---
title: Аутентификация Azure Active Directory для SQL Azure | Документация Майкрософт
description: Узнайте, как использовать Azure Active Directory для аутентификации с помощью базы данных SQL, управляемого экземпляра и хранилища данных SQL.
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: data warehouse
ms.devlang: ''
ms.topic: conceptual
author: GithubMirek
ms.author: mireks
ms.reviewer: vanto, carlrab
ms.date: 02/20/2019
ms.openlocfilehash: b99dbd403de0de948527fbe74b7e1205316822c0
ms.sourcegitcommit: b12a25fc93559820cd9c925f9d0766d6a8963703
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/14/2019
ms.locfileid: "69019677"
---
# <a name="use-azure-active-directory-authentication-for-authentication-with-sql"></a>Использование аутентификации Azure Active Directory для аутентификации с помощью SQL

Аутентификация Azure Active Directory — это механизм подключения к службам [База данных SQL](sql-database-technical-overview.md) Azure, [Управляемый экземпляр](sql-database-managed-instance.md) и [Хранилище данных SQL](../sql-data-warehouse/sql-data-warehouse-overview-what-is.md) с помощью удостоверений в Azure Active Directory (Azure AD). 

> [!NOTE]
> Этот раздел относится к Azure SQL Server, а также к базам данных SQL и хранилища данных SQL, создаваемым на сервере Azure SQL Server. Для простоты база данных SQL используется как для базы данных SQL, так и для хранилища данных SQL.

С помощью проверки подлинности Azure AD можно централизованно управлять удостоверениями пользователей базы данных и другими службами Майкрософт. Централизованное управление удостоверениями позволяет использовать единое расположение для управления пользователями и упрощает управление разрешениями. Это дает такие преимущества:

- наличие альтернативного варианта проверки подлинности SQL Server;
- возможность остановить увеличение количества пользователей на серверах баз данных;
- возможность чередования паролей в одном расположении;
- клиенты могут управлять разрешениями базы данных с помощью внешних групп (Azure AD);
- возможность исключить хранение паролей с помощью встроенной проверки подлинности Windows и других видов проверки подлинности, поддерживаемых Azure Active Directory;
- При проверке подлинности Azure AD используются данные пользователей автономной базы данных для проверки подлинности удостоверений на уровне базы данных.
- Azure AD поддерживает проверку подлинности на основе маркеров для приложений, подключающихся к базе данных SQL.
- Azure AD поддерживает проверку подлинности с использованием AD FS (федерация доменов) или собственную проверку подлинности с помощью имени пользователя и пароля для локального каталога Azure Active Directory без синхронизации домена.
- Azure AD поддерживает подключения из SQL Server Management Studio, использующие универсальную проверку подлинности Active Directory, в том числе Многофакторную идентификацию (MFA).  MFA обеспечивает надежную аутентификацию с использованием ряда простых вариантов проверки посредством телефонного звонка, текстового сообщения, смарт-карты с ПИН-кодом или уведомления в мобильном приложении. Дополнительные сведения см. в разделе [Поддержка SSMS в Azure AD MFA для базы данных SQL и хранилища данных SQL](sql-database-ssms-mfa-authentication.md).
- Azure AD поддерживает аналогичные подключения из SQL Server Data Tools (SSDT), использующие интерактивную аутентификацию Active Directory. Дополнительные сведения см. в статье [Поддержка Azure Active Directory в SQL Server Data Tools (SSDT)](/sql/ssdt/azure-active-directory).

> [!NOTE]  
> Подключение к SQL Server на виртуальной машине Azure с использованием учетной записи Azure Active Directory не поддерживается. Вместо этого используйте учетную запись домена Active Directory.  

Для настройки и использования проверки подлинности Azure Active Directory выполните следующие действия.

1. Создайте и заполните каталог Azure AD.
2. Необязательно: Свяжите или измените каталог Active Directory, который сейчас связан с вашей подпиской Azure.
3. Создайте учетную запись администратора Azure Active Directory для сервера Базы данных SQL Azure, управляемого экземпляра или [хранилища данных SQL Azure](https://azure.microsoft.com/services/sql-data-warehouse/).
4. Настройте клиентские компьютеры.
5. Создайте учетные записи пользователей автономной базы данных в базе данных, сопоставленной с удостоверениями Azure AD.
6. Подключитесь к базе данных с помощью удостоверений Azure AD.

> [!NOTE]
> Сведения о создании и заполнении каталога Azure AD, а также настройке Azure AD с помощью Базы данных SQL Azure, управляемого экземпляра и хранилища данных SQL см. в статье [Настройка аутентификации Azure Active Directory и управление ею с использованием Базы данных SQL или хранилища данных SQL](sql-database-aad-authentication-configure.md).

## <a name="trust-architecture"></a>Архитектура доверия

На следующей общей схеме представлена архитектура решения, в котором используется аутентификация Azure AD для базы данных SQL Azure. Та же концепция применяется к хранилищу данных SQL. Для поддержки собственной проверки подлинности Azure AD с использованием пароля пользователя учитывается только облачная часть, база данных SQL Azure и Azure AD. Для поддержки федеративной проверки подлинности (или имени пользователя и пароля в качестве учетных данных Windows) требуется взаимодействие с блоком ADFS. Стрелки обозначают пути обмена данными.

![схема проверки подлинности aad][1]

На следующей схеме показаны федерация, отношения доверия и отношения размещения. Все эти компоненты позволяют клиенту подключиться к базе данных, отправив маркер. Маркер проходит аутентификацию в Azure AD и становится доверенным для базы данных. Клиент 1 может представлять каталог Azure AD с собственными пользователями или федеративными пользователями. Клиент 2 представляет возможное решение, включая импортированных пользователей. В этом примере пользователи импортированы из федеративной службы Azure Active Directory, при этом службы ADFS синхронизированы с Azure Active Directory. Важно понимать, что для доступа к базе данных с использованием проверки подлинности Azure AD необходимо связать подписку размещения с Azure AD. Эту же подписку нужно использовать для создания сервера SQL Server для размещения базы данных SQL Azure или хранилища данных SQL.

![отношение подписки][2]

## <a name="administrator-structure"></a>Структура администраторов

При использовании аутентификации Azure AD существуют две учетные записи администратора сервера Базы данных SQL и управляемого экземпляра: учетная запись первоначального администратора сервера SQL Server и учетная запись администратора Azure AD. Та же концепция применяется к хранилищу данных SQL. Создать в пользовательской базе данных первого пользователя автономной базы данных Azure AD может только администратор с учетной записью Azure AD. Администратор Azure AD может использовать для входа имя пользователя Azure AD или имя группы Azure AD. Если учетная запись администратора является учетной записью группы, ее может использовать любой участник группы. По этой причине для одного экземпляра SQL Server может существовать несколько администраторов Azure AD. Использование учетной записи группы в качестве учетной записи администратора повышает управляемость. Это позволяет централизованно добавлять и удалять членов группы в Azure AD, не изменяя пользователей или разрешения в базе данных SQL. За один раз можно настроить только одного администратора Azure AD (пользователя или группу).

![структура администраторов][3]

## <a name="permissions"></a>Разрешения

Чтобы создавать новых пользователей, у вас должно быть разрешение `ALTER ANY USER` в базе данных. Разрешение `ALTER ANY USER` можно предоставить любому пользователю базы данных. Разрешение `ALTER ANY USER` также предоставляется учетным записям администратора сервера и пользователям базы данных с разрешениями `CONTROL ON DATABASE` или `ALTER ON DATABASE` для этой базы данных, а также участникам роли `db_owner` в базе данных.

Чтобы создать учетную запись пользователя автономной базы данных в Базе данных SQL Azure, управляемом экземпляре или хранилище данных SQL, необходимо подключиться к базе данных или экземпляру с помощью удостоверения Azure AD. Чтобы создать первого пользователя автономной базы данных, необходимо подключиться к ней с использованием учетной записи администратора Azure AD (который является владельцем базы данных). Это показано в статье [Настройка аутентификации Azure Active Directory и управление ею с использованием базы данных SQL или хранилища данных SQL](sql-database-aad-authentication-configure.md). Проверка подлинности Azure AD любого типа возможна только в том случае, если для базы данных SQL Azure или сервера хранилища данных SQL создана учетная запись администратора Azure AD. Если учетная запись администратора Azure Active Directory удалена с сервера, то существующие пользователи Azure Active Directory, учетные записи которых были созданы ранее на сервере SQL Server, больше не смогут подключаться к базе данных, используя свои текущие учетные данные Azure Active Directory.

## <a name="azure-ad-features-and-limitations"></a>Функции и ограничения Azure AD

- На сервере Azure SQL Server или в хранилище данных SQL можно выполнить подготовку для следующих членов Azure AD.

  - Собственные члены. Члены, созданные в Azure AD в управляемом домене или в домене клиента. Дополнительные сведения см. в статье [Добавление имени личного домена в Azure Active Directory](../active-directory/active-directory-domains-add-azure-portal.md).
  - Члены федеративного домена. Члены, созданные в Azure AD с федеративным доменом. Дополнительные сведения см. в статье [Microsoft Azure now supports federation with Windows Server Active Directory](https://azure.microsoft.com/blog/20../../windows-azure-now-supports-federation-with-windows-server-active-directory/) (Microsoft Azure теперь поддерживает федерацию с Windows Server Active Directory).
  - Импортированные члены из других каталогов Azure AD, являющиеся собственными или федеративными членами домена.
  - Группы Active Directory, созданные как группы безопасности.

- Пользователи Azure AD, которые входят в группу с ролью сервера `db_owner`, не могут использовать синтаксис **[CREATE DATABASE SCOPED CREDENTIAL](/sql/t-sql/statements/create-database-scoped-credential-transact-sql)** для Базы данных SQL Azure и Хранилища данных SQL Azure. Отобразится следующая ошибка:

    `SQL Error [2760] [S0001]: The specified schema name 'user@mydomain.com' either does not exist or you do not have permission to use it.`

    Предоставляйте роль `db_owner` напрямую отдельным пользователям Azure AD во избежание проблем с синтаксисом **CREATE DATABASE SCOPED CREDENTIAL**.

- Эти системные функции возвращают значения NULL при выполнении с помощью субъектов Azure AD:

  - `SUSER_ID()`
  - `SUSER_NAME(<admin ID>)`
  - `SUSER_SNAME(<admin SID>)`
  - `SUSER_ID(<admin name>)`
  - `SUSER_SID(<admin name>)`

### <a name="managed-instances"></a>Управляемые экземпляры

- Субъекты сервера (имена для входа) и пользователи Azure AD поддерживаются в [Управляемых экземплярах](sql-database-managed-instance.md) в качестве предварительной версии функции.
- Параметр субъектов сервера (имена для входа) Azure AD, сопоставленный с группой Azure AD в качестве владельца базы данных, не поддерживается в [Управляемых экземплярах](sql-database-managed-instance.md).
    - Кроме этого, при добавлении группы как части роли сервера `dbcreator` пользователи этой группы могут подключаться к Управляемому экземпляру и создавать базы данных, но не могут получить доступ к базе данных. Это происходит, так как новый владелец базы данных является системным администратором, а не пользователем Azure AD. Эта проблема не проявляется при добавлении роли сервера `dbcreator` для отдельного пользователя.
- Субъекты сервера (имена для входа) Azure AD поддерживают выполнение заданий и управление агентом SQL Server.
- Операции резервного копирования и восстановления базы данных могут быть выполнены с помощью субъектов сервера (имен для входа) Azure AD.
- Поддерживается аудит всех инструкций, связанных с субъектами сервера (именами для входа) Azure AD и событиями проверки подлинности.
- Поддерживается выделенное административное соединение для субъектов сервера (имен для входа) Azure AD, которые являются участниками роли сервера системного администратора.
    - Поддерживается с помощью служебной программы SQLCMD и SQL Server Management Studio.
- Триггеры входа поддерживаются для событий входа, поступающих от субъектов сервера (имен для входа) Azure AD.
- С помощью субъектов сервера (имен для входа) Azure AD можно настроить почту Service Broker и базы данных.


## <a name="connecting-using-azure-ad-identities"></a>Подключение с использованием удостоверений Azure AD

Проверка подлинности Azure Active Directory поддерживает следующие способы подключения к базе данных с помощью удостоверений Azure AD:

- с использованием встроенной проверки подлинности Windows;
- Использование имени субъекта-пользователя и пароля Azure AD
- Использование маркера проверки подлинности приложения

Для субъектов сервера (имен для входа) Azure AD поддерживаются следующие методы проверки подлинности (**общедоступная предварительная версия**):

- Пароль Azure Active Directory.
- Встроенная служба Azure Active Directory.
- Универсальная служба Azure Active Directory с поддержкой MFA.
- Интерактивная служба Azure Active Directory.


### <a name="additional-considerations"></a>Дополнительные замечания

- Для повышения управляемости рекомендуем подготовить специальную группу Azure AD от имени администратора.   
- За один раз можно настроить только одну учетную запись администратора Azure AD (пользователя или группу) для сервера Базы данных SQL Azure или Хранилища данных SQL Azure.
  - Добавление субъектов сервера (имен для входа) Azure AD для Управляемых экземпляров (**общедоступной предварительной версии**) позволяет создавать несколько субъектов сервера (имен для входа) Azure AD, которые можно добавить для роли `sysadmin`.
- Изначально только администратор Azure AD для SQL Server может подключаться к серверу Базы данных SQL Azure, Управляемому экземпляру или Хранилищу данных SQL Azure, используя учетную запись Azure Active Directory. Затем администратор Active Directory может настроить других пользователей базы данных Azure AD.   
- Мы рекомендуем установить время ожидания подключения в 30 секунд.   
- Проверку подлинности Azure Active Directory поддерживают SQL Server 2016 Management Studio и SQL Server Data Tools для Visual Studio 2015 (версии 14.0.60311.1, выпущенной в апреле 2016 г., или более поздней). (Проверку подлинности Azure AD поддерживает **поставщик данных .NET Framework для SQL Server**, требуется версия .NET Framework не ниже 4.6.) Поэтому для последних версий этих инструментов и приложений уровня данных (DAC и BACPAC-файлов) можно применять аутентификацию Azure AD.   
- Начиная с версии 15.0.1, служебные программы[SQLCMD](/sql/tools/sqlcmd-utility) и [BCP](/sql/tools/bcp-utility) поддерживают интерактивную аутентификацию Active Directory с возможностью MFA.
- Для SQL Server Data Tools для Visual Studio 2015 требуется версия Data Tools, выпущенная в апреле 2016 г. (14.0.60311.1), или более поздняя. Сейчас пользователи Azure AD не отображаются в обозревателе объектов SSDT. Сведения о пользователях можно просмотреть в файле [sys.database_principals](https://msdn.microsoft.com/library/ms187328.aspx).   
- [Драйвер Microsoft JDBC 6.0 для SQL Server](https://www.microsoft.com/download/details.aspx?id=11774) поддерживает проверку подлинности Azure AD. Вы можете также ознакомиться с [настройкой свойств подключения](https://msdn.microsoft.com/library/ms378988.aspx).   
- PolyBase не поддерживает проверку подлинности Azure AD.   
- База данных SQL поддерживает проверку подлинности Azure AD на портале Azure. Для этого используются колонки **Импорт базы данных** и **Экспорт базы данных**. Импорт и экспорт с использованием проверки подлинности Azure AD также можно выполнить с помощью команды PowerShell.   
- Аутентификация Azure AD для базы данных SQL, управляемого экземпляра и хранилища данных SQL поддерживается с помощью интерфейса командной строки. Сведения о настройке и управлении Azure AD см. в статьях [Настройка аутентификации Azure Active Directory и управление ею с использованием базы данных SQL или хранилища данных SQL](sql-database-aad-authentication-configure.md) и [SQL Server - az sql server](https://docs.microsoft.com/cli/azure/sql/server).

## <a name="next-steps"></a>Следующие шаги

- Сведения о создании и заполнении каталога Azure AD, а также настройке Azure AD с помощью Базы данных SQL Azure, управляемого экземпляра или хранилища данных SQL см. в статье [Настройка аутентификации Azure Active Directory и управление ею с использованием Базы данных SQL или хранилища данных SQL](sql-database-aad-authentication-configure.md).
- Дополнительные сведения об использовании субъектов сервера (имен для входа) Azure AD с Управляемыми экземплярами см. в статье [Руководство. Обеспечение безопасности управляемого экземпляра в Базе данных SQL Azure с помощью субъектов сервера (имен для входа) Azure AD](sql-database-managed-instance-aad-security-tutorial.md)
- Общие сведения о доступе к базе данных SQL и управлении ею см. в статье [Контроль доступа к базе данных SQL Azure](sql-database-control-access.md).
- Общие сведения об именах для входа, пользователях и ролях базы данных в базе данных SQL см. в статье [Предоставление доступа к базе данных и управление им](sql-database-manage-logins.md).
- Дополнительные сведения о субъектах базы данных см. в [этой статье](https://msdn.microsoft.com/library/ms181127.aspx).
- Дополнительные сведения о ролях баз данных см. в статье [Роли уровня базы данных](https://msdn.microsoft.com/library/ms189121.aspx).
- Сведения о синтаксисе для создания субъектов сервера (имен для входа) Azure AD для Управляемых экземпляров см. в статье [CREATE LOGIN (Transact-SQL)](/sql/t-sql/statements/create-login-transact-sql?view=azuresqldb-mi-current).
- Дополнительные сведения о правилах брандмауэра см. в статье [Обзор правил брандмауэра базы данных SQL Azure](sql-database-firewall-configure.md).

<!--Image references-->

[1]: ./media/sql-database-aad-authentication/1aad-auth-diagram.png
[2]: ./media/sql-database-aad-authentication/2subscription-relationship.png
[3]: ./media/sql-database-aad-authentication/3admin-structure.png
[4]: ./media/sql-database-aad-authentication/4select-subscription.png
[5]: ./media/sql-database-aad-authentication/5ad-settings-portal.png
[6]: ./media/sql-database-aad-authentication/6edit-directory-select.png
[7]: ./media/sql-database-aad-authentication/7edit-directory-confirm.png
[8]: ./media/sql-database-aad-authentication/8choose-ad.png
[9]: ./media/sql-database-aad-authentication/9ad-settings.png
[10]: ./media/sql-database-aad-authentication/10choose-admin.png
[11]: ./media/sql-database-aad-authentication/11connect-using-int-auth.png
[12]: ./media/sql-database-aad-authentication/12connect-using-pw-auth.png
[13]: ./media/sql-database-aad-authentication/13connect-to-db.png
