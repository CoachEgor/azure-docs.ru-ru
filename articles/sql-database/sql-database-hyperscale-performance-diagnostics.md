---
title: База данных SQL Azure — диагностика производительности на уровне службы "масштабирование" | Документация Майкрософт
description: В этой статье описывается устранение проблем с производительностью масштабирования в базе данных SQL Azure.
services: sql-database
ms.service: sql-database
ms.subservice: service
ms.topic: troubleshooting
author: denzilribeiro
ms.author: denzilr
ms.reviewer: sstein
ms.date: 10/18/2019
ms.openlocfilehash: 92a1fda85e5ee49f12a13123e8a296492fd9eb4b
ms.sourcegitcommit: b4f201a633775fee96c7e13e176946f6e0e5dd85
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/18/2019
ms.locfileid: "72598167"
---
# <a name="sql-hyperscale-performance-troubleshooting-diagnostics"></a>Диагностика по устранению неполадок производительности в SQL


Для устранения проблем с производительностью в базе данных с масштабированием [Общие методологии настройки производительности](sql-database-monitor-tune-overview.md) на кластерном узле базы данных SQL Azure являются отправной точкой для анализа производительности. Тем не менее, учитывая [распределенную архитектуру](sql-database-service-tier-hyperscale.md#distributed-functions-architecture) масштабирования, в помощь добавлены дополнительные диагностические средства. В этой статье описываются диагностические данные, относящиеся к масштабированию.


## <a name="log-rate-throttling-waits"></a>Ожиданий регулирования скорости записи в журнал


Каждый уровень обслуживания базы данных SQL Azure имеет ограничения частоты создания журнала, принудительно реализованные через [Управление частотой ведения журнала](sql-database-resource-limits-database-server.md#transaction-log-rate-governance). В этом случае ограничение на создание журнала в настоящее время равно 100 МБ/с, независимо от уровня обслуживания. Однако бывают случаи, когда скорость создания журнала в основной реплике вычислений должна регулироваться для поддержки соглашений об уровне обслуживания для восстановления. Такое регулирование происходит, когда [сервер страницы или другая реплика вычислений](sql-database-service-tier-hyperscale.md#distributed-functions-architecture) значительно отчасти от применения новых записей журнала из службы журналов.

Следующие типы ожидания (в [sys. DM _os_wait_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-wait-stats-transact-sql/)) описывают причины, по которым скорость ведения журнала может регулироваться в основной реплике вычислений:

|Тип ожидания    |Описание                         |
|-------------          |------------------------------------|
|RBIO_RG_STORAGE        | Происходит, когда скорость создания журнала основного узла базы данных в масштабе подкачки регулируется из-за отложенного потребления журнала на серверах страниц.         |
|RBIO_RG_DESTAGE        | Происходит при регулировании частоты создания журнала для масштабируемого узла базы данных, обусловленной задержкой использования журнала в долгосрочном хранилище журналов.         |
|RBIO_RG_REPLICA        | Происходит, когда частота создания журнала для расчетного узла базы данных в масштабе подсчета регулируется из-за отложенного потребления журнала вторичными репликами, доступными для чтения.         |
|RBIO_RG_LOCALDESTAGE   | Происходит при регулировании частоты создания журнала для расчетного узла базы данных в соответствии с задержкой использования журнала службой журнала.         |


## <a name="page-server-reads"></a>Операции чтения сервера страниц

Реплики вычислений не кэшируют полную копию базы данных локально. Данные, локальные для реплики вычислений, хранятся в буферном пуле (в памяти) и в локальном кэше расширения пула отказоустойчивого буфера (RBPEX), который является частичным (не охватывающим) кэшем страниц данных. Размер этого локального кэша RBPEX пропорционально размеру вычислений, и в 3 раза больше памяти уровня вычислений. RBPEX похож на буферный пул в том, что он имеет наиболее часто запрашиваемые данные. С другой стороны, на каждом сервере страницы есть кэш RBPEX для части базы данных, которую она поддерживает.
 
При выполнении операции чтения в реплике вычислений, если данные не существуют в буферном пуле или локальном кэше RBPEX, выдается вызов функции Page (идентификатор страницы, LSN), а страница извлекается с соответствующего сервера страниц. Операции чтения с серверов страниц — это удаленные операции чтения, поэтому они выполняются медленнее, чем операции чтения из локальной RBPEX. При устранении проблем с производительностью, связанных с операциями ввода-вывода, необходимо иметь возможность определить, сколько IOs выполнялось с помощью относительно медленных операций чтения с удаленного сервера страниц.

Несколько динамических административных представлений и расширенных событий имеют столбцы и поля, указывающие число удалений операций чтения с сервера страниц, которые можно сравнить с общим количеством операций чтения. 

- Столбцы, доступные для чтения сервера страниц отчетов, доступны в административных представлениях выполнения, например:
    - [sys.dm_exec_requests](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql/)
    - [sys.dm_exec_query_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-query-stats-transact-sql/)
    - [sys.dm_exec_procedure_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-procedure-stats-transact-sql/)
    - [sys. DM _exec_trigger_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-trigger-stats-transact-sql/)
- Операции чтения сервера страниц добавляются к следующим расширенным событиям:
    - sql_statement_completed
    - sp_statement_completed
    - sql_batch_completed
    - rpc_completed
    - scan_stopped
    - query_store_begin_persist_runtime_stat
    - запрос — store_execution_runtime_info
- Актуалпажесерверреадс/Актуалпажесерверреадахеадс добавляются в XML плана запроса для реальных планов. Пример.

`<RunTimeCountersPerThread Thread="8" ActualRows="90466461" ActualRowsRead="90466461" Batches="0" ActualEndOfScans="1" ActualExecutions="1" ActualExecutionMode="Row" ActualElapsedms="133645" ActualCPUms="85105" ActualScans="1" ActualLogicalReads="6032256" ActualPhysicalReads="0" ActualPageServerReads="0" ActualReadAheads="6027814" ActualPageServerReadAheads="5687297" ActualLobLogicalReads="0" ActualLobPhysicalReads="0" ActualLobPageServerReads="0" ActualLobReadAheads="0" ActualLobPageServerReadAheads="0" />`

> [!NOTE]
> Чтобы просмотреть эти атрибуты в окне "Свойства плана запроса" в SSMS, потребуется SSMS 18,3 или более поздней версии.


## <a name="virtual-file-stats-and-io-accounting"></a>Статистика виртуальных файлов и учет операций ввода-вывода

В базе данных SQL Azure [sys. DM _io_virtual_file_stats ()](/sql/relational-databases/system-dynamic-management-views/sys-dm-io-virtual-file-stats-transact-sql/) DMF является основным способом мониторинга SQL Server операций ввода-вывода. Характеристики операций ввода-вывода в масштабировании отличаются в соответствии с [распределенной архитектурой](sql-database-service-tier-hyperscale.md#distributed-functions-architecture). В этом разделе мы рассмотрим операции ввода-вывода (чтение и запись) для файлов данных, как показано в этом DMF. В процессе масштабирования каждый файл данных, видимый в этом DMF, соответствует удаленному серверу страниц. Упомянутый здесь кэш RBPEX является локальным кэшем на основе SSD, который является неохватывающим кэшем в реплике вычислений.


### <a name="local-rbpex-cache-usage"></a>Использование локального кэша RBPEX

Локальный кэш RBPEX существует на кластерном узле в локальном хранилище SSD. Таким же, операции ввода-вывода в этом кэше RBPEX выполняются быстрее, чем на серверах удаленных страниц. В настоящее время [sys. DM _io_virtual_file_stats ()](/sql/relational-databases/system-dynamic-management-views/sys-dm-io-virtual-file-stats-transact-sql/) в базе данных с масштабированием содержит специальную строку, сообщающую о вводе-выводе в локальном кэше RBPEX в реплике вычислений. Эта строка имеет значение 0 как для `database_id`, так и для `file_id` столбцов. Например, приведенный ниже запрос возвращает статистику использования RBPEX с момента запуска базы данных.

`select * from sys.dm_io_virtual_file_stats(0,NULL);`

Отношение операций чтения к RBPEX к агрегированным операциям чтения, выполненным для всех остальных файлов данных, обеспечивает коэффициент попаданий в кэш RBPEX.


### <a name="data-reads"></a>Операции чтения данных

- Когда обработчик SQL Server выполняет операции чтения в реплике вычислений, они могут обслуживаться либо локальным кэшем RBPEX, либо удаленными серверами страниц, либо сочетанием этих двух параметров при чтении нескольких страниц.
- Если в процессе считывания реплики из определенного файла считываются некоторые страницы, например file_id 1, то если эти данные находятся исключительно в локальном кэше RBPEX, все операции ввода-вывода для этого чтения зависят от file_id 0 (RBPEX). Если какая-либо часть этих данных находится в локальном кэше RBPEX, а какая-то часть находится на удаленном сервере страниц, операция ввода-вывода учитывается в file_id 0 для части, обслуживаемой из RBPEX, а часть, полученная с сервера удаленных страниц, учитывается в file_id 1. 
- Если реплика вычислений запрашивает страницу в определенном [номере LSN](/sql/relational-databases/sql-server-transaction-log-architecture-and-management-guide/) с сервера страниц, то если сервер страницы не был найден ЗАПРОШЕНному номеру LSN, то чтение из реплики вычислений будет ожидать до тех пор, пока страница не будет возвращена в реплику вычислений. При любом чтении с сервера страниц в реплике вычислений вы увидите тип PAGEIOLATCH_ * Wait, если он ожидает ввода-вывода. Это время ожидания включает как время, необходимое для получения запрошенной страницы на сервере страниц, так и номер LSN, а также время, необходимое для перемещения страницы с сервера страниц в реплику вычислений.
- Большие операции чтения, например упреждающее чтение, часто выполняются с помощью [операций чтения с разбивкой](/sql/relational-databases/reading-pages/)на несколько. Это позволяет одновременно считывать до 4 МБ страниц, что считается одним чтением в подсистеме SQL Server. Однако, когда считываемые данные находятся в RBPEX, эти операции чтения продаются в виде нескольких отдельных 8 КБ операций чтения, так как буферный пул и RBPEX всегда используют 8 КБ страниц. В результате число операций чтения IOs для RBPEX может быть больше фактического числа операций ввода/вывода, выполняемых ядром.


### <a name="data-writes"></a>Операции записи данных

- Первичная расчетная реплика не записывается непосредственно на серверы страниц. Вместо этого записи журнала из службы журнала воспроизводятся на соответствующих серверах страниц. 
- Операции записи, происходящие в реплике вычислений, преимущественно записываются в локальный RBPEX (file_id 0). Для операций записи в логические файлы размером более 8 КБ, т. е. с помощью функции [сбора и записи](/sql/relational-databases/writing-pages/), каждая операция записи преобразуется в несколько 8 КБ отдельных операций записи в RBPEX, так как буферный пул и RBPEX всегда используют 8 КБ страниц. В результате число операций записи IOs, наблюдаемых в RBPEX, может быть больше, чем реальное число операций ввода/вывода, выполняемых ядром.
- Кроме RBPEX-файлов или файлов данных, отличных от file_id 0, которые соответствуют серверам страниц, также отображаются записи. На уровне служб с масштабированием эти записи моделируются, так как реплики вычислений никогда не записываются непосредственно на серверы страниц. При записи операций ввода-вывода и пропускной способности учитывается, как они происходят в реплике вычислений, но задержка для файлов данных, отличных от file_id 0, не отражает фактическую задержку при записи сервера страниц.

### <a name="log-writes"></a>Записи журнала

- На основном вычислении запись журнала учитывается в file_id 2 из sys. DM _io_virtual_file_stats. Запись в журнал в основном вычислений — это запись в основную зону журнала.
- Записи журнала не зафиксированы на вторичной реплике при фиксации. В процессе масштабирования журнал применяется службой xlog к удаленным репликам. Поскольку записи журнала в действительности не происходят во вторичных репликах, любые учетные данные ввода-вывода журнала на вторичных репликах предназначены только для отслеживания.

## <a name="additional-resources"></a>дополнительные ресурсы.

- Ограничения ресурсов Виртуальное ядро для отдельной базы данных с горизонтальным масштабированием см. в разделе [Виртуальное ядро Service Tier Limits](sql-database-vcore-resource-limits-single-databases.md#hyperscale-service-tier-for-provisioned-compute)
- Сведения о настройке производительности базы данных SQL Azure см. [в статье производительность запросов в базе данных SQL Azure](sql-database-performance-guidance.md) .
- Сведения о настройке производительности с помощью хранилища запросов см. в разделе [мониторинг производительности с помощью хранилища запросов](/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store/) .
- Сведения о скриптах мониторинга динамического административного представления см. в статье [мониторинг производительности базы данных SQL Azure с помощью динамических административных представлений](sql-database-monitoring-with-dmvs.md) .
