---
title: Управление ресурсами в плотных эластичных бассейнах Документы Майкрософт
description: Управление вычислительными ресурсами в эластичных пулах Azure S'L с большим количеством баз данных.
services: sql-database
ms.service: sql-database
ms.subservice: elastic-pools
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: dimitri-furman
ms.author: dfurman
ms.reviewer: carlrab
ms.date: 03/13/2019
ms.openlocfilehash: 014f9edca1706c39930c6e48bb64cd8873bcace9
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79473733"
---
# <a name="resource-management-in-dense-elastic-pools"></a>Управление ресурсами в сжатых эластичных пулах

[Эластичные пулы](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-pool) базы данных Azure S'L — это экономичное решение для управления многими базами данных с различным использованием ресурсов. Все базы данных в эластичном пуле имеют одинаковое распределение ресурсов, таких как процессор, память, рабочие потоки, пространство для хранения данных, tempdb, исходя из предположения, что **только подмножество баз данных в пуле будет использовать вычислительные ресурсы в любой момент времени.** Это предположение позволяет эластичным пулам быть рентабельными. Вместо того, чтобы платить за все ресурсы, которые могут потенциально нуждаться в каждой отдельной базе данных, клиенты платят за гораздо меньший набор ресурсов, общих между всеми базами данных в пуле.

## <a name="resource-governance"></a>Управление ресурсами

Совместное использование ресурсов требует от системы тщательного контроля за использованием ресурсов, чтобы свести к минимуму эффект «шумного соседа», когда база данных с высоким потреблением ресурсов влияет на другие базы данных в том же эластичном пуле. В то же время система должна обеспечить достаточные ресурсы для таких функций, как высокая доступность и аварийное восстановление (HADR), резервное копирование и восстановление, мониторинг, магазин запросов, автоматическая настройка и т.д., чтобы надежно функционировать.

База данных Azure S'L достигает этих целей, используя несколько механизмов управления ресурсами, включая [объекты работы](https://docs.microsoft.com/windows/win32/procthread/job-objects) Windows для управления ресурсами уровня процесса, менеджер ресурсов сервера Windows [File Server (FSRM)](https://docs.microsoft.com/windows-server/storage/fsrm/fsrm-overview) для управления квотами хранения данных, а также измененную и расширенную версию [управляющего ресурсами](https://docs.microsoft.com/sql/relational-databases/resource-governor/resource-governor) сервера s L для реализации управления ресурсами в каждом экземпляре сервера S'L, работающего в базе данных Azure S'L.

Основная цель проектирования эластичных бассейнов заключается в том, чтобы быть экономически эффективным. По этой причине система намеренно позволяет клиентам создавать _плотные_ пулы, то есть пулы с числом баз данных приближается или на максимально допустимом уровне, но при умеренном распределении вычислительных ресурсов. По той же причине система не резервирует все потенциально необходимые ресурсы для своих внутренних процессов, но позволяет совместно голой информации между внутренними процессами и пользовательскими рабочими нагрузками.

Такой подход позволяет клиентам использовать плотные эластичные пулы для достижения адекватной производительности и значительной экономии средств. Однако, если рабочая нагрузка против многих баз данных в плотном пуле достаточно интенсивна, утверждение ресурсов становится значительным. Утверждение ресурсов снижает производительность рабочей нагрузки пользователя и может негативно повлиять на внутренние процессы.

> [!IMPORTANT]
> В плотных пулах с большим количеством активных баз данных может оказаться нецелесообразным увеличивать количество баз данных в пуле до максимумов, задокументированных для упругих пулов [DTU](sql-database-dtu-resource-limits-elastic-pools.md) и [vCore.](sql-database-vcore-resource-limits-elastic-pools.md)
> 
> Количество баз данных, которые могут быть размещены в плотных пулах, не вызывая проблем с ресурсами и производительности, зависит от количества одновременно активных баз данных и от потребления ресурсов нарабочня пользователей в каждой базе данных. Это число может меняться с течением времени по мере изменения рабочих нагрузок пользователей.

При возникновении спора с ресурсами в плотно упакованном пуле клиенты могут выбрать одно или несколько из следующих действий для его смягчения:
- Настройте рабочую нагрузку на запрос, чтобы уменьшить потребление ресурсов, или распределите потребление ресурсов по нескольким базам данных с течением времени.
- Снижение плотности пула путем перемещения некоторых баз данных в другой пул или создания автономных баз данных.
- Масштабируйте пул, чтобы получить больше ресурсов.

Предложения о том, как реализовать последние два действия, [см.](#operational-recommendations) Снижение спора ресурсов приносит пользу как рабочим нагрузкам пользователей, так и внутренним процессам и позволяет системе надежно поддерживать ожидаемый уровень обслуживания.

## <a name="monitoring-resource-consumption"></a>Мониторинг потребления ресурсов

Чтобы избежать ухудшения производительности из-за проблем с ресурсами, клиенты, использующие плотные эластичные пулы, должны активно отслеживать потребление ресурсов и своевременно принимать меры, если увеличение расхода ресурсов начинает влиять на рабочие нагрузки. Непрерывный мониторинг важен, поскольку использование ресурсов в пуле изменяется с течением времени из-за изменений в рабочей нагрузке пользователей, изменениях в объемах и распределении данных, изменениях плотности пула и изменениях в службе базы данных Azure S'L. 

База данных Azure S'L предоставляет несколько метрик, имеющих отношение к этому типу мониторинга. Превышение рекомендуемого среднего значения для каждой метрики указывает на утверждение ресурсов в пуле и должно быть рассмотрено с помощью одного из действий, упомянутых ранее.

|Имя метрики|Описание|Рекомендуемое среднее значение| 
|----------|--------------------------------|------------|
|`avg_instance_cpu_percent`|Использование процессора процесса S'L Server, связанного с эластичным пулом, измеряемым базовой операционной системой. Доступно в [sys.dm_db_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database?view=azuresqldb-current) просмотра в каждой базе данных, и `master` в [sys.elastic_pool_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) просмотра в базе данных. Эта метрика также излучается в Azure Monitor, где она [называется,](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported#microsoftsqlserverselasticpools) `sqlserver_process_core_percent`и может быть просмотрена на портале Azure. Это значение одинаково для каждой базы данных в одном и том же эластичном пуле.|Ниже 70%. Иногда короткие шипы до 90% могут быть приемлемыми.|
|`max_worker_percent`|Использование [рабочего потока.]( https://docs.microsoft.com/sql/relational-databases/thread-and-task-architecture-guide) Предоставляется для каждой базы данных в пуле, а также для самого пула. Существуют различные ограничения на количество рабочих потоков на уровне базы данных и на уровне пула, поэтому рекомендуется мониторинг этой метрики на обоих уровнях. Доступно в [sys.dm_db_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database?view=azuresqldb-current) просмотра в каждой базе данных, и `master` в [sys.elastic_pool_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) просмотра в базе данных. Эта метрика также излучается в Azure Monitor, где она [называется,](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported#microsoftsqlserverselasticpools) `workers_percent`и может быть просмотрена на портале Azure.|Ниже 80%. Спайки до 100% вызовут попытки подключения и запросы на сбой.|
|`avg_data_io_percent`|Использование IOPS для чтения и записи физического итог. Предоставляется для каждой базы данных в пуле, а также для самого пула. Существуют различные ограничения на количество IOPS на уровне базы данных и на уровне пула, поэтому рекомендуется мониторинг этой метрики на обоих уровнях. Доступно в [sys.dm_db_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database?view=azuresqldb-current) просмотра в каждой базе данных, и `master` в [sys.elastic_pool_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) просмотра в базе данных. Эта метрика также излучается в Azure Monitor, где она [называется,](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported#microsoftsqlserverselasticpools) `physical_data_read_percent`и может быть просмотрена на портале Azure.|Ниже 80%. Иногда короткие шипы до 100% могут быть приемлемыми.|
|`avg_log_write_percent`|Использование пропускной записи для записи журнала транзакций записывает io. Предоставляется для каждой базы данных в пуле, а также для самого пула. Существуют различные ограничения на пропускную систему журнала на уровне базы данных и на уровне пула, поэтому рекомендуется мониторинг этой метрики на обоих уровнях. Доступно в [sys.dm_db_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) просмотра в каждой базе данных, и `master` в [sys.elastic_pool_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) просмотра в базе данных. Эта метрика также излучается в Azure Monitor, где она [называется,](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported#microsoftsqlserverselasticpools) `log_write_percent`и может быть просмотрена на портале Azure. Когда эта метрика близка к 100%, все изменения базы данных (INSERT, ОБНОВЛЕНИЕ, DELETE, заявления MERGE, SELECT ... В, НАВАЛОМ ВСТАВКИ И Т.Д.) будет медленнее.|Ниже 90%. Иногда короткие шипы до 100% могут быть приемлемыми.|
|`oom_per_second`|Скорость ошибок вне памяти (OOM) в эластичной пуле, которая является индикатором давления памяти. Доступно в представлении [sys.dm_resource_governor_resource_pools_history_ex.](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-resource-pools-history-ex-azure-sql-database?view=azuresqldb-current) Смотрите [примеры](#examples) запроса для расчета этой метрики.|0|
|`avg_storage_percent`|Использование пространства для хранения на уровне эластичного пула. Доступно в [sys.elastic_pool_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) просмотра `master` в базе данных. Эта метрика также излучается в Azure Monitor, где она [называется,](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported#microsoftsqlserverselasticpools) `storage_percent`и может быть просмотрена на портале Azure.|Ниже 80%. Может приблизиться к 100% для пулов без роста данных.|
|`tempdb_log_used_percent`|Использование пространства транзакций в `tempdb` базе данных. Хотя временные объекты, созданные в одной базе данных, `tempdb` не видны в других базах данных в одном и том же эластичном пуле, это общий ресурс для всех баз данных в одном пуле. Длительная или простаиваемая транзакция, `tempdb` запущенная из одной базы данных в пуле, может потреблять большую часть журнала транзакций и вызывать сбои в работе запросов в других базах данных в том же пуле. Доступно в представлении [sys.dm_db_log_space_usage.](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-log-space-usage-transact-sql) Эта метрика также излучается в Azure Monitor и может быть просмотрена на портале Azure. Приведенные [примеры](#examples) для примерного запроса для возврата текущего значения этой метрики.|Ниже 50%. Случайные шипы до 80% являются приемлемыми.|
|||

В дополнение к этим показателям база данных Azure S'L предоставляет представление, которое возвращает фактические лимиты управления ресурсами, а также дополнительные представления, возвращающие статистику использования ресурсов на уровне пула ресурсов и на уровне группы рабочей нагрузки.

|Имя представления|Описание|  
|-----------------|--------------------------------|  
|[sys.dm_user_db_resource_governance](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-user-db-resource-governor-azure-sql-database)|Возвращает фактические настройки конфигурации и емкости, используемые механизмами управления ресурсами в текущей базе данных или эластичном пуле.|
|[sys.dm_resource_governor_resource_pools](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-resource-pools-transact-sql)|Возвращает информацию о текущем состоянии пула ресурсов, текущей конфигурации пулов ресурсов и общей статистике пула ресурсов.|
|[sys.dm_resource_governor_workload_groups](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-workload-groups-transact-sql)|Возвращает совокупную статистику группы рабочей нагрузки и текущую конфигурацию группы рабочей нагрузки. Это представление можно соединить с sys.dm_resource_governor_resource_pools в `pool_id` столбце для получения информации о пуле ресурсов.|
|[sys.dm_resource_governor_resource_pools_history_ex](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-resource-pools-history-ex-azure-sql-database)|Возвращает статистику использования пула ресурсов за последние 32 минуты. Каждая строка представляет собой 20-секундный интервал. Столбцы `delta_` возвращают изменение в каждой статистике в интервале.|
|[sys.dm_resource_governor_workload_groups_history_ex](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-workload-groups-history-ex-azure-sql-database)|Возвращает статистику использования группы рабочей нагрузки за последние 32 минуты. Каждая строка представляет собой 20-секундный интервал. Столбцы `delta_` возвращают изменение в каждой статистике в интервале.|
|||

Эти представления могут использоваться для мониторинга использования ресурсов и устранения неполадок ресурсов практически в режиме реального времени. Нагрузка пользователя на первичные и читаемые вторичные реплики, `SloSharedPool1` включая `UserPrimaryGroup.DBId[N]` георепликации, `N` классифицируется в пул ресурсов и группу рабочей нагрузки, где обозначаетзначение значения идентификатора базы данных.

Помимо мониторинга текущего использования ресурсов, клиенты, использующие плотные пулы, могут поддерживать исторические данные об использовании ресурсов в отдельном хранилище данных. Эти данные могут быть использованы в прогностическом анализе для упреждающего управления использованием ресурсов на основе исторических и сезонных тенденций.

## <a name="operational-recommendations"></a>Оперативные рекомендации

**Оставьте достаточный запас ресурсов.** В случае утверждения ресурсов и снижения производительности смягчение последствий может включать перемещение некоторых баз данных из пострадавшего эластичного пула или расширение пула, как отмечалось ранее. Однако для выполнения этих действий требуются дополнительные вычислительные ресурсы. В частности, для пулов Premium и Business Critical эти действия требуют передачи всех данных для перемещаемых баз данных или для всех баз данных в эластичном пуле при расширении пула. Передача данных — это длительная и ресурсоемкая операция. Если пул уже находится под высоким давлением ресурсов, смягчающая операция сама по себе еще больше ухудшит производительность. В крайних случаях может оказаться невозможным решить проблему спора с ресурсами с помощью перемещения базы данных или расширения пула из-за недоступности необходимых ресурсов. В этом случае единственным решением может быть временное уменьшение рабочей нагрузки запроса на пораженный эластичный пул.

Клиенты, использующие плотные пулы, должны внимательно следить за тенденциями использования ресурсов, как описано ранее, и принимать меры по смягчению последствий, в то время как метрики остаются в пределах рекомендуемых диапазонов и все еще имеются достаточные ресурсы в эластичном пуле.

Использование ресурсов зависит от нескольких факторов, которые меняются с течением времени для каждой базы данных и каждого эластичного пула. Достижение оптимального соотношения цены и производительности в плотных пулах требует постоянного мониторинга и перебалансировки, что является перемещением баз данных из более используемых пулов в менее используемые пулы и созданием новых пулов по мере необходимости для размещения возросшей рабочей нагрузки.

**Не перемещайте «горячие» базы данных.** Если утверждение ресурсов на уровне пула вызвано главным образом небольшим числом высокоиспользуемых баз данных, может возникнуть соблазн переместить эти базы данных в менее используемый пул или сделать их автономными базами данных. Однако делать это в то время, когда база данных остается широко используется, не рекомендуется, так как операция перемещения приведет к дальнейшему ухудшить производительность как для перемещения базы данных, так и для всего пула. Вместо этого либо подождите, пока высокое использование утихнет, либо переместите менее используемые базы данных вместо этого, чтобы уменьшить давление ресурсов на уровне пула. Однако перемещение баз данных с очень низким уровнем использования не дает никакой пользы в данном случае, поскольку существенно не сокращает использование ресурсов на уровне пула.

**Создание новых баз данных в «карантинном» пуле.** В сценариях, где часто создаются новые базы данных, такие как приложения, использующие модель "тенант- за базу данных", существует опасность того, что новая база данных, помещенная в существующий эластичный пул, неожиданно потребует значительные ресурсы и повлияет на другие базы данных и внутренние процессы в пуле. Чтобы уменьшить этот риск, создайте отдельный "карантинный" пул с достаточным распределением ресурсов. Используйте этот пул для новых баз данных с пока неизвестными шаблонами потребления ресурсов. После того, как база данных осталась в этом пуле в течение бизнес-цикла, например, недели или месяца, и ее потребление ресурсов известно, она может быть перемещена в пул с достаточной емкостью для размещения этого дополнительного использования ресурсов.

**Избегайте чрезмерно плотных логических серверов.** База данных Azure S'L [поддерживает](https://docs.microsoft.com/azure/sql-database/sql-database-resource-limits-database-server) до 5000 баз данных на логическом сервере. Клиенты, использующие эластичные пулы с тысячами баз данных, могут рассмотреть возможность размещения нескольких эластичных пулов на одном сервере, при этом общее количество баз данных будет соответствовать поддерживаемому пределу. Однако логические серверы со многими тысячами баз данных создают операционные проблемы. Операции, требующие перечисления всех баз данных на сервере, например просмотр баз данных на портале, будут замедляться. Оперативные ошибки, такие как неправильная модификация логинов уровня сервера или правил брандмауэра, повлияют на большее количество баз данных. Случайное удаление логического сервера потребует помощи службы поддержки Майкрософт для восстановления баз данных на удаленном сервере и приведет к длительному отключению всех затронутых баз данных.

Мы рекомендуем ограничить количество баз данных на логическом сервере меньшим числом, чем максимально поддерживаемое. Во многих сценариях оптимальным является использование до 1000-2000 баз данных на сервере. Чтобы уменьшить вероятность случайного удаления сервера, мы рекомендуем разместить [блокировку удаления](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-lock-resources) на логическом сервере или его группе ресурсов.

В прошлом некоторые сценарии, связанные с перемещением баз данных в, из или между эластичными пулами на одном логическом сервере, были быстрее, чем при перемещении баз данных между логическими серверами. В настоящее время все перемещения базы данных выполняются с одинаковой скоростью, независимо от логического сервера источника и назначения.

## <a name="examples"></a>Примеры

### <a name="monitoring-memory-utilization"></a>Мониторинг использования памяти

Этот запрос вычисляет метрику `oom_per_second` для каждого пула ресурсов за последние 32 минуты. Этот запрос может быть выполнен в любой базе данных в эластичной пуле.

```
SELECT pool_id,
       name AS resource_pool_name,
       IIF(name LIKE 'SloSharedPool%' OR name LIKE 'UserPool%', 'user', 'system') AS resource_pool_type,
       SUM(CAST(delta_out_of_memory_count AS decimal))/(SUM(duration_ms)/1000.) AS oom_per_second
FROM sys.dm_resource_governor_resource_pools_history_ex
GROUP BY pool_id, name
ORDER BY pool_id;
```
### <a name="monitoring-tempdb-log-space-utilization"></a>Мониторинг `tempdb` использования пространства журнала

Этот запрос возвращает текущее `tempdb_log_used_percent` значение метрики. Этот запрос может быть выполнен в любой базе данных в эластичной пуле.

```
SELECT used_log_space_in_percent AS tempdb_log_used_percent
FROM tempdb.sys.dm_db_log_space_usage;
```

## <a name="next-steps"></a>Дальнейшие действия

* Для введения в эластичные пулы см. [Упругие пулы помогают управлять несколькими базами данных Azure S'L.](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-pool)
* Для получения информации о рабочих нагрузках на настройку запроса для сокращения [Monitoring and performance tuning](https://docs.microsoft.com/azure/sql-database/sql-database-monitor-tune-overview)использования ресурсов [см.]( https://docs.microsoft.com/azure/sql-database/sql-database-monitoring-tuning-index)
