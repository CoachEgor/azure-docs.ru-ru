---
title: Как переместить ресурсы в другой регион
description: Узнайте, как переместить базу данных Azure S'L, эластичный пул Azure S'L или управляемый экземпляр Azure S'L в другой регион.
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: MashaMSFT
ms.author: mathoma
ms.reviewer: carlrab
ms.date: 06/25/2019
ms.openlocfilehash: 851ef49a5c066f12a95baa54daf5e267cb4278c5
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "73821438"
---
# <a name="how-to-move-azure-sql-resources-to-another-region"></a>Как переместить ресурсы Azure S'L в другой регион

В этой статье рассказывается об универсальном рабочем процессе о том, как переместить единую базу данных базы данных Azure S'L, эластичный пул и управляемый экземпляр в новый регион. 

## <a name="overview"></a>Обзор

Существуют различные сценарии, в которых необходимо переместить существующие ресурсы Azure S-L из одного региона в другой. Например, вы расширяете свой бизнес в новый регион и хотите оптимизировать его для новой клиентской базы. Или вам необходимо перенести операции в другой регион по причинам соответствия требованиям. Или Azure выпустила совершенно новый регион, который обеспечивает лучшую близость и улучшает качество обслуживания клиентов.  

Эта статья обеспечивает общий рабочий процесс для перемещения ресурсов в другой регион. Рабочий процесс состоит из следующих шагов: 

- Проверить предпосылки для переезда 
- Подготовка к перемещению ресурсов по охвату
- Мониторинг процесса подготовки
- Проверьте процесс перемещения
- Инициировать фактическое перемещение 
- Удаление ресурсов из региона исходного кода 


> [!NOTE]
> Эта статья относится к миграциям в общедоступном облаке Azure или в одном и том же суверенном облаке. 


[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="move-single-database"></a>Перемещение единой базы данных

### <a name="verify-prerequisites"></a>проверка предварительных требований; 

1. Создайте целевой логический сервер для каждого исходного сервера. 
1. Налажить брандмауэр с правильными исключениями с помощью [PowerShell.](scripts/sql-database-create-and-configure-database-powershell.md)  
1. Налаживать логические серверы с правильными логинами. Если вы не являетесь администратором подписки или администратором сервера S'L, работайте с администратором, чтобы назначить необходимые разрешения. Для получения дополнительной [How to manage Azure SQL database security after disaster recovery](sql-database-geo-replication-security-config.md)информации см. 
1. Если базы данных зашифрованы с помощью TDE и используют свой собственный ключ шифрования в хранилище ключей Azure, убедитесь, что правильный материал шифрования будет подготовлен в целевых регионах. Для получения дополнительной [Azure SQL Transparent Data Encryption with customer-managed keys in Azure Key Vault](transparent-data-encryption-byok-azure-sql.md) информации см.
1. Если аудит на уровне базы данных включен, отключите его и включите аудит на уровне сервера. После сбоя аудит уровня базы данных потребует межрегионального трафика, который не будет желанным или возможным после переезда. 
1. Для аудита на уровне серверов убедитесь, что:
   - Контейнер для хранения данных, журналная аналитика или концентратор событий с существующими журналами аудита перемещается в целевой регион. 
   - Аудит настроен на целевом сервере. Дополнительные сведения см. в статье [Приступая к работе с аудитом базы данных SQL](sql-database-auditing.md). 
1. Если в экземпляре есть долгосрочная политика удержания (LTR), существующие резервные ожидания LTR останутся связанными с текущим сервером. Поскольку целевой сервер отличается, вы сможете получить доступ к старым резервным копированиям LTR в исходной области с помощью исходного сервера, даже если сервер удален. 

  > [!NOTE]
  > Этого будет недостаточно для перемещения между суверенным облаком и общественным регионом. Такая миграция потребует перемещения резервных данных LTR на целевой сервер, который в настоящее время не поддерживается. 

### <a name="prepare-resources"></a>Подготовка ресурсов

1. Создайте [группу сбоя](sql-database-single-database-failover-group-tutorial.md#2---create-the-failover-group) между логическим сервером источника для логического сервера цели.  
1. Добавьте базы данных, которые вы хотите переместить в группу failover. 
    - Репликация всех добавленных баз данных будет инициирована автоматически. Для получения дополнительной информации [см.](sql-database-auto-failover-group.md#best-practices-of-using-failover-groups-with-single-databases-and-elastic-pools) 
 
### <a name="monitor-the-preparation-process"></a>Мониторинг процесса подготовки

Вы можете периодически звонить [Get-AzSqlDatabaseFailoverGroup,](/powershell/module/az.sql/get-azsqldatabasefailovergroup) чтобы контролировать репликацию баз данных от источника к цели. Объект вывода `Get-AzSqlDatabaseFailoverGroup` включает свойство для **состояния репликации:** 
   - **РепликацияState No 2** (CATCH_UP) указывает на то, что база данных синхронизирована и может быть безопасно сбой. 
   - **РепликацияState No 0** (SEEDING) указывает на то, что база данных еще не посеяна, и попытка неудачи завершится неудачей. 

### <a name="test-synchronization"></a>Синхронизация тестов

После того, как **ReplicationState** будет `2`подключен к каждой базе `<fog-name>.secondary.database.windows.net` данных или подмножеством баз данных, используя вторичную конечную точку, и выполните любой запрос против баз данных, чтобы обеспечить подключение, надлежащую конфигурацию безопасности и репликацию данных. 

### <a name="initiate-the-move"></a>Инициировать перемещение

1. Подключитесь к целевому серверу с помощью вторичной конечной точки. `<fog-name>.secondary.database.windows.net`
1. Используйте [Switch-AzSqlDatabaseFailoverGroup,](/powershell/module/az.sql/switch-azsqldatabasefailovergroup) чтобы переключить вторичный управляемый экземпляр в основной с полной синхронизацией. Эта операция либо увенчается успехом, либо откатится назад. 
1. Убедитесь, что команда успешно `nslook up <fog-name>.secondary.database.windows.net` завершила работу, используя, чтобы убедиться, что точки входа DNS CNAME на IP-адрес целевой области. Если команда коммутатора выходит из строя, CNAME не будет обновляться. 

### <a name="remove-the-source-databases"></a>Удаление исходных баз данных

Как только перемещение завершается, удалите ресурсы в исходном регионе, чтобы избежать ненужных платежей. 

1. Удалите группу неудачса с помощью [Remove-AzSqlDatabaseFailoverGroup](/powershell/module/az.sql/remove-azsqldatabasefailovergroup). 
1. Удалите каждую исходную базу данных с помощью [Remove-AzSqlDatabase](/powershell/module/az.sql/remove-azsqldatabase) для каждой из баз данных на исходном сервере. Это автоматически прекратит ссылки на георепликацию. 
1. Удалите исходный сервер с помощью [Remove-AzSqlServer](/powershell/module/az.sql/remove-azsqlserver). 
1. Удалите хранилище ключей, контейнеры для хранения аудита, концентратор событий, экземпляр AAD и другие зависимые ресурсы, чтобы перестать выставлять счета за них. 

## <a name="move-elastic-pools"></a>Перемещение эластичных бассейнов

### <a name="verify-prerequisites"></a>проверка предварительных требований; 

1. Создайте целевой логический сервер для каждого исходного сервера. 
1. Налажить брандмауэр с правильными исключениями с помощью [PowerShell.](scripts/sql-database-create-and-configure-database-powershell.md) 
1. Налаживать логические серверы с правильными логинами. Если вы не являетесь администратором подписки или администратором сервера S'L, работайте с администратором, чтобы назначить необходимые разрешения. Для получения дополнительной [How to manage Azure SQL database security after disaster recovery](sql-database-geo-replication-security-config.md)информации см. 
1. Если базы данных зашифрованы с помощью TDE и используют свой собственный ключ шифрования в хранилище ключей Azure, убедитесь, что правильный материал шифрования подготовлен в целевом регионе.
1. Создайте целевой эластичный пул для каждого упругого пула источника, убедившись, что пул создан в одном и том же уровне обслуживания, с тем же именем и тем же размером. 
1. Если аудит на уровне базы данных включен, отключите его и включите аудит на уровне сервера. После сбоя аудит на уровне базы данных потребует межрегионального трафика, который не является желательным или возможен после переезда. 
1. Для аудита на уровне серверов убедитесь, что:
    - Контейнер для хранения данных, журналная аналитика или концентратор событий с существующими журналами аудита перемещается в целевой регион.
    - Конфигурация аудита настроена на целевом сервере. Для получения более подробной [информации, см.](sql-database-auditing.md)
1. Если в экземпляре есть долгосрочная политика удержания (LTR), существующие резервные ожидания LTR останутся связанными с текущим сервером. Поскольку целевой сервер отличается, вы сможете получить доступ к старым резервным копированиям LTR в исходной области с помощью исходного сервера, даже если сервер удален. 

  > [!NOTE]
  > Этого будет недостаточно для перемещения между суверенным облаком и общественным регионом. Такая миграция потребует перемещения резервных данных LTR на целевой сервер, который в настоящее время не поддерживается. 

### <a name="prepare-to-move"></a>Подготовка к переезду
 
1.  Создайте отдельную [группу отказов](sql-database-elastic-pool-failover-group-tutorial.md#3---create-the-failover-group) между каждым эластичным пулом на исходном логическом сервере и его аналогам на целевом сервере. 
1.  Добавьте все базы данных в пуле в группу failover. 
    - Репликация добавленных баз данных будет инициирована автоматически. Для получения дополнительной информации ознакомьтесь [с рекомендациями для групп неудач с эластичными пулами.](sql-database-auto-failover-group.md#best-practices-of-using-failover-groups-with-single-databases-and-elastic-pools) 

  > [!NOTE]
  > Хотя можно создать группу failover, которая включает в себя несколько эластичных пулов, мы настоятельно рекомендуем создать отдельную группу failover для каждого пула. Если у вас есть большое количество баз данных в нескольких эластичных пулах, которые необходимо переместить, можно параллельно запускать шаги подготовки, а затем инициировать шаг перемещения параллельно. Этот процесс будет масштабироваться лучше и займет меньше времени по сравнению с наличием нескольких эластичных пулов в одной и той же группе failover. 

### <a name="monitor-the-preparation-process"></a>Мониторинг процесса подготовки

Вы можете периодически звонить [Get-AzSqlDatabaseFailoverGroup,](/powershell/module/az.sql/get-azsqldatabasefailovergroup) чтобы контролировать репликацию баз данных от источника к цели. Объект вывода `Get-AzSqlDatabaseFailoverGroup` включает свойство для **состояния репликации:** 
   - **РепликацияState No 2** (CATCH_UP) указывает на то, что база данных синхронизирована и может быть безопасно сбой. 
   - **РепликацияState No 0** (SEEDING) указывает на то, что база данных еще не посеяна, и попытка неудачи завершится неудачей. 

### <a name="test-synchronization"></a>Синхронизация тестов
 
После того, как **ReplicationState** будет `2`подключен к каждой базе `<fog-name>.secondary.database.windows.net` данных или подмножеством баз данных, используя вторичную конечную точку, и выполните любой запрос против баз данных, чтобы обеспечить подключение, надлежащую конфигурацию безопасности и репликацию данных. 

### <a name="initiate-the-move"></a>Инициировать перемещение
 
1. Подключитесь к целевому серверу с помощью вторичной конечной точки. `<fog-name>.secondary.database.windows.net`
1. Используйте [Switch-AzSqlDatabaseFailoverGroup,](/powershell/module/az.sql/switch-azsqldatabasefailovergroup) чтобы переключить вторичный управляемый экземпляр в основной с полной синхронизацией. Эта операция либо увенчается успехом, либо откатится назад. 
1. Убедитесь, что команда успешно `nslook up <fog-name>.secondary.database.windows.net` завершила работу, используя, чтобы убедиться, что точки входа DNS CNAME на IP-адрес целевой области. Если команда коммутатора выходит из строя, CNAME не будет обновляться. 

### <a name="remove-the-source-elastic-pools"></a>Удалите эластичные пулы источника
 
Как только перемещение завершается, удалите ресурсы в исходном регионе, чтобы избежать ненужных платежей. 

1. Удалите группу неудачса с помощью [Remove-AzSqlDatabaseFailoverGroup](/powershell/module/az.sql/remove-azsqldatabasefailovergroup).
1. Удалите каждый упругий пул источника на исходном сервере с помощью [Remove-AzSqlElasticPool.](/powershell/module/az.sql/remove-azsqlelasticpool) 
1. Удалите исходный сервер с помощью [Remove-AzSqlServer](/powershell/module/az.sql/remove-azsqlserver). 
1. Удалите хранилище ключей, контейнеры для хранения аудита, концентратор событий, экземпляр AAD и другие зависимые ресурсы, чтобы перестать выставлять счета за них. 

## <a name="move-managed-instance"></a>Перемещение управляемого экземпляра

### <a name="verify-prerequisites"></a>проверка предварительных требований;
 
1. Для каждого управляемого экземпляра источника создайте целевой управляемый экземпляр одинакового размера в целевом регионе.  
1. Наверстойная настройка сети для управляемого экземпляра. Для получения дополнительной информации см [конфигурация сети](sql-database-howto-managed-instance.md#network-configuration).
1. Нанастройка целевой основной базы данных с правильными логинами. Если вы не являетесь администратором подписки или администратором сервера S'L, работайте с администратором, чтобы назначить необходимые разрешения. 
1. Если базы данных зашифрованы с помощью TDE и используют свой собственный ключ шифрования в хранилище ключей Azure, убедитесь, что AKV с идентичными ключами шифрования существует как в исходных, так и в целевых регионах. Для получения дополнительной информации смотрите [TDE с ключами, управляемыми клиентами, в Azure Key Vault](transparent-data-encryption-byok-azure-sql.md).
1. Если аудит включен для например, убедитесь, что:
    - Контейнер для хранения или концентратор событий с существующими журналами перемещается в целевой регион. 
    - Аудит настроен на целевой экземпляр. Для получения дополнительной [информации](sql-database-managed-instance-auditing.md)см.
1. Если в экземпляре есть долгосрочная политика удержания (LTR), существующие резервные ожидания LTR останутся связанными с текущим сервером. Поскольку целевой сервер отличается, вы сможете получить доступ к старым резервным копированиям LTR в исходной области с помощью исходного сервера, даже если сервер удален. 

  > [!NOTE]
  > Этого будет недостаточно для перемещения между суверенным облаком и общественным регионом. Такая миграция потребует перемещения резервных данных LTR на целевой сервер, который в настоящее время не поддерживается. 

### <a name="prepare-resources"></a>Подготовка ресурсов

Создайте группу сбоя между каждым экземпляром исходного кода и соответствующим целевым экземпляром.
    - Репликация всех баз данных по каждому экземпляру будет инициирована автоматически. Для получения дополнительной [информации см.](sql-database-auto-failover-group.md)

 
### <a name="monitor-the-preparation-process"></a>Мониторинг процесса подготовки

Вы можете периодически звонить [Get-AzSqlDatabaseFailoverGroup,](/powershell/module/az.sql/get-azsqldatabasefailovergroup?view=azps-2.3.2) чтобы контролировать репликацию баз данных от источника к цели. Объект вывода `Get-AzSqlDatabaseFailoverGroup` включает свойство для **состояния репликации:** 
   - **РепликацияState No 2** (CATCH_UP) указывает на то, что база данных синхронизирована и может быть безопасно сбой. 
   - **РепликацияState No 0** (SEEDING) указывает на то, что база данных еще не посеяна, и попытка неудачи завершится неудачей. 

### <a name="test-synchronization"></a>Синхронизация тестов

После того, как **ReplicationState** будет `2`подключен к каждой базе `<fog-name>.secondary.database.windows.net` данных или подмножеством баз данных, используя вторичную конечную точку, и выполните любой запрос против баз данных, чтобы обеспечить подключение, надлежащую конфигурацию безопасности и репликацию данных. 

### <a name="initiate-the-move"></a>Инициировать перемещение 

1. Подключитесь к целевому серверу с помощью вторичной конечной точки. `<fog-name>.secondary.database.windows.net`
1. Используйте [Switch-AzSqlDatabaseFailoverGroup,](/powershell/module/az.sql/switch-azsqldatabasefailovergroup?view=azps-2.3.2) чтобы переключить вторичный управляемый экземпляр в основной с полной синхронизацией. Эта операция либо увенчается успехом, либо откатится назад. 
1. Убедитесь, что команда успешно `nslook up <fog-name>.secondary.database.windows.net` завершила работу, используя, чтобы убедиться, что точки входа DNS CNAME на IP-адрес целевой области. Если команда коммутатора выходит из строя, CNAME не будет обновляться. 

### <a name="remove-the-source-managed-instances"></a>Удалить экземпляры, управляемые исходом
Как только перемещение завершается, удалите ресурсы в исходном регионе, чтобы избежать ненужных платежей. 

1. Удалите группу неудачса с помощью [Remove-AzSqlDatabaseFailoverGroup](/powershell/module/az.sql/remove-azsqldatabasefailovergroup). Это упадет конфигурацию группы failover и прекратит георепликацию между двумя экземплярами. 
1. Удалите экземпляр управления исходным ресурсом с помощью [Remove-AzSqlInstance](/powershell/module/az.sql/remove-azsqlinstance). 
1. Удалите все дополнительные ресурсы в группе ресурсов, такие как виртуальный кластер, виртуальная сеть и группа безопасности. 

## <a name="next-steps"></a>Дальнейшие действия 

[Управление](sql-database-manage-after-migration.md) базой данных Azure S'L после ее переноса. 

