---
title: Как переместить ресурсы базы данных SQL Azure в другой регион | Документация Майкрософт
description: Узнайте, как переместить базу данных SQL Azure, эластичный пул SQL Azure или управляемый экземпляр SQL Azure в другой регион.
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: MashaMSFT
ms.author: mathoma
ms.reviewer: carlrab
manager: craigg
ms.date: 06/25/2019
ms.openlocfilehash: 26d3377767a99a7291e73522152d4c6dbf389067
ms.sourcegitcommit: a874064e903f845d755abffdb5eac4868b390de7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/24/2019
ms.locfileid: "68444855"
---
# <a name="how-to-move-azure-sql-resources-to-another-region"></a>Как переместить ресурсы SQL Azure в другой регион

В этой статье описывается универсальный рабочий процесс перемещения одной базы данных SQL Azure, эластичного пула и управляемого экземпляра в новый регион. 

## <a name="overview"></a>Обзор

Существуют различные сценарии, в которых необходимо переместить существующие ресурсы SQL Azure из одного региона в другой. Например, вы развернете свой бизнес в новом регионе и хотите оптимизировать его для новой клиентской базы. Или необходимо переместить операции в другой регион по соображениям соответствия. Или Azure выпустила новый регион, который обеспечивает более близкое сходство и улучшает взаимодействие с клиентами.  

В этой статье представлен общий рабочий процесс перемещения ресурсов в другой регион. Рабочий процесс состоит из следующих шагов: 

- Проверка предварительных требований для перемещения 
- Подготовка к перемещению ресурсов в области
- Мониторинг процесса подготовки
- Тестирование процесса перемещения
- Начать фактическое перемещение 
- Удалить ресурсы из исходного региона 


> [!NOTE]
> Эта статья относится к миграции в общедоступном облаке Azure или в том же независимых облаке. 


[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="move-single-database"></a>Переместить отдельную базу данных

### <a name="verify-prerequisites"></a>проверка предварительных требований; 

1. Создайте целевой логический сервер для каждого исходного сервера. 
1. Настройте брандмауэр с нужными исключениями с помощью [PowerShell](scripts/sql-database-create-and-configure-database-powershell.md).  
1. Настройте логические серверы с использованием правильных имен входа. Если вы не являетесь администратором подписки или администратором SQL Server, обратитесь к администратору, чтобы назначить необходимые разрешения. Дополнительные сведения см. [в статье Управление безопасностью базы данных SQL Azure после аварийного восстановления](sql-database-geo-replication-security-config.md). 
1. Если ваши базы данных зашифрованы с помощью TDE и в хранилище ключей Azure используется собственный ключ шифрования, убедитесь, что в целевых регионах подготовлены необходимые материалы по шифрованию. Дополнительные сведения см. [в статье прозрачное шифрование данных Azure SQL с управляемыми клиентом ключами в Azure Key Vault](transparent-data-encryption-byok-azure-sql.md)
1. Если включен аудит на уровне базы данных, отключите его и включите аудит на уровне сервера. После отработки отказа аудит на уровне базы данных потребует передачи трафика между регионами, что не требуется или невозможно после перемещения. 
1. Для аудита на уровне сервера убедитесь в том, что:
   - Контейнер хранилища, Log Analytics или концентратор событий с существующими журналами аудита перемещается в целевой регион. 
   - Аудит настроен на целевом сервере. Дополнительные сведения см. в статье [Приступая к работе с аудитом базы данных SQL](sql-database-auditing.md). 
1. Если экземпляр имеет политику долгосрочного хранения (LTR), существующие резервные копии LTR останутся связанными с текущим сервером. Так как целевой сервер отличается, вы сможете получить доступ к старым резервным копиям LTR в исходном регионе с помощью исходного сервера, даже если сервер удален. 

  > [!NOTE]
  > Это будет недостаточно для перемещения между облаком независимых и общедоступным регионом. Для такого переноса потребуется переместить резервные копии LTR на целевой сервер, который сейчас не поддерживается. 

### <a name="prepare-resources"></a>Подготовьте ресурсы

1. Создайте [группу](sql-database-single-database-failover-group-tutorial.md#2---create-the-failover-group) отработки отказа между логическим сервером источника и логическим сервером целевого объекта.  
1. Добавьте базы данных, которые необходимо переместить в группу отработки отказа. 
    - Репликация всех добавленных баз данных будет инициирована автоматически. Дополнительные сведения см. в статье рекомендации [по использованию групп отработки отказа с отдельными базами данных](sql-database-auto-failover-group.md#best-practices-of-using-failover-groups-with-single-databases-and-elastic-pools). 
 
### <a name="monitor-the-preparation-process"></a>Мониторинг процесса подготовки

Вы можете периодически вызывать [Get-азсклдатабасефаиловерграуп](/powershell/module/az.sql/get-azsqldatabasefailovergroup) для мониторинга репликации баз данных из источника в целевой объект. Выходной объект `Get-AzSqlDatabaseFailoverGroup` включает свойство для **ReplicationState**: 
   - **ReplicationState = 2** (CATCH_UP) указывает, что база данных синхронизирована и для нее можно выполнить безопасную отработку отказа. 
   - **ReplicationState = 0** (ЗАПОЛНЕНие) указывает, что база данных еще не заполнена и попытка отработки отказа завершится ошибкой. 

### <a name="test-synchronization"></a>Тестовая синхронизация

После **ReplicationState** `2`подключитесь к каждой базе данных или подмножеству баз данных с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net` и выполните любой запрос к базам данных, чтобы обеспечить подключение, правильную конфигурацию безопасности и данные. репликации. 

### <a name="initiate-the-move"></a>Начать перемещение

1. Подключитесь к целевому серверу с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net`.
1. Используйте [параметр Switch-азсклдатабасефаиловерграуп](/powershell/module/az.sql/switch-azsqldatabasefailovergroup) , чтобы перевести вторичный управляемый экземпляр в основной с полной синхронизацией. Эта операция либо будет выполнена, либо будет отменена. 
1. Убедитесь, что команда выполнена успешно, используя `nslook up <fog-name>.secondary.database.windows.net` , чтобы убедиться, что запись DNS CNAME указывает на IP-адрес целевого региона. Если команда Switch завершается неудачно, запись CNAME не будет обновлена. 

### <a name="remove-the-source-databases"></a>Удаление баз данных источника

После завершения перемещения удалите ресурсы из исходного региона, чтобы избежать ненужных расходов. 

1. Удалите группу отработки отказа с помощью команды [Remove-азсклдатабасефаиловерграуп](/powershell/module/az.sql/remove-azsqldatabasefailovergroup). 
1. Удалите каждую базу данных-источник с помощью команды [Remove азсклдатабасе](/powershell/module/az.sql/remove-azsqldatabase) для каждой базы данных на исходном сервере. Это приведет к автоматическому прекращению связей георепликации. 
1. Удалите исходный сервер с помощью команды [Remove-азсклсервер](/powershell/module/az.sql/remove-azsqlserver). 
1. Удалите хранилище ключей, аудит контейнеров хранилища, концентратор событий, экземпляр AAD и другие зависимые ресурсы, чтобы не оплачивать их. 

## <a name="move-elastic-pools"></a>Перемещение эластичных пулов

### <a name="verify-prerequisites"></a>проверка предварительных требований; 

1. Создайте целевой логический сервер для каждого исходного сервера. 
1. Настройте брандмауэр с нужными исключениями с помощью [PowerShell](scripts/sql-database-create-and-configure-database-powershell.md). 
1. Настройте логические серверы с использованием правильных имен входа. Если вы не являетесь администратором подписки или администратором SQL Server, обратитесь к администратору, чтобы назначить необходимые разрешения. Дополнительные сведения см. [в статье Управление безопасностью базы данных SQL Azure после аварийного восстановления](sql-database-geo-replication-security-config.md). 
1. Если ваши базы данных зашифрованы с помощью TDE и в хранилище ключей Azure используется собственный ключ шифрования, убедитесь, что в целевом регионе подготовлены необходимые материалы по шифрованию.
1. Создайте целевой эластичный пул для каждого исходного пула эластичных БД, убедившись, что пул создается на том же уровне служб с тем же именем и размером. 
1. Если включен аудит на уровне базы данных, отключите его и включите аудит на уровне сервера. После отработки отказа аудит на уровне базы данных потребует передачи трафика между регионами, который не нужен или может быть после перемещения. 
1. Для аудита на уровне сервера убедитесь в том, что:
    - Контейнер хранилища, Log Analytics или концентратор событий с существующими журналами аудита перемещается в целевой регион.
    - Конфигурация аудита настраивается на целевом сервере. Дополнительные сведения см. в разделе [Аудит базы данных SQL](sql-database-auditing.md).
1. Если экземпляр имеет политику долгосрочного хранения (LTR), существующие резервные копии LTR останутся связанными с текущим сервером. Так как целевой сервер отличается, вы сможете получить доступ к старым резервным копиям LTR в исходном регионе с помощью исходного сервера, даже если сервер удален. 

  > [!NOTE]
  > Это будет недостаточно для перемещения между облаком независимых и общедоступным регионом. Для такого переноса потребуется переместить резервные копии LTR на целевой сервер, который сейчас не поддерживается. 

### <a name="prepare-to-move"></a>Подготовка к перемещению
 
1.  Создайте отдельную [группу](sql-database-elastic-pool-failover-group-tutorial.md#3---create-the-failover-group) отработки отказа между каждым пулом эластичных баз данных на исходном логическом сервере и его аналогом эластичного пула на целевом сервере. 
1.  Добавьте все базы данных из пула в группу отработки отказа. 
    - Репликация добавленных баз данных будет инициирована автоматически. Дополнительные сведения см. в статье рекомендации [по использованию групп отработки отказа с пулами эластичных](sql-database-auto-failover-group.md#best-practices-of-using-failover-groups-with-single-databases-and-elastic-pools)баз данных. 

  > [!NOTE]
  > Хотя можно создать группу отработки отказа, которая включает несколько эластичных пулов, настоятельно рекомендуется создать отдельную группу отработки отказа для каждого пула. При наличии большого количества баз данных в нескольких эластичных пулах, которые необходимо переместить, можно выполнять подготовительные действия параллельно, а затем запускать шаг перемещения параллельно. Этот процесс будет лучше масштабироваться и займет меньше времени по сравнению с наличием нескольких эластичных пулов в одной группе отработки отказа. 

### <a name="monitor-the-preparation-process"></a>Мониторинг процесса подготовки

Вы можете периодически вызывать [Get-азсклдатабасефаиловерграуп](/powershell/module/az.sql/get-azsqldatabasefailovergroup) для мониторинга репликации баз данных из источника в целевой объект. Выходной объект `Get-AzSqlDatabaseFailoverGroup` включает свойство для **ReplicationState**: 
   - **ReplicationState = 2** (CATCH_UP) указывает, что база данных синхронизирована и для нее можно выполнить безопасную отработку отказа. 
   - **ReplicationState = 0** (ЗАПОЛНЕНие) указывает, что база данных еще не заполнена и попытка отработки отказа завершится ошибкой. 

### <a name="test-synchronization"></a>Тестовая синхронизация
 
После **ReplicationState** `2`подключитесь к каждой базе данных или подмножеству баз данных с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net` и выполните любой запрос к базам данных, чтобы обеспечить подключение, правильную конфигурацию безопасности и данные. репликации. 

### <a name="initiate-the-move"></a>Начать перемещение
 
1. Подключитесь к целевому серверу с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net`.
1. Используйте [параметр Switch-азсклдатабасефаиловерграуп](/powershell/module/az.sql/switch-azsqldatabasefailovergroup) , чтобы перевести вторичный управляемый экземпляр в основной с полной синхронизацией. Эта операция либо будет выполнена, либо будет отменена. 
1. Убедитесь, что команда выполнена успешно, используя `nslook up <fog-name>.secondary.database.windows.net` , чтобы убедиться, что запись DNS CNAME указывает на IP-адрес целевого региона. Если команда Switch завершается неудачно, запись CNAME не будет обновлена. 

### <a name="remove-the-source-elastic-pools"></a>Удаление исходных пулов эластичных БД
 
После завершения перемещения удалите ресурсы из исходного региона, чтобы избежать ненужных расходов. 

1. Удалите группу отработки отказа с помощью команды [Remove-азсклдатабасефаиловерграуп](/powershell/module/az.sql/remove-azsqldatabasefailovergroup).
1. Удалите каждый исходный эластичный пул на исходном сервере с помощью [Remove-азсклеластикпул](/powershell/module/az.sql/remove-azsqlelasticpool). 
1. Удалите исходный сервер с помощью команды [Remove-азсклсервер](/powershell/module/az.sql/remove-azsqlserver). 
1. Удалите хранилище ключей, аудит контейнеров хранилища, концентратор событий, экземпляр AAD и другие зависимые ресурсы, чтобы не оплачивать их. 

## <a name="move-managed-instance"></a>Переместить управляемый экземпляр

### <a name="verify-prerequisites"></a>проверка предварительных требований;
 
1. Для каждого исходного управляемого экземпляра Создайте целевой управляемый экземпляр того же размера в целевом регионе.  
1. Настройка сети для управляемого экземпляра. Дополнительные сведения см. в разделе [Сетевая конфигурация](sql-database-howto-managed-instance.md#network-configuration).
1. Настройте целевую базу данных master с использованием правильных имен входа. Если вы не являетесь администратором подписки или администратором SQL Server, обратитесь к администратору, чтобы назначить необходимые разрешения. 
1. Если ваши базы данных зашифрованы с помощью TDE и в хранилище ключей Azure используется собственный ключ шифрования, убедитесь, что AKV с одинаковыми ключами шифрования существует в исходном и целевом регионах. Дополнительные сведения см. [в разделе TDE with Customer-Managed Keys в Azure Key Vault](transparent-data-encryption-byok-azure-sql.md).
1. Если для экземпляра включен аудит, убедитесь, что:
    - Контейнер хранилища или концентратор событий с существующими журналами перемещается в целевой регион. 
    - Аудит настроен на целевом экземпляре. Дополнительные сведения см. в разделе [Аудит с помощью управляемого экземпляра](sql-database-managed-instance-auditing.md).
1. Если экземпляр имеет политику долгосрочного хранения (LTR), существующие резервные копии LTR останутся связанными с текущим сервером. Так как целевой сервер отличается, вы сможете получить доступ к старым резервным копиям LTR в исходном регионе с помощью исходного сервера, даже если сервер удален. 

  > [!NOTE]
  > Это будет недостаточно для перемещения между облаком независимых и общедоступным регионом. Для такого переноса потребуется переместить резервные копии LTR на целевой сервер, который сейчас не поддерживается. 

### <a name="prepare-resources"></a>Подготовьте ресурсы

Создайте группу отработки отказа между каждым исходным экземпляром и соответствующим целевым экземпляром.
    - Репликация всех баз данных на каждом экземпляре будет инициирована автоматически. Дополнительные сведения см. в разделе [группы автоматической](sql-database-auto-failover-group.md) отработки отказа.

 
### <a name="monitor-the-preparation-process"></a>Мониторинг процесса подготовки

Вы можете периодически вызывать [Get-азсклдатабасефаиловерграуп](/powershell/module/az.sql/get-azsqldatabasefailovergroup?view=azps-2.3.2) для мониторинга репликации баз данных из источника в целевой объект. Выходной объект `Get-AzSqlDatabaseFailoverGroup` включает свойство для **ReplicationState**: 
   - **ReplicationState = 2** (CATCH_UP) указывает, что база данных синхронизирована и для нее можно выполнить безопасную отработку отказа. 
   - **ReplicationState = 0** (ЗАПОЛНЕНие) указывает, что база данных еще не заполнена и попытка отработки отказа завершится ошибкой. 

### <a name="test-synchronization"></a>Тестовая синхронизация

После **ReplicationState** `2`подключитесь к каждой базе данных или подмножеству баз данных с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net` и выполните любой запрос к базам данных, чтобы обеспечить подключение, правильную конфигурацию безопасности и данные. репликации. 

### <a name="initiate-the-move"></a>Начать перемещение 

1. Подключитесь к целевому серверу с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net`.
1. Используйте [параметр Switch-азсклдатабасефаиловерграуп](/powershell/module/az.sql/switch-azsqldatabasefailovergroup?view=azps-2.3.2) , чтобы перевести вторичный управляемый экземпляр в основной с полной синхронизацией. Эта операция либо будет выполнена, либо будет отменена. 
1. Убедитесь, что команда выполнена успешно, используя `nslook up <fog-name>.secondary.database.windows.net` , чтобы убедиться, что запись DNS CNAME указывает на IP-адрес целевого региона. Если команда Switch завершается неудачно, запись CNAME не будет обновлена. 

### <a name="remove-the-source-managed-instances"></a>Удаление исходных управляемых экземпляров
После завершения перемещения удалите ресурсы из исходного региона, чтобы избежать ненужных расходов. 

1. Удалите группу отработки отказа с помощью команды [Remove-азсклдатабасефаиловерграуп](/powershell/module/az.sql/remove-azsqldatabasefailovergroup). Это приведет к удалению конфигурации группы отработки отказа и завершению связей георепликации между двумя экземплярами. 
1. Удалите исходный управляемый экземпляр с помощью [Remove-азсклинстанце](/powershell/module/az.sql/remove-azsqlinstance). 
1. Удалите все дополнительные ресурсы в группе ресурсов, такие как виртуальный кластер, виртуальная сеть и группа безопасности. 

## <a name="next-steps"></a>Следующие шаги 

[Управление](sql-database-manage-after-migration.md) базой данных SQL Azure после ее переноса. 

