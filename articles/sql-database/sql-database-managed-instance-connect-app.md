---
title: Подключение приложений к Управляемому экземпляру Базы данных SQL Azure | Документация Майкрософт
description: В этой статье описывается, как подключить приложение к Управляемому экземпляру Базы данных SQL.
services: sql-database
ms.service: sql-database
ms.subservice: managed-instance
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: srdan-bozovic-msft
ms.author: srbozovi
ms.reviewer: sstein, bonova, carlrab
manager: craigg
ms.date: 11/09/2018
ms.openlocfilehash: ed9fbdd3e999cfd262ecbcf05a843c19cc969ed1
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60701304"
---
# <a name="connect-your-application-to-azure-sql-database-managed-instance"></a>Подключение приложения к Управляемому экземпляру Базы данных SQL

Сейчас вам доступно много вариантов для размещения приложений.

Например, вы можете разместить приложение в облаке, используя Службу приложений Azure или любую службу виртуальных сетей Azure, например среду службы приложений Azure, виртуальные машины или масштабируемый набор виртуальных машин. Также можно применить гибридную схему работы с облаком, оставляя приложения в локальной среде.

Независимо от выбранной схемы, вы можете подключить приложение к Управляемому экземпляру.  

![высокий уровень доступности](./media/sql-database-managed-instance/application-deployment-topologies.png)

## <a name="connect-an-application-inside-the-same-vnet"></a>Подключение приложений внутри одной виртуальной сети

Это самый простой сценарий. Виртуальные машины внутри виртуальной сети могут свободно подключаться друг к другу напрямую, даже если находятся в разных подсетях. Это означает, что для подключения приложений, размещенных в среде приложений Azure или на виртуальной машине, достаточно лишь настроить строку подключения.  

## <a name="connect-an-application-inside-a-different-vnet"></a>Подключение приложений из другой виртуальной сети

Этот сценарий немного сложнее, поскольку Управляемый экземпляр получает частный IP-адрес, принадлежащий его виртуальной сети. Поэтому приложению для подключения нужно получить доступ к виртуальной сети, в которой развернут Управляемый экземпляр. Сначала необходимо создать подключение между приложением и виртуальной сетью Управляемого экземпляра. Для этого сценария не обязательно размещать виртуальные сети в одной подписке.

Существует два варианта подключения виртуальных сетей.

- [Пиринговая связь между виртуальными сетями Azure](../virtual-network/virtual-network-peering-overview.md).
- VPN-шлюз между виртуальными сетями ([портал Azure](../vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal.md), [PowerShell](../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md), [Azure CLI](../vpn-gateway/vpn-gateway-howto-vnet-vnet-cli.md)).

Лучше использовать пиринговую связь, поскольку она использует магистральную сеть корпорации Майкрософт и не добавляет существенных задержек по сравнению с подключением виртуальных машин в одной виртуальной сети. Пиринг виртуальной сети ограничен сетями в том же регионе.  

> [!IMPORTANT]
> Сценарий пиринга виртуальной сети для службы "Управляемый экземпляр" ограничен сетями в том же регионе из-за [ограничений пиринга глобальной виртуальной сети](../virtual-network/virtual-network-manage-peering.md#requirements-and-constraints).

## <a name="connect-an-on-premises-application"></a>Подключение локального приложения

Доступ к управляемому экземпляру возможен только по частному IP-адресу. Чтобы обратиться к нему из локальной среды, необходимо установить подключение типа "сеть — сеть" между приложением и виртуальной сетью управляемого экземпляра.

Есть два способа подключить локальную сеть к виртуальной сети Azure.

- VPN-подключение типа "сеть — сеть" ([Портал Azure](../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal.md), [PowerShell](../vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell.md), [Azure CLI](../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-cli.md)).
- Подключение [ExpressRoute](../expressroute/expressroute-introduction.md).  

Если подключение к Azure из локальной среды установлено успешно, но вам не удается подключиться к Управляемому экземпляру, проверьте правила брандмауэра: исходящее подключение на порт SQL 1433, а также к диапазону портов 11 000–12 000 для перенаправления.

## <a name="connect-an-application-on-the-developers-box"></a>Подключение приложения через окно разработчика

Доступ к Управляемому экземпляру возможен только по частному IP-адресу, а значит для доступа к нему из окна разработчика необходимо установить подключение между окном разработчика и виртуальной сетью Управляемого экземпляра. Для этого настройте подключение "точка — сеть" к виртуальной сети с помощью собственной аутентификации Azure на основе сертификата. Дополнительные сведения см. в статье [Configure a point-to-site connection to connect to an Azure SQL Database Managed Instance from on-premises computer](sql-database-managed-instance-configure-p2s.md) (Установка подключения "точка — сеть" к Управляемому экземпляру Базы данных SQL Azure из локального компьютера).

## <a name="connect-from-on-premises-with-vnet-peering"></a>Подключение из локальной сети с помощью пиринговой связи между виртуальными сетями

Другой сценарий, реализуемый клиентами, заключается в том, что VPN-шлюз размещается в виртуальной сети и подписке, которые отличаются от используемых для Управляемого экземпляра. Затем между двумя виртуальными сетями устанавливается пиринговая связь. На следующей схеме примера архитектуры показано, как это можно реализовать.

![Пиринговая связь между виртуальными сетями](./media/sql-database-managed-instance-connect-app/vnet-peering.png)

После настройки базовой инфраструктуры необходимо изменить некоторые параметры, чтобы VPN-шлюз мог просматривать IP-адреса в виртуальной сети, где размещен Управляемый экземпляр. Чтобы сделать это, внесите следующие изменения в разделе **Параметры пиринга**.

1. В виртуальной сети, где размещен VPN-шлюз, перейдите в раздел **Пиринги**, а затем к пиринговому подключению к Управляемому экземпляру и нажмите кнопку **Разрешить транзит шлюзов**.
2. В виртуальной сети, где размещен Управляемый экземпляр, перейдите в раздел **Пиринги**, а затем к пиринговому подключению к Управляемому экземпляру и щелкните **Use remote gateways** (Использовать удаленные шлюзы).

## <a name="connect-an-azure-app-service-hosted-application"></a>Подключение приложения, размещенного в службе приложений Azure

Доступ к Управляемому экземпляру возможен только по частному IP-адресу, а значит для доступа к нему из локальной среды необходимо установить подключение типа "сеть — сеть" между приложением и виртуальной сетью управляемого экземпляра. См. статью [Интеграция приложения с виртуальной сетью Azure](../app-service/web-sites-integrate-with-vnet.md).  

Сведения об устранении неполадок вы найдете [здесь](../app-service/web-sites-integrate-with-vnet.md#troubleshooting). Если соединение не удается установить, изучите статью о [синхронизации сетевой конфигурации](sql-database-managed-instance-sync-network-configuration.md).

В сценарии подключения службы приложений Azure к Управляемому экземпляру следует отдельно рассмотреть интеграцию службы приложений Azure с сетью, имеющую пиринговую связь с виртуальной сетью Управляемого экземпляра. В этом случае следует дополнительно настроить следующее.

- Виртуальная сеть Управляемого экземпляра НЕ ДОЛЖНА иметь шлюз.  
- Для виртуальной сети Управляемого экземпляра нужно настроить удаленные шлюзы.
- Пиринговые виртуальные сети должны разрешать транзит шлюзов.

Этот вариант сценария показан на схеме ниже.

![Пиринговая связь с интеграцией приложения](./media/sql-database-managed-instance/integrated-app-peering.png)

>[!NOTE]
>Функция интеграции c виртуальной сетью не предусматривает интеграции приложения с виртуальной сетью, в которой установлен шлюз ExpressRoute. Даже если шлюз ExpressRoute настроен в режиме сосуществования, функция интеграции c виртуальной сетью работать не будет. Если требуется получить доступ к ресурсам через соединение ExpressRoute, можно использовать Среду службы приложений, которая работает в виртуальной сети.

## <a name="troubleshooting-connectivity-issues"></a>Устранение неполадок с подключением

Для устранения проблем с подключением просмотрите следующие сведения:

- Если вы не можете подключиться к Управляемому экземпляру из виртуальной машины Azure в пределах одной виртуальной сети, но другой подсети, проверьте, установлена ли в подсети виртуальной машины группа безопасности сети, которая может блокировать доступ. Кроме того, обратите внимание, что вам необходимо открыть исходящее подключение на порту SQL 1433, а также порты в диапазоне 11000–12000, так как они необходимы для подключения с помощью перенаправления в пределах границ Azure.
- Убедитесь, что распространение BGP **включено** для таблицы маршрутов, которая связана с виртуальной сетью.
- Если используется VPN-подключение типа "точка — сеть", в конфигурации на портале Azure проверьте, отображаются ли числа для **входящего и исходящего трафика**. Ненулевые значения указывают, что Azure направляет трафик в локальную сеть и из нее.

   ![Число передаваемых байт для входящих и исходящих подключений](./media/sql-database-managed-instance-connect-app/ingress-egress-numbers.png)

- Убедитесь, что у клиентского компьютера (на котором запущен VPN-клиент) есть записи маршрутов для всех виртуальных сетей, к которым нужно получать доступ. Маршруты хранятся в `%AppData%\ Roaming\Microsoft\Network\Connections\Cm\<GUID>\routes.txt`.

   ![route.txt](./media/sql-database-managed-instance-connect-app/route-txt.png)

   Как показано на этом рисунке, существуют две записи для каждой используемой виртуальной сети и третья запись для конечной точки VPN, которая настроена на портале.

   Другой способ проверить маршруты — с помощью следующей команды. В выходных данных отображаются маршруты к различным подсетям:

   ```cmd
   C:\ >route print -4
   ===========================================================================
   Interface List
   14...54 ee 75 67 6b 39 ......Intel(R) Ethernet Connection (3) I218-LM
   57...........................rndatavnet
   18...94 65 9c 7d e5 ce ......Intel(R) Dual Band Wireless-AC 7265
   1...........................Software Loopback Interface 1
   Adapter===========================================================================

   IPv4 Route Table
   ===========================================================================
   Active Routes:
   Network Destination        Netmask          Gateway       Interface  Metric
          0.0.0.0          0.0.0.0       10.83.72.1     10.83.74.112     35
         10.0.0.0    255.255.255.0         On-link       172.26.34.2     43
         10.4.0.0    255.255.255.0         On-link       172.26.34.2     43
   ===========================================================================
   Persistent Routes:
   None
   ```

- Если используете пиринговую связь между виртуальными сетями, убедитесь, что вы следовали инструкциям по настройке [разрешения транзитов шлюзов и использования удаленных шлюзов](#connect-from-on-premises-with-vnet-peering).

## <a name="required-versions-of-drivers-and-tools"></a>Необходимые версии драйверов и средств

Ниже приведены рекомендуемые минимальные версии средств и драйверов, необходимые, чтобы подключиться к Управляемому экземпляру.

| Драйвер или средство | Version |
| --- | --- |
|.NET Framework | 4.6.1 (или .NET Core) |
|Драйвер ODBC| версия 17 |
|Драйвер PHP| 5.2.0 |
|Драйвер JDBC| 6.4.0 |
|Драйвер Node.js| 2.1.1 |
|Драйвер OLEDB| 18.0.2.0 |
|SSMS| 17.8.1 или [более поздней версии](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms) |

## <a name="next-steps"></a>Дальнейшие действия

- Сведения об Управляемом экземпляре см. в [обзоре Управляемого экземпляра](sql-database-managed-instance.md).
- См. инструкцию по [созданию Управляемого экземпляра](sql-database-managed-instance-get-started.md).
