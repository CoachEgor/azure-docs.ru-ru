---
title: Чтение запросов на репликах
description: База данных Azure S'L обеспечивает возможность загрузки-баланса только для чтения рабочих нагрузок, используя емкость только для чтения реплик - называется Read Scale-Out.
services: sql-database
ms.service: sql-database
ms.subservice: scale-out
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: sstein, carlrab
ms.date: 06/03/2019
ms.openlocfilehash: 1a1b9907cd931716949d92d948a7d541fd2d5057
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78206951"
---
# <a name="use-read-only-replicas-to-load-balance-read-only-query-workloads"></a>Использование реплик, доступных только для чтения, для распределения рабочих нагрузок запросов, доступных только для чтения

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

В рамках [архитектуры высокой доступности](./sql-database-high-availability.md#premium-and-business-critical-service-tier-availability)каждая база данных в уровне Premium и Business Critical автоматически предоставляется с основной репликой и несколькими вторичными репликами. Вторичные реплики подготовлены с тем же размером вычислений, что и основная реплика. Функция **Read Scale-Out** позволяет загружать балансную базу данных только для чтения, используя емкость одной из реплик только для чтения, вместо того, чтобы делиться репликой чтения-записи. Таким образом рабочая нагрузка только для чтения изолируется от главных рабочих нагрузок чтения и записи и не влияет на их производительность. Функция предназначена для приложений, которые включают логически разделенные рабочие нагрузки только для чтения, такие как аналитика. На уровне premium и Business Critical сервисные приложения могут получить преимущества в производительности, используя эту дополнительную емкость без каких-либо дополнительных затрат.

Функция **Read Scale-Out** также доступна в уровне службы Hyperscale, когда создается по крайней мере одна второстепенная реплика. Несколько вторичных реплик могут быть использованы, если рабочие нагрузки только для чтения требуют больше ресурсов, чем доступны на одной вторичной реплики. Архитектура высокой доступности уровней службы Basic, Standard и General Purpose не содержит копий. Функция **Read Scale-Out** недоступна в этих уровнях обслуживания.

Следующая диаграмма иллюстрирует ее с помощью базы данных Business Critical.

![Реплики только для чтения](media/sql-database-read-scale-out/business-critical-service-tier-read-scale-out.png)

Функция Чтения Масштаб-Out включена по умолчанию в новых базах данных Premium, Business Critical и Hyperscale. Для Hyperscale одна второстепенная реплика создается по умолчанию для новых баз данных. Если строка подключения S'L `ApplicationIntent=ReadOnly`настроена с помощью, приложение будет перенаправлено шлюзом на репатриированную копию этой базы данных только для чтения. Для получения информации `ApplicationIntent` о том, как использовать свойство, см. [Specifying Application Intent](https://docs.microsoft.com/sql/relational-databases/native-client/features/sql-server-native-client-support-for-high-availability-disaster-recovery#specifying-application-intent)

Если вы хотите убедиться, что приложение подключается `ApplicationIntent` к основной реплике независимо от настройки строки подключения S'L, необходимо явно отключить масштаб чтения при создании базы данных или при изменении конфигурации. Например, если вы обновите базу данных со стандартного или общего уровня цели до уровня Premium, Business Critical или Hyperscale и хотите убедиться, что все ваши соединения продолжают переходить к основной реплике, отключайте масштаб чтения. Для получения подробной информации о том, как отключить его, [см.](#enable-and-disable-read-scale-out)

> [!NOTE]
> Хранилище данных запросов, Расширенные события и функции S'L Profiler не поддерживаются в репликах только для чтения.

## <a name="data-consistency"></a>Согласованность данных

Одним из преимуществ реплик является то, что реплики всегда находятся в состоянии транзакционной согласованности, но в разные моменты времени может возникать небольшая задержка между различными репликами. Горизонтальное масштабирование для чтения поддерживает согласованность на уровне сеанса. Это означает, что если сеанс только для чтения воссоединяется после ошибки соединения, вызванной недоступностью реплики, он может быть перенаправлен на реплику, которая не является 100% актуальной с репликой чтения-записи. Аналогичным образом, если приложение записывает данные с помощью сеанса чтения и сразу же читает их с помощью сеанса только для чтения, возможно, что последние обновления не будут сразу видны на реплике. Задержка вызвана асинхронной операцией повтора журнала транзакций.

> [!NOTE]
> Задержки репликации в пределах региона случаются крайне редко.

## <a name="connect-to-a-read-only-replica"></a>Подключение к реплике только для чтения

При включении для базы данных горизонтального масштабирования для чтения предоставляемый клиентом параметр `ApplicationIntent` в строке подключения определяет, куда направляется подключение: к реплике для записи или к реплике только для чтения. В частности, если значение `ApplicationIntent` — `ReadWrite` (по умолчанию), подключение направляется к реплике базы данных для чтения и записи. Также происходит и без этой функции. Если значение `ApplicationIntent` — `ReadOnly`, подключение направляется к реплике, доступной только для чтения.

Например, следующая строка подключения позволяет подключить клиента к реплике только для чтения (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```sql
Server=tcp:<server>.database.windows.net;Database=<mydatabase>;ApplicationIntent=ReadOnly;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;
```

Обе приведенные ниже строки подключения подключают подключить клиента к реплике для чтения и записи (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```sql
Server=tcp:<server>.database.windows.net;Database=<mydatabase>;ApplicationIntent=ReadWrite;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;

Server=tcp:<server>.database.windows.net;Database=<mydatabase>;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;
```

## <a name="verify-that-a-connection-is-to-a-read-only-replica"></a>Убедитесь, что подключение выполняется к реплике только для чтения

Можно проверить, подключены ли вы к реплике только для чтения, выполнив приведенный ниже запрос. Он возвращает READ_ONLY при подключении к реплике только для чтения.

```sql
SELECT DATABASEPROPERTYEX(DB_NAME(), 'Updateability')
```

> [!NOTE]
> В отдельно взятый момент времени только одна из реплик AlwaysON доступна в сеансах только для чтения.

## <a name="monitoring-and-troubleshooting-read-only-replica"></a>Мониторинг и устранение неполадок только для чтения реплики

При подключении к реплике только для чтения можно `sys.dm_db_resource_stats` получить доступ к показателям производительности с помощью DMV. Чтобы получить доступ к `sys.dm_exec_query_stats`статистике `sys.dm_exec_query_plan` `sys.dm_exec_sql_text` плана запросов, используйте dM-и DMV.

> [!NOTE]
> DMV `sys.resource_stats` в логической основной базе данных возвращает данные об использовании и хранении процессора первичной реплики.

## <a name="enable-and-disable-read-scale-out"></a>Включение и отключение горизонтального масштабирования для чтения

Чтение Scale-Out включено по умолчанию на уровнях Premium, Business Critical и Hyperscale. Чтение Масштаб-Out не может быть включено в базовых, стандартных или общих уровнях службы общего назначения. Чтение Scale-Out автоматически отключено в базах данных Hyperscale, настроенных с 0 репликами.

Вы можете отключить и повторно включить Чтение Масштаб-Out на отдельных базах данных и эластичных базах данных пула в Премиум или Бизнес Критический уровень обслуживания, используя следующие методы.

> [!NOTE]
> Возможность отключить Read Scale-Out обеспечивается для обратной совместимости.

### <a name="azure-portal"></a>Портал Azure

Вы можете управлять настройками чтения шкалы на лезвии базы данных **Настройка.**

### <a name="powershell"></a>PowerShell

> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager (RM) по-прежнему поддерживается базой данных Azure S'L, но все будущие разработки предназначены для модуля Az.Sql. Модуль AzureRM будет получать исправления ошибок по крайней мере до декабря 2020 года.  Аргументы для команд в модуле Az и в модулях Azrm существенно идентичны. Подробнее об их совместимости читайте [в новом модуле Azure PowerShell Az.](/powershell/azure/new-azureps-module-az)

Для управления горизонтальным масштабированием для чтения в Azure PowerShell требуется выпуск Azure PowerShell за декабрь 2016 года или более поздней версии. Последнюю версию Azure PowerShell см. [здесь](https://docs.microsoft.com/powershell/azure/install-az-ps).

Вы можете отключить или повторно включить Чтение Масштаб-Out в Azure PowerShell, ссылаясь на [Set-AzSqlDatabase](/powershell/module/az.sql/set-azsqldatabase) `Enabled` cmdlet и проходя в нужное значение - или `Disabled` - для `-ReadScale` параметра.

Чтобы отключить масштаб чтения в существующей базе данных (замена элементов в угловых скобках правильными значениями для среды и сброс угловых кронштейнов):

```powershell
Set-AzSqlDatabase -ResourceGroupName <resourceGroupName> -ServerName <serverName> -DatabaseName <databaseName> -ReadScale Disabled
```

Чтобы отключить масштаб чтения в новой базе данных (замена элементов в угловых скобках правильными значениями для среды и сброс угловых кронштейнов):

```powershell
New-AzSqlDatabase -ResourceGroupName <resourceGroupName> -ServerName <serverName> -DatabaseName <databaseName> -ReadScale Disabled -Edition Premium
```

Повторное включение масштабирования чтения в существующую базу данных (замена элементов в угловых скобках правильными значениями для среды и удаление угловых скобок):

```powershell
Set-AzSqlDatabase -ResourceGroupName <resourceGroupName> -ServerName <serverName> -DatabaseName <databaseName> -ReadScale Enabled
```

### <a name="rest-api"></a>REST API

Чтобы создать базу данных с отключением масштаба чтения или изменить настройку существующей базы данных, используйте следующий метод с `readScale` набором свойств `Enabled` или `Disabled` как в запросе ниже образца.

```rest
Method: PUT
URL: https://management.azure.com/subscriptions/{SubscriptionId}/resourceGroups/{GroupName}/providers/Microsoft.Sql/servers/{ServerName}/databases/{DatabaseName}?api-version= 2014-04-01-preview
Body: {
   "properties": {
      "readScale":"Disabled"
   }
}
```

Дополнительные сведения см. в статье о [создании или обновлении базы данных](https://docs.microsoft.com/rest/api/sql/databases/createorupdate).

## <a name="using-tempdb-on-read-only-replica"></a>Использование TempDB на реплике только для чтения

База данных TempDB не реплицируется в реплики только для чтения. Каждая реплика имеет свою собственную версию базы данных TempDB, которая создается при создании реплики. Это гарантирует, что TempDB обновляется и может быть изменен во время выполнения запроса. Если рабочая нагрузка только для чтения зависит от использования объектов TempDB, следует создать эти объекты как часть скрипта запроса.

## <a name="using-read-scale-out-with-geo-replicated-databases"></a>Использование горизонтального масштабирования для чтения с геореплицированными базами данных

Если вы используете Читу Scale-Out для загрузки-баланса только для чтения рабочих нагрузок на базу данных, которая является гео-реплицируется (например, в качестве члена группы failover), убедитесь, что масштаб чтения включен как на первичной, так и в гео-реплицированных вторичных базах данных. Эта конфигурация гарантирует, что тот же опыт балансировки нагрузки будет продолжаться, когда приложение подключается к новому основному после сбоя. Если подключение к геореплицированной базе данных-получателю выполняется с включенной функцией масштабирования для чтения, ваши сеансы с `ApplicationIntent=ReadOnly` будут направляться в одну из реплик, так же как и в случае с маршрутизацией подключений к базе данных-источнику.  Сеансы без `ApplicationIntent=ReadOnly` будут направляться в первичную реплику геореплицированной базы данных-получателя (тоже только для чтения). Поскольку геореплицированная вторичная база данных имеет иную конечную точку, `ApplicationIntent=ReadOnly`чем основная база данных, исторически для доступа к вторичной не требовалось устанавливать . Для обеспечения обратной совместимости в динамическом административном представлении `sys.geo_replication_links` отображается `secondary_allow_connections=2` (разрешены любые подключения клиента).

> [!NOTE]
> Круглая или любая другая сбалансированная нагрузка, конечно., между локальными копиями вторичной базы данных не поддерживается.

## <a name="next-steps"></a>Дальнейшие действия

- Для получения информации о гипермасштабе базы данных S'L [см.](./sql-database-service-tier-hyperscale.md)
