---
title: База данных SQL Azure. Чтение запросов в репликах | Документация Майкрософт
description: Базы данных SQL Azure позволяет балансировать нагрузку рабочих нагрузок только для чтения, используя емкость реплик только для чтения — именем масштабирование для чтения.
services: sql-database
ms.service: sql-database
ms.subservice: scale-out
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: sstein, carlrab
manager: craigg
ms.date: 06/03/2019
ms.openlocfilehash: 1b452fb0bac91429793f8d55e439c36c70784722
ms.sourcegitcommit: 600d5b140dae979f029c43c033757652cddc2029
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/04/2019
ms.locfileid: "66492724"
---
# <a name="use-read-only-replicas-to-load-balance-read-only-query-workloads"></a>Использование реплик только для чтения для рабочих нагрузок только для чтения запросов балансировки нагрузки

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Как часть [архитектура высокого уровня доступности](./sql-database-high-availability.md#premium-and-business-critical-service-tier-availability), каждая база данных уровня "премиум", критически важный для бизнеса или крупномасштабным автоматически подготавливается с одной первичной и несколько вторичных реплик. Вторичные реплики, подготавливаются того же размера вычислений, что и первичная реплика. **Масштабирование для чтения** компонент позволяет сбалансировать базы данных SQL только для чтения рабочих нагрузок с использованием возможности одной из реплик только для чтения вместо совместного использования реплику чтения и записи. Таким образом рабочая нагрузка только для чтения изолируется от главных рабочих нагрузок чтения и записи и не влияет на их производительность. Эта функция предназначена для приложений, которые включают логически разделенные рабочие нагрузки только для чтения, например для анализа. Они могут получить преимущества производительности, используя дополнительную емкость за все это не предоставляются бесплатно.

На следующей схеме показано с помощью критически важный для базы данных.

![Реплики только для чтения](media/sql-database-read-scale-out/business-critical-service-tier-read-scale-out.png)

Масштабирование для чтения включена по умолчанию на "премиум" критически важный для бизнеса и крупномасштабным баз данных. Если строки подключения SQL настроена с помощью `ApplicationIntent=ReadOnly`, приложения будут перенаправляться в шлюз к реплике только для чтения этой базы данных. Сведения о том, как использовать `ApplicationIntent` свойство, см. в разделе [указании назначения приложения](https://docs.microsoft.com/sql/relational-databases/native-client/features/sql-server-native-client-support-for-high-availability-disaster-recovery#specifying-application-intent).

Если вы хотите убедиться, что приложение подключается к первичной реплике, независимо от `ApplicationIntent` параметр в строке подключения SQL, необходимо явно отключить масштабирование для чтения при создании базы данных или изменение его конфигурации. Например если обновить базу данных с уровня "стандартный" или общего назначения для уровня "премиум", критически важный для бизнеса или крупномасштабным и хотим убедиться, что все подключения отправлялись на первичной реплике, отключите масштабирование для чтения. Дополнительные сведения о том, как отключить его, см. в разделе [Включение и отключение горизонтального масштабирования чтения](#enable-and-disable-read-scale-out).

> [!NOTE]
> Запрос данных Store, расширенных событий, SQL Profiler и функции аудита не поддерживаются в репликах только для чтения. 

## <a name="data-consistency"></a>Согласованность данных

Одним из преимуществ реплик является то, что реплики всегда находятся в состоянии транзакционной согласованности, но в разные моменты времени может возникать небольшая задержка между различными репликами. Горизонтальное масштабирование для чтения поддерживает согласованность на уровне сеанса. Это означает, если сеанс только для чтения будет повторно подключаться после ошибки соединения, вызвана недоступностью реплики, он может быть перенаправлен на реплику, которая не равно 100% курсе реплику чтения и записи. Аналогично Если приложение записывает данные с помощью сеанса чтения и записи и сразу же считывает их с помощью сеанса только для чтения, это возможно, что последние обновления, не видны сразу в реплике. Задержка вызвана операцию повтора журнала асинхронных транзакций.

> [!NOTE]
> Задержки репликации в пределах региона случаются крайне редко.

## <a name="connect-to-a-read-only-replica"></a>Подключение к реплике только для чтения

При включении для базы данных горизонтального масштабирования для чтения предоставляемый клиентом параметр `ApplicationIntent` в строке подключения определяет, куда направляется подключение: к реплике для записи или к реплике только для чтения. В частности, если значение `ApplicationIntent` — `ReadWrite` (по умолчанию), подключение направляется к реплике базы данных для чтения и записи. Также происходит и без этой функции. Если значение `ApplicationIntent` — `ReadOnly`, подключение направляется к реплике, доступной только для чтения.

Например, следующая строка подключения позволяет подключить клиента к реплике только для чтения (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```SQL
Server=tcp:<server>.database.windows.net;Database=<mydatabase>;ApplicationIntent=ReadOnly;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;
```

Обе приведенные ниже строки подключения подключают подключить клиента к реплике для чтения и записи (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```SQL
Server=tcp:<server>.database.windows.net;Database=<mydatabase>;ApplicationIntent=ReadWrite;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;

Server=tcp:<server>.database.windows.net;Database=<mydatabase>;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;
```

## <a name="verify-that-a-connection-is-to-a-read-only-replica"></a>Убедитесь, что подключение выполняется к реплике только для чтения

Можно проверить, подключены ли вы к реплике только для чтения, выполнив приведенный ниже запрос. Он возвращает READ_ONLY при подключении к реплике только для чтения.

```SQL
SELECT DATABASEPROPERTYEX(DB_NAME(), 'Updateability')
```

> [!NOTE]
> В отдельно взятый момент времени только одна из реплик AlwaysON доступна в сеансах только для чтения.

## <a name="monitoring-and-troubleshooting-read-only-replica"></a>Мониторинг и устранение неполадок реплика только для чтения

При подключении к реплике только для чтения, доступны метрики производительности с помощью `sys.dm_db_resource_stats` динамического административного Представления. Для доступа к статистике плана запросов, используйте `sys.dm_exec_query_stats`, `sys.dm_exec_query_plan` и `sys.dm_exec_sql_text` динамических административных представлений.

> [!NOTE]
> Динамическое административное Представление `sys.resource_stats` в логической базе данных master возвращает ЦП использования и хранилища данных первичной реплики.


## <a name="enable-and-disable-read-scale-out"></a>Включение и отключение горизонтального масштабирования для чтения

Масштабирование для чтения включена по умолчанию для уровней службы "премиум", критически важный для бизнеса и ИТ. Невозможно включить масштабирование для чтения на уровнях служб Basic, Standard или общего назначения. Масштабирование для чтения в базах данных Гипермасштабируемого настроено 0 реплик автоматически отключается. 

Можно отключить и повторно включить масштабирование для чтения на отдельных баз данных и эластичного пула баз данных в уровень служб "премиум" или критически важный для бизнеса, с помощью следующих методов.

> [!NOTE]
> Возможность отключить масштабирование для чтения предоставляется для обеспечения обратной совместимости.

### <a name="azure-portal"></a>Портал Azure

Можно управлять параметрами горизонтального Sacle чтения на **Настройка** колонка базы данных. 

### <a name="powershell"></a>PowerShell

Для управления горизонтальным масштабированием для чтения в Azure PowerShell требуется выпуск Azure PowerShell за декабрь 2016 года или более поздней версии. Последнюю версию Azure PowerShell см. [здесь](https://docs.microsoft.com/powershell/azure/install-az-ps).

Можно отключить или включить масштабирование для чтения в Azure PowerShell, вызвав [набора AzSqlDatabase](/powershell/module/az.sql/set-azsqldatabase) командлета и передавая нужное значение — `Enabled` или `Disabled` --для `-ReadScale` параметра. 

Чтобы отключить масштабирование для чтения в существующей базе данных (Замените элементы в угловых скобках правильными значениями для своей среды и удалите угловые скобки):

```powershell
Set-AzSqlDatabase -ResourceGroupName <myresourcegroup> -ServerName <myserver> -DatabaseName <mydatabase> -ReadScale Disabled
```
Чтобы отключить масштабирование для чтения на новую базу данных (Замените элементы в угловых скобках правильными значениями для своей среды и удалите угловые скобки):

```powershell
New-AzSqlDatabase -ResourceGroupName <myresourcegroup> -ServerName <myserver> -DatabaseName <mydatabase> -ReadScale Disabled -Edition Premium
```

Чтобы снова включить масштабирование для чтения в существующей базе данных (Замените элементы в угловых скобках правильными значениями для своей среды и удалите угловые скобки):

```powershell
Set-AzSqlDatabase -ResourceGroupName <myresourcegroup> -ServerName <myserver> -DatabaseName <mydatabase> -ReadScale Enabled
```

### <a name="rest-api"></a>REST API

Создание базы данных с помощью масштабирование для чтения отключена, или изменить параметр для существующей базы данных, используйте следующий метод с `readScale` свойство значение `Enabled` или `Disabled` как показано на ниже пример запроса.

```rest
Method: PUT
URL: https://management.azure.com/subscriptions/{SubscriptionId}/resourceGroups/{GroupName}/providers/Microsoft.Sql/servers/{ServerName}/databases/{DatabaseName}?api-version= 2014-04-01-preview
Body:
{
   "properties":
   {
      "readScale":"Disabled"
   }
}
```

Дополнительные сведения см. в статье о [создании или обновлении базы данных](https://docs.microsoft.com/rest/api/sql/databases/createorupdate).

## <a name="using-tempdb-on-read-only-replica"></a>С помощью базы данных TempDB на реплики только для чтения

База данных TempDB не реплицируется на реплики только для чтения. Каждая реплика имеет свою собственную версию базы данных TempDB, который создается при создании реплики. Это гарантирует, что база данных TempDB может обновляться и могут быть изменены во время выполнения запроса. Если рабочая нагрузка только для чтения зависит от того, с помощью объектов базы данных TempDB, следует создать эти объекты как часть сценария запроса. 

## <a name="using-read-scale-out-with-geo-replicated-databases"></a>Использование горизонтального масштабирования для чтения с геореплицированными базами данных

Если вы используете масштабирование для чтения для рабочих нагрузок только для чтения балансировать нагрузку на базу данных, осуществляется георепликация (например, в качестве члена группы отработки отказа), убедитесь, что масштабирование для чтения включен как основного, так и географически реплицированных баз данных-получателей. Эта конфигурация гарантирует, что те же возможности балансировки нагрузки продолжает, когда приложение подключается к новой первичной реплики после отработки отказа. Если подключение к геореплицированной базе данных-получателю выполняется с включенной функцией масштабирования для чтения, ваши сеансы с `ApplicationIntent=ReadOnly` будут направляться в одну из реплик, так же как и в случае с маршрутизацией подключений к базе данных-источнику.  Сеансы без `ApplicationIntent=ReadOnly` будут направляться в первичную реплику геореплицированной базы данных-получателя (тоже только для чтения). Поскольку геореплицируемые изолированные базы данных-получателя имеет другой конечной точке, чем базы данных-источника, традиционно для доступа к получателю не требуется, чтобы она задать `ApplicationIntent=ReadOnly`. Для обеспечения обратной совместимости в динамическом административном представлении `sys.geo_replication_links` отображается `secondary_allow_connections=2` (разрешены любые подключения клиента).

> [!NOTE]
> Циклический перебор или какой-либо других с балансировкой нагрузки маршрутизации между локальной реплики базы данных-получателя не поддерживается.

## <a name="next-steps"></a>Дальнейшие действия

- Сведения о предложении обработки базы данных SQL, см. в разделе [уровня службы Гипермасштабируемого](./sql-database-service-tier-hyperscale.md).
