---
title: Группы отработки отказа. База данных SQL Azure | Документация Майкрософт
description: Группы автоматической отработки отказа являются возможностью Базы данных SQL, которая позволяет управлять репликацией и автоматической или согласованной отработкой отказа группы баз данных на сервере Базы данных SQL или во всех базах данных в управляемом экземпляре.
services: sql-database
ms.service: sql-database
ms.subservice: high-availability
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, carlrab
ms.date: 07/18/2019
ms.openlocfilehash: 5d79edc4db07a2c5916725efc312d9f94fe985dc
ms.sourcegitcommit: 3877b77e7daae26a5b367a5097b19934eb136350
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/30/2019
ms.locfileid: "68640088"
---
# <a name="use-auto-failover-groups-to-enable-transparent-and-coordinated-failover-of-multiple-databases"></a>Использование групп автоматической отработки отказа для включения прозрачной и согласованной отработки отказа в нескольких базах данных

Группы автоматической отработки отказа — это функция базы данных SQL, которая позволяет управлять репликацией и отработкой отказа группы баз данных на сервере базы данных SQL или всех базах данных в управляемом экземпляре в другом регионе. Это декларативная абстракция поверх существующей функции [активной георепликации](sql-database-active-geo-replication.md) , предназначенной для упрощения развертывания геореплицируемых баз данных и управления ими в масштабе. Вы можете запустить отработку отказа вручную или делегировать службе Базы данных SQL, используя определяемую пользователем политику. Последний вариант позволяет автоматически восстановить несколько связанных баз данных в дополнительном регионе после катастрофических сбоев или других незапланированных событий, которые приводят к полной или частичной потере доступности службы Базы данных SQL в основном регионе. Группа отработки отказа может включать одну или несколько баз данных, обычно используемых одним приложением. Кроме того, клиенты могут использовать доступные для чтения базы данных-получатели для разгрузки рабочих нагрузок запросов, доступных только для чтения. Так как группы автоматической отработки отказа включают в себя несколько баз данных, базы данных необходимо настроить на сервере-источнике. Основной и дополнительный серверы баз данных в группе отработки отказа должны размещаться в одной подписке. Группы автоматической отработки отказа поддерживают репликацию всех баз данных в группе только на один сервер-получатель в другом регионе.

> [!NOTE]
> Если при работе с отдельными базами данных или с базами данных в пуле на сервере базы данных SQL вы хотите создать несколько вторичных реплик в одном или в разных регионах, используйте [активную георепликацию](sql-database-active-geo-replication.md). 

Во время работы с группами автоматической отработки отказа с политикой автоматической отработки отказа любой сбой, который влияет на одну или на несколько баз данных в группе, приведет к автоматической отработке отказа. Кроме того, группы автоматической отработки отказа предоставляют конечные точки прослушивателя только для чтения и для чтения-записи, которые во время отработки отказа не изменяются. Независимо от того, используете ли вы активацию вручную или автоматическую активацию отработки отказа, отработка отказа переключит все базы данных-получатели в группе в базу данных-источник. После выполнения автоматической отработки отказа базы данных запись DNS автоматически обновляется, чтобы перенаправить конечные точки в новый регион. Конкретные сведения о RPO и RTO можно найти в [обзоре обеспечения непрерывности бизнес-процессов](sql-database-business-continuity.md).

Во время работы с группами автоматической отработки отказа с политикой автоматической отработки отказа любой сбой, который влияет на базы данных на сервере Базы данных SQL или в управляемом экземпляре, приведет к автоматической отработки отказа. Управляйте группами автоматической отработки отказа используя:

- [портал Azure](sql-database-implement-geo-distributed-database.md).
- [PowerShell: группа отработки отказа](scripts/sql-database-add-single-db-to-failover-group-powershell.md);
- [REST API: группа отработки отказа](https://docs.microsoft.com/rest/api/sql/failovergroups).

После отработки отказа убедитесь, что для новой базы данных-источника настроены требования аутентификации ваших сервера и базы данных. Дополнительные сведения см. в разделе [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).

Добавление избыточности баз данных между центрами обработки данных — только часть решения для достижения настоящей непрерывности бизнес-процессов. Для комплексного восстановления приложения (службы) после катастрофического сбоя необходимо восстановить все компоненты, из которых состоит служба и все зависимые службы. К примерам этих компонентов относятся клиентское программное обеспечение (например, браузер с пользовательским кодом JavaScript), интерфейсные веб-серверы, хранилище и DNS. Очень важно, чтобы все компоненты были устойчивы к одинаковым сбоям и становились доступными в соответствии с целевым временем восстановления (RTO) вашего приложения. Следовательно, необходимо определить все зависимые службы и получить сведения о гарантиях и возможностях, которые они предоставляют. Затем необходимо выполнить соответствующие действия, чтобы обеспечить работу службы во время отработки отказа служб, от которых она зависит. Дополнительные сведения о проектировании решений для аварийного восстановления см. в статье о [разработке облачных решений для аварийного восстановления с помощью активной георепликации](sql-database-designing-cloud-solutions-for-disaster-recovery.md).

## <a name="auto-failover-group-terminology-and-capabilities"></a>Терминология и способности группы автоматической отработки отказа

- **Группа отработки отказа (туман)**

  Группа отработки отказа — это именованная группа баз данных, управляемая одним сервером базы данных SQL или одним управляемым экземпляром, которые могут выполнять отработку отказа в другой регион в случае, если все или некоторые базы данных-получатели становятся недоступными вследствие сбоя в основном регионе. При создании для управляемых экземпляров группа отработки отказа содержит все пользовательские базы данных в экземпляре, поэтому в экземпляре можно настроить только одну группу отработки отказа.
  
  > [!IMPORTANT]
  > Имя группы отработки отказа должно быть глобально уникальным `.database.windows.net` в пределах домена.

- **Серверы Базы данных SQL**

     С помощью серверов Базы данных SQL можно разместить некоторые или все пользовательские базы данных с отдельного сервера Базы данных SQL в группе отработки отказа. Сервер Базы данных SQL также поддерживает несколько групп отработки отказа на отдельном сервере Базы данных SQL.

- **Источник**

  Сервер базы данных SQL или управляемый экземпляр, на котором размещены базы данных источника в группе отработки отказа.

- **Получатель**

  Сервер базы данных SQL или управляемый экземпляр, на котором размещены базы данных-получатели в группе отработки отказа. Источники и получатели не могут находиться в одном и том же регионе.

- **Добавление отдельных баз данных в группу отработки отказа**

  Вы можете разместить несколько отдельных баз данных на одном сервере Базы данных SQL в одной группе отработки отказа. Если вы добавите отдельную базу данных в группу отработки отказа, она автоматически создаст базу данных-получатель, используя тот же выпуск и объем вычислительных ресурсов на сервере-получателе.  Этот сервер следует указать при создании группы отработки отказа. Если вы добавите базу данных, у которой уже есть база данных-получатель на сервере-получателе, эта ссылка на георепликацию наследуется группой. Во время добавления базы данных, у которой уже есть база данных-получатель на сервере, которая не является частью группы отработки отказа, на этом сервере-получателе будет создана новая база данных-получатель.
  
  > [!IMPORTANT]
  > В управляемом экземпляре реплицируются все пользовательские базы данных. Нельзя выбирать подмножество для репликации пользовательских баз данных в группе отработки отказа.

- **Добавление баз данных в эластичный пул в группе отработки отказа**

  Вы можете разместить несколько баз данных или их все в эластичном пуле в одну группу отработки отказа. Если база данных-источник расположена в эластичном пуле, в нем автоматически создается база данных-получатель с тем же именем (вторичный пул). Необходимо убедиться, что сервер-получатель содержит эластичный пул с тем же именем и имеет достаточную емкость для размещения баз данных-получателей, которые будут созданы группой отработки отказа. Если вы добавите базу данных в пул, у которого уже есть база данных-получатель на вторичном пуле, эта ссылка на георепликацию наследуется группой. Во время добавления базы данных, у которой уже есть база данных-получатель на сервере, которая не является частью группы отработки отказа, в этом вторичном пуле будет создана новая база данных-получатель.
  
- **Зона DNS**

  Уникальный идентификатор, который автоматически создается при создании нового экземпляра. Сертификат с несколькими доменами (SAN) для этого экземпляра подготавливается для проверки подлинности клиентских подключений к любому экземпляру в той же зоне DNS. Два управляемых экземпляра в одной группе отработки отказа должны иметь общий доступ к зоне DNS. 
  
  > [!NOTE]
  > Идентификатор зоны DNS не требуется для групп отработки отказа, созданных для серверов базы данных SQL.

- **Прослушиватель чтения и записи для группы отработки отказа**

  Запись DNS CNAME, которая указывает на текущий основной URL-адрес. Он создается автоматически при создании группы отработки отказа и позволяет рабочей нагрузке SQL для чтения и записи прозрачно повторно подключаться к базе данных-источнику при изменении основных изменений после отработки отказа. При создании группы отработки отказа на сервере базы данных SQL запись CNAME DNS для URL-адреса прослушивателя формируется `<fog-name>.database.windows.net`как. При создании группы отработки отказа на управляемом экземпляре запись DNS CNAME для URL-адреса прослушивателя `<fog-name>.zone_id.database.windows.net`формируется как.

- **Прослушиватель только для чтения для группы отработки отказа**

  Формируется запись DNS CNAME, которая указывает на прослушиватель только для чтения, указывающий на URL-адрес получателя. Он создается автоматически при создании группы отработки отказа и позволяет рабочей нагрузке SQL только для чтения прозрачно подключаться к базе данных-получателю с помощью указанных правил балансировки нагрузки. При создании группы отработки отказа на сервере базы данных SQL запись CNAME DNS для URL-адреса прослушивателя формируется `<fog-name>.secondary.database.windows.net`как. При создании группы отработки отказа на управляемом экземпляре запись DNS CNAME для URL-адреса прослушивателя `<fog-name>.zone_id.secondary.database.windows.net`формируется как.

- **Политика автоматической отработки отказа**

  По умолчанию группа отработки отказа настроена с помощью политики автоматической отработки отказа. Служба базы данных SQL запускает отработку отказа после обнаружения сбоя и истечения льготного периода. Системе необходимо убедиться, что сбой нельзя устранить с помощью встроенной [инфраструктуры обеспечения высокой доступности Службы базы данных SQL](sql-database-high-availability.md) из-за масштаба влияния. Если вы хотите управлять рабочим процессом отработки отказа из приложения, вы можете отключить автоматическую отработку отказа.

- **Политика отработки отказа только для чтения**

  По умолчанию группа отработки отказа только для чтения отключена. Это гарантирует, что производительность базы данных-источника не изменится, если база данных-получателя отключена. Тем не менее, это также означает, что невозможно будет активировать сеансы только для чтения, пока база данных-получателя не восстановится. Если вас не устраивает время простоя для сеансов с доступом только для чтения, и вы предпочитаете временно использовать базы данных-источника для режима только для чтения, а также для режима чтения и записи трафика за счет возможного замедления производительности источника, вы можете включить отработку отказа в сеансе с доступом только для чтения. В этом случае трафик только для чтения будет автоматически перенаправлен на сервер-источник, если дополнительный сервер недоступен.

- **Плановая отработка отказа**

   Плановая отработка отказа выполняет полную синхронизацию между базой данных-источник и базой данных-получатель, прежде чем база данных-получатель переключится на основную роль. Такая обработка отказа гарантирует отсутствие потерь данных. Плановая отработка отказа используется в следующих сценариях.

  - Тестирование аварийного восстановления (DR) в рабочей среде в случае, если потеря данных неприемлема.
  - Перемещение баз данных в другой регион.
  - Возвращение баз данных в основной регион после устранения сбоя (восстановление размещения).

- **Незапланированная отработка отказа**

   При незапланированной или принудительной отработке отказа база данных-получатель немедленно переключается на основную роль без какой-либо синхронизации с базой данных-источником. Эта операция приведет к потере данных. Незапланированная отработка отказа используется в качестве метода восстановления при сбоях, когда база данных-источник недоступна. Когда исходный первичный сервер возвращается в режим «в сети», он автоматически повторно подключается без синхронизации и становится новым сервером-получателем.

- **Отработка отказа вручную**

  Вы можете запустить отработку отказа вручную в любое время, независимо от настройки автоматической отработки отказа. Если политика автоматической отработки отказа не настроена, для восстановления баз данных в группе отработки отказа в получателя требуется отработка отказа вручную. Вы можете запустить принудительную отработку отказа или адаптированную (с полной синхронизацией данных). Адаптированная отработка отказа может использоваться для перемещения источника в дополнительный регион. После завершения отработки отказа записи DNS автоматически обновляются для установления подключения к новому источнику.

- **Льготный период с потерей данных**

  Так как база данных-источник и база данных-получатель синхронизированы с помощью асинхронной репликации, отработка отказа может привести к потере данных. Вы можете настроить политику автоматической отработки отказа, чтобы представить устойчивость приложения к потере данных. Настраивая параметр **GracePeriodWithDataLossHours**, вы можете управлять продолжительностью периода ожидания системы перед последующим запуском отработки отказа, которая, вероятнее всего, приведет к потере данных.

- **Несколько групп отработки отказа**

  Вы можете настроить несколько групп отработки отказа для одной пары серверов, чтобы управлять масштабом отработок отказа. Каждая группа выполняет отработку отказа независимо от других групп. Если ваше мультитенантное приложение использует эластичные пулы, вы можете воспользоваться этой возможностью, чтобы объединить базу данных-источник и базу данных-получатель в каждом пуле. Таким образом вы сможете снизить последствия сбоя для половины клиентов.

  > [!NOTE]
  > Управляемый экземпляр не поддерживает несколько групп отработки отказа.
  
## <a name="permissions"></a>Разрешения
Управление разрешениями для группы отработки отказа осуществляется [с помощью управления доступом на основе ролей (RBAC)](../role-based-access-control/overview.md). Роль [участника SQL Server](../role-based-access-control/built-in-roles.md#sql-server-contributor) имеет все необходимые разрешения для управления группами отработки отказа. 

### <a name="create-failover-group"></a>Создание группы отработки отказа
Чтобы создать группу отработки отказа, необходим доступ на запись RBAC к серверам-источнику и серверу-получателю, а также ко всем базам данных в группе отработки отказа. Для управляемого экземпляра необходим доступ на запись RBAC к основному и дополнительному управляемому экземпляру, но разрешения на отдельные базы данных не важны, так как отдельные базы данных управляемого экземпляра нельзя добавлять в группу отработки отказа или удалять из нее. 

### <a name="update-a-failover-group"></a>Обновление группы отработки отказа
Чтобы обновить группу отработки отказа, требуется доступ на запись RBAC к группе отработки отказа и все базы данных на текущем сервере-источнике или управляемом экземпляре.  

### <a name="failover-a-failover-group"></a>Переход на другой ресурс группы отработки отказа
Для переключения группы отработки отказа требуется доступ на запись RBAC к группе отработки отказа на новом сервере-источнике или управляемом экземпляре. 

## <a name="best-practices-of-using-failover-groups-with-single-databases-and-elastic-pools"></a>Рекомендации по использованию групп отработки отказа с отдельными базами данных и эластичными пулами

Группу автоматической отработки отказа необходимо настроить на сервере-источнике Базы данных SQL и подключить к серверу-получателю Базы данных SQL в другом регионе Azure.  Группы могут содержать все или некоторые базы данных на этих серверах. На следующей схеме показана типичная конфигурация геоизбыточного облачного приложения, использующего несколько баз данных и активную георепликацию.

![автоматическая отработка отказа](./media/sql-database-auto-failover-group/auto-failover-group.png)

При разработке службы с обеспечением непрерывности бизнес-процессов придерживайтесь следующих рекомендаций.

- **Использование одной или нескольких групп отработки отказа для управления отработкой отказа нескольких баз данных**

  Вы можете создать одну или несколько групп отработки отказа между двумя серверами в различных регионах (для основного сервера и сервера-получателя). Каждая группа может содержать одну или несколько баз данных, которые восстанавливаются единым блоком в случае, когда все или часть баз данных-источников становятся недоступными из-за сбоя в основном регионе. Группа отработки отказа создает базу данных-получатель в дополнительном географическом регионе с таким же целевым уровнем служб, который указан для базы данных-источника. При добавлении существующей связи георепликации к группе отработки отказа убедитесь, что база данных-получатель геореплицируемых данных настроена с тем же уровнем служб и объемом вычислительных ресурсов, что и база данных-источник.

- **Использование прослушивателя чтения и записи для рабочей нагрузки OLTP**

  При выполнении операций OLTP используйте `<fog-name>.database.windows.net` в качестве URL-адреса сервера, чтобы все подключения автоматически перенаправлялись на сервер-источник. Этот URL-адрес не будет изменяться после отработки отказа. Обратите внимание на то, что отработка отказа включает в себя обновление DNS-записи, поэтому клиентские подключения будут перенаправляться на новый сервер-источник только после обновления кэша DNS на стороне клиента.

- **Использование прослушивателя только для чтения для рабочей нагрузки только для чтения**

  Если вы используете логически изолированную рабочую нагрузку в режиме только для чтения, устойчивую к некоторым задержкам в обновлении данных, в приложении можно использовать базу данных-получатель. Для сеансов с доступом только для чтения используйте `<fog-name>.secondary.database.windows.net` в качестве URL-адреса сервера, чтобы подключение автоматически перенаправлялось на сервер-получатель. Кроме того, мы рекомендуем указать режим только для чтения прямо в строке подключения, добавив аргумент **ApplicationIntent=ReadOnly**.

- **Будьте готовы к снижению производительности**

  Решение отработки отказа SQL не зависит от остальной части приложения или других используемых служб. Приложение может смешаться с некоторыми компонентами в одном регионе и с некоторыми в другом. Чтобы избежать снижения производительности, обеспечьте избыточное развертывание приложения в регионе аварийного восстановления и следуйте этим [рекомендациям по безопасности в сети](#failover-groups-and-network-security).

  > [!NOTE]
  > Приложение в регионе аварийного восстановления не требует использования другой строки подключения.  

- **Будьте готовы к потере данных**

  При обнаружении сбоя SQL ожидает в течение периода, указанного в **GracePeriodWithDataLossHours**. Значение этого свойства по умолчанию – 1 час. Если вы не можете позволить себе потерю данных, установите для параметра **GracePeriodWithDataLossHours** достаточно большое количество времени, например 24 часа. Используйте группу ручной отработки отказа для восстановления размещения из получателя в источник.

  > [!IMPORTANT]
  > Эластичные пулы с 800 DTU или менее и более чем 250 базами данных, использующими георепликацию, могут испытывать проблемы, включая более длительные плановые операции отработки отказа и снижение производительности.  Эти проблемы чаще всего возникают из-за рабочих нагрузок, интенсивно записывающих данные, если конечные точки георепликации физически находятся далеко друг от друга или если используется несколько дополнительных конечных точек для каждой базы данных.  Симптомы этих проблем проявляются при увеличении задержки георепликации с течением времени.  Эту задержку можно отслеживать с помощью [sys.dm_geo_replication_link_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-geo-replication-link-status-azure-sql-database).  Если эти проблемы возникли, к возможным способам их устранения относятся увеличение числа DTU пула или уменьшение количества геореплицируемых баз данных в одном пуле.

## <a name="best-practices-of-using-failover-groups-with-managed-instances"></a>Рекомендации по использованию групп отработки отказа с управляемыми экземплярами

Группы автоматической отработки отказа должны быть настроены на экземпляре источника и подключены к экземпляру получателя в другом регионе Azure.  Все базы данных в экземпляре будут реплицированы в экземпляр получателя. На следующей схеме показана типичная конфигурация геоизбыточного облачного приложения, использующего несколько управляемых экземпляров и активную георепликацию.

![автоматическая отработка отказа](./media/sql-database-auto-failover-group/auto-failover-group-mi.png)

> [!IMPORTANT]
> Группы автоматической отработки отказа для управляемого экземпляра предоставляются в общедоступной предварительной версии.

Если приложение использует управляемый экземпляр в качестве уровня данных, при проектировании непрерывности бизнес-процессов следуйте приведенным ниже общим рекомендациям.

- **Создание экземпляра получателя в той же зоне DNS, что и для экземпляра источника**

  Чтобы обеспечить беспрерывное подключение к экземпляру источника после отработки отказа, экземпляры и источника, и получателя должны находиться в одной зоне DNS. Это гарантирует, что один и тот же сертификат с несколькими доменами (SAN) можно использовать для проверки подлинности клиентских подключений к одному из двух экземпляров в группе отработки отказа. После подготовки вашего приложения к рабочему развертыванию создайте экземпляр получателя в другом регионе и убедитесь, что он использует ту же зону DNS, что и экземпляр источника. Это можно сделать, указав `DNS Zone Partner` необязательный параметр с помощью портал Azure, PowerShell или REST API. 

  Дополнительные сведения о создании экземпляра-получателя в той же зоне DNS, что и основной экземпляр, см. в разделе [Управление группами отработки отказа с помощью управляемых экземпляров (Предварительная версия)](#powershell-managing-failover-groups-with-managed-instances-preview).

- **Включение трафика репликации между двумя экземплярами**

  Поскольку каждый экземпляр изолирован в своей виртуальной сети, двусторонний трафик между этими виртуальными сетями должен быть разрешен. См. [VPN-шлюзы Azure](../vpn-gateway/vpn-gateway-about-vpngateways.md)

- **Настройка группы отработки отказа для управления отработками отказов для всего экземпляра**

  Группа отработки отказа будет управлять отработкой отказа всех баз данных в экземпляре. При создании группы каждая база данных в экземпляре будет автоматически геореплицироваться в экземпляр получателя. Вы не можете использовать группы отработки отказа для запуска частичной отработки отказа подмножества баз данных.

  > [!IMPORTANT]
  > Если база данных удалена из экземпляра источника, то она также будет автоматически удалена из экземпляра геополучателя.

- **Использование прослушивателя чтения и записи для рабочей нагрузки OLTP**

  При выполнении операций OLTP используйте `<fog-name>.zone_id.database.windows.net` в качестве URL-адреса сервера, чтобы все подключения автоматически перенаправлялись на сервер-источник. Этот URL-адрес не будет изменяться после отработки отказа. Отработка отказа включает в себя обновление DNS-записи, поэтому клиентские подключения будут перенаправляться на новый сервер-источник только после обновления кэша DNS на стороне клиента. Так как вторичный экземпляр использует зону DNS в качестве базы данных-источника, клиентское приложение сможет повторно подключиться к нему, используя тот же сертификат SAN.

- **Прямое подключение к георепликации получателя для запросов только для чтения**

  Если вы используете логически изолированную рабочую нагрузку в режиме только для чтения, устойчивую к некоторым задержкам в обновлении данных, в приложении можно использовать базу данных-получатель. Для прямого подключения к георепликации получателя используйте `server.secondary.zone_id.database.windows.net` в качестве URL-сервера.

  > [!NOTE]
  > На некоторых уровнях служб База данных SQL Azure поддерживает использование [реплик только для чтения](sql-database-read-scale-out.md) для балансировки рабочих нагрузок запросов только для чтения, используя возможности одной реплики и параметра `ApplicationIntent=ReadOnly` в строке соединения. После настройки георепликации получателя вы можете использовать эту возможность для соединения с репликой только для чтения либо в основном расположении, либо в геореплицированном расположении.
  > - Для подключения к реплике только для чтения в основном расположении используйте `<fog-name>.zone_id.database.windows.net`.
  > - Чтобы подключиться к реплике только для чтения в дополнительном расположении, `<fog-name>.secondary.zone_id.database.windows.net`используйте.

- **Будьте готовы к снижению производительности**

  Решение отработки отказа SQL не зависит от остальной части приложения или других используемых служб. Приложение может смешаться с некоторыми компонентами в одном регионе и с некоторыми в другом. Чтобы избежать снижения производительности, обеспечьте избыточное развертывание приложения в регионе аварийного восстановления и следуйте этим [рекомендациям по безопасности в сети](#failover-groups-and-network-security).

- **Будьте готовы к потере данных**

  При обнаружении сбоя SQL автоматически активирует отработку отказа с чтением и записью, если потери данных нулевые, насколько нам известно. В противном случае он ожидает в течение периода, указанного в `GracePeriodWithDataLossHours`. Если вы указали `GracePeriodWithDataLossHours`, будьте готовы к потере данных. Во время сбоев Azure, как правило, повышает доступность. Если вы не можете позволить себе потерю данных, установите для параметра GracePeriodWithDataLossHours достаточно большое количество времени, например 24 часа.

  После запуска отработки отказа DNS обновления прослушивателя чтения и записи произойдут автоматически. Эта операция не приведет к потере данных. Однако процесс смены ролей баз данных в обычных условиях может занять до 5 минут. До окончания этого процесса некоторые базы данных в новом экземпляре источника будут оставаться в режиме только для чтения. Если отработка отказа инициируется с помощью PowerShell, вся операция выполняется синхронно. Если она инициируется с помощью портал Azure, Пользовательский интерфейс будет указывать состояние завершения. Если она инициируется с помощью REST API, то используйте стандартный механизм опроса Azure Resource Manager для мониторинга выполнения.

  > [!IMPORTANT]
  > Используйте группу ручной отработки отказа для перемещения источников в исходное расположение. После устранения сбоя, вызвавшего отработку отказа, вы можете переместить базы данных-источники в исходное расположение. Для этого вам следует инициировать ручную отработку отказа группы.

## <a name="failover-groups-and-network-security"></a>Группы отработки отказа и сетевая безопасность

В некоторых приложениях правила безопасности требуют, чтобы сетевой доступ к уровню данных ограничивался определенным компонентом или компонентами, например виртуальной машиной, веб-службой и т. д. Это создает трудности для обеспечения непрерывности бизнес-процессов и использования групп отработки отказа. При реализации такого ограниченного доступа учитывайте следующие параметры.

### <a name="using-failover-groups-and-virtual-network-rules"></a>Использование групп отработки отказа и правил виртуальной сети

Если вы используете [конечные точки служб и правила виртуальной сети](sql-database-vnet-service-endpoint-rule-overview.md) для ограничения доступа к базе данных SQL, помните, что каждая конечная точка службы для виртуальной сети применяется только к одному региону Azure. Конечная точка не поддерживает прием подключений из подсети в других регионах. Таким образом, только клиентские приложения, развернутые в одном регионе, могут подключаться к базе данных-источнику. Так как результаты отработки отказа в сеансах клиента SQL пересылаются на сервер в другом (дополнительном) регионе, эти сеансы завершатся сбоем, если будут исходить из клиента за пределами этого региона. По этой причине политику автоматической отработки отказа невозможно включить, если на серверы-участники распространяются правила виртуальной сети. Для поддержки перехода на другой ресурс вручную выполните следующие действия:

1. Подготовьте избыточные копии интерфейсных компонентов приложения (веб-службы, виртуальные машины и т. д.) в дополнительном регионе.
2. Настройте [правила виртуальной сети](sql-database-vnet-service-endpoint-rule-overview.md) по отдельности для основного и дополнительного сервера.
3. Включите [отработку отказа внешнего интерфейса с помощью конфигурации диспетчера трафика](sql-database-designing-cloud-solutions-for-disaster-recovery.md#scenario-1-using-two-azure-regions-for-business-continuity-with-minimal-downtime).
4. Инициируйте отработку отказа вручную при обнаружении сбоя. Этот параметр оптимизирован для приложений, требующих последовательной задержки между внешним интерфейсом и уровнем данных, и поддерживает восстановление после сбоя внешнего интерфейса уровня данных или их обоих.

> [!NOTE]
> При использовании **прослушивателя только для чтения** для балансировки рабочей нагрузки только для чтения убедитесь, что эта рабочая нагрузка выполняется на виртуальной машине или в другом ресурсе в дополнительном регионе, чтобы прослушиватель мог подключаться к базе данных-получателю.

### <a name="using-failover-groups-and-sql-database-firewall-rules"></a>Использование групп отработки отказа и правил брандмауэра базы данных SQL

Если для плана обеспечения непрерывности бизнес-процессов требуется отработка отказа с помощью групп с автоматической отработкой отказа, можно ограничить доступ к базе данных SQL с помощью традиционных правил брандмауэра.  Для поддержки автоматического перехода на другой ресурс выполните следующие действия:

1. [создайте общедоступный IP-адрес](../virtual-network/virtual-network-public-ip-address.md#create-a-public-ip-address);
2. [создайте общедоступный балансировщик нагрузки](../load-balancer/quickstart-create-basic-load-balancer-portal.md#create-a-basic-load-balancer) и назначьте ему общедоступный IP-адрес;
3. [создайте виртуальную сеть и виртуальные машины](../load-balancer/quickstart-create-basic-load-balancer-portal.md#create-back-end-servers) для интерфейсных компонентов;
4. [создайте группу безопасности сети](../virtual-network/security-overview.md) и настройте входящие подключения.
5. Убедитесь, что исходящие подключения открыты для базы данных SQL Azure с помощью [тега службы](../virtual-network/security-overview.md#service-tags) "Sql".
6. Создайте [правило брандмауэра базы данных SQL](sql-database-firewall-configure.md), чтобы разрешить входящий трафик из общедоступного IP-адреса, созданного на этапе 1.

Дополнительные сведения о том, как настроить исходящий доступ и какой IP-адрес нужно использовать в правилах брандмауэра, см. в статье [Исходящие подключения в Azure](../load-balancer/load-balancer-outbound-connections.md).

Приведенная выше конфигурация гарантирует, что автоматический переход на другой ресурс не будет блокировать подключения из интерфейсных компонентов, и предполагает, что приложение может выдержать более длительную задержку между интерфейсном и уровнем данных.

> [!IMPORTANT]
> Для обеспечения непрерывности бизнес-процессов при региональных сбоях должна присутствовать географическая избыточность интерфейсных компонентов и баз данных.

## <a name="enabling-geo-replication-between-managed-instances-and-their-vnets"></a>Включение георепликации между управляемыми экземплярами и их виртуальных сетей

При настройке группы отработки отказа между основным и дополнительным управляемыми экземплярами в двух разных регионах каждый экземпляр изолирован с помощью независимой виртуальной сети. Чтобы разрешить трафик репликации между этими виртуальных сетей, убедитесь, что выполнены следующие условия.

1. Два управляемых экземпляра должны находиться в разных регионах Azure.
1. Два управляемых экземпляра должны быть одного уровня службы и иметь одинаковый размер хранилища. 
1. Ваш вторичный управляемый экземпляр должен быть пустым (без пользовательских баз данных).
1. Виртуальные сети, используемые управляемыми экземплярами, должны быть подключены через [VPN-шлюз](../vpn-gateway/vpn-gateway-about-vpngateways.md) или Express Route. Если две виртуальные сети подключаются через локальную сеть, убедитесь в отсутствии портов, блокирующих правила брандмауэра 5022 и 11000-11999. Пиринг глобальной виртуальной сети не поддерживается.
1. У двух управляемых экземпляров виртуальных сетей не может быть перекрывающихся IP-адресов.
1. Необходимо настроить группы безопасности сети (NSG), чтобы порты 5022 и диапазон 11000 ~ 12000 были открытыми для входящих и исходящих подключений из другой управляемой подсети с экземпляром. Это позволяет обеспечить трафик репликации между экземплярами.

   > [!IMPORTANT]
   > Неправильная настройка правил безопасности NSG приводит к задержке операций копирования баз данных.

7. Для экземпляра-получателя настраивается правильный идентификатор зоны DNS. Зона DNS — это свойство управляемого экземпляра, а его идентификатор включается в адрес имени узла. Идентификатор зоны создается в виде случайной строки, когда первый управляемый экземпляр создается в каждой виртуальной сети, и один и тот же идентификатор назначается всем остальным экземплярам в той же подсети. После назначения зону DNS изменить нельзя. Управляемые экземпляры, входящие в одну группу отработки отказа, должны иметь общий доступ к зоне DNS. Это достигается путем передачи идентификатора зоны основного экземпляра в качестве значения параметра Днсзонепартнер при создании экземпляра-получателя. 

## <a name="upgrading-or-downgrading-a-primary-database"></a>Повышение или понижение уровня производительности базы данных-источника

Вы можете повышать или понижать объем вычислительных ресурсов базы данных-источника (в рамках одного уровня служб, а не между уровнем общего назначения и критически важным для бизнеса) без отключения каких-либо баз данных-получателей. При обновлении рекомендуется сначала обновить все базы данных-получатели, а затем обновить сервер-источник. При переходе на более раннюю версию в обратном порядке: переход на более раннюю версию первичного и последующее понижение уровня всех баз данных-получателей. Когда вы повышаете или понижаете базу данных до следующего уровня служб, особенно важно выполнять рекомендацию выше.

Эту последовательность рекомендуется использовать специально, чтобы избежать проблем, когда вторичная версия на более низком SKU перегружается и должна быть повторно заполнена во время обновления или перехода на более раннюю версию. Вы также можете избежать этой проблемы, сделав первичную доступную только для чтения, за счет чего влияют на все рабочие нагрузки чтения и записи для первичной реплики. 

> [!NOTE]
> Если вы создали базу данных-получатель как часть конфигурации группы отработки отказа, понижение ее уровня не рекомендуется. Это необходимо, чтобы обеспечить достаточную емкость уровня данных для обработки регулярных рабочих нагрузок после активации отработки отказа.

> [!IMPORTANT]
> Обновление или понижение уровня Управляемый экземпляр, который является членом группы отработки отказа, в настоящее время не поддерживается.

## <a name="preventing-the-loss-of-critical-data"></a>Предотвращение потери важных данных

Из-за высокой задержки глобальных сетей непрерывная копия использует механизм асинхронной репликации. Ввиду асинхронной репликации потеря данных в случае сбоя неизбежна. Тем не менее для некоторых приложений терять данные недопустимо. Чтобы защитить эти критические обновления, разработчик приложения сразу же после фиксации транзакции может вызывать системную процедуру [sp_wait_for_database_copy_sync](/sql/relational-databases/system-stored-procedures/active-geo-replication-sp-wait-for-database-copy-sync). Вызов **sp_wait_for_database_copy_sync** блокирует вызывающий поток до передачи последней зафиксированной транзакции в базе данных-получателе. Но вызов не дожидается воспроизведения и фиксации переданных транзакций в базе данных-получателе. **sp_wait_for_database_copy_sync** ограничена конкретной связью непрерывной копии. Эту процедуру может вызвать любой пользователь с правами подключения к базе данных-источнику.

> [!NOTE]
> Процедура **sp_wait_for_database_copy_sync** предотвращает потерю данных после отработки отказа, но не гарантирует полную синхронизацию для доступа на чтение. Вызов процедуры **sp_wait_for_database_copy_sync** может привести к значительной задержке, которая будет зависеть от размера журнала транзакций во время вызова.

## <a name="failover-groups-and-point-in-time-restore"></a>Группы отработки отказа и восстановление до точки во времени

Сведения об использовании восстановления до точки во времени с группами отработки отказа см. в разделе [Восстановление до точки во времени (PITR)](sql-database-recovery-using-backups.md#point-in-time-restore).

## <a name="programmatically-managing-failover-groups"></a>Программное управление группами отработки отказа

Как уже говорилось ранее, группами автоматической отработки отказа и активной георепликацией можно также управлять программно с помощью Azure PowerShell и REST API. В приведенных ниже таблицах описан доступный для этого набор команд. Активная георепликация включает в себя набор API-интерфейсов Azure Resource Manager для управления, в том числе [REST API Базы данных SQL Azure](https://docs.microsoft.com/rest/api/sql/) и [командлеты Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview). Эти интерфейсы API требуют использования групп ресурсов и поддерживают безопасность на основе ролей (RBAC). Дополнительные сведения о том, как реализовать контроль доступа на основе ролей, см. в статье [Использование управления доступом на основе ролей для контроля доступа к ресурсам в подписке Azure](../role-based-access-control/overview.md).

### <a name="powershell-manage-sql-database-failover-with-single-databases-and-elastic-pools"></a>PowerShell: Управление отработкой отказа баз данных SQL с отдельными базами данных и эластичными пулами

| Командлет | Описание |
| --- | --- |
| [New-AzSqlDatabaseFailoverGroup](https://docs.microsoft.com/powershell/module/az.sql/set-azsqldatabasefailovergroup) |Создает группу отработки отказа и регистрирует ее на основном сервере и сервере-получателе.|
| [Remove-Азсклдатабасефаиловерграуп](https://docs.microsoft.com/powershell/module/az.sql/remove-azsqldatabasefailovergroup) | Удаляет группу отработки отказа с сервера, а также удаляет все входящие в нее базы данных-получатели. |
| [Get-AzSqlDatabaseFailoverGroup](https://docs.microsoft.com/powershell/module/az.sql/get-azsqldatabasefailovergroup) | Возвращает конфигурацию группы отработки отказа. |
| [Set-Азсклдатабасефаиловерграуп](https://docs.microsoft.com/powershell/module/az.sql/set-azsqldatabasefailovergroup) |Изменяет конфигурацию группы отработки отказа. |
| [Switch-AzSqlDatabaseFailoverGroup](https://docs.microsoft.com/powershell/module/az.sql/switch-azsqldatabasefailovergroup) | Запускает отработку отказа группы отработки отказа на сервер-получатель. |
| [Add-AzSqlDatabaseToFailoverGroup](https://docs.microsoft.com/powershell/module/az.sql/add-azsqldatabasetofailovergroup)|Добавляет одну или несколько баз данных в группу отработки отказа Базы данных SQL Azure.|
|  | |

> [!IMPORTANT]
> Пример сценария см. в статье [Use PowerShell to configure an active geo-replication failover group for a single Azure SQL database](scripts/sql-database-add-single-db-to-failover-group-powershell.md) (Использование PowerShell для настройки группы отработки отказа активной георепликации для отдельной базы данных SQL Azure).
>

### <a name="powershell-managing-failover-groups-with-managed-instances-preview"></a>PowerShell: Управление группами отработки отказа с помощью Управляемого экземпляра (предварительная версия)

#### <a name="install-the-newest-pre-release-version-of-powershell"></a>Установка новой предварительной версии PowerShell

1. Обновите модуль PowerShellGet до версии 1.6.5 (или до новой предварительной версии). См. [Сайт ознакомительной версии PowerShell](https://www.powershellgallery.com/packages/AzureRM.Sql/4.11.6-preview).

   ```powershell
      install-module PowerShellGet -MinimumVersion 1.6.5 -force
   ```

2. В новом окне PowerShell выполните следующие команды.

   ```powershell
      import-module PowerShellGet
      get-module PowerShellGet #verify version is 1.6.5 (or newer)
      install-module azurerm.sql -RequiredVersion 4.5.0-preview -AllowPrerelease –Force
      import-module azurerm.sql
   ```

#### <a name="powershell-commandlets-to-create-an-instance-failover-group"></a>Командлеты PowerShell для создания группы отработки отказа экземпляра

| API | Описание |
| --- | --- |
| New-AzureRmSqlDatabaseInstanceFailoverGroup |Создает группу отработки отказа и регистрирует ее на основном сервере и сервере-получателе.|
| Set-AzureRmSqlDatabaseInstanceFailoverGroup |Изменяет конфигурацию группы отработки отказа.|
| Get-AzureRmSqlDatabaseInstanceFailoverGroup |Возвращает конфигурацию группы отработки отказа.|
| Switch-AzureRmSqlDatabaseInstanceFailoverGroup |Запускает отработку отказа группы отработки отказа на сервер-получатель.|
| Remove-AzureRmSqlDatabaseInstanceFailoverGroup | Удаляет группу отработки отказа.|

### <a name="rest-api-manage-sql-database-failover-groups-with-single-and-pooled-databases"></a>REST API: Управление группами отработки отказа базы данных SQL с отдельными базами данных или с базами данных в пуле

| API | Описание |
| --- | --- |
| [Создание или обновление группы отработки отказа](https://docs.microsoft.com/rest/api/sql/failovergroups/createorupdate) | Создает или обновляет группу отработки отказа. |
| [Удаление группы отработки отказа](https://docs.microsoft.com/rest/api/sql/failovergroups/delete) | Удаляет группу отработки отказа с сервера. |
| [Плановая отработка отказа](https://docs.microsoft.com/rest/api/sql/failovergroups/failover) | Выполняет отработку отказа из текущего основного сервера на этот сервер. |
| [Принудительная отработка отказа (возможна потеря данных)](https://docs.microsoft.com/rest/api/sql/failovergroups/forcefailoverallowdataloss) |Выполняет отработку отказа из текущего основного сервера на этот сервер. Эта операция может привести к потере данных. |
| [Получение группы отработки отказа](https://docs.microsoft.com/rest/api/sql/failovergroups/get) | Получает группу отработки отказа. |
| [Вывод списка групп отработки отказа с фильтрацией по серверу](https://docs.microsoft.com/rest/api/sql/failovergroups/listbyserver) | Перечисляет группы отработки отказа на сервере. |
| [Обновление группы отработки отказа](https://docs.microsoft.com/rest/api/sql/failovergroups/update) | Обновляет группу отработки отказа. |
|  | |

### <a name="rest-api-manage-failover-groups-with-managed-instances-preview"></a>REST API: Управление группами отработки отказа с помощью Управляемого экземпляра (предварительная версия)

| API | Описание |
| --- | --- |
| [Создание или обновление группы отработки отказа](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/createorupdate) | Создает или обновляет группу отработки отказа. |
| [Удаление группы отработки отказа](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/delete) | Удаляет группу отработки отказа с сервера. |
| [Плановая отработка отказа](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/failover) | Выполняет отработку отказа из текущего основного сервера на этот сервер. |
| [Принудительная отработка отказа (возможна потеря данных)](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/forcefailoverallowdataloss) |Выполняет отработку отказа из текущего основного сервера на этот сервер. Эта операция может привести к потере данных. |
| [Получение группы отработки отказа](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/get) | Получает группу отработки отказа. |
| [Перечисление групп отработки отказа – Перечисление по расположению](https://docs.microsoft.com/rest/api/sql/instancefailovergroups/listbylocation) | Перечисляет группы отработки отказа в расположении. |

## <a name="next-steps"></a>Следующие шаги

- Ознакомьтесь с примерами скриптов в следующих статьях:
  - [Настройка активной георепликации для отдельной базы данных в базе данных SQL Azure с помощью PowerShell](scripts/sql-database-setup-geodr-and-failover-database-powershell.md)
  - [Настройка активной георепликации для базы данных в составе пула в базе данных SQL Azure с помощью PowerShell](scripts/sql-database-setup-geodr-and-failover-pool-powershell.md)
  - [Добавление отдельной базы данных SQL Azure в группу отработки отказа с помощью PowerShell](scripts/sql-database-add-single-db-to-failover-group-powershell.md)
- Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md)
- Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь с разделом [Общие сведения об автоматическом резервном копировании базы данных SQL](sql-database-automated-backups.md).
- Чтобы узнать об использовании автоматически создаваемых резервных копий для восстановления, ознакомьтесь с [восстановлением базы данных из резервных копий, инициируемых службой](sql-database-recovery-using-backups.md).
- Дополнительные сведения о требованиях к проверке подлинности для новых сервера-источника и базы данных-источника см. в статье [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).
