---
title: Прозрачное шифрование данных, управляемое клиентами (TDE)
description: Принесите свой собственный ключ (BYOK) поддержку прозрачного шифрования данных (TDE) с Azure Key Vault для базы данных S'L и Azure Synapse. Обзор TDE с поддержкой BYOK, преимущества, принцип работы, замечания и рекомендации.
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: seo-lt-2019, azure-synapse
ms.devlang: ''
ms.topic: conceptual
author: jaszymas
ms.author: jaszymas
ms.reviewer: vanto
ms.date: 03/18/2020
ms.openlocfilehash: 462326fb16663a6f25ff4b51ea11791201086fd6
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79528734"
---
# <a name="azure-sql-transparent-data-encryption-with-customer-managed-key"></a>Прозрачное шифрование данных Azure S'L с ключом, управляемым клиентом

Прозрачное [шифрование данных (TDE)](https://docs.microsoft.com/sql/relational-databases/security/encryption/transparent-data-encryption) с управляемым клиентом ключом позволяет создать сценарий для защиты данных в состоянии покоя и позволяет организациям осуществлять разделение обязанностей в управлении ключами и данными. Благодаря прозрачному шифрованию данных, управляемому клиентом, клиент отвечает за и полный контроль над ключевым жизненным циклом управления (создание ключей, загрузка, вращение, удаление), разрешения на использование ключей и аудит операций на ключах.

В этом сценарии ключом, используемым для шифрования ключа шифрования базы данных (DEK), называемого TDE-протектором, является управляемый клиентом асимметричный ключ, хранящийся в принадлежащем клиенту и управляемом клиентом [Azure Key Vault (AKV)](https://docs.microsoft.com/azure/key-vault/key-vault-secure-your-key-vault)— облачной внешней системе управления ключами. Key Vault является высокодоступным и масштабируемым безопасным хранилищем для криптографических ключей RSA, дополнительно поддерживаемым проверенными модулями аппаратной безопасности (HSMs) УРОВНЯ FIPS 140-2 Level 2. Он не позволяет прямой доступ к сохраненному ключу, но предоставляет услуги шифрования/расшифровки с помощью ключа к авторизованным объектам. Ключ может быть сгенерирован хранилищем ключей, импортирован или [переведен в хранилище ключей с устройства HSM on-prem.](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys)

Для базы данных Azure S'L и Azure Synapse протектор TDE устанавливается на логическом уровне сервера и наследуется всеми зашифрованными базами данных, связанными с этим сервером. Для Azure S'L Managed Instance протектор TDE устанавливается на уровне экземпляра и наследуется всеми зашифрованными базами данных в этом экземпляре. Термин *«сервер»* относится как к логическому серверу базы данных, так и к управляемому экземпляру на протяжении всего документа, если не указано по-другому.

> [!IMPORTANT]
> Для тех, кто использует управляемый сервисом TDE, кто хотел бы начать использовать управляемый клиентом TDE, данные остаются зашифрованными в процессе переключения, и нет времени простоя или повторного шифрования файлов базы данных. Переход от управляемого сервисом ключа к ключу, управляемому клиентом, требует только повторного шифрования DEK, который является быстрой и онлайновой операцией.

## <a name="benefits-of-the-customer-managed-tde"></a>Преимущества управляемого клиентом TDE

TDE, управляемый клиентами, предоставляет клиенту следующие преимущества:

- Полный и детальный контроль за использованием и управлением протектором TDE;

- Прозрачность использования протекторt TDE;

- Возможность осуществления разделения обязанностей в управлении ключами и данными внутри организации;

- Администратор Key Vault может отозвать разрешения на доступ к ключам, чтобы сделать зашифрованную базу данных недоступной;

- Центральное управление ключами в АКВ;

- Большее доверие со стороны ваших конечных клиентов, так как AKV разработан таким образом, что Microsoft не может видеть и извлекать ключи шифрования;

## <a name="how-customer-managed-tde-works"></a>Как работает TDE, управляемый заказчиком

![Настройка и функционирование управляемого заказчиком TDE](./media/transparent-data-encryption-byok-azure-sql/customer-managed-tde-with-roles.PNG)

Для того чтобы сервер мог использовать протектор TDE, хранящийся в AKV, для шифрования DEK администратору хранилища ключей необходимо предоставить следующие права доступа к серверу, используя его уникальную идентификацию AAD:

- **получить** - для извлечения общественной части и свойств ключа в Key Vault

- **wrapKey** - чтобы иметь возможность защитить (шифровать) DEK

- **unwrapKey** - чтобы иметь возможность расохранить (расшифровка) DEK

Администратор хранилища ключей также [может включить журнал событий аудита хранилища ключей,](https://docs.microsoft.com/azure/azure-monitor/insights/azure-key-vault)чтобы они могли быть проверены позже.

Когда сервер настроен для использования протектора TDE от AKV, сервер отправляет DEK каждой базы данных с поддержкой TDE в хранилище ключей для шифрования. Хранилище ключей возвращает зашифрованный DEK, который затем хранится в базе данных пользователя.

При необходимости сервер отправляет защищенный DEK в хранилище ключей для расшифровки.

Аудиторы могут использовать Azure Monitor для просмотра журналов хранилища ключей AuditEvent, если ведется регистрация.

[!INCLUDE [sql-database-akv-permission-delay](includes/sql-database-akv-permission-delay.md)]

## <a name="requirements-for-configuring-customer-managed-tde"></a>Требования к настройке TDE, управляемой клиентами

### <a name="requirements-for-configuring-akv"></a>Требования к настройке AKV

- Хранилище ключей и экземпляр базы данных S'L/управляемый экземпляр должны принадлежать тому же арендатору Active Directory Azure. Взаимодействия ключа хранилища для нескольких клиентов и сервера не поддерживаются. Для перемещения ресурсов после этого TDE с AKV необходимо будет перенастроить. Подробнее о [перемещении ресурсов.](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-move-resources)

- [Функция мягкого удаления](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete) должна быть включена в хранилище ключей, чтобы защитить от случайного удаления ключа (или хранилища ключей) происходит. Мягкие удаленные ресурсы сохраняются в течение 90 дней, если клиент пока не восстанавливает или не удаляет их. С действиями *Восстановить* и *Удалить* связаны отдельные разрешения в политике доступа хранилища ключей. Функция мягкого удаления отключена по умолчанию и может быть включена через [PowerShell](https://docs.microsoft.com/azure/key-vault/key-vault-soft-delete-powershell#enabling-soft-delete) или [CLI.](https://docs.microsoft.com/azure/key-vault/key-vault-soft-delete-cli#enabling-soft-delete) Он не может быть включен через портал Azure.  

- Предоставите серверу базы данных S'L или управляемый экземпляр доступа к хранилищу ключей (получить, обернуть, развернутьключе) с помощью интилита Лазурного Active Directory. При использовании портала Azure иждивенец Azure AD автоматически создается. При использовании PowerShell или CLI идентификатор Azure AD должен быть явно создан и завершение должно быть проверено. Подробные пошаговые инструкции по настройке TDE с поддержкой BYOK с помощью PowerShell см. в [этой статье](transparent-data-encryption-byok-azure-sql-configure.md), а по настройке TDE с поддержкой BYOK для управляемого экземпляра – [в этой](https://aka.ms/sqlmibyoktdepowershell).

- При использовании брандмауэра с AKV необходимо включить *опцию Allow trusted Microsoft services для обхода брандмауэра.*

### <a name="requirements-for-configuring-tde-protector"></a>Требования к настройке протектора TDE

- Протектор TDE может быть только асимметричным, RSA 2048 или RSA HSM 2048 ключ.

- Дата активации ключа (если установлена) должна быть датой и временем в прошлом. Срок действия (если установлен) должен быть будущей датой и временем.

- Ключ должен находиться в состоянии *включено.*

- Если вы импортируете существующий ключ в хранилище ключей, обязательно предоставьте его в поддерживаемых форматах файлов (.pfx, .byok или .backup).

## <a name="recommendations-when-configuring-customer-managed-tde"></a>Рекомендации при настройке управляемого клиентом TDE

### <a name="recommendations-when-configuring-akv"></a>Рекомендации при настройке AKV

- Ассоциированные не более 500 баз данных общего назначения или 200 бизнес-критических баз данных в общей сложности с хранилищем ключей в одной подписке, чтобы обеспечить высокую доступность при доступе к серверу протектору TDE в хранилище ключей. Эти цифры основаны на опыте и задокументированы в [лимитах службы хранилища ключей.](https://docs.microsoft.com/azure/key-vault/key-vault-service-limits) Цель здесь состоит в том, чтобы предотвратить проблемы после сбоя сервера, так как это вызовет столько ключевых операций против хранилища, сколько есть базы данных на этом сервере.

- Установите блокировку ресурсов в хранилище ключей, чтобы контролировать, кто может удалить этот критический ресурс и предотвратить случайное или несанкционированное удаление. Подробнее о [блокировках ресурсов.](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-lock-resources)

- Позволяет проводить аудит и сообщать обо всех ключах шифрования: Key vault предоставляет журналы, которые легко вводить в другие средства безопасности и инструменты управления событиями. Аналитика [Log Analytics](https://docs.microsoft.com/azure/log-analytics/log-analytics-azure-key-vault) журналов управления операциями является одним из примеров уже интегрированной службы.

- Свяжите каждый сервер с двумя хранилищами ключей, которые находятся в разных регионах и содержат один и тот же ключевой материал, чтобы обеспечить высокую доступность зашифрованных баз данных. Отметьте только ключ от хранилища ключей в том же регионе, что и протектор TDE. Система автоматически переключится на хранилище ключей в удаленном регионе, если происходит сбой, влияющий на хранилище ключей в том же регионе.

### <a name="recommendations-when-configuring-tde-protector"></a>Рекомендации при настройке протектора TDE
- Храните копию протектора TDE в безопасном месте или депозитный счет службы эскроу.

- Если ключ генерируется в хранилище ключей, создайте резервную линию ключа перед первым использованием ключа в AKV. Резервное копирование может быть восстановлено только в Хранилище ключей Azure. Узнайте больше о команде [Backup-AzKeyVaultKey.](https://docs.microsoft.com/powershell/module/az.keyvault/backup-azkeyvaultkey)

- Создавайте новую резервную привязку при внесении каких-либо изменений в ключ (например, ключевые атрибуты, теги, ACL).

- **Сохраняйте предыдущие версии** ключа в хранилище ключей при смене ключа, чтобы сохранить возможность восстановления из старых резервных копий базы данных. При изменении протектора TDE для базы данных старые резервные копирования базы данных **не обновляются** для использования последнего протектора TDE. Во время восстановления каждому резервному копированию нужен протектор TDE, с помощью которых он был зашифрован во время создания. Чтобы правильно сменить ключ, используйте инструкции из [этой статьи](transparent-data-encryption-byok-azure-sql-key-rotation.md).

- Храните все ранее используемые ключи в AKV даже после перехода на управляемые сервисом ключи. Это гарантирует, что резервное копирование базы данных может быть восстановлено с помощью протекторов TDE, хранящихся в AKV.  Протекторы TDE, созданные с помощью Azure Key Vault, должны поддерживаться до тех пор, пока не будут созданы все оставшиеся резервные копирования с ключами, управляемыми службой. Сделайте восстанавливаемые копии этих ключей с помощью [Backup-AzKeyVaultKey.](https://docs.microsoft.com/powershell/module/az.keyvault/backup-azkeyvaultkey)

- Чтобы удалить потенциально скомпрометированный ключ во время инцидента безопасности без риска потери данных, выполните шаги из [потенциально скомпрометированного ключа.](transparent-data-encryption-byok-azure-sql-remove-tde-protector.md)

## <a name="inaccessible-tde-protector"></a>Недоступный протектор TDE

Когда прозрачное шифрование данных настроено на использование ключа, управляемого клиентом, для того, чтобы база данных оставалась в сети, необходим непрерывный доступ к протектору TDE. Если сервер теряет доступ к управляемому клиентом tDE-протектору в AKV, в течение 10 минут база данных начнет отказывать во всех соединениях с соответствующим сообщением об ошибке и изменит его состояние на *Недоступное.* Единственным действием, разрешенным в базе данных в недоступном состоянии, является ее исключение.

> [!NOTE]
> Если база данных недоступна из-за прерывистого сбоя в сети, никаких действий не требуется, и базы данных будут возвращаться в режим езду автоматически.

После восстановления доступа к ключу возвращение базы данных в онлайн требует дополнительного времени и шагов, которые могут варьироваться в зависимости от времени, прошедшего без доступа к ключу, и размера данных в базе данных:

- Если доступ к ключу будет восстановлен в течение 8 часов, база данных автоматически заживит в течение следующего часа.

- Если доступ к ключу восстанавливается более чем через 8 часов, автоматическое восстановление невозможно, а возвращение базы данных требует дополнительных шагов на портале и может занять значительное количество времени в зависимости от размера базы данных. После возвращения базы данных в онлайн будут **потеряны**ранее настроенные настройки уровня сервера, такие как конфигурация [группы сбоя,](https://docs.microsoft.com/azure/sql-database/sql-database-auto-failover-group) история восстановления моментов и теги. Поэтому рекомендуется внедрить систему уведомлений, которая позволяет выявлять и решать основные ключевые проблемы доступа в течение 8 часов.

### <a name="accidental-tde-protector-access-revocation"></a>Случайный отзыв доступа к доступу к протектору TDE

Может случиться так, что кто-то с достаточными правами доступа к хранилищу ключей случайно отключит доступ к серверу к ключу:

- отзыв ключа хранилище *получить,* *wrapKey*, *unwrapKey* разрешений с сервера

- удалять ключ

- удалять хранилище ключей

- изменение правил брандмауэра хранилища ключей

- удалять управляемый идентатор сервера в active-каталоге Azure

Узнайте больше об [общих причинах недоступности базы данных.](https://docs.microsoft.com/sql/relational-databases/security/encryption/troubleshoot-tde?view=azuresqldb-current#common-errors-causing-databases-to-become-inaccessible)

## <a name="monitoring-of-the-customer-managed-tde"></a>Мониторинг управляемого заказчиком ТДД

Чтобы отслеживать состояние базы данных и включить оповещение о потере доступа к протектору TDE, назначайте следующие функции Azure:
- [Здоровье ресурсов Azure](https://docs.microsoft.com/azure/service-health/resource-health-overview). Недоступная база данных, потерявдоступки к протектору TDE, будет отображаться как "недоступная" после отказа в первом подключении к базе данных.
- [Регистрация активности,](https://docs.microsoft.com/azure/service-health/alerts-activity-log-service-notifications) когда доступ к протектору TDE в хранилище ключей, управляемых клиентом, выходит из строя, записи добавляются в журнал активности.  Создание оповещений для этих событий позволит вам восстановить доступ как можно скорее.
- [Группы действий](https://docs.microsoft.com/azure/azure-monitor/platform/action-groups) могут быть определены для отправки вам уведомлений и оповещений на основе ваших предпочтений, например, Email/SMS/Push/Voice, Logic App, Webhook, ITSM или Automation Runbook.

## <a name="database-backup-and-restore-with-customer-managed-tde"></a>Резервное копирование и восстановление базы данных с помощью tDE, управляемого клиентами

После того, как база данных зашифрована с помощью TDE с помощью ключа от Key Vault, все вновь созданные резервные копирования также шифруются с тем же протектором TDE. При изменении протектора TDE старые резервные копирования базы данных **не обновляются** для использования последнего протектора TDE.

Чтобы восстановить резервную защиту, зашифрованную с помощью протектора TDE от Key Vault, убедитесь, что ключевой материал доступен для целевого сервера. Поэтому мы рекомендуем хранить все старые версии протектора TDE в хранилище ключей, чтобы резервные данные базы данных могли быть восстановлены.

> [!IMPORTANT]
> В любой момент может быть не более одного протектора TDE, установленного для сервера. Это ключ, отмеченный "Сделать ключ протектором TDE по умолчанию" в лезвии портала Azure. Однако несколько дополнительных ключей могут быть подключены к серверу без маркировки их в качестве протектора TDE. Эти ключи не используются для защиты DEK, но могут быть использованы во время восстановления из резервного копирования, если файл резервного копирования зашифрован ключом с соответствующим отпечатком пальца.

Если ключ, необходимый для восстановления резервного копирования, больше не доступен целевому серверу, `<Servername>` следующее сообщение об ошибке возвращается \<при попытке \<восстановления: "Целевой сервер не имеет доступа ко всем IIS AKV, созданным между Timestamp #1> и Timestamp #2>. Пожалуйста, повторите операцию после восстановления всех URIs AKV".

Чтобы смягчить его, запустите смдlet [Get-AzSqlServerKeyVaultKey](/powershell/module/az.sql/get-azsqlserverkeyvaultkey) для логического сервера целевой базы данных s'L или [Get-AzSqlInstanceKeyVaultKey](/powershell/module/az.sql/get-azsqlinstancekeyvaultkey) для целевого управляемого экземпляра, чтобы вернуть список доступных ключей и идентифицировать недостающие. Чтобы обеспечить восстановление всех резервных отсталок, убедитесь, что целевой сервер для восстановления имеет доступ ко всем необходимым ключам. Эти ключи не должны быть помечены как протектор TDE.

Дополнительные сведения о восстановлении резервной копии для Базы данных SQL см. в [этой статье](sql-database-recovery-using-backups.md). Подробнее о восстановлении резервного копирования для пула S'L читайте в [переделке пула S'L.](../synapse-analytics/sql-data-warehouse/backup-and-restore.md) Для создания резервного копирования/восстановления сервера с помощью управляемого экземпляра [см.](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-get-started-restore)

Дополнительное внимание к файлам журнала: Резервные файлы журнала остаются зашифрованными с исходным протектором TDE, даже если он был повернут и база данных теперь использует новый протектор TDE.  Для восстановления базы данных потребуется оба ключа.  Если файл журнала использует протектор TDE, хранящийся в Хранилище ключей Azure, этот ключ будет необходим во время восстановления, даже если база данных была изменена для использования TDE, управляемой службой, тем временем.

## <a name="high-availability-with-customer-managed-tde"></a>Высокая доступность с управляемым клиентом TDE

Даже в тех случаях, когда для сервера отсутствует настроенная георезервизм, настоятельно рекомендуется настроить сервер для использования двух разных сводов ключей в двух разных регионах с одинаковым ключевым материалом. Это может быть достигнуто путем создания протектора TDE с помощью основного хранилища ключей, расположенного в том же регионе, что и сервер, и клонирование ключа в хранилище ключей в другой области Azure, так что сервер имеет доступ ко второму хранилищу ключа, если основной хранилище ключей должен быть основным хранилищем ключей возникла сбой во время работы базы данных.

Используйте смдlet Backup-AzKeyVaultKey для извлечения ключа в зашифрованном формате из основного хранилища ключей, а затем используйте cmdlet Restore-AzKeyVaultKey и укажите хранилище ключей во втором регионе, чтобы клонировать ключ. Кроме того, используйте портал Azure для резервного копирования и восстановления ключа. Ключ во вторичном хранилище ключей в другом регионе не должен быть помечен как протектор TDE, и это даже не разрешено.

 Если происходит сбой, влияющий на хранилище первичного ключа, и только после этого система автоматически переключается на другой связанный ключ с тем же отпечатком пальца во вторичном хранилище ключей, если он существует. Обратите внимание, что этот переключатель не произойдет, если протектор TDE недоступен из-за аннулированных прав доступа, или потому, что ключ или хранилище ключа удалены, так как это может означать, что клиент намеренно хотел ограничить доступ к ключу серверу.

![Односерверная HA](./media/transparent-data-encryption-byok-azure-sql/customer-managed-tde-with-ha.png)

## <a name="geo-dr-and-customer-managed-tde"></a>Geo-DR и управляемый клиентами TDE

В сценариях [активных групп георепликации](https://docs.microsoft.com/azure/sql-database/sql-database-active-geo-replication) и [групп сбоев](https://docs.microsoft.com/azure/sql-database/sql-database-auto-failover-group) для выполнения каждого сервера требуется отдельное хранилище ключей, которое должно быть расположено совместно с сервером в одном регионе Azure. Клиент несет ответственность за поддержание ключевого материала в хранилищах ключей в соответствии, так что гео-вторичный находится в синхронизации и может взять на себя использование того же ключа из своего локального хранилища ключей, если первичный становится недоступным из-за простоя в регионе и срабатывания . Можно настроить до четырех второстепенных, а цепочка (вторые второстепенные) не поддерживается.

Чтобы избежать проблем при создании или во время георепликации из-за неполного ключевого материала, важно следовать этим правилам при настройке управляемого клиентом TDE:

- Все ключевые хранилища должны иметь одинаковые свойства и одинаковые права доступа для соответствующих серверов.

- Все ключевые хранилища должны содержать идентичный ключевой материал. Это относится не только к текущему протектору TDE, но и ко всем предыдущим протекторам TDE, которые могут быть использованы в файлах резервного копирования.

- И начальная установка, и вращение протектора TDE должны быть сделаны сначала на вторичном, а затем на первичном.

![Группы отработки отказа и географическое аварийное восстановление](./media/transparent-data-encryption-byok-azure-sql/customer-managed-tde-with-bcdr.png)

Чтобы протестировать неудачу, выполните последующие действия в [обзоре Active geo-replication.](sql-database-geo-replication-overview.md) Это должно быть сделано на регулярной основе, чтобы подтвердить наличие разрешений на доступ к обоим ключевым хранилищам.

## <a name="next-steps"></a>Дальнейшие действия

Вы также можете проверить следующие скрипты образца PowerShell для общих операций с управляемым клиентом TDE:

- [Поверните прозрачный протектор шифрования данных для базы данных СЗЛ с помощью PowerShell](transparent-data-encryption-byok-azure-sql-key-rotation.md)

- [Удалить протектор прозрачного шифрования данных (TDE) для базы данных S'L с помощью PowerShell](https://docs.microsoft.com/azure/sql-database/transparent-data-encryption-byok-azure-sql-remove-tde-protector)

- [Управление прозрачным шифрованием данных в управляемой инстанции с помощью собственного ключа с помощью PowerShell](https://docs.microsoft.com/azure/sql-database/scripts/transparent-data-encryption-byok-sql-managed-instance-powershell?toc=%2fpowershell%2fmodule%2ftoc.json)
