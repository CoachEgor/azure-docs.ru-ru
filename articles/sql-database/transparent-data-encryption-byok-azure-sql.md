---
title: TDE — интеграция Azure Key Vault или создание собственных ключей (BYOK) — База данных Azure SQL | Документация Майкрософт
description: Поддержка создания собственных ключей для прозрачного шифрования данных в Azure Key Vault для Базы данных SQL и хранилища данных SQL. Обзор TDE с поддержкой BYOK, преимущества, принцип работы, замечания и рекомендации.
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: aliceku
ms.author: aliceku
ms.reviewer: vanto
manager: craigg
ms.date: 04/19/2019
ms.openlocfilehash: 645c140819042153b23d8e06417d4c5f441a14a9
ms.sourcegitcommit: a6873b710ca07eb956d45596d4ec2c1d5dc57353
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/16/2019
ms.locfileid: "68249236"
---
# <a name="azure-sql-transparent-data-encryption-with-customer-managed-keys-in-azure-key-vault-bring-your-own-key-support"></a>Прозрачное шифрование данных Azure SQL с собственным ключом в Azure Key Vault: Поддержка создания собственных ключей

[Прозрачное шифрование данных (TDE)](https://docs.microsoft.com/sql/relational-databases/security/encryption/transparent-data-encryption) с помощью Azure Key Vault позволяет зашифровать ключ шифрования базы данных (DEK), используя управляемый пользователем асимметричный ключ, который называется предохранителем TDE. Обычно это также называется поддержкой создания собственных ключей (BYOK) для прозрачного шифрования данных.  В сценарии создания собственных ключей предохранитель TDE хранится в управляемом клиентом экземпляре [Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-secure-your-key-vault) — облачной системы Azure для управления внешними ключами. Средство защиты TDE может быть [создано](https://docs.microsoft.com/azure/key-vault/about-keys-secrets-and-certificates) хранилищем ключей или [передано](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys) в хранилище ключей с локального устройства HSM. Ключ шифрования TDE, который хранится на загрузочной странице базы данных, шифруется и расшифровывается с помощью предохранителя TDE. Он хранится в Azure Key Vault и никогда не покидает это хранилище ключей.  База данных SQL должна иметь разрешения для хранилища ключей, принадлежащего клиенту, для шифрования и расшифрования DEK. Если права доступа логического сервера SQL к хранилищу ключей отменены, база данных будет недоступна и все данные будут зашифрованы. Для Базы данных SQL Azure предохранитель TDE настраивается на уровне логического сервера SQL и наследуется всеми базами данных, связанными с этим сервером. Для [Управляемого экземпляра SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-howto-managed-instance) предохранитель TDE настраивается на уровне экземпляра и наследуется всеми *зашифрованными* базами данных этого экземпляра. В этом документе термин *сервер* обозначает как сервер, так и экземпляр, если не указано иное.

> [!NOTE]
> Прозрачное шифрование данных с Azure Key Vaultной интеграцией (создание собственных ключей) для Управляемый экземпляр Базы данных SQL Azure доступна в предварительной версии.

Благодаря интеграции TDE с Azure Key Vault пользователи могут самостоятельно контролировать задачи управления ключами. В Azure Key Vault можно выполнять такие операции, как смена ключей, настройка разрешений для хранилища ключей, резервное копирование ключей, а также включать аудит и отчетность по всем предохранителям TDE. Key Vault поддерживает централизованное управление ключами, использует тщательно отслеживаемые аппаратные модули безопасности (HSM), а также позволяет разделять обязанности по управлению ключами и данными для обеспечения соответствия политикам безопасности.  

Интеграция прозрачного шифрования данных с Azure Key Vault обеспечивает следующие преимущества:

- более высокая прозрачность и точность контроля с возможностью самостоятельно управлять предохранителем TDE;
- возможность отменить разрешения в любое время, чтобы запретить просмотр базы данных;
- централизованное управление предохранителями TDE (а равно и другими ключами и секретами для всех остальных служб Azure) благодаря их размещению в Key Vault;
- разделение обязанностей по управлению ключами и данными в организации;
- повышение доверия со стороны клиентов, так как принцип работы Key Vault не позволяет сотрудникам Майкрософт видеть или извлекать ключи шифрования;
- поддержка смены ключей.

> [!IMPORTANT]
> Для тех, кто использует TDE под управлением службы и намерен перейти на работу с Key Vault, все функции TDE сохраняются в процессе перехода на предохранитель TDE в Key Vault. Не потребуется никаких остановок в работе или повторного шифрования файлов базы данных. Для перехода с управляемого службой ключа на ключ Key Vault достаточно лишь заново зашифровать ключ шифрования базы данных (DEK). Эта операция выполняется в через Интернет и не занимает много времени.

## <a name="how-does-tde-with-azure-key-vault-integration-support-work"></a>Принцип работы TDE с поддержкой интеграции Azure Key Vault

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL Azure, но вся будущая разработка предназначена для модуля AZ. SQL. Эти командлеты см. в разделе [AzureRM. SQL](https://docs.microsoft.com/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле AZ и в модулях AzureRm существенно идентичны.

![Аутентификация сервера в Key Vault](./media/transparent-data-encryption-byok-azure-sql/tde-byok-server-authentication-flow.PNG)

Когда вы впервые настраиваете для TDE использование предохранителя из Key Vault, сервер отправляет в Key Vault ключи шифрования от всех баз данных, поддерживающих TDE, чтобы создать запрос на упаковку ключа. Key Vault возвращает ключ шифрования для зашифрованной базы данных, и этот ключ сохраняется в базе данных пользователя.  

> [!IMPORTANT]
> Здесь важно отметить, что **сохраненный в Azure Key Vault предохранитель TDE никогда не покидает пределы Azure Key Vault**. Сервер может только отправлять запросы на операции с ключом в материал ключа предохранителя TDE в пределах Key Vault, но **никогда не получает доступ к самому предохранителю TDE и не кэширует его**. Администратор Key Vault имеет право в любой момент отменить разрешения Key Vault для сервера, и в этом случае все подключения к этому серверу разрываются.

## <a name="guidelines-for-configuring-tde-with-azure-key-vault"></a>Рекомендации по настройке прозрачного шифрования данных с помощью Azure Key Vault

### <a name="general-guidelines"></a>Общие рекомендации

- Убедитесь, что Azure Key Vault и База данных / Управляемый экземпляр SQL Azure размещаются в одном клиенте.  Взаимодействие между хранилищем ключей и сервером, размещенными в разных клиентах, **не поддерживается**.
- Заранее определите, какие подписки вы будете использовать для необходимых ресурсов. Для перемещения сервера в другую подписку потребуется заново настроить TDE с поддержкой BYOK. Дополнительные сведения [о перемещении ресурсов](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-move-resources).
- При настройке TDE с поддержкой Azure Key Vault важно учитывать нагрузку на хранилище ключей, которая будет создаваться в результате повторяющихся операций упаковки и распаковки. Например, все базы данных, связанные с одним сервером Базы данных SQL, используют один предохранитель TDE, а значит при отработке отказа для этого сервера будет активировано столько операций с ключами в хранилище, сколько баз данных хранится на этом сервере. Исходя из нашего опыта и задокументированных [ограничений для службы хранилища ключей](https://docs.microsoft.com/azure/key-vault/key-vault-service-limits) рекомендуем связывать с Azure Key Vault в одной подписке не более 500 баз данных категории "Стандартный" или "Общего назначения" или не более 200 баз данных категории "Премиум" или "Критически важный для бизнеса". Это позволит поддерживать стабильно высокий уровень доступности при обращении к предохранителю TDE в хранилище ключей.
- Рекомендация: Сохраняйте локальную копию предохранителя TDE.  Для этого потребуется устройство HSM, на котором вы создадите локальную версию предохранителя TDE, и система депонирования ключей для хранения этой локальной копии предохранителя TDE.  Узнайте, [как передать ключ из локального модуля HSM в Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys).
- Проблемы с существующими конфигурациями см. в разделе [Устранение неполадок TDE](https://docs.microsoft.com/sql/relational-databases/security/encryption/troubleshoot-tde)

### <a name="guidelines-for-configuring-azure-key-vault"></a>Рекомендации по настройке Azure Key Vault

- Создайте хранилище ключей с поддержкой [обратимого удаления](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete), чтобы избежать полной потери данных при случайном удалении ключа или хранилища ключей.  Для [включения свойства обратимого удаления в хранилище ключей необходимо использовать PowerShell](https://docs.microsoft.com/azure/key-vault/key-vault-soft-delete-powershell), так как это свойство пока не поддерживается на портале AKV, но является обязательным для SQL Azure.  
  - При обратимом удалении ресурсы сохраняются в течение определенного периода времени (90 дней), если не будут восстановлены или очищены раньше.
  - Для действий **восстановления** и **очистки** в политике доступа хранилища ключей заданы собственные разрешения.
- Установите блокировку ресурсов для хранилища ключей, чтобы управлять правами на удаление этого критически важного ресурса и предотвратить случайное или несанкционированное удаление.  [Дополнительная информация о блокировке ресурсов](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-lock-resources)

- Предоставьте серверу Базы данных SQL доступ к хранилищу ключей с помощью удостоверения Azure Active Directory (Azure AD).  При использовании пользовательского интерфейса портала удостоверение Azure AD, которое предоставляет серверу права доступа к хранилищу ключей, создается автоматически.  Если вы настраиваете TDE с поддержкой BYOK через PowerShell, удостоверение Azure AD нужно создать отдельно и проверить успешность его создания. Подробные пошаговые инструкции по настройке TDE с поддержкой BYOK с помощью PowerShell см. в [этой статье](transparent-data-encryption-byok-azure-sql-configure.md), а по настройке TDE с поддержкой BYOK для управляемого экземпляра – [в этой](https://aka.ms/sqlmibyoktdepowershell).

  > [!NOTE]
  > Если удостоверение Azure AD **случайно удалено или разрешения сервера отзываются** с помощью политики доступа хранилища ключей или случайно перемещаются в другую подписку, сервер теряет доступ к хранилищу ключей и TDE шифруется. базы данных недоступны в течение 24 часов.  

- При использовании брандмауэров и виртуальных сетей с помощью Azure Key Vault необходимо настроить следующее: 
  - Разрешите доверенным службам Майкрософт обходить этот брандмауэр, выбрав "Да".

  > [!NOTE]
  > Если TDE зашифрованные базы данных SQL потеряют доступ к хранилищу ключей, так как они не могут обходить брандмауэр, базы данных недоступны в течение 24 часов.

- Включение аудита и отчетов для всех ключей шифрования. Хранилище ключей предоставляет журналы, которые можно легко передать в любые средства управления информационной безопасностью и событиями безопасности (SIEM). В состав служб Operations Management Suite (OMS) [Azure Monitor журналы](https://docs.microsoft.com/azure/log-analytics/log-analytics-azure-key-vault) — это один из примеров службы, которая уже интегрирована.
- Чтобы обеспечить высокий уровень доступности для зашифрованных баз данных, настройте для каждого сервера Базы данных SQL два экземпляра Azure Key Vault в разных регионах.

### <a name="guidelines-for-configuring-the-tde-protector-asymmetric-key"></a>Рекомендации по настройке предохранителя TDE (асимметричного ключа)

- Создайте ключ шифрования на локальном устройстве HSM. Это должен быть асимметричный ключ RSA 2048, который можно хранить в Azure Key Vault.
- Передайте ключ в систему депонирования ключей.  
- Импортируйте файл ключа шифрования (в формате PFX, BYOK или BACKUP) в Azure Key Vault.

   > [!NOTE]
   > Для целей тестирования можно создать ключ прямо в Azure Key Vault, но такой ключ нельзя сохранить в локальной системе депонирования, так как закрытый ключ никогда не покидает хранилище ключей.  Всегда создавайте резервные копии ключей, используемых для шифрования рабочих данных, и помещайте их в систему депонирования, так как потеря такого ключа (при случайном удалении из хранилища ключей, истечении срока действия и т. п.) приведет к безвозвратной потере данных.

- Используйте ключ без определенного срока действия и не изменяйте срок действия для уже используемого ключа. **При истечении срока действия ключа все зашифрованные базы данных теряют доступ к предохранителю TDE и будут недоступны в течение 24 часов**.
- Убедитесь, что ключ включен и имеет разрешения на операции *получения*, *упаковки* и *распаковки ключа*.
- Создайте резервную копию ключа, сохраненного в Azure Key Vault, перед первым его использованием. Дополнительные сведения о команде [BACKUP-азкэйваулткэй](https://docs.microsoft.com/powershell/module/az.keyvault/backup-azkeyvaultkey) .
- Создавайте резервную копию ключа при каждом изменении в его параметрах (при добавлении списков управления доступом, тегов, атрибутов и т. п.).
- **Сохраняйте предыдущие версии** ключа в хранилище ключей при смене ключа, чтобы сохранить возможность восстановления из старых резервных копий базы данных. Когда для базы данных изменяется предохранитель TDE, старые резервные копии базы данных **не обновляются** до последней версии предохранителя TDE.  Для восстановления любой резервной копии нужно использовать тот предохранитель TDE, с которым она создавалась. Чтобы правильно сменить ключ, используйте инструкции из [этой статьи](transparent-data-encryption-byok-azure-sql-key-rotation.md).
- Сохраните все использовавшиеся ранее ключи в Azure Key Vault, если снова перейдете к управляемым службой ключами.  Это обеспечит возможность восстановить резервные копии баз данных, созданных с предохранителями TDE из Azure Key Vault.  Предохранители TDE, созданные в Azure Key Vault, следует сохранять до тех пор, пока сохраняются созданные с ними резервные копии.  
- Сделайте восстанавливаемые резервные копии этих ключей с помощью [BACKUP-азкэйваулткэй](https://docs.microsoft.com/powershell/module/az.keyvault/backup-azkeyvaultkey).
- Чтобы без риска потери данных удалить ключ, который мог быть скомпрометирован в результате инцидента безопасности, следуйте инструкциям из [этой статьи](transparent-data-encryption-byok-azure-sql-remove-tde-protector.md).

## <a name="high-availability-geo-replication-and-backup--restore"></a>Высокая доступность, георепликация, резервное копирование и восстановление

### <a name="high-availability-and-disaster-recovery"></a>Высокая доступность и аварийное восстановление

Настройка высокого уровня доступности с помощью Azure Key Vault зависит от конфигурации базы данных и сервера Базы данных SQL. Ниже указаны рекомендуемые конфигурации для двух разных случаев.  Первый вариант — для автономной базы данных или сервера Базы данных SQL без геоизбыточности.  Второй вариант подразумевает, что для базы данных или сервера Базы данных SQL настроены группы отработки отказа или геоизбыточность, при этом для каждой геоизбыточной копии требуется локальное хранилище Azure Key Vault в пределах группы отработки отказа для правильной отработки географически распределенных отказов.

В первом случае, если требуется высокий уровень доступности для базы данных и сервера Базы данных SQL без настроенной геоизбыточности, рекомендуется настроить сервер на использование в двух разных регионах двух разных хранилищ ключей с одинаковым материалом ключей. Для этого создайте предохранитель TDE с помощью первичного Key Vault, которое находится в одном регионе с сервером Базы данных SQL, и клонируйте этот ключ в хранилище ключей в другом регионе Azure. Теперь сервер сможет использовать вторичное хранилище ключей, если с первичным возникнут сбои в процессе работы базы данных. Используйте командлет Backup-Азкэйваулткэй, чтобы получить ключ в зашифрованном формате из хранилища первичного ключа, а затем используйте командлет Restore-Азкэйваулткэй и укажите хранилище ключей во втором регионе.

![Высокий уровень доступности с одним сервером и без географического аварийного восстановления](./media/transparent-data-encryption-byok-azure-sql/SingleServer_HA_Config.PNG)

## <a name="how-to-configure-geo-dr-with-azure-key-vault"></a>Настройка географического аварийного восстановления для Azure Key Vault

Чтобы сохранить высокий уровень доступности для предохранителей TDE, используемых для зашифрованных баз данных, следует настроить избыточные хранилища Azure Key Vault в существующих или создаваемых группах отработки отказа Базы данных SQL или экземпляры активной георепликации.  Каждый геореплицированный сервер должен иметь отдельное хранилище ключей, размещенное в том же регионе Azure, что и сервер. Если база данных-источник станет недоступной из-за сбоя в одном регионе, то после отработки отказа база данных-получатель сможет взять работу на себя, используя вторичное хранилище ключей.

Для геореплицированных баз данных SQL Azure необходима следующая конфигурация Azure Key Vault:

- Одна база данных-источник с хранилищем ключей в том же регионе и одна база данных-получатель хранилищем ключей в том же регионе.
- Должно существовать не менее одной и не более четырех баз данных-получателей.
- Вторичные реплики баз данных-получателей (создание цепочек) не поддерживаются.

В следующем разделе будут более подробно рассмотрены процессы установки и настройки.

### <a name="azure-key-vault-configuration-steps"></a>Действия по настройке Azure Key Vault

- Установка [Azure PowerShell](https://docs.microsoft.com/powershell/azure/install-az-ps)
- Создайте два хранилища Azure Key Vault в двух разных регионах, [включив для них функцию обратимого удаления с помощью PowerShell](https://docs.microsoft.com/azure/key-vault/key-vault-soft-delete-powershell) (эта возможность пока не поддерживается на портале AKV, но является обязательной для SQL).
- Регионы, в которых создаются два хранилища Azure Key Vault, должны быть расположены в одном географическом регионе Azure, чтобы выполнялись процессы резервного копирования и восстановления ключей.  Если вы хотите, чтобы эти хранилища ключей размещались в разных географических регионах, например для соответствия требованиям к географическому аварийному восстановлению, выполните [процедуру BYOK](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys), которая позволяет импортировать ключи из локального аппаратного модуля безопасности.
- Создайте в первом хранилище ключей новый ключ:  
  - ключ RSA/RSA-HSA 2048;
  - без даты окончания срока действия;
  - ключ включен и имеет разрешения на операции получения, упаковки и распаковки ключа.
- Создайте резервную копию первичного ключа и восстановите его во вторичном хранилище ключей.  См. раздел [баккупазурекэйваулткэй](https://docs.microsoft.com/powershell/module/az.keyvault/backup-azkeyvaultkey) and [RESTORE-азкэйваулткэй](https://docs.microsoft.com/powershell/module/az.keyvault/restore-azkeyvaultkey).

### <a name="azure-sql-database-configuration-steps"></a>Действия по настройке Базы данных SQL Azure

Описанные ниже этапы настройки будут различаться в зависимости от того, создаете вы новое развертывание SQL или используете уже существующее развертывание SQL с географическим аварийным восстановлением.  Здесь мы сначала опишем действия для нового развертывания, а затем покажем, как назначить хранящийся в Azure Key Vault предохранитель TDE существующему развертыванию, для которого уже создана связь географического аварийного восстановления.

**Ниже описан процесс для нового развертывания**.

- Создайте два сервера Базы данных SQL в тех же двух регионах, где вы ранее создали хранилища ключей.
- Выберите область TDE сервера Базы данных SQL, а затем для каждого сервера Базы данных SQL выполните следующие действия:  
  - Выберите AKV в том же регионе.
  - Выберите ключ, который вы намерены использовать в качестве предохранителя TDE. Каждый сервер будет использовать локальную копию предохранителя TDE.
  - Выполняя эту операцию на портале, вы получите удостоверение [AppID](https://docs.microsoft.com/azure/active-directory/managed-service-identity/overview) для сервера Базы данных SQL, которое позволяет назначать серверу Базы данных SQL разрешения на доступ к хранилищу ключей. Не удаляйте это удостоверение. Чтобы отменить доступ, удалите в Azure Key Vault разрешения для сервера Базы данных SQL, которые предоставляют этому серверу доступ к хранилищу ключей.
- Создайте базу данных-источник.
- И наконец, выполните [рекомендации по активной георепликации](sql-database-geo-replication-overview.md). В результате будет создана база данных-получатель.

![Группы отработки отказа и географическое аварийное восстановление](./media/transparent-data-encryption-byok-azure-sql/Geo_DR_Config.PNG)

> [!NOTE]
> Важно убедиться, что в обоих хранилищах ключей хранится один и тот же предохранитель TDE. Если все выполнено правильно, можно переходить к созданию географической связи между базами данных.

**Ниже описан процесс для имеющейся базы данных SQL, развернутой с поддержкой географического аварийного восстановления**.

Так как серверы Базы данных SQL уже существуют, а первичная и вторичная базы данных уже присвоены, остается лишь настроить Azure Key Vault в следующем порядке.

- Прежде всего на сервере Базы данных SQL, где размещена база данных-получатель, сделайте следующее:
  - назначьте хранилище ключей, расположенное в том же регионе;
  - назначьте предохранитель TDE.
- Теперь перейдите на сервер Базы данных SQL, где размещена база данных-источник:
  - выберите тот же предохранитель TDE, который используется для базы данных-получателя.

![Группы отработки отказа и географическое аварийное восстановление](./media/transparent-data-encryption-byok-azure-sql/geo_DR_ex_config.PNG)

>[!NOTE]
>При назначении серверу хранилища ключей важно начинать процесс с сервера-получателя.  На втором шаге назначьте хранилище ключей серверу-источнику и обновите предохранитель TDE. При этом связь географического аварийного восстановления продолжит работать, так как предохранитель TDE для реплицированной базы данных уже доступен на обоих серверах.

В сценарии для Базы данных SQL с географическим аварийным восстановлением, прежде чем включить TDE с ключами, сохраненными в Azure Key Vault и управляемыми клиентом, необходимо создать и поддерживать два хранилища Azure Key Vault с идентичным содержимым в тех же регионах, которые будут использоваться для георепликации базы данных SQL.  "Идентичное содержимое" здесь означает, что оба хранилища ключей должны содержать копии одного предохранителя TDE, чтобы оба сервера имели доступ к предохранителям TDE, используемым для всех баз данных.  В дальнейшем нужно соблюдать следующие требования: поддерживать синхронизацию обоих хранилищ ключей, то есть размещать в них одинаковые копии предохранителя TDE после смены ключей; сохранять старые версии ключей, которые использовались для файлов журналов или резервных копий; сохранять одинаковые свойства ключей для всех последующих предохранителей TDE; сохранять одинаковые разрешения на доступ серверов SQL в хранилищах ключей.  

Выполните действия, описанные в [обзоре активной георепликации](sql-database-geo-replication-overview.md), чтобы запустить тестовую отработку отказа. Этот процесс нужно выполнять регулярно для проверки разрешений сервера SQL на доступ к обоим хранилищам ключей.

### <a name="backup-and-restore"></a>Резервное копирование и восстановление

После того, как вы зашифруете базу данных с помощью TDE с ключом, сохраненным в Key Vault, все создаваемые резервные копии также будут шифроваться с помощью того же предохранителя TDE.

Чтобы восстановить резервную копию, зашифрованную с помощью предохранителя TDE из Key Vault, необходимо убедиться, что материал ключа по-прежнему находится в исходном хранилище с тем же именем. Когда для базы данных изменяется предохранитель TDE, старые резервные копии базы данных **не обновляются** до последней версии предохранителя TDE. Поэтому мы рекомендуем сохранять все старые версии предохранителя TDE в Key Vault, чтобы иметь возможность восстановить резервные копии базы данных.

Если ключ, который может потребоваться для восстановления резервной копии, отсутствует в исходном хранилище ключей, возвращается следующее сообщение об ошибке: "Целевой сервер `<Servername>` не имеет доступа ко всем URI AKV, созданным \<между отметкой \<времени #1 > и #2 > меток времени. Please retry operation after restoring all AKV Uris." (Целевой сервер не имеет доступа ко всем URI AKV, созданным с <метка времени №1> по <метка времени №2>. Повторите операцию после восстановления всех URI AKV).

Чтобы устранить эту проблемы, выполните командлет [Get-азсклсерверкэйваулткэй](/powershell/module/az.sql/get-azsqlserverkeyvaultkey) , чтобы получить список ключей из Key Vault, которые были добавлены на сервер (если они не были удалены пользователем). Чтобы убедиться, что все резервные копии можно восстановить, сохраняйте доступ целевого сервера резервного копирования ко всем используемым ключам.

```powershell
Get-AzSqlServerKeyVaultKey `
  -ServerName <LogicalServerName> `
  -ResourceGroup <SQLDatabaseResourceGroupName>
```

Дополнительные сведения о восстановлении резервной копии для Базы данных SQL см. в [этой статье](sql-database-recovery-using-backups.md). Дополнительные сведения о восстановлении резервной копии для хранилища данных SQL см. в [этой статье](../sql-data-warehouse/backup-and-restore.md).

Дополнительное замечание относительно резервных копий файлов журнала: сохраненные резервные копии журналов остаются зашифрованными с помощью исходного шифратора TDE, даже если произошла смена предохранителя TDE и база данных уже использует новый предохранитель TDE.  Для восстановления базы данных потребуется оба ключа.  Если файл журнала использует предохранитель TDE, хранящийся в Azure Key Vault, этот ключ потребуется во время восстановления, даже если база данных переведена на работу с управляемым службой предохранителем TDE.
