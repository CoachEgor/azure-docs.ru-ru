---
title: Учебник. Добавление управляемого экземпляра базы данных SQL в группу отработки отказа
description: Узнайте, как настроить группу отработки отказа для управляемого экземпляра базы данных SQL Azure.
services: sql-database
ms.service: sql-database
ms.subservice: high-availability
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: MashaMSFT
ms.author: mathoma
ms.reviewer: sashan, carlrab
manager: jroth
ms.date: 06/27/2019
ms.openlocfilehash: 5169fe5eef416812c399b421f59305f6cb1e7b62
ms.sourcegitcommit: 94ee81a728f1d55d71827ea356ed9847943f7397
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2019
ms.locfileid: "70035785"
---
# <a name="tutorial-add-a-sql-database-managed-instance-to-a-failover-group"></a>Учебник. Добавление управляемого экземпляра базы данных SQL в группу отработки отказа

Добавьте управляемый экземпляр базы данных SQL в группу отработки отказа. В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> - Создание основного управляемого экземпляра
> - Создайте вторичный управляемый экземпляр в составе [группы](sql-database-auto-failover-group.md)отработки отказа. 
> - Тестовая отработка отказа

  > [!NOTE]
  > - При работе с этим руководством убедитесь, что вы настраиваете ресурсы с [предварительными требованиями для настройки групп отработки отказа для управляемого экземпляра](sql-database-auto-failover-group.md#enabling-geo-replication-between-managed-instances-and-their-vnets). 
  > - Создание управляемого экземпляра может занять значительное время. В результате для выполнения этого руководства может потребоваться несколько часов. Дополнительные сведения о времени подготовки см. в разделе [операции управления управляемыми экземплярами](sql-database-managed-instance.md#managed-instance-management-operations). 
  > - Использование групп отработки отказа с управляемыми экземплярами сейчас находится на этапе предварительной версии. 

## <a name="prerequisites"></a>Предварительные требования

В рамках этого руководства вам потребуются: 

- Подписка Azure [Создайте бесплатную учетную запись](https://azure.microsoft.com/free/) , если у вас ее еще нет. 


## <a name="1----create-resource-group-and-primary-managed-instance"></a>1\. Создание группы ресурсов и основного управляемого экземпляра
На этом шаге вы создадите группу ресурсов и основной управляемый экземпляр для группы отработки отказа с помощью портал Azure. 

1. Войдите на [портал Azure](https://portal.azure.com). 
1. Выберите **Создание ресурса** в левом верхнем углу портал Azure. 
1. Введите `managed instance` в поле поиска и выберите параметр для управляемый экземпляр Azure SQL. 
1. Выберите **создать** , чтобы открыть страницу создания **управляемого экземпляра SQL** . 
1. На странице " **создание управляемый экземпляр базы данных SQL Azure** " на вкладке " **основы** "
    1. В разделе **сведения о проекте**выберите **подписку** из раскрывающегося списка, а затем выберите **создать новую** группу ресурсов. Введите имя группы ресурсов, например `myResourceGroup`. 
    1. В разделе **управляемый экземпляр сведения**укажите имя управляемого экземпляра и регион, в котором вы хотите развернуть управляемый экземпляр. Оставьте значения по умолчанию для **вычислений + Storage** . 
    1. В разделе **учетная запись администратора**укажите имя входа администратора, `azureuser`например, и сложный пароль администратора. 

    ![Создать основной MI](media/sql-database-managed-instance-failover-group-tutorial/primary-sql-mi-values.png)

1. Оставьте остальные параметры со значениями по умолчанию и выберите проверить и **создать** , чтобы проверить параметры управляемого экземпляра. 
1. Выберите **создать** , чтобы создать основной управляемый экземпляр. 


## <a name="2---create-a-virtual-network"></a>2\. Создание виртуальной сети
На этом шаге вы создадите виртуальную сеть для вторичного управляемого экземпляра. Этот шаг необходим, так как в подсети первичного и вторичного управляемых экземпляров находятся неперекрывающиеся диапазоны адресов. 

Чтобы проверить диапазон подсети основной виртуальной сети, выполните следующие действия.
1. В [портал Azure](https://portal.azure.com)перейдите к группе ресурсов и выберите виртуальную сеть для основного экземпляра. 
1. Выберите **подсети** в разделе **Параметры** и запишите **диапазон адресов**. Диапазон адресов подсети виртуальной сети для вторичного управляемого экземпляра не может перекрывать эту область. 


   ![Первичная подсеть](media/sql-database-managed-instance-failover-group-tutorial/verify-primary-subnet-range.png)

Чтобы создать виртуальную сеть, выполните следующие действия.

1. В [портал Azure](https://portal.azure.com)выберите **создать ресурс** и выполните поиск по запросу *Виртуальная сеть*. 
1. Выберите параметр **виртуальной сети** , опубликованный корпорацией Майкрософт, а затем нажмите кнопку **создать** на следующей странице. 
1. Заполните обязательные поля, чтобы настроить виртуальную сеть для вторичного управляемого экземпляра, а затем нажмите кнопку **создать**. 

   В следующей таблице приведены значения, необходимые для вторичной виртуальной сети.

    | **Поле** | Значение |
    | --- | --- |
    | **Name** |  Имя виртуальной сети, используемой дополнительным управляемым экземпляром, например `vnet-sql-mi-secondary`. |
    | **Пространство адресов** | Адресное пространство виртуальной сети, например `10.128.0.0/16`. | 
    | **Подписка** | Подписка, в которой находятся основные управляемые экземпляры и группы ресурсов. |
    | **Регион** | Расположение, в которое будет развертываться вторичный управляемый экземпляр. |
    | **Подсеть** | Имя вашей подсети. `default`по умолчанию предоставляется для вас. |
    | **Диапазон адресов**| Диапазон адресов для вашей подсети. Это значение должно отличаться от диапазона адресов подсети, используемого виртуальной сетью основного управляемого экземпляра, например `10.128.0.0/24`.  |
    | &nbsp; | &nbsp; |

    ![Значения вторичной виртуальной сети](media/sql-database-managed-instance-failover-group-tutorial/secondary-virtual-network.png)


## <a name="3---create-a-secondary-managed-instance"></a>3\. Создание вторичного управляемого экземпляра
На этом шаге вы создадите вторичный управляемый экземпляр на портал Azure, который также будет настраивать сетевые подключения между двумя управляемыми экземплярами. 

Второй управляемый экземпляр должен:
- Быть пустым. 
- Имеют разные подсети и диапазоны IP-адресов, чем у основного управляемого экземпляра. 

Чтобы создать вторичный управляемый экземпляр, выполните следующие действия. 

1. В [портал Azure](https://portal.azure.com)выберите **создать ресурс** и выполните поиск *управляемый экземпляр SQL Azure*. 
1. Выберите параметр **управляемый экземпляр Azure SQL** , опубликованный корпорацией Майкрософт, а затем нажмите кнопку **создать** на следующей странице.
1. На вкладке **Основные сведения** на странице **Создание управляемый экземпляр базы данных SQL Azure** введите необходимые поля для настройки вторичного управляемого экземпляра. 

   В следующей таблице приведены значения, необходимые для вторичного управляемого экземпляра.
 
    | **Поле** | Значение |
    | --- | --- |
    | **Подписка** |  Подписка, в которой находится основной управляемый экземпляр. |
    | **Группа ресурсов**| Группа ресурсов, в которой находится основной управляемый экземпляр. |
    | **Имя управляемого экземпляра** | Имя нового вторичного управляемого экземпляра, например`sql-mi-secondary`  | 
    | **Регион**| Расположение для вторичного управляемого экземпляра.  |
    | **Имя для входа администратора управляемого экземпляра** | Имя входа, которое будет использоваться для нового вторичного управляемого экземпляра, например `azureuser`. |
    | **Пароль** | Сложный пароль, который будет использоваться именем входа администратора для нового вторичного управляемого экземпляра.  |
    | &nbsp; | &nbsp; |

1. На вкладке **Сетевые подключения** для **виртуальной сети**выберите виртуальную сеть, созданную для дополнительного управляемого экземпляра, из раскрывающегося списка.

   ![Сеть дополнительных MI](media/sql-database-managed-instance-failover-group-tutorial/networking-settings-for-secondary-mi.png)

1. На вкладке **Дополнительные параметры** для параметра Георепликация выберите **Да** для _использования в качестве вторичной_отработки отказа. Выберите основной управляемый экземпляр из раскрывающегося списка. 
    1. Убедитесь, что параметры сортировки и часовой пояс соответствуют основному управляемому экземпляру. В основном управляемом экземпляре, созданном в этом учебнике, использовалось `(UTC) Coordinated Universal Time` по умолчанию `SQL_Latin1_General_CP1_CI_AS` параметры сортировки и часовой пояс. 

   ![Сеть дополнительных MI](media/sql-database-managed-instance-failover-group-tutorial/secondary-mi-failover.png)

1. Выберите **проверить и создать** , чтобы проверить параметры для вторичного управляемого экземпляра. 
1. Выберите **создать** , чтобы создать вторичный управляемый экземпляр. 


## <a name="4---create-primary-virtual-network-gateway"></a>4\. Создание основного шлюза виртуальной сети 

Чтобы два управляемых экземпляра участвовали в группе отработки отказа, необходимо настроить шлюз между виртуальными сетями двух управляемых экземпляров, чтобы разрешить сетевую связь. Шлюз для основного управляемого экземпляра можно создать с помощью портал Azure:

1. В [портал Azure](https://portal.azure.com)перейдите к группе ресурсов и выберите ресурс **виртуальной сети** для основного управляемого экземпляра. 
1. Выберите **подсети** в разделе **Параметры** , а затем выберите, чтобы добавить новую **подсеть шлюза**. Оставьте значения по умолчанию. 

   ![Добавление шлюза для основного управляемого экземпляра](media/sql-database-managed-instance-failover-group-tutorial/add-subnet-gateway-primary-vnet.png)

1. После создания шлюза подсети выберите **создать ресурс** в левой области навигации, а затем введите `Virtual network gateway` в поле поиска. Выберите ресурс **шлюза виртуальной сети** , опубликованный **корпорацией Майкрософт**. 

   ![Создание нового шлюза виртуальной сети](media/sql-database-managed-instance-failover-group-tutorial/create-virtual-network-gateway.png)

1. Заполните обязательные поля, чтобы настроить шлюз для основного управляемого экземпляра. 

   В следующей таблице приведены значения, необходимые для шлюза для основного управляемого экземпляра.
 
    | **Поле** | Значение |
    | --- | --- |
    | **Подписка** |  Подписка, в которой находится основной управляемый экземпляр. |
    | **Name** | Имя шлюза виртуальной сети, например `primary-mi-gateway`. | 
    | **Регион** | Регион, где находится ваш вторичный управляемый экземпляр. |
    | **Тип шлюза** | Выберите **VPN**. |
    | **Тип VPN** | Выбор **на основе маршрута** |
    | **SKU**| Оставьте значение по `VpnGw1`умолчанию для. |
    | **Location**| Расположение, в котором находится основной управляемый экземпляр и первичная виртуальная сеть.   |
    | **Виртуальная сеть**| Выберите виртуальную сеть, созданную в разделе 2, например `vnet-sql-mi-primary`. |
    | **Общедоступный IP-адрес**| Выберите **Создать**. |
    | **Имя общедоступного IP-адреса**| Введите имя IP-адреса, например `primary-gateway-IP`. |
    | &nbsp; | &nbsp; |
1. Оставьте остальные значения по умолчанию, а затем выберите **проверить и создать** , чтобы проверить параметры шлюза виртуальной сети.

   ![Параметры основного шлюза](media/sql-database-managed-instance-failover-group-tutorial/settings-for-primary-gateway.png)

1. Выберите **создать** , чтобы создать новый шлюз виртуальной сети. 

## <a name="5---configure-secondary-virtual-network-gateway"></a>5\. Настройка дополнительного шлюза виртуальной сети 

Повторите действия, описанные в предыдущем разделе, чтобы создать подсеть и шлюз виртуальной сети для вторичного управляемого экземпляра. Заполните обязательные поля, чтобы настроить шлюз для вторичного управляемого экземпляра. 

   В следующей таблице приведены значения, необходимые для шлюза для вторичного управляемого экземпляра.

   | **Поле** | Значение |
   | --- | --- |
   | **Подписка** |  Подписка, в которой находится экземпляр вторичного управляемого экземпляра. |
   | **Name** | Имя шлюза виртуальной сети, например `secondary-mi-gateway`. | 
   | **Регион** | Регион, где находится ваш вторичный управляемый экземпляр. |
   | **Тип шлюза** | Выберите **VPN**. |
   | **Тип VPN** | Выбор **на основе маршрута** |
   | **SKU**| Оставьте значение по `VpnGw1`умолчанию для. |
   | **Location**| Расположение, где находится дополнительный управляемый экземпляр и вторичная виртуальная сеть.   |
   | **Виртуальная сеть**| Выберите виртуальную сеть, созданную в разделе 2, например `vnet-sql-mi-secondary`. |
   | **Общедоступный IP-адрес**| Выберите **Создать**. |
   | **Имя общедоступного IP-адреса**| Введите имя IP-адреса, например `secondary-gateway-IP`. |
   | &nbsp; | &nbsp; |

   ![Параметры дополнительного шлюза](media/sql-database-managed-instance-failover-group-tutorial/settings-for-secondary-gateway.png)

## <a name="6---connect-the-gateways"></a>6\. Подключение шлюзов
На этом шаге создайте подключение между шлюзами. Подключение должно быть установлено с основного шлюза на дополнительный, а затем должно быть установлено отдельное соединение между базой данных-получателем и основным шлюзом. При настройке подключения между обоими шлюзами обязательно используйте один и тот же **общий ключ** . 

Чтобы настроить подключение, выполните следующие действия.

1. Перейдите к группе ресурсов в [портал Azure](https://portal.azure.com) и выберите основной шлюз, созданный на шаге 4. 
1. Выберите **подключения** в разделе **Параметры** , а затем нажмите кнопку **добавить** , чтобы создать новое соединение. 

   ![Добавление подключения к основному шлюзу](media/sql-database-managed-instance-failover-group-tutorial/add-primary-gateway-connection.png)

1. Введите имя для подключения, например `Primary-connection`, и введите значение для **общего** `mi1mi2psk`ключа, например. 
1. Выберите **второй шлюз виртуальной сети** , а затем выберите шлюз для вторичного управляемого экземпляра, например `secondary-mi-gateway`. 

   ![Создание первичного и вторичного подключения](media/sql-database-managed-instance-failover-group-tutorial/create-primary-to-secondary-connection.png)

1. Нажмите кнопку **ОК** , чтобы добавить новое подключение к шлюзу "основной-к-дополнительно".
1. Повторите эти действия, чтобы создать подключение из шлюза вторичного управляемого экземпляра к шлюзу основного управляемого экземпляра. 

   ![Создать вторичное подключение к первичному соединению](media/sql-database-managed-instance-failover-group-tutorial/create-secondary-to-primary-connection.png)


## <a name="7---create-a-failover-group"></a>7\. Создание группы отработки отказа
На этом шаге вы создадите группу отработки отказа и добавите в нее оба управляемых экземпляра. 

1. В [портал Azure](https://portal.azure.com)перейдите ко **всем службам** `managed instance` и введите в поле поиска. 
1. Используемых Выберите звездочку рядом с пунктом **управляемые экземпляры SQL** , чтобы добавить управляемые экземпляры в качестве ярлыка к левой панели навигации. 
1. Выберите **управляемые экземпляры SQL** и выберите основной управляемый экземпляр, например `sql-mi-primary`. 
1. В разделе **Параметры**перейдите к **экземпляру группы** отработки отказа и выберите **Добавить группу** , чтобы открыть страницу **группы отработки отказа экземпляра** . 

   ![Добавление группы отработки отказа](media/sql-database-managed-instance-failover-group-tutorial/add-failover-group.png)

1. На странице **Группа** отработки отказа введите имя группы отработки отказа, `failovergrouptutorial` например, а затем выберите дополнительный управляемый `sql-mi-secondary` экземпляр, например из раскрывающегося списка. Выберите **создать** , чтобы создать группу отработки отказа. 

   ![Создание группы отработки отказа](media/sql-database-managed-instance-failover-group-tutorial/create-failover-group.png)

1. После завершения развертывания группы отработки отказа будет выполнен переход на страницу **группы** отработки отказа. 

## <a name="8---test-failover"></a>8\. тестовая отработка отказа
На этом шаге группа отработки отказа будет передаваться на сервер-получатель, а затем восстановлена с помощью портал Azure. 

1. Перейдите к управляемому экземпляру в [портал Azure](https://portal.azure.com) и выберите **группы отработки отказа экземпляра** в разделе Параметры. 
1. Проверьте, какой управляемый экземпляр является первичным и какой управляемый экземпляр является вторичным. 
1. Выберите отработка отказа и нажмите **кнопку Да** в предупреждении о том, что сеансы TDS отключены. 

   ![Переключение группы отработки отказа](media/sql-database-managed-instance-failover-group-tutorial/failover-mi-failover-group.png)

1. Проверьте, какой экземпляр управляемого экземпляра является основным, а какой — дополнительным. Если отработка отказа завершилась успешно, два экземпляра должны иметь переключаемые роли. 

   ![Управляемые экземпляры с переключением ролей после отработки отказа](media/sql-database-managed-instance-failover-group-tutorial/mi-switched-after-failover.png)

1. Снова выберите отработку отказа, чтобы восстановить первичный экземпляр в первичную роль. 


## <a name="clean-up-resources"></a>Очистка ресурсов
Очистите ресурсы, сначала удалив управляемый экземпляр, затем виртуальный кластер, остальные ресурсы и, наконец, группу ресурсов. 

1. Перейдите к группе ресурсов в [портал Azure](https://portal.azure.com). 
1. Выберите управляемый экземпляр и нажмите кнопку **Удалить**. Введите `yes` текст в текстовое поле, чтобы подтвердить удаление ресурса, а затем выберите **Удалить**. Этот процесс может занять некоторое время в фоновом режиме, и пока он не будет завершен, вы не сможете удалить *виртуальный кластер* или другие зависимые ресурсы. Проследите за удалением на вкладке действие, чтобы подтвердить удаление управляемого экземпляра. 
1. После удаления управляемого экземпляра удалите *виртуальный кластер* , выбрав его в группе ресурсов, а затем нажмите кнопку **Удалить**. Введите `yes` текст в текстовое поле, чтобы подтвердить удаление ресурса, а затем выберите **Удалить**. 
1. Удалите все оставшиеся ресурсы. Введите `yes` текст в текстовое поле, чтобы подтвердить удаление ресурса, а затем выберите **Удалить**. 
1. Удалите группу ресурсов, выбрав **Удалить группу ресурсов**, введя имя группы `myResourceGroup`ресурсов, а затем выбрав **Удалить**. 

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы настроили группу отработки отказа между двумя управляемыми экземплярами. Вы научились выполнять следующие задачи:

> [!div class="checklist"]
> - Создание основного управляемого экземпляра
> - Создайте вторичный управляемый экземпляр в составе [группы](sql-database-auto-failover-group.md)отработки отказа. 
> - Тестовая отработка отказа

Перейдите к следующему краткому руководству по подключению к управляемому экземпляру и восстановлению базы данных в управляемом экземпляре. 

> [!div class="nextstepaction"]
> [Подключение к управляемому экземпляру](sql-database-managed-instance-configure-vm.md)
> [Восстановление базы данных в управляемый экземпляр](sql-database-managed-instance-get-started-restore.md)


