---
title: Ускоренное восстановление базы данных
description: В Базе данных Azure SQL доступна новая функция, обеспечивающая быстрое и последовательное восстановление базы данных, мгновенный откат транзакций и интенсивное усечение журнала для отдельных баз данных и баз данных в пуле в Базе данных SQL Azure и Хранилище данных SQL Azure.
ms.service: sql-database
ms.subservice: high-availability
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: mashamsft
ms.author: mathoma
ms.reviewer: carlrab
ms.date: 03/24/2020
ms.openlocfilehash: 57ca594dd067d15009de5e3abf7276fae48720d2
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80238660"
---
# <a name="accelerated-database-recovery"></a>Ускорение восстановления базы данных

**Ускоренное восстановление базы данных (ADR)** — это функция движка базы данных S'L, которая значительно повышает доступность базы данных, особенно при наличии длительных транзакций, путем реорганизации процесса восстановления движка базы данных S'L. ADR в настоящее время доступен для единого, эластичного пула и управляемого экземпляра Azure S'L (в настоящее время находится в предварительном просмотре). Основные преимущества ADR

- **Быстрое и согласованное восстановление баз данных**

  При использовании ADR длительные транзакции не влияют на общее время восстановления, благодаря чему обеспечивается быстрое и согласованное восстановление базы данных независимо от количества активных транзакций в системе или их размеров.

- **Мгновенный откат транзакции**

  При использовании ADR откат транзакций совершается мгновенно независимо от времени активности транзакции или количества выполненных обновлений.

- **Агрессивное усечение журнала**

  С ADR журнал транзакций агрессивно усечен, даже при наличии активных длительных транзакций, что не позволяет ему выйти из-под контроля.

## <a name="the-current-database-recovery-process"></a>Текущий процесс восстановления базы данных

Восстановление базы данных в SQL Server соответствует модели восстановления [ARIES](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) и состоит из трех этапов, которые проиллюстрированы на следующей схеме. Их подробное описание представлено ниже.

![текущий процесс восстановления](./media/sql-database-accelerated-database-recovery/current-recovery-process.png)

- **Стадия анализа**

  Передний скан журнала транзакций от начала последнего успешного контрольно-пропускного пункта (или старейшей грязной страницы LSN) до конца, чтобы определить состояние каждой транзакции на момент остановки сервера S'L.

- **Стадия повтора**

  Передний скан журнала транзакций из старейшей незафиксированной транзакции до конца, чтобы довести базу данных до состояния, которым она была во время сбоя, переделывая все совершенные операции.

- **Стадия отката**

  В каждой транзакции, которая была активна на момент сбоя, происходит перемещение по журналу назад и отменяются операции, выполненные в ходе этой транзакции.

Исходя из этой схемы, время, необходимое ядру СУБД SQL для восстановления после неожиданного перезапуска, (примерно) пропорционально размеру самой продолжительной активной транзакции в системе во время сбоя. Для восстановления требуется откат всех незавершенных транзакций. Необходимое время пропорционально объему работы, выполненному транзакцией, и времени ее активности. Таким образом, процесс восстановления сервера S'L может занять длительное время при наличии длительных транзакций (таких как операции больших вставок навалом или операции сборки индекса против большой таблицы).

Кроме того, отмена или откат большой транзакции по этой схеме также может занять много времени, так как используется та же самая стадия восстановления (стадия отката), как описано выше.

Кроме того, движок базы данных S'L не может усеивать журнал транзакций при длительных транзакциях, поскольку для процессов восстановления и отката необходимы соответствующие записи журнала. В результате этого проекта движка базы данных S'L некоторые клиенты сталкивались с проблемой, что размер журнала транзакций растет очень большой и потребляет огромное количество дискового пространства.

## <a name="the-accelerated-database-recovery-process"></a>Процесс ускоренного восстановления базы данных

С помощью функции ADR можно решить вышеуказанные проблемы, полностью изменив процесс восстановления ядра СУБД SQL следующим образом:

- Процесс длится фиксированное время или производится мгновенно благодаря тому, что не приходится проверять журнал от начала самой старой активной транзакции. С ADR журнал транзакций обрабатывается только с последнего успешного контрольно-пропускного пункта (или старейшей грязной страницы Номер последовательности журнала (LSN)). В результате длительные транзакции не влияют на время восстановления.
- Уменьшается место, которое требуется для журнала транзакций, так как больше не нужно обрабатывать журнал для всей транзакции. В результате журнал транзакций может агрессивно усекаться при наличии контрольных точек и резервных копий.

На высоком уровне ADR обеспечивает быстрое восстановление базы данных, отменяя все физические изменения базы данных и только отменяя логические операции, которые ограничены и могут быть отменены почти мгновенно. Любая транзакция, которая была активна на момент сбоя, помечается как прерванная, и поэтому любые версии, созданные такими транзакциями, могут быть проигнорированы в параллельных запросах пользователей.

Процесс восстановления ADR состоит из тех же трех этапов, что и текущий процесс восстановления. Этапы восстановления ADR проиллюстрированы на следующей схеме, а их подробное описание представлено ниже.

![Процесс восстановления ADR](./media/sql-database-accelerated-database-recovery/adr-recovery-process.png)

- **Стадия анализа**

  Процесс остается таким же, как и раньше с добавлением реконструкции sLog и копирования записей журналов для неверсированных операций.
  
- **Этап редо**

  Эта стадия разделена на два этапа.
  - Этап 1

      Повтор из sLog (от самой старой незафиксированной транзакции до последней контрольной точки). Повтор — это быстрая операция, так как требует обработки всего нескольких записей из sLog.
      
  - Этап 2

     Повтор в журнале транзакций начинается с последней контрольной точки (вместо самой старой незафиксированной транзакции).
     
- **Стадия отката**

   Стадия отката, выполняемая с помощью ADR, завершается почти мгновенно с использованием sLog для отката неверсионных операций и постоянного хранилища версий (PVS) с логической отменой для выполнения отката версий на уровне строк.

## <a name="adr-recovery-components"></a>Компоненты восстановления ADR

Ниже приведены четыре основных компонента ADR.

- **Постоянное хранилище версий (PVS)**

  Постоянное хранилище версий — это новое ядро СУБД SQL, предназначенное для хранения версий строк, созданных в базе данных, вместо традиционного хранилища версий `tempdb`. PVS позволяет изолировать ресурсы, а также повышает доступность получателей, доступных для чтения.

- **Логическая отмена изменений**

  Логический возврат — это асинхронный процесс, ответственный за выполнение строкового уровня версии На основе Undo - предоставление мгновенного отката транзакций и отменить все операции с версиями. Логический возврат осуществляется путем:

  - Отслеживание всех прерванных транзакций и маркировка их невидимыми для других транзакций. 
  - Выполнение отката с помощью PVS для всех пользовательских транзакций, а не физические сканирование журнала транзакций и отмена изменений по одному.
  - Освобождение всех блокировок сразу после прерывания транзакции. Поскольку прерывание включает в себя просто маркировки изменений в памяти, процесс является очень эффективным и, следовательно, замки не должны быть проведены в течение длительного времени.

- **sLog**

  sLog — это дополнительный поток журнала в памяти, в котором хранятся записи журнала для операций без версий (таких как перевод кэша метаданных в недействительное состояние, получение блокировки и т. д.). sLog обладает следующими особенностями:

  - малый объем и размещение в памяти;
  - сохраняется на диске путем сериализации во время обработки контрольных точек;
  - периодическое усекается при фиксации транзакций;
  - ускоряет повтор и отмену благодаря обработке только операций без версий;  
  - обеспечивает агрессивное усечение журнала транзакций за счет сохранения только необходимых записей журнала.

- **Очистка**

  Очистка — это асинхронный процесс, который периодически активируется и очищает ненужные версии страниц.

## <a name="accelerated-database-recovery-patterns"></a>Ускоренные шаблоны восстановления базы данных

Следующие типы рабочих нагрузок в наибольшей пользу от ADR:

- Рабочие нагрузки с длительными транзакциями.
- Рабочие нагрузки, в которых наблюдались случаи, когда активные транзакции приводят к значительному росту журнала транзакций.  
- Рабочие нагрузки, которые испытывали длительные периоды недоступности базы данных из-за длительного восстановления сервера S'L (например, неожиданная перезагрузка сервера S'L или ручной откат транзакций).

