---
title: Ускоренное восстановление базы данных
description: В Базе данных Azure SQL доступна новая функция, обеспечивающая быстрое и последовательное восстановление базы данных, мгновенный откат транзакций и интенсивное усечение журнала для отдельных баз данных и баз данных в пуле в Базе данных SQL Azure и Хранилище данных SQL Azure.
ms.service: sql-database
ms.subservice: high-availability
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: mashamsft
ms.author: mathoma
ms.reviewer: carlrab
ms.date: 03/24/2020
ms.openlocfilehash: 57ca594dd067d15009de5e3abf7276fae48720d2
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "80238660"
---
# <a name="accelerated-database-recovery"></a>Ускорение восстановления базы данных

**Ускоренное восстановление базы данных (ADR)** — это функция ядра СУБД SQL, которая значительно улучшает доступность базы данных, особенно при наличии длительных транзакций, путем перепроектирования процесса восстановления ядра СУБД SQL. В настоящее время ADR доступен для базы данных SQL Azure Single, эластичного пула и управляемого экземпляра, а базы данных в хранилище данных SQL Azure (в настоящее время находится на этапе предварительной версии). Основные преимущества ADR

- **Быстрое и согласованное восстановление баз данных**

  При использовании ADR длительные транзакции не влияют на общее время восстановления, благодаря чему обеспечивается быстрое и согласованное восстановление базы данных независимо от количества активных транзакций в системе или их размеров.

- **Мгновенный откат транзакции**

  При использовании ADR откат транзакций совершается мгновенно независимо от времени активности транзакции или количества выполненных обновлений.

- **Агрессивное усечение журнала**

  При использовании правила ADR журнал транзакций агрессивно усекается, даже при наличии активных долго выполняющихся транзакций, что предотвращает ее неконтролируемое увеличение контроля.

## <a name="the-current-database-recovery-process"></a>Текущий процесс восстановления базы данных

Восстановление базы данных в SQL Server соответствует модели восстановления [ARIES](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) и состоит из трех этапов, которые проиллюстрированы на следующей схеме. Их подробное описание представлено ниже.

![текущий процесс восстановления](./media/sql-database-accelerated-database-recovery/current-recovery-process.png)

- **Стадия анализа**

  Пересылка журнала транзакций с начала последней успешной контрольной точки (или самой старой "грязной" страницы номер LSN) до конца, чтобы определить состояние каждой транзакции во время SQL Server остановлена.

- **Стадия повтора**

  Пересылка журнала транзакций от самой старой незафиксированной транзакции до конца, чтобы перевести базу данных в состояние сбоя, повторно выполнив все зафиксированные операции.

- **Стадия отката**

  В каждой транзакции, которая была активна на момент сбоя, происходит перемещение по журналу назад и отменяются операции, выполненные в ходе этой транзакции.

Исходя из этой схемы, время, необходимое ядру СУБД SQL для восстановления после неожиданного перезапуска, (примерно) пропорционально размеру самой продолжительной активной транзакции в системе во время сбоя. Для восстановления требуется откат всех незавершенных транзакций. Необходимое время пропорционально объему работы, выполненному транзакцией, и времени ее активности. Таким образом, процесс восстановления SQL Server может занять длительное время в случае длительных транзакций (таких как большие операции с массовыми вставками или операции построения индекса для большой таблицы).

Кроме того, отмена или откат большой транзакции по этой схеме также может занять много времени, так как используется та же самая стадия восстановления (стадия отката), как описано выше.

Кроме того, ядро СУБД SQL не может Усечь журнал транзакций, если имеются длительные транзакции, поскольку для процессов восстановления и отката требуются соответствующие записи журнала. В результате такого проектирования ядра СУБД SQL некоторые клиенты использовались для решения проблемы, так как размер журнала транзакций растет очень много и потребляет огромные объемы дискового пространства.

## <a name="the-accelerated-database-recovery-process"></a>Процесс ускоренного восстановления базы данных

С помощью функции ADR можно решить вышеуказанные проблемы, полностью изменив процесс восстановления ядра СУБД SQL следующим образом:

- Процесс длится фиксированное время или производится мгновенно благодаря тому, что не приходится проверять журнал от начала самой старой активной транзакции. В случае с ADR журнал транзакций обрабатывается только из последней успешной контрольной точки (или самого старого номера LSN, который был изменен в журнале страниц). В результате длительные транзакции не влияют на время восстановления.
- Уменьшается место, которое требуется для журнала транзакций, так как больше не нужно обрабатывать журнал для всей транзакции. В результате журнал транзакций может агрессивно усекаться при наличии контрольных точек и резервных копий.

На высоком уровне, ADR обеспечивает быстрое восстановление базы данных путем управления версиями всех физических изменений базы данных и только отмену логических операций, которые ограничены и могут быть отменены почти мгновенно. Любая транзакция, которая была активна на момент сбоя, помечается как прерванная, и поэтому любые версии, созданные такими транзакциями, могут быть проигнорированы в параллельных запросах пользователей.

Процесс восстановления ADR состоит из тех же трех этапов, что и текущий процесс восстановления. Этапы восстановления ADR проиллюстрированы на следующей схеме, а их подробное описание представлено ниже.

![Процесс восстановления ADR](./media/sql-database-accelerated-database-recovery/adr-recovery-process.png)

- **Стадия анализа**

  Процесс остается таким же, как и раньше, с добавлением реконструирования sLog и копированием записей журнала для операций без управления версиями.
  
- Стадия **повтора**

  Эта стадия разделена на два этапа.
  - Этап 1

      Повтор из sLog (от самой старой незафиксированной транзакции до последней контрольной точки). Повтор — это быстрая операция, так как требует обработки всего нескольких записей из sLog.
      
  - Этап 2

     Повтор в журнале транзакций начинается с последней контрольной точки (вместо самой старой незафиксированной транзакции).
     
- **Стадия отката**

   Стадия отката, выполняемая с помощью ADR, завершается почти мгновенно с использованием sLog для отката неверсионных операций и постоянного хранилища версий (PVS) с логической отменой для выполнения отката версий на уровне строк.

## <a name="adr-recovery-components"></a>Компоненты восстановления ADR

Ниже приведены четыре основных компонента ADR.

- **Постоянное хранилище версий (PVS)**

  Постоянное хранилище версий — это новое ядро СУБД SQL, предназначенное для хранения версий строк, созданных в базе данных, вместо традиционного хранилища версий `tempdb`. PVS позволяет изолировать ресурсы, а также повышает доступность получателей, доступных для чтения.

- **Логическая отмена изменений**

  Логический откат — это асинхронный процесс, ответственный за отмену изменений на уровне строк, предоставляя мгновенный откат и отмену операций с управлением версиями. Логический откат выполняется следующим образом.

  - Отслеживание всех прерванных транзакций и пометка их невидимыми для других транзакций. 
  - Выполнение отката с помощью постоянного хранилища версий для всех пользовательских транзакций вместо физического сканирования журнала транзакций и отмены изменений по одному за раз.
  - Освобождение всех блокировок сразу после прерывания транзакции. Так как прерывание подразумевает простое пометку изменений в памяти, процесс очень эффективен, поэтому блокировки не должны храниться в течение длительного времени.

- **sLog**

  sLog — это дополнительный поток журнала в памяти, в котором хранятся записи журнала для операций без версий (таких как перевод кэша метаданных в недействительное состояние, получение блокировки и т. д.). sLog обладает следующими особенностями:

  - малый объем и размещение в памяти;
  - сохраняется на диске путем сериализации во время обработки контрольных точек;
  - периодическое усекается при фиксации транзакций;
  - ускоряет повтор и отмену благодаря обработке только операций без версий;  
  - обеспечивает агрессивное усечение журнала транзакций за счет сохранения только необходимых записей журнала.

- **Очистка**

  Очистка — это асинхронный процесс, который периодически активируется и очищает ненужные версии страниц.

## <a name="accelerated-database-recovery-patterns"></a>Шаблоны восстановления баз данных с ускорением

Преимущество следующих типов рабочих нагрузок от ADR:

- Рабочие нагрузки с долго выполняющимися транзакциями.
- Рабочие нагрузки, в которых встречаются случаи, когда активные транзакции вызывают значительное увеличение журнала транзакций.  
- Рабочие нагрузки с длительными периодами недоступности базы данных из-за SQL Server длительного восстановления (например, непредвиденных SQL Server перезапуска или отката транзакций вручную).

