---
title: Правила брандмауэра для IP-адресов
description: Налаживание правил IP-брандмауэра уровня сервера для базы данных S'L или брандмауэра хранилища данных. Управление правилами IP-брандмауэра уровня базы данных и на основе иснастройки для единой или объединенной базы данных.
services: sql-database
ms.service: sql-database
ms.subservice: security
titleSuffix: Azure SQL Database and SQL Data Warehouse
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: VanMSFT
ms.author: vanto
ms.reviewer: carlrab
ms.date: 03/18/2019
ms.openlocfilehash: af88fdf3378a6290c773c658ea6dd3469d7c92cc
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79531283"
---
# <a name="azure-sql-database-and-azure-sql-data-warehouse-ip-firewall-rules"></a>Правила брандмауэра хранилища ip-адресов Azure S'L и хранилища данных ИС

> [!NOTE]
> Эта статья распространяется как на серверы Azure S'L, так и на базы данных базы данных Azure S'L, а также базы данных хранилища данных Azure S'L на сервере Azure S'L. Для простоты *база данных S'L* используется для обозначения как базы данных S'L, так и склада данных S'L.

> [!IMPORTANT]
> Эта статья *не* относится к *Управляемому экземпляру Базы данных SQL Azure*. Для получения информации о конфигурации сети можно [ознакомиться с информацией о](sql-database-managed-instance-connect-app.md)конфигурации сети, см.

Например, при создании нового сервера Azure S'L под названием *mysqlserver*брандмауэр базы данных блокирует доступ к общедоступной конечной точке для сервера (доступной в *mysqlserver.database.windows.net).*

> [!IMPORTANT]
> Хранилище данных S'L поддерживает только правила IP-брандмауэра на уровне сервера. Он не поддерживает правила IP-брандмауэра уровня базы данных.

## <a name="how-the-firewall-works"></a>Как работает брандмауэр
Попытки подключения из Интернета и Azure должны пройти через брандмауэр, прежде чем они достигнут вашего сервера s или базы данных S'L, как показано на следующей диаграмме.

   ![Диаграмма конфигурации брандмауэра][1]

### <a name="server-level-ip-firewall-rules"></a>Правила брандмауэра для IP-адресов на уровне сервера

  Эти правила разрешают клиентам доступ ко всему серверу Azure SQL Server, то есть ко всем базам данных на одном сервере Базы данных SQL. Правила хранятся в *основной* базе данных. Для сервера Azure S'L Server можно иметь максимум 128 правил IP-адреса. Если у вас есть **службы Allow Azure и ресурсы для доступа к этому** серверу, это считается единым правилом брандмауэра для Azure S'L Server.
  
  Вы можете настроить правила IP-брандмауэра на уровне сервера с помощью портала Azure, powerShell или трансат-СЗЛ..
  - Чтобы использовать портал или PowerShell, вы должны быть владельцем подписки или участником подписки.
  - Для использования ВС-СЗЛ необходимо подключиться к экземпляру базы данных S'L в качестве основного входа на серверилий или администратора active Directory Azure. (Правило IP-брандмауэра уровня сервера должно быть создано пользователем, у которого есть разрешения уровня Azure.)

### <a name="database-level-ip-firewall-rules"></a>Правила брандмауэра для IP-адресов на уровне базы данных

  Эти правила разрешают клиентам доступ к определенным (защищенным) базам данных на одном сервере Базы данных SQL. Вы создаете правила для каждой базы данных (включая *базу* данных), и они хранятся в отдельной базе данных.
  
  Вы можете создавать и управлять правилами IP-брандмауэра на уровне баз данных для баз данных master и пользовательских баз данных с помощью заявлений Transact-S'L и только после настройки первого брандмауэра на уровне сервера.
  
  Если указать диапазон IP-адресов в правиле IP-брандмауэра уровня базы данных, которое находится за пределами диапазона в правиле IP-брандмауэра на уровне сервера, доступ к базе данных могут получить только те клиенты, которые имеют IP-адреса в диапазоне уровня базы данных.
  
  Для базы данных можно задать не более 128 правил брандмауэра для IP-адресов на уровне базы данных. Для получения дополнительной информации о настройке правил IP-брандмауэра ip-класса, см. более поздний пример в этой статье и [см. sp_set_database_firewall_rule (База данных Azure S'L)](https://msdn.microsoft.com/library/dn270010.aspx).

### <a name="recommendations-for-how-to-set-firewall-rules"></a>Рекомендации по установлению правил брандмауэра

Мы рекомендуем по возможности использовать правила IP-брандмауэра уровня базы данных. Эта практика повышает безопасность и делает вашу базу данных более портативной. Используйте правила IP-брандмауэра уровня сервера для администраторов. Также используйте их, когда у вас есть много баз данных, которые имеют те же требования к доступу, и вы не хотите, чтобы настроить каждую базу данных по отдельности.

> [!NOTE]
> Сведения о портативных базах данных в контексте непрерывности бизнес-процессов см. в разделе [Требования к проверке подлинности для аварийного восстановления](sql-database-geo-replication-security-config.md).

## <a name="server-level-versus-database-level-ip-firewall-rules"></a>Правила брандмауэра для IP-адресов уровня сервера и уровня базы данных

*Необходимо ли полностью изолировать пользователей одной базы данных от пользователей другой базы данных ?*

Если *да,* используйте правила IP-брандмауэра уровня базы данных для предоставления доступа. Этот метод позволяет избежать использования правил IP-брандмауэра уровня сервера, которые позволяют получить доступ через брандмауэр ко всем базам данных. Это уменьшит глубину вашей защиты.

*Нужен ли пользователям IP-адресов доступ ко всем базам данных?*

Если *да,* используйте правила IP-брандмауэра на уровне сервера, чтобы сократить количество раз, что вам нужно настроить правила IP брандмауэра.

*Имеет ли человек или команда, которые настраивают правила IP-брандмауэра, доступ только через портал Azure, PowerShell или REST API?*

Если это так, необходимо использовать правила IP-брандмауэра уровня сервера. Правила IP-брандмауэра уровня базы данных могут быть настроены только с помощью Transact-S'L.  

*Запрещается ли человеку или команде, накончающему правила IP-брандмауэра, иметь разрешение высокого уровня на уровне базы данных?*

Если да, используйте правила IP-брандмауэра уровня сервера. Вам нужно, по крайней *мере,* разрешение CONTROL DATABASE на уровне базы данных для настройки правил IP-брандмауэра уровня базы данных с помощью Transact-S'L.  

*Управляет ли человек или команда, которые настраивает или проверяет правила IP-брандмауэра, централизованно управлять правилами IP-брандмауэра для многих (возможно, сотен) баз данных?*

В этом сценарии рекомендации определяются вашими потребностями и окружающей средой. Правила брандмауэра для IP-адресов на уровне сервера проще настроить, но сценарии позволяют настроить правила уровня базы данных. И даже если вы используете правила IP-брандмауэра на уровне сервера, возможно, потребуется провести аудит правил IP-брандмауэра уровня базы данных, чтобы увидеть, создают ли пользователи с разрешением *CONTROL* в базе данных правила IP-брандмауэра.

*Могу ли я использовать сочетание правил БРАНД-стена на уровне сервера и базы данных?*

Да. Некоторым пользователям, например администраторам, могут потребоваться правила IP-брандмауэра ip-класса. А другим пользователям, например пользователям приложения базы данных, необходимы правила брандмауэра для IP-адресов на уровне базы данных.

### <a name="connections-from-the-internet"></a>Подключения через Интернет

Когда компьютер пытается подключиться к серверу базы данных из Интернета, брандмауэр сначала проверяет исходный IP-адрес запроса на правила IP-сообщения для базы данных, которые запрашивает соединение.

- Если адрес находится в пределах диапазона, указанного в правилах IP-брандмауэра уровня базы данных, соединение предоставляется в базу данных S'L, содержащую правило.
- Если адрес не находится в пределах диапазона правил IP-брандмауэра уровня базы данных, брандмауэр проверяет правила IP-брандмауэра уровня сервера. Если адрес находится в пределах диапазона, который находится в правилах IP-сообщения о брандмауэре на уровне сервера, соединение предоставляется. Правила брандмауэра для IP-адресов на уровне сервера применяются ко всем базам данных SQL на сервере SQL Azure.  
- Если адрес не находится в пределах диапазона, который находится в любом из правил брандмауэра IP-сообщения на уровне базы данных или сервера, запрос на подключение завершается неудачей.

> [!NOTE]
> Чтобы получить доступ к базе данных S'L с локального компьютера, убедитесь, что брандмауэр в вашей сети и локальном компьютере позволяет исходящие связи на tCP порт 1433.

### <a name="connections-from-inside-azure"></a>Соединения изнутри Azure

Для того чтобы приложения, размещенные в Azure, были подключены к серверу S'L, необходимо подключить соединения Azure. Когда приложение из Azure пытается подключиться к серверу базы данных, брандмауэр проверяет, что соединения Azure разрешены. Параметр брандмауэра, в результате которого запуск и окончание IP-адреса равны *0.0.0.0,* указывает на то, что соединения Azure разрешены. Это можно включить непосредственно из лезвия Портала Azure, установив правила Firewall, а также переключив **службы Allow Azure и ресурсы для доступа к этому серверу** в **ON** в настройках **Firewalls и виртуальных сетей.** Если подключение не разрешено, запрос не достигает сервера базы данных S'L.

> [!IMPORTANT]
> Эта опция настраивает брандмауэр на все соединения из Azure, включая соединения из подписок других клиентов. Если вы выберете эту опцию, убедитесь, что ваш логин и пользовательские разрешения ограничивают доступ только к авторизованным пользователям.

## <a name="create-and-manage-ip-firewall-rules"></a>Создание и управление правилами БРАНД Брандмауэр

Вы создаете первую настройку брандмауэра уровня сервера, используя [портал Azure](https://portal.azure.com/) или программно, используя [Azure PowerShell,](https://docs.microsoft.com/powershell/module/az.sql) [Azure CLI](https://docs.microsoft.com/cli/azure/sql/server/firewall-rule)или API Azure [REST.](https://docs.microsoft.com/rest/api/sql/firewallrules/createorupdate) Вы создаете и управляете дополнительными правилами IP-брандмауэра на уровне сервера, используя эти методы или Трансакт-СЗЛ.

> [!IMPORTANT]
> Правила IP-брандмауэра уровня базы данных могут создаваться и управляться только с помощью Transact-S'L.

Для повышения производительности правила брандмауэра для IP-адресов на уровне сервера временно кэшируются на уровне базы данных. Сведения об обновлении кэша см. в статье [DBCC FLUSHAUTHCACHE (Transact-SQL)](https://msdn.microsoft.com/library/mt627793.aspx).

> [!TIP]
> Чтобы провести аудит изменений брандмауэра уровня сервера и уровня базы данных, можно использовать [аудит базы данных SQL](sql-database-auditing.md).

### <a name="use-the-azure-portal-to-manage-server-level-ip-firewall-rules"></a>Используйте портал Azure для управления правилами IP-брандмауэра ip-класса

Чтобы установить правило IP-брандмауэра на портале Azure, перейдите на страницу обзора для базы данных Azure S-L или на сервере базы данных S'L.

> [!TIP]
> Руководство см. в статье [Создание базы данных SQL Azure на портале Azure](sql-database-single-database-get-started.md).

#### <a name="from-the-database-overview-page"></a>Со страницы обзора базы данных

1. Чтобы установить правило IP-панефверия на уровне сервера со страницы обзора базы данных, выберите **брандмауэр сервера** на панели инструментов, как показано на следующем изображении. 

    ![Правило брандмауэра IP-адреса сервера](./media/sql-database-get-started-portal/sql-database-server-set-firewall-rule.png)

    Откроется страница **параметров брандмауэра** для сервера Базы данных SQL.

2. Выберите **Добавить клиентСКИЙ IP** на панели инструментов, чтобы добавить IP-адрес компьютера, который вы используете, а затем выберите **Сохранить.** Для текущего IP-адреса будет создано правило брандмауэра для IP-адресов на уровне сервера.

    ![Установка правила IP-брандмауэра уровня сервера](./media/sql-database-get-started-portal/sql-database-server-firewall-settings.png)

#### <a name="from-the-server-overview-page"></a>Со страницы обзора сервера

Открывается страница обзора для вашего сервера. Он показывает полностью квалифицированное имя сервера *(например, mynewserver20170403.database.windows.net)* и предоставляет варианты для дальнейшей конфигурации.

1. Чтобы установить правило уровня сервера с этой страницы, выберите **Firewall** из меню **«Настройки»** на левой стороне.

2. Выберите **Добавить клиентСКИЙ IP** на панели инструментов, чтобы добавить IP-адрес компьютера, который вы используете, а затем выберите **Сохранить.** Для текущего IP-адреса будет создано правило брандмауэра для IP-адресов на уровне сервера.

### <a name="use-transact-sql-to-manage-ip-firewall-rules"></a>Используйте Трансакт-СЗЛ для управления правилами БРАНД брандмауэра

| Представление каталога или сохраненная процедура | Level | Описание |
| --- | --- | --- |
| [sys.firewall_rules](https://msdn.microsoft.com/library/dn269980.aspx) |Сервер |Отображает текущие правила брандмауэра для IP-адресов на уровне сервера |
| [sp_set_firewall_rule](https://msdn.microsoft.com/library/dn270017.aspx) |Сервер |Создает или обновляет правила брандмауэра для IP-адресов на уровне сервера |
| [sp_delete_firewall_rule](https://msdn.microsoft.com/library/dn270024.aspx) |Сервер |Удаляет правила брандмауэра для IP-адресов на уровне сервера |
| [sys.database_firewall_rules](https://msdn.microsoft.com/library/dn269982.aspx) |База данных |Отображает текущие правила брандмауэра для IP-адресов на уровне базы данных |
| [sp_set_database_firewall_rule](https://msdn.microsoft.com/library/dn270010.aspx) |База данных |Создает или обновляет правила брандмауэра для IP-адресов на уровне базы данных |
| [sp_delete_database_firewall_rule](https://msdn.microsoft.com/library/dn270030.aspx) |Базы данных |Удаляет правила брандмауэра для IP-адресов на уровне базы данных |

В следующем примере рассматриваются существующие правила, позволяет широкий спектр IP-адресов на сервере *Contoso*и удаляет правило IP-брандмауэра:

```sql
SELECT * FROM sys.firewall_rules ORDER BY name;
```

Затем добавьте правило брандмауэра для IP-адресов на уровне сервера.

```sql
EXECUTE sp_set_firewall_rule @name = N'ContosoFirewallRule',
   @start_ip_address = '192.168.1.1', @end_ip_address = '192.168.1.10'
```

Чтобы удалить правило IP-адреса сервера, *выполните* sp_delete_firewall_rule сохраненную процедуру. Следующий пример удаляет правило *ContosoFirewallRule:*

```sql
EXECUTE sp_delete_firewall_rule @name = N'ContosoFirewallRule'
```

### <a name="use-powershell-to-manage-server-level-ip-firewall-rules"></a>Используйте PowerShell для управления правилами IP-брандмауэра ip-класса 

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных Azure S'L, но все разработки теперь предназначены для модуля Az.Sql. Для этих cmdlets, см [AzureRM.Sql](https://docs.microsoft.com/powershell/module/AzureRM.Sql/). Аргументы для команд в модулях Az и AzureRm существенно идентичны.

| Командлет | Level | Описание |
| --- | --- | --- |
| [Get-AzSqlServerFirewallRule](/powershell/module/az.sql/get-azsqlserverfirewallrule) |Сервер |Возвращает текущие правила брандмауэра уровня сервера |
| [New-AzSqlServerFirewallRule](/powershell/module/az.sql/new-azsqlserverfirewallrule) |Сервер |Создает новое правило брандмауэра уровня сервера |
| [Set-AzSqlServerFirewallRule](/powershell/module/az.sql/set-azsqlserverfirewallrule) |Сервер |Обновляет свойства существующего правила брандмауэра уровня сервера |
| [Удалить-AzSqlServerFirewallRule](/powershell/module/az.sql/remove-azsqlserverfirewallrule) |Сервер |Удаляет правила брандмауэра уровня сервера |

Следующий пример использует PowerShell для установки правила IP-брандмауэра на уровне сервера:

```powershell
New-AzSqlServerFirewallRule -ResourceGroupName "myResourceGroup" `
    -ServerName $servername `
    -FirewallRuleName "ContosoIPRange" -StartIpAddress "192.168.1.0" -EndIpAddress "192.168.1.255"
```
> [!TIP]
> Для $servername указать имя сервера, а не полностью квалифицированное имя DNS, например, указать **mysqldbserver** вместо **mysqldbserver.database.windows.net**

> [!TIP]
> Для примеров PowerShell в контексте быстрого запуска [см. Создать DB - PowerShell](sql-database-powershell-samples.md) и [создать единую базу данных и настроить правило IP-брандмауэра уровня SL с помощью PowerShell.](scripts/sql-database-create-and-configure-database-powershell.md)

### <a name="use-cli-to-manage-server-level-ip-firewall-rules"></a>Используйте CLI для управления правилами IP-брандмауэра ip-класса

| Командлет | Level | Описание |
| --- | --- | --- |
|[az sql server firewall-rule create](/cli/azure/sql/server/firewall-rule#az-sql-server-firewall-rule-create)|Сервер|Создает правило брандмауэра для IP-адресов на уровне сервера|
|[az sql server firewall-rule list](/cli/azure/sql/server/firewall-rule#az-sql-server-firewall-rule-list)|Сервер|Выводит список правил брандмауэра для IP-адресов на сервере|
|[az sql server firewall-rule show](/cli/azure/sql/server/firewall-rule#az-sql-server-firewall-rule-show)|Сервер|Отображает детали правила IP-брандмауэра|
|[az sql server firewall-rule update](/cli/azure/sql/server/firewall-rule##az-sql-server-firewall-rule-update)|Сервер|Обновление правила IP-брандмауэра|
|[az sql server firewall-rule delete](/cli/azure/sql/server/firewall-rule#az-sql-server-firewall-rule-delete)|Сервер|Удаляет правило IP-брандмауэра|

В следующем примере используется CLI для установки правила IP-брандмауэра на уровне сервера:

```azurecli-interactive
az sql server firewall-rule create --resource-group myResourceGroup --server $servername \
-n ContosoIPRange --start-ip-address 192.168.1.0 --end-ip-address 192.168.1.255
```
> [!TIP]
> Для $servername указать имя сервера, а не полностью квалифицированное имя DNS, например, указать **mysqldbserver** вместо **mysqldbserver.database.windows.net**

> [!TIP]
> На примере CLI в контексте быстрого запуска см. [Создать DB - Azure CLI](sql-database-cli-samples.md) и [создать единую базу данных и настроить правило IP-панаи к использованию Azure CLI.](scripts/sql-database-create-and-configure-database-cli.md)

### <a name="use-a-rest-api-to-manage-server-level-ip-firewall-rules"></a>Используйте REST API для управления правилами IP-брандмауэра IP-сервера

| API | Level | Описание |
| --- | --- | --- |
| [Список правил брандмауэра](https://docs.microsoft.com/rest/api/sql/firewallrules/listbyserver) |Сервер |Отображает текущие правила брандмауэра для IP-адресов на уровне сервера |
| [Создание или обновление правил брандмауэра](https://docs.microsoft.com/rest/api/sql/firewallrules/createorupdate) |Сервер |Создает или обновляет правила брандмауэра для IP-адресов на уровне сервера |
| [Удаление правил брандмауэра](https://docs.microsoft.com/rest/api/sql/firewallrules/delete) |Сервер |Удаляет правила брандмауэра для IP-адресов на уровне сервера |
| [Получить правила брандмауэра](https://docs.microsoft.com/rest/api/sql/firewallrules/get) | Сервер | Возвращает правила брандмауэра для IP-адресов на уровне сервера |

## <a name="troubleshoot-the-database-firewall"></a>Устранение неполадок брандмауэра базы данных

Рассмотрим следующие моменты, когда доступ к службе базы данных S'L ведет себя не так, как вы ожидаете.

- **Конфигурация локального брандмауэра**

  Прежде чем компьютер сможет получить доступ к базе данных S'L, возможно, потребуется создать на вашем компьютере исключение из брандмауэра для порта TCP 1433. Чтобы сделать соединения внутри границы облака Azure, возможно, придется открыть дополнительные порты. Для получения дополнительной информации [ADO.NET,](sql-database-develop-direct-route-ports-adonet-v12.md)см.

- **Сетевой адресный перевод:**

  Из-за перевода сетевого адреса (NAT) IP-адрес, используемый компьютером для подключения к базе данных S'L, может отличаться от IP-адреса в настройках конфигурации IP-адреса компьютера. Для просмотра IP-адреса, который используется компьютером для подключения к Azure:
    1. Войдите на портал.
    1. Перейдите на вкладку **Настройка** на сервере, на котором размещена ваша база данных.
    1. **Текущий IP-адрес клиента** отображается в разделе **Разрешенные IP-адреса.** Выберите **Добавить** для **разрешенных IP-адресов,** чтобы позволить этому компьютеру получить доступ к серверу.

- **Изменения в списке разрешений еще не вступили в силу:**

  Для вхлаженной настройки брандмауэра базы данных может быть до пяти минут.

- **Логин не авторизован, или был использован неправильный пароль:**

  Если у входа нет разрешений на сервере базы данных или пароль неверен, подключение к серверу отказано. Создание параметра брандмауэра дает клиентам *возможность* подключиться к серверу. Клиент должен по-прежнему предоставлять необходимые учетные данные безопасности. Для получения дополнительной информации о подготовке логинов, [см. Управление и предоставление доступа к базе данных s'L и хранилище данных S'L](sql-database-manage-logins.md).

- **Динамический IP-адрес:**

  Если у вас есть подключение к Интернету, которое использует динамическое IP-адресизме и у вас есть проблемы с получением через брандмауэр, попробуйте одно из следующих решений:
  
  - Задайте своему интернет-провайдеру диапазон IP-адресов, назначенный вашим клиентам на компьютеры, которые получают доступ к серверу базы данных S'L. Добавьте диапазон IP-адресов в качестве правила IP-брандмауэра.
  - Вместо этого получите статический IP-адрес для компьютеров клиентов. Добавьте IP-адреса в правила IP-брандмауэра.

## <a name="next-steps"></a>Дальнейшие действия

- Подтвердите, что корпоративная сетевая среда позволяет внедренную связь из диапазонов вычислительных IP-адресов (включая диапазоны S'L), которые используются центрами обработки данных Azure. Возможно, вам придется добавить эти IP-адреса в список разрешений. Смотрите [диапазоны IP-адресов центра обработки данных Microsoft Azure.](https://www.microsoft.com/download/details.aspx?id=41653)  
- Для быстрого запуска о создании правила IP-брандмауэра на уровне сервера [см.](sql-database-single-database-get-started.md)
- Для получения помощи при подключении к базе данных Azure [Client quickstart code samples to SQL Database](https://msdn.microsoft.com/library/azure/ee336282.aspx)S'L из приложений с открытым исходным кодом или сторонними приложениями см.
- Для получения информации о дополнительных портах, которые могут потребоваться открыть, [ADO.NET](sql-database-develop-direct-route-ports-adonet-v12.md) см.
- Для получения обзора безопасности базы данных Azure S'L [см.](sql-database-security-overview.md)

<!--Image references-->
[1]: ./media/sql-database-firewall-configure/sqldb-firewall-1.png
