---
title: Аудит управляемого экземпляра
description: Узнайте, как приступить к аудиту управляемого экземпляра Базы данных SQL Azure с помощью T-SQL
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
f1_keywords:
- mi.azure.sqlaudit.general.f1
author: DavidTrigano
ms.author: datrigan
ms.reviewer: vanto
ms.date: 03/27/2020
ms.openlocfilehash: 405ac27fad3c24d3064f11476f452ad00abb9b02
ms.sourcegitcommit: d0fd35f4f0f3ec71159e9fb43fcd8e89d653f3f2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2020
ms.locfileid: "80387773"
---
# <a name="get-started-with-azure-sql-database-managed-instance-auditing"></a>Начало работы с аудитом управляемого экземпляра Базы данных SQL Azure

[Управляемый аудит экземпляра](sql-database-managed-instance.md) отслеживает события базы данных и записывает их в журнал аудита в учетной записи хранения Azure. Аудит также дает следующие возможности:

- Аудит может помочь вам соблюсти требования нормативов, проанализировать работу с базой данных и получить представление о расхождениях и аномалиях, которые могут указывать на бизнес-проблемы или предполагаемые нарушения безопасности.
- Средства аудита способствуют соблюдению стандартов соответствия, но не гарантируют их выполнение. Для получения дополнительной информации о программах Azure, поддерживающих соответствие стандартам, посетите [целевой центр Azure Trust Center,](https://gallery.technet.microsoft.com/Overview-of-Azure-c1be3942) где можно найти наиболее актуальный список сертификатов соответствия требованиям базы данных S'L.

## <a name="set-up-auditing-for-your-server-to-azure-storage"></a>Настройка аудита для сервера в службе хранилища Azure

В следующем разделе описывается настройка аудита для управляемого экземпляра.

1. Перейдите на [портал Azure](https://portal.azure.com).
2. Создайте **контейнер** службы хранилища Azure для хранения журналов аудита.

   1. Перейдите к хранилищу Azure, в котором вы намерены хранить журналы аудита.

      > [!IMPORTANT]
      > Используйте учетную запись хранения из того же региона, где размещен управляемый экземпляр, чтобы избежать операций чтения и записи между регионами.

   1. На странице учетной записи хранения перейдите на вкладку **Обзор** и щелкните **BLOB-объекты**.

      ![Мини-приложение больших двоичных объектов Azure](./media/sql-managed-instance-auditing/1_blobs_widget.png)

   1. В верхнем меню щелкните **+ Контейнер**, чтобы создать новый контейнер.

      ![Значок создания контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/2_create_container_button.png)

   1. Укажите **имя** контейнера, установите **закрытый** уровень общего доступа и щелкните **ОК**.

      ![Конфигурация создания контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/3_create_container_config.png)
  > [!IMPORTANT]
  > Клиент, желающий настроить непреложный магазин журналов для своих событий аудита на уровне сервера или базы данных, должен следовать [инструкциям, предоставленным Azure Storage](https://docs.microsoft.com/azure/storage/blobs/storage-blob-immutability-policies-manage#enabling-allow-protected-append-blobs-writes) (пожалуйста, вы выбрали **дополнительные приложения Allow** при настройке непреложного хранилища капля)
  
3. После создания контейнера существует два способа настроить его в качестве целевого объекта для журналов аудита: [с помощью T-SQL](#blobtsql) или [с помощью пользовательского интерфейса SQL Server Management Studio (SSMS)](#blobssms):

   - <a id="blobtsql"></a>Настройте хранилище BLOB-объектов для журналов аудита с помощью T-SQL:

     1. В списке контейнеров щелкните только что созданный контейнер, а затем **Свойства контейнера**.

        ![Кнопка свойств контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/4_container_properties_button.png)

     1. Скопируйте URL-адрес контейнера, щелкнув значок копирования, и сохраните этот URL-адрес (например, в Блокноте) для дальнейшего использования. URL-адрес контейнера должен иметь формат `https://<StorageName>.blob.core.windows.net/<ContainerName>`.

        ![Копирование URL-адреса контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/5_container_copy_name.png)

     1. Создайте **токен Azure Storage SAS Token** для предоставления управляемого экземпляра аудита прав доступа к учетной записи хранилища:

        - Перейдите к учетной записи хранения Azure, в которой вы создали контейнер на предыдущем шаге.

        - Щелкните **Подписанный URL-адрес** в меню "Параметры хранилища".

          ![Значок подписанного URL-адреса в меню параметров хранилища.](./media/sql-managed-instance-auditing/6_storage_settings_menu.png)

        - Настройте SAS следующим образом.

          - **Допустимые службы**: большой двоичный объект

          - **Дата начала:** чтобы избежать проблем, связанных с часового поясом, рекомендуется использовать дату вчерашнего дня

          - **Дата окончания:** выберите дату, на которую истекает срок действия этого токена SAS

            > [!NOTE]
            > Чтобы избежать сбоев аудита, не забудьте возобновить маркер по истечении срока действия.

          - Нажмите кнопку **Создать SAS**.
            
            ![Конфигурация SAS](./media/sql-managed-instance-auditing/7_sas_configure.png)

        - Когда вы щелкнете "Создать SAS", в нижней части страницы появится маркер SAS. Скопируйте маркер, щелкнув значок копирования, и сохраните его (например, в Блокноте) для дальнейшего использования.

          ![Копирование маркера SAS](./media/sql-managed-instance-auditing/8_sas_copy.png)

          > [!IMPORTANT]
          > Удалите символ знака вопроса (?) в начале маркера.

     1. Подключитесь к управляемому экземпляру, используя SQL Server Management Studio (SSMS) или любое другое поддерживаемое средство.

     1. Выполните следующую инструкцию T-SQL, чтобы **создать новые учетные данные** с использованием URL-адреса контейнера и маркера SAS, которые вы создали на предыдущих этапах.

        ```SQL
        CREATE CREDENTIAL [<container_url>]
        WITH IDENTITY='SHARED ACCESS SIGNATURE',
        SECRET = '<SAS KEY>'
        GO
        ```

     1. Выполните следующую инструкцию T-SQL, чтобы создать новый аудит сервера (выберите любое удобное имя аудита и укажите URL-адрес контейнера, созданный ранее). Если значение `RETENTION_DAYS` не указано, по умолчанию используется значение 0 (неограниченный период удержания).

        ```SQL
        CREATE SERVER AUDIT [<your_audit_name>]
        TO URL ( PATH ='<container_url>' [, RETENTION_DAYS =  integer ])
        GO
        ```

        1. Продолжите, [создав спецификацию аудита сервера или спецификацию аудита базы данных](#createspec).

   - <a id="blobssms"></a>Настройте хранилище BLOB-объектов для журналов аудита с помощью SQL Server Management Studio (SSMS) 18 (предварительная версия):

     1. Подключитесь к управляемому экземпляру через пользовательский интерфейс SQL Server Management Studio (SSMS).

     1. Разверните корневой узел обозревателя объектов.

     1. Разверните узел **Безопасность**, щелкните правой кнопкой мыши узел **Аудиты** и щелкните "Создать аудит":

        ![Развертывание узла аудитов и безопасности](./media/sql-managed-instance-auditing/10_mi_SSMS_new_audit.png)

     1. Убедитесь, что в поле **Назначение аудита** выбрано значение "URL-адрес", и щелкните **Обзор**:

        ![Просмотр службы хранилища](./media/sql-managed-instance-auditing/11_mi_SSMS_audit_browse.png)

     1. Войдите в учетную запись Azure (необязательно):

        ![Вход в Azure](./media/sql-managed-instance-auditing/12_mi_SSMS_sign_in_to_azure.png)

     1. Выберите подписку, учетную запись хранения и контейнер больших двоичных объектов из раскрывающихся списков или создайте собственный контейнер, щелкнув **Создать**. Когда вы зададите все необходимые параметры, нажмите кнопку **ОК**:

        ![Выберите подписку Azure, учетную запись хранения и контейнер с каплей](./media/sql-managed-instance-auditing/13_mi_SSMS_select_subscription_account_container.png)

     1. Нажмите кнопку **ОК** в диалоговом окне "Создать аудит".

4. <a id="createspec"></a>После настройки контейнера Blob в качестве целевого показателя для журналов аудита создайте и включите спецификацию аудита сервера или спецификацию аудита базы данных, как это было бы для сервера S'L:

   - [Руководство по созданию спецификации T-SQL для аудита сервера](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-specification-transact-sql)
   - [Руководство по созданию спецификации T-SQL для аудита базы данных](https://docs.microsoft.com/sql/t-sql/statements/create-database-audit-specification-transact-sql)

5. Включите аудит сервера, созданный в шаге 3:

    ```SQL
    ALTER SERVER AUDIT [<your_audit_name>]
    WITH (STATE=ON);
    GO
    ```

Дополнительные сведения см. в следующих статьях:

- [Аудит различий между отдельными базами данных, эластичными пулами и управляемыми экземплярами в базе данных Azure S'L и базами данных в сервере S'L](#auditing-differences-between-databases-in-azure-sql-database-and-databases-in-sql-server)
- [CREATE SERVER AUDIT](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-transact-sql)
- [ALTER SERVER AUDIT](https://docs.microsoft.com/sql/t-sql/statements/alter-server-audit-transact-sql)

## <a name="set-up-auditing-for-your-server-to-event-hub-or-azure-monitor-logs"></a>Настройка аудита для вашего сервера в журналы Event Hub или Azure Monitor

Записи журналов из управляемого экземпляра можно отправлять в журналы Even Hubs или Azure Monitor. В этом разделе описывается, как это настроить.

1. Откройте [портал Azure](https://portal.azure.com/) и перейдите к управляемому экземпляру.

2. Щелкните **Параметры диагностики**.

3. Щелкните **Включить диагностику**. Если диагностика уже включена, будет отображена кнопка *+Add diagnostic setting* (+ Добавить параметр диагностики).

4. Выберите **SQLSecurityAuditEvents** из списка журналов.

5. Выберите пункт назначения для событий аудита - концентратор событий, журналы Azure Monitor или и то, и другое. Настройте необходимые параметры (например, рабочую область Log Analytics) для каждой цели.

6. Нажмите **Сохранить**.

    ![Настройка параметров диагностики](./media/sql-managed-instance-auditing/9_mi_configure_diagnostics.png)

7. Подключитесь к управляемому экземпляру, используя **SQL Server Management Studio (SSMS)** или любой другой поддерживаемый клиент.

8. Выполните следующую инструкцию T-SQL для создания аудита сервера.

    ```SQL
    CREATE SERVER AUDIT [<your_audit_name>] TO EXTERNAL_MONITOR;
    GO
    ```

9. Создайте и включите спецификацию аудита сервера или спецификацию аудита базы данных, как это было бы для Сервера S'L:

   - [Руководство по созданию спецификации T-SQL для аудита сервера](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-specification-transact-sql)
   - [Руководство по созданию спецификации T-SQL для аудита базы данных](https://docs.microsoft.com/sql/t-sql/statements/create-database-audit-specification-transact-sql)

10. Включить аудит сервера, созданный в шаге 8:
 
    ```SQL
    ALTER SERVER AUDIT [<your_audit_name>]
    WITH (STATE=ON);
    GO
    ```

## <a name="consume-audit-logs"></a>Использование журналов аудита

### <a name="consume-logs-stored-in-azure-storage"></a>Использование журналов аудита, которые хранятся в службе хранилища Azure

Просмотреть журналы аудита больших двоичных объектов можно несколькими способами.

- Системная функция `sys.fn_get_audit_file` (T-SQL) возвращает данные журнала аудита в табличном формате. Дополнительные сведения об использовании этой функции см. в статье [sys.fn_get_audit_file (Transact-SQL)](https://docs.microsoft.com/sql/relational-databases/system-functions/sys-fn-get-audit-file-transact-sql).

- Вы можете изучить журналы аудита с помощью такого инструмента, как [Azure Storage Explorer.](https://azure.microsoft.com/features/storage-explorer/) В хранилище Azure журналы аудита сохраняются в виде коллекции файлов больших двоичных объектов в контейнере, который был определен для хранения журналов аудита. Дополнительные сведения об иерархии папки для хранения, соглашении об именовании и формате журнала см. в [документации по формату журнала аудита больших двоичных объектов](https://go.microsoft.com/fwlink/?linkid=829599).

- Полный список методов использования журналов аудита см. в статье о [начале работы с аудитом базы данных SQL](sql-database-auditing.md).

### <a name="consume-logs-stored-in-event-hub"></a>Использование журналов аудита, которые хранятся в концентраторе событий

Чтобы работать с данными журналов аудита из концентратора событий, необходимо настроить потоковую передачу для получения событий и их записи в целевой объект. Дополнительные сведения доступны в документации по Центрам событий Azure.

### <a name="consume-and-analyze-logs-stored-in-azure-monitor-logs"></a>Потребляйте и анализируйте журналы, хранящиеся в журналах Azure Monitor

Если журналы аудита записаны в журналы Azure Monitor, они доступны в рабочей области журнала Analytics, где можно выполнить расширенный поиск данных аудита. В качестве отправной точки перейдите в рабочее пространство Log Analytics и под *общим* `search "SQLSecurityAuditEvents"` разделом нажмите *журналы* и введите простой запрос, например: для просмотра журналов аудита.  

Журналы Azure Monitor дают вам оперативную информацию в режиме реального времени с помощью интегрированного поиска и пользовательских панелей мониторинга для легкого анализа миллионов записей во всех рабочих нагрузках и серверах. Для получения дополнительной полезной [информации](https://docs.microsoft.com/azure/azure-monitor/log-query/log-query-overview)о языке поиска и командах журналов Azure Monitor см.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

## <a name="auditing-differences-between-databases-in-azure-sql-database-and-databases-in-sql-server"></a>Различия между аудитом в базах данных Базы данных SQL Azure и SQL Server

Ниже перечислены основные различия между аудитом в базах данных в Базе данных SQL Azure и базах данных в SQL Server.

- При использовании варианта развертывания в виде управляемого экземпляра в Базе данных SQL Azure аудит выполняется на уровне сервера и сохраняет файлы журнала `.xel` в хранилище BLOB-объектов Azure.
- В SQL Server на локальном компьютере или виртуальной машине аудит выполняется на уровне сервера, но события сохраняются в журналы событий файловой системы или Windows.

Аудит XEvent в управляемом экземпляре поддерживает целевые объекты хранилища BLOB-объектов Azure. Журналы файловой системы и журналы Windows **не поддерживаются**.

Основные различия в синтаксисе `CREATE AUDIT` для аудита в хранилище BLOB-объектов Azure:

- Новый синтаксис `TO URL` позволяет указать URL-адрес контейнера в хранилище BLOB-объектов Azure, куда будут помещены файлы `.xel`.
- Предоставляется новый синтаксис `TO EXTERNAL MONITOR` для включения целей в области включения в систему Even Hub и Azure Monitor.
- Синтаксис `TO FILE`**не поддерживается**, так как База данных SQL не может использовать файловые ресурсы Windows.
- Параметр завершения работы **не поддерживается**.
- Значение 0 для `queue_delay`**не поддерживается**.

## <a name="next-steps"></a>Дальнейшие действия

- Полный список методов использования журналов аудита см. в статье о [начале работы с аудитом базы данных SQL](sql-database-auditing.md).
- Для получения дополнительной информации о программах Azure, поддерживающих соответствие стандартам, посетите [целевой центр Azure Trust Center,](https://gallery.technet.microsoft.com/Overview-of-Azure-c1be3942) где можно найти наиболее актуальный список сертификатов соответствия требованиям базы данных S'L.

<!--Image references-->









