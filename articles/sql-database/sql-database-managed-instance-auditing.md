---
title: Аудит управляемого экземпляра Базы данных SQL Azure | Документация Майкрософт
description: Узнайте, как приступить к аудиту управляемого экземпляра Базы данных SQL Azure с помощью T-SQL
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
f1_keywords:
- mi.azure.sqlaudit.general.f1
author: barmichal
ms.author: mibar
ms.reviewer: vanto
ms.date: 04/08/2019
ms.openlocfilehash: 23e3a15ac26cdf0950ee31fddad2af4a3b7414c2
ms.sourcegitcommit: d47a30e54c5c9e65255f7ef3f7194a07931c27df
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/29/2019
ms.locfileid: "73025380"
---
# <a name="get-started-with-azure-sql-database-managed-instance-auditing"></a>Начало работы с аудитом управляемого экземпляра Базы данных SQL Azure

[Аудит управляемого экземпляра](sql-database-managed-instance.md) позволяет отслеживать события базы данных и записывать их в журнал аудита в учетной записи хранения Azure. Аудит также дает следующие возможности:

- Аудит может помочь вам соблюсти требования нормативов, проанализировать работу с базой данных и получить представление о расхождениях и аномалиях, которые могут указывать на бизнес-проблемы или предполагаемые нарушения безопасности.
- Средства аудита способствуют соблюдению стандартов соответствия, но не гарантируют их выполнение. Дополнительные сведения о программах Azure, поддерживающих соответствие стандартам, см. в [центр управления безопасностью Azure](https://gallery.technet.microsoft.com/Overview-of-Azure-c1be3942) , где можно найти самый актуальный список сертификатов соответствия базы данных SQL.

## <a name="set-up-auditing-for-your-server-to-azure-storage"></a>Настройка аудита для сервера в службе хранилища Azure

В следующем разделе описывается настройка аудита для управляемого экземпляра.

1. Перейдите на [портал Azure](https://portal.azure.com).
1. Создайте **контейнер** службы хранилища Azure для хранения журналов аудита.

   1. Перейдите к хранилищу Azure, в котором вы намерены хранить журналы аудита.

      > [!IMPORTANT]
      > Используйте учетную запись хранения из того же региона, где размещен управляемый экземпляр, чтобы избежать операций чтения и записи между регионами.

   1. На странице учетной записи хранения перейдите на вкладку **Обзор** и щелкните **BLOB-объекты**.

      ![Мини-приложение больших двоичных объектов Azure](./media/sql-managed-instance-auditing/1_blobs_widget.png)

   1. В верхнем меню щелкните **+ Контейнер**, чтобы создать новый контейнер.

      ![Значок создания контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/2_create_container_button.png)

   1. Укажите **имя** контейнера, установите **закрытый** уровень общего доступа и щелкните **ОК**.

      ![Конфигурация создания контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/3_create_container_config.png)

1. После создания контейнера существует два способа настроить его в качестве целевого объекта для журналов аудита: [с помощью T-SQL](#blobtsql) или [с помощью пользовательского интерфейса SQL Server Management Studio (SSMS)](#blobssms):

   - <a id="blobtsql"></a>Настройте хранилище BLOB-объектов для журналов аудита с помощью T-SQL:

     1. В списке контейнеров щелкните только что созданный контейнер, а затем **Свойства контейнера**.

        ![Кнопка свойств контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/4_container_properties_button.png)

     1. Скопируйте URL-адрес контейнера, щелкнув значок копирования, и сохраните этот URL-адрес (например, в Блокноте) для дальнейшего использования. URL-адрес контейнера должен иметь формат `https://<StorageName>.blob.core.windows.net/<ContainerName>`.

        ![Копирование URL-адреса контейнера больших двоичных объектов](./media/sql-managed-instance-auditing/5_container_copy_name.png)

     1. Создайте **маркер SAS** службы хранилища Azure, который предоставляет права доступа к учетной записи хранения для аудита управляемого экземпляра.

        - Перейдите к учетной записи хранения Azure, в которой вы создали контейнер на предыдущем шаге.

        - Щелкните **Подписанный URL-адрес** в меню "Параметры хранилища".

          ![Значок подписанного URL-адреса в меню параметров хранилища.](./media/sql-managed-instance-auditing/6_storage_settings_menu.png)

        - Настройте SAS следующим образом.

          - **Допустимые службы**: большой двоичный объект

          - **Дата начала**: чтобы избежать проблем, связанных с часовыми поясами, выберите вчерашний день.

          - **Дата окончания**: выберите дату окончания срока действия для этого маркера SAS.

            > [!NOTE]
            > Чтобы избежать сбоев аудита, не забудьте возобновить маркер по истечении срока действия.

          - Нажмите кнопку **Создать SAS**.
            
            ![Конфигурация SAS](./media/sql-managed-instance-auditing/7_sas_configure.png)

        - Когда вы щелкнете "Создать SAS", в нижней части страницы появится маркер SAS. Скопируйте маркер, щелкнув значок копирования, и сохраните его (например, в Блокноте) для дальнейшего использования.

          ![Копирование маркера SAS](./media/sql-managed-instance-auditing/8_sas_copy.png)

          > [!IMPORTANT]
          > Удалите символ знака вопроса (?) в начале маркера.

     1. Подключитесь к управляемому экземпляру, используя SQL Server Management Studio (SSMS) или любое другое поддерживаемое средство.

     1. Выполните следующую инструкцию T-SQL, чтобы **создать новые учетные данные** с использованием URL-адреса контейнера и маркера SAS, которые вы создали на предыдущих этапах.

        ```SQL
        CREATE CREDENTIAL [<container_url>]
        WITH IDENTITY='SHARED ACCESS SIGNATURE',
        SECRET = '<SAS KEY>'
        GO
        ```

     1. Выполните следующую инструкцию T-SQL, чтобы создать новый аудит сервера (выберите любое удобное имя аудита и укажите URL-адрес контейнера, созданный ранее). Если значение `RETENTION_DAYS` не указано, по умолчанию используется значение 0 (неограниченный период удержания).

        ```SQL
        CREATE SERVER AUDIT [<your_audit_name>]
        TO URL ( PATH ='<container_url>' [, RETENTION_DAYS =  integer ])
        GO
        ```

        1. Продолжите, [создав спецификацию аудита сервера или спецификацию аудита базы данных](#createspec).

   - <a id="blobssms"></a>Настройте хранилище BLOB-объектов для журналов аудита с помощью SQL Server Management Studio (SSMS) 18 (предварительная версия):

     1. Подключитесь к управляемому экземпляру через пользовательский интерфейс SQL Server Management Studio (SSMS).

     1. Разверните корневой узел обозревателя объектов.

     1. Разверните узел **Безопасность**, щелкните правой кнопкой мыши узел **Аудиты** и щелкните "Создать аудит":

        ![Развертывание узла аудитов и безопасности](./media/sql-managed-instance-auditing/10_mi_SSMS_new_audit.png)

     1. Убедитесь, что в поле **Назначение аудита** выбрано значение "URL-адрес", и щелкните **Обзор**:

        ![Просмотр службы хранилища](./media/sql-managed-instance-auditing/11_mi_SSMS_audit_browse.png)

     1. Войдите в учетную запись Azure (необязательно):

        ![Войдите в Azure](./media/sql-managed-instance-auditing/12_mi_SSMS_sign_in_to_azure.png)

     1. Выберите подписку, учетную запись хранения и контейнер больших двоичных объектов из раскрывающихся списков или создайте собственный контейнер, щелкнув **Создать**. Когда вы зададите все необходимые параметры, нажмите кнопку **ОК**:

        ![Выберите подписку Azure, учетную запись хранения и контейнер больших двоичных объектов.](./media/sql-managed-instance-auditing/13_mi_SSMS_select_subscription_account_container.png)

     1. Нажмите кнопку **ОК** в диалоговом окне "Создать аудит".

1. <a id="createspec"></a>После настройки контейнера больших двоичных объектов как целевого объекта для журналов аудита создайте спецификацию аудита сервера или аудита базы данных, как это делается для SQL Server:

   - [Руководство по созданию спецификации T-SQL для аудита сервера](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-specification-transact-sql)
   - [Руководство по созданию спецификации T-SQL для аудита базы данных](https://docs.microsoft.com/sql/t-sql/statements/create-database-audit-specification-transact-sql)

1. Включите аудит сервера, созданный на шаге 6:

    ```SQL
    ALTER SERVER AUDIT [<your_audit_name>]
    WITH (STATE=ON);
    GO
    ```

Дополнительные сведения см. в следующих статьях:

- [Аудит различий между отдельными базами данных, эластичными пулами и управляемыми экземплярами в базе данных SQL Azure и в базах данных SQL Server](#auditing-differences-between-databases-in-azure-sql-database-and-databases-in-sql-server)
- [CREATE SERVER AUDIT (Transact-SQL)](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-transact-sql)
- [ALTER SERVER AUDIT (Transact-SQL)](https://docs.microsoft.com/sql/t-sql/statements/alter-server-audit-transact-sql)

## <a name="set-up-auditing-for-your-server-to-event-hub-or-azure-monitor-logs"></a>Настройка аудита сервера для концентратора событий или журналов Azure Monitor

Журналы аудита из управляемого экземпляра можно отправлять в даже центры или журналы Azure Monitor. В этом разделе описывается, как это настроить.

1. Откройте [портал Azure](https://portal.azure.com/) и перейдите к управляемому экземпляру.

2. Щелкните **Параметры диагностики**.

3. Щелкните **Включить диагностику**. Если диагностика уже включена, будет отображена кнопка *+Add diagnostic setting* (+ Добавить параметр диагностики).

4. Выберите **SQLSecurityAuditEvents** из списка журналов.

5. Выберите назначение для событий аудита — концентратор событий, журналы Azure Monitor или и то, и другое. Настройте необходимые параметры (например, рабочую область Log Analytics) для каждой цели.

6. В нижней части страницы нажмите кнопку **Save**.

    ![Настройка параметров диагностики](./media/sql-managed-instance-auditing/9_mi_configure_diagnostics.png)

7. Подключитесь к управляемому экземпляру, используя **SQL Server Management Studio (SSMS)** или любой другой поддерживаемый клиент.

8. Выполните следующую инструкцию T-SQL для создания аудита сервера.

    ```SQL
    CREATE SERVER AUDIT [<your_audit_name>] TO EXTERNAL_MONITOR;
    GO
    ```

9. Создайте спецификацию аудита сервера или спецификацию аудита базы данных, как для обычного сервера SQL Server.

   - [Руководство по созданию спецификации T-SQL для аудита сервера](https://docs.microsoft.com/sql/t-sql/statements/create-server-audit-specification-transact-sql)
   - [Руководство по созданию спецификации T-SQL для аудита базы данных](https://docs.microsoft.com/sql/t-sql/statements/create-database-audit-specification-transact-sql)

10. Включите аудит сервера, созданный на шаге 8.
 
    ```SQL
    ALTER SERVER AUDIT [<your_audit_name>] WITH (STATE=ON);
    GO
    ```

## <a name="consume-audit-logs"></a>Использование журналов аудита

### <a name="consume-logs-stored-in-azure-storage"></a>Использование журналов аудита, которые хранятся в службе хранилища Azure

Просмотреть журналы аудита больших двоичных объектов можно несколькими способами.

- Системная функция `sys.fn_get_audit_file` (T-SQL) возвращает данные журнала аудита в табличном формате. Дополнительные сведения об использовании этой функции см. в статье [sys.fn_get_audit_file (Transact-SQL)](https://docs.microsoft.com/sql/relational-databases/system-functions/sys-fn-get-audit-file-transact-sql).

- Журналы аудита можно просматривать с помощью таких инструментов, как [обозреватель хранилищ Azure](https://azure.microsoft.com/features/storage-explorer/). В хранилище Azure журналы аудита сохраняются в виде коллекции файлов больших двоичных объектов в контейнере, который был определен для хранения журналов аудита. Дополнительные сведения об иерархии папки для хранения, соглашении об именовании и формате журнала см. в [документации по формату журнала аудита больших двоичных объектов](https://go.microsoft.com/fwlink/?linkid=829599).

- Полный список методов использования журналов аудита см. в статье о [начале работы с аудитом базы данных SQL](sql-database-auditing.md).

### <a name="consume-logs-stored-in-event-hub"></a>Использование журналов аудита, которые хранятся в концентраторе событий

Чтобы работать с данными журналов аудита из концентратора событий, необходимо настроить потоковую передачу для получения событий и их записи в целевой объект. Дополнительные сведения доступны в документации по Центрам событий Azure.

### <a name="consume-and-analyze-logs-stored-in-azure-monitor-logs"></a>Использование и анализ журналов, хранящихся в журналах Azure Monitor

Если журналы аудита записываются в журналы Azure Monitor, они доступны в рабочей области Log Analytics, где можно выполнять расширенный поиск по данным аудита. В качестве отправной точки перейдите к рабочей области Log Analytics и в разделе *Общие* щелкните *журналы* и введите простой запрос, например: `search "SQLSecurityAuditEvents"`, чтобы просмотреть журналы аудита.  

Журналы Azure Monitor предоставляют оперативную аналитику в режиме реального времени с помощью встроенных средств поиска и настраиваемых панелей мониторинга для быстрого анализа миллионов записей во всех рабочих нагрузках и серверах. Дополнительные полезные сведения о языке и командах поиска журналов Azure Monitor см. в статье [Поиск по Azure Monitor журналов Справочник](https://docs.microsoft.com/azure/azure-monitor/log-query/log-query-overview).

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

## <a name="auditing-differences-between-databases-in-azure-sql-database-and-databases-in-sql-server"></a>Различия между аудитом в базах данных Базы данных SQL Azure и SQL Server

Ниже перечислены основные различия между аудитом в базах данных в Базе данных SQL Azure и базах данных в SQL Server.

- При использовании варианта развертывания в виде управляемого экземпляра в Базе данных SQL Azure аудит выполняется на уровне сервера и сохраняет файлы журнала `.xel` в хранилище BLOB-объектов Azure.
- В SQL Server на локальном компьютере или виртуальной машине аудит выполняется на уровне сервера, но события сохраняются в журналы событий файловой системы или Windows.

Аудит XEvent в управляемом экземпляре поддерживает целевые объекты хранилища BLOB-объектов Azure. Журналы файловой системы и журналы Windows **не поддерживаются**.

Основные различия в синтаксисе `CREATE AUDIT` для аудита в хранилище BLOB-объектов Azure:

- Новый синтаксис `TO URL` позволяет указать URL-адрес контейнера в хранилище BLOB-объектов Azure, куда будут помещены файлы `.xel`.
- `TO EXTERNAL MONITOR` предоставляется новый синтаксис, позволяющий реализовать даже целевые объекты журналов и Azure Monitor.
- Синтаксис `TO FILE` **не поддерживается**, так как База данных SQL не может использовать файловые ресурсы Windows.
- Параметр завершения работы **не поддерживается**.
- Значение 0 для `queue_delay` **не поддерживается**.

## <a name="next-steps"></a>Дальнейшие действия

- Полный список методов использования журналов аудита см. в статье о [начале работы с аудитом базы данных SQL](sql-database-auditing.md).
- Дополнительные сведения о программах Azure, поддерживающих соответствие стандартам, см. в [центр управления безопасностью Azure](https://gallery.technet.microsoft.com/Overview-of-Azure-c1be3942) , где можно найти самый актуальный список сертификатов соответствия базы данных SQL.

<!--Image references-->









