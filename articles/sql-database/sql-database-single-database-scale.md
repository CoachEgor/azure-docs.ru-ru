---
title: Масштабирование ресурсов отдельной базы данных
description: В этой статье описано масштабирование вычислительных ресурсов и ресурсов хранилища, предоставляемых отдельной базе данных в Базе данных SQL Azure.
services: sql-database
ms.service: sql-database
ms.subservice: performance
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sstein
ms.reviewer: carlrab
ms.date: 04/30/2020
ms.openlocfilehash: a13b860e01e7ef295df629d79dfa44700b5f0d02
ms.sourcegitcommit: 366e95d58d5311ca4b62e6d0b2b47549e06a0d6d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/01/2020
ms.locfileid: "82691592"
---
# <a name="scale-single-database-resources-in-azure-sql-database"></a>Масштабирование ресурсов отдельной базы данных в Базе данных SQL Azure

В этой статье описывается, как масштабировать ресурсы вычислений и хранения, доступные для базы данных SQL Azure, на подготовленном уровне вычислений. Кроме того, [уровень вычислений "бессерверный](sql-database-serverless.md) " обеспечивает автоматическое масштабирование вычислений и счета за секунду для используемых вычислений.

После первоначального выбора количества виртуальных ядер или DTU можно динамически масштабировать отдельную базу данных в зависимости от фактического взаимодействия с помощью [портал Azure](sql-database-single-databases-manage.md#manage-an-existing-sql-database-server), [Transact-SQL](https://docs.microsoft.com/sql/t-sql/statements/alter-database-transact-sql?view=azuresqldb-current#examples-1), [PowerShell](/powershell/module/az.sql/set-azsqldatabase), [Azure CLI](/cli/azure/sql/db#az-sql-db-update)или [REST API](https://docs.microsoft.com/rest/api/sql/databases/update).

В следующем видео показано динамическое изменение уровня служб и объема вычислительных ресурсов для увеличения количества доступных единиц DTU отдельной базы данных.

> [!VIDEO https://channel9.msdn.com/Blogs/Azure/Azure-SQL-Database-dynamically-scale-up-or-scale-down/player]

> [!IMPORTANT]
> Иногда требуется сжать базу данных, чтобы освободить неиспользуемое пространство. Дополнительные сведения см. [в статье Управление дисковым пространством в базе данных SQL Azure](sql-database-file-space-management.md).

## <a name="impact"></a>Влияние

Изменение уровня служб или размера вычислений в основном включает службу, выполняющую следующие действия:

1. Создание нового вычислительного экземпляра для базы данных  

    Будет создан новый вычислительный экземпляр с запрошенным уровнем служб и размером вычислений. Для некоторых сочетаний изменений уровня служб и размера вычислений реплика базы данных должна быть создана в новом вычислительном экземпляре, который включает копирование данных и может сильно повлиять на общую задержку. Независимо от этого, база данных остается в режиме «в сети» на этом шаге, а подключения по-прежнему направляются в базу данных в исходном вычислительном экземпляре.

2. Переключить маршрутизацию подключений на новый вычислительный экземпляр

    Существующие соединения с базой данных в исходном вычислительном экземпляре удаляются. Все новые соединения устанавливаются для базы данных в новом вычислительном экземпляре. Для некоторых сочетаний изменений уровня служб и размера вычислений файлы базы данных отсоединяются и повторно присоединяются во время переключения.  Независимо от этого коммутатор может привести к кратковременному прерыванию работы службы, если база данных недоступна в обычном объеме менее 30 секунд и часто занимает всего несколько секунд. Если при отсоединении подключений выполняются длительные транзакции, длительность этого шага может занять больше времени, чтобы восстановить прерванные транзакции. [Ускоренное восстановление базы данных](sql-database-accelerated-database-recovery.md) может снизить последствия прерывания длительных транзакций.

> [!IMPORTANT]
> Во время какого-либо этапа рабочего процесса данные не теряются. Убедитесь, что вы реализовали некоторую [логику повторных попыток](sql-database-connectivity-issues.md) в приложениях и компонентах, которые используют базу данных SQL Azure при изменении уровня служб.

## <a name="latency"></a>Задержка 

Расчетная задержка для изменения уровня служб, масштабирования размера вычислений отдельной базы данных или эластичного пула, перемещения базы данных в пул эластичных БД и из нее, а также для перемещения базы данных между пулами эластичных БД.

|Уровень служб|Базовая простая база данных,</br>Standard (S0-S1)|Базовый эластичный пул,</br>Standard (S2-S12), </br>Гипермасштабируемого </br>общего назначения одной базы данных или эластичного пула|Premium или критически важный для бизнеса одна база данных или эластичный пул|
|:---|:---|:---|:---|
|**Базовая простая база данных</br> , уровень "Стандартный" (S0-S1)**|&bull;&nbsp;Постоянная задержка во времени независимо от используемого пространства</br>&bull;&nbsp;Обычно менее 5 минут|&bull;&nbsp;Задержка, пропорциональная объему базы данных, используемой из-за копирования данных</br>&bull;&nbsp;Обычно используется менее 1 минуты на ГБ пространства|&bull;&nbsp;Задержка, пропорциональная объему базы данных, используемой из-за копирования данных</br>&bull;&nbsp;Обычно используется менее 1 минуты на ГБ пространства|
|**Базовый эластичный пул </br>, Стандартный (S2-S12) </br>, горизонтальное </br>масштабирование, общего назначения одна база данных или эластичный пул**|&bull;&nbsp;Задержка, пропорциональная объему базы данных, используемой из-за копирования данных</br>&bull;&nbsp;Обычно используется менее 1 минуты на ГБ пространства|&bull;&nbsp;Постоянная задержка во времени независимо от используемого пространства</br>&bull;&nbsp;Обычно менее 5 минут|&bull;&nbsp;Задержка, пропорциональная объему базы данных, используемой из-за копирования данных</br>&bull;&nbsp;Обычно используется менее 1 минуты на ГБ пространства|
|**Premium или критически важный для бизнеса одна база данных или эластичный пул**|&bull;&nbsp;Задержка, пропорциональная объему базы данных, используемой из-за копирования данных</br>&bull;&nbsp;Обычно используется менее 1 минуты на ГБ пространства|&bull;&nbsp;Задержка, пропорциональная объему базы данных, используемой из-за копирования данных</br>&bull;&nbsp;Обычно используется менее 1 минуты на ГБ пространства|&bull;&nbsp;Задержка, пропорциональная объему базы данных, используемой из-за копирования данных</br>&bull;&nbsp;Обычно используется менее 1 минуты на ГБ пространства|

> [!NOTE]
> Кроме того, для баз данных Standard (S2-S12) и общего назначения, задержка перемещения базы данных в эластичный пул или между пулами эластичных пулов будет пропорционально размеру базы данных, если база данных использует хранилище привилегированного файлового ресурса ([PFS](https://docs.microsoft.com/azure/storage/files/storage-files-introduction)).
>
> Чтобы определить, использует ли база данных PFS-хранилище, выполните следующий запрос в контексте базы данных. Если значение в столбце AccountType равно `PremiumFileStorage`, база данных использует хранилище PFS.
 
```sql
SELECT s.file_id,
       s.type_desc,
       s.name,
       FILEPROPERTYEX(s.name, 'AccountType') AS AccountType
FROM sys.database_files AS s
WHERE s.type_desc IN ('ROWS', 'LOG');
```

> [!TIP]
> Сведения о мониторинге выполняемых операций см. в статьях [Управление операциями с помощью REST API SQL](https://docs.microsoft.com/rest/api/sql/operations/list), [Управление операциями с помощью интерфейса командной строки](/cli/azure/sql/db/op), [мониторинг операций с помощью T-SQL](/sql/relational-databases/system-dynamic-management-views/sys-dm-operation-status-azure-sql-database) и следующие две команды PowerShell: [Get-азсклдатабасеактивити](/powershell/module/az.sql/get-azsqldatabaseactivity) и [останавливают-азсклдатабасеактивити](/powershell/module/az.sql/stop-azsqldatabaseactivity).

## <a name="cancelling-changes"></a>Отмена изменений

Операция изменения или масштабирования уровня службы может быть отменена.

#### <a name="azure-portal"></a>Портал Azure

В колонке обзор базы данных перейдите к разделу **уведомления** и щелкните плитку, указывающую на текущую операцию:

![Текущая операция](media/sql-database-single-database-scale/ongoing-operations.png)

Затем нажмите кнопку **отменить эту операцию**.

![Отменить текущую операцию](media/sql-database-single-database-scale/cancel-ongoing-operation.png)

#### <a name="powershell"></a>PowerShell

В командной строке PowerShell задайте `$resourceGroupName`, `$serverName`и `$databaseName`, а затем выполните следующую команду:

```azurecli
$operationName = (az sql db op list --resource-group $resourceGroupName --server $serverName --database $databaseName --query "[?state=='InProgress'].name" --out tsv)
if (-not [string]::IsNullOrEmpty($operationName)) {
    (az sql db op cancel --resource-group $resourceGroupName --server $serverName --database $databaseName --name $operationName)
        "Operation " + $operationName + " has been canceled"
}
else {
    "No service tier change or compute rescaling operation found"
}
```

## <a name="additional-considerations"></a>Дополнительные сведения

- При переходе к более высокому уровню служб или объему вычислительных ресурсов максимальный размер базы данных не увеличивается, если явно не указать для него большее значение (maxsize).
- При понижении уровня базы данных используемое ею пространство не должно превышать максимальный допустимый размер целевых уровня служб и объема вычислительных ресурсов.
- При понижении уровня служб **Премиум** до уровня **Стандартный** дополнительная плата взимается в следующих случаях: 1) максимальный размер базы данных поддерживается в целевом объеме вычислительных ресурсов; 2) максимальный размер превышает включенный объем хранилища целевого объема вычислительных ресурсов. Например, если база данных P1 с максимальным размером 500 ГБ — понижается S3, то будет применяться дополнительное хранилище, так как S3 поддерживает максимальный размер в 1 ТБ, а Включенный объем хранилища — только 250 ГБ. Поэтому дополнительный объем хранилища равен 500 – 250 = 250 ГБ. Чтобы узнать о ценах на дополнительное хранилище, ознакомьтесь с [ценами на Базу данных SQL](https://azure.microsoft.com/pricing/details/sql-database/). Если фактический объем пространства, которое используется, меньше, чем включенный объем хранилища, то этих дополнительных затрат можно избежать, уменьшив максимальный размер базы данных до включенного объема.
- Если вы повышаете уровень базы данных со включенной [георепликацией](sql-database-geo-replication-portal.md), перед повышением уровня базы данных-источника сначала обновите базы данных-получатели до требуемого уровня служб и объема вычислительных ресурсов (общая рекомендация для оптимальной производительности). При обновлении до другого выпуска требуется, чтобы база данных-получатель обновлялась первыми.
- Если вы понижаете уровень базы данных со включенной [георепликацией](sql-database-geo-replication-portal.md), перед понижением уровня базы данных-получателя сначала понизьте категорию ее базы данных-источника до требуемого уровня служб и объема вычислительных ресурсов (общая рекомендация для оптимальной производительности). При переходе на другой выпуск необходимо сначала понизить уровень базы данных-источника.
- Предложения службы восстановления отличаются для разных уровней служб. При понижении до уровня **Базовый** уменьшится период хранения резервной копии. Ознакомьтесь со статьей [Подробнее об автоматически создаваемых резервных копиях в Базе данных SQL](sql-database-automated-backups.md).
- Новые свойства базы данных не применяются до тех пор, пока изменение не завершится.

## <a name="billing"></a>Выставление счетов 

Плата взимается за каждый час существования базы данных с учетом самого высокого уровня служб и объема вычислительных ресурсов, которые использовались в течение этого часа, даже если база данных использовалась или была активна менее часа. Например, если вы создадите отдельную базу данных и через 5 минут удалите ее, вам будет выставлен счет за 1 час использования базы данных.

## <a name="change-storage-size"></a>Изменение размера хранилища

### <a name="vcore-based-purchasing-model"></a>Модель приобретения на основе виртуальных ядер

- Хранилище можно подготовить к максимальному размеру хранилища данных с шагом в 1 ГБ. Минимальное настраиваемое хранилище данных — 1 ГБ. См. раздел Документация по ограничению ресурсов для [отдельных баз данных](sql-database-vcore-resource-limits-single-databases.md) и [эластичных пулов](sql-database-vcore-resource-limits-elastic-pools.md) для ограничения максимального размера хранилища данных в каждой цели обслуживания.
- Хранилище данных для отдельной базы данных может быть подготовлено путем увеличения или уменьшения максимального размера с помощью [портал Azure](https://portal.azure.com), [Transact-SQL](https://docs.microsoft.com/sql/t-sql/statements/alter-database-transact-sql?view=azuresqldb-current#examples-1), [PowerShell](/powershell/module/az.sql/set-azsqldatabase), [Azure CLI](/cli/azure/sql/db#az-sql-db-update)или [REST API](https://docs.microsoft.com/rest/api/sql/databases/update). Если значение максимального размера указано в байтах, оно должно быть кратно 1 ГБ (1073741824 байт).
- Объем данных, которые могут храниться в файлах данных базы данных, ограничен максимальным размером хранилища данных. Помимо этого хранилища, база данных SQL автоматически выделяет 30% больше места для хранения журнала транзакций.
- База данных SQL автоматически выделяет 32 ГБ на виртуальное ядро для `tempdb` базы данных. `tempdb`находится в локальном хранилище SSD на всех уровнях служб.
- Стоимость хранилища для отдельной базы данных или эластичного пула — это сумма хранилища данных и объемов хранилища журнала транзакций, умноженная на цену единицы хранения уровня службы. Стоимость `tempdb` включается в цену. Дополнительные сведения о ценах на хранение см. в разделе [цены на базу данных SQL](https://azure.microsoft.com/pricing/details/sql-database/).

> [!IMPORTANT]
> Иногда требуется сжать базу данных, чтобы освободить неиспользуемое пространство. Дополнительные сведения см. [в статье Управление дисковым пространством в базе данных SQL Azure](sql-database-file-space-management.md).

### <a name="dtu-based-purchasing-model"></a>Модель приобретения на основе единиц DTU

- Цена DTU для отдельной базы данных включает в себя определенный объем хранилища, не требующий дополнительной платы. Дополнительный объем хранилища, сверх включенного, можно подготовить за дополнительную плату в пределах максимального допустимого размера с шагом в 250 ГБ при объеме хранилища до 1 ТБ и с шагом в 256 ГБ — при объеме более 1 ТБ. Сведения о включенном объеме хранилища и ограничениях максимального размера см. в разделе [Отдельная база данных: размеры хранилища и объемы вычислительных ресурсов](sql-database-dtu-resource-limits-single-databases.md#single-database-storage-sizes-and-compute-sizes).
- Дополнительные хранилища для одной базы данных можно подготовить, увеличив ее максимальный размер с помощью портал Azure, [Transact-SQL](https://docs.microsoft.com/sql/t-sql/statements/alter-database-transact-sql?view=azuresqldb-current#examples-1), [PowerShell](/powershell/module/az.sql/set-azsqldatabase), [Azure CLI](/cli/azure/sql/db#az-sql-db-update)или [REST API](https://docs.microsoft.com/rest/api/sql/databases/update).
- Стоимость дополнительного хранилища для отдельной базы данных равна объему хранилища, умноженному на цену единицы хранения этого хранилища для уровня служб. Сведения о цене на дополнительное хранилище см. на [странице цен на Базу данных SQL](https://azure.microsoft.com/pricing/details/sql-database/).

> [!IMPORTANT]
> Иногда требуется сжать базу данных, чтобы освободить неиспользуемое пространство. Дополнительные сведения см. [в статье Управление дисковым пространством в базе данных SQL Azure](sql-database-file-space-management.md).

### <a name="geo-replicated-database"></a>Геореплицированная база данных

Чтобы изменить размер базы данных реплицированной базы данных-получателя, измените размер базы данных-источника. Затем это изменение будет реплицировано и реализовано также в базе данных-получателе. 

## <a name="p11-and-p15-constraints-when-max-size-greater-than-1-tb"></a>Ограничения P11 и P15, если максимальный размер превышает 1 ТБ

В настоящее время на уровне "Премиум" доступно более 1 ТБ хранилища, за исключением: Восточный Китай, Северный Китай, центрального Германии, северо-восток, Западная Центральная часть США, US DoD регионов и центра правительства США. В этих регионах максимальный объем хранилища категории "Премиум" ограничен 1 ТБ. Ниже приведены рекомендации и ограничения для баз данных P11 и P15 с максимальным размером, превышающим 1 ТБ.

- Если в качестве максимального размера для базы данных P11 или p15 было задано значение больше 1 ТБ, то его можно восстановить или скопировать в базу данных P11 или P15.  Впоследствии база данных может масштабироваться до другого масштабируемого размера, при условии, что объем пространства, выделенного во время операции перемасштабирования, не превышает максимальный размер нового вычисленного размера.
- Для сценариев активной георепликации:
  - Настройка отношения георепликации. Если используется база данных-источник P11 или P15, уровень баз данных-получателей также должен быть P11 или P15. Базы данных с более низким объемом вычислительных ресурсов отклоняются, так как они не поддерживают максимальный размер больше 1 ТБ.
  - Обновление базы данных-источника в отношениях георепликации. При изменении максимального размера и указании значения больше 1 ТБ в базе данных-источнике такие же изменения произойдут в базе данных-получателе. Чтобы изменения в базе данных-источнике вступили в силу, оба обновления должны быть успешными. При этом применяются ограничения по регионам для максимального размера больше 1 ТБ. Если база данных-получатель находится в регионе, не поддерживающем максимальный размер больше 1 TB, то база данных-источник не обновляется.
- Использование службы импорта и экспорта для загрузки баз данных P11 и P15 с максимальным размером больше 1 ТБ не поддерживается. Для [импорта](sql-database-import.md) и [экспорта](sql-database-export.md) данных используйте файл SqlPackage.exe.

## <a name="next-steps"></a>Дальнейшие действия

Сведения об общих ограничениях ресурсов см. в статьях [Ограничения ресурсов для отдельной базы данных в Базе данных SQL Azure при использовании модели приобретения на основе виртуальных ядер (предварительная версия)](sql-database-vcore-resource-limits-single-databases.md) и [SQL Database DTU-based resource limits - elastic pools](sql-database-dtu-resource-limits-single-databases.md) (Ограничения ресурсов для эластичных пулов в Базе данных SQL при использовании модели приобретения на основе единиц DTU).
