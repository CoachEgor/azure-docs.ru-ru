---
title: Перенос экземпляра SQL Server в управляемый экземпляр Базы данных SQL Azure | Документация Майкрософт
description: Сведения о переносе экземпляра SQL Server в управляемый экземпляр Базы данных SQL Azure.
services: sql-database
ms.service: sql-database
ms.subservice: migration
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: bonova
ms.author: bonova
ms.reviewer: douglas, carlrab
manager: craigg
ms.date: 02/11/2019
ms.openlocfilehash: 1460b595e8887fc932d5be335ae51b07a000b9fb
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61315579"
---
# <a name="sql-server-instance-migration-to-azure-sql-database-managed-instance"></a>Перенос экземпляра SQL Server в управляемый экземпляр Базы данных SQL Azure

В этой статье вы узнаете о методах переноса экземпляра SQL Server 2005 или более поздней версии в [управляемый экземпляр Базы данных SQL Azure](sql-database-managed-instance.md). Дополнительные сведения см. в разделе о [миграции в отдельную базу данных или базу данных в пуле](sql-database-cloud-migrate.md). Сведения о миграции из других платформ см. [здесь](https://datamigration.microsoft.com/).

В общем процесс переноса базы данных выглядит примерно так:

![процесс переноса](./media/sql-database-managed-instance-migration/migration-process.png)

- [Оценка совместимости управляемого экземпляра](#assess-managed-instance-compatibility)
- [Выбор варианта подключения к приложению](sql-database-managed-instance-connect-app.md)
- [Развертывание в управляемый экземпляр оптимального размера](#deploy-to-an-optimally-sized-managed-instance)
- [Выбор метода переноса и выполнение переноса](#select-migration-method-and-migrate)
- [Мониторинг приложений](#monitor-applications)

> [!NOTE]
> Сведения о переносе отдельной базы данных в базу данных или эластичный пул см. в статье [Перенос базы данных SQL Server в базу данных SQL Azure](sql-database-single-database-migrate.md).

## <a name="assess-managed-instance-compatibility"></a>Оценка совместимости управляемого экземпляра

Сначала определите, соответствует ли управляемый экземпляр требованиям базы данных вашего приложения. Вариант развертывания управляемого экземпляра предназначен для обеспечения простого переноса методом lift-and-shift для большинства имеющихся приложений, которые используют SQL Server локально или на виртуальных машинах. Однако иногда вам могут потребоваться еще не поддерживаемые функции или возможности, а затраты на реализацию обходного пути слишком высоки.

Используйте [Data Migration Assistant (DMA)](https://docs.microsoft.com/sql/dma/dma-overview) для выявления потенциальных проблем совместимости, влияющих на функциональность базы данных в службе "База данных SQL Azure". DMA еще не поддерживает управляемый экземпляр в качестве назначения миграции, однако мы рекомендуем выполнить оценку Базы данных SQL Azure, внимательно просмотреть список обнаруженных проблем равенства функций и совместимости, сравнивая с документацией по продукту. Большинство блокирующих проблем, препятствующих переносу в Базу данных SQL Azure, были устранены с помощью управляемого экземпляра. Сведения об этом см. в статье [Сравнение возможностей службы "База данных SQL Azure" и SQL Server](sql-database-features.md). Например, в управляемых экземплярах доступны такие функции, как запросы и транзакции между базами данных в одном экземпляре, связывание сервера с другими источниками SQL, поддержка общеязыковой среды выполнения (CLR), глобальные временные таблицы, представления уровня экземпляра и Service Broker.

Если некоторые блокирующие проблемы не устранены с помощью варианта развертывания, рекомендуем рассмотреть альтернативный вариант, например [Использование SQL Server на виртуальных машинах](https://azure.microsoft.com/services/virtual-machines/sql-server/). Далее приводятся некоторые примеры.

- Если вам необходим прямой доступ к ОС или файловой системе, например, для установки сторонних или настраиваемых агентов на одной и той же виртуальной машине с SQL Server.
- Если у вас есть строгая зависимость от функций, которые все еще не поддерживаются, например FileStream или FileTable, PolyBase и транзакции между несколькими экземплярами.
- Если вам необходимо использовать только определенную версию SQL Server (например, 2012).
- Если ваши требования к вычислению намного ниже предлагаемых управляемым экземпляром (например, одно виртуальное ядро), а консолидация базы данных неприемлема.

## <a name="deploy-to-an-optimally-sized-managed-instance"></a>Развертывание в управляемый экземпляр оптимального размера

Управляемый экземпляр предназначен для локальных рабочих нагрузок, которые планируется перенести в облако. Он представляет [новую модель приобретения](sql-database-service-tiers-vcore.md), которая обеспечивает большую гибкость при выборе правильного уровня ресурсов для рабочих нагрузок. В локальной среде вы, вероятно, изменяли размер этих рабочих нагрузок с помощью физических ядер и пропускной способности ввода-вывода. Модель приобретения для управляемого экземпляра основана на виртуальных ядрах, а дополнительное хранилище и операции ввода-вывода доступны отдельно. Модель на основе виртуального ядра — это более простой способ понять требования к вычислению в облаке по сравнению с используемым в локальной среде. Эта новая модель позволяет выбирать оптимальный размер целевой среды в облаке.

Вы можете выбрать ресурсы вычисления и хранения во время развертывания, а затем изменить их без простоя для вашего приложения с помощью [портала Azure](sql-database-scale-resources.md):

![изменение размера управляемого экземпляра](./media/sql-database-managed-instance-migration/managed-instance-sizing.png)

Сведения о создании инфраструктуры виртуальной сети и управляемого экземпляра см. в статье [Краткое руководство. Создание Управляемого экземпляра Базы данных SQL Azure](sql-database-managed-instance-get-started.md).

> [!IMPORTANT]
> Важно, чтобы целевая виртуальная сеть и подсеть всегда соответствовали [требованиям к виртуальной сети управляемого экземпляра](sql-database-managed-instance-connectivity-architecture.md#network-requirements). Любая несовместимость может помешать созданию новых экземпляров или использованию созданных. Узнайте подробнее о [создании сетей](sql-database-managed-instance-create-vnet-subnet.md) и [настройке имеющихся](sql-database-managed-instance-configure-vnet-subnet.md).

## <a name="select-migration-method-and-migrate"></a>Выбор метода переноса и выполнение переноса

Вариант развертывания в виде управляемого экземпляра предназначен для пользовательских сценариев, требующих массового переноса баз данных из реализаций локальной базы данных или базы данных IaaS. Они являются оптимальным выбором, если вам нужно выполнить перенос методом lift-and-shift для серверной части приложение, которая регулярно используют уровень экземпляра и (или) межбазовые функции. В этом случае вы можете переместить весь экземпляр в соответствующую среду в Azure без необходимости изменять архитектуру приложений.

Чтобы переместить экземпляры SQL, необходимо тщательно спланировать следующее:

- Перенос всех баз данных, которые должны быть размещены совместно (те, которые выполняются в одном экземпляре).
- Перенос объектов уровня экземпляра, от которых зависит ваше приложение, включая имена для входа, учетные данные, операторы и задания агентов SQL, а также триггеры уровня сервера.

Управляемый экземпляр — это управляемая служба, позволяющая выполнять некоторые из обычных действий администратора базы данных на платформе, так как они встроены. Поэтому некоторые данные уровня экземпляра не нужно переносить (например, задания обслуживания для регулярных резервных копий или конфигурацию Always On). [Высокий уровень доступности](sql-database-high-availability.md) обеспечивается по умолчанию.

Управляемый экземпляр поддерживает следующие варианты переноса базы данных (сейчас это единственные поддерживаемые методы переноса).

- Azure Database Migration Service — миграция выполняется практически без простоев.
- Исходная `RESTORE DATABASE FROM URL` использует исходные резервные копии из SQL Server. Использование этого метода сопряжено с некоторым простоем.

### <a name="azure-database-migration-service"></a>Служба миграции баз данных Azure

[Azure Database Migration Service (DMS)](../dms/dms-overview.md) — это полностью управляемая служба, которая выполняет непрерывную миграцию из множества источников баз данных на платформы данных Azure с минимальным временем простоя. Эта служба упрощает выполнение задач, необходимых для перемещения имеющихся сторонних баз данных и баз данных SQL Server в Azure. Варианты развертывания в общедоступной предварительной версии включают базы данных SQL Azure и SQL Server на виртуальной машине Azure. DMS — это рекомендуемый метод переноса для корпоративных рабочих нагрузок.

Если вы используете службы SQL Server Integration Services (SSIS) на своем локальном экземпляре SQL Server, учтите, что DMS пока не поддерживает перенос каталога SSIS (SSISDB), в котором хранятся пакеты SSIS. Но вы можете подготовить среду Azure SSIS Integration Runtime (IR) в службе "Фабрика данных Azure" (ADF), чтобы создать SSISDB в управляемом экземпляре, а затем повторно развернуть свои пакеты там (см. статью [Создание среды выполнения интеграции Azure-SSIS в фабрике данных Azure](https://docs.microsoft.com/azure/data-factory/create-azure-ssis-integration-runtime)).

Дополнительные сведения об этом сценарии и шагах настройки для DMS см. в статье [Руководство. Перенос SQL Server в Управляемый экземпляр Базы данных SQL Azure с помощью DMS в автономном режиме](../dms/tutorial-sql-server-to-managed-instance.md).  

### <a name="native-restore-from-url"></a>Исходное восстановление из URL-адреса

Восстановление исходных резервных копий (BAK-файлов), взятых из локального SQL Server или [SQL Server на виртуальных машинах](https://azure.microsoft.com/services/virtual-machines/sql-server/), доступно в [службе хранилища Azure](https://azure.microsoft.com/services/storage/). Это одна из ключевых возможностей варианта развертывания в управляемом экземпляре. Она обеспечивает быстрое и простое перемещение базы данных в автономном режиме.

На следующей схеме представлен общий обзор процесса:

![последовательность переноса](./media/sql-database-managed-instance-migration/migration-flow.png)

В следующей таблице представлена дополнительная информация о методах, которые вы можете использовать в зависимости от используемой исходной версии SQL Server.

|Шаг|Ядро и версия SQL|Метод резервного копирования и восстановления|
|---|---|---|
|Помещение резервной копии в службу хранилища Azure|Версия до SQL 2012 SP1 CU2|Переча BAK-файла непосредственно в службу хранилища Azure|
||От 2012 SP1 CU2 до 2016|Прямое резервное копирование с использованием устаревшего синтаксиса [WITH CREDENTIAL](https://docs.microsoft.com/sql/t-sql/statements/restore-statements-transact-sql)|
||2016 и более поздние версии|Прямое резервное копирование с использованием синтаксиса [WITH SAS CREDENTIAL](https://docs.microsoft.com/sql/relational-databases/backup-restore/sql-server-backup-to-url)|
|Восстановление из службы хранилища Azure в управляемый экземпляр|[Восстановление на основе URL-адреса с помощью учетных данных SAS](sql-database-managed-instance-get-started-restore.md)|

> [!IMPORTANT]
> - При миграции базы данных, защищенной с помощью [прозрачного шифрования данных (TDE)](transparent-data-encryption-azure-sql.md), в управляемый экземпляр с использованием параметра собственного восстановления необходимо перед восстановлением базы данных перенести соответствующий сертификат из локального или IaaS SQL Server. Пошаговая процедура приведена в статье [Перенос сертификата защищенной TDE базы данных в Управляемый экземпляр Базы данных SQL Azure](sql-database-managed-instance-migrate-tde-certificate.md).
> - Восстановление системных баз данных не поддерживается. Чтобы перенести объекты уровня экземпляра (хранящиеся в базах данных master или msdb), рекомендуем создать для них скрипт и запустить скрипты T-SQL в экземпляре среды назначения.

Сведения о восстановлении резервной копии базы данных в управляемый экземпляр с использованием учетных данных SAS см. в [этой статье](sql-database-managed-instance-get-started-restore.md).

> [!VIDEO https://www.youtube.com/embed/RxWYojo_Y3Q]

## <a name="monitor-applications"></a>Мониторинг приложений

Отследите поведение и производительность приложения после переноса. Некоторые изменения в управляемом экземпляре активируются только после [изменения уровня совместимости базы данных](https://docs.microsoft.com/sql/relational-databases/databases/view-or-change-the-compatibility-level-of-a-database). При переносе базы данных в базу данных SQL Azure в большинстве случаев сохраняется первоначальный уровень совместимости. Если уровень совместимости пользовательской базы данных до переноса был равен 100 или выше, он остается неизменным после переноса. Если он был равен 90, в обновленной базе данных уровень совместимости будет равен 100. Это самый низкий уровень совместимости в управляемом экземпляре. Уровень совместимости системных баз данных равен 140.

Чтобы уменьшить риски, связанные с переносом, измените уровень совместимости базы данных только после мониторинга производительности. Используйте хранилище запросов в качестве оптимального средства для получения информации о производительности рабочей нагрузки до и после изменения уровня совместимости базы данных, как описано в разделе [Поддержание стабильной производительности во время обновления до новой версии SQL Server](https://docs.microsoft.com/sql/relational-databases/performance/query-store-usage-scenarios#CEUpgrade).

Когда вы перейдете на полностью управляемую платформу, вам будут доступны возможности, которые предоставляются автоматически как часть службы "База данных SQL". Например, вам не нужно будет создавать резервные копии в управляемом экземпляре — служба автоматически выполняет резервное копирование. Вам больше не нужно будет контролировать планирование, создание резервных копий и управление ими. Благодаря возможности [восстановления на определенный момент времени](sql-database-recovery-using-backups.md#point-in-time-restore) управляемый экземпляр позволяет восстанавливать данные на любой момент времени в пределах этого срока хранения. Кроме того, вам не нужно будет настраивать высокой уровень доступности, так как [он](sql-database-high-availability.md) встроен.

Чтобы повысить уровень безопасности, рассмотрите возможность использования следующих доступных функций:

- проверка подлинности Azure Active Directory на уровне базы данных;
- Используйте [расширенные функции безопасности](sql-database-security-overview.md) (например, [аудит](sql-database-managed-instance-auditing.md), [обнаружение угроз](sql-database-advanced-data-security.md), [безопасность на уровне строк](https://docs.microsoft.com/sql/relational-databases/security/row-level-security) и [динамическое маскирование данных](https://docs.microsoft.com/sql/relational-databases/security/dynamic-data-masking)) для защиты экземпляра.

## <a name="next-steps"></a>Дальнейшие действия

- Сведения об управляемом экземпляре см. в статье [Использование Управляемого экземпляра Базы данных SQL с виртуальными сетями и почти полной совместимостью](sql-database-managed-instance.md).
- Руководство со сведениями о восстановлении из резервной копии см. в статье [Краткое руководство. Создание Управляемого экземпляра Базы данных SQL Azure](sql-database-managed-instance-get-started.md).
- Руководство по миграции с помощью DMS см. в статье [Руководство. Перенос SQL Server в Управляемый экземпляр Базы данных SQL Azure с помощью DMS в автономном режиме](../dms/tutorial-sql-server-to-managed-instance.md).  
