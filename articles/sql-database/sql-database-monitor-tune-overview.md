---
title: Мониторинг и настройка производительности — база данных SQL Azure | Документация Майкрософт
description: Советы по настройке базы данных SQL Azure — оценка и улучшение производительности.
services: sql-database
ms.service: sql-database
ms.subservice: performance
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: jovanpop-msft
ms.author: jovanpop
ms.reviewer: jrasnick, carlrab
ms.date: 01/25/2019
ms.openlocfilehash: 83ff39e9f3b7f95256466c74011e55ebdc22a7a9
ms.sourcegitcommit: d70c74e11fa95f70077620b4613bb35d9bf78484
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2019
ms.locfileid: "70910530"
---
# <a name="monitoring-and-performance-tuning"></a>Мониторинг и настройка производительности

База данных SQL Azure предоставляет средства и методы, с помощью которых можно легко отслеживать использование, добавлять или удалять ресурсы (например, ЦП, память или операции ввода-вывода), устранять потенциальные проблемы и принимать рекомендации по повышению производительности базы данных. Функции в базе данных SQL Azure могут автоматически устранять проблемы в базах данных. 

Автоматическая настройка позволяет базе данных адаптироваться к рабочей нагрузке и автоматически оптимизировать производительность. Однако для некоторых пользовательских проблем может потребоваться устранение неполадок. В этой статье описываются некоторые рекомендации и средства, которые можно использовать для устранения проблем с производительностью.

Чтобы гарантировать, что база данных будет работать без проблем, выполните следующие действия.
- [Отслеживайте производительность базы данных](#monitor-database-performance) , чтобы убедиться, что ресурсы, назначенные базе данных, могут справиться с рабочей нагрузкой. Если база данных достигает пределов ресурсов, учитывайте следующее.
   - Определение и оптимизация основных ресурсоемких запросов.
   - Добавление дополнительных ресурсов путем [обновления уровня служб](https://docs.microsoft.com/azure/sql-database/sql-database-scale-resources).
- [Устраните проблемы с производительностью](#troubleshoot-performance-problems) , чтобы определить причину возникновения потенциальной проблемы и определить основную причину проблемы. Определив основную причину, выполните действия по устранению проблемы.

## <a name="monitor-database-performance"></a>Мониторинг производительности базы данных

Чтобы отслеживать производительность базы данных SQL в Azure, начните с мониторинга ресурсов, используемых относительно уровня выбранной производительности базы данных. Отслеживайте следующие ресурсы:
 - **Загрузка ЦП**: Проверьте, приближается ли база данных к 100 процента использования ЦП в течение продолжительного периода времени. Высокая загрузка ЦП может указывать на необходимость определения и настройки запросов, использующих наибольшую вычислительную мощность. Высокая загрузка ЦП также может указывать на то, что база данных или экземпляр должны быть обновлены до уровня служб выше. 
 - **Статистика ожидания**: Чтобы определить время ожидания запросов, используйте представление [sys. DM _os_wait_stats (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-wait-stats-transact-sql) . Запросы могут ожидать ресурсы, ожидания очереди или внешние ожидания. 
 - **Использование операций ввода-вывода**: Проверьте, достигла ли база данных ограничений ввода-вывода в базовом хранилище.
 - **Использование памяти**: Объем памяти, доступный для базы данных или экземпляра, пропорционален количеству виртуальных ядер. Убедитесь, что объем памяти достаточно велик для рабочей нагрузки. Ожидаемый срок жизни страницы — это один из параметров, которые могут указывать, насколько быстро страницы удаляются из памяти.

Служба базы данных SQL Azure содержит средства и ресурсы, помогающие устранить и устранить потенциальные проблемы с производительностью. Вы можете выявление возможных сделок по улучшению и оптимизации производительности запросов без изменения ресурсов, проверив [рекомендации по настройке производительности](sql-database-advisor.md). 

Отсутствующие индексы и плохо оптимизированные запросы — распространенные причины низкой производительности баз данных. Вы можете применить рекомендации по настройке для повышения производительности рабочей нагрузки. Вы также можете разрешить базе данных SQL Azure [автоматически оптимизировать производительность запросов](sql-database-automatic-tuning.md) , применив все определенные рекомендации. Затем убедитесь, что рекомендации улучшили производительность базы данных.

> [!NOTE]
> Индексирование доступно только в одиночной базе данных и пулах эластичных БД. Индексирование недоступно в управляемом экземпляре.

Для мониторинга и устранения неполадок производительности базы данных выберите один из следующих параметров.

- В [портал Azure](https://portal.azure.com)выберите базы **данных SQL** и выберите базу данных. На диаграмме **мониторинга** Найдите ресурсы, которые приближается к максимальному использованию. По умолчанию отображается процент использования DTU. Выберите **изменить** , чтобы изменить отображаемый диапазон времени и значения.
- Такие средства, как SQL Server Management Studio, предоставляют много полезных отчетов, таких как [панель мониторинга производительности](https://docs.microsoft.com/sql/relational-databases/performance/performance-dashboard). Используйте эти отчеты для мониторинга использования ресурсов и обнаружения наиболее ресурсоемких запросов, использующих ресурсы. [Хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store#Regressed) можно использовать для поиска запросов, производительность которых снизилась.
- В [портал Azure](https://portal.azure.com)используйте [Анализ производительности запросов](sql-database-query-performance.md) для поиска запросов, использующих наибольшие ресурсы. Эта функция доступна только в одиночной базе данных и пулах эластичных БД.
- Используйте [SQL помощник по базам данных](sql-database-advisor-portal.md) для просмотра рекомендаций, помогающих создавать и удалять индексы, параметризовать запросы и устранять проблемы схемы. Эта функция доступна только в одиночной базе данных и пулах эластичных БД.
- Используйте [Intelligent Insights Azure SQL](sql-database-intelligent-insights.md) для автоматического наблюдения за производительностью базы данных. При обнаружении проблемы с производительностью создается журнал диагностики. В журнале содержатся подробные сведения и анализ основных причин проблемы. При возможности предоставляется рекомендация по улучшению производительности.
- [Включите автоматическую настройку](sql-database-automatic-tuning-enable.md) , чтобы база данных SQL Azure автоматически исправляет проблемы с производительностью.
- Используйте [динамические административные представления (DMV)](sql-database-monitoring-with-dmvs.md), [Расширенные события](sql-database-xevent-db-diff-from-svr.md)и [хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store) для получения справки с более подробными сведениями об устранении проблем с производительностью.

> [!TIP]
> После определения проблемы с производительностью ознакомьтесь с нашим [руководством по производительности](sql-database-performance-guidance.md) , чтобы найти методы повышения производительности базы данных SQL Azure.

## <a name="troubleshoot-performance-problems"></a>Устранение проблем с производительностью

Чтобы диагностировать и устранить проблемы с производительностью, начните с определения состояния каждого активного запроса и условий, которые приводят к проблемам с производительностью, относящимся к каждому состоянию рабочей нагрузки. Чтобы повысить производительность базы данных SQL Azure, необходимо понимать, что каждый активный запрос из приложения находится в состоянии выполнения или состоянии ожидания. При устранении проблем с производительностью в базе данных SQL Azure следует помнить о следующей схеме.

![Состояния рабочей нагрузки](./media/sql-database-monitor-tune-overview/workload-states.png)

Проблема производительности в рабочей нагрузке может быть вызвана состязанием за ресурсы ЦП (состоянием, *связанным с выполнением* ) или отдельными запросами, ожидающими чего-либо (состояние *ожидания* ).

Проблемы, связанные с выполнением, могут быть вызваны следующими причинами.
- **Проблемы с компиляцией**: Оптимизатор SQL-запросов может создать неоптимальный план из-за устаревшей статистики, неверной оценки количества строк для обработки или неточной оценки требуемой памяти. Если вы знаете, что запрос был выполнен быстрее в прошлом или на другом экземпляре (управляемый экземпляр или экземпляр SQL Server), Сравните фактические планы выполнения, чтобы определить, различаются ли они. Попробуйте применить указания запросов или перестроить статистику или индексы, чтобы получить более подходящий план. Включите автоматическое исправление плана в базе данных SQL Azure, чтобы автоматически устранить эти проблемы.
- **Проблемы с выполнением**: Если план запроса является оптимальным, вероятно, это достигается за пределы ресурсов базы данных, например с пропускной способностью записи в журнал. Или можно использовать фрагментированные индексы, которые необходимо перестраивать. Проблемы с выполнением также могут возникнуть, когда для большого количества параллельных запросов требуются одни и те же ресурсы. Проблемы, *связанные с ожиданием* , обычно связаны с проблемами выполнения, так как запросы, которые не выполняются эффективно, вероятно, ожидают некоторых ресурсов.

Проблемы, связанные с ожиданием, могут быть вызваны следующими причинами.
- **Блокировка**: Один запрос может сохранить блокировку объектов в базе данных, тогда как другие пытаются получить доступ к тем же объектам. Можно выявление блокирующих запросов с помощью динамических административных представлений или средств мониторинга.
- **Проблемы ввода-вывода**: Запросы могут ожидать записи страниц в файлы данных или журналов. В этом случае проверьте `INSTANCE_LOG_RATE_GOVERNOR`статистику ожидания в динамическом административном элементе, `WRITE_LOG`или `PAGEIOLATCH_*` .
- **Проблемы tempdb**: Если Рабочая нагрузка использует временные таблицы или в планах есть сбросы базы данных TempDB, то в запросах может возникнуть проблема с пропускной способностью TempDB. 
- **Проблемы, связанные с памятью**: Если в рабочей нагрузке недостаточно памяти, может быть выведено ожидаемое время существования страницы, иначе запросы могут оказаться меньше памяти, чем требуется. В некоторых случаях встроенная аналитика в оптимизаторе запросов устраняет проблемы, связанные с памятью.
 
В следующих разделах объясняется, как определить и устранить проблемы некоторых типов.

## <a name="performance-problems-related-to-running"></a>Проблемы с производительностью, связанные с выполнением

Как правило, если загрузка ЦП постоянно не превышает 80%, то проблема с производительностью работает. Проблема, связанная с выполнением, может быть вызвана недостатком ресурсов ЦП. Или может быть связано с одним из следующих условий:

- слишком много выполняемых запросов;
- слишком много компилируемых запросов;
- Один или несколько выполнения запросов, использующих неоптимальный план запроса

Если обнаружена проблема производительности, связанная с производительностью, ваша цель состоит в определении точной проблемы с помощью одного или нескольких методов. Эти методы являются наиболее распространенными способами для выявления проблем, связанных с выполнением:

- Используйте [портал Azure](sql-database-manage-after-migration.md#monitor-databases-using-the-azure-portal) , чтобы отслеживать процент использования ЦП.
- Используйте следующие динамические [административные представления](sql-database-monitoring-with-dmvs.md):

  - Динамическое административное представление [sys. DM _db_resource_stats](sql-database-monitoring-with-dmvs.md#monitor-resource-use) возвращает сведения о ЦП, вводе-выводе и использовании памяти для базы данных SQL. Одна строка существует каждые 15 секунд, даже если в базе данных нет действий. Исторические данные хранятся в течение одного часа.
  - DMV [sys. resource_stats](sql-database-monitoring-with-dmvs.md#monitor-resource-use) возвращает сведения об использовании ЦП и данных хранилища для базы данных SQL Azure. Данные собираются и суммируются через пять минут.

> [!IMPORTANT]
> Сведения об устранении проблем с использованием ЦП для запросов T-SQL, использующих динамические административные представления sys. DM _db_resource_stats и sys. resource_stats, см. в разделе [выявление проблем с производительностью ЦП](sql-database-monitoring-with-dmvs.md#identify-cpu-performance-issues).

### <a name="ParamSniffing"></a>Запросы с проблемами PSP

Проблема с конфиденциальным планом (PSP) возникает, когда оптимизатор запросов формирует план выполнения запроса, оптимальный только для определенного значения параметра (или набора значений), а кэшированный план не оптимальен для значений параметров, используемых последовательно выполнений. Неоптимальные планы могут привести к проблемам с производительностью запросов и снизить общую пропускную способность рабочей нагрузки. 

Дополнительные сведения о перехвате параметров и обработке запросов см. в разделе [руководств по архитектуре обработки запросов](/sql/relational-databases/query-processing-architecture-guide#ParamSniffing).

Несколько обходных путей могут устранить проблемы PSP. Каждое решение имеет связанные компромиссы и недостатки.

- Использование указания запроса [RECOMPILE](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) при каждом выполнении запроса. Этот метод позволяет заменить время компиляции и увеличение загрузки ЦП на улучшение качества плана. `RECOMPILE` Параметр часто невозможен для рабочих нагрузок, требующих высокой пропускной способности.
- Используйте указание запроса [Option (оптимизировать для...)](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) , чтобы переопределить фактическое значение параметра, используя стандартное значение параметра, которое создает план, который достаточно подходит для большинства возможностей для значений параметров. Для этого варианта требуется хорошее понимание оптимальных значений параметров и связанных с ними характеристик плана.
- Используйте указание запроса [Option (оптимизация для НЕизвестного)](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) , чтобы переопределить фактическое значение параметра, а вместо этого используйте средний вектор плотности. Это также можно сделать, записывая значения входящих параметров в локальных переменных, а затем используя локальные переменные в предикатах вместо самих параметров. Для этого исправления средняя плотность должна быть *достаточно высокой*.
- Полностью отключите сканирование параметров, используя указание запроса [DISABLE_PARAMETER_SNIFFING](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) .
- Используйте указание запроса [кипфикседплан](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) для предотвращения перекомпиляций в кэше. В этом временном решении предполагается, что в кэше уже есть наиболее подходящий общий план. Можно также отключить автоматическое обновление статистики, чтобы снизить вероятность того, что хороший план будет удален, и будет скомпилирован новый недопустимый план.
- Принудительно применяйте план, явно используя указание запроса [USE PLAN](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) , переписав запрос и добавив указание в текст запроса. Или задайте конкретный план с помощью хранилища запросов или включите [автоматическую настройку](sql-database-automatic-tuning.md).
- Замена одной процедуры вложенным набором процедур, каждая из которых может использоваться на основе условной логики и связанных значений параметров.
- Создание альтернатив выполнения динамической строки для статического определения процедуры.

Дополнительные сведения об устранении проблем PSP см. в следующих записях блога:

- [Я запахю параметр](https://blogs.msdn.microsoft.com/queryoptteam/2006/03/31/i-smell-a-parameter/)
- [Сравнение Конор с динамическим SQL и процедурами и качества плана для параметризованных запросов](https://blogs.msdn.microsoft.com/conor_cunningham_msft/2009/06/03/conor-vs-dynamic-sql-vs-procedures-vs-plan-quality-for-parameterized-queries/)
- [Методы оптимизации запросов SQL в SQL Server: Перехват параметров](https://www.sqlshack.com/query-optimization-techniques-in-sql-server-parameter-sniffing/)

### <a name="compile-activity-caused-by-improper-parameterization"></a>Действие компиляции вызвано неправильной параметризации

Если запрос содержит литералы, то либо ядро СУБД автоматически параметризовать инструкцию, либо пользователь явным образом выдает инструкцию, чтобы сократить число компиляций. Большое количество компиляций для запроса, использующее один и тот же шаблон, но разные литеральные значения, могут привести к высокой загрузке ЦП. Аналогичным образом, если только частично параметризовать запрос, который по-своему не содержит литералов, ядро СУБД не будет выполнять дальнейшую параметризацию запроса.  

Ниже приведен пример частично параметризованного запроса:

```sql
SELECT * 
FROM t1 JOIN t2 ON t1.c1 = t2.c1
WHERE t1.c1 = @p1 AND t2.c2 = '961C3970-0E54-4E8E-82B6-5545BE897F8F'
```

В этом примере `t1.c1` принимает `@p1`, но не `t2.c2` принимает идентификатор GUID в качестве литерала. В этом случае, если изменить значение для `c2`, запрос рассматривается как другой запрос, и произойдет новая компиляция. Чтобы сократить число компиляций в этом примере, можно также параметризовать идентификатор GUID.

Следующий запрос показывает число запросов по хэшу запроса, чтобы определить, правильно ли параметризован запрос:

```sql
SELECT  TOP 10  
  q.query_hash
  , count (distinct p.query_id ) AS number_of_distinct_query_ids
  , min(qt.query_sql_text) AS sampled_query_text
FROM sys.query_store_query_text AS qt
  JOIN sys.query_store_query AS q
     ON qt.query_text_id = q.query_text_id
  JOIN sys.query_store_plan AS p 
     ON q.query_id = p.query_id
  JOIN sys.query_store_runtime_stats AS rs 
     ON rs.plan_id = p.plan_id
  JOIN sys.query_store_runtime_stats_interval AS rsi
     ON rsi.runtime_stats_interval_id = rs.runtime_stats_interval_id
WHERE
  rsi.start_time >= DATEADD(hour, -2, GETUTCDATE())
  AND query_parameterization_type_desc IN ('User', 'None')
GROUP BY q.query_hash
ORDER BY count (distinct p.query_id) DESC
```

### <a name="factors-that-affect-query-plan-changes"></a>Факторы, влияющие на изменения плана запроса

Повторная компиляция плана выполнения запроса может привести к созданию плана запроса, который отличается от первоначального кэшированного плана. Существующий исходный план может автоматически перекомпилироваться по различным причинам:
- На изменения в схеме ссылается запрос.
- Запрос ссылается на изменения данных в таблицах. 
- Параметры контекста запроса были изменены.

Скомпилированный план может быть извлечен из кэша по различным причинам, например:

- Перезагрузка экземпляра.
- Изменения конфигурации уровня базы данных.
- Нехватка памяти.
- Явные запросы на очистку кэша.

Если вы используете Указание RECOMPILE, план не будет кэшироваться.

Повторная компиляция (или новая компиляция после вытеснения кэша) по-прежнему может привести к созданию плана выполнения запроса, идентичного исходному. При изменении плана с прошлого или исходного плана, скорее всего, эти объяснения:

- **Измененная физическая структура**: Например, только что созданные индексы более эффективно охватывают требования запроса. Новые индексы могут использоваться для новой компиляции, если оптимизатор запросов решает, что использование нового индекса является более оптимальным, чем использование структуры данных, которая была изначально выбрана для первой версии выполнения запроса.  Любые физические изменения объектов, на которые имеются ссылки, могут привести к выбору нового плана во время компиляции.

- **Различия в ресурсах сервера**: Если план в одной системе отличается от плана в другой системе, доступность ресурсов, например количество доступных процессоров, может повлиять на создаваемый план.  Например, если в одной системе больше процессоров, можно выбрать параллельный план. 

- **Различные статистические данные**: Статистика, связанная с упоминаемыми объектами, могла быть изменена или может отличаться от статистики исходной системы.  Если изменение статистики и повторная компиляция происходят, оптимизатор запросов использует статистические данные, начиная с изменения. Пересмотренные статистические данные и частоты распределения данных могут отличаться от измененных в исходной компиляции.  Эти изменения используются для создания оценки количества элементов. (*Оценка количества элементов* — это количество строк, которые должны проходить через дерево логических запросов.) Изменения в оценке количества элементов могут привести к выбору различных физических операторов и связанных с ними заказов операций.  Даже небольшие изменения статистики могут привести к изменению плана выполнения запроса.

- **Измененный уровень совместимости базы данных или версия средства оценки количества элементов**:  Изменения уровня совместимости базы данных могут включать новые стратегии и функции, которые могут привести к другому плану выполнения запроса.  Помимо уровня совместимости базы данных, отключенный или включенный флаг трассировки 4199 или измененное состояние QUERY_OPTIMIZER_HOTFIXES конфигурации уровня базы данных также может влиять на выбор плана выполнения запроса во время компиляции.  Флаги трассировки 9481 (принудительно использовать устаревшие версии CE) и 2312 (принудительно по умолчанию CE) также влияют на план. 

### <a name="resolve-problem-queries-or-provide-more-resources"></a>Устранение проблемных запросов или предоставление дополнительных ресурсов

Определив проблему, можно либо настроить проблемные запросы, либо обновить размер вычислительных ресурсов или уровень служб, чтобы увеличить емкость базы данных SQL, чтобы уменьшить требования к ЦП. 

Дополнительные сведения см. в статье [масштабирование отдельных ресурсов базы данных в базе данных SQL Azure](sql-database-single-database-scale.md) и [масштабирование ресурсов эластичного пула в базе данных SQL Azure](sql-database-elastic-pool-scale.md). Сведения о масштабировании управляемого экземпляра см. в разделе [ограничения ресурсов на уровне экземпляра](sql-database-managed-instance-resource-limits.md#instance-level-resource-limits).

### <a name="performance-problems-caused-by-increased-workload-volume"></a>Проблемы с производительностью, вызванные увеличением объема рабочей нагрузки

Увеличение объема трафика приложения и рабочей нагрузки может привести к повышению загрузки ЦП. Но следует быть внимательным, чтобы правильно диагностировать эту проблему. При возникновении проблем с высокой производительностью ЦП ответьте на эти вопросы, чтобы определить, вызваны ли изменения в томе рабочей нагрузки.

- Являются ли запросы из приложения причиной проблемы с высокой производительностью ЦП?
- Для запросов с наибольшим потреблением ресурсов ЦП, которые можно выявление:

   - Связаны ли несколько планов выполнения с одним и тем же запросом? Если да, зачем?
   - Для запросов с одним и тем же планом выполнения были выполнены единообразные времена выполнения? Увеличится ли количество выполнений? В таком случае увеличение рабочей нагрузки, скорее всего, приведет к проблемам с производительностью.

Если план выполнения запроса не выполнялся по-разному, но загрузка ЦП увеличилась вместе со счетчиком выполнения, то проблема с производительностью скорее всего связана с увеличением рабочей нагрузки.

Не всегда легко выявление изменения тома рабочей нагрузки, которое приводит к возникновению проблемы с ЦП. Учитывайте следующие факторы: 

- **Измененное использование ресурсов**: Например, рассмотрим ситуацию, когда загрузка ЦП увеличилась до 80% в течение продолжительного периода времени.  Только загрузка ЦП не означает, что том рабочей нагрузки изменился. Регрессия в плане выполнения запроса и изменения в распределении данных могут также повысить уровень использования ресурсов, даже если приложение выполняет ту же рабочую нагрузку.

- **Внешний вид нового запроса**: Приложение может управлять новым набором запросов в разное время.

- **Увеличение или уменьшение количества запросов**: Этот сценарий является наиболее очевидным показателем рабочей нагрузки. Количество запросов не всегда соответствует дополнительному использованию ресурсов. Однако эта метрика по-прежнему является важным сигналом, при условии, что другие факторы не меняются.

## <a name="waiting-related-performance-problems"></a>Проблемы с производительностью в ожидании 

Если вы уверены, что проблема с производительностью не связана с высокой загрузкой ЦП или запуском, проблема связана с ожиданием. А значит, ресурсы ЦП не используются эффективно, так как ЦП ожидает какой-либо другой ресурс. В этом случае укажите, какие ресурсы ЦП ожидают. 

Эти методы обычно используются для отображения основных категорий типов ожидания:

- Используйте [хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store) , чтобы найти статистику ожидания для каждого запроса с течением времени. В хранилище запросов типы времени ожидания объединены в категории ожидания. Сопоставление категорий ожидания с типами ожидания можно найти в [sys. query_store_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-query-store-wait-stats-transact-sql#wait-categories-mapping-table).
- Используйте представление [sys. DM _db_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-wait-stats-azure-sql-database) , чтобы получить сведения обо всех ожиданиях, обнаруженных потоками, которые выполнялись во время операции. Это агрегированное представление можно использовать для диагностики проблем с производительностью базы данных SQL Azure, а также с конкретными запросами и пакетами.
- Используйте представление [sys. DM _os_waiting_tasks](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-os-waiting-tasks-transact-sql) , чтобы получить сведения о очереди задач, ожидающих некоторого ресурса.

В сценариях с высоким уровнем загрузки ЦП хранилище запросов и статистика ожидания могут не отражать загрузку ЦП, если:

- Запросы с высоким потреблением ЦП все еще выполняются.
- Запросы высокой загрузки ЦП выполнялись при отработке отказа.

Динамические административные представления, которые следят за хранилищем запросов и статистикой ожидания, показывают результаты только для успешно завершенных и истечения времени ожидания запросов. Они не отображают данные для выполняемых в данный момент инструкций до завершения операторов. Используйте динамическое административное представление [sys. DM _exec_requests](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql) для трассировки выполняющихся в данный момент запросов и связанного времени рабочего процесса.

На диаграмме рядом с началом этой статьи показано, что наиболее распространенные ожидания:

- блокировки;
- ВВОД-ВЫВОД
- Состязание, связанное с базой данных TempDB
- ожидание временно предоставляемого буфера памяти.

> [!IMPORTANT]
> Набор запросов T-SQL, использующих динамические административные представления для устранения неполадок, связанных с ожиданием, см. в следующих статьях:
>
> - [Поиск проблем производительности операций ввода-вывода](sql-database-monitoring-with-dmvs.md#identify-io-performance-issues)
> - [Определение ожидания временно предоставляемого буфера памяти](sql-database-monitoring-with-dmvs.md#identify-memory-grant-wait-performance-issues)
> - [Тижертулбокс ожидания и кратковременные блокировки](https://github.com/Microsoft/tigertoolbox/tree/master/Waits-and-Latches)
> - [Тижертулбокс usp_whatsup](https://github.com/Microsoft/tigertoolbox/tree/master/usp_WhatsUp)

## <a name="improve-database-performance-with-more-resources"></a>Повышение производительности базы данных с помощью дополнительных ресурсов

Если ни один из элементов не может повысить производительность базы данных, можно изменить объем ресурсов, доступных в базе данных SQL Azure. Назначьте дополнительные ресурсы, изменив [уровень служб DTU](sql-database-service-tiers-dtu.md) отдельной базы данных. Или увеличьте Edtu эластичного пула в любое время. Кроме того, если вы используете [модель приобретения на основе виртуальное ядро](sql-database-service-tiers-vcore.md), измените уровень служб или увеличьте ресурсы, выделенные для базы данных.

Для повышения производительности баз данных в отдельных базах данных можно [изменить уровни служб или ресурсы вычислений](sql-database-single-database-scale.md) по запросу. Если баз данных несколько, можно включить автомасштабирование ресурсов, используя [пулы эластичных баз данных](sql-database-elastic-pool-guidance.md).

## <a name="tune-and-refactor-application-or-database-code"></a>Настройка и рефакторинг кода приложения или базы данных

Вы можете оптимизировать код приложения для базы данных, изменить индексы, принудительно применить планы или использовать указания, чтобы вручную адаптировать базу данных к рабочей нагрузке. Сведения о ручной настройке и перезаписи кода см. в разделе [рекомендации по настройке производительности](sql-database-performance-guidance.md).

## <a name="next-steps"></a>Следующие шаги

- Чтобы включить автоматическую настройку в базе данных SQL Azure и разрешить функции автоматической настройки полностью управлять рабочей нагрузкой, см. раздел [Включение автоматической настройки](sql-database-automatic-tuning-enable.md).
- Чтобы использовать ручную настройку, ознакомьтесь с [рекомендациями по настройке в портал Azure](sql-database-advisor-portal.md). Вручную примените рекомендации, повышающие производительность запросов.
- Измените ресурсы, доступные в базе данных, изменив [уровни служб базы данных SQL Azure](sql-database-performance-guidance.md).
