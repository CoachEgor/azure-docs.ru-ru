---
title: Мониторинг и настройка производительности базы данных SQL Azure | Документация Майкрософт
description: Советы по настройке базы данных SQL Azure — оценка и улучшение производительности.
services: sql-database
ms.service: sql-database
ms.subservice: performance
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: danimir
ms.author: danil
ms.reviewer: jrasnik, carlrab
manager: craigg
ms.date: 01/25/2019
ms.openlocfilehash: 2a7a6ed5bd28bcc83500da6e82b6c4ff48b2989c
ms.sourcegitcommit: 61c8de2e95011c094af18fdf679d5efe5069197b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62097782"
---
# <a name="monitoring-and-performance-tuning"></a>Мониторинг и настройка производительности

База данных SQL Azure — это автоматически управляемая гибкая служба данных, позволяющая легко отслеживать использование, добавлять и удалять ресурсы (ЦП, памяти, ввода-вывода), находить рекомендации, которые могут повысить производительность базы данных, а также позволить базе данных адаптироваться к рабочей нагрузке и автоматически оптимизировать производительность.

## <a name="monitoring-database-performance"></a>Мониторинг производительности базы данных

Мониторинг производительности базы данных SQL в Azure начинается с мониторинга использования ресурсов в соответствии с выбранным уровнем производительности базы данных. База данных SQL Azure позволяет выявить возможности для повышения и оптимизации производительности запросов без изменения ресурсов. Для этого достаточно изучить [рекомендации по настройке производительности](sql-database-advisor.md). Отсутствующие индексы и плохо оптимизированные запросы — распространенные причины низкой производительности баз данных. Можно применить эти рекомендации по настройке, чтобы повысить производительность рабочей нагрузки. Можно также позволить Базе данных Azure SQL [автоматически оптимизировать производительность запросов](sql-database-automatic-tuning.md). В этом случае она будет применять все созданные рекомендации и проверять, действительно ли они повышают производительность базы данных.

Доступны следующие возможности мониторинга и устранения неполадок производительности базы данных.

- На [портале Azure](https://portal.azure.com) щелкните **Базы данных SQL**, выберите базу данных и найдите ресурсы, приближающиеся к максимальной отметке, на диаграмме мониторинга. По умолчанию отображается процент использования DTU. Щелкните **Изменить** , чтобы изменить диапазон времени и отображаемые значения.
- На странице [Анализ производительности запросов](sql-database-query-performance.md) можно определить, какие запросы потребляют большую часть ресурсов.
- Используйте [Помощник по базам данных SQL](sql-database-advisor-portal.md), чтобы просматривать рекомендации по созданию и удалению индексов, параметризации запросов и устранению ошибок схемы.
- Используйте [Azure SQL Intelligent Insights](sql-database-intelligent-insights.md) для автоматического мониторинга производительности базы данных. После обнаружения проблемы с производительностью создается журнал диагностики, в который записываются сведения о проблеме и результат анализа ее первопричин (RCA). При возможности также приводятся рекомендации по повышению производительности.
- [Включите автоматическую настройку](sql-database-automatic-tuning-enable.md) и позвольте Базе данных SQL Azure автоматически исправлять выявленные проблемы производительности.
- Используйте [динамические административные представления (DMV)](sql-database-monitoring-with-dmvs.md), [расширенные события](sql-database-xevent-db-diff-from-svr.md) и [хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store) для получения более подробных сведений об устранении проблем с производительностью.

> [!TIP]
> В [этом руководстве по производительности](sql-database-performance-guidance.md) описаны методы, которые можно использовать, чтобы повысить производительность базы данных SQL Azure, если вы обнаружили какие-либо проблемы с помощью этих методов.

## <a name="monitor-databases-using-the-azure-portal"></a>Мониторинг баз данных с помощью портала Azure

В [портала Azure](https://portal.azure.com/), можно отслеживать использование отдельной базы данных s, выбрав нужную базу данных и нажав кнопку **мониторинг** диаграммы. Появится окно **Метрика**, которое можно изменить, нажав кнопку **Изменить диаграмму**. Добавьте следующие метрики:

- Процент ЦП
- Процент DTU
- Процент операций ввода-вывода данных
- Размер базы данных в процентах

После добавления этих метрик можно продолжить наблюдение за ними на диаграмме **Мониторинг** с более подробными сведениями в окне **Метрика**. Все четыре метрики показывают средний процент использования в соответствии с количеством единиц **DTU** для вашей базы данных. Узнайте больше об уровнях служб, ознакомившись с [моделью приобретения на основе DTU](sql-database-service-tiers-dtu.md) и [моделью приобретения на основе виртуальных ядер](sql-database-service-tiers-vcore.md).  

![Мониторинг производительности базы данных для разных уровней служб.](./media/sql-database-single-database-monitoring/sqldb_service_tier_monitoring.png)

Также можно настроить оповещения для метрик производительности. В окне **Метрика** нажмите кнопку **Добавить оповещение**. Следуйте инструкциям мастера для настройки оповещения. Можно настроить предупреждение, информирующее либо о превышении показателями определенного порога, либо о падении показателей ниже определенного порога.

Например, если предполагается, что рабочая нагрузка базы данных будет расти, можно настроить отправку оповещения по электронной почте каждый раз, когда любой из показателей производительности для вашей базы данных достигнет 80%. Это оповещение можно использовать как предварительное предупреждение о том, что необходимо перейти на следующий максимальный объем вычислительных ресурсов.

Метрики производительности также помогут определить, можете ли вы перейти на более низкий объем вычислительных ресурсов. Предположим, вы используете базу данных размера S2 уровня Стандартный, и все метрики производительности показывают, что база данных никогда не используется более чем на 10%. Вполне вероятно, что эта база данных будет хорошо работать с размером S1 уровня Стандартный. Однако перед переходом на более низкий уровень производительности следует учитывать скачки и колебания объема вычислительных ресурсов.

## <a name="troubleshoot-performance-issues"></a>Устранение проблем с производительностью

Для диагностики и устранения проблем с производительностью начните с изучения состояния каждого активного запроса и условий, вызывающих проблемы производительности для каждого состояния рабочей нагрузки. Чтобы повысить производительность базы данных SQL Azure, необходимо понимать, что каждый активный запрос из приложения находится в состоянии выполнения или ожидания. Читая статью о выявлении и устранении проблем с производительностью в базе данных SQL Azure, примите во внимание приведенную ниже диаграмму:

![Состояния рабочей нагрузки](./media/sql-database-monitor-tune-overview/workload-states.png)

Для рабочей нагрузки проблема с производительностью может быть вызвана состязанием ЦП (условие, **связанное с выполнением**) или тем, что отдельные запросы находятся в состоянии ожидания (условие, **связанное с ожиданием**).

## <a name="running-related-performance-issues"></a>Проблемы с производительностью, связанные с выполнением

Как правило, проблемы с производительностью возникают, если загрузка ЦП постоянно превышает 80 %. Если у вас есть проблемы, связанные с выполнением, они могут быть вызваны нехваткой ресурсов ЦП или одним из следующих условий:

- слишком много выполняемых запросов;
- слишком много компилируемых запросов;
- один или несколько выполняемых запросов использует неоптимальный план запроса.

Если вы определили наличие проблемы, связанной с выполнением, нужно определить конкретную проблему с помощью одного или нескольких методов. Ниже приведены наиболее распространенные методы для выявления таких проблем:

- Используйте [портал Azure](#monitor-databases-using-the-azure-portal), чтобы отследить процент загрузки ЦП.
- Используйте следующие [динамические административные представления](sql-database-monitoring-with-dmvs.md):

  - [sys.dm_db_resource_stats](sql-database-monitoring-with-dmvs.md#monitor-resource-use) возвращает сведения об использовании ЦП, операциях ввода-вывода и потреблении памяти для базы данных в службе "База данных SQL Azure". Новая строка создается каждые 15 секунд, даже если в базе данных не выполняется никаких действий. Исторические данные хранятся в течение одного часа.
  - [sys.resource_stats](sql-database-monitoring-with-dmvs.md#monitor-resource-use) возвращает сведения об использовании ЦП и хранилища для Базы данных SQL Azure. Данные собираются и объединяются за пятиминутные интервалы.

> [!IMPORTANT]
> Сведения о наборе запросов T-SQL, где эти динамические административные представления используются для устранения проблем использования ЦП, см. в разделе [Выявление проблем производительности ЦП](sql-database-monitoring-with-dmvs.md#identify-cpu-performance-issues).

### <a name="ParamSniffing"></a> Устранять неполадки с запросами с проблемами плана выполнения зависящих от параметров запроса

Проблема параметра конфиденциального плана заключается в том, что оптимизатор запросов создает план выполнения запроса, который является оптимальным только для определенного значения (или набора значений) параметра, а кэшированный план затем становится неоптимальным для значений параметров, используемых в последовательных выполнениях. Неоптимальные планы могут привести к проблемам с производительностью запросов и общему снижению пропускной способности рабочих нагрузок. Дополнительные сведения о сканировании и обработки запросов, см. в разделе [руководство по архитектуре обработки запросов](/sql/relational-databases/query-processing-architecture-guide#ParamSniffing).

Существует несколько обходных решений для разрешения проблем, каждое из которых имеет свои преимущества и недостатки.

- Использование указания запроса [RECOMPILE](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) при каждом выполнении запроса. Этот метод позволяет заменить время компиляции и увеличение загрузки ЦП на улучшение качества плана. Использование параметра `RECOMPILE` часто недопустимо для рабочих нагрузок, требующих высокую пропускную способность.
- Использование указания запроса [OPTION (OPTIMIZE FOR…)](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query), чтобы переопределить фактическое значение параметра типичным значением, которое обеспечивает достаточно хороший план для большинства возможных значений параметра.   Для этого варианта требуется хорошее понимание оптимальных значений параметров и связанных с ними характеристик плана.
- Использование указания запроса [OPTION (OPTIMIZE FOR UNKNOWN)](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query), чтобы переопределить фактическое значение параметра в обмен на использование среднего значения вектора плотности. Другой способ сделать это – записать входящие значения параметров в локальные переменные, а затем использовать локальные переменные внутри предикатов вместо использования самих параметров. Средняя плотность должна быть *достаточно хорошей* для конкретного исправления.
- Полное отключение сканирования параметров с помощью указания запроса [DISABLE_PARAMETER_SNIFFING](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query).
- Использование указания запроса [KEEPFIXEDPLAN](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query), чтобы избежать перекомпиляции в кэше. Этот метод предполагает, что общий план, который находится в кэше, является *подходящим*. Можно также отключить автоматические обновления статистики, чтобы уменьшить вероятность вытеснения хорошего плана и компиляции неподходящего плана.
- Принудительное применение плана с помощью явного использования указания запроса [USE PLAN](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) (посредством явного указания, установки определенного плана с помощью хранилища запросов или включения [автонастройки](sql-database-automatic-tuning.md)).
- Замена одной процедуры вложенным набором процедур, каждая из которых может использоваться на основе условной логики и связанных значений параметров.
- Создание альтернатив выполнения динамической строки для статического определения процедуры.

Дополнительные сведения об устранении такого типа проблем см. по следующим ссылкам.

- Это [кажется, здесь параметр](https://blogs.msdn.microsoft.com/queryoptteam/2006/03/31/i-smell-a-parameter/) записи блога
- Запись блога о [динамическом SQL и качестве плана для параметризованных запросов](https://blogs.msdn.microsoft.com/conor_cunningham_msft/2009/06/03/conor-vs-dynamic-sql-vs-procedures-vs-plan-quality-for-parameterized-queries/).
- Это [методы оптимизации запросов SQL в SQL Server: Сканирование параметров](https://www.sqlshack.com/query-optimization-techniques-in-sql-server-parameter-sniffing/) записи блога

### <a name="troubleshooting-compile-activity-due-to-improper-parameterization"></a>Устранение неполадок компиляции активности из-за неправильной параметризации

Когда в запросе есть литералы, либо ядро ​​базы данных автоматически параметризует инструкцию, либо пользователь явно параметризует ее, чтобы уменьшить количество компиляций. Большое количество компиляций запроса, использующих один и тот же шаблон, но разные значения литералов, может привести к высокой загрузке ЦП. Аналогично, если вы только частично параметризуете запрос, который по-прежнему имеет литералы, ядро ​​базы данных не будет параметризировать его дальше.  Ниже приведен пример частично параметризованного запроса.

```sql
SELECT * FROM t1 JOIN t2 ON t1.c1 = t2.c1
WHERE t1.c1 = @p1 AND t2.c2 = '961C3970-0E54-4E8E-82B6-5545BE897F8F'
```

В предыдущем примере `t1.c1` принимает `@p1`, но `t2.c2` продолжает принимать GUID как литерал. В этом случае, если изменить значение для `c2`, запрос будет считаться другим, и возникнет новая компиляция. Чтобы уменьшить количество компиляций в предыдущем примере, рекомендуется также параметризовать идентификатор GUID.

В следующем запросе показано количество запросов хэша для определения того, правильно ли параметризован запрос.

```sql
SELECT  TOP 10  
  q.query_hash
  , count (distinct p.query_id ) AS number_of_distinct_query_ids
  , min(qt.query_sql_text) AS sampled_query_text
FROM sys.query_store_query_text AS qt
  JOIN sys.query_store_query AS q
     ON qt.query_text_id = q.query_text_id
  JOIN sys.query_store_plan AS p 
     ON q.query_id = p.query_id
  JOIN sys.query_store_runtime_stats AS rs 
     ON rs.plan_id = p.plan_id
  JOIN sys.query_store_runtime_stats_interval AS rsi
     ON rsi.runtime_stats_interval_id = rs.runtime_stats_interval_id
WHERE
  rsi.start_time >= DATEADD(hour, -2, GETUTCDATE())
  AND query_parameterization_type_desc IN ('User', 'None')
GROUP BY q.query_hash
ORDER BY count (distinct p.query_id) DESC
```

### <a name="resolve-problem-queries-or-provide-more-resources"></a>Устранение проблемных запросов или предоставление дополнительных ресурсов

Определив проблему, вы можете настроить проблемные запросы либо обновить размер вычислений или уровень служб, чтобы увеличить производительность базы данных SQL Azure для снижения требований к ЦП. Сведения о масштабировании ресурсов для отдельной базы данных см. в статье [Масштабирование ресурсов отдельной базы данных в базе данных SQL Azure](sql-database-single-database-scale.md). Дополнительную информацию о масштабировании ресурсов для эластичных пулов см. в статье [Масштабирование ресурсов эластичного пула в базе данных SQL Azure](sql-database-elastic-pool-scale.md). Сведения о масштабировании управляемого экземпляра см. в разделе [Ограничения ресурсов на уровне экземпляра](sql-database-managed-instance-resource-limits.md#instance-level-resource-limits).

### <a name="determine-if-running-issues-due-to-increase-workload-volume"></a>Определение того, возникли ли проблемы из-за увеличения объема рабочей нагрузки

Увеличение трафика приложений и рабочей нагрузки может привести к увеличению загрузки ЦП, но эту проблему необходимо правильно диагностировать. В сценарии с высокой загрузкой ЦП ответьте на следующие вопросы, чтобы определить, действительно ли увеличение загрузки ЦП вызвано изменениями объема рабочей нагрузки.

1. Являются ли запросы из приложения причиной проблемы высокой загрузки ЦП?
2. Для запросов, наиболее загружающих ЦП (которые можно определить), сделайте следующее.

   - Определите, связаны ли несколько планов выполнения с одним и тем же запросом. Если это так, определите почему.
   - Для запросов с одним и тем же планом выполнения определите, были ли согласованы времена выполнения и увеличилось ли количество выполнений. Если это так, вероятно, проблемы с производительностью связаны с увеличением рабочей нагрузки.

Таким образом, если план выполнения запроса не выполнялся по-разному, но загрузка ЦП увеличивалась вместе с количеством выполненных операций, вероятно, существует проблема производительности, связанная с увеличением рабочей нагрузки.

Не всегда легко прийти к заключению, что изменение объема рабочей нагрузки является причиной проблемы с ЦП.   Факторы, которые следует учесть. 

- **Изменение использования ресурсов**

  Например, рассмотрим сценарий, в котором загрузка ЦП увеличилась до 80 % на длительный период времени.  Сама по себе загрузка ЦП не означает, что объем рабочей нагрузки изменился.  Регрессии плана выполнения запросов и изменения в распределении данных также могут способствовать большему использованию ресурсов, даже если приложение выполняет точно такую ​​же рабочую нагрузку.

- **Создание нового запроса**

   Приложение может запускать новый набор запросов в разное время.

- **Количество запросов увеличилось или уменьшилось**

   Этот сценарий является наиболее очевидной мерой рабочей нагрузки. Количество запросов не всегда соответствует дополнительному использованию ресурсов. Тем не менее эта метрика является важным сигналом, если предположить, что другие факторы не изменились.

## <a name="waiting-related-performance-issues"></a>Проблемы производительности, связанные с ожиданием

Если вы убедитесь в отсутствии проблемы производительности, связанной с выполнением, с высокой загрузкой ЦП, значит, возникла проблема производительности, связанная с ожиданием. В частности, ресурсы ЦП используются неэффективно, так как ЦП ожидает другой ресурс. В этому случае следующим шагом является определение ресурсов, которых ожидает ЦП. Ниже перечислены наиболее распространенные методы для отображения основных категорий, относящихся к типу ожидания.

- [Хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store) предоставляет статистику времени ожидания на запрос за определенный промежуток времени. В хранилище запросов типы времени ожидания объединены в категории ожидания. Сопоставление категорий времени ожидания с типами доступно в [sys.query_store_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-query-store-wait-stats-transact-sql#wait-categories-mapping-table).
- [sys.dm_db_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-wait-stats-azure-sql-database) возвращает сведения обо всех периодах ожидания потоков, выполнявшихся в ходе операции. Это агрегированное представление может использоваться для диагностики проблем с производительностью Базы данных SQL Azure, а также проблем с определенными запросами и пакетами.
- [sys.dm_os_waiting_tasks](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-os-waiting-tasks-transact-sql) возвращает сведения об очереди ожидания задач, которым необходимы некоторые ресурсы.

В сценариях высокой загрузки ЦП хранилище запросов и статистика времени ожидания не всегда отражают использование ЦП по таким двум причинам:

- запросы, потребляющие больше ресурсов ЦП, могут все еще выполняться и быть незавершенными;
- во время выполнения запросов, потребляющих больше ресурсов ЦП, произошла отработка отказа.

Хранилище запросов и динамическое административное представление отслеживания статистики ожидания показывают результаты только успешно выполненных запросов и запросов с превышенным временем ожидания, но не отображают данные инструкций, выполняющихся в данный момент (пока они не завершаться). Динамическое административное представление [sys.dm_exec_requests](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql) позволяет отслеживать текущие запросы и соответствующее рабочее время.

Как показано на предыдущей диаграмме, следующие типы ожидания являются самыми распространенными:

- блокировки;
- ВВОД-ВЫВОД
- Состязания, связанные с `tempdb`
- ожидание временно предоставляемого буфера памяти.

> [!IMPORTANT]
> Сведения о наборе запросов T-SQL, где эти динамические административные представления используются для устранения проблем, связанных с ожиданием, см. в разделе:
>
> - [Поиск проблем производительности операций ввода-вывода](sql-database-monitoring-with-dmvs.md#identify-io-performance-issues)
> - [Поиск проблем производительности `tempdb`](sql-database-monitoring-with-dmvs.md#identify-io-performance-issues)
> - [Определение ожидания временно предоставляемого буфера памяти](sql-database-monitoring-with-dmvs.md#identify-memory-grant-wait-performance-issues)
> - [TigerToolbox - ожиданий и кратковременных блокировок](https://github.com/Microsoft/tigertoolbox/tree/master/Waits-and-Latches)
> - [TigerToolbox - usp_whatsup](https://github.com/Microsoft/tigertoolbox/tree/master/usp_WhatsUp)

## <a name="improving-database-performance-with-more-resources"></a>Повышение производительности базы данных с помощью дополнительных ресурсов

Наконец, если для базы данных нет применимых рекомендаций по повышению производительности, можно изменить объем ресурсов, доступных в Базе данных SQL Azure. Можно назначить больше ресурсов, изменив [уровень служб на основе DTU](sql-database-service-tiers-dtu.md) отдельной базы данных или увеличив количество eDTU эластичного пула в любое время. Кроме того, если вы используете [модель приобретения на основе виртуальных ядер](sql-database-service-tiers-vcore.md), вы можете изменить уровень служб или увеличить объем ресурсов, выделенных для базы данных.

1. Для повышения производительности отдельных баз данных можно изменять [уровни служб](sql-database-single-database-scale.md) или объем [вычислительных ресурсов](sql-database-single-database-scale.md) по запросу.
2. Если баз данных несколько, можно включить автомасштабирование ресурсов, используя [пулы эластичных баз данных](sql-database-elastic-pool-guidance.md).

## <a name="tune-and-refactor-application-or-database-code"></a>Настройка и рефакторинг кода приложения или базы данных

Можно изменить код приложения для более оптимального использования базы данных, изменить индексы, принудительно применить планы или с помощью указаний вручную адаптировать базу данных для рабочей нагрузки. Рекомендации и советы по ручной настройке и изменению кода приведены в [этом разделе руководства по производительности](sql-database-performance-guidance.md).

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о том, как включить автоматическую настройку в Базе данных SQL Azure и позволить ей полностью управлять рабочей нагрузкой, см. в [этой статье](sql-database-automatic-tuning-enable.md).
- Дополнительные сведения о ручной настройке для повышения производительности запросов см. в статье [Использование помощника по базам данных SQL на портале Azure](sql-database-advisor-portal.md).
- Изменить ресурсы, доступные в базе данных, можно, изменив [уровни служб Базы данных SQL Azure](sql-database-performance-guidance.md).
