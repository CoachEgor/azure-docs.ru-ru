---
title: Мониторинг и настройка производительности базы данных SQL Azure | Документация Майкрософт
description: Советы по настройке базы данных SQL Azure — оценка и улучшение производительности.
services: sql-database
ms.service: sql-database
ms.subservice: performance
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: jovanpop-msft
ms.author: jovanpop
ms.reviewer: jrasnik, carlrab
manager: craigg
ms.date: 01/25/2019
ms.openlocfilehash: 2fa43fcd48736a3d044deb07ed690af580c3b987
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "66416273"
---
# <a name="monitoring-and-performance-tuning"></a>Мониторинг и настройка производительности

Azure базы данных SQL позволяет легко отслеживать использование, добавить или удалить ресурсы (ЦП, памяти, ввода-вывода), устранять возможные неполадки и найти рекомендации по повышению производительности базы данных. База данных SQL Azure имеет множество функций, которые могут автоматически устранять проблемы в базах данных, чтобы позволить базе данных адаптироваться к рабочей нагрузке и автоматически оптимизировать производительность. Однако существуют некоторые пользовательские проблемы, которые может потребоваться для устранения неполадок. Здесь объясняются некоторые рекомендации и средства, которые можно использовать для диагностики проблем с производительностью.

Существует два основных действия, которые необходимо выполнить, чтобы убедиться, что, то база данных работает без проблем.
- [Мониторинг производительности базы данных](#monitoring-database-performance) чтобы убедиться, что ресурсы, назначенные вашей базы данных может обрабатывать рабочую нагрузку. Если вы видите, что вы столкнулись ограничения ресурсов, необходимо определить Топ-запросов использования ресурсов и оптимизировать их или добавить дополнительные ресурсы путем обновления уровня служб.
- [Устранение проблем с производительностью](#troubleshoot-performance-issues) чтобы определить, почему произошло некоторые потенциальные проблемы, определить основную причину проблемы и действие, которое будет устранить проблему.

## <a name="monitoring-database-performance"></a>Мониторинг производительности базы данных

Мониторинг производительности базы данных SQL в Azure начинается с мониторинга использования ресурсов в соответствии с выбранным уровнем производительности базы данных. Вам потребуется отслеживать следующие ресурсы:
 - **Использование ЦП** -необходимо проверить достижение 100% использования ЦП в более длительного периода времени. Это может означать, что может потребоваться для обновления базы данных или экземпляра или определить и настроить запросы, которые используют большую часть вычислительной мощности.
 - **Статистика ожидания** -убедитесь, что почему запросы ожидают некоторые ресурсы. Queriesmig ожидать от данных выборки или сохранения файлов баз данных, ожидания, так как достигнут предел на ресурсы и т. д.
 - **Использование операций ввода-ВЫВОДА** -необходимо проверить, вы превысили ограничения операций ввода-ВЫВОДА базового хранилища.
 - **Использование памяти** -объем памяти, доступной для базы данных или экземпляра пропорционально на количество виртуальных ядер, а вам нужно проверить достаточно ли для вашей рабочей нагрузки. Ожидаемый срок жизни страницы — один из параметров, которые могут указывать на страницах быстро удаляются из памяти.

База данных SQL Azure **предоставляет вывод советов, которые помогут вам поиск и устранение возможных проблем с производительностью**. Можно легко определить возможности для повышения и оптимизации производительности запросов без изменения ресурсов, просмотрев [рекомендации по настройке производительности](sql-database-advisor.md). Отсутствующие индексы и плохо оптимизированные запросы — распространенные причины низкой производительности баз данных. Можно применить эти рекомендации по настройке, чтобы повысить производительность рабочей нагрузки. Можно также позволить базе данных Azure SQL [автоматически оптимизировать производительность запросов](sql-database-automatic-tuning.md). В этом случае она будет применять все созданные рекомендации и проверять, действительно ли они повышают производительность базы данных.

Доступны следующие возможности мониторинга и устранения неполадок производительности базы данных.

- На [портале Azure](https://portal.azure.com) щелкните **Базы данных SQL**, выберите базу данных и найдите ресурсы, приближающиеся к максимальной отметке, на диаграмме мониторинга. По умолчанию отображается процент использования DTU. Щелкните **Изменить** , чтобы изменить диапазон времени и отображаемые значения.
- Средства, такие как SQL Server Management Studio указывать много полезных отчетов, такие как [панели мониторинга производительности](https://docs.microsoft.com/sql/relational-databases/performance/performance-dashboard?view=sql-server-2017) там, где вы можете отслеживать использование ресурсов и идентификации запросов, использования ресурсов или [Query Store](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store#Regressed)где можно определить запросы со сниженной производительностью.
- Используйте [анализ производительности запросов](sql-database-query-performance.md) [портала Azure](https://portal.azure.com) чтобы определить, какие запросы потребляют большую часть ресурсов. Эта функция доступна только в одной базе данных и эластичных пулов.
- Используйте [Помощник по базам данных SQL](sql-database-advisor-portal.md), чтобы просматривать рекомендации по созданию и удалению индексов, параметризации запросов и устранению ошибок схемы. Эта функция доступна только в одной базе данных и эластичных пулов.
- Используйте [Azure SQL Intelligent Insights](sql-database-intelligent-insights.md) для автоматического мониторинга производительности базы данных. После обнаружения проблемы с производительностью создается журнал диагностики, в который записываются сведения о проблеме и результат анализа ее первопричин (RCA). При возможности также приводятся рекомендации по повышению производительности.
- [Включите автоматическую настройку](sql-database-automatic-tuning-enable.md) и позвольте Базе данных SQL Azure автоматически исправлять выявленные проблемы производительности.
- Используйте [динамические административные представления (DMV)](sql-database-monitoring-with-dmvs.md), [расширенные события](sql-database-xevent-db-diff-from-svr.md) и [хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store) для получения более подробных сведений об устранении проблем с производительностью.

> [!TIP]
> В [этом руководстве по производительности](sql-database-performance-guidance.md) описаны методы, которые можно использовать, чтобы повысить производительность базы данных SQL Azure, если вы обнаружили какие-либо проблемы с помощью этих методов.

## <a name="troubleshoot-performance-issues"></a>Устранение проблем с производительностью

Для диагностики и устранения проблем с производительностью начните с изучения состояния каждого активного запроса и условий, вызывающих проблемы производительности для каждого состояния рабочей нагрузки. Чтобы повысить производительность базы данных SQL Azure, необходимо понимать, что каждый активный запрос из приложения находится в состоянии выполнения или ожидания. Читая статью о выявлении и устранении проблем с производительностью в Базе данных SQL Azure, примите во внимание приведенную ниже диаграмму:

![Состояния рабочей нагрузки](./media/sql-database-monitor-tune-overview/workload-states.png)

Для рабочей нагрузки проблема с производительностью может быть вызвана состязанием ЦП (условие, **связанное с выполнением**) или тем, что отдельные запросы находятся в состоянии ожидания (условие, **связанное с ожиданием**).

Причины или **выполнение связанных** проблемы может быть:
- **Ошибки компиляции** -оптимизатор запросов SQL может привести к неоптимальной план из-за устаревшей статистики, неверные оценки количества строк, которые будут обрабатываться или оценки необходимый объем памяти. Если известно, что этот запрос был выполнен быстрее в прошлом или на другой экземпляр (либо управляемый экземпляр или экземпляр SQL Server), отключите фактические планы выполнения и сравнить их, чтобы узнать они разные. При попытке применения указаний запросов или перестроение статистика или индексы, чтобы получить лучший план. Включите автоматическое исправление плана в базе данных SQL Azure, чтобы автоматически устранять эти проблемы.
- **Проблемы с выполнением** — Если план запроса является оптимальным, а затем, возможно, он попадает некоторые ограничения ресурсов в базе данных, таких как пропускная способность записи журнала или он может использовать дефрагментация индексов, которые должны быть перестроены. Большое количество параллельных запросов, которые проводят ресурсы также может быть причиной проблем выполнения. **Связанные ожидания** проблемы являются в большинстве случаев, относящиеся к вопросам выполнения, так как запросы, которые не выполняют эффективно, вероятно, ожидают некоторые ресурсы.

Причины или **связанные ожидания** проблемы может быть:
- **Блокировка** -один запрос может удерживает блокировку на некоторые объекты в базе данных, пока другие пытаются получить доступ к те же объекты. Можно легко определить блокирующие запросы с помощью динамического административного Представления или средства мониторинга.
- **Операции ввода-ВЫВОДА проблем** -ожидающих запросов для страниц, записываемых в файлы данных или журнала. В этом случае вы увидите `INSTANCE_LOG_RATE_GOVERNOR`, `WRITE_LOG`, или `PAGEIOLATCH_*` с ожиданием в динамического административного Представления.
- **Проблемы TempDB** — Если вы используете много временных таблиц или вы увидите массу TempDB попадании в планах запросов может возникнут проблемы с пропускной способности базы данных TempDB. 
- **Проблемы, связанные с памятью** -может не имеется достаточно памяти для рабочей нагрузки так, чтобы ваши ожидаемый срок жизни страницы могут удалять или запросы получают предоставления меньше памяти, чем требуется. В некоторых случаях встроенные средства аналитики в оптимизатор запросов будет устранить эти проблемы.
 
В следующих разделах будет рассматриваться как выявить и устранить некоторые из этих проблем.

## <a name="running-related-performance-issues"></a>Проблемы с производительностью, связанные с выполнением

Как правило, проблемы с производительностью возникают, если загрузка ЦП постоянно превышает 80 %. Если у вас есть проблемы, связанные с выполнением, они могут быть вызваны нехваткой ресурсов ЦП или одним из следующих условий:

- слишком много выполняемых запросов;
- слишком много компилируемых запросов;
- один или несколько выполняемых запросов использует неоптимальный план запроса.

Если вы определили наличие проблемы, связанной с выполнением, нужно определить конкретную проблему с помощью одного или нескольких методов. Ниже приведены наиболее распространенные методы для выявления таких проблем:

- Используйте [портал Azure](sql-database-manage-after-migration.md#monitor-databases-using-the-azure-portal), чтобы отследить процент загрузки ЦП.
- Используйте следующие [динамические административные представления](sql-database-monitoring-with-dmvs.md):

  - [sys.dm_db_resource_stats](sql-database-monitoring-with-dmvs.md#monitor-resource-use) возвращает сведения об использовании ЦП, операциях ввода-вывода и потреблении памяти для базы данных в службе "База данных SQL Azure". Новая строка создается каждые 15 секунд, даже если в базе данных не выполняется никаких действий. Исторические данные хранятся в течение одного часа.
  - [sys.resource_stats](sql-database-monitoring-with-dmvs.md#monitor-resource-use) возвращает сведения об использовании ЦП и хранилища для Базы данных SQL Azure. Данные собираются и объединяются за пятиминутные интервалы.

> [!IMPORTANT]
> Сведения о наборе запросов T-SQL, где эти динамические административные представления используются для устранения проблем использования ЦП, см. в разделе [Выявление проблем производительности ЦП](sql-database-monitoring-with-dmvs.md#identify-cpu-performance-issues).

### <a name="ParamSniffing"></a> Устранять неполадки с запросами с проблемами плана выполнения зависящих от параметров запроса

Проблема параметра конфиденциального плана заключается в том, что оптимизатор запросов создает план выполнения запроса, который является оптимальным только для определенного значения (или набора значений) параметра, а кэшированный план затем становится неоптимальным для значений параметров, используемых в последовательных выполнениях. Неоптимальные планы могут привести к проблемам с производительностью запросов и общему снижению пропускной способности рабочих нагрузок. Дополнительные сведения о сканировании и обработки запросов, см. в разделе [руководство по архитектуре обработки запросов](/sql/relational-databases/query-processing-architecture-guide#ParamSniffing).

Существует несколько обходных решений для разрешения проблем, каждое из которых имеет свои преимущества и недостатки.

- Использование указания запроса [RECOMPILE](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) при каждом выполнении запроса. Этот метод позволяет заменить время компиляции и увеличение загрузки ЦП на улучшение качества плана. Использование параметра `RECOMPILE` часто недопустимо для рабочих нагрузок, требующих высокую пропускную способность.
- Использование указания запроса [OPTION (OPTIMIZE FOR…)](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query), чтобы переопределить фактическое значение параметра типичным значением, которое обеспечивает достаточно хороший план для большинства возможных значений параметра.   Для этого варианта требуется хорошее понимание оптимальных значений параметров и связанных с ними характеристик плана.
- Использование указания запроса [OPTION (OPTIMIZE FOR UNKNOWN)](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query), чтобы переопределить фактическое значение параметра в обмен на использование среднего значения вектора плотности. Другой способ сделать это – записать входящие значения параметров в локальные переменные, а затем использовать локальные переменные внутри предикатов вместо использования самих параметров. Средняя плотность должна быть *достаточно хорошей* для конкретного исправления.
- Полное отключение сканирования параметров с помощью указания запроса [DISABLE_PARAMETER_SNIFFING](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query).
- Использование указания запроса [KEEPFIXEDPLAN](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query), чтобы избежать перекомпиляции в кэше. Этот метод предполагает, что общий план, который находится в кэше, является *подходящим*. Можно также отключить автоматические обновления статистики, чтобы уменьшить вероятность вытеснения хорошего плана и компиляции неподходящего плана.
- Принудительное применение плана с помощью явного использования указания запроса [USE PLAN](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) (посредством явного указания, установки определенного плана с помощью хранилища запросов или включения [автонастройки](sql-database-automatic-tuning.md)).
- Замена одной процедуры вложенным набором процедур, каждая из которых может использоваться на основе условной логики и связанных значений параметров.
- Создание альтернатив выполнения динамической строки для статического определения процедуры.

Дополнительные сведения об устранении такого типа проблем см. по следующим ссылкам.

- Это [кажется, здесь параметр](https://blogs.msdn.microsoft.com/queryoptteam/2006/03/31/i-smell-a-parameter/) записи блога
- Запись блога о [динамическом SQL и качестве плана для параметризованных запросов](https://blogs.msdn.microsoft.com/conor_cunningham_msft/2009/06/03/conor-vs-dynamic-sql-vs-procedures-vs-plan-quality-for-parameterized-queries/).
- Это [методы оптимизации запросов SQL в SQL Server: Сканирование параметров](https://www.sqlshack.com/query-optimization-techniques-in-sql-server-parameter-sniffing/) записи блога

### <a name="troubleshooting-compile-activity-due-to-improper-parameterization"></a>Устранение неполадок компиляции активности из-за неправильной параметризации

Когда в запросе есть литералы, либо ядро ​​базы данных автоматически параметризует инструкцию, либо пользователь явно параметризует ее, чтобы уменьшить количество компиляций. Большое количество компиляций запроса, использующих один и тот же шаблон, но разные значения литералов, может привести к высокой загрузке ЦП. Аналогично, если вы только частично параметризуете запрос, который по-прежнему имеет литералы, ядро ​​базы данных не будет параметризировать его дальше.  Ниже приведен пример частично параметризованного запроса.

```sql
SELECT * FROM t1 JOIN t2 ON t1.c1 = t2.c1
WHERE t1.c1 = @p1 AND t2.c2 = '961C3970-0E54-4E8E-82B6-5545BE897F8F'
```

В предыдущем примере `t1.c1` принимает `@p1`, но `t2.c2` продолжает принимать GUID как литерал. В этом случае, если изменить значение для `c2`, запрос будет считаться другим, и возникнет новая компиляция. Чтобы уменьшить количество компиляций в предыдущем примере, рекомендуется также параметризовать идентификатор GUID.

В следующем запросе показано количество запросов хэша для определения того, правильно ли параметризован запрос.

```sql
SELECT  TOP 10  
  q.query_hash
  , count (distinct p.query_id ) AS number_of_distinct_query_ids
  , min(qt.query_sql_text) AS sampled_query_text
FROM sys.query_store_query_text AS qt
  JOIN sys.query_store_query AS q
     ON qt.query_text_id = q.query_text_id
  JOIN sys.query_store_plan AS p 
     ON q.query_id = p.query_id
  JOIN sys.query_store_runtime_stats AS rs 
     ON rs.plan_id = p.plan_id
  JOIN sys.query_store_runtime_stats_interval AS rsi
     ON rsi.runtime_stats_interval_id = rs.runtime_stats_interval_id
WHERE
  rsi.start_time >= DATEADD(hour, -2, GETUTCDATE())
  AND query_parameterization_type_desc IN ('User', 'None')
GROUP BY q.query_hash
ORDER BY count (distinct p.query_id) DESC
```
### <a name="factors-influencing-query-plan-changes"></a>Факторов, влияющих на изменения плана запросов

Повторная компиляция планов выполнения запроса может привести план созданного запроса, который отличается от той, что изначально была кэширована. Существует несколько причин, почему может автоматически перекомпиляции существующего исходного плана:
- Изменения в схеме указанные в запросе
- Изменения данных в таблицы указанные в запросе 
- Изменения в параметры контекста запроса 

Скомпилированный план может извлечь из кэша по ряду причин, включая перезапуска экземпляров, изменения конфигурации, нехватки памяти и явные запросы для очистки кэша в области базы данных. Кроме того с помощью указание RECOMPILE означает, что план не будет кэшироваться.

Повторная компиляция (или новая компиляция после вытеснения кэша) по-прежнему может привести формирования плана выполнения идентичных запросов из одного изначально наблюдать.  Если, однако изменения в план, по сравнению с предыдущих или исходный план, ниже рассматриваются наиболее распространенные причины изменить план выполнения запроса.

- **Изменить физического проектирования**. Например создавать новые индексы, что более эффективно эти программы решают требования запроса может использоваться для компиляции, если оптимизатор запросов решает, он является более оптимальным использовать этот новый индекс, чем использовать структуру данных, установили для первой версии выполнение запроса.  Новый вариант плана во время компиляции может привести все физические изменения упоминаемые объекты.

- **Различия ресурсов сервера**. В сценарии, где один план отличается от «системные A» и «система B» — от доступности ресурсов, таких как количество доступных процессоров может повлиять на Получает созданный план.  Например если в одной системе имеет большее количество процессоров, может быть выбран параллельный план. 

- **Иной статистики**. Статистика, связанная с объектами, на которую указывает ссылка, изменены или существенно отличаются от исходной системы статистики.  Если изменить статистику, при повторной компиляции оптимизатор запросов будет использовать статистику на момент написания этого конкретного момента времени. Измененный статистики может иметь значительно различные распределения данных и частоты, которые не были в случае компиляции исходного.  Эти изменения позволяют оценить оценки количества элементов (количество строк, который ожидается в дереве логического запроса).  Изменения оценок количества элементов может привести к нам выбрать разные физические операторы и связанные с ней порядок операции.  План выполнения запроса измененных может привести даже небольшие изменения статистики.

- **Измененные версии базы данных совместимости уровня или количества элементов оценщика**.  Изменения уровня совместимости базы данных можно включить новые стратегии и компоненты, которые могут вызывать в другой план выполнения запроса.  За пределы уровня совместимости базы данных отключения или включения флага трассировки 4199 или изменение состояния конфигурации области базы данных, которые QUERY_OPTIMIZER_HOTFIXES может также повлиять на запрос вариантов плана выполнения во время компиляции.  Флаги трассировки 9481 (принудительного задания устаревшей оценки Кратности) и 2312 (принудительное Кратности по умолчанию) Кроме того, влияющие на план. 

### <a name="resolve-problem-queries-or-provide-more-resources"></a>Устранение проблемных запросов или предоставление дополнительных ресурсов

Определив проблему, вы можете настроить проблемные запросы либо обновить объем вычислительных ресурсов или уровень служб, чтобы увеличить производительность базы данных SQL Azure для снижения требований к ЦП. Сведения о масштабировании ресурсов для отдельной базы данных см. в статье [Масштабирование ресурсов отдельной базы данных в Базе данных SQL Azure](sql-database-single-database-scale.md). Дополнительную информацию о масштабировании ресурсов для эластичных пулов см. в статье [Масштабирование ресурсов эластичного пула в Базе данных SQL Azure](sql-database-elastic-pool-scale.md). Сведения о масштабировании управляемого экземпляра см. в разделе [Ограничения ресурсов на уровне экземпляра](sql-database-managed-instance-resource-limits.md#instance-level-resource-limits).

### <a name="determine-if-running-issues-due-to-increase-workload-volume"></a>Определение того, возникли ли проблемы из-за увеличения объема рабочей нагрузки

Увеличение трафика приложений и рабочей нагрузки может привести к увеличению загрузки ЦП, но эту проблему необходимо правильно диагностировать. В сценарии с высокой загрузкой ЦП ответьте на следующие вопросы, чтобы определить, действительно ли увеличение загрузки ЦП вызвано изменениями объема рабочей нагрузки.

1. Являются ли запросы из приложения причиной проблемы высокой загрузки ЦП?
2. Для запросов, наиболее загружающих ЦП (которые можно определить), сделайте следующее.

   - Определите, связаны ли несколько планов выполнения с одним и тем же запросом. Если это так, определите почему.
   - Для запросов с одним и тем же планом выполнения определите, были ли согласованы времена выполнения и увеличилось ли количество выполнений. Если это так, вероятно, проблемы с производительностью связаны с увеличением рабочей нагрузки.

Таким образом, если план выполнения запроса не выполнялся по-разному, но загрузка ЦП увеличивалась вместе с количеством выполненных операций, вероятно, существует проблема производительности, связанная с увеличением рабочей нагрузки.

Не всегда легко прийти к заключению, что изменение объема рабочей нагрузки является причиной проблемы с ЦП.   Факторы, которые следует учесть. 

- **Изменение использования ресурсов**

  Например, рассмотрим сценарий, в котором загрузка ЦП увеличилась до 80 % на длительный период времени.  Сама по себе загрузка ЦП не означает, что объем рабочей нагрузки изменился.  Регрессии плана выполнения запросов и изменения в распределении данных также могут способствовать большему использованию ресурсов, даже если приложение выполняет точно такую ​​же рабочую нагрузку.

- **Создание нового запроса**

   Приложение может запускать новый набор запросов в разное время.

- **Количество запросов увеличилось или уменьшилось**

   Этот сценарий является наиболее очевидной мерой рабочей нагрузки. Количество запросов не всегда соответствует дополнительному использованию ресурсов. Тем не менее эта метрика является важным сигналом, если предположить, что другие факторы не изменились.

## <a name="waiting-related-performance-issues"></a>Проблемы производительности, связанные с ожиданием

Если вы убедитесь в отсутствии проблемы производительности, связанной с выполнением, с высокой загрузкой ЦП, значит, возникла проблема производительности, связанная с ожиданием. В частности, ресурсы ЦП используются неэффективно, так как ЦП ожидает другой ресурс. В этому случае следующим шагом является определение ресурсов, которых ожидает ЦП. Ниже перечислены наиболее распространенные методы для отображения основных категорий, относящихся к типу ожидания.

- [Хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store) предоставляет статистику времени ожидания на запрос за определенный промежуток времени. В хранилище запросов типы времени ожидания объединены в категории ожидания. Сопоставление категорий времени ожидания с типами доступно в [sys.query_store_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-query-store-wait-stats-transact-sql#wait-categories-mapping-table).
- [sys.dm_db_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-wait-stats-azure-sql-database) возвращает сведения обо всех периодах ожидания потоков, выполнявшихся в ходе операции. Это агрегированное представление может использоваться для диагностики проблем с производительностью базы данных SQL Azure, а также проблем с определенными запросами и пакетами.
- [sys.dm_os_waiting_tasks](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-os-waiting-tasks-transact-sql) возвращает сведения об очереди ожидания задач, которым необходимы некоторые ресурсы.

В сценариях высокой загрузки ЦП хранилище запросов и статистика времени ожидания не всегда отражают использование ЦП по таким двум причинам:

- запросы, потребляющие больше ресурсов ЦП, могут все еще выполняться и быть незавершенными;
- во время выполнения запросов, потребляющих больше ресурсов ЦП, произошла отработка отказа.

Хранилище запросов и динамическое административное представление отслеживания статистики ожидания показывают результаты только успешно выполненных запросов и запросов с превышенным временем ожидания, но не отображают данные инструкций, выполняющихся в данный момент (пока они не завершаться). Динамическое административное представление [sys.dm_exec_requests](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql) позволяет отслеживать текущие запросы и соответствующее рабочее время.

Как показано на предыдущей диаграмме, следующие типы ожидания являются самыми распространенными:

- блокировки;
- ВВОД-ВЫВОД
- Состязания, связанные с `tempdb`
- ожидание временно предоставляемого буфера памяти.

> [!IMPORTANT]
> Сведения о наборе запросов T-SQL, где эти динамические административные представления используются для устранения проблем, связанных с ожиданием, см. в разделе:
>
> - [Поиск проблем производительности операций ввода-вывода](sql-database-monitoring-with-dmvs.md#identify-io-performance-issues)
> - [Поиск проблем производительности `tempdb`](sql-database-monitoring-with-dmvs.md#identify-io-performance-issues)
> - [Определение ожидания временно предоставляемого буфера памяти](sql-database-monitoring-with-dmvs.md#identify-memory-grant-wait-performance-issues)
> - [TigerToolbox - ожиданий и кратковременных блокировок](https://github.com/Microsoft/tigertoolbox/tree/master/Waits-and-Latches)
> - [TigerToolbox - usp_whatsup](https://github.com/Microsoft/tigertoolbox/tree/master/usp_WhatsUp)

## <a name="improving-database-performance-with-more-resources"></a>Повышение производительности базы данных с помощью дополнительных ресурсов

Наконец, если для базы данных нет применимых рекомендаций по повышению производительности, можно изменить объем ресурсов, доступных в Базе данных SQL Azure. Можно назначить больше ресурсов, изменив [уровень служб на основе DTU](sql-database-service-tiers-dtu.md) отдельной базы данных или увеличив количество eDTU эластичного пула в любое время. Кроме того, если вы используете [модель приобретения на основе виртуальных ядер](sql-database-service-tiers-vcore.md), вы можете изменить уровень служб или увеличить объем ресурсов, выделенных для базы данных.

1. Для повышения производительности отдельных баз данных можно изменять [уровни служб](sql-database-single-database-scale.md) или объем [вычислительных ресурсов](sql-database-single-database-scale.md) по запросу.
2. Если баз данных несколько, можно включить автомасштабирование ресурсов, используя [пулы эластичных баз данных](sql-database-elastic-pool-guidance.md).

## <a name="tune-and-refactor-application-or-database-code"></a>Настройка и рефакторинг кода приложения или базы данных

Можно изменить код приложения для более оптимального использования базы данных, изменить индексы, принудительно применить планы или с помощью указаний вручную адаптировать базу данных для рабочей нагрузки. Рекомендации и советы по ручной настройке и изменению кода приведены в [этом разделе руководства по производительности](sql-database-performance-guidance.md).

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о том, как включить автоматическую настройку в Базе данных SQL Azure и позволить ей полностью управлять рабочей нагрузкой, см. в [этой статье](sql-database-automatic-tuning-enable.md).
- Дополнительные сведения о ручной настройке для повышения производительности запросов см. в статье [Использование помощника по базам данных SQL на портале Azure](sql-database-advisor-portal.md).
- Изменить ресурсы, доступные в базе данных, можно, изменив [уровни служб Базы данных SQL Azure](sql-database-performance-guidance.md).
