---
title: Мониторинг и настройка производительности базы данных SQL Azure | Документация Майкрософт
description: Советы по настройке базы данных SQL Azure — оценка и улучшение производительности.
services: sql-database
ms.service: sql-database
ms.subservice: performance
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: jovanpop-msft
ms.author: jovanpop
ms.reviewer: jrasnick, carlrab
ms.date: 01/25/2019
ms.openlocfilehash: ee4bd9d61856ef4ea1afdd027d6f39e730b92d78
ms.sourcegitcommit: 07700392dd52071f31f0571ec847925e467d6795
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2019
ms.locfileid: "70129208"
---
# <a name="monitoring-and-performance-tuning"></a>Мониторинг и настройка производительности

База данных SQL Azure предоставляет средства и методы, позволяющие легко отслеживать использование, добавлять или удалять ресурсы (ЦП, память, операции ввода-вывода), устранять потенциальные проблемы и принимать рекомендации по повышению производительности базы данных. База данных SQL Azure содержит функции, которые могут автоматически исправлять проблемы в базах данных. Автоматическая настройка позволяет базе данных адаптироваться к рабочей нагрузке и автоматически оптимизировать производительность. Однако существуют некоторые пользовательские проблемы, которые могут потребовать устранения неполадок. В этой статье описаны некоторые рекомендации и средства, которые можно использовать для устранения проблем с производительностью.

Существует два основных действия, которые следует выполнить, чтобы убедиться, что база данных работает без проблем.
- [Отслеживайте производительность базы данных](#monitoring-database-performance) , чтобы убедиться, что ресурсы, назначенные базе данных, могут справиться с рабочей нагрузкой. Если вы видите, что в базе данных достигается ограничение ресурсов, учитывайте следующее.
   - определение и оптимизация наиболее ресурсоемких запросов, использующих ресурсы.
   - Добавление дополнительных ресурсов путем обновления уровня служб.
- [Устраните проблемы с производительностью](#troubleshoot-performance-issues) , чтобы определить причину возникшей проблемы, и определить основную причину проблемы. После того как основная причина будет определена, выполните действия по ее устранению.

## <a name="monitoring-database-performance"></a>Мониторинг производительности базы данных

Наблюдение за производительностью базы данных SQL в Azure начинается с мониторинга ресурсов, используемых относительно выбранного уровня производительности базы данных. Необходимо отслеживать следующие ресурсы:
 - **Загрузка ЦП** . Проверьте, приближается ли база данных к 100% использования ЦП в течение продолжительного периода времени. Высокая загрузка ЦП может указывать на то, что запросы с максимальной вычислительной мощностью должны быть идентифицированы и настроены. Или высокая загрузка ЦП может указывать на то, что база данных или экземпляр должны быть обновлены до уровня служб выше. 
 - **Ожидание статистики** — используйте [sys. DM _os_wait_stats (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-wait-stats-transact-sql) , чтобы определить, какие ожидания возникают в запросах. Запросы могут ожидать ресурсы, ожидания очереди или внешние ожидания. 
 - **Использование операций ввода-вывода** . Проверьте, достигла ли база данных ограничений ввода-вывода в базовом хранилище.
 - **Использование памяти** . объем памяти, доступный для базы данных или экземпляра, пропорционален количеству виртуальных ядер. Убедитесь, что объем памяти достаточно велик для рабочей нагрузки. Ожидаемый срок жизни страницы — это один из параметров, которые могут указывать, насколько быстро страницы удаляются из памяти.

Служба базы данных SQL Azure **включает средства и ресурсы, помогающие устранять и устранять потенциальные проблемы с производительностью**. Можно определить возможные сделки для повышения и оптимизации производительности запросов без изменения ресурсов, проверив [рекомендации по настройке производительности](sql-database-advisor.md). Отсутствующие индексы и плохо оптимизированные запросы — распространенные причины низкой производительности баз данных. Эти рекомендации по настройке можно применять для повышения производительности рабочей нагрузки. Мы также можем разрешить базе данных SQL Azure [автоматически оптимизировать производительность запросов](sql-database-automatic-tuning.md) , применяя все определенные рекомендации и проверяя рекомендации по повышению производительности базы данных.

Для мониторинга и устранения неполадок производительности базы данных доступны следующие параметры.

- В [портал Azure](https://portal.azure.com)щелкните **базы данных SQL**, выберите базу данных, а затем используйте диаграмму мониторинга для поиска ресурсов, использующих максимальное использование. По умолчанию отображается процент использования DTU. Щелкните **Изменить** , чтобы изменить диапазон времени и отображаемые значения.
- Такие средства, как SQL Server Management Studio, предоставляют много полезных отчетов, таких как [панель мониторинга производительности](https://docs.microsoft.com/sql/relational-databases/performance/performance-dashboard?view=sql-server-2017) , для мониторинга использования ресурсов и выявление наиболее ресурсоемких запросов, использующих ресурсы. [Хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store#Regressed) можно использовать для обнаружения запросов с повышенной производительностью.
- Используйте [Анализ производительности запросов](sql-database-query-performance.md) в [портал Azure](https://portal.azure.com) для поиска запросов, использующих наибольшие ресурсы. Эта функция доступна только в отдельная база данных и эластичных пулах.
- Используйте [Помощник по базам данных SQL](sql-database-advisor-portal.md), чтобы просматривать рекомендации по созданию и удалению индексов, параметризации запросов и устранению ошибок схемы. Эта функция доступна только в отдельная база данных и эластичных пулах.
- Используйте [Intelligent Insights Azure SQL](sql-database-intelligent-insights.md) для автоматического мониторинга производительности базы данных. После обнаружения проблемы с производительностью создается журнал диагностики, в который записываются сведения о проблеме и результат анализа ее первопричин (RCA). При возможности также приводятся рекомендации по повышению производительности.
- [Включите автоматическую настройку](sql-database-automatic-tuning-enable.md) и позвольте базе данных SQL Azure автоматически исправлять выявленные проблемы производительности.
- Используйте [динамические административные представления (DMV)](sql-database-monitoring-with-dmvs.md), [расширенные события](sql-database-xevent-db-diff-from-svr.md) и [хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store) для получения более подробных сведений об устранении проблем с производительностью.

> [!TIP]
> В [этом руководстве по производительности](sql-database-performance-guidance.md) описаны методы, которые можно использовать, чтобы повысить производительность базы данных SQL Azure, если вы обнаружили какие-либо проблемы с помощью этих методов.

## <a name="troubleshoot-performance-issues"></a>Устранение проблем с производительностью

Для диагностики и устранения проблем с производительностью начните с изучения состояния каждого активного запроса и условий, вызывающих проблемы производительности для каждого состояния рабочей нагрузки. Чтобы повысить производительность базы данных SQL Azure, необходимо понимать, что каждый активный запрос из приложения находится в состоянии "работает" или "ожидание". При устранении проблем с производительностью в базе данных SQL Azure не забывайте о том, как мы прочитали эту статью, чтобы диагностировать и устранить проблемы с производительностью.

![Состояния рабочей нагрузки](./media/sql-database-monitor-tune-overview/workload-states.png)

Для рабочей нагрузки проблема с производительностью может быть вызвана состязанием ЦП (условие, **связанное с выполнением**) или тем, что отдельные запросы находятся в состоянии ожидания (условие, **связанное с ожиданием**).

Причины проблем, **связанных с выполнением** , могут быть:
- **Проблемы с компиляцией** . оптимизатор запросов SQL может создать неоптимальный план из-за устаревшей статистики, неверной оценки количества строк, которые будут обработаны, или неточной оценки требуемой памяти. Если мы уверены, что запрос выполнялся быстрее в прошлом или на другом экземпляре (Управляемый экземпляр или SQL Server экземпляр), примите фактические планы выполнения и сравните их, чтобы определить, различаются ли они. Попробуйте применить указания запросов или перестроить статистику или перестроить индексы, чтобы получить более подходящий план. Включите автоматическое исправление плана в базе данных SQL Azure, чтобы автоматически устранить эти проблемы.
- **Проблемы с выполнением** — если план запроса является оптимальным, то, вероятно, в базе данных, например пропускной способности записи в журнал, будет достигнуто предельное число ресурсов, а также будут использоваться фрагментированные индексы. Большое количество одновременных запросов, требующих одних и тех же ресурсов, также могут быть причиной проблем с выполнением. В большинстве случаев проблемы, **связанные с ожиданием** , связаны с проблемами выполнения, так как запросы, которые не выполняются эффективно, вероятно ожидают некоторых ресурсов.

Причины проблем, **связанных с ожиданием** , могут быть:
- **Блокировка** — один запрос может сохранить блокировку объектов в базе данных, в то время как другие пытаются получить доступ к тем же объектам. Блокирующие запросы можно легко определить с помощью динамических административных представлений или средств мониторинга.
- **Проблемы ввода-вывода** — запросы могут ожидать записи страниц в файлы данных или журнала. В этом случае см `INSTANCE_LOG_RATE_GOVERNOR`. `WRITE_LOG`статью, `PAGEIOLATCH_*` или время ожидания в динамическом административном отображении.
- **Проблемы с базой данных tempdb** — если в рабочей нагрузке используются временные таблицы или в планах имеются сбросы базы данных tempdb, то при выполнении запросов может возникнуть проблема с пропускной способностью tempdb. 
- **Проблемы, связанные с памятью** . возможно, не хватает памяти для рабочей нагрузки, поэтому ожидаемый срок жизни страницы может быть уменьшен, а запросы — меньше памяти, чем требуется. В некоторых случаях встроенные аналитические средства в оптимизаторе запросов исправляют эти проблемы.
 
 В следующих разделах объясняется, как определить и устранить некоторые из этих проблем.

## <a name="running-related-performance-issues"></a>Проблемы с производительностью, связанные с выполнением

Как правило, если загрузка ЦП постоянно не превышает 80%, то существует проблем производительности, связанных с производительностью. Если возникла неполадка, связанная с работой, это может быть вызвано нехваткой ресурсов ЦП или с одним из следующих условий:

- слишком много выполняемых запросов;
- слишком много компилируемых запросов;
- Один или несколько выполнения запросов используют неоптимальный план запроса

Если определено, что существует проблем производительности, связанных с производительностью, цель — определить точную ошибку с помощью одного или нескольких методов. Ниже приведены наиболее распространенные методы для выявления таких проблем:

- Используйте [портал Azure](sql-database-manage-after-migration.md#monitor-databases-using-the-azure-portal), чтобы отследить процент загрузки ЦП.
- Используйте следующие [динамические административные представления](sql-database-monitoring-with-dmvs.md):

  - [sys. DM _db_resource_stats](sql-database-monitoring-with-dmvs.md#monitor-resource-use) возвращает сведения о ЦП, вводе-выводе и потреблении памяти для базы данных SQL Azure. Одна строка существует каждые 15 секунд, даже если в базе данных нет действий. Исторические данные хранятся в течение одного часа.
  - [sys.resource_stats](sql-database-monitoring-with-dmvs.md#monitor-resource-use) возвращает сведения об использовании ЦП и хранилища для базы данных SQL Azure. Данные собираются и объединяются за пятиминутные интервалы.

> [!IMPORTANT]
> Для запросов T-SQL, использующих динамические административные представления sys. DM _db_resource_stats и sys. resource_stats для устранения проблем с использованием ЦП, см. раздел [выявление проблем с производительностью ЦП](sql-database-monitoring-with-dmvs.md#identify-cpu-performance-issues).

### <a name="ParamSniffing"></a>Устранение неполадок с запросами плана выполнения запросов с учетом параметров

Проблема параметра конфиденциального плана заключается в том, что оптимизатор запросов создает план выполнения запроса, который является оптимальным только для определенного значения (или набора значений) параметра, а кэшированный план затем становится неоптимальным для значений параметров, используемых в последовательных выполнениях. Неоптимальные планы могут привести к проблемам с производительностью запросов и общему снижению пропускной способности рабочих нагрузок. Дополнительные сведения о сканировании параметров и обработке запросов см. в разделе [руководств по архитектуре обработки запросов](/sql/relational-databases/query-processing-architecture-guide#ParamSniffing).

Существует несколько обходных решений, которые используются для устранения этих проблем, в каждой из которых есть связанные с ними компромиссы и недостатки.

- Использование указания запроса [RECOMPILE](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) при каждом выполнении запроса. Это решение меняет время компиляции и увеличивает качество ЦП для лучшего качества плана. Использование параметра `RECOMPILE` часто недопустимо для рабочих нагрузок, требующих высокую пропускную способность.
- Использование указания запроса [OPTION (OPTIMIZE FOR…)](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query), чтобы переопределить фактическое значение параметра типичным значением, которое обеспечивает достаточно хороший план для большинства возможных значений параметра.   Для этого варианта требуется хорошее понимание оптимальных значений параметров и связанных с ними характеристик плана.
- Использование указания запроса [OPTION (OPTIMIZE FOR UNKNOWN)](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query), чтобы переопределить фактическое значение параметра в обмен на использование среднего значения вектора плотности. Другой способ сделать это – записать входящие значения параметров в локальные переменные, а затем использовать локальные переменные внутри предикатов вместо использования самих параметров. Средняя плотность должна быть *достаточно хорошей* для конкретного исправления.
- Полное отключение сканирования параметров с помощью указания запроса [DISABLE_PARAMETER_SNIFFING](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query).
- Использование указания запроса [KEEPFIXEDPLAN](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query), чтобы избежать перекомпиляции в кэше. Этот метод предполагает, что общий план, который находится в кэше, является *подходящим*. Можно также отключить автоматические обновления статистики, чтобы уменьшить вероятность вытеснения хорошего плана и компиляции неподходящего плана.
- Принудительное применение плана с помощью явного использования указания запроса [USE PLAN](https://docs.microsoft.com/sql/t-sql/queries/hints-transact-sql-query) (посредством явного указания, установки определенного плана с помощью хранилища запросов или включения [автонастройки](sql-database-automatic-tuning.md)).
- Замена одной процедуры вложенным набором процедур, каждая из которых может использоваться на основе условной логики и связанных значений параметров.
- Создание альтернатив выполнения динамической строки для статического определения процедуры.

Дополнительные сведения об устранении проблем такого типа см. в записях блога:

- [Я запахю параметр](https://blogs.msdn.microsoft.com/queryoptteam/2006/03/31/i-smell-a-parameter/)
- [динамическое сравнение SQL и качества плана для параметризованных запросов](https://blogs.msdn.microsoft.com/conor_cunningham_msft/2009/06/03/conor-vs-dynamic-sql-vs-procedures-vs-plan-quality-for-parameterized-queries/)
- [Методы оптимизации запросов SQL в SQL Server: Перехват параметров](https://www.sqlshack.com/query-optimization-techniques-in-sql-server-parameter-sniffing/)

### <a name="troubleshooting-compile-activity-due-to-improper-parameterization"></a>Устранение неполадок компиляции активности из-за неправильной параметризации

Когда в запросе есть литералы, либо ядро ​​базы данных автоматически параметризует инструкцию, либо пользователь явно параметризует ее, чтобы уменьшить количество компиляций. Большое число компиляций для запроса, использующего тот же шаблон, но разные литеральные значения, могут привести к высокой загрузке ЦП. Аналогично, если вы только частично параметризуете запрос, который по-прежнему имеет литералы, ядро ​​базы данных не будет параметризировать его дальше.  Ниже приведен пример частично параметризованного запроса.

```sql
SELECT * 
FROM t1 JOIN t2 ON t1.c1 = t2.c1
WHERE t1.c1 = @p1 AND t2.c2 = '961C3970-0E54-4E8E-82B6-5545BE897F8F'
```

В предыдущем примере принимает `t1.c1` `@p1` , но `t2.c2` в качестве литерала остается идентификатор GUID. В этом случае, если изменить значение для `c2`, запрос будет считаться другим, и возникнет новая компиляция. Чтобы уменьшить количество компиляций в предыдущем примере, рекомендуется также параметризовать идентификатор GUID.

В следующем запросе показано количество запросов хэша для определения того, правильно ли параметризован запрос.

```sql
SELECT  TOP 10  
  q.query_hash
  , count (distinct p.query_id ) AS number_of_distinct_query_ids
  , min(qt.query_sql_text) AS sampled_query_text
FROM sys.query_store_query_text AS qt
  JOIN sys.query_store_query AS q
     ON qt.query_text_id = q.query_text_id
  JOIN sys.query_store_plan AS p 
     ON q.query_id = p.query_id
  JOIN sys.query_store_runtime_stats AS rs 
     ON rs.plan_id = p.plan_id
  JOIN sys.query_store_runtime_stats_interval AS rsi
     ON rsi.runtime_stats_interval_id = rs.runtime_stats_interval_id
WHERE
  rsi.start_time >= DATEADD(hour, -2, GETUTCDATE())
  AND query_parameterization_type_desc IN ('User', 'None')
GROUP BY q.query_hash
ORDER BY count (distinct p.query_id) DESC
```
### <a name="factors-influencing-query-plan-changes"></a>Факторы, влияющие на изменения плана запроса

Повторная компиляция плана выполнения запроса может привести к созданию плана запроса, который отличается от первоначально кэшированного. Существует несколько причин, по которым существующий исходный план может быть автоматически перекомпилирован.
- Изменения в схеме, на которые ссылается запрос
- Изменения данных в таблицах, на которые ссылается запрос 
- Изменения в параметрах контекста запроса 

Скомпилированный план может быть извлечен из кэша по различным причинам, включая перезапуски экземпляра, изменения конфигурации области базы данных, нехватку памяти и явные запросы на очистку кэша. Кроме того, использование подсказки RECOMPILE означает, что план не будет кэшироваться.

Повторная компиляция (или новая компиляция после вытеснения кэша) по-прежнему может привести к созданию идентичного плана выполнения запроса от первоначально наблюдаемого.  Если в плане были внесены изменения по сравнению с предыдущим или исходным планом, ниже приведены наиболее распространенные объяснения по причине изменения плана выполнения запроса.

- **Измененная физическая структура**. Например, были созданы новые индексы, которые более эффективно охватывают требования запроса. Новые индексы могут использоваться для новой компиляции, если оптимизатор запросов решил использовать новый индекс более оптимально, чем использование структуры данных, первоначально выбранной для первой версии выполнения запроса.  Любые физические изменения объектов, на которые имеются ссылки, могут привести к выбору нового плана во время компиляции.

- **Различия в ресурсах сервера**. В сценарии, в котором один план отличается от "система а" и "система B" — доступность ресурсов, таких как количество доступных процессоров, может повлиять на то, какой план будет создан.  Например, если одна система имеет большее количество процессоров, можно выбрать параллельный план. 

- **Разные статистические данные**. Статистика, связанная с упоминаемыми объектами, изменилась или изменяется в отличие от статистики исходной системы.  При изменении статистики и повторной компиляции оптимизатор запросов будет использовать статистику на конкретный момент времени. Измененная статистика может иметь разные распределения данных и частоты, чем исходная компиляция.  Эти изменения используются для оценки оценок количества элементов (количество строк, которые должны проходить через дерево логических запросов).  Изменения в оценке количества элементов могут привести к выбору различных физических операторов и связанных с ними операций.  Даже небольшие изменения статистики могут привести к изменению плана выполнения запроса.

- **Измененный уровень совместимости базы данных или версия средства оценки количества элементов**.  Изменения уровня совместимости базы данных могут включать новые стратегии и функции, которые могут привести к другому плану выполнения запроса.  Помимо уровня совместимости базы данных, отключение или включение флага трассировки 4199 или изменение состояния QUERY_OPTIMIZER_HOTFIXES конфигурации области базы данных также может повлиять на выбор плана выполнения запроса во время компиляции.  Флаги трассировки 9481 (принудительно использовать устаревшие версии CE) и 2312 (принудительно по умолчанию CE) также влияют на план. 

### <a name="resolve-problem-queries-or-provide-more-resources"></a>Устранение проблемных запросов или предоставление дополнительных ресурсов

Определив проблему, вы можете настроить проблемные запросы либо обновить объем вычислительных ресурсов или уровень служб, чтобы увеличить производительность базы данных SQL Azure для снижения требований к ЦП. Сведения о масштабировании ресурсов для отдельной базы данных см. в статье [Масштабирование ресурсов отдельной базы данных в Базе данных SQL Azure](sql-database-single-database-scale.md). Дополнительную информацию о масштабировании ресурсов для эластичных пулов см. в статье [Масштабирование ресурсов эластичного пула в Базе данных SQL Azure](sql-database-elastic-pool-scale.md). Сведения о масштабировании управляемого экземпляра см. в разделе [Ограничения ресурсов на уровне экземпляра](sql-database-managed-instance-resource-limits.md#instance-level-resource-limits).

### <a name="determine-if-running-issues-due-to-increase-workload-volume"></a>Определение того, возникли ли проблемы из-за увеличения объема рабочей нагрузки

Увеличение трафика приложений и рабочей нагрузки может привести к увеличению загрузки ЦП, но эту проблему необходимо правильно диагностировать. В сценарии с высокой загрузкой ЦП ответьте на следующие вопросы, чтобы определить, действительно ли увеличение загрузки ЦП вызвано изменениями объема рабочей нагрузки.

1. Являются ли запросы из приложения причиной проблемы высокой загрузки ЦП?
2. Для запросов, наиболее загружающих ЦП (которые можно определить), сделайте следующее.

   - Определите, связаны ли несколько планов выполнения с одним и тем же запросом. Если это так, определите почему.
   - Для запросов с одним и тем же планом выполнения определите, были ли согласованы времена выполнения и увеличилось ли количество выполнений. Если это так, вероятно, проблемы с производительностью связаны с увеличением рабочей нагрузки.

Таким образом, если план выполнения запроса не выполнялся по-разному, но загрузка ЦП увеличивалась вместе с количеством выполненных операций, вероятно, существует проблема производительности, связанная с увеличением рабочей нагрузки.

Не всегда легко прийти к заключению, что изменение объема рабочей нагрузки является причиной проблемы с ЦП.   Факторы, которые следует учесть. 

- **Изменение использования ресурсов**

  Например, рассмотрим сценарий, в котором загрузка ЦП увеличилась до 80 % на длительный период времени.  Сама по себе загрузка ЦП не означает, что объем рабочей нагрузки изменился.  Регрессии плана выполнения запросов и изменения в распределении данных также могут способствовать большему использованию ресурсов, даже если приложение выполняет точно такую ​​же рабочую нагрузку.

- **Создание нового запроса**

   Приложение может запускать новый набор запросов в разное время.

- **Количество запросов увеличилось или уменьшилось**

   Этот сценарий является наиболее очевидной мерой рабочей нагрузки. Количество запросов не всегда соответствует дополнительному использованию ресурсов. Тем не менее эта метрика является важным сигналом, если предположить, что другие факторы не изменились.

## <a name="waiting-related-performance-issues"></a>Проблемы производительности, связанные с ожиданием

Если вы убедитесь в отсутствии проблемы производительности, связанной с выполнением, с высокой загрузкой ЦП, значит, возникла проблема производительности, связанная с ожиданием. В частности, ресурсы ЦП используются неэффективно, так как ЦП ожидает другой ресурс. В этому случае следующим шагом является определение ресурсов, которых ожидает ЦП. Ниже перечислены наиболее распространенные методы отображения основных категорий типа ожидания.

- [Хранилище запросов](https://docs.microsoft.com/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store) предоставляет статистику времени ожидания на запрос за определенный промежуток времени. В хранилище запросов типы времени ожидания объединены в категории ожидания. Сопоставление категорий времени ожидания с типами доступно в [sys.query_store_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-query-store-wait-stats-transact-sql#wait-categories-mapping-table).
- [sys.dm_db_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-wait-stats-azure-sql-database) возвращает сведения обо всех периодах ожидания потоков, выполнявшихся в ходе операции. Это агрегированное представление может использоваться для диагностики проблем с производительностью базы данных SQL Azure, а также проблем с определенными запросами и пакетами.
- [sys.dm_os_waiting_tasks](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-os-waiting-tasks-transact-sql) возвращает сведения об очереди ожидания задач, которым необходимы некоторые ресурсы.

В сценариях высокой загрузки ЦП хранилище запросов и статистика времени ожидания не всегда отражают использование ЦП по таким двум причинам:

- запросы, потребляющие больше ресурсов ЦП, могут все еще выполняться и быть незавершенными;
- во время выполнения запросов, потребляющих больше ресурсов ЦП, произошла отработка отказа.

Хранилище запросов и динамическое административное представление отслеживания статистики ожидания показывают результаты только успешно выполненных запросов и запросов с превышенным временем ожидания, но не отображают данные инструкций, выполняющихся в данный момент (пока они не завершаться). Динамическое административное представление [sys. DM _exec_requests](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql) позволяет контролировать выполняющиеся в данный момент запросы и связанное время рабочего процесса.

Как показано на предыдущей диаграмме, следующие типы ожидания являются самыми распространенными:

- блокировки;
- ВВОД-ВЫВОД
- Состязания, связанные с `tempdb`
- ожидание временно предоставляемого буфера памяти.

> [!IMPORTANT]
> Сведения о наборе запросов T-SQL, где эти динамические административные представления используются для устранения проблем, связанных с ожиданием, см. в разделе:
>
> - [Поиск проблем производительности операций ввода-вывода](sql-database-monitoring-with-dmvs.md#identify-io-performance-issues)
> - [Поиск проблем производительности `tempdb`](sql-database-monitoring-with-dmvs.md#identify-io-performance-issues)
> - [Определение ожидания временно предоставляемого буфера памяти](sql-database-monitoring-with-dmvs.md#identify-memory-grant-wait-performance-issues)
> - [Тижертулбокс — ожидание и кратковременные блокировки](https://github.com/Microsoft/tigertoolbox/tree/master/Waits-and-Latches)
> - [Тижертулбокс — usp_whatsup](https://github.com/Microsoft/tigertoolbox/tree/master/usp_WhatsUp)

## <a name="improving-database-performance-with-more-resources"></a>Повышение производительности базы данных с помощью дополнительных ресурсов

Наконец, если для базы данных нет применимых рекомендаций по повышению производительности, можно изменить объем ресурсов, доступных в Базе данных SQL Azure. Назначьте дополнительные ресурсы, изменив [уровень служб DTU](sql-database-service-tiers-dtu.md) отдельной базы данных или увеличив edtu пула эластичных БД в любое время. Кроме того, если вы используете [модель приобретения на основе виртуальное ядро](sql-database-service-tiers-vcore.md), измените уровень служб или увеличьте ресурсы, выделенные для базы данных.

1. Для повышения производительности отдельных баз данных можно изменять [уровни служб](sql-database-single-database-scale.md) или объем [вычислительных ресурсов](sql-database-single-database-scale.md) по запросу.
2. Если баз данных несколько, можно включить автомасштабирование ресурсов, используя [пулы эластичных баз данных](sql-database-elastic-pool-guidance.md).

## <a name="tune-and-refactor-application-or-database-code"></a>Настройка и рефакторинг кода приложения или базы данных

Можно изменить код приложения для более оптимального использования базы данных, изменить индексы, принудительно применить планы или с помощью указаний вручную адаптировать базу данных для рабочей нагрузки. Найдите руководство и советы по настройке и перезаписи кода в [разделе руководства по производительности](sql-database-performance-guidance.md) вручную.

## <a name="next-steps"></a>Следующие шаги

- Дополнительные сведения о том, как включить автоматическую настройку в Базе данных SQL Azure и позволить ей полностью управлять рабочей нагрузкой, см. в [этой статье](sql-database-automatic-tuning-enable.md).
- Дополнительные сведения о ручной настройке для повышения производительности запросов см. в статье [Использование помощника по базам данных SQL на портале Azure](sql-database-advisor-portal.md).
- Изменить ресурсы, доступные в базе данных, можно, изменив [уровни служб Базы данных SQL Azure](sql-database-performance-guidance.md).
