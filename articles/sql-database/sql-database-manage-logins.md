---
title: Имена входа и пользователи
description: Сведения об управлении безопасностью баз данных SQL и хранилища данных SQL, в частности о том, как управлять защитой входа в систему и доступа к базе данных с помощью учетной записи субъекта серверного уровня.
keywords: безопасность баз данных SQL, управление безопасностью баз данных, защита входа в систему, безопасность баз данных, доступ к базе данных
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: VanMSFT
ms.author: vanto
ms.reviewer: carlrab
ms.date: 03/26/2019
ms.openlocfilehash: e9934f868fb62f9b1a19ef408dab69ab8a2c0e29
ms.sourcegitcommit: 28688c6ec606ddb7ae97f4d0ac0ec8e0cd622889
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2019
ms.locfileid: "74159152"
---
# <a name="controlling-and-granting-database-access-to-sql-database-and-sql-data-warehouse"></a>Контроль и предоставление доступа к базе данных SQL и хранилищу данных SQL

После настройки правил брандмауэра можно подключиться к [базе данных SQL](sql-database-technical-overview.md) и [хранилищу данных SQL](../sql-data-warehouse/sql-data-warehouse-overview-what-is.md) Azure в качестве одной из учетных записей администратора, владельца или пользователя базы данных в базе данных.  

> [!NOTE]  
> Этот раздел относится к серверу SQL Azure, а также к базам данных SQL и хранилищам данных SQL, созданным на сервере SQL Azure. Для простоты база данных SQL используется как для базы данных SQL, так и для хранилища данных SQL. 
> [!TIP]
> Ознакомьтесь с руководством [Защита базы данных SQL Azure](sql-database-security-tutorial.md). Это руководство не относится к **Управляемому экземпляру Базы данных SQL Azure**.

## <a name="unrestricted-administrative-accounts"></a>Административные учетные записи с неограниченным доступом

В качестве администратора выступают две учетные записи (**администратор сервера** и **администратор Active Directory**). Чтобы определить эти учетные записи администратора для сервера SQL Server, откройте портал Azure и перейдите на вкладку "Свойства" сервера SQL или базы данных SQL.

![Администраторы SQL Server](media/sql-database-manage-logins/sql-admins.png)

- **Администратор сервера**

  При создании сервера Azure SQL Server необходимо назначить **имя для входа администратора сервера**. SQL Server создает эту учетную запись в качестве имени для входа в базе данных master. Эта учетная запись подключается с использованием проверки подлинности SQL Server (с предоставлением имени пользователя и пароля). Может существовать только одна такая учетная запись.

  > [!NOTE]
  > Чтобы сбросить пароль администратора сервера, на [портале Azure](https://portal.azure.com) щелкните **Серверы SQL**, выберите в списке сервер и щелкните **Сбросить пароль**.

- **Администратор Azure Active Directory**

  Одной отдельной учетной записи или учетной записи группы безопасности Azure Active Directory также можно предоставить права администратора. В целом проводить настройку администратора Azure AD необязательно, но если вы хотите использовать учетные записи Azure AD для подключения к базе данных SQL, администратор Azure AD **обязательно** должен быть настроен. Дополнительные сведения о настройке доступа Azure Active Directory см. в статьях [Подключение к базе данных SQL или хранилищу данных SQL c использованием проверки подлинности Azure Active Directory](sql-database-aad-authentication.md) и [Поддержка SSMS в Azure AD MFA для базы данных SQL и хранилища данных SQL](sql-database-ssms-mfa-authentication.md).

Учетные записи администратора **сервера** и **администратора Azure AD** имеют следующие характеристики.

- Это единственные учетные записи, которые могут автоматически подключаться к любой базе данных SQL на сервере. (Для подключения к пользовательской базе данных другие учетные записи должны иметь права владельца базы данных или в пользовательской базе данных должна находиться пользовательская учетная запись.)
- Эти учетные записи входят в пользовательские базы данных в качестве пользователя `dbo`. Они обладают всеми разрешениями в пользовательских базах данных. (Владелец пользовательской базы данных также входит в базу данных в качестве пользователя `dbo`.) 
- Не входят в базу данных `master` в качестве пользователя `dbo`. Для них назначены ограниченные разрешения в базе данных master. 
- **Не** являются членами предопределенной роли `sysadmin` стандартного сервера SQL Server, недоступной в базе данных SQL.  
- Могут создавать, изменять и удалять базы данных, имена для входа, пользователей в базе данных master и правила брандмауэра для IP-адресов на уровне сервера.
- Могут добавлять и удалять членов в ролях `dbmanager` и `loginmanager`.
- Могут просматривать системную таблицу `sys.sql_logins`.
- Не может быть переименован.
- Чтобы изменить учетную запись администратора Azure AD, используйте портал или Azure CLI.
- После этого невозможно изменить учетную запись администратора сервера.

### <a name="configuring-the-firewall"></a>Настройка брандмауэра

Если брандмауэр на уровне сервера настроен для отдельного IP-адреса или диапазона IP-адресов, то **администратор SQL Server** и **администратор Azure Active Directory** смогут подключаться к базе данных master и всем пользовательским базам данных. Первоначальный брандмауэр уровня сервера можно настроить на [портале Azure](sql-database-single-database-get-started.md), с помощью [PowerShell](sql-database-powershell-samples.md) или [REST API](https://msdn.microsoft.com/library/azure/dn505712.aspx). После подключения также можно настроить дополнительные правила брандмауэра для IP-адресов на уровне сервера с помощью инструкции [Transact-SQL](sql-database-configure-firewall-settings.md).

### <a name="administrator-access-path"></a>Путь доступа администратора

При правильной настройке брандмауэра на уровне сервера **администратор SQL Server** и **администратор Azure Active Directory** смогут подключаться с помощью таких клиентских средств, как SQL Server Management Studio или SQL Server Data Tools. Все функции и возможности доступны только в последних версиях средств. На схеме ниже показана типичная конфигурация для двух учетных записей администраторов.

![Настройка двух учетных записей администрирования](./media/sql-database-manage-logins/1sql-db-administrator-access.png)

При использовании открытого порта брандмауэра серверного уровня администраторы могут подключаться к любой базе данных SQL.

### <a name="connecting-to-a-database-by-using-sql-server-management-studio"></a>Подключение к базе данных с помощью SQL Server Management Studio

Пошаговые инструкции по созданию сервера, базы данных, правил брандмауэра протокола IP на уровне сервера и использованию SQL Server Management Studio для отправки запросов к базе данных см. в руководстве [Начало работы с серверами Базы данных SQL Azure, базами данных и правилами брандмауэра с использованием портала Azure и SQL Server Management Studio](sql-database-single-database-get-started.md).

> [!IMPORTANT]
> Чтобы обеспечить синхронизацию с обновлениями Microsoft Azure и Базой данных SQL, рекомендуется всегда использовать последнюю версию Management Studio. [Обновите среду SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).

## <a name="additional-server-level-administrative-roles"></a>Дополнительные административные роли на уровне сервера

>[!IMPORTANT]
>Этот раздел не относится к **Управляемому экземпляру Базы данных SQL Azure**, так как эти роли используются в **Базе данных SQL Azure**.

В дополнение к административным ролям на уровне сервера, обсуждаемым ранее, база данных SQL предусматривает две ограниченные административные роли в базе данных master, к которым можно добавить учетные записи пользователей. Эти роли предоставляют разрешения на создание баз данных или управление входами.

### <a name="database-creators"></a>Создатели баз данных

Одной из этих административных ролей является роль **dbmanager**. Участники этой роли могут создавать базы данных. Чтобы использовать эту роль, создайте пользователя в базе данных `master`, а затем добавьте его к роли базы данных **dbmanager**. Создавать базу данных могут лица, использующие учетные данные SQL Server в базе данных `master`, или пользователи автономной базы данных, на основе пользователя Azure Active Directory.

1. Используя учетную запись администратора, подключитесь к базе данных `master`.
2. Создайте имя для входа при проверке подлинности SQL Server с помощью инструкции [CREATE LOGIN](https://msdn.microsoft.com/library/ms189751.aspx). Пример инструкции:

   ```sql
   CREATE LOGIN Mary WITH PASSWORD = '<strong_password>';
   ```

   > [!NOTE]
   > Создавая имя для входа или пользователя автономной базы данных, используйте надежный пароль. Дополнительные сведения см. в статье [Надежные пароли](https://msdn.microsoft.com/library/ms161962.aspx).

   Для повышения производительности имена для входа (субъекты уровня сервера) временно кэшируются на уровне базы данных. Сведения об обновлении кэша проверки подлинности см. в статье [DBCC FLUSHAUTHCACHE (Transact-SQL)](https://msdn.microsoft.com/library/mt627793.aspx).

3. В базе данных `master` создайте пользователя, выполнив оператор [CREATE USER](https://msdn.microsoft.com/library/ms173463.aspx). Пользователь может быть пользователем автономной базы данных с проверкой подлинности Azure Active Directory (если вы настроили среду для проверки подлинности Azure AD) или пользователя автономной проверки подлинности SQL Server или SQL Server пользователя проверки подлинности на основе SQL Server имя входа для проверки подлинности (созданное на предыдущем шаге). Примеры инструкций:

   ```sql
   CREATE USER [mike@contoso.com] FROM EXTERNAL PROVIDER; -- To create a user with Azure Active Directory
   CREATE USER Ann WITH PASSWORD = '<strong_password>'; -- To create a SQL Database contained database user
   CREATE USER Mary FROM LOGIN Mary;  -- To create a SQL Server user based on a SQL Server authentication login
   ```

4. Добавьте нового пользователя в роль базы данных **dbmanager** в `master` с помощью оператора [ALTER ROLE](https://msdn.microsoft.com/library/ms189775.aspx). Примеры инструкций:

   ```sql
   ALTER ROLE dbmanager ADD MEMBER Mary; 
   ALTER ROLE dbmanager ADD MEMBER [mike@contoso.com];
   ```

   > [!NOTE]
   > Так как dbmanager — это роль базы данных в базе данных master, вы можете назначить роль dbmanager только пользователю базы данных. Невозможно добавить имя входа серверного уровня в роль уровня базы данных.

5. При необходимости настройте правило брандмауэра на уровне сервера, чтобы разрешить подключение новому пользователю. (К новому пользователю может применяться существующее правило брандмауэра.)

Теперь пользователь может подключаться к базе данных `master` и создавать базы данных. Учетная запись, создавшая базу данных, становится владельцем базы данных.

### <a name="login-managers"></a>Диспетчеры входа

Другая административная роль — это роль диспетчера входов. Участники этой роли могут создавать учетные записи в базе данных master. При желании можно выполнить те же действия (создание имени для входа и пользователя и назначение ему роли **loginmanager**), чтобы разрешить пользователю создавать имена для входа в базу данных master. Обычно имена для входа не требуются, так как корпорация Майкрософт рекомендует использовать пользователей автономной базы данных, проверка подлинности которых выполняется на уровне базы данных, а не пользователей с именами для входа. Дополнительные сведения см. в статье [Пользователи автономной базы данных — создание переносимой базы данных](https://msdn.microsoft.com/library/ff929188.aspx).

## <a name="non-administrator-users"></a>Пользователи без прав администратора

Как правило, учетным записям без прав администратора не требуется доступ к базе данных master. Создайте пользователей автономной базы данных на уровне базы данных с помощью инструкции [CREATE USER (Transact-SQL)](https://msdn.microsoft.com/library/ms173463.aspx). Пользователь может быть пользователем автономной базы данных с проверкой подлинности Azure Active Directory (если вы настроили среду для проверки подлинности Azure AD) или пользователя автономной проверки подлинности SQL Server или SQL Server пользователя проверки подлинности на основе SQL Server имя входа для проверки подлинности (созданное на предыдущем шаге). Дополнительные сведения см. в статье [пользователи автономной базы данных — Создание переносимой базы данных](https://msdn.microsoft.com/library/ff929188.aspx). 

Чтобы создать пользователей, подключитесь к базе данных и выполните инструкции, аналогичные приведенным ниже.

```sql
CREATE USER Mary FROM LOGIN Mary; 
CREATE USER [mike@contoso.com] FROM EXTERNAL PROVIDER;
```

Изначально создавать пользователей может только один администратор или владелец базы данных. Чтобы разрешить другим пользователям создавать пользователей, предоставьте выбранному пользователю разрешение `ALTER ANY USER` с помощью следующей инструкции.

```sql
GRANT ALTER ANY USER TO Mary;
```

Чтобы предоставить другим пользователям полный доступ к базе данных, сделайте их участником фиксированной роли базы данных **db_owner**.

Для Базы данных SQL Azure используйте оператор `ALTER ROLE`.

```sql
ALTER ROLE db_owner ADD MEMBER Mary;
```

Для Хранилища данных SQL Azure используйте [EXEC sp_addrolemember](/sql/relational-databases/system-stored-procedures/sp-addrolemember-transact-sql).
```sql
EXEC sp_addrolemember 'db_owner', 'Mary';
```


> [!NOTE]
> Предоставить пользователям доступ к нескольким базам данных — это одна из распространенных причин, по которой нужно создать пользователя базы данных на основе имени входа на сервер Базы данных SQL. Так как пользователи автономной базы данных являются отдельными сущностями, в каждой базе данных поддерживается отдельный пользователь с собственным паролем. Это может вызвать дополнительные сложности, поскольку пользователь должен запомнить отдельный пароль для каждой базы данных, а смена паролей при большом количестве баз данных станет нестерпимо тягостной. Но если использовать имена входа SQL Server и высокий уровень доступности (активной георепликации и групп отработки отказа), эти имена входа потребуется задать вручную на каждом сервере. В противном случае после отработки отказа пользователь базы данных не будет сопоставляться с именем входа на сервере и не сможет получить доступ к базе данных. Дополнительные сведения о настройке имен входа для георепликации см. в статье [Настройка безопасности базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md).

### <a name="configuring-the-database-level-firewall"></a>Настройка брандмауэра на уровне базы данных

Пользователям без прав администратора рекомендуется предоставлять доступ к нужным им базам данных только через брандмауэр. Вместо авторизации их IP-адресов с помощью брандмауэра уровня сервера и предоставления им доступа ко всем базам данных используйте инструкцию [sp_set_database_firewall_rule](https://msdn.microsoft.com/library/dn270010.aspx), чтобы настроить брандмауэр уровня базы данных. С помощью портала нельзя настроить брандмауэр уровня базы данных.

### <a name="non-administrator-access-path"></a>Путь доступа пользователя без прав администратора

При правильной настройке брандмауэра уровня базы данных пользователи базы данных могут подключаться к базе данных с помощью таких клиентских средств, как SQL Server Management Studio или SQL Server Data Tools. Все функции и возможности доступны только в последних версиях средств. На следующей схеме показан типичный путь доступа пользователя без прав администратора.

![Путь доступа пользователя без прав администратора](./media/sql-database-manage-logins/2sql-db-nonadmin-access.png)

## <a name="groups-and-roles"></a>Группы и роли

При эффективном управлении доступом используются разрешения, назначенные группам и ролям, а не отдельным пользователям. 

- При использовании проверки подлинности Azure Active Directory поместите пользователей Azure Active Directory в соответствующую группу. Создайте пользователя автономной базы данных для группы. Поместите одного или нескольких пользователей базы данных в [роль базы данных](https://msdn.microsoft.com/library/ms189121), а затем назначьте [разрешения](https://msdn.microsoft.com/library/ms191291.aspx) для этой роли.

- При использовании проверки подлинности SQL Server создайте пользователей автономной базы данных в базе данных. Поместите одного или нескольких пользователей базы данных в [роль базы данных](https://msdn.microsoft.com/library/ms189121), а затем назначьте [разрешения](https://msdn.microsoft.com/library/ms191291.aspx) для этой роли.

Роли базы данных могут быть встроенными ролями, например **db_owner**, **db_ddladmin**, **db_datawriter**, **db_datareader**, **db_denydatawriter** и **db_denydatareader**. Роль **db_owner** обычно используется для предоставления полных прав ограниченному числу пользователей. Другие фиксированные роли можно использовать для быстрого получения простых баз данных при разработке, но их не рекомендуется использовать для большинства рабочих баз данных. Например, фиксированная роль базы данных **db_datareader** предоставляет доступ (как правило, строго обязательный) на чтение к каждой таблице в базе данных. Рекомендуется использовать инструкцию [CREATE ROLE](https://msdn.microsoft.com/library/ms187936.aspx) , чтобы создавать пользовательские роли базы данных, а затем внимательно предоставлять каждой роли наименьший набор разрешений, необходимый для работы. Если пользователь является участником нескольких ролей, то ему предоставлены разрешения всех этих ролей.

## <a name="permissions"></a>Разрешения

Существует более 100 разрешений, которые можно по отдельности предоставлять или отменять в базе данных SQL. Многие эти разрешения являются частью других разрешений. Например, разрешение `UPDATE` на схеме включает в себя разрешение `UPDATE` для каждой таблицы в этой схеме. Как и в большинстве систем разрешений, отмена разрешения переопределяет предоставление. Так как некоторые разрешения включены в другие разрешения и их достаточно много, необходимо внимательно изучить их, чтобы спроектировать соответствующую систему разрешений, которая будет надежно защищать базу данных. Изучите список разрешений на [этой странице](https://docs.microsoft.com/sql/relational-databases/security/permissions-database-engine) и ознакомьтесь с [графическим представлением](https://docs.microsoft.com/sql/relational-databases/security/media/database-engine-permissions.png) разрешений.


### <a name="considerations-and-restrictions"></a>Рекомендации и ограничения

При управлении учетными записями и пользователями в базе данных SQL необходимо учитывать следующее.

- Для выполнения инструкций **необходимо подключение к базе данных**master`CREATE/ALTER/DROP DATABASE`.   
- Пользователя базы данных, соответствующего имени для входа **администратора сервера**, нельзя изменить или удалить. 
- Языком по умолчанию для имени для входа **администратора сервера** является американский вариант английского языка.
- Только администраторы (имя для входа **администратора сервера** или администратор Azure AD) и участники роли базы данных **dbmanager** в базе данных **master** имеют право выполнять инструкции `CREATE DATABASE` и `DROP DATABASE`.
- Необходимо подключение к базе данных master для выполнения инструкций `CREATE/ALTER/DROP LOGIN` . В то же время использовать имена входа не рекомендуется. Вместо них используйте пользователей автономной базы данных.
- Для подключения к пользовательской базе данных необходимо указать имя базы данных в строке подключения.
- Только имя для входа субъекта уровня сервера и участники роли базы данных **loginmanager** в базе данных **master** имеют разрешение на выполнение инструкций `CREATE LOGIN`, `ALTER LOGIN` и `DROP LOGIN`.
- При выполнении инструкций `CREATE/ALTER/DROP LOGIN` и `CREATE/ALTER/DROP DATABASE` в приложении ADO.NET не разрешается использовать параметризованные команды. Дополнительные сведения можно найти в статье [Команды и параметры](https://msdn.microsoft.com/library/ms254953.aspx).
- При выполнении инструкций `CREATE/ALTER/DROP DATABASE` и `CREATE/ALTER/DROP LOGIN` каждая из них должна быть единственной инструкцией в пакете Transact-SQL. В противном случае возникает ошибка. Например, следующая инструкция Transact-SQL проверяет существование базы данных. Если она существует, то вызывается инструкция `DROP DATABASE` для удаления базы данных. Так как инструкция `DROP DATABASE` не является единственной инструкцией в пакете, выполнение этой инструкции Transact-SQL приводит к ошибке.

  ```sql
  IF EXISTS (SELECT [name]
           FROM   [sys].[databases]
           WHERE  [name] = N'database_name')
  DROP DATABASE [database_name];
  GO
  ```
  
  Вместо этого используйте следующую инструкцию Transact-SQL:
  
  ```sql
  DROP DATABASE IF EXISTS [database_name]
  ```

- Если применяется инструкция `CREATE USER` с параметром `FOR/FROM LOGIN`, то она должна быть единственной инструкцией в пакете Transact-SQL.
- Если применяется инструкция `ALTER USER` с параметром `WITH LOGIN`, то она должна быть единственной инструкцией в пакете Transact-SQL.
- Для выполнения инструкций `CREATE/ALTER/DROP` пользователю требуется разрешение `ALTER ANY USER` для базы данных.
- Если владелец роли базы данных пытается добавить или удалить другого пользователя базы данных в роль или из роли базы данных, может произойти следующая ошибка: **В этой базе данных не существует пользователь или роль "Имя".** Эта ошибка возникает, поскольку данный пользователь не является видимым для владельца. Чтобы устранить эту проблему, предоставьте владельцу роли разрешение `VIEW DEFINITION` по отношению к данному пользователю. 


## <a name="next-steps"></a>Дополнительная информация

- Общие сведения о правилах брандмауэра см. в статье [Обзор правил брандмауэра Базы данных SQL Azure](sql-database-firewall-configure.md).
- Обзор всех функций защиты в базе данных SQL см. в [этой статье](sql-database-security-overview.md).
- Ознакомьтесь с руководством [Защита базы данных SQL Azure](sql-database-security-tutorial.md).
- Сведения о представлениях и хранимых процедурах см. в статье [Создание представлений и хранимых процедур](https://msdn.microsoft.com/library/ms365311.aspx).
- Сведения о предоставлении доступа к объекту базы данных см. в [этой статье](https://msdn.microsoft.com/library/ms365327.aspx).
