---
title: Средства контроля сетевого доступа
description: Обзор управления доступом к сети для базы данных и хранилища данных SQL Azure для управления доступом и настройки отдельной базы данных или в составе пула.
services: sql-database
ms.service: sql-database
ms.subservice: security
titleSuffix: Azure SQL Database and SQL Data Warehouse
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: rohitnayakmsft
ms.author: rohitna
ms.reviewer: vanto
ms.date: 03/09/2020
ms.openlocfilehash: 822fab5c00501d415c3c184587141e869523e417
ms.sourcegitcommit: 8f4d54218f9b3dccc2a701ffcacf608bbcd393a6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2020
ms.locfileid: "78945380"
---
# <a name="azure-sql-database-and-data-warehouse-network-access-controls"></a>Управление доступом к сети для базы данных SQL Azure и хранилища данных

> [!NOTE]
> Эта статья относится к Azure SQL Server, а также к базам данных SQL и хранилища данных SQL, создаваемым на сервере SQL Azure. Для простоты база данных SQL используется как для базы данных SQL, так и для хранилища данных SQL.

> [!IMPORTANT]
> Эта статья *не* относится к **Управляемому экземпляру Базы данных SQL Azure**. Дополнительные сведения о конфигурации сети см. в разделе [Подключение к управляемый экземпляр](sql-database-managed-instance-connect-app.md) .

При создании нового SQL Server Azure из [портал Azure](sql-database-single-database-get-started.md)результат представляет собой общедоступную конечную точку в формате *yourservername.Database.Windows.NET*.

Чтобы выборочно разрешить доступ к базе данных SQl через общедоступную конечную точку, можно использовать следующие элементы управления доступом к сети:
- Разрешить службы Azure. Если задано значение ON, другие ресурсы в границах Azure, например виртуальная машина Azure, могут получить доступ к базе данных SQL.

- Правила брандмауэра IP-адресов. Используйте эту функцию, чтобы явно разрешить подключения с определенного IP-адреса, например с локальных компьютеров.

Вы также можете разрешить закрытый доступ к базе данных SQL из [виртуальных сетей](../virtual-network/virtual-networks-overview.md) с помощью:
- Правила брандмауэра виртуальной сети: Используйте эту функцию, чтобы разрешить трафик из определенной виртуальной сети в границах Azure.

- Частная ссылка: Используйте эту функцию, чтобы создать частную конечную точку для Azure SQL Server в определенной виртуальной сети.



Более подробное описание этих элементов управления доступом и их действия см. в приведенном ниже видео.
> [!VIDEO https://channel9.msdn.com/Shows/Data-Exposed/Data-Exposed--SQL-Database-Connectivity-Explained/player?WT.mc_id=dataexposed-c9-niner]


## <a name="allow-azure-services"></a>Разрешить службы Azure 
При создании нового SQL Server Azure [из портал Azure](sql-database-single-database-get-started.md)этот параметр остается неустановленным.



Этот параметр можно также изменить через панель брандмауэра после создания SQL Server Azure, как показано ниже.
  
 ![Снимок экрана: Управление брандмауэром сервера][2]

Если задано значение **в** SQL Server Azure, обеспечивается передача данных из всех ресурсов в пределах границы Azure, которые могут быть или не входить в вашу подписку.

Во многих случаях параметр **On** имеет больше разрешений, чем требуется большинству клиентов. Им может потребоваться установить значение **Off** и заменить его на более ограниченные правила брандмауэра IP-адресов или правила брандмауэра виртуальной сети. Это влияет на следующие функции, выполняемые на виртуальных машинах в Azure, которые не входят в виртуальную сеть и поэтому подключаются к базе данных SQL через IP-адрес Azure.

### <a name="import-export-service"></a>Служба импорта и экспорта
Служба импорта и экспорта не работает, **разрешая службам Azure доступ к серверу** со значением OFF. Однако эту проблему можно решить [, вручную запустив SqlPackage. exe из виртуальной машины Azure или выполнив экспорт](https://docs.microsoft.com/azure/sql-database/import-export-from-vm) непосредственно в коде с помощью API DACFx.

### <a name="data-sync"></a>Синхронизация данных
Чтобы использовать функцию синхронизации данных с параметром **Разрешить службам Azure доступ к серверу** , необходимо создать отдельные записи правил брандмауэра, чтобы [Добавить IP-адреса](sql-database-server-level-firewall-rule.md) из **тега службы SQL** для региона, в котором размещена база данных- **концентратор** .
Добавьте эти правила брандмауэра на уровне сервера на логические серверы, на которых размещены базы данных- **концентраторы** и **элементы** (которые могут находиться в разных регионах).

Используйте следующий сценарий PowerShell для создания IP-адресов, соответствующих тегу службы SQL для региона "Западная часть США".
```powershell
PS C:\>  $serviceTags = Get-AzNetworkServiceTag -Location eastus2
PS C:\>  $sql = $serviceTags.Values | Where-Object { $_.Name -eq "Sql.WestUS" }
PS C:\> $sql.Properties.AddressPrefixes.Count
70
PS C:\> $sql.Properties.AddressPrefixes
13.86.216.0/25
13.86.216.128/26
13.86.216.192/27
13.86.217.0/25
13.86.217.128/26
13.86.217.192/27
```

> [!TIP]
> Командлет Get-Азнетворксервицетаг Возвращает глобальный диапазон для тега службы SQL, несмотря на указание параметра location. Не забудьте отфильтровать его в регионе, где размещена база данных центра, используемая группой синхронизации.

Обратите внимание, что выходные данные скрипта PowerShell находятся в нотации с использованием междоменной маршрутизации (CIDR), и ее необходимо преобразовать в формат начального и конечного IP-адреса с помощью [жет-ипранжестартенд. ps1](https://gallery.technet.microsoft.com/scriptcenter/Start-and-End-IP-addresses-bcccc3a9) следующим образом.
```powershell
PS C:\> Get-IPrangeStartEnd -ip 52.229.17.93 -cidr 26                                                                   
start        end
-----        ---
52.229.17.64 52.229.17.127
```

Выполните следующие дополнительные действия, чтобы преобразовать все IP-адреса из CIDR в формат начального и конечного IP-адресов.

```powershell
PS C:\>foreach( $i in $sql.Properties.AddressPrefixes) {$ip,$cidr= $i.split('/') ; Get-IPrangeStartEnd -ip $ip -cidr $cidr;}                                                                                                                
start          end
-----          ---
13.86.216.0    13.86.216.127
13.86.216.128  13.86.216.191
13.86.216.192  13.86.216.223
```
Теперь можно добавить их как отдельные правила брандмауэра, а затем установить параметр **Разрешить службам Azure доступ к серверу** .


## <a name="ip-firewall-rules"></a>Правила брандмауэра для IP-адресов
Брандмауэр на основе IP-адреса — это функция SQL Server Azure, которая предотвращает доступ к серверу базы данных до тех пор, пока вы явно не [добавите IP-адреса](sql-database-server-level-firewall-rule.md) клиентских компьютеров.


## <a name="virtual-network-firewall-rules"></a>Правила брандмауэра виртуальной сети

Кроме правил IP, брандмауэр SQL Server Azure позволяет определять *правила виртуальной сети*.  
Дополнительные сведения см. в статье [конечные точки и правила службы виртуальной сети для базы данных SQL Azure](sql-database-vnet-service-endpoint-rule-overview.md) или просмотрите это видео:

> [!VIDEO https://channel9.msdn.com/Shows/Data-Exposed/Data-Exposed--Demo--Vnet-Firewall-Rules-for-SQL-Database/player?WT.mc_id=dataexposed-c9-niner]

 ### <a name="azure-networking-terminology"></a>Терминология сети Azure  
При просмотре правил брандмауэра виртуальной сети учитывайте следующие термины сети Azure.

**Виртуальная сеть:** С подпиской Azure могут быть связаны виртуальные сети. 

**Подсеть**. Виртуальная сеть содержит **подсети**. Все ваши виртуальные машины Azure назначены в подсети. Одна подсеть может содержать несколько виртуальных машин или других вычислительных узлов. Вычислительные узлы, которые находятся вне вашей виртуальной сети, не имеют доступа к ней, если только не настроить систему безопасности таким образом, чтобы предоставить им доступ.

**Конечные точки служб для виртуальной сети**. [Конечная точка службы для виртуальной сети](../virtual-network/virtual-network-service-endpoints-overview.md) — это подсеть, значения свойств которой включают в себя одно или несколько формальных имен типов службы Azure. В этой статье мы рассмотрим тип **Microsoft.Sql**, который относится к службе Azure, которая называется Базой данных SQL.

**Правило виртуальной сети**. Правило виртуальной сети для сервера Базы данных SQL — это подсеть, которая указана в списке управления доступом (ACL) сервера Базы данных SQL. Для включения в ACL для базы данных SQL подсеть должна содержать имя типа **Microsoft.Sql**. Правило виртуальной сети предписывает серверу Базы данных SQL принимать подключения от всех узлов, находящихся в подсети.


## <a name="ip-vs-virtual-network-firewall-rules"></a>Правила брандмауэра IP-адреса и виртуальной сети

Брандмауэр SQL Server Azure позволяет указать диапазоны IP-адресов, из которых сообщения принимаются в базу данных SQL. Эта методика хорошо подходит для постоянных IP-адресов, которые находятся за пределами частной сети Azure. Однако виртуальные машины в частной сети Azure настроены с использованием *динамических* IP-адресов. Динамические IP-адреса могут измениться после перезапуска виртуальной машины и, в свою очередь, сделать недействительным правило брандмауэра на основе IP-адресов. Было бы неразумно указывать динамический IP-адрес в правиле брандмауэра в рабочей среде.

Это ограничение можно обойти, получая *статический* IP-адрес для виртуальной машины. Дополнительные сведения см. [в статье Настройка частных IP-адресов для виртуальной машины с помощью портал Azure](../virtual-network/virtual-networks-static-private-ip-arm-pportal.md). Однако применение статических IP-адресов может усложнить управление и создать дополнительные расходы при увеличении масштаба среды. 

Правила виртуальной сети проще устанавливать и управлять доступом из определенной подсети, содержащей ваши виртуальные машины.

> [!NOTE]
> Пока еще невозможно разместить базу данных SQL в подсети. Если сервер Базы данных SQL Azure был узлом в подсети виртуальной сети, то все узлы в этой виртуальной сети могли взаимодействовать с базой данных SQL. В этом случае виртуальные машины могли взаимодействовать с базой данных SQL без необходимости в каких-либо правилах виртуальной сети или правилах фильтрации IP-адресов.

## <a name="private-link"></a>Приватный канал 
Частная ссылка позволяет подключаться к Azure SQL Server через **закрытую конечную точку**. Частная конечная точка — это частный IP-адрес в определенной [виртуальной сети](../virtual-network/virtual-networks-overview.md) и подсети.

## <a name="next-steps"></a>Дальнейшие действия

- Краткое руководство по созданию правила брандмауэра IP на уровне сервера см. в статье [Создание базы данных SQL Azure](sql-database-single-database-get-started.md).

- Краткое руководство по созданию правила брандмауэра виртуальной сети на уровне сервера см. в статье [конечные точки и правила службы виртуальных сетей для базы данных SQL Azure](sql-database-vnet-service-endpoint-rule-overview.md).

- Дополнительные сведения о подключении к базе данных SQL Azure из приложений с открытым кодом или сторонними приложениями см. [в статье примеры кода для быстрого запуска клиента в базе данных SQL](https://msdn.microsoft.com/library/azure/ee336282.aspx).

- Дополнительные сведения о портах, которые, возможно, потребуется открыть, см. в разделе **Снаружи или внутри** статьи [Порты для ADO.NET 4.5, отличные от порта 1433](sql-database-develop-direct-route-ports-adonet-v12.md).

- Общие сведения о подключении к базе данных SQL Azure см. в статье [Архитектура подключения к SQL Azure](sql-database-connectivity-architecture.md) .

- Общие сведения о методах защиты в Базе данных SQL Azure см. в [этой статье](sql-database-security-overview.md).

<!--Image references-->
[1]: ./media/sql-database-get-started-portal/new-server2.png
[2]: ./media/sql-database-get-started-portal/manage-server-firewall.png

