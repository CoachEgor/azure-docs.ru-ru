---
title: Автоматическое геоизбыточное резервное копирование
description: База данных SQL автоматически создает локальную резервную копию базы данных каждые пять минут и использует геоизбыточное хранилище Azure с доступом на чтение для обеспечения геоизбыточности.
services: sql-database
ms.service: sql-database
ms.subservice: backup-restore
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, carlrab, danil
manager: craigg
ms.date: 12/13/2019
ms.openlocfilehash: f460bc3e4809b8a1cbabe1161c888255a7a484db
ms.sourcegitcommit: 76bc196464334a99510e33d836669d95d7f57643
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/12/2020
ms.locfileid: "77157522"
---
# <a name="automated-backups"></a>Автоматическое резервное копирование

База данных SQL автоматически создает резервные копии базы данных, которые хранятся на протяжении заданного срока хранения, и использует [геоизбыточное хранилище с доступом на чтение Azure (RA-GRS)](../storage/common/storage-redundancy.md) , чтобы гарантировать их сохранность, даже если центр обработки данных недоступен. Эти резервные копии создаются автоматически. Резервные копии базы данных являются важной частью любой стратегии непрерывности бизнес-процессов и аварийного восстановления, так как они защищают данные от случайного повреждения или удаления. Если для правил безопасности требуется, чтобы резервные копии были доступны в течение продолжительного периода времени (до 10 лет), можно настроить [долгосрочное хранение](sql-database-long-term-retention.md) в одноэлементных базах данных и пулах эластичных БД.

[!INCLUDE [GDPR-related guidance](../../includes/gdpr-intro-sentence.md)]

## <a name="what-is-a-sql-database-backup"></a>Резервная копия базы данных SQL

База данных SQL использует технологию SQL Server для создания [полных резервных копий](https://docs.microsoft.com/sql/relational-databases/backup-restore/full-database-backups-sql-server) каждую неделю, [разностные резервные копии](https://docs.microsoft.com/sql/relational-databases/backup-restore/differential-backups-sql-server) каждые 12 часов и [резервные копии журналов транзакций](https://docs.microsoft.com/sql/relational-databases/backup-restore/transaction-log-backups-sql-server) каждые 5-10 минут. Резервные копии хранятся в [хранилищах данных RA-GRS](../storage/common/storage-redundancy.md) , которые реплицируются в [парный центр обработки](../best-practices-availability-paired-regions.md) данных для защиты от сбоя центра обработки данных. При восстановлении базы данных служба сама определяет, какие резервные копии (полные, разностные или резервные копии журналов транзакций) следует восстановить.

Эти резервные копии позволяют выполнить следующие операции:

- **Восстановите существующую базу данных до точки во времени в прошлом** в течение срока хранения с помощью портал Azure, Azure PowerShell, Azure CLI или REST API. В одной базе данных и эластичных пулах эта операция создаст новую базу данных на том же сервере, что и исходная база данных. В Управляемый экземпляр эта операция может создать копию базы данных или ту же или другую Управляемый экземпляр в той же подписке.
- **Восстановление удаленной базы данных до момента ее удаления** или в любое время в течение срока хранения. Удаленную базу данных можно восстановить только на том же логическом сервере или Управляемый экземпляр, где была создана исходная база данных.
- **Восстановление базы данных в другой географический регион**. Геовосстановление позволяет выполнить восстановление после сбоя в регионе при отсутствии доступа к серверу и базе данных. В результате создается база данных на любом существующем сервере в любой точке мира.
- **Восстановление базы данных из определенной долгосрочной резервной копии** на отдельная база данных или эластичный пул, если для базы данных настроена политика долгосрочного хранения (LTR). LTR позволяет восстановить старую версию базы данных с помощью [портал Azure](sql-database-long-term-backup-retention-configure.md#using-azure-portal) или [Azure PowerShell](sql-database-long-term-backup-retention-configure.md#using-powershell) для удовлетворения запроса на соответствие или запуска старой версии приложения. Дополнительные сведения см. в статье [Storing Azure SQL Database Backups for up to 10 years](sql-database-long-term-retention.md) (Хранение резервных копий баз данных SQL Azure до 10 лет).
- Инструкции по восстановлению см. в статье о [восстановлении базы данных из резервной копии](sql-database-recovery-using-backups.md).

> [!NOTE]
> В службе хранилища Azure термин *репликация* обозначает копирование файлов из одного расположения в другое. *Репликация базы данных SQL* означает хранение нескольких баз данных-получателей, синхронизированных с основной базой данных.

Некоторые из этих операций можно выполнить с помощью следующих примеров.

| | Портал Azure | Azure PowerShell |
|---|---|---|
| Изменение срока хранения резервной копии | [отдельная база данных](sql-database-automated-backups.md?tabs=managed-instance#change-pitr-backup-retention-period-using-azure-portal) <br/> [Управляемый экземпляр](sql-database-automated-backups.md?tabs=managed-instance#change-pitr-backup-retention-period-using-azure-portal) | [отдельная база данных](sql-database-automated-backups.md#change-pitr-backup-retention-period-using-powershell) <br/>[Управляемый экземпляр](https://docs.microsoft.com/powershell/module/az.sql/set-azsqlinstancedatabasebackupshorttermretentionpolicy) |
| Изменение долгосрочного хранения резервных копий | [Отдельная база данных](sql-database-long-term-backup-retention-configure.md#configure-long-term-retention-policies)<br/>Управляемый экземпляр-н/д  | [отдельная база данных](sql-database-long-term-backup-retention-configure.md)<br/>Управляемый экземпляр-н/д  |
| Восстановление базы данных с точки во времени | [Отдельная база данных](sql-database-recovery-using-backups.md#point-in-time-restore) | [Отдельная база данных](https://docs.microsoft.com/powershell/module/az.sql/restore-azsqldatabase) <br/> [Управляемый экземпляр](https://docs.microsoft.com/powershell/module/az.sql/restore-azsqlinstancedatabase) |
| Восстановление удаленной базы данных | [Отдельная база данных](sql-database-recovery-using-backups.md) | [Отдельная база данных](https://docs.microsoft.com/powershell/module/az.sql/get-azsqldeleteddatabasebackup) <br/> [Управляемый экземпляр](https://docs.microsoft.com/powershell/module/az.sql/get-azsqldeletedinstancedatabasebackup)|
| Восстановление базы данных из хранилища BLOB-объектов Azure | Отдельная база данных — н/д <br/>Управляемый экземпляр-н/д  | Отдельная база данных — н/д <br/>[Управляемый экземпляр](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-get-started-restore) |


## <a name="backup-frequency"></a>Частота резервного копирования

### <a name="point-in-time-restore"></a>Восстановление на момент времени

База данных SQL поддерживает самообслуживание для восстановления на момент времени (PITR) путем автоматического создания полной резервной копии, разностных резервных копий и резервных копий журналов транзакций. Полные резервные копии базы данных создаются каждую неделю, разностные резервные копии — как правило, каждые 12 часов, а резервные копии журналов транзакций создаются каждые 5 – 10 минут. Периодичность архивации зависит от объема вычислительных ресурсов и числа действий, производимых с базой данных. Первое полное резервное копирование планируется сразу после создания базы данных. Обычно оно занимает не более 30 минут, но для базы данных большого размера может потребоваться больше времени. Например, начальное резервное копирование будет выполняться дольше для восстановленной базы данных или копии базы данных. После первого полного резервного копирования все последующие операции резервного копирования планируются автоматически и управляются без участия пользователя в фоновом режиме. Точное время создания всех копий базы данных определяет служба Базы данных SQL с учетом распределения общей рабочей нагрузки в системе. Нельзя изменить или отключить задания резервного копирования.

Резервные копии PITR защищены географически избыточным хранилищем. Дополнительные сведения см. в статье [избыточность службы хранилища Azure](../storage/common/storage-redundancy.md).

Дополнительную информацию см. в статье [Восстановление до точки во времени](sql-database-recovery-using-backups.md#point-in-time-restore).

### <a name="long-term-retention"></a>Длительный период удержания

Изолированные базы данных и базы данных в пуле предоставляют возможность настройки долгосрочного хранения (LTR) полных резервных копий до 10 лет в хранилище BLOB-объектов Azure. Если политика LTR включена, еженедельные полные резервные копии автоматически копируются в другой контейнер геоизбыточного хранилища с доступом на чтение. Чтобы удовлетворять различные требования к соответствию, вы можете выбрать разные периоды хранения для резервных копий, создаваемых еженедельно, ежемесячно или ежегодно. Использование хранилища зависит от частоты резервного копирования и периода хранения. Вы можете использовать [калькулятор цен LTR](https://azure.microsoft.com/pricing/calculator/?service=sql-database), чтобы определить стоимость долгосрочного хранения резервных копий.

Как и PITR, резервные копии LTR защищены геоизбыточным хранилищем. Дополнительные сведения см. в статье [избыточность службы хранилища Azure](../storage/common/storage-redundancy.md).

Дополнительные сведения см. в разделе [Долгосрочное хранение резервных копий](sql-database-long-term-retention.md).

## <a name="backup-storage-consumption"></a>Использование хранилища резервных копий 

Для отдельных баз данных общее использование хранилища резервных копий вычисляется следующим образом:   
`Total backup storage size = (size of full backups + size of differential backups + size of log backups) – database size`.

Для эластичных пулов суммарный размер хранилища резервных копий вычисляется на уровне пула и вычисляется следующим образом:   
`Total backup storage size = (total size of all full backups + total size of all differential backups + total size of all log backups) - allocated pool data storage`. 

Резервные копии, которые старше срока хранения, автоматически очищаются на основе их метки времени. Так как для разностных резервных копий и резервных копий журналов требуется более ранняя полная резервная копия, они удаляются вместе в еженедельные фрагменты. 

База данных SQL Azure вычислит общий объем хранения резервных копий в виде совокупного значения. Каждый час это значение передается в конвейер выставления счетов Azure, который отвечает за агрегирование этого почасового использования для вычисления потребления в конце каждого месяца. После удаления базы данных потребление уменьшается по возрасту резервных копий. После того как резервное копирование будет предшествовать сроку хранения, выставление счетов прекращается. 


### <a name="monitoring-consumption"></a>Мониторинг использования

Каждый тип резервной копии (полная, разностная и журнал) отображается в колонке "мониторинг базы данных" как отдельная метрика. На следующей схеме показано, как отслеживать потребление хранилища резервных копий.  

![Мониторинг потребления резервной копии базы данных в колонке "мониторинг базы данных" портал Azure](media/sql-database-automated-backup/backup-metrics.png)

### <a name="fine-tune-the-backup-storage-consumption"></a>Точная настройка использования хранилища резервных копий

Избыточное потребление хранилища резервных копий будет зависеть от рабочей нагрузки и размера отдельных баз данных. Вы можете реализовать некоторые из следующих методов настройки, чтобы еще больше сократить потребление хранилища резервных копий:

* Сократите [срок хранения резервных копий](#change-pitr-backup-retention-period-using-azure-portal) до минимально возможной потребности.
* Избегайте выполнения больших операций записи чаще, чем требуется, например для пересборки индекса.
* Для операций загрузки больших данных рекомендуется использовать [кластеризованные индексы columnstore](https://docs.microsoft.com/sql/database-engine/using-clustered-columnstore-indexes), сократить число некластеризованных индексов, а также рассмотреть операции групповой загрузки с числом строк около 1 000 000.
* На уровне служб общего назначения подготовленное хранилище данных менее затратно, чем стоимость избыточного хранилища резервных копий из-за того, что клиенты с непрерывными высокими затратами на хранение резервных копий могут увеличить объем хранилища данных, чтобы сэкономить на хранилище резервных копий.
* Используйте TempDB в логике ETL для хранения временных результатов вместо постоянных таблиц (применимо только к управляемому экземпляру).
* Рассмотрите возможность отключения шифрования TDE для баз данных, которые не содержат конфиденциальные данные (например, базы данных для разработки или тестирования). Резервные копии для незашифрованных баз данных обычно сжимаются с более высоким коэффициентом сжатия.

> [!IMPORTANT]
> Для аналитики "киоск данных \ рабочие нагрузки хранилища данных" настоятельно рекомендуется использовать [кластеризованные индексы columnstore](https://docs.microsoft.com/sql/database-engine/using-clustered-columnstore-indexes), сократить число некластеризованных индексов, а также рассмотреть операции групповой загрузки со счетчиком строк около 1 000 000, чтобы уменьшить объем избыточного хранилища резервных копий.


## <a name="storage-costs"></a>Затраты на хранение


### <a name="dtu-model"></a>Модель DTU

Дополнительная плата за хранилище резервных копий для баз данных и эластичных пулов с использованием модели DTU не взимается. 

### <a name="vcore-model"></a>Модель с виртуальными ядрами

Для отдельных баз данных минимальный объем хранилища резервных копий, равный 100% размера базы данных, предоставляется без дополнительной платы. Для эластичных пулов и управляемых экземпляров минимальный объем хранилища резервных копий, равный 100% от размера выделенного хранилища данных для пула или экземпляра, соответственно, предоставляется без дополнительной платы. Плата за дополнительное пространство хранилища резервных копий будет взиматься за количество ГБ в месяц. Это дополнительное потребление будет зависеть от рабочей нагрузки и размера отдельных баз данных.

База данных SQL Azure вычислит общий объем хранения резервных копий в виде совокупного значения. Каждый час это значение передается в конвейер выставления счетов Azure, который отвечает за агрегирование этого почасового использования для получения потребления в конце каждого месяца. После удаления базы данных мы уменьшаем потребление в течение срока хранения резервных копий. Когда они станут более старыми, чем срок хранения, выставление счетов прекращается. Так как все резервные копии журналов и разностные резервные копии хранятся в течение полного срока хранения, базы данных, которые сильно изменяются, будут иметь более высокие затраты на резервное копирование. 

Предположим, что база данных накоплена на 744 ГБ хранилища резервных копий, и эта сумма остается постоянной в течение всего месяца. Чтобы преобразовать это совокупное потребление хранилища в почасовое использование, мы разделите его на 744,0 (31 день в месяц * 24 часа в день). Таким результатом, база данных SQL будет сообщать о том, что каждый час использует 1 ГБ резервной копии PITR. Служба "выставление счетов Azure" выполнит статистическую обработку и покажет использование 744 ГБ на весь месяц и расходы на основе ставки $/ГБ/МО в вашем регионе. 

Теперь более сложный пример. Предположим, что срок хранения базы данных увеличился до 14 дней в середине месяца, и это (гипотетические) приводит к увеличению общего объема хранилища резервных копий с удвоением до 1488 ГБ. База данных SQL будет сообщать об использовании в течение 1-372 ГБ, а затем сообщать об использовании как 2 ГБ в течение 373-744 часов. Это значение будет объединено в качестве окончательного счета 1116 Гб/мес. 

Вы можете использовать анализ затрат по подписке Azure для определения текущих расходов на хранилище резервных копий.

![Анализ затрат на хранилище резервных копий](./media/sql-database-automated-backup/check-backup-storage-cost-sql-mi.png)

Например, чтобы понять затраты на хранение резервных копий для управляемого экземпляра, перейдите в подписку в портал Azure и откройте колонку анализ затрат. Выберите Подкатегория Счетчик **MI pitr резервное хранилище** , чтобы просмотреть текущую стоимость резервного копирования и прогноз расходов. Можно также включить другие подкатегории измерения, такие как **Общее назначение управляемого экземпляра — хранилище** или **управляемый экземпляр общее назначение — COMPUTE го поколения** для сравнения стоимости хранения резервных копий с другими категориями затрат.

## <a name="backup-retention"></a>Хранение резервных копий

Все базы данных SQL Azure (отдельные, пулы и управляемые экземпляры) имеют стандартный срок хранения резервных копий в **семь** дней. [Срок хранения резервных копий можно изменить до 35 дней](#change-pitr-backup-retention-period).

При удалении базы данных резервные копии для базы данных SQL будут храниться точно так же, как и для базы данных в Интернете. Например, если вы удалите базу данных уровня "Базовый" с периодом хранения семь дней, резервная копия, хранящаяся четыре дня, будет храниться еще три дня.

Если вам нужно сохранить резервные копии на более долгий срок по сравнению с максимальным периодом хранения, вы можете изменить свойства резервной копии, добавив в базу данных один или несколько периодов долгосрочного хранения. Дополнительные сведения см. в статье [Storing Azure SQL Database Backups for up to 10 years](sql-database-long-term-retention.md) (Хранение резервных копий баз данных SQL Azure до 10 лет).

> [!IMPORTANT]
> Если вы удаляете сервер SQL Azure, на котором размещены базы данных SQL, то все эластичные пулы и базы данных, находящиеся на этом сервере, также будут удалены без возможности восстановления. Удаленный сервер восстановить невозможно. Но если вы настроили долгосрочное хранение, резервные копии баз данных с LTR не будут удалены, и вы сможете восстановить эти базы данных.

## <a name="encrypted-backups"></a>Зашифрованные резервные копии

Если база данных зашифрована с использованием прозрачного шифрования, резервные копии, включая резервные копии LTR, будут автоматически шифроваться при хранении. Когда для базы данных Azure SQL включено прозрачное шифрование данных, также шифруются резервные копии. Прозрачное шифрование данных включено по умолчанию для всех новых баз данных SQL Azure. Дополнительные сведения о прозрачном шифровании данных см. в статье [Прозрачное шифрование данных в базе данных SQL Azure](/sql/relational-databases/security/encryption/transparent-data-encryption-azure-sql).

## <a name="backup-integrity"></a>Целостность резервной копии

На постоянной основе группа инженеров по базам данных SQL Azure автоматически проверяет восстановление резервных копий баз данных, размещенных на логических серверах и эластичных пулах (это недоступно в Управляемый экземпляр). При восстановлении до точки во времени базы данных также получают проверки целостности с помощью DBCC CHECKDB.

Управляемый экземпляр автоматически выполняет начальную архивацию с `CHECKSUM` баз данных, восстановленных с помощью собственной `RESTORE` команды или службы миграции данных после завершения миграции.

При обнаружении ошибок в процессе проверки целостности команда разработки получает оповещения. Дополнительные сведения о целостности данных в службе "База данных SQL Azure" см. в [этой записи блога](https://azure.microsoft.com/blog/data-integrity-in-azure-sql-database/).

## <a name="compliance"></a>Соответствие нормативным требованиям

При переносе базы данных с уровня служб на основе DTU на уровень служб на основе виртуальное ядро сохраняется сохранение PITR, чтобы гарантировать, что политика восстановления данных вашего приложения не будет скомпрометирована. Если период хранения по умолчанию не соответствует вашим требованиям соответствия, вы можете изменить период хранения PITR с помощью PowerShell или REST API. Дополнительные сведения см. в разделе [Как изменить период хранения резервной копии](#change-pitr-backup-retention-period).

[!INCLUDE [GDPR-related guidance](../../includes/gdpr-intro-sentence.md)]

## <a name="change-pitr-backup-retention-period"></a>Изменить срок хранения резервной копии PITR

Вы можете изменить срок хранения резервной копии PITR по умолчанию с помощью портал Azure, PowerShell или REST API. В следующих примерах показано, как установить период хранения PITR на 28 дней.

> [!WARNING]
> Если сократить текущий срок хранения, все существующие резервные копии старше нового срока хранения больше не будут доступны. Если увеличить текущий период хранения, то база данных SQL будет хранить существующие резервные копии до достижения нового установленного периода хранения.

> [!NOTE]
> Эти API-интерфейсы влияют только на период хранения PITR. Если для базы данных настроено LTR, оно не будет затронуто. Дополнительные сведения о том, как изменить период хранения LTR, см. в статье [Хранение резервных копий базы данных SQL Azure до 10 лет](sql-database-long-term-retention.md).

### <a name="change-pitr-backup-retention-period-using-azure-portal"></a>Изменить срок хранения резервной копии PITR с помощью портал Azure

Чтобы изменить срок хранения резервной копии PITR с помощью портал Azure, перейдите к объекту сервера, срок хранения которого вы хотите изменить на портале, а затем выберите соответствующий параметр в зависимости от изменяемого объекта сервера.

#### <a name="single-database--elastic-poolstabsingle-database"></a>[Отдельная база данных и эластичные пулы](#tab/single-database)

Изменение PITR хранения резервных копий для отдельных баз данных SQL Azure выполняется на уровне сервера. Изменения, внесенные на уровне сервера, применяются к базам данных на этом сервере. Чтобы изменить PITR для сервера базы данных SQL Azure с портал Azure, перейдите в колонку Обзор сервера, щелкните Управление резервными копиями в меню навигации, а затем щелкните настроить хранение на панели навигации.

![Изменение PITR на портале Azure](./media/sql-database-automated-backup/configure-backup-retention-sqldb.png)

#### <a name="managed-instancetabmanaged-instance"></a>[Управляемый экземпляр](#tab/managed-instance)

Изменение PITR хранения резервных копий для управляемого экземпляра базы данных SQL выполняется на уровне отдельных баз данных. Чтобы изменить срок хранения резервной копии PITR для базы данных экземпляра с портал Azure, перейдите в колонку обзор отдельных баз данных, а затем на панели навигации щелкните Настройка хранения резервных копий.

![Изменение PITR на портале Azure](./media/sql-database-automated-backup/configure-backup-retention-sqlmi.png)

---

### <a name="change-pitr-backup-retention-period-using-powershell"></a>Изменение периода хранения PITR с помощью PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL Azure, но вся будущая разработка предназначена для модуля AZ. SQL. Эти командлеты см. в разделе [AzureRM. SQL](https://docs.microsoft.com/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле AZ и в модулях AzureRm существенно идентичны.

```powershell
Set-AzSqlDatabaseBackupShortTermRetentionPolicy -ResourceGroupName resourceGroup -ServerName testserver -DatabaseName testDatabase -RetentionDays 28
```

### <a name="change-pitr-retention-period-using-rest-api"></a>Изменение периода хранения PITR с помощью REST API

#### <a name="sample-request"></a>Пример запроса

```http
PUT https://management.azure.com/subscriptions/00000000-1111-2222-3333-444444444444/resourceGroups/resourceGroup/providers/Microsoft.Sql/servers/testserver/databases/testDatabase/backupShortTermRetentionPolicies/default?api-version=2017-10-01-preview
```

#### <a name="request-body"></a>Текст запроса

```json
{
  "properties":{
    "retentionDays":28
  }
}
```

#### <a name="sample-response"></a>Пример ответа

Код состояния: 200.

```json
{
  "id": "/subscriptions/00000000-1111-2222-3333-444444444444/providers/Microsoft.Sql/resourceGroups/resourceGroup/servers/testserver/databases/testDatabase/backupShortTermRetentionPolicies/default",
  "name": "default",
  "type": "Microsoft.Sql/resourceGroups/servers/databases/backupShortTermRetentionPolicies",
  "properties": {
    "retentionDays": 28
  }
}
```

Дополнительные сведения о политиках краткосрочного хранения резервных копий см. [здесь](https://docs.microsoft.com/rest/api/sql/backupshorttermretentionpolicies).

## <a name="next-steps"></a>Дальнейшие действия

- Резервные копии базы данных являются важной частью любой стратегии непрерывности бизнес-процессов и аварийного восстановления, так как они защищают данные от случайного повреждения или удаления. Дополнительные сведения о других решениях для Базы данных SQL Azure, обеспечивающих непрерывность бизнес-процессов, см. в статье [Обзор обеспечения непрерывности бизнес-процессов с помощью Базы данных SQL Azure](sql-database-business-continuity.md).
- Сведения о восстановлении базы данных на определенный момент времени с помощью портала Azure см .в [этой статье](sql-database-recovery-using-backups.md).
- Сведения о восстановлении базы данных на определенный момент времени с помощью PowerShell см .в [этой статье](scripts/sql-database-restore-database-powershell.md).
- Сведения о настройке и управлении долгосрочного хранения создаваемых автоматически резервных копий в хранилище BLOB-объектов Azure, а также о восстановлении таких резервных копий на портале Azure см. в статье [Управление долгосрочным хранением резервных копий базы данных SQL Azure](sql-database-long-term-backup-retention-configure.md).
- Сведения о настройке, управлении и восстановлении долгосрочного хранения автоматически создаваемых резервных копий в хранилище BLOB-объектов Azure с помощью PowerShell см. в статье [Управление долгосрочным хранением резервных копий с помощью PowerShell](sql-database-long-term-backup-retention-configure.md).
