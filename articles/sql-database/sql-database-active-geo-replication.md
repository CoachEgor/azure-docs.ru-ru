---
title: Активная георепликация
description: Использование активной георепликации создает доступные для чтения баз данных-получателей отдельных баз данных в одном или в разных центрах обработки данных (регионах).
services: sql-database
ms.service: sql-database
ms.subservice: high-availability
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, carlrab
ms.date: 04/06/2020
ms.openlocfilehash: 1f339d987d67047f5857679b440e93e6c3730059
ms.sourcegitcommit: 98e79b359c4c6df2d8f9a47e0dbe93f3158be629
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/07/2020
ms.locfileid: "80810449"
---
# <a name="creating-and-using-active-geo-replication"></a>Создание и использование активной георепликации

Активная георепликация — это функция базы данных Azure S'L Database, которая позволяет создавать читаемые вторичные базы данных отдельных баз данных на сервере базы данных S'L в том же или другом центре обработки данных (регионе).

> [!NOTE]
> Управляемый экземпляр не поддерживает активную георепликацию. Дополнительные сведения о географической отработке отказа см. в статье [Использование групп автоматической отработки отказа для включения прозрачной и согласованной отработки отказа в нескольких базах данных](sql-database-auto-failover-group.md).

Активная георепликация разработана в качестве решения для обеспечения непрерывности бизнес-процессов, которое позволяет приложению выполнять быстрое аварийное восстановление отдельных баз данных в случае регионального сбоя или сбоя масштабирования. Если георепликация включена, приложение может инициировать отработку отказа в базу данных-получатель в другом регионе Azure. В одном или разных регионах поддерживается до четырех баз данных-получателей, которые также можно использовать для запросов на доступ только для чтения. Отработка отказа должна инициироваться вручную приложением пользователя. После отработки отказа у новой базы данных-источника будет другая конечная точка подключения. На следующей схеме показана типичная конфигурация геоизбыточного облачного приложения, использующего активную георепликацию.

![активная георепликация](./media/sql-database-active-geo-replication/geo-replication.png )

> [!IMPORTANT]
> В Базе данных SQL Azure также поддерживаются группы автоматической отработки отказа. Дополнительные сведения см. в [этой статье](sql-database-auto-failover-group.md). Кроме того, активная георепликация не поддерживается для баз данных, созданных в Управляемом экземпляре. Рассмотрите возможность использования [групп отработки отказа](sql-database-auto-failover-group.md) с Управляемыми экземплярами.

Если по какой-либо причине произойдет сбой вашей базы данных-источника (или вам просто потребуется перевести ее в автономный режим), вы можете выполнить отработку отказа на любую из доступных баз данных-получателей. При активации отработки отказа в одной из баз данных-получателей все прочие получатели автоматически связываются с новой базой данных-источником.

Вы можете управлять репликацией и отработкой отказа отдельной базы данных или набора баз данных на сервере или в эластичном пуле с помощью активной георепликации. Для этого используйте:

- [Портал Azure](sql-database-geo-replication-portal.md)
- [PowerShell: отдельную базу данных](scripts/sql-database-setup-geodr-and-failover-database-powershell.md);
- [PowerShell: эластичный пул](scripts/sql-database-setup-geodr-and-failover-pool-powershell.md);
- [Transact-SQL: отдельную базу данных или эластичный пул](/sql/t-sql/statements/alter-database-azure-sql-database);
- [REST API: отдельную базу данных](https://docs.microsoft.com/rest/api/sql/replicationlinks);


Активная георепликация использует технологию SQL Server [AlwaysOn](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server) для асинхронной репликации зафиксированных транзакций в базе данных-источнике в базы данных-получатели с помощью изоляции моментального снимка. Группы автоматической отработки отказа обеспечивают групповую семантику на основе активной георепликации, однако используется тот же механизм асинхронной репликации. Хотя в любой момент база данных-получатель может немного отстать от базы данных-источника, в базе данных-получателе никогда не будет частично выполненных транзакций. Избыточность в различных регионах позволяет быстро восстанавливать приложения после необратимой потери всего центра обработки данных или его частей, вызванной стихийным бедствием, неисправимыми человеческими ошибками или вредоносными действиями. Конкретные сведения о RPO можно найти в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md).

> [!NOTE]
> В случае сбоя сети между двумя регионами каждые 10 секунд выполняется попытка установить подключения.
> [!IMPORTANT]
> Чтобы гарантировать, что критическое изменение базы данных-источника реплицировано на дополнительную базу данных перед отработкой отказа, можно вызвать принудительную синхронизацию, что позволит обеспечить репликацию критически важных изменений (например, обновлений паролей). Принудительная синхронизация снизит производительность, так как будет блокировать вызывающий поток, пока все зафиксированные транзакции не будут реплицированы. Дополнительные сведения см. в статье [sp_wait_for_database_copy_sync (база данных SQL Azure)](https://docs.microsoft.com/sql/relational-databases/system-stored-procedures/active-geo-replication-sp-wait-for-database-copy-sync). Чтобы отследить задержку репликации между базой данных-источником и получателем, см. статью [sys.dm_geo_replication_link_status (база данных SQL Azure)](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-geo-replication-link-status-azure-sql-database).

На следующем рисунке показан пример активной георепликации, настроенной с помощью базы данных-источника в центрально-северной части США и базы данных-получателя в центрально-южной части США.

![Отношение георепликации](./media/sql-database-active-geo-replication/geo-replication-relationship.png)

Так как базы данных-получатели доступны для чтения, они могут использоваться для разгрузки рабочих нагрузок только для чтения, например заданий для составления отчетов. Если вы используете активную георепликацию, вы можете создать базу данных-получатель в том же регионе, в котором расположена база данных-источник, однако устойчивость приложения к катастрофическим сбоям останется на прежнем уровне. Если вы используете группы автоматической отработки отказа, база данных-получатель всегда будет создаваться в другом регионе.

Активная георепликация может использоваться не только для аварийного восстановления, но и в следующих сценариях:

- **Миграция баз данных**: Вы можете использовать активную георепликацию для переноса базы данных с одного сервера на другой онлайн с минимальным временем простоя.
- **Обновления приложения**: при обновлении приложения вы можете создать дополнительную базу данных-получатель как резервную копию на случай сбоя.

Добавление избыточности баз данных между центрами обработки данных — только часть решения для достижения настоящей непрерывности бизнес-процессов. Для комплексного восстановления приложения (службы) после катастрофического сбоя необходимо восстановить все компоненты, из которых состоит служба и все зависимые службы. К примерам этих компонентов относятся клиентское программное обеспечение (например, браузер с пользовательским кодом JavaScript), интерфейсные веб-серверы, хранилище и DNS. Очень важно, чтобы все компоненты были устойчивы к одинаковым сбоям и становились доступными в соответствии с целевым временем восстановления (RTO) вашего приложения. Следовательно, необходимо определить все зависимые службы и получить сведения о гарантиях и возможностях, которые они предоставляют. Затем необходимо выполнить соответствующие действия, чтобы обеспечить работу службы во время отработки отказа служб, от которых она зависит. Для получения дополнительной информации о разработке решений для аварийного восстановления [см.](sql-database-designing-cloud-solutions-for-disaster-recovery.md)

## <a name="active-geo-replication-terminology-and-capabilities"></a>Терминология и возможности активной георепликации

- **Автоматическая асинхронная репликация**

  Базу данных-получатель можно создать, только добавив ее к существующей базе данных. Базу данных-получатель можно создать на любом сервере Базы данных SQL Azure. После создания база данных-получатель заполняется данными, которые копируются из базы данных-источника. Этот процесс называется заполнением. После создания и начального заполнения базы данных-получателя обновления базы данных-источника асинхронно и автоматически реплицируются в базу данных-получателя. Асинхронная репликация означает, что транзакции фиксируются в базе данных-источнике перед их репликацией в базу данных-получатель.

- **Базы данных-получатели, доступные для чтения**

  Приложение может получить доступ к базе данных-получателю только для чтения с использованием тех же или других субъектов безопасности, которые применяются для доступа к базе данных-источнику. База данных-получатель работает в режиме изоляции моментальных снимков, чтобы гарантировать, что репликация обновлений базы данных-источника (воспроизведение журнала) не будет задерживаться из-за запросов, выполняемых на базе данных-получателе.

> [!NOTE]
> Если в базе данных-источнике есть обновления схем, воспроизведение журнала в базе данных-получателе откладывается. Для последнего требуется заблокировать схему базы данных-получателя.
> [!IMPORTANT]
> Георепликация может быть использоваться для создания вторичной базы данных в том же регионе, что и основная. Эту вторичную нагрузку можно использовать для загрузки-баланса рабочих нагрузок только для чтения в одном регионе. Однако второстепенная база данных в том же регионе не обеспечивает дополнительной устойчивости к неисправностям и, следовательно, не является подходящей целью аварийного восстановления. Это также не гарантирует изоляцию зоны доступности. Для достижения изоляции зоны доступности используйте критический или премиум-уровень обслуживания с [избыточной конфигурацией зоны.](sql-database-high-availability.md#zone-redundant-configuration)   
>

- **Запланированный сбой**

  Запланированный сбой переключает роли первичных и вторичных баз данных после завершения полной синхронизации. Это онлайн-операция, которая не приводит к потере данных. Время операции зависит от размера журнала транзакции на первичном, который необходимо синхронизировать. Плановый сбой предназначен для следующих сценариев: a) для выполнения DR-сверла в производстве, когда потеря данных неприемлема; b) перенести базу данных в другой регион; и с) вернуть базу данных в основной регион после смягчения простоя (отказ).

- **Незапланированный сбой**

  При незапланированной или принудительной отработке отказа база данных-получатель немедленно переключается на основную роль без какой-либо синхронизации с базой данных-источником. Любые транзакции, совершенные в основной, но не реплицированные на вторичные, будут потеряны. Эта операция разработана как метод восстановления во время простоев, когда первичная недоступна, но доступность базы данных должна быть быстро восстановлена. Когда исходный основной вернулся в сети он автоматически повторно подключиться и стать новым вторичным. Все несинхронизированные транзакции до сбоя будут сохранены в файле резервного копирования, но не будут синхронизированы с новой основной, чтобы избежать конфликтов. Эти транзакции должны быть объединены вручную с последней версией первичной базы данных.
 
- **Несколько баз данных-получателей**

  Для каждой базы данных-источника можно создать до 4 баз данных-получателей. Если же имеется только одна база данных-получатель и на ней происходит сбой, приложение подвергается более высокому риску, пока не будет создана новая база данных-получатель. Если существует несколько баз данных-получателей, то приложение остается защищенным даже при сбое одной из баз данных-получателей. Дополнительные базы данных-получатели также могут использоваться для масштабирования рабочих нагрузок только для чтения.

  > [!NOTE]
  > Если вы используете активную георепликацию, чтобы создать глобально распределенное приложение, и вам необходимо предоставить к данным доступ только для чтения более чем в четырех регионах, вы можете создать базу данных-получатель первой базы данных-получателя (цепочку). Это гарантирует виртуально неограниченное масштабирование репликации базы данных. Кроме того, эта цепочка снижает нагрузку репликации в базе данных-источнике. Недостатком является увеличенная задержка репликации в конечных базах данных-получателях.

- **Георепликация баз данных в эластичном пуле**

  Каждая база данных-получатель может отдельно участвовать в эластичном пуле или вообще не участвовать в каком-либо эластичном пуле. Выбор пула для каждой базы данных-получателя осуществляется отдельно и не зависит от конфигурации других баз данных-получателей (источников или получателей). Каждый эластичный пул содержится в одном регионе, поэтому несколько баз данных-получателей в одной топологии никогда не могут совместно использовать один эластичный пул.


- **Управляемые пользователем отработка отказа и восстановление размещения**

  Приложение или пользователь может в любой момент явным образом использовать базу данных-получатель в качестве базы данных-источника. Во время реального простоя следует использовать "незапланированный" вариант, который сразу же способствует вторичной быть основным. Когда работоспособность вышедшей из строя базы данных-источника будет восстановлена и она снова станет доступной, система автоматически пометит ее как базу данных-получатель и синхронизирует с новой базой данных-источником. Из-за асинхронного характера репликации во время внеплановой отработки отказа может быть потерян небольшой объем данных, если сбой базы данных-источника произойдет до того, как будет выполнена репликация самых последних изменений в базу данных-получатель. При сбое базы данных-источника с несколькими базами данных-получателями система автоматически перенастраивает отношения репликации и связывает оставшиеся базы данных-получатели с новой развернутой базой данных-источником без вмешательства пользователя. После устранения сбоя, который вызвал отработку отказа, желательно вернуть приложение в основной регион. Для этого следует ссылаться на команду о сбоях с "запланированным" вариантом.

## <a name="preparing-secondary-database-for-failover"></a>Подготовка вторичной базы данных к сбою

Чтобы обеспечить немедленное получение доступа к новому основному приложению после сбоя, убедитесь, что требования аутентификации для вашего вторичного сервера и базы данных настроены должным образом. Дополнительные сведения см. в разделе [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md). Чтобы гарантировать соответствие требованиям после сбоя, убедитесь, что политика резервного хранения в вторичной базе данных совпадает с политикой основной. Эти параметры не являются частью базы данных и не реплицируются. По умолчанию вторичный будет настроен с периодом удержания PITR по умолчанию в семь дней. Дополнительные сведения см. в статье [Подробнее о резервном копировании базы данных SQL](sql-database-automated-backups.md).

> [!IMPORTANT]
> Если ваша база данных является членом группы failover, вы не можете инициировать ее сбой с помощью команды faiover георепликации. Рассмотрите возможность использования команды failover для группы. Если вам необходимо выполнить неудачу в отдельной базе данных, сначала необходимо удалить ее из группы неудач. Подробнее о [группах failover](sql-database-auto-failover-group.md) см. 


## <a name="configuring-secondary-database"></a>Настройка вторичной базы данных

База данных-источник и база данных-получатель должны иметь один и тот же уровень служб. Кроме того, настоятельно рекомендуем создавать базу данных-источник и базу данных-получатель с одинаковым объемом вычислительных ресурсов (DTU или виртуальных ядер). Если основная база данных испытывает большую рабочую нагрузку записи, второстепенная с меньшим размером вычислений может быть не в состоянии идти в ногу с ней. Это приведет к повторному отставанию на вторичном, и потенциальной недоступности вторичного. Вторичная база данных, которая отстает от первичной, также рискует привести к значительной потере данных, если потребуется вынужденный сбой. Чтобы уменьшить эти риски, активная георепликация при необходимости задушит скорость входа в первичную, чтобы позволить его второстепенным догнать. 

Другим следствием несбалансированной вторичной конфигурации является то, что после сбоя производительность приложения может пострадать из-за недостаточной вычислительной мощности нового первичного. В этом случае необходимо будет увеличить масштаб ирование до необходимого уровня службы баз данных, что может занять значительное время и вычислить ресурсы, и потребует сбоя [высокой доступности](sql-database-high-availability.md) в конце процесса расширения масштабирования.

> [!IMPORTANT]
> Опубликовано 5 сек RPO SLA не может быть гарантировано, если вторичная база данных настроена с тем же или более высоким размером вычислений, как основной. 

Если вы решите создать вторичное с меньшим размером вычислений, процентная диаграмма журнала IO на портале Azure обеспечивает хороший способ оценить минимальный размер вычисления вторичного, который необходим для поддержания нагрузки репликации. Например, если основная база данных P6 (1000 DTU) и процент записи журнала составляет 50%, то вторичная должна быть не менее P4 (500 DTU). Для получения данных об итоговых данных исторического журнала используйте представление [sys.resource_stats.](/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database) Для получения последних данных записи журнала с более высокой детализацией, которая лучше отражает краткосрочные всплески скорости журнала, используйте [sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) view. 

Скорость регулирования транзакций на первичном из-за более низкого размера вычислений на вторичном, сообщается с использованием типа ожидания HADR_THROTTLE_LOG_RATE_MISMATCHED_SLO, видимом в [представлениях sys.dm_exec_requests](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql) и [sys.dm_os_wait_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-wait-stats-transact-sql) базы данных. 

> [!NOTE]
> Скорость входа транзакций на первичном может быть снижена по причинам, не связанным с более низким размером вычислений на вторичном. Такое регулирование может произойти даже при наличии вторичного размера вычислений, что и у основного. Для получения подробной информации, включая типы ожидания [Transaction log rate governance](sql-database-resource-limits-database-server.md#transaction-log-rate-governance)для различных видов регулирования скорости журнала, см.

Дополнительные сведения об объеме вычислительных ресурсов Базы данных SQL см. в статье с описанием [уровней служб Базы данных SQL](sql-database-purchase-models.md).

## <a name="cross-subscription-geo-replication"></a>Георепликация по перекрестной подписке

Для настройки активной георепликации между двумя базами данных, принадлежащими к разным подпискам (будь то под одинаковым арендатором или нет), необходимо следовать специальной процедуре, описанной в этом разделе.  Процедура основана на командах S'L и требует: 

- Создание привилегированном логина на обоих серверах
- Добавление IP-адреса в список клиента, выполняющего изменения на обоих серверах (например, IP-адрес хоста, работающего в студии управления серверами S'L). 

Клиенту, выполняющим изменения, необходим сетевой доступ к основному серверу. Хотя тот же IP-адрес клиента должен быть добавлен в список разрешений на вторичном сервере, подключение сети к вторичному серверу строго не требуется. 

### <a name="on-the-master-of-the-primary-server"></a>На мастере основного сервера

1. Добавьте IP-адрес в список клиента, выполняющего изменения (для получения дополнительной информации [см., Настройте брандмауэр).](sql-database-firewall-configure.md) 
1. Создайте логин, предназначенный для установки активной георепликации (и отрегулируйте учетные данные по мере необходимости):

   ```sql
   create login geodrsetup with password = 'ComplexPassword01'
   ```

1. Создайте соответствующего пользователя и присвоите ему роль dbmanager: 

   ```sql
   create user geodrsetup for login geodrsetup
   alter role dbmanager add member geodrsetup
   ```

1. Обратите внимание на SID нового входа с помощью этого запроса: 

   ```sql
   select sid from sys.sql_logins where name = 'geodrsetup'
   ```

### <a name="on-the-source-database-on-the-primary-server"></a>На исходной базе данных на основном сервере

1. Создайте пользователя для того же входа:

   ```sql
   create user geodrsetup for login geodrsetup
   ```

1. Добавьте пользователя к роли db_owner:

   ```sql
   alter role db_owner add member geodrsetup
   ```

### <a name="on-the-master-of-the-secondary-server"></a>На мастере вторичного сервера 

1. Добавьте IP-адрес в список клиента, выполняющего изменения. Он должен быть таким же IP-адресом основного сервера. 
1. Создайте тот же логин, что и на основном сервере, используя тот же пароль имени пользователя и SID: 

   ```sql
   create login geodrsetup with password = 'ComplexPassword01', sid=0x010600000000006400000000000000001C98F52B95D9C84BBBA8578FACE37C3E
   ```

1. Создайте соответствующего пользователя и присвоите ему роль dbmanager:

   ```sql
   create user geodrsetup for login geodrsetup;
   alter role dbmanager add member geodrsetup
   ```

### <a name="on-the-master-of-the-primary-server"></a>На мастере основного сервера

1. Войти в мастер основного сервера с помощью нового входа. 
1. Создайте вторичную копию исходной базы данных на вторичном сервере (при необходимости отрегулируйте имя базы данных и имя сервера):

   ```sql
   alter database dbrep add secondary on server <servername>
   ```

После первоначальной настройки пользователи, созданные правила для входа и брандмауэра могут быть удалены. 


## <a name="keeping-credentials-and-firewall-rules-in-sync"></a>Синхронизация учетных данных и правил брандмауэра

Мы рекомендуем использовать [правила IP-брандмауэра уровня базы данных](sql-database-firewall-configure.md) для геореплицированных баз данных, чтобы эти правила могли быть воспроизведены с базой данных, чтобы гарантировать, что все вторичные базы данных имеют те же правила IP-брандмауэра, что и первичные. Такой подход избавляет клиентов от необходимости вручную настраивать и обслуживать правила брандмауэра на серверах, на которых размещаются как базы данных-источники, так и базы данных-получатели. Аналогично, в случае получения доступа к данным с помощью [пользователей автономной базы данных](sql-database-manage-logins.md) базы данных-источники и базы данных-получатели всегда используют одни и те же учетные данные. Поэтому при отработке отказа можно избежать нарушений в работе из-за несоответствия имен для входа или паролей. Благодаря добавлению [Azure Active Directory](../active-directory/fundamentals/active-directory-whatis.md) клиенты могут управлять доступом пользователей к базам данных-источникам и базам данных-получателям, и им не нужно управлять учетными данными для баз данных.

## <a name="upgrading-or-downgrading-primary-database"></a>Обновление или понижение первичной базы данных

Вы можете повышать или понижать объем вычислительных ресурсов базы данных-источника (в рамках одного уровня служб, а не между уровнем общего назначения и критически важным для бизнеса) без отключения каких-либо баз данных-получателей. При повышении рекомендуется сначала повысить уровень производительности базы данных-получателя, а затем — уровень базы данных-источника. При понижении следует действовать в обратном порядке: сначала нужно понизить уровень производительности базы данных-источника, а после этого — базы данных-получателя. Когда вы повышаете или понижаете базу данных до следующего уровня служб, особенно важно выполнять рекомендацию выше.

> [!NOTE]
> Если вы создали базу данных-получатель как часть конфигурации группы отработки отказа, понижение ее уровня не рекомендуется. Это необходимо, чтобы обеспечить достаточную емкость уровня данных для обработки регулярных рабочих нагрузок после активации отработки отказа.

> [!IMPORTANT]
> Первичная база данных в группе failover не может масштабироваться до более высокого уровня, если вторичная база данных не масштабируется до более высокого уровня. Если вы попытаетесь масштабировать первичную базу данных до масштабирования вторичной базы данных, вы можете получить следующую ошибку:
>
> `Error message: The source database 'Primaryserver.DBName' cannot have higher edition than the target database 'Secondaryserver.DBName'. Upgrade the edition on the target before upgrading the source.`
>

## <a name="preventing-the-loss-of-critical-data"></a>Предотвращение потери важных данных

Из-за высокой задержки глобальных сетей непрерывная копия использует механизм асинхронной репликации. Ввиду асинхронной репликации потеря данных в случае сбоя неизбежна. Тем не менее для некоторых приложений терять данные недопустимо. Чтобы защитить эти критические обновления, разработчик приложения сразу же после фиксации транзакции может вызывать системную процедуру [sp_wait_for_database_copy_sync](/sql/relational-databases/system-stored-procedures/active-geo-replication-sp-wait-for-database-copy-sync). Вызов **sp_wait_for_database_copy_sync** блокирует вызывающий поток до передачи последней зафиксированной транзакции в базе данных-получателе. Но вызов не дожидается воспроизведения и фиксации переданных транзакций в базе данных-получателе. **sp_wait_for_database_copy_sync** ограничена конкретной связью непрерывной копии. Эту процедуру может вызвать любой пользователь с правами подключения к базе данных-источнику.

> [!NOTE]
> Процедура **sp_wait_for_database_copy_sync** предотвращает потерю данных после отработки отказа, но не гарантирует полную синхронизацию для доступа на чтение. Вызов процедуры **sp_wait_for_database_copy_sync** может привести к значительной задержке, которая будет зависеть от размера журнала транзакций во время вызова.

## <a name="monitoring-geo-replication-lag"></a>Мониторинг георепликации отставание

Для мониторинга отставания по отношению к RPO используйте *replication_lag_sec* столбец [sys.dm_geo_replication_link_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-geo-replication-link-status-azure-sql-database) в основной базе данных. Он показывает отставание в секундах между транзакциями, совершенными на первичном и сохраняются на вторичном. Пример: если значение задержки составляет 1 секунду, это означает, что если основной удар влияет на сбой в данный момент и инициирован, то 1 секунда последних переходов не будет сохранена. 

Для измерения отставания в отношении изменений в первичной базе данных, которые были применены на вторичной, т.е. доступны для чтения из вторичной, сравнить *last_commit* времени на вторичной базе данных с тем же значением в первичной базе данных.

> [!NOTE]
> Иногда *replication_lag_sec* в основной базе данных имеет значение NULL, что означает, что основной в настоящее время не знает, насколько далеко находится вторичное.   Это обычно происходит после перезагрузки процесса и должно быть временным условием. Рассмотрите возможность оповещения приложения, если *replication_lag_sec* возвращает NULL в течение длительного периода времени. Это будет означать, что второстепенная база данных не может общаться с первичной из-за постоянного сбоя подключения. Существуют также условия, которые могут привести к разнице между *last_commit* времени на вторичном и в первичной базе данных, чтобы стать большим. Пример: если коммит сделан на первичном после длительного периода без изменений, разница подскочит до большого значения, прежде чем быстро вернуться к 0. Считайте это условием ошибки, когда разница между этими двумя значениями остается большой в течение длительного времени.


## <a name="programmatically-managing-active-geo-replication"></a>Программное управление активной георепликацией

Как уже говорилось ранее, активной георепликацией можно также управлять программно с помощью Azure PowerShell и REST API. В приведенных ниже таблицах описан доступный для этого набор команд. Активная георепликация включает в себя набор API-интерфейсов Azure Resource Manager для управления, в том числе [REST API Базы данных SQL Azure](https://docs.microsoft.com/rest/api/sql/) и [командлеты Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview). Эти интерфейсы API требуют использования групп ресурсов и поддерживают безопасность на основе ролей (RBAC). Для получения дополнительной информации о [Azure Role-Based Access Control](../role-based-access-control/overview.md)том, как реализовать роли доступа, см.

### <a name="t-sql-manage-failover-of-single-and-pooled-databases"></a>Т-СЗЛ: Управление сбой одного и объединенных баз данных

> [!IMPORTANT]
> Приведенные ниже команды Transact-SQL применяются только к активной георепликации — они неприменимы к группам отработки отказа. Как таковые, они также не применяются к Управляемым экземплярам, так как они поддерживают только группы отработки отказа.

| Команда | Описание |
| --- | --- |
| [ИЗМЕНИТЬ БАЗУ ДАННЫХ](https://docs.microsoft.com/sql/t-sql/statements/alter-database-transact-sql?view=azuresqldb-current) |Используйте аргумент ADD SECONDARY ON SERVER, чтобы создать базу данных-получатель для существующей базы данных и начать репликацию данных. |
| [ИЗМЕНИТЬ БАЗУ ДАННЫХ](https://docs.microsoft.com/sql/t-sql/statements/alter-database-transact-sql?view=azuresqldb-current) |Используйте аргумент FAILOVER или FORCE_FAILOVER_ALLOW_DATA_LOSS, чтобы задать базу данных-получатель в качестве базы данных-источника для запуска отработки отказа. |
| [ИЗМЕНИТЬ БАЗУ ДАННЫХ](https://docs.microsoft.com/sql/t-sql/statements/alter-database-transact-sql?view=azuresqldb-current) |Используйте аргумент REMOVE SECONDARY ON SERVER, чтобы завершить репликацию данных между базой данных SQL и указанной базой данных-получателем. |
| [sys.geo_replication_links](/sql/relational-databases/system-dynamic-management-views/sys-geo-replication-links-azure-sql-database) |Возвращает сведения о всех существующих связях репликации для каждой базы данных на сервере Базы данных SQL Azure. |
| [sys.dm_geo_replication_link_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-geo-replication-link-status-azure-sql-database) |Получает время последней репликации, задержку при последней репликации и другие сведения о связи репликации для заданной базы данных SQL. |
| [sys.dm_operation_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-operation-status-azure-sql-database) |Показывает состояние всех операций с базой данных, включая состояние связей репликации. |
| [sp_wait_for_database_copy_sync](/sql/relational-databases/system-stored-procedures/active-geo-replication-sp-wait-for-database-copy-sync) |Указывает приложению ждать, пока все зафиксированные транзакции не будут реплицированы и подтверждены активной базой данных-получателем. |
|  | |

### <a name="powershell-manage-failover-of-single-and-pooled-databases"></a>PowerShell: Управление сбой одной и объединенной базы данных

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных Azure S'L, но все будущие разработки предназначены для модуля Az.Sql. Для этих cmdlets, см [AzureRM.Sql](https://docs.microsoft.com/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле Az и в модулях Azrm существенно идентичны.

| Командлет | Описание |
| --- | --- |
| [Get-AzSqlDatabase](https://docs.microsoft.com/powershell/module/az.sql/get-azsqldatabase) |Получает одну или несколько баз данных. |
| [New-AzSqlDatabaseSecondary](https://docs.microsoft.com/powershell/module/az.sql/new-azsqldatabasesecondary) |Создает базу данных-получатель для существующей базы данных и начинает репликацию данных. |
| [Set-AzSqlDatabaseSecondary](https://docs.microsoft.com/powershell/module/az.sql/set-azsqldatabasesecondary) |Преобразует базу данных-получатель в базу данных-источник для запуска отработки отказа. |
| [Remove-AzSqlDatabaseSecondary](https://docs.microsoft.com/powershell/module/az.sql/remove-azsqldatabasesecondary) |Завершает репликацию данных между базой данных SQL и указанной базой данных-получателем. |
| [Get-AzSqlDatabaseReplicationLink](https://docs.microsoft.com/powershell/module/az.sql/get-azsqldatabasereplicationlink) |Получает связи георепликации между базой данных SQL Azure и группой ресурсов или SQL Server. |
|  | |

> [!IMPORTANT]
> Дополнительные сведения о примерах сценариев см. в статьях [Настройка активной георепликации для отдельной базы данных SQL Azure с помощью PowerShell](scripts/sql-database-setup-geodr-and-failover-database-powershell.md) и [Настройка активной георепликации для базы данных SQL Azure в пуле с помощью PowerShell](scripts/sql-database-setup-geodr-and-failover-pool-powershell.md).

### <a name="rest-api-manage-failover-of-single-and-pooled-databases"></a>REST API: Управление сбой одиночных и объединенных баз данных

| API | Описание |
| --- | --- |
| [Создание или обновление базы данных (createMode=Restore)](https://docs.microsoft.com/rest/api/sql/databases/createorupdate) |Создает, обновляет или восстанавливает базу данных-источник или базу данных-получатель. |
| [Получение, создание или обновление состояния базы данных](https://docs.microsoft.com/rest/api/sql/databases/createorupdate) |Возвращает состояние во время операции создания. |
| [Задание базы данных-получателя в качестве базы данных-источника (плановая отработка отказа)](https://docs.microsoft.com/rest/api/sql/replicationlinks/failover) |Задает базу данных-получатель в качестве базы данных-источник. Для этого выполняется отработка отказа из текущей базы данных-источник. **Этот параметр не поддерживается в Управляемом экземпляре.**|
| [Задание базы данных-получателя в качестве базы данных-источника (внеплановая отработка отказа)](https://docs.microsoft.com/rest/api/sql/replicationlinks/failoverallowdataloss) |Задает базу данных-получатель в качестве базы данных-источник. Для этого выполняется отработка отказа из текущей базы данных-источник. Эта операция может привести к потере данных. **Этот параметр не поддерживается в Управляемом экземпляре.**|
| [Получение связи репликации](https://docs.microsoft.com/rest/api/sql/replicationlinks/get) |Получает определенную связь репликации для заданной базы данных SQL, участвующей в партнерстве георепликации. Извлекает сведения, отображаемые в представлении каталога sys.geo_replication_links. **Этот параметр не поддерживается в Управляемом экземпляре.**|
| [Replication Links - List By Database](https://docs.microsoft.com/rest/api/sql/replicationlinks/listbydatabase) (Ссылки для репликации: вывод списка по базе данных) | Получает все связи репликации для заданной базы данных SQL, участвующей в партнерстве георепликации. Извлекает сведения, отображаемые в представлении каталога sys.geo_replication_links. |
| [Удаление связей репликации](https://docs.microsoft.com/rest/api/sql/replicationlinks/delete) | Удаляет связь репликации базы данных. Невозможно выполнить во время отработки отказа. |
|  | |

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь с примерами скриптов в следующих статьях:
  - [Настройка и отказ от единой базы данных с помощью активной георепликации](scripts/sql-database-setup-geodr-and-failover-database-powershell.md)
  - [Настройка и отказ объединенной базы данных с помощью активной георепликации](scripts/sql-database-setup-geodr-and-failover-pool-powershell.md)
- В Базе данных SQL Azure также поддерживаются группы автоматической отработки отказа. Дополнительные сведения см. в [этой статье](sql-database-auto-failover-group.md).
- Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md)
- Чтобы узнать о автоматизированных резервных отстах базы данных Azure S'L, [см.](sql-database-automated-backups.md)
- Чтобы узнать об использовании автоматизированных резервных ups для восстановления, [см.](sql-database-recovery-using-backups.md)
- Дополнительные сведения о требованиях к проверке подлинности для новых сервера-источника и базы данных-источника см. в статье [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).
