---
title: Ограничения ресурсов базы данных SQL Azure | Документация Майкрософт
description: В этой статье приводятся общие сведения об ограничениях ресурсов базы данных SQL Azure для отдельных баз данных и эластичных пулов. Здесь также содержится информация о том, что происходит, когда эти ограничения ресурсов соответствуют или превышают допустимые нормы.
services: sql-database
ms.service: sql-database
ms.subservice: single-database
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sstein
ms.reviewer: sashan,moslake,josack
ms.date: 11/19/2019
ms.openlocfilehash: fa41649e002bd4845b95e787c1d0589ed1987588
ms.sourcegitcommit: 509b39e73b5cbf670c8d231b4af1e6cfafa82e5a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2020
ms.locfileid: "78391095"
---
# <a name="sql-database-resource-limits-and-resource-governance"></a>Ограничения ресурсов базы данных SQL и управление ресурсами

Статья представляет обзор ограничения ресурсов для сервера Базы данных SQL, который управляет отдельными базами данных и эластичными пулами. Он предоставляет сведения о том, что происходит при достижении или превышении лимитов ресурсов, а также описывает механизмы управления ресурсами, используемые для принудительного применения этих ограничений.

> [!NOTE]
> Ограничения Управляемого экземпляра см. в разделе [Ограничения ресурсов Базы данных SQL для управляемых экземпляров](sql-database-managed-instance-resource-limits.md).

## <a name="maximum-resource-limits"></a>Максимальное ограничение ресурсов

| Ресурс | Предельное количество |
| :--- | :--- |
| Баз данных на сервер | 5000 |
| Количество серверов по умолчанию на одну подписку в любом регионе | 20 |
| Максимальное количество серверов на одну подписку в любом регионе | 200 |  
| Квота DTU или eDTU на сервер | 54 000 |  
| Квота виртуальных ядер на сервер или экземпляр | 540 |
| Максимальное число пулов на сервер | ограничено числом DTU или виртуальных ядер Например, если каждый пул поддерживает 1000 DTU, тогда один сервер может поддерживать 54 пула.|
|||

> [!IMPORTANT]
> По мере приближения количества баз данных к пороговому значению для сервера Базы данных SQL может произойти следующее:
>
> - Увеличение задержки при выполнении запросов к базе данных master.  Сюда входят представления статистических данных использования ресурсов, такие как sys.resource_stats.
> - Увеличение задержки при управлении и отображении для точек наблюдения портала, включая перечисление баз данных на сервере.

> [!NOTE]
> Чтобы получить дополнительную квоту DTU/eDTU, квоту Виртуальное ядро или больше серверов по сравнению с суммой по умолчанию, отправьте новый запрос в службу поддержки в портал Azure. Дополнительные сведения см. в статье [запрос увеличения квоты для базы данных SQL Azure](quota-increase-request.md).

### <a name="storage-size"></a>Объем памяти

Размеры хранилища ресурсов для отдельных баз данных см. в разделе [ограничения ресурсов на основе DTU](sql-database-dtu-resource-limits-single-databases.md) или ограничения на [ресурсы на основе виртуальное ядро](sql-database-vcore-resource-limits-single-databases.md) для ограничения размера хранилища на ценовую категорию.

## <a name="what-happens-when-database-resource-limits-are-reached"></a>Что происходит при достижении ограничения ресурсов базы данных?

### <a name="compute-dtus-and-edtus--vcores"></a>Вычислительные ресурсы (DTU и eDTU/виртуальные ядра)

Когда использование вычислений базы данных (измеряемое DTU и Edtu или виртуальных ядер) становится большим, задержка запросов увеличивается, а время ожидания запросов может исключаться. В этих условиях запросы могут помещаться в очередь службой и предоставлять ресурсы для выполнения, так как ресурсы становятся свободными.
При интенсивном использовании вычислительных ресурсов возможны следующие варианты предотвращения последствий:

- Увеличение объема вычислительных ресурсов базы данных или эластичного пула для предоставления базе данных дополнительных вычислительных ресурсов. См. разделы [Масштабирование ресурсов отдельной базы данных](sql-database-single-database-scale.md) и [Масштабирование ресурсов эластичного пула](sql-database-elastic-pool-scale.md).
- Оптимизация запросов для уменьшения использования ресурсов каждым запросом. Дополнительные сведения см. в разделе [Настройка запросов и указания на них](sql-database-performance-guidance.md#query-tuning-and-hinting).

### <a name="storage"></a>Память

Когда используемое пространство базы данных достигает максимального размера, операции вставки и обновления, увеличивающие размер данных, завершаются сбоем и клиенты получают [сообщение об ошибке](troubleshoot-connectivity-issues-microsoft-azure-sql-database.md). Инструкции SELECT и DELETE продолжают выполняться.

При интенсивном использовании пространства возможны следующие варианты предотвращения последствий:

- Увеличение максимального размера базы данных или эластичного пула или Добавление дополнительного хранилища. См. разделы [Масштабирование ресурсов отдельной базы данных](sql-database-single-database-scale.md) и [Масштабирование ресурсов эластичного пула](sql-database-elastic-pool-scale.md).
- Если база данных находится в эластичном пуле, то в качестве альтернативы ее можно переместить за пределы пула, чтобы ее дисковое пространство не использовалось совместно с другими базами данных.
- Сжатие базы данных для освобождения неиспользуемого пространства. Дополнительные сведения см. в статье об [управлении файловым пространством в Базе данных SQL Azure](sql-database-file-space-management.md).

### <a name="sessions-and-workers-requests"></a>Сеансы и рабочие роли (запросы)

Максимальное количество сеансов и рабочих ролей определяется уровнем служб и размером вычислений (DTU/Edtu или виртуальных ядер. При достижении ограничения числа сеансов или рабочих ролей новые запросы отклоняются, а клиенты получают сообщение об ошибке. Хотя приложение может управлять числом доступных подключений, число параллельных рабочих ролей зачастую существенно труднее оценивать и контролировать. Это особенно справедливо во время пиковых периодов загрузки при достижении пределов ресурсов базы данных, а работники — из-за длительного выполнения запросов, больших блокирующих цепочек или чрезмерного параллелизма запросов.

При интенсивном использовании сеансов и рабочих ролей возможны следующие варианты предотвращения последствий:

- Повышение уровня служб или объема вычислительных ресурсов базы данных или эластичного пула. См. разделы [Масштабирование ресурсов отдельной базы данных](sql-database-single-database-scale.md) и [Масштабирование ресурсов эластичного пула](sql-database-elastic-pool-scale.md).
- Оптимизация запросов для сокращения использования ресурсов, необходимых каждому запросу, если причиной повышенного использования рабочих ролей является состязание за вычислительные ресурсы. Дополнительные сведения см. в разделе [Настройка запросов и указания на них](sql-database-performance-guidance.md#query-tuning-and-hinting).

## <a name="resource-governance"></a>Управление ресурсами

Чтобы применить ограничения ресурсов, база данных SQL Azure использует реализацию управления ресурсами, основанную на SQL Server [Resource Governor](https://docs.microsoft.com/sql/relational-databases/resource-governor/resource-governor), измененных и расширенных для запуска службы SQL Server базы данных в Azure. На каждом экземпляре SQL Server в службе существует несколько [пулов ресурсов](https://docs.microsoft.com/sql/relational-databases/resource-governor/resource-governor-resource-pool) и [групп рабочей нагрузки](https://docs.microsoft.com/sql/relational-databases/resource-governor/resource-governor-workload-group)с ограничениями ресурсов, заданными на уровнях пула и группы, чтобы обеспечить [сбалансированную базу данных как услугу](https://azure.microsoft.com/blog/resource-governance-in-azure-sql-database/). Рабочая нагрузка пользователя и внутренние рабочие нагрузки классифицируются в отдельные пулы ресурсов и группы рабочей нагрузки. Рабочая нагрузка пользователя на первичную и доступную для чтения вторичные реплики, включая геореплики, классифицируется в `SloSharedPool1` пул ресурсов и `UserPrimaryGroup.DBId[N]` группу рабочей нагрузки, где `N` означает значение идентификатора базы данных. Кроме того, для различных внутренних рабочих нагрузок существует несколько пулов ресурсов и групп рабочей нагрузки.

Кроме использования Resource Governor для управления ресурсами в процессе SQL Server, база данных SQL Azure также использует [объекты заданий](https://docs.microsoft.com/windows/win32/procthread/job-objects) Windows для контроля ресурсов на уровне процесса и [Диспетчер ресурсов файлового сервера Windows (FSRM)](https://docs.microsoft.com/windows-server/storage/fsrm/fsrm-overview) в управлении квотами на хранилище.

Управление ресурсами базы данных SQL Azure является иерархическим. С начала до конца ограничения применяются на уровне ОС и на уровне тома хранилища с помощью механизмов управления ресурсами операционной системы и Resource Governor, на уровне пула ресурсов с помощью Resource Governor, а затем на уровне группы рабочей нагрузки с помощью Resource Governor. Ограничения управления ресурсами, действующие для текущей базы данных или эластичного пула, отображаются в представлении [sys. dm_user_db_resource_governance](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-user-db-resource-governor-azure-sql-database) . 

### <a name="data-io-governance"></a>Управление вводом-выводом данных

Управление вводом-выводом данных — это процесс в базе данных SQL Azure, который позволяет ограничить операции чтения и записи физических операций ввода-вывода для файлов данных базы данных. Ограничения на операции ввода-вывода для каждого уровня обслуживания задаются для того, чтобы максимально сокращать «шум» соседа, чтобы обеспечить равномерное распределение ресурсов в многоклиентской службе и оставаться в пределах возможностей базового оборудования и хранилища.

Для отдельных баз данных ограничения группы рабочей нагрузки применяются ко всем операциям ввода-вывода хранилища для базы данных, а ограничения пула ресурсов применяются ко всем базам данных хранилища на одном и том же экземпляре SQL Server, включая базу данных `tempdb`. Для эластичных пулов ограничения группы рабочей нагрузки применяются к каждой базе данных в пуле, а ограничение пула ресурсов применяется ко всему пулу эластичных БД, включая базу данных `tempdb`, которая является общей для всех баз данных в пуле. В общем случае ограничения пула ресурсов могут быть недостижимыми рабочей нагрузкой для базы данных (отдельной или в составе пула), так как ограничения группы рабочей нагрузки ниже ограничений пула ресурсов и ограничивают скорость операций ввода-вывода и пропускную способность. Однако ограничения пула могут быть достигнуты в совокупной рабочей нагрузке на несколько баз данных на одном и том же экземпляре SQL Server.

Например, если запрос формирует 1000 операций ввода-вывода в секунду без каких-либо операций ввода/вывода, но для группы рабочей нагрузки задано максимальное значение в 900 в секунду, запрос не сможет создать более 900 операций ввода/вывода. Однако если предельное число операций ввода-вывода в секунду для пула ресурсов равно 1500, а общее количество операций ввода/вывода из всех групп рабочей нагрузки, связанных с пулом ресурсов, превышает 1500, то операция ввода-вывода одного и того же запроса может быть снижена под пределами группы в 900 операций ввода-вывода в секунду.

Значения min/max для операций ввода-вывода и пропускной способности, возвращаемые представлением [sys. dm_user_db_resource_governance](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-user-db-resource-governor-azure-sql-database) , действуют как ограничения/Caps, а не как гарантии. Кроме того, управление ресурсами не гарантирует каких бы то ни было конкретных задержек при хранении. Максимально достижимая задержка, число операций ввода-вывода в секунду и пропускная способность для заданной рабочей нагрузки пользователя зависят не только от ограничений управления ресурсами ввода-вывода, но и от того, какие размеры ввода-вывода используются, а также от возможностей базового хранилища. SQL Server использует IOs, размер которых варьируется от 512 КБ до 4 МБ. Для принудительного применения ограничений операций ввода-вывода каждый из них учитывается независимо от их размера, за исключением баз данных с файлами данных в службе хранилища Azure. В этом случае IOs размером свыше 256 КБ учитывается как несколько 256 КБ IOs, чтобы согласовать с учетом операций ввода-вывода службы хранилища Azure.

Для баз данных уровня "базовый", "Стандартный" и "общего назначения", которые используют файлы данных в службе хранилища Azure, значение `primary_group_max_io` может быть недостижимо, если база данных не содержит достаточно файлов данных для накопления числа операций ввода-вывода в секунду или если данные не распределяются равномерно по файлам, или если уровень производительности базовых больших двоичных объектов ограничивает число операций ввода/вывода, заданное в Аналогичным образом, при небольшом объеме операций ввода-вывода журнала, создаваемом частыми фиксациями транзакций, значение `primary_max_log_rate` может быть недостижимо рабочей нагрузкой в связи с ограничением в секунду для хранилища больших двоичных объектов Azure.

Значения использования ресурсов, такие как `avg_data_io_percent` и `avg_log_write_percent`, сообщаемые в представлениях [sys. dm_db_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database), [sys. resource_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database)и [sys. elastic_pool_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) , рассчитываются в процентах максимальных ограничений управления ресурсами. Таким образом, если другие факторы, кроме управления ресурсами, ограничивают количество операций ввода-вывода и пропускную способность, то при увеличении рабочей нагрузки можно просматривать операции ввода-вывода и задержки при увеличении и задержке, даже если отчет об использовании ресурсов остается ниже 100%. 

Чтобы просмотреть и записать операции ввода-вывода, пропускную способность и задержку для каждого файла базы данных, используйте функцию [sys. dm_io_virtual_file_stats ()](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-io-virtual-file-stats-transact-sql) . Эта функция выдает все операции ввода-вывода для базы данных, включая фоновые операции ввода-вывода, которые не учитывают `avg_data_io_percent`, но используют операций ввода-вывода и пропускную способность базового хранилища и могут повлиять на наблюдаемую задержку хранилища. Функция также предоставляет дополнительную задержку, которая может появиться при управлении ресурсами ввода-вывода для операций чтения и записи, в столбцах `io_stall_queued_read_ms` и `io_stall_queued_write_ms` соответственно.

### <a name="transaction-log-rate-governance"></a>Управление частотой ведения журнала транзакций

Управление скоростью журнала транзакций — это процесс в базе данных SQL Azure, который используется для ограничения высоких скоростей приема рабочих нагрузок, таких как массовая вставка, выбор в и построение индекса. Эти ограничения отправляются и применяются на уровне второго уровня к частоте формирования записей журнала, ограничивая пропускную способность независимо от того, сколько IOs может быть выдано для файлов данных.  Скорость создания журнала транзакций в настоящее время масштабируется линейно до точки, зависящей от оборудования, с максимальной частотой ведения журнала 96 МБ/с в модели приобретения Виртуальное ядро. 

> [!NOTE]
> Фактическая физическая операция ввода/вывода с файлами журнала транзакций не регулируется или ограничена.

Скорость ведения журнала задается таким, что их можно достигать и поддерживать в различных сценариях, в то время как вся система может поддерживать свои функции с минимальным влиянием на нагрузку пользователей. Управление частотой ведения журнала гарантирует, что резервные копии журналов транзакций остаются в рамках опубликованных соглашений об уровне обслуживания для восстановления.  Эта система управления также предотвращает чрезмерную невыполненную работу на вторичных репликах.

По мере создания записей журнала каждая операция оценивается и оценивается на необходимость задержки, чтобы поддерживать максимальную требуемую скорость ведения журнала (МБ/с в секунду). Задержки не добавляются, когда записи журнала записываются в хранилище, а в процессе создания частоты журнала применяется управление скоростью журнала.

Фактические частоты создания журналов, накладываемые во время выполнения, могут также повлиять на механизмы обратной связи, временно сокращая допустимые скорости ведения журнала, чтобы система могла стабилизировать работу системы. Управление местом в файле журнала, что позволяет избежать появления пространства журнала, а механизмы репликации группы доступности временно снижают общие системные ограничения.

Формирование трафика регулятора скорости ведения журнала осуществляется с помощью следующих типов ожидания (которые доступны в представлении динамического административного представления [sys. dm_db_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-wait-stats-azure-sql-database) ):

| Тип ожидания | Примечания |
| :--- | :--- |
| LOG_RATE_GOVERNOR | Ограничение базы данных |
| POOL_LOG_RATE_GOVERNOR | Ограничение пула |
| INSTANCE_LOG_RATE_GOVERNOR | Ограничение уровня экземпляра |  
| HADR_THROTTLE_LOG_RATE_SEND_RECV_QUEUE_SIZE | Элемент управления обратной связи, физическая репликация группы доступности в категории "Премиум/критически важный для бизнеса" не содержаться |  
| HADR_THROTTLE_LOG_RATE_LOG_SIZE | Элемент управления обратной связи, ограничивающий тариф, чтобы избежать возникновения нехватки пространства журнала |
|||

При возникновении ограничения скорости ведения журнала, которое ограничивает требуемую масштабируемость, рассмотрите следующие варианты.
- Увеличьте масштаб до более высокого уровня обслуживания, чтобы получить максимальную частоту записи в журнал 96 МБ/с. 
- Если загружаемые данные являются временными, например промежуточные данные в процессе ETL, их можно загрузить в базу данных tempdb (с минимальным протоколированием). 
- Для аналитических сценариев загрузите в таблицу, охваченную кластеризованным индексом columnstore. Это сокращает необходимую частоту ведения журнала из-за сжатия. Этот метод увеличивает загрузку ЦП и применяется только к наборам данных, которые используют преимущества кластеризованных индексов columnstore. 

## <a name="next-steps"></a>Следующие шаги

- Сведения об общих ограничениях Azure см. в разделе [Подписка Azure, границы, квоты и ограничения службы](../azure-resource-manager/management/azure-subscription-service-limits.md).
- Сведения о DTU и eDTU см. в разделе [Общие сведения об обычных единицах передачи данных (DTU) и единицах передачи данных в эластичной базе данных (eDTU)](sql-database-purchase-models.md#dtu-based-purchasing-model).
- Сведения об ограничениях на размер базы данных tempdb см. в [этом разделе](https://docs.microsoft.com/sql/relational-databases/databases/tempdb-database#tempdb-database-in-sql-database).
