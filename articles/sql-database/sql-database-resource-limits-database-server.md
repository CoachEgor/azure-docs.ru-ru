---
title: Ограничения ресурсов базы данных Azure S'L (ru) Документы Майкрософт
description: В этой статье приводится обзор лимитов ресурсов базы данных Azure s'L для отдельных баз данных и эластичных пулов. Здесь также содержится информация о том, что происходит, когда эти ограничения ресурсов соответствуют или превышают допустимые нормы.
services: sql-database
ms.service: sql-database
ms.subservice: single-database
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sstein
ms.reviewer: sashan,moslake,josack
ms.date: 11/19/2019
ms.openlocfilehash: 550c315023c0ae907c369778c81b16e137004bec
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80067264"
---
# <a name="sql-database-resource-limits-and-resource-governance"></a>Ограничения ресурсов базы данных и управления ресурсами базы данных

Статья представляет обзор ограничения ресурсов для сервера Базы данных SQL, который управляет отдельными базами данных и эластичными пулами. В нем содержится информация о том, что происходит при превышении или превышении этих ограничений ресурсов, а также описаны механизмы управления ресурсами, используемые для обеспечения соблюдения этих ограничений.

> [!NOTE]
> Ограничения Управляемого экземпляра см. в разделе [Ограничения ресурсов Базы данных SQL для управляемых экземпляров](sql-database-managed-instance-resource-limits.md).

## <a name="maximum-resource-limits"></a>Максимальное ограничение ресурсов

| Ресурс | Ограничение |
| :--- | :--- |
| Баз данных на сервер | 5000 |
| Количество серверов по умолчанию на одну подписку в любом регионе | 20 |
| Максимальное количество серверов на одну подписку в любом регионе | 200 |  
| Квота DTU или eDTU на сервер | 54 000 |  
| Квота виртуальных ядер на сервер или экземпляр | 540 |
| Максимальное число пулов на сервер | ограничено числом DTU или виртуальных ядер Например, если каждый пул поддерживает 1000 DTU, тогда один сервер может поддерживать 54 пула.|
|||

> [!IMPORTANT]
> По мере приближения количества баз данных к пороговому значению для сервера Базы данных SQL может произойти следующее:
>
> - Увеличение задержки при выполнении запросов к базе данных master.  Сюда входят представления статистических данных использования ресурсов, такие как sys.resource_stats.
> - Увеличение задержки при управлении и отображении для точек наблюдения портала, включая перечисление баз данных на сервере.

> [!NOTE]
> Чтобы получить больше квот DTU/eDTU, квоты vCore или больше серверов, чем сумма по умолчанию, отправьте новый запрос на поддержку на портале Azure. Для получения дополнительной [Request quota increases for Azure SQL Database](quota-increase-request.md)информации см.

### <a name="storage-size"></a>Объем памяти

Для отдельных баз данных объемы хранилища ресурсов относятся либо к [ограничениям ресурсов на основе DTU,](sql-database-dtu-resource-limits-single-databases.md) либо к [ограничениям ресурсов на основе vCore](sql-database-vcore-resource-limits-single-databases.md) для пределов размера хранилища на уровне ценообразования.

## <a name="what-happens-when-database-resource-limits-are-reached"></a>Что происходит при достижении ограничения ресурсов базы данных?

### <a name="compute-dtus-and-edtus--vcores"></a>Вычислительные ресурсы (DTU и eDTU/виртуальные ядра)

Когда использование вычислений баз данных (измеряется DTUs и eDTUs, или vCores) становится высоким, задержка запроса увеличивается, и запросы могут даже тайм-аут. В этих условиях запросы могут стоять в очередях службы и предоставлять ресурсы для выполнения по мере того, как ресурсы становятся свободными.
При интенсивном использовании вычислительных ресурсов возможны следующие варианты предотвращения последствий:

- Увеличение объема вычислительных ресурсов базы данных или эластичного пула для предоставления базе данных дополнительных вычислительных ресурсов. См. разделы [Масштабирование ресурсов отдельной базы данных](sql-database-single-database-scale.md) и [Масштабирование ресурсов эластичного пула](sql-database-elastic-pool-scale.md).
- Оптимизация запросов для сокращения использования ресурсов каждого запроса. Дополнительные сведения см. в разделе [Настройка запросов и указания на них](sql-database-performance-guidance.md#query-tuning-and-hinting).

### <a name="storage"></a>Хранилище

Когда используемое пространство базы данных достигает максимального размера, операции вставки и обновления, увеличивающие размер данных, завершаются сбоем и клиенты получают [сообщение об ошибке](troubleshoot-connectivity-issues-microsoft-azure-sql-database.md). Заявления SELECT и DELETE продолжают преуспевать.

При интенсивном использовании пространства возможны следующие варианты предотвращения последствий:

- Увеличение максимального размера базы данных или эластичного пула или добавление большего объема хранилища. См. разделы [Масштабирование ресурсов отдельной базы данных](sql-database-single-database-scale.md) и [Масштабирование ресурсов эластичного пула](sql-database-elastic-pool-scale.md).
- Если база данных находится в эластичном пуле, то в качестве альтернативы ее можно переместить за пределы пула, чтобы ее дисковое пространство не использовалось совместно с другими базами данных.
- Сжатие базы данных для освобождения неиспользуемого пространства. Дополнительные сведения см. в статье об [управлении файловым пространством в Базе данных SQL Azure](sql-database-file-space-management.md).

### <a name="sessions-and-workers-requests"></a>Сеансы и рабочие роли (запросы)

Максимальное количество сеансов и работников определяется уровнем обслуживания и размером вычислений (DTUs/eDTUs или vCores). При достижении ограничения числа сеансов или рабочих ролей новые запросы отклоняются, а клиенты получают сообщение об ошибке. Хотя приложение может управлять числом доступных подключений, число параллельных рабочих ролей зачастую существенно труднее оценивать и контролировать. Это особенно верно в периоды пиковой нагрузки, когда пределы ресурсов базы данных достигаются и работники накапливаются из-за более длительных запросов, больших цепочек блокировки или чрезмерного параллелизма запросов.

При интенсивном использовании сеансов и рабочих ролей возможны следующие варианты предотвращения последствий:

- Повышение уровня служб или объема вычислительных ресурсов базы данных или эластичного пула. См. разделы [Масштабирование ресурсов отдельной базы данных](sql-database-single-database-scale.md) и [Масштабирование ресурсов эластичного пула](sql-database-elastic-pool-scale.md).
- Оптимизация запросов для сокращения использования ресурсов, необходимых каждому запросу, если причиной повышенного использования рабочих ролей является состязание за вычислительные ресурсы. Дополнительные сведения см. в разделе [Настройка запросов и указания на них](sql-database-performance-guidance.md#query-tuning-and-hinting).
- Уменьшение настройки [MAXDOP](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option#Guidelines) (максимальная степень параллелизма).
- Оптимизация рабочей нагрузки запроса для уменьшения числа возникновений и продолжительности блокировки запроса.

### <a name="resource-consumption-by-user-workloads-and-internal-processes"></a>Потребление ресурсов по рабочим нагрузкам пользователей и внутренним процессам

О потреблении процессора и памяти пользователем рабочих нагрузок в каждой базе данных `avg_cpu_percent` `avg_memory_usage_percent` сообщается в [sys.dm_db_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database?view=azuresqldb-current) и [sys.resource_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database?view=azuresqldb-current) представлениях, в столбцах и столбцах. Для эластичных бассейнов потребление ресурсов на уровне пула сообщается в представлении [sys.elastic_pool_resource_stats.](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) Потребление процессора рабочей нагрузки `cpu_percent` пользователя также регистрируется с помощью метрики Azure Monitor для [отдельных баз данных](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported#microsoftsqlserversdatabases) и [эластичных пулов](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported#microsoftsqlserverselasticpools) на уровне пула.

База данных Azure S'L требует вычислять ресурсы для реализации основных функций службы, таких как высокая доступность и аварийное восстановление, резервное копирование и восстановление базы данных, мониторинг, магазин запросов, автоматическая настройка и т.д. Система выделяет определенную ограниченную часть общих ресурсов для этих внутренних процессов с использованием механизмов [управления ресурсами,](#resource-governance) в результате чего остальная часть ресурсов доступна для рабочих нагрузок пользователей. Иногда, когда внутренние процессы не используют вычислительные ресурсы, система делает их доступными для пользовательских рабочих нагрузок.

Общее общее потребление процессора и памяти по рабочим нагрузкам пользователей и внутренним процессам в экземпляре S'L Server, где `avg_instance_cpu_percent` размещается единая база данных или эластичный пул, сообщается в [sys.dm_db_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database?view=azuresqldb-current) и [sys.resource_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database?view=azuresqldb-current) представлениях, в столбцах и `avg_instance_memory_percent` столбцах. Эти данные также `sqlserver_process_core_percent` регистрируется с помощью метрик Azure `sqlserver_process_memory_percent` Monitor, для [отдельных баз данных](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported#microsoftsqlserversdatabases) и [эластичных пулов](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported#microsoftsqlserverselasticpools) на уровне пула.

Более подробная разбивка последних затрат ресурсов по рабочим нагрузкам пользователей и внутренним процессам сообщается в [sys.dm_resource_governor_resource_pools_history_ex](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-resource-pools-history-ex-azure-sql-database) и [sys.dm_resource_governor_workload_groups_history_ex](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-workload-groups-history-ex-azure-sql-database) представлений. Для получения подробной информации о пулах ресурсов и [Resource governance](#resource-governance)группах рабочей нагрузки, упомянутых в этих представлениях, см. Эти представления сообщают об использовании ресурсов с помощью рабочих нагрузок пользователей и конкретных внутренних процессов в связанных с ними пулах ресурсов и группах рабочей нагрузки.

В контексте мониторинга производительности и устранения неполадок`avg_cpu_percent`важно `cpu_percent`учитывать как потребление **процессора пользователя** (,`avg_instance_cpu_percent`),`sqlserver_process_core_percent`так и общее **потребление процессора** по нагрузкам пользователей и внутренним процессам (, ).

**Потребление процессора пользователя** рассчитывается как процент от ограничений рабочей нагрузки пользователя в каждой цели службы. **Использование процессора пользователя** на 100% указывает на то, что рабочая нагрузка пользователя достигла предела цели службы. Однако, когда **общее потребление процессора** достигает диапазона 70-100%, можно увидеть, что рабочая нагрузка пользователя выравнивается, а задержка запроса увеличивается, даже если сообщается о **потреблении процессора пользователя,** остается значительно ниже 100%. Это более вероятно при использовании меньших целей обслуживания с умеренным распределением вычислительных ресурсов, но относительно интенсивных пользовательских рабочих нагрузок, таких как в [плотных эластичных пулах.](sql-database-elastic-pool-resource-management.md) Это также может происходить с меньшими целями обслуживания, когда внутренние процессы временно требуют дополнительных ресурсов, например при создании новой реплики базы данных.

При **высоком общем потреблении процессора** параметры смягчения являются теми же, что и отмечалось ранее, и включают в себя объективное увеличение службы и/или оптимизацию рабочей нагрузки пользователя.

## <a name="resource-governance"></a>Управление ресурсами

Для обеспечения соблюдения ограничений ресурсов база данных Azure S'L использует реализацию управления ресурсами, основанную на [«Губернаторе ресурсов](https://docs.microsoft.com/sql/relational-databases/resource-governor/resource-governor)сервера» , измененной и расширенной для запуска службы баз данных сервера S'L Server в Azure. На каждом экземпляре сервера S'L в службе имеется несколько [пулов ресурсов](https://docs.microsoft.com/sql/relational-databases/resource-governor/resource-governor-resource-pool) и [групп рабочей нагрузки,](https://docs.microsoft.com/sql/relational-databases/resource-governor/resource-governor-workload-group)с ограничениями ресурсов, установленными как на уровне пула, так и на уровне групп, чтобы обеспечить [сбалансированную базу данных как служба.](https://azure.microsoft.com/blog/resource-governance-in-azure-sql-database/) Нагрузка пользователей и внутренние рабочие нагрузки классифицируются на отдельные пулы ресурсов и группы рабочей нагрузки. Нагрузка пользователя на первичные и читаемые вторичные реплики, `SloSharedPool1` включая `UserPrimaryGroup.DBId[N]` георепликации, `N` классифицируется в пул ресурсов и группу рабочей нагрузки, где обозначаетзначение значения идентификатора базы данных. Кроме того, существует несколько пулов ресурсов и групп рабочей нагрузки для различных внутренних рабочих нагрузок.

Помимо использования Ресурсного управляющего для управления ресурсами в процессе сервера S'L, база данных Azure S'L также использует [объекты работы](https://docs.microsoft.com/windows/win32/procthread/job-objects) Windows для управления ресурсами уровня процесса, а менеджер ресурсов сервера Windows [(FSRM)](https://docs.microsoft.com/windows-server/storage/fsrm/fsrm-overview) для управления квотами хранения данных.

Управление ресурсами базы данных Azure S'L является иерархическим по своему характеру. Сверху вниз, ограничения применяются на уровне ОС и на уровне объема хранилища с использованием механизмов управления ресурсами операционной системы и ресурсного управляющего, затем на уровне ресурсного пула с использованием ресурсного управляющего, а затем на уровне группы рабочей нагрузки с использованием Ресурсный губернатор. Ограничения управления ресурсами, действующие для текущей базы данных или эластичного пула, всплывают в представлении [sys.dm_user_db_resource_governance.](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-user-db-resource-governor-azure-sql-database) 

### <a name="data-io-governance"></a>Управление исправления данных

Управление идентидом данных — это процесс, используемый в базе данных Azure S'L, используемый для ограничения чтения и записи физического итогового с точки зрения файлов данных базы данных. Ограничения IOPS устанавливаются для каждого уровня обслуживания, чтобы свести к минимуму эффект «шумного соседа», обеспечить справедливость распределения ресурсов в мультитенантной службе и оставаться в пределах возможностей базового оборудования и хранилища.

Для отдельных баз данных ограничения группы рабочей нагрузки применяются ко всем исданным хранилищам в отношении базы данных, в то время как ограничения пула ресурсов применяются ко всем исданным данным для хранения данных ко всем базам данных на одном и том же экземпляре S'L Server, включая `tempdb` базу данных. Для эластичных пулов ограничения группы рабочей нагрузки применяются к каждой базе данных `tempdb` в пуле, в то время как ограничение пула ресурсов применяется ко всему эластичной пулу, включая базу данных, которая распределяется между всеми базами данных в пуле. Как правило, лимиты пула ресурсов могут быть недостижимы рабочей нагрузкой по базе данных (либо одноразовой, так и объединенной), поскольку лимиты групп рабочей нагрузки ниже лимитов пула ресурсов и быстрее ограничивают IOPS/пропускную скорость. Однако лимиты пула могут быть достигнуты за счет комбинированной рабочей нагрузки по нескольким базам данных в одном и том же экземпляре S'L Server.

Например, если запрос генерирует 1000 IOPS без какого-либо управления ресурсами IO, но максимальный лимит группы рабочей нагрузки IOPS установлен до 900 IOPS, запрос не сможет генерировать более 900 IOPS. Однако, если максимальный лимит пула ресурсов IOPS установлен до 1500 IOPS, а общий io-й раз из всех групп рабочей нагрузки, связанных с пулом ресурсов, превышает 1500 IOPS, то IO-на-то же запросе может быть уменьшено ниже лимита рабочей группы в 900 IOPS.

IoPS и значения мин/максимум ампутации, возвращенные [sys.dm_user_db_resource_governance](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-user-db-resource-governor-azure-sql-database) view действуют как ограничения/шапки, а не как гарантии. Кроме того, управление ресурсами не гарантирует какой-либо конкретной задержки хранилища. Наилучшая достижимая задержка, IOPS и пропускная способность данной рабочей нагрузки пользователя зависят не только от ограничений управления ресурсами IO, но и от сочетания используемых размеров исправления и от возможностей базового хранилища. Сервер S'L использует IOs, которые различаются по размеру между 512 КБ и 4 МБ. Для обеспечения соблюдения лимитов IOPS каждый итотинг учитывается независимо от его размера, за исключением баз данных с файлами данных в Azure Storage. В этом случае IOs размером более 256 кК учитываются как несколько 256 кБ IOs, чтобы соответствовать учету IO-данных хранилища Azure.

Для баз данных Basic, Standard и General Purpose, которые `primary_group_max_io` используют файлы данных в Azure Storage, значение может быть недостижимо, если база данных не имеет достаточного количества файлов данных, чтобы в совокупности обеспечить это количество IOPS, или если данные не распределены равномерно по файлам, или если уровень производительности основных капотов ограничивает IOPS/емкость ниже предела управления ресурсами. Аналогичным образом, при небольших иомо-журналах, генерируемых частым коммитом транзакций, `primary_max_log_rate` значение может быть недостижимо рабочей нагрузкой из-за лимита IOPS на базовой каббе хранения Azure.

Значения использования ресурсов, такие `avg_data_io_percent` `avg_log_write_percent`как и, сообщается в [sys.dm_db_resource_stats,](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) [sys.resource_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database)и [sys.elastic_pool_resource_stats](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) представлений, рассчитываются как проценты максимальных пределов управления ресурсами. Поэтому, когда факторы, помимо ограничения управления ресурсами, ограничивают IOPS/пропускную способность, можно увидеть, что IOPS/throughput выравниваются, а просривание увеличивается по мере увеличения рабочей нагрузки, даже несмотря на то, что использование ресурсов остается ниже 100%. 

Чтобы просмотреть чтение и запись IOPS, пропускной записи и задержки в файле базы данных, используйте функцию [sys.dm_io_virtual_file_stats().](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-io-virtual-file-stats-transact-sql) Эта функция всплывает на все данные io против `avg_data_io_percent`базы данных, включая фоновый идентиматарный, который не учитывается в отношении, но использует IOPS и пропускную емкость базового хранилища и может повлиять на наблюдаемую задержку хранилища. Функция также всплывает на поверхность дополнительной задержки, которая может быть `io_stall_queued_read_ms` введена управлением ресурсами IO для чтения и записи, соответственно, в столбцах и `io_stall_queued_write_ms` столбцах.

### <a name="transaction-log-rate-governance"></a>Управление тарифом транзакций

Управление тарифами транзакций — это процесс в базе данных Azure S'L, используемый для ограничения высоких показателей приема рабочих нагрузок, таких как объемная вставка, SELECT INTO и сборки индексов. Эти ограничения отслеживаются и применяются на субсекундном уровне до уровня генерации записей журналов, ограничивая пропускную стоимость независимо от количества iOs, которые могут быть выпущены в отношении файлов данных.  Скорость генерации журналов транзакций в настоящее время масштабируется линейно до точки, зависящей от оборудования, при этом максимальная скорость журнала допускается в 96 МБ/с с моделью покупки vCore. 

> [!NOTE]
> Фактические физические ИО для файлов журналов транзакций не регулируются или ограничены.

Ставки журнала устанавливаются таким образом, что они могут быть достигнуты и устойчивы в различных сценариях, в то время как общая система может поддерживать свою функциональность с минимизированным воздействием на пользовательскую нагрузку. Управление коэффициентом входа гарантирует, что резервные копии журналов транзакций остаются в пределах опубликованных SL-систем восстановления.  Это управление также предотвращает чрезмерное отставание по вторичным репликам.

По мере сгенерания записей журналов каждая операция оценивается и оценивается в том, следует ли отложить ее для поддержания максимальной желаемой скорости журнала (Mb/s в секунду). Задержки не добавляются, когда записи журнала смыты в хранилище, а управление тарифом журнала применяется во время генерации скорости журнала себя.

Фактические тарифы генерации журналов, введенные во время выполнения, также могут зависеть от механизмов обратной связи, что временно снижает допустимые ставки журнала, чтобы система могла стабилизироваться. Управление пространством в введомая, избегая запуска из условий пространства журнала и механизмов репликации группы доступности, может временно уменьшить общие пределы системы.

Регистрация скорость губернатора движения формирования всплывает через следующие типы ожидания (выставлены в [sys.dm_db_wait_stats](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-db-wait-stats-azure-sql-database) DMV):

| Тип ожидания | Примечания |
| :--- | :--- |
| LOG_RATE_GOVERNOR | Ограничение базы данных |
| POOL_LOG_RATE_GOVERNOR | Ограничение пула |
| INSTANCE_LOG_RATE_GOVERNOR | Ограничение уровня экземпляров |  
| HADR_THROTTLE_LOG_RATE_SEND_RECV_QUEUE_SIZE | Контроль обратной связи, физическая репликация группы доступности в Premium/Business Critical не поспева |  
| HADR_THROTTLE_LOG_RATE_LOG_SIZE | Контроль обратной связи, ограничение ставок, чтобы избежать выхода из состояния пространства журнала |
|||

При столкновении с ограничением скорости журнала, которое затрудняет желаемую масштабируемость, рассмотрим следующие варианты:
- Масштабируйте до более высокого уровня обслуживания, чтобы получить максимальную скорость входа в систему 96 МБ/с или переключитесь на другой уровень обслуживания. Уровень обслуживания [Hyperscale](sql-database-service-tier-hyperscale.md) обеспечивает скорость входа в систему 100 МБ/с независимо от выбранного уровня обслуживания.
- Если загруженные данные являются временными, например, постановка данных в процессе ETL, они могут быть загружены в tempdb (который минимально регистрируется). 
- Для аналитических сценариев загрузите в кластерную таблицу, охватываемую столбецом. Это снижает требуемую скорость входа из-за сжатия. Этот метод увеличивает использование процессора и применим только к наборам данных, которые извлекают выгоду из кластерных индексов столбцов. 

## <a name="next-steps"></a>Дальнейшие действия

- Сведения об общих ограничениях Azure см. в разделе [Подписка Azure, границы, квоты и ограничения службы](../azure-resource-manager/management/azure-subscription-service-limits.md).
- Сведения о DTU и eDTU см. в разделе [Общие сведения об обычных единицах передачи данных (DTU) и единицах передачи данных в эластичной базе данных (eDTU)](sql-database-purchase-models.md#dtu-based-purchasing-model).
- Сведения об ограничениях на размер базы данных tempdb см. в [этом разделе](https://docs.microsoft.com/sql/relational-databases/databases/tempdb-database#tempdb-database-in-sql-database).
