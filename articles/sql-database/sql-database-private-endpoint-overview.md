---
title: Приватный канал
description: Общие сведения о возможности частной конечной точки
author: rohitnayakmsft
ms.author: rohitna
titleSuffix: Azure SQL Database and SQL Data Warehouse
ms.service: sql-database
ms.topic: overview
ms.reviewer: vanto
ms.date: 09/17/2019
ms.openlocfilehash: 6cc8282a5c56f8f45e8d9e5ee452089a74f0d4ed
ms.sourcegitcommit: 05cdbb71b621c4dcc2ae2d92ca8c20f216ec9bc4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/16/2020
ms.locfileid: "76045638"
---
# <a name="private-link-for-azure-sql-database-and-data-warehouse-preview"></a>Приватный канал для Базы данных и Хранилища данных SQL Azure (предварительная версия)

Приватный канал позволяет подключаться к различным службам PaaS в Azure через **частную конечную точку**. Чтобы получить список служб PaaS, поддерживающих функции Приватного канала, перейдите на страницу [документации по Приватному каналу](../private-link/index.yml). Частная конечная точка — это частный IP-адрес в определенной [виртуальной сети](../virtual-network/virtual-networks-overview.md) и подсети. 

> [!IMPORTANT]
> Эта статья относится к Azure SQL Server, а также к базам данных SQL и хранилища данных SQL, создаваемым на сервере SQL Azure. Для простоты база данных SQL используется как для базы данных SQL, так и для хранилища данных SQL. Эта статья *не* относится к развертыванию **управляемого экземпляра** в Базе данных SQL Azure.

## <a name="data-exfiltration-prevention"></a>Предотвращение кражи данных

Кража данных в Базе данных SQL Azure происходит тогда, когда полномочный пользователь, например администратор базы данных, может извлекать данные из одной системы и перемещать их в другое расположение или систему за пределами организации. Например, пользователь перемещает данные в учетную запись хранения, принадлежащую третьей стороне.

Рассмотрим сценарий с пользователем, запускающим SQL Server Management Studio (SSMS) в виртуальной машине Azure, подключенной к Базе данных SQL. Эта База данных SQL находится в центре обработки данных в западной части США. В приведенном ниже примере показано, как ограничить доступ к общедоступным конечным точкам в Базе данных SQL с помощью средств контроля сетевого доступа.

1. Отключите весь трафик службы Azure к Базе данных SQL, проходящий через общедоступную конечную точку, установив для параметра Allow Azure Services (Разрешить использование служб Azure) значение **Выкл**. Убедитесь, что в правилах брандмауэра на уровне сервера и базы данных не разрешены никакие IP-адреса. Дополнительные сведения см. в статье [Azure SQL Database and Data Warehouse network access controls](sql-database-networkaccess-overview.md) (Средства контроля сетевого доступа Базы данных и Хранилища данных SQL Azure).
1. Разрешите трафик в Базу данных SQL с использованием только частного IP-адреса виртуальной машины. Дополнительные сведения см. в статьях, посвященных [конечной точке службы](sql-database-vnet-service-endpoint-rule-overview.md) и [правилам брандмауэра виртуальной сети](sql-database-firewall-configure.md).
1. На виртуальной машине Azure ограничьте область исходящего подключения, используя [группы безопасности сети (NSG)](../virtual-network/manage-network-security-group.md) и теги службы, как показано ниже:
    - укажите правило NSG, разрешающее трафик для тега службы = SQL.WestUs — разрешение подключения к Базе данных SQL только в западной части США;
    - укажите правило NSG (с **более высоким приоритетом**), чтобы запретить трафик для тега службы = SQL — запрет подключений к Базе данных SQL во всех регионах.

После завершения установки виртуальная машина Azure может подключаться к Базам данных SQL только в западной части США. Но возможность подключения не ограничивается одной Базой данных SQL. Виртуальная машина по-прежнему может подключаться к любым Базам данных SQL в западной части США, включая базы данных, которые не входят в подписку. Хотя мы сократили масштабы кражи данных в приведенном выше сценарии до определенного региона, мы не полностью устранили ее.

Используя Приватный канал, клиенты теперь могут настроить средства контроля сетевого доступа, например группы безопасности сети, чтобы ограничить доступ к частной конечной точке. Затем отдельные ресурсы Azure PaaS сопоставляются с конкретными частными конечными точками. Злоумышленник внутри организации может получить доступ только к сопоставленному ресурсу PaaS (например, к Базе данных SQL) и больше ни к какому другому ресурсу. 

## <a name="on-premises-connectivity-over-private-peering"></a>Локальные подключения через частный пиринг

Когда клиенты подключаются к общедоступной конечной точке из локальных компьютеров, их IP-адреса необходимо добавить в брандмауэр на основе IP-адресов, используя [правило брандмауэра на уровне сервера](sql-database-server-level-firewall-rule.md). Хотя эта модель отлично подходит для предоставления доступа к отдельным компьютерам для рабочих нагрузок разработки или тестирования, управлять ею в рабочей среде сложно.

Используя Приватный канал, клиенты могут включить перекрестный доступ к частной конечной точке с помощью [ExpressRoute](../expressroute/expressroute-introduction.md), частного пиринга или VPN-туннелирования. После этого клиенты могут отключить доступ через общедоступную конечную точку и не использовать брандмауэр на основе IP-адресов для разрешения каких-либо IP-адресов.

Используя Приватный канал, клиенты могут включить перекрестный доступ к частной конечной точке через Express Route (ER), частный пиринг или VPN-туннель. Затем они могут отключить доступ через общедоступную конечную точку и не использовать брандмауэр на основе IP-адресов.

## <a name="how-to-set-up-private-link-for-azure-sql-database"></a>Настройка Приватного канала для Базы данных SQL Azure 

### <a name="creation-process"></a>Процесс создания
Частные конечные точки можно создавать с помощью портала, PowerShell или Azure CLI:
- [Портал](../private-link/create-private-endpoint-portal.md)
- [PowerShell](../private-link/create-private-endpoint-powershell.md)
- [CLI](../private-link/create-private-endpoint-cli.md)

### <a name="approval-process"></a>Процесс утверждения
После того как администратор сети создаст частную конечную точку (PE), администратор SQL может управлять подключением частной конечной точки (PEC) к Базе данных SQL.

1. Перейдите к ресурсу SQL Server в портал Azure согласно шагам, показанным на снимке экрана ниже

    - (1) выберите подключения частной конечной точки в области слева;
    - (2) отобразится список всех подключений частных конечных точек (PEC);
    - (3) соответствующая частная конечная точка (PE) создана ![Снимок экрана всех PEC][3].

1. Выберите отдельное PEC из списка, щелкнув его.
![Снимок экрана с выбранным PEC][6]

1. Администратор SQL может утвердить или отклонить PEC и при необходимости добавить короткий текст ответа.
![Снимок экрана с утверждением PEC][4]

1. После утверждения или отклонения в списке отобразится соответствующее состояние вместе с текстом ответа.
![Снимок экрана со всеми PEC после утверждения][5]

## <a name="use-cases-of-private-link-for-azure-sql-database"></a>Варианты использования Приватного канала для Базы данных SQL Azure 

Клиенты могут подключаться к частной конечной точке из той же виртуальной сети, одноранговой виртуальной сети в том же регионе или через подключение типа "виртуальная сеть — виртуальная сеть" между регионами. Кроме того, клиенты могут подключаться из локальной среды с помощью ExpressRoute, частного пиринга или VPN-туннелирования. Ниже приведена упрощенная схема, на которой показаны распространенные варианты использования.

 ![Схема вариантов подключения][1]

## <a name="test-connectivity-to-sql-database-from-an-azure-vm-in-same-virtual-network-vnet"></a>Проверка подключения к Базе данных SQL из виртуальной машины Azure в той же виртуальной сети

Предположим, что в этом сценарии вы создали виртуальную машину Azure под управлением Windows Server 2016. 

1. [Запустите сеанс удаленного рабочего стола и подключитесь к виртуальной машине](../virtual-machines/windows/connect-logon.md#connect-to-the-virtual-machine). 
1. Затем можно выполнить некоторые проверки подключения, чтобы убедиться, что виртуальная машина подключается к Базе данных SQL через частную конечную точку, используя следующие средства:
    1. Telnet
    1. Psping
    1. Nmap
    1. SQL Server Management Studio (SSMS)

### <a name="check-connectivity-using-telnet"></a>Проверка подключения с помощью Telnet

[Клиент Telnet](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754293%28v%3dws.10%29) — это компонент Windows, который можно использовать для проверки подключения. В зависимости от версии ОС Windows может потребоваться включить этот компонент явным образом. 

Откройте окно командной строки после установки Telnet. Выполните команду Telnet и укажите IP-адрес и частную конечную точку Базы данных SQL.

```
>telnet 10.1.1.5 1433
```

После успешного подключения Telnet в окне командной строки появится пустой экран, как показано на приведенном ниже рисунке.

 ![Схема Telnet][2]

### <a name="check-connectivity-using-psping"></a>Проверка подключения с помощью Psping

[Psping](/sysinternals/downloads/psping) можно использовать следующим образом, чтобы убедиться, что подключение частной конечной точки (PEC) прослушивает подключения через порт 1433.

Запустите Psping следующим образом, указав полное доменное имя сервера Базы данных SQL и порт 1433:

```
>psping.exe mysqldbsrvr.database.windows.net:1433

PsPing v2.10 - PsPing - ping, latency, bandwidth measurement utility
Copyright (C) 2012-2016 Mark Russinovich
Sysinternals - www.sysinternals.com

TCP connect to 10.6.1.4:1433:
5 iterations (warmup 1) ping test:
Connecting to 10.6.1.4:1433 (warmup): from 10.6.0.4:49953: 2.83ms
Connecting to 10.6.1.4:1433: from 10.6.0.4:49954: 1.26ms
Connecting to 10.6.1.4:1433: from 10.6.0.4:49955: 1.98ms
Connecting to 10.6.1.4:1433: from 10.6.0.4:49956: 1.43ms
Connecting to 10.6.1.4:1433: from 10.6.0.4:49958: 2.28ms
```

Выходные данные показывают, что Psping может проверить связь с частным IP-адресом, связанным с PEC.

### <a name="check-connectivity-using-nmap"></a>Проверка подключения с помощью Nmap

Nmap (модуль сопоставления сети) — это бесплатное средство с открытым кодом, используемое для обнаружения сетевых ресурсов и аудита безопасности. Дополнительные сведения и ссылку для скачивания см. на странице https://nmap.org. С помощью этого средства можно обеспечить прослушивание подключений через порт 1433 в частной конечной точке.

Запустите Nmap следующим образом, указав диапазон адресов подсети, в которой размещена частная конечная точка.

```
>nmap -n -sP 10.1.1.0/24
...
...
Nmap scan report for 10.1.1.5
Host is up (0.00s latency).
Nmap done: 256 IP addresses (1 host up) scanned in 207.00 seconds
```

В результате отображается, что работает один IP-адрес, который соответствует IP-адресу частной конечной точки.


### <a name="check-connectivity-using-sql-server-management-studio-ssms"></a>Проверка подключения с помощью SQL Server Management Studio (SSMS)
> [!NOTE]
>Используйте **полное доменное имя** сервера в строках подключения для клиентов. Любые попытки входа, выполненные непосредственно на IP-адресе, будут завершаться ошибкой проектирования.

Выполните следующие действия, чтобы использовать [SSMS для подключения к базе данных SQL](sql-database-connect-query-ssms.md). После подключения к Базе данных SQL с помощью SSMS убедитесь, что вы подключаетесь с частного IP-адреса виртуальной машины Azure, выполнив следующий запрос:

````
select client_net_address from sys.dm_exec_connections 
where session_id=@@SPID
````
> [!NOTE]
> В предварительной версии подключения к частной конечной точке поддерживают в качестве [политики подключения](sql-database-connectivity-architecture.md#connection-policy) только **Прокси-сервер**.


## <a name="connecting-from-an-azure-vm-in-peered-virtual-network-vnet"></a>Подключение из виртуальной машины Azure в одноранговой виртуальной сети (VNet) 

Настройте [пиринг виртуальных сетей](../virtual-network/tutorial-connect-virtual-networks-powershell.md), чтобы установить подключение к Базе данных SQL из виртуальной машины Azure в одноранговой виртуальной сети.

## <a name="connecting-from-an-azure-vm-in-vnet-to-vnet-environment"></a>Подключение из виртуальной машины Azure в среде виртуальных сетей

Настройте [подключение VPN-шлюза типа "виртуальная сеть — виртуальная сеть"](../vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal.md), чтобы установить подключение к Базе данных SQL из виртуальной машины Azure в другом регионе или подписке.

## <a name="connecting-from-an-on-premises-environment-over-vpn"></a>Подключение из локальной среды через VPN

Чтобы установить подключение из локальной среды к Базе данных SQL, выберите и реализуйте один из вариантов:
- [Подключение "точка — сеть"](../vpn-gateway/vpn-gateway-howto-point-to-site-rm-ps.md)
- [VPN-подключение типа "сеть —сеть"](../vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell.md)
- [Канал ExpressRoute](../expressroute/expressroute-howto-linkvnet-portal-resource-manager.md)


## <a name="connecting-from-an-azure-sql-data-warehouse-to-azure-storage-using-polybase"></a>Подключение из Хранилища данных SQL Azure к службе хранилища Azure с помощью Polybase

PolyBase часто используют для загрузки данных в Хранилище данных SQL Azure из учетных записей службы хранилища Azure. Если учетная запись службы хранилища Azure, из которой загружаются данные, предоставляет доступ только к набору подсетей виртуальной сети через частные конечные точки, конечные точки службы или брандмауэры на основе IP-адресов, подключение из PolyBase к учетной записи будет прервано. Чтобы обеспечить возможность импорта и экспорта PolyBase в Хранилище данных SQL Azure, подключенное к службе хранилища Azure, прикрепленной к виртуальной сети, выполните действия, описанные [здесь](sql-database-vnet-service-endpoint-rule-overview.md#impact-of-using-vnet-service-endpoints-with-azure-storage): 



## <a name="next-steps"></a>Дальнейшие действия

- Общие сведения о методах защиты в Базе данных SQL Azure см. в [этой статье](sql-database-security-overview.md).
- Общие сведения об архитектуре подключений к Базе данных SQL Azure см. в [этой статье](sql-database-connectivity-architecture.md).

<!--Image references-->
[1]: ./media/sql-database-get-started-portal/pe-connect-overview.png
[2]: ./media/sql-database-get-started-portal/telnet-result.png
[3]: ./media/sql-database-get-started-portal/pec-list-before.png
[4]: ./media/sql-database-get-started-portal/pec-approve.png
[5]: ./media/sql-database-get-started-portal/pec-list-after.png
[6]: ./media/sql-database-get-started-portal/pec-select.png
