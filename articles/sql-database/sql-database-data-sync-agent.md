---
title: Агент синхронизации данных для синхронизация данных SQL
description: Узнайте, как установить и запустить Агента синхронизации данных для синхронизации данных SQL Azure, чтобы синхронизировать данные в локальных базах данных SQL Server
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: allenwux
ms.author: xiwu
ms.reviewer: carlrab
ms.date: 12/20/2018
ms.openlocfilehash: 6d0a728401ac9f0156cc8fa913ce486bb577c6dd
ms.sourcegitcommit: ac56ef07d86328c40fed5b5792a6a02698926c2d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2019
ms.locfileid: "73825174"
---
# <a name="data-sync-agent-for-azure-sql-data-sync"></a>Агент синхронизации данных для синхронизации данных SQL Azure

Синхронизируйте данные с локальными SQL Server базами данных, установив и настроив агент синхронизации данных для синхронизация данных SQL Azure. Дополнительные сведения о синхронизация данных SQL см. [в статье Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизация данных SQL](sql-database-sync-data.md).

> [!IMPORTANT]
> Служба "Синхронизация данных SQL Azure" пока **не** поддерживает Управляемый экземпляры Базы данных SQL Azure.

## <a name="download-and-install"></a>Загрузка и установка

Загрузить Агент синхронизации данных можно на странице [SQL Azure Data Sync Agent](https://www.microsoft.com/download/details.aspx?id=27693) (Агент синхронизации данных SQL Azure).

### <a name="install-silently"></a>Установка в автоматическом режиме

Чтобы установить Агент синхронизации данных в автоматическом режиме с командной строки, введите команду, аналогичную примеру. Проверьте имя скачанного файла .msi и предоставьте ваши значения для аргументов **TARGETDIR** и **SERVICEACCOUNT**.

- Если не указать значение для **TARGETDIR**, `C:\Program Files (x86)\Microsoft SQL Data Sync 2.0` будет значением по умолчанию.

- Если указать `LocalSystem` в качестве параметра **SERVICEACCOUNT**, используйте проверку подлинности SQL Server при настройке агента для подключения к локальному экземпляру SQL Server.

- Если указать учетную запись пользователя домена или учетную запись локального пользователя в качестве параметра **SERVICEACCOUNT**, необходимо также указать пароль в аргументе **SERVICEPASSWORD**. Пример: `SERVICEACCOUNT="<domain>\<user>"  SERVICEPASSWORD="<password>"`.

```cmd
msiexec /i "SQLDataSyncAgent-2.0-x86-ENU.msi" TARGETDIR="C:\Program Files (x86)\Microsoft SQL Data Sync 2.0" SERVICEACCOUNT="LocalSystem" /qn
```

## <a name="sync-data-with-sql-server-on-premises"></a>Синхронизация данных с локальным сервером SQL Server

Чтобы настроить Агент синхронизации данных для синхронизации с одной и более локальными базами данных SQL Server, см. раздел [Добавление локальной базы данных SQL Server](sql-database-get-started-sql-data-sync.md#add-on-prem).

## <a name="agent-faq"></a> Часто задаваемые вопросы об Агенте синхронизации данных

### <a name="why-do-i-need-a-client-agent"></a>Зачем нужен агент клиента?

Служба синхронизации данных SQL взаимодействует с базами данных SQL Server через агент клиента. Эта функция безопасности избавляет от необходимости поддерживать прямую связь с базами данных, которые защищены брандмауэром. Когда служба синхронизации данных SQL обменивается данными с агентом, используется шифрование соединения и уникальный маркер (*ключ агента*). Базы данных SQL Server выполняют аутентификацию агента по строке подключения и ключу агента. Такой подход обеспечивает высокий уровень безопасности для ваших данных.

### <a name="how-many-instances-of-the-local-agent-ui-can-be-run"></a>Сколько можно запустить экземпляров локального агента пользовательского интерфейса?

Вы можете запустить только один экземпляр пользовательского интерфейса.

### <a name="how-can-i-change-my-service-account"></a>Как изменить учетную запись службы?

После установки агента клиента есть только один способ изменить учетную запись службы: нужно ее удалить и заново установить агент клиента с новой учетной записью.

### <a name="how-do-i-change-my-agent-key"></a>Как изменить ключ агента?

Каждый ключ агента можно использовать для агента только один раз. Его нельзя использовать повторно, если вы удалите агент и установите его заново, а также нельзя применять для нескольких агентов. Если вам нужно создать новый ключ для существующего агента, следите за тем, чтобы в агенте клиента и в службе синхронизации данных SQL был указан один и тот же ключ.

### <a name="how-do-i-retire-a-client-agent"></a>Как отключить агент клиента?

Чтобы немедленно отключить агент (запретить его использование), повторно создайте для него ключ на портале, но не передавайте этот ключ в пользовательский интерфейс агента. При повторном создании ключа нельзя использовать предыдущий, независимо от наличия связи с соответствующим агентом.

### <a name="how-do-i-move-a-client-agent-to-another-computer"></a>Как перенести агент клиента на другой компьютер?

Если вы хотите запустить локальный агент на другом компьютере, выполните следующие действия:

1. Установите агент на новом компьютере.
2. Войдите на портал синхронизации данных SQL и повторно создайте ключ агента для нового агента.
3. Через пользовательский интерфейс нового агента отправьте ему только что созданный ключ агента.
4. Подождите, пока агент клиента скачает список локальных баз данных, которые уже зарегистрированы в системе.
5. Предоставьте учетные данные для подключение ко всем базам данных, которые отмечены как недоступные. Теперь эти базы данных должны стать доступными с нового компьютера, на котором вы установили агент.

## <a name="agent-tshoot"></a> Устранение неполадок Агента синхронизации данных

- [Установка, удаление или восстановление агента клиента завершается ошибкой](#agent-install)

- [Агент клиента не работает после отмены удаления](#agent-uninstall)

- [В списке агента отсутствует моя база данных](#agent-list)

- [Агент клиента не запускается (ошибка 1069)](#agent-start)

- [Невозможно отправить ключ агента](#agent-key)

- [Агент клиента невозможно удалить с портала, если связанная с ним локальная база данных недоступна](#agent-delete)

- [Приложение локального агента синхронизации не может подключиться к локальной службе синхронизации](#agent-connect)

### <a name="agent-install"></a> Установка, удаление или восстановление агента клиента завершается ошибкой

- **Причина**. Этот сбой может произойти во множестве случаев. Чтобы определить конкретную причину этого сбоя, просмотрите журналы.

- **Способы устранения**. Чтобы найти конкретную причину сбоя, следует создать и просмотреть журналы установщика Windows. Включить ведение журнала можно с помощью командной строки. Например, если `SQLDataSyncAgent-2.0-x86-ENU.msi` — это скачанный файл установки, создайте и изучите файлы журналов, используя следующие команды:

  - Для установки: `msiexec.exe /i SQLDataSyncAgent-2.0-x86-ENU.msi /l*v LocalAgentSetup.Log`
  - Для удаления: `msiexec.exe /x SQLDataSyncAgent-2.0-x86-ENU.msi /l*v LocalAgentSetup.Log`

    Вы также можете включить ведение журнала для всех установок, выполняемых установщиком Windows. Дополнительные сведения см. в статье базы знаний Майкрософт [Как включить ведение журнала работы установщика Windows](https://support.microsoft.com/help/223300/how-to-enable-windows-installer-logging). В ней также описано расположение этих журналов.

### <a name="agent-uninstall"></a> Агент клиента не работает после отмены удаления

Агент клиента не работает, даже если вы отменили его удаление.

- **Причина**. Эта проблема возникает из-за того, что агент клиента синхронизации данных SQL не хранит учетные данные.

- **Способы устранения**. Попробуйте применить следующие два способа:

    -   Используйте services.msc для повторного ввода учетных данных агента клиента.
    -   Удалите этот агент клиента и установите его заново. Скачайте и установите последний агент клиента из [центра загрузки](https://www.microsoft.com/download/details.aspx?id=27693).

### <a name="agent-list"></a> В списке агента отсутствует моя база данных

При попытке добавить существующую базу данных SQL Server в группу синхронизации база данных не отображается в списке агентов.

Этот сбой может произойти в следующих случаях:

- **Причина**. Агент клиента и группа синхронизации находятся в разных центрах обработки данных.

- **Способы устранения**. Агент клиента и группа синхронизации должны находиться в одном центре обработки данных. Чтобы обеспечить это, имеются две возможности:

    -   Создайте новый агент в центре обработки данных, в котором находится группа синхронизации. Затем зарегистрируйте базу данных в этом агенте.
    -   Удалите текущую группу синхронизации. Затем повторно создайте группу синхронизации в центре обработки данных, в котором находится агент.

- **Причина**. Список баз данных агента клиента устарел.

- **Способы устранения**. Остановите и перезапустите службу агента клиента.

    Локальный агент скачивает список связанных баз данных только при первой отправке ключа агента. Он не скачивает список связанных баз данных при последующих отправках ключа агента. Базы данных, зарегистрированные во время перемещения агента, не отображаются в исходном экземпляре агента.

### <a name="agent-start"></a> Агент клиента не запускается (ошибка 1069)

Вы обнаружили, что агент не работает на компьютере, на котором размещен сервер SQL Server. При попытке запустить агент вручную отображается диалоговое окно с сообщением об ошибке: "Ошибка 1069. Служба не запущена из-за ошибки входа в систему".

![Диалоговое окно ошибки с синхронизацией данных 1069](media/sql-database-troubleshoot-data-sync/sync-error-1069.png)

- **Причина**. Вероятной причиной этой ошибки является то, что пароль на локальном сервере изменился с момента создания агента и его пароля.

- **Способы устранения**. Обновите пароль агента до текущего пароля сервера.

  1. Найдите службу агента клиента синхронизации данных SQL.  
    а. Щелкните **Запуск**.  
    b. В поле поиска введите **services.msc**.  
    c. В результатах поиска щелкните **Службы**.  
    г) В окне **Службы** прокрутите список до записи **Агент синхронизации данных SQL**.  
  1. Щелкните правой кнопкой мыши **Агент синхронизации данных SQL**, а затем выберите **Остановить**.
  1. Щелкните правой кнопкой мыши **Агент синхронизации данных SQL**, а затем выберите **Свойства**.
  1. В окне **Свойства агента синхронизации данных SQL** щелкните вкладку **Вход**.
  1. Введите пароль в поле **Пароль**.
  1. Повторно введите пароль в поле **Подтверждение пароля**.
  1. Нажмите кнопку **Apply** (Применить), а затем нажмите кнопку **ОК**.
  1. В окне **Службы** щелкните правой кнопкой мыши службу **Агент синхронизации данных SQL**, а затем щелкните **Запуск**.
  1. Закройте окно **Службы**.

### <a name="agent-key"></a>Невозможно отправить ключ агента

После создания или повторного создания ключа агента вы пытаетесь передать этот ключ через приложение SqlAzureDataSyncAgent. Но выполнить отправку не удается.

![Диалоговое окно ошибки синхронизации: не удается отправить ключ агента](media/sql-database-troubleshoot-data-sync/sync-error-cant-submit-agent-key.png)

- **Предварительные требования**. Прежде чем продолжить, обратите внимание на следующие условия:

  - Служба синхронизации данных SQL Windows запущена.

  - Учетная запись службы синхронизации данных SQL Windows имеет доступ к сети.

  - Исходящий порт 1433 открыт в локальном правиле брандмауэра.

  - Локальный IP-адрес добавляется к серверу или в правило брандмауэра базы данных для синхронизации базы данных метаданных.

- **Причина**. Ключ агента уникально идентифицирует каждый локальный агент. Ключ должен соответствовать двум условиям:

  -   Ключи агента клиента на сервере синхронизации данных SQL и локальном компьютере должны быть идентичными.
  -   Ключ агента клиента можно использовать только один раз.

- **Способы устранения**. Если агент не работает, это связано с тем, что одно или оба условия не выполняются. Чтобы агент снова заработал:

  1. Создайте ключ.
  1. Примените новый ключ к агенту.

  Примените новый ключ к агенту.

  1. Используйте проводник для перехода в каталог установки агента. Каталог установки по умолчанию — C:\\Program Files (x86)\\Microsoft SQL Data Sync.
  1. Дважды щелкните подкаталог bin.
  1. Откройте приложение SqlAzureDataSyncAgent.
  1. Щелкните **Submit Agent Key** (Отправить ключ агента).
  1. Вставьте ключ из буфера обмена в соответствующем поле.
  1. Нажмите кнопку **ОК**.
  1. Закройте программу.

### <a name="agent-delete"></a> Агент клиента невозможно удалить с портала, если связанная с ним локальная база данных недоступна

Если локальная конечная точка (то есть база данных), которая зарегистрирована в агенте клиента синхронизации данных SQL, становится недоступной, агент клиента нельзя удалить.

- **Причина**. Локальный агент не может быть удален, так как недоступная база данных все еще зарегистрирована в агенте. При попытке удалить агент процесс удаления пытается подключиться к базе данных, что приводит к ошибке.

- **Способы устранения**. Используйте принудительное удаление, чтобы удалить недоступную базу данных.

> [!NOTE]
> Если таблицы метаданных синхронизации остаются после принудительного удаления, используйте `deprovisioningutil.exe`, чтобы очистить их.

### <a name="agent-connect"></a>Приложение локального агента синхронизации не может подключиться к локальной службе синхронизации

- **Способы устранения**. Попробуйте сделать следующее.

  1. Выйдите из приложения.  
  1. Откройте панель "Службы компонентов".  
    а. В поле поиска на панели задач введите **services.msc**.  
    b. В результатах поиска дважды щелкните **Службы**.  
  1. Остановите работу службы **синхронизации данных SQL**.
  1. Перезапустите службу **синхронизации данных SQL**.  
  1. Повторно откройте приложение.

## <a name="run-the-data-sync-agent-from-the-command-prompt"></a>Запустите Агент синхронизации данных из командной строки

Вы можете запустить такие команды Агента синхронизации данных из командной строки:

### <a name="ping-the-service"></a>Проверка связи со службой

#### <a name="usage"></a>Использование

```cmd
SqlDataSyncAgentCommand.exe -action pingsyncservice
```

#### <a name="example"></a>Пример

```cmd
SqlDataSyncAgentCommand.exe -action "pingsyncservice"
```

### <a name="display-registered-databases"></a>Отображение зарегистрированных баз данных

#### <a name="usage"></a>Использование

```cmd
SqlDataSyncAgentCommand.exe -action displayregistereddatabases
```

#### <a name="example"></a>Пример

```cmd
SqlDataSyncAgentCommand.exe -action "displayregistereddatabases"
```

### <a name="submit-the-agent-key"></a>Отправление ключа агента

#### <a name="usage"></a>Использование

```cmd
Usage: SqlDataSyncAgentCommand.exe -action submitagentkey -agentkey [agent key]  -username [user name] -password [password]
```

#### <a name="example"></a>Пример

```cmd
SqlDataSyncAgentCommand.exe -action submitagentkey -agentkey [agent key generated from portal, PowerShell, or API] -username [user name to sync metadata database] -password [user name to sync metadata database]
```

### <a name="register-a-database"></a>Регистрация базы данных

#### <a name="usage"></a>Использование

```cmd
SqlDataSyncAgentCommand.exe -action registerdatabase -servername [on-premisesdatabase server name] -databasename [on-premisesdatabase name]  -username [domain\\username] -password [password] -authentication [sql or windows] -encryption [true or false]
```

#### <a name="examples"></a>Примеры

```cmd
SqlDataSyncAgentCommand.exe -action "registerdatabase" -serverName localhost -databaseName testdb -authentication sql -username <user name> -password <password> -encryption true

SqlDataSyncAgentCommand.exe -action "registerdatabase" -serverName localhost -databaseName testdb -authentication windows -encryption true

```

### <a name="unregister-a-database"></a>Отмена регистрации базы данных

При использовании этой команды для отмены регистрации базы данных, она полностью отзывает базу данных. Если база присутствует в других группах синхронизации, такая операция нарушит другие группы синхронизации.

#### <a name="usage"></a>Использование

```cmd
SqlDataSyncAgentCommand.exe -action unregisterdatabase -servername [on-premisesdatabase server name] -databasename [on-premisesdatabase name]
```

#### <a name="example"></a>Пример

```cmd
SqlDataSyncAgentCommand.exe -action "unregisterdatabase" -serverName localhost -databaseName testdb
```

### <a name="update-credentials"></a>Обновление учетных данных

#### <a name="usage"></a>Использование

```cmd
SqlDataSyncAgentCommand.exe -action updatecredential -servername [on-premisesdatabase server name] -databasename [on-premisesdatabase name]  -username [domain\\username] -password [password] -authentication [sql or windows] -encryption [true or false]
```

#### <a name="examples"></a>Примеры

```cmd
SqlDataSyncAgentCommand.exe -action "updatecredential" -serverName localhost -databaseName testdb -authentication sql -username <user name> -password <password> -encryption true

SqlDataSyncAgentCommand.exe -action "updatecredential" -serverName localhost -databaseName testdb -authentication windows -encryption true
```

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о Синхронизации данных SQL см. в следующих статьях:

-   Обзор: [Синхронизация данных в нескольких облачных и локальных базах данных с помощью функции синхронизации данных SQL Azure](sql-database-sync-data.md).
-   Настройка синхронизации данных
    - На портале: [Руководство по настройке синхронизации данных SQL между базой данных SQL Azure и локальной базой данных SQL Server](sql-database-get-started-sql-data-sync.md).
    - С помощью PowerShell
        -  [Использование PowerShell для синхронизации данных между несколькими базами данных SQL Azure](scripts/sql-database-sync-data-between-sql-databases.md)
        -  [Использование PowerShell для синхронизации данных между базой данных SQL Azure и локальной базой данных SQL Server](scripts/sql-database-sync-data-between-azure-onprem.md)
-   Рекомендации: [Рекомендации по синхронизации данных SQL](sql-database-best-practices-data-sync.md).
-   Мониторинг: [Мониторинг синхронизации данных SQL с помощью журналов Azure Monitor](sql-database-sync-monitor-oms.md)
-   Устранение неполадок: [Устранение неполадок с синхронизацией данных SQL](sql-database-troubleshoot-data-sync.md).
-   Обновление схемы синхронизации
    -   С помощью Transact-SQL: [Автоматическая репликация изменений схемы при синхронизации данных SQL Azure](sql-database-update-sync-schema.md).
    -   С помощью PowerShell: [Использование PowerShell для обновления схемы синхронизации в существующей группе синхронизации](scripts/sql-database-sync-update-schema.md).
