---
title: Ограничения функций базы данных SQL Azure | Документация Майкрософт
description: Ограничения функций базы данных SQL Azure улучшают безопасность базы данных за счет ограничения функций в базе данных, которые злоумышленники могут получить доступ к информации в них.
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: vainolo
ms.author: arib
ms.reviewer: vanto
ms.date: 03/22/2019
ms.openlocfilehash: 5f5123624b5b9388baf799b48127b5b796eec21b
ms.sourcegitcommit: 7c4de3e22b8e9d71c579f31cbfcea9f22d43721a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/26/2019
ms.locfileid: "68568219"
---
# <a name="azure-sql-database-feature-restrictions"></a>Ограничения функций базы данных SQL Azure

Одним из распространенных источников SQL Server атак является веб-приложения, обращающиеся к базе данных, где для получения сведений о базе данных используются различные формы атак путем внедрения кода SQL.  В идеале код приложения разрабатывается таким образом, что он не поддерживает внедрение кода SQL.  Однако в больших основанных на коде базах данных, включающих устаревший и внешний код, нельзя гарантировать, что все варианты были устранены, поэтому внедрение SQL — это тот факт, с которым необходимо защищаться.  Цель ограничений функций заключается в предотвращении некоторых форм внедрения кода SQL от утечки информации о базе данных даже в случае успеха внедрения кода SQL.

## <a name="enabling-feature-restrictions"></a>Включение ограничений функций

Включение ограничений функций выполняется с помощью `sp_add_feature_restriction` хранимой процедуры следующим образом:

```sql
EXEC sp_add_feature_restriction <feature>, <object_class>, <object_name>
```

Следующие функции могут быть ограничены:

| Компонент          | Описание |
|------------------|-------------|
| Н'еррормессажес " | При наличии ограничений все данные пользователя в сообщении об ошибке будут замаскированы. См. раздел [Message Error ограничение функции](#error-messages-feature-restriction) |
| Н'ваитфор "       | При ограниченном использовании команда будет возвращаться немедленно без какой бы то ни было задержки. См. раздел [WAITFOR ограничение функции](#waitfor-feature-restriction) . |

Значение `object_class` может быть `N'User'` либолибо`object_name` , либо дляобозначения,являетсялиимяпользователяилиимяроливбазеданных.`N'Role'`

В следующем примере все сообщения об ошибках для пользователя `MyUser` будут замаскированы:

```sql
EXEC sp_add_feature_restriction N'ErrorMessages', N'User', N'MyUser'
```

## <a name="disabling-feature-restrictions"></a>Отключение ограничений функций

Отключение ограничений функций выполняется с помощью `sp_drop_feature_restriction` хранимой процедуры следующим образом:

```sql
EXEC sp_drop_feature_restriction <feature>, <object_class>, <object_name>
```

В следующем примере отключается маскирование сообщений об `MyUser`ошибках для пользователя:

```sql
EXEC sp_drop_feature_restriction N'ErrorMessages', N'User', N'MyUser'
```

## <a name="viewing-feature-restrictions"></a>Просмотр ограничений функций

`sys.sql_feature_restrictions` Представление представляет все определенные в настоящее время ограничения функций для базы данных. Он содержит следующие столбцы:

| Имя столбца | Тип данных | Описание |
|-------------|-----------|-------------|
| класс       | nvarchar(128) | Класс объекта, к которому применяется ограничение |
| объект      | nvarchar(256) | Имя объекта, к которому применяется ограничение |
| запросов"     | nvarchar(128) | Ограниченная функция |

## <a name="feature-restrictions"></a>Функциональные ограничения

### <a name="error-messages-feature-restriction"></a>Ограничение функции сообщений об ошибках

Один из распространенных методов атаки путем внедрения кода SQL заключается в том, чтобы внедрить код, вызывающий ошибку.  Изучив сообщение об ошибке, злоумышленник может получить сведения о системе, что обеспечивает дополнительные целевые атаки.  Такая атака может быть особенно полезной, когда приложение не отображает результаты запроса, но отображает сообщения об ошибках.

Рассмотрим веб-приложение с запросом в виде:

```html
http://www.contoso.com/employee.php?id=1
```

Который выполняет следующий запрос к базе данных:

```sql
SELECT Name FROM EMPLOYEES WHERE Id=$EmpId
```

Если значение, передаваемое в `id` качестве параметра в запрос веб-приложения, копируется для замены $EmpID в запросе к базе данных, злоумышленник может выполнить следующий запрос:

```html
http://www.contoso.com/employee.php?id=1 AND CAST(DB_NAME() AS INT)=0
```

И будет возвращена следующая ошибка, позволяющая злоумышленнику узнать имя базы данных:

```sql
Conversion failed when converting the nvarchar value 'HR_Data' to data type int.
```

После включения ограничения функции сообщений об ошибках для пользователя приложения в базе данных возвращенное сообщение об ошибке маскируется таким образом, что внутренняя информация о базе данных не будет утечка:

```sql
Conversion failed when converting the ****** value '******' to data type ******.
```

Аналогичным образом злоумышленник может выполнить следующий запрос:

```html
http://www.contoso.com/employee.php?id=1 AND CAST(Salary AS TINYINT)=0
```

И будет возвращена следующая ошибка, позволяющая злоумышленнику узнать о заработной плате сотрудника:

```sql
Arithmetic overflow error for data type tinyint, value = 140000.
```

С помощью ограничения функций сообщений об ошибках база данных возвращает:

```sql
Arithmetic overflow error for data type ******, value = ******.
```

### <a name="waitfor-feature-restriction"></a>Ограничение функции WAITFOR

Злонамеренная атака SQL заключается в том, что приложение не предоставляет злоумышленнику результаты введенного кода SQL или сообщения об ошибке, но злоумышленник может вывести информацию из базы данных, создав условный запрос, в котором две условные ветви выполнение занимает другое количество времени. Сравнивая время отклика, злоумышленник может узнать, какая ветвь была выполнена, и, тем самым, получить сведения о системе. Самый простой вариант такой атаки — использование `WAITFOR` оператора для представления задержки.

Рассмотрим веб-приложение с запросом в виде:

```html
http://www.contoso.com/employee.php?id=1
```

который выполняет следующий запрос к базе данных:

```sql
SELECT Name FROM EMPLOYEES WHERE Id=$EmpId
```

Если значение, передаваемое в качестве параметра идентификатора для запросов веб-приложения, копируется для замены $EmpId в запросе к базе данных, злоумышленник может выполнить следующий запрос:

```html
http://www.contoso.com/employee.php?id=1; IF SYSTEM_USER='sa' WAITFOR DELAY '00:00:05'
```

И при `sa` использовании учетной записи запрос займет еще 5 секунд. Если `WAITFOR` в базе данных отключено ограничение функции `WAITFOR` , инструкция будет проигнорирована, а сведения не будут потеряны с помощью этой атаки.