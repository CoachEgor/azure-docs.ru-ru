---
title: Ограничения компонентов
description: Ограничения функций базы данных SQL Azure улучшают безопасность базы данных за счет ограничения функций в базе данных, которые злоумышленники могут получить доступ к информации в них.
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: barmichal
ms.author: mibar
ms.reviewer: vanto
ms.date: 03/22/2019
ms.openlocfilehash: ce10daca23299f838e4086426fa89d9cade314ea
ms.sourcegitcommit: ac56ef07d86328c40fed5b5792a6a02698926c2d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2019
ms.locfileid: "73823436"
---
# <a name="azure-sql-database-feature-restrictions"></a>Ограничения функций базы данных SQL Azure

Одним из распространенных источников SQL Server атак является веб-приложения, обращающиеся к базе данных, где для получения сведений о базе данных используются различные формы атак путем внедрения кода SQL.  В идеале код приложения разрабатывается таким образом, что он не поддерживает внедрение кода SQL.  Однако в больших основанных на коде базах данных, включающих устаревший и внешний код, нельзя гарантировать, что все варианты были устранены, поэтому внедрение SQL — это тот факт, с которым необходимо защищаться.  Цель ограничений функций заключается в предотвращении некоторых форм внедрения кода SQL от утечки информации о базе данных даже в случае успеха внедрения кода SQL.

## <a name="enabling-feature-restrictions"></a>Включение ограничений функций

Включение ограничений функций выполняется с помощью хранимой процедуры `sp_add_feature_restriction`, как показано ниже.

```sql
EXEC sp_add_feature_restriction <feature>, <object_class>, <object_name>
```

Следующие функции могут быть ограничены:

| Функция          | ОПИСАНИЕ |
|------------------|-------------|
| Н'еррормессажес " | При наличии ограничений все данные пользователя в сообщении об ошибке будут замаскированы. См. раздел [Message Error Restriction](#error-messages-feature-restriction) |
| Н'ваитфор "       | При ограниченном использовании команда будет возвращаться немедленно без какой бы то ни было задержки. См. раздел [WAITFOR ограничение функции](#waitfor-feature-restriction) . |

Значение `object_class` может быть либо `N'User'`, либо `N'Role'`, чтобы указать, является ли `object_name` именем пользователя или именем роли в базе данных.

Следующий пример приведет к маскированию всех сообщений об ошибках для пользователя `MyUser`:

```sql
EXEC sp_add_feature_restriction N'ErrorMessages', N'User', N'MyUser'
```

## <a name="disabling-feature-restrictions"></a>Отключение ограничений функций

Отключение ограничений функций выполняется с помощью хранимой процедуры `sp_drop_feature_restriction`, как показано ниже.

```sql
EXEC sp_drop_feature_restriction <feature>, <object_class>, <object_name>
```

Следующий пример отключает маскирование сообщений об ошибках для `MyUser`пользователя:

```sql
EXEC sp_drop_feature_restriction N'ErrorMessages', N'User', N'MyUser'
```

## <a name="viewing-feature-restrictions"></a>Просмотр ограничений функций

Представление `sys.sql_feature_restrictions` представляет все определенные в настоящее время ограничения функций в базе данных. Он содержит следующие столбцы:

| Имя столбца | Тип данных | ОПИСАНИЕ |
|-------------|-----------|-------------|
| class       | nvarchar(128) | Класс объекта, к которому применяется ограничение |
| object      | nvarchar(256) | Имя объекта, к которому применяется ограничение |
| Функциями     | nvarchar(128) | Ограниченная функция |

## <a name="feature-restrictions"></a>Функциональные ограничения

### <a name="error-messages-feature-restriction"></a>Ограничение функции сообщений об ошибках

Один из распространенных методов атаки путем внедрения кода SQL заключается в том, чтобы внедрить код, вызывающий ошибку.  Изучив сообщение об ошибке, злоумышленник может получить сведения о системе, что обеспечивает дополнительные целевые атаки.  Такая атака может быть особенно полезной, когда приложение не отображает результаты запроса, но отображает сообщения об ошибках.

Рассмотрим веб-приложение с запросом в виде:

```html
http://www.contoso.com/employee.php?id=1
```

Который выполняет следующий запрос к базе данных:

```sql
SELECT Name FROM EMPLOYEES WHERE Id=$EmpId
```

Если значение, передаваемое в качестве параметра `id` в запрос веб-приложения, копируется для замены $EmpId в запросе к базе данных, злоумышленник может выполнить следующий запрос:

```html
http://www.contoso.com/employee.php?id=1 AND CAST(DB_NAME() AS INT)=0
```

И будет возвращена следующая ошибка, позволяющая злоумышленнику узнать имя базы данных:

```sql
Conversion failed when converting the nvarchar value 'HR_Data' to data type int.
```

После включения ограничения функции сообщений об ошибках для пользователя приложения в базе данных возвращенное сообщение об ошибке маскируется таким образом, что внутренняя информация о базе данных не будет утечка:

```sql
Conversion failed when converting the ****** value '******' to data type ******.
```

Аналогичным образом злоумышленник может выполнить следующий запрос:

```html
http://www.contoso.com/employee.php?id=1 AND CAST(Salary AS TINYINT)=0
```

И будет возвращена следующая ошибка, позволяющая злоумышленнику узнать о заработной плате сотрудника:

```sql
Arithmetic overflow error for data type tinyint, value = 140000.
```

С помощью ограничения функций сообщений об ошибках база данных возвращает:

```sql
Arithmetic overflow error for data type ******, value = ******.
```

### <a name="waitfor-feature-restriction"></a>Ограничение функции WAITFOR

Злонамеренная атака SQL заключается в том, что приложение не предоставляет злоумышленнику результаты введенного кода SQL или сообщения об ошибке, но злоумышленник может вывести информацию из базы данных, создав условный запрос, в котором две условные ветви выполнение занимает другое количество времени. Сравнивая время отклика, злоумышленник может узнать, какая ветвь была выполнена, и, тем самым, получить сведения о системе. Самый простой вариант такой атаки — использование оператора `WAITFOR` для представления задержки.

Рассмотрим веб-приложение с запросом в виде:

```html
http://www.contoso.com/employee.php?id=1
```

Который выполняет следующий запрос к базе данных:

```sql
SELECT Name FROM EMPLOYEES WHERE Id=$EmpId
```

Если значение, передаваемое в качестве параметра идентификатора для запросов веб-приложения, копируется для замены $EmpId в запросе к базе данных, злоумышленник может выполнить следующий запрос:

```html
http://www.contoso.com/employee.php?id=1; IF SYSTEM_USER='sa' WAITFOR DELAY '00:00:05'
```

И при использовании учетной записи `sa` запрос займет еще 5 секунд. Если в базе данных отключено ограничение функции `WAITFOR`, то инструкция `WAITFOR` будет проигнорирована, а информация не будет утечка при использовании этой атаки.