---
title: Мониторинг синхронизации данных SQL Azure с помощью журналов Azure Monitor | Документация Майкрософт
description: Узнайте, как выполнять мониторинг синхронизации данных SQL Azure с помощью журналов Azure Monitor
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: data sync
ms.devlang: ''
ms.topic: conceptual
author: allenwux
ms.author: xiwu
ms.reviewer: carlrab
manager: craigg
ms.date: 12/20/2018
ms.openlocfilehash: 6e94aac47ce5b45e700e2413d2e86d5f36596348
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "60614955"
---
# <a name="monitor-sql-data-sync-with-azure-monitor-logs"></a>Мониторинг синхронизации данных SQL с помощью журналов Azure Monitor 

Чтобы проверить журнал действий синхронизации данных SQL и обнаружить ошибки и предупреждения, необходимо сначала проверить синхронизацию данных SQL вручную на портале Azure, с помощью PowerShell или REST API. Выполните шаги в этой статье, чтобы настроить пользовательское решение, которое улучшает мониторинг синхронизации данных. Вы можете настроить это решение в соответствии со своим сценарием.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

Общие сведения о синхронизации данных SQL см. в статье [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL Azure](sql-database-sync-data.md).

> [!IMPORTANT]
> Служба синхронизации данных SQL Azure пока **не** поддерживает управляемые экземпляры базы данных SQL Azure.

## <a name="monitoring-dashboard-for-all-your-sync-groups"></a>Мониторинг панели мониторинга для всех групп синхронизации 

Больше нет необходимости просматривать журналы каждой группы синхронизации по отдельности для поиска проблем. Вы можете отслеживать всех групп синхронизации из любой из подписок в одном месте с помощью пользовательского представления Azure Monitor. В этом представлении отображается информация, которая важна для клиентов синхронизации данных SQL.

![Панель мониторинга синхронизации данных](media/sql-database-sync-monitor-oms/sync-monitoring-dashboard.png)

## <a name="automated-email-notifications"></a>Автоматические уведомления по электронной почте

Вам больше не требуется проверять журнал вручную на портале Azure, через PowerShell или REST API. С помощью [Azure Monitor регистрирует](https://docs.microsoft.com/azure/log-analytics/log-analytics-overview), вы можете создавать оповещения, которые отправляются непосредственно на адреса электронной почты тех, кто должен видеть их в случае ошибки.

![Уведомления по электронной почте о синхронизации данных](media/sql-database-sync-monitor-oms/sync-email-notifications.png)

## <a name="how-do-you-set-up-these-monitoring-features"></a>Как настроить эти возможности мониторинга? 

Реализация настраиваемого монитора Azure регистрирует решение мониторинга для синхронизации данных SQL в менее чем за час, выполнив следующие действия:

Необходимо настроить три компонента:

-   Модуль runbook PowerShell для передачи данных журнала синхронизации данных SQL Azure Monitor журналы.

-   Оповещения Azure Monitor для уведомлений по электронной почте.

-   Представление мониторинга Azure для мониторинга.

### <a name="samples-to-download"></a>Примеры для скачивания

Скачайте два следующих образца:

-   [Модуль runbook PowerShell для журнала синхронизации данных](https://github.com/Microsoft/sql-server-samples/blob/master/samples/features/sql-data-sync/DataSyncLogPowerShellRunbook.ps1)

-   [Представление Azure Monitor для синхронизации данных](https://github.com/Microsoft/sql-server-samples/blob/master/samples/features/sql-data-sync/DataSyncLogOmsView.omsview)

### <a name="prerequisites"></a>Технические условия

Настройте следующие компоненты:

-   учетную запись службы автоматизации Azure;

-   Рабочая область Log Analytics

## <a name="powershell-runbook-to-get-sql-data-sync-log"></a>Использование модуля runbook PowerShell для получения журнала синхронизации данных SQL 

Модуль runbook PowerShell, размещенный в службе автоматизации Azure позволяет извлечь данные журнала синхронизации данных SQL и отправлять их в журналы Azure Monitor. Пример сценария включен. Предварительно необходимо создать учетную запись службы автоматизации Azure. Затем необходимо создать модуль runbook и запланировать его запуск. 

### <a name="create-a-runbook"></a>Создание модуля runbook

Дополнительные сведения о создании модулей runbook см. в статье [Мой первый модуль Runbook PowerShell](https://docs.microsoft.com/azure/automation/automation-first-runbook-textual-powershell).

1.  В рамках учетной записи службы автоматизации Azure выберите вкладку **Модули Runbook** в разделе Process Automation (Автоматизация процессов).

2.  Выберите **Добавить Runbook** в верхнем левом углу на странице модулей Runbook.

3.  Выберите **Импорт существующего модуля Runbook**.

4.  В разделе **Runbook file** (Файл runbook) используйте данный файл `DataSyncLogPowerShellRunbook`. Задайте **тип runbook** как `PowerShell`. Присвойте имя модулю runbook.

5.  Нажмите кнопку **Создать**. Теперь у вас есть модуль runbook.

6.  В рамках учетной записи службы автоматизации Azure в разделе "Общие ресурсы" выберите вкладку **Переменные**.

7.  На странице "Переменные" выберите **Add a variable** (Добавить переменную). Создайте переменную для времени последнего выполнения модуля Runbook. Если у вас есть несколько модулей runbook, необходимо создать переменную для каждого из них.

8.  Присвойте переменной имя `DataSyncLogLastUpdatedTime` и задайте для нее тип DateTime.

9.  Выберите runbook и нажмите кнопку "Изменить" в верхней части страницы.

10. Внесите необходимые изменения в учетной записи и конфигурации синхронизации данных SQL. (Дополнительные сведения см. в примере сценария.)

    1.  Сведения, касающиеся Azure.

    2.  Сведения о группе синхронизации.

    3.  Azure Monitor заносит в журнал сведения. Эти сведения можно найти на портале Azure, выбрав "Параметры | Подключенные источники". Дополнительные сведения об отправке данных в журналы Azure Monitor см. в разделе [отправки данных в Azure Monitor журналов с помощью API сборщика данных HTTP (Предварительная версия)](../azure-monitor/platform/data-collector-api.md).

11. Запустите runbook в области тестирования. Убедитесь, что он выполнен успешно.

    При наличии ошибок убедитесь, что у вас установлена последняя версия модуля PowerShell. Вы можете установить последнюю версию модуля PowerShell в **коллекции модулей** в вашей учетной записи службы автоматизации.

12. Щелкните **Опубликовать**.

### <a name="schedule-the-runbook"></a>Создание расписания для runbook

Чтобы создать расписание для runbook:

1.  В модуле runbook в разделе Resources (Ресурсы) выберите вкладку **Schedules** (Расписания).

2.  Выберите **Add a Schedule** (Добавить расписание) на странице Schedules (Расписания).

3.  Выберите **Link a Schedule to your runbook** (Связать расписание с модулем runbook).

4.  Выберите **Create a new schedule** (Создать новое расписание).

5.  Задайте **повторение** и установите необходимый интервал. Используйте этот интервал здесь, в скрипте и в журналах Azure Monitor.

6.  Нажмите кнопку **Создать**.

### <a name="check-the-automation"></a>Проверка автоматизации

Для наблюдения за тем, работает ли автоматизация как ожидалось, в разделе **Обзор** вашей учетной записи автоматизации в разделе **Мониторинг** найдите представление **Job Statistics** (Статистика задания). Закрепите представление на панели мониторинга, чтобы его было удобнее просматривать. Успешные запуски Runbook имеют состояние "Завершено", а для запусков, которые завершились сбоем, отображается состояние "Сбой".

## <a name="create-an-azure-monitor-reader-alert-for-email-notifications"></a>Создание оповещения Azure Monitor чтения для уведомлений по электронной почте

Чтобы создать оповещение, которое использует журналы Azure Monitor, выполните указанные ниже действия. Перед началом необходимо иметь журналы Azure Monitor, связанной с рабочей областью Log Analytics.

1.  На портале Azure выберите **Поиск по журналу**.

2.  Создайте запрос, чтобы выбрать ошибки и предупреждения по группе синхронизации в течение выбранного интервала. Пример:

    `Type=DataSyncLog\_CL LogLevel\_s!=Success| measure count() by SyncGroupName\_s interval 60minute`

3.  После выполнения запроса щелкните значок в виде колокольчика, сигнализирующий об **оповещении**.

4.  В разделе **Generate alert based on** (Создать оповещение на основе) выберите **Metric Measurement** (Измерение метрик).

    1.  Установите статистическое значение **Больше чем**.

    2.  После задания **Больше чем** введите пороговое значение, по достижении которого начнут поступать уведомления. В синхронизации данных ожидаются временные ошибки. Для снижения шума задайте пороговое значение 5.

5.  В разделе **Действия** задайте для параметра **Уведомление по электронной почте** значение "Да". Введите необходимые электронные адреса получателей.

6.  Выберите команду **Сохранить**. Теперь при возникновении ошибок заданные получатели будут получать уведомления по электронной почте.

## <a name="create-an-azure-monitor-view-for-monitoring"></a>Создать представление Azure Monitor для мониторинга

Этот шаг создает представление Azure Monitor для визуального мониторинга всех заданных групп синхронизации. Представление содержит несколько компонентов:

-   плитку обзора, которая показывает количество ошибок, успешных выполнений и предупреждений во всех группах синхронизации;

-   плитку для всех групп синхронизации, которая показывает количество ошибок и предупреждений в группе синхронизации (группы, в которых нет сбоев, не отображаются на этой плитке);

-   плитку для каждой группы синхронизации, которая показывает количество ошибок, успешных выполнений, предупреждений, а также недавних сообщений об ошибках.

Чтобы настроить представление мониторинга Azure, выполните указанные ниже действия.

1.  На домашней странице рабочей области Log Analytics, выберите знак "плюс" слева, чтобы открыть **конструктор представлений**.

2.  Выберите **Импорт** на верхней панели конструктора представлений. Затем выберите пример файла "DataSyncLogOMSView".

3.  Этот пример представления предназначен для управления двумя группами синхронизации. Измените это представление в соответствии с вашим сценарием. Щелкните **Изменить** и внесите следующие изменения:

    1.  При необходимости создайте объекты "Кольцевая диаграмма и список" из коллекции.

    2.  В каждой плитке обновите запросы, указав свои сведения.

        1.  В каждой плитке измените интервал TimeStamp_t соответствующим образом.

        2.  На плитках каждой группы синхронизации обновите имена групп синхронизации.

    3.  Обновите название каждой плитки соответствующим образом.

4.  Нажмите кнопку **Сохранить**. Представление готово.

## <a name="cost-of-this-solution"></a>Стоимость этого решения

В большинстве случаев это решение будет бесплатным.

**Служба автоматизации Azure.** В зависимости от использования могут возникнуть дополнительные затраты, связанные с учетной записью службы автоматизации Azure. Первые 500 минут времени выполнения заданий в месяц бесплатны. Ожидается, что в большинстве случаев это решение будет использовать менее 500 минут в месяц. Чтобы избежать расходов, создайте расписание для runbook с интервалом в два или более часов. Дополнительные сведения см. на странице [цен на службу автоматизации](https://azure.microsoft.com/pricing/details/automation/).

**Журналы Azure Monitor:** Возможно, затраты, связанные с журналами Azure Monitor, в зависимости от использования. На бесплатном уровне доступно 500 МБ получаемых данных в день. Ожидается, что в большинстве случаев это решение будет принимать менее чем 500 МБ в день. Чтобы уменьшить потребление, используйте фильтрацию по сбоям, включенную в runbook. При использовании более 500 МБ в день необходимо перейти на платный уровень во избежание риска возможной остановки аналитики по достижении ограничений. Дополнительные сведения см. в разделе [Azure Monitor регистрирует цены](https://azure.microsoft.com/pricing/details/log-analytics/).

## <a name="code-samples"></a>Примеры кода

Скачайте примеры кода, описанные в этой статье, по следующим ссылкам:

-   [Модуль runbook PowerShell для журнала синхронизации данных](https://github.com/Microsoft/sql-server-samples/blob/master/samples/features/sql-data-sync/DataSyncLogPowerShellRunbook.ps1)

-   [Представление Azure Monitor для синхронизации данных](https://github.com/Microsoft/sql-server-samples/blob/master/samples/features/sql-data-sync/DataSyncLogOmsView.omsview)

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о синхронизации данных SQL:

-   Обзор: [Синхронизация данных в нескольких облачных и локальных базах данных с помощью функции синхронизации данных SQL Azure](sql-database-sync-data.md).
-   Настройка синхронизации данных
    - На портале: [Руководство по настройке синхронизации данных SQL между Базой данных SQL Azure и локальной базой данных SQL Server](sql-database-get-started-sql-data-sync.md)
    - С помощью PowerShell
        -  [Использование PowerShell для синхронизации данных между несколькими базами данных SQL Azure](scripts/sql-database-sync-data-between-sql-databases.md)
        -  [Использование PowerShell для синхронизации данных между базой данных SQL Azure и локальной базой данных SQL Server](scripts/sql-database-sync-data-between-azure-onprem.md)
-   Агент синхронизации данных: [Агент синхронизации данных для синхронизации данных SQL Azure](sql-database-data-sync-agent.md).
-   Рекомендации: [Рекомендации по синхронизации данных SQL](sql-database-best-practices-data-sync.md).
-   Устранение неполадок: [Устранение неполадок с синхронизацией данных SQL](sql-database-troubleshoot-data-sync.md).
-   Обновление схемы синхронизации
    -   С помощью Transact-SQL: [Автоматическая репликация изменений схемы при синхронизации данных SQL Azure](sql-database-update-sync-schema.md).
    -   С помощью PowerShell: [Использование PowerShell для обновления схемы синхронизации в существующей группе синхронизации](scripts/sql-database-sync-update-schema.md).

Дополнительные сведения о Базе данных SQL:

-   [Обзор Базы данных SQL](sql-database-technical-overview.md)
-   [Управление жизненным циклом базы данных](https://msdn.microsoft.com/library/jj907294.aspx)
