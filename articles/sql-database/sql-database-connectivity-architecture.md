---
title: База данных Azure SQL и SQL хранилища данных архитектура подключений к | Документация Майкрософт
description: В этом документе объясняется архитектура подключений к Azure SQL для подключения к базе данных из Azure или из за пределами Azure.
services: sql-database
ms.service: sql-database
ms.subservice: development
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: rohitnayakmsft
ms.author: rohitna
ms.reviewer: carlrab, vanto
manager: craigg
ms.date: 07/02/2019
ms.openlocfilehash: 8441e64981b7157e91a56124a08c0aa02a9b1db0
ms.sourcegitcommit: 084630bb22ae4cf037794923a1ef602d84831c57
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2019
ms.locfileid: "67537939"
---
# <a name="azure-sql-connectivity-architecture"></a>Архитектура подключения к SQL Azure

В этой статье описывается архитектура подключения к базе данных SQL Azure и Хранилищу данных SQL Azure, а также как функционируют различные компоненты при передаче трафика к вашему экземпляру SQL Azure. Эти компоненты подключения направляют сетевой трафик к базе данных SQL Azure или Хранилищу данных SQL с помощью клиентов, подключающихся из Azure, и клиентов, подключающихся извне Azure. В этой статье также приведены примеры сценариев, позволяющие изменить параметры подключения, а также рекомендации по изменению параметров подключения по умолчанию.

## <a name="connectivity-architecture"></a>Архитектура подключения

На следующей схеме показана общая архитектура подключений к базе данных SQL Azure.

![Общий вид архитектуры](./media/sql-database-connectivity-architecture/connectivity-overview.png)

Следующие шаги описывают, как установить подключение к базе данных SQL Azure:

- Клиенты подключаются к шлюзу, который использует общедоступный IP-адрес и ожидает передачи данных через порт 1433.
- Шлюз, в зависимости от действующей политики подключения, перенаправляет или проксирует трафик к правильному кластеру баз данных.
- В кластере баз данных трафик перенаправляется в соответствующую базу данных SQL Azure.

## <a name="connection-policy"></a>Политика подключения

База данных SQL Azure поддерживает следующие три варианта для параметра политики подключения сервера Базы данных SQL.

- **Перенаправление (рекомендуется)** . Клиенты устанавливают подключения непосредственно к размещению узла базы данных. Чтобы включить подключения, клиентам необходимо разрешить исходящие правила брандмауэра для всех IP-адресов Azure в регионе, с помощью групп безопасности сети (NSG) с [теги служб](../virtual-network/security-overview.md#service-tags)) для портов 11000 – 11999, не только базы данных SQL Azure IP-адрес шлюза адреса через порт 1433. Поскольку пакеты переходят непосредственно к базе данных, задержка и пропускная способность увеличили производительность.
- **Прокси-сервер**. В этом режиме все подключения проксируют через шлюзы Базы данных SQL Azure. Чтобы разрешить возможность подключения, клиентам необходимы правила брандмауэра для исходящего трафика, которые разрешают только адреса IP-адреса шлюза Базы данных SQL Azure (два IP-адреса на регион). Этот режим может стать результатом большего времени задержки и меньшей пропускной способности, в зависимости от характера рабочей нагрузки. Чтобы задержка была минимальной, а пропускная способность высокой, настоятельно рекомендуется использовать политику перенаправления подключения `Redirect` через политику подключения `Proxy`.
- **Значение по умолчанию**. Это политика подключения, которая влияет на все серверы после создания, пока вы явным образом не измените политику подключения на `Proxy` или `Redirect`. Действующая политика зависит от того, создается подключение из Azure (`Redirect`) или за его пределами (`Proxy`).

## <a name="connectivity-from-within-azure"></a>Подключение из Azure

Для подключений из Azure по умолчанию действует политика подключения `Redirect`. Политика подключения `Redirect` означает, что после установления сеанса TCP с базой данных SQL Azure сеанс клиента перенаправляется в правильный кластер баз данных с измененным виртуальным IP-адресом назначения, то есть вместо адреса шлюза Базы данных SQL Azure указывается адрес кластера. После этого все последующие пакеты передаются непосредственно через кластер, минуя шлюз Базы данных SQL Azure. Этот поток трафика представлен на схеме ниже.

![Общий вид архитектуры](./media/sql-database-connectivity-architecture/connectivity-azure.png)

## <a name="connectivity-from-outside-of-azure"></a>Подключение извне Azure

Для подключений извне Azure по умолчанию действует политика подключения `Proxy`. Политика `Proxy` означает, что устанавливается сеанс TCP через шлюз Базы данных SQL Azure и все последующие пакеты проходят через этот шлюз. Этот поток трафика представлен на схеме ниже.

![Общий вид архитектуры](./media/sql-database-connectivity-architecture/connectivity-onprem.png)

## <a name="azure-sql-database-gateway-ip-addresses"></a>IP-адреса шлюза Базы данных SQL Azure

В следующей таблице перечислены IP-адреса из шлюзы по регионам. Чтобы подключиться к базе данных SQL Azure, необходимо разрешить сетевой трафик к & из **все** шлюзов для региона.

В дальнейшем мы добавить дополнительные шлюзы в каждом регионе и снять с учета шлюзов в столбце адрес IP-адрес шлюза из эксплуатации в таблице ниже. Дополнительные сведения о выводе из эксплуатации процесса, приведенными в следующей статье: [Миграции трафика базы данных SQL Azure на более новые шлюзы](sql-database-gateway-migration.md)


| Имя региона          | IP-адрес шлюза | Списанные шлюза </br> IP-адрес| Заметки на вывод из эксплуатации | 
| --- | --- | --- | --- |
| Восточная часть Австралии       | 13.75.149.87, 40.79.161.1 | | |
| Юго-Восточная Австралия | 191.239.192.109, 13.73.109.251 | | |
| Южная часть Бразилии         | 104.41.11.5        |                 | |
| Центральная Канада       | 40.85.224.249      |                 | |
| Восточная Канада          | 40.86.226.166      |                 | |
| Центральный регион США           | 13.67.215.62, 52.182.137.15 | 23.99.160.139 | Нет подключений после 1 сентября 2019 г. |
| Восточный Китай 1         | 139.219.130.35     |                 | |
| Восточный Китай 2         | 40.73.82.1         |                 | |
| Северный Китай 1        | 139.219.15.17      |                 | |
| Северный Китай 2        | 40.73.50.0         |                 | |
| Восточная Азия            | 191.234.2.139, 52.175.33.150 |       | |
| Восточная часть США 1            | 40.121.158.30, 40.79.153.12 | 191.238.6.43 | Нет подключений после 1 сентября 2019 г. |
| Восток США 2            | 40.79.84.180, 52.177.185.181, 52.167.104.0 | 191.239.224.107    | Нет подключений после 1 сентября 2019 г. |
| Центральная Франция       | 40.79.137.0, 40.79.129.1 |           | |
| Центральная Германия      | 51.4.144.100       |                 | |
| Северо-восточная Германия   | 51.5.144.179       |                 | |
| Центральная Индия        | 104.211.96.159     |                 | |
| Южная Индия          | 104.211.224.146    |                 | |
| Западная Индия           | 104.211.160.80     |                 | |
| Восточная часть Японии           | 13.78.61.196, 40.79.184.8, 13.78.106.224 | 191.237.240.43 | Нет подключений после 1 сентября 2019 г. |
| Западная часть Японии           | 104.214.148.156, 40.74.100.192 | 191.238.68.11 | Нет подключений после 1 сентября 2019 г. |
| Центральная Корея        | 52.231.32.42       |                 | |
| Южная Корея          | 52.231.200.86      |                 | |
| Центрально-северная часть США     | 23.96.178.199      | 23.98.55.75     | Нет подключений после 1 сентября 2019 г. |
| Северная Европа         | 40.113.93.91       | 191.235.193.75  | Нет подключений после 1 сентября 2019 г. |
| Центрально-южная часть США     | 13.66.62.124       | 23.98.162.75    | Нет подключений после 1 сентября 2019 г. |
| Юго-Восточная Азия      | 104.43.15.0        | 23.100.117.95   | Нет подключений после 1 сентября 2019 г. |
| Южная часть Великобритании             | 51.140.184.11      |                 | |
| Западная часть Великобритании              | 51.141.8.11        |                 | |
| Западно-центральная часть США      | 13.78.145.25       |                 | |
| Западная Европа          | 191.237.232.75, 40.68.37.158 |       | |
| Западная часть США 1            | 23.99.34.75, 104.42.238.205 |        | |
| Западный регион США 2            | 13.66.226.202      |                 | |
|                      |                    |                 | |

## <a name="change-azure-sql-database-connection-policy"></a>Изменение политики подключения для Базы данных SQL Azure

Чтобы изменить политику подключения Базы данных SQL Azure для сервера Базы данных SQL Azure, используйте команду [conn-policy](https://docs.microsoft.com/cli/azure/sql/server/conn-policy).

- Если задана политика подключения `Proxy`, то все сетевые пакеты проходят через шлюз Базы данных SQL Azure. Для этого режима необходимо разрешить исходящий трафик только через IP-адрес шлюза Базы данных SQL Azure. В режиме `Proxy` задержка выше, чем в режиме `Redirect`.
- Если задана политика подключения `Redirect`, то все сетевые пакеты проходят напрямую в кластер баз данных. Для этого режима необходимо разрешить исходящий трафик для нескольких IP-адресов.

## <a name="script-to-change-connection-settings-via-powershell"></a>Сценарий для изменения параметров подключения через PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL Azure, но все будущие разработки — для модуля Az.Sql. Для этих командлетов см. в разделе [AzureRM.Sql](https://docs.microsoft.com/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле Az и в модуле AzureRm практически идентичны. Следующий сценарий требует [модуля Azure PowerShell](/powershell/azure/install-az-ps).

Приведенный ниже сценарий PowerShell показывает, как изменить политику подключения.

```powershell
# Get SQL Server ID
$sqlserverid=(Get-AzSqlServer -ServerName sql-server-name -ResourceGroupName sql-server-group).ResourceId

# Set URI
$id="$sqlserverid/connectionPolicies/Default"

# Get current connection policy
(Get-AzResource -ResourceId $id).Properties.connectionType

# Update connection policy
Set-AzResource -ResourceId $id -Properties @{"connectionType" = "Proxy"} -f
```

## <a name="script-to-change-connection-settings-via-azure-cli"></a>Сценарий изменения параметров подключения через Azure CLI

> [!IMPORTANT]
> Для работы этого сценария требуется [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli).

### <a name="azure-cli-in-a-bash-shell"></a>Azure CLI в оболочке bash

> [!IMPORTANT]
> Для работы этого сценария требуется [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli).

Следующий сценарий CLI показано, как изменить политику подключения в оболочке bash.

```azurecli-interactive
# Get SQL Server ID
sqlserverid=$(az sql server show -n sql-server-name -g sql-server-group --query 'id' -o tsv)

# Set URI
ids="$sqlserverid/connectionPolicies/Default"

# Get current connection policy
az resource show --ids $ids

# Update connection policy
az resource update --ids $ids --set properties.connectionType=Proxy
```

### <a name="azure-cli-from-a-windows-command-prompt"></a>Azure CLI из командной строки Windows

> [!IMPORTANT]
> Для работы этого сценария требуется [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli).

Следующий сценарий CLI показано, как изменить политику подключения из командной строки Windows (с установлен Azure CLI).

```azurecli
# Get SQL Server ID and set URI
FOR /F "tokens=*" %g IN ('az sql server show --resource-group myResourceGroup-571418053 --name server-538465606 --query "id" -o tsv') do (SET sqlserverid=%g/connectionPolicies/Default)

# Get current connection policy
az resource show --ids %sqlserverid%

# Update connection policy
az resource update --ids %sqlserverid% --set properties.connectionType=Proxy
```

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о том, как изменить политику подключения Базы данных SQL Azure для сервера Базы данных SQL Azure, см. в статье о команде [conn-policy](https://docs.microsoft.com/cli/azure/sql/server/conn-policy).
- Сведения о поведении подключения к базе данных SQL Azure клиентов, использующих ADO.NET 4.5 или более поздней версии, см. в разделе [Порты для ADO.NET 4.5, отличные от порта 1433](sql-database-develop-direct-route-ports-adonet-v12.md).
- Общая информация о разработке приложений приведена в разделе [Обзор разработки приложений баз данных SQL](sql-database-develop-overview.md).