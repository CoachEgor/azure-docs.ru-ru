---
title: Проверка согласованности данных в действии копирования
description: Узнайте, как включить проверку согласованности данных в действии копирования в Фабрике данных Azure.
services: data-factory
documentationcenter: ''
author: dearandyxu
manager: ''
ms.reviewer: ''
ms.service: data-factory
ms.workload: data-services
ms.topic: conceptual
ms.date: 3/27/2020
ms.author: yexu
ms.openlocfilehash: d52d172fa4cc435235079cd88999766df93bfdf0
ms.sourcegitcommit: 3543d3b4f6c6f496d22ea5f97d8cd2700ac9a481
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/20/2020
ms.locfileid: "86522913"
---
#  <a name="data-consistency-verification-in-copy-activity-preview"></a>Проверка согласованности данных в действии копирования (предварительная версия)

[!INCLUDE[appliesto-adf-asa-md](includes/appliesto-adf-asa-md.md)]

При перемещении данных из источника в целевое хранилище действие копирования Фабрики данных Azure предоставляет возможность выполнить дополнительную проверку согласованности данных, чтобы гарантировать, что данные не только успешно копируются из источника в конечное хранилище, но и согласованы между источником и целевым хранилищем. После обнаружения несогласованных файлов во время перемещения данных можно либо прервать действие копирования, либо продолжить копирование остальных, включив параметр отказоустойчивости для пропуска несогласованных файлов. Чтобы получить пропущенные имена файлов, включите параметр журнал сеанса в действии копирования. 

> [!IMPORTANT]
> В настоящее время эта функция доступна в качестве предварительной версии со следующими ограничениями, над устранением которых мы активно работаем.
>- Если включить параметр ведения журнала сеанса в действии копирования для записи в журнал несогласованных файлов, которые пропускаются, то невозможно гарантировать 100-процентной полноты файла журнала, если не операция копирования завершилась сбоем.
>- Журнал сеансов содержит только несогласованные файлы. В настоящее время в нем не регистрируются успешно скопированные файлы.

## <a name="supported-data-stores-and-scenarios"></a>Поддерживаемые хранилища данных и сценарии

-   Проверка согласованности данных поддерживается всеми соединителями, за исключением протоколов FTP, sFTP и HTTP. 
-   Проверка согласованности данных не поддерживается в сценарии промежуточного копирования.
-   При копировании двоичных файлов проверка согласованности данных доступна только в том случае, если в действии копирования задано поведение "PreserveHierarchy".
-   При копировании нескольких двоичных файлов в одном действии копирования с включенной проверкой согласованности данных можно либо прервать действие копирования, либо продолжить копирование остальных, включив параметр отказоустойчивости для пропуска несогласованных файлов. 
-   При копировании таблицы в одном действии копирования с включенной проверкой согласованности данных действие копирования завершается ошибкой, если число строк, считанных из источника, отличается от количества строк, скопированных в назначение, и количества пропущенных строк.


## <a name="configuration"></a>Конфигурация
В следующем примере представлено определение JSON для включения проверки согласованности данных в действие копирования. 

```json
"typeProperties": { 
"source": { 
        "type": "BinarySource", 
        "storeSettings": { 
            "type": "AzureDataLakeStoreReadSettings", 
            "recursive": true 
        } 
    }, 
    "sink": { 
        "type": "BinarySink", 
        "storeSettings": { 
            "type": "AzureDataLakeStoreWriteSettings" 
        } 
}, 
    "validateDataConsistency": true, 
    "skipErrorFile": { 
        "dataInconsistency": true 
    }, 
    "logStorageSettings": { 
        "linkedServiceName": { 
            "referenceName": "ADLSGen2_storage", 
            "type": "LinkedServiceReference" 
        }, 
        "path": "/sessionlog/" 
} 
} 
```

Свойство | Описание | Допустимые значения | Обязательно
-------- | ----------- | -------------- | -------- 
validateDataConsistency | Если задано значение true для этого свойства, при копировании двоичных файлов действие копирования будет проверять размер файла, lastModifiedDate и контрольную сумму MD5 для каждого двоичного файла, скопированного из источника в целевое хранилище, чтобы обеспечить согласованность данных между исходным и конечным хранилищем. При копировании табличных данных действие копирования будет проверять общее количество строк после завершения задания, чтобы общее число строк, считанных из источника, совпадало с количеством строк, скопированных в назначение, а также число пропущенных строк. Имейте в виду, что включение этого параметра влияет на производительность копирования.  | True<br/>False (по умолчанию) | нет
dataInconsistency | Одна из пар "ключ-значение" в контейнере свойств Скиперрорфиле, чтобы определить, нужно ли пропустить непоследовательные файлы. <br/> — True: необходимо скопировать оставшуюся копию, пропуская непоследовательные файлы.<br/> -False: необходимо прервать действие копирования после обнаружения несоответствия файлов.<br/>Имейте в виду, что это свойство допустимо только при копировании двоичных файлов и заданию Валидатедатаконсистенци как true.  | True<br/>False (по умолчанию) | нет
logStorageSettings | Группа свойств, которые можно указать, чтобы включить журнал сеанса для записи пропущенных файлов. | | Нет
linkedServiceName | Связанная служба [хранилища BLOB-объектов Azure](connector-azure-blob-storage.md#linked-service-properties) или [Azure Data Lake Storage 2-го поколения](connector-azure-data-lake-storage.md#linked-service-properties) для хранения файлов журнала сеанса. | Имя связанной службы `AzureBlobStorage` или `AzureBlobFS`, которая ссылается на экземпляр хранилища, используемый для хранения файла журнала. | Нет
path | Путь к файлам журнала. | Укажите путь, по которому следует хранить файлы журнала. Если путь не указан, служба создаст контейнер самостоятельно. | Нет

>[!NOTE]
>- При копировании двоичных файлов или в большой двоичный объект или Azure Data Lake Storage 2-го поколения Azure ADF выполняет проверку контрольной суммы MD5 на уровне блоков, используя [API больших двоичных объектов Azure](https://docs.microsoft.com/dotnet/api/microsoft.azure.storage.blob.blobrequestoptions?view=azure-dotnet-legacy) и [API Azure Data Lake Storage 2-го поколения](https://docs.microsoft.com/rest/api/storageservices/datalakestoragegen2/path/update#request-headers). Если ContentMD5 для файлов существует в хранилище BLOB-объектов Azure или Azure Data Lake Storage 2-го поколения в качестве источников данных, то ADF проверяет контрольную сумму MD5 на уровне файлов после считывания файлов. После копирования файлов в большой двоичный объект Azure или Azure Data Lake Storage 2-го поколения в качестве назначения данных служба ADF записывает ContentMD5 в большой двоичный объект Azure или Azure Data Lake Storage 2-го поколения, которые могут быть дополнительно использованы приложениями для проверки согласованности данных.
>- Файл ADF проверяет размер файла при копировании двоичных файлов между хранилищами.

## <a name="monitoring"></a>Наблюдение

### <a name="output-from-copy-activity"></a>Выходные данные действия копирования
После выполнения действия копирования можно просмотреть результат проверки согласованности данных в выходных данных каждого запуска действия копирования.

```json
"output": {
            "dataRead": 695,
            "dataWritten": 186,
            "filesRead": 3,  
            "filesWritten": 1, 
            "filesSkipped": 2, 
            "throughput": 297,
            "logPath": "https://myblobstorage.blob.core.windows.net//myfolder/a84bf8d4-233f-4216-8cb5-45962831cd1b/",
            "dataConsistencyVerification": 
           { 
                "VerificationResult": "Verified", 
                "InconsistentData": "Skipped" 
           } 
        }

```
Подробные сведения о проверке согласованности данных представлены в свойстве dataConsistencyVerification.

Значение параметра **VerificationResult**: 
-   **Verified**.  Для скопированных данных выполнена проверка согласованности между исходным и конечным хранилищами. 
-   **NotVerified**. Для скопированных данных не выполнена проверка согласованности, поскольку вы не включили параметр validateDataConsistency в действии копирования. 
-   **Unsupported**. Скопированные данные не были проверены на согласованность, поскольку проверка согласованности данных не поддерживается для этой конкретной пары копирования. 

Значение параметра **InconsistentData**: 
-   **Found**. Действие копирования ADF обнаружило несогласованные данные. 
-   **Пропущено**. Действие копирования ADF обнаружило и пропустило несогласованные данные. 
-   **Нет** — Действие копирования ADF не обнаружило несогласованных данных. Причиной может быть либо то, что уже была выполнена проверка согласованности данных между исходным и конечным хранилищами, либо то, что отключили параметр validateDataConsistency в действии копирования. 

### <a name="session-log-from-copy-activity"></a>Журнал сеанса действия копирования

Если вы настроили регистрацию несогласованных файлов в журнале, файл журнала можно найти по этому пути: `https://[your-blob-account].blob.core.windows.net/[path-if-configured]/copyactivity-logs/[copy-activity-name]/[copy-activity-run-id]/[auto-generated-GUID].csv`.  Файлы журнала должны иметь формат CSV. 

Ниже приведена схема файла журнала.

Столбец | Описание 
-------- | -----------  
Отметка времени | Метка времени пропуска несогласованных файлов службой ADF.
Level | Уровень ведения журнала для этого элемента. Для элемента, обозначающего пропуск файла, будет использоваться уровень Warning.
OperationName | Рабочее поведение действия копирования ADF для каждого файла. Для пропуска файла будет использоваться значение FileSkip.
OperationItem | Имя пропускаемого файла.
Сообщение | Дополнительные сведения о причине пропуска файлов.

Ниже приведен пример файла журнала. 
```
Timestamp, Level, OperationName, OperationItem, Message
2020-02-26 06:22:56.3190846, Warning, FileSkip, "sample1.csv", "File is skipped after read 548000000 bytes: ErrorCode=DataConsistencySourceDataChanged,'Type=Microsoft.DataTransfer.Common.Shared.HybridDeliveryException,Message=Source file 'sample1.csv' is changed by other clients during the copy activity run.,Source=,'." 
```
Из файла журнала, приведенного выше, можно увидеть, что файл sample1.csv был пропущен, поскольку его не удалось проверить на согласованность в исходном и целевом хранилищах. Дополнительные сведения о том, почему файл sample1.csv стал несогласованным, указывают на то, что он был изменен другими приложениями при выполнении действия копирования ADF. 



## <a name="next-steps"></a>Дальнейшие действия
См. другие статьи о действиях копирования:

- [Действие копирования в фабрике данных Azure](copy-activity-overview.md)
- [Отказоустойчивость действия копирования в фабрике данных Azure](copy-activity-fault-tolerance.md)


