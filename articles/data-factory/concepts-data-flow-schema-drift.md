---
title: Смещение схемы сопоставления потоков данных в Фабрике данных Azure
description: Создание устойчивых потоков данных со смещением схемы в Фабрике данных Azure
author: kromerm
ms.author: makromer
ms.service: data-factory
ms.topic: conceptual
ms.date: 10/04/2018
ms.openlocfilehash: 562daa024985a546ffb49c4da11eace3bc81a659
ms.sourcegitcommit: da0a8676b3c5283fddcd94cdd9044c3b99815046
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/18/2019
ms.locfileid: "68314824"
---
# <a name="mapping-data-flow-schema-drift"></a>Смещение схемы сопоставления потоков данных

[!INCLUDE [notes](../../includes/data-factory-data-flow-preview.md)]

Концепция смещения схемы — это случай, когда ваши источники часто меняют метаданные. Поля, столбцы, типы и т. д. могут быть добавлены, удалены или изменены без подготовки. Без обработки смещения схемы поток данных становится уязвимым к изменениям в вышестоящих источниках данных. При изменении входящих столбцов и полей типичные шаблоны извлечения, преобразования и загрузки завершаются ошибкой, так как они, как правило, привязаны к именам этих источников.

Чтобы защититься от смещения схемы, важно иметь в Потоке данных средства, позволяющие специалисту по работе с данными:

* определять источники с изменяемыми именами полей, типами данных, значениями и размерами;
* определять параметры преобразования, которые могут работать с шаблонами данных вместо жестко закодированных полей и значений;
* определять выражения, которые распознают шаблоны для сопоставления входящих полей вместо использования именованных полей.

## <a name="how-to-implement-schema-drift-in-adf-mapping-data-flows"></a>Реализация смещения схемы в потоках данных сопоставления ADF
ADF изначально поддерживает гибкие схемы, которые меняются от выполнения до выполнения, чтобы можно было создавать логику универсального преобразования данных без необходимости перекомпиляции потоков данных.

* Выберите "Allow Schema Drift" (Разрешить смещение схемы) в разделе преобразования источника.

<img src="media/data-flow/schemadrift001.png" width="400">

* При выборе этого параметра все входящие поля будут считываться из источника при каждом выполнении Потока данных и передаваться через весь поток в приемник.

* Все недавно обнаруженные столбцы (смещенные столбцы) по умолчанию поступают как строковый тип данных. В преобразовании «источник» выберите «определить переданные типы столбцов», если вы хотите, чтобы ADF автоматически выстроил типы данных из источника.

* Обязательно используйте "автокарту" для отображения всех новых полей в преобразовании приемника, чтобы все новые поля были подобраны и присвоены в назначении, и установите для приемника значение "Разрешить отклонение схемы".

<img src="media/data-flow/automap.png" width="400">

* Все будет работать, когда в этом сценарии появились новые поля с простым сопоставлением источника > приемника (копирования).

* Чтобы добавить преобразования в этот рабочий процесс, обрабатывающий смещение схемы, можно использовать сопоставление шаблонов для сопоставления столбцов по имени, типу и значению.

* Щелкните "Add Column Pattern" (Добавить шаблон столбца) в производном столбце или агрегатном преобразовании, если вы хотите создать преобразование, которое поддерживает смещение схемы.

<img src="media/data-flow/columnpattern.png" width="400">

> [!NOTE]
> Необходимо реализовать в потоке данных архитектурное решение, чтобы принимать смещение схемы по всему потоку. При этом можно защититься от изменений схемы, поступающих из источников. Однако вы потеряете раннюю привязку столбцов и типов во всем потоке данных. Фабрика данных Azure рассматривает потоки смещения схемы как потоки с поздней привязкой, поэтому при создании преобразований имена столбцов будут недоступны в представлениях схемы на протяжении всего потока.

<img src="media/data-flow/taxidrift1.png" width="400">

В Потоке данных с демонстрационным примером поездок в такси в нижнем потоке данных есть смещение примера схемы с источником TripFare. Обратите внимание, что в преобразовании агрегирования для полей агрегации используется конструкция "шаблон столбца". Вместо именования определенных столбцов или поиска столбцов по позиции мы предполагаем, что данные могут изменяться и не отображаться в том же порядке между выполнениями.

В этом примере обработки смещения схемы в Потоке данных Фабрики данных Azure мы создали агрегацию, которая сканирует столбцы двойного типа, учитывая, что домен данных содержит цены за каждую поездку. Затем мы можем выполнить статистический математический расчет по всем двойным полям в источнике, независимо от расположения и имени столбца.

В синтаксисе Потока данных в Фабрике данных Azure используется $$ для представления каждого сопоставленного столбца из шаблона сопоставления. Вы также можете выполнять сопоставление по именам столбцов с помощью комплексного поиска строк и функций регулярных выражений. В этом случае мы создадим новое имя агрегированного поля на основе каждого совпадения столбца двойного типа и добавим текст ```_total``` к каждому из этих совпадающих имен: 

```concat($$, '_total')```

Затем мы округлим и просуммируем значения для каждого из этих сопоставленных столбцов:

```round(sum ($$))```

Это можно проверить с помощью примера о поездках в такси в Потоке данных Фабрики данных Azure. Включите сеанс отладки с помощью переключателя отладки в верхней части области конструктора Потока данных, чтобы можно было просматривать результаты в интерактивном режиме:

<img src="media/data-flow/taxidrift2.png" width="800">

## <a name="access-new-columns-downstream"></a>Доступ к новым столбцам по нисходящей
При создании новых столбцов с шаблонами столбцов к этим новым столбцам можно обращаться позже в преобразованиях потока данных с помощью следующих методов:

* Используйте "Бипоситион", чтобы указать новые столбцы по номеру расположения.
* Используйте "Бинаме", чтобы указать новые столбцы по имени.
* В шаблонах столбцов используйте "имя", "поток", "расположение" или "тип" или любую комбинацию значений для сопоставления с новыми столбцами.

## <a name="next-steps"></a>Следующие шаги
В [языке выражений потока данных](data-flow-expression-functions.md) можно найти дополнительные средства для шаблонов столбцов и смещения схем, включая "бинаме" и "бипоситион".
