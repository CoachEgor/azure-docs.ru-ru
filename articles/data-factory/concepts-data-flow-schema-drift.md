---
title: Смещение схемы сопоставления потоков данных в Фабрике данных Azure
description: Создание устойчивых потоков данных со смещением схемы в Фабрике данных Azure
author: kromerm
ms.author: makromer
ms.service: data-factory
ms.topic: conceptual
ms.date: 10/04/2018
ms.openlocfilehash: 6fd610afc0a21a97a8544b9e4b173f207f5fb50f
ms.sourcegitcommit: dad277fbcfe0ed532b555298c9d6bc01fcaa94e2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/10/2019
ms.locfileid: "67722885"
---
# <a name="mapping-data-flow-schema-drift"></a>Смещение схемы сопоставления потоков данных

[!INCLUDE [notes](../../includes/data-factory-data-flow-preview.md)]

Концепция смещения схемы — это случай, когда ваши источники часто меняют метаданные. Поля, столбцы, типы и т. д. могут быть добавлены, удалены или изменены без подготовки. Без обработки смещения схемы поток данных становится уязвимым к изменениям в вышестоящих источниках данных. При изменении входящих столбцов и полей типичные шаблоны извлечения, преобразования и загрузки завершаются ошибкой, так как они, как правило, привязаны к именам этих источников.

Чтобы защититься от смещения схемы, важно иметь в Потоке данных средства, позволяющие специалисту по работе с данными:

* определять источники с изменяемыми именами полей, типами данных, значениями и размерами;
* определять параметры преобразования, которые могут работать с шаблонами данных вместо жестко закодированных полей и значений;
* определять выражения, которые распознают шаблоны для сопоставления входящих полей вместо использования именованных полей.

## <a name="how-to-implement-schema-drift"></a>Как реализовать смещение схемы

* Выберите "Allow Schema Drift" (Разрешить смещение схемы) в разделе преобразования источника.

<img src="media/data-flow/schemadrift001.png" width="400">

* При выборе этого параметра все входящие поля будут считываться из источника при каждом выполнении Потока данных и передаваться через весь поток в приемник.

* Убедитесь в том, что использование «Auto-Map» для сопоставления все новые поля в преобразовании приемника, чтобы все новые поля получить выбраны вверх и попали в места назначения.

<img src="media/data-flow/automap.png" width="400">

* Все заработает, когда новые поля будут введены в этом сценарии с простым сопоставлением "источник -> приемник" (копирование).

* Чтобы добавить преобразования в этот рабочий процесс, обрабатывающий смещение схемы, можно использовать сопоставление шаблонов для сопоставления столбцов по имени, типу и значению.

* Щелкните "Add Column Pattern" (Добавить шаблон столбца) в производном столбце или агрегатном преобразовании, если вы хотите создать преобразование, которое поддерживает смещение схемы.

<img src="media/data-flow/columnpattern.png" width="400">

> [!NOTE]
> Необходимо реализовать в потоке данных архитектурное решение, чтобы принимать смещение схемы по всему потоку. При этом можно защититься от изменений схемы, поступающих из источников. Однако вы потеряете раннюю привязку столбцов и типов во всем потоке данных. Фабрика данных Azure рассматривает потоки смещения схемы как потоки с поздней привязкой, поэтому при создании преобразований имена столбцов будут недоступны в представлениях схемы на протяжении всего потока.

<img src="media/data-flow/taxidrift1.png" width="400">

В Потоке данных с демонстрационным примером поездок в такси в нижнем потоке данных есть смещение примера схемы с источником TripFare. Обратите внимание, что в преобразовании агрегирования для полей агрегации используется конструкция "шаблон столбца". Вместо именования определенных столбцов или поиска столбцов по позиции мы предполагаем, что данные могут изменяться и не отображаться в том же порядке между выполнениями.

В этом примере обработки смещения схемы в Потоке данных Фабрики данных Azure мы создали агрегацию, которая сканирует столбцы двойного типа, учитывая, что домен данных содержит цены за каждую поездку. Затем мы можем выполнить статистический математический расчет по всем двойным полям в источнике, независимо от расположения и имени столбца.

В синтаксисе Потока данных в Фабрике данных Azure используется $$ для представления каждого сопоставленного столбца из шаблона сопоставления. Вы также можете выполнять сопоставление по именам столбцов с помощью комплексного поиска строк и функций регулярных выражений. В этом случае мы создадим новое имя агрегированного поля на основе каждого совпадения столбца двойного типа и добавим текст ```_total``` к каждому из этих совпадающих имен: 

```concat($$, '_total')```

Затем мы округлим и просуммируем значения для каждого из этих сопоставленных столбцов:

```round(sum ($$))```

Это можно проверить с помощью примера о поездках в такси в Потоке данных Фабрики данных Azure. Включите сеанс отладки с помощью переключателя отладки в верхней части области конструктора Потока данных, чтобы можно было просматривать результаты в интерактивном режиме:

<img src="media/data-flow/taxidrift2.png" width="800">

## <a name="access-new-columns-downstream"></a>Доступ более низком уровне в новые столбцы

При создании новых столбцов шаблоны столбцов, эти новые столбцы доступны позже в вашей преобразования потока данных, используя функцию «byName» выражение.

## <a name="next-steps"></a>Следующие шаги

В [язык выражений потока данных](data-flow-expression-functions.md) вы найдете дополнительные средства для шаблоны столбцов и смещение схемы, включая «byName» и «byPosition».
