---
title: Присоединение среды выполнения интеграции Azure SSIS к виртуальной сети | Документация Майкрософт
description: Узнайте, как присоединить среду выполнения интеграции Azure SSIS к виртуальной сети Azure.
services: data-factory
documentationcenter: ''
ms.service: data-factory
ms.workload: data-services
ms.tgt_pltfrm: na
ms.topic: conceptual
ms.date: 08/15/2019
author: swinarko
ms.author: sawinark
ms.reviewer: douglasl
manager: craigg
ms.openlocfilehash: 065f69cc98f05fcb19648f190a7dba4b43da1a9a
ms.sourcegitcommit: 1d0b37e2e32aad35cc012ba36200389e65b75c21
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/15/2019
ms.locfileid: "72326624"
---
# <a name="join-an-azure-ssis-integration-runtime-to-a-virtual-network"></a>Присоединение среды выполнения интеграции Azure SSIS к виртуальной сети
При использовании SQL Server Integration Services (SSIS) в фабрике данных Azure необходимо присоединить среду выполнения интеграции Azure SSIS (IR) к виртуальной сети Azure в следующих сценариях: 

- Вы хотите подключиться к локальным хранилищам данных из пакетов служб SSIS, которые выполняются на Azure-SSIS IR без настройки и управления автономными IR-данными в качестве прокси. 

- Необходимо подключиться к ресурсам службы Azure, поддерживаемым конечными точками службы виртуальной сети, из пакетов служб SSIS, которые выполняются на Azure-SSIS IR.

- Вы размещаете базу данных каталога SSIS (SSISDB) в базе данных SQL Azure с конечными точками службы виртуальной сети или управляемым экземпляром в виртуальной сети. 

Фабрика данных позволяет присоединить Azure-SSIS IR к виртуальной сети, созданной с помощью классической модели развертывания или модели развертывания Azure Resource Manager. 

> [!IMPORTANT]
> Классическая виртуальная сеть является устаревшей, поэтому вместо нее следует использовать виртуальную сеть Azure Resource Manager.  Если вы уже используете классическую виртуальную сеть, переключайтесь в Azure Resource Managerную виртуальную сеть как можно скорее.

## <a name="access-to-on-premises-data-stores"></a>Доступ к локальным хранилищам данных
Если пакеты служб SSIS обращаются к локальным хранилищам данных, вы можете присоединить Azure-SSIS IR к виртуальной сети, подключенной к локальной сети. Можно также настроить и управлять локальным IR в качестве прокси-сервера для Azure-SSIS IR. Дополнительные сведения см. в статье [Настройка автономного IR в качестве прокси-сервера для Azure-SSIS IR](https://docs.microsoft.com/azure/data-factory/self-hosted-integration-runtime-proxy-ssis). 

При присоединении Azure-SSIS IR к виртуальной сети помните следующие важные моменты. 

- Если виртуальная сеть не подключена к локальной сети, сначала создайте [Azure Resource Managerную виртуальную сеть](../virtual-network/quick-create-portal.md#create-a-virtual-network) для присоединения Azure-SSIS IR. Затем настройте [подключение VPN-шлюза](../vpn-gateway/vpn-gateway-howto-site-to-site-classic-portal.md) типа "сеть — сеть" или подключение [ExpressRoute](../expressroute/expressroute-howto-linkvnet-classic.md) из этой виртуальной сети к локальной сети. 

- Если Azure Resource Managerная виртуальная сеть уже подключена к локальной сети в том же расположении, что и Azure-SSIS IR, вы можете присоединить к ней IR в этой виртуальной сети. 

- Если классическая виртуальная сеть уже подключена к локальной сети в другом расположении из Azure-SSIS IR, можно создать [Azure Resource Managerную виртуальную сеть](../virtual-network/quick-create-portal.md#create-a-virtual-network) для присоединения Azure-SSIS IR. Затем настройте подключение типа [классическая виртуальная сеть — виртуальная сеть Azure Resource Manager](../vpn-gateway/vpn-gateway-connect-different-deployment-models-portal.md). 
 
- Если Azure Resource Manager виртуальная сеть уже подключена к локальной сети в другом расположении из Azure-SSIS IR, можно сначала создать [Azure Resource Manager виртуальную сеть](../virtual-network/quick-create-portal.md##create-a-virtual-network) для присоединения Azure-SSIS IR. Затем настройте подключение Azure Resource Manager к Azure Resource Manager виртуальной сети. 

## <a name="access-to-azure-services"></a>Доступ к службам Azure
Если пакеты SSIS обращаются к ресурсам службы Azure, поддерживаемым [конечными точками службы виртуальной сети](../virtual-network/virtual-network-service-endpoints-overview.md) , и вы хотите защитить эти ресурсы для Azure-SSIS IR, вы можете присоединить Azure-SSIS IR к подсети виртуальной сети, настроенной с помощью виртуальной сети. конечные точки службы. В то же время добавьте правило виртуальной сети в ресурсы службы Azure, чтобы разрешить доступ из той же подсети.

## <a name="hosting-the-ssis-catalog-in-sql-database"></a>Размещение каталога служб SSIS в базе данных SQL
Если вы размещаете каталог SSIS в базе данных SQL Azure с использованием конечных точек службы виртуальной сети, обязательно присоедините Azure-SSIS IR к той же виртуальной сети и подсети.

Чтобы присоединить Azure-SSIS IR к той же виртуальной сети, что и управляемый экземпляр, убедитесь, что Azure-SSIS IR находится в другой подсети, чем управляемый экземпляр. Чтобы присоединить Azure-SSIS IR к другой виртуальной сети, отличной от управляемого экземпляра, рекомендуется использовать пиринг виртуальных сетей (который ограничен тем же регионом) или подключение из виртуальной сети к виртуальной сети. Дополнительные сведения см. в статье [Подключение приложения к управляемому экземпляру базы данных SQL Azure](../sql-database/sql-database-managed-instance-connect-app.md).

Во всех случаях виртуальную сеть можно развернуть только с помощью модели развертывания Azure Resource Manager.

В следующих разделах приведены дополнительные сведения. 

## <a name="virtual-network-configuration"></a>Конфигурация виртуальной сети

Настройте виртуальную сеть в соответствии с этими требованиями: 

-   Убедитесь, что `Microsoft.Batch` является зарегистрированным поставщиком в подсети виртуальной сети, в которой размещается Azure-SSIS IR. При использовании классической виртуальной сети также присоедините `MicrosoftAzureBatch` к классической роли участника виртуальной машины для этой виртуальной сети. 

-   Убедитесь, что необходимые разрешения доступны. Дополнительные сведения см. в разделе [Настройка разрешений](#perms).

-   Выберите подходящую подсеть для размещения Azure-SSIS IR. Дополнительные сведения см. [в разделе Выбор подсети](#subnet). 

-   Если вы используете собственный сервер системы доменных имен (DNS) в виртуальной сети, см. раздел [Настройка DNS-сервера](#dns_server). 

-   Если в подсети используется группа безопасности сети (NSG), см. раздел [Настройка NSG](#nsg). 

-   Если вы используете Azure ExpressRoute или определяемый пользователем маршрут (UDR), см. статью [Использование Azure expressroute или UDR](#route). 

-   Убедитесь, что группа ресурсов виртуальной сети может создавать и удалять определенные сетевые ресурсы Azure. Дополнительные сведения см. [в разделе Настройка группы ресурсов](#resource-group). 

-   Если вы настраиваете Azure-SSIS IR, как описано в разделе [Выборочная установка для Azure-SSIS IR](https://docs.microsoft.com/azure/data-factory/how-to-configure-azure-ssis-ir-custom-setup), узлы Azure-SSIS IR будут получать частные IP-адреса из предопределенного диапазона от 172.16.0.0 до 172.31.255.255. Убедитесь, что диапазоны частных IP-адресов ваших виртуальных или локальных сетей не конфликтуют с этим диапазоном.

На этой схеме показаны необходимые подключения для Azure-SSIS IR:

![Azure SSIS IR](media/join-azure-ssis-integration-runtime-virtual-network/azure-ssis-ir.png)

### <a name="perms"></a>Настройка разрешений

Пользователь, создающий Azure-SSIS IR, должен иметь следующие разрешения:

- Если вы присоединяете Azure-SSIS IR к виртуальной сети Azure Resource Manager, у вас есть два варианта:

  - Используйте встроенную роль «участник сети». Эта роль предоставляет разрешение _Microsoft.Network/\*_ , область применения которого намного шире, чем требуется для этой задачи.

  - Создать настраиваемую роль, которая включает только нужное разрешение _Microsoft.Network/virtualNetworks/\*/join/action_. 

- При присоединении среды выполнения интеграции SSIS к классической виртуальной сети рекомендуется использовать встроенную роль участника классической виртуальной машины. В противном случае вам нужно будет определить пользовательскую роль, которая включает разрешение на присоединение к виртуальной сети.

### <a name="subnet"></a> Выбор подсети

При выборе подсети: 

-   Не выбирайте GatewaySubnet для развертывания Azure-SSIS IR. Он выделен для шлюзов виртуальной сети. 

-   Убедитесь, что выбранная подсеть имеет достаточно свободного адресного пространства для использования Azure-SSIS IR. Оставлять доступные IP-адреса как минимум в два раза больше, чем номер ИНФРАКРАСного узла. Azure резервирует некоторые IP-адреса в каждой подсети. Эти адреса нельзя использовать. Первый и последний IP-адреса подсетей зарезервированы для соответствия протоколу, и для служб Azure используются три адреса. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets) 

-   Не используйте подсеть, предназначенную исключительно для других служб Azure (например, управляемый экземпляр базы данных SQL, служба приложений и т. д.). 

### <a name="dns_server"></a>Настройка DNS-сервера 
Если вам нужно использовать собственный DNS-сервер в виртуальной сети, присоединенной Azure-SSIS IR, убедитесь, что она может разрешить глобальные имена узлов Azure (например, большой двоичный объект службы хранилища Azure с именем `<your storage account>.blob.core.windows.net`). 

Рекомендуется выполнить следующие действия: 

-   Настройте пользовательский DNS для пересылки запросов на Azure DNS. Неразрешенные записи DNS можно пересылать по IP-адресу рекурсивных арбитров конфликтов Azure (168.63.129.16) на собственном DNS-сервере. 

-   Настройте пользовательский DNS-сервер в качестве основного DNS-сервера для виртуальной сети. Настройте Azure DNS в качестве дополнительного DNS-сервера. Зарегистрируйте IP-адрес рекурсивного арбитра конфликтов Azure (168.63.129.16) в качестве дополнительного DNS-сервера, если ваш собственный DNS-сервер недоступен. 

Дополнительные сведения см. в разделе [разрешение имен, использующее собственный DNS-сервер](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server). 

### <a name="nsg"></a>Настройка NSG
Если необходимо реализовать NSG для подсети, используемой Azure-SSIS IR, разрешите входящий и исходящий трафик через следующие порты: 

| Направление | Транспортный протокол | Источник | Диапазон портов источника | Место назначения | Диапазон портов назначения | Комментарии |
|---|---|---|---|---|---|---|
| Вход. | TCP | батчнодеманажемент | * | Виртуальная сеть | 29876, 29877 (если вы присоединяете IR к диспетчер ресурсов виртуальной сети) <br/><br/>10100, 20100, 30100 (при присоединении среды выполнения интеграции к классической виртуальной сети)| Служба фабрики данных использует эти порты для связи с узлами Azure-SSIS IR в виртуальной сети. <br/><br/> Независимо от того, создаете ли вы NSG на уровне подсети, фабрика данных всегда настраивает NSG на уровне сетевых адаптеров, подключенных к виртуальным машинам, на которых размещается Azure-SSIS IR. NSG уровня сетевых адаптеров на указанных портах разрешает только входящий трафик от IP-адресов Фабрики данных. Даже если вы откроете эти порты для трафика Интернета на уровне подсети, трафик с IP-адресов, не являющихся IP-адресами фабрики данных, блокируется на уровне NIC. |
| Исход. | TCP | Виртуальная сеть | * | AzureCloud; | 443 | Узлы Azure-SSIS IR в виртуальной сети используют этот порт для доступа к службам Azure, таким как служба хранилища Azure и концентраторы событий Azure. |
| Исход. | TCP | Виртуальная сеть | * | Интернет | 80 | Узлы Azure-SSIS IR в виртуальной сети используют этот порт для скачивания списка отзыва сертификатов из Интернета. |
| Исход. | TCP | Виртуальная сеть | * | SQL | 1433, 11000-11999 | Узлы Azure-SSIS IR в виртуальной сети используют эти порты для доступа к SSISDB, размещенной на сервере базы данных SQL. Если для политики подключения сервера базы данных SQL задано значение **прокси** вместо **перенаправления**, то требуется только порт 1433. Это правило безопасности для исходящего трафика не применимо к SSISDB, размещенной в управляемом экземпляре в виртуальной сети. |
||||||||

### <a name="route"></a>Использование Azure ExpressRoute или UDR
При подключении канала [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) к инфраструктуре виртуальной сети для расширения локальной сети в Azure в общей конфигурации используется принудительное туннелирование (объявление маршрута BGP 0.0.0.0/0 в виртуальной сети). Это туннелирование направляет исходящий Интернет-трафик из виртуальной сети в локальное сетевое устройство для проверки и ведения журнала. 
 
Кроме того, можно определить [определяемые пользователем маршруты](../virtual-network/virtual-networks-udr-overview.md) для принудительного применения исходящего Интернет-трафика из подсети, в которой размещается Azure-SSIS IR, в другую подсеть, где размещен виртуальный сетевой модуль (NVA) в качестве брандмауэра или брандмауэра Azure для проверки и ведения журнала. 

В обоих случаях маршрут трафика будет прерывать требуемое входящее подключение из зависимых служб фабрики данных Azure (в частности, службы управления пакетной службой Azure) к Azure-SSIS IR в виртуальной сети. Чтобы избежать этого, определите один или несколько определяемые пользователем маршруты в подсети, содержащей Azure-SSIS IR. 

Вы можете применить маршрут 0.0.0.0/0 с типом следующего прыжка в **Интернете** в подсети, в которой размещается Azure-SSIS IR в сценарии Azure ExpressRoute. Кроме того, можно изменить существующий маршрут 0.0.0.0/0 с типа следующего прыжка в качестве **виртуального устройства** в **Интернете** в сценарии NVA.

![Добавление маршрута](media/join-azure-ssis-integration-runtime-virtual-network/add-route-for-vnet.png)

Если вы собираетесь потерять возможность исследовать исходящий Интернет-трафик из этой подсети, можно определить конкретные определяемые пользователем маршруты для маршрутизации трафика только между службами управления пакетной службой Azure и Azure-SSIS IR с типом следующего прыжка в **Интернете**.

Например, если Azure-SSIS IR находится в `UK South`, вы получите список диапазона IP-адресов для тега службы `BatchNodeManagement.UKSouth` из [ссылки на веб-канал загрузки тегов служб](https://www.microsoft.com/en-us/download/details.aspx?id=56519) или через [API обнаружения тегов служб](https://aka.ms/discoveryapi). Затем примените следующие определяемые пользователем маршруты для связанных маршрутов диапазона IP-адресов с типом следующего прыжка в **Интернете**.

![Параметры UDR пакетной службы Azure](media/join-azure-ssis-integration-runtime-virtual-network/azurebatch-udr-settings.png)

> [!NOTE]
> Этот подход влечет за собой дополнительную стоимость обслуживания. Регулярно проверяйте диапазон IP-адресов и добавьте новые диапазоны IP-адресов в UDR, чтобы избежать нарушения Azure-SSIS IR. Мы рекомендуем проверять диапазон IP-адресов ежемесячно, так как при появлении нового IP-адреса в теге службы этот IP-адрес будет действовать в следующий месяц. 

### <a name="resource-group"></a>Настройка группы ресурсов
Среда выполнения интеграции Azure SSIS должна создать определенные сетевые ресурсы в той же группе ресурсов, в которой находится виртуальная сеть. К этим ресурсам относятся:
   -   Балансировщик нагрузки Azure с именем *\<Guid >-azurebatch-клаудсервицелоадбаланцер*.
   -   Общедоступный IP-адрес Azure с именем *\<Guid >-azurebatch-клаудсервицепублиЦип*.
   -   Группа безопасности рабочей сети с именем *\<Guid >-azurebatch-клаудсервиценетворксекуритиграуп*. 

Эти ресурсы будут созданы при запуске IR. Они будут удалены при остановке IR. Чтобы предотвратить блокировку ИК-остановки, не используйте эти сетевые ресурсы в других ресурсах. 

Убедитесь в отсутствии блокировки ресурсов для группы ресурсов или подписки, к которой принадлежит виртуальная сеть. Если вы настраиваете блокировку только для чтения или удаление, запуск и остановка IR могут завершиться сбоем, иначе IR может перестать отвечать. 

Убедитесь, что у вас нет политики Azure, которая не позволяет создавать следующие ресурсы в группе ресурсов или подписке, к которой принадлежит виртуальная сеть. 
   -   Microsoft.Network/LoadBalancers 
   -   Microsoft.Network/NetworkSecurityGroups 
   -   Microsoft.Network/PublicIPAddresses 

### <a name="faq"></a> Часто задаваемые вопросы

- Как защитить общедоступный IP-адрес, предоставленный на Azure-SSIS IR для входящего подключения? Можно ли удалить общедоступный IP-адрес?
 
    Сейчас общедоступный IP-адрес будет создан автоматически, когда Azure-SSIS IR присоединяется к виртуальной сети. У нас есть NSG на уровне сетевых адаптеров, чтобы разрешить входящие подключения только к Azure-SSIS IR в службах управления пакетной службой Azure. Можно также указать NSG на уровне подсети для защиты входящего трафика.

    Если вы не хотите предоставлять общедоступный IP-адрес, рассмотрите возможность [настройки самостоятельно размещенного IR в качестве прокси-сервера для Azure-SSIS IR](https://docs.microsoft.com/azure/data-factory/self-hosted-integration-runtime-proxy-ssis) вместо виртуальной сети, если это применимо к вашему сценарию.
 
- Можно ли добавить статический IP-адрес Azure-SSIS IR в список разрешений брандмауэра для источника данных?
 
    - Если источник данных является локальным, после подключения виртуальной сети к локальной сети и присоединения Azure-SSIS IR к подсети виртуальной сети можно добавить диапазон IP-адресов этой подсети в список разрешений.
    - Если источником данных является служба Azure, поддерживаемая с конечной точкой службы виртуальной сети, можно настроить точку обслуживания виртуальной сети в виртуальной сети и присоединить Azure-SSIS IR к этой подсети виртуальной сети. Затем можно разрешить доступ с помощью правила виртуальной сети служб Azure, а не диапазона IP-адресов.
    - Если источник данных является другим типом облачного источника данных, можно использовать UDR для маршрутизации исходящего трафика из Azure-SSIS IR в NVA или в брандмауэр Azure с помощью статического общедоступного IP-адреса. Вы можете добавить общедоступный IP-адрес NVA или брандмауэра Azure в список разрешений.
    - Если предыдущие ответы не соответствуют вашим потребностям, рассмотрите возможность предоставления доступа к источнику данных, [настроив локальную IR в качестве прокси-сервера для Azure-SSIS IR](https://docs.microsoft.com/azure/data-factory/self-hosted-integration-runtime-proxy-ssis). Затем можно добавить IP-адрес компьютера, на котором размещена локальная среда IR, в список разрешений вместо присоединения Azure-SSIS IR к виртуальной сети.

## <a name="azure-portal-data-factory-ui"></a>Портал Azure (пользовательский интерфейс фабрики данных)
В этом разделе показано, как присоединить существующую Azure-SSIS IR к виртуальной сети (классической или Azure Resource Manager) с помощью портал Azure и пользовательского интерфейса фабрики данных. 

Перед присоединением Azure-SSIS IR к виртуальной сети необходимо правильно настроить виртуальную сеть. Выполните действия, описанные в разделе, который относится к типу виртуальной сети (классическая или Azure Resource Manager). Затем выполните действия, описанные в третьем разделе, чтобы присоединить Azure-SSIS IR к виртуальной сети. 

### <a name="configure-an-azure-resource-manager-virtual-network"></a>Настройка виртуальной сети Azure Resource Manager

С помощью портала настройте виртуальную сеть Azure Resource Manager, прежде чем пытаться присоединить к ней Azure-SSIS IR.

1. Запустите Microsoft Edge или Google Chrome. В настоящее время пользовательский интерфейс фабрики данных поддерживается только в этих веб-браузерах. 

1. Войдите на [портале Azure](https://portal.azure.com). 

1. Выберите **Больше служб**. Примените фильтр и выберите **Виртуальные сети**. 

1. Примените фильтр и выберите в списке свою виртуальную сеть. 

1. На странице **Виртуальная сеть** выберите **Свойства**. 

1. Нажмите кнопку копирования напротив поля **Идентификатор ресурса**, чтобы скопировать идентификатор ресурса для виртуальной сети в буфер обмена. Сохраните идентификатор из буфера обмена в OneNote или в файле. 

1. В меню слева выберите **подсети**. Убедитесь, что число доступных адресов превышает количество узлов в Azure-SSIS IR. 

1. Убедитесь, что поставщик пакетной службы Azure зарегистрирован в подписке Azure, которая содержит виртуальную сеть. Или зарегистрируйте поставщик пакетной службы Azure. Если у вас уже есть учетная запись пакетной службы Azure в вашей подписке, ваша подписка будет зарегистрирована в пакетной службе Azure. (При создании Azure-SSIS IR на портале фабрики данных поставщик пакетной службы Azure регистрируется автоматически.) 

   а) В портал Azure в меню слева выберите **подписки**. 

   б) Выберите свою подписку. 

   в) В левой части выберите **поставщики ресурсов**и убедитесь, что **Microsoft. Batch** является зарегистрированным поставщиком. 

   ![Подтверждение состояния "Зарегистрировано"](media/join-azure-ssis-integration-runtime-virtual-network/batch-registered-confirmation.png)

   Если поставщик **Microsoft.Batch** не отображается в списке, то для его регистрации [создайте в своей подписке пустую учетную запись пакетной службы Azure](../batch/batch-account-create-portal.md). Затем ее можно будет удалить. 

### <a name="configure-a-classic-virtual-network"></a>Настройка классической виртуальной сети
Используйте портал для настройки классической виртуальной сети, прежде чем пытаться присоединить к ней Azure-SSIS IR. 

1. Запустите Microsoft Edge или Google Chrome. В настоящее время пользовательский интерфейс фабрики данных поддерживается только в этих веб-браузерах. 

1. Войдите на [портале Azure](https://portal.azure.com). 

1. Выберите **Больше служб**. Примените фильтр и выберите **Виртуальные сети (классика)** . 

1. Примените фильтр и выберите в списке свою виртуальную сеть. 

1. На странице **Виртуальные сети (классика)** выберите **Свойства**. 

   ![Идентификатор ресурса классической виртуальной сети](media/join-azure-ssis-integration-runtime-virtual-network/classic-vnet-resource-id.png)

1. Нажмите кнопку копирования напротив поля **Идентификатор ресурса**, чтобы скопировать идентификатор ресурса для классической сети в буфер обмена. Сохраните идентификатор из буфера обмена в OneNote или в файле. 

1. В меню слева выберите **подсети**. Убедитесь, что число доступных адресов превышает количество узлов в Azure-SSIS IR. 

   ![Число доступных адресов в виртуальной сети](media/join-azure-ssis-integration-runtime-virtual-network/number-of-available-addresses.png)

1. Присоедините **MicrosoftAzureBatch** к роли **Участник классической виртуальной машины** для виртуальной сети. 

    а) В меню слева выберите **Управление доступом (IAM)** и перейдите на вкладку **назначения ролей** . 

    ![Кнопки "Управление доступом" и "Добавить"](media/join-azure-ssis-integration-runtime-virtual-network/access-control-add.png)

    б) Выберите **Добавить назначение ролей**.

    в) На странице **Добавление назначения ролей** выберите **роль** **участник классической виртуальной машины**. В поле **SELECT** вставьте **ddbf3205-c6bd-46ae-8127-60eb93363864**, а затем выберите **Пакетная служба Microsoft Azure** из списка результатов поиска. 

    ![Результаты поиска на странице "Добавление назначения ролей"](media/join-azure-ssis-integration-runtime-virtual-network/azure-batch-to-vm-contributor.png)

    г) Нажмите кнопку **сохранить** , чтобы сохранить параметры и закрыть страницу. 

    ![Сохранение параметров доступа](media/join-azure-ssis-integration-runtime-virtual-network/save-access-settings.png)

    д) Убедитесь, что в списке участников отображается **пакетная служба Microsoft Azure**. 

    ![Подтверждение доступа к пакетной службе Azure](media/join-azure-ssis-integration-runtime-virtual-network/azure-batch-in-list.png)

1. Убедитесь, что поставщик пакетной службы Azure зарегистрирован в подписке Azure, которая содержит виртуальную сеть. Или зарегистрируйте поставщик пакетной службы Azure. Если у вас уже есть учетная запись пакетной службы Azure в вашей подписке, ваша подписка будет зарегистрирована в пакетной службе Azure. (При создании Azure-SSIS IR на портале фабрики данных поставщик пакетной службы Azure регистрируется автоматически.) 

   а) В портал Azure в меню слева выберите **подписки**. 

   б) Выберите свою подписку. 

   в) В левой части выберите **поставщики ресурсов**и убедитесь, что **Microsoft. Batch** является зарегистрированным поставщиком. 

   ![Подтверждение состояния "Зарегистрировано"](media/join-azure-ssis-integration-runtime-virtual-network/batch-registered-confirmation.png)

   Если поставщик **Microsoft.Batch** не отображается в списке, то для его регистрации [создайте в своей подписке пустую учетную запись пакетной службы Azure](../batch/batch-account-create-portal.md). Затем ее можно будет удалить. 

### <a name="join-the-azure-ssis-ir-to-a-virtual-network"></a>Присоединение среды выполнения интеграции Azure SSIS к виртуальной сети

После настройки Azure Resource Manager виртуальной сети или классической виртуальной сети можно присоединить Azure-SSIS IR к виртуальной сети.

1. Запустите Microsoft Edge или Google Chrome. В настоящее время пользовательский интерфейс фабрики данных поддерживается только в этих веб-браузерах. 

1. В [портал Azure](https://portal.azure.com)в меню слева выберите **фабрики данных**. Если в меню не отображаются **фабрики данных** , выберите **больше служб**, а затем в разделе **аналитики и аналитика** выберите **фабрики данных**. 

   ![Список фабрик данных](media/join-azure-ssis-integration-runtime-virtual-network/data-factories-list.png)

1. Выберите фабрику данных с Azure-SSIS IR в списке. После этого откроется домашняя страница фабрики данных. Выберите плитку **Author & Deploy** (Создать и развернуть). На отдельной вкладке откроется пользовательский интерфейс фабрики данных. 

   ![Домашняя страница фабрики данных](media/join-azure-ssis-integration-runtime-virtual-network/data-factory-home-page.png)

1. В пользовательском интерфейсе фабрики данных перейдите на вкладку **Правка**, щелкните **Подключения**, а затем выберите вкладку **сред выполнения интеграции**. 

   ![Вкладка сред выполнения интеграции](media/join-azure-ssis-integration-runtime-virtual-network/integration-runtimes-tab.png)

1. Если Azure-SSIS IR выполняется, в списке **среды выполнения интеграции** в столбце **действия** нажмите кнопку " **Отключить** " для Azure-SSIS IR. Невозможно изменить IR, пока вы его не отключите. 

   ![Остановка среды выполнения интеграции](media/join-azure-ssis-integration-runtime-virtual-network/stop-ir-button.png)

1. В списке **среды выполнения интеграции** в столбце **действия** нажмите кнопку **изменить** для Azure-SSIS IR. 

   ![Изменение среды выполнения интеграции](media/join-azure-ssis-integration-runtime-virtual-network/integration-runtime-edit.png)

1. На панели **настройки Integration Runtime** перейдите на страницу **Общие параметры** и **параметры SQL** , нажав кнопку **Далее** . 

1. На странице **Дополнительные параметры** выполните следующие действия. 

   а) Установите флажок рядом с полем **выберите виртуальную сеть**. 

   б) **Подписка** — выберите подписку Azure. В подписке можно выбрать существующую виртуальную сеть. 
  
   в) В поле **Имя виртуальной сети** выберите нужную виртуальную сеть. 

   г) В поле **Имя подсети** выберите нужную подсеть в виртуальной сети. 

   д) Если вы также хотите настроить локальное IR в качестве прокси-сервера для Azure-SSIS IR, установите флажок **настроить автономное** размещение. Дополнительные сведения см. в статье [Настройка автономного IR в качестве прокси-сервера для Azure-SSIS IR](https://docs.microsoft.com/azure/data-factory/self-hosted-integration-runtime-proxy-ssis).

   е) Нажмите кнопку **Проверка виртуальной сети** . Если проверка прошла успешно, нажмите кнопку **Далее** . 

   ![Дополнительные параметры для настройки среды выполнения интеграции](media/join-azure-ssis-integration-runtime-virtual-network/ir-setup-advanced-settings.png)

1. На странице **Сводка** проверьте все параметры для Azure-SSIS IR. Затем нажмите кнопку **Обновить** .

1. Запустите Azure-SSIS IR, нажав кнопку **Пуск** в столбце **действия** для Azure-SSIS IR. Запуск Azure-SSIS IR, который присоединяется к виртуальной сети, займет от 20 до 30 минут. 

## <a name="azure-powershell"></a>Azure PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

### <a name="configure-a-virtual-network"></a>Настройка виртуальной сети
Перед присоединением Azure-SSIS IR к виртуальной сети необходимо настроить виртуальную сеть. Чтобы автоматически настроить разрешения и параметры виртуальной сети для Azure-SSIS IR присоединиться к виртуальной сети, добавьте следующий скрипт:

```powershell
# Make sure to run this script against the subscription to which the virtual network belongs.
if(![string]::IsNullOrEmpty($VnetId) -and ![string]::IsNullOrEmpty($SubnetName))
{
    # Register to the Azure Batch resource provider
    $BatchApplicationId = "ddbf3205-c6bd-46ae-8127-60eb93363864"
    $BatchObjectId = (Get-AzADServicePrincipal -ServicePrincipalName $BatchApplicationId).Id
    Register-AzResourceProvider -ProviderNamespace Microsoft.Batch
    while(!(Get-AzResourceProvider -ProviderNamespace "Microsoft.Batch").RegistrationState.Contains("Registered"))
    {
    Start-Sleep -s 10
    }
    if($VnetId -match "/providers/Microsoft.ClassicNetwork/")
    {
        # Assign the VM contributor role to Microsoft.Batch
        New-AzRoleAssignment -ObjectId $BatchObjectId -RoleDefinitionName "Classic Virtual Machine Contributor" -Scope $VnetId
    }
}
```

### <a name="create-an-azure-ssis-ir-and-join-it-to-a-virtual-network"></a>Создание среды выполнения интеграции Azure SSIS и ее присоединение к виртуальной сети
Вы можете создать среду выполнения интеграции Azure SSIS и присоединить ее к виртуальной сети одновременно. Полный сценарий и инструкции см. в разделе [создание Azure-SSIS IR](create-azure-ssis-integration-runtime.md#use-azure-powershell-to-create-an-integration-runtime).

### <a name="join-an-existing-azure-ssis-ir-to-a-virtual-network"></a>Присоединение имеющейся среды выполнения интеграции Azure SSIS к виртуальной сети
В статье [создание Azure-SSIS IR](create-azure-ssis-integration-runtime.md) показано, как создать Azure-SSIS IR и присоединить ее к виртуальной сети в том же скрипте. Если у вас уже есть Azure-SSIS IR, выполните следующие действия, чтобы присоединить его к виртуальной сети. 
1. Остановите среду выполнения интеграции Azure SSIS. 
1. Настройте среду выполнения интеграции Azure SSIS для присоединения виртуальной сети. 
1. Запустите среду выполнения интеграции Azure SSIS. 

### <a name="define-the-variables"></a>Определение переменных
```powershell
$ResourceGroupName = "<your Azure resource group name>"
$DataFactoryName = "<your Data Factory name>" 
$AzureSSISName = "<your Azure-SSIS IR name>"
# Specify the information about your classic or Azure Resource Manager virtual network.
$VnetId = "<your Azure virtual network resource ID>"
$SubnetName = "<the name of subnet in your virtual network>"
```

### <a name="stop-the-azure-ssis-ir"></a>Остановка среды выполнения интеграции Azure SSIS
Чтобы присоединиться к виртуальной сети, необходимо прерывать Azure-SSIS IR. Следующая команда освобождает все узлы и прекращает выставление счетов.

```powershell
Stop-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $ResourceGroupName `
                                            -DataFactoryName $DataFactoryName `
                                            -Name $AzureSSISName `
                                            -Force 
```

### <a name="configure-virtual-network-settings-for-the-azure-ssis-ir-to-join"></a>Настройка параметров виртуальной сети для присоединения средой выполнения интеграции Azure SSIS

Чтобы настроить параметры для виртуальной сети, к которой будут присоединяться службы Azure SSIS, используйте следующий скрипт: 

```powershell
# Make sure to run this script against the subscription to which the virtual network belongs.
if(![string]::IsNullOrEmpty($VnetId) -and ![string]::IsNullOrEmpty($SubnetName))
{
    # Register to the Azure Batch resource provider
    $BatchApplicationId = "ddbf3205-c6bd-46ae-8127-60eb93363864"
    $BatchObjectId = (Get-AzADServicePrincipal -ServicePrincipalName $BatchApplicationId).Id
    Register-AzResourceProvider -ProviderNamespace Microsoft.Batch
    while(!(Get-AzResourceProvider -ProviderNamespace "Microsoft.Batch").RegistrationState.Contains("Registered"))
    {
        Start-Sleep -s 10
    }
    if($VnetId -match "/providers/Microsoft.ClassicNetwork/")
    {
        # Assign VM contributor role to Microsoft.Batch
        New-AzRoleAssignment -ObjectId $BatchObjectId -RoleDefinitionName "Classic Virtual Machine Contributor" -Scope $VnetId
    }
}
```

### <a name="configure-the-azure-ssis-ir"></a>Настройка среды выполнения интеграции Azure SSIS
Чтобы настроить Azure-SSIS IR для приподключения к виртуальной сети, выполните команду `Set-AzDataFactoryV2IntegrationRuntime`: 

```powershell
Set-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $ResourceGroupName `
                                           -DataFactoryName $DataFactoryName `
                                           -Name $AzureSSISName `
                                           -Type Managed `
                                           -VnetId $VnetId `
                                           -Subnet $SubnetName
```

### <a name="start-the-azure-ssis-ir"></a>Запуск среды выполнения интеграции Azure SSIS
Чтобы запустить Azure-SSIS IR, выполните следующую команду: 

```powershell
Start-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $ResourceGroupName `
                                             -DataFactoryName $DataFactoryName `
                                             -Name $AzureSSISName `
                                             -Force

```

Выполнение этой команды занимает от 20 до 30 минут.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о Azure-SSIS IR см. в следующих статьях: 
- [Azure-SSIS IR](concepts-integration-runtime.md#azure-ssis-integration-runtime). В этой статье содержатся общие сведения о IRs, включая Azure-SSIS IR. 
- [Руководство. Развертывание пакетов служб SSIS в Azure](tutorial-create-azure-ssis-runtime-portal.md). В этом учебнике приводятся пошаговые инструкции по созданию Azure-SSIS IR. Для размещения каталога SSIS в ней используется База данных SQL Azure. 
- [Создайте Azure-SSIS IR](create-azure-ssis-integration-runtime.md). Эта статья разворачивается в этом руководстве. В нем приведены инструкции по использованию базы данных SQL Azure с конечными точками службы виртуальной сети или управляемым экземпляром в виртуальной сети для размещения каталога служб SSIS. В нем показано, как присоединить Azure-SSIS IR к виртуальной сети. 
- [Мониторинг среды выполнения интеграции в фабрике данных Azure](monitor-integration-runtime.md#azure-ssis-integration-runtime). В этой статье показано, как получить сведения о Azure-SSIS IR. Он предоставляет описания состояния для возвращаемых сведений. 
- [Управление средой выполнения интеграции Azure SSIS](manage-azure-ssis-integration-runtime.md). В этой статье показано, как приступить к работе, запускать или удалять Azure-SSIS IR. Кроме того, здесь показано, как развернуть IR Azure SSIS путем добавления узлов.
