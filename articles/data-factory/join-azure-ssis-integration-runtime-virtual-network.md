---
title: Присоединение среды выполнения интеграции Azure SSIS к виртуальной сети
description: Узнайте, как присоединиться к моменту выполнения интеграции Azure-SSIS в виртуальной сети Azure.
services: data-factory
documentationcenter: ''
ms.service: data-factory
ms.workload: data-services
ms.topic: conceptual
ms.date: 02/01/2020
author: swinarko
ms.author: sawinark
ms.reviewer: douglasl
manager: mflasko
ms.openlocfilehash: 4819eaf2a65cf542029cf36f262d0cea5be75f2e
ms.sourcegitcommit: b0ff9c9d760a0426fd1226b909ab943e13ade330
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2020
ms.locfileid: "80521947"
---
# <a name="join-an-azure-ssis-integration-runtime-to-a-virtual-network"></a>Присоединение среды выполнения интеграции Azure SSIS к виртуальной сети

При использовании служб интеграции серверов Сервера (SSIS) в Azure Data Factory необходимо присоединиться к моменту выполнения интеграции Azure-SSIS (IR) в виртуальную сеть Azure в следующих сценариях:

- Необходимо подключиться к магазинам данных из пакетов SSIS, которые работают на ИК Azure-SSIS без настройки или управления самостоятельной ИК в качестве прокси-сервера. 

- Вы хотите разместить базу данных каталога SSIS (SSISDB) в базе данных Azure S'L с правилами IP-брандмауэра/виртуальными конечными точками сетевого обслуживания или управляемым экземпляром с частной конечной точкой. 

- Необходимо подключиться к ресурсам Azure, настроенным с помощью конечных точек виртуального сетевого обслуживания из пакетов SSIS, которые работают на ИК Azure-SSIS.

- Необходимо подключиться к хранилищам данных/ресурсам, настроенным с правилами IP-брандмауэра из пакетов SSIS, которые работают на ИК Azure-SSIS.

Data Factory позволяет присоединиться к ИК Azure-SSIS в виртуальную сеть, созданную с помощью классической модели развертывания или модели развертывания ресурсов Azure.

> [!IMPORTANT]
> Классическая виртуальная сеть унижается, поэтому вместо этого используйте виртуальную сеть Azure Resource Manager.  Если вы уже используете классическую виртуальную сеть, переключитесь на виртуальную сеть Azure Resource Manager как можно скорее.

[Настройка службы интеграции серверов Azure-S'L Server -SSIS (ИСИС) для присоединения к виртуальному сетевому](tutorial-deploy-ssis-virtual-network.md) учебнику показывает минимальные шаги через портал Azure. Эта статья расширяет сяпок и описывает все дополнительные задачи:

- Если вы используете виртуальную сеть (классическая).
- Если вы приносите свои собственные общедоступные IP-адреса для ИК Azure-SSIS.
- Если вы используете свой собственный сервер системы доменных имен (DNS).
- Если вы используете группу сетевой безопасности (NSG) в подсети.
- Если вы используете Azure ExpressRoute или маршрут, определяемый пользователем (UDR).
- Если вы используете настраиваемый ИК Azure-SSIS.
- Если вы используете подготовку Azure Powershell.

## <a name="access-to-on-premises-data-stores"></a>Доступ к локальным хранилищам данных

Если пакеты SSIS имеют доступ к магазинам данных, вы можете присоединиться к ИК Azure-SSIS в виртуальной сети, подключенной к предварительной сети. Или вы можете настроить и управлять самостоятельной ИК в качестве прокси для вашего Azure-SSIS ИК. Для получения дополнительной информации [см. Налажнете самостоятельно хозяйничать ипотечник в качестве прокси для ИК Azure-SSIS.](https://docs.microsoft.com/azure/data-factory/self-hosted-integration-runtime-proxy-ssis) 

При присоединении к ИК Azure-SSIS в виртуальную сеть помните следующие важные моменты: 

- Если виртуальная сеть не подключена к вашей персональной сети, сначала создайте [виртуальную сеть Azure Resource Manager](../virtual-network/quick-create-portal.md#create-a-virtual-network) для присоединения к ИК Azure-SSIS. Затем настройте подключение к [VPN шлюзу](../vpn-gateway/vpn-gateway-howto-site-to-site-classic-portal.md) от сайта к сайту или соединение [ExpressRoute](../expressroute/expressroute-howto-linkvnet-classic.md) из этой виртуальной сети в вашу локальная сеть. 

- Если виртуальная сеть Azure Resource Manager уже подключена к вашей персональной сети в том же месте, что и Ваш ИК Azure-SSIS, вы можете присоединиться к ИК-виртуальной сети. 

- Если классическая виртуальная сеть уже подключена к вашей персональной сети в другом месте от ИК Azure-SSIS, можно создать [виртуальную сеть Azure Resource Manager](../virtual-network/quick-create-portal.md#create-a-virtual-network) для присоединения к ИК Azure-SSIS. Затем назначите [виртуальное сетевое](../vpn-gateway/vpn-gateway-connect-different-deployment-models-portal.md) подключение к классическим ресурсам. 
 
- Если виртуальная сеть Azure Resource Manager уже подключена к вашей персональной сети в другом месте от ИК Azure-SSIS, сначала можно создать [виртуальную сеть Azure Resource Manager](../virtual-network/quick-create-portal.md#create-a-virtual-network) для присоединения к ИК Azure-SSIS. Затем назначите виртуальное сетевое подключение менеджера ресурсов Azure Manager to-Azure Manager. 

## <a name="hosting-the-ssis-catalog-in-sql-database"></a>Хостинг каталога SSIS в базе данных S'L

Если вы размещаете свой каталог SSIS в базе данных Azure S'L с виртуальными конечными точками сетевого обслуживания, убедитесь, что вы присоединитесь к ИК Azure-SSIS к той же виртуальной сети и подсети.

Если вы размещаете свой каталог SSIS в управляемом экземпляре с частной конечной точкой, убедитесь, что вы присоединитесь к ИК Azure-SSIS в той же виртуальной сети, но в другой подсети, чем управляемый экземпляр. Чтобы присоединиться к ИК Azure-SSIS в другой виртуальной сети, чем управляемый экземпляр, мы рекомендуем либо виртуальную сеть пиринга (которая ограничена в том же регионе) или подключение от виртуальной сети к виртуальной сети. Для получения дополнительной информации посетите [см. Подключите приложение к управляемому экземпляру базы данных Azure S'L.](../sql-database/sql-database-managed-instance-connect-app.md)

## <a name="access-to-azure-services"></a>Доступ к службам Azure

Если SSIS пакеты доступа к ресурсам Azure, которые поддерживают [виртуальные конечные точки сетевого обслуживания,](../virtual-network/virtual-network-service-endpoints-overview.md) и вы хотите обеспечить доступ к этим ресурсам из Azure-SSIS IR, вы можете присоединиться к Azure-SSIS IR к виртуальной сети подсети, настроенной для конечных точек виртуального сетевого обслуживания, а затем добавить виртуальное сетевое правило в соответствующие ресурсы Azure, чтобы обеспечить доступ из той же подсети.

## <a name="access-to-data-sources-protected-by-ip-firewall-rule"></a>Доступ к источникам данных, защищенным правилом IP-брандмауэра

Если ваш SSIS пакеты доступа к хранилищам данных / ресурсам, которые позволяют только конкретные статические общедоступные IP-адреса, и вы хотите, чтобы обеспечить доступ к этим ресурсам из Azure-SSIS IR, вы можете принести свои собственные [общедоступные IP-адреса](https://docs.microsoft.com/azure/virtual-network/virtual-network-public-ip-address) для Azure-SSIS IR при присоединении к виртуальной сети, а затем добавить правило IP брандмауэра для соответствующих ресурсов, чтобы обеспечить доступ от этих IP-адресов.

Во всех случаях виртуальная сеть может быть развернута только через модель развертывания диспетчера ресурсов Azure.

В следующих разделах приведены дополнительные сведения. 

## <a name="virtual-network-configuration"></a>Конфигурация виртуальной сети

Наполните виртуальную сеть в соответствии с этими требованиями: 

- Убедитесь, `Microsoft.Batch` что это зарегистрированный провайдер по подписке на виртуальную сетевую подсеть, в размещениивую ИК Azure-SSIS. Если вы используете классическую `MicrosoftAzureBatch` виртуальную сеть, также присоединиться к классической виртуальной машины Вкладчик роль для этой виртуальной сети. 

- Убедитесь, что необходимые разрешения доступны. Для получения дополнительной [информации см.](#perms)

- Выберите подходящую подсеть для размещения Azure-SSIS IR. Для получения дополнительной информации [см.](#subnet) 

- Если вы приносите свои собственные общедоступные IP-адреса для ИК Azure-SSIS, [см.](#publicIP)

- Если вы используете свой собственный сервер Domain Name System (DNS) в виртуальной сети, [см.](#dns_server) 

- Если вы используете группу сетевой безопасности (NSG) в подсети, [см.](#nsg) 

- Если вы используете Azure ExpressRoute или маршрут, определяемый пользователем (UDR), [см.](#route) 

- Убедитесь, что группа ресурсов виртуальной сети (или группа ресурсов общедоступных IP-адресов, если вы приносите свои собственные общедоступные IP-адреса) могут создавать и удалять определенные сетевые ресурсы Azure. Для получения дополнительной информации [см.](#resource-group) 

- Если настроить ИК Azure-SSIS, как описано в [пользовательской настройке для Azure-SSIS IR,](https://docs.microsoft.com/azure/data-factory/how-to-configure-azure-ssis-ir-custom-setup)ваши IP-узлы Azure-SSIS получат частные IP-адреса из заданного диапазона 172.16.0.0 до 172.31.255.255. Поэтому убедитесь, что частные диапазоны IP-адресов ваших виртуальных или закрытых сетей не сталкиваются с этим диапазоном.

На этой диаграмме отобраста необходимые подключения для ИК Azure-SSIS:

![Azure SSIS IR](media/join-azure-ssis-integration-runtime-virtual-network/azure-ssis-ir.png)

### <a name="set-up-permissions"></a><a name="perms"></a>Настройка разрешений

Пользователь, создающий ИК Azure-SSIS, должен иметь следующие разрешения:

- Если вы присоединяете Azure-SSIS IR к виртуальной сети Azure Resource Manager, у вас есть два варианта:

  - Использовать встроенную роль Участник сетей. Эта роль предоставляет разрешение _Microsoft.Network/\*_, область применения которого намного шире, чем требуется для этой задачи.

  - Создать настраиваемую роль, которая включает только нужное разрешение _Microsoft.Network/virtualNetworks/\*/join/action_. Если вы также хотите принести свои собственные общедоступные IP-адреса для Azure-SSIS IR, присоединившись к виртуальной сети Azure Resource Manager, пожалуйста, также включите в роль _Microsoft.Network/publicIPAddresses//join/action_ permission.

- Если вы присоединяете SSIS IR к классической виртуальной сети, мы рекомендуем использовать встроенную роль Участник классических виртуальных машин. В противном случае вам нужно будет определить пользовательскую роль, которая включает разрешение на присоединение к виртуальной сети.

### <a name="select-the-subnet"></a><a name="subnet"></a> Выбор подсети

При выборе подсети: 

- Не выбирайте GatewaySubnet для развертывания ИК Azure-SSIS. Он предназначен для виртуальных сетевых шлюзов. 

- Убедитесь, что выбранная подсеть имеет достаточно доступное адресное пространство для использования ИК Azure-SSIS. Оставьте доступные IP-адреса по крайней мере в два раза больше номера ИК-узла. Azure резервирует некоторые IP-адреса в каждой подсети. Эти адреса не могут быть использованы. Первый и последний IP-адреса подсетей зарезервированы для соответствия протокола, а еще три адреса используются для служб Azure. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets) 

- Не используйте подсеть, которая исключительно занята другими службами Azure (например, служба управляемых данных базы данных S'L, служба приложений и так далее). 

### <a name="select-the-static-public-ip-addresses"></a><a name="publicIP"></a>Выберите статические общедоступные IP-адреса

Если вы хотите привести свои собственные статические общедоступные IP-адреса для Azure-SSIS IR, присоединившись к виртуальной сети, убедитесь, что они отвечают следующим требованиям:

- Следует предоставить ровно два неиспользованных ресурса, которые еще не связаны с другими ресурсами Azure. Дополнительный будет использоваться при периодическом обновлении ИК Azure-SSIS. Обратите внимание, что один общедоступный IP-адрес не может быть общим среди активных ИК Azure-SSIS.

- Они оба должны быть статичными стандартного типа. Для получения более подробной информации обратитесь к [SUS общественного IP-адреса.](https://docs.microsoft.com/azure/virtual-network/virtual-network-ip-addresses-overview-arm#sku)

- Они оба должны иметь имя DNS. Если при его создании вы не предоставили имя DNS, это можно сделать на портале Azure.

![Azure SSIS IR](media/ssis-integration-runtime-management-troubleshoot/setup-publicipdns-name.png)

- Они и виртуальная сеть должны находиться под одной подпиской и в одном регионе.

### <a name="set-up-the-dns-server"></a><a name="dns_server"></a>Настройка DNS-сервера 
Если вам нужно использовать свой собственный DNS-сервер в виртуальной сети, к ней присоединился ваш ИК Azure-SSIS для решения вашего `<your storage account>.blob.core.windows.net`частного имени хоста, убедитесь, что он также может решить глобальные имена хостов Azure (например, капля хранения Azure' named). 

Ниже приведен один рекомендуемый подход: 

-   Нанастройка пользовательских DNS для переадресов запросов в Azure DNS. Неразрешенные DNS-записи можно переслать на СВОЙ собственный DNS-сервер (168.63.129.16) на собственном DNS-сервере. 

Для получения дополнительной информации см. [разрешение имен, которое использует ваш собственный DNS-сервер.](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server) 

> [!NOTE]
> Пожалуйста, используйте полностью квалифицированное доменное имя (ФЗДН) `<your_private_server>.contoso.com` для `<your_private_server>`вашего частного имени хоста, например, использовать вместо , как Azure-SSIS IR не будет автоматически приложение свой собственный DNS суффикс.

### <a name="set-up-an-nsg"></a><a name="nsg"></a>Настройка NSG
Если вам нужно реализовать NSG для подсети, используемой вашим ИК Azure-SSIS, разрешите входящий и исходящий трафик через следующие порты: 

-   **Входящие требования Azure-SSIS ИК**

| Направление | Транспортный протокол | Источник | Диапазон исходных портов | Назначение | Диапазон портов назначения | Комментарии |
|---|---|---|---|---|---|---|
| Входящий трафик | TCP | BatchNodeManagement | * | Виртуальная сеть | 29876, 29877 (если вы присоединитесь к ИК в виртуальной сети менеджер ресурсов) <br/><br/>10100, 20100, 30100 (при присоединении среды выполнения интеграции к классической виртуальной сети)| Служба Data Factory использует эти порты для связи с узлами иК Azure-SSIS в виртуальной сети. <br/><br/> Независимо от того, создаете ли вы NSG уровня подсети, Data Factory всегда настраивает NSG на уровне карт сетевого интерфейса (NICs), прикрепленных к виртуальным машинам, вмещающим ИК Azure-SSIS. NSG уровня сетевых адаптеров на указанных портах разрешает только входящий трафик от IP-адресов Фабрики данных. Даже если вы откроете эти порты для интернет-трафика на уровне подсети, трафик с IP-адресов, которые не являются IP-адресами Data Factory, блокируется на уровне NIC. |
| Входящий трафик | TCP | CorpNetSaw | * | Виртуальная сеть | 3389 | (Необязательно) Это правило требуется только тогда, когда сторонник Майкрософт просит клиента открыть для продвинутой работы по устранению неполадок, и может быть закрыто сразу после устранения неполадок. Тег службы **CorpNetSaw** позволяет использовать удаленный рабочий стол только для работы по работе с пользователями доступа в корпоративной сети Майкрософт. И этот тег не может быть выбран с портала и доступен только через Azure PowerShell или Azure CLI. <br/><br/> На уровне NIC NSG порт 3389 открыт по умолчанию, и мы позволяем вам управлять портом 3389 на уровне подсети NSG, в то время как Azure-SSIS IR исключила порт 3389, исходящий по умолчанию в правиле брандмауэра Windows на каждом ИК-узеле для защиты. |
||||||||

-   **ИК-требование об исходящих иР-ик-класса Azure-SSIS**

| Направление | Транспортный протокол | Источник | Диапазон исходных портов | Назначение | Диапазон портов назначения | Комментарии |
|---|---|---|---|---|---|---|
| Исходящие | TCP | Виртуальная сеть | * | AzureCloud; | 443 | Узлы вашего ИК Azure-SSIS в виртуальной сети используют этот порт для доступа к службам Azure, таким как Azure Storage и Azure Event Hubs. |
| Исходящие | TCP | Виртуальная сеть | * | Интернет | 80 | (Необязательно) Узлы вашего ИК Azure-SSIS в виртуальной сети используют этот порт для загрузки списка отзыва сертификатов из Интернета. При блокировании этого трафика при запуске ИК-ик-ик-икс могут понизиться производительность и потерять возможность проверки списка аннулирования сертификатов для использования сертификата. Если вы хотите еще больше сузить место назначения до определенных F-DN, пожалуйста, обратитесь к **разделу «Использование Azure ExpressRoute» или раздела UDR**|
| Исходящие | TCP | Виртуальная сеть | * | SQL | 1433, 11000-11999 | (Необязательно) Это правило требуется только в том случае, если узлы вашего ИК Azure-SSIS в виртуальной сети получают доступ к SSISDB, размещенному на вашем сервере базы данных S'L. Если ваша политика подключения сервера базы данных s'L установлена на **Прокси** вместо **Перенаправления,** необходим только порт 1433. <br/><br/> Это правило безопасности исходящих не применимо к SSISDB, размещенному управляемым экземпляром в виртуальной сети или сервере базы данных Azure, настроенном с частной конечной точкой. |
| Исходящие | TCP | Виртуальная сеть | * | Виртуальная сеть | 1433, 11000-11999 | (Необязательно) Это правило требуется только тогда, когда узлы вашего ИК Azure-SSIS в виртуальной сети получают доступ к SSISDB, размещенному управляемым экземпляром в виртуальной сети или сервере базы данных Azure, настроенном с частной конечной точкой. Если ваша политика подключения сервера базы данных s'L установлена на **Прокси** вместо **Перенаправления,** необходим только порт 1433. |
| Исходящие | TCP | Виртуальная сеть | * | Память | 445 | (Необязательно) Это правило требуется только при выполнении пакета SSIS, хранящегося в файлах Azure. |
||||||||

### <a name="use-azure-expressroute-or-udr"></a><a name="route"></a>Используйте Azure ExpressRoute или UDR
Если вы хотите проверить исходящий трафик из Azure-SSIS IR, вы можете направить трафик, инициированный из Azure-SSIS IR, на попредк брандмауэра через туннелирование сил [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) (реклама маршрута BGP, 0.0.0.0/0, в виртуальную сеть) или в сеть Virtual Appliance (NVA) в качестве брандмауэра или [Azure Firewall](https://docs.microsoft.com/azure/firewall/) через [UDRs.](../virtual-network/virtual-networks-udr-overview.md) 

![Сценарий NVA для ИК Azure-SSIS](media/join-azure-ssis-integration-runtime-virtual-network/azure-ssis-ir-nva.png)

Вы должны сделать ниже вещей, чтобы сделать весь сценарий работы
   -   Входящий трафик между службами управления Azure Batch и ИК Azure-SSIS не может быть перенаправлен с помощью брандмауэра.
   -   Прибор брандмауэра позволяет осуществлять исходящий трафик, требуемый ИК Azure-SSIS.

Входящий трафик между службами управления Azure Batch и ИК Azure-SSIS не может быть направлен на брандмауэр, в противном случае трафик будет нарушен из-за проблемы с асимметричной маршрутизацией. Маршруты должны быть определены для входящего трафика, чтобы трафик мог ответить обратно так же, как он пришел дюйма Можно определить конкретные UD-трафика для маршрутизатора трафика между службами управления Azure Batch и ИК Azure-SSIS со следующим типом перехода в качестве **Интернета.**

Например, если ваш ИК Azure-SSIS `UK South` находится в истечении и вы хотите проверить исходящий трафик `BatchNodeManagement.UKSouth` через Azure Firewall, вы, во-первых, получите список IP-класса сервисного тега из [ссылки загрузки диапазона IP-услуг](https://www.microsoft.com/download/details.aspx?id=56519) или через [API Service Tag Discovery.](https://aka.ms/discoveryapi) Затем примените следующие UDRs связанных маршрутов диапазона IP со следующим типом **хмеля** в качестве Интернета вместе с маршрутом 0.0.0.0/0 со следующим типом перехода в качестве **виртуального устройства.**

![Настройки UDR пакета Azure](media/join-azure-ssis-integration-runtime-virtual-network/azurebatch-udr-settings.png)

> [!NOTE]
> Такой подход несет дополнительные расходы на техническое обслуживание. Регулярно проверяйте диапазон IP и добавляйте новые диапазоны IP в UDR, чтобы избежать взлома ИК Azure-SSIS. Мы рекомендуем проверять диапазон IP ежемесячно, потому что, когда новый IP появится в теге обслуживания, IP займет еще один месяц вступит в силу. 

Чтобы упростить настройку правил UDR, можно запустить следующий сценарий Powershell, чтобы добавить правила UDR для служб управления Azure Batch:
```powershell
$Location = "[location of your Azure-SSIS IR]"
$RouteTableResourceGroupName = "[name of Azure resource group that contains your Route Table]"
$RouteTableResourceName = "[resource name of your Azure Route Table ]"
$RouteTable = Get-AzRouteTable -ResourceGroupName $RouteTableResourceGroupName -Name $RouteTableResourceName
$ServiceTags = Get-AzNetworkServiceTag -Location $Location
$BatchServiceTagName = "BatchNodeManagement." + $Location
$UdrRulePrefixForBatch = $BatchServiceTagName
if ($ServiceTags -ne $null)
{
    $BatchIPRanges = $ServiceTags.Values | Where-Object { $_.Name -ieq $BatchServiceTagName }
    if ($BatchIPRanges -ne $null)
    {
        Write-Host "Start to add rule for your route table..."
        for ($i = 0; $i -lt $BatchIPRanges.Properties.AddressPrefixes.Count; $i++)
        {
            $UdrRuleName = "$($UdrRulePrefixForBatch)_$($i)"
            Add-AzRouteConfig -Name $UdrRuleName `
                -AddressPrefix $BatchIPRanges.Properties.AddressPrefixes[$i] `
                -NextHopType "Internet" `
                -RouteTable $RouteTable `
                | Out-Null
            Write-Host "Add rule $UdrRuleName to your route table..."
        }
        Set-AzRouteTable -RouteTable $RouteTable
    }
}
else
{
    Write-Host "Failed to fetch service tags, please confirm that your Location is valid."
}
```

Для того, чтобы прибор брандмауэра разрешал исходящий трафик, необходимо разрешить выход в порты ниже, как и требование в правилах исходящего NSG.
-   Порт 443 с направлением как услуги Azure Cloud.

    Если вы используете Azure Firewall, можно указать сетевое правило с помощью тега службы AzureCloud. Для брандмауэра других типов можно либо просто разрешить назначение, как и все для порта 443, либо позволить ниже F-DN в зависимости от типа среды Azure:
    | Среда Azure | Конечные точки                                                                                                                                                                                                                                                                                                                                                              |
    |-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | Azure Public      | <ul><li><b>Фабрика данных Azure (Управление)</b></li><li style="list-style-type:none"><ul><li>\*.frontend.clouddatahub.net</li></ul></li><li><b>Хранение azure (Управление)</b></li><li style="list-style-type:none"><ul><li>\*.blob.core.windows.net</li><li>\*.table.core.windows.net</li></ul></li><li><b>Реестр контейнеров Azure (пользовательская настройка)</b></li><li style="list-style-type:none"><ul><li>\*.azurecr.io</li></ul></li><li><b>Концентратор событий (Регистрация)</b></li><li style="list-style-type:none"><ul><li>\*.servicebus.windows.net.</li></ul></li><li><b>Служба регистрации Майкрософт (внутреннее использование)</b></li><li style="list-style-type:none"><ul><li>gcs.prod.monitoring.core.windows.net</li><li>prod.warmpath.msftcloudes.com;</li><li>azurewatsonanalysis-prod.core.windows.net</li></ul></li></ul> |
    | Azure для государственных организаций  | <ul><li><b>Фабрика данных Azure (Управление)</b></li><li style="list-style-type:none"><ul><li>\*.frontend.datamovement.azure.us</li></ul></li><li><b>Хранение azure (Управление)</b></li><li style="list-style-type:none"><ul><li>\*.blob.core.usgovcloudapi.net</li><li>\*.table.core.usgovcloudapi.net</li></ul></li><li><b>Реестр контейнеров Azure (пользовательская настройка)</b></li><li style="list-style-type:none"><ul><li>\*.azurecr.us</li></ul></li><li><b>Концентратор событий (Регистрация)</b></li><li style="list-style-type:none"><ul><li>\*.servicebus.usgovcloudapi.net</li></ul></li><li><b>Служба регистрации Майкрософт (внутреннее использование)</b></li><li style="list-style-type:none"><ul><li>fairfax.warmpath.usgovcloudapi.net;</li><li>azurewatsonanalysis.usgovcloudapp.net</li></ul></li></ul> |
    | Azure China 21Vianet     | <ul><li><b>Фабрика данных Azure (Управление)</b></li><li style="list-style-type:none"><ul><li>\*.frontend.datamovement.azure.cn</li></ul></li><li><b>Хранение azure (Управление)</b></li><li style="list-style-type:none"><ul><li>\*.blob.core.chinacloudapi.cn</li><li>\*.table.core.chinacloudapi.cn</li></ul></li><li><b>Реестр контейнеров Azure (пользовательская настройка)</b></li><li style="list-style-type:none"><ul><li>\*.azurecr.cn</li></ul></li><li><b>Концентратор событий (Регистрация)</b></li><li style="list-style-type:none"><ul><li>\*.servicebus.chinacloudapi.cn</li></ul></li><li><b>Служба регистрации Майкрософт (внутреннее использование)</b></li><li style="list-style-type:none"><ul><li>mooncake.warmpath.chinacloudapi.cn;</li><li>azurewatsonanalysis.chinacloudapp.cn</li></ul></li></ul>

    Что касается F-DNs хранилища Azure, реестра контейнеров Azure и концентратора событий, то можно также включить следующие конечные точки обслуживания для виртуальной сети, чтобы сетевой трафик в эти конечные точки проходил через магистральные сети Azure вместо того, чтобы направляться на прибор брандмауэра:
    -  Microsoft.Storage;
    -  Microsoft.ContainerRegistry
    -  Microsoft.EventHub


-   Порт 80 с назначением, как CRL скачать сайты.

    Вы должны разрешить ниже F-DNs, которые используются в качестве CRL (Список отзыва сертификатов) загружать сайты сертификатов для целей управления Azure-SSIS:
    -  crl.microsoft.com:80
    -  mscrl.microsoft.com:80
    -  crl3.digicert.com:80
    -  crl4.digicert.com:80
    -  ocsp.digicert.com:80
    -  cacerts.digicert.com:80
    
    Если вы используете сертификаты, имеющие различные CRL, вам предлагается включить их также. Вы можете прочитать это, чтобы понять больше на [список отзыва сертификатов](https://social.technet.microsoft.com/wiki/contents/articles/2303.understanding-access-to-microsoft-certificate-revocation-list.aspx).

    Если вы откажетесь от этого трафика, вы можете испытать понижение производительности при запуске ИК Azure-SSIS и потерять возможность проверить список отзыва сертификатов для использования сертификата, который не рекомендуется с точки зрения безопасности.

-   Порт 1433, 11000-11999 с пунктом назначения, как Azure S'L (требуется только при необходимости узлов вашего Azure-SSIS IR в виртуальной сети доступ к SSISDB, размещенный на вашем сервере базы данных S'L).

    Если вы используете Azure Firewall, можно указать сетевое правило с помощью тега службы Azure S'L, в противном случае вы можете разрешить назначение в качестве конкретного лазурного URL-адреса sql в приборе брандмауэра.

-   Порт 445 с назначением в качестве хранилища Azure (требуется только при выполнении пакета SSIS, хранящегося в файлах Azure).

    Если вы используете Azure Firewall, можно указать сетевое правило с тегом службы хранения, в противном случае вы можете разрешить назначение в качестве конкретного лазурного файла хранения URL в брандмауэре.

> [!NOTE]
> Для Azure S'L и Storage, если настроить конечные точки службы Virtual Network в подсети, то трафик между Azure-SSIS IR и Azure S'L в том же регионе - Azure Storage в том же регионе или в паре будет направляться в сеть Microsoft Azure backbone непосредственно вместо вашего брандмауэра.

Если вам не нужна возможность проверки исходящего трафика Azure-SSIS IR, вы можете просто применить маршрут, чтобы заставить весь трафик к следующему типу перехода **Интернет:**

-   В сценарии Azure ExpressRoute можно применить маршрут 0.0.0.0/0 со следующим типом перехода в качестве **Интернета** в подсети, в котором размещается ИК Azure-SSIS. 
-   В сценарии NVA можно изменить существующий маршрут 0.0.0.0/0, применяемый в подсети, в котором размещается ИК Azure-SSIS, от следующего типа хмеля как **виртуальный прибор** для **Интернета.**

![Добавление маршрута](media/join-azure-ssis-integration-runtime-virtual-network/add-route-for-vnet.png)

> [!NOTE]
> Указать маршрут со следующим типом перехода **Интернет** не означает, что весь трафик будет идти через Интернет. Пока адрес назначения предназначен для одной из служб Azure, Azure направляет трафик непосредственно в службу через магистранную сеть Azure, а не направляет трафик в Интернет.

### <a name="set-up-the-resource-group"></a><a name="resource-group"></a>Настройка группы ресурсов

Среда выполнения интеграции Azure SSIS должна создать определенные сетевые ресурсы в той же группе ресурсов, в которой находится виртуальная сеть. Эти ресурсы включают в себя:
- Балансиватель нагрузки Azure с именем * \<Guid>-azurebatch-cloudserviceloadbalancer.*
- Общедоступный IP-адрес Azure с именем * \<Guid>-azurebatch-cloudservicepublicip.*
- Группа безопасности сетевой работы с названием * \<Guid>-azurebatch-cloudservicenetworksecuritygroupgroup.* 

> [!NOTE]
> Теперь вы можете принести свои собственные статические общедоступные IP-адреса для Azure-SSIS IR. В этом сценарии мы создадим только балансизатор нагрузки Azure и группу сетевой безопасности в той же группе ресурсов, что и ваши статичные общедоступные IP-адреса, а не виртуальную сеть.

Эти ресурсы будут созданы после запуска ИК Azure-SSIS. Они будут удалены, когда ваш ИК Azure-SSIS прекратится. Если вы берете свои собственные статичные общедоступные IP-адреса для Azure-SSIS IR, ваши собственные статичные общедоступные IP-адреса не будут удалены при остановке ИК Azure-SSIS. Чтобы не блокировать икобову Azure-SSIS, не используйте эти сетевые ресурсы в других ресурсах.

Убедитесь, что у вас нет блокировки ресурсов на группе ресурсов / подписке, к которой принадлежит виртуальная сеть/ваши статичные общедоступные IP-адреса. Если вы наверснете блокировку только для чтения/удаления, запуск и остановка ИК Azure-SSIS не удастся, или он перестанет отвечать.

Убедитесь, что у вас нет политики Azure, которая предотвращает создание следующих ресурсов в группе ресурсов/подписке, к которой принадлежат виртуальная сеть/ваши статические общедоступные IP-адреса: 
- Microsoft.Network/LoadBalancers 
- Microsoft.Network/NetworkSecurityGroups 
- Microsoft.Network/PublicIPAddresses 

Убедитесь, что квоты ресурсов вашей подписки достаточно для вышеуказанных трех сетевых ресурсов. В частности, для каждого ИК Azure-SSIS, созданного в виртуальной сети, необходимо зарезервировать две бесплатные квоты для каждого из трех вышеперечисленных сетевых ресурсов. Дополнительная квота будет использоваться при периодическом обновлении ИК Azure-SSIS.

### <a name="faq"></a><a name="faq"></a> Вопросы и ответы

- Как защитить общедоступный IP-адрес, выставленный на моем ИК Azure-SSIS, для входящего соединения? Можно ли удалить общедоступный IP-адрес?
 
  Сейчас общедоступный IP-адрес будет автоматически создан, когда ваш ИК Azure-SSIS присоединится к виртуальной сети. У нас есть NSG уровня NIC, позволяющий только службам управления Azure Batch входить в исключаемый икобовик Azure-SSIS. Вы также можете указать NSG уровня подсети для входящих защиты.

  Если вы не хотите, чтобы какой-либо общедоступный IP-адрес был разоблачен, подумайте о [настройке самостоятельно размещенной ИК в качестве прокси-сервера для вашего ИК Azure-SSIS](https://docs.microsoft.com/azure/data-factory/self-hosted-integration-runtime-proxy-ssis) вместо присоединения к ИК Azure-SSIS к виртуальной сети, если это относится к вашему сценарию.
 
- Могу ли я добавить общедоступный IP-адрес моего ИК Azure-SSIS в список разрешений брандмауэра для источников данных?

  Теперь вы можете принести свои собственные статические общедоступные IP-адреса для Azure-SSIS IR. В этом случае можно добавить свои IP-адреса в список разрешений брандмауэра для источников данных. Вы также можете рассмотреть другие варианты ниже, чтобы обеспечить доступ к данным от Azure-SSIS ИК в зависимости от вашего сценария:

  - Если ваш источник данных находится в помещениях, после подключения виртуальной сети к вашей предварительной сети и присоединения Azure-SSIS IR к виртуальной сети подсети, вы можете добавить частный диапазон IP-адресов этой подсети в список разрешений брандмауэра для вашего источника данных.
  - Если источником данных является служба Azure, которая поддерживает конечные точки виртуального сетевого обслуживания, можно настроить виртуальную конечную точку сетевого сервиса в вашей виртуальной сетевой подсети и присоединиться к ИК Azure-SSIS в эту подсеть. Затем можно добавить виртуальное сетевое правило с этой подсетью в брандмауэр для исходного кода.
  - Если ваш источник данных является облачным сервисом, не относящемся к Azure, можно использовать UDR для маршрутизации исходящего трафика с ИК Azure-SSIS в брандмауэр NVA/Azure через статический общедоступный IP-адрес. Затем можно добавить статический общедоступный IP-адрес брандмауэра NVA/Azure firewall в список разрешений брандмауэра для источника данных.
  - Если ни один из вышеперечисленных вариантов не отвечает вашим потребностям, подумайте о [настройке самостоятельной ИК-иК в качестве прокси для Вашего ИК Azure-SSIS.](https://docs.microsoft.com/azure/data-factory/self-hosted-integration-runtime-proxy-ssis) Затем можно добавить статический общедоступный IP-адрес машины, в котором размещается ваш самоуправляемый ИК, в список разрешений брандмауэра для вашего источника данных.

- Почему мне нужно узнать два статических общедоступных адреса, если я хочу принести свой собственный для Azure-SSIS IR?

  Azure-SSIS IR автоматически обновляется на регулярной основе. Новые узлы создаются во время обновления, а старые будут удалены. Однако, чтобы избежать простоя, старые узлы не будут удалены до тех пор, пока новые не будут готовы. Таким образом, ваш первый статический общедоступный IP-адрес, используемый старыми узлами, не может быть немедленно выпущен, и нам нужен второй статический публичный IP-адрес для создания новых узлов.

- Я принес свои собственные статические общедоступные IP-адреса для Azure-SSIS IR, но почему он до сих пор не может получить доступ к моим источникам данных?

  - Подтвердите, что два статических общедоступных IP-адреса добавляются в список разрешений брандмауэра для источников данных. Каждый раз, когда ваш ИК Azure-SSIS обновляется, его статический общедоступный IP-адрес переключается между двумя принесенными вами. Если вы добавите только один из них в список разрешений, доступ к данным для ИК Azure-SSIS будет нарушен после его обновления.
  - Если ваш источник данных — это служба Azure, пожалуйста, проверьте, сконфигурировали ли вы его с помощью конечных точек виртуального сетевого обслуживания. Если это так, трафик от Azure-SSIS IR к источнику данных перейдет на использование частных IP-адресов, управляемых службами Azure, и добавление собственных статических общедоступных IP-адресов в список разрешений брандмауэра для вашего источника данных не вступит в силу.

## <a name="azure-portal-data-factory-ui"></a>Портал Azure (пользовательский интерфейс фабрики данных)

В этом разделе показано, как присоединиться к существующей ИК Azure-SSIS к виртуальной сети (классический или Azure Resource Manager) с помощью портала Azure и пользовательского чата Data Factory. 

Перед тем, как присоединиться к ИК Azure-SSIS, необходимо правильно настроить виртуальную сеть. Выполните действия в разделе, который применяется к типу виртуальной сети (классический или Azure Resource Manager). Затем выполните последующие действия в третьем разделе, чтобы присоединиться к ИК Azure-SSIS в виртуальной сети. 

### <a name="configure-an-azure-resource-manager-virtual-network"></a>Настройка виртуальной сети менеджера ресурсов Azure

Используйте портал для настройки виртуальной сети Azure Resource Manager, прежде чем пытаться присоединиться к ИК Azure-SSIS.

1. Запустите Microsoft Edge или Google Chrome. В настоящее время только эти веб-браузеры поддерживают uI Data Factory. 

1. Войдите на [портал Azure](https://portal.azure.com). 

1. Выберите **дополнительные услуги**. Примените фильтр и выберите **Виртуальные сети**. 

1. Примените фильтр и выберите в списке свою виртуальную сеть. 

1. На странице **Виртуальная сеть** выберите **Свойства**. 

1. Нажмите кнопку копирования напротив поля **Идентификатор ресурса**, чтобы скопировать идентификатор ресурса для виртуальной сети в буфер обмена. Сохраните идентификатор из буфера обмена в OneNote или в файле. 

1. В левом меню выберите **подсети.** Убедитесь, что количество доступных адресов больше, чем узлов в икфазе Azure-SSIS. 

1. Убедитесь, что поставщик пакетной службы Azure зарегистрирован в подписке Azure, которая содержит виртуальную сеть. Или зарегистрируйте поставщика Azure Batch. Если в подписке уже есть учетная запись Azure Batch, ваша подписка зарегистрирована на Azure Batch. (При создании Azure-SSIS IR на портале фабрики данных поставщик пакетной службы Azure регистрируется автоматически.) 

   1. На портале Azure, в левом меню, выберите **Подписки**. 

   1. Выберите свою подписку. 

   1. Слева выберите **поставщиков ресурсов**и подтвердите, что **Microsoft.Batch** является зарегистрированным поставщиком. 

   ![Подтверждение состояния "Зарегистрировано"](media/join-azure-ssis-integration-runtime-virtual-network/batch-registered-confirmation.png)

   Если поставщик **Microsoft.Batch** не отображается в списке, то для его регистрации [создайте в своей подписке пустую учетную запись пакетной службы Azure](../batch/batch-account-create-portal.md). Затем ее можно будет удалить. 

### <a name="configure-a-classic-virtual-network"></a>Налаживание классической виртуальной сети

Используйте портал для настройки классической виртуальной сети, прежде чем пытаться присоединиться к ИК Azure-SSIS. 

1. Запустите Microsoft Edge или Google Chrome. В настоящее время только эти веб-браузеры поддерживают uI Data Factory. 

1. Войдите на [портал Azure](https://portal.azure.com). 

1. Выберите **дополнительные услуги**. Примените фильтр и выберите **Виртуальные сети (классика)**. 

1. Примените фильтр и выберите в списке свою виртуальную сеть. 

1. На странице **Виртуальные сети (классика)** выберите **Свойства**. 

   ![Идентификатор ресурса классической виртуальной сети](media/join-azure-ssis-integration-runtime-virtual-network/classic-vnet-resource-id.png)

1. Нажмите кнопку копирования напротив поля **Идентификатор ресурса**, чтобы скопировать идентификатор ресурса для классической сети в буфер обмена. Сохраните идентификатор из буфера обмена в OneNote или в файле. 

1. В левом меню выберите **подсети.** Убедитесь, что количество доступных адресов больше, чем узлов в икфазе Azure-SSIS. 

   ![Число доступных адресов в виртуальной сети](media/join-azure-ssis-integration-runtime-virtual-network/number-of-available-addresses.png)

1. Присоедините **MicrosoftAzureBatch** к роли **Участник классической виртуальной машины** для виртуальной сети. 

   1. В левом меню выберите **элемент управления доступом (IAM)** и выберите вкладку **«Назначения роли».** 

       ![Кнопки "Управление доступом" и "Добавить"](media/join-azure-ssis-integration-runtime-virtual-network/access-control-add.png)

   1. Выберите **Назначение ролей.**

   1. На странице **назначения роли Добавить,** для **роли**, выберите **Классический Виртуальный Machine Contributor**. В поле **Select,** вставьте **ddbf3205-c6bd-46ae-8127-60eb93363864**, а затем выберите **Microsoft Azure Batch** из списка результатов поиска. 

       ![Результаты поиска на странице "Добавить назначение ролей"](media/join-azure-ssis-integration-runtime-virtual-network/azure-batch-to-vm-contributor.png)

   1. Выберите **Сохранить,** чтобы сохранить настройки и закрыть страницу. 

       ![Сохранение параметров доступа](media/join-azure-ssis-integration-runtime-virtual-network/save-access-settings.png)

   1. Убедитесь, что в списке участников отображается **пакетная служба Microsoft Azure**. 

       ![Подтверждение доступа к пакетной службе Azure](media/join-azure-ssis-integration-runtime-virtual-network/azure-batch-in-list.png)

1. Убедитесь, что поставщик пакетной службы Azure зарегистрирован в подписке Azure, которая содержит виртуальную сеть. Или зарегистрируйте поставщика Azure Batch. Если в подписке уже есть учетная запись Azure Batch, ваша подписка зарегистрирована на Azure Batch. (При создании Azure-SSIS IR на портале фабрики данных поставщик пакетной службы Azure регистрируется автоматически.) 

   1. На портале Azure, в левом меню, выберите **Подписки**. 

   1. Выберите свою подписку. 

   1. Слева выберите **поставщиков ресурсов**и подтвердите, что **Microsoft.Batch** является зарегистрированным поставщиком. 

   ![Подтверждение состояния "Зарегистрировано"](media/join-azure-ssis-integration-runtime-virtual-network/batch-registered-confirmation.png)

   Если поставщик **Microsoft.Batch** не отображается в списке, то для его регистрации [создайте в своей подписке пустую учетную запись пакетной службы Azure](../batch/batch-account-create-portal.md). Затем ее можно будет удалить. 

### <a name="join-the-azure-ssis-ir-to-a-virtual-network"></a>Присоединение среды выполнения интеграции Azure SSIS к виртуальной сети

После настройки виртуальной сети Azure Resource Manager или классической виртуальной сети можно присоединиться к ИК Azure-SSIS в виртуальную сеть:

1. Запустите Microsoft Edge или Google Chrome. В настоящее время только эти веб-браузеры поддерживают uI Data Factory. 

1. На [портале Azure](https://portal.azure.com)( в левом меню, выберите **data заводы**. Если вы не видите **фабрики данных** в меню, выберите **дополнительные услуги,** а затем в разделе **INTELLIGENCE и ANALYTICS,** выберите **фабрики данных.** 

   ![Список фабрик данных](media/join-azure-ssis-integration-runtime-virtual-network/data-factories-list.png)

1. Выберите фабрику данных с ИК Azure-SSIS в списке. После этого откроется домашняя страница фабрики данных. Выберите плитку **«Автор & монитор».** На отдельной вкладке откроется пользовательский интерфейс фабрики данных. 

   ![Домашняя страница фабрики данных](media/join-azure-ssis-integration-runtime-virtual-network/data-factory-home-page.png)

1. В пользовательском интерфейсе фабрики данных перейдите на вкладку **Правка**, щелкните **Подключения**, а затем выберите вкладку **сред выполнения интеграции**. 

   ![Вкладка сред выполнения интеграции](media/join-azure-ssis-integration-runtime-virtual-network/integration-runtimes-tab.png)

1. Если ваш ИК Azure-SSIS работает в списке **«Время выполнения интеграции»** в столбце **«Действия»,** выберите кнопку **«Стоп»** для ИК Azure-SSIS. Вы не можете отсечь иСР Azure-SSIS до тех пор, пока не прекратите его. 

   ![Остановка среды выполнения интеграции](media/join-azure-ssis-integration-runtime-virtual-network/stop-ir-button.png)

1. В списке **«Интеграция Runtimes»** в столбце **«Действия»** выберите кнопку **«Отображение»** для ИК Azure-SSIS. 

   ![Изменение среды выполнения интеграции](media/join-azure-ssis-integration-runtime-virtual-network/integration-runtime-edit.png)

1. На панели настройки времени выполнения интеграции продвигайся по общим параметрам **и** **секциям настроек S'L,** выбрав кнопку **«Следующая».** 

1. В разделе **Расширенные настройки:** 

   1. Выберите **VNet для вашего Времени интеграции Azure-SSIS, чтобы присоединиться, позвольте ADF создавать определенные сетевые ресурсы и по желанию принести свой собственный статический общедоступный ip-адрес.** 

   1. В поле **Подписка** выберите подписку Azure, в которой расположена виртуальная сеть.

   1. В поле **Расположение** введите то же расположение среды выполнения интеграции.

   1. Для **type**выберите тип виртуальной сети: классический или Azure Resource Manager. Мы рекомендуем выбрать виртуальную сеть Azure Resource Manager, поскольку классические виртуальные сети вскоре будут утиханы.

   1. В поле **Имя виртуальной сети** выберите имя вашей виртуальной сети. Это должен быть тот же, который используется для вашего сервера базы данных Azure S'L с виртуальными конечными точками сетевого обслуживания или управляемым экземпляром с частной конечной точкой для размещения SSISDB. Или он должен быть таким же, как и к вашей сети. В противном случае, это может быть любая виртуальная сеть, чтобы принести свои собственные статические общедоступные IP-адреса для Azure-SSIS ИК.

   1. В поле **Имя подсети** выберите имя подсети в виртуальной сети. Это должно быть то же самое, что используется для вашего сервера базы данных Azure S'L с виртуальными конечными точками сетевого обслуживания для размещения SSISDB. Или это должна быть другая подсеть, чем та, которая используется для управляемого экземпляра с частной конечной точкой для размещения SSISDB. В противном случае, это может быть любая подсеть, чтобы принести свои собственные статические общедоступные IP-адреса для Azure-SSIS ИК.

   1. Выберите **статичные общедоступные IP-адреса для вашего флажка Azure-SSIS Integration Runtime,** чтобы выбрать, хотите ли вы предоставить свои собственные статичные общедоступные IP-адреса для Azure-SSIS IR, чтобы вы могли разрешить их в брандмауэре для источников данных.

      Если вы выберете флажок, выполните следующие шаги.

      1. Для **первого статического общедоступного IP-адреса**выберите первый статический общедоступный IP-адрес, отвечающий [требованиям,](#publicIP) предъявляемомке к ИК Azure-SSIS. Если у вас их нет, нажмите **«Создайте новую** ссылку» для создания статических общедоступных IP-адресов на портале Azure, а затем нажмите кнопку обновления здесь, чтобы вы могли выбрать их.
      
      1. Для **второго статического общедоступного IP-адреса**выберите второй статический общедоступный IP-адрес, отвечающий [требованиям,](#publicIP) предъявляемомке к ИК Azure-SSIS. Если у вас их нет, нажмите **«Создайте новую** ссылку» для создания статических общедоступных IP-адресов на портале Azure, а затем нажмите кнопку обновления здесь, чтобы вы могли выбрать их.

   1. Выберите **валидацию VNet**. Если проверка удалась, выберите **Продолжить**. 

   ![Дополнительные параметры с использованием виртуальной сети](./media/tutorial-create-azure-ssis-runtime-portal/advanced-settings-vnet.png)

1. В разделе **Резюме** просмотрите все настройки для ИК Azure-SSIS. Затем выберите **обновление**.

1. Запустите ИК Azure-SSIS, выбрав кнопку **«Пуск»** в столбце **«Действия»** для ИК Azure-SSIS. Запуск ИК Azure-SSIS, который присоединяется к виртуальной сети, занимает от 20 до 30 минут. 

## <a name="azure-powershell"></a>Azure PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

### <a name="define-the-variables"></a>Определение переменных

```powershell
$ResourceGroupName = "[your Azure resource group name]"
$DataFactoryName = "[your data factory name]"
$AzureSSISName = "[your Azure-SSIS IR name]"
# Virtual network info: Classic or Azure Resource Manager
$VnetId = "[your virtual network resource ID or leave it empty]" # REQUIRED if you use an Azure SQL Database server with IP firewall rules/virtual network service endpoints or a managed instance with private endpoint to host SSISDB, or if you require access to on-premises data without configuring a self-hosted IR. We recommend an Azure Resource Manager virtual network, because classic virtual networks will be deprecated soon.
$SubnetName = "[your subnet name or leave it empty]" # WARNING: Use the same subnet as the one used for your Azure SQL Database server with virtual network service endpoints, or a different subnet from the one used for your managed instance with a private endpoint
# Public IP address info: OPTIONAL to provide two standard static public IP addresses with DNS name under the same subscription and in the same region as your virtual network
$FirstPublicIP = "[your first public IP address resource ID or leave it empty]"
$SecondPublicIP = "[your second public IP address resource ID or leave it empty]"
```

### <a name="configure-a-virtual-network"></a>Настройка виртуальной сети

Прежде чем присоединиться к ИК Azure-SSIS в виртуальную сеть, необходимо настроить виртуальную сеть. Чтобы автоматически настроить виртуальные сетевые разрешения и настройки для вашего ИК Azure-SSIS для присоединения к виртуальной сети, добавьте следующий скрипт:

```powershell
# Make sure to run this script against the subscription to which the virtual network belongs.
if(![string]::IsNullOrEmpty($VnetId) -and ![string]::IsNullOrEmpty($SubnetName))
{
    # Register to the Azure Batch resource provider
    $BatchApplicationId = "ddbf3205-c6bd-46ae-8127-60eb93363864"
    $BatchObjectId = (Get-AzADServicePrincipal -ServicePrincipalName $BatchApplicationId).Id
    Register-AzResourceProvider -ProviderNamespace Microsoft.Batch
    while(!(Get-AzResourceProvider -ProviderNamespace "Microsoft.Batch").RegistrationState.Contains("Registered"))
    {
    Start-Sleep -s 10
    }
    if($VnetId -match "/providers/Microsoft.ClassicNetwork/")
    {
        # Assign the VM contributor role to Microsoft.Batch
        New-AzRoleAssignment -ObjectId $BatchObjectId -RoleDefinitionName "Classic Virtual Machine Contributor" -Scope $VnetId
    }
}
```

### <a name="create-an-azure-ssis-ir-and-join-it-to-a-virtual-network"></a>Создание среды выполнения интеграции Azure SSIS и ее присоединение к виртуальной сети

Вы можете создать среду выполнения интеграции Azure SSIS и присоединить ее к виртуальной сети одновременно. Для полного сценария и инструкций [см.](create-azure-ssis-integration-runtime.md#use-azure-powershell-to-create-an-integration-runtime)

### <a name="join-an-existing-azure-ssis-ir-to-a-virtual-network"></a>Присоединение имеющейся среды выполнения интеграции Azure SSIS к виртуальной сети

В статье [«Создание ИК Azure-SSIS»](create-azure-ssis-integration-runtime.md) показано, как создать ИК Azure-SSIS и присоединиться к виртуальной сети в том же скрипте. Если у вас уже есть ИК Azure-SSIS, выполните следующие действия, чтобы присоединиться к его виртуальной сети: 
1. Остановите среду выполнения интеграции Azure SSIS. 
1. Настройте среду выполнения интеграции Azure SSIS для присоединения виртуальной сети. 
1. Запустите среду выполнения интеграции Azure SSIS. 

### <a name="stop-the-azure-ssis-ir"></a>Остановка среды выполнения интеграции Azure SSIS

Прежде чем присоединиться к виртуальной сети, необходимо остановить ИК Azure-SSIS. Следующая команда освобождает все узлы и прекращает выставление счетов.

```powershell
Stop-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $ResourceGroupName `
    -DataFactoryName $DataFactoryName `
    -Name $AzureSSISName `
    -Force 
```

### <a name="configure-virtual-network-settings-for-the-azure-ssis-ir-to-join"></a>Настройка параметров виртуальной сети для присоединения средой выполнения интеграции Azure SSIS

Для настройки настроек виртуальной сети, к которым присоединится Azure-SSIS, используйте этот скрипт: 

```powershell
# Make sure to run this script against the subscription to which the virtual network belongs.
if(![string]::IsNullOrEmpty($VnetId) -and ![string]::IsNullOrEmpty($SubnetName))
{
    # Register to the Azure Batch resource provider
    $BatchApplicationId = "ddbf3205-c6bd-46ae-8127-60eb93363864"
    $BatchObjectId = (Get-AzADServicePrincipal -ServicePrincipalName $BatchApplicationId).Id
    Register-AzResourceProvider -ProviderNamespace Microsoft.Batch
    while(!(Get-AzResourceProvider -ProviderNamespace "Microsoft.Batch").RegistrationState.Contains("Registered"))
    {
        Start-Sleep -s 10
    }
    if($VnetId -match "/providers/Microsoft.ClassicNetwork/")
    {
        # Assign VM contributor role to Microsoft.Batch
        New-AzRoleAssignment -ObjectId $BatchObjectId -RoleDefinitionName "Classic Virtual Machine Contributor" -Scope $VnetId
    }
}
```

### <a name="configure-the-azure-ssis-ir"></a>Настройка среды выполнения интеграции Azure SSIS

Чтобы присоединиться к ИК Azure-SSIS `Set-AzDataFactoryV2IntegrationRuntime` в виртуальную сеть, запустите команду: 

```powershell
Set-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $ResourceGroupName `
    -DataFactoryName $DataFactoryName `
    -Name $AzureSSISName `
    -VnetId $VnetId `
    -Subnet $SubnetName

# Add public IP address parameters if you bring your own static public IP addresses
if(![string]::IsNullOrEmpty($FirstPublicIP) -and ![string]::IsNullOrEmpty($SecondPublicIP))
{
    $publicIPs = @($FirstPublicIP, $SecondPublicIP)
    Set-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $ResourceGroupName `
        -DataFactoryName $DataFactoryName `
        -Name $AzureSSISName `
        -PublicIPs $publicIPs
}
```

### <a name="start-the-azure-ssis-ir"></a>Запуск среды выполнения интеграции Azure SSIS

Чтобы запустить ИК Azure-SSIS, запустите следующую команду: 

```powershell
Start-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $ResourceGroupName `
    -DataFactoryName $DataFactoryName `
    -Name $AzureSSISName `
    -Force
```

Выполнение этой команды занимает от 20 до 30 минут.

## <a name="next-steps"></a>Дальнейшие действия

Для получения дополнительной информации об ИК Azure-SSIS смотрите следующие статьи: 
- [Azure-SSIS ИК](concepts-integration-runtime.md#azure-ssis-integration-runtime). В этой статье приводится общая концептуальная информация об ИР, включая ИК Azure-SSIS. 
- [Учебник: Развертывание пакетов SSIS в Azure](tutorial-create-azure-ssis-runtime-portal.md). В этом уроке содержатся пошаговые инструкции по созданию ИК Azure-SSIS. Для размещения каталога SSIS в ней используется База данных SQL Azure. 
- [Создайте ИК Azure-SSIS](create-azure-ssis-integration-runtime.md). Эта статья расширяется на учебник. В нем содержатся инструкции об использовании базы данных Azure S'L с виртуальными конечными точками сетевого обслуживания или управляемым экземпляром в виртуальной сети для размещения каталога SSIS. Он показывает, как присоединиться к ИК Azure-SSIS к виртуальной сети. 
- [Мониторинг среды выполнения интеграции в фабрике данных Azure](monitor-integration-runtime.md#azure-ssis-integration-runtime). В этой статье показано, как получить информацию о вашем ИК Azure-SSIS. Он предоставляет описания статуса для возвращенной информации. 
- [Manage an Azure-SSIS integration runtime](manage-azure-ssis-integration-runtime.md) (Управление средой выполнения интеграции Azure SSIS). В этой статье показано, как остановить, запустить или удалить ИК Azure-SSIS. Кроме того, здесь показано, как развернуть IR Azure SSIS путем добавления узлов.