---
title: Использование Управляемого экземпляра Базы данных SQL Azure с помощью Azure MSSQL Integration Services в Фабрике данных Azure
description: Узнайте, как использовать Управляемый экземпляр Базы данных SQL Azure с помощью MSSQL Integration Services в Фабрике данных Azure.
services: data-factory
documentationcenter: ''
author: chugugrace
ms.author: chugu
ms.reviewer: ''
manager: ''
ms.service: data-factory
ms.workload: data-services
ms.topic: conceptual
ms.date: 4/15/2020
ms.openlocfilehash: 74cad0ab9ffc3eb05219cb9e2c2585e73498c9bd
ms.sourcegitcommit: fdec8e8bdbddcce5b7a0c4ffc6842154220c8b90
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2020
ms.locfileid: "83663542"
---
# <a name="use-azure-sql-database-managed-instance-with-sql-server-integration-services-ssis-in-azure-data-factory"></a>Использование Управляемого экземпляра Базы данных SQL Azure с помощью MSSQL Integration Services в Фабрике данных Azure

[!INCLUDE[appliesto-adf-asa-md](includes/appliesto-adf-xxx-md.md)]

Проекты, пакеты и рабочие нагрузки служб SQL Server Integration Services (SSIS) теперь можно переносить в облако Azure. Для управления, развертывания и выполнения проектов и пакетов SSIS, размещенных в Базе данных SQL Azure или Управляемом экземпляре Базы данных SQL, вы можете использовать привычные вам инструменты, например SQL Server Management Studio (SSMS). В этой статье рассматриваются следующие вопросы, связанные с использованием Управляемого экземпляра Базы данных SQL Azure с помощью Azure-SSIS Integration Runtime (IR):

- [Подготовка к работе Azure-SSIS IR с помощью каталога SSIS (SSISDB), размещенного в Управляемом экземпляре Базы данных SQL Azure](#provision-azure-ssis-ir-with-ssisdb-hosted-by-azure-sql-database-managed-instance).
- [Выполнение пакетов служб интеграции SQL Server с помощью задания агента Управляемого экземпляра SQL Azure](how-to-invoke-ssis-package-managed-instance-agent.md).
- [Очистка журналов SSISDB с помощью задания агента Управляемого экземпляра SQL Azure](#clean-up-ssisdb-logs).
- [Отработка отказа Azure-SSIS IR с помощью Управляемого экземпляра Базы данных SQL Azure](configure-bcdr-azure-ssis-integration-runtime.md#azure-ssis-ir-failover-with-a-sql-database-managed-instance).
- [Перенос локальных рабочих нагрузок служб интеграции SQL Server в службы интеграции SQL Server в ADF с помощью Управляемого экземпляра Базы данных SQL Azure в качестве назначения рабочей нагрузки базы данных](scenario-ssis-migration-overview.md#azure-sql-database-managed-instance-as-database-workload-destination).

## <a name="provision-azure-ssis-ir-with-ssisdb-hosted-by-azure-sql-database-managed-instance"></a>Подготовка к работе Azure-SSIS IR с помощью каталога SSISDB, размещенного в Управляемом экземпляре Базы данных SQL Azure

### <a name="prerequisites"></a>Предварительные требования

1. [Включите Azure Active Directory (Azure AD) в Управляемом экземпляре Базы данных SQL Azure](enable-aad-authentication-azure-ssis-ir.md#configure-azure-ad-authentication-for-azure-sql-database-managed-instance) при выборе проверки подлинности Azure Active Directory.

1. Выберите способ подключения управляемого экземпляра SQL: через частную или общедоступную конечную точку.

    - Через частную конечную точку (рекомендуется).

        1. Выберите виртуальную сеть для присоединения Azure-SSIS IR:
            - Вы можете выбрать ту же виртуальную сеть, в которой расположен управляемый экземпляр SQL с **другой подсетью**.
            - Или выбрать виртуальную сеть, отличную от сети управляемого экземпляра SQL, используя пиринг между виртуальными сетями (в том же регионе из-за ограничений при глобальном пиринге виртуальных сетей) или подключение типа "виртуальная сеть — виртуальная сеть".

            Дополнительные сведения см. в статье [Подключение приложения к Управляемому экземпляру Базы данных SQL](https://review.docs.microsoft.com/azure/sql-database/sql-database-managed-instance-connect-app).

        1. [Настройте виртуальную сеть](#configure-virtual-network).

    - Через общедоступную конечную точку.

        Управляемые экземпляры Базы данных SQL Azure могут подключаться через [общедоступные конечные точки](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-public-endpoint-configure). Чтобы разрешить трафик между Управляемым экземпляром SQL и Azure-SSIS IR необходимо соблюдать требования к входящему и исходящему трафику:

        - Если Azure-SSIS IR расположен не в виртуальной сети (рекомендуется):

            **Требование входящего трафика Управляемого экземпляра SQL** для разрешения входящего трафика от Azure-SSIS IR.

            | Транспортный протокол | Источник | Диапазон исходных портов | Назначение | Диапазон портов назначения |
            |---|---|---|---|---|
            |TCP|Тег облачной службы Azure|*|Виртуальная сеть|3342|

            Дополнительные сведения см. в разделе [Разрешение общедоступного трафика конечной точки в группе безопасности сети](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-public-endpoint-configure#allow-public-endpoint-traffic-on-the-network-security-group).

        - Если Azure-SSIS IR расположен в виртуальной сети:

            Существует специальный сценарий, если Управляемый экземпляр SQL находится в регионе, который не поддерживается средой Azure-SSIS IR, находящейся внутри виртуальной сети без пиринга виртуальных сетей из-за ограничения пиринга глобальной виртуальной сети. В этом сценарии **Azure-SSIS IR внутри виртуальной сети** подключает Управляемый экземпляр SQL **через общедоступную конечную точку**. Чтобы разрешить трафик между Управляемым экземпляром SQL и Azure-SSIS IR, соблюдайте следующие правила группы безопасности сети (NSG):

            1. **Требование входящего трафика Управляемого экземпляра SQL** для разрешения входящего трафика от Azure-SSIS IR.

                | Транспортный протокол | Источник | Диапазон исходных портов | Назначение |Диапазон портов назначения |
                |---|---|---|---|---|
                |TCP|Статический IP-адрес Azure-SSIS IR. <br> Дополнительные сведения см. в разделе [об использовании собственного общедоступного IP-адреса для Azure-SSIS IR](join-azure-ssis-integration-runtime-virtual-network.md#publicIP).|*|Виртуальная сеть|3342|

             1. **Требование исходящего трафика Azure-SSIS IR** для разрешения исходящего трафика к Управляемому экземпляру SQL.

                | Транспортный протокол | Источник | Диапазон исходных портов | Назначение |Диапазон портов назначения |
                |---|---|---|---|---|
                |TCP|Виртуальная сеть|*|[IP-адрес общедоступной конечной точки в Управляемом экземпляре SQL](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-find-management-endpoint-ip-address)|3342|

### <a name="configure-virtual-network"></a>Настройка виртуальной сети

1. **Разрешение пользователя**. У пользователя, создающего Azure-SSIS IR, должна быть [назначена роль](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-list-portal#list-role-assignments-for-a-user-at-a-scope) по крайней мере в ресурсе Фабрики данных Azure с одним из следующих вариантов:

    - Использовать встроенную роль "Участник сетей". Эта роль предоставляет разрешение _Microsoft.Network/\*_ , область применения которого намного шире, чем требуется для этой задачи.
    - Создать настраиваемую роль, которая включает только нужное разрешение _Microsoft.Network/virtualNetworks/\*/join/action_. Если вы хотите также использовать собственные общедоступные IP-адреса для среды Azure-SSIS IR при присоединении ее к виртуальной сети Azure Resource Manager, то включите в роль разрешение _Microsoft.Network/publicIPAddresses/*/join/action_.

1. **Виртуальная сеть**.

    1. Убедитесь, что группа ресурсов виртуальной сети может создавать и удалять определенные ресурсы сети Azure.

        Среда выполнения интеграции Azure SSIS должна создать определенные сетевые ресурсы в той же группе ресурсов, в которой находится виртуальная сеть. К этим ресурсам относятся:
        - подсистема балансировки нагрузки с именем *\<Guid>-azurebatch-cloudserviceloadbalancer*;
        - группа безопасности сети с именем *\<Guid>-azurebatch-cloudservicenetworksecuritygroup;
        - общедоступный IP-адрес Azure с именем -azurebatch-cloudservicepublicip.

        Эти ресурсы будут созданы при запуске Azure-SSIS IR. Они будут удалены после остановки Azure-SSIS IR. Чтобы предотвратить блокировку остановки Azure-SSIS IR, не используйте повторно эти сетевые ресурсы в других ресурсах.

    1. Убедитесь в отсутствии [блокировки ресурсов](https://docs.microsoft.com/azure/azure-resource-manager/management/lock-resources) в группе ресурсов и подписке, к которым принадлежит виртуальная сеть. Если вы настроили блокировку только для чтения или удаления, запуск и остановка среды Azure-SSIS IR завершатся ошибкой или она перестанет отвечать на запросы.

    1. Убедитесь, что у вас нет политики Azure, которая запрещает создавать следующие ресурсы в группе ресурсов и подписке, к которым принадлежит виртуальная сеть:
        - Microsoft.Network/LoadBalancers
        - Microsoft.Network/NetworkSecurityGroups

    1. Для обеспечения трафика между Управляемым экземпляром SQL и Azure-SSIS IR, а также трафика, необходимого для Azure-SSIS IR, разрешите трафик по правилам группы безопасности сети (NSG).
        1. **Требование входящего трафика Управляемого экземпляра SQL** для разрешения входящего трафика от Azure-SSIS IR.

            | Транспортный протокол | Источник | Диапазон исходных портов | Назначение | Диапазон портов назначения | Комментарии |
            |---|---|---|---|---|---|
            |TCP|Виртуальная сеть|*|Виртуальная сеть|1433, 11000–11999|Если для политики подключения сервера Базы данных SQL задано значение **Proxy** вместо **Redirect**, требуется только порт 1433.|

        1. **Требование исходящего трафика Azure-SSIS IR** для разрешения исходящего трафика к Управляемому экземпляру SQL и другого трафика, необходимого Azure-SSIS IR.

        | Транспортный протокол | Источник | Диапазон исходных портов | Назначение | Диапазон портов назначения | Комментарии |
        |---|---|---|---|---|---|
        | TCP | Виртуальная сеть | * | Виртуальная сеть | 1433, 11000–11999 |Разрешите исходящий трафик к Управляемому экземпляру SQL. Если для политики подключения задано значение **Proxy** вместо **Redirect**, требуется только порт 1433. |
        | TCP | Виртуальная сеть | * | AzureCloud; | 443 | Узлы Azure-SSIS IR в виртуальной сети используют этот порт для доступа к службам Azure, например к службе хранилища Azure и Центрам событий Azure. |
        | TCP | Виртуальная сеть | * | Интернет | 80 | (Необязательно.) Узлы Azure SSIS IR в виртуальной сети используют этот порт для скачивания списка отзыва сертификатов из Интернета. Если заблокировать этот трафик, производительность при запуске IR может снизиться и вы можете потерять возможность выполнить проверку списка отзыва сертификатов для использования сертификата. Если вы хотите дополнительно сузить место назначения до определенных полных доменных имен, ознакомьтесь с разделом [Использование Azure ExpressRoute или UDR](https://docs.microsoft.com/azure/data-factory/join-azure-ssis-integration-runtime-virtual-network#route).|
        | TCP | Виртуальная сеть | * | Память | 445 | (Необязательно.) Это правило требуется только при выполнении пакета службы интеграции SQL Server, хранящегося в службе "Файлы Azure". |
        |||||||

        1. **Требование входящего трафика Azure-SSIS IR** для разрешения трафика, необходимого Azure-SSIS IR.

        | Транспортный протокол | Источник | Диапазон исходных портов | Назначение | Диапазон портов назначения | Комментарии |
        |---|---|---|---|---|---|
        | TCP | BatchNodeManagement | * | Виртуальная сеть | 29876, 29877 (при присоединении среды выполнения интеграции к виртуальной сети Resource Manager) <br/><br/>10100, 20100, 30100 (при присоединении среды выполнения интеграции к классической виртуальной сети)| Служба фабрики данных использует эти порты для взаимодействия с узлами вашей среды выполнения интеграции Azure-SSIS IR в виртуальной сети. <br/><br/> Независимо от того, создан уровень подсети NSG или нет, Фабрика данных всегда настраивает NSG на уровне карт сетевых интерфейсов, подключенных к виртуальным машинам, на которых размещается Azure-SSIS IR. NSG уровня сетевых адаптеров на указанных портах разрешает только входящий трафик от IP-адресов Фабрики данных. Даже если эти порты доступны для интернет-трафика, трафик с IP-адресов, которые не являются IP-адресами Фабрики данных, блокируется на уровне сетевых адаптеров. |
        | TCP | CorpNetSaw | * | Виртуальная сеть | 3389 | (Необязательно.) Это правило требуется только в том случае, если служба поддержки Майкрософт предлагает клиенту открыть порт для расширенного устранения неполадок. Этот порт можно будет закрыть сразу после устранения неполадок. Тег службы **CorpNetSaw** позволяет использовать удаленный рабочий стол только с помощью рабочих станций с защищенным доступом в корпоративной сети Майкрософт. Этот тег службы нельзя выбрать на портале, он доступен только через Azure PowerShell или Azure CLI. <br/><br/> В NSG уровня сетевых адаптеров порт 3389 открыт по умолчанию, и мы позволяем управлять портом 3389 в NSG на уровне подсети, в то время как Azure-SSIS IR по умолчанию отключил исходящий порт 3389 в правиле брандмауэра Windows на каждом узле IR в целях защиты. |
        |||||||

    1. Дополнительную информацию см. в разделе [о конфигурации виртуальной сети](join-azure-ssis-integration-runtime-virtual-network.md#virtual-network-configuration), если:
        - вы используете собственный общедоступный IP-адрес для Azure-SSIS IR;
        - вы используете собственный DNS-сервер;
        - вы используете Azure ExpressRoute или определяемый пользователем маршрут (UDR);
        - вы используете настраиваемую среду Azure-SSIS IR.

### <a name="provision-azure-ssis-integration-runtime"></a>Подготовка к работе Azure-SSIS IR

1. Выберите частную или общедоступную конечную точку в Управляемом экземпляре SQL.

    При [подготовке Azure-SSIS IR](create-azure-ssis-integration-runtime.md#provision-an-azure-ssis-integration-runtime) в приложении портала Azure или ADF на странице параметров SQL используйте **частную** или **общедоступную конечную точку** в управляемом экземпляре SQL при создании каталога службы интеграции SQL Server (SSISDB).

    Имя узла общедоступной конечной точки имеет формат <mi_name>.public.<dns_zone>.database.windows.net и порт, используемый для соединения, — 3342.  

    ![catalog-public-endpoint](./media/how-to-use-sql-managed-instance-with-ir/catalog-public-endpoint.png)

1. При применении параметров выберите проверку подлинности Azure AD.

    ![catalog-public-endpoint](./media/how-to-use-sql-managed-instance-with-ir/catalog-aad.png)

    Дополнительную информацию см. в разделе [Настройка проверки подлинности Azure AD для Управляемого экземпляра SQL Azure](enable-aad-authentication-azure-ssis-ir.md#configure-azure-ad-authentication-for-azure-sql-database-managed-instance).

1. При применении параметров присоедините Azure-SSIS IR к виртуальной сети.

    На странице дополнительных параметров выберите виртуальную сеть и подсеть для присоединения.
    
    В той же виртуальной сети, что и Управляемый экземпляр SQL, выберите **другую подсеть** (отличную от Управляемого экземпляра SQL). 

    Дополнительные сведения см. в статье [Присоединение среды выполнения интеграции Azure SSIS к виртуальной сети](join-azure-ssis-integration-runtime-virtual-network.md).

    ![join-virtual-network](./media/how-to-use-sql-managed-instance-with-ir/join-virtual-network.png)

Дополнительные сведения о создании Azure-SSIS IR см. в статье [Создание среды выполнения интеграции Azure-SSIS в Фабрике данных Azure](create-azure-ssis-integration-runtime.md#provision-an-azure-ssis-integration-runtime).

## <a name="clean-up-ssisdb-logs"></a>Очистка журналов SSISDB

Политика хранения журналов SSISDB определяется по следующим свойствам в [catalog.catalog_properties](https://docs.microsoft.com/sql/integration-services/system-views/catalog-catalog-properties-ssisdb-database?view=sql-server-ver15):

- OPERATION_CLEANUP_ENABLED

    Если значение равно TRUE, подробности и сообщения, связанные с операциями старше RETENTION_WINDOW (дней), удаляются из каталога. Если значение равно FALSE, все подробности и сообщения операции сохраняются в каталоге. Примечание. Задание SQL Server выполняет очистку операций.

- RETENTION_WINDOW

    Срок (в днях) сохранения подробностей и сообщений операции в каталоге. Значение, равное – 1, соответствует неограниченному сроку хранения. Примечание. Если очистка не требуется, присвойте свойству OPERATION_CLEANUP_ENABLED значение FALSE.

Для удаления журналов SSISDB, которые находятся за пределами окна периода удержания, настроенного администратором, можно активировать хранимую процедуру `[internal].[cleanup_server_retention_window_exclusive]`. При необходимости можно запланировать выполнение задания агента управляемого экземпляра SQL для активации хранимой процедуры.

## <a name="next-steps"></a>Дальнейшие действия

- [Выполнение пакетов служб интеграции SQL Server с помощью задания агента Управляемого экземпляра SQL Azure](how-to-invoke-ssis-package-managed-instance-agent.md).
- [Настройка среды выполнения интеграции Azure-SSIS с помощью георепликации и отработки отказа Базы данных SQL Azure](configure-bcdr-azure-ssis-integration-runtime.md).
- [Миграция локальных рабочих нагрузок служб SSIS в службы SSIS в ADF](scenario-ssis-migration-overview.md).
