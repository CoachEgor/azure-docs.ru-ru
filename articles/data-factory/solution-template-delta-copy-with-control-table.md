---
title: Копия Delta из базы данных с помощью таблицы управления
description: Узнайте, как использовать шаблон решения для добавочного копирования только новых или обновленных строк из базы данных в Фабрике данных Azure.
services: data-factory
documentationcenter: ''
author: dearandyxu
ms.author: yexu
ms.reviewer: douglasl
manager: anandsub
ms.service: data-factory
ms.workload: data-services
ms.topic: conceptual
ms.custom: seo-lt-2019
ms.date: 12/24/2018
ms.openlocfilehash: 01a6d796a9a8306da5bb707111b07786136a66cc
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81414789"
---
# <a name="delta-copy-from-a-database-with-a-control-table"></a>Копия Delta из базы данных с таблицей управления
[!INCLUDE[appliesto-adf-asa-md](includes/appliesto-adf-asa-md.md)]

В этой статье описывается шаблон, который доступен для постепенной загрузки новых или обновленных строк из таблицы баз данных в Azure с помощью таблицы внешнего управления, в которой хранится значение высокого уровня воды.

Этот шаблон требует, чтобы схема исходной базы данных содержит столбец метки времени или клавишу приравки для идентификации новых или обновленных строк.

>[!NOTE]
> Если в исходной базе данных есть столбец метки времени для идентификации новых или обновленных строк, но вы не хотите создавать таблицу внешнего управления для использования для копии дельты, можно использовать [инструмент копирования данных Azure Data Factory](copy-data-tool.md) для получения конвейера. Этот инструмент использует запланированное на триггер время в качестве переменной для чтения новых строк из исходной базы данных.

## <a name="about-this-solution-template"></a>Информация о шаблоне решения

Этот шаблон сначала извлекает старое значение водяного знака и сравнивает его с текущим значением водяного знака. После этого он копирует только изменения из исходной базы данных, основываясь на сравнении между двумя значениями водяного знака. Наконец, он хранит новое значение высокого водяного знака в таблице внешнего управления для загрузки данных дельты в следующий раз.

Шаблон состоит из четырех действий.
- **Поиск** получает старое значение высокого водяного знака, которое хранится во внешней таблице управления.
- Другая активность **Lookup** извлекает текущее значение высокого водяного знака из исходной базы данных.
- **Копирование** копий только изменяется из исходной базы данных в магазин назначения. Запрос, идентифицирующие изменения в исходной базе данных, аналогичен "SELECT - от Data_Source_Table где TIMESTAMP_Column > "последний высоководный знак" и TIMESTAMP_Column <" текущий высоководный знак".
- **SqlServerStoredProcedure** записывает текущее значение высокого водяного знака на таблицу внешнего управления для копации дельты в следующий раз.

Шаблон определяет следующие параметры:
- *Data_Source_Table_Name* — это таблица исходной базы данных, с ней нужно загрузить данные.
- *Data_Source_WaterMarkColumn* — это название столбца в исходной таблице, используемое для идентификации новых или обновленных строк. Тип этого столбца обычно *датируется,* *INT*или аналогичный.
- *Data_Destination_Container* является корневой траекторией места, куда копируется данные в магазине назначения.
- *Data_Destination_Directory* — это путь каталога под корнем места, куда копируется данные в магазине назначения.
- *Data_Destination_Table_Name* это место, где данные копируются в магазине назначения (применимо, когда "Azure Synapse Analytics (ранее S'L DW)" выбран в качестве пункта назначения данных).
- *Data_Destination_Folder_Path* это место, где данные копируется в магазине назначения (применимо, когда "File System" или "Azure Data Lake Storage Gen1" выбран в качестве пункта назначения данных).
- *Control_Table_Table_Name* является таблицей внешнего управления, которая хранит значение высокого водяного знака.
- *Control_Table_Column_Name* — это столбец во внешней таблице управления, в который хранится значение высокого водяного знака.

## <a name="how-to-use-this-solution-template"></a>Использование шаблона решения

1. Изучите исходную таблицу, которую вы хотите загрузить, и определите столбец высокого водяного знака, который может быть использован для идентификации новых или обновленных строк. Тип этого столбца может быть *датой,* *INT*, или аналогичный. Значение этого столбца увеличивается по мере добавления новых строк. Из следующей таблицы исходного кода образца (data_source_table) мы можем использовать столбец *LastModifytime* в качестве столбца высокого водяного знака.

    ```sql
            PersonID    Name    LastModifytime
            1   aaaa    2017-09-01 00:56:00.000
            2   bbbb    2017-09-02 05:23:00.000
            3   cccc    2017-09-03 02:36:00.000
            4   dddd    2017-09-04 03:21:00.000
            5   eeee    2017-09-05 08:06:00.000
            6   fffffff 2017-09-06 02:23:00.000
            7   gggg    2017-09-07 09:01:00.000
            8   hhhh    2017-09-08 09:01:00.000
            9   iiiiiiiii   2017-09-09 09:01:00.000
    ```
    
2. Создайте таблицу управления в базе данных S'L Server или Azure S'L для хранения высокой стоимости водяного знака для загрузки данных дельты. В следующем примере название таблицы управления является *водоразделом.* В этой таблице *WatermarkValue* представляет собой столбец, который хранит значение высокого водяного знака, а его тип — *время начала года.*

    ```sql
            create table watermarktable
            (
            WatermarkValue datetime,
            );
            INSERT INTO watermarktable
            VALUES ('1/1/2010 12:00:00 AM')
    ```
    
3. Создайте процедуру хранения в том же экземпляре базы данных S'L Или, который использовался для создания таблицы управления. Сохраненная процедура используется для записи нового значения высокого водяного знака на внешнюю таблицу управления для загрузки данных дельты в следующий раз.

    ```sql
            CREATE PROCEDURE update_watermark @LastModifiedtime datetime
            AS

            BEGIN

                UPDATE watermarktable
                SET [WatermarkValue] = @LastModifiedtime 

            END
    ```
    
4. Перейдите к **копии Delta из шаблона базы данных.** Создайте **новое** подключение к исходной базе данных, которую вы хотите скопировать с данных.

    ![Создание подключения к исходной таблице](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable4.png)

5. Создайте **новое** соединение с хранилищем данных назначения, в которое необходимо скопировать данные.

    ![Создание подключения к целевой таблице](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable5.png)

6. Создайте **новое** соединение с таблицей внешнего управления и сохраненной процедурой, созданной в шагах 2 и 3.

    ![Создание подключения к хранилищу данных контрольной таблицы](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable6.png)

7. Выберите **Использовать этот шаблон**.
    
8. Вы видите доступный конвейер, показанный в следующем примере:
  
    ![Проверка конвейера](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable8.png)

9. Выберите **Сохраненную процедуру**. Для **названия Сохраненной процедуры**выберите **«dbo». update_watermark.** Выберите **параметр импорта,** а затем выберите **Добавить динамическое содержимое.**  

    ![Установка действия процедуры хранения](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable9.png)  

10. Напишите содержимое ** \@«активность»('LookupCurrentWaterMark').output.firstRow.NewWatermarkValue»,** а затем выберите **Finish**.  

    ![Написать содержимое для параметров сохраненной процедуры](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable10.png)       
     
11. Выберите **отключать,** введите **параметры,** а затем выберите **Finish.**

    ![Выберите «Дебуг»](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable11.png)

12. Отображаются результаты, аналогичные следующему примеру:

    ![Просмотр результатов](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable12.png)

13. Вы можете создать новые строки в исходной таблице. Вот пример языка S-L для создания новых строк:

    ```sql
            INSERT INTO data_source_table
            VALUES (10, 'newdata','9/10/2017 2:23:00 AM')

            INSERT INTO data_source_table
            VALUES (11, 'newdata','9/11/2017 9:01:00 AM')
    ```

14. Чтобы запустить конвейер снова, выберите **Отек,** введите **параметры,** а затем выберите **Отделку.**

    Вы увидите, что только новые строки были скопированы к месту назначения.

15. (Необязательно:) При выборе Azure Synapse Analytics (ранее S'L DW) в качестве пункта назначения данных необходимо также предоставить подключение к хранению Azure Blob для постановки, что требуется полибазой хранилища данных. Шаблон будет генерировать контейнерный путь для вас. После запуска конвейера проверьте, был ли контейнер создан в хранилище Blob.
    
    ![Настройка PolyBase](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable15.png)
    
## <a name="next-steps"></a>Дальнейшие действия

- [Массовая копия из базы данных с помощью таблицы управления с Azure Data Factory](solution-template-bulk-copy-with-control-table.md)
- [Копирование файлов из нескольких контейнеров с помощью Фабрики данных Azure](solution-template-copy-files-multiple-containers.md)
