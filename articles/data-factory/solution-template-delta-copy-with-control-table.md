---
title: Разностного копирования из базы данных с помощью элемента управления таблицы с помощью фабрики данных Azure | Документация Майкрософт
description: Узнайте, как использовать шаблон решения для добавочного копирования только новых или обновленных строк из базы данных в Фабрике данных Azure.
services: data-factory
documentationcenter: ''
author: dearandyxu
ms.author: yexu
ms.reviewer: douglasl
manager: craigg
ms.service: data-factory
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 12/24/2018
ms.openlocfilehash: c32592ce539eeb2dec71792e4a6eb31e7d904eff
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "60312513"
---
# <a name="delta-copy-from-a-database-with-a-control-table"></a>Разностного копирования из базы данных с помощью элемента управления таблицы

В этой статье описывается шаблон, который доступен для добавочной загрузки новых или обновленных строк из таблицы базы данных в Azure с помощью внешнего элемента управления таблицы, в которой хранится значение верхнего предела.

Этот шаблон требует, что схема базы данных-источника содержит ключ столбца или увеличения отметки времени для определения новых или обновленных строк.

>[!NOTE]
> Если у вас есть столбец отметок времени в вашей базы данных-источника для определения новых или обновленных строк, но вы не хотите создать таблицу внешнего элемента управления для разностного копирования, вместо этого можно использовать [средства копирования данных фабрики данных Azure](copy-data-tool.md) на получение конвейера. Этот инструмент использует время запланированный триггер как переменную для считывания новых строк из базы данных-источника.

## <a name="about-this-solution-template"></a>Информация о шаблоне решения

Этот шаблон сначала получает старое значение предела и сравнивает его с текущим значением водяного знака. После этого он копирует только изменения из базы данных-источника, исходя из сравнения между двумя значениями пределов. Наконец он сохраняет новое значение верхнего предела в таблицу внешнего элемента управления для следующей загрузки разностных данных.

Шаблон состоит из четырех действий.
- **Поиск** получает старое значение верхнего предела, который хранится в таблице внешнего элемента управления.
- Другой **подстановки** действие получает текущее значение верхнего предела из базы данных-источника.
- **Копировать** копирует только изменения из базы данных-источника в целевое хранилище. Запрос, который обозначает изменения базы данных-источника аналогична "ВЫБЕРИТЕ * из Data_Source_Table ГДЕ TIMESTAMP_Column > «последнего верхнего предела» и TIMESTAMP_Column < = «текущего верхнего предела»".
- **SqlServerStoredProcedure** записывает текущее значение верхнего предела при очередном таблицу внешнего элемента управления для разностного копирования.

Шаблон определяет пять параметров.
- *Data_Source_Table_Name* таблица, в который требуется загрузить данные из базы данных-источника.
- *Data_Source_WaterMarkColumn* является именем столбца в исходной таблице, которая используется для обозначения новых или обновленных строк. Тип этого столбца — обычно *datetime*, *INT*, или аналогичные.
- *Data_Destination_Folder_Path* или *Data_Destination_Table_Name* — это место, где данные копируются в хранилище данных назначения.
- *Control_Table_Table_Name* таблица внешнего элемента управления, в которой хранится значение верхнего предела.
- *Control_Table_Column_Name* является столбцом в таблице внешнего элемента управления, которая хранит значение верхнего предела.

## <a name="how-to-use-this-solution-template"></a>Использование шаблона решения

1. Просмотр источника таблицы вы которого требуется загрузить и определить столбец верхнего предела, который может использоваться для идентификации новых или обновленных строк. Этот столбец может быть *datetime*, *INT*, или аналогичные. Значение этого столбца растет по мере добавления новых строк. Из следующих образца исходной таблицы (data_source_table), мы используем *LastModifytime* столбец как столбец верхнего предела.

    ```sql
            PersonID    Name    LastModifytime
            1   aaaa    2017-09-01 00:56:00.000
            2   bbbb    2017-09-02 05:23:00.000
            3   cccc    2017-09-03 02:36:00.000
            4   dddd    2017-09-04 03:21:00.000
            5   eeee    2017-09-05 08:06:00.000
            6   fffffff 2017-09-06 02:23:00.000
            7   gggg    2017-09-07 09:01:00.000
            8   hhhh    2017-09-08 09:01:00.000
            9   iiiiiiiii   2017-09-09 09:01:00.000
    ```
    
2. Создайте таблицу элемента управления в SQL Server или базы данных SQL Azure для хранения значения верхнего предела для загрузки разностных данных. В следующем примере в таблице управления называется *watermarktable*. В этой таблице *WatermarkValue* — столбец, который сохраняет значение верхнего предела, а его тип — *datetime*.

    ```sql
            create table watermarktable
            (
            WatermarkValue datetime,
            );
            INSERT INTO watermarktable
            VALUES ('1/1/2010 12:00:00 AM')
    ```
    
3. Создание хранимой процедуры в одном экземпляре SQL Server или базы данных SQL Azure, которая использовалась для создания элемента управления таблицы. Хранимая процедура используется для записи нового значения верхнего предела в таблицу внешнего элемента управления для следующей загрузки разностных данных.

    ```sql
            CREATE PROCEDURE update_watermark @LastModifiedtime datetime
            AS

            BEGIN

                UPDATE watermarktable
                SET [WatermarkValue] = @LastModifiedtime 

            END
    ```
    
4. Перейдите к **разностного копирования из базы данных** шаблона. Создание **New** соединение, для копирования данных из базы данных-источника.

    ![Создание подключения к исходной таблице](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable4.png)

5. Создание **New** соединение в целевое хранилище данных, который требуется скопировать данные.

    ![Создание подключения к целевой таблице](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable5.png)

6. Создание **New** соединение с внешнего элемента управления таблицы и хранимой процедуры, созданной при выполнении шагов 2 и 3.

    ![Создание подключения к хранилищу данных контрольной таблицы](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable6.png)

7. Выберите **этот шаблон используется**.

     ![Использовать этот шаблон](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable7.png)
    
8. Вы увидите доступные конвейера, как показано в следующем примере:

     ![Проверка конвейера](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable8.png)

9. Выберите **хранимой процедуры**. Для **имя хранимой процедуры**, выберите **[update_watermark]** . Выберите **параметра импорта**, а затем выберите **добавить динамическое содержимое**.  

     ![Задайте действие хранимой процедуры](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable9.png) 

10. Напишите содержимое,  **\@{activity('LookupCurrentWaterMark').output.firstRow.NewWatermarkValue}** , а затем выберите **Готово**.  

     ![Напишите содержимое, для параметров хранимой процедуры](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable10.png)      
     
11. Выберите **Отладка**, введите **параметры**, а затем выберите **Готово**.

    ![Выберите ** отладки **](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable11.png)

12. Отображаются результаты, как в следующем примере:

    ![Просмотр результатов](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable12.png)

13. Вы можете создать новые строки в исходной таблице. Ниже приведен пример языка SQL для создания новых строк.

    ```sql
            INSERT INTO data_source_table
            VALUES (10, 'newdata','9/10/2017 2:23:00 AM')

            INSERT INTO data_source_table
            VALUES (11, 'newdata','9/11/2017 9:01:00 AM')
    ```
14. Для повторного запуска конвейера, выберите **Отладка**, введите **параметры**, а затем выберите **Готово**.

    ![Выберите ** отладки **](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable11.png)

    Вы увидите, что только новые строки были скопированы в место назначения.

15. (Необязательно.) При выборе хранилища данных SQL в качестве назначения данных, необходимо также указать соединение со службой хранилища BLOB-объектов Azure для промежуточного хранения, который необходим Polybase хранилища данных SQL. Убедитесь, что контейнер уже был создан в хранилище BLOB-объектов.
    
    ![Настройка PolyBase](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable15.png)
    
## <a name="next-steps"></a>Дальнейшие действия

- [Массовое копирование из базы данных с помощью элемента управления таблицы с помощью фабрики данных Azure](solution-template-bulk-copy-with-control-table.md)
- [Копирование данных из нескольких контейнеров с помощью фабрики данных Azure](solution-template-copy-files-multiple-containers.md)
