---
title: Разностное копирование из базы данных с помощью управляющей таблицы
description: Узнайте, как использовать шаблон решения для добавочного копирования только новых или обновленных строк из базы данных в Фабрике данных Azure.
services: data-factory
documentationcenter: ''
author: dearandyxu
ms.author: yexu
ms.reviewer: douglasl
manager: craigg
ms.service: data-factory
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 12/24/2018
ms.openlocfilehash: 22723033b59fafc0b9dfd1ae4fc08e5f6e9145ed
ms.sourcegitcommit: 8bd85510aee664d40614655d0ff714f61e6cd328
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/06/2019
ms.locfileid: "74896219"
---
# <a name="delta-copy-from-a-database-with-a-control-table"></a>Разностное копирование из базы данных с помощью управляющей таблицы

В этой статье описывается шаблон, доступный для добавочной загрузки новых или обновленных строк из таблицы базы данных в Azure с помощью внешней таблицы управления, в которой хранится значение верхнего предела.

Для этого шаблона требуется, чтобы схема базы данных-источника содержала столбец timestamp или увеличивал ключ для обнаружения новых или обновленных строк.

>[!NOTE]
> Если в базе данных-источнике есть столбец timestamp для обнаружения новых или обновленных строк, но вы не хотите создавать внешнюю таблицу управления для разностного копирования, можно использовать [средство копирование данных фабрики данных Azure](copy-data-tool.md) для получения конвейера. Это средство использует время, запланированное триггером, в качестве переменной для чтения новых строк из базы данных-источника.

## <a name="about-this-solution-template"></a>Информация о шаблоне решения

Этот шаблон сначала извлекает старое значение предела и сравнивает его с текущим значением предела. После этого он копирует только изменения из базы данных-источника, основываясь на сравнении двух значений водяного знака. Наконец, он сохраняет новое значение высокой подложки во внешней таблице элементов управления для загрузки разностных данных в следующий раз.

Шаблон состоит из четырех действий.
- **Поиск** получает старое значение верхнего предела, которое хранится во внешней таблице элементов управления.
- Другое действие **поиска** извлекает текущее значение высокой подложки из базы данных-источника.
- **Копировать** копирует только изменения из базы данных источника в целевое хранилище. Запрос, определяющий изменения в базе данных-источнике, аналогичен "SELECT * FROM Data_Source_Table, где TIMESTAMP_Column >" последняя большая Подложка "и TIMESTAMP_Column < =" текущий верхний предел ".
- **SqlServerStoredProcedure** записывает текущее значение высокой подложки во внешнюю таблицу управления для разностного копирования в следующий раз.

Шаблон определяет пять параметров.
- *Data_Source_Table_Name* — это таблица в базе данных-источнике, из которой необходимо загрузить данные.
- *Data_Source_WaterMarkColumn* — имя столбца в исходной таблице, который используется для обнаружения новых или обновленных строк. Этот столбец обычно имеет тип *DateTime*, *int*или аналогичный.
- *Data_Destination_Folder_Path* или *Data_Destination_Table_Name* — место, куда копируются данные в целевом хранилище.
- *Control_Table_Table_Name* — это внешняя таблица элементов управления, в которой хранится значение верхнего предела.
- *Control_Table_Column_Name* — это столбец во внешней таблице элементов управления, в котором хранится значение верхнего предела.

## <a name="how-to-use-this-solution-template"></a>Использование шаблона решения

1. Изучите исходную таблицу, которую необходимо загрузить, и определите столбец верхнего предела, который можно использовать для определения новых или обновленных строк. Этот столбец может иметь тип *DateTime*, *int*или аналогичный. Значение этого столбца увеличивается по мере добавления новых строк. В следующем образце исходной таблицы (data_source_table) можно использовать столбец *LastModifytime* в качестве столбца верхнего предела.

    ```sql
            PersonID    Name    LastModifytime
            1   aaaa    2017-09-01 00:56:00.000
            2   bbbb    2017-09-02 05:23:00.000
            3   cccc    2017-09-03 02:36:00.000
            4   dddd    2017-09-04 03:21:00.000
            5   eeee    2017-09-05 08:06:00.000
            6   fffffff 2017-09-06 02:23:00.000
            7   gggg    2017-09-07 09:01:00.000
            8   hhhh    2017-09-08 09:01:00.000
            9   iiiiiiiii   2017-09-09 09:01:00.000
    ```
    
2. Создайте таблицу элементов управления в SQL Server или базе данных SQL Azure, чтобы сохранить значение верхнего предела для загрузки разностных данных. В следующем примере имя управляющей таблицы — *ватермарктабле*. В этой таблице *ватермарквалуе* — это столбец, в котором хранится значение верхнего предела, а его тип — *DateTime*.

    ```sql
            create table watermarktable
            (
            WatermarkValue datetime,
            );
            INSERT INTO watermarktable
            VALUES ('1/1/2010 12:00:00 AM')
    ```
    
3. Создайте хранимую процедуру на том же SQL Server или в экземпляре базы данных SQL Azure, который использовался для создания таблицы управления. Хранимая процедура используется для записи нового значения высокой подложки во внешнюю таблицу управления для загрузки разностных данных в следующий раз.

    ```sql
            CREATE PROCEDURE update_watermark @LastModifiedtime datetime
            AS

            BEGIN

                UPDATE watermarktable
                SET [WatermarkValue] = @LastModifiedtime 

            END
    ```
    
4. Перейдите к **разностной копии из шаблона базы данных** . Создайте **новое** соединение с базой данных-источником, из которой требуется копировать данные.

    ![Создание подключения к исходной таблице](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable4.png)

5. Создайте **новое** соединение с целевым хранилищем данных, в которое необходимо скопировать данные.

    ![Создание подключения к целевой таблице](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable5.png)

6. Создайте **новое** соединение с таблицей внешнего элемента управления и хранимой процедурой, созданной на шаге 2 и 3.

    ![Создание подключения к хранилищу данных контрольной таблицы](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable6.png)

7. Выберите **Использовать этот шаблон**.

     ![Использование шаблона](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable7.png)
    
8. Вы увидите доступный конвейер, как показано в следующем примере:

     ![Проверка конвейера](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable8.png)

9. Выберите **хранимая процедура**. В качестве **имени хранимой процедуры**выберите **[update_watermark]** . Выберите **параметр импорта**, а затем выберите **добавить динамическое содержимое**.  

     ![Задание действия хранимой процедуры](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable9.png) 

10. Запишите содержимое **\@{Activity (' лукупкуррентватермарк '). Output. firstRow. невватермарквалуе}** и нажмите кнопку **Готово**.  

     ![Запись содержимого для параметров хранимой процедуры](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable10.png)      
     
11. Выберите **Отладка**, введите **Параметры**и нажмите кнопку **Готово**.

    ![Выберите * * Отладка * *](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable11.png)

12. Отобразятся результаты, аналогичные приведенным в следующем примере:

    ![Просмотр результатов](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable12.png)

13. Вы можете создать новые строки в исходной таблице. Ниже приведен пример языка SQL для создания новых строк:

    ```sql
            INSERT INTO data_source_table
            VALUES (10, 'newdata','9/10/2017 2:23:00 AM')

            INSERT INTO data_source_table
            VALUES (11, 'newdata','9/11/2017 9:01:00 AM')
    ```
14. Чтобы снова запустить конвейер, выберите **Отладка**, введите **Параметры**и нажмите кнопку **Готово**.

    ![Выберите * * Отладка * *](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable11.png)

    Вы увидите, что в назначение были скопированы только новые строки.

15. Используемых Если в качестве назначения данных выбрано хранилище данных SQL, необходимо также предоставить подключение к хранилищу BLOB-объектов Azure для промежуточного хранения, которое требуется для polybase хранилища данных SQL. Убедитесь, что контейнер уже создан в хранилище BLOB-объектов.
    
    ![Настройка PolyBase](media/solution-template-delta-copy-with-control-table/DeltaCopyfromDB_with_ControlTable15.png)
    
## <a name="next-steps"></a>Дальнейшие действия

- [Полное копирование из базы данных с помощью таблицы элементов управления и фабрики данных Azure](solution-template-bulk-copy-with-control-table.md)
- [Копирование файлов из нескольких контейнеров с помощью фабрики данных Azure](solution-template-copy-files-multiple-containers.md)
