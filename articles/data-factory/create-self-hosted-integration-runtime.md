---
title: Создание локальной среды выполнения интеграции
description: Узнайте, как создать самохлаженное время выполнения интеграции в Azure Data Factory, которое позволяет фабрикам данных получать доступ к хранилищам данных в частной сети.
services: data-factory
documentationcenter: ''
ms.service: data-factory
ms.workload: data-services
ms.topic: conceptual
author: nabhishek
ms.author: abnarain
manager: anandsub
ms.custom: seo-lt-2019
ms.date: 03/10/2020
ms.openlocfilehash: 6302a7d6ffe7218d339121ec98a624f8e98356f6
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80065596"
---
# <a name="create-and-configure-a-self-hosted-integration-runtime"></a>Создание и настройка локальной среды выполнения интеграции

Среда выполнения интеграции (IR) — это инфраструктура вычислений, которую Фабрика данных Azure использует для обеспечения интеграции данных в разных сетевых средах. Для получения подробной информации об ИК, см [Интеграция запуска обзор](concepts-integration-runtime.md).

Самохлажен интеграции запуска может запускать действия копирования между облачным хранилищем данных и хранилищем данных в частной сети. Он также может отправлять действия преобразования против вычислительных ресурсов в предприимчивой сети или виртуальной сети Azure. Установка автономной интеграции runtime нуждается в собственной машине или виртуальной машине внутри частной сети.  

В этой статье описывается, как можно создать и настроить самостоятельно размещенный ИК.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="setting-up-a-self-hosted-integration-runtime"></a>Настройка автономного времени выполнения интеграции

Для создания и настройки автономной интеграции времени выполнения, используйте следующие процедуры.

### <a name="create-a-self-hosted-ir-via-azure-powershell"></a>Создание самостоятельной ИК через Azure PowerShell

1. Для этой задачи можно использовать Azure PowerShell. Например:

    ```powershell
    Set-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $resourceGroupName -DataFactoryName $dataFactoryName -Name $selfHostedIntegrationRuntimeName -Type SelfHosted -Description "selfhosted IR description"
    ```
  
2. [Скачайте](https://www.microsoft.com/download/details.aspx?id=39717) и установите на локальном компьютере локальную среду выполнения интеграции.

3. Получите ключ проверки подлинности и зарегистрируйте локальную среду выполнения интеграции с помощью этого ключа. Ниже приведен пример скрипта PowerShell.

    ```powershell

    Get-AzDataFactoryV2IntegrationRuntimeKey -ResourceGroupName $resourceGroupName -DataFactoryName $dataFactoryName -Name $selfHostedIntegrationRuntimeName  

    ```

### <a name="create-a-self-hosted-ir-via-azure-data-factory-ui"></a>Создание автономной ИК через uI-иу-изюма Фабрики данных Azure

Используйте следующие шаги для создания самостоятельного ИК-системы с помощью uI-има Azure Data Factory.

1. На странице **Let's Get started** of Azure Data Factory UI выберите вкладку **Автора** на левом панели.

   ![Кнопка "Автор домашней страницы"](media/doc-common-process/get-started-page-author-button.png)

1. Выберите **соединения** в нижней части левого стекла и выберите **время выполнения интеграции** в окне **соединения.** Выберите **новый .**

   ![Создание среды выполнения интеграции](media/create-self-hosted-integration-runtime/new-integration-runtime.png)

1. На окне **настройки времени выполнения интеграции** выберите **Выполнение движения данных и действия отправки на внешние вычисления**и выберите **Продолжить**.

1. Введите имя для ИК и выберите **Создать.**

1. Выберите ссылку в соответствии с **вариантом 1,** чтобы открыть экспресс-установку на вашем компьютере. Или выполните шаги в соответствии с **вариантом 2,** чтобы настроить вручную. Следующие инструкции основаны на ручной настройке:

   ![Настройка среды выполнения интеграции](media/create-self-hosted-integration-runtime/integration-runtime-setting-up.png)

    1. Копировать и вставить ключ проверки подлинности. Выберите **Скачать и установить время выполнения интеграции**.

    1. Скачайте локальную среду выполнения интеграции на локальный компьютер под управлением Windows. Запустите установщик.

    1. На странице **Регистрационная интеграция Runtime (самостоятельнох)** страницы вставьте сохраненный ранее ключ и выберите **Регистр.**
    
       ![Регистрация среды выполнения интеграции](media/create-self-hosted-integration-runtime/register-integration-runtime.png)

    1. На странице **Новый узел среды выполнения интеграции (с локальным размещением)** нажмите кнопку **Finish** (Завершить)

1. После успешной регистрации автономного времени выполнения интеграции вы видите следующее окно:

    ![Успешная регистрация](media/create-self-hosted-integration-runtime/registered-successfully.png)

### <a name="set-up-a-self-hosted-ir-on-an-azure-vm-via-an-azure-resource-manager-template"></a>Настройка автономной ИК на VM Azure с помощью шаблона управления ресурсами Azure

Вы можете автоматизировать самостоятельно размещенную ИК-установку на виртуальной машине Azure с помощью [ИК-шаблона Create self host.](https://github.com/Azure/azure-quickstart-templates/tree/master/101-vms-with-selfhost-integration-runtime) Шаблон обеспечивает простой способ иметь полностью функциональный автономный ИК внутри виртуальной сети Azure. ИК имеет функции высокой доступности и масштабируемости, если установить количество узлов до 2 или выше.

### <a name="set-up-an-existing-self-hosted-ir-via-local-powershell"></a>Настройка существующего автономного ИК через локальную PowerShell

Вы можете использовать командную строку для настройки или управления существующим ик-хозяйничаемым ИК. Это использование может особенно помочь автоматизировать установку и регистрацию самоуправляемых ИК-узлов.

Dmgcmd.exe включен в самохаулястанец. Обычно он находится в папке C: «Файлы программы»-«Microsoft Интеграция Runtime» (Microsoft Integration Runtime) 3.0. Это приложение поддерживает различные параметры и может вызываться с помощью командной строки с помощью пакетных скриптов для автоматизации.

Используйте приложение следующим образом:

```powershell
dmgcmd [ -RegisterNewNode "<AuthenticationKey>" -EnableRemoteAccess "<port>" ["<thumbprint>"] -EnableRemoteAccessInContainer "<port>" ["<thumbprint>"] -DisableRemoteAccess -Key "<AuthenticationKey>" -GenerateBackupFile "<filePath>" "<password>" -ImportBackupFile "<filePath>" "<password>" -Restart -Start -Stop -StartUpgradeService -StopUpgradeService -TurnOnAutoUpdate -TurnOffAutoUpdate -SwitchServiceAccount "<domain\user>" ["<password>"] -Loglevel <logLevel> ]
```

Ниже приведены подробные сведения о параметрах и свойствах приложения: 

| Свойство                                                    | Описание                                                  | Обязательно |
| ----------------------------------------------------------- | ------------------------------------------------------------ | -------- |
| **РегистрацияNewNode** "`<AuthenticationKey>`"                     | Зарегистрируйте самоходное узлы времени выполнения интеграции с указанным ключом проверки подлинности. | нет       |
| **РегистрацияNewNode** "`<AuthenticationKey>`" "`<NodeName>`"      | Зарегистрируйте самоходное узлы времени выполнения интеграции с указанным ключом проверки подлинности и именем узла. | нет       |
| **EnableRemoteAccess** "`<port>`" ["`<thumbprint>`"]            | Включить удаленный доступ на текущем узлах для настройки кластера с высокой доступностью. Или позволяет устанавливать учетные данные непосредственно против самостоятельно йохасу, не проходя через Фабрику данных Azure. Вы делаете последнее с помощью **New-AzDataFactoryV2LinkedServiceEncryptedCredentialcmcredential** cmdlet от удаленного аппарата в той же сети. | нет       |
| **Включить удаленныйдоступинконтейнер** "`<port>`" ["`<thumbprint>`"] | Включить удаленный доступ к текущему узлам при запуске узла в контейнере. | нет       |
| **Отключитьудаленныйдоступ**                                         | Отвадить удаленный доступ к текущему узлам. Для установки мультиузловой настройки необходим удаленный доступ. **Новый AzDataFactoryV2LinkedServiceEncryptedCredential** PowerShell cmdlet по-прежнему работает даже при отключении удаленного доступа. Такое поведение верно до тех пор, пока cmdlet выполняется на той же машине, что и самоуправляемый ИК-узла. | нет       |
| **Ключевое значение** "`<AuthenticationKey>`"                                 | Перезапись или обновление предыдущего ключа проверки подлинности. Будьте осторожны с этим действием. Ваш предыдущий самоуправляемый ИК-узла может перейти в автономный режим, если ключ имеет новое время выполнения интеграции. | нет       |
| **GenerateBackupFile** "`<filePath>`" "`<password>`"            | Создание резервного файла для текущего узла. Файл резервного копирования включает ключ узла и учетные данные хранилища данных. | нет       |
| **ImportBackupFile** "`<filePath>`" "`<password>`"              | Восстановление узла из файла резервного копирования.                          | нет       |
| **"Перезапуск"**                                                     | Перезапустите самохлаженную службу запуска.   | нет       |
| **Начало**                                                       | Запустите самохозня интеграционную службу запуска.     | нет       |
| **Остановить**                                                        | Остановите самохлаженную службу запуска.        | нет       |
| **StartUpgradeService**                                         | Запустите самохозня интеграции службы обновления времени выполнения.       | нет       |
| **СтопАпвапСервис**                                          | Остановите самохлаженную службу обновления времени выполнения.        | нет       |
| **TurnonAutoUpdate**                                            | Включите самохлажентную интеграцию автоматического обновления.        | нет       |
| **ВыключениеАвтоupdate**                                           | Выключите самохпарнюстом автоматическое обновление времени выполнения интеграции.       | нет       |
| **SwitchServiceAccount** "`<domain\user>`" ["`<password>`"]           | Установите DIAHostService для запуска в качестве новой учетной записи. Используйте пустой пароль "" для системных учетных записей и виртуальных учетных записей. | нет       |


## <a name="command-flow-and-data-flow"></a>Поток команд и поток данных

При перемещении данных между помещениями и облаком в действии используется автономное время выполнения интеграции для передачи данных между исходным источником данных и облаком.

Вот краткое изложение шагов по обработке потоков данных для копирования с помощью самостоятельно гостовых ИК:

![Обзор потока данных на высоком уровне](media/create-self-hosted-integration-runtime/high-level-overview.png)

1. Разработчик данных создает самохлаженное время выполнения интеграции в рамках фабрики данных Azure с помощью cmdlet PowerShell. В настоящее время портал Azure не поддерживает эту функцию.
1. Разработчик данных создает связанную службу для хранения данных. Разработчик делает это, указывая самоходном экземпляре времени выполнения интеграции, который служба должна использовать для подключения к хранилищам данных.
1. Узел локальной среды выполнения интеграции шифрует учетные данные с помощью программного интерфейса защиты данных (API защиты данных) и сохраняет учетные данные локально. Если вы настроили несколько узлов для обеспечения высокой доступности, учетные данные дополнительно синхронизируются между этими узлами. Каждый узел шифрует учетные данные с помощью API защиты данных и сохраняет их локально. Синхронизация учетных данных выполняется локальной средой выполнения интеграции, и разработчик данных может отслеживать этот процесс.
1. Фабрика данных Azure общается с автономным временем выполнения интеграции для планирования и управления заданиями. Связь происходит через канал управления, который использует общее соединение [Azure Service Bus Relay.](https://docs.microsoft.com/azure/service-bus-relay/relay-what-is-it#wcf-relay) Когда необходимо выполнить задание действия, Data Factory выстраивает запрос в очередь вместе с любой информацией о учетных данных. Это происходит в случае, если учетные данные уже не хранятся на автономном времени выполнения интеграции. Самохлажен интеграции время выполнения начинает работу после опроса очереди.
1. Самохлажен интеграции время выполнения копирует данные между припредствием магазина и облачным хранилищем. Направление копии зависит от того, как настроено действие копирования в конвейере данных. Для этого шага самоходной интеграции времени выполнения непосредственно общается с облачными службами хранения, такими как Хранилище Azure Blob через безопасный канал HTTPS.

## <a name="considerations-for-using-a-self-hosted-ir"></a>Рекомендации по использованию локальной среды выполнения интеграции

- Можно использовать одно автономное время выполнения интеграции для нескольких собственных источников данных. Вы также можете поделиться им с другой фабрикой данных в рамках того же арендатора Azure Active Directory (Azure AD). Дополнительные сведения см. в разделе о [совместном использовании локальной среды выполнения интеграции](#create-a-shared-self-hosted-integration-runtime-in-azure-data-factory).
- Можно установить только один экземпляр автономной интеграции на любой отдельной машине. Если у вас есть две фабрики данных, которым необходимо получить доступ к автономным источникам данных, либо используйте [самостоятельно размещенную функцию обмена ИК](#create-a-shared-self-hosted-integration-runtime-in-azure-data-factory) для обмена самостоятельной ИК, либо установите самостоятельно размещенный ИК на двух закрытых компьютерах, по одному для каждой фабрики данных.  
- Самоходной интеграции время выполнения не должно быть на той же машине, как источник данных. Однако самохлажентное время выполнения интеграции близко к источнику данных сокращает время автономного выполнения интеграции для подключения к источнику данных. Мы рекомендуем установить автономное время выполнения интеграции на машину, которая отличается от той, которая размещает в нем исходный источник данных. Когда самоходного времени выполнения интеграции и источника данных находятся на разных машинах, самоходного времени интеграции не конкурируют с источником данных для ресурсов.
- Вы можете установить несколько локальных сред выполнения интеграции на разных компьютерах и подключить их к одному локальному источнику данных. Например, если у вас есть два автономных времени интеграции, которые обслуживают две фабрики данных, один и тот же исходный источник данных может быть зарегистрирован на обеих фабриках данных.
- Если на компьютере уже установлен шлюз для обслуживания сценария Power BI, установите на другой машине отдельное автономное время выполнения интеграции для Data Factory.
- Используйте автономное время выполнения интеграции для поддержки интеграции данных в виртуальной сети Azure.
- Источник данных следует считать локальным и находящимся за брандмауэром, даже если используется Azure ExpressRoute. Используйте автономное время выполнения интеграции для подключения службы к источнику данных.
- Используйте автономное время выполнения интеграции, даже если хранилище данных находится в облаке на базе инфраструктуры Azure в качестве виртуальной машины службы (IaaS).
- Задачи могут выполнить неудачу при самостоятельной интеграции, установленной на сервере Windows, для которого включено шифрование, соответствующее ТРЕБОВАНИЯМ FIPS. Чтобы устранить эту проблему, отключите на сервере шифрование, совместимое с FIPS. Чтобы отключить шифрование, соответствующее требованиям FIPS, измените значение подключаемых ключей `HKLM\System\CurrentControlSet\Control\Lsa\FIPSAlgorithmPolicy\Enabled`реестра с 1 (включено) на 0 (отключено): .

## <a name="prerequisites"></a>Предварительные требования

- Поддерживаемые версии Windows:
  + Windows 7 с пакетом обновления 1
  + Windows 8.1
  + Windows 10
  + Windows Server 2008 R2 с пакетом обновления 1 (SP1)
  + Windows Server 2012
  + Windows Server 2012 R2
  + Windows Server 2016
  + Windows Server 2019
   
   Установка автономной интеграции времени выполнения на контроллер домена не поддерживается.
- Требуется .NET Framework 4.6.1 или более поздней версии. Если локальная среда выполнения интеграции устанавливается на компьютер под управлением Windows 7, установите .NET Framework 4.6.1 или более поздней версии. Дополнительные сведения см. в разделе [Требования к системе для .NET Framework](/dotnet/framework/get-started/system-requirements).
- Рекомендуемая минимальная конфигурация для самохпарнюшированной интеграционной машины - это 2-ГГц процессор с 4 ядрами, 8 ГБ оперативной памяти и 80 ГБ доступного пространства на жестком диске.
- Если машина-хоста вспыхивет, самохлажен т.д. не отвечает на запросы данных. Перед установкой локальной среды выполнения интеграции на компьютере следует настроить соответствующую схему управления питанием. Если машина настроена в спящий режим, самоходном установщике интеграции подсказывает подсказки с сообщением.
- Вы должны быть администратором на машине, чтобы успешно установить и настроить автономное время выполнения интеграции.
- Запуски копирования-активности происходят с определенной частотой. Использование процессора и оперативной памяти на машине следует той же схеме с пиковым и простоем времени. Использование ресурсов также в значительной степени зависит от объема данных, которые перемещались. Когда выполняется несколько заданий копирования, в пиковые периоды уровень использования ресурсов системы повышается.
- Задачи могут выполнить сярприза при извлечении данных в форматах Parquet, ORC или Avro. Подробнее о паркете читайте [в формате Parquet в Azure Data Factory.](https://docs.microsoft.com/azure/data-factory/format-parquet#using-self-hosted-integration-runtime) Создание файлов выполняется на самостоятельно размещенной интеграционной машине. Для работы, как и ожидалось, создание файла требует следующих предпосылок:
    - [Визуальный C ' 2010 Redistributable](https://download.microsoft.com/download/3/2/2/3224B87F-CFA0-4E70-BDA3-3DE650EFEBA5/vcredist_x64.exe) Пакет (x64)
    - Java Runtime (JRE) версия 8 от поставщика JRE, таких как [Adopt OpenJDK](https://adoptopenjdk.net/). Убедитесь, `JAVA_HOME` что переменная среды установлена.

## <a name="installation-best-practices"></a>Рекомендации по установке

Вы можете установить самохозняемый время выполнения интеграции, загрузив пакет настройки управляемой идентичности из [Microsoft Download Center.](https://www.microsoft.com/download/details.aspx?id=39717) Смотрите статью [Перемещение данных между на месте и облако](tutorial-hybrid-copy-powershell.md) для пошаговых инструкций.

- Назначайте план питания на хост-машине для автономной интеграции времени выполнения так, чтобы машина не вспыхивали. Если хост-компьютер перейдет в режим гибернации, локальная среда выполнения интеграции будет отключена.
- Регулярнорезервное копирование учетных данных, связанных с автономным временем выполнения интеграции.
- Для автоматизации самостоятельной операции установки ИК, пожалуйста, обратитесь к [Настройка существующих самостоятельнох размещение ИК через PowerShell](#setting-up-a-self-hosted-integration-runtime).  

## <a name="install-and-register-a-self-hosted-ir-from-microsoft-download-center"></a>Установка и регистрация самостоятельного ИК-центра Microsoft Download Center

1. Перейдите на [страницу загрузки среды выполнения интеграции Майкрософт](https://www.microsoft.com/download/details.aspx?id=39717).
1. Выберите **Скачать,** выберите 64-битную версию и выберите **Следующую.** 32-битная версия не поддерживается.
1. Выполнить файл Управляемой идентификации напрямую, или сохранить его на жестком диске и запустить его.
1. На окне **Добро пожаловать** выберите язык и выберите **Следующий**.
1. Примите условия лицензионного соглашения об использовании программного обеспечения Майкрософт и выберите **Далее**.
1. Выберите **папку** для установки локальной среды выполнения интеграции и нажмите кнопку **Далее**.
1. На **странице Ready to install** выберите **Install**.
1. Выберите **завершение** для завершения установки.
1. Получите ключ проверки подлинности с помощью PowerShell. Ниже представлен код PowerShell для получения ключа проверки подлинности.

    ```powershell
    Get-AzDataFactoryV2IntegrationRuntimeKey -ResourceGroupName $resourceGroupName -DataFactoryName $dataFactoryName -Name $selfHostedIntegrationRuntime
    ```

1. В окне **регистрации интеграции Runtime (самостоятельнох)** окна Microsoft Integration Runtime Configuration Manager, работая на вашей машине, выполняйте следующие шаги:

    1. Вставьте в текстовое поле ключ проверки подлинности.

    1. Чтобы просмотреть текст ключа, щелкните **Show authentication key** (Показать ключ проверки подлинности).

    1. Выберите **Зарегистрировать**.

## <a name="high-availability-and-scalability"></a>Высокий уровень доступности и масштабируемость

Вы можете связать самоходной интеграции времени выполнения с несколькими предприимченными машинами или виртуальными машинами в Azure. Такие компьютеры называются узлами. Для локальной среды выполнения интеграции можно использовать до четырех узлов. Преимущества наличия нескольких узлов на наемных машинах, которые имеют шлюз установлен для логического шлюза являются:

* Более высокая доступность автономной интеграции, так что это больше не единая точка сбоя в решении больших данных или облачной интеграции данных с Data Factory. Эта доступность помогает обеспечить непрерывность при использовании до четырех узлов.
* Повышение производительности и пропускной способности при перемещении данных между локальными и облачными хранилищами данных. Узнайте больше о [сравнении производительности](copy-activity-performance.md).

Вы можете связать несколько узлов, установив саморазмещенное программное обеспечение для запуска интеграции из [Скачать Центр.](https://www.microsoft.com/download/details.aspx?id=39717) Затем зарегистрируйте его, используя любой из ключей аутентификации, которые были получены от **New-AzDataFactoryV2IntegrationRuntimeKey** cmdlet, как описано в [учебнике](tutorial-hybrid-copy-powershell.md).

> [!NOTE]
> Вам не нужно создавать новое автономное время выполнения интеграции, чтобы связать каждый узлы. Вы можете установить эту среду на другом компьютере и зарегистрировать ее, используя тот же ключ проверки подлинности.

> [!NOTE]
> Прежде чем добавить еще один узло высокой доступности и масштабируемости, убедитесь, что удаленный доступ к опции **intranet** включен на первом узло. Для этого выберите**настройки настройки** > **Remote access to intranet** > настройки настройки **настройки microsoft Integration Runtime**

### <a name="scale-considerations"></a>Рекомендации по масштабированию

#### <a name="scale-out"></a>Масштабирование

Когда использование процессора является высоким, а доступная память на самостоятельно модно-хозяйничаемых ИК, добавьте новый узла, чтобы помочь масштабировать нагрузку на разных машинах. Если действия не выполняются из-за тайм-аута или самостоятельно размещенный ИК-узла находится в автономном режиме, это поможет, если вы добавите узла к шлюзу.

#### <a name="scale-up"></a>Увеличение масштаба

Когда процессор и доступная оперативная память не используются хорошо, но выполнение одновременных заданий достигает пределов узла, масштабирование за счет увеличения числа одновременных заданий, которые может запускать узла. Вы также можете увеличить масштаб, когда действия тайм-аут, потому что самостоятельно размещенные ИК перегружены. Как показано на следующем рисунке, можно увеличить максимальную емкость для узла:  

![Увеличьте количество одновременных заданий, которые могут работать на узлах](media/create-self-hosted-integration-runtime/scale-up-self-hosted-IR.png)

### <a name="tlsssl-certificate-requirements"></a>Требования к TLS- и SSL-сертификатам

Ниже приведены требования к сертификату TLS/SSL, который используется для обеспечения связи между узлами времени выполнения интеграции:

- Сертификат должен быть общедоступным доверенным сертификатом X509 v3. Мы рекомендуем вам использовать сертификаты, выданные государственным органом по сертификации партнеров (CA).
- Все узлы среды выполнения интеграции должны доверять этому сертификату.
- Мы не рекомендуем сертификаты «Альтернативное имя субъекта» (SAN), поскольку используется только последний элемент SAN. Все остальные элементы SAN игнорируются. Например, если у вас есть сертификат SAN, SANs которого **node1.domain.contoso.com** и **node2.domain.contoso.com,** вы можете использовать этот сертификат только на машине, чье полностью квалифицированное доменное имя (F'DN) **node2.domain.contoso.com.**
- Сертификат может использовать любой размер ключа, поддерживаемый Windows Server 2012 R2 для tLS/SSL-сертификатов.
- Сертификаты, в которых используются клавиши CNG, не поддерживаются.  

> [!NOTE]
> Этот сертификат используется:
>
> - Шифрование портов на самостоятельно размещенном ИК-узлах.
> - Для связи узла к узлам для синхронизации состояния, которая включает синхронизацию учетных данных связанных служб в узлах.
> - Когда cmdlet PowerShell используется для настройки учетных данных подключенных служб из локальной сети.
>
> Мы предлагаем вам использовать этот сертификат, если ваша частная сетевая среда не является безопасной или если вы хотите обеспечить связь между узлами в вашей частной сети.
>
> Перемещение данных транзитом из самостоятельно размещенного ИК-хранилища всегда происходит в зашифрованном канале, независимо от того, установлен этот сертификат или нет.

## <a name="create-a-shared-self-hosted-integration-runtime-in-azure-data-factory"></a>Создание общего автономного времени выполнения интеграции на фабрике данных Azure

Вы можете повторно использовать существующую инфраструктуру локальной среды IR, которую вы уже настроили в фабрике данных. Это повторное использование позволяет создавать связанное саморазмещенное время интеграции на другой фабрике данных, ссылаясь на существующую общую иС-усевую.

Чтобы увидеть введение и демонстрацию этой функции, посмотрите следующее 12-минутное видео:

> [!VIDEO https://channel9.msdn.com/Shows/Azure-Friday/Hybrid-data-movement-across-multiple-Azure-Data-Factories/player]

### <a name="terminology"></a>Терминология

- **Общий ИК**: Оригинальный самоуправляемый ИК, который работает на физической инфраструктуре.  
- **Связанные ИК**: ИК, который ссылается на другой общий ИК. Связанный ИК является логическим ИК и использует инфраструктуру другого общего самостоятельного ИК.

### <a name="methods-to-share-a-self-hosted-integration-runtime"></a>Методы совместного совместного выполнения интеграции

Чтобы поделиться автономным временем выполнения интеграции [Create a shared self-hosted integration runtime](create-shared-self-hosted-integration-runtime-powershell.md) с несколькими фабриками данных, см.

### <a name="monitoring"></a>Наблюдение

#### <a name="shared-ir"></a>Общий ИК

![Выборы для поиска общего времени выполнения интеграции](media/create-self-hosted-integration-runtime/Contoso-shared-IR.png)

![Мониторинг общего времени выполнения интеграции](media/create-self-hosted-integration-runtime/contoso-shared-ir-monitoring.png)

#### <a name="linked-ir"></a>Связанные ИК

![Выбор, чтобы найти связанное время выполнения интеграции](media/create-self-hosted-integration-runtime/Contoso-linked-ir.png)

![Мониторинг связанного времени выполнения интеграции](media/create-self-hosted-integration-runtime/Contoso-linked-ir-monitoring.png)

### <a name="known-limitations-of-self-hosted-ir-sharing"></a>Известные ограничения общего доступа к локальной среде IR

* Фабрика данных, на которой создается связанный ИК, должна иметь [управляемую идентификацию.](https://docs.microsoft.com/azure/active-directory/managed-service-identity/overview) По умолчанию фабрики данных, созданные на портале Azure или cmdlets PowerShell, имеют неявно созданную Управляемую идентификацию. Но когда фабрика данных создается с помощью шаблона Azure Resource Manager или SDK, необходимо четко установить свойство **identity.** Эта настройка гарантирует, что диспетчер ресурсов создает фабрику данных, содержащую управляемую идентификацию.

* Фабрика данных .NET SDK, которая поддерживает эту функцию, должна быть версией 1.1.0 или позже.

* Чтобы предоставить разрешение, вам нужна роль владельца или унаследованная роль Владельца на фабрике данных, где существует общий ИК.

* Функция обмена работает только для фабрик данных в рамках того же арендатора Azure AD.

* Для [гостевых пользователей](https://docs.microsoft.com/azure/active-directory/governance/manage-guest-access-with-access-reviews)Azure AD функция поиска в пользовательской системе, в которой перечислены все фабрики данных с помощью ключевого слова поиска, [не работает.](https://msdn.microsoft.com/library/azure/ad/graph/howto/azure-ad-graph-api-permission-scopes#SearchLimits) Но до тех пор, пока гость является владельцем фабрики данных, вы можете поделиться ИК без функциональности поиска. Для управляемой идентификации фабрики данных, которая должна поделиться ИК, введите эту управляемую идентификацию в поле **разрешения на присвоение** данных и выберите **Добавить** в uI Data Factory.

  > [!NOTE]
  > Эта функция доступна только в Data Factory V2.

## <a name="notification-area-icons-and-notifications"></a>Значки и уведомления в области уведомлений

Если вы перемещаете курсор по значку или сообщению в области уведомлений, вы можете увидеть подробную информацию о состоянии автономного времени выполнения интеграции.

![Уведомления в области уведомлений](media/create-self-hosted-integration-runtime/system-tray-notifications.png)

## <a name="ports-and-firewalls"></a>Порты и брандмауэры

Есть два брандмауэра для рассмотрения:

- *Корпоративный брандмауэр,* который работает на центральном маршрутизаторе организации
- *Брандмауэр Windows,* настроенный как daemon на локальной машине, где установлено самохлаженное время выполнения интеграции

![Брандмауэры](media/create-self-hosted-integration-runtime/firewall.png)

На уровне корпоративного брандмауэра необходимо настроить следующие домены и исходящие порты.

[!INCLUDE [domain-and-outbound-port-requirements](../../includes/domain-and-outbound-port-requirements.md)]

На уровне брандмауэра Windows или на уровне машины эти исходящие порты обычно включены. Если это не так, можно настроить домены и порты на самостоятельно размещенную интеграционную машину runtime.

> [!NOTE]
> Основываясь на источнике и раковинах, может потребоваться разрешить дополнительные домены и исходящие порты в корпоративном брандмауэре или брандмауэре Windows.
>
> Для некоторых облачных баз данных, таких как база данных Azure S'L и Azure Data Lake, возможно, потребуется разрешить IP-адреса самоходноразуходных машин для запуска в конфигурации брандмауэра.

### <a name="copy-data-from-a-source-to-a-sink"></a>Копирование данных из источника в приемник

Убедитесь, что вы правильно включить правила брандмауэра на корпоративном брандмауэре, брандмауэр Windows самохапленной интеграции запуска машины, и сам магазин данных. Включение этих правил позволяет самоуправляемому времени выполнения интеграции успешно подключаться как к источнику, так и к раковине. Активируйте правила для каждого хранилища данных, задействованного в операции копирования.

Например, для копирования из хранилища данных в хранилище данных в sink s-L database или на хранилище данных Azure S'L, выполняйте следующие шаги:

1. Разрешить исходящие связи TCP на порт 1433 для брандмауэра Windows и корпоративного брандмауэра.
1. Настройте настройки брандмауэра базы данных S'L, чтобы добавить IP-адрес самохауляторной интеграционной машины для выполнения в список разрешенных IP-адресов.

> [!NOTE]
> Если брандмауэр не позволяет выходить из порта 1433, самохозня не может получить доступ к базе данных S'L напрямую. В этом случае можно использовать [поэтапную копию](copy-activity-performance.md) в базе данных S'L и Хранилище данных S'L. В этом сценарии для движения данных требуется только HTTPS (порт 443).

## <a name="proxy-server-considerations"></a>Рекомендации для прокси-сервера

Если для доступа в Интернет в вашей корпоративной среде используется прокси-сервер, настройте параметры этого прокси-сервера в локальной среде выполнения интеграции. Прокси-сервер можно настроить на этапе начальной регистрации.

![Указать прокси](media/create-self-hosted-integration-runtime/specify-proxy.png)

При настройке автономное время выполнения интеграции использует прокси-сервер для подключения к источнику и месту назначения облачной службы (который использует протокол HTTP или HTTPS). Вот почему вы выбираете **ссылку Change** во время первоначальной настройки.

![Установка прокси](media/create-self-hosted-integration-runtime/set-http-proxy.png)

Доступны три варианта конфигурации.

- **Не используйте прокси:** Автономное время выполнения интеграции явно не использует прокси для подключения к облачным службам.
- **Используйте систему прокси**: Самохлаженный запуск интеграции использует настройку прокси, настроенную на diahost.exe.config и diawp.exe.config. Если в этих файлах не указывается конфигурация прокси, самоходное время выполнения интеграции подключается к облачному сервису напрямую, не проходя через прокси.
- **Используйте пользовательский прокси:** Настройте настройки прокси HTTP для использования для автономной интеграции времени выполнения, вместо использования конфигураций в diahost.exe.config и diawp.exe.config. **Требуются** значения адресов и **портов.** Значения **имени пользователя** и **пароля** неявляются в зависимости от настройки аутентификации вашего прокси. Все параметры шифруются с помощью Windows DPAPI в локальной среде выполнения интеграции и хранятся локально на компьютере.

Служба запуска программы «Время выполнения» автоматически перезапускается после сохранения обновленных настроек прокси.

После регистрации автономного времени выполнения интеграции, если вы хотите просмотреть или обновить настройки прокси, используйте менеджер конфигурации Runtime Microsoft Integration.

1. Откройте **диспетчер конфигураций Microsoft Integration Runtime**.
1. Выберите вкладку **«Настройки».**
1. В **соответствии с http Proxy**выберите ссылку **«Изменение»,** чтобы открыть диалоговую будку **Set HTTP Proxy.**
1. Нажмите кнопку **Далее**. Затем вы видите предупреждение, которое запрашивает ваше разрешение на сохранение настройки прокси и перезагрузку службы хоста времени выполнения.

Инструмент менеджера конфигурации можно использовать для просмотра и обновления прокси HTTP.

![Просмотр и обновление прокси](media/create-self-hosted-integration-runtime/view-proxy.png)

> [!NOTE]
> Если вы настроили прокси-сервер с аутентификацией NTLM, служба чета записи записи запускается под учетную запись домена. Если позже вы измените пароль для учетной записи домена, не забудьте обновить настройки конфигурации службы и перезапустить службу. Из-за этого требования мы предлагаем вам получить доступ к прокси-серверу с помощью выделенной учетной записи домена, которая не требует частого обновления пароля.

### <a name="configure-proxy-server-settings"></a>Настройка параметров прокси-сервера

При выборе **прокси-опции Use System** для прокси HTTP, самохлажен с помощью программы запуска интеграции использует настройки прокси в diahost.exe.config и diawp.exe.config. Когда эти файлы не указывают прокси, самоходное время выполнения интеграции подключается к облачному сервису напрямую, не проходя через прокси. Ниже приводится процедура обновления файла конфигурации diahost.exe.config:

1. В File Explorer, сделать безопасную копию C: «Программные файлы »Microsoft Интеграция Runtime »3.0 »Shared-diahost.exe.config в качестве резервного копирования исходного файла.
1. Открыть блокнот работает в качестве администратора.
1. В Блокноте откройте текстовый файл C: «Программные файлы»-«Файлы-программы»-«Microsoft Интеграция Runtime» (Shared-diahost.exe.config).
1. Найдите тег **system.net** по умолчанию, как показано в следующем коде:

    ```xml
    <system.net>
        <defaultProxy useDefaultCredentials="true" />
    </system.net>
    ```
    Затем можно добавить данные прокси-сервера, как показано в следующем примере:

    ```xml
    <system.net>
        <defaultProxy enabled="true">
              <proxy bypassonlocal="true" proxyaddress="http://proxy.domain.org:8888/" />
        </defaultProxy>
    </system.net>
    ```

    Тег прокси позволяет дополнительным свойствам указывать необходимые настройки, такие как. `scriptLocation` Для синтаксиса [ \<см.\> прокси-элемент (настройки сети).](https://msdn.microsoft.com/library/sa91de1e.aspx)

    ```xml
    <proxy autoDetect="true|false|unspecified" bypassonlocal="true|false|unspecified" proxyaddress="uriString" scriptLocation="uriString" usesystemdefault="true|false|unspecified "/>
    ```
1. Сохранить файл конфигурации в исходном месте. Затем перезапустите самоходная служба запуска, которая подхватит изменения.

   Чтобы перезапустить сервис, воспользуйтесь услугами Applet от панели управления. Или нажмите в диспетчере конфигураций Integration Runtime кнопку **Остановить службу**, а затем выберите **Запустить службу**.

   Если служба не заработает, вы, вероятно, добавили неправильный синтаксис XML-тегов в файл конфигурации приложения, который вы редактировали.

> [!IMPORTANT]
> Не забудьте обновить оба файла (diahost.exe.config и diawp.exe.config).

Вы также должны убедиться, что Microsoft Azure находится в списке разрешений вашей компании. Вы можете скачать список действительных IP-адресов Azure из [Microsoft Download Center](https://www.microsoft.com/download/details.aspx?id=41653).

### <a name="possible-symptoms-for-issues-related-to-the-firewall-and-proxy-server"></a>Возможные симптомы проблем, связанных с брандмауэром и прокси-сервером

Если вы видите сообщения об ошибках, как следующие, вероятной причиной является неправильная конфигурация брандмауэра или прокси-сервера. Такая конфигурация предотвращает подключение автономного времени выполнения интеграции к Data Factory для проверки подлинности. Чтобы убедиться, что брандмауэр и прокси-сервер настроены должным образом, см. предыдущий раздел.

* При попытке зарегистрировать автономное время выполнения интеграции вы получаете следующее сообщение об ошибке: «Не удалось зарегистрировать этот узлы Запуска интеграции! Подтвердите, что ключ аутентификации действителен, и служба интеграции работает на этой машине».
* При открытии диспетчера конфигураций среды выполнения интеграции отображается состояние **Отключено** или **Подключение**. При просмотре журналов событий Windows в**журнале** > приложений **и** > служб microsoft**Integration Runtime**вы видите сообщения об ошибках, подобные этому:

    ```
    Unable to connect to the remote server
    A component of Integration Runtime has become unresponsive and restarts automatically. Component name: Integration Runtime (Self-hosted).
    ```

### <a name="enable-remote-access-from-an-intranet"></a>Включить удаленный доступ из интрасети

Если вы используете PowerShell для шифрования учетных данных с сетевой машины, кроме места, где вы установили самоходное время выполнения интеграции, можно включить **опцию удаленного доступа из Intranet.** Если вы запустите PowerShell для шифрования учетных данных на машине, где вы установили автономное время выполнения интеграции, вы не можете включить **удаленный доступ из Intranet.**

Включите **удаленный доступ из Intranet** перед добавлением еще одного узла для высокой доступности и масштабируемости.  

При запуске самоходной версии настройки времени выполнения интеграции 3.3 или позже, по умолчанию самоходной интеграции установщик времени выполнения отстраняет **удаленный доступ от Intranet** на самостоятельной интеграции запуска машины.

При использовании брандмауэра от партнера или других лиц можно вручную открыть порт 8060 или настроенный на пользователя порт. Если у вас возникла проблема с брандмауэром при настройке автономного времени выполнения интеграции, используйте следующую команду для установки автономного времени выполнения интеграции без настройки брандмауэра:

```
msiexec /q /i IntegrationRuntime.msi NOFIREWALL=1
```

Если вы решили не открывать порт 8060 на самохлаже, что позволяет создать систему времени выполнения интеграции, используйте механизмы, помимо приложения Setting Credentials, для настройки учетных данных хранилища данных. Например, можно использовать **new-AzDataFactoryV2LinkedServiceEncryptCredential** PowerShell cmdlet.

## <a name="next-steps"></a>Дальнейшие действия

Для пошаговых инструкций [см.](tutorial-hybrid-copy-powershell.md)
