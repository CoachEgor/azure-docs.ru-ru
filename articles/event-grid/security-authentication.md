---
title: 'Сетка событий Azure: безопасность и проверка подлинности'
description: В этой статье описываются различные способы проверки подлинности доступа к ресурсам сетки событий (веб-перехватчик, подписки, пользовательские разделы).
services: event-grid
author: banisadr
manager: timlt
ms.service: event-grid
ms.topic: conceptual
ms.date: 03/06/2020
ms.author: babanisa
ms.openlocfilehash: 4b2d65c9523f32eed01baa8d63c3d0119d00de1b
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81532399"
---
# <a name="authenticating-access-to-event-grid-resources"></a>Проверка подлинности доступа к ресурсам сетки событий

В сетке событий Azure предусмотрено три типа проверки подлинности:

- Доставка событий веб-перехватчика
- Подписки на события
- Публикация пользовательских разделов

## <a name="webhook-event-delivery"></a>Доставка событий веб-перехватчика

Веб-перехватчики — это один из многих способов получения событий из службы "Сетка событий Azure". При возникновении нового события служба "Сетка событий" отправляет в настроенную конечную точку HTTP-запрос, в тексте которого находится событие.

Как и многие другие службы, поддерживающие веб-перехватчики, служба "Сетка событий" требует, чтобы вы подтвердили право собственности на конечную точку веб-перехватчика до того, как служба начнет доставку событий в эту конечную точку. Это требование не позволяет пользователю-злоумышленнику переполнить вашу конечную точку событиями. Инфраструктура Azure автоматически обрабатывает эту проверку, когда вы используете любую из следующих трех служб Azure:

- Azure Logic Apps с [соединителем Сетки событий](https://docs.microsoft.com/connectors/azureeventgrid/);
- служба автоматизации Azure через [веб-перехватчик](../event-grid/ensure-tags-exists-on-new-virtual-machines.md);
- Функции Azure с [триггером службы "Сетка событий"](../azure-functions/functions-bindings-event-grid.md).

При использовании любого другого типа конечной точки, такого как функция Azure на основе триггера HTTP, код конечной точки должен участвовать в подтверждении проверки со службой "Сетка событий". Сетка событий поддерживает два типа проверки подписки.

1. **Синхронное подтверждение**: во время создания подписки на события сетка событий отправляет событие проверки подписки в конечную точку. Схема этого события похожа на любое другое событие Сетки событий. Часть данных этого события включает свойство `validationCode`. Приложение проверяет, что запрос на проверку относится к ожидаемой подписке на события, и возвращает код проверки в ответе синхронно. Этот механизм подтверждения поддерживается во всех версиях Сетки событий.

2. **Асинхронное подтверждение**связи. в некоторых случаях невозможно вернуть ValidationCode в ответе синхронно. Например, если вы используете сторонние службы (например [`Zapier`](https://zapier.com) , или [ифттт](https://ifttt.com/)), вы не сможете программно реагировать на код проверки.

   Начиная с версии 2018-05-01-preview Сетка событий поддерживает подтверждение проверки вручную. Если вы создаете подписку на события с помощью пакета SDK или инструмента, который использует версию API 2018-05-01-preview или более позднюю, Сетка событий отправит свойство `validationUrl` в часть данных события проверки подписки. Чтобы завершить подтверждение, найдите этот URL-адрес в данных события и выполните в нем запрос GET. Вы можете использовать клиент REST или свой веб-браузер.

   Указанный URL-адрес действителен в течение **5 минут**. В течение этого времени состояние подготовки подписки на событие находится в `AwaitingManualAction`. Если не выполнить ручную проверку в течение 5 минут, состояние подготовки будет равно `Failed`. Прежде чем выполнить проверку вручную, потребуется создать подписку на событие еще раз.

   Этот механизм проверки подлинности также требует, чтобы конечная точка веб-перехватчика возвращала код состояния HTTP 200, чтобы он знал, что запись для события проверки была принята, прежде чем ее можно будет перевести в режим ручной проверки. Иными словами, если конечная точка возвращает 200, но ответ проверки не возвращается синхронно, режим переходит в режим ручной проверки. Если имеется URL-адрес проверки в течение 5 минут, подтверждение проверки считается успешным.

> [!NOTE]
> Использование самозаверяющих сертификатов для проверки не поддерживается. Вместо этого используйте подписанный сертификат из центра сертификации (ЦС).

### <a name="validation-details"></a>Сведения о проверке

- Во время создания или обновления подписки на события Сетка событий публикует в целевую конечную точку событие проверки подписки.
- В качестве заголовка событие содержит значение "Aeg-Event-Type: SubscriptionValidation".
- Текст события имеет ту же схему, что и другие события сетки событий.
- Свойству события eventType соответствует значение `Microsoft.EventGrid.SubscriptionValidationEvent`.
- К свойству данных события относится свойство `validationCode` со строкой, сгенерированной случайным образом. Например "validationCode: acb13…".
- Данные о событии включают свойство `validationUrl` с URL-адресом для проверки подписки вручную.
- Массив содержит только событие проверки. Другие события отправляются в отдельном запросе после возврата кода проверки.
- Пакеты SDK EventGrid DataPlane содержат классы, соответствующие данным события проверки подписки и ответу на проверку подписки.

Пример SubscriptionValidationEvent показан в следующем примере:

```json
[
  {
    "id": "2d1781af-3a4c-4d7c-bd0c-e34b19da4e66",
    "topic": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "subject": "",
    "data": {
      "validationCode": "512d38b6-c7b8-40c8-89fe-f46f9e9622b6",
      "validationUrl": "https://rp-eastus2.eventgrid.azure.net:553/eventsubscriptions/estest/validate?id=512d38b6-c7b8-40c8-89fe-f46f9e9622b6&t=2018-04-26T20:30:54.4538837Z&apiVersion=2018-05-01-preview&token=1A1A1A1A"
    },
    "eventType": "Microsoft.EventGrid.SubscriptionValidationEvent",
    "eventTime": "2018-01-25T22:12:19.4556811Z",
    "metadataVersion": "1",
    "dataVersion": "1"
  }
]
```

Чтобы подтвердить владение конечной точкой, в свойстве validationResponse возвращается код проверки, как показано в следующем примере:

```json
{
  "validationResponse": "512d38b6-c7b8-40c8-89fe-f46f9e9622b6"
}
```

Должен возвратиться код состояния ответа HTTP 200 OK. HTTP 202 Accepted не распознается как действительный ответ проверки подписки Сетки событий. HTTP-запрос должен завершиться в течение 30 секунд. Если операция не завершается в течение 30 секунд, операция будет отменена и ее выполнение может быть повторено через 5 секунд. Если все попытки завершатся ошибкой, она будет считаться ошибкой подтверждения проверки.

Можно также вручную проверить подписку, отправив запрос GET по URL-адресу проверки. Подписка на событие остается в состоянии ожидания, пока проверка не будет завершена. URL-адрес проверки использует порт 553. Если правила брандмауэра блокируют порт 553, то для успешного ручного подтверждения может потребоваться обновление правил.

Пример обработки подтверждения проверки подписки на C# см. на [сайте GitHub](https://github.com/Azure-Samples/event-grid-dotnet-publish-consume-events/blob/master/EventGridConsumer/EventGridConsumer/Function1.cs).

## <a name="troubleshooting-eventsubsciption-validation"></a>Устранение неполадок проверки ЕвентсубсЦиптион

При создании подписки на событие, если отображается сообщение об ошибке "попытка проверить указанную конечную точку HTTPS:\//йоур-ендпоинт-Хере завершилась неудачей. Дополнительные сведения см. по адресу\/HTTPS:/AKA.MS/esvalidation ". Это означает, что в подтверждении проверки произошла ошибка. Чтобы устранить эту ошибку, проверьте следующие аспекты:

- Выполните HTTP POST на URL-адрес веб перехватчика с [примером](#validation-details) текста запроса SubscriptionValidationEvent, используя POST или или аналогичное средство.
- Если веб-перехватчик реализует механизм подтверждения синхронной проверки, убедитесь, что ValidationCode возвращается как часть ответа.
- Если веб-перехватчик реализует механизм подтверждения по асинхронной проверке, убедитесь, что HTTP POST возвращает значение 200 OK.
- Если веб-перехватчик возвращает 403 (запрещено) в ответе, проверьте, находится ли веб-перехватчик за шлюзом приложений Azure или брандмауэром веб-приложения. Если это так, необходимо отключить эти правила брандмауэра и выполнить HTTP-запрос повторно.

  920300 (в запросе отсутствует заголовок Accept, мы можем исправить это)

  942430 (ограничение на обнаружение аномалий символов SQL (args): Превышено число специальных символов (12))

  920230 (обнаружено несколько кодировок URL-адресов)

  942130 (атака путем внедрения кода SQL: обнаружен SQL Таутологи.)

  931130 (возможная атака с удаленными файлами (RFI) = не является ссылкой на домен или ссылкой)

### <a name="event-delivery-security"></a>Защита доставки событий

#### <a name="azure-ad"></a>Azure AD

Вы можете защитить конечную точку веб-перехватчика с помощью Azure Active Directory для проверки подлинности и авторизации сетки событий, чтобы опубликовать события в конечных точках. Вам потребуется создать приложение Azure Active Directory, создать роль и субъект-службу в приложении, которое будет выполнять авторизацию в службе "Сетка событий", и настроить подписку на события для использования приложения Azure AD. [Узнайте, как настроить AAD с помощью сетки событий](secure-webhook-delivery.md).

#### <a name="query-parameters"></a>Параметры запроса

Защитить конечную точку веб-перехватчика можно путем добавления параметров запроса для URL-адреса веб-перехватчика при создании подписки на события. Задайте один из этих параметров запроса в качестве секрета, например [маркер доступа](https://en.wikipedia.org/wiki/Access_token). С его помощью веб-перехватчик сможет распознавать событие, поступающее из Сетки событий с допустимыми разрешениями. Сетка событий будет включать эти параметры в каждую доставку событий для веб-перехватчика.

При изменении подписки на событие, если в [интерфейсе командной строки](https://docs.microsoft.com/cli/azure?view=azure-cli-latest) Azure не используется параметр [--include-full-endpoint-url](https://docs.microsoft.com/cli/azure/eventgrid/event-subscription?view=azure-cli-latest#az-eventgrid-event-subscription-show), параметры запроса не отображаются и не возвращаются.

Наконец, необходимо отметить, что служба "Сетка событий Azure" поддерживает только конечные точки веб-перехватчиков HTTPS.

## <a name="event-subscription"></a>Подписка на события

Чтобы подписаться на событие, необходимо предоставить доказательство, что вы обладаете доступом к источнику и обработчику события. В предыдущем разделе было описано, как доказать, что вы владеете веб-перехватчиком. При использовании обработчика событий, который не является веб-перехватчиком (например, концентратор событий или хранилище очередей), у пользователя возникает необходимость в доступе на запись к данному ресурсу. Данная проверка разрешений предотвращает попытки неавторизованных пользователей отправить события в ресурс.

Чтобы использовать ресурс, который является источником события, необходимо иметь разрешение **Microsoft.EventGrid/EventSubscriptions/Write**. Это разрешение необходимо, так как вы записываете новую подписку в области действия ресурса. Требуемый ресурс зависит от того, на какой раздел оформляется подписка: системный или пользовательский. В этом разделе описываются оба типа подписки.

### <a name="system-topics-azure-service-publishers"></a>Системные разделы (издатели служб Azure)

Для системных разделов необходимо разрешение на запись новой подписки на события в области действия ресурса, публикующего событие. Ресурс имеет следующий формат: `/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/{resource-provider}/{resource-type}/{resource-name}`

Например, чтобы подписаться на событие в учетной записи хранения с именем **myacct**, требуется разрешение Microsoft.EventGrid/EventSubscriptions/Write для следующего ресурса: `/subscriptions/####/resourceGroups/testrg/providers/Microsoft.Storage/storageAccounts/myacct`

### <a name="custom-topics"></a>Пользовательские разделы

Для пользовательских разделов необходимо разрешение на запись новой подписки на события в области действия для сетки событий. Ресурс имеет следующий формат: `/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.EventGrid/topics/{topic-name}`

Например, чтобы подписаться на пользовательский раздел с именем **mytopic**, требуется разрешение Microsoft.EventGrid/EventSubscriptions/Write для следующего ресурса: `/subscriptions/####/resourceGroups/testrg/providers/Microsoft.EventGrid/topics/mytopic`

## <a name="custom-topic-publishing"></a>Публикация пользовательских разделов

Для пользовательских разделов используется либо подписанный URL-адрес (SAS), либо аутентификация с помощью ключа. Рекомендуется использовать SAS, но проверка подлинности с использованием ключа обеспечивает простое программирование, а также совместима со множеством существующих издателей веб-перехватчиков.

Значение проверки подлинности следует включить в заголовок HTTP. Для SAS в качестве значения заголовка используйте **aeg-sas-token**. Для подлинности с использованием ключа в качестве значения заголовка следует использовать **aeg-sas-key**.

### <a name="key-authentication"></a>Проверка подлинности с использованием ключа

Проверка подлинности с использованием ключа — самая простая форма проверки подлинности. Используйте следующий формат: `aeg-sas-key: <your key>`

Например, для передачи ключа можно использовать следующую команду:

```
aeg-sas-key: VXbGWce53249Mt8wuotr0GPmyJ/nDT4hgdEj9DpBeRr38arnnm5OFg==
```

### <a name="sas-tokens"></a>Маркеры SAS

Маркеры SAS для сетки события включают ресурс, срок его действия и подпись. Маркер SAS имеет следующий формат: `r={resource}&e={expiration}&s={signature}`.

Ресурс — это путь для раздела сетки событий, в который вы отправляете события. Например, допустимый путь к ресурсу: `https://<yourtopic>.<region>.eventgrid.azure.net/eventGrid/api/events?api-version=2019-06-01`. Чтобы просмотреть все поддерживаемые версии API, см. раздел [типы ресурсов Microsoft. EventGrid](https://docs.microsoft.com/azure/templates/microsoft.eventgrid/allversions). 

Вы создаете подпись на основе ключа.

Например, допустимое значение **aeg-sas-token** выглядит следующим образом:

```http
aeg-sas-token: r=https%3a%2f%2fmytopic.eventgrid.azure.net%2feventGrid%2fapi%2fevent&e=6%2f15%2f2017+6%3a20%3a15+PM&s=a4oNHpRZygINC%2fBPjdDLOrc6THPy3tDcGHw1zP4OajQ%3d
```

В следующем примере создается маркер SAS для использования с сеткой событий:

```cs
static string BuildSharedAccessSignature(string resource, DateTime expirationUtc, string key)
{
    const char Resource = 'r';
    const char Expiration = 'e';
    const char Signature = 's';

    string encodedResource = HttpUtility.UrlEncode(resource);
    var culture = CultureInfo.CreateSpecificCulture("en-US");
    var encodedExpirationUtc = HttpUtility.UrlEncode(expirationUtc.ToString(culture));

    string unsignedSas = $"{Resource}={encodedResource}&{Expiration}={encodedExpirationUtc}";
    using (var hmac = new HMACSHA256(Convert.FromBase64String(key)))
    {
        string signature = Convert.ToBase64String(hmac.ComputeHash(Encoding.UTF8.GetBytes(unsignedSas)));
        string encodedSignature = HttpUtility.UrlEncode(signature);
        string signedSas = $"{unsignedSas}&{Signature}={encodedSignature}";

        return signedSas;
    }
}
```

### <a name="encryption-at-rest"></a>Шифрование при хранении

Все события или данные, записываемые на диск службой "Сетка событий", шифруются с помощью ключа, управляемого корпорацией Майкрософт, что гарантирует их шифрование. Кроме того, максимальный период времени, в течение которого события или данные были сохранены, составляет 24 часа в соответствии с [политикой повтора сетки событий](delivery-and-retry.md). Сетка событий будет автоматически удалять все события или данные через 24 часа или срок жизни события в зависимости от того, какое значение меньше.

## <a name="endpoint-validation-with-cloudevents-v10"></a>Проверка конечной точки с помощью Клаудевентс v 1.0
Если вы уже знакомы со службой "Сетка событий", то, возможно, знаете, что подтверждение конечной точки сетки событий не позволяет избежать нарушения. Клаудевентс v 1.0 реализует собственную [семантику защиты от](security-authentication.md#webhook-event-delivery) нарушений с помощью метода HTTP Options. Дополнительные сведения можно прочитать [здесь](https://github.com/cloudevents/spec/blob/v1.0/http-webhook.md#4-abuse-protection). При использовании схемы Клаудевентс для вывода в службе "Сетка событий" используется с защитой Клаудевентс v 1.0 вместо механизма событий проверки сетки событий.

## <a name="next-steps"></a>Дальнейшие шаги

- Общие сведения о сетке событий см. в статье [о сетке событий](overview.md) .
