---
title: Доставка событий веб-перехватчика
description: В этой статье описывается доставка событий веб-перехватчика и проверка конечной точки при использовании веб-перехватчиков.
services: event-grid
author: banisadr
manager: timlt
ms.service: event-grid
ms.topic: conceptual
ms.date: 03/06/2020
ms.author: babanisa
ms.openlocfilehash: 7ae8a21d4ea9216bea13d47ad5ae41f3bc1c2089
ms.sourcegitcommit: 1895459d1c8a592f03326fcb037007b86e2fd22f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/01/2020
ms.locfileid: "82630178"
---
# <a name="webhook-event-delivery"></a>Доставка событий веб-перехватчика
Веб-перехватчики — это один из многих способов получения событий из службы "Сетка событий Azure". При возникновении нового события служба "Сетка событий" отправляет в настроенную конечную точку HTTP-запрос, в тексте которого находится событие.

Как и многие другие службы, поддерживающие веб-перехватчики, служба "Сетка событий" требует, чтобы вы подтвердили право собственности на конечную точку веб-перехватчика до того, как служба начнет доставку событий в эту конечную точку. Это требование не позволяет пользователю-злоумышленнику переполнить вашу конечную точку событиями. Инфраструктура Azure автоматически обрабатывает эту проверку, когда вы используете любую из следующих трех служб Azure:

- Azure Logic Apps с [соединителем Сетки событий](https://docs.microsoft.com/connectors/azureeventgrid/);
- служба автоматизации Azure через [веб-перехватчик](../event-grid/ensure-tags-exists-on-new-virtual-machines.md);
- Функции Azure с [триггером службы "Сетка событий"](../azure-functions/functions-bindings-event-grid.md).

## <a name="endpoint-validation-with-event-grid-events"></a>Проверка конечной точки с событиями сетки событий
При использовании любого другого типа конечной точки, такого как функция Azure на основе триггера HTTP, код конечной точки должен участвовать в подтверждении проверки со службой "Сетка событий". Сетка событий поддерживает два типа проверки подписки.

1. **Синхронное подтверждение**: во время создания подписки на события сетка событий отправляет событие проверки подписки в конечную точку. Схема этого события похожа на любое другое событие Сетки событий. Часть данных этого события включает свойство `validationCode`. Приложение проверяет, что запрос на проверку относится к ожидаемой подписке на события, и возвращает код проверки в ответе синхронно. Этот механизм подтверждения поддерживается во всех версиях Сетки событий.

2. **Асинхронное подтверждение**связи. в некоторых случаях невозможно вернуть ValidationCode в ответе синхронно. Например, если вы используете сторонние службы (например [`Zapier`](https://zapier.com) , или [ифттт](https://ifttt.com/)), вы не сможете программно реагировать на код проверки.

   Начиная с версии 2018-05-01-preview Сетка событий поддерживает подтверждение проверки вручную. Если вы создаете подписку на события с помощью пакета SDK или инструмента, который использует версию API 2018-05-01-preview или более позднюю, Сетка событий отправит свойство `validationUrl` в часть данных события проверки подписки. Чтобы завершить подтверждение, найдите этот URL-адрес в данных события и выполните в нем запрос GET. Вы можете использовать клиент REST или свой веб-браузер.

   Указанный URL-адрес действителен в течение **5 минут**. В течение этого времени состояние подготовки подписки на событие находится в `AwaitingManualAction`. Если не выполнить ручную проверку в течение 5 минут, состояние подготовки будет равно `Failed`. Прежде чем выполнить проверку вручную, потребуется создать подписку на событие еще раз.

   Этот механизм проверки подлинности также требует, чтобы конечная точка веб-перехватчика возвращала код состояния HTTP 200, чтобы он знал, что запись для события проверки была принята, прежде чем ее можно будет перевести в режим ручной проверки. Иными словами, если конечная точка возвращает 200, но ответ проверки не возвращается синхронно, режим переходит в режим ручной проверки. Если имеется URL-адрес проверки в течение 5 минут, подтверждение проверки считается успешным.

> [!NOTE]
> Использование самозаверяющих сертификатов для проверки не поддерживается. Вместо этого используйте подписанный сертификат из центра сертификации (ЦС).

### <a name="validation-details"></a>Сведения о проверке

- Во время создания или обновления подписки на события Сетка событий публикует в целевую конечную точку событие проверки подписки.
- В качестве заголовка событие содержит значение "Aeg-Event-Type: SubscriptionValidation".
- Текст события имеет ту же схему, что и другие события сетки событий.
- Свойству события eventType соответствует значение `Microsoft.EventGrid.SubscriptionValidationEvent`.
- К свойству данных события относится свойство `validationCode` со строкой, сгенерированной случайным образом. Например "validationCode: acb13…".
- Данные о событии включают свойство `validationUrl` с URL-адресом для проверки подписки вручную.
- Массив содержит только событие проверки. Другие события отправляются в отдельном запросе после возврата кода проверки.
- Пакеты SDK EventGrid DataPlane содержат классы, соответствующие данным события проверки подписки и ответу на проверку подписки.

Пример SubscriptionValidationEvent показан в следующем примере:

```json
[
  {
    "id": "2d1781af-3a4c-4d7c-bd0c-e34b19da4e66",
    "topic": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "subject": "",
    "data": {
      "validationCode": "512d38b6-c7b8-40c8-89fe-f46f9e9622b6",
      "validationUrl": "https://rp-eastus2.eventgrid.azure.net:553/eventsubscriptions/estest/validate?id=512d38b6-c7b8-40c8-89fe-f46f9e9622b6&t=2018-04-26T20:30:54.4538837Z&apiVersion=2018-05-01-preview&token=1A1A1A1A"
    },
    "eventType": "Microsoft.EventGrid.SubscriptionValidationEvent",
    "eventTime": "2018-01-25T22:12:19.4556811Z",
    "metadataVersion": "1",
    "dataVersion": "1"
  }
]
```

Чтобы подтвердить владение конечной точкой, в свойстве validationResponse возвращается код проверки, как показано в следующем примере:

```json
{
  "validationResponse": "512d38b6-c7b8-40c8-89fe-f46f9e9622b6"
}
```

Должен возвратиться код состояния ответа HTTP 200 OK. HTTP 202 Accepted не распознается как действительный ответ проверки подписки Сетки событий. HTTP-запрос должен завершиться в течение 30 секунд. Если операция не завершается в течение 30 секунд, операция будет отменена и ее выполнение может быть повторено через 5 секунд. Если все попытки завершатся ошибкой, она будет считаться ошибкой подтверждения проверки.

Можно также вручную проверить подписку, отправив запрос GET по URL-адресу проверки. Подписка на событие остается в состоянии ожидания, пока проверка не будет завершена. URL-адрес проверки использует порт 553. Если правила брандмауэра блокируют порт 553, то для успешного ручного подтверждения может потребоваться обновление правил.

Пример обработки подтверждения проверки подписки на C# см. на [сайте GitHub](https://github.com/Azure-Samples/event-grid-dotnet-publish-consume-events/blob/master/EventGridConsumer/EventGridConsumer/Function1.cs).

## <a name="endpoint-validation-with-cloudevents-v10"></a>Проверка конечной точки с помощью Клаудевентс v 1.0
Если вы уже знакомы со службой "Сетка событий", то, возможно, знаете, что подтверждение конечной точки сетки событий не позволяет избежать нарушения. Клаудевентс v 1.0 реализует собственную [семантику защиты от](webhook-event-delivery.md) нарушений с помощью метода HTTP Options. Дополнительные сведения можно прочитать [здесь](https://github.com/cloudevents/spec/blob/v1.0/http-webhook.md#4-abuse-protection). При использовании схемы Клаудевентс для вывода в службе "Сетка событий" используется с защитой Клаудевентс v 1.0 вместо механизма событий проверки сетки событий.

## <a name="next-steps"></a>Дальнейшие действия
Ознакомьтесь со следующей статьей, чтобы узнать, как устранить неполадки с подпиской на события: 

[Устранение неполадок при проверках подписки на события](troubleshoot-subscription-validation.md)
