---
title: Доставка и повторные попытки доставки сетки событий Azure
description: В статье описывается, как сетка событий Azure передает события и обрабатывает недоставленные сообщения.
services: event-grid
author: spelluru
ms.service: event-grid
ms.topic: conceptual
ms.date: 02/27/2020
ms.author: spelluru
ms.openlocfilehash: dda2fd98c4c0d330059156a5ec00baa97ffaf627
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77921068"
---
# <a name="event-grid-message-delivery-and-retry"></a>Доставка и повторные попытки доставки сообщений сетки событий

В этой статье описывается, как Сетка событий Azure обрабатывает события, когда доставка не подтверждена.

Сетка событий обеспечивает надежную доставку. Она обеспечивает доставку каждого сообщения по крайней мере один раз для каждой подписки. Отправка событий для зарегистрированных веб-перехватчиков каждой подписки осуществляется мгновенно. Если конечная точка не подтверждает получения события, "Сетка событий" предпринимает повторную попытку доставить событие.

## <a name="batched-event-delivery"></a>Пакетная доставка событий

Event Grid по умолчанию отправляет каждое событие по отдельности подписчикам. Каждый подписчик получает массив с одним событием. Можно настроить Event Grid на пакетные события для доставки для повышения производительности HTTP в сценариях высокой пропускной способности.

Пакетная доставка имеет две настройки:

* **Макс события за партию** - Максимальное количество событий Event Grid будет поставлять за партию. Это число никогда не будет превышено, однако меньше событий может быть доставлено, если на момент публикации не доступны другие события. Event Grid не задерживает события, чтобы создать пакет, если доступно меньше событий. Должно быть от 1 до 5000.
* **Предпочтительный размер партии в килобайтах** - Целевой потолок для размера партии в килобайтах. Как и в случае с событиями max, размер пакета может быть меньше, если на момент публикации больше событий недоступно. Возможно, что пакет больше предпочтительного размера партии, *если* одно событие больше предпочтительного размера. Например, если предпочтительный размер составляет 4 КБ, а событие 10-KB отодвинуто на event Grid, событие 10-KB будет по-прежнему поставляться в своей собственной партии, а не отбрасывается.

Пакетная доставка настроена на основе подписки на каждое событие через портал, CLI, PowerShell или SDK.

### <a name="azure-portal"></a>Портал Azure: 
![Настройки доставки пакетов](./media/delivery-and-retry/batch-settings.png)

### <a name="azure-cli"></a>Azure CLI
При создании подписки на событие используйте следующие параметры: 

- **max-events-per-batch** - Максимальное количество событий в партии. Должно быть число от 1 до 5000.
- **предпочтительный-пакет-размер-в-килобайт** - Предпочтительный размер партии в килобайтах. Должно быть число между 1 и 1024.

```azurecli
storageid=$(az storage account show --name <storage_account_name> --resource-group <resource_group_name> --query id --output tsv)
endpoint=https://$sitename.azurewebsites.net/api/updates

az eventgrid event-subscription create \
  --resource-id $storageid \
  --name <event_subscription_name> \
  --endpoint $endpoint \
  --max-events-per-batch 1000 \
  --preferred-batch-size-in-kilobytes 512
```

Для получения дополнительной информации об использовании [Route storage events to web endpoint with Azure CLI](../storage/blobs/storage-blob-event-quickstart.md)Azure CLI с Event Grid см.

## <a name="retry-schedule-and-duration"></a>График повторных попыток и длительность

Event Grid ждет ответа 30 секунд после доставки сообщения. Через 30 секунд, если конечная точка не ответила, сообщение стоит в очереди для повторной попытки. Для доставки событий сетка событий использует политику экспоненциального увеличения задержки повтора. Event Grid повторно выполняет доставку по следующему графику на основе лучших усилий:

- 10 с
- 30 секунд
- 1 минута
- 5 мин
- 10 минут.
- 30 минут
- 1 час
- Почасовой срок до 24 часов

Если конечная точка ответит в течение 3 минут, Event Grid попытается удалить событие из очереди повтора на основе наилучших усилий, но дубликаты все равно могут быть получены.

Event Grid добавляет небольшую рандомизацию ко всем шагам повторной попытки и может оппортунистически пропустить определенные повторы, если конечная точка постоянно неработоспособна, вниз в течение длительного периода или, как представляется, перегружены.

Для детерминированного поведения установите время выполнения событий и максимальные попытки доставки в [политиках повторной попытки подписки.](manage-event-delivery.md)

По умолчанию служба "Сетка событий" завершает срок действия всех событий, которые не были доставлены в течение 24 часов. [Политику повтора можно настроить](manage-event-delivery.md) во время создания подписки на события. Укажите максимальное число попыток доставки (по умолчанию — 30) и срок жизни события (по умолчанию — 1440 минут).

## <a name="delayed-delivery"></a>Задержка доставки

В качестве конечной точки опытс асбытности доставки, Event Grid начнет задерживать доставку и повторную попытку событий в этой конечной точке. Например, если первые 10 событий, опубликованных в конечную точку, сбой, Event Grid будет считать, что конечная точка испытывает проблемы и будет задерживать все последующие повторы *и новые* поставки в течение некоторого времени - в некоторых случаях до нескольких часов.

Функциональной целью задержки доставки является защита нездоровых конечных точек, а также системы Event Grid. Без резервного отработки и задержки доставки в нездоровые конечные точки, политика повторной попытки event Grid и возможности громкости могут легко перегрузить систему.

## <a name="dead-letter-events"></a>События недоставленных сообщений

Когда службе "Сетка событий Azure" не удается доставить событие, она может отправлять его в учетною запись хранилища. Этот процесс называется перемещение в очередь недоставленных сообщений. По умолчанию в службе "Сетка событий Azure" не включено перемещение в очередь недоставленных сообщений. Чтобы его включить, необходимо указать учетную запись хранения недоставленных событий при создании подписки на событие. Можно извлекать события из этой учетной записи хранения, чтобы продолжать доставку.

"Сетка событий" отправляет событие расположение недоставленных в том случае, когда действие выполнялось все повторные попытки. Если "Сетка событий" получает код ответа 400 (ошибка запроса) или 413 (слишком большой запрос), она немедленно отправляет событие в конечную точку события недоставленных сообщений. Эти коды отклика указывают, что доставка события никогда не будет выполнена успешно.

Предусмотрена 5-минутная задержка между последней попыткой доставить событие и доставкой этого события в расположение недоставленных сообщений. Эта задержка предназначена для уменьшения количества операций в хранилище BLOB-объектов. Если расположение недоставленных сообщений недоступно в течение четырех часов, событие удаляется.

Прежде чем задать параметры расположения недоставленных сообщений, необходимо создать учетную запись хранения с контейнером. При создании подписки на событие необходимо ввести конечную точку для этого контейнера. Конечная точка имеет следующий формат: `/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.Storage/storageAccounts/<storage-name>/blobServices/default/containers/<container-name>`

Может потребоваться получать уведомления, когда события был отправлен в расположение недоставленных сообщений. Чтобы использовать службу "Сетка событий Azure" для реагирования на недоставленные события, [создайте подписку на события](../storage/blobs/storage-blob-event-quickstart.md?toc=%2fazure%2fevent-grid%2ftoc.json) для хранилища больших двоичных объектов недоставленных сообщений. Каждый раз, когда ваше хранилище больших двоичных объектов недоставленных сообщений получает недоставленное событие, служба "Сетка событий Azure" уведомляет вашего обработчика. Обработчик отвечает действиями, которые необходимо предпринять для согласования недоставленных событий.

Пример настройки расположения недоставленных сообщений, см. в разделе [Недоставленные сообщения и политики повтора](manage-event-delivery.md).

## <a name="message-delivery-status"></a>Состояние доставки сообщения

Сетка событий использует коды ответов HTTP для подтверждения получения событий. 

### <a name="success-codes"></a>Коды успешной доставки

Event Grid рассматривает **только** следующие коды ответов HTTP как успешные поставки. Все остальные коды статуса считаются неудачными поставками и будут повторены или deadlettered по мере необходимости. Получив успешный код состояния, Event Grid считает доставку полной.

- 200 ОК
- 201 Создано
- 202 — принято
- 203 Неавторитетная информация
- 204 No Content (содержимое отсутствует)

### <a name="failure-codes"></a>Коды сбоя доставки

Все остальные коды, не втомяемые (200-204), считаются сбоями и будут повторены. Некоторые из них имеют конкретные политики повторной работы, связанные с ними, изложенные ниже, все остальные следуют стандартной экспоненциальной модели резервного копирования. Важно иметь в виду, что из-за весьма параллелизированного характера архитектуры Event Grid поведение повторная попытка не детерминирована. 

| Код состояния | Поведение при повторе |
| ------------|----------------|
| 400 — недопустимый запрос | Повторная попытка через 5 минут или более (Deadletter немедленно, если deadletter установки) |
| 401 — недостаточно прав | Повторная попытка через 5 минут или более |
| 403. Запрещено | Повторная попытка через 5 минут или более |
| 404 — не найдено | Повторная попытка через 5 минут или более |
| 408 — Истекло время ожидания запроса | Повторная попытка через 2 минуты или более |
| 413 — размер запрашиваемой сущности слишком большой | Повторная попытка через 10 секунд или более (Deadletter немедленно, если deadletter установки) |
| 503 — Служба недоступна | Повторная попытка через 30 секунд или более |
| Все остальные | Повторная попытка через 10 секунд или более |


## <a name="next-steps"></a>Дальнейшие действия

* Сведения о том, как просмотреть состояние доставки событий, см. в статье [Мониторинг доставки сообщений Сетки событий](monitor-event-delivery.md).
* Чтобы настроить параметры доставки событий, см. в разделе [Недоставленные сообщения и политики повтора](manage-event-delivery.md).
