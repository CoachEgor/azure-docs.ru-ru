---
title: Доставка и повторные попытки доставки сетки событий Azure
description: В статье описывается, как сетка событий Azure передает события и обрабатывает недоставленные сообщения.
services: event-grid
author: spelluru
ms.service: event-grid
ms.topic: conceptual
ms.date: 02/27/2020
ms.author: spelluru
ms.openlocfilehash: dda2fd98c4c0d330059156a5ec00baa97ffaf627
ms.sourcegitcommit: 3c925b84b5144f3be0a9cd3256d0886df9fa9dc0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/28/2020
ms.locfileid: "77921068"
---
# <a name="event-grid-message-delivery-and-retry"></a>Доставка и повторные попытки доставки сообщений сетки событий

В этой статье описывается, как Сетка событий Azure обрабатывает события, когда доставка не подтверждена.

Сетка событий обеспечивает надежную доставку. Она обеспечивает доставку каждого сообщения по крайней мере один раз для каждой подписки. Отправка событий для зарегистрированных веб-перехватчиков каждой подписки осуществляется мгновенно. Если конечная точка не подтверждает получения события, "Сетка событий" предпринимает повторную попытку доставить событие.

## <a name="batched-event-delivery"></a>Пакетная доставка событий

По умолчанию сетка событий отправляет каждое событие по отдельности подписчикам. Каждый подписчик получает массив с одним событием. Вы можете настроить в службе "Сетка событий" пакетные события для доставки, чтобы улучшить производительность HTTP в сценариях с высокой пропускной способностью.

Пакетная доставка имеет два параметра:

* Максимальное число **событий на пакет** — максимально допустимое количество событий в сетке событий для каждого пакета. Это число никогда не будет превышено, однако если во время публикации не будут доступны другие события, может доставляться меньшее количество событий. Сетка событий не задерживает события, чтобы создать пакет, если доступно меньшее количество событий. Должно быть в диапазоне от 1 до 5 000.
* **Предпочтительный размер пакета в килобайтах** — размер пакета в килобайтах. Как и в случае с Max Events, размер пакета может быть меньше, если в момент публикации больше событий не будет доступно. Возможно, что пакет больше, чем размер предпочтительного размера пакета, *Если* одно событие больше предпочтительного размера. Например, если предпочтительный размер равен 4 КБ, а событие 10 КБ отправлено в сетку событий, то событие 10 КБ по-прежнему будет доставлено в отдельном пакете, а не удалено.

Пакетная доставка, настроенная на основе подписки на события, осуществляется с помощью портала, интерфейса командной строки, PowerShell или пакетов SDK.

### <a name="azure-portal"></a>Портал Azure: 
![Параметры пакетной доставки](./media/delivery-and-retry/batch-settings.png)

### <a name="azure-cli"></a>Azure CLI
При создании подписки на события используйте следующие параметры: 

- **Max-Events-для каждого пакета** — максимальное количество событий в пакете. Должно быть числом от 1 до 5000.
- **предпочтительный — пакетный — размер в килобайтах** — предпочтительный размер пакета в килобайтах. Должно быть числом от 1 до 1024.

```azurecli
storageid=$(az storage account show --name <storage_account_name> --resource-group <resource_group_name> --query id --output tsv)
endpoint=https://$sitename.azurewebsites.net/api/updates

az eventgrid event-subscription create \
  --resource-id $storageid \
  --name <event_subscription_name> \
  --endpoint $endpoint \
  --max-events-per-batch 1000 \
  --preferred-batch-size-in-kilobytes 512
```

Дополнительные сведения об использовании Azure CLI с таблицей событий см. в разделе [Маршрутизация событий хранилища в веб-конечную точку с Azure CLI](../storage/blobs/storage-blob-event-quickstart.md).

## <a name="retry-schedule-and-duration"></a>График повторных попыток и длительность

Сетка событий ожидает ответа в течение 30 секунд после доставки сообщения. Через 30 секунд, если конечная точка не ответила, сообщение помещается в очередь для повтора. Для доставки событий сетка событий использует политику экспоненциального увеличения задержки повтора. Сетка событий повторяет доставку по следующему расписанию с учетом оптимального объема:

- 10 секунд
- 30 секунд
- 1 минута
- 5 мин
- 10 минут.
- 30 минут
- 1 час
- Ежечасно до 24 часов

Если конечная точка отвечает в течение 3 минут, то сетка событий попытается удалить событие из очереди повторов с наибольшей вероятностью, но повторы по-прежнему могут быть получены.

Сетка событий добавляет небольшой случай для всех шагов повтора и может рационально пропускать определенные повторные попытки, если конечная точка постоянно неработоспособна, не работает в течение длительного времени или перегружена.

Для детерминированного поведения задайте для параметра время события значение Live и максимальное число попыток доставки в [политиках повтора подписки](manage-event-delivery.md).

По умолчанию служба "Сетка событий" завершает срок действия всех событий, которые не были доставлены в течение 24 часов. [Политику повтора можно настроить](manage-event-delivery.md) во время создания подписки на события. Укажите максимальное число попыток доставки (по умолчанию — 30) и срок жизни события (по умолчанию — 1440 минут).

## <a name="delayed-delivery"></a>Отложенная доставка

В качестве конечной точки происходит сбой доставки, и сетка событий начинает откладывать доставку и повторы событий в эту конечную точку. Например, если первые 10 событий, опубликованных в конечной точке, завершатся ошибкой, то сетка событий будет считать, что в конечной точке возникли проблемы, и будет задерживать все последующие повторы *и новые* доставки на некоторое время в течение нескольких часов.

Функциональное назначение отложенной доставки заключается в защите неработоспособных конечных точек, а также системы сетки событий. Без резервного копирования и задержки доставки к неработоспособным конечным точкам политика повтора и возможности тома сетки событий могут легко перегружать систему.

## <a name="dead-letter-events"></a>События недоставленных сообщений

Когда службе "Сетка событий Azure" не удается доставить событие, она может отправлять его в учетною запись хранилища. Этот процесс называется перемещение в очередь недоставленных сообщений. По умолчанию в службе "Сетка событий Azure" не включено перемещение в очередь недоставленных сообщений. Чтобы его включить, необходимо указать учетную запись хранения недоставленных событий при создании подписки на событие. Можно извлекать события из этой учетной записи хранения, чтобы продолжать доставку.

"Сетка событий" отправляет событие расположение недоставленных в том случае, когда действие выполнялось все повторные попытки. Если "Сетка событий" получает код ответа 400 (ошибка запроса) или 413 (слишком большой запрос), она немедленно отправляет событие в конечную точку события недоставленных сообщений. Эти коды отклика указывают, что доставка события никогда не будет выполнена успешно.

Предусмотрена 5-минутная задержка между последней попыткой доставить событие и доставкой этого события в расположение недоставленных сообщений. Эта задержка предназначена для уменьшения количества операций в хранилище BLOB-объектов. Если расположение недоставленных сообщений недоступно в течение четырех часов, событие удаляется.

Прежде чем задать параметры расположения недоставленных сообщений, необходимо создать учетную запись хранения с контейнером. При создании подписки на событие необходимо ввести конечную точку для этого контейнера. Конечная точка имеет следующий формат: `/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.Storage/storageAccounts/<storage-name>/blobServices/default/containers/<container-name>`

Может потребоваться получать уведомления, когда события был отправлен в расположение недоставленных сообщений. Чтобы использовать службу "Сетка событий Azure" для реагирования на недоставленные события, [создайте подписку на события](../storage/blobs/storage-blob-event-quickstart.md?toc=%2fazure%2fevent-grid%2ftoc.json) для хранилища больших двоичных объектов недоставленных сообщений. Каждый раз, когда ваше хранилище больших двоичных объектов недоставленных сообщений получает недоставленное событие, служба "Сетка событий Azure" уведомляет вашего обработчика. Обработчик отвечает действиями, которые необходимо предпринять для согласования недоставленных событий.

Пример настройки расположения недоставленных сообщений, см. в разделе [Недоставленные сообщения и политики повтора](manage-event-delivery.md).

## <a name="message-delivery-status"></a>Состояние доставки сообщения

Сетка событий использует коды ответов HTTP для подтверждения получения событий. 

### <a name="success-codes"></a>Коды успешной доставки

В сетке событий в качестве успешных поставок рассматриваются **только** следующие коды ответов HTTP. Все другие коды состояния считаются неудачными доставкой, которые будут повторены или недоставленное по мере необходимости. После получения успешного кода состояния сетка событий считает, что доставка завершена.

- 200, ОК
- 201 Создано
- 202 — принято
- 203. неофициальная информация
- 204 No Content (содержимое отсутствует)

### <a name="failure-codes"></a>Коды сбоя доставки

Все остальные коды, отсутствующие в указанном выше наборе (200-204), считаются ошибками и будут повторены. Некоторые из них привязаны к указанным ниже политикам повтора, все остальные следуют стандартной модели экспоненциального возврата. Важно помнить, что из-за высокой параллелизации архитектуры сетки событий поведение повторов не детерминировано. 

| Код состояния | Поведение при повторе |
| ------------|----------------|
| 400 — недопустимый запрос | Повтор попытки через 5 минут или более (недоставленный моментальный момент немедленно, если настройка недоставленных сообщений) |
| 401 — недостаточно прав | Повторная попытка через 5 минут или более |
| 403 Запрещено | Повторная попытка через 5 минут или более |
| 404 — не найдено | Повторная попытка через 5 минут или более |
| 408 — Истекло время ожидания запроса | Повторить через 2 минуты или больше |
| 413 — размер запрашиваемой сущности слишком большой | Повторная попытка через 10 секунд или более (недоставленный моментальный момент немедленно, если настройка недоставленных |
| 503 — Служба недоступна | Повторная попытка через 30 секунд или более |
| Все остальные | Повторная попытка через 10 секунд или более |


## <a name="next-steps"></a>Следующие шаги

* Сведения о том, как просмотреть состояние доставки событий, см. в статье [Мониторинг доставки сообщений Сетки событий](monitor-event-delivery.md).
* Чтобы настроить параметры доставки событий, см. в разделе [Недоставленные сообщения и политики повтора](manage-event-delivery.md).
