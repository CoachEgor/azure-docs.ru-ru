---
title: Интеграция Azure Relay со службой "Приватный канал Azure"
description: Сведения о том, как интегрировать Azure Relay со службой "Приватный канал Azure"
services: service-bus-relay
author: spelluru
ms.author: spelluru
ms.date: 05/13/2020
ms.service: service-bus-relay
ms.topic: article
ms.openlocfilehash: 3c2426b65e16d8d6bcdd9733280c8f97f4aa79d6
ms.sourcegitcommit: fdec8e8bdbddcce5b7a0c4ffc6842154220c8b90
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2020
ms.locfileid: "83657557"
---
# <a name="integrate-azure-relay-with-azure-private-link-preview"></a>Интеграция Azure Relay со службой "Приватный канал Azure" (предварительная версия)
**Приватный канал** Azure обеспечивает доступ к службам Azure (например, к Azure Relay, Служебной шине Azure, Центрам событий Azure, службе хранилища Azure и Azure Cosmos DB), а также размещенным в Azure службам клиентов или партнеров через частную конечную точку в виртуальной сети. Дополнительные сведения см. в статье [What is Azure Private Link? (Preview)](../private-link/private-link-overview.md) (Что такое Приватный канал Azure (предварительная версия)?)

**Частная конечная точка** — это сетевой интерфейс, который позволяет выполняемым в виртуальной сети рабочим нагрузкам приватно и безопасно подключаться к службе, которая имеет **ресурс приватного канала** (например, пространство имен ретранслятора). Частная конечная точка использует частный IP-адрес из виртуальной сети, по сути перемещая службу в виртуальную сеть. Весь трафик к службе может маршрутизироваться через частную конечную точку, поэтому шлюзы, устройства преобразования сетевых адресов (NAT), подключения ExpressRoute, VPN или общедоступные IP-адреса не требуются. Трафик между виртуальной сетью и службой проходит через магистральную сеть Майкрософт, что позволяет избежать рисков общедоступного Интернета. Обеспечить степень детализации для управления доступом позволяет подключение к конкретным пространствам имен Azure Relay. 


> [!IMPORTANT]
> Эта функция сейчас доступна в режиме **предварительной версии**. 
>
> В настоящее время поддерживаются подключения к приватному каналу на клиентах отправителя. 


## <a name="add-a-private-endpoint-using-azure-portal"></a>Добавление частной конечной точки с помощью портала Azure

### <a name="prerequisites"></a>Предварительные требования
Чтобы интегрировать пространство имен Azure Relay с Приватным каналом Azure (предварительная версия), вам потребуются следующие сущности или разрешения:

- Пространство имен Azure Relay.
- Виртуальная сеть Azure.
- Подсеть в виртуальной сети.
- Разрешения владельца или участника для виртуальной сети.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. При выборе региона для частной конечной точки с помощью портала будут автоматически фильтроваться только виртуальные сети в этом регионе. Пространство имен может находиться в другом регионе.

Частная конечная точка использует частный IP-адрес в виртуальной сети.

### <a name="steps"></a>Шаги
Пошаговые инструкции по созданию нового пространства имен Azure Relay и сущностей в нем содержатся в статье [Создание пространства имен Azure Relay с помощью портала Azure](relay-create-namespace-portal.md).

1. Войдите на [портал Azure](https://portal.azure.com). 
2. В строке поиска введите **Ретрансляторы**.
3. Выберите из списка **пространство имен**, для которого нужно добавить частную конечную точку.
4. Выберите вкладку **Сеть** в разделе **Параметры**.
5. Выберите вкладку **Подключения к частным конечным точкам (предварительная версия)** в верхней части страницы.
6. Нажмите кнопку **+ Частная конечная точка** в верхней части страницы.

    ![Кнопка "Добавить частную конечную точку"](./media/private-link-service/add-private-endpoint-button.png)
7. На странице **Базовые** выполните следующие действия. 
    1. Выберите **подписку Azure**, в которой нужно создать частную конечную точку. 
    2. Выберите **группу ресурсов** для ресурса частной конечной точки.
    3. Укажите **имя** частной конечной точки. 
    5. Выберите **регион** частной конечной точки. Частная конечная точка должна находиться в том же регионе, что и виртуальная сеть, но может находиться в разных регионах с пространством имен Azure Relay, к которому выполняется подключение. 
    6. По завершении выберите **Next: ресурс >** в нижней части страницы.

        ![Создание частной конечной точки — страница "Базовые"](./media/private-link-service/create-private-endpoint-basics-page.png)
8. На странице **Ресурс** выполните следующие действия.
    1. Если вы выбрали **Подключиться к ресурсу Azure в моем каталоге** в качестве метода подключения, при этом у вас есть доступ владельца или участника к пространству имен и это пространство имен находится в том же каталоге, что и частная конечная точка, выполните следующие действия: 
        1. Выберите **подписку Azure**, в которой находится **пространство имен Azure Relay**. 
        2. Для параметра **Тип ресурса** выберите **Microsoft.Relay/namespaces** в качестве **типа ресурса**.
        3. В качестве значения параметра **Ресурс** выберите пространство имен ретранслятора из раскрывающегося списка. 
        4. Убедитесь, что для параметра **Целевой подресурс** задано **пространство имен**.
        5. По завершении выберите **Next: конфигурация >**  в нижней части страницы. 
        
            ![Создание частной конечной точки — страница "Ресурсы"](./media/private-link-service/create-private-endpoint-resource-page.png)    
    2. Если вы выбрали **Подключиться к ресурсу Azure по идентификатору ресурса или псевдониму**, так как пространство имен не находится в том же каталоге, что и частная конечная точка, выполните следующие действия:
        1. Введите **идентификатор ресурса** или **псевдоним**. Это может быть идентификатор ресурса или псевдоним, к которому вам предоставили доступ. Самый простой способ получить идентификатор ресурса — перейти к пространству имен Azure Relay на портале Azure и скопировать часть URI, начинающуюся с `/subscriptions/`. Пример: `/subscriptions/000000000-0000-0000-0000-000000000000000/resourceGroups/myresourcegroup/providers/Microsoft.Relay/namespaces/myrelaynamespace.` 
        2. Для параметра **Целевой подресурс** введите **пространство имен**. Это тип подресурса, к которому имеет доступ частная конечная точка.
        3. (Необязательно) Введите **сообщение запроса**. Владелец ресурса видит это сообщение при управлении подключением к частной конечной точке.
        4. Затем щелкните **Далее. конфигурация >**  в нижней части страницы.

            ![Создание частной конечной точки — подключение с использованием идентификатора ресурса](./media/private-link-service/connect-resource-id.png)
9. На странице **Конфигурация** выберите в виртуальной сети подсеть, в которой нужно развернуть частную конечную точку. 
    1. Выберите **виртуальную сеть**. В раскрывающемся списке отображаются только виртуальные сети в выбранных сейчас подписке и расположении. 
    2. Выберите **подсеть** в выбранной виртуальной сети. 
    3. Включите параметр **Интегрировать с частной зоной DNS**, если вы хотите интегрировать частную конечную точку с частной зоной DNS. 
    
        Для частного подключения к частной конечной точке требуется запись DNS. Рекомендуем интегрировать частную конечную точку с **частной зоной DNS**. Вы также можете применять собственные DNS-серверы или создать записи DNS с использованием файлов узлов на виртуальных машинах. Дополнительные сведения см. в статье [Конфигурация DNS для частной конечной точки Azure](../private-link/private-endpoint-dns.md). В нашем примере выбран вариант **интеграции с частной зоной DNS**, значит для вас будет создана частная зона DNS. 
    3. По завершении выберите **Next: теги >** в нижней части страницы. 

        ![Частная конечная точка — страница "Конфигурация"](./media/private-link-service/create-private-endpoint-configuration-page.png)
10. На странице **Теги** создайте теги (имена и значения), которые нужно связать с частной конечной точкой и частной зоной DNS (если вы включили эту возможность). В нижней части страницы нажмите на кнопку **Проверка и создание**. 
11. На странице **Проверка и создание** проверьте все параметры и нажмите **Создать**, чтобы создать частную конечную точку.
    
    ![Создание частной конечной точки — страница "Проверка и создание"](./media/private-link-service/create-private-endpoint-review-create-page.png)
12. На странице **Частная конечная точка** можно просмотреть состояние подключения к частной конечной точке. Если вы являетесь владельцем пространства имен ретранслятора или имеете доступ на управление им и выбрали **Подключиться к ресурсу Azure в моем каталоге** в качестве параметра **Метод подключения**, подключение к конечной точке должно **утверждаться автоматически**. Если она находится в **состоянии ожидания**, см. раздел [Управление частными конечными точками с помощью портала Azure](#manage-private-endpoints-using-azure-portal).

    ![Страница "Частная конечная точка"](./media/private-link-service/private-endpoint-page.png)
13. Вернитесь на страницу **Сеть** **пространства имен** и перейдите на вкладку **Подключения к частным конечным точкам (предварительная версия)** . Вы должны увидеть созданную частную конечную точку. 

    ![Частная конечная точка создана](./media/private-link-service/private-endpoint-created.png)

## <a name="add-a-private-endpoint-using-powershell"></a>Добавление частной конечной точки с помощью PowerShell
В следующем примере показано, как использовать Azure PowerShell для создания подключения частной конечной точки к пространству имен Azure Relay.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. Пространство имен Azure Relay может находиться в другом регионе. Частная конечная точка использует частный IP-адрес в виртуальной сети.

```azurepowershell-interactive

$rgName = "<RESOURCE GROUP NAME>"
$vnetlocation = "<VNET LOCATION>"
$vnetName = "<VIRTUAL NETWORK NAME>"
$subnetName = "<SUBNET NAME>"
$namespaceLocation = "<NAMESPACE LOCATION>"
$namespaceName = "<NAMESPACE NAME>"
$peConnectionName = "<PRIVATE ENDPOINT CONNECTION NAME>"

# create resource group
az group create -l $vnetLocation -n $rgName

# create virtual network
$virtualNetwork = New-AzVirtualNetwork `
                    -ResourceGroupName $rgName `
                    -Location $vnetlocation `
                    -Name $vnetName `
                    -AddressPrefix 10.0.0.0/16

# create subnet with endpoint network policy disabled
$subnetConfig = Add-AzVirtualNetworkSubnetConfig `
                    -Name $subnetName `
                    -AddressPrefix 10.0.0.0/24 `
                    -PrivateEndpointNetworkPoliciesFlag "Disabled" `
                    -VirtualNetwork $virtualNetwork

# update virtual network
$virtualNetwork | Set-AzVirtualNetwork

# create a relay namespace
$namespaceResource = New-AzResource -Location $namespaceLocation -ResourceName $namespaceName -ResourceGroupName $rgName -Properties @{} -ResourceType "Microsoft.Relay/namespaces" 

# create a private link service connection
$privateEndpointConnection = New-AzPrivateLinkServiceConnection `
                                -Name $peConnectionName `
                                -PrivateLinkServiceId $namespaceResource.ResourceId `
                                -GroupId "namespace"

# get subnet object that you will use in the next step                                
$virtualNetwork = Get-AzVirtualNetwork -ResourceGroupName  $rgName -Name $vnetName
$subnet = $virtualNetwork | Select -ExpandProperty subnets `
                                | Where-Object  {$_.Name -eq $subnetName}  
   
# now, create private endpoint   
$privateEndpoint = New-AzPrivateEndpoint -ResourceGroupName $rgName  `
                                -Name $vnetName   `
                                -Location $vnetlocation `
                                -Subnet  $subnet   `
                                -PrivateLinkServiceConnection $privateEndpointConnection

(Get-AzResource -ResourceId $namespaceResource.ResourceId -ExpandProperties).Properties


```

## <a name="manage-private-endpoints-using-azure-portal"></a>Управление частными конечными точками с помощью портала Azure

При создании частной конечной точки подключение должно быть утверждено. Если ресурс (пространство имен ретранслятора), для которого создается частная конечная точка, находится в вашем каталоге, вы можете утвердить запрос на подключение при наличии прав на управление пространством имен ретранслятора. При подключении к пространству имен ретранслятора, к которому у вас нет доступа для управления, нужно дождаться, пока владелец этого ресурса утвердит запрос на подключение.

Существует четыре состояния подготовки:

| Действие в службе | Состояние частной конечной точки объекта-получателя службы | Описание |
|--|--|--|
| None | Ожидает | Подключение создается вручную и ожидает утверждения от владельца пространства имен Azure Relay. |
| Утверждение | Approved | Подключение утверждено автоматически или вручную и готово к использованию. |
| Reject | Отклонено | Соединение было отклонено владельцем пространства имен Azure Relay. |
| Удалить | Отключено | Подключение удалено владельцем пространства имен Azure Relay. Частная конечная точка станет информативной и подлежит удалению для очистки. |
 
###  <a name="approve-reject-or-remove-a-private-endpoint-connection"></a>Утверждение, отклонение или удаление подключения к частной конечной точке

1. Войдите на портал Azure.
1. В строке поиска введите **Ретранслятор**.
1. Выберите **пространство имен** для управления.
1. Перейдите на вкладку **Сеть**.
5. Перейдите ниже к соответствующему разделу в зависимости от операции, которую нужно выполнить (утверждение, отклонение или удаление). 

### <a name="approve-a-private-endpoint-connection"></a>Утверждение подключения частной конечной точки

1. Если есть подключения в состоянии подготовки, вы увидите такое подключение в списке с состоянием **В ожидании**. 
2. Выберите **частную конечную точку**, которую вы хотите утвердить.
3. Нажмите кнопку **Утвердить**.

    ![Утверждение частной конечной точки](./media/private-link-service/private-endpoint-approve.png)
4. На странице **Утвердить подключение** введите **комментарий** по желанию и нажмите **Да**. Если выбрать **Нет**, ничего не произойдет. 

    ![Страница утверждения подключения](./media/private-link-service/approve-connection-page.png)
5. Вы увидите, что состояние подключения в списке изменилось на **Утверждено**.

### <a name="reject-a-private-endpoint-connection"></a>Отклонение подключения к частной конечной точке

1. Если есть подключения к частным конечным точкам, которые вы хотите отклонить (ожидающее или ранее одобренное существующее подключение), выберите подключение и нажмите кнопку **Отклонить**.

    ![Кнопка "Отклонить"](./media/private-link-service/private-endpoint-reject.png)
2. На странице **Отклонить подключение** по желанию можно ввести комментарий, после чего нажать **Да**. Если выбрать **Нет**, ничего не произойдет. 

    ![Страница отклонения подключения](./media/private-link-service/reject-connection-page.png)
3. Вы увидите, что состояние подключения в списке изменилось на **Отклонено**.


### <a name="remove-a-private-endpoint-connection"></a>Удаление подключения к частной конечной точке

1. Чтобы удалить подключение к частной конечной точке, выберите ее в списке и нажмите **Удалить** на панели инструментов. 

    ![Кнопка "Удалить"](./media/private-link-service/remove-endpoint.png)
2. На странице **Удалить подключение** нажмите **Да**, чтобы подтвердить удаление частной конечной точки. Если выбрать **Нет**, ничего не произойдет. 

    ![Страница удаления подключения](./media/private-link-service/delete-connection-page.png)
3. Вы увидите, что состояние изменилось на **Отключено**. Затем конечная точка исчезнет из списка. 

## <a name="validate-that-the-private-link-connection-works"></a>Проверка работоспособности подключения Приватного канала
Нужно проверить, что ресурсы в той же подсети частной конечной точки подключаются к пространству имен Azure Relay по его частному IP-адресу.

Для этого создайте виртуальную машину, выполнив действия, описанные в статье [Краткое руководство. Создание виртуальной машины Windows на портале Azure](../virtual-machines/windows/quick-create-portal.md).

На вкладке **Сеть** выполните следующее. 

1. Укажите **виртуальную сеть** и **подсеть**. Необходимо выбрать виртуальную сеть, в которой развернута частная конечная точка.
2. Укажите ресурс **общедоступного IP-адреса**.
3. В списке **Группа безопасности сети сетевого адаптера** выберите **Нет**.
4. В поле **Балансировка нагрузки** выберите **Нет**.

Подключитесь к виртуальной машине, откройте командную строку и выполните следующую команду:

```console
nslookup <your-relay-namespace-name>.servicebus.windows.net
```

Должен появиться следующий результат. 

```console
Non-authoritative answer:
Name:    <namespace-name>.privatelink.servicebus.windows.net
Address:  10.0.0.4 (private IP address associated with the private endpoint)
Aliases:  <namespace-name>.servicebus.windows.net
```

## <a name="limitations-and-design-considerations"></a>Проблемы и ограничения разработки

### <a name="design-considerations"></a>Рекомендации по проектированию
- Частная конечная точка для Azure Relay предоставляется в **общедоступной предварительной версии**. 
- Сведения о ценах для Приватного канала Azure (предварительная версия) см. [здесь](https://azure.microsoft.com/pricing/details/private-link/).

### <a name="limitations"></a>Ограничения 
- Максимальное число частных конечных точек на пространство имен Azure Relay: 64
- Максимальное число пространств имен Azure Relay с частными конечными точками на одну подписку: 64
- Правила группы безопасности сети (NSG) и определяемые пользователем маршруты не применяются к частной конечной точке. Дополнительные сведения см. в разделе [Служба "Приватный канал Azure". Limitations](../private-link/private-link-service-overview.md#limitations) (Служба "Приватный канал Azure". Ограничения)

## <a name="next-steps"></a>Next Steps

- См. дополнительные сведения о службе [Приватный канал Azure (предварительная версия)](../private-link/private-link-service-overview.md).
- См. дополнительные сведения об [Azure Relay](relay-what-is-it.md).
