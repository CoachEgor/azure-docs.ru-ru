---
title: Создание интерактивных отчетов с книгами Azure Monitor | Документы Майкрософт
description: Упростите создание сложных отчетов с помощью готовых настраиваемых параметризованных книг
ms.topic: conceptual
author: NumberByColors
ms.author: daviste
ms.date: 09/19/2018
ms.reviewer: mbullwin
ms.openlocfilehash: 15543f7f761c707e8eff8e0cc0a0e4532475ddf8
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77671007"
---
# <a name="create-interactive-reports-with-azure-monitor-workbooks"></a>Создание интерактивных отчетов с книгами Azure Monitor

Рабочие книги объединяют текст,  [запросы аналитики](https://docs.microsoft.com/azure/application-insights/app-insights-analytics), метрики Azure и параметры в подробные интерактивные отчеты. Их могут редактировать другие участники команды с доступом к тому же ресурсу Azure.

Workbooks полезны для следующих сценариев:

* Изучение использования вашего приложения, когда вы не знаете метрик интерес заранее: количество пользователей, удержания ставки, коэффициенты конверсии и т.д. В отличие от других инструментов аналитики использования, трудовые книжки позволяют сочетать несколько видов визуализаций и анализов, что делает их отличными для такого рода исследований свободной формы.
* Объяснение рабочей группе принципа работы недавно выпущенных компонентов за счет отображения количества ключевых взаимодействий пользователей и других метрик.
* Совместное использование результатов альфа и бета-тестирования приложения с другими членами вашей команды. Цели для экспериментов можно объяснить с помощью текста, а затем отобразить каждую метрику использования и аналитический запрос для оценки тестирования вместе с обозначениями того, была ли каждая метрика выше или ниже целевой.
* Отчет о влиянии сбоев на использование приложения, объединение данных, текстовое описание и обсуждение следующих шагов, чтобы избежать сбоев в будущем.

## <a name="starting-with-a-template-or-saved-workbook"></a>Начните с шаблона или сохраненной книги

Книга составлена из разделов, состоящих из отдельно редактируемых диаграмм, таблиц, текста и элементов управления для ввода. Чтобы лучше понять, как работают книги, лучше всего открыть и посмотреть одну из них. 

Выберите **Книги** в меню слева в интерфейсе Application Insights для вашего приложения.

![Снимок экрана навигации к книгам](./media/usage-workbooks/001-workbooks.png)

Откроется коллекция книг с готовыми книгами, которая поможет вам приступить к работе.

![Снимок экрана с коллекцией книг приложения](./media/usage-workbooks/002-workbook-gallery.png)

Мы начнем с **шаблона по умолчанию**, который находится под заголовком **Быстрый запуск**.

![Снимок экрана с коллекцией книг приложения](./media/usage-workbooks/003-default-template.png)

## <a name="editing-rearranging-cloning-and-deleting-workbook-sections"></a>Изменение, переупорядочивание, клонирование и удаление разделов книги

Книги могут работать в двух режимах: **режиме редактирования** и **режиме чтения**. При первом запуске книга по умолчанию открывается в **режиме редактирования**. В нем показано все содержимое книги, включая все шаги и параметры, которые в противном случае будут скрыты. **Режим чтения** представляет упрощенный стиль отчета. Это позволяет абстрагироваться от сложностей, связанных с формированием отчета, одновременно сохраняя лежащую в основе механику под рукой на случай необходимости изменения.

![Элементы управления для редактирования статьи книг Application Insights Workbooks](./media/usage-workbooks/editing-controls-new.png)

1. Закончив редактирование раздела, щелкните **Done Editing** (Завершить редактирование) в левом нижнем углу раздела.

2. Чтобы создать копию раздела, щелкните значок **Clone this section** (Клонировать этот раздел). Создание повторяющихся разделов — это отличный способ для выполнения итерации по запросу без потери предыдущих итераций.

3. Чтобы перейти к следующему или к предыдущему разделу в книге, щелкните значок **Вверх** или **Вниз**.

4. Чтобы окончательно удалить раздел, щелкните значок **Удалить**.

## <a name="adding-text-and-markdown-sections"></a>Добавление текста и разделы разметки Markdown

Добавление заголовков, объяснений и комментариев в Workbooks позволяет превратить набор таблиц и диаграмм в описание. Разделы текста в книгах поддерживают [синтаксис разметки Markdown](https://daringfireball.net/projects/markdown/) для форматирования текста, например заголовков, полужирного шрифта, курсива и маркированных списков.

Чтобы добавить раздел текста в книгу, используйте кнопку **Добавить текст** в нижней части книги, либо в нижней части любого раздела.

## <a name="adding-query-sections"></a>Добавление разделов запроса

![Раздел "Запрос" в Workbooks](./media/usage-workbooks/analytics-section-new.png)

Чтобы добавить раздел запроса в книгу, используйте кнопку **Добавить запрос** в нижней части книги либо в нижней части любого раздела.

Разделы запросов очень гибки и позволяют отвечать на вопросы наподобие следующих:

* Сколько исключений об отказе в доступе выдает веб-узел за определенный период времени?
* Каким было распределение времени загрузки страниц для пользователей, просматривающих определенные страницы?
* Сколько пользователей просматривали конкретные наборы страниц на сайте? Это может быть полезно для определения кластера пользователей, использующих различные подмножества функциональных возможностей веб-сайта (используйте оператор `join` с модификатором `kind=leftanti` на [языке запросов Kusto](/azure/kusto/query/)).

Вы также не ограничены одними лишь запросами из контекста приложения, где запустили книгу. Можно выполнять запросы в нескольких приложениях, отслеживаемых службой Application Insights, а также рабочих областях Log Analytics — при условии, что у вас есть разрешение на доступ к этим ресурсам.

Для запроса дополнительных внешних ресурсов Application Insights используйте идентификатор **приложения**.

```
union app('app01').requests, app('app02').requests, requests
| summarize count() by bin(timestamp, 1h)
```  

Этот запрос объединяет запросы из трех приложений. Здесь это приложение с именем app01, приложение app02 и запросы из локального ресурса Application Insights.

Чтобы извлечь данные из внешней рабочей области Log Analytics, используйте идентификатор **рабочей области**.

Дополнительные сведения о межресурсных запросах см. в [официальном руководстве](https://docs.microsoft.com/azure/log-analytics/log-analytics-cross-workspace-search).

### <a name="advanced-analytic-query-settings"></a>Расширенные параметры запросов аналитики

У каждого раздела есть свои расширенные параметры, доступные по щелчку значка параметров ![Элементы управления редактирования книг Application Insights](./media/usage-workbooks/005-settings.png) справа от кнопки **Добавить параметры**.

![Элементы управления для редактирования статьи книг Application Insights Workbooks](./media/usage-workbooks/0006-settings-expanded.png)

   |         |          |
   | ---------------- |:-----|
   | **Настраиваемая ширина**    | Установите ее, чтобы придать элементу произвольный размер; это позволяет разместить несколько элементов на одной строке, чтобы лучше организовать диаграммы и таблицы в подробные интерактивные отчеты.  |
   | **Условная видимость** | Используйте этот параметр, чтобы скрывать шаги на основе параметра в режиме чтения. |
   | **Экспорт параметра**| Позволяет выбранной строке в таблице или диаграмме изменять в последующих действиях значения или делать их видимыми.  |
   | **Отображать запрос, когда он не редактируется** | Запрос отображается над диаграммой или таблицей даже в режиме чтения.
   | **Показать кнопку "Открыть в службе аналитики", если редактирование не ведется** | Добавляет синий значок "Аналитика" в правом углу диаграммы, чтобы предоставить доступ одним щелчком.|

Большинство из этих параметров довольно очевидны, но для понимания того, как работает **Экспорт параметра**, лучше изучить книгу, использующую эту функцию.

Одна из предварительно созданных книг содержит сведения об активных пользователях.

Первая часть книги основывается на данных из запроса аналитики:

![Элементы управления для редактирования статьи книг Application Insights Workbooks](./media/usage-workbooks/003-active-users.png)

Второй раздел также основывается на данных из запроса аналитики, но при выборе строки в первой таблице содержимое диаграммы интерактивно обновляется:

![Элементы управления для редактирования статьи книг Application Insights Workbooks](./media/usage-workbooks/004-active-users-trend.png)

 Это возможно благодаря использованию расширенных параметров **Экспорта параметра при выборе элемента**, которые включены в запрос аналитики в таблице.

![Элементы управления для редактирования статьи книг Application Insights Workbooks](./media/usage-workbooks/007-settings-export.png)

Второй запрос аналитики применяет экспортированные значения при выборе строки. Если строка не выбрана, по умолчанию используется строка, представляющая общие значения. 

```
let start = startofday(ago({TimeRange} + {Metric}));
union customEvents, pageViews
| where timestamp >= start
| where name in ({Activities}) or '*' in ({Activities}) or ('%' in ({Activities}) and itemType == 'pageView') or ('#' in ({Activities}) and itemType == 'customEvent')
{OtherFilters}
| where '{Filter}' == '' or '{Filter}' == '🔸 Overall' or {AnalyzeBy} == replace('🔹 ', '', '{Filter}')
| evaluate activity_engagement(user_Id, timestamp, start, now(), 1d, {Metric})
| where timestamp >= startofday(ago({TimeRange}))
| project timestamp, ["Active User"] = dcount_activities_outer
| render timechart 
```

## <a name="adding-metrics-sections"></a>Добавление разделов метрики

Разделы метрики дают вам полный доступ для включения данных метрик Azure Monitor в интерактивные отчеты. Многие из предварительно созданных книг содержат данные запросов аналитики и данные метрик, что позволяет воспользоваться всеми преимуществами обоих компонентов в одном месте. Также есть возможность извлечения данных метрики из ресурсов любой из подписок, к которым у вас есть доступ.

Ниже приведен пример данных о виртуальных машинах, запрашиваемых в книге для наглядного представления сетки производительности ЦП:

![Элементы управления для редактирования статьи книг Application Insights Workbooks](./media/usage-workbooks/008-metrics-grid.png)

## <a name="adding-parameter-sections"></a>Добавление разделов параметров

Параметры книги позволяют изменять значения в книге без ручного редактирования в разделах запросов или текста.  Это устраняет необходимость изучения базового языка запросов аналитики и значительно расширяет возможности потенциальной аудитории отчетов на основе книг.

Значения параметров подставляются в запросы, текст или в другие разделы параметров; для этого поместите имя параметра в фигурные скобки, например ``{parameterName}``.  Имена параметров подчиняются тем же правилам, что идентификаторы JavaScript; они начинаются с буквы или подчеркивания, за которыми следуют буквенно-цифровые символы или подчеркивания. Так, **a1** разрешено, но **1a** не допускается.

Параметры являются линейными, начиная с верхней части книги и до последующих шагов.  Параметры, объявленные в книге позже, имеют приоритет над теми, что были объявлены выше.  Это также позволяет параметрам, которые используют запросы, обращаться к значениям из параметров, определенных выше.  В пределах самого шага параметров параметры также линейны и идут слева направо; параметры справа могут зависеть от параметра, объявленного ранее на этом же шаге.
 
Сейчас поддерживаются четыре различных типа параметров:

  |         |          |
   | ---------------- |:-----|
   | **Text**    | Пользователь будет редактировать текстовое поле; при необходимости можно указать запрос, чтобы задать значения по умолчанию. |
   | **Раскрывающийся список** | Пользователь выбирает одно значение из набора значений. |
   | **Средство выбора диапазона времени**| Пользователь делает выбор в заранее заданном наборе диапазонов времени или задает свой диапазон.|
   | **Сборщик ресурсов** | Пользователь выбирает из ресурсов, выбранных для книги.|

### <a name="using-a-text-parameter"></a>Использование текстового параметра

Значение, которое пользователь вводит в текстовом поле, подставляется в запрос напрямую, без экранирования и кавычек. Если нужное значение — строка, параметр в запросе должен быть заключен в кавычки (например, **'{parameter}'**).

Это позволяет использовать текст из поля в любом месте. Это может быть имя таблицы, имя столбца, имя функции, оператор и т. д.

У параметров текстового типа есть параметр **Получить значение по умолчанию из запроса аналитики**, которая позволяет автору книги использовать запрос для заполнения значения этого текстового поля по умолчанию.

Если используется значение по умолчанию из запроса аналитики, как значение по умолчанию используется только первое значение первой строки (строка 0, столбец 0). Поэтому рекомендуется ограничить запрос, чтобы он возвращал только одну строку и один столбец. Любые другие данные, возвращаемые запросом, не учитываются. 

Какое бы значение ни вернул запрос, оно будет подставлено напрямую без экранирования или заключения в кавычки. Если запрос не возвращает строки, результат параметра будет пустой строкой (если параметр не является обязательным) или не определен (если параметр является обязательным).

### <a name="using-a-dropdown"></a>Использование раскрывающегося списка

Тип параметра c раскрывающимся списком позволяет создать раскрывающийся список, который допускает выбор одного значения или нескольких.

Раскрывающийся список заполняется при помощи запроса аналитики. Если запрос возвращает один столбец, значения в нем одновременно задают **значения** и **метки** в списке. Если запрос возвращает два столбца, первый столбец — **значение**, а второй — **метка** в раскрывающемся списке.  Если запрос возвращает три столбца, третий столбец используется для указания выбора по умолчанию в раскрывающемся списке.  Этот столбец может быть любого типа, но проще всего использовать логические или числовые типы, где 0 — ложь, а 1 — истина.

 Если столбец имеет строковый тип, пустая строка рассматривается как ложное значение, а любое другое значение считается истинным. Для раскрывающихся списков с одиночным выбором по умолчанию используется первое истинное значение.  Для раскрывающихся списков с множественным выбором по умолчанию используются все истинные значения. Элементы в раскрывающемся списке отображаются в порядке, в котором запрос вернул строки. 

Взглянем на параметры, представленные в отчете активных пользователей. Щелкните значок редактирования рядом с полем **TimeRange**.

![Элементы управления для редактирования статьи книг Application Insights Workbooks](./media/usage-workbooks/009-time-range.png)

Откроется пункт меню "Изменить параметр":

![Элементы управления для редактирования статьи книг Application Insights Workbooks](./media/usage-workbooks/010-time-range-edit.png)

В запросе используется функция языка запросов аналитики, которая называется **datatable**; она позволяет создавать произвольные таблицы, полные данных, буквально на лету! Например, следующий запрос аналитики:

```
datatable( column1:string, column2:string )
[
 "row 1 column 1", "row 1 column 2",
"row 2 column 1", "row 2 column 2"
]
```

Создает такой результат:

![Элементы управления для редактирования статьи книг Application Insights Workbooks](./media/usage-workbooks/011-data-table.png)

Более применимым примером является использование выпадения, чтобы выбрать из набора стран/регионов по имени:

```
customEvents
| where timestamp >= ago(14d)
| summarize count() by client_CountryOrRegion
| top 100 by count_
| project  client_CountryOrRegion 
| order by client_CountryOrRegion asc
```

Запрос выводит результаты так:

![Раскрывающийся список стран](./media/usage-workbooks/012-country-dropdown.png)

Раскрывающиеся списки невероятно полезны для настройки и создания интерактивных отчетов.

### <a name="time-range-parameters"></a>Параметры диапазонов времени

Хотя вы можете создать собственный параметр с настраиваемыми диапазонами времени, используя тип параметра раскрывающегося списка, можно применить готовый тип параметра диапазона времени, если гибкость настройки не так важна. 

В типе параметров с диапазонами времени есть 15 диапазонов по умолчанию: от пяти минут до последних 90 дней. Есть также возможность разрешить выбор настраиваемого диапазона времени, который позволяет явно задать в отчете начальное и конечное значения для диапазона времени.

### <a name="resource-picker"></a>Средство выбора ресурсов

Тип параметра со средством выбора ресурсов дает возможность ограничить отчет определенными типами ресурсов. Пример предварительно созданной книги, которая использует средство выбора типа ресурсов, — это книга **Аналитика сбоев**.

![Раскрывающийся список стран](./media/usage-workbooks/013-resource-picker.png)

## <a name="saving-and-sharing-workbooks-with-your-team"></a>Сохранение и совместное использование книг с коллегами

Книги будут сохраняться в ресурсе Application Insights: в закрытом разделе **Мои отчеты** или в разделе **Общие отчеты**, доступном всем пользователям с доступом к ресурсу Application Insights. Для просмотра всех книг в ресурсе нажмите кнопку **Открыть** на панели действий.

Чтобы опубликовать книгу, которая находится в разделе **Мои отчеты**, сделайте следующее:

1. На панели действий щелкните **Сохранить**.
2. Нажмите кнопку "..." рядом с книгой, к которой необходимо предоставить доступ.
3. Щелкните **Move to Shared Reports** (Переместить в общие отчеты).

Чтобы опубликовать книгу с помощью ссылки или по электронной почте, нажмите кнопку **Поделиться** в области действия. Имейте в виду, что получателю ссылки потребуется доступ к этому ресурсу на портале Azure, чтобы просмотреть книгу. Чтобы внести изменения, получателям потребуется по крайней мере разрешения участника ресурса.

Чтобы закрепить ссылку на книгу на панели мониторинга Azure, сделайте следующее:

1. На панели действий щелкните **Сохранить**.
2. Нажмите кнопку "..." рядом с книгой, которую требуется закрепить.
3. Щелкните **Закрепить на панели мониторинга**.

## <a name="contributing-workbook-templates"></a>Публикация шаблонов книг

Вы создали отличный шаблон книги и хотите поделиться им с сообществом? Дополнительные сведения см. в нашем [репозитории на GitHub](https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/README.md).

## <a name="next-steps"></a>Дальнейшие действия
- Чтобы обеспечить оптимальное использование, начните отправлять [пользовательские события](https://docs.microsoft.com/azure/application-insights/app-insights-api-custom-events-metrics#trackevent) или [сведения о просмотрах страниц](https://docs.microsoft.com/azure/application-insights/app-insights-api-custom-events-metrics#page-views).
- Если вы уже сделали это, изучите инструменты использования, чтобы узнать, как пользователи используют службу.
    - [Пользователи, сеансы, события](../../azure-monitor/app/usage-segmentation.md)
    - [Воронки](../../azure-monitor/app/usage-funnels.md)
    - [Хранения](../../azure-monitor/app/usage-retention.md)
    - [Маршруты пользователей](../../azure-monitor/app/usage-flows.md)
    - [Добавление контекста пользователей](../../azure-monitor/app/usage-send-user-context.md)
