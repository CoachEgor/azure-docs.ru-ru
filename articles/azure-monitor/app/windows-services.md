---
title: Azure Application Insights для рабочих ролей и служб Windows | Документация Майкрософт
description: Добавьте вручную пакет SDK Application Insights в приложение ASP.NET для анализа использования, доступности и производительности.
services: application-insights
documentationcenter: .net
author: mrbullwinkle
manager: carmonm
ms.assetid: 106ba99b-b57a-43b8-8866-e02f626c8190
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.topic: conceptual
ms.date: 05/15/2017
ms.author: mbullwin
ms.openlocfilehash: 85764c0ee5b8ed117fb191657d54abe5bd10a703
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60784492"
---
# <a name="manually-configure-application-insights-for-net-applications"></a>Настройка Application Insights вручную для приложений .NET

Вы можете настроить [Application Insights](../../azure-monitor/app/app-insights-overview.md) для мониторинга разнообразных приложений, ролей приложений, компонентов или микрослужб. Для веб-приложений и служб Visual Studio предлагает [одноэтапную настройку](../../azure-monitor/app/asp-net.md). Для других типов приложений .NET, таких как внутренние роли сервера или классические приложения, вы можете настроить Application Insights вручную.

![Пример диаграмм мониторинга производительности](./media/windows-services/10-perf.png)

#### <a name="before-you-start"></a>Перед началом работы

Вам необходимы:

* подписка на [Microsoft Azure](https://azure.com). Если у вашей группы или организации есть подписка Azure, владелец может добавить вас в нее с помощью вашей [учетной записи Майкрософт](https://live.com).
* Visual Studio 2013 или более поздняя версия.

## <a name="add"></a>1. Выбор ресурса Application Insights

Ресурс — место, где ваши данные собираются и отображаются на портале Azure. Определитесь, что вам нужно: создать еще один ресурс или совместно использовать имеющийся.

### <a name="part-of-a-larger-app-use-existing-resource"></a>Часть приложение большего размера — используйте существующий ресурс

Если веб-приложение состоит из нескольких компонентов, например интерфейсное веб-приложение и одна или несколько серверных служб, вы должны отправлять телеметрию со всех компонентов в один ресурс. Так они будут отображаться на единой схеме сопоставления приложений, а вы сможете отслеживать запрос от одного компонента к другому.

Если вы уже отслеживаете другие компоненты этого приложения, просто используйте тот же ресурс.

Откройте ресурс на [портале Azure](https://portal.azure.com/). 

### <a name="self-contained-app-create-a-new-resource"></a>Автономное приложение — Создать новый ресурс

Если новое приложение не связано с другими приложениями, оно должно иметь свой ресурс.

Войдите на [портал Azure](https://portal.azure.com/)и создайте новый ресурс Application Insights. Выберите приложение ASP.NET в качестве типа приложения.

![Нажмите "Создать" и "Application Insights"](./media/windows-services/01-new-asp.png)

От выбранного типа приложения зависит содержимое по умолчанию столбцов ресурсов.

## <a name="2-copy-the-instrumentation-key"></a>2. Копирование ключа инструментирования
Ключ идентифицирует ресурс. Вы установите его в пакет SDK для направления данных ресурсу.

![Нажмите «Свойства», выберите ключ и нажмите сочетание клавиш CTRL + C](./media/windows-services/02-props-asp.png)

## <a name="sdk"></a>3. Установка пакета Application Insights в приложении
Установка и настройка пакета Application Insights зависит от платформы, на которой вы работаете. 

1. В Visual Studio щелкните проект правой кнопкой мыши и выберите пункт **Управление пакетами NuGet**.
   
    ![Щелкните проект правой кнопкой мыши и выберите пункт "Управление пакетами Nuget"](./media/windows-services/03-nuget.png)
2. Установите пакет Application Insights Microsoft.ApplicationInsights.WindowsServer. для приложений Windows Server.
   
    ![Поиск Application Insights](./media/windows-services/04-ai-nuget.png)
   
    *Какую версию выбрать?*

    Установите флажок **Включить предварительные выпуски**, если вы хотите воспользоваться нашими новыми функциями. Дополнительные сведения о том, нужна ли вам предварительная версия, см. в соответствующих документах или блогах.
    
    *Можно ли использовать другие пакеты?*
   
    Да. Выберите Microsoft.ApplicationInsights, если вы хотите использовать API для отправки собственной телеметрии. Пакет Windows Server включает API, а также ряд других пакетов, например для сбора данных счетчиков производительности и отслеживания зависимостей. 

### <a name="to-upgrade-to-future-package-versions"></a>Обновление до будущих версий пакета
Время от времени мы выпускаем новую версию пакета SDK.

Чтобы выполнить обновление до [нового выпуска пакета](https://github.com/Microsoft/ApplicationInsights-dotnet-server/releases/), еще раз откройте диспетчер пакетов NuGet и выполните фильтрацию по установленным пакетам. Выберите **Microsoft.ApplicationInsights.WindowsServer**, а затем — **Обновить**.

Если были выполнены какие-либо настройки файла ApplicationInsights.config, то, прежде чем выполнять обновление, сохраните его копию, а затем объедините изменения в новой версии.

## <a name="4-send-telemetry"></a>4. Отправка данных телеметрии
**Если установлен только пакет API:**

* Задайте ключ инструментирования в коде, например в `main()`: 
  
    `TelemetryConfiguration.Active.InstrumentationKey = "` *ваш ключ* `";` 
* [Создайте собственную телеметрию с помощью](../../azure-monitor/app/api-custom-events-metrics.md#ikey).

**Если у вас установлены другие пакеты Application Insights** , ключ инструментирования можно задать с помощью CONFIG-файла:

* Отредактируйте файл ApplicationInsights.config (который был добавлен при установке NuGet). Вставьте следующий фрагмент непосредственно перед закрывающим тегом:
  
    `<InstrumentationKey>` *скопированный ключ инструментирования* `</InstrumentationKey>`
* Убедитесь, что свойства файла ApplicationInsights.config в обозревателе решений имеют следующие значения: **"Действие сборки = содержимое", "Копировать в выходной каталог = копировать"**.

Если вы хотите [изменить ключ для разных конфигураций сборки](../../azure-monitor/app/separate-resources.md), можно задать ключ инструментирования в коде. Если ключ задан в коде, его не нужно задавать в файле `.config`.

## <a name="run"></a>Запуск проекта
Запустите приложение, нажав клавишу **F5**, и попробуйте открывать разные страницы, чтобы создать некоторый объем данных телеметрии.

В Visual Studio вы увидите число отправленных событий.

![Количество событий в Visual Studio](./media/windows-services/appinsights-09eventcount.png)

## <a name="monitor"></a> Просмотр своих данных телеметрии
Вернитесь на [портал Azure](https://portal.azure.com/) и перейдите к своему ресурсу Application Insights.

Выполните поиск данных в диаграммах "Обзор". Сначала вы увидите только одну или две точки. Пример.

![Щелкните плитки, чтобы увидеть больше данных](./media/windows-services/12-first-perf.png)

Щелкните любую диаграмму, чтобы увидеть более подробные метрики. [Дополнительные сведения о метриках.](../../azure-monitor/app/web-monitor-performance.md)

### <a name="no-data"></a>Нет данных?
* Используйте приложение, открывая различные страницы, чтобы создать некоторый объем данных телеметрии.
* Откройте плитку [Поиск](../../azure-monitor/app/diagnostic-search.md) , чтобы просмотреть отдельные события. Иногда для прохождения событий через конвейер метрики требуется чуть больше времени.
* Подождите несколько секунд и нажмите **Обновить**. Диаграмма периодически обновляется, однако ее можно обновить и вручную, если вы ждете появления каких-либо данных.
* См. раздел [Устранение неполадок](../../azure-monitor/app/troubleshoot-faq.md).

## <a name="publish-your-app"></a>Публикация приложения
Теперь разверните свое приложение на сервере или в Azure и наблюдайте за тем, как накапливаются данные.

![Опубликуйте свое веб-приложение с помощью Visual Studio](./media/windows-services/15-publish.png)

При работе в режиме отладки телеметрия передается через конвейер, поэтому данные должны появиться в течение нескольких секунд. При развертывании приложения в конфигурации выпуска данные накапливаются медленнее.

### <a name="no-data-after-you-publish-to-your-server"></a>Отсутствуют данные после публикации на сервере?
Откройте порты для исходящего трафика в брандмауэре сервера. Список необходимых адресов можно просмотреть на [этой странице](https://docs.microsoft.com/azure/application-insights/app-insights-ip-addresses). 

### <a name="trouble-on-your-build-server"></a>Проблемы на сервере сборки?
Изучите [этот элемент устранения неполадок](../../azure-monitor/app/asp-net-troubleshoot-no-data.md#NuGetBuild).

> [!NOTE]
> Если приложение генерирует много телеметрических данных, модуль адаптивной выборки автоматически сокращает объем отправляемых на портал данных, пересылая только репрезентативную часть событий. При этом связанные с тем же запросом события отбираются как группа, что позволяет перемещаться между связанными событиями. 
> [Дополнительная информация о выборке](../../azure-monitor/app/sampling.md).
> 
> 

## <a name="video"></a>Видео

> [!VIDEO https://channel9.msdn.com/events/Connect/2016/100/player]

## <a name="next-steps"></a>Дальнейшие действия
* [добавить дополнительную телеметрию](../../azure-monitor/app/asp-net-more.md) .

