---
title: Непрерывный экспорт данных телеметрии из Application Insights | Документация Майкрософт
description: Экспортируйте данные диагностики и использования в хранилище в Microsoft Azure и загрузите их оттуда.
ms.topic: conceptual
ms.date: 03/25/2020
ms.openlocfilehash: f6afe42e483ab7ad5810169fc301946c75308c29
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "80298289"
---
# <a name="export-telemetry-from-application-insights"></a>Экспорт данных телеметрии из Application Insights
Хотите увеличить период удержания телеметрии или анализировать ее особым образом? Функция "Непрерывный экспорт" идеально подходит для этого. События, которые отображаются на портале Application Insights, можно экспортировать в хранилище Microsoft Azure в формате JSON. После этого можно скачать данные и написать код, необходимый для его обработки.  

Прежде чем настраивать функцию непрерывного экспорта, рассмотрите некоторые альтернативные варианты.

* Кнопка Экспорт в верхней части вкладки "метрики" или "Поиск" позволяет передавать таблицы и диаграммы в электронную таблицу Excel.

* [Аналитика](../../azure-monitor/app/analytics.md) предоставляет эффективный язык запросов для телеметрии и позволяет экспортировать результаты.
* Если вы собираетесь [исследовать данные в Power BI](../../azure-monitor/app/export-power-bi.md ), это можно сделать, не прибегая к непрерывному экспорту.
* [REST API доступа к данным](https://dev.applicationinsights.io/) позволяет получить доступ к телеметрии программным образом.
* Можно также настроить [непрерывный экспорт с помощью PowerShell](https://docs.microsoft.com/powershell/module/az.applicationinsights/new-azapplicationinsightscontinuousexport).

После того, как во время непрерывного экспорта данные будут скопированы в хранилище (где они могут храниться столько, сколько необходимо), они по-прежнему будут доступны в Application Insights в течение обычного [периода хранения](../../azure-monitor/app/data-retention-privacy.md).

## <a name="continuous-export-advanced-storage-configuration"></a>Конфигурация дополнительного хранилища для непрерывного экспорта

Непрерывный экспорт не **поддерживает** следующие функции и конфигурации службы хранилища Azure:

* Использование [брандмауэров виртуальной сети или службы хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-network-security) совместно с хранилищем BLOB-объектов Azure.

* [Неизменяемое хранилище](https://docs.microsoft.com/azure/storage/blobs/storage-blob-immutable-storage) для хранилища BLOB-объектов Azure.

* [Azure Data Lake Storage 2-го поколения](https://docs.microsoft.com/azure/storage/blobs/data-lake-storage-introduction).

## <a name="create-a-continuous-export"></a><a name="setup"></a>Создание непрерывного экспорта

1. В ресурсе Application Insights для приложения в разделе Настройка слева откройте непрерывный экспорт и выберите **Добавить**:

2. Выберите типы данных телеметрии, которые хотите экспортировать.

3. Создайте или выберите [учетную запись хранения Azure](../../storage/common/storage-introduction.md), в которой необходимо сохранить данные. Дополнительные сведения о ценах на хранилище см. на [странице официальных цен](https://azure.microsoft.com/pricing/details/storage/).

     Нажмите кнопку Добавить, выберите пункт назначение экспорта, учетная запись хранения, а затем создайте новое хранилище или выберите существующее.

    > [!Warning]
    > По умолчанию учетная запись хранения будет относиться к тому же географическому региону, что и ресурс Application Insights. Если вы выберете другой регион, может взиматься плата за передачу данных.

4. Создайте или выберите контейнер в хранилище.

После создания параметров экспорта запускается процедура экспорта. Вы получите только те данные, которые поступят после создания параметров экспорта.

Возможна задержка около часа до появления данных в хранилище.

После завершения первого экспорта вы увидите структуру, подобную следующей в контейнере хранилища BLOB-объектов Azure: (это зависит от собираемых данных.)

|Имя | Описание |
|:----|:------|
| [Доступность](export-data-model.md#availability) | Это свойство создает отчеты о [веб-тестах на доступность](../../azure-monitor/app/monitor-web-app-availability.md).  |
| [Журнале](export-data-model.md#events) | Пользовательские события, создаваемые элементом [TrackEvent()](../../azure-monitor/app/api-custom-events-metrics.md#trackevent). 
| [Исключения](export-data-model.md#exceptions) |Отправляются сведения об [исключениях](../../azure-monitor/app/asp-net-exceptions.md) на сервере и в браузере.
| [Сообщения](export-data-model.md#trace-messages) | Отправитель: [TrackTrace](../../azure-monitor/app/api-custom-events-metrics.md#tracktrace) и [адаптеры ведения журналов](../../azure-monitor/app/asp-net-trace-logs.md).
| [Метрики](export-data-model.md#metrics) | Создается вызовами API метрик.
| [PerformanceCounters](export-data-model.md) | Счетчики производительности, собранные Application Insights.
| [Запросы](export-data-model.md#requests)| Отправитель: [TrackRequest](../../azure-monitor/app/api-custom-events-metrics.md#trackrequest). Используется стандартными модулями для создания отчетов о времени отклика сервера (измеряется на сервере).| 

### <a name="to-edit-continuous-export"></a>Изменение непрерывного экспорта

Щелкните непрерывный экспорт и выберите учетную запись хранения для изменения.

### <a name="to-stop-continuous-export"></a>Остановка непрерывного экспорта

Чтобы остановить экспорт, нажмите кнопку "Отключить". При повторном нажатии кнопки включения экспорт будет повторно запущен с новыми данными. Пока экспорт был отключен, вы не будете получать данные, которые поступают на портал.

Чтобы остановить экспорт навсегда, удалите его. Это действие не повлечет удаление данных из хранилища.

### <a name="cant-add-or-change-an-export"></a>Не удается добавить или изменить параметры экспорта?
* Чтобы добавить или изменить экспорты, необходимо быть владельцем, участником или Application Insights правами доступа участника. [Дополнительные сведения о ролях][roles].

## <a name="what-events-do-you-get"></a><a name="analyze"></a> Какие события вы получаете?
Экспортированные данные представляют собой необработанную телеметрию, получаемую из приложения, за исключением добавления данных расположения, которые рассчитываются по IP-адресу клиента.

Данные, которые были отклонены [выборкой](../../azure-monitor/app/sampling.md) , не включаются в экспортированные данные.

Другие вычисляемые метрики не включаются. Например, мы не экспортируем показатель среднего использования ЦП, но экспортируем необработанные данные телеметрии, на основе которых можно вычислить это среднее значение.

Данные также содержат результаты любого настроенного [веб-теста доступности](../../azure-monitor/app/monitor-web-app-availability.md).

> [!NOTE]
> **Ресамплинга.** Если ваше приложение отправляет большие объемы данных, может сработать функция выборки и отправить только часть вашей телеметрии. [Дополнительная информация о выборке.](../../azure-monitor/app/sampling.md)
>
>

## <a name="inspect-the-data"></a><a name="get"></a> Изучение данных
Проверить хранилище можно непосредственно на портале. Щелкните Главная в крайнем левом меню в верхней части окна, где указано "службы Azure" выберите **учетные записи хранения**, выберите имя учетной записи хранения, на странице Обзор выберите **BLOB-объекты** в разделе службы, а затем выберите имя контейнера.

Чтобы проверить службу хранилища Azure в Visual Studio, выберите меню **Представление** и щелкните **Cloud Explorer**. (Если этой команды нет в меню, установите пакет SDK для Azure: откройте диалоговое окно **Создание проекта**, разверните узел "Visual C#/Облако" и выберите **Get Microsoft Azure SDK for .NET** (Получить пакет Microsoft Azure SDK для .NET).)

При открытии хранилища больших двоичных объектов вы увидите контейнер с набором файлов больших двоичных объектов. URI для каждого файла основан на имени ресурса Application Insights, ключе инструментирования, типе телеметрии, дате и времени. (Имя ресурса содержит только строчные буквы, в ключе инструментирования опускаются дефисы).

![Проверьте хранилище больших двоичных объектов с помощью подходящего средства.](./media/export-telemetry/04-data.png)

Дата и время имеют формат UTC и соответствуют моменту, когда элемент телеметрии был внесен в хранилище (не моменту его создания). Поэтому при написании кода для загрузки данных можно линейно перемещаться по данным.

Путь имеет следующий вид.

    $"{applicationName}_{instrumentationKey}/{type}/{blobDeliveryTimeUtc:yyyy-MM-dd}/{ blobDeliveryTimeUtc:HH}/{blobId}_{blobCreationTimeUtc:yyyyMMdd_HHmmss}.blob"

Where

* `blobCreationTimeUtc`время создания большого двоичного объекта во внутреннем промежуточном хранилище
* `blobDeliveryTimeUtc` — время копирования большого двоичного объекта в целевое хранилище экспорта.

## <a name="data-format"></a><a name="format"></a>Формат данных
* Каждый большой двоичный объект является текстовым файлом, который содержит несколько строк, разделенных символом новой строки "\n". Он содержит данные телеметрии, обрабатываемые примерно раз в 30 секунд.
* Каждая строка представляет точку данных телеметрии, например просмотр страницы или запроса.
* Каждая строка представляет собой неформатированный JSON-документ. Если вы хотите просмотреть его, откройте документ в Visual Studio и последовательно выберите "Правка", "Дополнительно", "Формат файла":

![Просмотрите данные телеметрии с помощью подходящего средства.](./media/export-telemetry/06-json.png)

Продолжительность времени измеряется в тактах, где 10 000 тактов составляют 1 мс. Например, следующие значения показывают время 1 мс для отправки запроса из браузера, 3 мс для его получения и 1,8 с для обработки страницы в браузере.

    "sendRequest": {"value": 10000.0},
    "receiveRequest": {"value": 30000.0},
    "clientProcess": {"value": 17970000.0}

[Подробный справочник по модели данных типов и значений свойств.](export-data-model.md)

## <a name="processing-the-data"></a>Обработка данных
Для небольших объемов данных можно написать код, который будет выделять элементы данных, записывать их в электронную таблицу и т. д. Пример:

    private IEnumerable<T> DeserializeMany<T>(string folderName)
    {
      var files = Directory.EnumerateFiles(folderName, "*.blob", SearchOption.AllDirectories);
      foreach (var file in files)
      {
         using (var fileReader = File.OpenText(file))
         {
            string fileContent = fileReader.ReadToEnd();
            IEnumerable<string> entities = fileContent.Split('\n').Where(s => !string.IsNullOrWhiteSpace(s));
            foreach (var entity in entities)
            {
                yield return JsonConvert.DeserializeObject<T>(entity);
            }
         }
      }
    }

Больший пример кода см. в статье [Пошаговое руководство. Экспорт в SQL из Application Insights с использованием Stream Analytics][exportasa].

## <a name="delete-your-old-data"></a><a name="delete"></a>Удаление старых данных
Вы несете ответственность за управление емкостью хранилища и удаление старых данных при необходимости.

## <a name="if-you-regenerate-your-storage-key"></a>При повторном создании ключа хранилища...
Если изменить ключ хранилища, непрерывный экспорт перестанет работать. Вы увидите уведомление в учетной записи Azure.

Откройте вкладку непрерывный экспорт и измените экспорт. Измените параметр назначения экспорта, но оставьте выбранным то же самое хранилище. Нажмите кнопку "ОК" для подтверждения.

Непрерывный экспорт будет перезапущен.

## <a name="export-samples"></a>Примеры экспорта

* [Экспорт в SQL с использованием Stream Analytics][exportasa]
* [Пример 2 с использованием Stream Analytics](export-stream-analytics.md)

Для больших объемов данных рассмотрите возможность использования [HDInsight](https://azure.microsoft.com/services/hdinsight/) – кластеров Hadoop в облаке. HDInsight предусматривает широкий набор технологий для анализа больших объемов данных и управления ими. Кроме того, решение можно использовать для обработки данных, экспортированных из Application Insights.

## <a name="q--a"></a>Вопросы и ответы
* *Все, что мне требуется, – всего лишь один раз загрузить диаграмму.*  

    Да, это можно сделать. В верхней части вкладки щелкните **Export Data (экспорт данных**).
* *Параметры экспорта настроены, но в хранилище нет данных.*

    Получала ли служба Application Insights какие-либо данные телеметрии из вашего приложения с момента настройки параметров экспорта? Вы получите только новые данные.
* *Я попытался настроить параметры экспорта, но было отказано в доступе.*

    Если учетная запись принадлежит организации, необходимо быть членом группы владельцев или участников.
* *Могу ли я экспортировать данные непосредственно в свое локальное хранилище?*

    Нет. Наш механизм экспорта в настоящее время работает только для хранилища Azure.  
* *Существует ли предел для объема данных, помещаемых в мое хранилище?*

    Нет. Мы будем хранить переданные данные в хранилище, пока вы не удалите данные экспорта. Мы остановим передачу данных, если столкнемся с внешними ограничениями для хранилища больших двоичных объектов, но хранилище очень большое. Вы можете настроить объем используемого хранилища.  
* *Сколько больших двоичных объектов отображается в хранилище?*

  * Для каждого типа данных, выбранных для экспорта, каждую минуту создается новый большой двоичный объект (при наличии данных).
  * Кроме того, для приложений с высоким трафиком выделяются дополнительные единицы разделов. В этом случае каждая единица создает большой двоичный объект каждую минуту.
* *После повторного создания ключа для моего хранилища или изменения имени контейнера экспорт больше не работает.*

    Измените экспорт и откройте вкладку назначение экспорта. Оставьте выбранное хранилище, а затем нажмите кнопку ОК для подтверждения. Экспорт будет перезапущен. Если это изменение было сделано в течение последних нескольких дней, данные не будут потеряны.
* *Можно ли приостановить экспорт?*

    Да. Нажмите кнопку "Отключить".

## <a name="code-samples"></a>Примеры кода

* [Пример с использованием Stream Analytics](export-stream-analytics.md).
* [Экспорт в SQL с использованием Stream Analytics][exportasa]
* [Подробный справочник по модели данных типов и значений свойств.](export-data-model.md)

<!--Link references-->

[exportasa]: ../../azure-monitor/app/code-sample-export-sql-stream-analytics.md
[roles]: ../../azure-monitor/app/resources-roles-access-control.md
