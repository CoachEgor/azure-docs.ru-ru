---
title: Проблемы устранения неполадок с профилером Azure Application Insights
description: В этой статье содержатся инструкции по устранению неполадок и сведения, помогающие разработчикам в решении проблем с включением или использованием Application Insights Profiler.
ms.topic: conceptual
author: cweining
ms.author: cweining
ms.date: 08/06/2018
ms.reviewer: mbullwin
ms.openlocfilehash: f284d4dfbe550c357f81c01fa0a66aa9878b6c1e
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77671568"
---
# <a name="troubleshoot-problems-enabling-or-viewing-application-insights-profiler"></a>Устранение неполадок по включению и просмотру Application Insights Profiler

## <a name="active-issues"></a>Активные проблемы

* Профилирование для ASP.NET приложений Core 3.x пока не поддерживается.
  * Если вы должны иметь Profiler на, обходной путь заключается в использовании [приложения Insights Profiler для ASP.NET Core](https://github.com/microsoft/ApplicationInsights-Profiler-AspNetCore). Профайлер помечен для Linux, но он также работает с приложениями .NET Core 3.0 на Windows. Для получения подробной информации [см.](https://github.com/microsoft/ApplicationInsights-Profiler-AspNetCore#supported-versions)

## <a name="general-troubleshooting"></a><a id="troubleshooting"></a>Общие действия по устранению неполадок

### <a name="profiles-are-uploaded-only-if-there-are-requests-to-your-application-while-profiler-is-running"></a>Профили загружаются только в том случае, если есть запросы к вашему приложению во время работы Profiler

Azure Application Insights Profiler собирает данные профилирования в течение двух минут каждый час. Он также собирает данные, когда вы нажимаете кнопку **Профилировать** на панели **Configure Application Insights Profiler** (Настройка Application Insights Profiler). Но данные профилирования отправляются только тогда, когда их можно привязать к запросу, который появился во время работы Profiler. 

Profiler записывает сообщения трассировки и пользовательские события в ресурс Application Insights. Можно использовать эти события, чтобы просмотреть работу Profiler. Если предполагается, что Profiler должен работать и захватывать трассировки, но они не отображаются на странице **Производительность**, вы можете проверить работу Profiler с помощью таких действий.

1. Выполните поиск сообщений трассировки и пользовательских событий, записанных с помощью Profiler в ресурс Application Insights. Можно использовать эту строку для поиска необходимых данных:

    ```
    stopprofiler OR startprofiler OR upload OR ServiceProfilerSample
    ```
    На приведенном ниже снимке экрана показан пример выполнения двух операций поиска на двух разных ресурсах ИИ. 
    
   * В левой части приведено приложение, которое не получает запросы во время работы Profiler. Отображается сообщение со сведениями о том, что отправка была отменена из-за отсутствия действий. 

   * Справа можно увидеть, что Profiler запущен и уже отправил пользовательские события при обнаружении запросов, которые появились во время его работы. Если отображается пользовательское событие ServiceProfilerSample, это означает, что Profiler вложил трассировку в запрос и вы можете просмотреть трассировку на панели **производительности Application Insights**.

     Если вы не видите никакой телеметрии вообще, то Profiler не работает. Вам потребуется прочитать разделы по устранению неполадок для конкретного типа приложения, приведенные ниже в этой статье.  

     ![Поиск данных телеметрии Profiler][profiler-search-telemetry]

1. Если запросы возникают во время работы Profiler, убедитесь, что они обрабатываются в рамках вашего приложения, в котором включен Profiler. Хотя приложения иногда состоят из нескольких компонентов, Profiler доступен только для некоторых из них. На панели **Configure Application Insights Profiler** (Настройка Application Insights Profiler) отобразятся компоненты с отправленной трассировкой.

### <a name="other-things-to-check"></a>Что нужно еще проверить:
* Проверьте, работает ли приложение на платформе .NET Framework 4.6.
* Если веб-приложение является приложением ASP.NET Core, оно должно работать под управлением ASP.NET Core 2.0.
* Если данные, которые вы пытаетесь просмотреть, хранятся дольше нескольких недель, попробуйте ограничить фильтр времени и повторите попытку. Трассировки удаляются через 7 дней.
* Убедитесь, что доступ к https://gateway.azureserviceprofiler.net для прокси-серверов или брандмауэра не заблокирован.
* Профиль не поддерживается в бесплатных или общих планах обслуживания приложений. Если вы используете один из этих планов, попробуйте масштабирование до одного из основных планов и Profiler должен начать работать.

### <a name="double-counting-in-parallel-threads"></a><a id="double-counting"></a>Двойной подсчет в параллельных потоках

В некоторых случаях значение метрики общего времени в средстве просмотра стека больше, чем длительность запроса.

Это может произойти при наличии нескольких потоков, связанных с запросом и работающих в параллельном режиме. В таком случае общее время потока будет больше затраченного времени. Один поток может ожидать завершения другого. Средство просмотра пытается это обнаружить и исключить ненужное ожидание. При этом вместо исключения отображается слишком много сведений. Это могут быть критически важные сведения.

Обнаружив параллельные потоки в трассировках, укажите, какие потоки находятся в состоянии ожидания, чтобы можно было определить критический путь к запросу. Обычно поток, который быстро переходит в состояние ожидания, просто ожидает другие потоки. Сосредоточьтесь на других потоках и игнорируйте время ожидания потоков.

### <a name="error-report-in-the-profile-viewer"></a>Отчет об ошибках в средстве просмотра данных о профилировании
Отправьте запрос в службу поддержки на портале. Обязательно укажите идентификатор корреляции из сообщения об ошибке.

## <a name="troubleshoot-profiler-on-azure-app-service"></a>Устранение проблем с Profiler в Службе приложений Azure
Для правильной работы Profiler:
* Необходимо использовать план службы веб-приложений уровня "Базовый" или выше.
* Для веб-приложения нужно включить Application Insights.
* Ваше веб-приложение должно иметь следующие настройки приложения:

    |Параметр приложения    | Значение    |
    |---------------|----------|
    |APPINSIGHTS_INSTRUMENTATIONKEY         | iKey для ресурса Application Insights    |
    |APPINSIGHTS_PROFILERFEATURE_VERSION | 1.0.0 |
    |DiagnosticServices_EXTENSION_VERSION | No 3 |


* Веб-задание **ApplicationInsightsProfiler3** должно быть запущено. Чтобы проверить веб-задание:
   1. Перейдите к [Kudu](https://blogs.msdn.microsoft.com/cdndevs/2015/04/01/the-kudu-debug-console-azure-websites-best-kept-secret/).
   1. В меню **Tools** (Средства) выберите **WebJobs Dashboard** (Панель мониторинга веб-заданий).  
      Откроется область **WebJobs** (Веб-задания). 
   
      ![profiler-webjob]   
   
   1. Для просмотра деталей webjob, включая журнал, выберите ссылку **ApplicationInsightsProfiler3.**  
     Откроется область **Continuous WebJob Details** (Сведения о непрерывных веб-заданиях).

      ![profiler-webjob-log]

Если вы не можете понять, почему Profiler не работает для вас, вы можете скачать журнал и отправить его в нашу команду за помощью, serviceprofilerhelp@microsoft.com. 
    
### <a name="manual-installation"></a>Ручная установка

При настройке профилировщика в параметры веб-приложения вносятся обновления. Обновления можно применить вручную, если этого требует ваша среда. Например, если приложение выполняется в среде веб-приложений для PowerApps. Чтобы применять обновления вручную:

1. В панели **управления веб-приложений,** **открытые настройки**.

1. Установите **рамочную версию .NET** до **v4.6**.

1. Установите для параметра **Всегда включено** значение **Включено**.
1. Создайте эти настройки приложения:

    |Параметр приложения    | Значение    |
    |---------------|----------|
    |APPINSIGHTS_INSTRUMENTATIONKEY         | iKey для ресурса Application Insights    |
    |APPINSIGHTS_PROFILERFEATURE_VERSION | 1.0.0 |
    |DiagnosticServices_EXTENSION_VERSION | No 3 |

### <a name="too-many-active-profiling-sessions"></a>Слишком много активных сеансов профилирования

Сейчас вы можете включить профилировщик не более, чем в четырех веб-приложениях Azure и слотах развертывания, работающих в рамках одного плана службы. Если в рамках одного плана службы приложений у вас работает больше четырех веб-приложений, Profiler может вызвать исключение *Microsoft.ServiceProfiler.Exceptions.TooManyETWSessionException*. Profiler запускается отдельно для каждого веб-приложения и пытается запустить сеанс трассировки событий Windows (ETW) для каждого приложения. Существует ограничение на количество сеансов ETW, выполняемых одновременно. Если веб-задание Profiler содержит слишком много активных сеансов профилирования, то перенесите некоторые веб-приложения в другой план службы.

### <a name="deployment-error-directory-not-empty-dhomesitewwwrootapp_datajobs"></a>Ошибка развертывания: каталог не пустой "D:\\домашний\\сайт\\wwwroot\\App_Data\\jobs"

При повторном развертывании в ресурсе веб-приложений с включенным Profiler может отобразиться сообщение, содержащее сведения о следующей ошибке:

*Каталог не пустой\\'D: домашний\\сайт\\wwwroot\\App_Data\\рабочих мест'*

Эта ошибка происходит при запуске веб-развертывания с помощью сценариев или в конвейере развертывания Azure DevOps. Чтобы устранить эту проблему, необходимо добавить приведенные ниже параметры развертывания в задачу веб-развертывания.

```
-skip:Directory='.*\\App_Data\\jobs\\continuous\\ApplicationInsightsProfiler.*' -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data\\jobs\\continuous$' -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data\\jobs$'  -skip:skipAction=Delete,objectname='dirPath',absolutepath='.*\\App_Data$'
```

Эти параметры удаляют папку, используемую Application Insights Profiler, и разблокируют процесс повторного развертывания. Текущий запущенный экземпляр профилировщика не будет затронут.

### <a name="how-do-i-determine-whether-application-insights-profiler-is-running"></a>Как определить, работает ли Application Insights Profiler?

Profiler запускается в качестве непрерывного веб-задания в веб-приложении. Вы можете открыть веб-ресурс приложения на [портале Azure](https://portal.azure.com). Проверьте состояние **ApplicationInsightsProfiler** в области **Веб-задания**. Если он не работает, откройте **Журналы**, чтобы просмотреть дополнительные сведения.

## <a name="troubleshoot-problems-with-profiler-and-azure-diagnostics"></a>Устранение неполадок с Profiler и системой диагностики Azure

>**Исправлена ошибка в профилировщике, который поставляется в WAD для облачных служб.** Последняя версия WAD (1.12.2.0) для облачных служб работает со всеми последними версиями App Insights SDK. Хосты облачных сервисов будут обновлять WAD автоматически, но это не немедленно. Чтобы заставить обновить, вы можете передислоцировать службу или перезагрузить узла.

Существуют три шага, чтобы проверить, что Profiler настроен правильно с помощью системы диагностики Azure. 
1. Сначала убедитесь, что содержимое развернутой конфигурации системы диагностики Azure соответствует вашим ожиданиям. 

1. Во-вторых, убедитесь, что система диагностики Azure передает правильный ключ инструментирования iKey в командной строке Profiler. 

1. В-третьих, просмотрите файл журнала Profiler, чтобы выяснить, почему Profiler получает ошибку при работе. 

Чтобы проверить параметры, которые использовались для системы диагностики Azure:

1. Войдите в виртуальную машину (VM), а затем откройте файл журнала в этом месте. (Диск может быть c: или d: и плагин версия может быть другой.)

    ```
    c:\logs\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\1.11.3.12\DiagnosticsPlugin.log  
    ```
    или диспетчер конфигурации служб
    ```
    c:\WindowsAzure\logs\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\1.11.3.12\DiagnosticsPlugin.log
    ```

1. В этом файле в строке **WadCfg** вы найдете параметры, которые были переданы на виртуальную машину для настройки системы диагностики Azure. Можно проверить правильность ключа инструментирования, который используется в приемнике Profiler.

1. Проверьте командную строку, которая используется для запуска Profiler. Аргументы, которые используются для запуска Profiler, находятся в следующем файле. (Диск может быть c: или d:)

    ```
    D:\ProgramData\ApplicationInsightsProfiler\config.json
    ```

1. Проверьте правильность ключа инструментирования ikey в командной строке Profiler. 

1. Используя путь, обнаруженный в файле *config.json* выше, проверьте файл журнала Profiler. Он отобразит информацию об отладке, включающую параметры, используемые Profiler. Также отобразятся сообщения о состоянии и ошибках из Profiler.  

    Если Профиль работает во время получения запросов в приложении, отображается следующее сообщение: *активность, обнаруженная в iKey.* 

    При загрузке трассы отображается следующее сообщение: *Начните загружать след.* 


## <a name="edit-network-proxy-or-firewall-rules"></a>Изменение правил прокси-сервера сети или брандмауэра

Если приложение подключается к Интернету через прокси или брандмауэр, возможно, потребуется изменить правила, чтобы позволить приложению общаться с службой Profiler Application Insights. ИТ-файлы, используемые профилем Application Insights, включены в тег службы Azure Monitor.


[profiler-search-telemetry]:./media/profiler-troubleshooting/Profiler-Search-Telemetry.png
[profiler-webjob]:./media/profiler-troubleshooting/Profiler-webjob.png
[profiler-webjob-log]:./media/profiler-troubleshooting/Profiler-webjob-log.png








