---
title: Отладчик моментальных снимков Azure Application Insights для приложений .NET | Документация Майкрософт
description: Отладочные моментальные снимки автоматически собираются при порождении исключений в рабочих приложениях .NET
services: application-insights
documentationcenter: ''
author: mrbullwinkle
manager: carmonm
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.topic: conceptual
ms.reviewer: brahmnes
ms.date: 03/07/2019
ms.author: mbullwin
ms.openlocfilehash: 4157285e8af67acd1dc3627bebc12076d7fe072c
ms.sourcegitcommit: 1fbc75b822d7fe8d766329f443506b830e101a5e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/14/2019
ms.locfileid: "65595556"
---
# <a name="debug-snapshots-on-exceptions-in-net-apps"></a>Отладочные моментальные снимки для исключений в приложениях .NET
При возникновении исключения, можно автоматически собирать отладочный моментальный снимок из работающего веб-приложения. Моментальный снимок отображает состояние исходного кода и переменных в момент порождения этого исключения. Отладчик моментальных снимков (предварительная версия) в [Azure Application Insights](../../azure-monitor/app/app-insights-overview.md) отслеживает телеметрию исключений, поступающую из веб-приложения. Он собирает моментальные снимки для наиболее частых исключений, чтобы предоставить вам необходимые сведения для диагностики проблем в рабочей среде. Добавьте [пакет NuGet сборщика моментальных снимков](https://www.nuget.org/packages/Microsoft.ApplicationInsights.SnapshotCollector) в приложение и, при необходимости, настройте параметры сбора в файле [ApplicationInsights.config](../../azure-monitor/app/configuration-with-applicationinsights-config.md). Моментальные снимки для [исключений](../../azure-monitor/app/asp-net-exceptions.md) отображаются на портале Application Insights.

Вы можете просмотреть отладочные моментальные снимки на портале, чтобы изучить стек вызовов и проверить значения переменных в каждом кадре стека вызовов. Чтобы получить более мощными средствами отладки исходного кода, откройте моментальные снимки в Visual Studio Enterprise 2019 г. В Visual Studio можно также [настроить точки прикрепления для интерактивного создания моментальных снимков](https://aka.ms/snappoint) без ожидания исключения.

Моментальные снимки отладки хранятся в течение семи дней. Такая политика хранения задается для каждого приложения отдельно. Если нужно изменить этот параметр, вы можете запросить изменения, открыв окно Службы Поддержки на портале Microsoft Azure.

## <a name="enable-application-insights-snapshot-debugger-for-your-application"></a>Включить отладчик моментальных снимков Application Insights для приложения
Коллекция моментальных снимков доступна для:
* .NET Framework и приложений ASP.NET выполняющихся с помощью .NET Framework 4.5 или более поздней версии.
* .NET Core 2.0 и приложений ASP.NET Core 2.0 под управлением Windows.

Поддерживаются следующие среды:

* [службе приложений Azure](snapshot-debugger-appservice.md?toc=/azure/azure-monitor/toc.json)
* [Облачные службы Azure](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json) под управлением ОС семейства 4 или более поздней версии
* [Службы Azure Service Fabric](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json) на Windows Server 2012 R2 или более поздней версии
* [Наборы масштабирования виртуальных машин и виртуальных машин Azure](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json) под управлением Windows Server 2012 R2 или более поздней версии
* [Локальных виртуальных или физических машин](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json) под управлением Windows Server 2012 R2 или более поздней версии

> [!NOTE]
> Клиентские приложения (например, WPF, Windows Forms или UWP) не поддерживаются.

Если вы включили отладчик моментальных снимков, но не видите моментальные снимки, проверьте наших [руководство по устранению неполадок](snapshot-debugger-troubleshoot.md?toc=/azure/azure-monitor/toc.json).

## <a name="grant-permissions"></a>Предоставление разрешений

Доступ к моментальным снимкам защищен с помощью управления доступом на основе ролей (RBAC). Чтобы проверить моментальный снимок, вы сначала должны быть добавлены к нужной роли владельцем подписки.

> [!NOTE]
> Владельцы и участники не получают эту роль автоматически. При необходимости просмотреть моментальные снимки нужно самостоятельно добавиться к роли.

Владельцам подписки следует назначить роль `Application Insights Snapshot Debugger` пользователям, которые будут проверять моментальные снимки. Владельцы подписок могут назначить эту роль отдельным пользователям или группам для целевого ресурса Application Insights или его группы ресурсов или подписки.

1. Перейдите к ресурсу Application Insights на портале Azure.
1. Щелкните **Управление доступом (IAM)**.
1. Нажмите кнопку **+Добавить назначение ролей**.
1. В раскрывающемся списке **Роли** выберите **Отладчик моментальных снимков Application Insights**.
1. Выполните поиск и введите имя пользователя, который будет добавлен.
1. Нажмите кнопку **Сохранить**, чтобы добавить пользователя к роли.


> [!IMPORTANT]
> Моментальные снимки могут содержать личные и другие конфиденциальные данные в значениях переменных и параметров.

## <a name="view-snapshots-in-the-portal"></a>Просмотр моментальных снимков на портале

Возникло исключение в приложении, и был создан моментальный снимок, должна быть моментальные снимки для просмотра. Может занять 5 – 10 минут с исключением, сформированным к моментальному снимку готова и можно просмотреть на портале. Чтобы просмотреть моментальные снимки, в **сбоя** области выберите **операций** кнопку при просмотре **операций** , или откройте вкладку **исключения**кнопку при просмотре **исключения** вкладке:

![Страницы ошибок](./media/snapshot-debugger/failures-page.png)

Выберите операцию или исключение в области справа, чтобы открыть **сведения о транзакциях End-to-End** области, а затем выберите событие исключения. Если моментальный снимок доступен для заданного исключения, **открыть моментальный снимок отладки** кнопка отображается на правой панели со сведениями для [исключение](../../azure-monitor/app/asp-net-exceptions.md).

![Кнопка "Open Debug Snapshot" (Открыть отладочный моментальный снимок) для исключения](./media/snapshot-debugger/e2e-transaction-page.png)

В представлении "Debug Snapshot" (Отладочный моментальный снимок) можно увидеть стек вызовов и область переменных. При выборе кадров стека вызовов в области стека вызовов можно просматривать локальные переменные и параметры для этого вызова функции в области переменных.

![Просмотр отладочного моментального снимка на портале](./media/snapshot-debugger/open-snapshot-portal.png)

Моментальные снимки могут содержать конфиденциальные сведения и по умолчанию не отображаются. Для просмотра моментальных снимков вам должна быть назначена роль `Application Insights Snapshot Debugger`.

## <a name="view-snapshots-in-visual-studio-2017-enterprise-or-above"></a>Просмотр моментальных снимков в Visual Studio 2017 Enterprise или более поздней версии
1. Нажмите кнопку **скачать моментальный снимок** кнопку, чтобы загрузить `.diagsession` файл, который можно открыть в Visual Studio Enterprise.

2. Чтобы открыть `.diagsession` файл, необходимо быть установлен компонент Visual Studio отладчик моментальных снимков. Компонент отладчика моментальных снимков — это необходимый компонент рабочая нагрузка ASP.net в Visual Studio и могут быть выбраны из списка отдельных компонентов в установщике Visual Studio. Если вы используете версию Visual Studio до Visual Studio 2017 версии 15.5, необходимо установить расширение из [Visual Studio Marketplace](https://aka.ms/snapshotdebugger).

3. После открытия файла моментального снимка в Visual Studio появится страница мини-дампа отладки. Щелкните **Debug Managed Code** (Отладить управляемый код), чтобы начать отладку моментального снимка. Откроется строка кода, на которой было порождено исключение, и вы сможете выполнить отладку текущего состояния процесса.

    ![Просмотр отладочного моментального снимка в Visual Studio](./media/snapshot-debugger/open-snapshot-visualstudio.png)

Загруженный моментальный снимок содержит все файлы символов, найденные на сервере веб-приложения. Эти файлы символов требуются для связывания данных моментального снимка с исходным кодом. Для приложений службы приложений не забудьте включить развертывание символов при публикации веб-приложения.

## <a name="how-snapshots-work"></a>Как работают моментальные снимки

Сборщик моментальных снимков реализуется в виде [обработчика телеметрии Application Insights](../../azure-monitor/app/configuration-with-applicationinsights-config.md#telemetry-processors-aspnet). При запуске приложения обработчик телеметрии как компонент сборщика моментальных снимков добавляется в конвейер телеметрии вашего приложения.
Каждый раз, когда приложение вызывает [TrackException](../../azure-monitor/app/asp-net-exceptions.md#exceptions), сборщик моментальных снимков вычисляет идентификатор проблемы из типа вызываемого исключения и метод создания исключения.
При этом значение счетчика увеличивается для соответствующего идентификатора проблемы. Когда счетчик достигает значения `ThresholdForSnapshotting`, идентификатор проблемы добавляется в план сбора.

Сборщик Snapshot Collector также отслеживает исключения во время их создания, используя подписку на событие [AppDomain.CurrentDomain.FirstChanceException](https://docs.microsoft.com/dotnet/api/system.appdomain.firstchanceexception). При возникновении этого события идентификатор проблемы исключения вычисляется и сравнивается с идентификаторами в плане сбора.
Если обнаружено соответствие, создается моментальный снимок выполняющегося процесса. Моментальному снимку назначается уникальный идентификатор, и к исключению добавляется метка с этим идентификатором. После возврата ответа обработчиком FirstChanceException вызванное исключение обрабатывается в обычном режиме. Со временем исключение снова достигает метода TrackException. Тогда оно вместе с идентификатором моментального снимка сообщается в Application Insights.

Основной процесс продолжает выполняться и обслуживать трафик для пользователей с небольшим прерыванием. Тем временем моментальный снимок передается в процесс передачи моментальных снимков. Отправитель моментальных снимков создает минидамп и передает его в Application Insights вместе с соответствующими PDB-файлами символов.

> [!TIP]
> - Моментальный снимок процесса — это приостановленный клон выполняющегося процесса.
> - Создание моментального снимка занимает около 10–20 мс.
> - Значение по умолчанию для `ThresholdForSnapshotting` — 1. Это минимальное значение. Таким образом, прежде чем будет создан моментальный снимок, приложение должно вызвать то же исключение **дважды**.
> - Задайте для `IsEnabledInDeveloperMode` значение true, если требуется создавать моментальные снимки во время отладки в Visual Studio.
> - Частота создания моментальных снимков ограничивается параметром `SnapshotsPerTenMinutesLimit`. По умолчанию установлено ограничение — один моментальный снимок каждые десять минут.
> - Можно отправлять не более 50 моментальных снимков в день.

## <a name="limitations"></a>Ограничения

Срок хранения данных по умолчанию — 15 дней. Для каждого экземпляра Application Insights максимальное число 50 снимков допускается в день.

### <a name="publish-symbols"></a>Публикация символов
Отладчику моментальных снимков требуется наличие файлов символов на рабочем сервере для декодирования переменных и обеспечения возможности отладки в Visual Studio.
Выпуск 15.2 (или выше) приложения Visual Studio 2017 по умолчанию публикует символы для сборок выпуска при публикации в службе приложений. В предыдущих версиях в профиль публикации `.pubxml` необходимо добавить приведенную ниже строку, чтобы символы публиковались в режиме выпуска.

```xml
    <ExcludeGeneratedDebugSymbol>False</ExcludeGeneratedDebugSymbol>
```

Для службы вычислений Azure и других типов служб файлы символов должны находиться в одной папке с DLL-файлом основного приложения (как правило, `wwwroot/bin`) или быть доступными по текущему пути.

### <a name="optimized-builds"></a>Оптимизированные сборки
В некоторых случаях локальные переменные не могут отображаться в сборках выпуска из-за оптимизаций, примененных JIT-компиляторов.
Однако в службах приложений Azure сборщик моментальных снимков может деоптимизировать методы создания исключений, которые являются частью плана сбора.

> [!TIP]
> Установите расширение сайта Application Insights в службе приложений для получения поддержки деоптимизации.

## <a name="next-steps"></a>Дальнейшие действия
Включите Application Insights Snapshot Debugger для вашего приложения:

* [службе приложений Azure](snapshot-debugger-appservice.md?toc=/azure/azure-monitor/toc.json)
* [Облачные службы Azure](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json)
* [Службы Azure Service Fabric](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json)
* [Профилирование веб-приложений, работающих на виртуальной машине Azure или в масштабируемом наборе виртуальных машин, с помощью Application Insights Profiler](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json)
* [Локальных виртуальных или физических компьютеров](snapshot-debugger-vm.md?toc=/azure/azure-monitor/toc.json)

Помимо Application Insights Snapshot Debugger:
 
* [Установите в коде точки прикрепления](https://docs.microsoft.com/visualstudio/debugger/debug-live-azure-applications), чтобы получать моментальные снимки не ожидая исключений.
* В статье [Диагностика исключений в веб-приложениях с помощью Application Insights](../../azure-monitor/app/asp-net-exceptions.md) объясняется, как отобразить дополнительные исключения в Application Insights.
* В статье [Интеллектуальное обнаружение в Application Insights](../../azure-monitor/app/proactive-diagnostics.md) описывается автоматическое обнаружение аномалий производительности.
