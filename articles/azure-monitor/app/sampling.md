---
title: Выборка данных телеметрии в Azure Application Insights | Документация Майкрософт
description: Как управлять объемом данных телеметрии.
ms.service: azure-monitor
ms.subservice: application-insights
ms.topic: conceptual
author: mrbullwinkle
ms.author: mbullwin
ms.date: 03/14/2019
ms.reviewer: vitalyg
ms.openlocfilehash: d07bb9b69f022da98b3d46e3e36f4c4de2b4d006
ms.sourcegitcommit: 49e14e0d19a18b75fd83de6c16ccee2594592355
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75945629"
---
# <a name="sampling-in-application-insights"></a>Выборка в Application Insights

Выборка — это функция [Azure Application Insights](../../azure-monitor/app/app-insights-overview.md), которую мы рекомендуем использовать для сокращения трафика телеметрии и хранения. Эта функция также поддерживает статистически правильный анализ данных приложения. Фильтр выбирает связанные элементы, позволяя переходить между ними при диагностике.
Если счетчики метрик представлены на портале, они будут повторно нормализованы для использования выборки учетных записей. Это снизит влияние на статистику.

Выборка сокращает расходы, связанные с использованием трафика и данных, помогая избежать регулирования.

## <a name="in-brief"></a>Краткое описание

* Выборка сохраняет 1 из *n* записей и отклоняет остальные. Например, он может хранить один из пяти событий, частота выборки равна 20%. 
* Адаптивная выборка включена по умолчанию во всех последних версиях ASP.NET и ASP.NET Core пакетах средств разработки программного обеспечения (SDK).
* Выборку можно также задать вручную. Это можно настроить на портале на *странице использование и предполагаемые затраты*в пакете SDK ASP.NET в файле ApplicationInsights. config в пакете SDK ASP.NET Core с помощью кода или пакета SDK для Java в файле ApplicationInsights. XML.
* Если вы зарегистрируете пользовательские события и хотите убедиться, что набор событий сохраняется или удаляется вместе, события должны иметь одинаковое значение с идентификатором.
* Делитель выборки *n* указывается в каждой записи в свойстве `itemCount`, которая при поиске отображается как число запросов или счетчик событий. `itemCount==1`, если выборка не находится в операции.
* При написании запросов аналитики необходимо [учитывать выборку](../../azure-monitor/log-query/aggregations.md). В частности, вместо простого подсчета записей следует использовать функцию `summarize sum(itemCount)`.

## <a name="types-of-sampling"></a>Типы выборки

Существует три альтернативных метода выборки.

* **Адаптивная выборка** автоматически корректирует объем данных телеметрии, отправляемых из пакета SDK в приложении ASP.NET/ASP.NET Core. Это выборка по умолчанию из ASP.NET Web SDK v 2.0.0-beta3 и Microsoft. ApplicationInsights. AspNetCore SDK v 2.2.0-Beta1.  Адаптивная выборка сейчас доступна только в рамках серверной телеметрии ASP.NET.

* **Выборка с фиксированной частотой** сокращает объем данных телеметрии, отправляемых с сервера ASP.NET или ASP.NET Core или Java, а также из браузеров пользователей. Частоту вы задаете сами. Благодаря тому, что клиент и сервер будут синхронизировать свои выборки, при поиске вы сможете перемещаться между связанными представлениями страниц и запросами.

* **Выборка приема** Работает в портал Azure. отклоняет некоторые данные телеметрии, поступающие из приложения, с заданной скоростью выборки. Выборка не сокращает трафик телеметрии, отправляемый из вашего приложения, но помогает оставаться в пределах месячной квоты. Основное преимущество выборки приема заключается в том, что можно задать частоту выборки без повторного развертывания приложения. Выборка приема действует единообразно для всех серверов и клиентов.

Если выполняется адаптивная или фиксированная выборка, выборка приема отключена.


## <a name="adaptive-sampling-in-your-aspnetaspnet-core-web-applications"></a>Адаптивная выборка в веб-приложениях ASP.NET/ASP.NET Core

Адаптивная выборка доступна для Application Insights пакета SDK для ASP.NET v 2.0.0-beta3 и более поздних версий, Microsoft. ApplicationInsights. AspNetCore SDK v 2.2.0-Beta1 и более поздних версий и включена по умолчанию.

Адаптивная выборка влияет на объем данных телеметрии, отправляемых в конечную точку службы Application Insights из приложения веб-сервера. Том корректируется автоматически, чтобы он оставался в пределах заданного максимального уровня трафика, и управляется с помощью параметра `MaxTelemetryItemsPerSecond`. Если приложение создает небольшой объем данных телеметрии, например при отладке или из-за низкого уровня использования, элементы не будут удаляться процессором выборки, пока том не `MaxTelemetryItemsPerSecond`. По мере увеличения объема данных телеметрии частота дискретизации корректируется, чтобы получить целевой том.

Для получения целевого объема некоторые формируемые данные телеметрии игнорируются. Однако, как и в других типах выборки, алгоритм сохраняет связанные элементы телеметрии. Например, при проверке телеметрии в поиске это позволит найти запрос, связанный с определенным исключением.

Счетчики метрик, например частота запросов и частота исключений, корректируются с учетом частоты выборки, так что в обозревателе метрик отображаются приблизительно точные значения.

## <a name="configuring-adaptive-sampling-for-aspnet-applications"></a>Настройка адаптивной выборки для приложений ASP.NET

[Сведения](../../azure-monitor/app/sampling.md#configuring-adaptive-sampling-for-aspnet-core-applications) о настройке адаптивной выборки для приложений ASP.NET Core. 

В файле [ApplicationInsights.config](../../azure-monitor/app/configuration-with-applicationinsights-config.md) можно настроить несколько параметров узла `AdaptiveSamplingTelemetryProcessor`. Ниже представлены значения по умолчанию.

* `<MaxTelemetryItemsPerSecond>5</MaxTelemetryItemsPerSecond>`
  
    Целевая частота, к которой стремится адаптивный алгоритм **на каждом узле сервера**. Если веб-приложение выполняется на множестве узлов, нужно уменьшить это значение, чтобы не превышать целевую скорость трафика на портале Application Insights.
* `<EvaluationInterval>00:00:15</EvaluationInterval>` 
  
    Интервал повторного вычисления текущей скорости телеметрии. Вычисление выполняется на основе скользящего среднего. Вы можете сократить этот интервал, если наблюдаете неожиданные скачки данных телеметрии в сторону увеличения.
* `<SamplingPercentageDecreaseTimeout>00:02:00</SamplingPercentageDecreaseTimeout>`
  
    Время, по истечении которого можно снова снизить процент выборки для сбора меньшего объема данных после изменения значения процента выборки.
* `<SamplingPercentageIncreaseTimeout>00:15:00</SamplingPercentageIncreaseTimeout>`
  
    Время, по истечении которого можно снова увеличить процент выборки для сбора большего объема данных после изменения значения процента выборки.
* `<MinSamplingPercentage>0.1</MinSamplingPercentage>`
  
    Минимальное допустимое значение с учетом изменения процента выборки.
* `<MaxSamplingPercentage>100.0</MaxSamplingPercentage>`
  
    Максимальное допустимое значение с учетом изменения процента выборки.
* `<MovingAverageRatio>0.25</MovingAverageRatio>` 
  
    Взвешенное значение, присваиваемое последнему значению при вычислении скользящего среднего. Используйте значение не больше 1. Использование значений ниже рекомендуемых приводит к тому, что скорость реагирования алгоритма на резкие изменения замедляется.
* `<InitialSamplingPercentage>100</InitialSamplingPercentage>`
  
    Значение, назначенное сразу после запуска приложения. Не сокращайте значение во время отладки.

* `<ExcludedTypes>Trace;Exception</ExcludedTypes>`
  
    Разделенный точкой с запятой список типов, которые не должны включаться в выборку. Распознаваемые типы: Dependency, Event, Exception, PageView, Request, Trace. Передаются все экземпляры указанных типов; типы, которые не указаны, включаются в выборку.

* `<IncludedTypes>Request;Dependency</IncludedTypes>`
  
    Разделенный точкой с запятой список типов, которые должны включаться в выборку. Распознаваемые типы: Dependency, Event, Exception, PageView, Request, Trace. Указанные типы включаются в выборку; все экземпляры других типов будут всегда передаваться.


**Чтобы отключить** адаптивную выборку, удалите AdaptiveSamplingTelemetryProcessor узлы из applicationinsights-config.

### <a name="alternative-configure-adaptive-sampling-in-code"></a>Альтернатива: настройка адаптивной выборки в коде

Вместо установки параметра выборки в CONFIG-файле можно задать эти значения программным способом.

1. Удалите все `AdaptiveSamplingTelemetryProcessor` узлы из файла конфигурации.
2. Используйте следующий фрагмент кода для настройки адаптивной выборки.

*C#*

```csharp

    using Microsoft.ApplicationInsights;
    using Microsoft.ApplicationInsights.Extensibility;
    using Microsoft.ApplicationInsights.WindowsServer.Channel.Implementation;
    using Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel;
    ...

    var builder = TelemetryConfiguration.Active.TelemetryProcessorChainBuilder;
    // If you are on ApplicationInsights SDK v 2.8.0-beta2 or higher, use the following line instead
    // var builder = TelemetryConfiguration.Active.DefaultTelemetrySink.TelemetryProcessorChainBuilder;

    // Enable AdaptiveSampling so as to keep overall telemetry volume to 5 items per second.
    builder.UseAdaptiveSampling(maxTelemetryItemsPerSecond:5);

    // If you have other telemetry processors:
    builder.Use((next) => new AnotherProcessor(next));

    builder.Build();

```

([Сведения о процессорах телеметрии](../../azure-monitor/app/api-filtering-sampling.md#filtering).)

Можно также настроить частоту выборки для каждого типа телеметрии отдельно или даже исключить определенные типы из выборки. 

*C#*

```csharp
    // The following configures adaptive sampling with 5 items per second, and also excludes DependencyTelemetry from being subject to sampling.
    builder.UseAdaptiveSampling(maxTelemetryItemsPerSecond:5, excludedTypes: "Dependency");
```

## <a name="configuring-adaptive-sampling-for-aspnet-core-applications"></a>Настройка адаптивной выборки для приложений ASP.NET Core.

Для ASP.NET Core приложений нет `ApplicationInsights.Config`, поэтому все настройки выполняются с помощью кода.
Адаптивная выборка включена для всех приложений ASP.NET Core по умолчанию. Вы можете отключить или настроить поведение выборки.

### <a name="turning-off-adaptive-sampling"></a>Отключение адаптивной выборки

Функцию выборки по умолчанию можно отключить во время добавления Application Insights службы в ```ConfigureServices```метода с помощью ```ApplicationInsightsServiceOptions``` в файле `Startup.cs`:

```csharp
public void ConfigureServices(IServiceCollection services)
{
    // ...

    var aiOptions = new Microsoft.ApplicationInsights.AspNetCore.Extensions.ApplicationInsightsServiceOptions();
    aiOptions.EnableAdaptiveSampling = false;
    services.AddApplicationInsightsTelemetry(aiOptions);
    //...
}
```

Указанный выше код отключит функцию выборки. Чтобы добавить выборку с дополнительными параметрами настройки, выполните следующие действия.

### <a name="configure-sampling-settings"></a>Настройка параметров выборки

Чтобы настроить поведение выборки, используйте методы расширения ```TelemetryProcessorChainBuilder```, как показано ниже.

> [!IMPORTANT]
> Если вы используете этот метод для настройки выборки, убедитесь, что вы используете параметры aiOptions.EnableAdaptiveSampling = false; с помощью AddApplicationInsightsTelemetry().

```csharp
public void Configure(IApplicationBuilder app, IHostingEnvironment env, TelemetryConfiguration configuration)
{
    var builder = configuration.TelemetryProcessorChainBuilder;
    // version 2.5.0-beta2 and above should use the following line instead of above. (https://github.com/Microsoft/ApplicationInsights-aspnetcore/blob/develop/CHANGELOG.md#version-250-beta2)
    // var builder = configuration.DefaultTelemetrySink.TelemetryProcessorChainBuilder;

    // Using adaptive sampling
    builder.UseAdaptiveSampling(maxTelemetryItemsPerSecond:5);

    // Alternately, the following configures adaptive sampling with 5 items per second, and also excludes DependencyTelemetry from being subject to sampling.
    // builder.UseAdaptiveSampling(maxTelemetryItemsPerSecond:5, excludedTypes: "Dependency");

    // If you have other telemetry processors:
    builder.Use((next) => new AnotherProcessor(next));
    
    builder.Build();

    // ...
}

```

**Если для настройки выборки используется метод, описанный выше, обязательно используйте параметры ```aiOptions.EnableAdaptiveSampling = false;``` с Аддаппликатионинсигхтстелеметри ().**

## <a name="fixed-rate-sampling-for-aspnet-aspnet-core-java-websites-and-python-applications"></a>Выборка с фиксированной частотой для ASP.NET, ASP.NET Core, веб-сайтов Java и приложений Python

Выборка с фиксированной частотой уменьшает объем трафика, отправляемого с веб-сервера и веб-браузеров. В отличие от адаптивной выборки объем данных уменьшается в фиксированном, заданном вами размере. Выборки клиента и сервера синхронизируются, а связанные элементы сохраняются. Например, просматривая представление страницы в поиске, вы всегда сможете найти соответствующий ему запрос.

Как и другие методы выборки, это также позволяет хранить связанные элементы. При каждом событии HTTP-запроса этот запрос и связанные с ним события игнорируются или передаются вместе.

В обозревателе метрик такие параметры, как счетчики запросов и исключений, умножаются на коэффициент, компенсирующий частоту выборки, что позволяет получать примерно точные значения.

### <a name="configuring-fixed-rate-sampling-in-aspnet"></a>Настройка выборки с фиксированной частотой в ASP.NET

1. **Отключите адаптивную выборку.** В файле [ApplicationInsights.config](../../azure-monitor/app/configuration-with-applicationinsights-config.md) удалите или преобразуйте в комментарий узел `AdaptiveSamplingTelemetryProcessor`.

    ```xml

    <TelemetryProcessors>

    <!-- Disabled adaptive sampling:
      <Add Type="Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel.AdaptiveSamplingTelemetryProcessor, Microsoft.AI.ServerTelemetryChannel">
        <MaxTelemetryItemsPerSecond>5</MaxTelemetryItemsPerSecond>
      </Add>
    -->
    ```

2. **Включите модуль выборки с фиксированной частотой.** Добавьте этот фрагмент кода в файл [ApplicationInsights.config](../../azure-monitor/app/configuration-with-applicationinsights-config.md):
   
    ```XML
   
    <TelemetryProcessors>
     <Add  Type="Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel.SamplingTelemetryProcessor, Microsoft.AI.ServerTelemetryChannel">
   
      <!-- Set a percentage close to 100/N where N is an integer. -->
     <!-- E.g. 50 (=100/2), 33.33 (=100/3), 25 (=100/4), 20, 1 (=100/100), 0.1 (=100/1000) -->
      <SamplingPercentage>10</SamplingPercentage>
      </Add>
    </TelemetryProcessors>
   
    ```
   ### <a name="alternative-enable-fixed-rate-sampling-in-your-server-code"></a>Альтернатива: включение выборки с фиксированной частотой в коде сервера
    
    Вместо установки параметра выборки в CONFIG-файле можно задать эти значения программным способом. 

*C#*

```csharp

    using Microsoft.ApplicationInsights.Extensibility;
    using Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel;
    ...

    var builder = TelemetryConfiguration.Active.TelemetryProcessorChainBuilder;
    // If you are on ApplicationInsights SDK v 2.8.0-beta2 or higher, use the following line instead
    // var builder = TelemetryConfiguration.Active.DefaultTelemetrySink.TelemetryProcessorChainBuilder;

    builder.UseSampling(10.0); // percentage

    // If you have other telemetry processors:
    builder.Use((next) => new AnotherProcessor(next));

    builder.Build();

```
([Сведения о процессорах телеметрии](../../azure-monitor/app/api-filtering-sampling.md#filtering).)

### <a name="configuring-fixed-rate-sampling-in-aspnet-core"></a>Настройка выборки с фиксированной частотой в ASP.NET Core

1. **Отключить адаптивную выборку**: изменения можно вносить в метод ```ConfigureServices```с помощью ```ApplicationInsightsServiceOptions```:

    ```csharp
    public void ConfigureServices(IServiceCollection services)
    {
    // ...

        var aiOptions = new Microsoft.ApplicationInsights.AspNetCore.Extensions.ApplicationInsightsServiceOptions();
        aiOptions.EnableAdaptiveSampling = false;
        services.AddApplicationInsightsTelemetry(aiOptions);
    //...
    }
    ```

2. **Включите модуль выборки с фиксированной частотой.** Изменения можно вносить в метод ```Configure```, как показано в следующем фрагменте кода:

    ```csharp
    public void Configure(IApplicationBuilder app, IHostingEnvironment env)
    {
        var configuration = app.ApplicationServices.GetService<TelemetryConfiguration>();

        var builder = configuration.TelemetryProcessorChainBuilder;
        // version 2.5.0-beta2 and above should use the following line instead of above. (https://github.com/Microsoft/ApplicationInsights-aspnetcore/blob/develop/CHANGELOG.md#version-250-beta2)
        // var builder = configuration.DefaultTelemetrySink.TelemetryProcessorChainBuilder;

        // Using fixed rate sampling   
        double fixedSamplingPercentage = 10;
        builder.UseSampling(fixedSamplingPercentage);

        builder.Build();

        // ...
    }

    ```

### <a name="configuring-fixed-rate-sampling-in-java"></a>Настройка выборки с фиксированной частотой в Java ###

1. Скачайте [пакет SDK Application Insights для Java](../../azure-monitor/app/java-get-started.md) последней версии и настройте его в веб-приложении.

2. **Включите модуль выборки с фиксированной частотой**, добавив следующий фрагмент кода в файл ApplicationInsights.xml.

    ```XML
        <TelemetryProcessors>
            <BuiltInProcessors>
                <Processor type = "FixedRateSamplingTelemetryProcessor">
                    <!-- Set a percentage close to 100/N where N is an integer. -->
                    <!-- E.g. 50 (=100/2), 33.33 (=100/3), 25 (=100/4), 20, 1 (=100/100), 0.1 (=100/1000) -->
                    <Add name = "SamplingPercentage" value = "50" />
                </Processor>
            </BuiltInProcessors>
        </TelemetryProcessors>
    ```

3. Конкретные типы телеметрии можно включить в выборку или исключить из нее с помощью следующих тегов внутри тега обработчика данных FixedRateSamplingTelemetryProcessor.
    ```XML
        <ExcludedTypes>
            <ExcludedType>Request</ExcludedType>
        </ExcludedTypes>

        <IncludedTypes>
            <IncludedType>Exception</IncludedType>
        </IncludedTypes>
    ```

Типы телеметрии, которые могут быть включены или исключены из выборки, — это зависимости, события, исключения, PageView, запрос и трассировка.

> [!NOTE]
> В качестве процента выборки выберите значение в процентах, близкое к 100/N, где N — это целое число.  В настоящее время выборка не поддерживает другие значения.
> 
> 

<a name="other-web-pages"></a>

### <a name="configuring-fixed-rate-sampling-in-opencensus-python"></a>Настройка выборки с фиксированной частотой в Опенценсус Python ###

1. Выполните инструментирование приложения с помощью последних средств [экспорта опенценсус Azure Monitor](../../azure-monitor/app/opencensus-python.md).

> [!NOTE]
> Выборка с фиксированной частотой доступна только при использовании средства экспорта трассировки. Это означает, что входящие и исходящие запросы являются единственными типами телеметрии, в которых можно настроить выборку.
> 
> 

2. Вы можете указать `sampler` как часть конфигурации `Tracer`. Если не указан явный образец, по умолчанию будет использоваться Пробабилитисамплер. По умолчанию Пробабилитисамплер будет использовать частоту 1/10000, то есть все запросы 10000 будут отправляться в Application Insights. Чтобы указать свою частоту выборки, см. ниже.

3. При указании дискретизатора убедитесь, что `Tracer` указывает дискретизатор с частотой выборки от 0,0 до 1,0 включительно. Частота выборки 1,0 представляет 100%, то есть все запросы будут отправляться как данные телеметрии для Application Insights.

    ```python
    tracer = Tracer(
        exporter=AzureExporter(
            instrumentation_key='00000000-0000-0000-0000-000000000000',
        ),
        sampler=ProbabilitySampler(1.0),
    )
    ```

## <a name="ingestion-sampling"></a>Выборка приема

Этот вид выборки работает в точке, где данные телеметрии с веб-сервера, браузеров и устройств достигают конечной точки службы Application Insights. Несмотря на то, что трафик телеметрии, отправляемой из приложения, такая выборка не уменьшает, она сокращает объем данных для обработки и сохранения в службе Application Insights, а значит и размер оплаты.

Используйте этот тип выборки, если ваше приложение часто выходит за рамки ежемесячной квоты, а возможности использовать один из типов выборки на основе SDK нет. 

Задайте частоту выборки на странице "Usage and estimated costs" (Данные об использовании и предполагаемые расходы).

![В колонке общих сведений о приложении щелкните "Параметры", "Квота", "Выборки", выберите частоту выборки и щелкните "Обновить".](./media/sampling/data-sampling.png)

Как и в других типах выборки, алгоритм сохраняет связанные элементы телеметрии. Например, при проверке телеметрии в поиске это позволит найти запрос, связанный с определенным исключением. Правильно сохраняются счетчики метрик, например частота запросов и частота исключений.

Точки данных, отклоненные выборкой, доступны не во всех функциях Application Insights, например [Непрерывный экспорт](../../azure-monitor/app/export-telemetry.md).

Выборка приема не работает во время действия адаптивной или фиксированной выборки на основе пакета SDK. Адаптивная выборка включена по умолчанию, если пакет SDK для ASP.NET/ASP.NET Core включен в Visual Studio или включен в расширениях веб-приложения Azure или с помощью монитор состояния, а выборка приема отключена. Если частота выборки в пакете SDK составляет менее 100% (т. е. элементов, для которых выполняется выборка), то заданная скорость выборки игнорируется.

> [!WARNING]
> Значение, отображаемое на плитке, обозначает значение, которое вы задали для выборки приема. Оно не отражает фактическую частоту выборки, если действует выборка пакета SDK.
>
>
## <a name="sampling-for-web-pages-with-javascript"></a>Включение выборки для веб-страниц с помощью JavaScript
Вы можете настроить выборку с фиксированной частотой для веб-страниц с любого сервера. 

При [настройке веб-страниц для Application Insights](../../azure-monitor/app/javascript.md) измените фрагмент JavaScript, скачанный с портала Application Insights. (В приложениях ASP.NET фрагмент обычно находится в _Layout. cshtml.)  Вставьте строку, например `samplingPercentage: 10,`, перед ключом инструментирования:

    <script>
    var appInsights= ... 
    }({ 


    // Value must be 100/N where N is an integer.
    // Valid examples: 50, 25, 20, 10, 5, 1, 0.1, ...
    samplingPercentage: 10, 

    instrumentationKey:...
    }); 

    window.appInsights=appInsights; 
    appInsights.trackPageView(); 
    </script> 

В качестве процента выборки выберите значение в процентах, близкое к 100/N, где N — это целое число.  В настоящее время выборка не поддерживает другие значения.

Если вы также включите выборку с фиксированной частотой на сервере, выборка будет синхронизироваться между клиентом и сервером. Благодаря этому вы сможете перемещаться между связанными представлениями страниц и запросами в службе поиска.

## <a name="when-to-use-sampling"></a>Когда следует использовать выборку?

Адаптивная выборка включается автоматически в последних пакетах SDK для .NET и .NET Core. Независимо от того, какая версия пакета SDK используется, можно включить выборку при приеме, чтобы разрешить Application Insights выборку собранных данных.

По умолчанию в пакете SDK для Java выборка не включена. В настоящее время он поддерживает только выборку с фиксированный частотой. Адаптивная выборка в пакете SDK для Java не поддерживается.

В общем случае для большинства приложений малого и среднего размера выборка не требуется. Наиболее полезные диагностические сведения и наиболее точную статистику можно получить, собирая данные обо всех действиях пользователей. 

Основные преимущества выборки:

* Служба Application Insights удаляет («регулирует») точки данных, когда приложение слишком часто отправляет данные телеметрии за короткий интервал времени. 
* Вы остаетесь в пределах [квоты](../../azure-monitor/app/pricing.md) на точки данных для своей ценовой категории. 
* Вам нужно сократить сетевой трафик, который тратится на сбор данных телеметрии. 

### <a name="which-type-of-sampling-should-i-use"></a>Какой тип выборки следует использовать?

**Используйте выборку приема, если:**

* Вы часто превышаете ежемесячную квоту телеметрии.
* Вы используете версию пакета SDK, которая не поддерживает выборки, например версию пакета для ASP.NET ниже 2.
* Вы получаете слишком много данных телеметрии из веб-браузеров пользователей.

**Используйте выборку с фиксированной частотой, если:**

* Вы используете пакет SDK Application Insights для веб-служб ASP.NET 2.0.0 или более поздней версии или для Java 2.0.1 или более поздней версии.
* Вам нужна синхронизированная выборка между клиентом и сервером, которая позволяет перемещаться между связанными событиями на стороне клиента и сервера (такими, как просмотры страниц и HTTP-запросы) при использовании [службы поиска](../../azure-monitor/app/diagnostic-search.md)в ходе анализа событий.
* Вам нужна уверенность в выборе соответствующего процента выборки для вашего приложения. Он должен быть достаточно высоким, чтобы получить точные метрики и при этом не превышать ценовую квоту и ограничения регулирования. 

**Используйте адаптивную выборку:**

Если условия для использования других форм выборки не применяются, мы рекомендуем адаптивную выборку. Этот параметр включен по умолчанию в пакете SDK сервера ASP.NET/ASP.NET Core. Она не приведет к уменьшению трафика, пока не будет достигнута определенная минимальная скорость. Таким образом, сайты, которые используются редко, не будут затронуты.

## <a name="how-do-i-know-whether-sampling-is-in-operation"></a>Как узнать, действует ли выборка

Чтобы узнать фактическую частоту выборки (где бы она ни применялась), выполните такой [запрос аналитики](../../azure-monitor/app/analytics.md) :

```
union requests,dependencies,pageViews,browserTimings,exceptions,traces
| where timestamp > ago(1d)
| summarize RetainedPercentage = 100/avg(itemCount) by bin(timestamp, 1h), itemType
```

Если Ретаинедперцентаже для любого типа меньше 100, то этот элемент выдается в виде выборки.

**В Application Insights не указаны типы телеметрии сеанса, метрик и счетчиков производительности в любых методах выборки, описанных выше. Эти типы всегда исключаются из выборки, так как снижение точности может быть очень нежелательным для этих типов телеметрии.**

## <a name="how-does-sampling-work"></a>Как работает функция выборки?

Функция выборки с фиксированной частотой поддерживается в пакетах SDK для ASP.NET версии 2.0.0 и выше и в пакетах SDK для Java версии 2.0.1 и выше. Адаптивная выборка поддерживается в пакете SDK для ASP.NET версии 2.0.0 и выше. Выборка приема — это компонент службы Application Insights. Она может работать, даже если пакет SDK не выполняет выборку.

Алгоритм выборки решает, какие элементы телеметрии необходимо удалить, а какие сохранить (как в пакете SDK, так и в службе Application Insights). Решение выборки основано на нескольких правилах, цель которых — сохранение всех точек взаимосвязанных данных без изменений, а также реализация функции диагностики в Application Insights даже с использованием сокращенного набора данных. Например, если для неудачно завершенного запроса приложение отправляет дополнительные элементы телеметрии (например, исключение и трассировки, зарегистрированные этим запросом), выборка не будет разделять этот запрос и другие данные телеметрии. Она либо сохраняет, либо удаляет все элементы вместе. Поэтому при просмотре сведений о запросе в Application Insights вы всегда будете видеть запрос вместе со связанными элементами телеметрии. 

Решение выборки основывается на ИДЕНТИФИКАТОРе операции запроса. Это означает, что все элементы телеметрии, относящиеся к определенной операции, либо сохраняются, либо удаляются. Для элементов телеметрии, для которых не задан идентификатор операции (например, элементы телеметрии, полученные из асинхронных потоков без контекста HTTP), просто захватывает процент элементов телеметрии каждого типа. До 2.5.0 версии 2 пакета SDK для .NET и 2.2.0-ASP.NET Core beta3 SDK, решение выборки было основано на хэшу идентификатора пользователя для приложений, определяющих "пользователя" (то есть наиболее типичных веб-приложений). Для типов приложений, не определяющих пользователей (например, веб-служб), решение выборки было основано на ИДЕНТИФИКАТОРе операции запроса.

Представляя вам данные телеметрии, служба Application Insights корректирует метрики в соответствии с процентом выборки, который использовался во время сбора. Это делается, чтобы компенсировать отсутствующие точки данных. Следовательно, при просмотре данных телеметрии в Application Insights пользователи видят статистически правильные приблизительные значения, очень близкие к реальным цифрам.

Точность приблизительного значения в значительной степени зависит от заданного процента выборки. Кроме того, точность возрастает для приложений, обрабатывающих большой объем сходных запросов от большого количества пользователей. С другой стороны, для приложений, которые не работают с существенной нагрузкой, выборка не требуется, так как такие приложения обычно могут отправлять все данные телеметрии, не выходя за пределы квоты и не вызывая потерю данных в результате регулирования. 

> [!WARNING]
> Application Insights не использует выборки данных телеметрии для метрик и сеансов. Снижение точности может быть нежелательным для данных типов телеметрии.
> 

### <a name="adaptive-sampling"></a>Адаптивная выборка

Адаптивная выборка добавляет компонент, который отслеживает текущую скорость передачи данных из пакета SDK и корректирует процент выборки, чтобы оставаться в пределах целевой максимальной скорости. Корректировка пересчитывается через регулярные интервалы времени в зависимости от скользящего среднего для скорости исходящей передачи.

## <a name="sampling-and-the-javascript-sdk"></a>Выборка и пакет SDK для JavaScript

Пакет SDK клиента (JavaScript) участвует в выборке с фиксированной частотой в сочетании с серверным пакетом SDK. Инструментированные страницы отправляют данные телеметрии клиента только от тех пользователей, которых сервер включил в выборку. Такая логика обеспечивает непрерывность сеанса пользователя как на клиенте, так и на сервере. Благодаря этому с помощью любого элемента телеметрии в Application Insights можно найти все остальные элементы телеметрии для этого пользователя или сеанса. 

*Данные телеметрии на клиенте и сервере не отображают скоординированные образцы, как описано выше.*

* Убедитесь в том, что выборка с фиксированной частотой включена и на сервере, и в клиенте.
* Убедитесь в том, что используется пакет SDK версии 2.0 или выше.
* Проверьте, указан ли процент выборки на клиенте и сервере.

### <a name="sampling-in-azure-functions"></a>Выборка в функциях Azure

Следуйте инструкциям из [этой](https://docs.microsoft.com/azure/azure-functions/functions-monitoring#configure-sampling) статьи, чтобы настроить выборку для приложений, выполняющихся в функциях Azure.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

*Что такое поведение выборки по умолчанию в ASP.NET и ASP.NET Core SDK?*

* Если вы используете одну из последних версий указанного выше пакета SDK, Адаптивная выборка включается по умолчанию с пятью элементами телеметрии в секунду.
  По умолчанию Добавлено 2 Адаптивесамплингтелеметрипроцессорс, а в другой — тип события выборки, а в другом — исключение типа выборки. Такая конфигурация означает, что пакет SDK будет пытаться ограничить элементы телеметрии пятью элементами телеметрии типов событий и пять элементов телеметрии всех остальных типов, таким образом гарантируя, что события будут выделены отдельно от других типов телеметрии. События обычно используются для бизнес-телеметрии и, скорее всего, не должны быть затронуты томами телеметрии диагностики.
  
  Ниже показан созданный по умолчанию файл ApplicationInsights. config. Как было сказано, добавлены два отдельных узла AdaptiveSamplingTelemetryProcessor, один за исключением типов событий и другой, включая его. В ASP.NET Core в коде включено аналогичное поведение по умолчанию. Используйте примеры из предыдущего раздела документа, чтобы изменить это поведение по умолчанию.

    ```xml
    <TelemetryProcessors>
        <Add Type="Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel.AdaptiveSamplingTelemetryProcessor, Microsoft.AI.ServerTelemetryChannel">
            <MaxTelemetryItemsPerSecond>5</MaxTelemetryItemsPerSecond>
            <ExcludedTypes>Event</ExcludedTypes>
        </Add>
        <Add Type="Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel.AdaptiveSamplingTelemetryProcessor, Microsoft.AI.ServerTelemetryChannel">
            <MaxTelemetryItemsPerSecond>5</MaxTelemetryItemsPerSecond>
            <IncludedTypes>Event</IncludedTypes>
        </Add>
    </TelemetryProcessors>
    ```

*Можно ли выполнить выборку данных телеметрии более одного раза?*

* Нет. Самплингтелеметрипроцессорс не учитывать элементы из соображений выборки, если элемент уже выбран. То же самое справедливо и для выборки приема, что не будет применять выборку к этим элементам, уже выбранным в пакете SDK.

*Почему выборка — это не простой сбор X процентов данных телеметрии каждого типа?*

* Хотя этот подход выборки обеспечивает высокий уровень точности в приближении метрик, он не сможет сопоставлять диагностические данные для каждого пользователя, сеанса и запроса, что очень важно для диагностики. Поэтому выборку лучше всего описать как «сбор всех элементов телеметрии для X процентов пользователей приложения» или «сбор всех данных телеметрии для X процентов запросов приложения». Для элементов телеметрии, не связанных с запросами (например, фоновой асинхронной обработкой), резервным вариантом является "сбор X процентов всех элементов для каждого типа телеметрии". 

*Может ли процент выборки меняться со временем?*

* Да, адаптивная выборка постепенно меняет процент выборки в зависимости от текущего объема данных телеметрии.

*Если я использую выборку с фиксированной частотой, как узнать, какой процент выборки будет оптимальным для моего приложения?*

* Один из способов — начать с адаптивной выборки, узнать подобранную частоту (см. вопрос выше) и переключиться на выборку с этой фиксированной частотой. 
  
    В противном случае придется только угадывать. Анализируйте текущее использование телеметрии в Application Insights, наблюдайте осуществляемое регулирование и оценивайте объем собранных данных телеметрии. Эти три фактора в сочетании с выбранной ценовой категорией позволяют оценить объем собранных данных телеметрии, который может потребоваться сократить. Однако увеличение числа пользователей или некоторые другие факторы, меняющие объем данных телеметрии, могут сделать оценку недействительной.

*Что произойдет, если настроить слишком низкий процент выборки?*

* Слишком низкий процент выборки (излишне агрессивная выборка) снижает точность приблизительных значений, когда служба Application Insights пытается компенсировать отображение данных для сокращения объема данных. Кроме того, это может отрицательно повлиять на функцию диагностики, так как в выборку могут не попасть некоторые редкие сбои или медленные запросы.

*Что произойдет, если настроить слишком высокий процент выборки?*

* Слишком высокий процент выборки (недостаточно агрессивная выборка) приводит к недостаточному снижению объема собранных данных телеметрии. У вас по-прежнему может наблюдаться потеря данных телеметрии, связанная с регулированием, а затраты на использование Application Insights могут быть выше запланированных из-за избыточных расходов.

*На каких платформах можно использовать выборку?*

* Выборка приема может выполняться автоматически, когда объем данных телеметрии превышает определенный порог, если пакет SDK не выполняет выборку. Такая конфигурация будет работать, например, если вы используете более раннюю версию пакета SDK для ASP.NET или предыдущую версию пакета SDK для Java (1.0.10 или ранее).
* Если вы используете версии пакета SDK ASP.NET 2.0.0 и выше или ASP.NET CORE SDK версии 2.2.0 и выше (размещенные в Azure или на своем сервере), вы получаете адаптивную выборку по умолчанию, но вы можете переключиться на фиксированную расставку, как описано выше. При выборке с фиксированной частотой пакет SDK браузера выполняет автоматическую синхронизацию с событиями, связанными с выборкой. 
* Если вы используете пакет SDK для Java версии 2.0.1 или более поздней, можно настроить ApplicationInsights. XML, чтобы включить выборку с фиксированной частотой. По умолчанию выборка отключена. При выборке с фиксированной частотой пакет SDK браузера выполняет автоматическую синхронизацию с событиями, связанными с выборкой.

*Есть определенные редкие события, которые я всегда хочу просматривать. Как сделать так, чтобы модуль выборки не отфильтровывал их?*

* Лучший способ добиться этого — написать пользовательский [TelemetryInitializer](../../azure-monitor/app/api-filtering-sampling.md#addmodify-properties-itelemetryinitializer), который задает для `SamplingPercentage` значение 100 в элементе телеметрии, который необходимо сохранить, как показано ниже. Так как инициализаторы гарантированно выполняются до обработчиков данных телеметрии (включая выборку), это гарантирует, что все методы выборки будут игнорировать этот элемент из соображений выборки.

```csharp
     public class MyTelemetryInitializer : ITelemetryInitializer
      {
         public void Initialize(ITelemetry telemetry)
        {
            if(somecondition)
            {
                ((ISupportSampling)telemetry).SamplingPercentage = 100;
            }
        }
      }
```

## <a name="next-steps"></a>Дальнейшие действия

* [Фильтрация](../../azure-monitor/app/api-filtering-sampling.md) может обеспечивать более строгий контроль над данными, отправляемыми пакетом SDK.
* Прочтите статью "сеть разработчика", чтобы [оптимизировать телеметрию с помощью Application Insights](https://msdn.microsoft.com/magazine/mt808502.aspx).
