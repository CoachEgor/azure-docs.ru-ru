---
title: Обработчики данных телеметрии (Предварительная версия) — Azure Monitor Application Insights для Java
description: Настройка обработчиков данных телеметрии в Azure Monitor Application Insights для Java
ms.topic: conceptual
ms.date: 10/29/2020
author: MS-jgol
ms.custom: devx-track-java
ms.author: jgol
ms.openlocfilehash: 7fd53c77b64e028ffad25c8fa7a9eefd95439513
ms.sourcegitcommit: ea17e3a6219f0f01330cf7610e54f033a394b459
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2020
ms.locfileid: "97387162"
---
# <a name="telemetry-processors-preview---azure-monitor-application-insights-for-java"></a>Обработчики данных телеметрии (Предварительная версия) — Azure Monitor Application Insights для Java

> [!NOTE]
> Эта функция по-прежнему находится в предварительной версии.

Агент Java 3,0 для Application Insights теперь имеет возможности обработки данных телеметрии перед экспортом данных.

### <a name="some-use-cases"></a>Некоторые варианты использования:
 * Маскирование конфиденциальных данных
 * Условно добавить пользовательские измерения
 * Обновление имени телеметрии, используемого для агрегирования и вывода

### <a name="supported-processors"></a>Поддерживаемые процессоры:
 * Обработчик атрибутов
 * Охват процессора

## <a name="to-get-started"></a>Начало работы

Создайте файл конфигурации с именем `applicationinsights.json` и поместите его в тот же каталог, что и в `applicationinsights-agent-***.jar` следующем шаблоне.

```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "processors": [
      {
        "type": "attribute",
        ...
      },
      {
        "type": "attribute",
        ...
      },
      {
        "type": "span",
        ...
      }
    ]
  }
}
```

## <a name="includeexclude-spans"></a>Включить или исключить диапазоны

Обработчик атрибутов и процессор span предоставляют возможность предоставить набор свойств диапазона для сопоставления, чтобы определить, следует ли включать или исключать диапазон в процессоре. Чтобы настроить этот параметр, `include` необходимо указать и (или `exclude` ) хотя бы один, `matchType` а также один из параметров `spanNames` или `attributes` . Конфигурация включения и исключения поддерживается для нескольких указанных условий. Все указанные условия должны иметь значение true, чтобы сопоставление было выполнено. 

**Обязательное поле**: 
* `matchType` управляет `spanNames` интерпретацией элементов в `attributes` массивах и. Возможные значения: `regexp` или `strict`. 

**Необязательные поля**: 
* `spanNames` должен совпадать по крайней мере с одним из элементов. 
* `attributes` Задает список атрибутов для сопоставления. Все эти атрибуты должны совпадать в точности для совпадений.

> [!NOTE]
> Если `include` указаны и `exclude` , и, `include` свойства проверяются перед `exclude` свойствами.

#### <a name="sample-usage"></a>Пример использования

Ниже показано, как указать набор свойств span, чтобы указать, к каким диапазонам должен применяться этот процессор. `include`Свойства, которые указывают, какие из них должны быть добавлены, а также `exclude` свойства, позволяющие отфильтровать диапазоны, которые не должны обрабатываться.

```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "processors": [
      {
        "type": "attribute",
        "include": {
          "matchType": "strict",
          "spanNames": [
            "svcA",
            "svcB"
          ]
        },
        "exclude": {
          "matchType": "strict",
          "attributes": [
            {
              "key": "redact_trace",
              "value": "false"
            }
          ]
        },
        "actions": [
          {
            "key": "credit_card",
            "action": "delete"
          },
          {
            "key": "duplicate_key",
            "action": "delete"
          }
        ]
      }
    ]
  }
}
```

В приведенной выше конфигурации следующие диапазоны соответствуют свойствам и применяются действия процессора:

* Имя Span1: атрибуты "Свкб": {env: Production, test_request: 123, credit_card: 1234, redact_trace: "false"}

* Имя Span2: атрибуты "СВКА": {env: промежуточное хранение, test_request: false, redact_trace: true}

Следующие диапазоны не соответствуют свойствам включения, и действия процессора не применяются:

* Имя Span3: атрибуты "Свкб": {env: Production, test_request: true, credit_card: 1234, redact_trace: false}

* Имя Span4: атрибуты "СВКК": {env: dev, test_request: false}

## <a name="attribute-processor"></a>Обработчик атрибутов 

Обработчик атрибутов изменяет атрибуты диапазона. При необходимости она поддерживает возможность включения и исключения диапазонов.
Он принимает список действий, которые выполняются в порядке, указанном в файле конфигурации. Поддерживаются следующие действия:

* `insert` : Вставляет новый атрибут в диапазоны, где ключ еще не существует
* `update` : Обновляет атрибут в диапазонах, где существует ключ
* `delete` : Удаляет атрибут из диапазона.
* `hash`   : Hashs (SHA1) существующее значение атрибута

Для действий `insert` и `update`
* `key` является обязательным
* требуется один из `value` или `fromAttribute`
* `action` является обязательным.

Для `delete` действия
* `key` является обязательным
* `action`: `delete` является обязательным.

Для `hash` действия
* `key` является обязательным
* `action` : `hash` является обязательным.

Список действий можно составить для создания насыщенных сценариев, таких как атрибут заполнения, копирования значений в новый ключ, обезличивание конфиденциальные сведения.

#### <a name="sample-usage"></a>Пример использования

В следующем примере демонстрируется вставка ключей и значений в диапазоны:

```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "processors": [
      {
        "type": "attribute",
        "actions": [
          {
            "key": "attribute1",
            "value": "value1",
            "action": "insert"
          },
          {
            "key": "key1",
            "fromAttribute": "anotherkey",
            "action": "insert"
          }
        ]
      }
    ]
  }
}
```

В следующем примере показано, как настроить процессор для обновления только существующих ключей в атрибуте.

```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "processors": [
      {
        "type": "attribute",
        "actions": [
          {
            "key": "piiattribute",
            "value": "redacted",
            "action": "update"
          },
          {
            "key": "credit_card",
            "action": "delete"
          },
          {
            "key": "user.email",
            "action": "hash"
          }
        ]
      }
    ]
  }
}
```

В следующем примере показано, как обрабатывать диапазоны с именем диапазона, которое соответствует шаблонам RegExp.
Этот процессор удалит атрибут "token" и запишет атрибут "Password" в диапазонах, где имя диапазона совпадает с "auth \* ". и где имя Span не соответствует имени \* входа.

```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "processors": [
      {
        "type": "attribute",
        "include": {
          "matchType": "regexp",
          "spanNames": [
            "auth.*"
          ]
        },
        "exclude": {
          "matchType": "regexp",
          "spanNames": [
            "login.*"
          ]
        },
        "actions": [
          {
            "key": "password",
            "value": "obfuscated",
            "action": "update"
          },
          {
            "key": "token",
            "action": "delete"
          }
        ]
      }
    ]
  }
}
```

## <a name="span-processors"></a>Охват процессоров

Процессор span изменяет либо имя или атрибуты диапазона, исходя из имени диапазона. При необходимости она поддерживает возможность включения и исключения диапазонов.

### <a name="name-a-span"></a>Назовите диапазон

В разделе имени требуется следующий параметр:

* `fromAttributes`: Значение атрибута для ключей используется для создания нового имени в порядке, указанном в конфигурации. Все ключи атрибутов должны быть указаны в диапазоне процессора для его переименования.

При необходимости можно настроить следующий параметр:

* `separator`: Строка, которая указана, будет использоваться для разделения значений
> [!NOTE]
> Если переименование зависит от атрибутов, изменяемых обработчиком атрибутов, убедитесь, что процессор span указан после обработчика атрибутов в спецификации конвейера.

#### <a name="sample-usage"></a>Пример использования

В следующем примере задаются значения атрибута "DB. svc", "Operation" и "ID", которые формируют новое имя диапазона в этом порядке, разделенное значением "::".
```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "processors": [
      {
        "type": "span",
        "name": {
          "fromAttributes": [
            "db.svc",
            "operation",
            "id"
          ],
          "separator": "::"
        }
      }
    ]
  }
}
```

### <a name="extract-attributes-from-span-name"></a>Извлечь атрибуты из имени диапазона

Принимает список регулярных выражений, чтобы соответствовать имени диапазона и извлекать из него атрибуты на основе части выражения. Должен быть указан в `toAttributes` разделе.

Требуются следующие параметры.

`rules` : Список правил для извлечения значений атрибутов из имени диапазона. Значения в имени диапазона заменяются извлеченными именами атрибутов. Каждое правило в списке является строкой шаблона регулярного выражения. Имя диапазона проверяется по регулярному выражению. Если регулярное выражение соответствует, все именованные части выражения Regex извлекаются как атрибуты и добавляются в диапазон. Каждое имя части выражения преобразуется в имя атрибута и сопоставленная часть выражения, которая преобразуется в значение атрибута. Сопоставленная часть в имени диапазона заменяется извлеченным именем атрибута. Если атрибуты уже существуют в диапазоне, они будут перезаписаны. Процесс повторяется для всех правил в том порядке, в котором они указаны. Каждое последующее правило работает с именем диапазона, которое является выходным результатом после обработки предыдущего правила.

#### <a name="sample-usage"></a>Пример использования

Предположим, что имя диапазона ввода —/API/V1/Document/12345678/Update. Применение следующих результатов в области вывода имя/api/v1/document/{documentId}/update добавит новый атрибут "documentId" = "12345678" к диапазону.
```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "processors": [
      {
        "type": "span",
        "name": {
          "toAttributes": {
            "rules": [
              "^/api/v1/document/(?<documentId>.*)/update$"
            ]
          }
        }
      }
    ]
  }
}
```

Ниже показано, как переименовать область имен в "{operation_website}" и добавить атрибут {key: operation_website, значение: Олдспаннаме}, если диапазон имеет следующие свойства:
- Имя диапазона содержит строку "/" в любом месте строки.
- Имя диапазона не является "не разграничения/Change".
```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "processors": [
      {
        "type": "span",
        "include": {
          "matchType": "regexp",
          "spanNames": [
            "^(.*?)/(.*?)$"
          ]
        },
        "exclude": {
          "matchType": "strict",
          "spanNames": [
            "donot/change"
          ]
        },
        "name": {
          "toAttributes": {
            "rules": [
              "(?<operation_website>.*?)$"
            ]
          }
        }
      }
    ]
  }
}
```