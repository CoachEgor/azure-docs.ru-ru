---
title: Мониторинг веб-приложения с помощью многоэтапных веб-тестов и Azure Application Insights | Документация Майкрософт
description: Настройка многошаговых веб-тестов для мониторинга веб-приложений с помощью Azure Application Insights
ms.service: azure-monitor
ms.subservice: application-insights
ms.topic: conceptual
author: mrbullwinkle
ms.author: mbullwin
ms.date: 07/25/2019
ms.reviewer: sdash
ms.openlocfilehash: f34695cb4a92fbed285ba8c56764606a124194a4
ms.sourcegitcommit: 1bd2207c69a0c45076848a094292735faa012d22
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/21/2019
ms.locfileid: "72678236"
---
# <a name="multi-step-web-tests"></a>Многошаговые веб-тесты

Вы можете отслеживать записанную последовательность URL-адресов и взаимодействия с веб-сайтом с помощью многошаговых веб-тестов. В этой статье описывается процесс создания многоэтапного веб-теста с Visual Studio Enterprise.

> [!NOTE]
> Многошаговые веб-тесты зависят от файлов Visual Studio WebTest. Было [объявлено](https://devblogs.microsoft.com/devops/cloud-based-load-testing-service-eol/) , что Visual Studio 2019 будет последней версией с функциональностью веб-теста. Важно понимать, что несмотря на то, что новые функции не добавляются, функциональность веб-теста в Visual Studio 2019 все еще поддерживается и будет продолжать поддерживаться в течение жизненного цикла поддержки продукта. Группа разработки Azure Monitor разработчиков приступила к рассмотрению вопросов, касающихся [будущего тестирования](https://github.com/MicrosoftDocs/azure-docs/issues/26050#issuecomment-468814101)многофакторной доступности.  

## <a name="pre-requisites"></a>Технические условия

* Visual Studio 2017 Enterprise или более поздняя.
* Средства веб-тестов производительности и нагрузочного тестирования Visual Studio.

, Чтобы обнаружить предварительные требования для средств тестирования. Запустите **Visual Studio Installer**  > **отдельные компоненты**  > **отладку и тестирование**  > **веб-инструменты производительности и нагрузочного тестирования**.

![Снимок экрана: Пользовательский интерфейс установщика Visual Studio с выбранными отдельными компонентами с флажком рядом с элементом для веб-инструментов производительности и нагрузочного тестирования](./media/availability-multistep/web-performance-load-testing.png)

> [!NOTE]
> С многошаговыми веб-тестами связаны дополнительные затраты. Чтобы узнать больше, ознакомьтесь с [официальным руководством по ценам](https://azure.microsoft.com/pricing/details/application-insights/).

## <a name="record-a-multi-step-web-test"></a>Запись многошагового веб-теста

Для создания многошагового теста вам сначала нужно записать сценарий с помощью Visual Studio Enterprise, а затем отправить запись в Application Insights. Application Insights воспроизводит сценарий через заданные интервалы и проверяет ответ.

> [!IMPORTANT]
> * В тестах нельзя использовать запрограммированные функции или циклы. Тест должен полностью находиться в WEBTEST-файле скрипта. Однако вы можете использовать стандартные подключаемые модули.
> * В многошаговых веб-тестах поддерживаются только символы английского алфавита. Если вы используете Visual Studio на других языках, обновите файл определения веб-теста, чтобы перевести или исключить символы языков, отличных от английского.

Для записи веб-сеанса используйте Visual Studio Enterprise.

1. Создайте проект веб-тестов производительности и нагрузочного теста. **Файл**  > **Новый**  > **проекта**  > **Visual C#**   > **Test**

    ![Пользовательский интерфейс нового проекта Visual Studio](./media/availability-multistep/vs-web-performance-and-load-test.png)

2. Откройте файл `.webtest` и начните запись.

    ![Пользовательский интерфейс записи теста Visual Studio](./media/availability-multistep/open-web-test.png)

3. Щелкните шаги, которые должны имитироваться тестом в процессе записи.

    ![Пользовательский интерфейс записи браузера](./media/availability-multistep/record.png)

4. Отредактируйте тест, чтобы:

    * Добавить проверки полученного текста и кодов ответов.
    * Удалите все взаимодействия унекцесари. Можно также удалить зависимые запросы для изображений или добавить отслеживаемые сайты, не имеющие отношения к успешному выполнению теста.
    
    Помните, что можно изменять только тестовый сценарий — можно добавить пользовательский код или вызвать другие веб-тесты. Не вставляйте в тест циклы. Вы можете использовать стандартные подключаемые модули для веб-тестов.

5. Запустите тест в Visual Studio, чтобы проверить и убедиться, что он работает.

    Средство выполнения веб-тестов откроет веб-браузер и повторит записанные действия. Убедитесь, что все ведет себя так, как ожидалось.

## <a name="upload-the-web-test"></a>Отправка веб-теста

1. На портале Application Insights на панели доступности выберите **создать тестовый**  > **тип теста**  > **многошаговый веб-тест**.

2. Укажите расположения тестов, частоту и параметры оповещений.

### <a name="frequency--location"></a>Расположение & частоты

|Параметр| Пояснение
|----|----|----|
|**Периодичность проверки**| Задает частоту выполнения теста для всех тестовых расположений. При стандартной частоте в пять минут и с пятью тестовыми расположениями ваш сайт будет проверяться в среднем каждую минуту.|
|**Расположения тестов**| — Это места, из которых наши серверы отправляют веб-запросы на ваш URL-адрес. **Минимальное количество рекомендуемых тестовых расположений — пять** , чтобы вы могли отличать проблемы на веб-сайте от сетевых проблем. Вы можете выбрать до 16 таких расположений.

### <a name="success-criteria"></a>Условия успеха

|Параметр| Пояснение
|----|----|----|
| **Время ожидания теста** |Уменьшите значение этого параметра, чтобы получать оповещения о медленных откликах. Тест считается неудачной попыткой, если ответы от сайта не были получены в течение заданного периода. Если выбрать параметр **Анализировать зависимые запросы**, все изображения, файлы стилей, скрипты и другие зависимые ресурсы будут получены в течение этого периода.|
| **HTTP-ответ** | Возвращаемый код состояния, который считается успешным результатом. Код 200 указывает на возврат нормальной веб-страницы.|
| **Совпадение содержимого** | Строка, например "Добро пожаловать!" Проверим наличие точного совпадения (с учетом регистра) в каждом ответе. Это должна быть строка обычного текста без подстановочных знаков. Не забывайте, что если контент страницы изменяется, необходимо обновить эту строку. **С совпадением содержимого поддерживаются только английские символы** |

### <a name="alerts"></a>Оповещения

|Параметр| Пояснение
|----|----|----|
|**Почти в реальном времени (Предварительная версия)** | Мы рекомендуем использовать оповещения практически в реальном времени. Настройка этого типа оповещений выполняется после создания теста доступности.  |
|**Классический** | Мы больше не рекомендуем использовать классические оповещения для новых тестов доступности.|
|**Порог расположения предупреждения**|Мы рекомендуем как минимум 3 из 5 расположений. Оптимальное отношение между пороговым значением расположения предупреждений и числом расположений тестов — **пороговое значение расположения предупреждений**  = **число расположений тестирования — 2, с минимум пятью расположениями тестов.**|

## <a name="advanced-configuration"></a>Расширенная конфигурация

### <a name="plugging-time-and-random-numbers-into-your-test"></a>Подключение времени и случайных чисел к тесту

Предположим, что вы тестируете инструмент, который получает зависящие от времени данные (например, запасы) от внешнего источника. При записи веб-теста необходимо использовать определенные значения времени, но они должны быть заданы как параметры теста StartTime и EndTime.

![Снимок экрана приложения Awesome биржи](./media/availability-multistep/app-insights-72webtest-parameters.png)

При запуске теста параметру EndTime следует всегда присваивать текущее время, а параметру StartTime – время за 15 минут до текущего.

Подключаемый модуль даты и времени веб-теста предоставляет способ для работы со значениями параметризации.

1. Добавьте подключаемые модули веб-теста для всех необходимых значений переменных параметров. На панели инструментов веб-теста выберите **Добавить подключаемый модуль веб-теста**.
    
    ![Добавить подключаемый модуль веб-тестов](./media/availability-multistep/app-insights-72webtest-plugin-name.png)
    
    В этом примере используется два экземпляра подключаемого модуля даты и времени. Для первого экземпляра будет задано время за 15 минут до текущего, а для второго — текущее время.

2. Откройте свойства каждого подключаемого модуля. Присвойте ему имя и настройте его для использования текущего времени. Для одного из экземпляров задайте для параметра "Добавление минут" значение "-15".

    ![Параметры контекста](./media/availability-multistep/app-insights-72webtest-plugin-parameters.png)

3. В параметрах веб-теста используйте {{имя подключаемого модуля}} для ссылки на имя подключаемого модуля.

    ![StartTime](./media/availability-multistep/app-insights-72webtest-plugins.png)

Теперь можно передать тест на портал. Он будет использовать динамические значения при каждом тестировании.

### <a name="dealing-with-sign-in"></a>Работа с входом

Если пользователи входят в приложение, вы можете протестировать страницы входа, используя несколько способов имитации входа. Выбор подхода зависит от типа безопасности в приложении.

Во всех случаях учетную запись в приложении следует создавать только для целей тестирования. По возможности ограничьте разрешения для этой тестовой учетной записи, чтобы веб-тесты не доставляли неудобств реальным пользователям.

**Простое имя пользователя и пароль** Запишите веб-тест обычным способом. Сначала удалите файлы cookie.

**Проверка подлинности SAML**

|Имя свойства| Описание|
|----|-----|
| URI аудитории | URI аудитории для токена SAML.  Это универсальный код ресурса (URI) для службы контроля доступа (ACS), включая пространство имен ACS и имя узла. |
| Пароль сертификата | Пароль для сертификата клиента, который предоставит доступ к внедренному закрытому ключу. |
| Сертификат клиента  | Значение сертификата клиента с закрытым ключом в формате, закодированном в формате Base64. |
| Идентификатор имени | Идентификатор имени для токена |
| Не после | Интервал времени, для которого токен будет допустимым.  Значение по умолчанию — 5 минут. |
| До | Интервал времени, для которого создан токен, созданный в прошлом, будет допустимым (для адресации рассогласований во время).  Значение по умолчанию — (отрицательное) 5 минут. |
| Имя параметра контекста целевого объекта | Параметр контекста, который будет принимать созданное утверждение. |


**Секрет клиента** Если в приложении есть маршрут входа, включающий секрет клиента, используйте этот маршрут. Azure Active Directory (AAD) — это пример службы, в которой доступен вход в систему с использованием секрета клиента. В AAD секрет клиента — это ключ приложения.

Ниже приведен пример веб-теста веб-приложения Azure с использованием ключа приложения.

![Пример снимка экрана](./media/availability-multistep/client-secret.png)

Получите токен из Azure AD с помощью секрета клиента (AppKey).
Извлеките токен носителя из ответа.
Вызовите интерфейс API, используя токен носителя в заголовке авторизации.
Убедитесь, что веб-тест является фактическим клиентом, т. е. имеет собственное приложение в AAD, и используйте его ключ clientId +. У тестируемой службы также есть собственное приложение в AAD: универсальный код ресурса URI appID этого приложения содержится в веб-тесте в поле resource.

### <a name="open-authentication"></a>Открытая проверка подлинности
Пример открытой проверки подлинности — это вход с помощью учетной записи Майкрософт или Google. Многие приложения, использующие OAuth, предоставляют альтернативный вариант с использованием секрета клиента, поэтому сначала стоит попробовать эту возможность.

Если в вашем тесте должен выполняться вход с использованием OAuth, общий порядок действий таков:

Проверьте трафик между веб-браузером, сайтом проверки подлинности и приложением при помощи Fiddler или аналогичного средства.
Выполните вход несколько раз с разных компьютеров или из разных браузеров либо через большие промежутки времени (чтобы истек срок действия маркеров).
Сравнивая различные сеансы, определите маркер, возвращаемый с сайта проверки подлинности, который затем передается на сервер приложения после входа.
Запишите веб-тест с помощью Visual Studio.
Параметризуйте маркеры, задав параметр при возврате маркера из структуры проверки подлинности и использовав его в запросе к сайту. (Visual Studio попытается параметризовать тест, но не сможет правильно параметризовать маркеры).

## <a name="troubleshooting"></a>Устранение неисправностей

Выделенная [статья по устранению неполадок](troubleshoot-availability.md).

## <a name="next-steps"></a>Дальнейшие действия

* [Оповещения о доступности](availability-alerts.md)
* [Веб-тесты проверки связи URL](monitor-web-app-availability.md)
