---
title: Монитор с многоступенчатыми веб-тестами - Azure Application Insights
description: Настройка многоступенчатых веб-тестов для мониторинга веб-приложений с помощью Azure Application Insights
ms.topic: conceptual
ms.date: 10/23/2019
ms.reviewer: sdash
ms.openlocfilehash: 3b8baad127b16a1bd9d071d0c3d4df68da8c3304
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77655946"
---
# <a name="multi-step-web-tests"></a>Многошаговые веб-тесты

Вы можете контролировать записанную последовательность URL-адресов и взаимодействий с веб-сайтом с помощью многоступенчатых веб-тестов. Эта статья проведет вас через процесс создания многоступенчатого веб-теста с Visual Studio Enterprise.

> [!NOTE]
> Многоступенчатые веб-тесты зависят от веб-тестов Visual Studio. Было [объявлено,](https://devblogs.microsoft.com/devops/cloud-based-load-testing-service-eol/) что Visual Studio 2019 станет последней версией с функциональностью webtest. Важно понимать, что в то время как новые функции не будут добавлены, веб-тест функциональность в Visual Studio 2019 по-прежнему в настоящее время поддерживается и будет по-прежнему поддерживается в течение жизненного цикла поддержки продукта. Команда разработчиков Azure Monitor рассмотрела здесь вопросы, касающиеся будущего многоэтапных [тестов](https://github.com/MicrosoftDocs/azure-docs/issues/26050#issuecomment-468814101)доступности.  

## <a name="pre-requisites"></a>Предварительные требования

* Визуальная студия 2017 Предприятие или больше.
* Визуальные студии веб-производительности и нагрузочных инструментов тестирования.

Чтобы найти инструменты предварительного тестирования. Запуск **Visual Studio Установка** > **Индивидуальные компоненты** > **Отладка и тестирование** > **веб-производительности и загрузки инструментов тестирования.**

![Скриншот uI установки Visual Studio с отдельными компонентами, выбранными с флажком рядом с товаром для инструментов веб-производительности и тестирования нагрузки](./media/availability-multistep/web-performance-load-testing.png)

> [!NOTE]
> Многоступенчатые веб-тесты сопряжены с дополнительными затратами. Чтобы узнать больше, обратитесь к [официальному руководству ценообразования](https://azure.microsoft.com/pricing/details/application-insights/).

## <a name="record-a-multi-step-web-test"></a>Запись многоступенчатого веб-теста 

> [!WARNING]
> Мы больше не рекомендуем использовать многоступенчатый диктофон. Диктофон был разработан для статических HTML-страниц с основными взаимодействиями и не обеспечивает функционального опыта для современных веб-страниц.

Для получения рекомендаций по созданию визуальных студийных веб-тестов обратитесь к [официальной визуальной студии 2019 документации](https://docs.microsoft.com/visualstudio/test/how-to-create-a-web-service-test?view=vs-2019).

## <a name="upload-the-web-test"></a>Загрузить веб-тест

1. На портале Application Insights на панели доступности выберите **Создать тест** > **тест типа** > **Multi-шаг веб-тест.**

2. Установите параметры тестовых мест, частоты и оповещения.

### <a name="frequency--location"></a>Частота & местоположения

|Параметр| Объяснение
|----|----|----|
|**Частота теста**| Задает частоту выполнения теста для всех тестовых расположений. При стандартной частоте в пять минут и с пятью тестовыми расположениями ваш сайт будет проверяться в среднем каждую минуту.|
|**Местопроведения**| Это места, откуда наши серверы отправляют веб-запросы на ваш URL. **Наше минимальное количество рекомендуемых тестовых мест составляет пять,** чтобы гарантировать, что вы можете отличить проблемы на вашем сайте от сетевых проблем. Вы можете выбрать до 16 таких расположений.

### <a name="success-criteria"></a>Критерии успеха

|Параметр| Объяснение
|----|----|----|
| **Тайм-аут тестирования** |Уменьшите значение этого параметра, чтобы получать оповещения о медленных откликах. Тест считается неудачной попыткой, если ответы от сайта не были получены в течение заданного периода. Если выбрать параметр **Анализировать зависимые запросы**, все изображения, файлы стилей, скрипты и другие зависимые ресурсы будут получены в течение этого периода.|
| **ОТВЕТ HTTP** | Возвращаемый код состояния, который считается успешным результатом. Код 200 указывает на возврат нормальной веб-страницы.|
| **совпадение содержимого** | Строка, как "Добро пожаловать!" Проверим наличие точного совпадения (с учетом регистра) в каждом ответе. Это должна быть строка обычного текста без подстановочных знаков. Не забывайте, что если контент страницы изменяется, необходимо обновить эту строку. **Только английские символы поддерживаются с одержимо-совпадением** |

### <a name="alerts"></a>видны узлы

|Параметр| Объяснение
|----|----|----|
|**Ближайшее время (Предварительный просмотр)** | Рекомендуем использовать оповещения в режиме реального времени. Настройка этого типа оповещения выполняется после создания теста доступности.  |
|**Классический** | Мы больше не рекомендуем использовать классические оповещения для новых тестов доступности.|
|**Порог местоположения оповещения**|Мы рекомендуем как минимум 3 из 5 расположений. Оптимальная взаимосвязь между порогом местоположения оповещения и числом местоположений **тестирования** = — это**пороговое число тестовых мест - 2, с минимум пятью тестовыми местами.**|

## <a name="configuration"></a>Параметр Configuration

### <a name="plugging-time-and-random-numbers-into-your-test"></a>Подключение времени и случайных чисел в тест

Предположим, что вы тестируете инструмент, который получает зависящие от времени данные (например, запасы) от внешнего источника. При записи веб-теста необходимо использовать определенные значения времени, но они должны быть заданы как параметры теста StartTime и EndTime.

![Мой удивительный фондовый приложение скриншот](./media/availability-multistep/app-insights-72webtest-parameters.png)

При запуске теста параметру EndTime следует всегда присваивать текущее время, а параметру StartTime – время за 15 минут до текущего.

Плагин Времени веб-тестирования обеспечивает способ обработки времени параметризации.

1. Добавьте подключаемые модули веб-теста для всех необходимых значений переменных параметров. На панели инструментов веб-теста выберите **Добавить подключаемый модуль веб-теста**.
    
    ![Добавить веб-тест Plug-in](./media/availability-multistep/app-insights-72webtest-plugin-name.png)
    
    В этом примере используется два экземпляра подключаемого модуля даты и времени. Для первого экземпляра будет задано время за 15 минут до текущего, а для второго — текущее время.

2. Откройте свойства каждого подключаемого модуля. Присвойте ему имя и настройте его для использования текущего времени. Для одного из экземпляров задайте для параметра "Добавление минут" значение "-15".

    ![Параметры контекста](./media/availability-multistep/app-insights-72webtest-plugin-parameters.png)

3. В параметрах веб-теста используйте {{имя подключаемого модуля}} для ссылки на имя подключаемого модуля.

    ![StartTime](./media/availability-multistep/app-insights-72webtest-plugins.png)

Теперь можно передать тест на портал. Он будет использовать динамические значения при каждом тестировании.

### <a name="dealing-with-sign-in"></a>Работа с входом

Если пользователи входят в приложение, вы можете протестировать страницы входа, используя несколько способов имитации входа. Выбор подхода зависит от типа безопасности в приложении.

Во всех случаях учетную запись в приложении следует создавать только для целей тестирования. По возможности ограничьте разрешения для этой тестовой учетной записи, чтобы веб-тесты не доставляли неудобств реальным пользователям.

**Простое имя пользователя и пароль** Запись веб-теста обычным способом. Сначала удалите файлы cookie.

**Проверка подлинности SAML**

|Имя свойства| Описание|
|----|-----|
| Аудитория Ури | Аудитория URI для токена SAML.  Это URI для Службы контроля доступа (ACS), включая пространство имен ACS и имя хоста. |
| Пароль сертификата | Пароль для сертификата клиента, который предоставит доступ к встроенному частному ключу. |
| Сертификат клиента  | Значение сертификата клиента с закрытым ключом в закодированном формате Base64. |
| Идентификатор имени | Идентификатор имени для токена |
| Дата окончания срока действия | Срок, в течение которого токен будет действителен.  Значение по умолчанию равно 5 минутам. |
| До | Временной промежуток, для которого токен, созданный в прошлом, будет действительным (для устранения перекосов времени).  По умолчанию (отрицательный) 5 минут. |
| Целевой контекст Параметры | Параметр контекста, который получит генерируемое утверждение. |


**Секрет клиента** Если у вашего приложения есть маршрут регистрации, который включает в себя секрет клиента, используйте этот маршрут. Azure Active Directory (AAD) — это пример службы, в которой доступен вход в систему с использованием секрета клиента. В AAD секрет клиента — это ключ приложения.

Ниже приведен пример веб-теста веб-приложения Azure с использованием ключа приложения.

![Образец скриншота](./media/availability-multistep/client-secret.png)

Получите токен из Azure AD с помощью секрета клиента (AppKey).
Извлеките токен носителя из ответа.
Вызовите интерфейс API, используя токен носителя в заголовке авторизации.
Убедитесь, что веб-тест является фактическим клиентом - то есть, он имеет свое собственное приложение в AAD - и использовать свой ключ приложения clientId. У тестируемой службы также есть собственное приложение в AAD: универсальный код ресурса URI appID этого приложения содержится в веб-тесте в поле resource.

### <a name="open-authentication"></a>Открытая проверка подлинности
Пример открытой проверки подлинности — это вход с помощью учетной записи Майкрософт или Google. Многие приложения, использующие OAuth, предоставляют альтернативный вариант с использованием секрета клиента, поэтому сначала стоит попробовать эту возможность.

Если в вашем тесте должен выполняться вход с использованием OAuth, общий порядок действий таков:

Проверьте трафик между веб-браузером, сайтом проверки подлинности и приложением при помощи Fiddler или аналогичного средства.
Выполните вход несколько раз с разных компьютеров или из разных браузеров либо через большие промежутки времени (чтобы истек срок действия маркеров).
Сравнивая различные сеансы, определите маркер, возвращаемый с сайта проверки подлинности, который затем передается на сервер приложения после входа.
Запишите веб-тест с помощью Visual Studio.
Параметризуйте маркеры, задав параметр при возврате маркера из структуры проверки подлинности и использовав его в запросе к сайту. (Visual Studio попытается параметризовать тест, но не сможет правильно параметризовать маркеры).

## <a name="troubleshooting"></a>Устранение неполадок

Выделенная [статья для устранения неполадок](troubleshoot-availability.md).

## <a name="next-steps"></a>Дальнейшие действия

* [Оповещения о доступности](availability-alerts.md)
* [Url пинг веб-тесты](monitor-web-app-availability.md)
