---
title: Управление использованием и затратами для Azure Application Insights | Документация Майкрософт
description: Управление объемом данных телеметрии и контроль расходов в Application Insights.
ms.topic: conceptual
author: DaleKoetke
ms.author: dalek
ms.date: 11/27/2019
ms.reviewer: mbullwin
ms.openlocfilehash: 0225484de06ae4e595f1dcbcdd520f4e0e4d53f5
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81405387"
---
# <a name="manage-usage-and-costs-for-application-insights"></a>Управление использованием и затратами для Application Insights

> [!NOTE]
> В этой статье описывается, как понять и контролировать свои расходы на Application Insights.  В соответствующей статье [«Мониторинг использования и сметных затрат»](https://docs.microsoft.com/azure/azure-monitor/platform/usage-estimated-costs) описывается, как просматривать использование и сметные затраты в нескольких функциях мониторинга Azure для различных моделей ценообразования.

Application Insights предназначен для получения всего необходимого для мониторинга доступности, производительности и использования веб-приложений, независимо от того, размещаются ли они в Azure или в помещениях. Application Insights поддерживает популярные языки и платформы, такие как .NET, Java и Node.js, и интегрируется с процессами и инструментами DevOps, такими как Azure DevOps, Jira и PagerDuty. Важно понимать, что определяет затраты на мониторинг приложений. В этой статье мы рассмотрим, что движет затратами на мониторинг приложений и как вы можете активно контролировать и контролировать их.

Если у вас возникли вопросы о принципах формирования цен на Application Insights, вы можете задать их на нашем [форуме](https://social.msdn.microsoft.com/Forums/home?forum=ApplicationInsights&filter=alltypes&sort=lastpostdesc).

## <a name="pricing-model"></a>Модель ценообразования

Ценообразование для [Azure Application Insights][start] — это модель **Pay-As-You-Go,** основанная на объеме данных, вемыхае и дополнительно для более длительного хранения данных. Каждый ресурс Application Insights оплачивается как отдельная служба и включается в счет за подписку Azure. Объем данных оценивается по размеру несжатых пакетов данных в формате JSON, получаемых службой Application Insights от вашего приложения. Плата за использование [Live Metrics Stream](../../azure-monitor/app/live-stream.md)не взимается с объема данных.

За [многошаговые веб-тесты](../../azure-monitor/app/availability-multistep.md) взимается дополнительная плата. Это веб-тесты, в ходе которых выполняется несколько последовательных действий. За обычную *проверку связи* для одной страницы отдельная плата не взимается. Объем данных телеметрии, переданных в ходе проверки связи или многошагового теста, оплачивается так же, как другие данные телеметрии из вашего приложения.

Опция Application Insights для [включения оповещения о пользовательских измерениях метрик](https://docs.microsoft.com/azure/azure-monitor/app/pre-aggregated-metrics-log-metrics#custom-metrics-dimensions-and-pre-aggregation) также может привести к дополнительным затратам, поскольку это может привести к созданию дополнительных метрик до агрегирования. [Узнайте больше](https://docs.microsoft.com/azure/azure-monitor/app/pre-aggregated-metrics-log-metrics) о метриках на основе журналов и предварительно агрегированных в application Insights и о ценах на пользовательские [метрики](https://azure.microsoft.com/pricing/details/monitor/) Azure Monitor.

## <a name="estimating-the-costs-to-manage-your-application"></a>Оценка затрат на управление приложением

Если вы еще не используете Application Insights, вы можете использовать [калькулятор цен Azure Monitor](https://azure.microsoft.com/pricing/calculator/?service=monitor) для оценки стоимости использования Application Insights. Начните с ввода "Azure Monitor" в поле поиска и нажатия на полученную плитку Azure Monitor. Прокрутите страницу до Azure Monitor и выберите анализ приложений из момента отбрасывания типа.  Здесь вы можете ввести количество ГБ данных, которые вы ожидаете собирать в месяц, так что вопрос в том, сколько данных будет Application Insights собирать мониторинг вашего приложения.

Существует два подхода к решению этой проблемы: использование мониторинга по умолчанию и адаптивной выборки, которая доступна в ASP.NET SDK, или оценка вероятного приема данных на основе того, что видели другие подобные клиенты.

### <a name="data-collection-when-using-sampling"></a>Сбор данных при использовании выборки

При [ASP.NET адаптивной выборке](sampling.md#adaptive-sampling)SDK объем данных автоматически корректируется, чтобы держать в пределах указанной максимальной скорости трафика для мониторинга Application Insights по умолчанию. Если приложение производит небольшое количество телеметрии, например, при отладке или из-за низкого использования, элементы не будут удалены процессором выборки до тех пор, пока объем ниже настроенных событий в секунду. Для приложения с большим объемом, с порогом по умолчанию в пять событий в секунду, адаптивная выборка ограничит количество ежедневных событий до 432 000. Используя типичный средний размер события 1 КБ, это соответствует 13,4 ГБ телеметрии за 31-дневный месяц на узла, намещающих ваше приложение (поскольку выборка выполняется локально для каждого узла). 

Для SDK, не поддерживающих адаптивную выборку, можно использовать [выборку приема,](https://docs.microsoft.com/azure/azure-monitor/app/sampling#ingestion-sampling)которая пробы, когда данные получены Application Insights на основе процента данных для сохранения, или [выборки с фиксированной ставкой для ASP.NET, ASP.NET Core и Веб-сайтов Java,](sampling.md#fixed-rate-sampling) чтобы уменьшить трафик, отправленный с вашего веб-сервера и веб-браузеров

### <a name="learn-from-what-similar-customers-collect"></a>Узнайте, что собирают подобные клиенты

В калькуляторе цен на цены мониторинга Azure для Application Insights, если вы включите функцию "Оценка объема данных на основе активности приложения", вы можете предоставить данные о вашем приложении (запросы в месяц и просмотры страниц в месяц, в случае, если вы будете собирать телеметрию со стороны клиента), а затем калькулятор сообщит вам средний и 90-й процентильный объем данных, собранных аналогичными приложениями. Эти приложения охватывают диапазон конфигурации Application Insights (например, некоторые из них имеют [выборку](../../azure-monitor/app/sampling.md)по умолчанию, некоторые из них не имеют выборки и т.д.), так что у вас все еще есть контроль, чтобы уменьшить объем данных, которые вы глотаете гораздо ниже медианного уровня с помощью выборки. Но это отправная точка, чтобы понять, что другие, подобные клиенты видят.

## <a name="understand-your-usage-and-estimate-costs"></a>Понимание затрат на использование и оценка

В Applicaition Insights легко разобраться с затратами, которые, как правило, основаны на последних шаблонах использования. Чтобы приступить к работе, перейдите на страницу **Данные об использовании и предполагаемые расходы** для ресурса Application Insights на портале Azure.

![Выбор цен](./media/pricing/pricing-001.png)

A. Просмотрите сведения об объеме данных на месяц. К ним относятся все полученные и сохраненные данные (после любой [выборки](../../azure-monitor/app/sampling.md) из серверных и клиентских приложений, а также с тестов доступности).  
Б. Отдельно плата взимается за [многошаговые веб-тесты](../../azure-monitor/app/availability-multistep.md). (К ним не относятся простые тесты доступности, плата за которые взимается при выставлении счетов за используемый объем данных.)  
В. Просмотр тенденций объемов данных за последний месяц.  
Г. [Выборка](../../azure-monitor/app/sampling.md) при приеме данных.
Д. Настройка ежедневного ограничения объема данных.  

(Обратите внимание, что все цены, отображаемые на скриншотах в этой статье, являются только для целей. Для текущих цен в вашей валюте и регионе, см [Application Insights ценообразования][pricing].)

Для получения более детальных сведений об использовании Application Insights откройте страницу **Метрики**, добавьте метрику "Объем точки данных", а затем выберите *Применить разделение*, чтобы разделить данные по типу элемента телеметрии.

Оплата за использование Application Insights добавляется в счет Azure. Дополнительную информацию о счете за подписку на Azure можно просмотреть в разделе **Выставление счетов** портала Azure или на [портале выставления счетов Azure](https://account.windowsazure.com/Subscriptions).

![В меню слева выберите "Выставление счетов".](./media/pricing/02-billing.png)

### <a name="using-data-volume-metrics"></a>Использование метрик объема данных
<a id="understanding-ingested-data-volume"></a>

Чтобы узнать больше об объемах данных, выбрав **метрики** для ресурса Application Insights, добавьте новую диаграмму. Для метрики диаграммы, в соответствии **с логина на основе метрик**, выберите **объем точки данных.** Нажмите **Применить расщепление**, и выбрать группу по ** `Telemetryitem` типу**.

![Используйте метрики для изучения объема данных](./media/pricing/10-billing.png)

### <a name="queries-to-understand-data-volume-details"></a>Запросы для понимания деталей объема данных

Существует два подхода к изучению объемов данных для Application Insights. Первый использует агрегированную информацию в `systemEvents` `_BilledSize` таблице, а второй — свойство, доступное на каждом проглатированном событии.

#### <a name="using-aggregated-data-volume-information"></a>Использование агрегированной информации об объеме данных

Например, можно использовать `systemEvents` таблицу для просмотра объема данных, поданных за последние 24 часа, с помощью запроса:

```kusto
systemEvents
| where timestamp >= ago(24h)
| where type == "Billing"
| extend BillingTelemetryType = tostring(dimensions["BillingTelemetryType"])
| extend BillingTelemetrySizeInBytes = todouble(measurements["BillingTelemetrySize"])
| summarize sum(BillingTelemetrySizeInBytes)
```

Или чтобы увидеть диаграмму объема данных (в байтах) по типу данных за последние 30 дней, можно использовать:

```kusto
systemEvents
| where timestamp >= startofday(ago(30d))
| where type == "Billing"
| extend BillingTelemetryType = tostring(dimensions["BillingTelemetryType"])
| extend BillingTelemetrySizeInBytes = todouble(measurements["BillingTelemetrySize"])
| summarize sum(BillingTelemetrySizeInBytes) by BillingTelemetryType, bin(timestamp, 1d) | render barchart  
```

Обратите внимание, что этот запрос может быть использован в [оповещении журнала Azure](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-unified-log) для настройки оповещения о объемах данных.  

Чтобы узнать больше об изменениях телеметрических данных, мы можем получить подсчет событий по типу с помощью запроса:

```kusto
systemEvents
| where timestamp >= startofday(ago(30d))
| where type == "Billing"
| extend BillingTelemetryType = tostring(dimensions["BillingTelemetryType"])
| summarize count() by BillingTelemetryType, bin(timestamp, 1d)
| render barchart  
```

#### <a name="using-data-size-per-event-information"></a>Использование размера данных на информацию о событии

Чтобы узнать больше об источнике объемов данных, `_BilledSize` можно использовать свойство, присутствуюте на каждом событии, прогуливаемом.

Например, чтобы посмотреть, какие операции генерируют наибольший объем данных за последние 30 дней, мы можем суммировать `_BilledSize` все события зависимости:

```kusto
dependencies
| where timestamp >= startofday(ago(30d))
| summarize sum(_BilledSize) by operation_Name
| render barchart  
```

## <a name="viewing-application-insights-usage-on-your-azure-bill"></a>Просмотр использования приложений на счете Azure

Azure предоставляет большую полезную функциональность в центре [управления затратами Azure и Биллинга.](https://docs.microsoft.com/azure/cost-management/quick-acm-cost-analysis?toc=/azure/billing/TOC.json) Например, функция «Анализ затрат» позволяет просматривать расходы ресурсов Azure. Добавление фильтра по типу ресурсов (к microsoft.insights/components for Application Insights) позволит вам отслеживать ваши расходы.

Более глубокое понимание использования можно получить, [загрузив использование с портала Azure.](https://docs.microsoft.com/azure/billing/billing-download-azure-invoice-daily-usage-date#download-usage-in-azure-portal)
В загруженной таблице можно увидеть использование ресурса Azure в день. В этой таблице Excel использование ресурсов Application Insights можно найти, сначала отфильтровав в столбце "Категория метр", чтобы показать "Application Insights" и "Log Analytics", а затем добавить фильтр в столбце "Instance ID", который "содержит microsoft.insights/components".  Большинство использования Application Insights сообщается на счетчиках с meter Category of Log Analytics, так как для всех компонентов Azure Monitor имеется единый бэкэнд журналов.  Сообщается только о ресурсах Application Insights о устаревших уровнях ценообразования и многоступенчатых веб-тестах с помощью категории Meter of Application Insights.  Использование отображается в столбце "Потребление" и единица для каждой записи отображается в столбце "Единица измерения".  Более подробная информация доступна, чтобы помочь вам [понять ваш счет Microsoft Azure](https://docs.microsoft.com/azure/billing/billing-understand-your-bill).

## <a name="managing-your-data-volume"></a>Управление объемом данных

Объем омраотправлятьих данных можно использовать следующими методами:

* **Выборка.** Позволяет уменьшить объем данных телеметрии, отправляемых из серверных и клиентских приложений, с минимальным искажением метрик. Это основное средство, с помощью которого можно настроить объем отправляемых данных. Дополнительные сведения см. в статье [Выборка в Application Insights](../../azure-monitor/app/sampling.md).

* **Ограничьте вызовы Ajax:** можно [ограничить количество вызовов Ajax, о которых можно сообщить](../../azure-monitor/app/javascript.md#configuration) в каждом представлении страницы, или отключить отчетность Ajax.

* **Отключение ненужных модулей:** [Отстежь ApplicationInsights.config,](../../azure-monitor/app/configuration-with-applicationinsights-config.md) чтобы отключить модули сбора, которые вам не нужны. Например, вы можете решить, что счетчики производительности или данные зависимостей не являются необходимыми.

* **Предварительно агрегированные метрики:** Если вы размещаете вызовы TrackMetric в приложении, вы можете уменьшить трафик, используя перегрузку, которая принимает ваш расчет среднего и стандартного отклонения партии измерений. Кроме того, вы можете использовать [пакет предварительных статистических вычислений](https://www.myget.org/gallery/applicationinsights-sdk-labs).
 
* **Ежедневное ограничение.** При создании ресурса Application Insights на портале Azure устанавливается ограничение, которое составляет 100 ГБ в день. Ограничение по умолчанию при создании ресурса Application Insights в Visual Studio невелико (всего 32,3 МБ в день). Ежедневное ограничение по умолчанию задается для упрощения тестирования. Предполагается, что пользователь повысит ежедневное ограничение перед развертыванием приложения в рабочую среду. 

    Максимальное ограничение составляет 1000 ГБ в день. Вы можете запросить большее ограничение для приложения с большим объемом трафика.
    
    Предупреждающие письма о дневном лимите отправляются на учетные записи, которые являются участниками этих ролей для вашего ресурса Application Insights: "ServiceAdmin", "AccountAdmin", "CoAdmin", "Owner".

    Будьте внимательны при задании ежедневного ограничения. Следует предполагать, что вы *никогда не достигнете его*. При достижении ежедневного ограничения вы потеряете данные за остаток дня и не сможете наблюдать за приложением. Чтобы изменить ежедневное ограничение, используйте параметр **Ежедневное ограничение объема**. Этот параметр можно настроить в области **Usage and estimated costs** (Данные об использовании и предполагаемые расходы). Это описано более подробно далее в этой статье.
    
    Мы удалили ограничение для некоторых типов подписок с кредитом, который не может использоваться для Application Insights. Ранее, если для подписки была задана предельная сумма расходов, то в колонке ежедневного ограничения отображались инструкции по ее удалению, а также включению возможности повышения этого ограничения свыше 32,3 МБ в день.
    
* **Регулирование.** Ограничивает скорость передачи данных 32 000 событий в секунду на ключ инструментирования, с усреднением за периоды по 1 минуте. Объем данных, отправляемых приложением, оценивается каждую минуту. Если он превышает среднюю минутную частоту, сервер отклоняет часть запросов. Пакет SDK буферизует данные, а затем пытается повторно отправить их. Он распределяет резкое увеличение трафика на несколько минут. Если приложение постоянно отправляет данные с частотой, превышающей частоту регулирования, некоторые данные будут пропущены. (ASP.NET, Java и JavaScript SDK пытаются отправить данные таким образом; другие SDK могут просто упасть с задушенные данные.) Если происходит регулирование, предупреждение о предупреждении предупреждает вас о том, что это произошло.

## <a name="manage-your-maximum-daily-data-volume"></a>Управление максимальным ежедневным объемом данных

Можно использовать ежедневное ограничение, чтобы ограничить объем собираемых данных. Тем не менее, если это ограничение достигнуто, теряются все данные телеметрии, отправленные из приложения за остаток дня. *Не рекомендуется* допускать достижения приложением ежедневного ограничения. После достижения ежедневного ограничения невозможно отслеживать работоспособность и производительность приложения.

Вместо ежедневного ограничения объема используйте [выборку](../../azure-monitor/app/sampling.md), чтобы настроить объем данных до требуемого уровня. Затем используйте ежедневное ограничение как "крайнюю меру" в случае, если приложение неожиданно начинает отправлять намного большие объемы данных телеметрии.

### <a name="identify-what-daily-data-limit-to-define"></a>Определение ежедневного ограничения по сбору данных

Просмотрите использование приложений Insights и сметные затраты, чтобы понять тенденцию к потреблению данных и то, что ежедневный предел объема определить. Это следует рассматривать с осторожностью, так как вы не сможете контролировать свои ресурсы после того, как предел будет достигнут.

### <a name="set-the-daily-cap"></a>Установить ежедневную крышку

Чтобы изменить дневную крышку, в разделе **Настройка** ресурса Application Insights на странице **«Использование и сметные расходы»** выберите **Daily Cap.**

![Настройка ограничения ежедневного объема данных телеметрии](./media/pricing/pricing-003.png)

Чтобы [изменить дневной лимит через менеджер ресурсов Azure,](../../azure-monitor/app/powershell.md)свойство изменить . `dailyQuota`  Через менеджер ресурсов Azure вы `dailyQuotaResetTime` также можете установить и дневной `warningThreshold`колпачок.

### <a name="create-alerts-for-the-daily-cap"></a>Создание оповещений для Daily Cap

В приложении Insights Daily Cap создается событие в журнале активности Azure, когда объемы данных, попавшие в попадание, достигли уровня предупреждения или дневного уровня крышки.  Можно [создать оповещение на основе этих событий журнала активности.](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-activity-log#create-with-the-azure-portal) Имена сигналов для этих событий:

* Компонент приложения Insights с ежедневным порогом предупреждения крышки достигнут

* Компонент приложения Исследования суточным лимитом достиг

## <a name="sampling"></a>Выборка
[Выборка](../../azure-monitor/app/sampling.md) позволяет уменьшить скорость отправки данных телеметрии в ваше приложение. Она позволяет искать связанные события при поиске по журналу диагностики. Она также позволяет сохранить правильные значения числа событий.

Выборка — это эффективный способ сократить затраты и оставаться в пределах месячной квоты. Алгоритм выборки сохраняет связанные элементы телеметрии, поэтому, например, при использовании поиска можно найти запрос, относящийся к конкретному исключению. Алгоритм также сохраняет правильные количества, чтобы вы видели в обозревателе метрик правильные значения частоты запросов, частоты исключений и других счетчиков.

Существует несколько видов выборки.

* По умолчанию для пакета SDK для ASP.NET используется [адаптивная выборка](../../azure-monitor/app/sampling.md). Адаптивная выборка автоматически настраивается в соответствии с объемом данных телеметрии, отправляемых приложением. Она оперирует данными в пакете SDK в вашем веб-приложении, что позволяет уменьшить сетевой трафик телеметрии. 
* *Выборка приема* — это другая функция, которая работает в точке, где данные телеметрии из приложения поступают в службу Application Insights. Выборка приема не влияет на объем данных телеметрии, отправляемых из приложения, но уменьшает объем данных, сохраняемых службой. С помощью этой выборки можно уменьшить квоту, заданную для данных телеметрии, которые поступают из браузеров и других пакетов SDK.

Чтобы настроить выборку приема, перейдите в область **Цены**.

![В диалоговом окне "Quotas and pricing" (Квоты и цены) щелкните элемент "Выборки" и выберите долю выборки.](./media/pricing/pricing-004.png)

> [!WARNING]
> В области **Выборка данных** отражается только значение выборки приема. В ней не отражается частота выборки, которую применяет пакет SDK для Application Insights в приложении. Если по входящей телеметрии уже сделана выборка в пакете SDK, то выборка приема не применяется.
>

Чтобы узнать фактическую частоту выборки (где бы она ни применялась), выполните [запрос Analytics](analytics.md). Этот запрос выглядит следующим образом.

    requests | where timestamp > ago(1d)
    | summarize 100/avg(itemCount) by bin(timestamp, 1h)
    | render areachart

Для каждой сохранившейся записи `itemCount` обозначает число исходных записей, которые эта запись представляет. Эта величина равна 1 + число предыдущих удаленных записей.

## <a name="change-the-data-retention-period"></a>Изменение срока хранения данных

Сохранение по умолчанию для ресурсов Application Insights составляет 90 дней. Для каждого ресурса Application Insights могут быть выбраны различные периоды хранения. Полный набор доступных периодов удержания составляет 30, 60, 90, 120, 180, 270, 365, 550 или 730 дней.

Чтобы изменить удержание, с ресурса Application Insights, перейдите на страницу **«Использование и сметные затраты»** и выберите опцию **хранения данных:**

![Настройка ограничения ежедневного объема данных телеметрии](./media/pricing/pricing-005.png)

При понижении удержания существует несколько дней льготного периода до удаления самых старых данных.

Удержание также может быть [установлено программно с помощью PowerShell](powershell.md#set-the-data-retention) с использованием `retentionInDays` параметра. Если установить сохранение данных до 30 дней, можно вызвать `immediatePurgeDataOn30Days` немедленную очистку старых данных с помощью параметра, что может быть полезно для сценариев, связанных с соответствием. Эта функция очистки разоблачается только через Azure Resource Manager и должна использоваться с особой осторожностью. Ежедневное время сбросить крышку объема данных можно настроить с `dailyQuotaResetTime` помощью менеджера ресурсов Azure для настройки параметра.

## <a name="data-transfer-charges-using-application-insights"></a>Плата за передачу данных с помощью Application Insights

Отправка данных в Application Insights может повлечь за себя плату за пропускную способность данных. Как описано на [странице ценообразования Azure Bandwidth,](https://azure.microsoft.com/pricing/details/bandwidth/)передача данных между службами Azure, расположенными в двух регионах, взимается как передача исходящих данных с обычной скоростью. Входная передача данных бесплатна. Тем не менее, эта плата очень мала (несколько %) по сравнению с затратами на прием данных в журнале Application Insights. Следовательно, контроль затрат на log Analytics должен быть сосредоточен на объеме данных, и у нас есть рекомендации, которые помогут понять это [здесь.](https://docs.microsoft.com/azure/azure-monitor/app/pricing#managing-your-data-volume)

## <a name="limits-summary"></a>Сводная таблица ограничений

[!INCLUDE [application-insights-limits](../../../includes/application-insights-limits.md)]

## <a name="disable-daily-cap-e-mails"></a>Отключение ежедневных электронных писем

Чтобы отключить ежедневное ограничение объема электронных писем, в разделе **Настройки** ресурса Application Insights в области **Usage and estimated costs** (Данные об использовании и предполагаемые расходы) выберите **Ежедневное ограничение**. Существуют параметры для отправки писем при достижении ограничения, а также при достижении порога предупреждений. Если вы хотите отключить все ежедневные сообщения, связанные с объемом крышки, отоверьте обе коробки.

## <a name="legacy-enterprise-per-node-pricing-tier"></a>Устаревший энтерий (Per Node) ценовой уровень

Для первых пользователей Azure Application Insights есть еще два возможных уровня ценообразования: Basic и Enterprise. Базовый уровень ценообразования такой же, как описано выше, и является уровнем по умолчанию. Она включает в себя все функции уровня предприятия, без каких-либо дополнительных затрат. Основной уровень счета в первую очередь на объем данных, которые попадает.

> [!NOTE]
> Эти устаревшие уровни ценообразования были переименованы. Уровень ценообразования предприятия теперь называется **Per Node,** а базовый уровень ценообразования теперь называется **Per GB.** Эти новые имена используются ниже и на портале Azure.  

Уровень Per Node (ранее Enterprise) имеет плату за узлы, и каждый узла получает суточную надбавку к данным. В уровне ценообразования Per Node с вас взимается плата за данные, понижаемые выше включенной надбавки. Если вы используете набор управления операциями, вы должны выбрать уровень Per Node.

Текущие цены в валюте вашей страны для выбранного региона вы можете узнать на [странице цен на Application Insights](https://azure.microsoft.com/pricing/details/application-insights/).

> [!NOTE]
> В апреле 2018 года была [представлена](https://azure.microsoft.com/blog/introducing-a-new-way-to-purchase-azure-monitoring-services/) новая модель ценообразования для служб мониторинга Azure. Эта модель использует простой принцип "с оплатой по мере использования" во всем портфеле служб мониторинга. Узнайте больше о [новой модели ценообразования,](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-usage-and-estimated-costs)как [оценить влияние перехода к этой модели](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-usage-and-estimated-costs#understanding-your-azure-monitor-costs) на основе шаблонов использования, и как выбрать в [новую модель](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-usage-and-estimated-costs#azure-monitor-pricing-model)

### <a name="per-node-tier-and-operations-management-suite-subscription-entitlements"></a>Уровень Per Node и права на подписку на управление операциями Suite

Клиенты, приобретающие набор управления операциями E1 и E2, могут получить Application Insights Per Node в качестве дополнительного компонента без каких-либо дополнительных затрат, как [было объявлено ранее.](https://blogs.technet.microsoft.com/msoms/2017/05/19/azure-application-insights-enterprise-as-part-of-operations-management-suite-subscription/) В частности, каждая единица пакета управления операциями E1 и E2 включает в себя право на один узлы уровня Application Insights Per Node. Каждый узел Application Insights включает до 200 МБ ежедневно обрабатываемых данных (отдельно от получаемых данных Log Analytics), которые хранятся в течение 90 дней. Дополнительная плата за это не взимается. Уровень описан более подробно позже в статье.

Поскольку этот уровень применим только к клиентам с подпиской «Сутс управления операциями», клиенты, у которых нет подписки на «Пакет управления операциями», не видят возможности выбора этого уровня.

> [!NOTE]
> Чтобы убедиться, что вы получаете это право, ресурсы Application Insights должны быть в ценовом уровне Per Node. Эта возможность применяется только к узлам. Ресурсы Application Insights на уровне Per GB не реализуют никакой пользы. Эта возможность не отображается в предполагаемых затратах в области **Usage and estimated costs** (Данные об использовании и предполагаемые расходы). Кроме того, если перенести подписку на новую модель ценообразования мониторинга Azure в апреле 2018 года, уровень Per GB является единственным доступным уровнем. Перевод подписки на новую модель ценообразования для мониторинга Azure не рекомендуется, если у вас есть подписка Operations Management Suite.

### <a name="how-the-per-node-tier-works"></a>Как работает уровень Per Node

* Вы платите за каждый узло, отправляемый телеметрией для любых приложений в уровне Per Node.
  * *Узла* — это физический или виртуальный серверный станок или пример роли платформы как службы, в котором размещается ваше приложение.
  * В число узлов не включаются компьютеры для разработки, клиентские браузеры и мобильные устройства.
  * Если приложение содержит несколько компонентов, отправляющих данные телеметрии, например веб-службу и рабочую роль сервера, такие компоненты учитываются отдельно.
  * Данные [динамического потока метрик](../../azure-monitor/app/live-stream.md) не учитываются при расчете стоимости. Сумма платы за подписку зависит от количества узлов, а не от количества приложений. Если вы используете пять узлов, которые отправляют телеметрию для 12 приложений, то плата взимается за пять узлов.
* Несмотря на то что суммы в тарифах указаны за целый месяц, плата взимается только за те часы, в течение которых узел отправлял данные телеметрии из приложения. Сумма почасовой платы вычисляется как указанная в тарифе ежемесячная плата, разделенная на 744 (то есть на количество часов в месяц длительностью 31 день).
* Для каждого обнаруженного узла на день выделяются данные объемом 200 МБ (с детализацией по часам). Выделенные, но не использованные объемы данных не переносятся на следующий день.
  * Если вы выбираете уровень ценообразования Per Node, каждая подписка получает суточную надбавку данных в зависимости от количества узлов, отправляющих телеметрию на ресурсы Application Insights в этой подписке. Например, если вы используете 5 узлов, которые круглые сутки отправляют данные, вы получите совокупную квоту в 1 ГБ на все ресурсы Application Insights в этой подписке. Неважно, какие узлы передают больший объем информации, так как включенные данные распределяются на все узлы. Если в данный день ресурсы Application Insights получают больше данных, чем включено в ежедневное распределение данных для этой подписки, взимается плата за данные на ГБ. 
  * Ежедневная квота на объем передаваемых данных вычисляется в зависимости от количества часов за соответствующий день (в формате UTC), на протяжении которых каждый узел отправлял данные телеметрии. Это количество часов делится на 24 и умножается на 200 МБ. Таким образом, если четыре узла отправляли данные телеметрии в течение 15 часов (из 24), объем данных рассчитывается по следующей формуле: ((4 × 15) / 24) × 200 МБ = 500 МБ. Если за этот день узлы отправят 1 ГБ данных, то, исходя из цены в 2,30 доллара США за каждый гигабайт данных сверх квоты, плата за этот день составит 1,15 доллара США.
  * Суточная надбавка уровня Per Node не распределяется с приложениями, для которых вы выбрали уровень Per GB. Неиспользованный лимит на следующий день не переносится.

### <a name="examples-of-how-to-determine-distinct-node-count"></a>Примеры для определения количества уникальных узлов

| Сценарий                               | Общее количество узлов за день |
|:---------------------------------------|:----------------:|
| 1 приложение использует 3 экземпляра службы приложений Azure и 1 виртуальный сервер. | 4 |
| 3 приложения, работающие на 2 ВМ; ресурсы Application Insights для этих приложений находятся в той же подписке и в уровне Per Node | 2 | 
| Каждое из 4 приложений, ресурсы Application Insights которых находятся в одной подписке, запускает 2 экземпляра на протяжении 16 часов с наименьшей загрузкой и 4 экземпляра на протяжении 8 часов пиковой загрузки. | 13,33 |
| Облачные службы, у которых есть по 1 рабочей роли и 1 веб-роли, каждая их которых выполняется в 2 экземплярах. | 4 | 
| В кластере Azure Service Fabric с 5 узлами работают 50 микрослужб, для каждой из которых запущено по 3 экземпляра | 5|

* Точный подсчет количества узлов зависит от того, какой пакет SDK для Application Insights использует ваше приложение. 
  * В пакете SDK версии 2.2 и более новых версий пакет [SDK для Core](https://www.nuget.org/packages/Microsoft.ApplicationInsights/) и [веб-пакет SDK](https://www.nuget.org/packages/Microsoft.ApplicationInsights.Web/) Application Insights считают узлами каждый узел приложения. Например, имя компьютера для физического сервера или виртуальной машины или имя экземпляра для облачных служб.  Единственное исключение — приложение, использующее только [.NET Core](https://dotnet.github.io/) и пакет SDK для Core Application Insights. В этом случае для всех узлов регистрируется только один узел, так как имя узла недоступно.
  * В более ранних версиях пакета SDK [веб-пакет SDK](https://www.nuget.org/packages/Microsoft.ApplicationInsights.Web/) ведет себя так же, как и в новых версиях, но пакет [SDK для Core](https://www.nuget.org/packages/Microsoft.ApplicationInsights/) учитывает только один узел, независимо от количества узлов приложения.
  * Если приложение с помощью пакета SDK задает пользовательское значение для параметра **roleInstance** (Количество экземпляров роли), то по умолчанию это же значение будет использоваться и для определения количества узлов.
  * Если вы используете новую версию SDK с приложением, которое работает с клиентских компьютеров или мобильных устройств, количество узлов может вернуть большое число (из-за большого количества клиентских машин или мобильных устройств).

## <a name="automation"></a>Служба автоматизации

Вы можете написать скрипт для установки уровня ценообразования с помощью Управления ресурсами Azure. [Подробнее](powershell.md#price).

## <a name="next-steps"></a>Дальнейшие действия

* [Выборка](../../azure-monitor/app/sampling.md)

[api]: app-insights-api-custom-events-metrics.md
[apiproperties]: app-insights-api-custom-events-metrics.md#properties
[start]: ../../azure-monitor/app/app-insights-overview.md
[pricing]: https://azure.microsoft.com/pricing/details/application-insights/
[pricing]: https://azure.microsoft.com/pricing/details/application-insights/