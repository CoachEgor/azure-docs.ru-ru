---
title: Управление использованием и затратами для Azure Application Insights | Документация Майкрософт
description: Управление объемом данных телеметрии и контроль расходов в Application Insights.
services: application-insights
documentationcenter: ''
author: DaleKoetke
manager: carmonm
ms.assetid: ebd0d843-4780-4ff3-bc68-932aa44185f6
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.topic: conceptual
ms.reviewer: mbullwin
ms.date: 10/03/2019
ms.author: dalek
ms.openlocfilehash: 55ff134bfa76634250b7495120432d7310b07c06
ms.sourcegitcommit: 77bfc067c8cdc856f0ee4bfde9f84437c73a6141
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2019
ms.locfileid: "72431875"
---
# <a name="manage-usage-and-costs-for-application-insights"></a>Управление использованием и затратами для Application Insights

> [!NOTE]
> В этой статье описывается, как оценить затраты на Application Insights и управлять этими затратами.  В связанной статье, [мониторинге использования и оценочных затратах](https://docs.microsoft.com/azure/azure-monitor/platform/usage-estimated-costs) описывается просмотр использования и оценка затрат в нескольких функциях мониторинга Azure для различных моделей ценообразования.

Application Insights предназначен для получения всех необходимых сведений для наблюдения за доступностью, производительностью и использованием веб-приложений независимо от того, размещены ли они в Azure или локально. Application Insights поддерживает популярные языки и платформы, такие как .NET, Java и Node. js, и интегрируется с DevOps процессами и инструментами, такими как Azure DevOps, JIRA и PagerDuty. Важно понимать, что определяет затраты на мониторинг приложений. В этой статье мы рассмотрим, какие диски отслеживают затраты на мониторинг приложений и как можно заблаговременно отслеживать их и контролировать.

Если у вас возникли вопросы о принципах формирования цен на Application Insights, вы можете задать их на нашем [форуме](https://social.msdn.microsoft.com/Forums/en-US/home?forum=ApplicationInsights&filter=alltypes&sort=lastpostdesc).

## <a name="pricing-model"></a>Модель ценообразования

Цены на [Azure Application Insights][start] — это модель с **оплатой по мере** использования, основанная на принятом объеме данных и, возможно, для более длительного хранения данных. Каждый ресурс Application Insights оплачивается как отдельная служба и включается в счет за подписку Azure. Объем данных оценивается по размеру несжатых пакетов данных в формате JSON, получаемых службой Application Insights от вашего приложения. За использование [Live Metrics Stream](../../azure-monitor/app/live-stream.md)не взимается плата за объем данных.

За [многошаговые веб-тесты](../../azure-monitor/app/availability-multistep.md) взимается дополнительная плата. Это веб-тесты, в ходе которых выполняется несколько последовательных действий. За обычную *проверку связи* для одной страницы отдельная плата не взимается. Объем данных телеметрии, переданных в ходе проверки связи или многошагового теста, оплачивается так же, как другие данные телеметрии из вашего приложения.

## <a name="estimating-the-costs-to-manage-your-application"></a>Оценка затрат на управление приложением 

Если вы еще не используете Application Insights, можно использовать [Калькулятор цен Azure Monitor](https://azure.microsoft.com/pricing/calculator/?service=monitor) , чтобы оценить стоимость использования Application Insights. Начните с ввода в поле поиска «Azure Monitor» и щелчком на полученном Azure Monitor плитке. Прокрутите страницу вниз до Azure Monitor и выберите Application Insights в раскрывающемся списке тип.  Здесь можно ввести количество ГБ данных, которые будут собраны в месяц, поэтому они дают вопрос о том, сколько данных будет Application Insights собираются мониторинг приложения. 

Существует два подхода к решению этой задачи: использование мониторинга по умолчанию и адаптивной выборки, которая доступна в пакете SDK ASP.NET, или Оценка вероятного приема данных в зависимости от того, что появлялось другим подобным клиентам. 

### <a name="data-collection-when-using-sampling"></a>Сбор данных при использовании выборки

При [адаптивной выборки](https://docs.microsoft.com/azure/azure-monitor/app/sampling#adaptive-sampling-in-your-aspnetaspnet-core-web-applications)пакета SDK для ASP.NET объем данных корректируется автоматически, чтобы он оставался в пределах заданного максимального уровня трафика для мониторинга Application Insights по умолчанию. Если приложение создает небольшой объем данных телеметрии, например при отладке или из-за низкого уровня использования, то элементы не будут удаляться процессором выборки, если том находится ниже настроенных событий в секунду. Для приложения большого объема с пороговым значением по умолчанию 5 событий в секунду Адаптивная выборка будет ограничивать число ежедневных событий до 432 000. При стандартном среднем размере событий, равном 1 КБ, это соответствует 13,4 ГБ данных телеметрии за 31-дневный месяц на каждом узле, где размещается ваше приложение (поскольку выборка выполняется локально для каждого узла). 

Для пакетов SDK, которые не поддерживают адаптивную выборку, можно использовать [выборку](https://docs.microsoft.com/azure/azure-monitor/app/sampling#ingestion-sampling) , которая выбирается при получении данных Application Insights в зависимости от процента данных для удержания или с [фиксированной частотой для ASP.NET, ASP.NET Core и Java. ](https://docs.microsoft.com/azure/azure-monitor/app/sampling#fixed-rate-sampling-for-aspnet-aspnet-core-and-java-websites)веб-сайты для уменьшения трафика, отправляемого с веб-сервера и веб-браузеров

### <a name="learn-from-what-similar-customers-collect"></a>Узнайте, какие аналогичные клиенты собираются

В калькуляторе цен на мониторинг Azure для Application Insights, если вы включили функцию "Оценка объема данных на основе активности приложения", вы можете предоставить входные данные о приложении (количество запросов в месяц и просмотров страниц в месяц), если будет сбор данных телеметрии на стороне клиента), а затем калькулятор сообщит, как медиана и 90 процентиль объем собранных в ней приложений. Разумеется, эти приложения охватывают диапазон конфигураций Application Insights (например, некоторые из них имеют [выборку](../../azure-monitor/app/sampling.md)по умолчанию, некоторые из них не имеют выборки и т. д.), поэтому у вас по-прежнему есть элемент управления, позволяющий уменьшить объем данных, которые вы занимали гораздо меньше среднего уровня с помощью Но это отправная точка для понимания того, что видят другие похожие клиенты. 

## <a name="understand-your-usage-and-estimate-costs"></a>Сведения об использовании и оценке затрат

В Applicaition Insights легко разобраться с затратами, которые, как правило, основаны на последних шаблонах использования. Чтобы приступить к работе, перейдите на страницу **Данные об использовании и предполагаемые расходы** для ресурса Application Insights на портале Azure. 

![Выбор цен](./media/pricing/pricing-001.png)

О. Просмотрите сведения об объеме данных на месяц. К ним относятся все полученные и сохраненные данные (после любой [выборки](../../azure-monitor/app/sampling.md) из серверных и клиентских приложений, а также с тестов доступности).  
B. Отдельно плата взимается за [многошаговые веб-тесты](../../azure-monitor/app/availability-multistep.md). (К ним не относятся простые тесты доступности, плата за которые взимается при выставлении счетов за используемый объем данных.)  
C. Просмотр тенденций объемов данных за последний месяц.  
D. [Выборка](../../azure-monitor/app/sampling.md) при приеме данных.   
E. Настройка ежедневного ограничения объема данных.  

(Обратите внимание, что все цены, отображаемые на снимках экрана в этой статье, предназначены только для примера. Текущие цены в валюте и регионе см. в разделе [цены на Application Insights][pricing].)

Для получения более детальных сведений об использовании Application Insights откройте страницу **Метрики**, добавьте метрику "Объем точки данных", а затем выберите *Применить разделение*, чтобы разделить данные по типу элемента телеметрии. 

Оплата за использование Application Insights добавляется в счет Azure. Дополнительную информацию о счете за подписку на Azure можно просмотреть в разделе **Выставление счетов** портала Azure или на [портале выставления счетов Azure](https://account.windowsazure.com/Subscriptions). 

![В меню слева выберите "Выставление счетов".](./media/pricing/02-billing.png)

## <a name="viewing-application-insights-usage-on-your-azure-bill"></a>Просмотр Application Insights использования в счете Azure 

Azure предоставляет большое количество полезных функций в центре [управления затратами Azure и центра выставления счетов](https://docs.microsoft.com/azure/cost-management/quick-acm-cost-analysis?toc=/azure/billing/TOC.json) . Например, функция "анализ затрат" позволяет просматривать расходы на ресурсы Azure. Добавление фильтра по типу ресурсов (в Microsoft. Insights/Components для Application Insights) позволит вам относить расходы.

Чтобы получить дополнительные сведения об использовании, скачайте сведения [об использовании с портала Azure](https://docs.microsoft.com/azure/billing/billing-download-azure-invoice-daily-usage-date#download-usage-in-azure-portal). В скачанной электронной таблице вы можете просмотреть сведения об использовании каждого ресурса Azure в день. В этой таблице Excel использование ресурсов Application Insights можно найти с помощью первой фильтрации в столбце "Категория счетчиков", чтобы отобразить "Application Insights" и "Log Analytics", а затем добавить фильтр для столбца "идентификатор экземпляра", который содержит Microsoft. Insights/Components.  Большая часть Application Insights используется на метрах с категорией счетчика Log Analytics, так как для всех Azure Monitor компонентов существует одна серверная часть журналов.  С категорией счетчиков Application Insights могут сообщаться только Application Insights ресурсы на устаревших ценовых категориях и многошаговых веб-тестах.  Использование отображается в столбце "потребленное количество", а единица для каждой записи отображается в столбце "единица измерения".  Дополнительные сведения помогут вам [разобраться с Microsoft Azureным счетом](https://docs.microsoft.com/azure/billing/billing-understand-your-bill). 

## <a name="managing-your-data-volume"></a>Управление томом данных 

Чтобы понять, сколько данных отправляет приложение, вы можете:

* Откройте страницу **Usage and estimated costs** (Данные об использовании и предполагаемые расходы), чтобы просмотреть диаграмму ежедневного объема данных. 
* В обозревателе метрик добавьте новую диаграмму. Для метрики диаграммы настройте параметр **Объем точки данных**. Включите параметр **Группировка** и выберите группировку по **типу данных**.
* Используйте тип данных `systemEvents`. Например, чтобы увидеть объем данных, принятый за последний день, запрос будет выглядеть следующим образом:

```kusto
systemEvents 
| where timestamp >= ago(1d)
| where type == "Billing" 
| extend BillingTelemetryType = tostring(dimensions["BillingTelemetryType"])
| extend BillingTelemetrySizeInBytes = todouble(measurements["BillingTelemetrySize"])
| summarize sum(BillingTelemetrySizeInBytes)
```

Этот запрос можно использовать в [предупреждении журнала Azure](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-unified-log) для настройки оповещений на томах данных. 

Объем отправляемых данных можно управлять с помощью следующих методов:

* **Выборка.** Позволяет уменьшить объем данных телеметрии, отправляемых из серверных и клиентских приложений, с минимальным искажением метрик. Это основное средство, с помощью которого можно настроить объем отправляемых данных. Дополнительные сведения см. в статье [Выборка в Application Insights](../../azure-monitor/app/sampling.md).

* **Ограничить число вызовов AJAX**. можно [ограничить количество вызовов AJAX, которые могут быть переданы](../../azure-monitor/app/javascript.md#configuration) в каждом представлении страницы, или отключить отчеты AJAX.

* **Отключите ненужные модули**: [измените ApplicationInsights. config](../../azure-monitor/app/configuration-with-applicationinsights-config.md) , чтобы отключить ненужные модули сбора. Например, вы можете решить, что счетчики производительности или данные зависимостей не являются необходимыми.

* **Предварительная статистическая обработка метрик**: Если в приложении помещаются вызовы TrackMetric, можно уменьшить трафик, используя перегрузку, которая принимает вычисление среднего и стандартного отклонения пакета измерений. Кроме того, вы можете использовать [пакет предварительных статистических вычислений](https://www.myget.org/gallery/applicationinsights-sdk-labs).
 
* **Ежедневное ограничение.** При создании ресурса Application Insights на портале Azure устанавливается ограничение, которое составляет 100 ГБ в день. Ограничение по умолчанию при создании ресурса Application Insights в Visual Studio невелико (всего 32,3 МБ в день). Ежедневное ограничение по умолчанию задается для упрощения тестирования. Предполагается, что пользователь повысит ежедневное ограничение перед развертыванием приложения в рабочую среду. 

    Максимальное ограничение составляет 1000 ГБ в день. Вы можете запросить большее ограничение для приложения с большим объемом трафика. 
    
    Предупреждающие сообщения о ежедневном ограничении отправляются в учетную запись, которая является членами этих ролей для ресурса Application Insights: "Сервицеадмин", "Аккаунтадмин", "admin", "Owner".

    Будьте внимательны при задании ежедневного ограничения. Следует предполагать, что вы *никогда не достигнете его*. При достижении ежедневного ограничения вы потеряете данные за остаток дня и не сможете наблюдать за приложением. Чтобы изменить ежедневное ограничение, используйте параметр **Ежедневное ограничение объема**. Этот параметр можно настроить в области **Usage and estimated costs** (Данные об использовании и предполагаемые расходы). Это описано более подробно далее в этой статье.
    
    Мы удалили ограничение для некоторых типов подписок с кредитом, который не может использоваться для Application Insights. Ранее, если для подписки была задана предельная сумма расходов, то в колонке ежедневного ограничения отображались инструкции по ее удалению, а также включению возможности повышения этого ограничения свыше 32,3 МБ в день.
    
* **Регулирование.** Ограничивает скорость передачи данных 32 000 событий в секунду на ключ инструментирования, с усреднением за периоды по 1 минуте. Объем данных, отправляемых приложением, оценивается каждую минуту. Если он превышает среднюю минутную частоту, сервер отклоняет часть запросов. Пакет SDK буферизует данные, а затем пытается повторно отправить их. Он распределяет резкое увеличение трафика на несколько минут. Если приложение постоянно отправляет данные с частотой, превышающей частоту регулирования, некоторые данные будут пропущены. (Пакеты SDK ASP.NET, Java и JavaScript пытаются повторно отправить данные таким образом; другие пакеты SDK могут просто удалять регулируемые данные.) Если происходит регулирование, выводится предупреждение о том, что это произошло.

## <a name="manage-your-maximum-daily-data-volume"></a>Управление максимальным дневным объемом данных

Можно использовать ежедневное ограничение, чтобы ограничить объем собираемых данных. Тем не менее, если это ограничение достигнуто, теряются все данные телеметрии, отправленные из приложения за остаток дня. *Не рекомендуется* допускать достижения приложением ежедневного ограничения. После достижения ежедневного ограничения невозможно отслеживать работоспособность и производительность приложения.

Вместо ежедневного ограничения объема используйте [выборку](../../azure-monitor/app/sampling.md), чтобы настроить объем данных до требуемого уровня. Затем используйте ежедневное ограничение как "крайнюю меру" в случае, если приложение неожиданно начинает отправлять намного большие объемы данных телеметрии.

### <a name="identify-what-daily-data-limit-to-define"></a>Определение ежедневного ограничения по сбору данных

Ознакомьтесь с Application Insights использования и оценочными затратами, чтобы понять тенденцию приема данных и то, что является ежедневным ограничением объема для определения. Их необходимо тщательно рассмотреть, так как вы не сможете контролировать свои ресурсы после достижения предела. 

### <a name="set-the-daily-cap"></a>Установка ежедневного ограничения

Чтобы изменить ежедневное ограничение, в разделе **Настройка** ресурса Application Insights на странице **использование и оценка затрат** выберите **ежедневное ограничение**.

![Настройка ограничения ежедневного объема данных телеметрии](./media/pricing/pricing-003.png)

Чтобы [изменить ежедневное ограничение с помощью Azure Resource Manager](../../azure-monitor/app/powershell.md), изменяемым свойством является `dailyQuota`.  С помощью Azure Resource Manager можно также установить `dailyQuotaResetTime` и ежедневное ограничение `warningThreshold`. 

## <a name="sampling"></a>Выборка
[Выборка](../../azure-monitor/app/sampling.md) позволяет уменьшить скорость отправки данных телеметрии в ваше приложение. Она позволяет искать связанные события при поиске по журналу диагностики. Она также позволяет сохранить правильные значения числа событий.

Выборка — это эффективный способ сократить затраты и оставаться в пределах месячной квоты. Алгоритм выборки сохраняет связанные элементы телеметрии, поэтому, например, при использовании поиска можно найти запрос, относящийся к конкретному исключению. Алгоритм также сохраняет правильные количества, чтобы вы видели в обозревателе метрик правильные значения частоты запросов, частоты исключений и других счетчиков.

Существует несколько видов выборки.

* По умолчанию для пакета SDK для ASP.NET используется [адаптивная выборка](../../azure-monitor/app/sampling.md). Адаптивная выборка автоматически настраивается в соответствии с объемом данных телеметрии, отправляемых приложением. Она оперирует данными в пакете SDK в вашем веб-приложении, что позволяет уменьшить сетевой трафик телеметрии. 
* *Выборка приема* — это другая функция, которая работает в точке, где данные телеметрии из приложения поступают в службу Application Insights. Выборка приема не влияет на объем данных телеметрии, отправляемых из приложения, но уменьшает объем данных, сохраняемых службой. С помощью этой выборки можно уменьшить квоту, заданную для данных телеметрии, которые поступают из браузеров и других пакетов SDK.

Чтобы настроить выборку приема, перейдите в область **Цены**.

![В диалоговом окне "Quotas and pricing" (Квоты и цены) щелкните элемент "Выборки" и выберите долю выборки.](./media/pricing/pricing-004.png)

> [!WARNING]
> В области **Выборка данных** отражается только значение выборки приема. В ней не отражается частота выборки, которую применяет пакет SDK для Application Insights в приложении. Если по входящей телеметрии уже сделана выборка в пакете SDK, то выборка приема не применяется.
>

Чтобы узнать фактическую частоту выборки (где бы она ни применялась), выполните [запрос Analytics](analytics.md). Этот запрос выглядит следующим образом.

    requests | where timestamp > ago(1d)
    | summarize 100/avg(itemCount) by bin(timestamp, 1h)
    | render areachart

Для каждой сохранившейся записи `itemCount` обозначает число исходных записей, которые эта запись представляет. Эта величина равна 1 + число предыдущих удаленных записей. 

## <a name="change-the-data-retention-period"></a>Изменение срока хранения данных

Срок хранения по умолчанию для ресурсов Application Insights составляет 90 дней. Для каждого Application Insightsного ресурса можно выбрать разные периоды хранения. Полный набор доступных периодов хранения составляет 30, 60, 90, 120, 180, 270, 365, 550 или 730 дней. 

Чтобы изменить период удержания, в ресурсе Application Insights перейдите на страницу **использование и предполагаемые затраты** и выберите параметр **хранения данных** :

![Настройка ограничения ежедневного объема данных телеметрии](./media/pricing/pricing-005.png)

Кроме того, удержание можно [настроить программно с помощью PowerShell](powershell.md) с параметром `retentionInDays`. Кроме того, если задать срок хранения данных 30 дней, можно немедленно запустить немедленную очистку старых данных с помощью параметра `immediatePurgeDataOn30Days`, который может быть полезен для сценариев, связанных с соответствием. Эта функция очистки доступна только через Azure Resource Manager и должна использоваться с крайней осторожностью. 

Когда выставление счетов начинается дольше, чем за декабрь 2019, срок хранения данных, превышающих 90 дней, будет взиматься по той же ставке, что и в течение срока хранения данных Azure Log Analytics. Дополнительные сведения см. на [странице цен на Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/). Следите за ходом хранения переменных, [проголосуя по этому предложению](https://feedback.azure.com/forums/357324-azure-monitor-application-insights/suggestions/17454031). 

## <a name="data-transfer-charges-using-application-insights"></a>Плата за передачу данных с помощью Application Insights

Отправка данных в Application Insights может повлечь за собой плату за пропускную способность данных. Как описано на [странице цен на пропускную способность Azure](https://azure.microsoft.com/pricing/details/bandwidth/), передача данных между службами Azure, расположенными в двух регионах, наследуется в качестве исходящих данных по нормальной ставке. Передача входящих данных предоставляется бесплатно. Однако эта плата очень мала (несколько%) по сравнению с затратами на прием данных журнала Application Insights. Следовательно, управление затратами на Log Analytics должно сосредоточиться на принятом объеме данных, и мы предлагаем рекомендации, которые помогут понять [это.](https://docs.microsoft.com/azure/azure-monitor/app/pricing#managing-your-data-volume)   

## <a name="limits-summary"></a>Сводная таблица ограничений

[!INCLUDE [application-insights-limits](../../../includes/application-insights-limits.md)]

## <a name="disable-daily-cap-e-mails"></a>Отключение ежедневных электронных писем

Чтобы отключить ежедневное ограничение объема электронных писем, в разделе **Настройки** ресурса Application Insights в области **Usage and estimated costs** (Данные об использовании и предполагаемые расходы) выберите **Ежедневное ограничение**. Существуют параметры для отправки писем при достижении ограничения, а также при достижении порога предупреждений. Если вы хотите отключить все ежедневные сообщения, относящиеся к объему ежедневного ограничения, снимите оба флажка.

## <a name="legacy-enterprise-per-node-pricing-tier"></a>Ценовая категория "устаревший корпоративный" (на узел) "

Для ранних внедрений Application Insights Azure по-прежнему существуют две возможные ценовые категории: "базовый" и "Корпоративный". Ценовая категория "базовый" аналогична описанной выше и является уровнем по умолчанию. Он включает все функции корпоративного уровня без дополнительных затрат. Базовый уровень счета в основном относится к объему принимаемых данных. 

> [!NOTE]
> Эти ценовые категории прежних версий были переименованы. Корпоративная ценовая категория теперь называется **на каждый узел** , а базовая ценовая категория теперь НАЗЫВАЕТСЯ **за ГБ**. Эти новые имена используются ниже и в портал Azure.  

За каждый узел (ранее — корпоративный) взимается плата за каждый узел, и каждый узел получает дневную квоту на данные. В ценовой категории "на узел" выставляются счета за данные, полученные выше предоставленной скидки. При использовании Operations Management Suite следует выбрать уровень на уровне каждого узла. 

Текущие цены в валюте вашей страны для выбранного региона вы можете узнать на [странице цен на Application Insights](https://azure.microsoft.com/pricing/details/application-insights/).

> [!NOTE]
> В апреле 2018 года была [представлена](https://azure.microsoft.com/blog/introducing-a-new-way-to-purchase-azure-monitoring-services/) новая модель ценообразования для мониторинга Azure. Эта модель использует простой принцип "с оплатой по мере использования" во всем портфеле служб мониторинга. Узнайте больше о [новой модели ценообразования](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-usage-and-estimated-costs), о том, как [оценить последствия перехода на новую модель](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-usage-and-estimated-costs#assessing-the-impact-of-the-new-pricing-model), исходя из ваших шаблонов использования, и как [перейти на эту модель](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-usage-and-estimated-costs#moving-to-the-new-pricing-model).

### <a name="per-node-tier-and-operations-management-suite-subscription-entitlements"></a>Права на уровне узлов и подписки Operations Management Suite

Клиенты, которые приобрели Operations Management Suite E1 и E2, могут получить Application Insights для каждого узла как дополнительный компонент без дополнительных затрат, как [было объявлено ранее](https://blogs.technet.microsoft.com/msoms/2017/05/19/azure-application-insights-enterprise-as-part-of-operations-management-suite-subscription/). В частности, каждая единица Operations Management Suite E1 и E2 включает в себя право на один узел Application Insights уровня каждого узла. Каждый узел Application Insights включает до 200 МБ ежедневно обрабатываемых данных (отдельно от получаемых данных Log Analytics), которые хранятся в течение 90 дней. Дополнительная плата за это не взимается. Этот уровень подробно описан далее в этой статье. 

Так как этот уровень применим только для клиентов с подпиской Operations Management Suite, клиенты, у которых нет подписки Operations Management Suite, не видят возможность выбора этого уровня.

> [!NOTE]
> Чтобы убедиться, что вы получаете это право, ресурсы Application Insights должны быть в ценовой категории "на узел". Эта возможность применяется только к узлам. Ресурсы Application Insights на уровне ГБ не имеют никаких преимуществ. Эта возможность не отображается в предполагаемых затратах в области **Usage and estimated costs** (Данные об использовании и предполагаемые расходы). Кроме того, если вы перемещаете подписку на новую модель ценообразования для мониторинга Azure в апреле 2018, уровень "на ГБ" является единственным доступным уровнем. Перевод подписки на новую модель ценообразования для мониторинга Azure не рекомендуется, если у вас есть подписка Operations Management Suite.

### <a name="how-the-per-node-tier-works"></a>Принцип работы уровня каждого узла

* Вы платите за каждый узел, который отправляет данные телеметрии для любых приложений на уровне каждого узла.
  * *Узел* — это любой физический компьютер, виртуальная машина или экземпляр роли платформы как услуги, на котором размещено ваше приложение.
  * В число узлов не включаются компьютеры для разработки, клиентские браузеры и мобильные устройства.
  * Если приложение содержит несколько компонентов, отправляющих данные телеметрии, например веб-службу и рабочую роль сервера, такие компоненты учитываются отдельно.
  * Данные [динамического потока метрик](../../azure-monitor/app/live-stream.md) не учитываются при расчете стоимости. Сумма платы за подписку зависит от количества узлов, а не от количества приложений. Если вы используете пять узлов, которые отправляют телеметрию для 12 приложений, то плата взимается за пять узлов.
* Несмотря на то что суммы в тарифах указаны за целый месяц, плата взимается только за те часы, в течение которых узел отправлял данные телеметрии из приложения. Сумма почасовой платы вычисляется как указанная в тарифе ежемесячная плата, разделенная на 744 (то есть на количество часов в месяц длительностью 31 день).
* Для каждого обнаруженного узла на день выделяются данные объемом 200 МБ (с детализацией по часам). Выделенные, но не использованные объемы данных не переносятся на следующий день.
  * При выборе ценовой категории "на узел" каждая подписка получает дневную квоту на данные в зависимости от количества узлов, которые отправляют телеметрию в ресурсы Application Insights в этой подписке. Например, если вы используете 5 узлов, которые круглые сутки отправляют данные, вы получите совокупную квоту в 1 ГБ на все ресурсы Application Insights в этой подписке. Неважно, какие узлы передают больший объем информации, так как включенные данные распределяются на все узлы. Если в определенный день Application Insights ресурсы получают больше данных, чем включено в ежедневное распределение данных для этой подписки, взимается плата за использование данных за ГБ. 
  * Ежедневная квота на объем передаваемых данных вычисляется в зависимости от количества часов за соответствующий день (в формате UTC), на протяжении которых каждый узел отправлял данные телеметрии. Это количество часов делится на 24 и умножается на 200 МБ. Таким образом, если четыре узла отправляли данные телеметрии в течение 15 часов (из 24), объем данных рассчитывается по следующей формуле: ((4 × 15) / 24) × 200 МБ = 500 МБ. Если за этот день узлы отправят 1 ГБ данных, то, исходя из цены в 2,30 доллара США за каждый гигабайт данных сверх квоты, плата за этот день составит 1,15 доллара США.
  * Дневная квота уровня каждого узла не является общей для приложений, для которых выбран уровень "за ГБ". Неиспользованный лимит на следующий день не переносится. 

### <a name="examples-of-how-to-determine-distinct-node-count"></a>Примеры для определения количества уникальных узлов

| Сценарий                               | Общее количество узлов за день |
|:---------------------------------------|:----------------:|
| 1 приложение использует 3 экземпляра службы приложений Azure и 1 виртуальный сервер. | 4 |
| 3 приложения, выполняющиеся на 2 виртуальных машинах; ресурсы Application Insights для этих приложений находятся в одной подписке и на уровне каждого узла. | 2 | 
| Каждое из 4 приложений, ресурсы Application Insights которых находятся в одной подписке, запускает 2 экземпляра на протяжении 16 часов с наименьшей загрузкой и 4 экземпляра на протяжении 8 часов пиковой загрузки. | 13,33 | 
| Облачные службы, у которых есть по 1 рабочей роли и 1 веб-роли, каждая их которых выполняется в 2 экземплярах. | 4 | 
| В кластере Azure Service Fabric с 5 узлами работают 50 микрослужб, для каждой из которых запущено по 3 экземпляра | 5|

* Точный подсчет количества узлов зависит от того, какой пакет SDK для Application Insights использует ваше приложение. 
  * В пакете SDK версии 2.2 и более новых версий пакет [SDK для Core](https://www.nuget.org/packages/Microsoft.ApplicationInsights/) и [веб-пакет SDK](https://www.nuget.org/packages/Microsoft.ApplicationInsights.Web/) Application Insights считают узлами каждый узел приложения. Например, имя компьютера для физического сервера или виртуальной машины или имя экземпляра для облачных служб.  Единственное исключение — приложение, использующее только [.NET Core](https://dotnet.github.io/) и пакет SDK для Core Application Insights. В этом случае для всех узлов регистрируется только один узел, так как имя узла недоступно. 
  * В более ранних версиях пакета SDK [веб-пакет SDK](https://www.nuget.org/packages/Microsoft.ApplicationInsights.Web/) ведет себя так же, как и в новых версиях, но пакет [SDK для Core](https://www.nuget.org/packages/Microsoft.ApplicationInsights/) учитывает только один узел, независимо от количества узлов приложения. 
  * Если приложение с помощью пакета SDK задает пользовательское значение для параметра **roleInstance** (Количество экземпляров роли), то по умолчанию это же значение будет использоваться и для определения количества узлов. 
  * Если вы используете новую версию пакета SDK для приложения, которое запускается на клиентских компьютерах или мобильных устройствах, может возвращаться очень большое количество узлов (из-за большого числа клиентских компьютеров или мобильных устройств). 

## <a name="automation"></a>Служба автоматизации

Вы можете написать сценарий для настройки ценовой категории с помощью управления ресурсами Azure. [Подробнее](powershell.md#price).


## <a name="next-steps"></a>Дальнейшие действия

* [Выборка](../../azure-monitor/app/sampling.md)

[api]: app-insights-api-custom-events-metrics.md
[apiproperties]: app-insights-api-custom-events-metrics.md#properties
[start]: ../../azure-monitor/app/app-insights-overview.md
[pricing]: https://azure.microsoft.com/pricing/details/application-insights/