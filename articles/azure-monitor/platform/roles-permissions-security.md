---
title: Приступая к работе с ролями, разрешениями и системой безопасности с помощью Azure Monitor
description: Узнайте, как использовать встроенные роли и разрешения Azure Monitor для ограничения доступа к ресурсам мониторинга.
author: johnkemnetz
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 11/27/2017
ms.author: johnkem
ms.subservice: ''
ms.openlocfilehash: 4949391aded58f27ba8acd5c9ec437e8933f9843
ms.sourcegitcommit: 509e1583c3a3dde34c8090d2149d255cb92fe991
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2019
ms.locfileid: "66243423"
---
# <a name="get-started-with-roles-permissions-and-security-with-azure-monitor"></a>Приступая к работе с ролями, разрешениями и системой безопасности с помощью Azure Monitor

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

Многим командам необходимо строго регулировать доступ к данным и параметрам мониторинга. Например, если участники команды работают исключительно с мониторингом (инженеры службы поддержки, инженеры DevOps) или если вы используете поставщик управляемых служб, вы можете предоставить им доступ к данным только мониторинга ограничив возможности для создания, изменения, или Удалите ресурсы. В этой статье показано, как быстро применить к пользователю в Azure встроенные роли RBAC для мониторинга или создать собственную настраиваемую роль для пользователя, которому нужен ограниченный набор разрешений для мониторинга. Далее в статье рассматриваются вопросы безопасности ресурсов, связанных с Azure Monitor, и способы ограничения доступа к данным, которые они содержат.

## <a name="built-in-monitoring-roles"></a>Встроенные роли мониторинга
Встроенные роли Azure Monitor помогают ограничить доступ к ресурсам в подписке, то же время позволяя пользователям, ответственным за инфраструктуру мониторинга, получать и настраивать необходимые данные. Azure Monitor предоставляет две готовые роли: "Читатель данных мониторинга" и "Участник мониторинга".

### <a name="monitoring-reader"></a>Читатель данных мониторинга
Пользователи, которым назначена роль Monitoring Reader, могут просматривать все данные мониторинга в подписке, но не могут изменять какие-либо ресурсы или параметры, связанные с ресурсами мониторинга. Эта роль подходит для тех пользователей в организации (например, инженеров службы поддержки или инженеров по операциям), которым необходимо иметь следующие возможности.

* Просмотр панелей мониторинга на портале и создание собственных частных панелей мониторинга.
* Просмотр правил генерации оповещений, определенных в интерфейсе [оповещений Azure](alerts-overview.md).
* Запрос метрик с помощью [REST API Azure Monitor](https://msdn.microsoft.com/library/azure/dn931930.aspx), [командлетов PowerShell](powershell-quickstart-samples.md) или [кроссплатформенного интерфейса командной строки](cli-samples.md).
* Запрос журнала действий с помощью портала, REST API Azure Monitor, командлетов PowerShell или кроссплатформенного интерфейса командной строки.
* Просмотр [параметров диагностики](diagnostic-logs-overview.md#diagnostic-settings) для ресурса.
* Просмотр [профиля журнала](activity-log-export.md) для подписки.
* Просмотр параметров автомасштабирования.
* Просмотр действий и параметров оповещений.
* Доступ к данным Application Insights и просмотр данных в Application Insights Analytics.
* Поиск данных рабочей области Log Analytics, включая данные об использовании рабочей области.
* Просмотр групп управления Log Analytics.
* Получение схемы поиска в рабочую область Log Analytics.
* Вывод списка пакетов мониторинга в рабочей области Log Analytics.
* Извлечение и выполнение сохраненных поисковых запросов в рабочей области Log Analytics.
* Получение конфигурации хранилища рабочей области Log Analytics.

> [!NOTE]
> Эта роль не предоставляет доступ на чтение к данным журнала, переданным в потоковом режиме в концентратор событий или сохраненным в учетной записи хранения. [указаны ниже](#security-considerations-for-monitoring-data) .
> 
> 

### <a name="monitoring-contributor"></a>Участник мониторинга
Пользователи, которым назначена роль Monitoring Contributor, могут просматривать все данные мониторинга в подписке и создавать или изменять параметры мониторинга, но не могут изменять какие-либо другие ресурсы. Эта роль включает в себя все разрешения роли Monitoring Reader и подходит для участников команды мониторинга в организации или поставщиков управляемых служб, которым, помимо приведенных выше разрешений, также необходимо иметь следующие возможности.

* Публикация панелей мониторинга для совместного использования.
* Задайте [параметров диагностики](diagnostic-logs-overview.md#diagnostic-settings) для ресурса.\*
* Задайте [профиль журнала](activity-log-export.md) для подписки.\*
* Настройка действий и параметров для правил генерации оповещений при помощи интерфейса [оповещений Azure](alerts-overview.md).
* Создание веб-тестов и компонентов Application Insights.
* Вывод списка общих ключей рабочей области Log Analytics.
* Включение или отключение мониторинга пакетов в рабочей области Log Analytics.
* Создание и удаление и выполнение сохраненных поисковых запросов в рабочей области Log Analytics.
* Создание и удаление конфигурации хранилища рабочей области Log Analytics.

\*пользователь должен также отдельно предоставляться разрешение ListKeys для целевого ресурса (хранилища учетной записи или событие пространство имен концентратора) для настройки профиля журнала или параметра диагностики.

> [!NOTE]
> Эта роль не предоставляет доступ на чтение к данным журнала, переданным в потоковом режиме в концентратор событий или сохраненным в учетной записи хранения. [указаны ниже](#security-considerations-for-monitoring-data) .
> 
> 

## <a name="monitoring-permissions-and-custom-rbac-roles"></a>Разрешения мониторинга и настраиваемые роли RBAC
Если приведенные выше встроенные роли не отвечают потребностям вашей команды, вы можете [создать настраиваемую роль RBAC](../../role-based-access-control/custom-roles.md) с более детализированными разрешениями. Ниже приведены распространенные операции RBAC для Azure Monitor с описаниями.

| Операция | Описание |
| --- | --- |
| Microsoft.Insights/ActionGroups/[Read, Write, Delete] |Чтение, запись и удаление групп действий. |
| Microsoft.Insights/ActivityLogAlerts/[Read, Write, Delete] |Чтение, запись и удаление оповещений журнала действий. |
| Microsoft.Insights/AlertRules/[Read, Write, Delete] |Чтение, запись и удаление правил генерации оповещений (для классического интерфейса оповещений). |
| Microsoft.Insights/AlertRules/Incidents/Read |Вывод списка инцидентов (журнала активации правила генерации оповещений) для правила генерации оповещений. Это относится только к порталу. |
| Microsoft.Insights/AutoscaleSettings/[Read, Write, Delete] |Чтение, запись и удаление параметров автомасштабирования. |
| Microsoft.Insights/DiagnosticSettings/[Read, Write, Delete] |Чтение, запись и удаление параметров диагностики. |
| Microsoft.Insights/EventCategories/Read |Перечисление всех возможных категорий в журнале действий. Используется на портале Azure. |
| Microsoft.Insights/eventtypes/digestevents/Read |Это разрешение необходимо пользователям, которым требуется доступ к журналам действия на портале. |
| Microsoft.Insights/eventtypes/values/Read |Вывод списка событий журнала действий (событий управления) в подписке. Это разрешение применяется для доступа к журналу действий посредством кода или портала. |
| Microsoft.Insights/ExtendedDiagnosticSettings/[Read, Write, Delete] | Чтение, запись и удаление параметров диагностики для журналов сетевого потока. |
| Microsoft.Insights/LogDefinitions/Read |Это разрешение необходимо пользователям, которым требуется доступ к журналам действия на портале. |
| Microsoft.Insights/LogProfiles/[Read, Write, Delete] |Чтение, запись и удаление профилей журналов (потоковая передача журнала действий в концентратор событий или учетную запись хранения). |
| Microsoft.Insights/MetricAlerts/[Read, Write, Delete] |Чтение, запись и удаление оповещений на основе метрик практически в реальном времени. |
| Microsoft.Insights/MetricDefinitions/Read |Чтение определений метрик (вывод списка доступных типов метрик для ресурса). |
| Microsoft.Insights/Metrics/Read |Чтение метрик для ресурса. |
| Microsoft.Insights/Register/Action |Регистрация поставщика ресурсов Azure Monitor. |
| Microsoft.Insights/ScheduledQueryRules/[Read, Write, Delete] |Чтение, запись и удаление оповещений журналов в Azure Monitor. |



> [!NOTE]
> Для доступа к оповещениям, параметрам диагностики и метрикам для ресурса пользователь должен иметь доступ на чтение к типу этого ресурса и его области применения. Для создания ("записи") параметра диагностики или профиля журнала, который архивирует данные в учетную запись хранения или передает их в потоковом режиме в концентраторы событий, у пользователя должно быть также разрешение ListKeys для целевого ресурса.
> 
> 

Например, с помощью приведенной выше таблицы можно создать настраиваемую роль RBAC Activity Log Reader для чтения журнала действий следующим образом.

```powershell
$role = Get-AzRoleDefinition "Reader"
$role.Id = $null
$role.Name = "Activity Log Reader"
$role.Description = "Can view activity logs."
$role.Actions.Clear()
$role.Actions.Add("Microsoft.Insights/eventtypes/*")
$role.AssignableScopes.Clear()
$role.AssignableScopes.Add("/subscriptions/mySubscription")
New-AzRoleDefinition -Role $role 
```

## <a name="security-considerations-for-monitoring-data"></a>Вопросы безопасности данных мониторинга
Данные мониторинга, в особенности файлы журналов, могут содержать конфиденциальные сведения, такие как IP-адреса или имена пользователей. Данные мониторинга поступают из Azure в трех основных формах:

1. журнал действий, описывающий все действия плоскости управления с подпиской Azure;
2. журналы диагностики, выдаваемые ресурсом;
3. метрики, выдаваемые ресурсами.

Все три типа данных можно сохранять в учетной записи хранения или передавать в потоковом режиме в концентратор событий. Оба эти назначения являются универсальными ресурсами Azure. Так как это универсальные ресурсы, то их создание, удаление и доступ к ним являются привилегированными операциями, которые зарезервированы для администратора. Рекомендуется использовать следующие рекомендации для ресурсов, связанных с мониторингом, чтобы предотвратить их несанкционированное использование.

* Используйте отдельную учетную запись хранения для данных мониторинга. Если нужно разделить данные мониторинга на несколько учетных записей хранения, никогда не используйте какую-либо учетную запись хранения одновременно для данных мониторинга и данных другого типа. Иначе данные другого типа могут быть случайно предоставлены пользователям, которым требуется доступ только к данным мониторинга (например SIEM стороннего производителя).
* По этой же причине используйте отдельное пространство имен служебной шины или концентратора событий во всех параметрах диагностики.
* Ограничьте доступ к учетным записям хранения или концентраторам событий, связанным с мониторингом, держа их в отдельной группе ресурсов, и [используйте область применения](../../role-based-access-control/overview.md#scope) ролей мониторинга, чтобы предоставить им доступ только к этой группе ресурсов.
* Никогда не предоставляйте разрешение ListKeys для учетных записей хранения или концентраторов событий в области применения подписки, если пользователю требуется доступ только к данным мониторинга. Вместо этого предоставьте пользователю эти разрешения в области применения ресурса или группы ресурсов (при наличии выделенной группы ресурсов мониторинга).

### <a name="limiting-access-to-monitoring-related-storage-accounts"></a>Ограничение доступа к учетным записям хранения, связанным с мониторингом
Когда пользователю или приложению требуется доступ к данным мониторинга в учетной записи хранения, следует [создать SAS учетной записи](https://msdn.microsoft.com/library/azure/mt584140.aspx) для учетной записи хранения, содержащей данные мониторинга, с доступом на чтение уровня службы к хранилищу BLOB-объектов. В PowerShell это может выглядеть следующим образом.

```powershell
$context = New-AzStorageContext -ConnectionString "[connection string for your monitoring Storage Account]"
$token = New-AzStorageAccountSASToken -ResourceType Service -Service Blob -Permission "rl" -Context $context
```

Затем можно передать маркер сущности, которой требуется считать данные из этой учетной записи хранения, и она сможет получить список всех больших двоичных объектов в этой учетной записи хранения и считывать данные из них.

Кроме того, если необходимо управлять данным разрешением с помощью RBAC, то вы можете предоставить сущности разрешение Microsoft.Storage/storageAccounts/listkeys/action для этой конкретной учетной записи хранения. Это необходимо пользователям, которым нужна возможность настраивать параметры диагностики или профиль журнала для архивирования данных в учетную запись хранения. Например, можно создать следующую настраиваемую роль RBAC для пользователя или приложения, которому требуется только считывать данные из одной учетной записи хранения.

```powershell
$role = Get-AzRoleDefinition "Reader"
$role.Id = $null
$role.Name = "Monitoring Storage Account Reader"
$role.Description = "Can get the storage account keys for a monitoring storage account."
$role.Actions.Clear()
$role.Actions.Add("Microsoft.Storage/storageAccounts/listkeys/action")
$role.Actions.Add("Microsoft.Storage/storageAccounts/Read")
$role.AssignableScopes.Clear()
$role.AssignableScopes.Add("/subscriptions/mySubscription/resourceGroups/myResourceGroup/providers/Microsoft.Storage/storageAccounts/myMonitoringStorageAccount")
New-AzRoleDefinition -Role $role 
```

> [!WARNING]
> Разрешение ListKeys позволяет пользователю получать список первичных и вторичных ключей учетной записи хранения. Эти ключи предоставляют пользователю все подписанные разрешения (чтение, запись, создание больших двоичных объектов, удаление больших двоичных объектов и т. д.) для всех подписанных служб (больших двоичных объектов, очередей, таблиц, файлов) в данной учетной записи хранения. Рекомендуется при возможности использовать SAS учетной записи, как описано выше.
> 
> 

### <a name="limiting-access-to-monitoring-related-event-hubs"></a>Ограничение доступа к концентраторам событий, связанным с мониторингом
Аналогичная схема используется и для концентраторов событий, но сначала необходимо создать выделенное правило авторизации прослушивания. Если вы хотите предоставить доступ приложению, которому требуется только прослушивать концентраторы событий, связанные с мониторингом, выполните следующее:

1. Создайте политику общего доступа для концентраторов событий, созданных для потоковой передачи данных мониторинга с утверждениями только прослушивания. Это можно сделать на портале. Например, можно назвать ее monitoringReadOnly. При возможности вы предоставите этот ключ непосредственно потребителю и пропустите следующий шаг.
2. Если потребитель должен иметь возможность получить ключ напрямую, предоставьте пользователю listkeys для этого концентратора событий. Это также необходимо пользователям, которым нужна возможность настраивать параметры диагностики или профиль журнала для потоковой передачи данных в концентраторы событий. Например, можно создать правило RBAC, как показано ниже.
   
   ```powershell
   $role = Get-AzRoleDefinition "Reader"
   $role.Id = $null
   $role.Name = "Monitoring Event Hub Listener"
   $role.Description = "Can get the key to listen to an event hub streaming monitoring data."
   $role.Actions.Clear()
   $role.Actions.Add("Microsoft.ServiceBus/namespaces/authorizationrules/listkeys/action")
   $role.Actions.Add("Microsoft.ServiceBus/namespaces/Read")
   $role.AssignableScopes.Clear()
   $role.AssignableScopes.Add("/subscriptions/mySubscription/resourceGroups/myResourceGroup/providers/Microsoft.ServiceBus/namespaces/mySBNameSpace")
   New-AzRoleDefinition -Role $role 
   ```

## <a name="monitoring-within-a-secured-virtual-network"></a>Мониторинг в защищенной виртуальной сети

Для предоставления служб, которые вы активировали, Azure Monitor требуется доступ к ресурсам Azure. Если вам необходимо осуществлять мониторинг ресурсов Azure, которым запрещен доступ к общедоступному Интернету, вы можете включить указанные далее параметры.

### <a name="secured-storage-accounts"></a>Защищенные учетные записи хранения 

Данные мониторинга часто записываются в учетную запись хранения. Вероятно, вы захотите проследить за тем, чтобы данные, которые копируются в учетную запись хранения, не были доступны пользователям без соответствующих прав. Для обеспечения дополнительной безопасности можно заблокировать доступ к сети, разрешив доступ к учетной записи хранения только авторизованным ресурсам и доверенным службам Майкрософт. Для этого в настройках учетной записи хранения щелкните "Выбранные сети".
![Диалоговое окно настроек учетной записи хранения](./media/roles-permissions-security/secured-storage-example.png) Azure Monitor относится к этим доверенным службам Майкрософт. Если вы разрешите доверенным службам Майкрософт доступ к своему защищенному хранилищу, Azure Monitor получит доступ к вашей защищенной учетной записи хранения и сможет записывать в нее журналы диагностики, журнал действий и метрики в соответствии с этими ограничениями. Это также позволит службе Log Analytics осуществлять чтение журналов из защищенного хранилища.   


Дополнительные сведения см. в статье [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](../../storage/common/storage-network-security.md).

## <a name="next-steps"></a>Дальнейшие действия
* [Прочитайте о RBAC и разрешениях в Resource Manager](../../role-based-access-control/overview.md)
* [Прочитайте общие сведения о мониторинге в Azure](../../azure-monitor/overview.md)


