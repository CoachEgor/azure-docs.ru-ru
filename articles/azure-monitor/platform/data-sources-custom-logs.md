---
title: Сбор настраиваемых журналов в Azure Monitor | Документация Майкрософт
description: Azure Monitor может собирать события из текстовых файлов на компьютерах Windows и Linux.  В этой статье описано, как определить новый настраиваемый журнал и сведения для записей, которые он создает в службе Azure Monitor.
services: log-analytics
documentationcenter: ''
author: bwren
manager: carmonm
editor: tysonn
ms.assetid: aca7f6bb-6f53-4fd4-a45c-93f12ead4ae1
ms.service: log-analytics
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/12/2019
ms.author: bwren
ms.openlocfilehash: c80736dcd8be0c7ff3aae850aaaf9659f47daf36
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "60996523"
---
# <a name="custom-logs-in-azure-monitor"></a>Настраиваемые журналы в Azure Monitor
С помощью настраиваемых журналов, выступающих в качестве источников данных, в Azure Monitor можно собирать события из текстовых файлов на компьютерах Windows и Linux. Во многих приложениях вместо стандартной службы ведения журнала, например журнала событий Windows или системного журнала, данные журналов записываются в текстовые файлы. Вы можете проанализировать собранные данные с разделением на отдельные поля в ваших запросах или во время сбора извлечь данные в отдельные поля.

![Сбор данных из настраиваемых журналов](media/data-sources-custom-logs/overview.png)

Собираемые файлы журнала должны соответствовать следующим условиям:

- В каждой строке журнала должна содержаться одна запись либо в начале каждой строки должна быть временная метка в одном из следующих форматов:

    ГГГГ-ММ-ДД ЧЧ:ММ:СС;<br>М/Д/ГГГГ ЧЧ:ММ:СС AM/PM (12-часовой формат);<br>М ДД ГГГГ ЧЧ:ММ:СС;<br />ггммдд чч:мм:сс;<br />ддммгг чч:мм:сс;<br />ммм д чч:мм:сс;<br />дд/ммм/гг чч:мм:сс;<br />гггг-ММ-ддTчч:мм:сс.

- В части файла журнала, где будут добавляться новые записи, не должны выполняться циклическое ведение журнала или чередования журналов.
- В файле журнала должна использоваться кодировка ASCII или UTF-8.  Другие форматы, например UTF-16, не поддерживаются.

>[!NOTE]
>Если в файле журнала есть повторяющиеся записи, Azure Monitor будет собирать их.  Тем не менее результаты запроса будут несогласованы, если после применения фильтра будет показано больше событий, чем самих результатов.  Будет важно проверить журнал, чтобы определить, вызвано ли это поведение приложением, которое его создает, и устранить проблему, если это возможно, перед созданием определения сбора настраиваемого журнала.  
>
  
>[!NOTE]
> Если файл журнала создается в приложении каждый день или достигает определенного размера, агент Log Analytics для Linux обнаружит их, только после перезагрузки. Так происходит из-за того, что агент перечисляет и начинает мониторинг для шаблонов с указанными журналами только при запуске. Поэтому вам нужно учитывать это при планировании, автоматизировав перезапуск агента.  В агентах Log Analytics для Windows такое ограничение отсутствует.  
>

>[!NOTE]
> Рабочая область Log Analytics поддерживает следующие ограничения.
> 
> * Вы можете создать только 500 пользовательских журналов.
> * Таблица поддерживает до 500 столбцов. 
> * Имя столбца не может содержать более 500 символов. 
>

## <a name="defining-a-custom-log"></a>Определение настраиваемого журнала
Ниже описана процедура определения файла настраиваемого журнала.  В конце этой статьи содержится пошаговое руководство по добавлению настраиваемого журнала.

### <a name="step-1-open-the-custom-log-wizard"></a>Шаг 1. Открытие мастера настраиваемого журнала
Мастер настраиваемых журналов на портале Azure позволяет определить новый настраиваемый журнал для сбора данных.

1. На портале Azure щелкните **Рабочие области Log Analytics**, выберите свою рабочую область, а затем — **Дополнительные параметры**.
2. Щелкните **Данные** > **Настраиваемые журналы**.
3. По умолчанию все изменения конфигурации автоматически отправляются во все агенты.  Файл конфигурации агентов Linux отправляется в сборщик данных Fluentd.  Если вы хотите изменить этот файл вручную в каждом агенте Linux, снимите флажок *Apply below configuration to my Linux machines*(Применить конфигурацию ниже к моим компьютерам Linux).
4. Щелкните **Add+** (Добавить+), чтобы открыть мастер настраиваемого журнала.

### <a name="step-2-upload-and-parse-a-sample-log"></a>Шаг 2. Загрузка и преобразование примера журнала
Сначала необходимо загрузить пример настраиваемого журнала.  Затем мастер выполнит преобразование и отобразит записи в этом файле, чтобы вы смогли их проверить.  Azure Monitor будет использовать указанный вами разделитель для определения каждой записи.

**Новая строка** — тип разделителя по умолчанию, который используется для файлов журнала с одной записью в строке.  Если строка начинается с даты и времени в одном из доступных форматов, то можно указать тип разделителя **Метка времени** , который поддерживает записи, охватывающие несколько строк.

Если в качестве разделителя используется метка времени, свойство TimeGenerated каждой записи в Azure Monitor заполняется датой и временем, указанными для этой записи в файле журнала.  Если в качестве разделителя используется новая строка, свойство TimeGenerated заполняется датой и временем сбора этой записи в Azure Monitor.


1. Нажмите кнопку **Обзор** , чтобы перейти к примеру файла.  Обратите внимание, что в некоторых браузерах эта кнопка может называться **Выбрать файл** .
2. Нажмите кнопку **Далее**.
3. Мастер настраиваемого журнала загрузит файл и выведет список определяемых записей.
4. Измените разделитель, который используется для определения новой записи, и выберите разделитель, который подходит для записей в файле журнала.
5. Нажмите кнопку **Далее**.

### <a name="step-3-add-log-collection-paths"></a>Шаг 3. Добавление пути к файлам журнала
Для агента необходимо определить один или несколько путей, по которым будет расположен настраиваемый журнал.  Вы можете указать конкретный путь и имя файла журнала или путь с подстановочным знаком вместо имени. Это подходит для приложений, в которых каждый день создается новый файл, или когда один файл достигает определенного размера. Вы также можете указать несколько путей для одного файла журнала.

Например, приложение может каждый день создавать файл журнала, добавляя в имя дату, например log20100316.txt. Шаблоном для такого журнала может быть *log\*.txt*, который будет применяться к любому файлу журнала в соответствии со схемой именования приложения.

>[!NOTE]
> Если файл журнала создается в приложении каждый день или достигает определенного размера, агент Log Analytics для Linux обнаружит их, только после перезагрузки. Так происходит из-за того, что агент перечисляет и начинает мониторинг для шаблонов с указанными журналами только при запуске. Поэтому вам нужно учитывать это при планировании, автоматизировав перезапуск агента.  В агентах Log Analytics для Windows такое ограничение отсутствует.  
>

Ниже приведены примеры допустимых шаблонов для указания различных файлов журналов.

| Описание | Путь |
|:--- |:--- |
| Все файлы агента Windows в папке *C:\Logs* с расширением .txt |C:\Logs\\\*.txt |
| Все файлы агента Windows в папке *C:\Logs* с расширением .txt и именем, начинающимся со слова log |C:\Logs\log\*.txt |
| Все файлы агента Linux в папке */var/log/audits* с расширением .txt |/var/log/audit/*.txt |
| Все файлы агента Linux в папке */var/log/audit* с расширением .txt и именем, начинающимся со слова log |/var/log/Audit/log\*.txt |

1. Выберите Windows или Linux, чтобы указать, какой формат пути добавляется.
2. Введите путь и нажмите кнопку **+** .
3. Повторите эту процедуру для всех других путей.

### <a name="step-4-provide-a-name-and-description-for-the-log"></a>Шаг 4. Указание имени и описания журнала
Указываемое вами имя будет использоваться для типа журнала, как описано выше.  Это имя всегда будет заканчиваться на _CL, чтобы обозначить, что это настраиваемый журнал.

1. Введите имя для журнала.  Суффикс **\__CL** добавляется автоматически.
2. При необходимости введите **описание**.
3. Нажмите кнопку **Далее** , чтобы сохранить определения настраиваемого журнала.

### <a name="step-5-validate-that-the-custom-logs-are-being-collected"></a>Шаг 5. Проверка того, собираются ли данные настраиваемых журналов
Чтобы начальные данные из нового настраиваемого журнала появились в Azure Monitor, может потребоваться около часа.  Из журналов, расположенных по пути, который вы указали, будут собираться записи, добавленные после определения настраиваемого журнала.  Служба Log Analytics не будет сохранять записи, загруженные во время создания настраиваемого журнала, но она будет собирать уже существующие записи в найденных файлах журнала.

Как только Azure Monitor начнет собирать записи из настраиваемого журнала, их можно будет найти, используя запрос по журналу.  В качестве **типа** запроса следует использовать имя, присвоенное настраиваемому журналу.

> [!NOTE]
> Если в разделе запроса отсутствует свойство RawData, закройте и откройте браузер снова.


### <a name="step-6-parse-the-custom-log-entries"></a>Шаг 6. Преобразование записей настраиваемого журнала
Вся запись журнала будет сохранена в свойстве **RawData**.  Скорее всего, вам потребуется разделить различные сведения в каждой записи между отдельными свойствами для каждой записи. Сведения о параметрах для анализа **RawData** с разделением на несколько свойств см. в статье об [анализе текстовых данных в Azure Monitor](../log-query/parse-text.md).

## <a name="removing-a-custom-log"></a>Удаление настраиваемого журнала
Чтобы удалить определенный ранее настраиваемый журнал, выполните приведенные ниже действия на портале Azure.

1. В меню **Данные** в **дополнительных параметрах** рабочей области выберите **Настраиваемые журналы**, чтобы получить список всех настраиваемых журналов.
2. Нажмите кнопку **Удалить** рядом с нужным настраиваемым журналом.


## <a name="data-collection"></a>Сбор данных
Azure Monitor собирает новые записи из каждого настраиваемого журнала примерно каждые 5 минут.  Агент фиксирует место сбора в каждом отслеживаемом файле журнала.  Если агент на некоторое время перейдет в автономный режим, Azure Monitor будет собирать записи, начиная с места остановки, даже если эти записи были созданы, пока агент был отключен.

Все содержимое записи журнала записывается в свойство **RawData**.  Методы для анализа каждой импортированной записи журнала с разделением на несколько свойств см. в статье об [анализе текстовых данных в Azure Monitor](../log-query/parse-text.md).

## <a name="custom-log-record-properties"></a>Свойства записей настраиваемого журнала
Записи настраиваемого журнала имеют тип на основе указанного имени журнала и указанные ниже свойства.

| Свойство | Описание |
|:--- |:--- |
| TimeGenerated |Дата и время сбора записи службой Azure Monitor.  Если журнал использует разделитель на основе времени, это время, взятое из записи. |
| SourceSystem |Тип агента, из которого собрана запись. <br> OpsManager — агент Windows, подключенный напрямую или управляемый с помощью System Center Operations Manager. <br> Linux — все агенты Linux |
| RawData |Полный текст собранной записи. Скорее всего, вам потребуется [проанализировать эти данные с разделением на отдельные свойства](../log-query/parse-text.md). |
| ManagementGroupName |Имя группы управления для агентов System Center Operations Manager.  Для других агентов это AOI-\<идентификатор_рабочей_области\>. |


## <a name="sample-walkthrough-of-adding-a-custom-log"></a>Пошаговое руководство по добавлению настраиваемого журнала
В этом разделе описывается процедура создания настраиваемого журнала.  В каждой строке примера журнала, из которого собираются данные, содержится одна запись, начинающаяся с даты и времени, после которых идут поля для кода, состояния и сообщения, разделенные запятыми.  Ниже приведены некоторые примеры записей.

    2016-03-10 01:34:36 207,Success,Client 05a26a97-272a-4bc9-8f64-269d154b0e39 connected
    2016-03-10 01:33:33 208,Warning,Client ec53d95c-1c88-41ae-8174-92104212de5d disconnected
    2016-03-10 01:35:44 209,Success,Transaction 10d65890-b003-48f8-9cfc-9c74b51189c8 succeeded
    2016-03-10 01:38:22 302,Error,Application could not connect to database
    2016-03-10 01:31:34 303,Error,Application lost connection to database

### <a name="upload-and-parse-a-sample-log"></a>Загрузка и преобразование примера журнала
Мы откроем один из файлов журнала, чтобы увидеть события, которые он будет собирать.  В этом случае достаточно использовать в качестве разделителя новую строку.  Если одна запись в журнале может занимать несколько строк, то потребуется использовать в качестве разделителя метку времени.

![Загрузка и преобразование примера журнала](media/data-sources-custom-logs/delimiter.png)

### <a name="add-log-collection-paths"></a>Добавление пути к файлам журнала
Файлы журналов будут храниться в каталоге *C:\MyApp\Logs*.  Каждый день создается файл с именем, которое включает в себя дату, в формате *приложение_ГГГГММДД.log*.  Для этого журнала будет использоваться путь *C:\MyApp\Logs\\\*.log*.

![Путь к файлам журнала](media/data-sources-custom-logs/collection-path.png)

### <a name="provide-a-name-and-description-for-the-log"></a>Указание имени и описания журнала
Мы введем имя *MyApp_CL* и текст **описания**.

![Имя журнала](media/data-sources-custom-logs/log-name.png)

### <a name="validate-that-the-custom-logs-are-being-collected"></a>Проверка того, собираются ли данные настраиваемых журналов
Мы используем запрос *Type=MyApp_CL*, чтобы вернуть все записи из журнала, данные которого собираются.

![Запрос к журналу без настраиваемых полей](media/data-sources-custom-logs/query-01.png)

### <a name="parse-the-custom-log-entries"></a>Преобразование записей настраиваемого журнала
Мы используем настраиваемые поля, чтобы определить поля *EventTime* (Время события), *Code* (Кодировка), *Status* (Состояние) и *Message* (Сообщение). Кроме того, мы сможем увидеть разницу в записях, которые возвращаются запросом.

![Запрос к журналу с использованием настраиваемых полей](media/data-sources-custom-logs/query-02.png)

## <a name="alternatives-to-custom-logs"></a>Альтернативные варианты настройки журналов
Настраиваемые журналы являются важными в том случае, если ваши данные соответствуют перечисленным ниже критериям, но в некоторых случаях вам необходимо применить другую стратегию.

- Данные не соответствуют требуемой структуре, например, метка времени представлена в другом формате.
- Файл журнала не соответствует требованиям, например, кодирование файла или неподдерживаемая структура папки.
- Данные требуют предварительной обработки или фильтрации перед сбором. 

В тех случаях, когда настраиваемые журналы не могут собрать данные, рассмотрите следующие альтернативные стратегии.

- Используйте настраиваемый сценарий или другой метод для записи данных в [События Windows](data-sources-windows-events.md) или [Syslog](data-sources-syslog.md), которые собираются с помощью службы Azure Monitor. 
- Отправьте данные непосредственно в Azure Monitor с помощью [API сборщика данных HTTP](data-collector-api.md). Пример с использованием модулей runbook в службе автоматизации Azure Monitor представлен в [этой статье](runbook-datacollect.md).

## <a name="next-steps"></a>Дальнейшие действия
* Методы для анализа каждой импортированной записи журнала с разделением на несколько свойств см. в статье об [анализе текстовых данных в Azure Monitor](../log-query/parse-text.md).
* Узнайте больше о [запросах журнала](../log-query/log-query-overview.md), которые можно применять для анализа данных, собираемых из источников данных и решений.