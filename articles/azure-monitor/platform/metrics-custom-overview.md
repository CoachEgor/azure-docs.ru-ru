---
title: Пользовательские метрики в Azure Monitor
description: Сведения о пользовательских метриках в Azure Monitor и их моделировании.
author: ancav
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 09/09/2019
ms.author: ancav
ms.subservice: metrics
ms.openlocfilehash: 744958fc44a8d10bbc8ca5d44af8c473548ae5ca
ms.sourcegitcommit: 609d4bdb0467fd0af40e14a86eb40b9d03669ea1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/06/2019
ms.locfileid: "73669161"
---
# <a name="custom-metrics-in-azure-monitor"></a>Пользовательские метрики в Azure Monitor

По мере развертывания ресурсов и приложений в Azure вы захотите начать собирать данные телеметрии, чтобы получить представление об их производительности и работоспособности. В Azure доступны некоторые метрики по умолчанию. Их называют стандартными метриками или метриками платформы. Тем не менее на самом деле они ограничены. Для более подробной аналитики необходимо собирать некоторые специальные индикаторы производительности или метрики, относящиеся к бизнесу.
Эти **пользовательские** метрики можно собирать из данных телеметрии приложений, из агента, работающего в ресурсах Azure, или даже из внешней системы мониторинга, а затем отправлять непосредственно в Azure Monitor. После их публикации в Azure Monitor можно просматривать, запрашивать и оповещать о пользовательских метриках для приложений и ресурсов Azure параллельно со стандартными метриками в Azure.

## <a name="send-custom-metrics"></a>Отправка пользовательских метрик
Пользовательские метрики можно отправлять в Azure Monitor несколькими способами.
- Инструментировать приложения с помощью пакета SDK Application Insights и отправить пользовательские данные телеметрии в Azure Monitor. 
- Установить расширения Диагностики Azure для Windows из [виртуальной машины Azure](collect-custom-metrics-guestos-resource-manager-vm.md), [масштабируемого набора виртуальных машин](collect-custom-metrics-guestos-resource-manager-vmss.md), [классической виртуальной машины](collect-custom-metrics-guestos-vm-classic.md) или [классических облачных служб](collect-custom-metrics-guestos-vm-cloud-service-classic.md) и отправить счетчики производительности в Azure Monitor. 
- Установить [агент InfluxData Telegraf](collect-custom-metrics-linux-telegraf.md) на виртуальной машине Linux Azure и отправить метрики с помощью подключаемого модуля выходных данных Azure Monitor.
- Отправить пользовательские метрики [непосредственно в REST API Azure Monitor](../../azure-monitor/platform/metrics-store-custom-rest-api.md), `https://<azureregion>.monitoring.azure.com/<AzureResourceID>/metrics`.

При отправке пользовательских метрик в Azure Monitor каждая отправляемая точка данных или значение должны включать следующие сведения.

### <a name="authentication"></a>Аутентификация
При отправке пользовательских метрик в Azure Monitor сущность, отправляющая метрику, должна содержать действительный маркер Azure Active Directory в заголовке **Bearer** запроса. Существует несколько поддерживаемых способов получить действительный маркер носителя:
1. [Управляемые удостоверения для ресурсов Azure](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview). Предоставляет удостоверение самому ресурсу Azure (например, виртуальной машине). Управляемое удостоверение службы (MSI) предназначено для предоставления разрешений ресурсов для выполнения определенных операций. Пример разрешает ресурсам выдать собственные метрики. Ресурсу или его MSI на другой ресурс необходимо разрешение **Издателя метрик мониторинга**. С этим разрешением MSI может выдавать метрики для других ресурсов.
2. [Субъект-служба Azure AD](https://docs.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals). В данном случае приложению или службе AAD можно назначить разрешения на отправку метрик ресурса Azure.
Для проверки подлинности запроса с помощью открытых ключей AAD Azure Monitor проверяет маркер приложения. Существующая роль **Издатель метрик мониторинга** имеет это разрешение, доступное на портале Azure. Доступно на портале Azure. Субъекту-службе (в зависимости от того, для каких ресурсов будут отправляться пользовательские метрики) можно предоставить роль **Издатель метрик мониторинга** в необходимой области. Например, в подписке, группе ресурсов или в ресурсе.

> [!NOTE]  
> Когда для создания настраиваемых метрик вы запрашиваете маркер Azure AD, убедитесь, что он запрашивает аудиторию или ресурс, которые совпадают с https://monitoring.azure.com/. Убедитесь, что адрес содержит завершающую косую черту (/).

### <a name="subject"></a>Субъект
Это свойство содержит ИД ресурса Azure, для которого предоставляется пользовательская метрика. Эти сведения будут закодированы в URL-адресе совершаемого вызова API. Каждый API может отправлять значения метрик для одного ресурса Azure.

> [!NOTE]  
> Отправить пользовательские метрики с помощью идентификатора группы ресурсов или подписки невозможно.
>
>

### <a name="region"></a>Регион
В этом свойстве указывается регион Azure, где развертывается ресурс, для которого отправляются метрики. Метрики должны отправляться в конечную точку Azure Monitor того же региона, в котором развертывается ресурс. Например, пользовательские метрики для виртуальной машины, развернутой в регионе "Западная часть США", должны отправляться в конечную точку Azure Monitor региона "Западная часть США". Сведения о регионе также кодируются в URL-адресе вызова API.

> [!NOTE]  
> В общедоступной предварительной версии пользовательские метрики доступны только в некоторых регионах Azure. Список поддерживаемых регионов представлен в последующем разделе этой статьи.
>
>

### <a name="timestamp"></a>Timestamp
Каждая точка данных, отправляемая в Azure Monitor, должна быть отмечена временной меткой. Эта метка времени содержит дату и время измерения или получения метрики. Azure Monitor принимает данные метрик с метками времени до 20 минут назад и до 5 минут вперед. Метка времени должна быть в формате ISO 8601.

### <a name="namespace"></a>Пространство имен
При помощи пространств имен можно классифицировать или группировать похожие метрики. Они позволяют обеспечить изоляцию между группами метрик, которые смогут собирать разные аналитические сведения или индикаторы производительности. Например, у вас может быть пространство имен с именем **контосомемориметрикс** , которое отслеживает метрики использования памяти для профилирования приложения. Другое пространство имен с именем **контосоапптрансактион** может отнести все метрики о пользовательских транзакциях в приложении.

### <a name="name"></a>Имя
**Имя** — имя отправляемой метрики. Как правило, оно является достаточно описательным, чтобы указать измеряемый показатель. Пример представляет собой показатель, который измеряет количество байтов памяти, используемых на определенной виртуальной машине. Например, имя метрики **Используемые байты памяти**.

### <a name="dimension-keys"></a>Ключи измерений
Измерение — это пара "ключ-значение", помогающая описывать дополнительные характеристики собираемой метрики. С помощью дополнительных характеристик можно собирать больше данных о метрике, которые предоставляют больше аналитических сведений. Например, у метрики **Используемые байты памяти** может быть ключ измерения под названием **Процесс**, в котором указано, сколько байтов памяти использует каждый процесс на виртуальной машине. Использование этого ключа позволяет фильтровать метрику, чтобы узнать, сколько памяти используют определенные процессы, или получить список 5 процессов, использующих больше всего памяти.
Измерения являются необязательными, а не все метрики могут иметь измерения. Пользовательская Метрика может иметь до 10 измерений.

### <a name="dimension-values"></a>Значения измерений
При отправке точки данных метрики каждому ключу измерения отправляемой метрики соответствует значение измерения. Например, вам нужно сообщить, сколько памяти использует ContosoApp на вашей виртуальной машине:

* имя метрики — **Используемые байты памяти**;
* ключ измерения — **Процесс**;
* значение измерения — **ContosoApp.exe**.

Публикуя значение метрики, можно указывать только по одному значению измерения на ключ. Собирая одни и те же данные об использовании памяти для нескольких процессов на виртуальной машине, можно отправить несколько значений метрик для этой метки времени. Каждое значение метрики задает отдельное значение измерения для ключа **Процесс**.
Измерения являются необязательными, а не все метрики могут иметь измерения. Если в записи метрики определяются ключи измерения, соответствующие значения измерений являются обязательными.

### <a name="metric-values"></a>Значения метрик
При сохранении метрик Azure Monitor степень детализации составляет одну минуту. Мы понимаем, что во время заданной минуты понадобится несколько раз выбирать метрику. Например, использование ЦП. Для многих дискретных событий это необходимо измерить. Например, задержка транзакций входа в систему. Чтобы ограничить количество необработанных значений, которые требуется отправлять и оплачивать в Azure Monitor, вы можете заранее выполнить статистическое вычисление в локальной среде и выбрать такие значения:

* **Минимум** — минимальное наблюдаемое значение из всех образцов или измерений за минуту.
* **Максимум** — максимальное наблюдаемое значение из всех образцов или измерений за минуту.
* **Сумма** — сумма всех наблюдаемых значений из всех образцов или измерений за минуту.
* **Количество** — число образцов или измерений за минуту.

Допустим, за определенную минуту в приложении произошло 4 транзакции входа, в результате которых были получены следующие задержки.

|Транзакция 1|Транзакция 2|Транзакция 3|Транзакция 4|
|---|---|---|---|
|7 мс|4 мс|13 мс|16 мс|
|

Результаты публикации метрики в Azure Monitor будут следующими:
* "Минимум": 4;
* "Максимум": 16;
* "Сумма": 40;
* "Количество": 4.

Если приложение не может заранее выполнять статистическое вычисление в локальной среде и вынуждено отправлять каждый образец или событие сразу после сбора, то вы можете передавать необработанные значения показателей. Например, при каждой транзакции входа в приложении метрика будет публиковаться в Azure Monitor только с одним измерением. Таким образом, для транзакции входа, выполнение которой заняло 12 мс, будут опубликованы следующие результаты:
* "Минимум": 12;
* "Максимум": 12;
* "Сумма": 12;
* "Количество": 1.

С помощью этого процесса для одного сочетания метрики и измерения можно отправлять несколько значений за определенную минуту. Затем Azure Monitor соберет все необработанные значения, переданные за эту минуту, и выполнит статистическое вычисление.

### <a name="sample-custom-metric-publication"></a>Пример публикации пользовательской метрики
В приведенном ниже примере создается пользовательская метрика под названием **Используемые байты памяти** в пространстве имен **Профиль памяти** для виртуальной машины. У этой метрики есть одно измерение с именем **Процесс**. Для определенной метки времени мы передаем значения метрики из двух процессов.

```json
{
    "time": "2018-08-20T11:25:20-7:00",
    "data": {

      "baseData": {

        "metric": "Memory Bytes in Use",
        "namespace": "Memory Profile",
        "dimNames": [
          "Process"        ],
        "series": [
          {
            "dimValues": [
              "ContosoApp.exe"
            ],
            "min": 10,
            "max": 89,
            "sum": 190,
            "count": 4
          },
          {
            "dimValues": [
              "SalesApp.exe"
            ],
            "min": 10,
            "max": 23,
            "sum": 86,
            "count": 4
          }
        ]
      }
    }
  }
```
> [!NOTE]  
> Application Insights, расширение системы диагностики Windows Azure, и агент InfluxData Telegraf уже настроены на отправку значений метрик в соответствующую региональную конечную точку, передавая все вышеуказанные свойства при каждой отправке.
>
>

## <a name="custom-metric-definitions"></a>Определения пользовательских метрик
Нет необходимости определять пользовательскую метрику в Azure Monitor до ее отправления. Каждая опубликованная точка данных метрик содержит информацию о пространстве имен, имени и измерении. Поэтому при первом создании пользовательской метрики в Azure Monitor автоматически создается ее определение. Это определение метрики может быть обнаружено любым ресурсом, для которого эта метрика отправлялась с помощью определений.

> [!NOTE]  
> Azure Monitor пока не поддерживает определение **единиц измерения** для пользовательских метрик.

## <a name="using-custom-metrics"></a>Использование пользовательских метрик
После отправки пользовательских метрик в Azure Monitor их можно просмотреть на портале Azure и запросить через REST API Azure Monitor. Также для них можно создать оповещения, чтобы уведомлять об определенных условиях.
### <a name="browse-your-custom-metrics-via-the-azure-portal"></a>Просмотр пользовательских метрик на портале Azure
1.  Перейдите на [портал Azure](https://portal.azure.com).
2.  Выберите вкладку **Монитор**.
3.  Выберите **Метрики**.
4.  Выберите ресурс, с которого отправлялись пользовательские метрики.
5.  Выберите пространство имен для пользовательской метрики.
6.  Выберите пользовательскую метрику.

## <a name="supported-regions"></a>Поддерживаемые регионы
В общедоступной предварительной версии публиковать пользовательские метрики возможно только в некоторых регионах Azure. Это означает, что публиковать метрики возможно только для ресурсов в одном из поддерживаемых регионов. В следующей таблице перечислены наборы поддерживаемых регионов Azure для пользовательских метрик. В ней также перечислены соответствующие конечные точки, в которых необходимо опубликовать маркеры для ресурсов в этих регионах.

|Регион Azure |Префикс региональной конечной точки|
|---|---|
| **США и Канада** | |
|центрально-западная часть США | HTTPS:\//westcentralus.monitoring.azure.com/ |
|западная часть США 2       | HTTPS:\//westus2.monitoring.azure.com/ |
|Центрально-северная часть США | HTTPS:\//northcentralus.monitoring.azure.com
|Центрально-южная часть США| HTTPS:\//southcentralus.monitoring.azure.com/ |
|Центральная часть США      | HTTPS:\//centralus.monitoring.azure.com |
|Центральная Канада | HTTPS:\//канадацентрал.Мониторинг.Азуре.КОМК
|Восток США| HTTPS:\//eastus.monitoring.azure.com/ |
| **Европа** | |
|Северная Европа    | HTTPS:\//northeurope.monitoring.azure.com/ |
|Западная Европа     | HTTPS:\//westeurope.monitoring.azure.com/ |
|южная часть Соединенного Королевства | HTTPS:\//uksouth.monitoring.azure.com
|Центральная Франция | HTTPS:\//francecentral.monitoring.azure.com |
| **Африка** | |
|Северная часть ЮАР | HTTPS:\//southafricanorth.monitoring.azure.com
| **Азия** | |
|Центральная Индия | HTTPS:\//centralindia.monitoring.azure.com
|Восточная Австралия | HTTPS:\//australiaeast.monitoring.azure.com
|Восточная Япония | HTTPS:\//japaneast.monitoring.azure.com
|Юго-Восточная Азия  | HTTPS:\//southeastasia.monitoring.azure.com |
|Восточная Азия | HTTPS:\//eastasia.monitoring.azure.com
|Республика Корея, центральный регион   | HTTPS:\//koreacentral.monitoring.azure.com


## <a name="quotas-and-limits"></a>Квоты и ограничения
Azure Monitor налагает указанные ниже ограничения на использование пользовательских метрик.

|Категория|Ограничение|
|---|---|
|Активные временные серии, подписки, регион|50 000|
|Ключи измерений на метрику|10|
|Длина строки для имен и пространств имен метрик, а также ключей и имен измерений|256 символов|

Активная временная серия — это уникальное сочетание метрики, ключа и значения измерения, содержащее значения метрик, опубликованные за последние 12 часов.

## <a name="next-steps"></a>Дальнейшие действия
Используйте пользовательские метрики из различных служб: 
 - [Виртуальные машины](collect-custom-metrics-guestos-resource-manager-vm.md)
 - [Масштабируемый набор виртуальных машин](collect-custom-metrics-guestos-resource-manager-vmss.md)
 - [Виртуальные машины Azure (классические)](collect-custom-metrics-guestos-vm-classic.md)
 - [Виртуальная машина Linux с агентом Telegraf](collect-custom-metrics-linux-telegraf.md)
 - [ИНТЕРФЕЙС REST API](../../azure-monitor/platform/metrics-store-custom-rest-api.md)
 - [Классические облачные службы](collect-custom-metrics-guestos-vm-cloud-service-classic.md)
 
