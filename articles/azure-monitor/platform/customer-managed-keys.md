---
title: Azure Monitor ключ, управляемый клиентом
description: Сведения и действия по настройке ключа, управляемого клиентом (CMK), для шифрования данных в рабочих областях Log Analytics с помощью ключа Azure Key Vault.
ms.subservice: logs
ms.topic: conceptual
author: yossi-y
ms.author: yossiy
ms.date: 05/07/2020
ms.openlocfilehash: 2838051d8e75ffbe3b7ecc9fbc655f24b57199e4
ms.sourcegitcommit: a8ee9717531050115916dfe427f84bd531a92341
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/12/2020
ms.locfileid: "83198688"
---
# <a name="azure-monitor-customer-managed-key"></a>Azure Monitor ключ, управляемый клиентом 

В этой статье содержатся общие сведения и инструкции по настройке ключей, управляемых клиентом (CMK), для рабочих областей Log Analytics. После настройки все данные, отправленные в рабочие области, шифруются с помощью ключа Azure Key Vault.

Перед настройкой рекомендуется ознакомиться [с ограничениями и ограничениями,](#limitations-and-constraints) приведенными ниже.

## <a name="disclaimers"></a>Заявления об отказе от ответственности

- Возможность CMK поставляется в выделенном кластере Log Analytics, который является физическим кластером, и хранилищем данных, которое подходит для клиентов, отправляющих 1 ТБ в день или больше.

- Модель ценообразования CMK сейчас недоступна, и она не рассматривается в этой статье. Модель ценообразования для выделенного кластера Log Analytics ожидается во втором квартале календарного года (CY) 2020 и будет применяться к любым существующим развертываниям CMK.

## <a name="customer-managed-key-cmk-overview"></a>Обзор ключа, управляемого клиентом (CMK)

[Шифрование неактивных](https://docs.microsoft.com/azure/security/fundamentals/encryption-atrest) данных — это общие требования к конфиденциальности и безопасности в организациях. Вы можете полностью управлять шифрованием в Azure, в то время как у вас есть различные варианты для тесного управления шифрованием или ключами шифрования.

Хранилище Azure Monitor гарантирует, что все данные шифруются с помощью ключей, управляемых Azure, и хранятся в службе хранилища Azure. Azure Monitor также предоставляет возможность шифрования данных с помощью собственного ключа, хранящегося в [Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-overview), доступ к которому осуществляется с помощью [управляемой системой идентификации](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview) с проверкой подлинности. Этот ключ может быть [программным или аппаратным обеспечением с защитой HSM](https://docs.microsoft.com/azure/key-vault/key-vault-overview).
Azure Monitor использование шифрования идентично тому, как работает шифрование службы [хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-service-encryption#about-azure-storage-encryption) .

Частота, с которой Azure Monitor доступ к хранилищу Key Vault для операций упаковки и распаковки, составляет от 6 до 60 секунд.Azure Monitor хранилище всегда учитывает изменения в ключевых разрешениях в течение часа.

Полученные данные за последние 14 дней также сохраняются в оперативном кэше (с поддержкой SSD) для эффективной работы механизма запросов. Эти данные остаются зашифрованными с помощью ключей Майкрософт независимо от конфигурации CMK, но ваш контроль над данными SSD придерживается [отзыва ключа](#cmk-kek-revocation) и недоступен. Мы работаем над тем, чтобы данные SSD были зашифрованы с помощью CMK во второй половине 2020.

## <a name="how-cmk-works-in-azure-monitor"></a>Как работает CMK в Azure Monitor

Azure Monitor использует управляемое системой удостоверение для предоставления доступа к Azure Key Vault.Управляемое системой удостоверение может быть связано только с одним ресурсом Azure. Удостоверение выделенного кластера Log Analytics поддерживается на уровне кластера, и это указывает на то, что возможность CMK доставляется в выделенный кластер Log Analytics. Для поддержки CMK в нескольких рабочих областях новый ресурс *кластера* log Analytics выполняет в качестве промежуточного подключения между Key Vaultом и рабочими областями log Analytics. Эта концепция сохраняет удостоверение между выделенным кластером Log Analytics и ресурсом *кластера* log Analytics, а данные связанных рабочих областей защищаются с помощью ключа Key Vault. Выделенное хранилище кластера Log Analytics использует управляемое удостоверение, \' связанное с ресурсом *кластера* для проверки подлинности и доступа к Azure Key Vault через Azure Active Directory.

![Обзор CMK](media/customer-managed-keys/cmk-overview-8bit.png)
1.    Key Vault клиента.
2.    Ресурс *кластера* log Analytics клиента с правами управляемого удостоверения с разрешениями на Key Vault — удостоверение поддерживается на уровне выделенного log Analytics кластера.
3.    Выделенный кластер Log Analytics.
4.    Рабочие области клиента, связанные с ресурсом *кластера* для шифрования CMK.

## <a name="encryption-keys-operation"></a>Операция с ключами шифрования

Существует 3 типа ключей, участвующих в шифровании данных хранилища:

- Ключ шифрования **KEK** (CMK)
- **АЕК** — ключ шифрования учетной записи
- **DEK** — ключ шифрования данных

Применяются следующие правила.

- Выделенные учетные записи хранения Log Analytics кластера создают уникальный ключ шифрования для каждой учетной записи хранения, который называется АЕК.

- АЕК используется для получения DEK, которые являются ключами, используемыми для шифрования каждого блока данных, записываемых на диск.

- Когда вы настраиваете ключ в Key Vault и ссылаетсяе на него в ресурсе *кластера* , служба хранилища Azure отправляет запросы в ваш Azure Key Vault для переноса и распаковки АЕК для выполнения операций шифрования и расшифровки данных.

- KEK никогда не покидает ваш Key Vault и в случае ключа HSM он никогда не покидает оборудование.

- Служба хранилища Azure использует управляемое удостоверение, связанное с ресурсом *кластера* , для проверки подлинности и доступа к Azure Key Vault через Azure Active Directory.

## <a name="cmk-provisioning-procedure"></a>Процедура подготовки CMK

1. Подписка список разрешений. чтобы убедиться, что в вашем регионе есть требуемая емкость для выделенного кластера Log Analytics, необходимо сначала проверить и список разрешений подписку.
2. Создание Azure Key Vault и хранение ключа
3. Создание ресурса *кластера*
5. Предоставление разрешений Key Vault
6. Связывание рабочих областей Log Analytics

В настоящее время процедура не поддерживается в пользовательском интерфейсе, а процесс подготовки выполняется с помощью REST API.

> [!IMPORTANT]
> Любой запрос API должен содержать маркер авторизации носителя в заголовке запроса.

Пример:

```rst
GET https://management.azure.com/subscriptions/<subscription-id>/resourcegroups/<resource-group-name>/providers/Microsoft.OperationalInsights/workspaces/<workspace-name>?api-version=2020-03-01-preview
Authorization: Bearer eyJ0eXAiO....
```

Где *eyJ0eXAiO...* представляет полный маркер авторизации. 

Получить маркер можно с помощью одного из следующих методов:

1. Используйте метод [Регистрация приложений](https://docs.microsoft.com/graph/auth/auth-concepts#access-tokens) .
2. На портале Azure
    1. Переход к портал Azure в "инструменте разработчика" (F12)
    1. Найдите строку авторизации в разделе "заголовки запросов" в одном из экземпляров "Пакетная обработка API-версия". Он выглядит следующим образом: "Authorization: Bearer eyJ0eXAiO....". 
    1. Скопируйте и добавьте его в вызов API в приведенных ниже примерах.
3. Перейдите на сайт документации по Azure RESTFUL. Нажмите кнопку "попробовать" для любого API и скопируйте токен носителя.

### <a name="asynchronous-operations-and-status-check"></a>Асинхронные операции и проверка состояния

Некоторые операции в этой процедуре настройки выполняются асинхронно, так как они не могут быть завершены быстро. Ответ для асинхронной операции изначально возвращает код состояния HTTP 200 (ОК) и заголовок со свойством *Azure-AsyncOperation* , если оно принято:
```json
"Azure-AsyncOperation": "https://management.azure.com/subscriptions/subscription-id/providers/Microsoft.OperationalInsights/locations/region-name/operationStatuses/operation-id?api-version=2020-03-01-preview"
```

Вы можете проверить состояние асинхронной операции, отправив запрос GET в значение заголовка *Azure-AsyncOperation* :
```rst
GET https://management.azure.com/subscriptions/subscription-id/providers/microsoft.operationalInsights/locations/region-name/operationstatuses/operation-id?api-version=2020-03-01-preview
Authorization: Bearer <token>
```

Ответ содержит сведения об операции и ее *состояние*. Это может быть одно из следующих:

Операция выполняется
```json
{
    "id": "Azure-AsyncOperation URL value from the GET operation",
    "name": "operation-id", 
    "status" : "InProgress", 
    "startTime": "2017-01-06T20:56:36.002812+00:00",
}
```

Операция завершена
```json
{
    "id": "Azure-AsyncOperation URL value from the GET operation",
    "name": "operation-id", 
    "status" : "Succeeded", 
    "startTime": "2017-01-06T20:56:36.002812+00:00",
    "endTime": "2017-01-06T20:56:56.002812+00:00",
}
```

Сбой операции
```json
{
    "id": "Azure-AsyncOperation URL value from the GET operation",
    "name": "operation-id", 
    "status" : "Failed", 
    "startTime": "2017-01-06T20:56:36.002812+00:00",
    "endTime": "2017-01-06T20:56:56.002812+00:00",
    "error" : { 
        "code": "error-code",  
        "message": "error-message" 
    }
}
```

### <a name="subscription-whitelisting"></a>Список разрешений подписки

Возможность CMK — это функция раннего доступа. Подписки, в которых планируется создавать ресурсы *кластера* , должны быть предварительно список разрешений группой продуктов Azure. Используйте свои контакты в Майкрософт, чтобы предоставить идентификаторы подписок.

> [!IMPORTANT]
> Функция CMK является региональной. Azure Key Vault, ресурс *кластера* и связанные рабочие области log Analytics должны находиться в одном регионе, но они могут находиться в разных подписках.

### <a name="storing-encryption-key-kek"></a>Хранение ключа шифрования (KEK)

Создайте или используйте Azure Key Vault, которые уже необходимо создать, или импортируйте ключ, который будет использоваться для шифрования данных. Azure Key Vault должны быть настроены как восстанавливаемые для защиты ключа и доступа к данным в Azure Monitor. Эту конфигурацию можно проверить в разделе "Свойства" в Key Vault, чтобы включить *обратимое удаление* и *защиту от* удаления.

![Параметры обратимого удаления и очистки защиты](media/customer-managed-keys/soft-purge-protection.png)

Эти параметры доступны через CLI и PowerShell.
- [Обратимое удаление](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete)
- [Очистка защиты](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete#purge-protection) защищает от принудительного удаления секрета или хранилища даже после обратимого удаления

### <a name="create-cluster-resource"></a>Создание ресурса *кластера*

Этот ресурс используется в качестве промежуточного подключения между Key Vault и рабочими областями Log Analytics. После получения подтверждения о том, что ваши подписки были список разрешений, создайте ресурс *кластера* log Analytics в регионе, где находятся ваши рабочие области.

При создании ресурса *кластера* необходимо указать уровень *резервирования емкости* (SKU). Уровень *резервирования емкости* может быть в диапазоне от 1 000 до 2 000 ГБ в день. его можно обновить, выполнив действия, описанные в разделе 100. Если требуется уровень резервирования емкости более 2 000 ГБ в день, свяжитесь с нами по адресу LAIngestionRate@microsoft.com . [Дополнительные сведения](https://docs.microsoft.com/azure/azure-monitor/platform/manage-cost-storage#log-analytics-clusters)
    
Свойство *биллингтипе* определяет атрибуты выставления счетов для ресурса *кластера* и его данных:
- *кластер* (по умолчанию) — выставление счетов относится к подписке, в которой размещается ресурс *кластера* .
- *рабочие области* — выставление счетов с атрибутами для подписок, в которых размещаются рабочие области, пропорционально 

> [!NOTE]
> После создания ресурса *кластера* его можно обновить с помощью *SKU*, *кэйваултпропертиес* или *биллингтипе* , используя запрос на обновление RESTful.

**Создать**

Этот диспетчер ресурсов запрос является асинхронной операцией.

```rst
PUT https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.OperationalInsights/clusters/<cluster-name>?api-version=2020-03-01-preview
Authorization: Bearer <token>
Content-type: application/json

{
  "identity": {
    "type": "systemAssigned"
    },
  "sku": {
    "name": "capacityReservation",
    "Capacity": 1000
    },
  "properties": {
    "billingType": "cluster",
    },
  "location": "<region-name>",
}
```
Удостоверение назначается ресурсу *кластера* во время создания.

**Ответ**

200 ОК и заголовок.

Хотя подготовка выделенного кластера Log Analyticsа ко времени завершения, можно проверить состояние подготовки двумя способами.

1. Скопируйте значение URL-адреса Azure-AsyncOperation из ответа и выполните [проверку состояния асинхронных операций](#asynchronous-operations-and-status-check).
2. Отправьте запрос GET на ресурс *кластера* и просмотрите значение *provisioningState* . Это *провисионингаккаунт* во время подготовки и *успешного* завершения.


```rst
GET https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.OperationalInsights/clusters/<cluster-name>?api-version=2020-03-01-preview
Authorization: Bearer <token>
```

> [!IMPORTANT]
> Скопируйте и сохраните ответ, так как эти сведения понадобятся вам в дальнейших действиях.

**Ответ**

```json
{
  "identity": {
    "type": "SystemAssigned",
    "tenantId": "tenant-id",
    "principalId": "principal-id"
    },
  "sku": {
    "name": "capacityReservation",
    "capacity": 1000,
    "lastSkuUpdate": "Sun, 22 Mar 2020 15:39:29 GMT"
    },
  "properties": {
    "provisioningState": "ProvisioningAccount",
    "clusterType": "LogAnalytics",
    "billingType": "cluster",
    "clusterId": "cluster-id"
    },
  "id": "/subscriptions/subscription-id/resourceGroups/resource-group-name/providers/Microsoft.OperationalInsights/clusters/cluster-name",
  "name": "cluster-name",
  "type": "Microsoft.OperationalInsights/clusters",
  "location": "region-name"
}
```

Идентификатор GUID "principalId" создается управляемой службой удостоверений для ресурса *кластера* .

### <a name="grant-key-vault-permissions"></a>Предоставление Key Vault разрешений

Обновите Key Vault с помощью новой политики доступа, которая предоставляет разрешения для ресурса *кластера* . Эти разрешения используются хранилищем Azure Monitor ундерлай для шифрования данных. Откройте Key Vault в портал Azure и щелкните "политики доступа", а затем "+ добавить политику доступа", чтобы создать политику с этими параметрами:

- Разрешения ключа: выберите "Get", "обернуть ключ" и "разворачивать ключ".
- Выбор субъекта: введите значение идентификатора участника, которое было возвращено в ответе на предыдущем шаге.

![предоставление Key Vault разрешений](media/customer-managed-keys/grant-key-vault-permissions-8bit.png)

Разрешение *Get* необходимо для проверки того, что Key Vault настроена как восстанавливаемая для защиты ключа и доступа к данным Azure Monitor.

### <a name="update-cluster-resource-with-key-identifier-details"></a>Обновление ресурса кластера с подробными сведениями об идентификаторе ключа

Этот шаг выполняется во время начальной и будущей обновлений версии ключа в Key Vault. Он информирует Azure Monitor хранилище о версии ключа, используемой для шифрования данных. При обновлении новый ключ используется для переноса и распаковки ключа хранилища (АЕК).

Чтобы обновить ресурс *кластера* , используя сведения об *идентификаторе ключа* Key Vault, выберите текущую версию ключа в Azure Key Vault, чтобы получить сведения об идентификаторе ключа.

![Предоставление Key Vault разрешений](media/customer-managed-keys/key-identifier-8bit.png)

Обновите ресурс *кластера* кэйваултпропертиес, используя сведения об идентификаторе ключа.

**Обновление**

Этот диспетчер ресурсов запрос является асинхронной операцией при обновлении сведений об идентификаторе ключа, а также в синхронном режиме при обновлении значения емкости.

> [!Note]
> Вы можете указать частичный текст в ресурсе *кластера* для обновления *SKU*, *кэйваултпропертиес* или *биллингтипе*.

```rst
PATCH https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.OperationalInsights/clusters/<cluster-name>?api-version=2020-03-01-preview
Authorization: Bearer <token>
Content-type: application/json

{
   "identity": { 
     "type": "systemAssigned" 
     },
   "sku": {
     "name": "capacityReservation",
     "capacity": 1000
     },
   "properties": {
    "billingType": "cluster",
     "KeyVaultProperties": {
       KeyVaultUri: "https://<key-vault-name>.vault.azure.net",
       KeyName: "<key-name>",
       KeyVersion: "<current-version>"
       }
   },
   "location":"<region-name>"
}
```
"Кэйваултпропертиес" содержит сведения об идентификаторе ключа Key Vault.

**Ответ**

200 ОК и заголовок.
Это занимает несколько минут для завершения распространения идентификатора ключа. Проверить состояние обновления можно двумя способами.
1. Скопируйте значение URL-адреса Azure-AsyncOperation из ответа и выполните [проверку состояния асинхронных операций](#asynchronous-operations-and-status-check).
2. Отправьте запрос GET на ресурс *кластера* и просмотрите свойства *кэйваултпропертиес* . Недавно обновленные сведения об идентификаторе ключа должны возвращаться в ответе.

Ответ на запрос GET для ресурса *кластера* должен выглядеть следующим образом после завершения обновления идентификатора ключа:

```json
{
  "identity": {
    "type": "SystemAssigned",
    "tenantId": "tenant-id",
    "principalId": "principle-id"
    },
  "sku": {
    "name": "capacityReservation",
    "capacity": 1000,
    "lastSkuUpdate": "Sun, 22 Mar 2020 15:39:29 GMT"
    },
  "properties": {
    "keyVaultProperties": {
      keyVaultUri: "https://key-vault-name.vault.azure.net",
      kyName: "key-name",
      keyVersion: "current-version"
      },
    "provisioningState": "Succeeded",
    "clusterType": "LogAnalytics", 
    "billingType": "cluster",
    "clusterId": "cluster-id"
  },
  "id": "/subscriptions/subscription-id/resourceGroups/resource-group-name/providers/Microsoft.OperationalInsights/clusters/cluster-name",
  "name": "cluster-name",
  "type": "Microsoft.OperationalInsights/clusters",
  "location": "region-name"
}
```

### <a name="workspace-association-to-cluster-resource"></a>Сопоставление рабочей области с ресурсом *кластера*

Для выполнения этой операции требуются разрешения "запись" для рабочей области и ресурса *кластера* , в том числе следующие действия:

- Рабочая область: Microsoft. OperationalInsights/рабочие области/запись
- В ресурсе *кластера* : Microsoft. OperationalInsights/Clusters/Write

> [!IMPORTANT]
> Этот шаг следует выполнить только после завершения подготовки выделенной Log Analytics кластера. Если вы связываете рабочие области и принимаете данные до подготовки, полученные данные будут удалены и не будут восстановлены.

**Связывание рабочей области**

Этот диспетчер ресурсов запрос является асинхронной операцией.

```rst
PUT https://management.azure.com/subscriptions/<subscription-id>/resourcegroups/<resource-group-name>/providers/microsoft.operationalinsights/workspaces/<workspace-name>/linkedservices/cluster?api-version=2020-03-01-preview 
Authorization: Bearer <token>
Content-type: application/json

{
  "properties": {
    "WriteAccessResourceId": "/subscriptions/<subscription-id>/resourcegroups/<resource-group-name>/providers/microsoft.operationalinsights/clusters/<cluster-name>"
    }
}
```

**Ответ**

200 ОК и заголовок.

Полученные данные хранятся в зашифрованном виде с помощью управляемого ключа после операции сопоставления, что может занять до 90 минут. Проверить состояние сопоставления рабочей области можно двумя способами.

1. Скопируйте значение URL-адреса Azure-AsyncOperation из ответа и выполните [проверку состояния асинхронных операций](#asynchronous-operations-and-status-check).
2. Отправить [рабочие области — запрос Get](https://docs.microsoft.com/rest/api/loganalytics/workspaces/get) и наблюдать за ответом, связанная Рабочая область будет иметь клустерресаурцеид в разделе "компоненты".

```rest
GET https://management.azure.com/subscriptions/<subscription-id>/resourcegroups/<resource-group-name>/providers/microsoft.operationalInsights/workspaces/<workspace-name>?api-version=2020-03-01-preview
```

**Ответ**

```json
{
  "properties": {
    "source": "Azure",
    "customerId": "workspace-name",
    "provisioningState": "Succeeded",
    "sku": {
      "name": "pricing-tier-name",
      "lastSkuUpdate": "Tue, 28 Jan 2020 12:26:30 GMT"
    },
    "retentionInDays": days,
    "features": {
      "legacy": 0,
      "searchVersion": 1,
      "enableLogAccessUsingOnlyResourcePermissions": true,
      "clusterResourceId": "/subscriptions/subscription-id/resourceGroups/resource-group-name/providers/Microsoft.OperationalInsights/clusters/cluster-name"
    },
    "workspaceCapping": {
      "dailyQuotaGb": -1.0,
      "quotaNextResetTime": "Tue, 28 Jan 2020 14:00:00 GMT",
      "dataIngestionStatus": "RespectQuota"
    }
  },
  "id": "/subscriptions/subscription-id/resourcegroups/resource-group-name/providers/microsoft.operationalinsights/workspaces/workspace-name",
  "name": "workspace-name",
  "type": "Microsoft.OperationalInsights/workspaces",
  "location": "region-name"
}
```

## <a name="cmk-kek-revocation"></a>Отзыв CMK (KEK)

Вы можете отозвать доступ к данным, отключив ключ или удалив политику доступа к ресурсам *кластера* в Key Vault. Выделенное Log Analytics хранилище кластера всегда будет учитывать изменения ключевых разрешений в течение часа или более ранней, а хранилище станет недоступным. Все данные, принимаемые в рабочие области, связанные с ресурсом *кластера* , удаляются, и запросы завершатся ошибкой. Ранее полученные данные остаются недоступными в хранилище, так как ресурс *кластера* и ваши рабочие области не удаляются. Недоступные данные определяются политикой хранения данных и удаляются при достижении срока хранения. 

Полученные данные за последние 14 дней также сохраняются в оперативном кэше (с поддержкой SSD) для эффективной работы механизма запросов. Эта операция удаляется из операции отзыва ключа и становится недоступной.

Хранилище периодически опрашивает Key Vault, чтобы попытаться расшифровать ключ шифрования и получить доступ к нему, а затем возобновить прием данных и выполнить запрос в течение 30 минут.

## <a name="cmk-kek-rotation"></a>Вращение CMK (KEK)

Для вращения CMK требуется явное обновление ресурса *кластера* с новой версией ключа в Azure Key Vault. Следуйте инструкциям в разделе "Обновление ресурса *кластера* с подробными сведениями об идентификаторе ключа". Если вы не обновите сведения о новом идентификаторе ключа в ресурсе *кластера* , выделенное log Analyticsное хранилище кластера продолжит использовать предыдущий ключ.

Все данные остаются доступными после операции смены ключей, включая данные, полученные до смены ключа, так как данные всегда шифруются с помощью ключа шифрования учетной записи (АЕК), а АЕК теперь шифруются с помощью новой версии ключа шифрования ключа (KEK) в Key Vault.

## <a name="limitations-and-constraints"></a>Ограничения и ограничения

- CMK поддерживается в выделенном кластере Log Analytics, пригодном для клиентов, отправляющих 1 ТБ в день или более.

- Максимальное число ресурсов *кластера* на регион и подписку равно 2

- Рабочую область можно связать с ресурсом *кластера* , а затем отменить ее связь, если CMK для его данных больше не требуется или по какой-либо другой причине. Число ассоциаций рабочей области, которое можно выполнять в рабочей области в течение 30 дней, ограничено 2

- Связь рабочей области с ресурсом *кластера* должна быть выполнена только после того, как была выполнена проверка того, что выделенная подготовка кластера log Analytics завершена. Данные, отправляемые в рабочую область до завершения, будут удалены и не будут восстановлены.

- Шифрование CMK применяется к вновь принимаемым данным после настройки CMK. Данные, которые были приняты до настройки CMK, остаются зашифрованными с помощью ключа Microsoft Key. Вы можете легко запрашивать данные, полученные до и после настройки CMK.

- Azure Key Vault должны быть настроены как восстанавливаемые. Эти свойства не включены по умолчанию и должны быть настроены с помощью интерфейса командной строки или PowerShell:

  - Необходимо включить [обратимое удаление](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete)
  - Чтобы защититься от принудительного удаления секрета или хранилища даже после обратимого удаления, следует включить [защиту](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete#purge-protection) от удаления.

- Перемещение ресурса *кластера* в другую группу ресурсов или подписку сейчас не поддерживается.

- Ваша Azure Key Vault, *кластерный* ресурс и связанные рабочие области должны находиться в одном и том же регионе и в одном клиенте Azure Active Directory (Azure AD), но они могут находиться в разных подписках.

- Связь рабочей области с ресурсом *кластера* завершится ошибкой, если она связана с другим ресурсом *кластера* .


## <a name="management"></a>Управление

- **Получение всех ресурсов *кластера* для группы ресурсов**

  ```rst
  GET https://management.azure.com/subscriptions/<subscription-id>/resourcegroups/<resource-group-name>/providers/Microsoft.OperationalInsights/clusters?api-version=2020-03-01-preview
  Authorization: Bearer <token>
  ```
    
  **Ответ**
  
  ```json
  {
    "value": [
      {
        "identity": {
          "type": "SystemAssigned",
          "tenantId": "tenant-id",
          "principalId": "principal-Id"
        },
        "sku": {
          "name": "capacityReservation",
          "capacity": 1000,
          "lastSkuUpdate": "Sun, 22 Mar 2020 15:39:29 GMT"
          },
        "properties": {
           "keyVaultProperties": {
              keyVaultUri: "https://key-vault-name.vault.azure.net",
              keyName: "key-name",
              keyVersion: "current-version"
              },
          "provisioningState": "Succeeded",
          "clusterType": "LogAnalytics", 
          "billingType": "cluster",
          "clusterId": "cluster-id"
        },
        "id": "/subscriptions/subscription-id/resourcegroups/resource-group-name/providers/microsoft.operationalinsights/workspaces/workspace-name",
        "name": "cluster-name",
        "type": "Microsoft.OperationalInsights/clusters",
        "location": "region-name"
      }
    ]
  }
  ```

- **Получение всех ресурсов *кластера* для подписки**

  ```rst
  GET https://management.azure.com/subscriptions/<subscription-id>/providers/Microsoft.OperationalInsights/clusters?api-version=2020-03-01-preview
  Authorization: Bearer <token>
  ```
    
  **Ответ**
    
  Тот же ответ, что и для "ресурсов*кластера* для группы ресурсов", но в области подписки.

- **Обновление *резервирования емкости* в ресурсе *кластера***

  Когда объем данных в связанных рабочих областях изменяется с течением времени и необходимо соответствующим образом обновить уровень резервирования емкости. Выполните [Обновление ресурса *кластера* ](#update-cluster-resource-with-key-identifier-details) и укажите новое значение емкости. Это значение может находиться в диапазоне от 1 000 до 2 000 ГБ в день и в шагах 100. Чтобы включить уровень выше 2 000 ГБ в день, обратитесь к своему контакту Майкрософт. Обратите внимание, что вам не нужно указывать полный текст запроса на ОСТАВШУЮся версию и включать номер SKU:

  ```json
  {
    "sku": {
      "name": "capacityReservation",
      "Capacity": 1000
    }
  }
  ``` 

- **Обновление *биллингтипе* в ресурсе *кластера***

  Свойство *биллингтипе* определяет атрибуты выставления счетов для ресурса *кластера* и его данных:
  - *кластер* (по умолчанию) — выставление счетов относится к подписке, в которой размещается ресурс кластера.
  - *рабочие области* — выставление счетов с атрибутами для подписок, в которых размещаются рабочие области, пропорционально
  
  Выполните [Обновление ресурса *кластера* ](#update-cluster-resource-with-key-identifier-details) и укажите новое значение биллингтипе. Обратите внимание, что вам не нужно указывать полный текст запроса на ОСТАВШУЮся часть и включать *биллингтипе*:

  ```json
  {
    "properties": {
      "billingType": "cluster",
      }  
  }
  ``` 

- **Отменить связывание рабочей области**

  Для выполнения этой операции требуются разрешения на запись в рабочую область и ресурс *кластера* . Вы можете в любое время отменить связывание рабочей области с ресурсом *кластера* . Новые принимаемые данные после операции отмены сопоставления сохраняются в хранилище Log Analytics и шифруются с помощью ключа Microsoft Key. Вы можете запросить данные, которые были приняты в рабочую область, до и после отмены взаимосвязи без проблем, если ресурс *кластера* подготовлен и настроен с допустимым ключом key Vault.

  Этот диспетчер ресурсов запрос является асинхронной операцией.

  ```rest
  DELETE https://management.azure.com/subscriptions/<subscription-id>/resourcegroups/<resource-group-name>/providers/microsoft.operationalinsights/workspaces/<workspace-name>/linkedservices/cluster?api-version=2020-03-01-preview
  ```

  **Ответ**

  200 ОК и заголовок.

  Полученные данные после операции отмены ассоциации сохраняются в хранилище Log Analytics. это может занять 90 минут. Состояние отмены сопоставления рабочей области можно проверить двумя способами.

  1. Скопируйте значение URL-адреса Azure-AsyncOperation из ответа и выполните [проверку состояния асинхронных операций](#asynchronous-operations-and-status-check).
  2. Отправка [рабочих областей — запрос Get](https://docs.microsoft.com/rest/api/loganalytics/workspaces/get) и наблюдение за ответом, несвязанная Рабочая область не будет содержать *клустерресаурцеид* в разделе " *компоненты*".


- **Удаление ресурса *кластера***

  Для выполнения этой операции необходимы разрешения Write для ресурса *кластера* . Операция обратимого удаления выполняется, чтобы разрешить восстановление ресурса *кластера* , включая его данные в течение 14 дней, независимо от того, было ли удаление случайным или умышленно. Имя ресурса *кластера* остается зарезервированным во время периода обратимого удаления, и вы не можете создать новый кластер с таким именем. После периода обратимого удаления имя ресурса *кластера* освобождается, ресурс *кластера* и данные будут окончательно удалены и не будут восстановлены. Любая связанная Рабочая область становится несвязанной с ресурсом *кластера* при операции удаления. Новые принимаемые данные хранятся в хранилище Log Analytics и шифруются с помощью ключа Microsoft. Операция отмены, связанная с рабочими областями, является асинхронной и может занять до 90 минут.

  ```rst
  DELETE https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.OperationalInsights/clusters/<cluster-name>?api-version=2020-03-01-preview
  Authorization: Bearer <token>
  ```

  **Ответ**

  200 ОК

- **Восстановление ресурса *кластера* и данных** 
  
  Ресурс *кластера* , который был удален за последние 14 дней, находится в состоянии обратимого удаления и может быть восстановлен с помощью его данных. Так как все рабочие области были удалены из ресурса *кластера* при удалении, необходимо повторно связать рабочие области после восстановления для шифрования CMK. В настоящее время операция восстановления выполняется вручную группой продуктов. Используйте канал Майкрософт для запросов на восстановление.

## <a name="troubleshooting"></a>Устранение неполадок
- Поведение при Key Vault доступности
  - В нормальных операциях — кэш хранилища АЕК в течение короткого периода времени и возвращается к Key Vault для периодического растекания.
    
  - Ошибки неустранимых подключений. хранилище обрабатывает временные ошибки (время ожидания, сбои подключений, проблемы DNS), позволяя ключам оставаться в кэше в течение короткого промежутка времени, а это приводит к небольшому нестабильной работеу доступности. Возможности запросов и приема продолжаются без перерывов.
    
  - Live site — недоступность в течение 30 минут приведет к тому, что учетная запись хранения станет доступной. Возможность запросов недоступна, и полученные данные кэшируются в течение нескольких часов с помощью ключа Майкрософт, чтобы избежать потери данных. При восстановлении доступа к Key Vault запрос становится доступным, а временные кэшированные данные принимаются в хранилище данных и шифруются с помощью CMK.

- Если вы создадите ресурс *кластера* и сразу укажете кэйваултпропертиес, операция может завершиться ошибкой, так как политика доступа не может быть определена, пока не будет назначено системное удостоверение ресурсу *кластера* .

- Если вы обновляете существующий ресурс *кластера* с помощью кэйваултпропертиес и в Key Vault отсутствует политика доступа к ключам "Get", операция завершится ошибкой.

- При попытке удалить ресурс *кластера* , связанный с рабочей областью, операция удаления завершится ошибкой.

- Если при создании ресурса *кластера* возникает ошибка конфликта, возможно, вы удалили ресурс *кластера* за последние 14 дней и в течение периода обратимого удаления. Имя ресурса *кластера* остается зарезервированным во время периода обратимого удаления, и вы не можете создать новый кластер с таким именем. Имя освобождается после периода обратимого удаления при окончательном удалении ресурса *кластера* .

- Если обновить ресурс *кластера* во время выполнения операции, операция завершится ошибкой.

- Если вы не развернете ресурс *кластера* , убедитесь, что Azure Key Vault, ресурс *кластера*   и связанные рабочие области log Analytics находятся в одном регионе. Может находиться в разных подписках.

- Если вы обновляете версию ключа в Key Vault и не обновляете новые сведения об идентификаторе ключа в ресурсе *кластера* , кластер log Analytics будет использовать предыдущий ключ, и ваши данные станут недоступными. Обновление сведений о новом идентификаторе ключа в ресурсе *кластера* для возобновления приема данных и возможности запроса данных.

- Для получения поддержки и справки, связанной с управляемым клиентом ключом, используйте свои контакты в Майкрософт.

