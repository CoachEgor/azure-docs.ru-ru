---
title: Устранение неполадок оповещений метрик Azure
description: Распространенные проблемы с Azure Monitor оповещениями о метриках и возможными решениями.
author: harelbr
ms.author: harelbr
ms.topic: reference
ms.date: 08/09/2020
ms.subservice: alerts
ms.openlocfilehash: c6b7d1fb28e81957ded56662a06946e56c3dc00e
ms.sourcegitcommit: b8702065338fc1ed81bfed082650b5b58234a702
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2020
ms.locfileid: "88114903"
---
# <a name="troubleshooting-problems-in-azure-monitor-metric-alerts"></a>Устранение неполадок в Azure Monitor оповещениях метрик 

В этой статье обсуждаются распространенные проблемы в Azure Monitor [оповещениях метрик](alerts-metric-overview.md) и способах их устранения.

Azure Monitor оповещения заблаговременно уведомляют Вас при обнаружении важных условий в данных мониторинга. Они позволяют выявить и устранить проблемы, прежде чем пользователи системы обнаружат их. Дополнительные сведения о предупреждениях см. [в разделе Обзор оповещений в Microsoft Azure](alerts-overview.md).

## <a name="metric-alert-should-have-fired-but-didnt"></a>Оповещение метрики должно быть инициировано, но не было 

Если вы считаете, что оповещение метрики должно быть вызвано, но оно не было запущено и не найдено в портал Azure, попробуйте выполнить следующие действия.

1. **Конфигурация** . Проверьте конфигурацию правила генерации оповещений метрик, чтобы убедиться, что она настроена правильно:
    - Убедитесь, что **тип агрегирования**, **гранулярность статистической обработки (точка)** и **пороговое значение** или **чувствительность** настроены должным образом.
    - Для правила генерации оповещений, которое использует динамические пороговые значения, проверьте, настроены ли дополнительные параметры, так как **число нарушений** может фильтровать предупреждения и **игнорировать данные, прежде чем** может повлиять на вычисление пороговых значений.

       > [!NOTE] 
       > Для динамических пороговых значений требуется не менее 3 дней и 30 образцов метрик, прежде чем станет активным.

2. Порождено, **но без уведомления** . Просмотрите [список вызванных предупреждений](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/alertsV2) , чтобы узнать, удается ли найти запущенное оповещение. Если вы видите предупреждение в списке, но возникли проблемы с некоторыми его действиями или уведомлениями, см. Дополнительные сведения [здесь](./alerts-troubleshoot.md#action-or-notification-on-my-alert-did-not-work-as-expected).

3. **Уже активен** — проверьте, вызвано ли предупреждение в ряде временных рядов, для которого вы ожидали оповещение. Метрические оповещения — это оповещения с отслеживанием состояния, что значит, что как только оповещение поступает на определенный временной ряд метрики, дополнительные оповещения на этом временном ряду не будут поступать, пока проблема не будет устранена. Этот вариант разработки сокращает шум. Предупреждение автоматически разрешается, если условие предупреждения не выполняется для трех последовательных вычислений.

4. **Используемые измерения** . Если вы выбрали некоторые [значения измерения для метрики](./alerts-metric-overview.md#using-dimensions), правило генерации оповещений отслеживает каждый отдельный временной ряд метрик (как определено сочетанием значений измерений) для нарушения порогового значения. Чтобы также отслеживать временные ряды метрик (без выбранных измерений), настройте дополнительное правило генерации оповещений для метрики без выбора измерений.

5. **Статистическая обработка и детализация времени** . Если вы визуализируете метрику с помощью [диаграмм метрик](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/metrics), убедитесь, что:
    * Выбранная **Статистическая обработка** в схеме метрики совпадает с **типом агрегирования** в правиле оповещения
    * Выбранная **гранулярность времени** совпадает с **гранулярностью статистической обработки (период)** в правиле генерации оповещений (и не имеет значение "автоматически")

## <a name="metric-alert-fired-when-it-shouldnt-have"></a>Оповещение метрики, когда оно не должно иметь

Если вы считаете, что оповещение метрики не должно быть инициировано, но это было сделано, следующие шаги могут помочь устранить проблему.

1. Просмотрите [список вызванные предупреждения](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/alertsV2) , чтобы перейти к запущенному оповещению, и щелкните, чтобы просмотреть сведения о нем. Просмотрите сведения в разделе **почему это предупреждение срабатывает?** , чтобы увидеть диаграмму метрик, **значение метрики**и **пороговое значение** на момент запуска оповещения.

    > [!NOTE] 
    > Если вы используете тип условия динамических пороговых значений и думаете, что используются неверные пороговые значения, оставьте отзыв с помощью значка нахмуренный смайлик. Эти отзывы повлияют на алгоритмы машинного обучения и помогают улучшить обнаружение в будущем.

2. Если для метрики выбрано несколько значений измерений, предупреждение будет активировано, когда **любой** из временных рядов (как определено сочетанием значений измерений) нарушает пороговое значение. Дополнительные сведения об использовании измерений в оповещениях метрик см. [здесь](./alerts-metric-overview.md#using-dimensions).

3. Проверьте конфигурацию правила генерации оповещений, чтобы убедиться, что она настроена правильно:
    - Убедитесь, что **тип агрегирования**, **гранулярность статистической обработки (точка)** и **пороговое значение** или **чувствительность** настроены должным образом.
    - Для правила генерации оповещений, которое использует динамические пороговые значения, проверьте, настроены ли дополнительные параметры, так как **число нарушений** может фильтровать предупреждения и **игнорировать данные, прежде чем** может повлиять на вычисление пороговых значений.

   > [!NOTE]
   > Для динамических пороговых значений требуется не менее 3 дней и 30 образцов метрик, прежде чем станет активным.

4. Если вы визуализируете метрику с помощью [диаграммы метрик](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/metrics), убедитесь, что:
    - Выбранная **Статистическая обработка** в схеме метрики совпадает с **типом агрегирования** в правиле оповещения
    - Выбранная **гранулярность времени** совпадает с **гранулярностью статистической обработки (период)** в правиле генерации оповещений (и не имеет значение "автоматически")

5. Если оповещение запущено, когда уже запущены предупреждения, которые отслеживают те же условия (которые не разрешены), проверьте, настроено ли для правила генерации оповещений свойство *Автосмягчение* на **значение false** (это свойство можно настроить только с помощью интерфейса RESTful, PowerShell или CLI, поэтому проверьте скрипт, используемый для развертывания правила генерации оповещений). В таком случае правило генерации оповещений не выполняет автоматическое разрешение запущенных предупреждений и не требует, чтобы предупреждение было устранено перед повторным срабатыванием.


## <a name="cant-find-the-metric-to-alert-on---virtual-machines-guest-metrics"></a>Не удается найти метрику для оповещений гостевых метрик виртуальных машин

Чтобы оповещать о метриках операционной системы виртуальной машины (например, памяти, места на диске), убедитесь, что вы установили необходимый агент для сбора этих данных в Azure Monitor метрики:
- [Для виртуальных машин Windows](./collect-custom-metrics-guestos-resource-manager-vm.md)
- [Для виртуальных машин Linux](./collect-custom-metrics-linux-telegraf.md)

Дополнительные сведения о сборе данных из гостевой операционной системы виртуальной машины см. [здесь](../insights/monitor-vm-azure.md#guest-operating-system).
    
> [!NOTE] 
> Если вы настроили метрики гостя для отправки в рабочую область Log Analytics, метрики отображаются в ресурсе рабочей области Log Analytics и начнет отображать данные **только** после создания правила генерации оповещений, которое отслеживает их. Выполните действия, чтобы [настроить оповещение метрики для журналов](./alerts-metric-logs.md#configuring-metric-alert-for-logs).

## <a name="cant-find-the-metric-to-alert-on"></a>Не удается найти метрику для оповещения

Если вы хотите оповещать об определенной метрике, но не видите метрик для ресурса, [Проверьте, поддерживается ли для оповещений метрика тип ресурса](./alerts-metric-near-real-time.md).
Если вы видите некоторые метрики для ресурса, но не можете найти определенную метрику, [Проверьте, доступна ли эта метрика](./metrics-supported.md), и, если это так, ознакомьтесь с описанием метрики, чтобы узнать, доступна ли она только в определенных версиях или выпусках ресурса.

## <a name="cant-find-the-metric-dimension-to-alert-on"></a>Не удается найти Измерение метрики для оповещения

Если вы хотите оповещать об [определенном значении измерения метрики](./alerts-metric-overview.md#using-dimensions), но не можете найти эти значения, обратите внимание на следующее:

1. Для отображения значений измерений в списке **значений измерений** может потребоваться несколько минут.
1. Отображаемые значения измерений основаны на данных метрик, собранных за последние 3 дня.
1. Если значение измерения еще не выдается, щелкните знак "+", чтобы добавить пользовательское значение.
1. Если вы хотите получать оповещения обо всех возможных значениях измерения (включая будущие значения), установите флажок "Select *".

## <a name="metric-alert-rules-still-defined-on-a-deleted-resource"></a>Правила генерации оповещений метрик по-прежнему определены для удаленного ресурса 

При удалении ресурса Azure связанные с ним правила генерации оповещений метрики не удаляются автоматически. Чтобы удалить правила генерации оповещений, связанные с удаленным ресурсом, выполните следующие действия.

1. Откройте группу ресурсов, в которой был определен удаленный ресурс.
1. В списке ресурсов установите флажок **Показывать скрытые типы**.
1. Отфильтруйте этот список по типу **microsoft.insights/metricalerts**.
1. Выберите соответствующие правила генерации оповещений и нажмите кнопку **Удалить** .

## <a name="make-metric-alerts-occur-every-time-my-condition-is-met"></a>Создавать оповещения метрик при каждом выполнении условия

Оповещения метрик по умолчанию имеют состояние, поэтому дополнительные предупреждения не запускаются, если в заданный временной ряд уже произошло оповещение. Если вы хотите сделать определенное правило оповещений метрик без отслеживания состояния и получать оповещение о каждой оценке, в которой выполняется условие предупреждения, создайте правило оповещения программным способом (например, с помощью [Диспетчер ресурсов](./alerts-metric-create-templates.md), [PowerShell](/powershell/module/az.monitor/?view=azps-3.6.1), службы [RESTful](/rest/api/monitor/metricalerts/createorupdate), [интерфейса командной строки](/cli/azure/monitor/metrics/alert?view=azure-cli-latest)) и задайте для свойства " *автосмягчение* " значение "false".

> [!NOTE] 
> Если правило генерации оповещений метрики не позволяет устранить неполадки, запущенные предупреждения, поэтому даже после того, как условие не будет выполнено, события будут оставаться в состоянии срабатывания до истечения 30 дней.

## <a name="define-an-alert-rule-on-a-custom-metric-that-isnt-emitted-yet"></a>Определение правила генерации оповещений для настраиваемой метрики, которая еще не выдается

При создании правила генерации оповещений метрика имя метрики проверяется с помощью [API определений метрик](/rest/api/monitor/metricdefinitions/list) , чтобы убедиться, что он существует. В некоторых случаях вы хотите создать правило генерации оповещений для пользовательской метрики, даже прежде чем она будет выдаваться. Например, при создании (с использованием шаблона диспетчер ресурсов) ресурс Application Insights, который будет выдавать пользовательскую метрику, а также правило генерации оповещений, отслеживающее эту метрику.

Чтобы избежать сбоя развертывания при попытке проверить определения пользовательской метрики, можно использовать параметр *скипметриквалидатион* в разделе критериев правила оповещения, что приведет к пропуску проверки метрики. Сведения об использовании этого параметра в шаблоне диспетчер ресурсов см. в приведенном ниже примере. Дополнительные сведения см. в статье [полный пример шаблона диспетчер ресурсов для создания правил генерации оповещений метрик](./alerts-metric-create-templates.md).

```json
"criteria": {
    "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
        "allOf": [
            {
                    "name" : "condition1",
                        "metricName": "myCustomMetric",
                "metricNamespace": "myCustomMetricNamespace",
                        "dimensions":[],
                        "operator": "GreaterThan",
                        "threshold" : 10,
                        "timeAggregation": "Average",
                    "skipMetricValidation": true
        }
              ]
        }
```

## <a name="export-the-arm-template-of-a-metric-alert-rule-via-the-azure-portal"></a>Экспортируйте шаблон ARM правила генерации оповещений метрики с помощью портал Azure

Экспорт шаблона ARM правила генерации оповещений метрик помогает понять синтаксис и свойства JSON, а также использовать его для автоматизации будущих развертываний.
1. Перейдите к разделу " **группы ресурсов** " на портале и выберите группу ресурсов, содержащую правило.
2. В разделе Обзор установите флажок **Показывать скрытые типы** .
3. В поле Фильтр **типов** выберите *Microsoft. Insights/метрикалертс*.
4. Выберите соответствующее правило генерации оповещений, чтобы просмотреть сведения о нем.
5. В разделе **Параметры**выберите **Экспорт шаблона**.

## <a name="metric-alert-rules-quota-too-small"></a>Квота на правила генерации оповещений метрик слишком мала

Допустимое число правил генерации оповещений метрик на подписку ограничено [квотой](../service-limits.md).

Если вы достигли предельной квоты, следующие шаги могут помочь устранить проблему:
1. Попробуйте удалить или отключить правила генерации оповещений метрик, которые больше не используются.

2. Перейдите на использование правил генерации оповещений метрик, которые отслеживают сразу несколько ресурсов. Благодаря этой возможности одно правило генерации оповещений может отслеживать несколько ресурсов, используя только одно правило генерации оповещений, подсчитанное по квоте. Дополнительные сведения об этой возможности и поддерживаемых типах ресурсов см. [здесь](./alerts-metric-overview.md#monitoring-at-scale-using-metric-alerts-in-azure-monitor).

3. Если требуется увеличить квоту, откройте запрос в службу поддержки и укажите следующие сведения:

    - Идентификаторы подписок, для которых необходимо увеличить квоту
    - Тип ресурса для увеличения квоты: **оповещения метрик** или **оповещения метрик (классическая модель)**
    - Запрашиваемое увеличение квоты.

## <a name="check-total-number-of-metric-alert-rules"></a>Проверка общего числа правил генерации оповещений метрик

Чтобы проверить текущее использование правил генерации оповещений метрик, выполните следующие действия.

### <a name="from-the-azure-portal"></a>На портале Azure

1. На экране **Оповещения** щелкните **Управление правилами оповещения**.
2. Фильтрация к соответствующей подписке с помощью элемента управления "раскрывающийся список **подписок** "
3. НЕ следует выполнять фильтрацию по определенной группе ресурсов, типу ресурса или ресурсу.
4. В раскрывающемся элементе управления " **Тип сигнала** " выберите **метрики** .
5. Убедитесь, что для элемента управления "раскрывающийся список **состояния** " задано значение **включено** .
6. Общее число правил генерации оповещений метрики, отображаемых над списком правил генерации оповещений

### <a name="from-api"></a>Из API

- PowerShell: используйте [Get-AzMetricAlertRuleV2](/powershell/module/az.monitor/get-azmetricalertrulev2?view=azps-3.7.0).
- REST API: [выведите список по подписке](/rest/api/monitor/metricalerts/listbysubscription).
- Azure CLI: используйте [az monitor metrics alert list](/cli/azure/monitor/metrics/alert?view=azure-cli-latest#az-monitor-metrics-alert-list).

## <a name="managing-alert-rules-using-resource-manager-templates-rest-api-powershell-or-azure-cli"></a>Управление правилами генерации оповещений с помощью диспетчер ресурсов шаблонов, REST API, PowerShell или Azure CLI

Если у вас возникли проблемы с созданием, обновлением, извлечением или удалением оповещений метрик с помощью диспетчер ресурсов шаблонов, REST API, PowerShell или интерфейса командной строки Azure (CLI), следующие действия могут помочь устранить проблему.

### <a name="resource-manager-templates"></a>Шаблоны Resource Manager

- Просмотрите список [распространенных ошибок развертывания в Azure](../../azure-resource-manager/templates/common-deployment-errors.md) и примите соответствующие меры.
- Сведения о том, как правильно передаются все параметры, см. в статье [оповещения о метриках Azure Resource Manager примеры шаблонов](./alerts-metric-create-templates.md) .

### <a name="rest-api"></a>REST API

Ознакомьтесь с [руководством по REST API](/rest/api/monitor/metricalerts/) , чтобы проверить правильность передачи всех параметров.

### <a name="powershell"></a>PowerShell

Убедитесь, что вы используете правильные командлеты PowerShell для оповещений метрик:

- Командлеты PowerShell для оповещений метрик доступны в модуле [Az.Monitor](/powershell/module/az.monitor/?view=azps-3.6.1)
- Обязательно используйте командлеты, которые заканчиваются на "v2", для новых (не классической) оповещений метрик (например, [Add-AzMetricAlertRuleV2](/powershell/module/az.monitor/add-azmetricalertrulev2?view=azps-3.6.1)).

### <a name="azure-cli"></a>Azure CLI

Убедитесь, что вы используете команды CLI правой кнопкой мыши для оповещений метрик:

- Команды интерфейса командной строки для оповещений метрик начинаются с `az monitor metrics alert`. Ознакомьтесь со [справочником по Azure CLI](/cli/azure/monitor/metrics/alert?view=azure-cli-latest), в котором описывается синтаксис.
- Ознакомьтесь с [примером, в котором показано, как использовать CLI для оповещений метрик](./alerts-metric.md#with-azure-cli).
- Чтобы создать оповещение для пользовательской метрики, обязательно добавьте к имени метрики соответствующее пространство имен метрики: NAMESPACE.METRIC

### <a name="general"></a>Общие сведения

- Если вы получаете `Metric not found` сообщение об ошибке:

   - Для метрики платформы: Убедитесь, что вы используете имя **метрики** на [странице Azure Monitor поддерживаемые метрики](./metrics-supported.md), а не **Отображаемое имя метрики** .

   - Для пользовательской метрики убедитесь, что метрика уже выдается (вы не можете создать правило генерации оповещений для пользовательской метрики, которая еще не существует) и что вы предоставляете пространство имен пользовательской метрики (см. Пример шаблона ARM [здесь](./alerts-metric-create-templates.md#template-for-a-static-threshold-metric-alert-that-monitors-a-custom-metric)).

- Если вы создаете [оповещения метрик в журналах](./alerts-metric-logs.md), убедитесь, что включены соответствующие зависимости. Ознакомьтесь с [примером шаблона](./alerts-metric-logs.md#resource-template-for-metric-alerts-for-logs).

- При создании правила генерации оповещений, которое содержит несколько условий, обратите внимание на следующие ограничения.

   - В каждом из критериев можно выбрать только одно значение для каждого измерения.
   - Невозможно использовать "\*" в качестве значения измерения.
   - Если метрики, настроенные в разных критериях, поддерживают одно и то же измерение, настроенное значение измерения должно быть явно задано одинаково для всех этих метрик (см. Пример шаблона [Диспетчер ресурсов).](./alerts-metric-create-templates.md#template-for-a-static-threshold-metric-alert-that-monitors-multiple-criteria)


## <a name="no-permissions-to-create-metric-alert-rules"></a>Нет разрешений на создание правил генерации оповещений метрики

Чтобы создать правило генерации оповещений метрики, необходимы следующие разрешения.

- Разрешение на чтение в целевом ресурсе правила генерации оповещений
- Разрешение на запись в группу ресурсов, в которой создано правило генерации оповещений (если правило генерации оповещений создается на основе портал Azure, правило генерации оповещений создается в той же группе ресурсов, в которой находится целевой ресурс).
- Разрешение на чтение для любой группы действий, связанной с правилом генерации оповещений (если применимо)


## <a name="naming-restrictions-for-metric-alert-rules"></a>Ограничения именования для правил генерации оповещений метрик

Учитывайте следующие ограничения для имен правил генерации оповещений метрик.

- Имена правил генерации оповещений метрик не могут быть изменены (переименованы) после создания
- Имена правил генерации оповещений метрик должны быть уникальными в пределах группы ресурсов
- Имена правил генерации оповещений метрик не могут содержать следующие символы: * # & +:  < > ? @ % { } \ / 
- Имена правил генерации оповещений метрик не могут заканчиваться следующим символом:.


## <a name="restrictions-when-using-dimensions-in-a-metric-alert-rule-with-multiple-conditions"></a>Ограничения при использовании измерений в правиле генерации оповещений метрик с несколькими условиями

Оповещения метрик поддерживают создание оповещений многомерных метрик, а также поддержку определения нескольких условий (до 5 условий для каждого правила генерации оповещений).

При использовании измерений в правиле генерации оповещений, содержащих несколько условий, учитывайте следующие ограничения.
- В каждом условии можно выбрать только одно значение для каждого измерения.
- Параметр "выбрать все текущие и будущие значения" нельзя использовать (Select \* ).
- Если метрики, настроенные в различных условиях, поддерживают одно и то же измерение, то настроенное значение измерения должно быть явно задано одинаково для всех этих метрик (в соответствующих условиях).
Пример:
    - Рассмотрим правило генерации оповещений метрик, которое определено в учетной записи хранения и отслеживает два условия:
        * Всего **транзакций** > 5
        * Среднее **SuccessE2ELatency** > 250 мс
    - Я хотел бы обновить первое условие и наблюдать только за транзакциями, в которых измерение **ApiName** имеет значение *"BLOB"* .
    - Так как метрики **транзакций** и **SuccessE2ELatency** поддерживают измерение **ApiName** , мне нужно обновить оба условия, и оба они задают измерение **ApiName** со значением *"BLOB"* .


## <a name="next-steps"></a>Дальнейшие действия

- Общие сведения об устранении неполадок с предупреждениями и уведомлениями см. [в разделе Устранение неполадок в Azure Monitor оповещениях](alerts-troubleshoot.md).
