---
title: Устранение неполадок оповещений метрик Azure
description: Распространенные проблемы с Azure Monitor оповещениями о метриках и возможными решениями.
author: harelbr
ms.author: harelbr
ms.topic: reference
ms.date: 06/21/2020
ms.subservice: alerts
ms.openlocfilehash: 36ff80bc0858d6d08cc120d126628de02ba6e703
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85130744"
---
# <a name="troubleshooting-problems-in-azure-monitor-metric-alerts"></a>Устранение неполадок в Azure Monitor оповещениях метрик 

В этой статье обсуждаются распространенные проблемы в Azure Monitor [оповещениях метрик](alerts-metric-overview.md) и способах их устранения.

Azure Monitor оповещения заблаговременно уведомляют Вас при обнаружении важных условий в данных мониторинга. Они позволяют выявить и устранить проблемы, прежде чем пользователи системы обнаружат их. Дополнительные сведения о предупреждениях см. [в разделе Обзор оповещений в Microsoft Azure](alerts-overview.md).

## <a name="metric-alert-should-have-fired-but-didnt"></a>Оповещение метрики должно быть инициировано, но не было 

Если вы считаете, что оповещение метрики должно быть вызвано, но оно не было запущено и не найдено в портал Azure, попробуйте выполнить следующие действия.

1. **Конфигурация** . Проверьте конфигурацию правила генерации оповещений метрик, чтобы убедиться, что она настроена правильно:
    - Убедитесь, что **тип агрегирования**, **гранулярность статистической обработки (точка)** и **пороговое значение** или **чувствительность** настроены должным образом.
    - Для правила генерации оповещений, которое использует динамические пороговые значения, проверьте, настроены ли дополнительные параметры, так как **число нарушений** может фильтровать предупреждения и **игнорировать данные, прежде чем** может повлиять на вычисление пороговых значений.

       > [!NOTE] 
       > Для динамических пороговых значений требуется не менее 3 дней и 30 образцов метрик, прежде чем станет активным.

2. Порождено, **но без уведомления** . Просмотрите [список вызванных предупреждений](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/alertsV2) , чтобы узнать, удается ли найти запущенное оповещение. Если вы видите предупреждение в списке, но возникли проблемы с некоторыми его действиями или уведомлениями, см. Дополнительные сведения [здесь](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-troubleshoot#action-or-notification-on-my-alert-did-not-work-as-expected).

3. **Уже активен** — проверьте, вызвано ли предупреждение в ряде временных рядов, для которого вы ожидали оповещение. Оповещения метрик имеют состояние. Это означает, что после срабатывания предупреждения в определенной временной последовательности метрики дополнительные предупреждения в этом временном ряде не будут срабатывать, пока эта ошибка не будет устранена. Этот вариант разработки сокращает шум. Предупреждение автоматически разрешается, если условие предупреждения не выполняется для трех последовательных вычислений.

4. **Используемые измерения** . Если [для метрики](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-overview#using-dimensions)выбраны некоторые значения измерений, правило генерации оповещений отслеживает каждый отдельный временной ряд метрик (как определено сочетанием значений измерений) для нарушения порогового значения. Чтобы также отслеживать временные ряды метрик (без выбранных измерений), настройте дополнительное правило генерации оповещений для метрики без выбора измерений.

5. **Статистическая обработка и детализация времени** . Если вы визуализируете метрику с помощью [диаграмм метрик](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/metrics), убедитесь, что:
    * Выбранная **Статистическая обработка** в схеме метрики совпадает с **типом агрегирования** в правиле оповещения
    * Выбранная **гранулярность времени** совпадает с **гранулярностью статистической обработки (период)** в правиле генерации оповещений (и не имеет значение "автоматически")

## <a name="metric-alert-fired-when-it-shouldnt-have"></a>Оповещение метрики, когда оно не должно иметь

Если вы считаете, что оповещение метрики не должно быть инициировано, но это было сделано, следующие шаги могут помочь устранить проблему.

1. Просмотрите [список вызванные предупреждения](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/alertsV2) , чтобы перейти к запущенному оповещению, и щелкните, чтобы просмотреть сведения о нем. Просмотрите сведения в разделе **почему это предупреждение срабатывает?** , чтобы увидеть диаграмму метрик, **значение метрики**и **пороговое значение** на момент запуска оповещения.

    > [!NOTE] 
    > Если вы используете тип условия "Динамический порог", и вам кажется, что пороги неправильные, оставьте отзыв, используя нахмуренный смайлик. Эти отзывы повлияют на алгоритмы машинного обучения и помогают улучшить обнаружение в будущем.

2. Если для метрики выбрано несколько значений измерений, предупреждение будет активировано, когда **любой** из временных рядов (как определено сочетанием значений измерений) нарушает пороговое значение. Дополнительные сведения об использовании измерений в оповещениях метрик см. [здесь](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-overview#using-dimensions).

3. Проверьте конфигурацию правила генерации оповещений, чтобы убедиться, что она настроена правильно:
    - Убедитесь, что **тип агрегирования**, **гранулярность статистической обработки (точка)** и **пороговое значение** или **чувствительность** настроены должным образом.
    - Для правила генерации оповещений, которое использует динамические пороговые значения, проверьте, настроены ли дополнительные параметры, так как **число нарушений** может фильтровать предупреждения и **игнорировать данные, прежде чем** может повлиять на вычисление пороговых значений.

   > [!NOTE]
   > Для динамических пороговых значений требуется не менее 3 дней и 30 образцов метрик, прежде чем станет активным.

4. При визуализации метрики с помощью [диаграммы метрики](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade/metrics)убедитесь, что:
    - Выбранная **Статистическая обработка** в схеме метрики совпадает с **типом агрегирования** в правиле оповещения
    - Выбранная **гранулярность времени** совпадает с **гранулярностью статистической обработки (период)** в правиле генерации оповещений (и не имеет значение "автоматически")

5. Если оповещение запущено, когда уже запущены предупреждения, которые отслеживают те же условия (которые не разрешены), проверьте, настроено ли для правила генерации оповещений свойство *Автосмягчение* на **значение false** (это свойство можно настроить только с помощью интерфейса RESTful, PowerShell или CLI, поэтому проверьте скрипт, используемый для развертывания правила генерации оповещений). В таком случае правило генерации оповещений не выполняет автоматическое разрешение запущенных предупреждений и не требует, чтобы предупреждение было устранено перед повторным срабатыванием.


## <a name="cant-find-metric-to-alert-on---virtual-machines"></a>Не удается найти метрику для оповещений на виртуальных машинах 

Чтобы создать оповещение о метриках гостей на виртуальных машинах (для памяти, места на диске), убедитесь, что настроены параметры диагностики для отправки данных в приемник Azure Monitor.
    * [Для виртуальных машин Windows](https://docs.microsoft.com/azure/azure-monitor/platform/collect-custom-metrics-guestos-resource-manager-vm)
    * [Для виртуальных машин Linux](https://docs.microsoft.com/azure/azure-monitor/platform/collect-custom-metrics-linux-telegraf)
    
> [!NOTE] 
> Если вы настроили метрики гостя для отправки в рабочую область Log Analytics, метрики отображаются в ресурсе рабочей области Log Analytics и начнет отображать данные **только** после создания правила генерации оповещений, которое отслеживает их. Выполните действия, чтобы [настроить оповещение метрики для журналов](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-logs#configuring-metric-alert-for-logs).

## <a name="cant-find-the-metric-to-alert-on"></a>Не удается найти метрику для оповещения

Если вы хотите оповещать об определенной метрике, но не видите метрик для ресурса, [Проверьте, поддерживается ли для оповещений метрика тип ресурса](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-near-real-time).
Если вы видите некоторые метрики для ресурса, но не можете найти определенную метрику, [Проверьте, доступна ли эта метрика](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported), и, если это так, ознакомьтесь с описанием метрики, чтобы узнать, доступна ли она только в определенных версиях или выпусках ресурса.

## <a name="cant-find-the-metric-dimension-to-alert-on"></a>Не удается найти Измерение метрики для оповещения

Если вы хотите оповещать об [определенном значении измерения метрики](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-overview#using-dimensions), но не можете найти эти значения, обратите внимание на следующее:

1. Для отображения значений измерений в списке **значений измерений** может потребоваться несколько минут.
1. Отображаемые значения измерений основаны на данных метрик, собранных за последние 3 дня.
1. Если значение измерения еще не выдается, щелкните знак "+", чтобы добавить пользовательское значение.
1. Если вы хотите получать оповещения обо всех возможных значениях измерения (включая будущие значения), установите флажок "Select *".

## <a name="metric-alert-rules-still-defined-on-a-deleted-resource"></a>Правила генерации оповещений метрик по-прежнему определены для удаленного ресурса 

При удалении ресурса Azure связанные с ним правила генерации оповещений метрики не удаляются автоматически. Чтобы удалить правила генерации оповещений, связанные с удаленным ресурсом, выполните следующие действия.

1. Откройте группу ресурсов, в которой был определен удаленный ресурс.
1. В списке ресурсов установите флажок **Показывать скрытые типы**.
1. Отфильтруйте этот список по типу **microsoft.insights/metricalerts**.
1. Выберите соответствующие правила генерации оповещений и нажмите кнопку **Удалить** .

## <a name="make-metric-alerts-occur-every-time-my-condition-is-met"></a>Создавать оповещения метрик при каждом выполнении условия

Оповещения метрик по умолчанию имеют состояние, поэтому дополнительные предупреждения не запускаются, если в заданный временной ряд уже произошло оповещение. Если вы хотите сделать определенное правило оповещений метрик без отслеживания состояния и получать оповещение о каждой оценке, в которой выполняется условие предупреждения, создайте правило оповещения программным способом (например, с помощью [Диспетчер ресурсов](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-create-templates), [PowerShell](https://docs.microsoft.com/powershell/module/az.monitor/?view=azps-3.6.1), службы [RESTful](https://docs.microsoft.com/rest/api/monitor/metricalerts/createorupdate), [интерфейса командной строки](https://docs.microsoft.com/cli/azure/monitor/metrics/alert?view=azure-cli-latest)) и задайте для свойства " *автосмягчение* " значение "false".

> [!NOTE] 
> Если правило генерации оповещений метрики не позволяет устранить неполадки, запущенные предупреждения, поэтому даже после того, как условие не будет выполнено, события будут оставаться в состоянии срабатывания до истечения 30 дней.


## <a name="metric-alert-rules-quota-too-small"></a>Квота на правила генерации оповещений метрик слишком мала

Допустимое число правил генерации оповещений метрик на подписку ограничено [квотой](https://docs.microsoft.com/azure/azure-monitor/service-limits).

Если вы достигли квоты, помочь устранить проблему вам помогут следующие действия.
1. Попробуйте удалить или отключить правила генерации оповещений метрик, которые больше не используются.

2. Перейдите на использование правил генерации оповещений метрик, которые отслеживают сразу несколько ресурсов. Благодаря этой возможности одно правило генерации оповещений может отслеживать несколько ресурсов, используя только одно правило генерации оповещений, подсчитанное по квоте. Дополнительные сведения об этой возможности и поддерживаемых типах ресурсов см. [здесь](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-overview#monitoring-at-scale-using-metric-alerts-in-azure-monitor).

3. Если требуется увеличить квоту, откройте запрос в службу поддержки и укажите следующие сведения:

    - Идентификаторы подписок, для которых необходимо увеличить квоту
    - Тип ресурса для увеличения квоты: **оповещения метрик** или **оповещения метрик (классическая модель)**
    - Запрашиваемое увеличение квоты.

## <a name="check-total-number-of-metric-alert-rules"></a>Проверка общего числа правил генерации оповещений метрик

Чтобы проверить текущее использование правил генерации оповещений метрик, выполните следующие действия.

### <a name="from-the-azure-portal"></a>На портале Azure

1. На экране **Оповещения** щелкните **Управление правилами оповещения**.
2. Фильтрация к соответствующей подписке с помощью элемента управления "раскрывающийся список **подписок** "
3. НЕ следует выполнять фильтрацию по определенной группе ресурсов, типу ресурса или ресурсу.
4. В раскрывающемся элементе управления " **Тип сигнала** " выберите **метрики** .
5. Убедитесь, что для элемента управления "раскрывающийся список **состояния** " задано значение **включено** .
6. Общее число правил генерации оповещений метрики, отображаемых над списком правил

### <a name="from-api"></a>Из API

- PowerShell: используйте [Get-AzMetricAlertRuleV2](https://docs.microsoft.com/powershell/module/az.monitor/get-azmetricalertrulev2?view=azps-3.7.0).
- REST API: [выведите список по подписке](https://docs.microsoft.com/rest/api/monitor/metricalerts/listbysubscription).
- Azure CLI: используйте [az monitor metrics alert list](https://docs.microsoft.com/cli/azure/monitor/metrics/alert?view=azure-cli-latest#az-monitor-metrics-alert-list).

## <a name="managing-alert-rules-using-resource-manager-templates-rest-api-powershell-or-azure-cli"></a>Управление правилами генерации оповещений с помощью диспетчер ресурсов шаблонов, REST API, PowerShell или Azure CLI

При возникновении проблем с созданием, обновлением, извлечением или удалением оповещений метрик с помощью шаблонов диспетчер ресурсов, REST API, PowerShell или интерфейса командной строки Azure (CLI), приведенные ниже действия могут помочь устранить проблему.

### <a name="resource-manager-templates"></a>Шаблоны Resource Manager

- Просмотрите список [распространенных ошибок развертывания в Azure](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-common-deployment-errors) и примите соответствующие меры.
- Сведения о том, как правильно передаются все параметры, см. в статье [оповещения о метриках Azure Resource Manager примеры шаблонов](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-create-templates) .

### <a name="rest-api"></a>REST API

Ознакомьтесь с [руководством по REST API](https://docs.microsoft.com/rest/api/monitor/metricalerts/) и убедитесь, что все параметры передаются правильно.

### <a name="powershell"></a>PowerShell

Убедитесь, что вы используете правильные командлеты PowerShell для оповещений метрик:

- Командлеты PowerShell для оповещений метрик доступны в модуле [Az.Monitor](https://docs.microsoft.com/powershell/module/az.monitor/?view=azps-3.6.1)
- Обязательно используйте командлеты, которые заканчиваются на "v2", для новых (не классической) оповещений метрик (например, [Add-AzMetricAlertRuleV2](https://docs.microsoft.com/powershell/module/az.monitor/Add-AzMetricAlertRuleV2?view=azps-3.6.1)).

### <a name="azure-cli"></a>Azure CLI

Убедитесь, что для оповещений метрик используются правильные команды интерфейса командной строки:

- Команды интерфейса командной строки для оповещений метрик начинаются с `az monitor metrics alert`. Ознакомьтесь со [справочником по Azure CLI](https://docs.microsoft.com/cli/azure/monitor/metrics/alert?view=azure-cli-latest), в котором описывается синтаксис.
- Ознакомьтесь с [примером, в котором показано, как использовать CLI для оповещений метрик](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric#with-azure-cli).
- Чтобы создать оповещение для пользовательской метрики, обязательно добавьте к имени метрики соответствующее пространство имен метрики: NAMESPACE.METRIC

### <a name="general"></a>Общие сведения

- Если возникла ошибка `Metric not found`, сделайте следующее.

   - Для метрики платформы: Убедитесь, что вы используете имя **метрики** на [странице Azure Monitor поддерживаемые метрики](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported), а не **Отображаемое имя метрики** .

   - Для пользовательской метрики убедитесь, что метрика уже выдается (вы не можете создать правило генерации оповещений для пользовательской метрики, которая еще не существует) и что вы предоставляете пространство имен пользовательской метрики (см. Пример шаблона ARM [здесь](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-create-templates#template-for-a-static-threshold-metric-alert-that-monitors-a-custom-metric)).

- Если вы создаете [оповещения метрик для журналов](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-logs), убедитесь, что включены соответствующие зависимости. Ознакомьтесь с [примером шаблона](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-logs#resource-template-for-metric-alerts-for-logs).

- При создании правила генерации оповещений, которое содержит несколько условий, обратите внимание на следующие ограничения.

   - В каждом из критериев можно выбрать только одно значение для каждого измерения.
   - Невозможно использовать "\*" в качестве значения измерения.
   - Если метрики, настроенные в разных критериях, поддерживают одно и то же измерение, настроенное значение измерения должно быть явно задано одинаково для всех этих метрик (см. Пример шаблона [Диспетчер ресурсов).](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-metric-create-templates#template-for-a-static-threshold-metric-alert-that-monitors-multiple-criteria)


## <a name="no-permissions-to-create-metric-alert-rules"></a>Нет разрешений на создание правил генерации оповещений метрики

Чтобы создать правило генерации оповещений метрики, необходимы следующие разрешения.

- Разрешение на чтение в целевом ресурсе правила генерации оповещений
- Разрешение на запись в группу ресурсов, в которой создано правило генерации оповещений (если правило генерации оповещений создается на основе портал Azure, правило генерации оповещений создается в той же группе ресурсов, в которой находится целевой ресурс).
- Разрешение на чтение для любой группы действий, связанной с правилом генерации оповещений (если применимо)


## <a name="naming-restrictions-for-metric-alert-rules"></a>Ограничения именования для правил генерации оповещений метрик

Обратите внимание на следующие ограничения для имен правил оповещения о метриках:

- Имена правил генерации оповещений метрик не могут быть изменены (переименованы) после создания
- Имена правил генерации оповещений метрик должны быть уникальными в пределах группы ресурсов
- Имена правил генерации оповещений метрик не могут содержать следующие символы: * # & +:  < > ? @ % { } \ / 
- Имена правил генерации оповещений метрик не могут заканчиваться следующим символом:.


## <a name="restrictions-when-using-dimensions-in-a-metric-alert-rule-with-multiple-conditions"></a>Ограничения при использовании измерений в правиле генерации оповещений метрик с несколькими условиями

Оповещения метрик поддерживают создание оповещений многомерных метрик, а также поддержку определения нескольких условий (до 5 условий для каждого правила генерации оповещений).

Обратите внимание на следующие ограничения при использовании измерений в правиле генерации оповещений, которые содержат несколько условий.
1. В каждом условии можно выбрать только одно значение для каждого измерения.
2. Параметр "выбрать все текущие и будущие значения" нельзя использовать (Select \* ).
3. Если метрики, настроенные в различных условиях, поддерживают одно и то же измерение, то настроенное значение измерения должно быть явно задано одинаково для всех этих метрик (в соответствующих условиях).
Пример:
    - Рассмотрим правило генерации оповещений метрик, которое определено в учетной записи хранения и отслеживает два условия:
        * Всего **транзакций** > 5
        * Среднее **SuccessE2ELatency** > 250 мс
    - Я хотел бы обновить первое условие и наблюдать только за транзакциями, в которых измерение **ApiName** имеет значение *"BLOB"* .
    - Так как метрики **транзакций** и **SuccessE2ELatency** поддерживают измерение **ApiName** , мне нужно обновить оба условия, и оба они задают измерение **ApiName** со значением *"BLOB"* .


## <a name="next-steps"></a>Дальнейшие шаги

- Общие сведения об устранении неполадок с предупреждениями и уведомлениями см. [в разделе Устранение неполадок в Azure Monitor оповещениях](alerts-troubleshoot.md).
