---
title: Развертывание Azure Monitor
description: Развертывайте Azure Monitor функции в масштабе с помощью политики Azure.
ms.subservice: ''
ms.topic: conceptual
ms.date: 06/08/2020
ms.openlocfilehash: 4be403f8efc8e328548b6ef38b36be78a8fb96d7
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84678704"
---
# <a name="deploy-azure-monitor-at-scale-using-azure-policy"></a>Развертывание Azure Monitor в масштабе с помощью политики Azure
Хотя некоторые Azure Monitor компоненты настраиваются один раз или ограниченное число раз, другие необходимо повторить для каждого ресурса, который вы хотите отслеживать. В этой статье описываются методы использования политики Azure для реализации Azure Monitor в масштабе, чтобы обеспечить согласованную и точную настройку мониторинга для всех ресурсов Azure.

Например, необходимо создать параметр диагностики для всех имеющихся ресурсов Azure и для каждого создаваемого ресурса. Кроме того, необходимо установить агент и настроить его каждый раз при создании виртуальной машины. Для выполнения этих действий можно использовать такие методы, как PowerShell или CLI, так как эти методы доступны для всех функций Azure Monitor. С помощью политики Azure можно создать логику, которая будет автоматически выполнять соответствующую конфигурацию при каждом создании или изменении ресурса.


## <a name="azure-policy"></a>Политика Azure
В этом разделе приводится краткое введение в [политику Azure](../../governance/policy/overview.md) , которая позволяет оценивать и применять организационные стандарты во всей подписке Azure или группе управления с минимальными усилиями. Подробные сведения см. в [документации по политике Azure](../../governance/policy/overview.md) .

С помощью политики Azure можно указать требования к конфигурации для всех создаваемых ресурсов, а также определить ресурсы, которые не соответствуют требованиям, заблокировать создание ресурсов или добавить необходимую конфигурацию. Он работает путем перехвата вызовов для создания нового ресурса или изменения существующего ресурса. Он может реагировать на такие эффекты, как отклонить запрос, если он не соответствует свойствам, ожидаемым в определении политики, отмечать его для несоответствия или развертывать связанный ресурс. Существующие ресурсы можно исправить с помощью **deployIfNotExists** или **изменить** определение политики.

Политика Azure состоит из объектов, приведенных в следующей таблице. Более подробное описание каждого из них см. в разделе [объекты политики Azure](../../governance/policy/overview.md#azure-policy-objects) .

| Item | Описание: |
|:---|:---|
| Определение политики | Описывает условия соответствия ресурсов и результат выполнения условия при соблюдении условий. Это могут быть все ресурсы определенного типа или только ресурсы, соответствующие определенным свойствам. Этот результат может быть простым отметкой ресурса на соответствие или развертыванием связанного ресурса. Определения политик записываются с помощью JSON, как описано в разделе [структура определения политики Azure](../../governance/policy/concepts/definition-structure.md). Эффекты описаны в разделе [Общие сведения о влиянии политики Azure](../../governance/policy/concepts/effects.md).
| Инициатива политики | Группа определений политик, которые должны применяться вместе. Например, у вас может быть одно определение политики для отправки журналов ресурсов в Log Analytics рабочую область, а другой — для отправки журналов ресурсов в концентраторы событий. Создайте инициативу, включающую в себя оба определения политик, и примените эту инициативу к ресурсам, а не к отдельным определениям политик. Инициативы написаны с помощью JSON, как описано в разделе [Структура инициативы политики Azure](../../governance/policy/concepts/initiative-definition-structure.md). |
| Назначение | Определение политики или инициатива не вступают в силу, пока она не будет назначена области. Например, назначьте политику группе ресурсов, чтобы применить ее ко всем ресурсам, созданным в этом ресурсе, или примените ее к подписке, чтобы применить ее ко всем ресурсам в этой подписке.  Дополнительные сведения см. в разделе [Структура назначения политики Azure](../../governance/policy/concepts/assignment-structure.md). |

## <a name="built-in-policy-definitions-for-azure-monitor"></a>Встроенные определения политик для Azure Monitor
Политика Azure включает несколько предварительно созданных определений, связанных с Azure Monitor. Вы можете назначить эти определения политик существующей подписке или использовать их в качестве базиса для создания собственных пользовательских определений. Полный список встроенных политики в категории **мониторинга** см. в статье [определения встроенных политик политики Azure для Azure Monitor](../policy-samples.md).

Чтобы просмотреть встроенные определения политик, связанные с мониторингом, выполните следующие действия.

1. Перейдите к **политике Azure** в портал Azure.
2. Выберите **определения**.
3. В качестве **типа**выберите *встроенный* и для **категории**выберите *мониторинг*.

  ![Встроенные определения политик](media/deploy-scale/builtin-policies.png)


## <a name="diagnostic-settings"></a>Параметры диагностики
[Параметры диагностики](../platform/diagnostic-settings.md) собираются журналы ресурсов и метрики из ресурсов Azure в несколько расположений, обычно в log Analytics рабочей области, которая позволяет анализировать данные с помощью [запросов журнала](../log-query/log-query-overview.md) и [оповещений журнала](alerts-log.md). Используйте политику для автоматического создания параметров диагностики при каждом создании ресурса.

Каждый тип ресурсов Azure имеет уникальный набор категорий, которые должны быть перечислены в параметре диагностики. Поэтому для каждого типа ресурсов требуется отдельное определение политики. Некоторые типы ресурсов имеют встроенные определения политик, которые можно назначить без изменения. Для других типов ресурсов необходимо создать пользовательское определение.

### <a name="built-in-policy-definitions-for-azure-monitor"></a>Встроенные определения политик для Azure Monitor
Для каждого типа ресурса существует два встроенных определения политик: один для отправки в Log Analytics рабочую область, а другой — в концентратор событий. Если требуется только одно расположение, назначьте эту политику для типа ресурса. Если требуется, назначьте оба определения политики для ресурса.

Например, на следующем рисунке показаны встроенные определения политик параметров диагностики для Data Lake Analytics.

  ![Встроенные определения политик](media/deploy-scale/builtin-diagnostic-settings.png)

### <a name="custom-policy-definitions"></a>Определения настраиваемых политик
Для типов ресурсов, у которых нет встроенной политики, необходимо создать определение настраиваемой политики. Это можно сделать вручную в портал Azure путем копирования существующей встроенной политики и последующего изменения типа ресурса. Однако эффективнее создавать политику с помощью скрипта в коллекция PowerShell.

Сценарий [CREATE-аздиагполици](https://www.powershellgallery.com/packages/Create-AzDiagPolicy) создает файлы политики для определенного типа ресурсов, которые можно установить с помощью POWERSHELL или CLI. Используйте следующую процедуру, чтобы создать определение настраиваемой политики для параметров диагностики.


1. Убедитесь, что установлен [Azure PowerShell](https://docs.microsoft.com/powershell/azure/install-az-ps) .
2. Установите скрипт с помощью следующей команды:
  
    ```azurepowershell
    Install-Script -Name Create-AzDiagPolicy
    ```

3. Запустите скрипт, используя параметры, чтобы указать, куда отправить журналы. Вам будет предложено указать подписку и тип ресурса. Например, чтобы создать определение политики, которое отправляется в Log Analytics рабочую область и концентратор событий, используйте следующую команду.

   ```azurepowershell
   Create-AzDiagPolicy.ps1 -ExportLA -ExportEH -ExportDir ".\PolicyFiles"  
   ```

4. Кроме того, в команде можно указать подписку и тип ресурса. Например, чтобы создать определение политики, которое отправляет в Log Analytics рабочую область и концентратор событий для SQL Server баз данных Azure, используйте следующую команду.

   ```azurepowershell
   Create-AzDiagPolicy.ps1 -SubscriptionID xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx -ResourceType Microsoft.Sql/servers/databases  -ExportLA -ExportEH -ExportDir ".\PolicyFiles"  
   ```

5. Скрипт создает отдельные папки для каждого определения политики, каждый из которых содержит три файла с именами азуреполици, JSON, azurepolicy.rules.jsв azurepolicy.parameters.js. Если вы хотите создать политику вручную в портал Azure, можно скопировать и вставить содержимое azurepolicy.js, так как оно включает в себя полное определение политики. Используйте два других файла с PowerShell или CLI, чтобы создать определение политики из командной строки.

    В следующих примерах показано, как установить определение политики из PowerShell и CLI. Каждый включает метаданные, чтобы указать категорию **мониторинга** для группировки нового определения политики с помощью встроенных определений политик.

      ```azurepowershell
      New-AzPolicyDefinition -name "Deploy Diagnostic Settings for SQL Server database to Log Analytics workspace" -policy .\Apply-Diag-Settings-LA-Microsoft.Sql-servers-databases\azurepolicy.rules.json -parameter .\Apply-Diag-Settings-LA-Microsoft.Sql-servers-databases\azurepolicy.parameters.json -mode All -Metadata '{"category":"Monitoring"}'
      ```

      ```azurecli
      az policy definition create --name 'deploy-diag-setting-sql-database--workspace' --display-name 'Deploy Diagnostic Settings for SQL Server database to Log Analytics workspace'  --rules 'Apply-Diag-Settings-LA-Microsoft.Sql-servers-databases\azurepolicy.rules.json' --params 'Apply-Diag-Settings-LA-Microsoft.Sql-servers-databases\azurepolicy.parameters.json' --subscription 'AzureMonitor_Docs' --mode All
      ```

### <a name="initiative"></a>Инициатива
Чтобы не создавать назначение для каждого определения политики, распространенной стратегией является создание инициативы, включающей определения политик для создания параметров диагностики для каждой службы Azure. Создайте назначение между инициативой и группой управления, подпиской или группой ресурсов в зависимости от того, как вы управляете средой. Эта стратегия обеспечивает следующие преимущества:

- Создайте одно назначение для инициативы вместо нескольких назначений для каждого типа ресурса. Используйте одну и ту же инициативу для нескольких групп мониторинга, подписок или групп ресурсов.
- Измените инициативу, когда необходимо добавить новый тип ресурса или назначение. Например, начальным требованием может быть отправка данных только в Log Analytics рабочую область, но позже необходимо добавить концентратор событий. Измените инициативу, а не создавайте новые назначения.

Сведения о создании инициативы см. в статье [Создание и назначение определения инициативы](../../governance/policy/tutorials/create-and-manage.md#create-and-assign-an-initiative-definition) . Предлагаются следующие рекомендации.

- Задайте **категорию** **мониторинга** , чтобы сгруппировать ее со связанными встроенными и пользовательскими определениями политик.
- Вместо указания сведений для рабочей области Log Analytics и концентратора событий для определения политики, входящей в состав инициативы, используйте общий параметр инициативы. Это позволяет легко указать общее значение для всех определений политик и при необходимости изменить это значение.

![Определение инициативы](media/deploy-scale/initiative-definition.png)

### <a name="assignment"></a>Назначение 
Назначьте инициативу группе управления Azure, подписке или группе ресурсов в зависимости от области наблюдаемых ресурсов. [Группа управления](../../governance/management-groups/overview.md) особенно полезна для политики области, особенно если ваша организация имеет несколько подписок.

![Присвоение инициативы](media/deploy-scale/initiative-assignment.png)

С помощью параметров инициативы можно указать рабочую область или любые другие сведения один раз для всех определений политик в инициативе. 

![Параметры инициативы](media/deploy-scale/initiative-parameters.png)

### <a name="remediation"></a>Исправление
Инициатива будет применена к каждой виртуальной машине в процессе ее создания. [Задача исправления](../../governance/policy/how-to/remediate-resources.md) развертывает определения политик в рамках инициативы в отношении существующих ресурсов, поэтому позволяет создавать параметры диагностики для всех уже созданных ресурсов. При создании назначения с помощью портал Azure имеется возможность одновременного создания задачи исправления. Дополнительные сведения об исправлении см. в статье исправление [несоответствующих ресурсов с помощью политики Azure](../../governance/policy/how-to/remediate-resources.md) .

![Исправление инициатив](media/deploy-scale/initiative-remediation.png)


## <a name="azure-monitor-for-vms"></a>Azure Monitor для виртуальных машин
[Azure Monitor для виртуальных машин](../insights/vminsights-overview.md) является основным средством Azure Monitor для наблюдения за виртуальными машинами. При включении Azure Monitor для виртуальных машин устанавливаются агент Log Analytics и агент зависимостей. Вместо выполнения этих задач вручную используйте политику Azure, чтобы обеспечить настройку каждой виртуальной машины при ее создании.

Azure Monitor для виртуальных машин включает два встроенных инициативы с именем **Enable Azure Monitor для виртуальных машин** и **Enable Azure Monitor для масштабируемых наборов виртуальных машин**. Эти инициативы включают набор определений политик, необходимых для установки агента Log Analytics и агента зависимостей, необходимого для включения Azure Monitor для виртуальных машин. 

Вместо создания назначений для этих инициатив с помощью интерфейса политики Azure Azure Monitor для виртуальных машин включает функцию, позволяющую проверять количество виртуальных машин в каждой области, чтобы определить, применена ли инициатива. Затем можно настроить рабочую область и создать все необходимые назначения с помощью этого интерфейса.

Дополнительные сведения об этом процессе см. в статье [включение Azure Monitor для виртуальных машин с помощью политики Azure](../insights/vminsights-enable-at-scale-policy.md).

![Политика Azure Monitor для виртуальных машин](../platform/media/deploy-scale/vminsights-policy.png)


## <a name="next-steps"></a>Дальнейшие шаги

- Узнайте больше о [политике Azure](../../governance/policy/overview.md).
- Узнайте больше о [параметрах диагностики](diagnostic-settings.md).
