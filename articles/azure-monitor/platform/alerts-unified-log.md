---
title: Оповещения журнала в Azure Monitor
description: Узнайте, как активировать сообщения электронной почты и уведомления, вызывать URL-адреса веб-сайтов (использовать веб-перехватчики) или автоматизировать операции при выполнении заданных вами условий запросов аналитики в интерфейсе оповещений Azure.
author: yanivlavi
services: monitoring
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 5/31/2019
ms.author: yalavi
ms.subservice: alerts
ms.openlocfilehash: d0314e94e627a42ab55f9e91017acac0cdc8b541
ms.sourcegitcommit: be344deef6b37661e2c496f75a6cf14f805d7381
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/07/2019
ms.locfileid: "72001624"
---
# <a name="log-alerts-in-azure-monitor"></a>Оповещения журнала в Azure Monitor

В этой статье рассматриваются оповещения журнала. Это один из типов оповещений, которые поддерживаются в системе [оповещений Azure](../../azure-monitor/platform/alerts-overview.md) и позволяют пользователям применять платформу аналитики Azure в качестве основы для оповещений.

Оповещение журнала состоит из правил поиска по журналам, созданных для [Azure Monitor Logs](../../azure-monitor/learn/tutorial-viewdata.md) или [Application Insights](../../azure-monitor/app/cloudservices.md#view-azure-diagnostics-events). Дополнительные сведения о его использовании см. в сведениях о [создании оповещений журнала в Azure](../../azure-monitor/platform/alerts-log.md).

> [!NOTE]
> Часто используемые данные из [Azure Monitor Logs](../../azure-monitor/learn/tutorial-viewdata.md) теперь доступны на платформе метрик в Azure Monitor. Более подробную информацию см. в статье [Create Metric Alerts for Logs in Azure Monitor](../../azure-monitor/platform/alerts-metric-logs.md) (Создание оповещений метрик для журналов в Azure Monitor).


## <a name="log-search-alert-rule---definition-and-types"></a>Правило генерации оповещений для поиска по журналам: определения и типы

Правила поиска по журналам создаются в интерфейсе оповещений Azure, чтобы указанные запросы к журналу автоматически выполнялись с регулярными интервалами.  Если результаты запроса к журналу отвечают определенным условиям, создается запись оповещения. Затем правило может автоматически выполнять одно или несколько действий с помощью [групп действий](../../azure-monitor/platform/action-groups.md). Для создания, изменения и обновления оповещений журнала может понадобиться наличие роли [участника мониторинга Azure](../../azure-monitor/platform/roles-permissions-security.md) наряду с правами доступа и выполнения запросов для целевых показателей аналитики в правилах генерации оповещений или запросах оповещений. Если у создаваемого пользователя нет доступа ко всем целевым службам аналитики в правиле генерации оповещений или предупреждении, то создание правила может завершиться ошибкой или правило генерации оповещений журнала будет выполняться с частичными результатами.

Правила поиска по журналам определяются следующими сведениями:

- **Запрос к журналу.**  Это запрос, который будет запускаться каждый раз при срабатывании правила генерации оповещений.  Определить, следует ли активировать оповещение, можно с помощью записей, возвращаемых этим запросом. Запрос аналитики можно выполнять для конкретной рабочей области Log Analytics или приложения Application Insights, или даже для [нескольких ресурсов Log Analytics и Application Insights](../../azure-monitor/log-query/cross-workspace-query.md#querying-across-log-analytics-workspaces-and-from-application-insights) при условии, что у пользователя есть права на доступ и выполнение запроса для всех этих ресурсов. 
    > [!IMPORTANT]
    > поддержка [запросов между ресурсами](../../azure-monitor/log-query/cross-workspace-query.md#querying-across-log-analytics-workspaces-and-from-application-insights) в оповещениях журнала для Application Insights и оповещения журналов для [log Analytics, настроенных с помощью API счедуледкуерирулес](../../azure-monitor/platform/alerts-log-api-switch.md) .

    Некоторые аналитические команды и сочетания не подходят для использования в оповещениях журнала. Дополнительные сведения см. в статье [Запросы оповещений журналов в Azure Monitor](../../azure-monitor/platform/alerts-log-query.md).

- **Период.**  Указывает диапазон времени для запроса. Запрос возвращает только те записи, которые были созданы в течение этого периода, предшествующего настоящему времени. Период ограничивает данные, полученные при запросе журнала, чтобы предотвратить нарушения, и обходит любую команду времени (например, ago), используемую в запросе журнала. <br>*Например, если период времени равен 60 минутам, а запрос выполняется в 1:15 РМ, то для выполнения запроса журнала возвращается только запись, созданная между 12:15 PM и 1:15 PM. Теперь, если в запросе журнала используется команда time, например назад (7D), запрос журнала будет выполняться только для данных между 12:15 и 1:15 PM, как если бы данные существовали только за последние 60 минут. И не в течение семи дней, как указано в запросе журнала.*

- **Частота**.  Указывает, как часто должен выполняться запрос. Это значение может составлять от 5 минут до 24 часов. Оно не должно превышать указанный период.  Если значение больше, чем указанный период, записи могут быть пропущены.<br>*Например, рассмотрим период времени 30 минут и частоту в 60 минут.  Если запрос выполняется в 1:00, он возвращает записи между 12:30 и 1:00 PM.  В следующий раз при выполнении запроса будет 2:00, когда он возвратит записи между 1:30 и 2:00.  Любые записи, созданные между 1:00 и 1:30, никогда не будут оцениваться.*

- **Пороговое значение**.  Чтобы определить, следует ли создавать оповещение, оцениваются результаты поиска по журналам.  Для каждого типа правил генерации оповещений для поиска по журналам определяется собственное пороговое значение.

Для [Azure Monitor Logs](../../azure-monitor/learn/tutorial-viewdata.md) и для [Application Insights](../../azure-monitor/app/cloudservices.md#view-azure-diagnostics-events) используются правила поиска по журналам двух типов. Каждый из этих типов подробно описан в последующих разделах.

- **[Число результатов](#number-of-results-alert-rules)** . Если число записей, возвращенных в результатах поиска по журналам, превышает указанное количество, создается оповещение.
- **[Измерение метрик](#metric-measurement-alert-rules)** .  Оповещение, созданное для каждого объекта в результатах поиска по журналам со значением, превышающим указанное пороговое значение.

Ниже приведены различия между типами правил генерации оповещений.

- Правило генерации оповещений *Число результатов* всегда создает одно оповещение, а правило *Измерение метрик* — по одному для каждого объекта, который превышает порог.
- Правило генерации оповещений *Число результатов* создает оповещение при одноразовом превышении порогового значения. Правило генерации оповещений *Измерение метрик* может создавать оповещение при превышении порогового значения определенное количество раз за указанный интервал времени.

### <a name="number-of-results-alert-rules"></a>Number of results alert rules (Количество результатов для правила генерации оповещений)

Правила генерации оповещений **Число результатов** создают одно оповещение, если количество записей, возвращенных в результатах поискового запроса, превышает указанное пороговое значение. Этот тип правила генерации оповещений идеально подходит для работы с такими событиями, как журналы событий Windows, системный журнал, ответ веб-приложения и настраиваемые журналы.  Возможно, вам потребуется создать оповещение, когда создается конкретное событие ошибки или при создании нескольких событий ошибки в течение определенного периода.

**Порог.** Порог для правил генерации оповещений "Число результатов" больше или меньше определенного значения.  Если число записей, возвращенных в результатах поиска по журналам, соответствует этому критерию, создается оповещение.

Для оповещения об отдельном событии задайте количество результатов больше 0 и проверяйте наличие одного события, созданного с момента последнего выполнения запроса. Некоторые приложения могут вносить в журнал нерегулярную ошибку, которая не обязательно должна вызывать оповещение.  Например, приложение может повторно запустить процесс, который создал событие ошибки и затем успешно завершил работу при следующем выполнении.  В этом случае, возможно, вам потребуется создавать оповещение только в случае возникновения нескольких событий за определенный период.  

В некоторых случаях может потребоваться создать оповещение в случае отсутствия события.  Например, процесс может регистрировать регулярные события, чтобы указать, что он работает правильно.  Если он не регистрирует одно из таких событий в пределах определенного периода, следует создать оповещение.  В этом случае задайте для порога значение **меньше 1**.

#### <a name="example-of-number-of-records-type-log-alert"></a>Пример оповещения журнала типа "Количество записей"

Рассмотрим сценарий, где нужно узнать, когда веб-приложение предоставит пользователям ответ с кодом 500 ("Внутренняя ошибка сервера"). Необходимо создать правило генерации оповещений со следующими сведениями:  

- **Запрос:** запросы | где resultCode == 500.<br>
- **Период:** 30 минут.<br>
- **Частота предупреждений:** 5 минут.<br>
- **Пороговое значение:** больше 0.<br>

После этого оповещение будет выполнять запрос каждые 5 минут с 30 минутами данных для поиска записей с кодом результата 500. Если будет найдена хотя бы одна такая запись, сработает оповещение и запустится настроенное действие.

### <a name="metric-measurement-alert-rules"></a>Правило генерации оповещений "Измерение метрик"

Правила генерации оповещений **измерения метрик** создают предупреждение для каждого объекта в запросе со значением, которое превышает заданное пороговое значение и заданное условие триггера. В отличие от правил генерации оповещений о **количестве результатов** , правила оповещения **измерения метрик** работают, когда результат аналитики предоставляет временные ряды. Ниже приведены их четко выраженные отличия от правил генерации оповещений **Число результатов**.

- **Агрегатная функция.** Определяет выполняемые вычисления и (необязательно) числовое поле для статистических вычислений.  Например, **count()** возвращает число записей в запросе, а **avg(CounterValue)** — среднее значение поля CounterValue в рамках указанного интервала. Агрегатная функция в запросе должна называться AggregatedValue. Она указывает числовое значение. 

- **Поле группы.** Для каждого экземпляра этого поля будет создана запись с агрегированным значением; для каждого поля можно создать оповещение.  Например, если вы хотите создать оповещение для каждого компьютера, используйте группировку **по компьютерам**. Если в запросе оповещения содержится несколько полей группировки, пользователь может указать, какое поле будет использоваться для сортировки результатов, с помощью параметра **Агрегация по** (metricColumn).

    > [!NOTE]
    > Параметр *Агрегация по* (metricColumn) доступен только для оповещений журналов типа "Измерение метрик" для Application Insights и оповещений журналов для [Log Analytics, настроенных с помощью API scheduledQueryRules](../../azure-monitor/platform/alerts-log-api-switch.md).

- **Интервал.** Определяет период, в течение которого выполняется статистическое вычисление данных.  Например, если вы указали значение **5 минут**, создается запись для каждого экземпляра поля группы, вычисленного с интервалом в 5 минут за период, указанный для оповещения.

    > [!NOTE]
    > В запросе для указания интервала необходимо использовать функцию Bin. Так как при использовании bin() можно получить неравные интервалы времени, интерфейс оповещений будет автоматически преобразовывать команду bin в команду bin_at с соответствующим временем выполнения, чтобы гарантировать получение результатов с фиксированной запятой. Тип оповещения журнала "Измерение метрик" предназначен для работы с запросами, имеющими до трех команд bin().
    
- **Порог.** Порог для правил генерации оповещений "Измерение метрик" определяется на основе объединенного значения и числа нарушений.  Если любая точка данных в результатах поиска по журналам превышает это значение, она рассматривается как нарушение.  Когда число нарушений в результатах для любого объекта превышает указанное значение, для этого объекта создается оповещение.

Неправильная настройка параметра *Агрегация по* или *metricColumn* может привести к сбою правила генерации оповещений. Дополнительные сведения см. в разделе, посвященном [устранению неполадок в случае неправильной работы правила генерации оповещений типа "Измерение метрик"](alert-log-troubleshoot.md#metric-measurement-alert-rule-is-incorrect).

#### <a name="example-of-metric-measurement-type-log-alert"></a>Пример оповещения журнала типа "Измерение метрик"

Рассмотрим ситуацию, где оповещение должно создаваться, когда использование процессора на компьютере превышает 90 % три раза в течение 30 минут.  Необходимо создать правило генерации оповещений со следующими сведениями:  

- **Запрос:** Perf | where ObjectName == "Processor" and CounterName == "% Processor Time" | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 5m), Computer<br>
- **Период:** 30 минут.<br>
- **Частота предупреждений:** 5 минут.<br>
- **Логика оповещения — условие & пороговое значение:** Больше 90<br>
- **Поле группы (Aggregate-on):** Компьютерами
- **Активировать оповещение на основе:** общее число нарушений, превышающее 2.<br>

Запрос вернет среднее значение для каждого компьютера с интервалом в 5 минут.  Этот запрос выполняется каждые 5 минут для данных, собранных в течение предыдущих 30 минут. Так как в "Группировка по полю (агрегация по)" выбрано группировку по столбцу "Компьютер", значение AggregatedValue разделено для различных значений "Компьютер" и среднее использование процессора для каждого компьютера определено временем ячейки в 5 минут.  Примерный результат запроса для трех компьютеров будет выглядеть следующим образом.


|TimeGenerated [UTC] |Компьютер  |AggregatedValue  |
|---------|---------|---------|
|20xx-xx-xxT01:00:00Z     |   Srv01.contoso.com      |    72     |
|20xx-xx-xxT01:00:00Z     |   SRV02.contoso.com      |    91     |
|20xx-xx-xxT01:00:00Z     |   srv03.contoso.com      |    83     |
|...     |   ...      |    ...     |
|20xx-xx-xxT01:30:00Z     |   Srv01.contoso.com      |    88     |
|20xx-xx-xxT01:30:00Z     |   SRV02.contoso.com      |    84     |
|20xx-xx-xxT01:30:00Z     |   srv03.contoso.com      |    92     |

Если результат запроса отобразиться на графике, он будет выглядеть следующим образом.

![Результаты выполнения примера запроса](media/alerts-unified-log/metrics-measurement-sample-graph.png)

В этом примере показан средний объем использования процессоров для каждого из трех компьютеров в ячейках 5 минут, вычисляемый в течение 5 минут. Пороговое значение 90 нарушено srv01 только один раз в ячейке 1:25. Для сравнения, srv02 превышает пороговое значение 90 в ячейках 1:10, 1:15 и 1:25; а srv03 превышает пороговое значение 90 в 1:10, 1:15, 1:20 и 1:30.
Поскольку оповещение настроено, чтобы активировать общую брешь в системе безопасности (более двух нарушений), только srv02 и srv03 соответствуют этому критерию. Поэтому отдельные предупреждения будут созданы для SRV02 и компьютера SRV03, так как они перестанут пороговое значение 90% в несколько временных ячеек.  Если для параметра использовать *триггер оповещений на основе:* параметр был настроен для *непрерывного нарушения* , то предупреждение будет инициировано **только** для компьютера SRV03, так как оно нарушило пороговое значение для трех последовательных временных интервалов от 1:10 до 1:20. Однако оно **не** будет срабатывать для srv02, так как он нарушил пороговое значение в ячейках времени с 1:10 до 1:15 последовательно два раза.

## <a name="log-search-alert-rule---firing-and-state"></a>Правило генерации оповещений в поиске по журналу — срабатывание и состояние

Правила оповещений поиска по журналам работают только с логикой, создаваемой в запросе. Система предупреждений не имеет другого контекста состояния системы, вашей цели или основной причины, подразумеваемой запросом. Таким образом, оповещения журнала называются без состояния. Условия оцениваются как «TRUE» или «FALSE» при каждом запуске.  Предупреждение будет срабатывать каждый раз, когда вычисление условия предупреждения будет иметь значение "TRUE", независимо от того, было оно запущено ранее.    

Давайте посмотрим на это поведение с помощью практического примера. Предположим, что у нас есть правило генерации оповещений журнала *contoso-log-Alert*, которое настроено, как показано в [примере, указанном для оповещения журнала типа "число результатов](#example-of-number-of-records-type-log-alert)". Условие представляет собой настраиваемый запрос оповещения, предназначенный для поиска кода результата 500 в журналах. Если в журналах найдено более 500 кодов результатов, то условие предупреждения будет иметь значение true. 

С каждым интервалом, указанным ниже, система оповещений Azure оценивает условие для *оповещения Contoso-log*.


| Время    | Число записей, возвращенных запросом поиска по журналам | Журнал условий евалутион | Результат 
| ------- | ----------| ----------| ------- 
| 1:05 РМ | 0 записей | 0 не > 0, поэтому FALSE |  Предупреждение не срабатывает. Действия не вызваны.
| 1:10 РМ | 2 записи | 2 > 0 — да  | Оповещение срабатывает и группы действий с именем. Состояние оповещения активно.
| 1:15 РМ | 5 записей | 5 > 0 — да  | Оповещение срабатывает и группы действий с именем. Состояние оповещения активно.
| 1:20 РМ | 0 записей | 0 не > 0, поэтому FALSE |  Предупреждение не срабатывает. Действия не вызваны. Состояние оповещения осталось активным.

В качестве примера используйте предыдущий вариант:

В 1:15. оповещения Azure не могут определить, сохраняются ли основные проблемы, обнаруженные в 1:10, и если записи являются новыми сбоями или повторяются старые сбои в 1:10PM. Запрос, предоставленный пользователем, может или не учитывать более ранние записи, и система не знает об этом. Система оповещений Azure создается с ошибками на стороне с осторожностью, а также запускает оповещение и связанные действия снова в 1:15 РМ. 

В 1:20 при обнаружении нулевых записей с кодом результата 500, оповещения Azure не могут быть уверены, что причина 500 кода результата в 1:10 PM и 1:15 теперь устранена. Он не знает, возникают ли ошибки 500 по тем же причинам. Таким образом, *оповещение Contoso-log* не меняется на " **разрешено** " на панели мониторинга оповещений Azure и/или не отправляются уведомления о том, что предупреждение разрешено. Только вы, кто понимает точное условие или причину для логики, внедренной в запрос аналитики, может [пометить предупреждение как закрытое](alerts-managing-alert-states.md) по мере необходимости.

## <a name="pricing-and-billing-of-log-alerts"></a>Цены и выставление счетов для оповещений журнала

Цены, применимые к оповещениям журнала, установлены на странице [цен Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/). В счетах Azure оповещения журнала представлены типом `microsoft.insights/scheduledqueryrules`. Кроме того:

- Для оповещений журнала Application Insights указываются точное имя оповещения, группа ресурсов и свойства оповещения.
- При создании оповещений журнала Log Analytics с помощью [API scheduledQueryRules](https://docs.microsoft.com/rest/api/monitor/scheduledqueryrules) для них указываются точное имя оповещения, а также группа ресурсов и свойства оповещения.

[Устаревший API Log Analytics](../../azure-monitor/platform/api-alerts.md) использует действия оповещения и расписания в составе сохраненных поисков Log Analytics, а не как полноценные [ресурсы Azure](../../azure-resource-manager/resource-group-overview.md). Поэтому для того, чтобы включить выставление счетов для прежних версий оповещений журнала, созданных для Log Analytics с помощью портала Azure **без** [перехода на новый интерфейс API](../../azure-monitor/platform/alerts-log-api-switch.md) или через [устаревший API Log Analytics](../../azure-monitor/platform/api-alerts.md), потребуется создать на странице `microsoft.insights/scheduledqueryrules` скрытые фиктивные правила генерации оповещений, которые будут отслеживаться для выставления счетов в Azure. Скрытые фиктивные правила генерации оповещений, созданные для выставления счетов на `microsoft.insights/scheduledqueryrules`, отображаются как `<WorkspaceName>|<savedSearchId>|<scheduleId>|<ActionId>` вместе с группой ресурсов и свойствами оповещения.

> [!NOTE]
> Если в имени есть недопустимые символы, такие как `<, >, %, &, \, ?, /`, для скрытого фиктивного правила генерации оповещений, а следовательно и в счетах Azure, они будут заменены символами `_`.

Чтобы удалить скрытые ресурсы scheduleQueryRules, созданные для выставления счетов за правила генерации оповещений, созданные в [устаревшем API Log Analytics](api-alerts.md), пользователь может выполнить любое из следующих действий:

- [Изменить используемый API для правил генерации оповещений в рабочей области Log Analytics](../../azure-monitor/platform/alerts-log-api-switch.md) и перейти на совместимый с Azure Resource Manager [API-интерфейс scheduledQueryRules](https://docs.microsoft.com/rest/api/monitor/scheduledqueryrules) без потери существующих правил генерации оповещений или мониторинга. Это действие позволит отказаться от скрытых фиктивных правил генерации оповещений, которые вы создавали для выставления счетов.
- Если нет желания переключать используемый API, следует **удалить** исходное расписание и действие оповещения через [устаревший API Log Analytics](api-alerts.md) или [удалить исходное правило генерации оповещений для журнала через портал Azure](../../azure-monitor/platform/alerts-log.md#view--manage-log-alerts-in-azure-portal).

Кроме того, для скрытых ресурсов Счедулекуерирулес, созданных для выставления счетов по правилам генерации оповещений с помощью [устаревшего log Analytics API](api-alerts.md), любые операции изменения, такие как операция вставки, завершатся ошибкой. Так как псевдо-правила типа `microsoft.insights/scheduledqueryrules` предназначены для выставления счетов по правилам генерации оповещений, созданным с помощью [устаревших log Analytics API](api-alerts.md). Все изменения правил генерации оповещений следует выполнять с помощью [устаревшего log Analytics API](api-alerts.md) (или) пользователь может [Переключить предпочтение API для правил генерации оповещений](../../azure-monitor/platform/alerts-log-api-switch.md) для использования [API счедуледкуерирулес](https://docs.microsoft.com/rest/api/monitor/scheduledqueryrules) .

## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения о [создании оповещений журнала в Azure](../../azure-monitor/platform/alerts-log.md).
* Информация о [веб-перехватчиках в оповещениях журналов в Azure](alerts-log-webhook.md).
* Сведения об [оповещениях Azure](../../azure-monitor/platform/alerts-overview.md).
* Дополнительные сведения об [Application Insights](../../azure-monitor/app/analytics.md).
* Дополнительные сведения о [Log Analytics](../../azure-monitor/log-query/log-query-overview.md).
