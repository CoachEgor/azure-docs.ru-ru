---
title: Оповещения журнала в Azure Monitor
description: Узнайте, как активировать сообщения электронной почты и уведомления, вызывать URL-адреса веб-сайтов (использовать веб-перехватчики) или автоматизировать операции при выполнении заданных вами условий запросов аналитики в интерфейсе оповещений Azure.
author: msvijayn
services: monitoring
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 5/31/2019
ms.author: vinagara
ms.subservice: alerts
ms.openlocfilehash: ae35c735cffeb8cd85af1f32bb2d14ede6dc6b69
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "66427411"
---
# <a name="log-alerts-in-azure-monitor"></a>Оповещения журнала в Azure Monitor

В этой статье рассматриваются оповещения журнала. Это один из типов оповещений, которые поддерживаются в системе [оповещений Azure](../../azure-monitor/platform/alerts-overview.md) и позволяют пользователям применять платформу аналитики Azure в качестве основы для оповещений.

Оповещение журнала состоит из правил поиска по журналам, созданных для [Azure Monitor Logs](../../azure-monitor/learn/tutorial-viewdata.md) или [Application Insights](../../azure-monitor/app/cloudservices.md#view-azure-diagnostics-events). Дополнительные сведения о его использовании см. в сведениях о [создании оповещений журнала в Azure](../../azure-monitor/platform/alerts-log.md).

> [!NOTE]
> Часто используемые данные из [Azure Monitor Logs](../../azure-monitor/learn/tutorial-viewdata.md) теперь доступны на платформе метрик в Azure Monitor. Более подробную информацию см. в статье [Create Metric Alerts for Logs in Azure Monitor](../../azure-monitor/platform/alerts-metric-logs.md) (Создание оповещений метрик для журналов в Azure Monitor).


## <a name="log-search-alert-rule---definition-and-types"></a>Правило генерации оповещений для поиска по журналам: определения и типы

Правила поиска по журналам создаются в интерфейсе оповещений Azure, чтобы указанные запросы к журналу автоматически выполнялись с регулярными интервалами.  Если результаты запроса к журналу отвечают определенным условиям, создается запись оповещения. Затем правило может автоматически выполнять одно или несколько действий с помощью [групп действий](../../azure-monitor/platform/action-groups.md). Для создания, изменения и обновления оповещений журнала может понадобиться наличие роли [участника мониторинга Azure](../../azure-monitor/platform/roles-permissions-security.md) наряду с правами доступа и выполнения запросов для целевых показателей аналитики в правилах генерации оповещений или запросах оповещений. В случае, если создание пользователя нет доступа к все целевые объекты аналитики в правило генерации оповещений или запроса на оповещение — Создание правила может завершиться ошибкой или правило генерации оповещений журнала будет выполняться с частичные результаты.

Правила поиска по журналам определяются следующими сведениями:

- **Запрос к журналу.**  Это запрос, который будет запускаться каждый раз при срабатывании правила генерации оповещений.  Определить, следует ли активировать оповещение, можно с помощью записей, возвращаемых этим запросом. Запрос аналитики можно выполнять для конкретной рабочей области Log Analytics или приложения Application Insights, или даже для [нескольких ресурсов Log Analytics и Application Insights](../../azure-monitor/log-query/cross-workspace-query.md#querying-across-log-analytics-workspaces-and-from-application-insights) при условии, что у пользователя есть права на доступ и выполнение запроса для всех этих ресурсов. 
    > [!IMPORTANT]
    > [запрос нескольких ресурсов](../../azure-monitor/log-query/cross-workspace-query.md#querying-across-log-analytics-workspaces-and-from-application-insights) поддержка в оповещения журнала для Application Insights и оповещения журналов для [Log Analytics, настроить с помощью scheduledQueryRules API](../../azure-monitor/platform/alerts-log-api-switch.md) только.

    Некоторые аналитические команды и сочетания не подходят для использования в оповещениях журнала. Дополнительные сведения см. в статье [Запросы оповещений журналов в Azure Monitor](../../azure-monitor/platform/alerts-log-query.md).

- **Период.**  Указывает диапазон времени для запроса. Запрос возвращает только те записи, которые были созданы в течение этого периода, предшествующего настоящему времени. Период ограничивает данные, полученные при запросе журнала, чтобы предотвратить нарушения, и обходит любую команду времени (например, ago), используемую в запросе журнала. <br>*Например, если задан период 60 минут, а запрос выполняется в 13:15, то для запроса журнала возвращаются только записи, созданные между 12:15 и 13:15. Если в запросе журнала будет использована команда времени, например ago (7d), запрос журнала будет выполняться только для данных между 12:15 и 13:15 — как если бы данные существовали только за последние 60 минут. Данные за семь дней, как указано в запросе журнала, не будут выводиться.*

- **Частота**.  Указывает, как часто должен выполняться запрос. Это значение может составлять от 5 минут до 24 часов. Оно не должно превышать указанный период.  Если значение больше, чем указанный период, записи могут быть пропущены.<br>*Например, рассмотрим период в 30 минут и частоту в 60 минут.  Если запрос выполняется в 13:00, он возвращает записи между 12:30 и 13:00.  В следующий раз этот запрос будет выполнен в 14:00, а записи возвратятся между 13:30 и 14:00.  Записи, созданные между 13:00 и 13:30, не будут учитываться.*

- **Пороговое значение**.  Чтобы определить, следует ли создавать оповещение, оцениваются результаты поиска по журналам.  Для каждого типа правил генерации оповещений для поиска по журналам определяется собственное пороговое значение.

Для [Azure Monitor Logs](../../azure-monitor/learn/tutorial-viewdata.md) и для [Application Insights](../../azure-monitor/app/cloudservices.md#view-azure-diagnostics-events) используются правила поиска по журналам двух типов. Каждый из этих типов подробно описан в последующих разделах.

- **[Число результатов](#number-of-results-alert-rules)** . Если число записей, возвращенных в результатах поиска по журналам, превышает указанное количество, создается оповещение.
- **[Измерение метрик](#metric-measurement-alert-rules)** .  Оповещение, созданное для каждого объекта в результатах поиска по журналам со значением, превышающим указанное пороговое значение.

Ниже приведены различия между типами правил генерации оповещений.

- Правило генерации оповещений *Число результатов* всегда создает одно оповещение, а правило *Измерение метрик* — по одному для каждого объекта, который превышает порог.
- Правило генерации оповещений *Число результатов* создает оповещение при одноразовом превышении порогового значения. Правило генерации оповещений *Измерение метрик* может создавать оповещение при превышении порогового значения определенное количество раз за указанный интервал времени.

### <a name="number-of-results-alert-rules"></a>Правило генерации оповещений "Число результатов"

Правила генерации оповещений **Число результатов** создают одно оповещение, если количество записей, возвращенных в результатах поискового запроса, превышает указанное пороговое значение. Этот тип правила генерации оповещений идеально подходит для работы с такими событиями, как журналы событий Windows, системный журнал, ответ веб-приложения и настраиваемые журналы.  Возможно, вам потребуется создать оповещение, когда создается конкретное событие ошибки или при создании нескольких событий ошибки в течение определенного периода.

**Пороговое значение.** Порог для правила генерации оповещений "Число результатов" больше или меньше определенного значения.  Если число записей, возвращенных в результатах поиска по журналам, соответствует этому критерию, создается оповещение.

Для оповещения об отдельном событии задайте количество результатов больше 0 и проверяйте наличие одного события, созданного с момента последнего выполнения запроса. Некоторые приложения могут вносить в журнал нерегулярную ошибку, которая не обязательно должна вызывать оповещение.  Например, приложение может повторно запустить процесс, который создал событие ошибки и затем успешно завершил работу при следующем выполнении.  В этом случае, возможно, вам потребуется создавать оповещение только в случае возникновения нескольких событий за определенный период.  

В некоторых случаях может потребоваться создать оповещение в случае отсутствия события.  Например, процесс может регистрировать регулярные события, чтобы указать, что он работает правильно.  Если он не регистрирует одно из таких событий в пределах определенного периода, следует создать оповещение.  В этом случае задайте для порога значение **меньше 1**.

#### <a name="example-of-number-of-records-type-log-alert"></a>Пример оповещения журнала типа "Количество записей"

Рассмотрим сценарий, где нужно узнать, когда веб-приложение предоставит пользователям ответ с кодом 500 ("Внутренняя ошибка сервера"). Необходимо создать правило генерации оповещений со следующими сведениями:  

- **Запрос:** запросы | где resultCode == 500.<br>
- **Период времени:** 30 минут<br>
- **Частота предупреждений:** 5 минут.<br>
- **Пороговое значение:** больше 0.<br>

После этого оповещение будет выполнять запрос каждые 5 минут с 30 минутами данных для поиска записей с кодом результата 500. Если будет найдена хотя бы одна такая запись, сработает оповещение и запустится настроенное действие.

### <a name="metric-measurement-alert-rules"></a>Metric measurement alert rules (Измерение метрики для правила генерации оповещений)

**Измерение метрик** правила генерации оповещений создать оповещение для каждого объекта в запросе со значением, которое превышает заданное пороговое значение и указанное условие триггера. В отличие от **количество результатов** правила, оповещения **измерение метрик** работают правила генерации оповещений в случае, если результат analytics предоставляет временных рядов. Ниже приведены их четко выраженные отличия от правил генерации оповещений **Число результатов**.

- **Агрегатная функция.** Указывает выполняемые вычисления и (необязательно) числовое поле для статистических вычислений.  Например, **count()** возвращает число записей в запросе, а **avg(CounterValue)** — среднее значение поля CounterValue в рамках указанного интервала. Агрегатная функция в запросе должна иметь имя: AggregatedValue и указывать числовое значение. 

- **Группировка по полю.** Для каждого экземпляра этого поля будет создана запись с агрегированным значением, и для каждого из них можно создать оповещение.  Например, если вы хотите создать оповещение для каждого компьютера, используйте группировку **по компьютерам**. Если в запросе оповещения содержится несколько полей группировки, пользователь может указать, какое поле будет использоваться для сортировки результатов, с помощью параметра **Агрегация по** (metricColumn).

    > [!NOTE]
    > Параметр *Агрегация по* (metricColumn) доступен только для оповещений журналов типа "Измерение метрик" для Application Insights и оповещений журналов для [Log Analytics, настроенных с помощью API scheduledQueryRules](../../azure-monitor/platform/alerts-log-api-switch.md).

- **Интервал.**  Определяет интервал времени, в течение которого выполняется статистическое вычисление данных.  Например, если вы указали значение **5 минут**, создается запись для каждого экземпляра поля группы, вычисленного с интервалом в 5 минут за период, указанный для оповещения.

    > [!NOTE]
    > В запросе для указания интервала необходимо использовать функцию Bin. Так как при использовании bin() можно получить неравные интервалы времени, интерфейс оповещений будет автоматически преобразовывать команду bin в команду bin_at с соответствующим временем выполнения, чтобы гарантировать получение результатов с фиксированной запятой. Тип оповещения журнала "Измерение метрик" предназначен для работы с запросами, имеющими до трех команд bin().
    
- **Пороговое значение.** Пороговое значение для правил генерации оповещений "Измерение метрик" определяется на основе статического значения и числа нарушений.  Если любая точка данных в результатах поиска по журналам превышает это значение, она рассматривается как нарушение.  Когда число нарушений в результатах для любого объекта превышает указанное значение, для этого объекта создается оповещение.

Неправильная настройка параметра *Агрегация по* или *metricColumn* может привести к сбою правила генерации оповещений. Дополнительные сведения см. в разделе, посвященном [устранению неполадок в случае неправильной работы правила генерации оповещений типа "Измерение метрик"](alert-log-troubleshoot.md#metric-measurement-alert-rule-is-incorrect).

#### <a name="example-of-metric-measurement-type-log-alert"></a>Пример оповещения журнала типа "Измерение метрик"

Рассмотрим ситуацию, где оповещение должно создаваться, когда использование процессора на компьютере превышает 90 % три раза в течение 30 минут.  Необходимо создать правило генерации оповещений со следующими сведениями:  

- **Запрос** Perf | where ObjectName == "Processor" and CounterName == "% Processor Time" | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 5m), Computer<br>
- **Период времени:** 30 минут<br>
- **Частота предупреждений:** 5 минут.<br>
- **Логика оповещений — условие и пороговое значение:** больше 90.<br>
- **Группировка по полю (агрегация по):** Computer
- **Активировать оповещение на основе:** общее число нарушений превышает 2.<br>

Запрос вернет среднее значение для каждого компьютера с интервалом в 5 минут.  Этот запрос выполняется каждые 5 минут для данных, собранных в течение предыдущих 30 минут. Так как в "Группировка по полю (агрегация по)" выбрано группировку по столбцу "Компьютер", значение AggregatedValue разделено для различных значений "Компьютер" и среднее использование процессора для каждого компьютера определено временем ячейки в 5 минут.  Примерный результат запроса для трех компьютеров будет выглядеть следующим образом.


|TimeGenerated [UTC] |Computer  |AggregatedValue  |
|---------|---------|---------|
|20xx-xx-xxT01:00:00Z     |   Srv01.contoso.com      |    72     |
|20xx-xx-xxT01:00:00Z     |   SRV02.contoso.com      |    91     |
|20xx-xx-xxT01:00:00Z     |   srv03.contoso.com      |    83     |
|...     |   ...      |    ...     |
|20xx-xx-xxT01:30:00Z     |   Srv01.contoso.com      |    88     |
|20xx-xx-xxT01:30:00Z     |   SRV02.contoso.com      |    84     |
|20xx-xx-xxT01:30:00Z     |   srv03.contoso.com      |    92     |

Если результат запроса отобразиться на графике, он будет выглядеть следующим образом.

![Результаты выполнения примера запроса](media/alerts-unified-log/metrics-measurement-sample-graph.png)

В этом примере показан средний объем использования процессоров для каждого из трех компьютеров в ячейках 5 минут, вычисляемый в течение 5 минут. Пороговое значение 90 нарушено srv01 только один раз в ячейке 1:25. Для сравнения, srv02 превышает пороговое значение 90 в ячейках 1:10, 1:15 и 1:25; а srv03 превышает пороговое значение 90 в 1:10, 1:15, 1:20 и 1:30.
Поскольку оповещение настроено, чтобы активировать общую брешь в системе безопасности (более двух нарушений), только srv02 и srv03 соответствуют этому критерию. Поэтому для srv02 и srv03 будут созданы отдельные оповещения, так как за указанный период они 2 раза нарушили пороговое значение в 90 %.  Если вместо параметра *Активировать оповещение на основе:* настроен параметр *Continuous breaches* (Последовательные бреши), то оповещение будет срабатывать **только** для srv03, так как именно для него нарушено пороговое значение в трех последовательных ячейках времени с 1:10 по 1:20. Однако оно **не** будет срабатывать для srv02, так как он нарушил пороговое значение в ячейках времени с 1:10 до 1:15 последовательно два раза.

## <a name="log-search-alert-rule---firing-and-state"></a>Правило генерации оповещений в поиске по журналу — срабатывание и состояние

Правило генерации оповещений в поиске по журналу работает по логике, заданной пользователем в соответствии с конфигурацией и используемым пользовательским запросом аналитики. С момента логику мониторинга включая точные условия или причина, почему правило генерации оповещений следует активировать инкапсулирован в запрос analytics - которое может отличаться в каждое правило генерации оповещений журнала. Оповещения Azure имеет ограниченные сведения о сценарии, вычисляемое при достигнуто или превышено пороговое значение условие правила генерации оповещений журнала поиска конкретных основной причины (или). Таким образом оповещений журнала, рассматриваются как состояние без участия. И будет поддерживать обработки правил генерации оповещений журнала, до тех пор, пока выполнены условия оповещения в результате выполнения пользовательском аналитическом запрос. Без оповещения каждые получение разрешения в соответствии маскировки логику точного основная причина сбоя мониторинга внутри запроса analytics, предоставленных пользователем. Что в настоящее время отсутствует механизм для оповещений Azure Monitor можно окончательно выявить основную причину решаемой задачи.

Позволит нам см. в разделе, то же самое с практического примера. Предположим, что имеется правило генерации оповещений журнала с именем *оповещения для журнала Contoso*, как и в случае каждой конфигурации в [пример для оповещений журнала типа номер из результатов](#example-of-number-of-records-type-log-alert) — где пользовательского запроса на оповещение предназначен для поиска 500 Код результата в журналах.

- В 13:05:00 выполнения Contoso-оповещения журнала в оповещениях Azure результатах поиска по журналам дали записей с кодом результата с 500. Так как ноль меньше порогового значения и предупреждения не запущено.
- В следующей итерации в 1:10 PM выполнения Contoso-оповещения журнала в оповещениях Azure результатов поиска в журнале предоставлены пять записей с кодом результата 500. Происходит после пяти превышает пороговое значение и предупреждения с соответствующими действиями.
- В 1:15 выполнения Contoso-оповещения журнала в оповещениях Azure результатов поиска в журнале предоставляются две записи с кодом результата 500. Происходит, так как два превышает пороговое значение и предупреждения с соответствующими действиями.
- Теперь в следующую итерацию в 1:20 PM выполнения Contoso-Log-оповещения Azure предупреждения, результатов поиска в журнале предоставляются снова записей с кодом результата 500. Так как ноль меньше порогового значения и предупреждения не запущено.

Но в случае перечисленных выше, в 13:15:00 - оповещений Azure не удается определить что сохраняться базовых проблем, возникающих в 1:10, и если нет net новые отказы. Оповещения Azure могут быть уверены, как запрос, предоставленный пользователем может принимать во внимание более ранние записи —. Так как логика для оповещения инкапсулируется в запроса на оповещение — таким образом две записи с кодом результата 500, появление 1:15 PM может или может быть еще не видел в 13:10. Поэтому осторожностью, допустить ошибку при выполнении Contoso-оповещения журнала в 13:15, настроенное действие запускается снова. Теперь в 1:20 PM при пустые записи, будут видны с кодом результата 500 - оповещений Azure нельзя быть уверенным, что теперь решается причину код 500 результата, появление 13:10:00 и 13:15 и оповещения Azure Monitor можно уверенно вывести 500 ошибок будет выполняться не по той же причине s снова. Таким образом оповещения для журнала Contoso будет не изменен на разрешено в панель мониторинга Azure предупреждения и отправки уведомлений о том, разрешить оповещение. Вместо этого пользователя, который понимает точные условия или причину логики, внедренных в запрос analytics, можно [пометьте оповещение как закрытые](alerts-managing-alert-states.md) при необходимости.

## <a name="pricing-and-billing-of-log-alerts"></a>Цены и выставление счетов для оповещений журнала

Цены, применимые к оповещениям журнала, установлены на странице [цен Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/). В счетах Azure оповещения журнала представлены типом `microsoft.insights/scheduledqueryrules`. Кроме того:

- Для оповещений журнала Application Insights указываются точное имя оповещения, группа ресурсов и свойства оповещения.
- При создании оповещений журнала Log Analytics с помощью [API scheduledQueryRules](https://docs.microsoft.com/rest/api/monitor/scheduledqueryrules) для них указываются точное имя оповещения, а также группа ресурсов и свойства оповещения.

[Устаревший API Log Analytics](../../azure-monitor/platform/api-alerts.md) использует действия оповещения и расписания в составе сохраненных поисков Log Analytics, а не как полноценные [ресурсы Azure](../../azure-resource-manager/resource-group-overview.md). Поэтому для того, чтобы включить выставление счетов для прежних версий оповещений журнала, созданных для Log Analytics с помощью портала Azure **без** [перехода на новый интерфейс API](../../azure-monitor/platform/alerts-log-api-switch.md) или через [устаревший API Log Analytics](../../azure-monitor/platform/api-alerts.md), потребуется создать на странице `microsoft.insights/scheduledqueryrules` скрытые фиктивные правила генерации оповещений, которые будут отслеживаться для выставления счетов в Azure. Скрытые фиктивные правила генерации оповещений, созданные для выставления счетов на `microsoft.insights/scheduledqueryrules`, отображаются как `<WorkspaceName>|<savedSearchId>|<scheduleId>|<ActionId>` вместе с группой ресурсов и свойствами оповещения.

> [!NOTE]
> Если в имени есть недопустимые символы, такие как `<, >, %, &, \, ?, /`, для скрытого фиктивного правила генерации оповещений, а следовательно и в счетах Azure, они будут заменены символами `_`.

Чтобы удалить скрытые ресурсы scheduleQueryRules, созданные для выставления счетов за правила генерации оповещений, созданные в [устаревшем API Log Analytics](api-alerts.md), пользователь может выполнить любое из следующих действий:

- [Изменить используемый API для правил генерации оповещений в рабочей области Log Analytics](../../azure-monitor/platform/alerts-log-api-switch.md) и перейти на совместимый с Azure Resource Manager [API-интерфейс scheduledQueryRules](https://docs.microsoft.com/rest/api/monitor/scheduledqueryrules) без потери существующих правил генерации оповещений или мониторинга. Это действие позволит отказаться от скрытых фиктивных правил генерации оповещений, которые вы создавали для выставления счетов.
- Если нет желания переключать используемый API, следует **удалить** исходное расписание и действие оповещения через [устаревший API Log Analytics](api-alerts.md) или [удалить исходное правило генерации оповещений для журнала через портал Azure](../../azure-monitor/platform/alerts-log.md#view--manage-log-alerts-in-azure-portal).

Кроме того, для скрытых scheduleQueryRules ресурсы, созданные для выставления счетов с помощью правил генерации оповещений [устаревших API Log Analytics](api-alerts.md), любой операции изменения, например PUT не удастся. Как `microsoft.insights/scheduledqueryrules` тип псевдо правила предназначены для целей выставления счетов правила генерации оповещений, созданных с помощью [устаревших API Log Analytics](api-alerts.md). Допустимо любое изменение правила генерации оповещений с помощью [устаревших API Log Analytics](api-alerts.md) (или) пользователь может [переключения предпочтений API для правил генерации оповещений](../../azure-monitor/platform/alerts-log-api-switch.md) использовать [scheduledQueryRules API](https://docs.microsoft.com/rest/api/monitor/scheduledqueryrules) Вместо этого.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о [создании оповещений журнала в Azure](../../azure-monitor/platform/alerts-log.md).
* Информация о [веб-перехватчиках в оповещениях журналов в Azure](alerts-log-webhook.md).
* Сведения об [оповещениях Azure](../../azure-monitor/platform/alerts-overview.md).
* Дополнительные сведения об [Application Insights](../../azure-monitor/app/analytics.md).
* Дополнительные сведения о [Log Analytics](../../azure-monitor/log-query/log-query-overview.md).