---
title: Оповещения журнала в Azure Monitor
description: Узнайте, как активировать сообщения электронной почты и уведомления, вызывать URL-адреса веб-сайтов (использовать веб-перехватчики) или автоматизировать операции при выполнении заданных вами условий запросов аналитики в интерфейсе оповещений Azure.
author: msvijayn
services: monitoring
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 2/20/2019
ms.author: vinagara
ms.subservice: alerts
ms.openlocfilehash: 194fba3296359f5f7d29a37425a938fe08f1332b
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60345896"
---
# <a name="log-alerts-in-azure-monitor"></a>Оповещения журнала в Azure Monitor

В этой статье рассматриваются оповещения журнала. Это один из типов оповещений, которые поддерживаются в системе [оповещений Azure](../../azure-monitor/platform/alerts-overview.md) и позволяют пользователям применять платформу аналитики Azure в качестве основы для оповещений.

Оповещение журнала состоит из правил поиска по журналам, созданных для [Azure Monitor Logs](../../azure-monitor/learn/tutorial-viewdata.md) или [Application Insights](../../azure-monitor/app/cloudservices.md#view-azure-diagnostics-events). Дополнительные сведения о его использовании см. в сведениях о [создании оповещений журнала в Azure](../../azure-monitor/platform/alerts-log.md).

> [!NOTE]
> Часто используемые данные из [Azure Monitor Logs](../../azure-monitor/learn/tutorial-viewdata.md) теперь доступны на платформе метрик в Azure Monitor. Более подробную информацию см. в статье [Create Metric Alerts for Logs in Azure Monitor](../../azure-monitor/platform/alerts-metric-logs.md) (Создание оповещений метрик для журналов в Azure Monitor).


## <a name="log-search-alert-rule---definition-and-types"></a>Правило генерации оповещений для поиска по журналам: определения и типы

Правила поиска по журналам создаются в интерфейсе оповещений Azure, чтобы указанные запросы к журналу автоматически выполнялись с регулярными интервалами.  Если результаты запроса к журналу отвечают определенным условиям, создается запись оповещения. Затем правило может автоматически выполнять одно или несколько действий с помощью [групп действий](../../azure-monitor/platform/action-groups.md). Для создания, изменения и обновления оповещений журнала может понадобиться наличие роли [участника мониторинга Azure](../../azure-monitor/platform/roles-permissions-security.md) наряду с правами доступа и выполнения запросов для целевых показателей аналитики в правилах генерации оповещений или запросах оповещений. Если при создании у пользователя отсутствует доступ ко всем целевым показателям аналитики в правиле генерации оповещений или запросе оповещения, создание правила может завершиться сбоем или правило генерации оповещений журнала будет выполнено с частичными результатами.

Правила поиска по журналам определяются следующими сведениями:

- **Запрос к журналу.**  Это запрос, который будет запускаться каждый раз при срабатывании правила генерации оповещений.  Определить, следует ли активировать оповещение, можно с помощью записей, возвращаемых этим запросом. Запрос аналитики можно выполнять для конкретной рабочей области Log Analytics или приложения Application Insights, или даже для [нескольких ресурсов Log Analytics и Application Insights](../../azure-monitor/log-query/cross-workspace-query.md#querying-across-log-analytics-workspaces-and-from-application-insights) при условии, что у пользователя есть права на доступ и выполнение запроса для всех этих ресурсов. 
    > [!IMPORTANT]
    > В целях безопасности оповещение журнала **не** поддерживает использование [функций](../log-query/functions.md). Кроме того, поддержка [запросов по нескольким ресурсам](../../azure-monitor/log-query/cross-workspace-query.md#querying-across-log-analytics-workspaces-and-from-application-insights) в оповещениях журналов распространяется только на ресурсы Application Insights и [Log Analytics, настроенные через API scheduledQueryRules](../../azure-monitor/platform/alerts-log-api-switch.md).

    Некоторые аналитические команды и сочетания не подходят для использования в оповещениях журнала. Дополнительные сведения см. в статье [Запросы оповещений журналов в Azure Monitor](../../azure-monitor/platform/alerts-log-query.md).

- **Период.**  Указывает диапазон времени для запроса. Запрос возвращает только те записи, которые были созданы в течение этого периода, предшествующего настоящему времени. Период ограничивает данные, полученные при запросе журнала, чтобы предотвратить нарушения, и обходит любую команду времени (например, ago), используемую в запросе журнала. <br>*Например, если задан период 60 минут, а запрос выполняется в 13:15, то для запроса журнала возвращаются только записи, созданные между 12:15 и 13:15. Если в запросе журнала будет использована команда времени, например ago (7d), запрос журнала будет выполняться только для данных между 12:15 и 13:15 — как если бы данные существовали только за последние 60 минут. Данные за семь дней, как указано в запросе журнала, не будут выводиться.*

- **Частота**.  Указывает, как часто должен выполняться запрос. Это значение может составлять от 5 минут до 24 часов. Оно не должно превышать указанный период.  Если значение больше, чем указанный период, записи могут быть пропущены.<br>*Например, рассмотрим период в 30 минут и частоту в 60 минут.  Если запрос выполняется в 13:00, он возвращает записи между 12:30 и 13:00.  В следующий раз этот запрос будет выполнен в 14:00, а записи возвратятся между 13:30 и 14:00.  Записи, созданные между 13:00 и 13:30, не будут учитываться.*

- **Пороговое значение**.  Чтобы определить, следует ли создавать оповещение, оцениваются результаты поиска по журналам.  Для каждого типа правил генерации оповещений для поиска по журналам определяется собственное пороговое значение.

Для [Azure Monitor Logs](../../azure-monitor/learn/tutorial-viewdata.md) и для [Application Insights](../../azure-monitor/app/cloudservices.md#view-azure-diagnostics-events) используются правила поиска по журналам двух типов. Каждый из этих типов подробно описан в последующих разделах.

- **[Число результатов](#number-of-results-alert-rules)**. Если число записей, возвращенных в результатах поиска по журналам, превышает указанное количество, создается оповещение.
- **[Измерение метрик](#metric-measurement-alert-rules)**.  Оповещение, созданное для каждого объекта в результатах поиска по журналам со значением, превышающим указанное пороговое значение.

Ниже приведены различия между типами правил генерации оповещений.

- Правило генерации оповещений *Число результатов* всегда создает одно оповещение, а правило *Измерение метрик* — по одному для каждого объекта, который превышает порог.
- Правило генерации оповещений *Число результатов* создает оповещение при одноразовом превышении порогового значения. Правило генерации оповещений *Измерение метрик* может создавать оповещение при превышении порогового значения определенное количество раз за указанный интервал времени.

### <a name="number-of-results-alert-rules"></a>Правило генерации оповещений "Число результатов"

Правила генерации оповещений **Число результатов** создают одно оповещение, если количество записей, возвращенных в результатах поискового запроса, превышает указанное пороговое значение. Этот тип правила генерации оповещений идеально подходит для работы с такими событиями, как журналы событий Windows, системный журнал, ответ веб-приложения и настраиваемые журналы.  Возможно, вам потребуется создать оповещение, когда создается конкретное событие ошибки или при создании нескольких событий ошибки в течение определенного периода.

**Пороговое значение.** Порог для правила генерации оповещений "Число результатов" больше или меньше определенного значения.  Если число записей, возвращенных в результатах поиска по журналам, соответствует этому критерию, создается оповещение.

Для оповещения об отдельном событии задайте количество результатов больше 0 и проверяйте наличие одного события, созданного с момента последнего выполнения запроса. Некоторые приложения могут вносить в журнал нерегулярную ошибку, которая не обязательно должна вызывать оповещение.  Например, приложение может повторно запустить процесс, который создал событие ошибки и затем успешно завершил работу при следующем выполнении.  В этом случае, возможно, вам потребуется создавать оповещение только в случае возникновения нескольких событий за определенный период.  

В некоторых случаях может потребоваться создать оповещение в случае отсутствия события.  Например, процесс может регистрировать регулярные события, чтобы указать, что он работает правильно.  Если он не регистрирует одно из таких событий в пределах определенного периода, следует создать оповещение.  В этом случае задайте для порога значение **меньше 1**.

#### <a name="example-of-number-of-records-type-log-alert"></a>Пример оповещения журнала типа "Количество записей"

Рассмотрим сценарий, где нужно узнать, когда веб-приложение предоставит пользователям ответ с кодом 500 ("Внутренняя ошибка сервера"). Необходимо создать правило генерации оповещений со следующими сведениями:  

- **Запрос:** запросы | где resultCode == 500.<br>
- **Период времени:** 30 минут<br>
- **Частота предупреждений:** 5 минут.<br>
- **Пороговое значение:** больше 0.<br>

После этого оповещение будет выполнять запрос каждые 5 минут с 30 минутами данных для поиска записей с кодом результата 500. Если будет найдена хотя бы одна такая запись, сработает оповещение и запустится настроенное действие.

### <a name="metric-measurement-alert-rules"></a>Metric measurement alert rules (Измерение метрики для правила генерации оповещений)

Правила генерации оповещений **Измерение метрик** создают оповещение для каждого объекта в запросе со значением, превышающим указанное пороговое значение.  Ниже приведены их четко выраженные отличия от правил генерации оповещений **Число результатов**.

- **Агрегатная функция.** Указывает выполняемые вычисления и (необязательно) числовое поле для статистических вычислений.  Например, **count()** возвращает число записей в запросе, а **avg(CounterValue)** — среднее значение поля CounterValue в рамках указанного интервала. Агрегатная функция в запросе должна иметь имя: AggregatedValue и указывать числовое значение. 

- **Группировка по полю.** Для каждого экземпляра этого поля будет создана запись с агрегированным значением, и для каждого из них можно создать оповещение.  Например, если вы хотите создать оповещение для каждого компьютера, используйте группировку **по компьютерам**. Если в запросе оповещения содержится несколько полей группировки, пользователь может указать, какое поле будет использоваться для сортировки результатов, с помощью параметра **Агрегация по** (metricColumn).

    > [!NOTE]
    > Параметр *Агрегация по* (metricColumn) доступен только для оповещений журналов типа "Измерение метрик" для Application Insights и оповещений журналов для [Log Analytics, настроенных с помощью API scheduledQueryRules](../../azure-monitor/platform/alerts-log-api-switch.md).

- **Интервал.**  Определяет интервал времени, в течение которого выполняется статистическое вычисление данных.  Например, если вы указали значение **5 минут**, создается запись для каждого экземпляра поля группы, вычисленного с интервалом в 5 минут за период, указанный для оповещения.

    > [!NOTE]
    > В запросе для указания интервала необходимо использовать функцию Bin. Так как при использовании bin() можно получить неравные интервалы времени, интерфейс оповещений будет автоматически преобразовывать команду bin в команду bin_at с соответствующим временем выполнения, чтобы гарантировать получение результатов с фиксированной запятой. Тип оповещения журнала "Измерение метрик" предназначен для работы с запросами, имеющими до трех команд bin().
    
- **Пороговое значение.** Пороговое значение для правил генерации оповещений "Измерение метрик" определяется на основе статического значения и числа нарушений.  Если любая точка данных в результатах поиска по журналам превышает это значение, она рассматривается как нарушение.  Когда число нарушений в результатах для любого объекта превышает указанное значение, для этого объекта создается оповещение.

Неправильная настройка параметра *Агрегация по* или *metricColumn* может привести к сбою правила генерации оповещений. Дополнительные сведения см. в разделе, посвященном [устранению неполадок в случае неправильной работы правила генерации оповещений типа "Измерение метрик"](alert-log-troubleshoot.md#metric-measurement-alert-rule-is-incorrect).

#### <a name="example-of-metric-measurement-type-log-alert"></a>Пример оповещения журнала типа "Измерение метрик"

Рассмотрим ситуацию, где оповещение должно создаваться, когда использование процессора на компьютере превышает 90 % три раза в течение 30 минут.  Необходимо создать правило генерации оповещений со следующими сведениями:  

- **Запрос** Perf | where ObjectName == "Processor" and CounterName == "% Processor Time" | summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 5m), Computer<br>
- **Период времени:** 30 минут<br>
- **Частота предупреждений:** 5 минут.<br>
- **Логика оповещений — условие и пороговое значение:** больше 90.<br>
- **Группировка по полю (агрегация по):** Computer
- **Активировать оповещение на основе:** общее число нарушений превышает 2.<br>

Запрос вернет среднее значение для каждого компьютера с интервалом в 5 минут.  Этот запрос выполняется каждые 5 минут для данных, собранных в течение предыдущих 30 минут. Так как в "Группировка по полю (агрегация по)" выбрано группировку по столбцу "Компьютер", значение AggregatedValue разделено для различных значений "Компьютер" и среднее использование процессора для каждого компьютера определено временем ячейки в 5 минут.  Примерный результат запроса для трех компьютеров будет выглядеть следующим образом.


|TimeGenerated [UTC] |Computer  |AggregatedValue  |
|---------|---------|---------|
|20xx-xx-xxT01:00:00Z     |   Srv01.contoso.com      |    72     |
|20xx-xx-xxT01:00:00Z     |   SRV02.contoso.com      |    91     |
|20xx-xx-xxT01:00:00Z     |   srv03.contoso.com      |    83     |
|...     |   ...      |    ...     |
|20xx-xx-xxT01:30:00Z     |   Srv01.contoso.com      |    88     |
|20xx-xx-xxT01:30:00Z     |   SRV02.contoso.com      |    84     |
|20xx-xx-xxT01:30:00Z     |   srv03.contoso.com      |    92     |

Если результат запроса отобразиться на графике, он будет выглядеть следующим образом.

![Результаты выполнения примера запроса](media/alerts-unified-log/metrics-measurement-sample-graph.png)

В этом примере показан средний объем использования процессоров для каждого из трех компьютеров в ячейках 5 минут, вычисляемый в течение 5 минут. Пороговое значение 90 нарушено srv01 только один раз в ячейке 1:25. Для сравнения, srv02 превышает пороговое значение 90 в ячейках 1:10, 1:15 и 1:25; а srv03 превышает пороговое значение 90 в 1:10, 1:15, 1:20 и 1:30.
Поскольку оповещение настроено, чтобы активировать общую брешь в системе безопасности (более двух нарушений), только srv02 и srv03 соответствуют этому критерию. Поэтому для srv02 и srv03 будут созданы отдельные оповещения, так как за указанный период они 2 раза нарушили пороговое значение в 90 %.  Если вместо параметра *Активировать оповещение на основе:* настроен параметр *Continuous breaches* (Последовательные бреши), то оповещение будет срабатывать **только** для srv03, так как именно для него нарушено пороговое значение в трех последовательных ячейках времени с 1:10 по 1:20. Однако оно **не** будет срабатывать для srv02, так как он нарушил пороговое значение в ячейках времени с 1:10 до 1:15 последовательно два раза.

## <a name="log-search-alert-rule---firing-and-state"></a>Правило генерации оповещений в поиске по журналу — срабатывание и состояние

Правило генерации оповещений в поиске по журналу работает по логике, заданной пользователем в соответствии с конфигурацией и используемым пользовательским запросом аналитики. Так как логика точного условия или причины, по которой должно срабатывать правило генерации оповещений, инкапсулируется в запросе аналитики, он может отличаться в каждом правиле генерации оповещений журнала. Оповещения Azure содержат ограниченную информацию о конкретной основной причине в результатах журнала, когда условие порога правила генерации оповещений в поиске по журналам соблюдается или превышено. Таким образом, оповещения журнала называются оповещениями без учета состояния и будут срабатывать каждый раз, когда результат поиска в журнале будет достаточным для превышения порогового значения, указанного в оповещениях журнала о типе условия *Количество результатов* или *Измерение метрики*. Правила генерации оповещений журнала всегда будут срабатывать, пока результат запроса аналитики пользователя соответствует условию оповещения и ни одно из оповещений не устраняется. Так как логика точной причины сбоя мониторинга маскируется внутри запроса аналитики, предоставленного пользователем, нет никаких средств, с помощью которых оповещения Azure могут окончательно определить, дает ли разрешение проблемы результат поиска по журналу, не отвечающий пороговому значению.

Теперь предположим, что у нас есть правило генерации оповещений журнала, которое называется *Contoso-Log-Alert* в соответствии с конфигурацией в [примере, представленном для оповещения журнала типа "Количество результатов"](#example-of-number-of-records-type-log-alert). 
- В 13:05, когда правило Contoso-Log-Alert было выполнено оповещениями Azure, результат поиска по журналу выдал 0 записей ниже порога, из-за чего оповещение не появилось. 
- В следующей итерации в 13:10, когда правило Contoso-Log-Alert было выполнено оповещениями Azure, в результате поиска по журналу было получено 5 записей. Это выше порога, поэтому сработало оповещение вскоре после запуска связанной [группы действий](../../azure-monitor/platform/action-groups.md). 
- В 13:15, когда правило Contoso-Log-Alert было выполнено оповещениями Azure, в результате поиска по журналу было получено 2 записи. Порог был превышен, из-за чего сработало оповещение вскоре после запуска связанной [группы действий](../../azure-monitor/platform/action-groups.md).
- Далее в следующей итерации в 13:20, когда правило Contoso-Log-Alert было выполнено оповещениями Azure, в результате поиска по журналу снова было предоставлено 0 записей ниже порога, из-за чего оповещение не появилось.

Но в приведенном выше случае в 13:15 оповещения Azure не могут определить, сохраняются ли основные проблемы, наблюдаемые в 13:10, и есть ли новые сбои. Так как запрос, предоставленный пользователем, может учитывать предыдущие записи, оповещения Azure могут точно определить то, что нужно. Следовательно, когда правило Contoso-Log-Alert выполняется в 13:15, настроенная [группа действий](../../azure-monitor/platform/action-groups.md) оповещается снова в целях предосторожности. Теперь в 13:20, когда записи не появляются, оповещения Azure не могут с точностью определить, что причина записей устранена, поэтому состояние правила Contoso-Log-Alert не будет изменено на "Разрешено" на панели мониторинга оповещений Azure, а также не будут доступны уведомления об устранении проблемы.


## <a name="pricing-and-billing-of-log-alerts"></a>Цены и выставление счетов для оповещений журнала

Цены, применимые к оповещениям журнала, установлены на странице [цен Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/). В счетах Azure оповещения журнала представлены типом `microsoft.insights/scheduledqueryrules`. Кроме того:

- Для оповещений журнала Application Insights указываются точное имя оповещения, группа ресурсов и свойства оповещения.
- При создании оповещений журнала Log Analytics с помощью [API scheduledQueryRules](https://docs.microsoft.com/rest/api/monitor/scheduledqueryrules) для них указываются точное имя оповещения, а также группа ресурсов и свойства оповещения.

[Устаревший API Log Analytics](../../azure-monitor/platform/api-alerts.md) использует действия оповещения и расписания в составе сохраненных поисков Log Analytics, а не как полноценные [ресурсы Azure](../../azure-resource-manager/resource-group-overview.md). Поэтому для того, чтобы включить выставление счетов для прежних версий оповещений журнала, созданных для Log Analytics с помощью портала Azure **без** [перехода на новый интерфейс API](../../azure-monitor/platform/alerts-log-api-switch.md) или через [устаревший API Log Analytics](../../azure-monitor/platform/api-alerts.md), потребуется создать на странице `microsoft.insights/scheduledqueryrules` скрытые фиктивные правила генерации оповещений, которые будут отслеживаться для выставления счетов в Azure. Скрытые фиктивные правила генерации оповещений, созданные для выставления счетов на `microsoft.insights/scheduledqueryrules`, отображаются как `<WorkspaceName>|<savedSearchId>|<scheduleId>|<ActionId>` вместе с группой ресурсов и свойствами оповещения.

> [!NOTE]
> Если в имени есть недопустимые символы, такие как `<, >, %, &, \, ?, /`, для скрытого фиктивного правила генерации оповещений, а следовательно и в счетах Azure, они будут заменены символами `_`.

Чтобы удалить скрытые ресурсы scheduleQueryRules, созданные для выставления счетов за правила генерации оповещений, созданные в [устаревшем API Log Analytics](api-alerts.md), пользователь может выполнить любое из следующих действий:

- [Изменить используемый API для правил генерации оповещений в рабочей области Log Analytics](../../azure-monitor/platform/alerts-log-api-switch.md) и перейти на совместимый с Azure Resource Manager [API-интерфейс scheduledQueryRules](https://docs.microsoft.com/rest/api/monitor/scheduledqueryrules) без потери существующих правил генерации оповещений или мониторинга. Это действие позволит отказаться от скрытых фиктивных правил генерации оповещений, которые вы создавали для выставления счетов.
- Если нет желания переключать используемый API, следует **удалить** исходное расписание и действие оповещения через [устаревший API Log Analytics](api-alerts.md) или [удалить исходное правило генерации оповещений для журнала через портал Azure](../../azure-monitor/platform/alerts-log.md#view--manage-log-alerts-in-azure-portal).

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о [создании оповещений журнала в Azure](../../azure-monitor/platform/alerts-log.md).
* Информация о [веб-перехватчиках в оповещениях журналов в Azure](alerts-log-webhook.md).
* Сведения об [оповещениях Azure](../../azure-monitor/platform/alerts-overview.md).
* Дополнительные сведения об [Application Insights](../../azure-monitor/app/analytics.md).
* Дополнительные сведения о [Log Analytics](../../azure-monitor/log-query/log-query-overview.md).