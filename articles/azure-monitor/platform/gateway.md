---
title: Подключение компьютеров с помощью шлюза Log Analytics | Документация Майкрософт
description: Подключайте свои устройства и компьютеры под наблюдением Operations Manager с помощью шлюза Log Analytics для отправки данных в службу Log Analytics и службы автоматизации Azure, когда они не имеют доступа к Интернету.
services: log-analytics
documentationcenter: ''
author: mgoedtel
manager: carmonm
editor: ''
ms.assetid: ae9a1623-d2ba-41d3-bd97-36e65d3ca119
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.topic: conceptual
ms.date: 04/17/2019
ms.author: magoedte
ms.openlocfilehash: b0b221a9fe6c6482e8759664c297dbd25d0ee776
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60396433"
---
# <a name="connect-computers-without-internet-access-by-using-the-log-analytics-gateway-in-azure-monitor"></a>Подключение компьютеров без доступа к Интернету с помощью шлюза Log Analytics в Azure Monitor

>[!NOTE]
>Как Microsoft Operations Management Suite (OMS) происходит переход к Microsoft Azure Monitor, изменяется терминология. Эта статья относится к шлюзу OMS со шлюзом Azure Log Analytics. 
>

В этой статье описывается, как настроить связь между службой автоматизации Azure и Azure Monitor с помощью шлюза Log Analytics в том случае, если компьютеры, которые напрямую подключены или отслеживаются Operations Manager нет доступа к Интернету. 

Шлюз Log Analytics — прямой прокси-сервер HTTP, HTTP-туннелирование осуществляется с помощью команды HTTP CONNECT. Этот шлюз могут собирать данные и отправлять их в службу автоматизации Azure и рабочую область Log Analytics в Azure Monitor от имени компьютеров, которые не подключены к Интернету.  

Шлюз Log Analytics поддерживает:

* Reporting до же четыре Log Analytics агенты рабочей области, находящиеся позади этого и, настроенные с помощью службы автоматизации Azure гибридных рабочих ролей Runbook.  
* Компьютеры Windows, на которых Microsoft Monitoring Agent подключен непосредственно к рабочей области Log Analytics в Azure Monitor.
* Компьютеры Linux, на которых агент Log Analytics для Linux напрямую подключен к рабочей области Log Analytics в Azure Monitor.  
* System Center Operations Manager 2012 SP1 UR7, Operations Manager 2012 R2 с UR3 или группу управления в Operations Manager 2016 или более поздней версии, интегрированной с Log Analytics.  

Некоторые политики ИТ-безопасности не разрешать подключение к Интернету для сетевых компьютеров. Эти неподключенный компьютеров может быть точки продажи (POS) устройств или серверам, поддерживающим ИТ-служб, например. Для подключения этих устройств к службе автоматизации Azure или рабочей области Log Analytics, поэтому вы можете управлять и монитор, настроить их для взаимодействия непосредственно со шлюзом Log Analytics. Шлюз Log Analytics можно получить сведения о конфигурации и передавать данные от их имени. Если компьютеры настроены с помощью агента Log Analytics для подключения к рабочей области Log Analytics напрямую, вместо этого взаимодействовать со шлюзом Log Analytics.  

Log Analytics шлюз передает данные от агентов в службу напрямую. Он не анализирует данные во время передачи.

Если группа управления Operations Manager интегрирована с Log Analytics, серверы управления можно настроить для подключения к шлюзу Log Analytics для получения сведений о конфигурации и отправлять собранные данные в зависимости от включенного решения .  Агенты Operations Manager отправляют на сервер управления некоторые данные. Например агенты может отправлять оповещения, данные оценки конфигурации, данных пространства экземпляров и емкость данных Operations Manager. Другие данные большого объема, например журналы Internet Information Services (IIS), данные о производительности и событиях безопасности, отправляется непосредственно к шлюзу Log Analytics. 

Если развертывается один или несколько серверов шлюза Operations Manager для мониторинга ненадежных систем в сети периметра или изолированной сети, эти серверы не могут взаимодействовать со шлюзом Log Analytics.  Серверы Operations Manager шлюза могут сообщать только серверу управления.  При настройке группы управления Operations Manager для взаимодействия со шлюзом Log Analytics сведения о конфигурации прокси-сервера автоматически распространяются на каждый управляемый агентом компьютер, который настроен для сбора данных журнала для Azure Monitor даже если соответствующий параметр не указан.    

Для обеспечения высокой доступности для непосредственно подключенных или групп Operations Management, взаимодействующих с рабочей областью Log Analytics через шлюз, с использованием балансировки сетевой нагрузки (NLB) чтобы перенаправлять и распределять трафик между несколькими серверами шлюза. Таким образом, если один сервер шлюза выходит из строя, трафик перенаправляется на другие доступные узлы.  

На компьютере под управлением шлюза Log Analytics требуется агент Log Analytics Windows для идентификации конечных точек службы, которые приходится обмениваться данными со шлюзом. Агент также должен направлять шлюза к тем же рабочим областям, агенты или Operations Manager группы управления на базе шлюза должны быть настроены. Эта конфигурация обеспечивает шлюз и агент для взаимодействия с их назначенного рабочей области.

Шлюз может быть многосетевыми, чтобы до четырех рабочих областей. Это общее число рабочих областей, которые поддерживает агент Windows.  

Каждый агент должен иметь сетевое подключение к шлюзу, таким образом, чтобы агенты сможет автоматически передавать данные в, а также через шлюз. Не устанавливать шлюз на контроллере домена.

На следующей схеме показана данными, поступающими от прямых агентов, через шлюз, в службе автоматизации Azure и Log Analytics. Конфигурация прокси-сервера агента должна соответствовать порту, в которой настроен шлюз Log Analytics.  

![Схема взаимодействия прямого агента со службами](./media/gateway/oms-omsgateway-agentdirectconnect.png)

На следующей схеме представлена передача данных из группы управления Operations Manager в Log Analytics.   

![Схема взаимодействия Operations Manager с Log Analytics](./media/gateway/log-analytics-agent-opsmgrconnect.png)

## <a name="set-up-your-system"></a>Настройка системы

Компьютеры, назначенные для запуска шлюза Log Analytics должен иметь следующую конфигурацию:

* Windows 10, Windows 8.1 или Windows 7
* Windows Server 2016, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2 или Windows Server 2008
* Microsoft .NET Framework 4.5;
* По крайней мере 4-ядерный процессор и 8 ГБ памяти 
* Объект [агент Log Analytics для Windows](agent-windows.md) , настроенный для отправки отчетов в той же рабочей области, что и агенты, которые обмениваются данными через шлюз

### <a name="language-availability"></a>Доступность языковых версий

Шлюз Log Analytics доступна на следующих языках:

- Китайский (упрощенное письмо)
- Китайский (традиционное письмо)
- Чешский
- Нидерландский
- Английский
- Французский
- Немецкий
- Венгерский
- Итальянский
- Японский
- Корейский
- Польский
- Португальский (Бразилия)
- Португальский (Португалия)
- Русский
- испанский (международный).

### <a name="supported-encryption-protocols"></a>Поддерживаемые протоколы шифрования
Шлюз Log Analytics поддерживает только уровень безопасности TLS (Transport) 1.0, 1.1 и 1.2.  Он не поддерживает протокол Secure Sockets Layer (SSL).  Чтобы обеспечить безопасность данных во время передачи в Log Analytics, настроить шлюз, чтобы использовать по крайней мере TLS 1.2. Предыдущие версии TLS или SSL уязвимы. Несмотря на то, что в настоящее время они обеспечивают обратную совместимость, избегайте их использования.  

См. дополнительные сведения о [безопасной отправке данных с помощью TLS 1.2](../../azure-monitor/platform/data-security.md#sending-data-securely-using-tls-12). 

### <a name="supported-number-of-agent-connections"></a>Поддерживаемое число подключений агента
В следующей таблице показаны примерно, сколько агентов могут взаимодействовать с сервером шлюза. Поддержка основана на агенты, которые отправляют около 200 КБ данных каждые 6 секунд. Для каждого агента тестирования объем данных составляет 2,7 ГБ в день.

|Шлюз |Агенты поддерживаются (приблизительно)|  
|--------|----------------------------------|  
|ЦП: Intel Xeon E5-2660 v3 процессора \@ ядер с частотой 2,6 ГГц 2<br> Память: 4 ГБ<br> Пропускная способность сети. 1 Гбит/с| 600|  
|ЦП: Intel Xeon E5-2660 v3 процессора \@ 2,6 ГГц, 4 ядра<br> Память: 8 ГБ<br> Пропускная способность сети. 1 Гбит/с| 1000|  

## <a name="download-the-log-analytics-gateway"></a>Скачивание шлюза Log Analytics

Получить последнюю версию файла установки шлюза Log Analytics из любого [центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=54443) или портала Azure.

Чтобы перевести шлюз в Log Analytics на портале Azure, выполните следующие действия.

1. Найдите список служб и выберите **Log Analytics**. 
1. Выберите рабочую область.
1. В колонке рабочей области в разделе **Общие** выберите **Быстрый запуск**. 
1. в разделе **Выбор источника данных для подключения к рабочей области** щелкните **Компьютеры**;
1. В **Direct Agent** колонке **Log Analytics, скачайте шлюз**.
 
   ![Снимок экрана из шагов, чтобы скачать шлюз Log Analytics](./media/gateway/download-gateway.png)

или 

1. В колонке рабочей области в разделе **Параметры** щелкните **Дополнительные параметры**.
1. Перейдите к **подключенные источники** > **серверов Windows** и выберите **Log Analytics, скачайте шлюз**.

## <a name="install-log-analytics-gateway-using-setup-wizard"></a>Установка шлюза Log Analytics, с помощью мастера установки

Чтобы установить шлюз с помощью мастера установки, выполните следующие действия. 

1. В папке назначения дважды щелкните файл **Log Analytics Gateway.msi**.
1. На странице **приветствия** нажмите кнопку **Далее**.

   ![Снимок экрана приветствия страницы в мастере установки шлюза](./media/gateway/gateway-wizard01.png)

1. На **лицензионное соглашение** выберите **я принимаю условия лицензионного соглашения** принять условия лицензионного соглашения на использование программного обеспечения Майкрософт, а затем нажмите кнопку **Далее**.
1. На странице со сведениями об **адресе порта и прокси-сервера**:

   a. Введите номер TCP-порта, используемый для шлюза. Программа установки использует этот номер порта, чтобы настроить правило для входящего трафика в брандмауэре Windows.  По умолчанию используется значение 8080.
      Допустимый диапазон номеров порта — от 1 до 65535. При вводе значения, которое не входит в этот диапазон, появится сообщение об ошибке.

   2. Если сервер, где установлен шлюз должен взаимодействовать через прокси-сервер, введите адрес прокси-сервера, которому должен подключиться шлюз. Например, введите `http://myorgname.corp.contoso.com:80`.  Если оставить это поле пустым, шлюз будет пытаться подключиться к Интернету напрямую.  Если ваш прокси-сервер требует проверки подлинности, введите имя пользователя и пароль.

   c. Щелкните **Далее**.

   ![Снимок экрана конфигурации прокси-сервера шлюза](./media/gateway/gateway-wizard02.png)

1. Если у вас включен центр обновления Майкрософт, на странице центра обновления Майкрософт и вы можете включить ее. Сделайте выбор, а затем выберите **Далее**. В противном случае перейдите к следующему шагу.
1. На **конечная папка** странице оставьте папку по умолчанию (C:\Program c:\programfiles\oms Gateway) или введите расположение, где вы хотите установить шлюз. Затем нажмите кнопку **Далее**.
1. На странице **Готово к установке** выберите **Установить**. Если контроль учетных записей пользователей запрашивает разрешение на установку, выберите **Да**.
1. После завершения установки выберите **Готово**. Чтобы убедиться, что служба запущена, откройте оснастку services.msc и убедитесь, что **шлюз OMS** отображается в списке служб и имеющее состояние **под управлением**.

   ![Снимок экрана локальными службами работы шлюза OMS](./media/gateway/gateway-service.png)

## <a name="install-the-log-analytics-gateway-using-the-command-line"></a>Установка шлюза Log Analytics, с помощью командной строки
Скачанный файл шлюза — пакет установщика Windows, которые поддерживают автоматическую установку из командной строки или других автоматических метода. Если вы не знакомы со стандартными параметрами командной строки для установщика Windows, см. в разделе [параметры командной строки](https://docs.microsoft.com/windows/desktop/Msi/command-line-options).   

В следующей таблице выделены параметров, поддерживаемых программой установки.

|Параметры| Примечания|
|----------|------| 
|НОМЕР_ПОРТА | Номер TCP-порта для шлюза для прослушивания |
|ПРОКСИ-СЕРВЕРА | IP-адрес прокси-сервера |
|КАТАЛОГ УСТАНОВКИ | Полный путь, чтобы указать каталог установки файлов программного обеспечения шлюза |
|ИМЯ ПОЛЬЗОВАТЕЛЯ | Идентификатор пользователя для проверки подлинности с прокси-сервером |
|ПАРОЛЬ | Пароль пользователя, идентификатор для проверки подлинности с прокси-сервера |
|LicenseAccepted | Укажите значение **1** для проверки того, примите условия лицензионного соглашения |
|HASAUTH | Укажите значение **1** Если указаны параметры имени пользователя и ПАРОЛЯ |
|HASPROXY | Укажите значение **1** при указании IP-адрес для **ПРОКСИ** параметр |

Автоматическая установка шлюза и настройте его с адресом конкретного прокси-сервера, номер порта, введите следующее:

```dos
Msiexec.exe /I “oms gateway.msi” /qn PORTNUMBER=8080 PROXY=”10.80.2.200” HASPROXY=1 LicenseAccepted=1 
```

С помощью параметра командной строки /qn скрывает установки, /qb показывает установки во время автоматической установки.  

Если вам нужно предоставить учетные данные для проверки подлинности на прокси-сервере, введите следующее:

```dos
Msiexec.exe /I “oms gateway.msi” /qn PORTNUMBER=8080 PROXY=”10.80.2.200” HASPROXY=1 HASAUTH=1 USERNAME=”<username>” PASSWORD=”<password>” LicenseAccepted=1 
```

После установки можно подтвердить параметры, принято (exlcuding имя пользователя и пароль) с помощью следующих командлетов PowerShell:

- **Get-OMSGatewayConfig** — возвращает шлюз настроен для прослушивания TCP-порт.
- **Get-OMSGatewayRelayProxy** — возвращает IP-адрес прокси-сервера, вы настроили обмен данными.

## <a name="configure-network-load-balancing"></a>Настройка балансировки сетевой нагрузки 
Вы можете настроить шлюз для обеспечения высокой доступности с помощью балансировки сетевой нагрузки (NLB) с помощью либо в корпорацию Майкрософт [балансировки сетевой нагрузки (NLB)](https://docs.microsoft.com/windows-server/networking/technologies/network-load-balancing), [Azure Load Balancer](../../load-balancer/load-balancer-overview.md), или подсистемы балансировки нагрузки на основе оборудования. Подсистема балансировки нагрузки управляет трафиком, распределяя по подключенным узлам запросы на подключение, полученные от агентов Log Analytics или серверов управления Operations Manager. Если один сервер шлюза выходит из строя, трафик перенаправляется на другие узлы.

### <a name="microsoft-network-load-balancing"></a>Балансировка нагрузки сети Майкрософт
Сведения о проектировании и развертывании кластера балансировки сетевой нагрузки Windows Server 2016 см. в статье о [балансировке сетевой нагрузки](https://docs.microsoft.com/windows-server/networking/technologies/network-load-balancing). Ниже описана процедура настройки кластера балансировки сетевой нагрузки Майкрософт.  

1. Войдите на сервер Windows, который входит в кластер балансировки сетевой нагрузки, с использованием учетной записи администратора.  
2. Откройте диспетчер балансировки сетевой нагрузки в диспетчере сервера, щелкните **Инструменты**, а затем — **Диспетчер балансировки сетевой нагрузки**.
3. Чтобы подключить сервер шлюза Log Analytics с установленным компонентом Microsoft Monitoring Agent, щелкните правой кнопкой мыши IP-адрес кластера и выберите **Добавить узел в кластер**. 

    ![Диспетчер балансировки — сетевой нагрузки добавить узел в кластер](./media/gateway/nlb02.png)
 
4. Введите IP-адрес сервера шлюза, который нужно подключить. 

    ![Диспетчер балансировки сетевой нагрузки — "Добавление узла в кластер": Подключение](./media/gateway/nlb03.png) 

### <a name="azure-load-balancer"></a>Azure Load Balancer
Чтобы узнать, как проектировать и развертывать балансировщика нагрузки Azure, см. в разделе [что такое Azure Load Balancer?](../../load-balancer/load-balancer-overview.md). Чтобы развернуть подсистему балансировки нагрузки, базовый, выполните шаги, описанные в этом [быстрого запуска](../../load-balancer/quickstart-create-basic-load-balancer-portal.md) за исключением действия, описанные в разделе **Создание внутренних серверов**.   

> [!NOTE]
> Настройка подсистемы балансировки нагрузки Azure с помощью **SKU "базовый"**, виртуальные машины Azure, принадлежать к группе доступности. Дополнительные сведения о группах доступности см. в разделе [Управление доступностью виртуальных машин Windows в Azure](../../virtual-machines/windows/manage-availability.md). Добавить существующие виртуальные машины в группу доступности, см. в статье [задать Resource Manager виртуальной Машины группу доступности Azure](https://gallery.technet.microsoft.com/Set-Azure-Resource-Manager-f7509ec4).
> 

После создания подсистемы балансировки нагрузки внутреннему пулу должна быть создана, которая распределяет трафик на один или несколько серверов шлюзов. Выполните действия, описанные в разделе статьи краткого руководства [Создание ресурсов для подсистемы балансировки нагрузки](../../load-balancer/quickstart-create-basic-load-balancer-portal.md#create-resources-for-the-load-balancer).  

>[!NOTE]
>При настройке пробы работоспособности, должен быть настроен используется TCP-порт сервера шлюза. Проба работоспособности динамически добавляет или удаляет серверы шлюза из ротации подсистемы балансировки нагрузки, на основе их ответа на проверки работоспособности. 
>

## <a name="configure-the-log-analytics-agent-and-operations-manager-management-group"></a>Настройка агента Log Analytics и группы управления Operations Manager
В этом разделе вы увидите, как настроить непосредственно подключенных агентов Log Analytics, группы управления Operations Manager или службы автоматизации Azure гибридных рабочих ролей Runbook с помощью Log Analytics шлюза для связи со службой автоматизации Azure или Log Analytics.  

### <a name="configure-a-standalone-log-analytics-agent"></a>Настройка автономного агента Log Analytics
При настройке агента Log Analytics, замените значение сервера прокси-сервера IP-адрес сервера шлюза Log Analytics и его номер порта. Если вы развернули несколько серверов шлюзов после балансировщика нагрузки, конфигурацию прокси-сервера агента Log Analytics — это виртуальный IP-адрес подсистемы балансировки нагрузки.  

>[!NOTE]
>Чтобы установить агент Log Analytics на компьютерах Windows, которые напрямую подключаются к Log Analytics и шлюза, см. в разделе [компьютеров Windows для подключения к службе Log Analytics в Azure](agent-windows.md). Подключение компьютеров Linux, см. в разделе [Настройка агента Log Analytics для компьютеров Linux в гибридной среде](../../azure-monitor/learn/quick-collect-linux-computer.md). 
>

После установки агента на сервере шлюза, настройте его для передачи данных в рабочей области или рабочей области агенты, взаимодействующие со шлюзом. Если агент Log Analytics Windows не установлен на шлюзе, событие 300 записывается в журнал событий шлюза OMS, указывающее, что агент должен быть установлен. Если агент установлен, но не настроен для отправки отчетов в той же рабочей области, что и агенты, которые обмениваются данными через него, 105 событие записывается в один журнал, указывающее, что агент на шлюз должен быть настроен для отправки отчетов в той же рабочей области, что и агенты, co mmunicate со шлюзом.

После завершения настройки перезапустите службу шлюза OMS, чтобы применить изменения. В противном случае шлюз отклонит агенты, которые пытается связаться с Log Analytics и сообщает событие 105 в журнале событий шлюза OMS. Это также происходит при добавлении или удалении из конфигурации агента на сервере шлюза рабочей области.   

Сведения, связанные с гибридной рабочей роли Runbook службы автоматизации, см. в разделе [автоматизация ресурсов в центре обработки данных или облаке с помощью гибридной рабочей роли Runbook](../../automation/automation-hybrid-runbook-worker.md).

### <a name="configure-operations-manager-where-all-agents-use-the-same-proxy-server"></a>Настройка Operations Manager, где все агенты используют один прокси-сервер
Конфигурация прокси-сервера Operations Manager применяется ко всем агентам, передающим данные в Operations Manager, автоматически, даже если соответствующий параметр не указан.  

Чтобы использовать шлюз OMS для Operations Manager, необходимо иметь:

* Microsoft Monitoring Agent (версии 8.0.10900.0 или более поздней версии) установлен на сервере шлюза OMS и настроен с тем же рабочих областей Log Analytics, что группе управления настроен на отправку отчета.
* Подключение к Интернету. Кроме того шлюз OMS должны быть подключены к прокси-сервер, подключенный к Интернету.

> [!NOTE]
> Если указать значение для шлюза не ко всем агентам передаются пустые значения.
>

Если вашей группы управления Operations Manager регистрации рабочей области Log Analytics в первый раз, вы не увидите параметр для указания конфигурации прокси-сервера для группы управления в консоли управления. Этот параметр доступен только в том случае, если группа управления зарегистрирован в службе.  

Чтобы настроить интеграцию, обновите конфигурацию прокси-сервера системы с помощью Netsh в системе, где выполняется консоль управления и на всех серверах управления в группе управления. Выполните следующие действия.

1. Откройте командную строку с повышенными правами:

   a. Выберите **запустить** и введите **cmd**.  

   2. Щелкните правой кнопкой мыши **командной** и выберите **Запуск от имени администратора**.  

1. Введите следующую команду:

   `netsh winhttp set proxy <proxy>:<port>`

После завершения интеграции с Log Analytics, удалить изменения, запустив `netsh winhttp reset proxy`. Затем в консоли управления, используйте **Настройка прокси-сервера** параметр, чтобы указать сервер шлюза Log Analytics. 

1. В консоли Operations Manager в разделе **Operations Management Suite**выберите **подключения**, а затем выберите **Настройка прокси-сервера**.

   ![Снимок экрана Operations Manager, отображается выбора Настройка прокси-сервера](./media/gateway/scom01.png)

1. Выберите **использовать прокси-сервер для доступа к Operations Management Suite** и введите IP-адрес сервера шлюза Log Analytics или виртуальный IP-адрес подсистемы балансировки нагрузки. Не забудьте начинаются с префикса `http://`.

   ![Снимок экрана Operations Manager, показывающий адрес сервера прокси-сервера](./media/gateway/scom02.png)

1. Выберите **Готово**. Группа управления Operations Manager настроена для обмена данными со службой Log Analytics через сервер шлюза.

### <a name="configure-operations-manager-where-specific-agents-use-a-proxy-server"></a>Настройка Operations Manager, где определенные агенты используют прокси-сервер
Для больших или сложных средах можно только определенные серверы (или группы) использовали сервер шлюза Log Analytics.  Для этих серверов невозможно обновить агент Operations Manager напрямую, так как это значение перезаписывается глобальным значением группы управления.  Вместо этого необходимо переопределите правило, используемое для передачи этих значений.  

> [!NOTE] 
> Используйте этот прием конфигурации, если вы хотите разрешить для нескольких серверов шлюзов Log Analytics в вашей среде.  Например можно потребовать, чтобы указать на основе региональных определенные серверы шлюза Log Analytics.
>

Чтобы настроить определенные серверы или группы для использования сервера шлюза Log Analytics: 

1. Откройте консоль Operations Manager и выберите рабочую область **Создание**.  
1. В рабочей области "Создание" выберите **Правила**. 
1. На панели инструментов Operations Manager выберите **область** кнопки. Если это кнопка недоступна, убедитесь, что выбран объект, а не папка, в **мониторинг** области. Появится диалоговое окно **Ориентация объектов пакета управления** со списком общих целевых классов, групп или объектов. 
1. В **искать** введите **служба работоспособности** и выберите его из списка. Нажмите кнопку **ОК**.  
1. Поиск **правило настройки прокси-сервера помощника**. 
1. На панели инструментов Operations Manager выберите **переопределяет** и наведите указатель на **переопределить Rule\For конкретного объекта данного класса: Служба работоспособности** и выберите объект из списка.  Или создать пользовательскую группу, содержащую объект службы работоспособности серверов, необходимо применить это переопределение. Затем примените переопределения к вашей пользовательской группы.
1. В **свойства переопределения** диалоговое окно, добавьте метку в **переопределить** столбца рядом с полем **WebProxyAddress** параметра.  В **значение переопределения** введите URL-адрес сервера шлюза Log Analytics. Не забудьте начинаются с префикса `http://`.  

    >[!NOTE]
    > Вам не нужно включать правило. Он уже автоматически управляет переопределение, содержащееся в пакете управления Microsoft System Center Advisor переопределением безопасной ссылки, ориентированного на System Center Advisor группу серверов мониторинга Microsoft.
    > 

1. Выберите пакет управления из **выберите целевой пакет управления** или создайте новый незапечатанный пакет управления, выбрав **New**. 
1. По завершении нажмите кнопку **ОК**. 

### <a name="configure-for-automation-hybrid-runbook-workers"></a>Настройка для гибридных рабочих ролей Runbook службы автоматизации
Если в вашей среде гибридных рабочих ролей Runbook службы автоматизации, выполните следующие действия вручную, временные обходные пути настроить шлюз OMS для поддержки рабочие роли.

Выполните действия, описанные в этом разделе, нужно знать регион Azure, где находится учетная запись службы автоматизации. Чтобы найти это расположение:

1. Войдите на [портале Azure](https://portal.azure.com/).
1. Выберите службу автоматизации Azure.
1. Выберите соответствующую учетную запись службы автоматизации Azure.
1. Просмотрите ее регион в разделе **Расположение**.

   ![Снимок экрана: расположение учетной записи службы автоматизации на портале Azure](./media/gateway/location.png)

Используйте следующие таблицы для определения URL-адрес для каждого расположения.

**URL-адреса службы Job Runtime Data**

| **Местоположение.** | **URL-адрес** |
| --- | --- |
| Центрально-северная часть США |ncus-jobruntimedata-prod-su1.azure-automation.net |
| Западная Европа |we-jobruntimedata-prod-su1.azure-automation.net |
| Центрально-южная часть США |scus-jobruntimedata-prod-su1.azure-automation.net |
| Восток США 2 |eus2-jobruntimedata-prod-su1.azure-automation.net |
| Центральная Канада |cc-jobruntimedata-prod-su1.azure-automation.net |
| Северная Европа |ne-jobruntimedata-prod-su1.azure-automation.net |
| Юго-Восточная Азия |sea-jobruntimedata-prod-su1.azure-automation.net |
| Центральная Индия |cid-jobruntimedata-prod-su1.azure-automation.net |
| Япония |jpe-jobruntimedata-prod-su1.azure-automation.net |
| Австралия |ase-jobruntimedata-prod-su1.azure-automation.net |

**URL-адреса службы агента**

| **Местоположение.** | **URL-адрес** |
| --- | --- |
| Центрально-северная часть США |ncus-agentservice-prod-1.azure-automation.net |
| Западная Европа |we-agentservice-prod-1.azure-automation.net |
| Центрально-южная часть США |scus-agentservice-prod-1.azure-automation.net |
| Восток США 2 |eus2-agentservice-prod-1.azure-automation.net |
| Центральная Канада |cc-agentservice-prod-1.azure-automation.net |
| Северная Европа |ne-agentservice-prod-1.azure-automation.net |
| Юго-Восточная Азия |sea-agentservice-prod-1.azure-automation.net |
| Центральная Индия |cid-agentservice-prod-1.azure-automation.net |
| Япония |jpe-agentservice-prod-1.azure-automation.net |
| Австралия |ase-agentservice-prod-1.azure-automation.net |

Если компьютер автоматически зарегистрировался в качестве гибридной рабочей роли Runbook, используйте решение по управлению обновлениями для управления исправлениями. Выполните следующие действия.

1. Добавьте URL-адреса службы Job Runtime Data в список разрешенных узлов в шлюзе Log Analytics. Например: `Add-OMSGatewayAllowedHost we-jobruntimedata-prod-su1.azure-automation.net`
1. Перезапустите службу шлюза Log Analytics, используя командлет PowerShell `Restart-Service OMSGatewayService`.

Если компьютер присоединен к службе автоматизации Azure с помощью командлета регистрации гибридной рабочей роли Runbook, выполните следующие действия:

1. Добавьте URL-адрес для внесения службы агента в список разрешенных узлов в шлюзе Log Analytics. Например: `Add-OMSGatewayAllowedHost ncus-agentservice-prod-1.azure-automation.net`
1. Добавьте URL-адреса службы Job Runtime Data в список разрешенных узлов в шлюзе Log Analytics. Например: `Add-OMSGatewayAllowedHost we-jobruntimedata-prod-su1.azure-automation.net`
1. Перезапустите службу шлюза Log Analytics.
    `Restart-Service OMSGatewayService`

## <a name="useful-powershell-cmdlets"></a>Полезные командлеты PowerShell
Для выполнения задач для обновления параметров конфигурации шлюза Log Analytics можно использовать командлеты. Прежде чем использовать командлеты, обязательно сделайте следующее:

1. Установите шлюз Log Analytics (установщик Microsoft Windows).
1. Откройте окно консоли PowerShell.
1. Импортируйте модуль, введя следующую команду: `Import-Module OMSGateway`
1. Если при выполнении предыдущего шага не произошла ошибка, значит импорт модуля выполнен успешно и вы можете использовать командлеты. Введите `Get-Module OMSGateway`
1. После изменения с помощью командлетов перезапустите службу шлюза OMS.

Ошибка в шаге 3 означает, что модуль не был импортирован. Эта ошибка может возникнуть, когда PowerShell не удается найти модуль. Модуль можно найти в пути установки шлюза OMS: *C:\Program Files\Microsoft OMS Gateway\PowerShell\OmsGateway*.

| **Командлет** | **Параметры** | **Описание** | **Пример** |
| --- | --- | --- | --- |  
| `Get-OMSGatewayConfig` |Ключ |Получает конфигурацию службы |`Get-OMSGatewayConfig` |  
| `Set-OMSGatewayConfig` |Ключ (обязательно) <br> Value |Изменяет конфигурацию службы |`Set-OMSGatewayConfig -Name ListenPort -Value 8080` |  
| `Get-OMSGatewayRelayProxy` | |Получает адрес (и учетные данные) прокси-сервера ретрансляции (вышестоящего) |`Get-OMSGatewayRelayProxy` |  
| `Set-OMSGatewayRelayProxy` |Адрес<br> Имя пользователя<br> Пароль |Задает адрес (и учетные данные) прокси-сервера ретрансляции (вышестоящего) |1. Задайте прокси-сервер ретрансляции и учетные данные:<br> `Set-OMSGatewayRelayProxy`<br>`-Address http://www.myproxy.com:8080`<br>`-Username user1 -Password 123` <br><br> 2. Задайте прокси-сервер ретрансляции, для которого не требуется проверка подлинности: `Set-OMSGatewayRelayProxy`<br> `-Address http://www.myproxy.com:8080` <br><br> 3. Очистите параметры прокси-сервера ретрансляции:<br> `Set-OMSGatewayRelayProxy` <br> `-Address ""` |  
| `Get-OMSGatewayAllowedHost` | |Получает разрешенный в настоящее время узел (только локально настроенные Разрешенные узлы, загружается автоматически не разрешенные узлы) |`Get-OMSGatewayAllowedHost` | 
| `Add-OMSGatewayAllowedHost` |Узел (обязательно) |Добавляет узел в список разрешенных |`Add-OMSGatewayAllowedHost -Host www.test.com` |  
| `Remove-OMSGatewayAllowedHost` |Узел (обязательно) |Удаляет узел из списка разрешенных |`Remove-OMSGatewayAllowedHost`<br> `-Host www.test.com` |  
| `Add-OMSGatewayAllowedClientCertificate` |Субъект (обязательно) |Добавляет субъект сертификата клиента в список разрешенных |`Add-OMSGatewayAllowed`<br>`ClientCertificate` <br> `-Subject mycert` |  
| `Remove-OMSGatewayAllowedClientCertificate` |Субъект (обязательно) |Удаляет субъект сертификата клиента из списка разрешенных |`Remove-OMSGatewayAllowed` <br> `ClientCertificate` <br> `-Subject mycert` |  
| `Get-OMSGatewayAllowedClientCertificate` | |Получает разрешенный в настоящее время клиент субъекты сертификата (только локально настроенные разрешенные субъекты, загружается автоматически не разрешенные субъекты) |`Get-`<br>`OMSGatewayAllowed`<br>`ClientCertificate` |  

## <a name="troubleshooting"></a>Устранение неполадок
Для сбора событий, регистрируемых шлюзом, необходимо установить агент Log Analytics.

![Снимок экрана списка средство просмотра событий в журнале шлюза Log Analytics](./media/gateway/event-viewer.png)

### <a name="log-analytics-gateway-event-ids-and-descriptions"></a>Log Analytics шлюза идентификаторы и описания событий

В следующей таблице показаны идентификаторы и описания событий журнала шлюза Log Analytics.

| **Идентификатор** | **Описание** |
| --- | --- |
| 400 |Любая ошибка приложения имеет без определенного идентификатора. |
| 401 |Неправильная конфигурация. Например, параметра listenport задано значение = «text», а не является целым числом. |
| 402 |Исключение при анализе сообщений подтверждения TLS. |
| 403 |Сетевая ошибка. Например не может подключиться к целевому серверу. |
| 100 |Общие сведения. |
| 101 |Служба запущена. |
| 102 |Служба остановлена. |
| 103 |Команда HTTP CONNECT от клиента получен. |
| 104 |Команда HTTP CONNECT не получена. |
| 105 |Целевой сервер не включен в список разрешенных или конечный порт не является безопасной (443). <br> <br> Убедитесь, что агент MMA на сервере шлюза OMS и агенты, взаимодействующие со шлюзом OMS, подключены к одной и той же рабочей области Log Analytics. |
| 105 |Ошибка TCP-подключения — недопустимый сертификат клиента: CN = Gateway. <br><br> Убедитесь, что вы используете шлюз версии 1.0.395.0 или более поздней версии. Также убедитесь, что агент MMA на сервере шлюза OMS и агенты, взаимодействующие со шлюзом OMS, подключены к одной и той же рабочей области Log Analytics. |
| 106 |Неподдерживаемая версия протокола TLS/SSL.<br><br> Шлюз Log Analytics поддерживает только TLS 1.0, TLS 1.1 и 1.2. Он не поддерживает протокол SSL.|
| 107 |Сеанс TLS проверен. |

### <a name="performance-counters-to-collect"></a>Счетчики производительности для сбора данных

В следующей таблице приведены счетчики производительности, доступные для шлюза Log Analytics. Используйте системный монитор, чтобы добавить счетчики.

| **Имя** | **Описание** |
| --- | --- |
| Шлюз Log Analytics — Active Client Connection (Активные клиентские подключения) |Количество активных сетевых подключений клиента (TCP) |
| Шлюз Log Analytics — Error Count (Количество ошибок) |Количество ошибок |
| Шлюз Log Analytics — Connected Client (Подключенные клиенты) |Количество подключенных клиентов |
| Шлюз Log Analytics — Rejection Count (Количество отклонений) |Количество отклонений из-за любых ошибок проверки TLS |

![Снимок экрана Log Analytics интерфейс, отображение счетчиков производительности](./media/gateway/counters.png)

## <a name="assistance"></a>Помощь
Если вы вошли на портал Azure, вам поможет шлюза Log Analytics или другие службы Azure и функций.
Чтобы получить справку, выберите значок с вопросительным знаком в правом верхнем углу на портале и выберите **новый запрос на поддержку**. Затем заполните форму нового запроса поддержки.

![Снимок экрана: новый запрос в службу поддержки](./media/gateway/support.png)

## <a name="next-steps"></a>Дальнейшие действия
[Добавление источников данных](../../azure-monitor/platform/agent-data-sources.md) для сбора данных из подключенных источников и хранения данных в рабочей области Log Analytics.