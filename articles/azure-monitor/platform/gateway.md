---
title: Подключите компьютеры с помощью шлюза Log Analytics (ru) Документы Майкрософт
description: Подключите свои устройства и компьютеры, контролируемые менеджером операций, используя шлюз Log Analytics для отправки данных в службу автоматизации и анализа журналов Azure, если они не имеют доступа в Интернет.
ms.subservice: logs
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 12/24/2019
ms.openlocfilehash: a92e96a835f24ac54fa55b05086a35b9a91d609e
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80298333"
---
# <a name="connect-computers-without-internet-access-by-using-the-log-analytics-gateway-in-azure-monitor"></a>Подключение компьютеров без доступа в Интернет с помощью шлюза Log Analytics в Azure Monitor

>[!NOTE]
>По мере перехода на Microsoft Azure Monitor терминология меняется по мере перехода на Microsoft Operations Management Suite (OMS). В этой статье OMS Gateway упоминается как шлюз Analytics журналов Azure. 
>

В этой статье описывается, как настроить связь с Azure Automation и Azure Monitor с помощью шлюза Log Analytics, когда компьютеры, которые непосредственно подключены или контролируются менеджером по операциям, не имеют доступа к Интернету. 

Шлюз Log Analytics — это прокси HTTP-форвард, поддерживающий туннелирование HTTP с помощью команды HTTP CONNECT. Этот шлюз отправляет данные в Azure Automation и рабочее пространство Log Analytics в Azure Monitor от имени компьютеров, которые не могут напрямую подключаться к Интернету. 

Шлюз Log Analytics поддерживает:

* Отчетность до тех же рабочих областей анализа журналов, настроенных на каждый агент, на который стоит, и которые настроены с помощью гибридных runbook работников Azure Automation.  
* Компьютеры Windows, на которых агент мониторинга Майкрософт непосредственно подключен к рабочей области Log Analytics в Azure Monitor.
* Linux-компьютеры, на которых агент Log Analytics для Linux напрямую подключен к рабочей области Log Analytics в Azure Monitor.  
* Менеджер по операциям Системного центра 2012 SP1 с UR7, операционный менеджер 2012 R2 с UR3, или группа управления в операционном менеджере 2016 или позже, которая интегрирована с Log Analytics.  

Некоторые политики ИТ-безопасности не позволяют подключение к Интернету для сетевых компьютеров. Эти неподключенные компьютеры могут быть, например, в точке продажи (POS) или серверами, поддерживающими ИТ-услуги. Чтобы подключить эти устройства к Azure Automation или рабочему пространству Log Analytics, чтобы вы могли управлять и контролировать их, настроить их для непосредственного общения с шлюзом Log Analytics. Шлюз Log Analytics может получать информацию о конфигурации и данные пересылать от их имени. Если компьютеры настроены с агентом Log Analytics для непосредственного подключения к рабочей области Log Analytics, компьютеры вместо этого общаются с шлюзом Log Analytics.  

Шлюз Log Analytics передает данные от агентов службе напрямую. Он не анализирует данные в пути, и шлюз не кэширует данные, когда теряет связь с службой. Когда шлюз не может связаться с службой, агент продолжает работать и выстраивает в очередь собранные данные на диске контролируемого компьютера. Когда соединение восстановлено, агент отправляет кэшированные данные, собранные в Azure Monitor.

Когда группа управления менеджером операций интегрирована с Log Analytics, серверы управления могут быть настроены для подключения к шлюзу Log Analytics для получения информации о конфигурации и отправки собранных данных, в зависимости от включенного решения .  Агенты менеджера операций отправляют некоторые данные на сервер управления. Например, агенты могут отправлять оповещения диспетчера операций, данные оценки конфигурации, данные пространства экземпляров и данные о емкости. Другие данные большого объема, такие как журналы Интернет-информации (IIS), данные о производительности и события безопасности, отправляются непосредственно на шлюз Log Analytics. 

Если один или несколько серверов Manager Gateway развернуты для мониторинга ненадежных систем в сети периметра или изолированной сети, эти серверы не могут общаться с шлюзом Log Analytics.  Серверы Operations Manager Gateway могут отчитываться только перед сервером управления.  Когда группа управления менеджером операций настроена для связи с шлюзом Log Analytics, информация о конфигурации прокси автоматически распространяется на каждый управляемый агентом компьютер, настроенный для сбора данных журнала для Azure Monitor, даже если параметр пуст.

Чтобы обеспечить высокую доступность для непосредственно подключенных или операционных групп управления, которые взаимодействуют с рабочим пространством Log Analytics через шлюз, используйте балансировку сетевой нагрузки (NLB) для перенаправления и распределения трафика через несколько серверов шлюза. Таким образом, если один сервер шлюза выходит из-под конкретиза, трафик перенаправляется в другой доступный узла.  

Компьютер, который запускает шлюз Log Analytics, требует от агента Log Analytics Windows определить конечные точки службы, с которыми шлюз должен общаться. Агенту также необходимо направить шлюз для отчета в те же рабочие области, с которыми настроены агенты или группа управления операциями за шлюзом. Эта конфигурация позволяет шлюзу и агенту общаться с назначенным рабочим пространством.

Шлюз может быть многодомет до четырех рабочих пространств. Это общее количество рабочих областей, которые поддерживает агент Windows.  

Каждый агент должен иметь сетевое подключение к шлюзу, чтобы агенты могли автоматически передавать данные в и из шлюза. Избегайте установки шлюза на контроллер домена. Компьютеры Linux, которые находятся за сервером шлюза, не могут использовать метод [установки скриптов для](agent-linux.md#install-the-agent-using-wrapper-script) установки агента Log Analytics для Linux. Агент должен быть загружен вручную, скопирован на компьютер и установлен вручную, поскольку шлюз поддерживает связь только с службами Azure, упомянутыми ранее.

На следующей диаграмме показаны данные, перетекающие из прямых агентов через шлюз в Azure Automation и Log Analytics. Конфигурация прокси-сервера агента должна соответствовать порту, с которым настроен шлюз Log Analytics.  

![Диаграмма прямого агентского сообщения с сервисами](./media/gateway/oms-omsgateway-agentdirectconnect.png)

На следующей схеме представлена передача данных из группы управления Operations Manager в Log Analytics.   

![Диаграмма связи менеджера по операциям с журналом Analytics](./media/gateway/log-analytics-agent-opsmgrconnect.png)

## <a name="set-up-your-system"></a>Настройка системы

Компьютеры, предназначенные для запуска шлюза Log Analytics, должны иметь следующую конфигурацию:

* Windows 10, Windows 8.1 или Windows 7
* Windows Server 2019, Windows Server 2016, Windows Server 2012 R2, Windows Server 2012, Windows Server 2008 R2 или Windows Server 2008
* Microsoft .NET Framework 4.5
* По крайней мере, 4-ядерный процессор и 8 ГБ памяти 
* [Агент log Analytics для Windows,](agent-windows.md) настроенный для отчета в то же рабочее пространство, что и агенты, которые общаются через шлюз

### <a name="language-availability"></a>Доступность языковых версий

Шлюз Log Analytics доступен на следующих языках:

- Китайский (упрощенное письмо)
- Китайский (традиционное письмо)
- Чешский
- Нидерландский
- Английский
- Французский
- Немецкий
- Венгерский
- Итальянский
- Японский
- Корейский
- Польский
- Португальский (Бразилия)
- Португальский (Португалия)
- Русский
- испанский (международный).

### <a name="supported-encryption-protocols"></a>Поддерживаемые протоколы шифрования

Шлюз Log Analytics поддерживает только безопасность транспортного слоя (TLS) 1.0, 1.1 и 1.2.  Он не поддерживает безопасные разъемы слоя (SSL).  Для обеспечения безопасности данных, передаваемых в журнал Analytics, настройте шлюз, чтобы использовать по крайней мере TLS 1.2. Уязвимы старые версии TLS или SSL. Хотя в настоящее время они позволяют обратную совместимость, избегайте их использования.  

См. дополнительные сведения о [безопасной отправке данных с помощью TLS 1.2](../../azure-monitor/platform/data-security.md#sending-data-securely-using-tls-12). 

### <a name="supported-number-of-agent-connections"></a>Поддерживаемое число подключений агента

В следующей таблице показано примерно, сколько агентов может общаться с сервером шлюза. Поддержка основана на агентах, которые загружают около 200 кБ данных каждые 6 секунд. Для каждого проверенного агента объем данных составляет около 2,7 ГБ в день.

|Шлюз |Поддерживаемые агенты (приблизительно)|  
|--------|----------------------------------|  
|Процессор: процессор Intel Xeon Процессор E5-2660 v3 \@ 2,6 ГГц 2 Ядра<br> Память: 4 ГБ<br> Пропускная способность сети: 1 Гбит/с| 600|  
|Процессор: процессор Intel Xeon Процессор E5-2660 v3 \@ 2,6 ГГц 4 ядра<br> Память: 8 ГБ<br> Пропускная способность сети: 1 Гбит/с| 1000|  

## <a name="download-the-log-analytics-gateway"></a>Скачивание шлюза Log Analytics

Получите последнюю версию файла настройки шлюза Log Analytics от центра загрузки Майкрософт[(Download Link),](https://go.microsoft.com/fwlink/?linkid=837444)либо на портале Azure.

Чтобы получить шлюз Log Analytics с портала Azure, выполните следующие действия:

1. Найдите список служб и выберите **Log Analytics**. 
1. Выберите рабочую область.
1. В колонке рабочей области в разделе **Общие** выберите **Быстрый запуск**. 
1. в разделе **Выбор источника данных для подключения к рабочей области** щелкните **Компьютеры**;
1. В лезвии **прямого агента** выберите **шлюз Скачать журнал Analytics**.
 
   ![Скриншот шагов для загрузки шлюза Log Analytics](./media/gateway/download-gateway.png)

или диспетчер конфигурации служб 

1. В колонке рабочей области в разделе **Параметры** щелкните **Дополнительные параметры**.
1. Перейдите к**серверам Windows-серверов** **подключенных источников** > и выберите **шлюз Скачать Log Analytics.**

## <a name="install-log-analytics-gateway-using-setup-wizard"></a>Установка шлюза Log Analytics с помощью мастера настройки

Чтобы установить шлюз с помощью мастера настройки, выполните следующие действия. 

1. В папке назначения дважды щелкните файл **Log Analytics Gateway.msi**.
1. На странице **приветствия** нажмите кнопку **Далее**.

   ![Скриншот страницы Welcome в мастере настройки шлюза](./media/gateway/gateway-wizard01.png)

1. На странице **Лицензионного соглашения** **выберите, что я принимаю условия Лицензионного соглашения,** чтобы согласиться с условиями лицензии на программное обеспечение Майкрософт, а затем выбрать **следующий**.
1. На странице со сведениями об **адресе порта и прокси-сервера**:

   а. Введите номер порта TCP, который будет использоваться для шлюза. Настройка использует этот номер порта для настройки входящего правила на Windows Firewall.  По умолчанию используется значение 8080.
      Допустимый диапазон номера порта составляет от 1 до 65535. При вводе значения, которое не входит в этот диапазон, появится сообщение об ошибке.

   b. Если сервер, на котором установлен шлюз, должен общаться через прокси-сервер, введите прокси-адрес, по которому шлюз должен подключиться. Например, введите `http://myorgname.corp.contoso.com:80`.  Если вы оставите это поле пустым, шлюз будет пытаться подключиться к Интернету напрямую.  Если ваш прокси-сервер требует проверки подлинности, введите имя пользователя и пароль.

   c. Нажмите кнопку **Далее**.

   ![Скриншот конфигурации для прокси-шлюза](./media/gateway/gateway-wizard02.png)

1. Если у вас нет включении обновления Майкрософт, появляется страница обновления Майкрософт, и вы можете включить ее. Сделайте выбор, а затем выберите **Следующий**. В противном случае перейдите к следующему шагу.
1. На странице **Destination Folder** либо оставьте папку C по умолчанию: «Файлы программы »OMS Gateway или введите место, где вы хотите установить шлюз. Затем выберите **Следующий**.
1. На **странице Ready to install** выберите **Install**. Если user Account Control запрашивает разрешение на установку, выберите **«Да».**
1. После завершения настройки выберите **Finish.** Чтобы убедиться, что служба запущена, откройте service.msc snap-in и убедитесь, что **OMS Gateway** отображается в списке служб и что его статус **запущен.**

   ![Скриншот местных служб, показывающий, что OMS Gateway работает](./media/gateway/gateway-service.png)

## <a name="install-the-log-analytics-gateway-using-the-command-line"></a>Установка шлюза Log Analytics с помощью командной строки

Загруженный файл для шлюза представляет собой пакет Windows Installer, который поддерживает бесшумную установку из командной строки или другого автоматизированного метода. Если вы не знакомы со стандартными вариантами командной [Command-line options](https://docs.microsoft.com/windows/desktop/Msi/command-line-options)строки для установки Windows, см.
 
В следующей таблице освещаются параметры, поддерживаемые установкой.

|Параметры| Примечания|
|----------|------| 
|ПОРТНОМЕР | Номер порта TCP для шлюза для прослушивания |
|Прокси | IP-адрес прокси-сервера |
|INSTALLDIR | Полностью квалифицированный способ указать каталог файлов программного обеспечения шлюза |
|USERNAME | Идентификатор пользователя для проверки подлинности с помощью прокси-сервера |
|PASSWORD | Пароль идентификатора пользователя для проверки подлинности с помощью прокси |
|LicenseAccepted | Укажите значение **1** для проверки того, что вы принимаете лицензионное соглашение |
|ХАСАУТ | Укажите значение **1** при указании параметров USERNAME/PASSWORD |
|HASPROXY | Указать значение **1** при указании IP-адреса для параметра **PROXY** |

Чтобы бесшумно установить шлюз и настроить его с определенным прокси-адресом, номером порта, введите следующее:

```dos
Msiexec.exe /I "oms gateway.msi" /qn PORTNUMBER=8080 PROXY="10.80.2.200" HASPROXY=1 LicenseAccepted=1 
```

Использование опции командной строки /qn скрывает настройку, /qb показывает настройку во время бесшумной установки.  

Если вам необходимо предоставить учетные данные для проверки подлинности с помощью прокси- и введите следующее:

```dos
Msiexec.exe /I "oms gateway.msi" /qn PORTNUMBER=8080 PROXY="10.80.2.200" HASPROXY=1 HASAUTH=1 USERNAME="<username>" PASSWORD="<password>" LicenseAccepted=1 
```

После установки вы можете подтвердить, что настройки принимаются (за исключением имени пользователя и пароля) с помощью следующих cmdlets PowerShell:

- **Get-OMSGatewayConfig** - Возвращает порт TCP шлюз настроен на прослушивание.
- **Get-OMSGatewayRelayProxy** - Возвращает IP-адрес прокси-сервера, с ним вы настраивали его для общения.

## <a name="configure-network-load-balancing"></a>Настройка балансировки сетевой нагрузки

Вы можете настроить шлюз для высокой доступности с помощью балансировки сетевой нагрузки (NLB) с помощью либо [балансировки загрузки сети Майкрософт (NLB),](https://docs.microsoft.com/windows-server/networking/technologies/network-load-balancing) [баланса нагрузки Azure](../../load-balancer/load-balancer-overview.md)или аппаратных балансировок нагрузки. Подсистема балансировки нагрузки управляет трафиком, распределяя по подключенным узлам запросы на подключение, полученные от агентов Log Analytics или серверов управления Operations Manager. Если один сервер шлюза выходит из строя, трафик перенаправляется на другие узлы.

### <a name="microsoft-network-load-balancing"></a>Служба балансировки сетевой нагрузки Microsoft

Сведения о проектировании и развертывании кластера балансировки сетевой нагрузки Windows Server 2016 см. в статье о [балансировке сетевой нагрузки](https://docs.microsoft.com/windows-server/networking/technologies/network-load-balancing). Ниже описана процедура настройки кластера балансировки сетевой нагрузки Майкрософт.  

1. Войдите на сервер Windows, который входит в кластер балансировки сетевой нагрузки, с использованием учетной записи администратора.  
2. Откройте диспетчер балансировки сетевой нагрузки в диспетчере сервера, щелкните **Инструменты**, а затем — **Диспетчер балансировки сетевой нагрузки**.
3. Чтобы подключить сервер шлюза Log Analytics с установленным компонентом Microsoft Monitoring Agent, щелкните правой кнопкой мыши IP-адрес кластера и выберите **Добавить узел в кластер**. 

    ![Диспетчер балансировки сетевой нагрузки — "Добавить узел в кластер"](./media/gateway/nlb02.png)
 
4. Введите IP-адрес сервера шлюза, который нужно подключить. 

    ![Диспетчер балансировки сетевой нагрузки — "Добавить узел в кластер: подключить"](./media/gateway/nlb03.png) 

### <a name="azure-load-balancer"></a>Azure Load Balancer

Чтобы узнать, как проектировать и развертывать балансер загрузки Azure, [см.](../../load-balancer/load-balancer-overview.md) Чтобы развернуть базовый балансик нагрузки, выполните шаги, изложенные в этом [быстром запуске,](../../load-balancer/quickstart-load-balancer-standard-public-portal.md) исключая шаги, изложенные в разделе **Создание серверов бэк-энда.**   

> [!NOTE]
> Настройка баланса загрузки Azure с помощью **Базового SKU**требует, чтобы виртуальные машины Azure принадлежали к набору доступности. Чтобы узнать больше о наборах доступности, [см. Управление доступностью виртуальных машин Windows в Azure.](../../virtual-machines/windows/manage-availability.md) Чтобы добавить существующие виртуальные машины в набор доступности, обратитесь к [Set Azure Resource Manager VM Availability Set.](https://gallery.technet.microsoft.com/Set-Azure-Resource-Manager-f7509ec4)
> 

После создания балансиста нагрузки необходимо создать пул бэкэнда, который распределяет трафик на один или несколько серверов шлюза. Следуйте шагам, описанным в разделе «Быстрый запуск» [Для создания ресурсов для балансивировора нагрузки.](../../load-balancer/quickstart-load-balancer-standard-public-portal.md)  

>[!NOTE]
>При настройке зонда работоспособности следует настроить для использования порта TCP сервера шлюза. Зонд работоспособности динамически добавляет или удаляет серверы шлюза из вращения балансопарка нагрузки на основе их реакции на проверки работоспособности. 
>

## <a name="configure-the-log-analytics-agent-and-operations-manager-management-group"></a>Настройка агента Log Analytics и группы управления менеджером по операциям

В этом разделе вы увидите, как настроить непосредственно подключенные агенты Log Analytics, группу управления менеджерами операций или гибридных сотрудников по управлению Runbook С помощью шлюза Log Analytics для связи с Azure Automation или Log Analytics.  

### <a name="configure-a-standalone-log-analytics-agent"></a>Настройка автономного агента по анализу журналов

При настройке агента Log Analytics замените значение прокси-сервера НА IP-адрес шлюза Log Analytics и его номер порта. Если вы развернули несколько серверов шлюза за балансером нагрузки, конфигурация прокси-сервера агента Log Analytics является виртуальным IP-адресом балансиста нагрузки.  

>[!NOTE]
>Для установки агента Log Analytics на шлюзе и компьютерах Windows, которые непосредственно подключаются к журналу Analytics, [см.](agent-windows.md) Чтобы подключить компьютеры Linux, [см.](agent-linux.md) 
>

После установки агента на сервер шлюза настройте его для отчета в рабочее пространство или рабочие агенты, которые общаются с шлюзом. Если агент Log Analytics Windows не установлен на шлюзе, событие 300 записывается в журнал событий OMS Gateway, что указывает на необходимость установки агента. Если агент установлен, но не настроен, чтобы отчитываться в том же рабочем пространстве, что и агенты, которые общаются через него, событие 105 записывается в тот же журнал, что указывает на то, что агент на шлюзе должен быть настроен, чтобы сообщить в ту же рабочую область, что и агенты, которые общаться с шлюзом.

После завершения конфигурации перезапустите службу **OMS Gateway** для применения изменений. В противном случае шлюз отклонит агенты, которые пытаются связаться с Log Analytics, и сообщит о событии 105 в журнале событий OMS Gateway. Это также произойдет при добавлении или удалении рабочего пространства из конфигурации агента на сервере шлюза.

Для получения информации, связанной с [Automate resources in your datacenter or cloud by using Hybrid Runbook Worker](../../automation/automation-hybrid-runbook-worker.md)автоматическим гибридным Runbook Worker, см.

### <a name="configure-operations-manager-where-all-agents-use-the-same-proxy-server"></a>Настройка менеджера операций, где все агенты используют один и тот же прокси-сервер

Конфигурация прокси-сервера Operations Manager применяется ко всем агентам, передающим данные в Operations Manager, автоматически, даже если соответствующий параметр не указан.  

Чтобы использовать OMS Gateway для поддержки менеджера операций, необходимо:

* Агент мониторинга Майкрософт (версия 8.0.10900.0 или более поздняя), установленный на сервере OMS Gateway и настроенный с теми же рабочими областями Log Analytics, на которые настроена ваша группа управления.
* Подключение к Интернету. Кроме того, OMS Gateway должен быть подключен к прокси-серверу, подключенного к Интернету.

> [!NOTE]
> Если вы не указываете значение для шлюза, пустые значения перемещаются всем агентам.
>

Если группа управления операциями впервые регистрируется в рабочей области Log Analytics, вы не увидите возможность указать конфигурацию прокси для группы управления в консоли Operations. Эта опция доступна только в том случае, если группа управления зарегистрирована в службе.  

Чтобы настроить интеграцию, обновите конфигурацию прокси-серверов системы, используя Netsh в системе, где вы работаете консоль Операций, и на всех серверах управления в группе управления. Выполните следующие действия.

1. Откройте поднятую команду:

   а. Выберите **Начало** и введите **cmd**.  

   b. Нажмите кнопкой **мыши Команды Оперативное** и выберите **Выполнить в качестве администратора**.  

1. Введите следующую команду:

   `netsh winhttp set proxy <proxy>:<port>`

После завершения интеграции с Log Analytics `netsh winhttp reset proxy`удалите изменение, запустив. Затем, в консоли Операций, используйте опцию **прокси-сервера Настройка** для указания шлюза Log Analytics. 

1. На консоли Operations Manager под **набором управления операциями**выберите **соединение,** а затем **выберите Настройку Прокси-сервера.**

   ![Скриншот менеджера операций, показывающий выбор настройки прокси-сервера](./media/gateway/scom01.png)

1. Выберите **используйте прокси-сервер для доступа к набору управления операциями,** а затем введите IP-адрес шлюза Log Analytics или виртуальный IP-адрес балансера нагрузки. Будьте осторожны, чтобы `http://`начать с префиксом .

   ![Скриншот менеджера операций с указанием адреса прокси-сервера](./media/gateway/scom02.png)

1. Нажмите кнопку **Готово**. Группа управления Operations Manager настроена для обмена данными со службой Log Analytics через сервер шлюза.

### <a name="configure-operations-manager-where-specific-agents-use-a-proxy-server"></a>Настройка менеджера операций, где конкретные агенты используют прокси-сервер

Для больших или сложных сред может потребоваться использовать только определенные серверы (или группы) для использования шлюза log Analytics.  Для этих серверов вы не можете обновлять агент менеджера операций напрямую, поскольку это значение перезаписано глобальной ценностью для группы управления.  Вместо этого переопределить правило, используемое для нажатия этих значений.  

> [!NOTE] 
> Используйте этот метод конфигурации, если вы хотите, чтобы несколько серверов шлюза Log Analytics в вашей среде.  Например, можно потребовать, чтобы конкретные серверы шлюзов Log Analytics были указаны на региональной основе.
>

Для настройки определенных серверов или групп для использования сервера шлюза Log Analytics: 

1. Откройте консоль Operations Manager и выберите рабочую область **Создание**.  
1. В рабочей области "Создание" выберите **Правила**. 
1. На панели инструментов «Менеджер операций» выберите кнопку **Scope.** Если эта кнопка недоступна, убедитесь, что вы выбрали объект, а не папку, в панели **мониторинга.** Появится диалоговое окно **Ориентация объектов пакета управления** со списком общих целевых классов, групп или объектов. 
1. В поле **«Ищите»** введите **службу здравоохранения** и выберите ее из списка. Нажмите кнопку **ОК**.  
1. Поиск **правила настройки прокси-сервера советника.** 
1. На панели инструментов «Менеджер операций» выберите **Переопределения,** а затем укажите на **переопределение правила для конкретного объекта класса: Служба работоспособности** и выберите объект из списка.  Или создайте пользовательскую группу, содержащую объект службы работы серверов, к которым вы хотите применить этот переопределение. Затем примените переопределение к вашей пользовательской группе.
1. В диалоговом поле **Override Properties** добавьте контрольный знак в столбце **Override** рядом с параметром **WebProxyAddress.**  В поле **значения переопределения** введите URL-адрес шлюза Log Analytics. Будьте осторожны, чтобы `http://`начать с префиксом .  

    >[!NOTE]
    > Вам не нужно включать правило. Он уже управляется автоматически с переопределением в пакете управления защищенным справочным переопределением Microsoft System Center, который нацелен на группу мониторинга Microsoft System Center Monitoring Server Group.
    > 

1. Выберите пакет управления из списка **пакетов управления Select или** создайте новый негерметичной пакет управления, выбрав **новый**. 
1. По завершении нажмите кнопку **ОК**. 

### <a name="configure-for-automation-hybrid-runbook-workers"></a>Настройка для автоматизации гибридных runbook работников

Если в вашей среде есть автоматические гибридные runbook, выполните следующие действия, чтобы настроить шлюз для поддержки работников.

Для поиска URL-адреса для каждого региона обратитесь к [разделу «Настройка сетевого](../../automation/automation-hybrid-runbook-worker.md#network-planning) раздела документации автоматизации».

Если ваш компьютер зарегистрирован как гибридный работник Runbook автоматически, например, если решение Update Management включено для одного или нескольких vMs, выполните следующие действия:

1. Добавьте URL-адреса службы Job Runtime Data в список разрешенных узлов в шлюзе Log Analytics. Например: `Add-OMSGatewayAllowedHost we-jobruntimedata-prod-su1.azure-automation.net`
1. Перезапустите службу шлюза Log Analytics, используя командлет PowerShell `Restart-Service OMSGatewayService`.

Если ваш компьютер присоединился к Автоматизации Azure с помощью регистрации Hybrid Runbook Worker cmdlet, выполните следующие действия:

1. Добавьте URL-адрес для внесения службы агента в список разрешенных узлов в шлюзе Log Analytics. Например: `Add-OMSGatewayAllowedHost ncus-agentservice-prod-1.azure-automation.net`
1. Добавьте URL-адреса службы Job Runtime Data в список разрешенных узлов в шлюзе Log Analytics. Например: `Add-OMSGatewayAllowedHost we-jobruntimedata-prod-su1.azure-automation.net`
1. Перезапустите службу шлюза Log Analytics.
    `Restart-Service OMSGatewayService`

## <a name="useful-powershell-cmdlets"></a>Полезные командлеты PowerShell

Для выполнения задач для обновления параметров конфигурации шлюза Log Analytics можно использовать cmdlets. Перед использованием cmdlets, не забудьте:

1. Установка шлюза Log Analytics (Установщик Microsoft Windows).
1. Откройте окно консоли PowerShell.
1. Импортируйте модуль, введя эту команду:`Import-Module OMSGateway`
1. Если при выполнении предыдущего шага не произошла ошибка, значит импорт модуля выполнен успешно и вы можете использовать командлеты. Введите `Get-Module OMSGateway`
1. После использования cmdlets для внесения изменений перезапустите службу OMS Gateway.

Ошибка в шаге 3 означает, что модуль не был импортирован. Ошибка может произойти, когда PowerShell не может найти модуль. Вы можете найти модуль в пути установки OMS Gateway: *C: «Программные файлы »Microsoft OMS Gateway »PowerShell»OmsGateway*.

| **Командлет** | **Параметры** | **Описание** | **Пример** |
| --- | --- | --- | --- |  
| `Get-OMSGatewayConfig` |Ключ |Получает конфигурацию службы |`Get-OMSGatewayConfig` |  
| `Set-OMSGatewayConfig` |Ключ (обязательно) <br> Значение |Изменяет конфигурацию службы |`Set-OMSGatewayConfig -Name ListenPort -Value 8080` |  
| `Get-OMSGatewayRelayProxy` | |Получает адрес (и учетные данные) прокси-сервера ретрансляции (вышестоящего) |`Get-OMSGatewayRelayProxy` |  
| `Set-OMSGatewayRelayProxy` |Адрес<br> Имя пользователя<br> Пароль (безопасная строка) |Задает адрес (и учетные данные) прокси-сервера ретрансляции (вышестоящего) |1. Установите ретрансляционный прокси и учетные данные:<br> `Set-OMSGatewayRelayProxy`<br>`-Address http://www.myproxy.com:8080`<br>`-Username user1 -Password 123` <br><br> 2. Установите прокси-сервер, который не нуждается в аутентификации:`Set-OMSGatewayRelayProxy`<br> `-Address http://www.myproxy.com:8080` <br><br> 3. Очистить настройки реле прокси:<br> `Set-OMSGatewayRelayProxy` <br> `-Address ""` |  
| `Get-OMSGatewayAllowedHost` | |Получает в настоящее время разрешенный хост (только локально настроенный разрешенный хост, а не автоматически загруженный разрешенные хосты) |`Get-OMSGatewayAllowedHost` | 
| `Add-OMSGatewayAllowedHost` |Узел (обязательно) |Добавляет узел в список разрешенных |`Add-OMSGatewayAllowedHost -Host www.test.com` |  
| `Remove-OMSGatewayAllowedHost` |Узел (обязательно) |Удаляет узел из списка разрешенных |`Remove-OMSGatewayAllowedHost`<br> `-Host www.test.com` |  
| `Add-OMSGatewayAllowedClientCertificate` |Субъект (обязательно) |Добавляет субъект сертификата клиента в список разрешенных |`Add-OMSGatewayAllowed`<br>`ClientCertificate` <br> `-Subject mycert` |  
| `Remove-OMSGatewayAllowedClientCertificate` |Субъект (обязательно) |Удаляет субъект сертификата клиента из списка разрешенных |`Remove-OMSGatewayAllowed` <br> `ClientCertificate` <br> `-Subject mycert` |  
| `Get-OMSGatewayAllowedClientCertificate` | |Получает в настоящее время разрешенные субъекты сертификата клиента (только локально настроенные разрешенные предметы, а не автоматически загруженные разрешенные предметы) |`Get-`<br>`OMSGatewayAllowed`<br>`ClientCertificate` |  

## <a name="troubleshooting"></a>Устранение неполадок

Для сбора событий, зарегистрированных шлюзом, необходимо установить агент Log Analytics.

![Скриншот списка просмотра событий в журнале журнала «Аналитика»](./media/gateway/event-viewer.png)

### <a name="log-analytics-gateway-event-ids-and-descriptions"></a>Идентии идентипов и инструкций и описаний событий Log Analytics Analytics

В следующей таблице показаны идентивы события и описания событий журнала Log Analytics.

| **Идентификатор** | **Описание** |
| --- | --- |
| 400 |Любая ошибка приложения, не имевававачтой конкретного идентификатора. |
| 401 |Неправильная конфигурация. Например, слушатьPort и "текст" вместо бесхозна. |
| 402 |Исключение при анализе сообщений подтверждения TLS. |
| 403 |Сетевая ошибка. Например, не удается подключиться к целевому серверу. |
| 100 |Общие сведения. |
| 101 |Служба запущена. |
| 102 |Служба остановлена. |
| 103 |От клиента была получена команда HTTP CONNECT. |
| 104 |Команда HTTP CONNECT не получена. |
| 105 |Сервер назначения не находится в разрешенном списке, или порт назначения не является безопасным (443). <br> <br> Убедитесь, что агент MMA на сервере OMS Gateway и агенты, которые общаются с OMS Gateway, подключены к тому же рабочему пространству Log Analytics. |
| 105 |ERROR TcpConnection - Недействительный сертификат клиента: CN-Gateway. <br><br> Убедитесь, что вы используете версию OMS Gateway 1.0.395.0 или больше. Также убедитесь, что агент MMA на сервере OMS Gateway и агенты, взаимодействуют с OMS Gateway, подключены к тому же рабочему пространству Log Analytics. |
| 106 |Неподдерживаемая версия протокола TLS/SSL.<br><br> Шлюз Log Analytics поддерживает только TLS 1.0, TLS 1.1 и 1.2. Он не поддерживает протокол SSL.|
| 107 |Сеанс TLS проверен. |

### <a name="performance-counters-to-collect"></a>Счетчики производительности, данные для которых необходимо собрать

В следующей таблице приведены счетчики производительности, доступные для шлюза Log Analytics. Используйте монитор производительности для добавления счетчиков.

| **Название** | **Описание** |
| --- | --- |
| Шлюз Log Analytics — Active Client Connection (Активные клиентские подключения) |Количество активных сетевых подключений клиента (TCP) |
| Шлюз Log Analytics — Error Count (Количество ошибок) |Количество ошибок |
| Шлюз Log Analytics — Connected Client (Подключенные клиенты) |Количество подключенных клиентов |
| Шлюз Log Analytics — Rejection Count (Количество отклонений) |Количество отклонений из-за любых ошибок проверки TLS |

![Скриншот интерфейса шлюза Log Analytics, показывающий счетчики производительности](./media/gateway/counters.png)

## <a name="assistance"></a>Помощь

При входе на портал Azure вы можете получить помощь с шлюзом для аналитики журналов или любой другой службой или функцией Azure.
Чтобы получить помощь, выберите значок знака вопросительных вопросов в правом верхнем углу портала и выберите **новый запрос поддержки.** Затем заполните новую форму запроса поддержки.

![Скриншот нового запроса на поддержку](./media/gateway/support.png)

## <a name="next-steps"></a>Дальнейшие действия

[Добавление источников данных](../../azure-monitor/platform/agent-data-sources.md) для сбора данных из подключенных источников и хранения данных в рабочей области Log Analytics.
