---
title: Управление рабочими областями Log Analytics в Azure Monitor | Документация Майкрософт
description: Управлять доступом к данным, хранящимся в рабочей области анализа журналов в Azure Monitor, можно использовать разрешения ресурса, рабочего пространства или таблицы. В этой статье подробно описано, как завершить.
ms.subservice: logs
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 10/22/2019
ms.openlocfilehash: 1e559309b8e8d9768ca2f79dabfb01ec6086a961
ms.sourcegitcommit: 8a9c54c82ab8f922be54fb2fcfd880815f25de77
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "80348721"
---
# <a name="manage-access-to-log-data-and-workspaces-in-azure-monitor"></a>Управление доступом к данным журнала и рабочим областям в Azure Monitor

Azure Monitor хранит данные [журналов](data-platform-logs.md) в рабочей области Log Analytics. Рабочее пространство — это контейнер, включающий данные и информацию о конфигурации. Чтобы управлять доступом к данным журнала, вы выполняете различные административные задачи, связанные с рабочим пространством.

В этой статье объясняется, как управлять доступом к журналам и администрировать рабочие области, которые их содержат, в том числе как предоставить доступ к: 

* Рабочее пространство с использованием разрешений рабочего пространства.
* Пользователи, которым необходим доступ к данным журнала из определенных ресурсов, использующих элемент управления доступом на основе ролей Azure (RBAC).
* Пользователи, которым необходим доступ к данным журнала в определенной таблице рабочей области с помощью Azure RBAC.

## <a name="configure-access-control-mode"></a>Настройка режима управления доступом

Можно просмотреть [режим управления доступом,](design-logs-deployment.md) настроенный на рабочее пространство с портала Azure или с Помощью Azure PowerShell.  Вы можете изменить эту настройку, используя один из следующих поддерживаемых методов:

* Портал Azure

* Azure PowerShell

* Шаблон Azure Resource Manager

### <a name="from-the-azure-portal"></a>на портале Azure;

Можно просмотреть текущий режим управления доступом рабочего пространства на странице **Обзор** для рабочего пространства в меню **рабочего пространства Log Analytics.**

![Просмотр режима управления доступом рабочей области](media/manage-access/view-access-control-mode.png)

1. Войти на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com).
1. На портале Azure выберите рабочие области анализа журналов > рабочее пространство.

Эту настройку можно изменить со страницы **Свойств** рабочего пространства. Изменение параметра будет отключено, если у вас нет разрешений на настройку рабочего пространства.

![Изменение режима доступа к рабочей области](media/manage-access/change-access-control-mode.png)

### <a name="using-powershell"></a>Использование PowerShell

Используйте следующую команду для изучения режима управления доступом для всех рабочих областей в подписке:

```powershell
Get-AzResource -ResourceType Microsoft.OperationalInsights/workspaces -ExpandProperties | foreach {$_.Name + ": " + $_.Properties.features.enableLogAccessUsingOnlyResourcePermissions}
```

Результат должен выглядеть так:

```
DefaultWorkspace38917: True
DefaultWorkspace21532: False
```

Значение `False` средств, настроенных на рабочее пространство, с режимом доступа рабочего пространства и контекста.  Значение `True` средств, настроенное рабочее пространство с режимом доступа к ресурсно-контексту.

> [!NOTE]
> Если рабочее пространство возвращается без значения boolean и является пустым, это также соответствует результатам `False` значения.
>

Используйте следующий сценарий для настройки режима управления доступом для определенного рабочего пространства для разрешения ресурс-контекста:

```powershell
$WSName = "my-workspace"
$Workspace = Get-AzResource -Name $WSName -ExpandProperties
if ($Workspace.Properties.features.enableLogAccessUsingOnlyResourcePermissions -eq $null)
    { $Workspace.Properties.features | Add-Member enableLogAccessUsingOnlyResourcePermissions $true -Force }
else
    { $Workspace.Properties.features.enableLogAccessUsingOnlyResourcePermissions = $true }
Set-AzResource -ResourceId $Workspace.ResourceId -Properties $Workspace.Properties -Force
```

Используйте следующий скрипт для настройки режима управления доступом для всех рабочих областей в подписке на разрешение ресурс-контекст:

```powershell
Get-AzResource -ResourceType Microsoft.OperationalInsights/workspaces -ExpandProperties | foreach {
if ($_.Properties.features.enableLogAccessUsingOnlyResourcePermissions -eq $null)
    { $_.Properties.features | Add-Member enableLogAccessUsingOnlyResourcePermissions $true -Force }
else
    { $_.Properties.features.enableLogAccessUsingOnlyResourcePermissions = $true }
Set-AzResource -ResourceId $_.ResourceId -Properties $_.Properties -Force
}
```

### <a name="using-a-resource-manager-template"></a>Использование шаблона менеджера ресурсов

Чтобы настроить режим доступа в шаблон Azure Resource Manager, установите флаг функции **включенияLogAccessUsingOnlyResourcePermissions** на рабочем пространстве на одно из следующих значений.

* **ложное**: Установите рабочее пространство в разрешения рабочего пространства и контекста. Это параметр по умолчанию, если флаг не установлен.
* **true**: Установите рабочее пространство на разрешения ресурс-контекст.

## <a name="manage-access-using-workspace-permissions"></a>Управление доступом с помощью разрешений рабочего пространства

Каждая рабочая область может включать учетных записей, каждая из которых может иметь доступ к нескольким рабочим областям. Доступ управляется с помощью [ролевой доступности Azure.](../../role-based-access-control/role-assignments-portal.md)

Разрешения Azure также требуются для следующих действий:

|Действие |Требуются разрешения Azure |Примечания |
|-------|-------------------------|------|
| Добавление и удаление решений мониторинга | `Microsoft.Resources/deployments/*` <br> `Microsoft.OperationalInsights/*` <br> `Microsoft.OperationsManagement/*` <br> `Microsoft.Automation/*` <br> `Microsoft.Resources/deployments/*/write` | Эти разрешения нужно предоставить на уровне группы ресурсов или подписки. |
| Изменение ценовой категории | `Microsoft.OperationalInsights/workspaces/*/write` | |
| Просмотр данных на плитках *службы архивации* и *службы Site Recovery* | Администратор или соадминистратор | Имеет доступ к ресурсам, развернутым с использованием классической модели развертывания |
| Создание рабочей области на портале Azure | `Microsoft.Resources/deployments/*` <br> `Microsoft.OperationalInsights/workspaces/*` ||
| Просмотр основных свойств рабочей области и введите лезвие рабочего пространства на портале | `Microsoft.OperationalInsights/workspaces/read` ||
| Журналы запросов с использованием любого интерфейса | `Microsoft.OperationalInsights/workspaces/query/read` ||
| Доступ ко всем типам журналов с помощью запросов | `Microsoft.OperationalInsights/workspaces/query/*/read` ||
| Доступ к определенной таблице журнала | `Microsoft.OperationalInsights/workspaces/query/<table_name>/read` ||
| Ознакомьте ключи рабочего пространства, чтобы разрешить отправку журналов в это рабочее пространство | `Microsoft.OperationalInsights/workspaces/sharedKeys/action` ||

## <a name="manage-access-using-azure-permissions"></a>Управление доступом с помощью разрешений Azure

Чтобы предоставить доступ к рабочей области Log Analytics с помощью разрешений Azure, следуйте указаниям в статье [Использование назначений ролей для управления доступом к ресурсам в подписке Azure](../../role-based-access-control/role-assignments-portal.md). Например, пользовательские роли [см.](#custom-role-examples)

В Azure доступны две встроенные роли пользователя для рабочих областей Log Analytics:

* читатель Log Analytics;
* участник Log Analytics.

Членам роли *Читатель Log Analytics* доступны следующие действия:

* просмотр и поиск всех данных мониторинга;
* просмотр параметров мониторинга, в том числе просмотр конфигурации диагностики Azure на всех ресурсах Azure.

Роль читателя Log Analytics включает следующие действия Azure:

| Тип    | Разрешение | Описание |
| ------- | ---------- | ----------- |
| Действие | `*/read`   | Возможность просматривать все ресурсы Azure и их конфигурацию. Включает просмотр следующих данных: <br> состояние расширения виртуальной машины; <br> конфигурация диагностики Azure на ресурсах; <br> Все свойства и настройки всех ресурсов. <br> Для рабочих областей он позволяет полностью неограниченные разрешения считывать настройки рабочего пространства и выполнять запрос на данных. Смотрите больше детальных вариантов выше. |
| Действие | `Microsoft.OperationalInsights/workspaces/analytics/query/action` | Унижается, не нужно присваивать их пользователям. |
| Действие | `Microsoft.OperationalInsights/workspaces/search/action` | Унижается, не нужно присваивать их пользователям. |
| Действие | `Microsoft.Support/*` | Возможность создавать обращения в службу поддержки. |
|Запрет действия | `Microsoft.OperationalInsights/workspaces/sharedKeys/read` | Запрет на чтение ключа рабочей области, необходимого для использования API сбора данных и для установки агентов. Это предотвращает добавление новых ресурсов в рабочую область |

Членам роли *Участник Log Analytics* доступны следующие действия:

* Включает в себя все привилегии *роли читателя журнала Analytics,* позволяя пользователю читать все данные мониторинга
* Создание и настройка учетных записей автоматизации
* Добавление и удаление решений по управлению.

    > [!NOTE]
    > Чтобы выполнять последние два действия, нужно предоставить разрешение на уровне группы ресурсов или подписки.

* Читать ключи учетной записи хранилища
* Настройка коллекции журналов из хранилища Azure
* изменение параметров мониторинга ресурсов Azure, в том числе:
  * добавление расширения виртуальных машин на виртуальные машины;
  * настройка диагностики Azure на всех ресурсах Azure.

> [!NOTE]
> Можно добавить расширение виртуальной машины на виртуальную машину, чтобы получить полный контроль над ней.

Роль участника Log Analytics включает следующие действия Azure:

| Разрешение | Описание |
| ---------- | ----------- |
| `*/read`     | Возможность просматривать все ресурсы и конфигурацию ресурсов. Включает просмотр следующих данных: <br> состояние расширения виртуальной машины; <br> конфигурация диагностики Azure на ресурсах; <br> Все свойства и настройки всех ресурсов. <br> Для рабочих областей он позволяет полностью неограниченные разрешения считывать настройки рабочего пространства и выполнять запрос на данных. Смотрите больше детальных вариантов выше. |
| `Microsoft.Automation/automationAccounts/*` | Возможность создания и настройки учетных записей службы автоматизации Azure, в том числе добавление и изменение модулей Runbook. |
| `Microsoft.ClassicCompute/virtualMachines/extensions/*` <br> `Microsoft.Compute/virtualMachines/extensions/*` | Добавление, обновление и удаление расширений виртуальных машин, в том числе расширения Microsoft Monitoring Agent и агента OMS для расширения Linux. |
| `Microsoft.ClassicStorage/storageAccounts/listKeys/action` <br> `Microsoft.Storage/storageAccounts/listKeys/action` | Просмотр ключа учетной записи хранения. Эта возможность необходима для настройки в Log Analytics чтения журналов из учетных записей хранения Azure. |
| `Microsoft.Insights/alertRules/*` | Добавление, обновление и удаление правил генерации оповещений. |
| `Microsoft.Insights/diagnosticSettings/*` | Добавление, обновление и удаление параметров диагностики в ресурсах Azure. |
| `Microsoft.OperationalInsights/*` | Добавление, обновление и удаление конфигурации для рабочих областей log Analytics. Для отсечения расширенных `Microsoft.OperationalInsights/workspaces/write`параметров рабочего пространства пользователю необходимо. |
| `Microsoft.OperationsManagement/*` | Добавление и удаление решений по управлению. |
| `Microsoft.Resources/deployments/*` | Создание и удаление развертываний. Требуется для добавления и удаления решений, рабочих областей и учетных записей службы автоматизации. |
| `Microsoft.Resources/subscriptions/resourcegroups/deployments/*` | Создание и удаление развертываний. Требуется для добавления и удаления решений, рабочих областей и учетных записей службы автоматизации. |

Чтобы добавить пользователей в роль или удалить их из нее, требуются разрешения `Microsoft.Authorization/*/Delete` и `Microsoft.Authorization/*/Write`.

С помощью этих ролей можно предоставлять пользователям доступ к различным областям:

* Подписка — доступ ко всем рабочим областям в подписке.
* Группа ресурсов — доступ ко всем рабочим областям в группе ресурсов.
* Ресурс — доступ к только указанной рабочей области.

Мы рекомендуем выполнять задания на уровне ресурсов (рабочее пространство) для обеспечения точного контроля доступа. Используйте [пользовательские роли](../../role-based-access-control/custom-roles.md) для создания ролей с определенными разрешениями.

### <a name="resource-permissions"></a>Разрешения ресурсов

Когда пользователи загоняют журналы из рабочего пространства с помощью доступа к ресурсу и контексту, они будут иметь следующие разрешения на ресурсе:

| Разрешение | Описание |
| ---------- | ----------- |
| `Microsoft.Insights/logs/<tableName>/read`<br><br>Примеры:<br>`Microsoft.Insights/logs/*/read`<br>`Microsoft.Insights/logs/Heartbeat/read` | Возможность просмотра всех данных журнала для ресурса.  |
| `Microsoft.Insights/diagnosticSettings/write` | Возможность настройки диагностики позволяет настраивать журналы для этого ресурса. |

`/read`разрешение обычно выдается от роли, которая _\*_ включает _ \*/читать или_ разрешения, такие как встроенные роли [Reader](../../role-based-access-control/built-in-roles.md#reader) и [Contributor.](../../role-based-access-control/built-in-roles.md#contributor) Пользовательские роли, включающие определенные действия или выделенные встроенные роли, могут не включать это разрешение.

Ниже [приведено определение элемента управления доступом на стол](#table-level-rbac) ниже, если требуется создать различный элемент управления доступом для разных таблиц.

## <a name="custom-role-examples"></a>Примеры пользовательских ролей

1. Чтобы предоставить пользователю доступ к данным журнала из своих ресурсов, выполните следующие:

    * Настройка режима управления доступом рабочего пространства для **использования рабочих мест или разрешений ресурсов**

    * Предоставлять `*/read` пользователям `Microsoft.Insights/logs/*/read` или разрешения на их ресурсы. Если им уже назначена роль [читателя анализа журналов](../../role-based-access-control/built-in-roles.md#reader) в рабочем пространстве, этого достаточно.

2. Чтобы предоставить пользователю доступ к данным журналов из своих ресурсов и настроить свои ресурсы для отправки журналов в рабочее пространство, выполните следующее:

    * Настройка режима управления доступом рабочего пространства для **использования рабочих мест или разрешений ресурсов**

    * Предоставить пользователям следующие разрешения на `Microsoft.OperationalInsights/workspaces/read` `Microsoft.OperationalInsights/workspaces/sharedKeys/action`рабочее пространство: и . С этими разрешениями пользователи не могут выполнять запросы на уровне рабочего пространства. Они могут только перечислить рабочее пространство и использовать его в качестве места назначения для диагностических настроек или конфигурации агента.

    * Предоставить пользователям следующие разрешения `Microsoft.Insights/logs/*/read` на `Microsoft.Insights/diagnosticSettings/write`свои ресурсы: и . Если им уже назначена роль [вкладчика в анализ журнала,](../../role-based-access-control/built-in-roles.md#contributor) назначена роль читателя или выданы `*/read` разрешения на этот ресурс, этого достаточно.

3. Чтобы предоставить пользователю доступ к данным журнала из своих ресурсов, не имея возможности читать события безопасности и отправлять данные, выполните следующие:

    * Настройка режима управления доступом рабочего пространства для **использования рабочих мест или разрешений ресурсов**

    * Предоставить пользователям следующие разрешения `Microsoft.Insights/logs/*/read`на их ресурсы: .

    * Добавьте следующее NonAction, чтобы заблокировать `Microsoft.Insights/logs/SecurityEvent/read`пользователей от чтения типа SecurityEvent: . NonAction должен быть в той же пользовательской роли,`Microsoft.Insights/logs/*/read`что и действие, которое предоставляет разрешение на чтение (). Если пользователю присущо действие чтения из другой роли, назначенной этому ресурсу или группе подписки или ресурса, он сможет читать все типы журналов. Это также верно, `*/read`если они наследуют , которые существуют, например, с Reader или Вкладчик роль.

4. Чтобы предоставить пользователю доступ к данным журнала из своих ресурсов и прочитать все данные системы входа в систему Azure AD и прочитать данные системы управления обновлением из рабочей области, выполните следующие:

    * Настройка режима управления доступом рабочего пространства для **использования рабочих мест или разрешений ресурсов**

    * Предоставить пользователям следующие разрешения на рабочее пространство: 

        * `Microsoft.OperationalInsights/workspaces/read`Требуется, чтобы использование можно перечисляло рабочее пространство и открывало лопасти рабочего пространства на портале Azure
        * `Microsoft.OperationalInsights/workspaces/query/read`- требуется для каждого пользователя, который может выполнять запросы
        * `Microsoft.OperationalInsights/workspaces/query/SigninLogs/read`- чтобы иметь возможность читать журналы входа azure AD
        * `Microsoft.OperationalInsights/workspaces/query/Update/read`- чтобы иметь возможность читать журналы решений управления обновлением
        * `Microsoft.OperationalInsights/workspaces/query/UpdateRunProgress/read`- чтобы иметь возможность читать журналы решений управления обновлением
        * `Microsoft.OperationalInsights/workspaces/query/UpdateSummary/read`- чтобы иметь возможность читать журналы управления обновлениями
        * `Microsoft.OperationalInsights/workspaces/query/Heartbeat/read`Требуется, чтобы иметь возможность использовать решение управления обновлением
        * `Microsoft.OperationalInsights/workspaces/query/ComputerGroup/read`Требуется, чтобы иметь возможность использовать решение управления обновлением

    * Предоставить пользователям следующие разрешения `*/read`на их ресурсы: , `Microsoft.Insights/logs/*/read`назначенной роли читателя, или . 

## <a name="table-level-rbac"></a>Таблица уровня RBAC

**Уровень таблицы RBAC** позволяет определить более детальный контроль с данными в рабочей области Log Analytics в дополнение к другим разрешениям. Этот элемент управления позволяет определить определенные типы данных, которые доступны только определенному набору пользователей.

Элемент управления доступом к таблицам с [пользовательскими ролями Azure](../../role-based-access-control/custom-roles.md) предоставляется либо для предоставления доступа к определенным [таблицам](../log-query/logs-structure.md) в рабочей области. Эти роли применяются к рабочим пространствам с [режимами управления доступом](design-logs-deployment.md#access-control-mode) рабочего пространства-контекста или ресурсно-контекстного доступа, независимо от [режима доступа](design-logs-deployment.md#access-mode)пользователя.

Создайте [пользовательскую роль](../../role-based-access-control/custom-roles.md) со следующими действиями для определения доступа к управлению доступом к таблице.

* Чтобы предоставить доступ к таблице, включите ее в раздел **«Действия»** определения роли. Чтобы вычесть доступ из разрешенных **действий,** включите его в раздел **NotActions.**
* Для обоуказания все таблицы используйте Microsoft.OperationalInsights/workspaces/query/'.

Например, чтобы создать роль с доступом к таблицам _Heartbeat_ и _AzureActivity,_ создайте пользовательскую роль, используя следующие действия:

```
"Actions":  [
    "Microsoft.OperationalInsights/workspaces/read",
    "Microsoft.OperationalInsights/workspaces/query/read",
    "Microsoft.OperationalInsights/workspaces/query/Heartbeat/read",
    "Microsoft.OperationalInsights/workspaces/query/AzureActivity/read"
  ],
```

Чтобы создать роль с доступом только к таблице _SecurityBaseline,_ создайте пользовательскую роль, используя следующие действия:

```
"Actions":  [
    "Microsoft.OperationalInsights/workspaces/read",
    "Microsoft.OperationalInsights/workspaces/query/read",
    "Microsoft.OperationalInsights/workspaces/query/SecurityBaseline/read"
],
```

### <a name="custom-logs"></a>Пользовательские журналы

 Пользовательские журналы создаются из источников данных, таких как пользовательские журналы и API http Data Collector. Самый простой способ определить тип журнала, проверяя таблицы, [перечисленные в пользовательских журналах в схеме журнала.](../log-query/get-started-portal.md#understand-the-schema)

 В настоящее время вы не можете предоставить доступ к отдельным пользовательским журналам, но вы можете предоставить доступ ко всем пользовательским журналам. Чтобы создать роль с доступом ко всем пользовательским журналам, создайте пользовательскую роль, используя следующие действия:

```
"Actions":  [
    "Microsoft.OperationalInsights/workspaces/read",
    "Microsoft.OperationalInsights/workspaces/query/read",
    "Microsoft.OperationalInsights/workspaces/query/Tables.Custom/read"
],
```

### <a name="considerations"></a>Рекомендации

* Если пользователю будет предоставлено глобальное разрешение на чтение со стандартными ролями Reader или Contributor, которые включают _ \*действие/чтение,_ он переопределяет элемент управления доступом к таблице и даст ему доступ ко всем данным журнала.
* Если пользователю предоставляется доступ к таблице, но нет других разрешений, он сможет получить доступ к данным журнала с API, но не с портала Azure. Чтобы обеспечить доступ с портала Azure, используйте в качестве базовой роли Reader Log Analytics Reader.
* Администраторы подписки будут иметь доступ ко всем типам данных, независимо от других настроек разрешения.
* Владельцы рабочего пространства рассматриваются как любой другой пользователь для управления доступом к столу.
* Мы рекомендуем назначать роли группам безопасности, а не отдельным пользователям, чтобы уменьшить количество назначений. Это также поможет вам использовать существующие инструменты управления группами для настройки и проверки доступа.

## <a name="next-steps"></a>Дальнейшие действия

* Сведения о сборе данных с компьютеров в центре обработки данных или в другой облачной среде см в статье об [агенте Log Analytics](../../azure-monitor/platform/log-analytics-agent.md).

* [См. Сбор данных о виртуальных машинах Azure](../../azure-monitor/learn/quick-collect-azurevm.md) для настройки сбора данных с Виртуальных Технологий Azure.
