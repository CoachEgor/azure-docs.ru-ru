---
title: Устранение неполадок с оповещениями журнала в Azure Monitor | Документация Майкрософт
description: Распространенные проблемы, ошибки и способы их устранения для правил генерации оповещений журнала в Azure.
author: yanivlavi
ms.author: yalavi
ms.topic: conceptual
ms.subservice: alerts
ms.date: 10/29/2018
ms.openlocfilehash: acb9784b745fa90fc9cd264162930020e6d64751
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "79249039"
---
# <a name="troubleshoot-log-alerts-in-azure-monitor"></a>Устранение неполадок с оповещениями журнала в Azure Monitor  

В этой статье показано, как устранить распространенные проблемы, которые могут возникнуть при настройке оповещений журнала в Azure Monitor. Он также предоставляет решения распространенных проблем с функциональностью или конфигурацией оповещений журнала.

Термин *оповещения журнала* описывает правила, которые срабатывают на основе запроса журнала в [рабочей области Azure Log Analytics](../learn/tutorial-viewdata.md) или в [Application Insights Azure](../../azure-monitor/app/analytics.md). Узнайте больше о функциональных возможностях, терминологии и типах в [оповещениях журнала в Azure Monitor](../platform/alerts-unified-log.md).

> [!NOTE]
> В этой статье не рассматриваются случаи, когда в портал Azure показано срабатывание правила генерации оповещений, а уведомление не выполняется связанной группой действий. В таких случаях см. Дополнительные сведения в разделе [Создание групп действий и управление ими в портал Azure](../platform/action-groups.md).

## <a name="log-alert-didnt-fire"></a>Оповещение журналов не срабатывает

Ниже приведены некоторые распространенные причины, по которым состояние настроенного [правила генерации оповещений журнала в Azure Monitor](../platform/alerts-log.md) не отображается [, когда ожидается *fired* ](../platform/alerts-managing-alert-states.md).

### <a name="data-ingestion-time-for-logs"></a>Время приема данных для журналов

Оповещение журнала периодически выполняет запрос на основе [log Analytics](../learn/tutorial-viewdata.md) или [Application Insights](../../azure-monitor/app/analytics.md). Поскольку Azure Monitor обрабатывает много терабайтов данных от тысяч клиентов из различных источников по всему миру, служба подвержена различным временным задержкам. Дополнительные сведения см. [в разделе время приема данных в журналах Azure Monitor](../platform/data-ingestion-time.md).

Чтобы устранить задержки, система ожидает и повторяет запрос предупреждения несколько раз, если он находит необходимые данные еще не приняты. Система имеет экспоненциально возрастающее время ожидания. Оповещение журнала активируется только после того, как данные доступны, поэтому задержка может быть вызвана медленным приемом данных журнала.

### <a name="incorrect-time-period-configured"></a>Неправильно настроен период времени

Как описано в статье о [терминологии для оповещений журнала](../platform/alerts-unified-log.md#log-search-alert-rule---definition-and-types), период времени, указанный в конфигурации, указывает диапазон времени для запроса. Запрос возвращает только записи, созданные в этом диапазоне.

Период времени позволяет ограничить данные, полученные для запроса журнала, чтобы предотвратить нарушение, и она обходит любую команду времени (например, **назад**), используемую в запросе журнала. Например, если задан период 60 минут, а запрос выполняется в 13:15, то для запроса журнала используются только записи, созданные между 12:15 и 13:15. Если в запросе журнала используется команда времени, например **назад (1d)**, запрос по-прежнему использует данные только между 12:15 pm и 1:15 PM, так как для периода времени задан этот интервал.

Убедитесь, что период времени в конфигурации совпадает с вашим запросом. В приведенном выше примере, если в запросе к журналу используется **назад (1d)** с зеленым маркером, то период времени должен быть установлен в 24 часа или 1 440 минут (обозначен красным цветом). Этот параметр гарантирует, что запрос выполняется должным образом.

![Период времени](media/alert-log-troubleshoot/LogAlertTimePeriod.png)

### <a name="suppress-alerts-option-is-set"></a>Настроена отмена вывода оповещений

Как описано в шаге 8 статьи о [создании правила генерации оповещений журнала в портал Azure](../platform/alerts-log.md#managing-log-alerts-from-the-azure-portal), оповещения журнала предоставляют параметр **подавлять предупреждения** , чтобы отключить триггеры и действия уведомлений в течение заданного промежутка времени. В результате вы можете подумать, что предупреждение не порождается. Фактически он был вызван, но был подавлен.  

![Отменить вывод оповещений](media/alert-log-troubleshoot/LogAlertSuppress.png)

### <a name="metric-measurement-alert-rule-is-incorrect"></a>Неправильно настроено правило генерации оповещений "Измерение метрик"

*Оповещения журнала измерения метрик* — это подтипы оповещений журнала с особыми возможностями и синтаксисом запросов предупреждений с ограниченным доступом. Правило для оповещения журнала измерения метрики требует, чтобы выходные данные запроса были метрикой временных рядов. Таким образом, выходные данные представляют собой таблицу с разными и соответствующими статистическими значениями.

Можно выбрать дополнительные переменные в таблице рядом с **AggregatedValue**. Эти переменные можно использовать для сортировки таблицы.

Например, предположим, что правило для оповещения журнала измерения метрики было настроено следующим образом:

- Запрос`search *| summarize AggregatedValue = count() by $table, bin(timestamp, 1h)`  
- Период времени 6 часов
- Пороговое значение 50
- Логика генерации оповещений трех последовательных нарушений
- **Статистическое выражение** по выбранному **$Table**

Так как команда включает **сводку... по** и предоставляет две переменные (**timestamp** и **$Table**), система выбирает **$Table** для **статистической обработки**. Система сортирует таблицу результатов по полю **$Table** , как показано на следующем снимке экрана. Затем он рассматривает несколько экземпляров **AggregatedValue** для каждого типа таблицы (например, **availabilityResults**), чтобы проверить наличие трех или более последовательных нарушений.

![Выполнение запроса измерения метрики с несколькими значениями](media/alert-log-troubleshoot/LogMMQuery.png)

Поскольку **функция Aggregate** on определена для **$Table**, данные сортируются по столбцу **$Table** (обозначен красным цветом). Затем мы будем группировать и искать типы поля « **Статистическая обработка** ».

Например, для **$Table**значения для **availabilityResults** будут рассматриваться как один график или сущность (обозначенные оранжевым цветом). В этом графике значений или сущностях служба оповещений проверяет наличие трех последовательных нарушений (отмеченных зеленым цветом). Нарушение активирует предупреждение для значения таблицы **availabilityResults**.

Аналогичным образом, если для любого другого значения **$Table**происходит три последовательных нарушения, то для того же самого будет активировано еще одно уведомление о предупреждении. Служба оповещений автоматически сортирует значения в одной диаграмме или сущности (обозначены оранжевым цветом) по времени.

Теперь предположим, что правило для оповещения журнала измерения метрики было изменено, а запрос `search *| summarize AggregatedValue = count() by bin(timestamp, 1h)`был. Остальная часть конфигурации осталась такой же, как и ранее, включая логику оповещений для трех последовательных нарушений. По умолчанию параметр « **Статистическая обработка** по» в данном случае имеет значение **timestamp** . В запросе для суммирования указывается только одно значение **... по** (то есть **метке времени**). Как и в предыдущем примере, выходные данные в конце выполнения будут выглядеть так, как показано ниже.

   ![Выполнение запроса измерения метрики с использованием единственного значения](media/alert-log-troubleshoot/LogMMtimestamp.png)

Поскольку **функция Aggregate** on определена для **отметки времени**, данные сортируются по столбцу **timestamp** (обозначен красным цветом). Затем мы сгруппированы по **метке времени**. Например, значения для `2018-10-17T06:00:00Z` будут рассматриваться как один график или сущность (обозначенные оранжевым цветом). В этом графике или сущности значения служба оповещений не обнаружит последовательных нарушений (так как каждое значение **метки времени** имеет только одну запись). Поэтому оповещение никогда не запускается. В этом случае пользователь должен либо:

- Добавьте фиктивную переменную или существующую переменную (например, **$Table**) для правильной сортировки с помощью поля **Статистическая обработка** по.
- Перенастройте правило генерации оповещений, чтобы использовать логику оповещений на основе **общего нарушения** .

## <a name="log-alert-fired-unnecessarily"></a>Оповещение журналов срабатывает без необходимости

Настроенное [правило генерации оповещений журнала в Azure Monitor](../platform/alerts-log.md) может быть неожиданно запущено при его просмотре в [оповещениях Azure](../platform/alerts-managing-alert-states.md). В следующих разделах описываются некоторые распространенные причины.

### <a name="alert-triggered-by-partial-data"></a>Предупреждение активируется по частичным данным

Log Analytics и Application Insights подчиняются задержкам приема и обработке. При запуске запроса на оповещение журнала может оказаться, что данные недоступны или доступны только некоторые данные. Дополнительные сведения см. [в разделе время приема данных журнала в Azure Monitor](../platform/data-ingestion-time.md).

В зависимости от того, как вы настроили правило генерации оповещений, ошибка может возникнуть, если во время выполнения оповещения в журналах нет данных или частичных данных. В таких случаях мы рекомендуем изменить запрос или конфигурацию предупреждения.

Например, если настроить правило генерации оповещений для триггера, если количество результатов в запросе аналитики меньше 5, оповещение активируется при отсутствии данных (нулевой записи) или частичных результатов (одна запись). Но после задержки приема данных один и тот же запрос с полными данными может предоставить результат из 10 записей.

### <a name="alert-query-output-is-misunderstood"></a>Выходные данные запроса предупреждений непонятны

Вы предоставляете логику для оповещений журнала в аналитическом запросе. Аналитический запрос может использовать различные большие данные и математические функции. Служба оповещений выполняет запрос с интервалами, указанными в данных за указанный период времени. Служба оповещений вносит незначительные изменения в запрос на основе типа оповещения. Это изменение можно просмотреть в разделе **запрос для выполнения** на экране **Настройка логики сигнала** :

![Выполняемый запрос](media/alert-log-troubleshoot/LogAlertPreview.png)

В поле **запрос для выполнения** запустится служба оповещения журнала. Если вы хотите разобраться с результатами запроса предупреждений перед созданием предупреждения, можно выполнить указанный запрос и интервал времени с помощью [портала аналитики](../log-query/portals.md) или [API аналитики](https://docs.microsoft.com/rest/api/loganalytics/).

## <a name="log-alert-was-disabled"></a>Оповещение журнала отключено

В следующих разделах перечислены некоторые причины, по которым Azure Monitor может отключить [правило оповещения журнала](../platform/alerts-log.md).

### <a name="resource-where-the-alert-was-created-no-longer-exists"></a>Ресурс, в котором создано оповещение, больше не существует

Правила генерации оповещений журнала, созданные в Azure Monitor нацелены на конкретный ресурс, такой как Рабочая область Log Analytics Azure, приложение Azure Application Insights и ресурс Azure. Затем служба оповещений журнала запустит аналитический запрос, указанный в правиле для указанного целевого объекта. Но после создания правила пользователи часто переходят к разделу Удаление из Azure — или перемещение в Azure — целевой объект правила оповещения журнала. Так как целевой объект правила генерации оповещений больше не действителен, выполнение правила завершается ошибкой.

В таких случаях Azure Monitor отключает оповещение журнала и гарантирует, что плата не будет взиматься без необходимости, если правило не может выполняться постоянно в течение указанного периода (например, в неделю). Вы можете узнать точное время, когда Azure Monitor отключил оповещение журнала с помощью [журнала действий Azure](../../azure-resource-manager/management/view-activity-logs.md). В журнале действий Azure событие добавляется, когда Azure Monitor отключает правило оповещения журнала.

Следующий пример события в журнале действий Azure предназначен для правила генерации оповещений, которое было отключено из-за непрерывного сбоя.

```json
{
    "caller": "Microsoft.Insights/ScheduledQueryRules",
    "channels": "Operation",
    "claims": {
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/spn": "Microsoft.Insights/ScheduledQueryRules"
    },
    "correlationId": "abcdefg-4d12-1234-4256-21233554aff",
    "description": "Alert: test-bad-alerts is disabled by the System due to : Alert has been failing consistently with the same exception for the past week",
    "eventDataId": "f123e07-bf45-1234-4565-123a123455b",
    "eventName": {
        "value": "",
        "localizedValue": ""
    },
    "category": {
        "value": "Administrative",
        "localizedValue": "Administrative"
    },
    "eventTimestamp": "2019-03-22T04:18:22.8569543Z",
    "id": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
    "level": "Informational",
    "operationId": "",
    "operationName": {
        "value": "Microsoft.Insights/ScheduledQueryRules/disable/action",
        "localizedValue": "Microsoft.Insights/ScheduledQueryRules/disable/action"
    },
    "resourceGroupName": "<Resource Group>",
    "resourceProviderName": {
        "value": "MICROSOFT.INSIGHTS",
        "localizedValue": "Microsoft Insights"
    },
    "resourceType": {
        "value": "MICROSOFT.INSIGHTS/scheduledqueryrules",
        "localizedValue": "MICROSOFT.INSIGHTS/scheduledqueryrules"
    },
    "resourceId": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
    "status": {
        "value": "Succeeded",
        "localizedValue": "Succeeded"
    },
    "subStatus": {
        "value": "",
        "localizedValue": ""
    },
    "submissionTimestamp": "2019-03-22T04:18:22.8569543Z",
    "subscriptionId": "<SubscriptionId>",
    "properties": {
        "resourceId": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
        "subscriptionId": "<SubscriptionId>",
        "resourceGroup": "<ResourceGroup>",
        "eventDataId": "12e12345-12dd-1234-8e3e-12345b7a1234",
        "eventTimeStamp": "03/22/2019 04:18:22",
        "issueStartTime": "03/22/2019 04:18:22",
        "operationName": "Microsoft.Insights/ScheduledQueryRules/disable/action",
        "status": "Succeeded",
        "reason": "Alert has been failing consistently with the same exception for the past week"
    },
    "relatedEvents": []
}
```

### <a name="query-used-in-a-log-alert-is-not-valid"></a>Недопустимый запрос, используемый в предупреждении журнала

Каждое правило генерации оповещений журнала, созданное в Azure Monitor в составе конфигурации, должно указывать аналитический запрос, который служба оповещений будет периодически запускать. Запрос аналитики может иметь правильный синтаксис во время создания или обновления правила. Но иногда в течение некоторого времени запрос, указанный в правиле оповещения журнала, может разрабатывать синтаксические проблемы и привести к сбою выполнения правила. Вот некоторые распространенные причины, по которым запрос аналитики, указанный в правиле генерации оповещений журнала, может разрабатывать ошибки:

- Запрос записывается для [выполнения на нескольких ресурсах](../log-query/cross-workspace-query.md). И один или несколько указанных ресурсов больше не существуют.
- В настроенном [предупреждении журнала типа "измерение метрик](../../azure-monitor/platform/alerts-unified-log.md#metric-measurement-alert-rules) " есть запрос на оповещение не соответствует нормам синтаксиса
- Нет потока данных для платформы аналитики. [Выполнение запроса приводит к ошибке](https://dev.loganalytics.io/documentation/Using-the-API/Errors) из-за отсутствия данных для предоставленного запроса.
- Изменения в [языке запросов](https://docs.microsoft.com/azure/kusto/query/) включают в себя измененный формат команд и функций. Поэтому запрос, указанный ранее в правиле генерации оповещений, больше не действителен.

[Помощник Azure](../../advisor/advisor-overview.md) предупредит об этом поведении. Для конкретного правила генерации оповещений журнала на помощнике Azure вы добавляете рекомендацию в категорию высокого уровня доступности с средним влиянием и описание "восстановление правила оповещения журнала для обеспечения мониторинга". Если запрос на оповещение в правиле оповещения журнала не исправить после того, как помощник Azure предоставил рекомендацию в течение семи дней, Azure Monitor отключит оповещение журнала и гарантирует, что плата не будет взиматься без необходимости, если правило не может выполняться непрерывно в течение указанного периода (например, недели).

Вы можете узнать точное время, когда Azure Monitor отключил правило оповещения журнала, выполнив поиск события в [журнале действий Azure](../../azure-resource-manager/management/view-activity-logs.md).

## <a name="next-steps"></a>Дальнейшие шаги

- Ознакомьтесь со сведениями об [оповещениях журналов в Azure](../platform/alerts-unified-log.md).
- Дополнительные сведения об [Application Insights](../../azure-monitor/app/analytics.md).
- Дополнительные сведения о [запросах журналов](../log-query/log-query-overview.md).
