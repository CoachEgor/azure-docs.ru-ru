---
title: Устранение неполадок с оповещениями журнала в Azure Monitor | Документация Майкрософт
description: Распространенные проблемы, ошибки и разрешение для правил генерации оповещений журнала в Azure.
author: msvijayn
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 10/29/2018
ms.author: vinagara
ms.subservice: alerts
ms.openlocfilehash: 0c7189f1d43a114532b30b0c1aabe6f7cd4402d8
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60775990"
---
# <a name="troubleshooting-log-alerts-in-azure-monitor"></a>Устранение неполадок с оповещениями журналов в Azure Monitor  

## <a name="overview"></a>Обзор

В этой статье показано, как устранить распространенные проблемы, возникающие при настройке оповещений журнала в Azure Monitor. Здесь также приведены ответы на часто задаваемые вопросы о работе и настройке оповещений журналов. 

Термин **оповещений журнала** описываются оповещения, что огня на основе журнала запроса в [рабочей области Log Analytics](../learn/tutorial-viewdata.md) или [Application Insights](../../azure-monitor/app/analytics.md). Дополнительные сведения о функциях, терминологии и типах см. в статье [Оповещения журнала в Azure Monitor](../platform/alerts-unified-log.md).

> [!NOTE]
> В этой статье не рассматриваются случаи, когда правило генерации оповещений отображается на портале Azure как активированное и отправляет уведомление через связанные группы действий. В таких случаях см. сведения о [группах действий](../platform/action-groups.md).

## <a name="log-alert-didnt-fire"></a>Оповещение журналов не срабатывает

Ниже приведены некоторые распространенные причины, почему настроенное [правило оповещения журнала в Azure Monitor](../platform/alerts-log.md) не отображает состояние [как *Инициировано* в предполагаемое время](../platform/alerts-managing-alert-states.md). 

### <a name="data-ingestion-time-for-logs"></a>Время приема данных для журналов

Оповещения журналов периодически выполняют запросы через [Log Analytics](../learn/tutorial-viewdata.md) или [Application Insights](../../azure-monitor/app/analytics.md). Так как Azure Monitor обрабатывает многие терабайты данных от тысяч клиентов из различных источников по всему миру, служба делает возможной различной задержкой. Дополнительные сведения см. в разделе [время приема данных в журналах Azure Monitor](../platform/data-ingestion-time.md).

Чтобы избежать задержки приема данных, система ждет и повторяет запрос предупреждения несколько раз, если обнаруживает, что необходимые данные еще не поступают. Система имеет экспоненциально возрастающее время ожидания. Предупреждение о регистрации журнала запускается только после того, как данные доступны, поэтому они могут задерживаться из-за медленного приема данных журнала. 

### <a name="incorrect-time-period-configured"></a>Неправильно настроен период времени

Как описано в статье с [терминологией для оповещений журналов](../platform/alerts-unified-log.md#log-search-alert-rule---definition-and-types), настроенный в конфигурации период времени определяет диапазон времени для запроса. Запрос возвращает только те записи, которые были созданы в указанный период времени. Период ограничивает данные, полученные при запросе журнала, чтобы предотвратить нарушения, и обходит любую команду времени (например, *ago*), используемую в запросе журнала. Например, если задан период 60 минут, а запрос выполняется в 13:15, то для запроса журнала используются только записи, созданные между 12:15 и 13:15. Если журнал запроса использует команду времени *ago (1d)*, запрос будет по прежнему использовать данные в диапазоне 12:15 и 1:15, так как в интервале задан этот период времени*.

Таким образом проверка этого периода времени в конфигурации соответствует условиям. Для описанного выше примера, где используется команда *ago (1d)*, как отмечено зеленым маркером, период времени должен составлять 24 часа (1440 минут, как указано красным цветом), чтобы результат выполнения такого запроса выполнятся, как ожидается.

![Период времени](media/alert-log-troubleshoot/LogAlertTimePeriod.png)

### <a name="suppress-alerts-option-is-set"></a>Настроена отмена вывода оповещений

Как описано в шаге 8 о создании [правил генерации оповещений для поиска по журналам на портале Azure](../platform/alerts-log.md#managing-log-alerts-from-the-azure-portal), оповещения журнала содержат параметр **отключения оповещений**, отключающий действия оповещения и уведомления в течении заданного времени. Таким образом, может показаться, что оповещения не срабатывают, хотя на самом деле они были отключены.  

![Отключение оповещений](media/alert-log-troubleshoot/LogAlertSuppress.png)

### <a name="metric-measurement-alert-rule-is-incorrect"></a>Неправильно настроено правило генерации оповещений "Измерение метрик"

**Оповещения журнала измерения метрик** являются подтипом оповещений журнала, которые обладают специальными возможностями и ограниченным синтаксисом запроса оповещений. Правило генерации оповещений журналов "Измерение метрик" требует, чтобы выходные данные запроса предоставляли временные ряды метрик, то есть таблицу с равномерно распределенными периодами времени и агрегированными значениями. Кроме того, пользователи могут настроить дополнительные переменные в таблице наряду с AggregatedValue. Эти переменные могут использоваться для сортировки таблицы. 

Предположим, что мы настроили такое правило генерации оповещений журнала с типом "Измерение метрик", как показано ниже:

- выполняемый запрос: `search *| summarize AggregatedValue = count() by $table, bin(timestamp, 1h)`;  
- период времени: 6 часов;
- пороговое значение: 50;
- логика оповещений: три последовательных нарушения;
- статистическое выражение (Aggregate Upon): $table.

Так как команда содержит *summarize … by* и предоставляет две переменные (timestamp и $table), система выберет $table в качестве *Aggregate Upon*. В итоге таблица результатов будет отсортирована по полю *$table*, как показано ниже, и по этим результатам будет выполнена проверка значений AggregatedValue для каждой таблицы (например, availabilityResults) в поисках 3 и более последовательных нарушений.

![Запрос "Измерение метрик" для нескольких значений](media/alert-log-troubleshoot/LogMMQuery.png)

Так как для статистического выражения *Aggregate Upon* выбрано значение *$table*, данные сортируются по столбцу $table (обозначено КРАСНЫМ цветом) и группируются, после чего по полю *Aggregate Upon* (т. е. $table) выполняется поиск типов. Например, все значения для availabilityResults будут считаться одним графиком или сущностью (как обозначено оранжевым цветом). Именно по этому графику или сущности служба уведомлений ищет три последовательных нарушения (как обозначено зеленым цветом), по которым и будут активированы уведомления для значения таблицы availabilityResults. Аналогичным образом, если будут обнаружены три последовательных нарушения для любого другого значения $table, для них создается дополнительное уведомление с автоматической сортировкой значений каждого графика (сущности) по времени, как показано оранжевым цветом.

Теперь предположим, что для этого правила генерации оповещений "Измерение метрик" мы указали запрос `search *| summarize AggregatedValue = count() by bin(timestamp, 1h)`, но сохранили все остальные настройки, в том числе логику оповещений при трех последовательных нарушениях. В этом случае для параметра Aggregate Upon будет выбрано значение по умолчанию timestamp. Так как в запросе для суммирования *summarize ... by* выбирается только одно значение, и теперь это будет значение *timestamp*, а выходные данные этого запроса будут выглядеть так, как показано ниже.

   ![Выполнение запроса "Измерение метрик" для одного значения](media/alert-log-troubleshoot/LogMMtimestamp.png)

Так как у параметра *Aggregate Upon* значение timestamp, данные сортируются по столбцу *timestamp* (как показано КРАСНЫМ цветом), а затем группируются по полю timestamp. В результате значения `2018-10-17T06:00:00Z` будут рассматриваться как один график (сущность), как показано оранжевым цветом. По этому графику или сущности служба оповещений не сможет обнаружить три последовательных нарушения, так как для каждого значения timestamp предоставлена только одна запись, а значит оповещение никогда не будет активировано. В таком случае у пользователя есть несколько вариантов:

- добавить фиктивную переменную или применить существующую переменную (например, $table), чтобы настроить правильную сортировку с помощью поля Aggregate Upon;
- изменить правило генерации оповещений так, чтобы использовать правильную логику оповещений по полю *total breach*.

## <a name="log-alert-fired-unnecessarily"></a>Оповещение журналов срабатывает без необходимости

Ниже приведены распространенные причины того, что [правило генерации оповещений журналов в Azure Monitor](../platform/alerts-log.md) отображается в [оповещениях Azure](../platform/alerts-managing-alert-states.md) как активированное, хотя вы не ожидаете его срабатывания.

### <a name="alert-triggered-by-partial-data"></a>Предупреждение активируется по частичным данным

Log Analytics и Application Insights основываются на службе аналитики, работа которой характеризуется задержками при приеме и обработке данных. Это означает, что на момент выполнения запроса для оповещения журналов нужные данные могут отсутствовать или быть неполными. Дополнительные сведения см. в разделе [время приема данных журнала в Azure Monitor](../platform/data-ingestion-time.md).

В зависимости от настройки правила генерации оповещений могут происходить ложные срабатывания, если на момент выполнения запроса оповещений данные в журналах отсутствуют или являются неполными. В таких случаях мы советуем вам изменить запрос или конфигурацию для оповещения. 

Например, если правило генерации оповещений журнала должно активироваться при количестве результатов в запросе менее 5, оповещение будет срабатывать и при отсутствии данных (нуль записей) или наличии неполных данных (одна запись). Однако после задержки приема данных один и тот же запрос с полными данными может дать результат из 10 записей.

### <a name="alert-query-output-misunderstood"></a>Неправильная интерпретация выходных данных запроса оповещения

Вы предоставляете логику для оповещений журнала в аналитическом запросе. В этом аналитическом запросе могут использоваться различные возможности больших данных и математические функции.  Служба оповещений выполняет ваш запрос с указанной периодичностью по данным за указанный период времени. В зависимости от выбранного типа оповещений она вносит в запрос незначительные изменения. Это изменение можно просмотреть в разделе «Запроса для выполнения» *настройка логики сигнала* экрана, как показано ниже: ![Выполняемый запрос](media/alert-log-troubleshoot/LogAlertPreview.png)

В поле **Выполняемый запрос** отображается запрос, выполняемый службой оповещений журнала. Вы можете запустить указанный запрос, а также временной диапазон на [портале аналитики](../log-query/portals.md) или с помощью [API аналитики](https://docs.microsoft.com/rest/api/loganalytics/), если хотите просмотреть возможные выходные данные запроса оповещения перед фактическим созданием оповещения.

## <a name="log-alert-was-disabled"></a>Оповещение журнала был отключен

Ниже приведены некоторые причины, из-за чего [правила оповещения журнала в Azure Monitor](../platform/alerts-log.md) можно отключить с Azure Monitor.

### <a name="resource-on-which-alert-was-created-no-longer-exists"></a>Ресурс, на котором создания предупреждения больше не существует

Правила генерации оповещений журнала, созданные в Azure Monitor предназначенных для конкретного ресурса, например рабочей области Azure Log Analytics, Azure Application Insights приложения и ресурсов Azure. И службы оповещений журнала будет выполнять запрос аналитики, предоставляемых в правило для указанного целевого объекта. Но после создания правила, часто пользователи для удаления из Azure или перемещения внутри Azure — целевой объект правила генерации оповещений. Так как целевой объект правила генерации оповещений журнала больше не является допустимым, произойдет сбой выполнения правила.

В таких случаях Azure Monitor отключит оповещения журнала и убедитесь, что клиенты не взимается, без необходимости, когда само правило не сможет выполнять постоянно за допустимыми пределами период как недели. Пользователей можно узнать на точное время, по которому была отключена правило генерации оповещений журнала Azure Monitor с помощью [журнал действий Azure](../../azure-resource-manager/resource-group-audit.md). В журнале действий Azure при отключении правила оповещения журнала в Azure, добавлении события в журнале действий Azure.

Пример события в журнале действий Azure для отключения правила генерации оповещений из-за его постоянные ошибки; Ниже приведен.

```json
{
    "caller": "Microsoft.Insights/ScheduledQueryRules",
    "channels": "Operation",
    "claims": {
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/spn": "Microsoft.Insights/ScheduledQueryRules"
    },
    "correlationId": "abcdefg-4d12-1234-4256-21233554aff",
    "description": "Alert: test-bad-alerts is disabled by the System due to : Alert has been failing consistently with the same exception for the past week",
    "eventDataId": "f123e07-bf45-1234-4565-123a123455b",
    "eventName": {
        "value": "",
        "localizedValue": ""
    },
    "category": {
        "value": "Administrative",
        "localizedValue": "Administrative"
    },
    "eventTimestamp": "2019-03-22T04:18:22.8569543Z",
    "id": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
    "level": "Informational",
    "operationId": "",
    "operationName": {
        "value": "Microsoft.Insights/ScheduledQueryRules/disable/action",
        "localizedValue": "Microsoft.Insights/ScheduledQueryRules/disable/action"
    },
    "resourceGroupName": "<Resource Group>",
    "resourceProviderName": {
        "value": "MICROSOFT.INSIGHTS",
        "localizedValue": "Microsoft Insights"
    },
    "resourceType": {
        "value": "MICROSOFT.INSIGHTS/scheduledqueryrules",
        "localizedValue": "MICROSOFT.INSIGHTS/scheduledqueryrules"
    },
    "resourceId": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
    "status": {
        "value": "Succeeded",
        "localizedValue": "Succeeded"
    },
    "subStatus": {
        "value": "",
        "localizedValue": ""
    },
    "submissionTimestamp": "2019-03-22T04:18:22.8569543Z",
    "subscriptionId": "<SubscriptionId>",
    "properties": {
        "resourceId": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
        "subscriptionId": "<SubscriptionId>",
        "resourceGroup": "<ResourceGroup>",
        "eventDataId": "12e12345-12dd-1234-8e3e-12345b7a1234",
        "eventTimeStamp": "03/22/2019 04:18:22",
        "issueStartTime": "03/22/2019 04:18:22",
        "operationName": "Microsoft.Insights/ScheduledQueryRules/disable/action",
        "status": "Succeeded",
        "reason": "Alert has been failing consistently with the same exception for the past week"
    },
    "relatedEvents": []
}
```

### <a name="query-used-in-log-alert-is-not-valid"></a>Недопустимый запрос, используемый в журнал предупреждений

Каждого правила генерации оповещений журнала, созданные в Azure Monitor в процессе его настройки необходимо указать запрос analytics периодически выполняемой службы оповещений. Хотя запрос аналитики может имеет неправильный синтаксис во время создания правила или обновления. Несколько раз в течение времени, укажите запрос, в журнале правила генерации оповещений можно разрабатывать проблем синтаксиса и привести к завершаться сбоем при выполнении правила. Ниже приведены некоторые распространенные причины, почему запрос analytics, в правило генерации оповещений журнала можно разработать ошибки.

- Запрос записывается в [выполнения по нескольким ресурсам](../log-query/cross-workspace-query.md) и один или несколько ресурсов указано, теперь не существует.
- Нет потоков данных на платформу аналитики, из-за которой было [выполнения запроса выдает ошибку](https://dev.loganalytics.io/documentation/Using-the-API/Errors) как нет данных для предоставленного запроса.
- Изменения в [язык запросов](https://docs.microsoft.com/azure/kusto/query/) произошли какие команды и функции имеют измененный формат. Поэтому ранее указанный запрос в правило генерации оповещений больше не является допустимым.

Пользователь должен быть вывод предупреждений такого поведения через [помощника по Azure](../../advisor/advisor-overview.md). Рекомендация будет добавляться для конкретного правила оповещения журнала в помощнике по Azure, в категории с высоким уровнем доступности с со средним уровнем влияния и описание, как «Восстановить правило оповещения журнала для обеспечения мониторинга». Если через семь дней, предоставляя рекомендации в помощнике по Azure запроса на оповещение в правило генерации оповещений журнала не будет исправлено. Затем Azure Monitor отключит оповещения журнала и убедитесь, что клиенты не взимается, без необходимости, когда само правило не сможет выполнять постоянно за допустимыми пределами период как недели.

Пользователей можно узнать на точное время, по которому была отключена правило генерации оповещений журнала Azure Monitor с помощью [журнал действий Azure](../../azure-resource-manager/resource-group-audit.md). В журнале действий Azure при отключении правила генерации оповещений журнала с Azure — добавлении события в журнале действий Azure.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения см. в статье [Оповещения журнала в Azure Monitor. Интерфейс оповещений](../platform/alerts-unified-log.md).
- Дополнительные сведения об [Application Insights](../../azure-monitor/app/analytics.md)
- Дополнительные сведения о [журнал запросов](../log-query/log-query-overview.md)
