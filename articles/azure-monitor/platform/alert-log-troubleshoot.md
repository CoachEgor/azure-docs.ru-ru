---
title: Предупреждения о схожих неполадок в Azure Monitor Документы Майкрософт
description: Общие проблемы, ошибки и разрешения для правил оповещения о журнале в Azure.
author: yanivlavi
ms.author: yalavi
ms.topic: conceptual
ms.subservice: alerts
ms.date: 10/29/2018
ms.openlocfilehash: acb9784b745fa90fc9cd264162930020e6d64751
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79249039"
---
# <a name="troubleshoot-log-alerts-in-azure-monitor"></a>Предупреждения о схожих неполадок в Azure Monitor  

В этой статье показано, как решить общие проблемы, которые могут возникнуть при настройке оповещений журнала в Azure Monitor. Он также предоставляет решения общих проблем с функциональностью или конфигурацией оповещений журнала.

В *оповещении о журнале* термина описывают правила, которые срабатывают на основе запроса журнала в [рабочей области анализа журналов Azure](../learn/tutorial-viewdata.md) или в [Azure Application Insights.](../../azure-monitor/app/analytics.md) Подробнее о функциональности, терминологии и типах в [оповещениях журнала в Azure Monitor.](../platform/alerts-unified-log.md)

> [!NOTE]
> В этой статье не рассматриваются случаи, когда портал Azure показывает срабатывающее правило оповещения и уведомление не выполняется связанной группой действий. В таких случаях на портале Azure можно ознакомиться с подробной информацией в [группах действий «Создание и управление ими».](../platform/action-groups.md)

## <a name="log-alert-didnt-fire"></a>Оповещение журналов не срабатывает

Вот несколько распространенных причин, почему состояние для настроенного [правила оповещения журнала в Azure Monitor](../platform/alerts-log.md) не отображается [так, как *ожидалось.* ](../platform/alerts-managing-alert-states.md)

### <a name="data-ingestion-time-for-logs"></a>Время приема данных для журналов

Оповещение о журнале периодически запускает ваш запрос на основе [анализа журналов](../learn/tutorial-viewdata.md) или [анализов приложений.](../../azure-monitor/app/analytics.md) Поскольку Azure Monitor обрабатывает многие терабайты данных от тысяч клиентов из различных источников по всему миру, служба подвержена различным задержкам во времени. Для получения дополнительной информации смотрите [время приема данных в журналах Azure Monitor.](../platform/data-ingestion-time.md)

Чтобы уменьшить задержки, система ждет и повторно перестраивает запрос оповещения несколько раз, если он находит нужные данные еще не попадает. Система имеет экспоненциально возрастающее время ожидания. Оповещение о журнале запускается только после того, как данные доступны, поэтому задержка может быть вызвана медленным использованием данных журнала.

### <a name="incorrect-time-period-configured"></a>Неправильно настроен период времени

Как описано в статье о [терминологии для журналов оповещений,](../platform/alerts-unified-log.md#log-search-alert-rule---definition-and-types)период времени, указанный в конфигурации, определяет временной диапазон запроса. Запрос возвращает только записи, которые были созданы в этом диапазоне.

Период времени ограничивает данные, извлеченные для запроса журнала, чтобы предотвратить злоупотребления, и обходит любое время команды (например, **назад),** используемой в запросе журнала. Например, если задан период 60 минут, а запрос выполняется в 13:15, то для запроса журнала используются только записи, созданные между 12:15 и 13:15. Если в запросе журнала используется команда времени, как **раранее (1d),** запрос по-прежнему использует данные только между 12:15 pm и 1:15 PM, потому что период времени установлен на этом интервале.

Убедитесь, что период времени в конфигурации соответствует вашему запросу. Для приведенного ранее примера, если запрос журнала использует **назад (1d)** с зеленым маркером, период времени должен быть установлен на 24 часа или 1440 минут (указано красным цветом). Эта настройка гарантирует, что запрос выполняется по назначению.

![Период времени](media/alert-log-troubleshoot/LogAlertTimePeriod.png)

### <a name="suppress-alerts-option-is-set"></a>Настроена отмена вывода оповещений

Как описано в шаге 8 статьи о создании правила оповещения о журнале на [портале Azure,](../platform/alerts-log.md#managing-log-alerts-from-the-azure-portal)оповещения о журнале предоставляют опцию подавить действия **триггера** и уведомления в течение настроенного периода времени. В результате, вы можете подумать, что оповещение не сравлива. На самом деле, он сделал огонь, но был подавлен.  

![Отменить вывод оповещений](media/alert-log-troubleshoot/LogAlertSuppress.png)

### <a name="metric-measurement-alert-rule-is-incorrect"></a>Неправильно настроено правило генерации оповещений "Измерение метрик"

*Предупреждения о журнале метрических измерений* представляют собой подтип оповещений о журнале, которые имеют специальные возможности и синтаксис с ограниченным запросом оповещения. Правило для предупреждения журнала измерения метрики требует, чтобы выход запроса был метрической временной серией. То есть вывод представляет собой таблицу с отчетливыми, одинаково размерными периодами времени наряду с соответствующими агрегированными значениями.

Вы можете выбрать дополнительные переменные в таблице наряду с **AggregatedValue.** Эти переменные можно использовать для сортировки таблицы.

Например, предположим, что правило для предупреждения журнала измерения метрики было настроено как:

- Запрос`search *| summarize AggregatedValue = count() by $table, bin(timestamp, 1h)`  
- Период времени 6 часов
- Порог 50
- Логика оповещения о трех последовательных нарушениях
- **Агрегат по** выбору в качестве **$table**

Потому что команда включает в **себя обобщить ... и** предоставляет две переменные **(метка времени** и **$table),** система выбирает **$table** для **Aggregate Upon**. Система сортирует таблицу результатов **по $table** поле, как показано на следующем скриншоте. Затем он рассматривает несколько экземпляров **AggregatedValue** для каждого типа таблицы (например, **availabilityResults),** чтобы увидеть, было ли три или более последовательных нарушений.

![Выполнение запроса измерения метрики с несколькими значениями](media/alert-log-troubleshoot/LogMMQuery.png)

Поскольку **Агрегированный на** **$table,** данные сортируются по **$table** столбец (указано красным цветом). Затем мы группируем и ищем типы **агрегирования на** поле.

Например, для **$table**значения **доступностиРезультаты** будут рассматриваться как один участок/сущность (указано оранжевым цветом). В этом значении участка / сущности, служба оповещения проверяет в течение трех последовательных нарушений (указано зеленым цветом). Нарушения вызывают оповещение о **доступности значений таблицыResults.**

Аналогичным образом, если три последовательных нарушения происходят для любого другого значения **$table,** другое уведомление оповещения срабатывает для того же самого. Служба оповещения автоматически сортирует значения в одном участке/сущности (указано оранжевым) по времени.

Теперь предположим, что правило для предупреждения журнала измерения `search *| summarize AggregatedValue = count() by bin(timestamp, 1h)`метрики было изменено и запрос был . Остальная конфигурация осталась такой же, как и раньше, включая логику оповещения в течение трех последовательных нарушений. **Опция Aggregate On** в этом случае является **метки времени** по умолчанию. Только одно значение предоставляется в запросе для **резюме ... по** (т.е. **метки времени**). Как и в предыдущем примере, вывод в конце исполнения будет проиллюстрирован следующим образом.

   ![Выполнение запроса измерения метрики с исключительным значением](media/alert-log-troubleshoot/LogMMtimestamp.png)

Поскольку **Агрегированный на** отметке времени определяется на **метке времени,** данные сортируются по **столбце метки времени** (указано красным цветом). Затем мы группировать по **метке времени**. Например, значения `2018-10-17T06:00:00Z` для будут рассматриваться как один участок/сущность (указано оранжевым цветом). В этом значении участка /сущности служба оповещения не найдет последовательных нарушений (потому что каждое значение **метки имеет** только одну запись). Таким образом, оповещение никогда не срабатывает. В таком случае пользователь должен либо:

- Добавьте фиктивную переменную или существующую переменную **(например, $table),** чтобы правильно сортировать с помощью **агрегированного** поля.
- Перенастроить правило оповещения, чтобы использовать логику оповещения, основанную на **общем нарушении.**

## <a name="log-alert-fired-unnecessarily"></a>Оповещение журналов срабатывает без необходимости

Настроенное [правило оповещения о журналах в Azure Monitor](../platform/alerts-log.md) может быть запущено неожиданно при просмотре в [Azure Alerts.](../platform/alerts-managing-alert-states.md) В следующих разделах описаны некоторые общие причины.

### <a name="alert-triggered-by-partial-data"></a>Предупреждение активируется по частичным данным

Аналитика журналов и анализ приложений подвержены задержкам и обработке. При запуске запроса оповещения о журнале может обнаружить, что данные отсутствуют или доступны только некоторые данные. Для получения дополнительной информации смотрите [время приема данных журнала в Azure Monitor](../platform/data-ingestion-time.md).

В зависимости от того, как вы настроили правило оповещения, ошибка может произойти, если нет данных или частичных данных в журналах во время выполнения оповещения. В таких случаях мы советуем изменить запрос или конфигурацию оповещения.

Например, если настроить правило оповещения журнала для запуска, когда количество результатов из запроса аналитики меньше 5, оповещение срабатывает, когда нет данных (нулевая запись) или частичные результаты (одна запись). Но после задержки с использованием данных тот же запрос с полными данными может дать результат из 10 записей.

### <a name="alert-query-output-is-misunderstood"></a>Вывод запроса оповещения неправильно понят

Вы предоставляете логику для оповещений журнала в аналитическом запросе. В запросе аналитики можно использовать различные большие данные и математические функции. Служба оповещения запускает запрос с интервалами, указанными с данными за определенный период времени. Служба оповещения вносит незначительные изменения в запрос в зависимости от типа оповещения. Это изменение можно просмотреть в разделе **«Запрос» для выполнения** на экране **логики сигнала Настройки:**

![Выполняемый запрос](media/alert-log-troubleshoot/LogAlertPreview.png)

**Запрос, который будет выполнен** поле является то, что служба оповещения журнала работает. Если вы хотите понять, каким может быть выход запроса оповещения перед созданием оповещения, можно запустить указанный запрос и временной промежуток через [портал Analytics](../log-query/portals.md) или [API Analytics.](https://docs.microsoft.com/rest/api/loganalytics/)

## <a name="log-alert-was-disabled"></a>Оповещение о журнале было отключено

В следующих разделах перечисляется несколько причин, по которым Azure Monitor может отключить [правило оповещения о журнале.](../platform/alerts-log.md)

### <a name="resource-where-the-alert-was-created-no-longer-exists"></a>Ресурс, в котором было создано оповещение, больше не существует

Правила оповещения о журналах, созданные в Azure Monitor, нацелены на определенный ресурс, например рабочее пространство Анализа журналов Azure, приложение Azure Application Insights и ресурс Azure. Служба оповещения о журнале запустит запрос аналитики, указанный в правиле для указанной цели. Но после создания правил пользователи часто удаляют из Azure или перемещаются внутри Azure — целевого правила оповещения о журнале. Поскольку цель правила оповещения больше не действительна, выполнение правила завершается сбоем.

В таких случаях Azure Monitor отключает оповещение о журнале и гарантирует, что вы не будете выставлены счета без необходимости, когда правило не может работать непрерывно в течение значительного периода (например, неделю). Вы можете узнать точное время, когда Azure Monitor отключил оповещение о журнале через [журнал активности Azure.](../../azure-resource-manager/management/view-activity-logs.md) В журнале активности Azure добавляется событие, когда Azure Monitor отключает правило оповещения о журнале.

Следующее событие примера в журнале активности Azure предназначено для правила оповещения, которое было отключено из-за постоянного сбоя.

```json
{
    "caller": "Microsoft.Insights/ScheduledQueryRules",
    "channels": "Operation",
    "claims": {
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/spn": "Microsoft.Insights/ScheduledQueryRules"
    },
    "correlationId": "abcdefg-4d12-1234-4256-21233554aff",
    "description": "Alert: test-bad-alerts is disabled by the System due to : Alert has been failing consistently with the same exception for the past week",
    "eventDataId": "f123e07-bf45-1234-4565-123a123455b",
    "eventName": {
        "value": "",
        "localizedValue": ""
    },
    "category": {
        "value": "Administrative",
        "localizedValue": "Administrative"
    },
    "eventTimestamp": "2019-03-22T04:18:22.8569543Z",
    "id": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
    "level": "Informational",
    "operationId": "",
    "operationName": {
        "value": "Microsoft.Insights/ScheduledQueryRules/disable/action",
        "localizedValue": "Microsoft.Insights/ScheduledQueryRules/disable/action"
    },
    "resourceGroupName": "<Resource Group>",
    "resourceProviderName": {
        "value": "MICROSOFT.INSIGHTS",
        "localizedValue": "Microsoft Insights"
    },
    "resourceType": {
        "value": "MICROSOFT.INSIGHTS/scheduledqueryrules",
        "localizedValue": "MICROSOFT.INSIGHTS/scheduledqueryrules"
    },
    "resourceId": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
    "status": {
        "value": "Succeeded",
        "localizedValue": "Succeeded"
    },
    "subStatus": {
        "value": "",
        "localizedValue": ""
    },
    "submissionTimestamp": "2019-03-22T04:18:22.8569543Z",
    "subscriptionId": "<SubscriptionId>",
    "properties": {
        "resourceId": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
        "subscriptionId": "<SubscriptionId>",
        "resourceGroup": "<ResourceGroup>",
        "eventDataId": "12e12345-12dd-1234-8e3e-12345b7a1234",
        "eventTimeStamp": "03/22/2019 04:18:22",
        "issueStartTime": "03/22/2019 04:18:22",
        "operationName": "Microsoft.Insights/ScheduledQueryRules/disable/action",
        "status": "Succeeded",
        "reason": "Alert has been failing consistently with the same exception for the past week"
    },
    "relatedEvents": []
}
```

### <a name="query-used-in-a-log-alert-is-not-valid"></a>Запрос, используемый в оповещении журнала, недействителен

Каждое правило оповещения журнала, созданное в Azure Monitor в рамках его конфигурации, должно указывать запрос аналитики, который служба оповещения будет периодически работать. Запрос аналитики может иметь правильный синтаксис во время создания или обновления правил. Но иногда, в течение определенного периода времени, запрос, представленный в правиле оповещения журнала, может привести к проблемам синтаксиса и к сбою выполнения правила. Некоторые распространенные причины, по которым запрос аналитики, представленный в правиле оповещения журнала, может выработать ошибки:

- Запрос записываются для [выполнения нескольких ресурсов.](../log-query/cross-workspace-query.md) И один или несколько из указанных ресурсов больше не существует.
- Накончается [оповещение типа измерения,](../../azure-monitor/platform/alerts-unified-log.md#metric-measurement-alert-rules) настроенное с запросом оповещения, не соответствующим нормам синтаксиса
- На платформу аналитики не было потока данных. [Выполнение запроса дает ошибку,](https://dev.loganalytics.io/documentation/Using-the-API/Errors) поскольку для предоставленного запроса нет данных.
- Изменения в [языке запросов](https://docs.microsoft.com/azure/kusto/query/) включают пересмотренный формат команд и функций. Таким образом, запрос, представленный ранее в правиле оповещения, больше не действителен.

[Советник Azure](../../advisor/advisor-overview.md) предупреждает вас об этом поведении. Добавлена рекомендация для конкретного правила оповещения о журнале на Azure Advisor, под категорией высокой доступности со средним воздействием и описанием "Ремонт правила оповещения о журнале для обеспечения мониторинга". Если запрос оповещения в правиле оповещения не исправлен после того, как Azure Advisor предоставил рекомендацию в течение семи дней, Azure Monitor отключит оповещение о журнале и гарантирует, что вы не выставляете счет без необходимости, когда правило не может работать непрерывно в течение значительного периода ( как неделя).

Вы можете найти точное время, когда Azure Monitor отключил правило оповещения о журнале, ища событие в [журнале активности Azure.](../../azure-resource-manager/management/view-activity-logs.md)

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь со сведениями об [оповещениях журналов в Azure](../platform/alerts-unified-log.md).
- Дополнительные сведения об [Application Insights](../../azure-monitor/app/analytics.md).
- Подробнее о [запросах журнала](../log-query/log-query-overview.md).
