---
title: Настройка сбора данных для агента Azure Monitor (Предварительная версия)
description: ''
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 08/19/2020
ms.openlocfilehash: aa3225378f921792d1e8ba0442f2c555d095fb9d
ms.sourcegitcommit: bdd5c76457b0f0504f4f679a316b959dcfabf1ef
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/22/2020
ms.locfileid: "90968407"
---
# <a name="configure-data-collection-for-the-azure-monitor-agent-preview"></a>Настройка сбора данных для агента Azure Monitor (Предварительная версия)
Правила сбора данных (ДКР) определяют данные, поступающие в Azure Monitor, и указывают, куда они должны отправляться. В этой статье описывается создание правила сбора данных для сбора данных из виртуальных машин с помощью агента Azure Monitor.

Полное описание правил сбора данных см. [в разделе правила сбора данных в Azure Monitor (Предварительная версия)](data-collection-rule-overview.md).

> [!NOTE]
> В этой статье описывается, как настроить данные для виртуальных машин с помощью агента Azure Monitor, который в настоящее время находится на этапе предварительной версии. Описание агентов, которые являются общедоступными и как использовать их для получения данных, см. в разделе [Общие сведения об агентах Azure Monitor](agents-overview.md) .


## <a name="dcr-associations"></a>Ассоциации ДКР
Чтобы применить ДКР к виртуальной машине, создайте ассоциацию для виртуальной машины. Виртуальная машина может иметь связь с несколькими DCR, и у ДКР может быть несколько виртуальных машин, связанных с ней. Это позволяет определить набор DCR, каждый из которых соответствует определенному требованию, и применить их только к виртуальным машинам, в которых они применяются. 

Например, рассмотрим среду с набором виртуальных машин, на которых работает бизнес-приложение и другие, работающие SQL Server. Возможно, имеется одно правило сбора данных по умолчанию, которое применяется ко всем виртуальным машинам, а также к отдельным правилам сбора данных, которые собираются данные, предназначенные специально для бизнес-приложения и для SQL Server. Связи для виртуальных машин с правилами сбора данных будут выглядеть примерно так, как показано на следующей схеме.

![На схеме показаны виртуальные машины, на которых размещается бизнес-приложение, и SQL Server связанные с правилами сбора данных, которые называются "Центрально-я t-по умолчанию" и "бизнес-приложение для бизнеса", а также Центрально-я t-по умолчанию и s q l для SQL Server.](media/data-collection-rule-azure-monitor-agent/associations.png)

## <a name="create-using-the-azure-portal"></a>Создание с помощью портала Azure
Вы можете использовать портал Azure для создания правила сбора данных и связывания виртуальных машин в подписке с этим правилом. Агент Azure Monitor будет автоматически установлен и управляемое удостоверение, созданное для всех виртуальных машин, на которых он еще не установлен.

В меню **Azure Monitor** в портал Azure выберите **правила сбора данных** в разделе **Параметры** . Нажмите кнопку **Добавить** , чтобы добавить новое правило и назначение сбора данных.

[![Правила сбора данных](media/azure-monitor-agent/data-collection-rules.png)](media/azure-monitor-agent/data-collection-rules.png#lightbox)

Нажмите кнопку **Добавить** , чтобы создать новое правило и набор ассоциаций. Укажите **имя правила** и укажите **подписку** и **группу ресурсов**. Указывает, где будет создан ДКР. Виртуальные машины и их ассоциации могут находиться в любой подписке или группе ресурсов в клиенте.

[![Основные сведения о правилах сбора данных](media/azure-monitor-agent/data-collection-rule-basics.png)](media/azure-monitor-agent/data-collection-rule-basics.png#lightbox)

На вкладке **виртуальные машины** добавьте виртуальные машины, для которых необходимо применить правило сбора данных. Агент Azure Monitor будет установлен на виртуальных машинах, на которых он еще не установлен.

[![Виртуальные машины правил сбора данных](media/azure-monitor-agent/data-collection-rule-virtual-machines.png)](media/azure-monitor-agent/data-collection-rule-virtual-machines.png#lightbox)

На вкладке " **Получение и доставка** " щелкните **Добавить источник данных** , чтобы добавить источник данных и набор назначения. Выберите **тип источника данных**, и отобразятся соответствующие сведения для выбора. Для счетчиков производительности можно выбрать предопределенный набор объектов и частоту выборки. Для событий можно выбрать один из наборов журналов или средств и уровень серьезности. 

[![Базовый источник данных](media/azure-monitor-agent/data-collection-rule-data-source-basic.png)](media/azure-monitor-agent/data-collection-rule-data-source-basic.png#lightbox)


Чтобы указать другие журналы и счетчики производительности, выберите **Пользовательский**. Затем можно указать [XPath ](https://www.w3schools.com/xml/xpath_syntax.asp) для всех конкретных значений, которые необходимо получить. Примеры см. в разделе [Sample ДКР](data-collection-rule-overview.md#sample-data-collection-rule) .

[![Пользовательский источник данных](media/azure-monitor-agent/data-collection-rule-data-source-custom.png)](media/azure-monitor-agent/data-collection-rule-data-source-custom.png#lightbox)

На вкладке **назначение** добавьте одно или несколько назначений для источника данных. Источники данных о событиях и системных журналах Windows могут отсылаться только в журналы Azure Monitor. Счетчики производительности могут отсылать как Azure Monitor метрики, так и журналы Azure Monitor.

[![Назначение](media/azure-monitor-agent/data-collection-rule-destination.png)](media/azure-monitor-agent/data-collection-rule-destination.png#lightbox)

Щелкните **Добавить источник данных** , а затем — **Обзор и создать** , чтобы проверить сведения о правиле сбора данных и сопоставлении с набором виртуальных машин. Нажмите кнопку **создать** , чтобы создать его.

> [!NOTE]
> После создания правила сбора данных и связей может потребоваться до 5 минут для отправки данных в назначения.

## <a name="createusingrestapi"></a>Создание с помощью REST API
Выполните следующие действия, чтобы создать ДКР и связи с помощью REST API. 
1.Вручную создайте файл ДКР, используя формат JSON, показанный в [примере ДКР](data-collection-rule-overview.md#sample-data-collection-rule).
2.Создайте правило с помощью [REST API](https://docs.microsoft.com/rest/api/monitor/datacollectionrules/create#examples).
3.Создайте ассоциацию для каждой виртуальной машины в правиле сбора данных с помощью [REST API](https://docs.microsoft.com/rest/api/monitor/datacollectionruleassociations/create#examples).

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения об [агенте Azure Monitor](azure-monitor-agent-overview.md).
- Дополнительные сведения о [правилах сбора данных](data-collection-rule-overview.md).
