---
title: Получение журналов ресурсов Azure в Log Analytics рабочей области
description: Узнайте, как выполнять потоковую передачу журналов ресурсов Azure в рабочую область Log Analytics в Azure Monitor.
author: bwren
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 09/20/2019
ms.author: bwren
ms.subservice: logs
ms.openlocfilehash: 83b91be52694076373d950e0ad785ef22671ef4f
ms.sourcegitcommit: 8bd85510aee664d40614655d0ff714f61e6cd328
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/06/2019
ms.locfileid: "74894514"
---
# <a name="collect-azure-resource-logs-in-log-analytics-workspace-in-azure-monitor"></a>Получение журналов ресурсов Azure в Log Analytics рабочей области в Azure Monitor
[Журналы ресурсов](resource-logs-overview.md) в Azure предоставляют широкие и часто встречающиеся данные о внутренней работе ресурса Azure. В этой статье описывается сбор журналов ресурсов в рабочей области Log Analytics, которая позволяет анализировать их с другими данными мониторинга, собранными в журналах Azure Monitor, используя мощные запросы журналов, а также использовать другие функции Azure Monitor, такие как оповещения и визуализации. 


## <a name="what-you-can-do-with-resource-logs-in-a-workspace"></a>Что можно делать с журналами ресурсов в рабочей области
Сбор журналов ресурсов в Log Analytics рабочей области позволяет анализировать журналы всех ресурсов Azure вместе и использовать преимущества всех функций, доступных для [Azure Monitor журналов](data-platform-logs.md) , включая следующие:

* **Запросы журналов** . Создание [запросов к журналам](../log-query/log-query-overview.md) с помощью мощного языка запросов для быстрого анализа и анализа диагностических данных, а также анализ данных с данными, собранными из других источников в Azure Monitor.
* **Оповещения** — получение упреждающего уведомления о критических условиях и закономерностях, определенных в журналах ресурсов с помощью [оповещений журнала в Azure Monitor](alerts-log.md).
* **Визуализации** — закрепление результатов запроса журнала на панели мониторинга Azure или включение их в книгу как часть интерактивного отчета.

## <a name="prerequisites"></a>Технические условия
Если у вас ее еще нет, [Создайте новую рабочую область](../learn/quick-create-workspace.md) . Рабочая область не обязательно должна находиться в той же подписке, что и журнал, отправляющий журналы, если пользователь, настроив параметр, имеет соответствующий доступ RBAC к обеим подпискам.

## <a name="create-a-diagnostic-setting"></a>Создание параметра диагностики
Журналы ресурсов по умолчанию не собираются. Собирайте их в рабочей области Log Analytics и других местах, создав параметр диагностики для ресурса Azure. Дополнительные сведения см. в статье [Создание параметров диагностики для сбора журналов и метрик в Azure](diagnostic-settings.md) .

## <a name="collection-mode"></a>Режим сбора
Данные, собранные в рабочей области Log Analytics, хранятся в таблицах, как описано в разделе [Структура журналов Azure Monitor](../log-query/logs-structure.md). Таблицы, используемые журналами ресурсов, зависят от типа коллекции, используемой ресурсом.

- Диагностика Azure — все данные, записанные в таблицу _AzureDiagnostics_ .
- Данные конкретного ресурса записываются в отдельную таблицу для каждой категории ресурса.

### <a name="azure-diagnostics-mode"></a>Режим система диагностики Azure 
В этом режиме все данные из любого [параметра диагностики](diagnostic-settings.md) будут собраны в таблицу _AzureDiagnostics_ . Это устаревший метод, используемый на сегодняшний день большинством служб Azure.

Так как несколько типов ресурсов отправляют данные в одну и ту же таблицу, их схема является надмножеством схем всех различных собираемых типов данных.

Рассмотрим следующий пример, где параметры диагностики собираются в одной рабочей области для следующих типов данных:

- Журналы аудита службы 1 (со схемой, состоящей из столбцов A, B и C)  
- Журналы ошибок службы 1 (со схемой, состоящей из столбцов D, E и F)  
- Журналы аудита службы 2 (со схемой, состоящей из столбцов G, H и I)  

Таблица AzureDiagnostics будет выглядеть следующим образом:  

| ResourceProvider    | Категория     | A  | b  | C  | D  | E  | F  | G  | Серия H  | I  |
| -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- |
| Microsoft. Service1 | AuditLogs    | x1 | Y1 | Z1 |    |    |    |    |    |    |
| Microsoft. Service1 | ErrorLogs    |    |    |    | q1 | W1 | e1 |    |    |    |
| Microsoft. S2 | AuditLogs    |    |    |    |    |    |    | J1 | k1 | L1 |
| Microsoft. Service1 | ErrorLogs    |    |    |    | q2 | W2 | e2 |    |    |    |
| Microsoft. S2 | AuditLogs    |    |    |    |    |    |    | J3 | k3 | Индекс |
| Microsoft. Service1 | AuditLogs    | x5 | y5 | z5 |    |    |    |    |    |    |
| ... |

### <a name="resource-specific"></a>Для конкретного ресурса
В этом режиме отдельные таблицы в выбранной рабочей области создаются для каждой категории, выбранной в параметре диагностики. Этот метод рекомендуется, поскольку он значительно упрощает работу с данными в запросах к журналу, обеспечивает лучшую возможность обнаружения схем и их структуры, повышает производительность как задержки приема, так и времени выполнения запросов, а также возможность предоставлять разрешения RBAC для определенная таблица. Все службы Azure в конечном итоге будут перенесены в режим, зависящий от ресурса. 

Приведенный выше пример привел бы к созданию трех таблиц:
 
- Таблица *Service1AuditLogs* выглядит следующим образом:

    | Поставщик ресурсов | Категория | A | b | C |
    | -- | -- | -- | -- | -- |
    | Service1 | AuditLogs | x1 | Y1 | Z1 |
    | Service1 | AuditLogs | x5 | y5 | z5 |
    | ... |

- Таблица *Service1ErrorLogs* выглядит следующим образом:  

    | Поставщик ресурсов | Категория | D | E | F |
    | -- | -- | -- | -- | -- | 
    | Service1 | ErrorLogs |  q1 | W1 | e1 |
    | Service1 | ErrorLogs |  q2 | W2 | e2 |
    | ... |

- Таблица *Service2AuditLogs* выглядит следующим образом:  

    | Поставщик ресурсов | Категория | G | Серия H | I |
    | -- | -- | -- | -- | -- |
    | Service2 | AuditLogs | J1 | k1 | L1|
    | Service2 | AuditLogs | J3 | k3 | Индекс|
    | ... |



### <a name="select-the-collection-mode"></a>Выбор режима сбора
Большинство ресурсов Azure записывают данные в рабочую область в **службе диагностики Azure** или в **режиме отдельных ресурсов** , не предоставляя выбора. Дополнительные сведения о том, какой режим используется, см. в [документации по каждой службе](diagnostic-logs-schema.md) . Все службы Azure в конечном итоге будут использовать режим, зависящий от конкретного ресурса. В рамках этого перехода некоторые ресурсы позволяют выбрать режим в параметре диагностики. Для всех новых параметров диагностики следует указать режим конкретного ресурса, так как это упрощает управление данными и может помочь избежать сложных миграций позднее.
  
   ![Селектор режима параметров диагностики](media/resource-logs-collect-workspace/diagnostic-settings-mode-selector.png)




> [!NOTE]
> Сейчас система **диагностики Azure** и режим **конкретного ресурса** можно выбрать только при настройке параметра диагностики в портал Azure. Если вы настраиваете параметр с помощью интерфейса командной строки, PowerShell или интерфейсов API, он по умолчанию будет выполнять **диагностику Azure**.

Можно изменить существующий параметр диагностики на режим, зависящий от ресурса. В этом случае собранные данные останутся в таблице _AzureDiagnostics_ до тех пор, пока не будут удалены в соответствии с параметром хранения для рабочей области. Новые данные будут собраны в выделенную таблицу. Используйте оператор [Union](https://docs.microsoft.com/azure/kusto/query/unionoperator) для запроса данных в обеих таблицах.

Перейдите к блогу об [обновлениях Azure](https://azure.microsoft.com/updates/) , чтобы получить объявления о службах Azure, поддерживающих зависящий от ресурсов режим.

### <a name="column-limit-in-azurediagnostics"></a>Ограничение столбца в AzureDiagnostics
Существует ограничение 500 свойств для любой таблицы в журналах Azure Monitor. После достижения этого ограничения все строки, содержащие данные со свойством, находящимся за пределами первых 500, будут удалены во время приема. Таблица *AzureDiagnostics* особенно подвержена этому ограничению, так как она включает свойства для всех служб Azure, записывающих в нее.

Если вы собираете журналы ресурсов из нескольких служб, _AzureDiagnostics_ может превысить это ограничение, и данные будут пропущены. До тех пор пока все службы Azure не будут поддерживать режим конкретного ресурса, необходимо настроить ресурсы для записи в несколько рабочих областей, чтобы снизить вероятность достижения ограничения в 500 столбцов.

### <a name="azure-data-factory"></a>Фабрика данных Azure
Фабрика данных Azure, из-за очень подробного набора журналов, — это служба, которая записывает большое количество столбцов и может привести к превышению предела _AzureDiagnostics_ . Для всех параметров диагностики, настроенных до включения режима для конкретного ресурса, будет создан новый столбец для каждого параметра пользователя с уникальным именем в отношении любого действия. Будут созданы дополнительные столбцы из-за подробной природы входных и выходных данных действия.
 
Необходимо как можно скорее перенести журналы, чтобы использовать режим, зависящий от ресурса. Если вы не можете сделать это немедленно, следует изолировать журналы фабрики данных Azure в своей рабочей области, чтобы снизить вероятность того, что эти журналы будут влиять на другие типы журналов, собираемые в ваших рабочих областях.


## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о журналах ресурсов Azure см. в статье [Обзор журналов ресурсов Azure](resource-logs-overview.md).
* Сведения о создании параметра диагностики для сбора журналов ресурсов в Log Analytics рабочей области см. в статье [Создание параметров диагностики для сбора журналов и метрик в Azure](diagnostic-settings.md).
