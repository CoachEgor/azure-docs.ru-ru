---
title: Экспорт журнала действий Azure
description: Экспорт журнала действий Azure в хранилище для архивирования или Azure концентраторов событий для экспорта за пределами Azure.
author: bwren
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 05/20/2019
ms.author: bwren
ms.subservice: logs
ms.openlocfilehash: acf2526e79519e610614dc5217efbfe5e327b90f
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "66248149"
---
# <a name="export-azure-activity-log-to-storage-or-azure-event-hubs"></a>Экспорт журнала действий Azure для хранения или концентраторы событий Azure
[Журнал действий Azure](activity-logs-overview.md) предоставляет сведения о событиях уровня подписки, которые произошли в вашей подписке Azure. Помимо Просмотр журнала действий на портале Azure или скопировав ее в рабочей области Log Analytics, где их можно проанализировать с другими данными, собранными с Azure Monitor, можно создать профиль журнала, чтобы Архивация журнала действий для учетной записи хранения Azure или поток для  Концентратор событий.

## <a name="archive-activity-log"></a>Архивация журнала действий
Архивация журнала действий в учетной записи хранения полезно в том случае, если вы хотите хранить данные дольше 90 дней (с полным контролем над политикой хранения) для аудита, статического анализа или резервного копирования журнала. Если необходимо хранить события в течение 90 дней или меньше не нужно настраивать архивацию в учетную запись хранения, так как события журнала действий хранятся на платформе Azure в течение 90 дней.

## <a name="stream-activity-log-to-event-hub"></a>Журнал действий Stream в концентратор событий
[Концентраторы событий Azure](/azure/event-hubs/) данных потоковой передачи платформы и служба потребления событий, может получать и обрабатывать миллионы событий в секунду. Данные, отправляемые в концентратор событий, можно преобразовывать и сохранять с помощью любого поставщика аналитики в реальном времени, а также с помощью адаптеров пакетной обработки или хранения. Ниже приведены два способа использования потоковой передачи журнала действий.
* **Потоковая передача в сторонние системы ведения журналов и сбора телеметрии.** Со временем Центры событий Azure будут использоваться для передачи журнала действий в сторонние решения SIEM и решения для анализа журналов.
* **Создание пользовательской платформы для телеметрии и ведения журнала.** Если у вас уже есть пользовательская платформа для телеметрии и ведения журнала или вы только планируете ее создать, высокая масштабируемость публикации и подписки Центров событий позволит вам гибко настраивать прием журнала действий. 

## <a name="prerequisites"></a>Технические условия

### <a name="storage-account"></a>Учетная запись хранения
Если выполняется архивация журнала действий, необходимо [создать учетную запись хранилища](../../storage/common/storage-quickstart-create-account.md) Если у вас еще нет. Не следует использовать существующую учетную запись хранения с другими, отличных от наблюдения данные, хранящиеся в нем, таким образом, чтобы вы лучше контролировать доступ к данным мониторинга. Если вы архивируете журналов диагностики и метрик в учетную запись хранения, что вы можете использовать одну и ту же учетную запись хранения все данные мониторинга будут храниться в центральном расположении.

Учетная запись хранения не обязательно должна находиться в той самой подписке, в которой создаются журналы, если у пользователя, настраивающего параметр, имеется соответствующий доступ RBAC к обеим подпискам.
> [!NOTE]
>  Сейчас невозможно архивировать данные в учетную запись хранения, которая находится в защищенной виртуальной сети.

### <a name="event-hubs"></a>Центры событий;
Если вы отправляете журнала действий в концентратор событий, то необходимо [создать концентратор событий](../../event-hubs/event-hubs-create.md) Если у вас еще нет. Если вы ранее выполнили потоковую передачу событий журнала действий к этому пространству имен концентраторов событий, концентратор событий будет использоваться повторно.

Политика общего доступа определяет разрешения, предоставленные для механизма потоковой передачи. Потоковая передача в концентраторы событий нужны разрешения на управление, отправку и прослушивание. Можно создать или изменить политики общего доступа для пространства имен концентраторов событий на портале Azure на вкладке Настройка для пространства имен концентраторов событий.

Чтобы обновить профиль журнала действий для включения потоковой передачи, необходимо иметь разрешение ListKey этого правила авторизации концентраторов событий. Пространство имен службы "Центры событий Azure" не должно находиться в той же подписке, что и подписка, генерирующая журналы, если пользователь, который настраивает этот параметр, имеет соответствующий доступ RBAC к обеим подпискам, и обе подписки находятся в том же клиенте AAD.

Журнал действий в концентратор событий, Stream [Создание профиля журнала](#create-a-log-profile).

## <a name="create-a-log-profile"></a>Создание профиля журнала
Можно определить, как журнал действий Azure экспорта с помощью **профиль журнала**. Каждая подписка Azure может иметь только один профиль журнала. Эти параметры можно настроить с помощью **Экспорт** параметр в колонке журнала действий на портале. Их также можно настроить программно [с помощью REST API Azure Monitor](https://msdn.microsoft.com/library/azure/dn931927.aspx), командлетов PowerShell или интерфейса командной строки.

Профиль журнала определяет следующее.

**Отправки журнала действий.** В настоящее время доступные варианты: учетная запись хранения или концентраторы событий.

**Какие категории событий будут отправляться.** Значение *категории* в профилях журнала и журнала действий отличается события. В профиле журнала *категории* обозначает тип операции (запись, удаление, действие). В событии журнала действий *категории*«* свойство представляет источник или тип события (например, администрирования, ServiceHealth и предупреждения).

**Какие регионы (расположения) должны быть экспортированы.** Следует включить все расположения, так как существует множество событий в журнале действий глобальные события.

**Как долго должен храниться журнал действий, в учетной записи хранения.** Срок хранения 0 дней означает, что журналы хранятся неограниченно долго. В противном случае укажите количество дней в диапазоне от 1 до 2 147 483 647.

Если политики хранения заданы, но хранение журналов в учетной записи хранения отключено, то политики хранения не оказывают влияния. Политики хранения применяются по дням, поэтому в конце дня (по времени в формате UTC) журналы, срок которых теперь превышает период хранения, будут удалены. Например, если настроена политика хранения в течение одного дня, то в начале текущего дня журналы за вчерашний день будет удалены. Удаление начинается в полночь по времени UTC. Обратите внимание, что удаление журналов из учетной записи хранения может занять до 24 часов.



> [!WARNING]
> Формат данных журнала в учетной записи хранения будет изменен на JSON Lines с 1 ноября 2018 г. [См. дополнительные сведения, включая информацию об обновлении инструментария для включения поддержки нового формата.](diagnostic-logs-append-blobs.md)
>
>

### <a name="create-log-profile-using-the-azure-portal"></a>Создать профиль журнала, с помощью портала Azure

Создание или изменение профиля журнала с **Экспорт в концентратор событий** параметр на портале Azure.

1. Из **монитор** меню на портале Azure, выберите **Экспорт в концентратор событий**.

    ![Кнопка экспорта на портале](media/activity-log-export/portal-export.png)

3. В появившейся колонке укажите следующие сведения:
   * Области с событиями для экспорта. Следует выбрать все регионы, чтобы убедиться, что не пропустите ключевые события, так как журнал действий — это глобальный журнал (без привязки к региону), и поэтому большинство событий не имеют связанных с ними регионе. 
   * Если вы хотите записать в учетную запись хранения:
       * Учетная запись хранения, к которому вы хотите сохранить события.
       * число дней, вы хотите сохранить эти события в хранилище. (если выбрать значение "0 дней", журналы будут храниться бессрочно);
   * Если требуется выполнить запись в концентратор событий:
       * пространство имен служебной шины, в котором вы хотите концентратор событий, которые будут созданы для потоковой передачи этих событий.

     ![Колонка экспорта журнала действий](./media/activity-logs-overview/activity-logs-portal-export-blade.png)


4. Нажмите кнопку **Сохранить** , чтобы сохранить эти параметры. Параметры будут немедленно применены к подписке


### <a name="configure-log-profile-using-powershell"></a>Настройка профиля журнала с помощью PowerShell

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

Если профиль журнала уже существует, необходимо сначала удалить существующий профиль журнала, а затем создать ее заново.

1. Используйте `Get-AzLogProfile`, чтобы проверить, существует ли профиль журнала.  Если профиль журнала существует, обратите внимание, *имя* свойство.

1. Удалите журнал профиля с помощью `Remove-AzLogProfile`, используя значение свойства *name*.

    ```powershell
    # For example, if the log profile name is 'default'
    Remove-AzLogProfile -Name "default"
    ```

3. Создайте профиль журнала с помощью `Add-AzLogProfile`:

    ```powershell
    Add-AzLogProfile -Name my_log_profile -StorageAccountId /subscriptions/s1/resourceGroups/myrg1/providers/Microsoft.Storage/storageAccounts/my_storage -serviceBusRuleId /subscriptions/s1/resourceGroups/Default-ServiceBus-EastUS/providers/Microsoft.ServiceBus/namespaces/mytestSB/authorizationrules/RootManageSharedAccessKey -Location global,westus,eastus -RetentionInDays 90 -Category Write,Delete,Action
    ```

    | Свойство | Обязательно для заполнения | ОПИСАНИЕ |
    | --- | --- | --- |
    | Name |Yes |Имя профиля журнала. |
    | StorageAccountId |Нет |Идентификатор ресурса учетной записи хранения, где следует сохранить журнал действий. |
    | serviceBusRuleId |Нет |Идентификатор правила служебной шины для пространства имен служебной шины, в котором вы сможете создать концентраторы событий. Это строка в формате: `{service bus resource ID}/authorizationrules/{key name}`. |
    | Расположение |Yes |Разделенный запятыми список регионов, для которых будут собираться события журнала действий. |
    | RetentionInDays |Да |Число дней, для которых будут храниться события в учетной записи, от 1 до 2147483647. Нулевое значение означает, что журналы хранятся неограниченно долго. |
    | Категория |Нет |Разделенный запятыми список категорий событий, которые будут собираться. Возможные значения: _записи_, _удалить_, и _действие_. |

### <a name="example-script"></a>Пример сценария
Ниже приведен пример сценария PowerShell для создания профиля журнала, который записывает журнал действий в оба хранилища учетной записи и концентратор событий.

   ```powershell
   # Settings needed for the new log profile
   $logProfileName = "default"
   $locations = (Get-AzLocation).Location
   $locations += "global"
   $subscriptionId = "<your Azure subscription Id>"
   $resourceGroupName = "<resource group name your event hub belongs to>"
   $eventHubNamespace = "<event hub namespace>"

   # Build the service bus rule Id from the settings above
   $serviceBusRuleId = "/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.EventHub/namespaces/$eventHubNamespace/authorizationrules/RootManageSharedAccessKey"

   # Build the storage account Id from the settings above
   $storageAccountId = "/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.Storage/storageAccounts/$storageAccountName"

   Add-AzLogProfile -Name $logProfileName -Location $locations -ServiceBusRuleId $serviceBusRuleId
   ```


### <a name="configure-log-profile-using-azure-cli"></a>Настройка профиля журнала с помощью Azure CLI

Если профиль журнала уже существует, сначала удалите его, а затем создайте новый.

1. Используйте `az monitor log-profiles list`, чтобы проверить, существует ли профиль журнала.
2. Удалите журнал профиля с помощью `az monitor log-profiles delete --name "<log profile name>`, используя значение свойства *name*.
3. Создайте профиль журнала с помощью `az monitor log-profiles create`:

   ```azurecli-interactive
   az monitor log-profiles create --name "default" --location null --locations "global" "eastus" "westus" --categories "Delete" "Write" "Action"  --enabled false --days 0 --service-bus-rule-id "/subscriptions/<YOUR SUBSCRIPTION ID>/resourceGroups/<RESOURCE GROUP NAME>/providers/Microsoft.EventHub/namespaces/<EVENT HUB NAME SPACE>/authorizationrules/RootManageSharedAccessKey"
   ```

    | Свойство | Обязательно для заполнения | ОПИСАНИЕ |
    | --- | --- | --- |
    | name |Да |Имя профиля журнала. |
    | storage-account-id |Да |Идентификатор ресурса для учетной записи хранения, в которую будут сохранены журналы действий. |
    | Расположения |Да |Разделенный пробелами список регионов, для которых будут собираться события журнала действий. Вы можете просмотреть список всех регионов для своей подписки с помощью `az account list-locations --query [].name`. |
    | days |Да |Число дней, какие события должны сохраняться, от 1 до 365. Нулевое значение означает, что журналы будут храниться неограниченно долго, то есть всегда.  Если значение равно нулю, для включенного параметра нужно установить значение true. |
    |enabled | Да |Значение True или False.  Позволяет включить или отключить политику хранения.  Если установлено значение True, параметр дней должен иметь значение больше 0.
    | Категории |Да |Разделенный пробелами список категорий событий, которые будут собираться. Возможные значения: Write, Delete или Action. |



## <a name="activity-log-schema"></a>Схема журнала действий
Ли отправлен в хранилище Azure или концентратор событий, данные журнала действий будут записаны в JSON в следующем формате.

``` JSON
{
    "records": [
        {
            "time": "2015-01-21T22:14:26.9792776Z",
            "resourceId": "/subscriptions/s1/resourceGroups/MSSupportGroup/providers/microsoft.support/supporttickets/115012112305841",
            "operationName": "microsoft.support/supporttickets/write",
            "category": "Write",
            "resultType": "Success",
            "resultSignature": "Succeeded.Created",
            "durationMs": 2826,
            "callerIpAddress": "111.111.111.11",
            "correlationId": "c776f9f4-36e5-4e0e-809b-c9b3c3fb62a8",
            "identity": {
                "authorization": {
                    "scope": "/subscriptions/s1/resourceGroups/MSSupportGroup/providers/microsoft.support/supporttickets/115012112305841",
                    "action": "microsoft.support/supporttickets/write",
                    "evidence": {
                        "role": "Subscription Admin"
                    }
                },
                "claims": {
                    "aud": "https://management.core.windows.net/",
                    "iss": "https://sts.windows.net/72f988bf-86f1-41af-91ab-2d7cd011db47/",
                    "iat": "1421876371",
                    "nbf": "1421876371",
                    "exp": "1421880271",
                    "ver": "1.0",
                    "http://schemas.microsoft.com/identity/claims/tenantid": "1e8d8218-c5e7-4578-9acc-9abbd5d23315 ",
                    "http://schemas.microsoft.com/claims/authnmethodsreferences": "pwd",
                    "http://schemas.microsoft.com/identity/claims/objectidentifier": "2468adf0-8211-44e3-95xq-85137af64708",
                    "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn": "admin@contoso.com",
                    "puid": "20030000801A118C",
                    "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier": "9vckmEGF7zDKk1YzIY8k0t1_EAPaXoeHyPRn6f413zM",
                    "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname": "John",
                    "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname": "Smith",
                    "name": "John Smith",
                    "groups": "cacfe77c-e058-4712-83qw-f9b08849fd60,7f71d11d-4c41-4b23-99d2-d32ce7aa621c,31522864-0578-4ea0-9gdc-e66cc564d18c",
                    "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name": " admin@contoso.com",
                    "appid": "c44b4083-3bq0-49c1-b47d-974e53cbdf3c",
                    "appidacr": "2",
                    "http://schemas.microsoft.com/identity/claims/scope": "user_impersonation",
                    "http://schemas.microsoft.com/claims/authnclassreference": "1"
                }
            },
            "level": "Information",
            "location": "global",
            "properties": {
                "statusCode": "Created",
                "serviceRequestId": "50d5cddb-8ca0-47ad-9b80-6cde2207f97c"
            }
        }
    ]
}
```
В следующей таблице описываются элементы в этом формате JSON.

| Имя элемента | ОПИСАНИЕ |
| --- | --- |
| time |Метка времени, когда служба Azure создала событие при обработке соответствующего этому событию запроса. |
| resourceId |Идентификатор ресурса для затронутого ресурса. |
| operationName |Имя операции. |
| category |Категория действия, например "Запись", "Чтение", "Действие" |
| resultType |Тип результата, например "Успешно", "Ошибка", "Запуск" |
| resultSignature |Зависит от типа ресурса. |
| durationMs |Время выполнения операции в миллисекундах |
| callerIpAddress |IP-адрес пользователя, который выполнил операцию, утверждение имени субъекта-службы или имени участника-пользователя в зависимости от доступности. |
| correlationId |Обычно GUID в строковом формате. События, которые совместно используют идентификатор correlationId, принадлежат к одному общему действию. |
| identity |Большой двоичный объект JSON, описывающий авторизацию и утверждения. |
| authorization |BLOB-объект со свойствами RBAC события. Обычно включает следующие свойства: action, role и scope. |
| level |Уровень события. Одно из следующих значений: _Критические_, _ошибка_, _предупреждение_, _Информационное_, и _Verbose_ |
| location |Регион, к которому принадлежит расположение (или глобальное местоположение). |
| properties |Набор пар `<Key, Value>` (например, Dictionary) c подробным описанием события. |

> [!NOTE]
> Свойства и об использовании этих свойств зависит от ресурса.



## <a name="next-steps"></a>Дальнейшие действия

* [См. дополнительные сведения о журнале действий](../../azure-resource-manager/resource-group-audit.md)
* [Сбор журнала действий в журналы Azure Monitor](activity-log-collect.md)
