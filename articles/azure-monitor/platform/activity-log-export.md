---
title: Экспорт журнала действий Windows Azure
description: Экспорт журнала деятельности Azure в хранилище для архивирования или концентраторов событий Azure для экспорта за пределы Azure.
author: bwren
services: azure-monitor
ms.topic: conceptual
ms.date: 01/23/2020
ms.author: bwren
ms.subservice: logs
ms.openlocfilehash: edaa585ffb3448a80b021aa924a9d654ac829931
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79096291"
---
# <a name="export-azure-activity-log-to-storage-or-azure-event-hubs"></a>Экспорт журнала деятельности Azure в хранилища или концентраторы событий Azure

> [!IMPORTANT]
> Метод отправки журнала Azure Activity в концентраторы хранения azure и Azure event были изменены на [диагностические настройки.](diagnostic-settings.md) В этой статье описывается устаревший метод, который находится в процессе унижаемого. Для сравнения смотрите [коллекцию журналов и экспорт](diagnostic-settings-legacy.md) ам-версий update to Azure Activity.


[В журнале деятельности Azure](platform-logs-overview.md) содержится информация о событиях уровня подписки, которые произошли в подписке Azure. Помимо просмотра журнала Activity на портале Azure или копирования его в рабочее пространство Log Analytics, где его можно анализировать с помощью других данных, собранных Azure Monitor, можно создать профиль журнала для архивирования журнала Activity в учетную запись хранения Azure или передать его в Концентратор событий.

## <a name="archive-activity-log"></a>Архивная деятельность Журнал
Архивирование журнала активности на учетную запись хранилища полезно, если вы хотите сохранить данные журнала более 90 дней (с полным контролем над политикой хранения) для аудита, статического анализа или резервного копирования. Если вам нужно сохранить события только в течение 90 дней или менее, вам не нужно настраивать архив на учетную запись хранения, так как события журнала активности сохраняются в платформе Azure в течение 90 дней.

## <a name="stream-activity-log-to-event-hub"></a>Поток активности журнал концентратор событий
[Azure Event Hubs](/azure/event-hubs/) — это платформа для потоковой передачи данных и служба приема событий, которая может принимать и обрабатывать миллионы событий в секунду. Данные, отправляемые в концентратор событий, можно преобразовывать и сохранять с помощью любого поставщика аналитики в реальном времени, а также с помощью адаптеров пакетной обработки или хранения. Два способа использования возможности потоковой передачи для журнала activity— это:
* **Потоковая передача в сторонние системы ведения журнала и сбора телеметрии.** Со временем Центры событий Azure будут использоваться для передачи журнала действий в сторонние решения SIEM и решения для анализа журналов.
* **Создание пользовательской платформы для телеметрии и ведения журнала.** Если у вас уже есть пользовательская платформа для телеметрии и ведения журнала или вы только планируете ее создать, высокая масштабируемость публикации и подписки Центров событий позволит вам гибко настраивать прием журнала действий.

## <a name="prerequisites"></a>Предварительные требования

### <a name="storage-account"></a>Учетная запись хранения
Если вы архивируете журнал активности, вам необходимо [создать учетную запись хранения,](../../storage/common/storage-account-create.md) если у вас ее еще нет. Не следует использовать существующую учетную запись хранения, в ней хранятся другие данные, не связанные с мониторингом, чтобы можно было лучше контролировать доступ к данным мониторинга. Если вы также архивируете журналы и метрики для учетной записи хранилища, вы можете использовать ту же учетную запись хранения, чтобы хранить все данные мониторинга в центральном месте.

Учетная запись хранения не обязательно должна находиться в той самой подписке, в которой создаются журналы, если у пользователя, настраивающего параметр, имеется соответствующий доступ RBAC к обеим подпискам. 

> [!TIP]
> [См. Наверстать брандмауэры Azure Storage и виртуальные сети](https://docs.microsoft.com/azure/storage/common/storage-network-security#exceptions) для обеспечения доступа к учетной записи хранилища за защищенной виртуальной сетью.

### <a name="event-hubs"></a>Центры событий
Если вы отправляете журнал активности в концентратор событий, то вам необходимо [создать концентратор событий,](../../event-hubs/event-hubs-create.md) если у вас его еще нет. Если вы ранее транслировали события журнала активности в это пространство имен концентраторов событий, то этот концентратор событий будет повторно использован.

Политика общего доступа определяет разрешения, предоставленные для механизма потоковой передачи. Потоковая передача концентрам событий требует разрешения на управление, отправку и прослушивание. Политики общего доступа для пространства имен Центров событий можно создать или изменить на портале Azure, на вкладке Настройка соответствующего пространства имен.

Чтобы обновить профиль журнала «Нтиз» для включения потоковой передачи, необходимо иметь разрешение ListKey в этом правиле авторизации концентраторов событий. Пространство имен службы "Центры событий Azure" не должно находиться в той же подписке, что и подписка, генерирующая журналы, если пользователь, который настраивает этот параметр, имеет соответствующий доступ RBAC к обеим подпискам, и обе подписки находятся в том же клиенте AAD.

Поток журнала активности в концентратор событий, [создавая профиль журнала.](#create-a-log-profile)

## <a name="create-a-log-profile"></a>Создание профиля журнала
Вы определяете, как экспортируется журнал деятельности Azure с помощью **профиля журнала.** Каждая подписка Azure может иметь только один профиль журнала. Эти параметры можно настроить с помощью опции **Экспорт** в лезвии журнала активности на портале. Их также можно настроить программно [с помощью REST API Azure Monitor](https://msdn.microsoft.com/library/azure/dn931927.aspx), командлетов PowerShell или интерфейса командной строки.

Профиль журнала определяет следующее.

**Куда следует отправить журнал активности.** В настоящее время доступными вариантами являются учетная запись хранения или концентраторы событий.

**Какие категории событий должны быть отправлены.** Значение *категории* в профилях журнала и событиях журнала активности отличается. В профиле журнала *категория* представляет тип операции (Запись, Удаление, Действие). В событии журнала активности *категория*«свойство» представляет источник или тип события (например, Administration, ServiceHealth и Alert).

**Какие регионы (локации) должны экспортироваться.** Вы должны включать все места, так как многие события в журнале активности являются глобальными событиями.

**Как долго должен храниться журнал действий в учетной записи хранения.** Срок хранения 0 дней означает, что журналы хранятся неограниченно долго. В противном случае значение может соответься любым количеством дней от 1 до 365.

Если политики удержания установлены, но хранение журналов в учетной записи хранилища отключено, то политики удержания не имеют никакого эффекта. Политики хранения применяются по дням, поэтому в конце дня (по времени в формате UTC) журналы, срок которых теперь превышает период хранения, будут удалены. Например, если настроена политика хранения в течение одного дня, то в начале текущего дня журналы за вчерашний день будет удалены. Удаление начинается в полночь по времени UTC. Обратите внимание, что удаление журналов из учетной записи хранения может занять до 24 часов.


> [!IMPORTANT]
> Вы можете получить ошибку при создании профиля журнала, если поставщик ресурсов Microsoft.Insights не зарегистрирован. Для регистрации этого поставщика ресурсов Azure можно увидеть [поставщиков ресурсов и типов Azure.](../../azure-resource-manager/management/resource-providers-and-types.md)


### <a name="create-log-profile-using-the-azure-portal"></a>Создание профиля журнала с помощью портала Azure

Создайте или отспособите профиль журнала с опцией **«Экспорт в концентратор событий»** на портале Azure.

1. Из меню **Azure Monitor** на портале Azure выберите **журнал activity.**
3. Нажмите **На настройки диагностики**.

   ![Параметры диагностики](media/diagnostic-settings-subscription/diagnostic-settings.png)

4. Нажмите фиолетовый баннер для наследия опыт.

    ![Наследие опыта](media/diagnostic-settings-subscription/legacy-experience.png)

3. В появляется лезвие, укажите следующее:
   * Регионы с событиями на экспорт. Необходимо выбрать все регионы, чтобы убедиться, что вы не пропустите ключевые события, так как журнал активности является глобальным (нерегиональным) журналом, и поэтому в большинстве событий нет региона, связанного с ними.
   * Если вы хотите написать на учетную запись хранения:
       * Учетная запись хранилища, на которую вы хотели бы сохранить события.
       * Количество дней, которые вы хотите сохранить эти события в хранилище. (если выбрать значение "0 дней", журналы будут храниться бессрочно);
   * Если вы хотите написать в концентратор событий:
       * Название сервиса, в котором вы хотели бы создать концентратор событий для потоковой передачи этих событий.

     ![Колонка экспорта журнала действий](./media/activity-logs-overview/activity-logs-portal-export-blade.png)


4. Нажмите кнопку **Сохранить** , чтобы сохранить эти параметры. Параметры будут немедленно применены к подписке


### <a name="configure-log-profile-using-powershell"></a>Настройка профиля журнала с помощью PowerShell

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

Если профиль журнала уже существует, сначала необходимо удалить существующий профиль журнала, а затем создать новый.

1. Используйте `Get-AzLogProfile`, чтобы проверить, существует ли профиль журнала.  Если профиль журнала существует, обратите внимание на свойство *имени.*

1. Удалите журнал профиля с помощью `Remove-AzLogProfile`, используя значение свойства *name*.

    ```powershell
    # For example, if the log profile name is 'default'
    Remove-AzLogProfile -Name "default"
    ```

3. Создайте профиль журнала с помощью `Add-AzLogProfile`:

    ```powershell
    Add-AzLogProfile -Name my_log_profile -StorageAccountId /subscriptions/s1/resourceGroups/myrg1/providers/Microsoft.Storage/storageAccounts/my_storage -serviceBusRuleId /subscriptions/s1/resourceGroups/Default-ServiceBus-EastUS/providers/Microsoft.ServiceBus/namespaces/mytestSB/authorizationrules/RootManageSharedAccessKey -Location global,westus,eastus -RetentionInDays 90 -Category Write,Delete,Action
    ```

    | Свойство | Обязательно | Описание |
    | --- | --- | --- |
    | name |Да |Имя профиля журнала. |
    | StorageAccountId |нет |Идентификатор ресурса учетной записи хранения, в котором должен быть сохранен журнал активности. |
    | serviceBusRuleId |нет |Идентификатор правила служебной шины для пространства имен служебной шины, в котором вы сможете создать концентраторы событий. Это строка с форматом: `{service bus resource ID}/authorizationrules/{key name}`. |
    | Расположение |Да |Разделенный запятыми список регионов, для которых будут собираться события журнала действий. |
    | RetentionInDays |Да |Количество дней, в течение которых события должны быть сохранены в учетной записи хранилища, между 1 и 365. Нулевое значение означает, что журналы хранятся неограниченно долго. |
    | Категория |нет |Разделенный запятыми список категорий событий, которые будут собираться. Возможные значения _— запись,_ _удаление_и _действие._ |

### <a name="example-script"></a>Пример сценария
Ниже приводится пример сценария PowerShell для создания профиля журнала, который записывает журнал активности как в учетную запись хранения, так и в концентратор событий.

   ```powershell
   # Settings needed for the new log profile
   $logProfileName = "default"
   $locations = (Get-AzLocation).Location
   $locations += "global"
   $subscriptionId = "<your Azure subscription Id>"
   $resourceGroupName = "<resource group name your event hub belongs to>"
   $eventHubNamespace = "<event hub namespace>"

   # Build the service bus rule Id from the settings above
   $serviceBusRuleId = "/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.EventHub/namespaces/$eventHubNamespace/authorizationrules/RootManageSharedAccessKey"

   # Build the storage account Id from the settings above
   $storageAccountId = "/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.Storage/storageAccounts/$storageAccountName"

   Add-AzLogProfile -Name $logProfileName -Location $locations -ServiceBusRuleId $serviceBusRuleId
   ```


### <a name="configure-log-profile-using-azure-cli"></a>Настройка профиля журнала с помощью Azure CLI

Если профиль журнала уже существует, сначала удалите его, а затем создайте новый.

1. Используйте `az monitor log-profiles list`, чтобы проверить, существует ли профиль журнала.
2. Удалите журнал профиля с помощью `az monitor log-profiles delete --name "<log profile name>`, используя значение свойства *name*.
3. Создайте профиль журнала с помощью `az monitor log-profiles create`:

   ```azurecli-interactive
   az monitor log-profiles create --name "default" --location null --locations "global" "eastus" "westus" --categories "Delete" "Write" "Action"  --enabled false --days 0 --service-bus-rule-id "/subscriptions/<YOUR SUBSCRIPTION ID>/resourceGroups/<RESOURCE GROUP NAME>/providers/Microsoft.EventHub/namespaces/<EVENT HUB NAME SPACE>/authorizationrules/RootManageSharedAccessKey"
   ```

    | Свойство | Обязательно | Описание |
    | --- | --- | --- |
    | name |Да |Имя профиля журнала. |
    | storage-account-id |Да |Идентификатор ресурса для учетной записи хранения, в которую будут сохранены журналы действий. |
    | Расположения |Да |Разделенный пробелами список регионов, для которых будут собираться события журнала действий. Вы можете просмотреть список всех регионов для своей подписки с помощью `az account list-locations --query [].name`. |
    | days |Да |Количество дней, в течение которых события должны быть сохранены, между 1 и 365. Нулевое значение означает, что журналы будут храниться неограниченно долго, то есть всегда.  Если ноль, то включенный параметр должен быть установлен на ложный. |
    |Включено | Да |Значение True или False.  Позволяет включить или отключить политику хранения.  Если установлено значение True, параметр дней должен иметь значение больше 0.
    | Категории |Да |Разделенный пробелами список категорий событий, которые будут собираться. Возможные значения: Write, Delete или Action. |



## <a name="next-steps"></a>Дальнейшие действия

* [Узнайте больше о журнале активности](../../azure-resource-manager/management/view-activity-logs.md)
* [Сбор журналов активности в журналы мониторинга Azure](activity-log-collect.md)
