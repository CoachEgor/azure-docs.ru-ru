---
title: Экспорт журнала действий Azure
description: Экспортируйте журнал действий Azure в хранилище для архивации или концентраторы событий Azure для экспорта за пределами Azure.
author: bwren
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 05/20/2019
ms.author: bwren
ms.subservice: logs
ms.openlocfilehash: ff8956d942aa54500a08cac4ebd94127b14b0bd4
ms.sourcegitcommit: a5ebf5026d9967c4c4f92432698cb1f8651c03bb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2019
ms.locfileid: "74931763"
---
# <a name="export-azure-activity-log-to-storage-or-azure-event-hubs"></a>Экспорт журнала действий Azure в хранилище или концентраторы событий Azure

> [!WARNING]
> Теперь можно выполнить сбор журнала действий в Log Analytics рабочую область, используя параметр диагностики, аналогичный сбору журналов ресурсов. См. статью [Получение и анализ журналов действий Azure в log Analytics рабочей области в Azure Monitor](diagnostic-settings-subscription.md).

[Журнал действий Azure](activity-logs-overview.md) позволяет получить представление о событиях уровня подписки, произошедших в подписке Azure. Помимо просмотра журнала действий в портал Azure или его копирования в Log Analytics рабочую область, где его можно проанализировать с помощью других данных, собранных Azure Monitor, можно создать профиль журнала для архивации журнала действий в учетную запись хранения Azure или потоковой передачи в  Концентратор событий.

## <a name="archive-activity-log"></a>Архивировать журнал действий
Архивация журнала действий в учетную запись хранения полезна, если вы хотите хранить данные журнала дольше 90 дней (с полным контролем над политикой хранения) для аудита, статического анализа или резервного копирования. Если вам нужно хранить события только в течение 90 дней или меньше, вам не нужно настраивать архивацию для учетной записи хранения, так как события журнала действий сохраняются на платформе Azure в течение 90 дней.

## <a name="stream-activity-log-to-event-hub"></a>Потоковая передача журнала действий в концентратор событий
[Концентраторы событий Azure](/azure/event-hubs/) — это платформа потоковой передачи данных и служба приема событий, которая может принимать и обрабатывать миллионы событий в секунду. Данные, отправляемые в концентратор событий, можно преобразовывать и сохранять с помощью любого поставщика аналитики в реальном времени, а также с помощью адаптеров пакетной обработки или хранения. Для журнала действий можно использовать возможности потоковой передачи:
* **Потоковая передача в сторонние системы ведения журнала и сбора телеметрии.** Со временем Центры событий Azure будут использоваться для передачи журнала действий в сторонние решения SIEM и решения для анализа журналов.
* **Создание пользовательской платформы для телеметрии и ведения журнала.** Если у вас уже есть пользовательская платформа для телеметрии и ведения журнала или вы только планируете ее создать, высокая масштабируемость публикации и подписки Центров событий позволит вам гибко настраивать прием журнала действий. 

## <a name="prerequisites"></a>Технические условия

### <a name="storage-account"></a>Учетная запись хранения
Если вы выполняете архивацию журнала действий, необходимо [создать учетную запись хранения](../../storage/common/storage-quickstart-create-account.md) , если она еще не создана. Не следует использовать существующую учетную запись хранения, в которой хранятся другие данные, не относящиеся к мониторингу, чтобы лучше управлять доступом к данным мониторинга. Если вы также выполняете архивирование журналов и метрик в учетную запись хранения, вы можете использовать эту же учетную запись хранения для хранения всех данных мониторинга в централизованном расположении.

Учетная запись хранения не обязательно должна находиться в той самой подписке, в которой создаются журналы, если у пользователя, настраивающего параметр, имеется соответствующий доступ RBAC к обеим подпискам.
> [!NOTE]
>  Сейчас невозможно архивировать данные в учетную запись хранения, которая находится в защищенной виртуальной сети.

### <a name="event-hubs"></a>Концентраторы событий
Если вы отправляете журнал действий в концентратор событий, необходимо [создать концентратор событий](../../event-hubs/event-hubs-create.md) , если он еще не создан. Если вы ранее перестроили события журнала действий в это пространство имен концентраторов событий, то этот концентратор событий будет использоваться повторно.

Политика общего доступа определяет разрешения, предоставленные для механизма потоковой передачи. Потоковая передача в концентраторы событий требует разрешений на управление, отправку и прослушивание. Вы можете создать или изменить политики общего доступа для пространства имен концентраторов событий в портал Azure на вкладке Настройка для пространства имен концентраторов событий.

Чтобы обновить профиль журнала действий для включения потоковой передачи, необходимо иметь разрешение ListKey для этого правила авторизации концентраторов событий. Пространство имен службы "Центры событий Azure" не должно находиться в той же подписке, что и подписка, генерирующая журналы, если пользователь, который настраивает этот параметр, имеет соответствующий доступ RBAC к обеим подпискам, и обе подписки находятся в том же клиенте AAD.

Потоковая передача журнала действий в концентратор событий путем [создания профиля журнала](#create-a-log-profile).

## <a name="create-a-log-profile"></a>Создание профиля журнала
Вы определяете, как экспортируется журнал действий Azure с помощью **профиля журнала**. Каждая подписка Azure может иметь только один профиль журнала. Эти параметры можно настроить с помощью параметра **Экспорт** в колонке журнал действий на портале. Их также можно настроить программно [с помощью REST API Azure Monitor](https://msdn.microsoft.com/library/azure/dn931927.aspx), командлетов PowerShell или интерфейса командной строки.

Профиль журнала определяет следующее.

**Место отправки журнала действий.** В настоящее время доступны параметры — учетная запись хранения или концентраторы событий.

**Какие категории событий следует отправлять.** Значение *Category* в профилях журналов и событиях журнала действий отличается. В профиле журнала *Категория* представляет тип операции (запись, удаление, действие). В событии журнала действий *Категория*"*" представляет источник или тип события (например, "Администрирование", "ServiceHealth" и "предупреждение").

**Какие регионы (расположения) следует экспортировать.** Необходимо включить все расположения, так как многие события в журнале действий являются глобальными событиями.

**Как долго журнал действий должен храниться в учетной записи хранения.** Срок хранения 0 дней означает, что журналы хранятся неограниченно долго. В противном случае значение может быть любым числом дней от 1 до 365.

Если заданы политики хранения, но хранение журналов в учетной записи хранения отключено, политики хранения не будут действовать. Политики хранения применяются по дням, поэтому в конце дня (по времени в формате UTC) журналы, срок которых теперь превышает период хранения, будут удалены. Например, если настроена политика хранения в течение одного дня, то в начале текущего дня журналы за вчерашний день будет удалены. Удаление начинается в полночь по времени UTC. Обратите внимание, что удаление журналов из учетной записи хранения может занять до 24 часов.


> [!IMPORTANT]
> При создании профиля журнала может появиться сообщение об ошибке, если поставщик ресурсов Microsoft. Insights не зарегистрирован. Чтобы зарегистрировать поставщик, см. раздел [поставщики и типы ресурсов Azure](../../azure-resource-manager/resource-manager-supported-services.md) .


### <a name="create-log-profile-using-the-azure-portal"></a>Создание профиля журнала с помощью портал Azure

Создайте или измените профиль журнала с помощью параметра **Экспорт в концентратор событий** в портал Azure.

1. В меню **мониторинг** портал Azure выберите пункт **Экспорт в концентратор событий**.

    ![Кнопка экспорта на портале](media/activity-log-export/portal-export.png)

3. В появившейся колонке укажите следующее:
   * Регионы с экспортируемыми событиями. Следует выбрать все регионы, чтобы не пропускать ключевые события, так как журнал действий является глобальным (не региональным) журналом, поэтому большинство событий не имеет связанного с ними региона. 
   * Если вы хотите выполнить запись в учетную запись хранения:
       * Учетная запись хранения, в которую вы хотите сохранить события.
       * Число дней, в течение которых необходимо хранить эти события в хранилище. (если выбрать значение "0 дней", журналы будут храниться бессрочно);
   * Если вы хотите записать в концентратор событий:
       * Пространство имен служебной шины, в котором вы хотите создать концентратор событий для потоковой передачи этих событий.

     ![Колонка экспорта журнала действий](./media/activity-logs-overview/activity-logs-portal-export-blade.png)


4. Нажмите кнопку **Сохранить** , чтобы сохранить эти параметры. Параметры будут немедленно применены к подписке


### <a name="configure-log-profile-using-powershell"></a>Настройка профиля журнала с помощью PowerShell

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

Если профиль журнала уже существует, сначала необходимо удалить существующий профиль журнала, а затем создать новый.

1. Используйте `Get-AzLogProfile`, чтобы проверить, существует ли профиль журнала.  Если профиль журнала существует, обратите внимание на свойство *Name* .

1. Удалите журнал профиля с помощью `Remove-AzLogProfile`, используя значение свойства *name*.

    ```powershell
    # For example, if the log profile name is 'default'
    Remove-AzLogProfile -Name "default"
    ```

3. Создайте профиль журнала с помощью `Add-AzLogProfile`:

    ```powershell
    Add-AzLogProfile -Name my_log_profile -StorageAccountId /subscriptions/s1/resourceGroups/myrg1/providers/Microsoft.Storage/storageAccounts/my_storage -serviceBusRuleId /subscriptions/s1/resourceGroups/Default-ServiceBus-EastUS/providers/Microsoft.ServiceBus/namespaces/mytestSB/authorizationrules/RootManageSharedAccessKey -Location global,westus,eastus -RetentionInDays 90 -Category Write,Delete,Action
    ```

    | Свойство | Обязательно для заполнения | Описание |
    | --- | --- | --- |
    | Name |ДА |Имя профиля журнала. |
    | StorageAccountId |Нет |Идентификатор ресурса учетной записи хранения, в которой должен быть сохранен журнал действий. |
    | serviceBusRuleId |Нет |Идентификатор правила служебной шины для пространства имен служебной шины, в котором вы сможете создать концентраторы событий. Это строка с форматом: `{service bus resource ID}/authorizationrules/{key name}`. |
    | Location |ДА |Разделенный запятыми список регионов, для которых будут собираться события журнала действий. |
    | RetentionInDays |ДА |Число дней, в течение которых события должны храниться в учетной записи хранения в диапазоне от 1 до 365. Нулевое значение означает, что журналы хранятся неограниченно долго. |
    | Категория |Нет |Разделенный запятыми список категорий событий, которые будут собираться. Возможные значения: _Write_, _Delete_и _Action_. |

### <a name="example-script"></a>Пример сценария
Ниже приведен пример скрипта PowerShell для создания профиля журнала, который записывает журнал действий в учетную запись хранения и концентратор событий.

   ```powershell
   # Settings needed for the new log profile
   $logProfileName = "default"
   $locations = (Get-AzLocation).Location
   $locations += "global"
   $subscriptionId = "<your Azure subscription Id>"
   $resourceGroupName = "<resource group name your event hub belongs to>"
   $eventHubNamespace = "<event hub namespace>"

   # Build the service bus rule Id from the settings above
   $serviceBusRuleId = "/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.EventHub/namespaces/$eventHubNamespace/authorizationrules/RootManageSharedAccessKey"

   # Build the storage account Id from the settings above
   $storageAccountId = "/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.Storage/storageAccounts/$storageAccountName"

   Add-AzLogProfile -Name $logProfileName -Location $locations -ServiceBusRuleId $serviceBusRuleId
   ```


### <a name="configure-log-profile-using-azure-cli"></a>Настройка профиля журнала с помощью Azure CLI

Если профиль журнала уже существует, сначала удалите его, а затем создайте новый.

1. Используйте `az monitor log-profiles list`, чтобы проверить, существует ли профиль журнала.
2. Удалите журнал профиля с помощью `az monitor log-profiles delete --name "<log profile name>`, используя значение свойства *name*.
3. Создайте профиль журнала с помощью `az monitor log-profiles create`:

   ```azurecli-interactive
   az monitor log-profiles create --name "default" --location null --locations "global" "eastus" "westus" --categories "Delete" "Write" "Action"  --enabled false --days 0 --service-bus-rule-id "/subscriptions/<YOUR SUBSCRIPTION ID>/resourceGroups/<RESOURCE GROUP NAME>/providers/Microsoft.EventHub/namespaces/<EVENT HUB NAME SPACE>/authorizationrules/RootManageSharedAccessKey"
   ```

    | Свойство | Обязательно для заполнения | Описание |
    | --- | --- | --- |
    | name |ДА |Имя профиля журнала. |
    | storage-account-id |ДА |Идентификатор ресурса для учетной записи хранения, в которую будут сохранены журналы действий. |
    | Расположения |ДА |Разделенный пробелами список регионов, для которых будут собираться события журнала действий. Вы можете просмотреть список всех регионов для своей подписки с помощью `az account list-locations --query [].name`. |
    | days |ДА |Число дней, в течение которых должны храниться события, от 1 до 365. Нулевое значение означает, что журналы будут храниться неограниченно долго, то есть всегда.  Если значение равно нулю, то параметру Enabled должно быть присвоено значение false. |
    |включено | ДА |Значение True или False.  Позволяет включить или отключить политику хранения.  Если установлено значение True, параметр дней должен иметь значение больше 0.
    | Категории |ДА |Разделенный пробелами список категорий событий, которые будут собираться. Возможные значения: Write, Delete или Action. |



## <a name="activity-log-schema"></a>Схема журнала действий
Независимо от того, отправлены ли в службу хранилища Azure или концентратор событий, данные журнала действий будут записаны в JSON в следующем формате.


> Формат данных журнала действий, записываемых в учетную запись хранения, изменился на строки JSON в 2018 ноября. 1. Дополнительные сведения об этом изменении формата см. в разделе [Подготовка к изменению формата для Azure Monitor журналов ресурсов, архивных в учетной записи хранения](diagnostic-logs-append-blobs.md) .

``` JSON
{
    "records": [
        {
            "time": "2015-01-21T22:14:26.9792776Z",
            "resourceId": "/subscriptions/s1/resourceGroups/MSSupportGroup/providers/microsoft.support/supporttickets/115012112305841",
            "operationName": "microsoft.support/supporttickets/write",
            "category": "Write",
            "resultType": "Success",
            "resultSignature": "Succeeded.Created",
            "durationMs": 2826,
            "callerIpAddress": "111.111.111.11",
            "correlationId": "c776f9f4-36e5-4e0e-809b-c9b3c3fb62a8",
            "identity": {
                "authorization": {
                    "scope": "/subscriptions/s1/resourceGroups/MSSupportGroup/providers/microsoft.support/supporttickets/115012112305841",
                    "action": "microsoft.support/supporttickets/write",
                    "evidence": {
                        "role": "Subscription Admin"
                    }
                },
                "claims": {
                    "aud": "https://management.core.windows.net/",
                    "iss": "https://sts.windows.net/72f988bf-86f1-41af-91ab-2d7cd011db47/",
                    "iat": "1421876371",
                    "nbf": "1421876371",
                    "exp": "1421880271",
                    "ver": "1.0",
                    "http://schemas.microsoft.com/identity/claims/tenantid": "1e8d8218-c5e7-4578-9acc-9abbd5d23315 ",
                    "http://schemas.microsoft.com/claims/authnmethodsreferences": "pwd",
                    "http://schemas.microsoft.com/identity/claims/objectidentifier": "2468adf0-8211-44e3-95xq-85137af64708",
                    "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn": "admin@contoso.com",
                    "puid": "20030000801A118C",
                    "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier": "9vckmEGF7zDKk1YzIY8k0t1_EAPaXoeHyPRn6f413zM",
                    "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname": "John",
                    "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname": "Smith",
                    "name": "John Smith",
                    "groups": "cacfe77c-e058-4712-83qw-f9b08849fd60,7f71d11d-4c41-4b23-99d2-d32ce7aa621c,31522864-0578-4ea0-9gdc-e66cc564d18c",
                    "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name": " admin@contoso.com",
                    "appid": "c44b4083-3bq0-49c1-b47d-974e53cbdf3c",
                    "appidacr": "2",
                    "http://schemas.microsoft.com/identity/claims/scope": "user_impersonation",
                    "http://schemas.microsoft.com/claims/authnclassreference": "1"
                }
            },
            "level": "Information",
            "location": "global",
            "properties": {
                "statusCode": "Created",
                "serviceRequestId": "50d5cddb-8ca0-47ad-9b80-6cde2207f97c"
            }
        }
    ]
}
```
Элементы в этом JSON описаны в следующей таблице.

| Имя элемента | Описание |
| --- | --- |
| time |Метка времени, когда служба Azure создала событие при обработке соответствующего этому событию запроса. |
| ResourceId |Идентификатор ресурса для затронутого ресурса. |
| operationName |Имя операции. |
| category |Категория действия, например "Запись", "Чтение", "Действие" |
| resultType |Тип результата, например "Успешно", "Ошибка", "Запуск" |
| resultSignature |Зависит от типа ресурса. |
| durationMs |Время выполнения операции в миллисекундах |
| callerIpAddress |IP-адрес пользователя, который выполнил операцию, утверждение имени субъекта-службы или имени участника-пользователя в зависимости от доступности. |
| correlationId |Обычно GUID в строковом формате. События, которые совместно используют идентификатор correlationId, принадлежат к одному общему действию. |
| удостоверение |Большой двоичный объект JSON, описывающий авторизацию и утверждения. |
| authorization |BLOB-объект со свойствами RBAC события. Обычно включает следующие свойства: action, role и scope. |
| level |Уровень события. Одно из следующих значений: _критическая_, _Ошибка_, _предупреждение_, _информационное_и _подробное_ . |
| location |Регион, к которому принадлежит расположение (или глобальное местоположение). |
| properties |Набор пар `<Key, Value>` (например, Dictionary) c подробным описанием события. |

> [!NOTE]
> Свойства и использование этих свойств могут различаться в зависимости от ресурса.



## <a name="next-steps"></a>Дальнейшие действия

* [См. дополнительные сведения о журнале действий](../../azure-resource-manager/resource-group-audit.md)
* [Собирайте журналы действий в журналах Azure Monitor](activity-log-collect.md)
