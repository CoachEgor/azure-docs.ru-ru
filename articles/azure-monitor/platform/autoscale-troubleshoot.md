---
title: Автоматическое устранение проблем Azure
description: Отслеживание проблем с автомасштабированием Azure, используемым в сервисных технологиях, виртуальных машинах, веб-приложениях и облачных сервисах.
ms.topic: conceptual
ms.date: 11/4/2019
ms.subservice: autoscale
ms.openlocfilehash: 9780cf88070110c4efc13c477d65307aa3985fe5
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75751333"
---
# <a name="troubleshooting-azure-autoscale"></a>Автоматическое устранение проблем Azure
 
Автомасштабazура Monitor помогает вам иметь нужное количество ресурсов, работающих для обработки нагрузки на приложение. Это позволяет добавлять ресурсы для обработки увеличения нагрузки, а также экономить деньги, удаляя ресурсы, которые простаивают. Масштабировать можно на основе расписания, фиксированного времени даты или метрики ресурсов, которые вы выберете. Для получения дополнительной информации [см.](autoscale-overview.md)

Сервис автомасштабирования предоставляет метрики и журналы, чтобы понять, какие действия масштаба произошли и оценку условий, которые привели к этим действиям. Вы можете найти ответы на такие вопросы, как:

- Почему мой сервис масштабируется или в ней?
- Почему мой сервис не масштабируется?
- Почему автоматическое действие сбой?
- Почему для масштабирования автомасштабного действия необходимо время?
  
## <a name="autoscale-metrics"></a>Автомасштабные метрики

Autoscale предоставляет четыре [метрики,](metrics-supported.md#microsoftinsightsautoscalesettings) чтобы понять его работу. 

- **Наблюдаемая метическая величина** - Значение метрики, на которую вы решили принять действие масштаба, как видно или вычисляется автоматическим двигателем. Поскольку один автоматический параметр может иметь несколько правил и, следовательно, несколько метрических источников, можно фильтровать с помощью "метрического источника" в качестве измерения.
- **Метрический порог** - порог, который вы установили для действия масштаба. Поскольку один автоматический параметр может иметь несколько правил и, следовательно, несколько метрических источников, можно фильтровать с помощью "метрического правила" в качестве измерения.
- **Наблюдаемая емкость** - активное количество экземпляров целевого ресурса, как видно на autoscale двигателя.
- **Инициированные действия масштабирования.** Указывает количество действий горизонтального масштабирования, инициированных подсистемой автомасштабирования. Вы можете фильтровать по масштабу по сравнению с масштабом в действиях.

Вы можете использовать [Explorer метрик,](metrics-getting-started.md) чтобы наметить приведенные выше метрики все в одном месте. Диаграмма должна показать:

  - фактическая метрика
  - метрики, как видно / вычисляется автоматическим двигателем
  - порог для действия масштаба
  - изменение емкости 

## <a name="example-1---analyzing-a-simple-autoscale-rule"></a>Пример 1 - Анализ простого правила автомасштабного масштаба 

У нас есть простой автоматический набор для виртуального набора масштабов машины, который:

- масштабируется, когда средний процент процессора набора превышает 70% в течение 10 минут 
- весы, когда процент процессора набора составляет менее 5% в течение более 10 минут. 

Давайте рассмотрим метрики из автомасштабного сервиса.
 
![Пример примера процессора виртуальной шкалы машины](media/autoscale-troubleshoot/autoscale-vmss-CPU-ex-full-1.png)

![Пример примера процессора виртуальной шкалы машины](media/autoscale-troubleshoot/autoscale-vmss-CPU-ex-full-2.png)

***Рисунок 1a - Процентная метрика процессора для набора виртуальной шкалы машин и метрика наблюдаемой метрики метрики для автоматического параметра***

![Метрический порог и наблюдаемая емкость](media/autoscale-troubleshoot/autoscale-metric-threshold-capacity-ex-full.png)

***Рисунок 1b - Метрический порог и наблюдаемая емкость***

На рисунке **1b, метрический порог** (светло-голубая линия) для правила масштабирования составляет 70.  **Наблюдаемая емкость** (темно-синяя линия) показывает количество активных экземпляров, которое в настоящее время составляет 3. 

> [!NOTE]
> Для просмотра порога масштабирования масштаба масштабирования (увеличения) порога масштабирования масштаба и шкалы в правиле (уменьшение) необходимо отфильтровать **метрический порог** по размеру измерения измерения триггера. 

## <a name="example-2---advanced-autoscaling-for-a-virtual-machine-scale-set"></a>Пример 2 - Расширенный автомасштабирование для набора виртуальной машины

У нас есть автоматическое измерение, которое позволяет виртуальному набору машинного набора ресурса масштабироваться на основе собственных метрических **исходящих потоков.** Обратите внимание, что проверяется **параметр разделения по отсчету экземпляров** для порога метрики. 

Правило действия масштаба: 

Если значение **исходящего потока в экземпляре** превышает 10, то автомасштабическая служба должна масштабироваться на 1 экземпляр. 

В этом случае наблюдаемое метрическое значение автоматического двигателя рассчитывается как фактическое метрическое значение, разделенное на количество экземпляров. Если наблюдаемое значение метрики меньше порога, действие по масштабу не инициируется. 
 
![Пример диаграмм автомасштабных метрик виртуальной шкалы машины](media/autoscale-troubleshoot/autoscale-vmss-metric-chart-ex-1.png)

![Пример диаграмм автомасштабных метрик виртуальной шкалы машины](media/autoscale-troubleshoot/autoscale-vmss-metric-chart-ex-2.png)

***Рисунок 2 - Виртуальная машина масштаб набора автомасштабных метрик диаграммы пример***

На рисунке 2 можно увидеть две метрические диаграммы. 

Диаграмма сверху показывает фактическое значение метрики **исходящих потоков.** Фактическое значение 6. 

На графике внизу показано несколько значений. 
 - **Наблюдаемое значение метрики** (светло-голубой) составляет 3, поскольку существует 2 активных экземпляра и 6 разделенных на 2- и 3. 
 - **Наблюдаемая емкость** (фиолетовый) показывает количество экземпляров, увиденное автоматическим двигателем. 
 - **Метрический порог** (светло-зеленый) установлен до 10. 

При наличии нескольких правил действия масштаба можно использовать разделение или опцию **фильтра добавления** в диаграмме Explorer Метрики, чтобы посмотреть на метрику по определенному источнику или правилу. Для получения дополнительной информации о разделении метрической [диаграммы см. Расширенные функции метрических диаграмм - расщепление](metrics-charts.md#apply-splitting-to-a-chart)

## <a name="example-3---understanding-autoscale-events"></a>Пример 3 - Понимание событий автомасштаба

На экране настройки автоматической шкалы перейдите на вкладку **«История запуска»,** чтобы увидеть последние действия масштаба. Вкладка также показывает изменение **наблюдаемой емкости** с течением времени. Чтобы узнать более подробную информацию обо всех действиях автомасштаба, включая такие операции, как настройки автоматического масштаба обновления/удаления, просмотрите журнал действий и фильтр с помощью автоматических операций.

![Настройки автоматического масштаба выполнения истории](media/autoscale-troubleshoot/autoscale-setting-run-history-smaller.png)

## <a name="autoscale-resource-logs"></a>Автомасштабресурсные журналы ресурсов

Так же, как и любой другой ресурс Azure, служба автомасштабирования предоставляет [журналы ресурсов.](platform-logs-overview.md) Есть две категории журналов.

- **Автомасштабная оценка** - автоматический двигатель записывает записи журнала для каждого состояния оценки каждый раз, когда он делает проверку.  Запись содержит подробную информацию о наблюдаемых значениях метрик, оцениваемых правилах и о том, привела ли оценка к действию масштаба или нет.

- **Действия автомасштабной шкалы** - Двигатель записывает масштабные события действия, инициированные автосервисом, и результаты этих масштабов действий (успех, сбой, и сколько масштабирования произошло, как видно на автомасштабной службы).

Как и в случае с любой службой поддержки Azure Monitor, для маршрутизации этих журналов можно использовать [диагностические настройки:](diagnostic-settings.md)

- к вашему рабочему пространству Log Analytics для детальной аналитики
- кцентратам событий, а затем к инструментам, не являеващемуся Azure
- к вашему счету хранения Azure для архива  

![Автомасштабные диагностические настройки](media/autoscale-troubleshoot/diagnostic-settings.png)

На предыдущем рисунке показаны настройки автоматической диагностики портала Azure. Там вы можете выбрать вкладку Журналы диагностики/ресурсов и включить сбор журналов и их распределение. Вы также можете выполнять те же действия с помощью REST API, CLI, PowerShell, шаблонов менеджера ресурсов для диагностических настроек, выбрав тип ресурса *как Microsoft.Insights/AutoscaleSettings.* 

## <a name="troubleshooting-using-autoscale-logs"></a>Устранение неполадок с помощью автомасштабных журналов 

Для лучшего устранения неполадок мы рекомендуем переодевание журналов в журналы Azure Monitor (Log Analytics) через рабочее пространство при создании автоматической настройки. Этот процесс показан на картинке в предыдущем разделе. Вы можете проверить оценки и масштабировать действия лучше с помощью log Analytics.

После настройки журналов автомасштабов для отправки в рабочее пространство Log Analytics можно выполнить следующие запросы для проверки журналов. 

Чтобы начать работу, попробуйте этот запрос, чтобы просмотреть последние журналы автомасштабной оценки:

```Kusto
AutoscaleEvaluationsLog
| limit 50
```

Или попробуйте следующий запрос для просмотра последних журналов действий масштаба:

```Kusto
AutoscaleScaleActionsLog
| limit 50
```

Используйте следующие разделы для этих вопросов. 

## <a name="a-scale-action-occurred-that-i-didnt-expect"></a>Произошло действие масштаба, которого я не ожидал

Сначала выполните запрос для действия масштаба, чтобы найти интересуемые действия масштаба. Если это последнее действие масштаба, используйте следующий запрос:

```Kusto
AutoscaleScaleActionsLog
| take 1
```

Выберите поле CorrelationId из журнала действий масштаба. Используйте CorrelationId, чтобы найти нужный журнал оценки. Выполнение ниже приведенного запроса будет отображать все правила и условия, оцениваемые, ведущие к действию этого масштаба.

```Kusto
AutoscaleEvaluationsLog
| where CorrelationId = "<correliationId>"
```

## <a name="what-profile-caused-a-scale-action"></a>Какой профиль вызвал действие масштаба?

Произошло масштабное действие, но у вас есть перекрывающиеся правила и профили, и необходимо отследить, что вызвало действие. 

Найдите корреляцию действия масштаба (как это объясняется в примере 1), а затем выполните запрос в журналах оценки, чтобы узнать больше о профиле.

```Kusto
AutoscaleEvaluationsLog
| where CorrelationId = "<correliationId_Guid>"
| where ProfileSelected == true
| project ProfileEvaluationTime, Profile, ProfileSelected, EvaluationResult
```

Вся оценка профиля также может быть лучше понята, используя следующий запрос

```Kusto
AutoscaleEvaluationsLog
| where TimeGenerated > ago(2h)
| where OperationName contains == "profileEvaluation"
| project OperationName, Profile, ProfileEvaluationTime, ProfileSelected, EvaluationResult
```

## <a name="a-scale-action-did-not-occur"></a>Масштабное действие не произошло

Я ожидал масштаб действий, и это не произошло. Возможно, не может быть событий действия масштаба или журналов.

Просмотрите автоматические метрики, если вы используете правило шкалы на основе метрики. Вполне возможно, что **наблюдаемое значение метрики** или **наблюдаемая емкость** не являются тем, какимвы вы их ожидали, и поэтому правило масштаба не срастало. Вы все равно увидите оценки, но не правило масштабирования. Также возможно, что время охлаждения не давало возможности действовать в масштабе. 

 Просмотрите журналы автомасштабной оценки в течение периода времени, ожидаемого действия масштаба. Просмотрите все оценки, которые он сделал, и почему он решил не инициировать действие масштаба.


```Kusto
AutoscaleEvaluationsLog
| where TimeGenerated > ago(2h)
| where OperationName == "MetricEvaluation" or OperationName == "ScaleRuleEvaluation"
| project OperationName, MetricData, ObservedValue, Threshold, EstimateScaleResult
```

## <a name="scale-action-failed"></a>Ошибка действия масштаба

Может быть случай, когда автомасштабическая служба приняла действие масштаба, но система решила не масштабировать или не завершила действие масштаба. Используйте этот запрос, чтобы найти неудавшийся масштаб действий.

```Kusto
AutoscaleScaleActionsLog
| where ResultType == "Failed"
| project ResultDescription
```

Создавайте правила оповещения для получения уведомления об автоматических действиях или сбоях. Вы также можете создать правила оповещения, чтобы получать уведомления о событиях автомасштаба.

## <a name="schema-of-autoscale-resource-logs"></a>Схема журналов автомасштабных ресурсов

Для получения дополнительной информации смотрите [журналы ресурсов автомасштаба](autoscale-resource-log-schema.md)

## <a name="next-steps"></a>Дальнейшие действия
Читайте информацию об [автомасштабной передовой практике](autoscale-best-practices.md). 
