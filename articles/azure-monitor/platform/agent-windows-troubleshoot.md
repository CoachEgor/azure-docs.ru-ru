---
title: Устранение неполадок с агентом Log Analytics для Windows | Документация Майкрософт
description: Описание симптомов, причин и решений для наиболее распространенных проблем с помощью агента Log Analytics для Windows в Azure Monitor.
services: azure-monitor
documentationcenter: ''
author: mgoedtel
manager: carmonm
editor: tysonn
ms.assetid: ''
ms.service: azure-monitor
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 06/12/2019
ms.author: magoedte
ms.openlocfilehash: afa4483677336e9a887908a8cccf9590eed27af3
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67120114"
---
# <a name="how-to-troubleshoot-issues-with-the-log-analytics-agent-for-windows"></a>Устранение неполадок с агентом Log Analytics для Windows 

Эта статья содержит справочные сведения по устранению ошибок, которые могут возникнуть с агентом Log Analytics для Windows в Azure Monitor и предлагает возможные решения для их устранения.

Если ни одна из рекомендаций не поможет устранить проблему, вы можете использовать следующие каналы поддержки:

* Клиенты с поддержкой Premier могут открыть запрос на поддержку на странице [Premier](https://premier.microsoft.com/).
* Клиенты с соглашением на поддержку Azure могут открыть запрос на поддержку на [портале Azure](https://manage.windowsazure.com/?getsupport=true).
* Посетите страницу отзывов в Log Analytics, чтобы просмотреть отправленные предложения и сообщения об ошибках [https://aka.ms/opinsightsfeedback](https://aka.ms/opinsightsfeedback) или оставить новый отзыв. 

## <a name="important-troubleshooting-sources"></a>Важные источники по устранению неполадок

 Для устранения проблемы, связанные с агентом Log Analytics для Windows, агент записывает события в журнал событий Windows, в частности в разделе *приложением и диспетчером Services\Operations*.  

## <a name="connectivity-issues"></a>Проблемы, связанные с подключением

Если агент взаимодействует через прокси-сервер или брандмауэр, могут существовать ограничения на предотвращение обмен данными между исходным компьютером и службой Azure Monitor. Если обмен данными блокируется, неправильной настройки, регистрации в рабочей области может завершиться ошибкой при попытке установить агент, настройка после установки агента для отправки отчетов в рабочую область дополнительные или связи с агентом завершается сбоем после успешной регистрации. В этом разделе описываются способы устранения такого рода проблемы с агентом Windows. 

Проверьте, что брандмауэр или прокси-сервер настроен для разрешить следующие порты и URL-адреса, описанные в следующей таблице. Также убедитесь, что проверки HTTP не включен для веб-трафика, так как он может препятствовать безопасный канал TLS между агентом и Azure Monitor.  

|Ресурс агента|порты; |Направление |Обход проверки HTTPS|
|------|---------|--------|--------|   
|*.ods.opinsights.azure.com |Порт 443 |Исходящие|Yes |  
|*.oms.opinsights.azure.com |Порт 443 |Исходящие|Yes |  
|*.blob.core.windows.net |Порт 443 |Исходящие|Yes |  
|*.azure-automation.net |Порт 443 |Исходящие|Yes |  

Сведения о брандмауэрах, необходимые для Azure для государственных организаций, см. в разделе [управления Azure для государственных организаций](../../azure-government/documentation-government-services-monitoringandmanagement.md#azure-monitor-logs). 

Существует несколько способов, чтобы узнать, если агент успешно взаимодействует с Azure Monitor.

- Включить [оценки работоспособности агента Azure Log Analytics](../insights/solution-agenthealth.md) в рабочей области. На панели мониторинга работоспособности агентов, просмотреть **число агентов, не отвечает** столбца, чтобы быстро просмотреть, если он отображается.  

- Выполните следующий запрос, чтобы убедиться, что агент отправляет периодический сигнал, настроенного для отправки отчетов в рабочей области. Замените <ComputerName> фактическим именем компьютера.

    ```
    Heartbeat 
    | where Computer like "<ComputerName>"
    | summarize arg_max(TimeGenerated, * ) by Computer 
    ```

    Если компьютер успешно взаимодействует со службой, запрос должен возвращать результат. Если запрос не вернул результат, сначала убедитесь, что агент настроен для отправки отчетов в нужной рабочей области. Если настроена правильно, перейдите к шагу 3 и найдите журнал событий Windows, чтобы выявить точку, ведение журнала агента какие проблемы могут препятствовать его взаимодействие с Azure Monitor.

- Другой метод, чтобы определить проблему с подключением — запустив **TestCloudConnectivity** средство. Средство устанавливается по умолчанию с агентом в папке *%SystemRoot%\Program Files\Microsoft Monitoring Agent\Agent*. Из командной строки с повышенными привилегиями перейдите к папке и запустите средство. Средство возвращает результаты и выделения, где тест не пройден (например, если она ссылается на определенный порт и URL-адрес блокировки). 

    ![Результаты выполнения средства TestCloudConnection](./media/agent-windows-troubleshoot/output-testcloudconnection-tool-01.png)

- Фильтр *Operations Manager* журнала событий по **источники событий** - *модулей службы работоспособности*, *HealthService*, и *Service Connector* и фильтровать по **уровень события** *предупреждение* и *ошибка* для подтверждения, если он написал события из следующие таблицы. Если это так, проверьте действия по разрешению проблемы, которые включены для каждого возможного события.

    |Идентификатор события |source |Описание |Способы устранения: |
    |---------|-------|------------|-----------|
    |2133 & 2129 |Служба работоспособности |Не удалось подключиться к службе из агента |Эта ошибка может возникать, если агент не может взаимодействовать напрямую или через брандмауэр или прокси-сервера в службу Azure Monitor. Проверьте параметры прокси-сервера агента или что сетевой брандмауэр или прокси-сервер разрешает TCP-трафик от компьютера к службе.|
    |2138 |Модули службы работоспособности |Прокси-сервер требует проверки подлинности |Настройка параметров прокси-сервера агента и укажите имя пользователя и пароль, необходимые для проверки подлинности на прокси-сервере. |
    |2129 |Модули службы работоспособности |Сбой подключения "или" Сбой согласования SSL |Проверьте параметры TCP/IP сетевого адаптера и параметры прокси-сервера агента.|
    |2127 |Модули службы работоспособности |Сбой при отправке данных получен код ошибки |Если это происходит только периодически в течение дня, это может быть просто случайных аномалий, которое можно игнорировать. Монитор, чтобы понять, как часто она происходит. Если это случается часто на протяжении всего дня, сначала проверьте конфигурацию сети и параметры прокси-сервера. Если описание содержит код ошибки HTTP 404, и это в первый раз, в который агент пытается отправить данные в службу, она будет включать ошибка 500 с внутренним кодом ошибки 404. 404 означает, что не найден, который указывает, что область хранения для новой рабочей области по-прежнему идет подготовка. При следующей попытке данных будет успешно записан в рабочей области должным образом. Ошибка HTTP 403 может указывать на разрешение или учетные данные. Есть Дополнительные сведения, в состав ошибка 403 для помощи в устранении проблемы.|
    |4000 |Соединитель служб |Не удалось разрешить имя DNS |Компьютер не удалось разрешить Интернет-адрес, используемый при отправке данных в службу. Это может быть параметры сопоставителя DNS на компьютере, параметры неправильный прокси-сервера или может быть временная проблема DNS с помощью поставщика. Если происходит периодически, оно вызвано временная проблема, связанная с сетью.|
    |4001 |Соединитель служб |Не удалось подключиться к службе. |Эта ошибка может возникать, если агент не может взаимодействовать напрямую или через брандмауэр или прокси-сервера в службу Azure Monitor. Проверьте параметры прокси-сервера агента или что сетевой брандмауэр или прокси-сервер разрешает TCP-трафик от компьютера к службе.|
    |4002 |Соединитель служб |Служба вернула код состояния HTTP 403 в ответ на запрос. Обратитесь к администратору службы для службы работоспособности. Запрос будет повторно отправлен позже. |Эта ошибка записывается во время этапа первоначальной регистрации агента, и вы увидите URL-адрес следующего вида: *https://<workspaceID>.oms.opinsights.azure.com/AgentService.svc/AgentTopologyRequest*. Ошибка кода 403 означает, что запрещено и может быть вызвана вводом неправильного идентификатор рабочей области или ключ, или дату и время на компьютере. Если время отличается от текущего на 15 минут, подключение завершится сбоем. Чтобы устранить эту проблему, обновите дату и (или) часовой пояс компьютера Windows.|

## <a name="data-collection-issues"></a>Проблемы коллекции данных

После установки агента и отчеты в его настроенной рабочей области или рабочие области, она может прекратить получение конфигурации, сбор или переадресации производительности, журналы или другие данные в службу, в зависимости от того, что включен и предназначенные для компьютера. Это необходимо определить, если:

- Это особый тип данных или все данные, которые не доступен в рабочей области?
- Тип данных указана с помощью решения или как часть конфигурации сбора данных рабочей области?
- Сколько компьютеров будут затронуты? Это один или несколько компьютеров, отчеты в рабочую область?
- Он работает и были выполнены останов в определенное время суток, или он никогда не было собранных? 
- Является синтаксически правильным поисковый запрос журнала, который вы используете? 
- Агент никогда не получил его конфигурацию из Azure Monitor?

Чтобы определить, если компьютер отправляет событие пульса является первым шагом устранения неполадок.

```
Heartbeat 
    | where Computer like "<ComputerName>"
    | summarize arg_max(TimeGenerated, * ) by Computer
```

Если запрос возвращает результаты, необходимо определить, если определенный тип данных не собираются и перенаправляются в службу. Это может быть вызвано агента, не получил обновленную конфигурацию от службы или некоторых других проблем препятствует двигатель нормально работает агент. Выполните следующие действия для дальнейшей диагностики.

1. Откройте командную строку с повышенными привилегиями на компьютере и перезапустите службу агента, используя `net stop healthservice && net start healthservice`.
2. Откройте *Operations Manager* журнала событий и выполните поиск **коды событий** *7023, 7024, 7025, 7028* и *1210* из **событий источник** *HealthService*.  Эти события указывают агент успешно получает конфигурации из Azure Monitor и активно мониторинга компьютера. Описание события для события, которое ИД 1210 также указать в качестве строки все решения и подробные сведения, которые включены в области мониторинга на агенте.  

    ![Описание 1210 идентификатор события](./media/agent-windows-troubleshoot/event-id-1210-healthservice-01.png)

3. Если через несколько минут вы не видите ожидаемые данные в результаты запроса или визуализации, в зависимости от того, если вы просматриваете данные из решения или получения сведений, а из *Operations Manager* журнала событий, и выполните поиск **событий источники** *HealthService* и *модулей службы работоспособности* и фильтровать по **уровень события** *предупреждение* и *Ошибка* для подтверждения, если он написал события из следующей таблицы.

    |Идентификатор события |source |Описание |Способы устранения: |
    |---------|-------|------------|
    |8000 |Служба работоспособности |Это событие будет указать, если рабочий процесс по производительности, событий или другого типа данных, которые собираются не может пересылаться в службу для приема в рабочую область. | Идентификатор события 2136 из источника HealthService записывается вместе с данным событием и можно указать агент не сможет взаимодействовать со службой, возможно, из-за неправильной настройки параметров прокси-сервера и проверки подлинности, сбоя сети или брандмауэра сети / прокси-сервер не разрешил TCP-трафик от компьютера к службе.| 
    |10102 и 10103 |Модули службы работоспособности |Рабочий процесс не удается разрешить источник данных. |Это может произойти, если указанный счетчик производительности или экземпляр не существует на компьютере, или неправильно определен в параметрах данных рабочей области. Если это определяемый пользователем [счетчика производительности](data-sources-performance-counters.md#configuring-performance-counters)проверьте указанные сведения подписан правильный формат и существует на конечных компьютерах. |
    |26002 |Модули службы работоспособности |Рабочий процесс не удается разрешить источник данных. |Это может произойти, если указанного журнала событий Windows не существует на компьютере. Эту ошибку можно проигнорировать, если компьютер не должен иметь этот журнал событий, зарегистрированных, в противном случае, если это определяемый пользователем [журнал событий](data-sources-windows-events.md#configuring-windows-event-logs), проверьте правильность указанных данных. |

