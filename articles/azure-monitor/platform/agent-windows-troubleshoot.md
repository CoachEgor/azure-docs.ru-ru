---
title: Проблемы с устранением неполадок с агентом Log Analytics для Windows
description: Опишите симптомы, причины и разрешение наиболее распространенных проблем с агентом журнала Analytics для Windows в Azure Monitor.
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 11/21/2019
ms.openlocfilehash: 4112555347ce1d718375fbab3f166c6f2f5deeaa
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80333505"
---
# <a name="how-to-troubleshoot-issues-with-the-log-analytics-agent-for-windows"></a>How to troubleshoot issues with the Log Analytics agent for Windows (Устранение проблем с агентом Log Analytics для Windows) 

В этой статье содержатся ошибки, с помощью которых вы можете устранить ошибки с агентом Log Analytics для Windows в Azure Monitor, и предлагаются возможные решения для их устранения.

Если ни одна из рекомендаций не поможет устранить проблему, вы можете использовать следующие каналы поддержки:

* Клиенты с поддержкой Premier могут открыть запрос на поддержку на странице [Premier](https://premier.microsoft.com/).
* Клиенты с соглашением на поддержку Azure могут открыть запрос на поддержку на [портале Azure](https://manage.windowsazure.com/?getsupport=true).
* Посетите страницу отзывов журнала Analytics, [https://aka.ms/opinsightsfeedback](https://aka.ms/opinsightsfeedback) чтобы просмотреть представленные идеи и ошибки или подать новый. 

## <a name="important-troubleshooting-sources"></a>Важные источники устранения неполадок

 Для оказания помощи в устранении неполадок, связанных с агентом Log Analytics для Windows, агент регистрирует события в журнале событий Windows, в частности, в рамках *управления приложениями и службами.*  

## <a name="connectivity-issues"></a>Проблемы, связанные с подключением

Если агент общается через прокси-сервер или брандмауэр, могут быть введены ограничения, препятствующие связи с исходным компьютером и службой Azure Monitor. В случае, если связь заблокирована из-за неправильной настройки, регистрация в рабочей области может быть завершена при попытке установить агента или настроить агента после установки, чтобы сообщить дополнительное рабочее пространство. Связь агента может вывести из строя после успешной регистрации. В этом разделе описаны методы устранения неполадок с агентом Windows.

Двойная проверка настройки брандмауэра или прокси для обеспечения следующих портов и URL-адресов, описанных в следующей таблице. Также подтвердите, что проверка HTTP не включена для веб-трафика, так как это может предотвратить безопасный канал TLS между агентом и Azure Monitor.  

|Ресурс агента|порты; |Направление |Обход проверки HTTPS|
|------|---------|--------|--------|   
|*.ods.opinsights.azure.com |Порт 443 |Исходящие|Да |  
|*.oms.opinsights.azure.com |Порт 443 |Исходящие|Да |  
|*.blob.core.windows.net |Порт 443 |Исходящие|Да |  

Для получения информации о брандмауэре, необходимой для правительства Azure, [см.](../../azure-government/documentation-government-services-monitoringandmanagement.md#azure-monitor-logs) Если вы планируете использовать Azure Automation Hybrid Runbook Worker для подключения и регистрации в службе автоматизации для использования runbooks или решений управления в вашей среде, он должен иметь доступ к номеру порта и URL-адресам, описанным в [настройке вашей сети для Hybrid Runbook Worker.](../../automation/automation-hybrid-runbook-worker.md#network-planning) 

Существует несколько способов проверки успешного общения агента с Azure Monitor.

- Включите [оценку работоспособности агента анализа журналов Azure](../insights/solution-agenthealth.md) в рабочей области. С панели мониторинга «Здоровье агента» просмотрите столбец **«Граф агентов», не отвечающий требованиям,** чтобы быстро узнать, указан ли агент.  

- Выполнить следующий запрос, чтобы подтвердить, что агент отправляет сердцебиение в рабочее пространство, в какое оно настроено, чтобы сообщить об этом. Замените `<ComputerName>` фактическое название машины.

    ```
    Heartbeat 
    | where Computer like "<ComputerName>"
    | summarize arg_max(TimeGenerated, * ) by Computer 
    ```

    Если компьютер успешно общается с службой, запрос должен вернуть результат. Если запрос не вернул результат, сначала проверьте, что агент настроен, чтобы отчитаться перед правильной рабочей областью. Если он настроен правильно, приступайте к шагу 3 и ищите журнал событий Windows, чтобы определить, регистрирует ли агент, какая проблема может помешать ему общаться с Azure Monitor.

- Другой метод выявления проблемы подключения — это запуск инструмента **TestCloudConnectivity.** Инструмент устанавливается по умолчанию с агентом в папке *%SystemRoot% /Программные файлы/Агент мониторинга Microsoft.* От поднятой запроса команды перейдите в папку и запустите инструмент. Инструмент возвращает результаты и выделяет, где тест не удалось (например, если он был связан с определенным портом / URL, который был заблокирован). 

    ![Результаты выполнения инструмента TestCloudConnection](./media/agent-windows-troubleshoot/output-testcloudconnection-tool-01.png)

- Фильтр *амбулатория менеджер операций* журнал событий по **источникам** - событий*Модули службы здравоохранения*, *HealthService*, и *сервисный разъем* и фильтр *по предупреждению* **уровня событий** и *ошибки,* чтобы подтвердить, если он написал события из следующей таблицы. Если это так, просмотрите шаги разрешения, включенные для каждого возможного события.

    |Идентификатор события |Источник |Описание |Решение |
    |---------|-------|------------|-----------|
    |2133 & 2129 |Служба работоспособности |Подключение к службе от агента не удалось |Эта ошибка может возникнуть, когда агент не может общаться напрямую или через сервер брандмауэра/прокси-сервера в службу Мониторингaz. Проверить настройки прокси-сервера или что сетевой брандмауэр/прокси позволяет трафик TCP с компьютера на службу.|
    |2138 |Модули службы работоспособности |Прокси-сервер требует проверки подлинности |Настроите настройки прокси-сервера агента и укажите имя пользователя/пароль, необходимые для проверки подлинности с помощью прокси-сервера. |
    |2129 |Модули службы работоспособности |Неудачное соединение/неудачное согласование TLS |Проверьте настройки сетевого адаптера TCP/IP и настройки прокси-сервера агента.|
    |2127 |Модули службы работоспособности |Сбой отправки данных, полученных кодом ошибки |Если это происходит только периодически в течение дня, это может быть просто случайная аномалия, которая может быть проигнорирована. Монитор, чтобы понять, как часто это происходит. Если это происходит часто в течение дня, сначала проверьте настройки сети и прокси-сервера. Если описание включает код ошибки HTTP 404 и это первый раз, когда агент пытается отправить данные в службу, он будет включать в себя 500 ошибка с внутренним кодом ошибки 404. 404 означает не найдено, что указывает на то, что место хранения для нового рабочего пространства все еще готовится. При следующей повторной попытке данные будут успешно записываться в рабочее пространство, как и ожидалось. Ошибка HTTP 403 может указывать на проблему разрешения или учетных данных. Существует больше информации, включенной с ошибкой 403, чтобы помочь устранить проблему.|
    |4000 |Сервисный разъем |Разрешение имени DNS не удалось |Машина не смогла решить интернет-адрес, используемый при отправке данных в службу. Это могут быть настройки DNS-решателя на машине, неправильные настройки прокси или, может быть, временная проблема DNS с вашим поставщиком. Если это происходит периодически, это может быть вызвано переходной проблемой, связанной с сетью.|
    |4001 |Сервисный разъем |Подключение к службе не удалось. |Эта ошибка может возникнуть, когда агент не может общаться напрямую или через сервер брандмауэра/прокси-сервера в службу Мониторингaz. Проверить настройки прокси-сервера или что сетевой брандмауэр/прокси позволяет трафик TCP с компьютера на службу.|
    |4002 |Сервисный разъем |Служба вернула код состояния HTTP 403 в ответ на запрос. Проконсультируйтесь с администратором службы о работоспособности службы. Повторная попытка запроса будет выполнена позже. |Эта ошибка написана на начальном этапе регистрации агента, и вы увидите URL, похожий на следующее: *https://\<workspaceID>.oms.opinsights.azure.com/AgentService.svc/AgentTopologyRequest*. Код ошибки 403 означает запрещенное и может быть вызвано неправильно набранным идентификатором или ключом Рабочего пространства, или данные и время неверны на компьютере. Если время отличается от текущего на 15 минут, подключение завершится сбоем. Чтобы исправить это, обновите дату и/или часовой пояс вашего компьютера Windows.|

## <a name="data-collection-issues"></a>Вопросы сбора данных

После установки агента и отчета в настроенное рабочее пространство или рабочие области он может перестать получать конфигурацию, сбор или пересылку производительности, журналов или других данных в службу в зависимости от того, что включено и ориентировано на компьютер. Необходимо определить, если:

- Это конкретный тип данных или все данные, которые недоступны в рабочей области?
- Определяется ли тип данных, указанный решением или указанный в конфигурации сбора данных рабочего пространства?
- Сколько компьютеров затронуты? Является ли это один или несколько компьютеров отчетности в рабочее пространство?
- Работала ли она и остановилась ли она в определенное время суток, или она никогда не была собрана? 
- Является ли запрос поиска журнала, который вы используете синтаксически правильным? 
- Получал ли агент свою конфигурацию от Azure Monitor?

Первым шагом в устранении неполадок является определение того, отправляет ли компьютер событие сердцебиения.

```
Heartbeat 
    | where Computer like "<ComputerName>"
    | summarize arg_max(TimeGenerated, * ) by Computer
```

Если запрос возвращает результаты, необходимо определить, не собирается ли определенный тип данных и не перенаправляется в службу. Это может быть вызвано тем, что агент не получает обновленную конфигурацию от службы, или каким-либо другим симптомом, препятствующим нормальной работе агента. Выполните следующие шаги для дальнейшего устранения неполадок.

1. Откройте поднятую командную подсказку на компьютере и `net stop healthservice && net start healthservice`перезапустите агентуру, введя.
2. Откройте журнал событий *Operations Manager* и поиск **идентиматологов событий** *7023, 7024, 7025, 7028* и *1210* от **источника событий** *HealthService.*  Эти события указывают на то, что агент успешно получает конфигурацию от Azure Monitor и активно отслеживает работу компьютера. Описание события для идентификатора события 1210 также укажет на последней строке все решения и исследования, которые включены в область мониторинга на агенте.  

    ![Описание event ID 1210](./media/agent-windows-troubleshoot/event-id-1210-healthservice-01.png)

3. Если через несколько минут вы не увидите ожидаемые данные в результатах запроса или визуализации, в зависимости от того, просматриваете ли данные из решения или Insight, из журнала событий *«Менеджер операций»,* ищите **источники событий** *HealthService* и *модули службы здравоохранения* и фильтруете по *предупреждению* и *ошибке* **уровня событий,** чтобы подтвердить, были ли они написаны события из следующей таблицы.

    |Идентификатор события |Источник |Описание |Решение |
    |---------|-------|------------|
    |8000 |Служба работоспособности |В этом событии будет указано, не может ли рабочий процесс, связанный с производительностью, событием или другим собранным типом данных, пересылать службе для приема в рабочее пространство. | Event ID 2136 от источника HealthService пишется вместе с этим событием и может указывать на то, что агент не может связаться с службой, возможно, из-за неправильной настройки настройки прокси и проверки подлинности, сбой в сети или сетевой брандмауэр/прокси не позволяет Трафик TCP с компьютера на службу.| 
    |10102 и 10103 |Модули службы работоспособности |Рабочий процесс не может разрешить источник данных. |Это может произойти, если указанный счетчик производительности или экземпляр не существует на компьютере или неправильно определен в настройках данных рабочей области. Если это [счетчик производительности,](data-sources-performance-counters.md#configuring-performance-counters)указанный пользователем, проверьте указанную информацию, которая находится в правильном формате и существует на целевых компьютерах. |
    |26002 |Модули службы работоспособности |Рабочий процесс не может разрешить источник данных. |Это может произойти, если указанный журнал событий Windows не существует на компьютере. Эта ошибка может быть безопасно проигнорирована, если компьютер не должен иметь этот журнал событий зарегистрирован, в противном случае, если это [данный журнал событий,](data-sources-windows-events.md#configuring-windows-event-logs)проверить указанную информацию является правильной. |

