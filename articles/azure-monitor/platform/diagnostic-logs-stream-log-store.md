---
title: Stream журналов диагностики в рабочую область Log Analytics в Azure Monitor
description: Узнайте, как выполнять потоковую передачу журналов диагностики Azure в рабочую область Log Analytics в Azure Monitor.
author: johnkemnetz
services: azure-monitor
ms.service: azure-monitor
ms.topic: conceptual
ms.date: 04/18/2019
ms.author: johnkem
ms.subservice: logs
ms.openlocfilehash: 13eb1a8fcea2f74cda5921a51b8c2e8816be975f
ms.sourcegitcommit: 82efacfaffbb051ab6dc73d9fe78c74f96f549c2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/20/2019
ms.locfileid: "67303712"
---
# <a name="stream-azure-diagnostic-logs-to-log-analytics-workspace-in-azure-monitor"></a>Stream журналов диагностики в рабочую область Log Analytics в Azure Monitor

**[Журналы диагностики Azure](diagnostic-logs-overview.md)**  может передаваться в близком к реальному времени, в рабочую область Log Analytics в Azure Monitor с помощью портала, командлетов PowerShell или интерфейса командной строки Azure.

## <a name="what-you-can-do-with-diagnostics-logs-in-a-log-analytics-workspace"></a>Что вы можно делать с журналами диагностики в рабочей области Log Analytics

Azure Monitor предоставляет гибкую журнала запросов и анализа средство, которое позволяет получить представление о данных журналов, созданные из ресурсов Azure. Ниже перечислены некоторые возможности:

* **Запрос журнала** -записи, сложные запросы, over, данные журнала, сопоставление журналов из различных источников и создавать диаграммы, можно закрепить на панели мониторинга Azure.
* **Предупреждения** -обнаружить, когда одно или несколько событий соответствуют определенному запросу и получать уведомления на адрес электронной почты или веб-перехватчика вызов, с помощью оповещений Azure Monitor.
* **Расширенная аналитика**. Применение машинного обучения и алгоритмов сопоставления шаблонов для выявления возможных проблем, обнаруженных в журналах.

## <a name="enable-streaming-of-diagnostic-logs-to-log-analytics-workspace"></a>Включение потоковой передачи журналов диагностики в рабочую область Log Analytics

Потоковую передачу журналов диагностики можно включить программно, через портал или с помощью [REST API Azure Monitor](https://docs.microsoft.com/rest/api/monitor/diagnosticsettings). В любом случае создается параметр диагностики, в котором указывается рабочая область Log Analytics, а также категории журналов и метрики, которые требуется отправить в эту рабочую область. Категория **журналов диагностики** — это тип журналов, которые может предоставить ресурс.

Рабочая область Log Analytics не обязательно должна находиться в той же подписке, в которой находится ресурс, выдающий журналы, если у пользователя, настраивающего параметр, имеется соответствующий доступ RBAC к обеим подпискам.

> [!NOTE]
> Отправка многомерных метрик с помощью параметров диагностики сейчас не поддерживается. Метрики с измерениями экспортируются как преобразованные в плоскую структуру одномерные метрики, агрегированные по значениям измерений.
>
> *Пример*. Метрику "Входящие сообщения" в концентраторе событий можно изучить и вывести в виде диаграммы на уровне очереди. Но при экспорте с помощью параметров диагностики метрика будет представлена в виде всех входящих сообщений для всех очередей концентратора событий.
>
>

## <a name="stream-diagnostic-logs-using-the-portal"></a>Потоковая передача журналов диагностики с помощью портала
1. На портале перейдите к Azure Monitor и щелкните **параметров диагностики** в **параметры** меню.


2. При необходимости отфильтруйте список по группе или типу ресурса, а затем щелкните ресурс, для которого необходимо задать параметр диагностики.

3. Если параметров для выбранного ресурса не существует, вам будет предложено создать параметр. Щелкните Turn on diagnostics (Включить диагностику).

   ![Добавление параметра диагностики — имеющиеся параметры отсутствуют](media/diagnostic-logs-stream-log-store/diagnostic-settings-none.png)

   Если в ресурсе имеются параметры, для него отобразится список настроенных параметров. Нажмите Add diagnostic setting (Добавить параметр диагностики).

   ![Добавление параметра диагностики — имеющиеся параметры](media/diagnostic-logs-stream-log-store/diagnostic-settings-multiple.png)

3. Введите имя параметра и установите флажок для **Отправить в Log Analytics**, затем выберите рабочую область Log Analytics.

   ![Добавление параметра диагностики — имеющиеся параметры](media/diagnostic-logs-stream-log-store/diagnostic-settings-configure.png)

4. Выберите команду **Сохранить**.

Через несколько секунд новый параметр появится в списке параметров для данного ресурса, и сразу же после создания данных о событии журналы диагностики будут отправлены в необходимую рабочую область. Возможно, до 15 минут между когда создается событие, и когда она появится в Log Analytics.

### <a name="via-powershell-cmdlets"></a>С помощью командлетов PowerShell

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

Для включения потоковой передачи с помощью [командлетов Azure PowerShell](../../azure-monitor/platform/powershell-quickstart-samples.md) применяется командлет `Set-AzDiagnosticSetting` с такими параметрами:

```powershell
Set-AzDiagnosticSetting -ResourceId [your resource ID] -WorkspaceID [resource ID of the Log Analytics workspace] -Categories [list of log categories] -Enabled $true
```

Обратите внимание на то, что свойство workspaceID содержит полный идентификатор рабочей области, а не идентификатор и ключ рабочей области, отображаемые в Log Analytics.

### <a name="via-azure-cli"></a>С помощью интерфейса командной строки Azure

Чтобы включить потоковую передачу с помощью [Azure CLI](../../azure-monitor/platform/cli-samples.md), используйте команду [az monitor diagnostic-settings create](/cli/azure/monitor/diagnostic-settings#az-monitor-diagnostic-settings-create).

```azurecli
az monitor diagnostic-settings create --name <diagnostic name> \
    --workspace <log analytics name or object ID> \
    --resource <target resource object ID> \
    --resource-group <log analytics workspace resource group> \
    --logs '[
    {
        "category": <category name>,
        "enabled": true
    }
    ]'
```

Вы можете расширить набор категорий в журнале диагностики, добавив словари в массив JSON, переданный в качестве параметра `--logs`.

Аргумент `--resource-group` является обязательным, только если `--workspace` — не идентификатор объекта.

## <a name="how-do-i-query-the-data-from-a-log-analytics-workspace"></a>Как запрос данных из рабочей области Log Analytics?

В колонке "журналы" на портале Azure Monitor можно запросить журналы диагностики в рамках решения управления журналами в таблице AzureDiagnostics. Существуют также [несколько решений для мониторинга для ресурсов Azure](../../azure-monitor/insights/solutions.md) можно установить, чтобы мгновенно получать представление о данных журналов, отправляемых в Azure Monitor.

## <a name="azure-diagnostics-vs-resource-specific"></a>Azure Diagnostics vs ресурсом  
После назначения Log Analytics включена в конфигурации системы диагностики Azure, существует два различных способа, данные будут отображаться в рабочей области:  
- **Система диагностики Azure** -это метод прежних версий, используемых сегодня большинство служб Azure. В этом режиме все данные из любого параметра диагностики, на который указывает для заданной рабочей области будут направлены в _AzureDiagnostics_ таблицы. 
<br><br>Так как многие ресурсы отправлять данные в одной таблице (_AzureDiagnostics_), схема этой таблицы — это принудительный набор схем все различные типы данных собираются. Например при создании параметров диагностики для сбора следующих типов данных, передача данных выполняется в той же рабочей области:
    - Аудит журналов 1 ресурсов (имеющая схеме, состоящей из столбцов A, B и C)  
    - Журналы ошибок 2 ресурсов (имеющая схеме, состоящей из столбцов, D, E и F)  
    - Журналы потоков данных из ресурсов 3 (имеющая схеме, состоящей из столбцов G, H и я)  

    В таблице AzureDiagnostics будет выглядеть следующим образом, с демонстрационными данными:  

    | ResourceProvider | Категория | A | b | C | D | E | F | G. | H | I |
    | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- | -- |
    | Microsoft.Resource1 | AuditLogs | x1 | y1 | z1 |
    | Microsoft.Resource2 | ErrorLogs | | | | Вопрос 1 | W1 | e1 |
    | Microsoft.Resource3 | DataFlowLogs | | | | | | | J1 | K1 | L1|
    | Microsoft.Resource2 | ErrorLogs | | | | вопрос 2 | W2 | e2 |
    | Microsoft.Resource3 | DataFlowLogs | | | | | | | J3 | K3 | L3|
    | Microsoft.Resource1 | AuditLogs | x5 | y5 | z5 |
    | ... |

- **Ресурсом** -в этом режиме создаются отдельные таблицы в выбранной рабочей области для каждого каждой категории, выбранные в конфигурацию параметров диагностики. Этот метод более новые делает гораздо проще найти точно нужно найти через явное разделение областей ответственности: таблицы для каждой категории. Кроме того он предоставляет преимущества в поддержке для динамических типов. Вы уже видели этот режим, выберите типы ресурсов Azure, например [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/reports-monitoring/howto-analyze-activity-logs-log-analytics) или [Intune](https://docs.microsoft.com/intune/review-logs-using-azure-monitor) журналы. В конечном счете ожидается, что каждый тип данных для переноса в режиме конкретного ресурса. 

    В приведенном выше примере в результате создается три таблицы: 
    - Таблица _AuditLogs_ следующим образом:

        | ResourceProvider | Категория | A | b | C |
        | -- | -- | -- | -- | -- |
        | Microsoft.Resource1 | AuditLogs | x1 | y1 | z1 |
        | Microsoft.Resource1 | AuditLogs | x5 | y5 | z5 |
        | ... |

    - Таблица _ErrorLogs_ следующим образом:  

        | ResourceProvider | Категория | D | E | F |
        | -- | -- | -- | -- | -- | 
        | Microsoft.Resource2 | ErrorLogs | Вопрос 1 | W1 | e1 |
        | Microsoft.Resource2 | ErrorLogs | вопрос 2 | W2 | e2 |
        | ... |

    - Таблица _DataFlowLogs_ следующим образом:  

        | ResourceProvider | Категория | G. | H | I |
        | -- | -- | -- | -- | -- | 
        | Microsoft.Resource3 | DataFlowLogs | J1 | K1 | L1|
        | Microsoft.Resource3 | DataFlowLogs | J3 | K3 | L3|
        | ... |

    Другие преимущества использования режима ресурсом включают улучшенную производительность как задержка приема данных, так и время на запрос, облегчения схемы и их структуру, может предоставлять права RBAC на определенную таблицу и многое другое.

### <a name="selecting-azure-diagnostic-vs-resource-specific-mode"></a>Выбор режима диагностики Azure vs ресурсом
Для большинством ресурсов Azure не нужно будет выбрать следует ли использовать режим диагностики Azure или конкретного ресурса; автоматически будет потока данных через метод, который выбран для использования ресурса. См. в документации, предоставленной для ресурса, вы включили для отправки данных в Log Analytics сведения, на которых работает режим. 

Как уже говорилось в предыдущем разделе, в конечном счете целью является монитора Azure для всех служб в Azure, используйте режим конкретного ресурса. Чтобы упростить этот переход и убедитесь, что все данные сохраняются как часть его, некоторые службы Azure, когда подключения к Log Analytics будет предоставлен выбор режима:  
   ![Выбор режима диагностические параметры](media/diagnostic-logs-stream-log-store/diagnostic-settings-mode-selector.png)

Мы **строго** рекомендуем, чтобы избежать потенциально сложности при миграции в будущем, для новых параметров диагностики использования ресурсов на режим.  

Для существующих параметров диагностики, после включения определенного ресурса Azure можно переключиться из диагностики Azure в режим ресурсом задним числом. Ранее полученные данные будут по-прежнему доступна в _AzureDiagnostics_ таблицы до его устаревают, настроенный в параметре хранения в рабочей области, но все новые данные будут отправляться в выделенную таблицу. Это означает, что для всех запросов, которые обязательно должно охватывать старых данных и новые (пока не полностью устареет старые данные), [объединение](https://docs.microsoft.com/azure/kusto/query/unionoperator) операторов в запросах необходимо объединить эти два набора данных.

Просмотрите новости о новых Azure служб вспомогательные журналы в режиме ресурсом на [обновления Azure](https://azure.microsoft.com/updates/) блога!

### <a name="known-limitation-column-limit-in-azurediagnostics"></a>Известное ограничение: ограничение количества столбцов в AzureDiagnostics
Нет явного ограничения, любой заданной таблицы журнала Azure, не имеющий более чем 500 столбцов. После достижения любой строки, содержащие данные с любой столбец за пределами первые 500, будут удалены во время приема. В таблице AzureDiagnostics является особенно подвержены быть влияет это ограничение. Обычно это происходит либо, так как множества различных источников данных передаются на той же рабочей области, или несколько источников подробные данные, отправляемые в той же рабочей области. 

#### <a name="azure-data-factory"></a>Фабрика данных Azure  
Фабрика данных Azure, из-за очень подробный набор журналов, — это ресурс, известно, что особенно влиять на это ограничение. В частности все параметры диагностики, заданные перед конкретного ресурса режим не включен или явно выбрать для использования режима ресурсом по причинам совместимости обратное:  
- *Параметры пользователя, определенные для любого действия в конвейере*: будет новый столбец, созданный для каждого параметра пользователя с уникальным именем для любого действия. 
- *Вводимые и выдаваемые действиями*: эти различаются для деятельности и создание большого числа столбцов из-за их характера verbose. 
 
Как с широкой предложения решение ниже, рекомендуется для переноса журналов для использования режима ресурсом, как можно скорее. Если вы не сможете немедленно, альтернативой промежуточные является изолировать ADF журналы в собственной рабочей области, чтобы свести к минимуму вероятность возникновения этих журналов, влияя на другие типы журналов, собираемых в рабочие области. 
 
#### <a name="workarounds"></a>Обходные пути
Краткосрочные, пока не всех служб Azure не включены в режиме конкретного ресурса, для всех служб, но поддержки режима конкретного ресурса, рекомендуется для разделения типов подробные данные, опубликованный корпорацией эти службы в отдельных рабочих областей для уменьшения вероятность превышения ограничения на.  
 
Более системы диагностики Azure будет переходит от всех служб Azure, которые поддерживают режим конкретного ресурса. Мы рекомендуем перемещение в этот режим, как можно скорее, чтобы уменьшить вероятность влияния это ограничение в 500 столбцов.  


## <a name="next-steps"></a>Дальнейшие действия

* [Дополнительные сведения о журналах диагностики Azure](diagnostic-logs-overview.md)

