---
title: Сбор данных журнала с помощью агента Azure Log Analytics | Документация Майкрософт
description: В этой статье содержатся сведения о том, как собирать данные и наблюдать за компьютерами, размещенными в Azure, локальной или другой облачной среде, с помощью Log Analytics.
ms.service: azure-monitor
ms.subservice: logs
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 12/24/2019
ms.openlocfilehash: 58d6c8d18e03ab248cfbebcf910ae13c5fee439e
ms.sourcegitcommit: ce4a99b493f8cf2d2fd4e29d9ba92f5f942a754c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/28/2019
ms.locfileid: "75530975"
---
# <a name="collect-log-data-with-the-log-analytics-agent"></a>Получение данных журнала с помощью агента Log Analytics

Агент Azure Log Analytics, который ранее назывался агентом Microsoft Monitoring Agent (MMA) или агентом OMS для Linux, был разработан для обеспечения комплексного управления на компьютерах в локальной среде, компьютерах, отслеживаемых с помощью [System Center Operations Manager](https://docs.microsoft.com/system-center/scom/), и виртуальных машинах в любом облаке. Агенты Windows и Linux подключаются к Azure Monitor и хранят собранные данные журналов из различных источников в рабочей области Log Analytics, а также любые уникальные журналы или метрики, как определено в решении для мониторинга. 

В этой статье предоставлен подробный обзор требований к агенту, системе и сети, а также различных методов развертывания.

## <a name="overview"></a>Обзор

![Схема связей агента Log Analytics](./media/log-analytics-agent/log-analytics-agent-01.png)

Прежде чем анализировать собранные данные и работать с ними, сначала необходимо установить и подключить агенты для всех компьютеров, которые будут отсылать данные в службу Azure Monitor. Вы можете установить агенты на виртуальных машинах Azure с помощью расширения виртуальной машины Azure Log Analytics для Windows и Linux, а также на компьютерах в гибридной среде с помощью программы установки, командной строки или настройки требуемого состояния (DSC) в службе автоматизации Azure. 

Агент для Linux и Windows передает исходящий трафик в службу Azure Monitor через TCP-порт 443, а также если компьютер подключается через брандмауэр или сервер для взаимодействия через Интернет, просмотрите требования ниже, чтобы понять конфигурацию сети. Обязательно. Если политики безопасности ИТ не позволяют компьютерам в сети подключаться к Интернету, можно настроить [шлюз log Analytics](gateway.md) , а затем настроить агент для подключения через шлюз к Azure Monitor журналов. Затем агент может получать сведения о конфигурации и отправлять собранные данные в зависимости от того, какие правила сбора данных и решения мониторинга включены в рабочей области. 

При использовании агентов Log Analytics для получения данных необходимо понимать следующее, чтобы спланировать развертывание агента.

* Для получения данных от агентов Windows можно [настроить каждый агент для отправки отчетов в одну или несколько рабочих областей](agent-windows.md), даже если он сообщается группе управления System Center Operations Manager. Агент Windows может сообщить до четырех рабочих областей.
* Агент Linux не поддерживает несколько сетевых интерфейсов и может передавать отчеты только в одну рабочую область.
* Агент Windows поддерживает [стандарт FIPS 140](https://docs.microsoft.com/windows/security/threat-protection/fips-140-validation), в то время как агент Linux не поддерживает его.  

При использовании System Center Operations Manager 2012 R2 или более поздней версии:

* Каждая группа управления Operations Manager может быть [подключена только к одной рабочей области](om-agents.md).
* Компьютеры Linux, передающие данные в группу управления, должны быть настроены для отправки отчетов непосредственно в Log Analytics рабочую область. Если компьютеры Linux уже отправляют отчеты непосредственно в рабочую область и вы хотите отслеживать их с помощью Operations Manager, выполните следующие действия, чтобы [Отправить отчет в группу управления Operations Manager](agent-manage.md#configure-agent-to-report-to-an-operations-manager-management-group).
* Вы можете установить агент Log Analytics Windows на компьютере Windows и сообщить о том, что Operations Manager интегрированы с рабочей областью, и с другой рабочей областью.

Агент для Linux и Windows не только подключается к Azure Monitor, но также поддерживает службу автоматизации Azure для размещения гибридной рабочей роли Runbook и других служб, таких как [Отслеживание изменений](../../automation/change-tracking.md), [Управление обновлениями](../../automation/automation-update-management.md)и [Центр безопасности Azure](../../security-center/security-center-intro.md). Дополнительные сведения о гибридной рабочей роли Runbook см. в разделе [Общие сведения об архитектуре автоматизации](../../automation/automation-hybrid-runbook-worker.md).  

## <a name="supported-windows-operating-systems"></a>Поддерживаемые операционные системы Windows

Для агента Windows официально поддерживаются следующие версии операционной системы Windows:

* Windows Server 2019
* Windows Server 2008 SP2 (x64), 2008 R2, 2012, 2012 R2, 2016, Version 1709 и 1803
* Windows 7 с пакетом обновления 1 (SP1), Windows 8 Корпоративная и профессиональная, Windows 10 Корпоративная и профессиональная

>[!NOTE]
>Хотя агент Log Analytics для Windows был разработан для поддержки сценариев наблюдения за серверами, мы понимаем, что клиент Windows можно использовать для поддержки рабочих нагрузок, настроенных и оптимизированных для серверной операционной системы. Агент поддерживает клиент Windows, но наши решения мониторинга не сосредоточены на сценариях наблюдения за клиентами, если явно не указано иное.

## <a name="supported-linux-operating-systems"></a>Поддерживаемые операционные системы Linux

В этом разделе приведены сведения о поддерживаемых дистрибутивах Linux.

Начиная с версий, выпущенных после августа 2018 года, мы вносим следующие изменения в свою модель поддержки:  

* Поддерживаются только версии серверов, а не клиентов.  
* Новые версии [рекомендуемых дистрибутивов Azure Linux](../../virtual-machines/linux/endorsed-distros.md) всегда поддерживаются.  
* Все вспомогательные версии поддерживаются для каждого основного номера версии в списке.
* Версии, для которых прошла дата окончания поддержки производителем, не поддерживаются.  
* Новые версии AMI не поддерживаются.  
* Поддерживаются только версии, работающие с SSL 1.x по умолчанию.

>[!NOTE]
>Если вы используете дистрибутив или версию, которые в настоящее время не поддерживаются и не соответствуют нашей модели поддержки, мы рекомендуем вам сделать вилку этого репозитория, согласившись, что специалисты службы поддержки Майкрософт не будут предоставлять помощь при работе с версиями разветвленных агентов.

* Amazon Linux 2017.09 (x64)
* CentOS Linux 6 (x86/x64) и 7 (x64)  
* Oracle Linux 6 и 7 (x86/x64) 
* Red Hat Enterprise Linux Server 6 (x86/x64) и 7 (x64)
* Debian GNU/Linux 8 и 9 (x86/x64)
* Ubuntu 14.04 LTS (x86/x64), 16.04 LTS (x86/x64) и 18.04 LTS (x64)
* SUSE Linux Enterprise Server 12 (x64) и 15 (x64)

>[!NOTE]
>OpenSSL 1.1.0 поддерживается только на платформах x86_x64 (64-разрядная версия), а OpenSSL версии более ранней, чем 1.x, не поддерживается ни на каких платформах.
>

### <a name="agent-prerequisites"></a>Предварительные требования к агенту

В следующей таблице перечислены пакеты, необходимые для поддерживаемых дистрибутивов Linux, на которых будет установлен агент.

|Требуемый пакет |Description |Минимальная версия |
|-----------------|------------|----------------|
|Glibc |    Библиотека C GNU | 2.5-12 
|Openssl    | Библиотеки OpenSSL | 1.0. x или 1.1. x |
|Curl | Веб-клиент cURL | 7.15.5 |
|Python-ctypes | | 
|PAM | Подключаемые модули аутентификации | | 

>[!NOTE]
>Для сбора сообщений системного журнала требуется rsyslog или syslog-ng. Управляющая программа syslog по умолчанию не поддерживается для сбора событий системного журнала в Red Hat Enterprise Linux версии 5, CentOS и Oracle Linux (sysklog). Чтобы собирать данные системного журнала из дистрибутивов этих версий, требуется установить и настроить управляющую программу rsyslog, которая заменит sysklog.

## <a name="tls-12-protocol"></a>Протокол TLS 1.2

Чтобы обеспечить безопасность передаваемых данных в журналы Azure Monitor, настоятельно рекомендуется настроить агент на использование по крайней мере протокола TLS 1,2. Более старые версии протоколов TLS/SSL оказались уязвимы. Хотя они все еще используются для обеспечения обратной совместимости, применять их **не рекомендуется**.  См. дополнительные сведения о [безопасной отправке данных с помощью TLS 1.2](data-security.md#sending-data-securely-using-tls-12). 

## <a name="network-firewall-requirements"></a>Требования к брандмауэру в сети

Ниже перечислены сведения о конфигурации прокси-сервера и брандмауэра, необходимые агентам Linux и Windows для взаимодействия с журналами Azure Monitor.  

|Ресурс агента|порты; |Направление |Обход проверки HTTPS|
|------|---------|--------|--------|   
|*.ods.opinsights.azure.com |Порт 443 |Исход.|Да |  
|*.oms.opinsights.azure.com |Порт 443 |Исход.|Да |  
|*.blob.core.windows.net |Порт 443 |Исход.|Да |  

Сведения о брандмауэре, необходимые для Azure для государственных организаций, см. в статье [Управление Azure](../../azure-government/documentation-government-services-monitoringandmanagement.md#azure-monitor-logs)для государственных организаций. 

Если вы планируете использовать гибридную рабочую роль Runbook службы автоматизации Azure для подключения и регистрации в службе автоматизации для использования модулей Runbook или решений для управления в вашей среде, у нее должен быть доступ к номеру порта и URL-адресам, описанным в разделе [Настройка сети для гибридной рабочей роли Runbook](../../automation/automation-hybrid-runbook-worker.md#network-planning). 

Агент Windows и Linux поддерживает связь через прокси-сервер или шлюз Log Analytics для Azure Monitor по протоколу HTTPS.  Поддерживается анонимная и базовая аутентификация (с именем пользователя и паролем).  Для агента Windows, подключенного непосредственно к службе, конфигурация прокси-сервера указывается во время установки или [после развертывания](agent-manage.md#update-proxy-settings) — в панели управления или с помощью PowerShell.  

Для агента Linux прокси-сервер определяется во время или [после установки](agent-manage.md#update-proxy-settings), или при изменении файла конфигурации proxy.conf.  Конфигурация прокси-сервера агента Linux имеет следующий синтаксис:

`[protocol://][user:password@]proxyhost[:port]`

> [!NOTE]
> Если прокси-сервер не требует аутентификацию, для агента Linux все равно необходимо указать псевдо-имя пользователя или пароль. Вы можете указать любое имя пользователя или пароль.

|Свойство| Description |
|--------|-------------|
|Протокол | https |
|пользователь | Необязательное имя пользователя для аутентификации прокси-сервера |
|password | Необязательный пароль для аутентификации прокси-сервера |
|proxyhost | Адрес или полное доменное имя прокси-сервера или шлюза Log Analytics |
|порт | Необязательный номер порта прокси-сервера или шлюза Log Analytics |

Например: `https://user01:password@proxy01.contoso.com:30443`

> [!NOTE]
> Если в пароле использованы специальные знаки (например, \@), отобразится ошибка подключения прокси-сервера из-за неправильного анализа значения.  Чтобы обойти эту проблему, закодируйте пароль в URL-адрес, используя специальные инструменты (например, [URLDecode](https://www.urldecoder.org/)).  

## <a name="install-and-configure-agent"></a>Установка и настройка агента

Подключение компьютеров в подписке Azure или гибридной среде напрямую с журналами Azure Monitor можно выполнить с помощью различных методов в зависимости от требований. В следующей таблице описан каждый метод. Эти данные помогут вам определить, какой из методов наиболее подходящий для вашей организации.

|Источник | Метод | Description|
|-------|-------------|-------------|
|Виртуальная машина Azure| Расширение виртуальной машины Log Analytics для [Windows](../../virtual-machines/extensions/oms-windows.md) или [Linux](../../virtual-machines/extensions/oms-linux.md) с использованием Azure CLI или шаблона Azure Resource Manager<br>- [вручную из портал Azure](../../azure-monitor/learn/quick-collect-azurevm.md)<br>- [автоматической подготовки центра безопасности Azure](../../security-center/security-center-enable-data-collection.md)| — Расширение устанавливает агент Log Analytics на виртуальных машинах Azure и регистрирует их в существующей Azure Monitor рабочей области.<br>— Центр безопасности Azure может подготавливать агент Log Analytics на всех поддерживаемых виртуальных машинах Azure и всех новых, созданных, если включить его для отслеживания уязвимостей и угроз безопасности. Если этот флажок установлен, будет подготовлена любая новая или Существующая виртуальная машина без установленного агента.|
| Гибридные компьютеры Windows|- [Установка вручную](agent-windows.md)<br>- [DSC службы автоматизации Azure](agent-windows.md#install-the-agent-using-dsc-in-azure-automation)<br>- [Шаблон Resource Manager с Azure Stack](https://github.com/Azure/AzureStack-QuickStart-Templates/tree/master/MicrosoftMonitoringAgent-ext-win) |Установка агента Microsoft Monitoring Agent из командной строки или автоматически, например с помощью DSC службы автоматизации Azure, [System Center Configuration Manager](https://docs.microsoft.com/sccm/apps/deploy-use/deploy-applications) или шаблона Azure Resource Manager, если Microsoft Azure Stack уже развернут в центре обработки данных.| 
| Гибридные компьютеры Linux| [Установка вручную](agent-linux.md)|Установите агент для Linux, вызвав скрипт-оболочку, размещенный на GitHub, или вручную Скачайте и установите агент. | 
| System Center Operations Manager|[Интеграция Operations Manager с Log Analytics](om-agents.md) | Настройте интеграцию между журналами Operations Manager и Azure Monitor, чтобы пересылать собранные данные с компьютеров Windows, отправляют отчеты в группу управления.|  

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения об источниках данных, доступных для сбора данных из операционных систем Windows или Linux, см. в статье [Data sources in Log Analytics](agent-data-sources.md) (Источники данных в Log Analytics). 

* Узнайте больше о [запросах журнала](../log-query/log-query-overview.md), которые можно применять для анализа данных, собираемых из источников данных и решений. 

* Узнайте больше о [решениях мониторинга](../insights/solutions.md), которые расширяют функции службы Azure Monitor и собирают данные в ее рабочей области.
