---
title: Мониторинг работоспособности виртуальных машин с помощью Azure Monitor для виртуальных машин (предварительная версия) | Документация Майкрософт
description: В этой статье объясняется, как оценить работоспособность виртуальной машины и операционной системы с помощью Azure Monitor для виртуальных машин.
services: azure-monitor
documentationcenter: ''
author: mgoedtel
manager: carmonm
editor: ''
ms.assetid: ''
ms.service: azure-monitor
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/22/2019
ms.author: magoedte
ms.openlocfilehash: 9fa76c9637a6dcdca48bf45e8ee2aa9305a4f64f
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "66130460"
---
# <a name="understand-the-health-of-your-azure-virtual-machines"></a>Оценки состояния работоспособности виртуальных машин Azure

Azure предлагает несколько служб, которые по отдельности выполняют определенную роль или задачу в панели "Наблюдение", но еще не указаны подробные работоспособности точки зрения операционной системы, размещенной на виртуальных машинах Azure. Хотя можно отслеживать для различных условий, с помощью Azure Monitor, не предназначенные для моделирования и представления работоспособности ключевых компонентов или общую работоспособность виртуальной машины. Платформа Azure Monitor для виртуальных машин осуществляет упреждающий мониторинг доступности и производительности гостевой ОС Windows или Linux. Платформа использует модель ключевых компонентов и связей между ними, критерии оценки работоспособности этих компонентов и оповещения об обнаружении состояний неработоспособности.  

В Azure Monitor есть два варианта просмотра сведений об общей работоспособности виртуальной машины Azure: непосредственно с виртуальной машины или с платформы Azure Monitor для всех виртуальных машин в группе ресурсов.

Из этой статьи вы узнаете, как быстро оценить, изучить и устранить обнаруженные проблемы с работоспособностью.

Сведения о настройке Azure Monitor для виртуальных машин, см. в [этой статье](vminsights-enable-overview.md).

## <a name="monitoring-configuration-details"></a>Сведения о настройке мониторинга

В этом разделе описаны критерии работоспособности, используемые по умолчанию для мониторинга виртуальных машин Azure на базе Windows и Linux. Все критерии работоспособности предварительно настроены на оповещение при соблюдении условия неработоспособности. 

### <a name="windows-vms"></a>Виртуальные машины Windows

- доступный объем памяти, мегабайт; 
- среднее время на операцию записи, секунд (логический диск);
- среднее время на операцию записи, секунд (диск);
- среднее время на операцию чтения, секунд (логический диск);
- среднее время на операцию перемещения, секунд (логический диск);
- среднее время на операцию чтения, секунд (диск);
- среднее время на операцию перемещения, секунд (диск);
- текущая длина очереди диска (логический диск);
- текущая длина очереди диска (диск);
- процент времени простоя диска;
- ошибка или повреждение файловой системы;
- мало свободного пространства на логическом диске (в процентах);
- мало свободного пространства на логическом диске (в мегабайтах);
- процент времени простоя логического диска;
- страниц памяти в секунду;
- процент используемой пропускной способности чтения;
- процент используемой общей пропускной способности;
- процент используемой пропускной способности записи;
- процент используемой выделенной памяти;
- процент времени простоя диска;
- работоспособность службы DHCP-клиента;
- работоспособность службы DNS-клиента;
- работоспособность службы RPC;
- работоспособность службы сервера;
- общий процент использования ЦП;
- работоспособность службы журнала событий Windows;
- работоспособность службы брандмауэра Windows;
- работоспособность службы удаленного управления Windows.

### <a name="linux-vms"></a>Виртуальные машины Linux
- диск, средн. — время обращения к диску (с) 
- диск, средн. — время чтения с диска (с) 
- диск, средн. — время записи на диск (с) 
- работоспособность диска;
- свободное пространство на логическом диске;
- свободное пространство на логическом диске (в процентах);
- свободные дескрипторы на логическом диске (в процентах);
- работоспособность сетевого адаптера;
- общее процессорное время в процентах;
- доступный для операционной системы объем памяти, мегабайт.

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure

Войдите на [портале Azure](https://portal.azure.com). 

## <a name="introduction-to-health-experience"></a>Знакомство с интерфейсом для оценки работоспособности системы

Прежде чем углубляться в тонкости использования функции для оценки работоспособности виртуальной машины или группы виртуальных машин, мы представим краткий обзор, чтобы вам было легче понять отображаемую информацию и визуализации.  

### <a name="view-health-directly-from-a-virtual-machine"></a>Просмотр сведений о работоспособности непосредственно с виртуальной машины 

Чтобы просмотреть состояние работоспособности виртуальной машины Azure, выберите **Аналитические сведения (предварительная версия)** в левой области страницы виртуальной машины. На странице аналитики виртуальных машин по умолчанию открывается вкладка **Работоспособность** с представлением работоспособности виртуальной машины.  

![Представление работоспособности выбранной виртуальной машины Azure в Azure Monitor для виртуальных машин](./media/vminsights-health/vminsights-directvm-health.png)

На вкладке **Работоспособность** в разделе **Работоспособность гостевых виртуальных машин** отображаются сведения о текущей работоспособности виртуальной машины и общее число оповещений о неработоспособности определенного компонента. Дополнительные сведения см. в разделе [оповещения](#alerts) возникать к Дополнительные сведения о создания оповещений.  

В следующей таблице описываются состояния работоспособности, которые могут быть определены для виртуальной машины: 

|Значок |Исправное состояние |Значение |
|-----|-------------|---------------|
| |Healthy |Значение "Исправно" означает, что состояние работоспособности находится в пределах определенных условий. Это значение указывает на то, что никаких проблем с виртуальной машиной не обнаружено и она работает надлежащим образом. С родительским сводный монитор сводный показатель работоспособности и он отражает оптимистичный и пессимистичный состояние дочернего элемента.|
| |критические ошибки. |Значение "Критическое" означает, что состояние работоспособности находится за пределами определенных условий. Это значение указывает на то, что обнаружены одна или несколько критических проблем, которые нужно устранить, чтобы восстановить нормальную работу виртуальной машины. С родительским сводный монитор сводный показатель работоспособности и он отражает оптимистичный и пессимистичный состояние дочернего элемента.|
| |Предупреждение |Значение "Предупреждение" означает, что показатель работоспособности находится между двумя определенными порогами. Один из них указывает на состояние *Предупреждение*, а другой — на состояние *Критическое* (можно настроить три порога состояния работоспособности). Это состояние также присваивается при обнаружении некритических проблем, которые могут привести к критическим, если их не устранить. Со сверткой родительский монитор, если один или несколько дочерних элементов находится в состоянии предупреждения, а затем будет отражать родительского *предупреждение* состояния. Если же одновременно для какого-либо дочернего элемента зафиксировано состояние *Критическое*, а для другого — состояние *Предупреждение*, в родительском сводным мониторе для состояния работоспособности отображается значение *Критическое*.|
| |Unknown |Состояние работоспособности — *Неизвестный* при ее не удается вычислить по следующим причинам. См. в разделе ниже сноска <sup>1</sup> более подробные сведения и возможные решения для их устранения. |

<sup>1</sup> неизвестное состояние работоспособности вызвано следующие проблемы:

- Агент был перенастроен с указанием больше не отчеты в рабочую область при включении Azure Monitor для виртуальных машин. Чтобы настроить агент для отправки отчетов в рабочей области см. в разделе, [Добавление или удаление рабочей области](../platform/agent-manage.md#adding-or-removing-a-workspace).
- Виртуальная машина была удалена.
- Удалить рабочую область, связанную с Azure Monitor для виртуальных машин. Для восстановления рабочей области, в том случае, если у вас есть преимущества, можно открыть запрос в службу поддержки с помощью поддержки Premier [Premier](https://premier.microsoft.com/).
- Решение зависимости были удалены. Чтобы включить ServiceMap и InfrastructureInsights решения в рабочей области Log Analytics, можно переустановить с помощью [шаблона Azure Resource Manager](vminsights-enable-at-scale-powershell.md#install-the-servicemap-and-infrastructureinsights-solutions) , предоставленные или с помощью параметра настройки рабочей области см. на Get Started вкладки.
- Виртуальная машина была отключена.
- Служба Azure виртуальной Машины недоступен или производится обслуживание.
- Рабочая область [ежедневные данные или срок хранения](../platform/manage-cost-storage.md) удовлетворяется.

Щелкните **Просмотреть диагностику работоспособности**, чтобы открыть страницу со списком всех компонентов виртуальной машины, для которых указаны критерии работоспособности, сведения об изменении состояний и серьезных проблемах, обнаруженных в ходе мониторинга компонентов виртуальной машины. Дополнительные сведения см. в разделе [Диагностика работоспособности](#health-diagnostics). 

В разделе **Работоспособность компонентов** представлена таблица со сводной информацией о состояниях работоспособности по основным категориям, отслеживаемым для соответствующих областей, например **ЦП**, **Память**, **Диск** и **Сеть**.  Выбрав любой из этих компонентов, вы откроете страницу со списком всех аспектов мониторинга работоспособности и указанием состояния работоспособности для каждого из них.  

При доступе к работоспособности виртуальной машины Azure под управлением операционной системы Windows, состояние работоспособности верхней, пять основных служб отображаются в разделе Windows **основные службы работоспособности**.  Выберите любую из них, чтобы открыть страницу со списком критериев работоспособности для мониторинга этого компонента и сведениями о его работоспособности.  Щелкните имя критерия работоспособности, чтобы открыть панель свойств, на которой можно просмотреть сведения о конфигурации, в том числе об оповещениях Azure Monitor для этого критерия работоспособности. Дополнительные сведения см. в разделе о [диагностике работоспособности и использовании ее критериев](#health-diagnostics).  

### <a name="aggregate-virtual-machine-perspective"></a>Агрегированное представление виртуальных машин

Чтобы просмотреть сводные данные о работоспособности всех виртуальных машин в группе ресурсов, выберите на портале в списке навигации пункт **Azure Monitor**, а затем — элемент **Виртуальные машины (предварительная версия)** .  

![Страница аналитики виртуальных машин. Представление мониторинга в Azure Monitor](./media/vminsights-health/vminsights-aggregate-health.png)

В раскрывающихся списках **Подписка** и **Группа ресурсов** выберите подходящий вариант, который включает целевые виртуальные машины, связанные с группой, для просмотра передаваемого состояния работоспособности.  Выбор применяется только к функции работоспособности и не применяется к производительности.

На вкладке **Работоспособность** можно получить следующие сведения:

* Сколько виртуальных машин находятся в критическом, неработоспособном или исправном состоянии либо не отправляют данные (то есть имеют неизвестное состояние).
* Для каких виртуальных машин и с какими операционными системами (ОС) зафиксировано состояние неработоспособности.
* Сколько виртуальных машин находятся в неработоспособном состоянии из-за проблем с процессором, диском, памятью или сетевым адаптером (в разбивке по категориям состояний работоспособности).  
* Сколько виртуальных машин находятся в неработоспособном состоянии из-за проблем с базовой операционной системой (в разбивке по категориям состояний работоспособности).

Здесь вы можете быстро определить наиболее критичные проблемы, которые обнаруживаются с помощью профилактического мониторинга виртуальной машины, а также просмотреть предупреждения о работоспособности виртуальной машины и соответствующие статьи базы знаний для диагностики и исправления проблемы.  Чтобы открыть страницу [Все оповещения](../../azure-monitor/platform/alerts-overview.md#all-alerts-page), отфильтрованную по конкретной серьезности, щелкните ее.

В списке **Распределение виртуальных машин по операционной системе** перечислены виртуальные машины по каждому выпуску Windows и (или) версии дистрибутива Linux. В каждой категории операционных систем виртуальные машины дополнительно разделены по состояниям работоспособности. 

![Страница аналитики виртуальных машин. Представление с распределением виртуальных машин](./media/vminsights-health/vminsights-vmdistribution-by-os.png)

Вы можете щелкнуть любой элемент столбца, например **Число виртуальных машин**, **Критическое**, **Предупреждение**, **Исправно** или **Неизвестно**, чтобы открыть страницу **Виртуальные машины** с подробными результатами, отфильтрованными по выбранному столбцу. Например, если мы хотим просмотреть все виртуальные машины с ОС **Red Hat Enterprise Linux версии 7.5**, щелкните значение **Число виртуальных машин**, отображаемое для этой ОС. Откроется показанная ниже страница со списком виртуальных машин по этому фильтру и сведениями о работоспособности для них.  

![Пример сводного монитора для виртуальных машин Red Hat Linux](./media/vminsights-health/vminsights-rollup-vm-rehl-01.png)
 
На странице **Виртуальные машины** вы можете выбрать имя виртуальной машины в столбце **Имя виртуальной машины**, чтобы перейти на страницу экземпляра виртуальной машины. Здесь представлены подробные сведения об оповещениях и обнаруженных несоответствиях критериям работоспособности, которые влияют на работоспособность выбранной виртуальной машины.  На этой странице можно отфильтровать сведения о работоспособности, щелкнув значок **Состояние работоспособности** в верхнем левом углу страницы. Например, можно отобразить все компоненты, которые находятся в неработоспособном состоянии или просмотреть оповещения о работоспособности виртуальной машины, вызванные неработоспособным компонентом, в разбивке по категориям серьезности предупреждения.    

Если щелкнуть имя виртуальной машины в представлении списка виртуальных машин, откроется та же самая страница **Работоспособность** для этой виртуальной машины, что и при выборе для нее ссылки **Аналитические сведения (предварительная версия)** .

![Страница аналитики виртуальных машин. Информация по выбранной виртуальной машине Azure](./media/vminsights-health/vminsights-directvm-health.png)

Здесь вы видите сводный монитор **Состояние работоспособности** для виртуальной машины и **оповещения**, сгруппированные по уровням серьезности, то есть оповещения о работоспособности виртуальной машины, создаваемые при ухудшении работоспособности.  Если выбрать элемент **VMs in critical condition** (Виртуальные машины в критическом состоянии), откроется страница со сведениями об одной или нескольких виртуальных машинах, которые находятся в критическом состоянии.  Щелкните состояние работоспособности любой из виртуальных машин в этом списке, чтобы для виртуальной машины отобразилось представление **Диагностика работоспособности**.  Здесь можно выяснить, по каким критериям определена проблема с работоспособностью. На странице **Диагностика работоспособности** отобразятся сведения обо всех компонентах виртуальной машины и критериях работоспособности для них, по которым определено текущее состояние работоспособности. Дополнительные сведения см. в разделе [диагностики работоспособности](#health-diagnostics).  

Щелкните **Просмотреть все условия работоспособности**, чтобы открыть страницу со списком всех доступных для этой функции критериев работоспособности.  Эти данные можно дополнительно отфильтровать по следующим параметрам:

* **Тип.** Есть три типа критериев работоспособности для оценки условий и общего состояния работоспособности отслеживаемой виртуальной машины.  
    a. **Блок.** Отслеживается определенный модуль виртуальной машины. К этому типу критериев работоспособности относятся проверка счетчика производительности для определения производительности компонента, выполнение закодированной в скрипте синтетической транзакции или отслеживание события, свидетельствующего о наличии ошибки.  По умолчанию для фильтра указано именно значение "Блок".  
    2\. **Зависимость.** Предоставляется сводный монитор по нескольким сущностям. Такой критерий работоспособности определяет, что работоспособность определенной сущности зависит от работоспособности сущностей другого типа, которые необходимы ей для успешной работы.  
    c. **Агрегация.** Предоставляются обобщенные сведения о работоспособности по другим критериям работоспособности. В этом критерии работоспособности обычно используются сведения по критерию "Блок" и (или) "Зависимость". Критерий агрегации не только позволяет лучше упорядочить несколько разных критериев для одной сущности, но и определить уникальные состояния работоспособности для отдельных категорий сущностей.

* **Категория.** Этот тип критерия работоспособности используется, чтобы сгруппировать аналогичные критерии для отчетности.  Это могут быть критерии **доступности** или **производительности**.

Вы можете просмотреть более подробные сведения, например найти конкретные неработоспособные экземпляры, щелкнув значение в столбце **Unhealthy Component** (Неработоспособный компонент).  На этой странице представлена таблица со списком компонентов, которые находятся в критическом состоянии.    

## <a name="health-diagnostics"></a>Диагностика работоспособности

**Диагностики работоспособности** страница позволяет визуализировать модели работоспособности виртуальной машины, список всех компонентов виртуальной машины, соответствующие критериям работоспособности, изменения состояния, и другие серьезные проблемы, идентифицируемый отслеживаемый компоненты, связанные к виртуальной Машине.

![Пример страницы диагностики работоспособности для виртуальной машины](./media/vminsights-health/health-diagnostics-page-01.png)

Диагностику работоспособности можно запустить указанными ниже способами.

* Через сводный монитор работоспособности для всех виртуальных машин, который отображается в представлении агрегированных сведений о виртуальной машине в Azure Monitor.  На странице **работоспособности** щелкните значок состояния работоспособности **Критическое**, **Предупреждение**, **Исправно** или **Неизвестно** в разделе **Работоспособность гостевой виртуальной машины**, а затем перейдите к странице со списком виртуальных машин, соответствующих выбранной категории.  Если щелкнуть значение в столбце **Состояние работоспособности**, откроется страница диагностики работоспособности для конкретной виртуальной машины.      

* Через операционную систему в представлении агрегированных сведений о виртуальной машине в Azure Monitor. Из раздела **Распределение виртуальных машин** при выборе любого из значений в столбцах открывается страница **Виртуальные машины** со списком в табличном виде, который отфильтрован по выбранной категории.  Если щелкнуть значение в столбце **Состояние работоспособности**, откроется страница диагностики работоспособности для выбранной виртуальной машины.    
 
* С гостевой виртуальной машины на вкладке **Работоспособность** в Azure Monitor для виртуальных машин. Нужно выбрать **Просмотреть диагностику работоспособности**. 

На странице диагностики работоспособности сведения о работоспособности упорядочены по следующим категориям: 

* Доступность
* Производительность
 
Все работоспособности критериям, определенным для конкретного компонента, например логического диска, ЦП, т. д. можно просматривать без фильтрации на две категории (которые — это комплексная представление всех критериев), или отфильтровать результаты с обеими категориями, при выборе **доступности**  или **производительности** параметры на странице. Кроме того, можно увидеть категорию критерии рядом с ним в **критерия работоспособности** столбца. Если критерии не соответствует выбранной категории, он будет отображаться сообщение **без критериев работоспособности, доступных для выбранной категории** в **критерия работоспособности** столбца.  

Для каждого критерия работоспособности определяется одно из четырех состояний: *Критическое*, *Предупреждение*, *Исправно* или *Неизвестно*. Первые три являются настраиваемыми, то есть можно изменить пороговые значения мониторов непосредственно из области критериев работоспособности конфигурации или с помощью Azure Monitor REST API [монитор операция обновления](https://docs.microsoft.com/rest/api/monitor/microsoft.workloadmonitor/monitors/update). Состояние *Неизвестно* нельзя настроить. Оно зарезервировано для определенных сценариев.  

На странице "Диагностика работоспособности" есть три основных раздела:

* "Модель компонентов"; 
* Health Criteria (Критерии работоспособности);
* "Изменения состояния". 

![Разделы страницы диагностики работоспособности](./media/vminsights-health/health-diagnostics-page-02.png)

### <a name="component-model"></a>Модель компонентов

Крайний столбец слева на странице диагностики работоспособности содержит модель компонентов. В этом столбце отображаются все компоненты, связанные с виртуальной машиной, и сведения об их текущем состоянии работоспособности. 

В следующем примере обнаружены следующие компоненты: диск, логический диск, процессор, память и операционная система. В этом столбце обнаруживаются и отображаются несколько экземпляров этих компонентов. Например, на приведенном ниже рисунке показано, что на виртуальной машине используется два экземпляра логических дисков — C: и D:, которые находятся в исправном состоянии.  

![Пример модели компонентов в разделе диагностики работоспособности](./media/vminsights-health/health-diagnostics-page-component.png)

### <a name="health-criteria"></a>Критерии работоспособности

Центральный столбец на странице диагностики работоспособности называется **Health Criteria** (Критерии работоспособности). Модель работоспособности, созданная для виртуальной машины, отображается здесь в виде иерархического дерева. Модель работоспособности для виртуальной машины состоит из критериев работоспособности "Блок" и "Агрегация".  

![Пример критериев работоспособности в разделе диагностики работоспособности](./media/vminsights-health/health-diagnostics-page-healthcriteria.png)

С помощью каждого критерия работоспособность отслеживаемого экземпляра оценивают по определенному показателю, например по порогу, состоянию сущности и т. д. Критерий работоспособности может принимать два или три настраиваемых порога состояния работоспособности, как описано ранее. В любой момент критерий работоспособности может находиться только в одном из допустимых состояний. 

Общая работоспособность целевого объекта определяется работоспособностью по каждому критерию, установленному в модели работоспособности. Он представляет собой сочетание критерия работоспособности, нацеленных на целевой объект, критерии работоспособности, адресованный сверткой помощью критерий агрегатов работоспособности компонентов. Эта иерархия проиллюстрирована в разделе **критериев работоспособности** на странице "Диагностика работоспособности". Политика сводного монитора работоспособности определяется в конфигурации критериев агрегации, по умолчанию *Worst-of* (Наихудшее из). Вы найдете список по умолчанию набор критериев работоспособности, выполняющуюся как часть этой функции в разделе [конфигурации сведения о наблюдении за](#monitoring-configuration-details), и можно использовать Azure Monitor REST API [наблюдать за экземплярами - список по ресурсам Операция](https://docs.microsoft.com/rest/api/monitor/microsoft.workloadmonitor/monitorinstances/listbyresource) для получения списка всех критериев работоспособности и его подробную конфигурацию при запуске для ресурса виртуальной Машины Azure.  

Чтобы изменить конфигурацию для критерия работоспособности **Блок**, щелкните крайнюю ссылку справа с многоточием и выберите действие **Показать сведения**, после чего откроется панель конфигурации. 

![Пример конфигурации критериев работоспособности](./media/vminsights-health/health-diagnostics-vm-example-02.png)

На панели конфигурации для выбранного критерия работоспособности можно настроить порог с другим числовым значением, используя пример **Average Disk Seconds Per Write** (Среднее время записи на диск в секундах). Это монитор двух состояний. Состояние может изменяться только со значения "Исправно" на значение "Предупреждение". Критерии работоспособности могут поддерживать три состояния, и тогда для них можно отдельно настроить пороги для предупреждения и критического состояния. Вы также можете изменить пороговое значение, с помощью Azure Monitor REST API [монитор операция обновления](https://docs.microsoft.com/rest/api/monitor/microsoft.workloadmonitor/monitors/update).

>[!NOTE]
>Изменения конфигурации, вносимые в критерии работоспособности для одного экземпляра, применяются сразу ко всем отслеживаемым экземплярам.  Например, если вы выберете **Disk -1 D:** (Диск -1 D:) и измените порог для **Average Disk Seconds Per Write** (Среднее время записи на диск в секундах), это значение будет действовать не только для выбранного экземпляра, но и для всех остальных обнаруженных экземпляров диска на отслеживаемой виртуальной машине.
>

![Пример настройки критерия работоспособности для базового монитора](./media/vminsights-health/health-diagnostics-criteria-config-01.png)

С дополнительными сведениями об индикаторе работоспособности можно ознакомиться в статьях базы знаний, где описаны методы выявления проблем, их причины и способы устранения. Щелкните ссылку **Просмотреть сведения**. Статья базы знаний по определенной проблеме откроется в новой вкладке браузера. Вы можете в любой момент просмотреть статьи базы знаний о критериях оценки работоспособности Azure Monitor для виртуальных машин [здесь](https://docs.microsoft.com/azure/monitoring/infrastructure-health/).
  
### <a name="state-changes"></a>Изменения состояний

В крайнем столбце справа на странице диагностики работоспособности отображаются сведения об **изменениях состояния**. Здесь перечислены все изменения состояний, обнаруженные для выбранных критериев работоспособности в разделе **Health Criteria** (Критерии работоспособности), а также изменения состояний для виртуальной машины, если она была выбрана в столбце таблицы **Модель компонентов** или **Health Criteria** (Критерии работоспособности). 

![Пример изменений состояний в разделе диагностики работоспособности](./media/vminsights-health/health-diagnostics-page-statechanges.png)

Этот раздел содержит сведения об изменении состояния критериев работоспособности и времени их изменения с сортировкой по убыванию актуальности.   

### <a name="association-of-component-model-health-criteria-and-state-change-columns"></a>Ассоциации модели компонентов, критерии работоспособности и состоянии изменить столбцы 

Эти три столбца связаны друг с другом. Если выбрать обнаруженный экземпляр в разделе **Модель компонентов**, раздел **Критерии работоспособности** фильтруется по этому компоненту, а затем обновляется раздел **Изменение состояния** в зависимости от набора выбранных критериев работоспособности. 

![Пример выбора отслеживаемого экземпляра и фильтрации результатов](./media/vminsights-health/health-diagnostics-vm-example-01.png)

Когда в приведенном выше примере вы выбираете экземпляр **Disk - 1 D:** (Диск -1 D:), дерево критериев работоспособности фильтруется по экземпляру **Disk - 1D:** (Диск -1 D:). Теперь в столбце **Изменение состояния** отображаются только изменения состояния, касающиеся доступности экземпляра **Disk - 1D:** (Диск -1 D:). 

Чтобы просмотреть обновленные сведения о работоспособности, обновите страницу диагностики. Для этого щелкните ссылку **Обновить**.  Если состояние работоспособности для критерия работоспособности изменяется с определенным заданным интервалом, это действие позволит избежать ожидания и сразу отобразить свежие данные о работоспособности.  Фильтр **Состояние критериев работоспособности** позволяет ограничить результаты по значению состояния работоспособности: *Исправно*, *Предупреждение*, *Критическое*, *Неизвестно* или получить результаты по *всем* этим значениям.  Значение времени **Последнее обновление** в верхнем углу справа — это момент последней загрузки страницы диагностики работоспособности.  

## <a name="alerts"></a>Оповещения

Функцию оценки работоспособности в Azure Monitor для виртуальных машин можно интегрировать с [интерфейсом оповещений Azure](../../azure-monitor/platform/alerts-overview.md), чтобы создавать оповещения о переходе критериев работоспособности из состояния "Исправно" в любое неисправное состояние. Оповещения разделяются на несколько уровней серьезности — от 0 до 4, где 0 обозначает наивысший уровень серьезности. 

Оповещения не связаны с группы действий для уведомления о том, когда было запущено оповещение. Владелец подписки необходимо настроить уведомления, описанные [далее в этом разделе](#configure-alerts).   

Общее число оповещений о работоспособности виртуальной машины с разбивкой по уровням серьезности можно найти на панели мониторинга **Работоспособность** в разделе **Оповещения**. Когда вы выбираете общее число оповещений или число, соответствующее определенному уровню серьезности, открывается страница **Оповещения** со списком всех оповещений для выбранного элемента.  Например, если вы выбрали строку для уровня серьезности **Sev level 1**, вы увидите следующее:

![Пример оповещений для уровня серьезности 1](./media/vminsights-health/vminsights-sev1-alerts-01.png)

На странице **Оповещения** отображаются не только оповещения, соответствующие выбранным параметрам, но и отфильтрованные по **типу ресурса**, чтобы отображались только оповещения о работоспособности, вызванные ресурсом виртуальной машины.  Оно будет отражено в списке оповещений, в столбце **целевой ресурс**, где он показывает для возникло оповещение, когда выполнено условие неработоспособное критерия работоспособности для конкретной виртуальной Машине Azure.  

Оповещения от других типов ресурсов или службы не предназначены для включения в этом представлении, такие как журнал оповещений на основе журнала запросов или оповещения метрик, можно будет просматривать по умолчанию Azure Monitor [все оповещения](../../azure-monitor/platform/alerts-overview.md#all-alerts-page) страницы. 

Это представление можно отфильтровать, выбрав значения в раскрывающемся меню в верхней части страницы.

|столбец |Описание | 
|-------|------------| 
|Подписка |Выберите подписку Azure. В представление включены только оповещения из выбранных подписок. | 
|Группа ресурсов |Выбор одной группы ресурсов. Только те предупреждения, которые отмечены в выбранной группе ресурсов, включены в представление. | 
|Тип ресурса |Выбор одной или нескольких группу ресурсов. По умолчанию только оповещения целевого объекта **Виртуальные машины** выбраны и включены в это представление. Этот столбец становится доступным только после указания группы ресурсов. | 
|Ресурс |Выбор ресурса. В представление включены только те оповещения, целью которых выбраны ресурсы. Этот столбец становится доступным только после указания типа ресурсов. | 
|Severity |Выберите серьезность оповещения или щелкните *Все*, чтобы включить оповещения всех уровней серьезности. | 
|Состояние монитора |Выберите условие мониторинга, при котором отображаются предупреждения, созданные системой (*Fired*) или устраненные системой (*Resolved*) при прекращении действия условия. Также можно выбрать вариант *Все*, чтобы отобразить оповещения по любым условиям. | 
|Состояние оповещения |Выберите состояние оповещения *Новое*, *Подтверждено* или *Закрыто* или щелкните *Все*, чтобы включить оповещения во всех состояниях. | 
|Мониторинг службы |Выберите службу или щелкните *Все*, чтобы включить все службы. Эта функция поддерживает только оповещения от *аналитики виртуальных машин*.| 
|Диапазон времени| Только оповещения, выполненные в рамках выбранного временного интервала, будут включены в представление. Поддерживаемые значения: за последний час, за последние 24 часа, за последние 7 дней и за последние 30 дней. | 

При выборе оповещения отображается страница **сведений об оповещении**, где вы можете изменить его состояние. Дополнительные сведения об управлении оповещениями см. в статье [Создание и просмотр оповещений метрик, а также управление ими с помощью Azure Monitor](../../azure-monitor/platform/alerts-metric.md).  

>[!NOTE]
>Сейчас не поддерживается создание оповещений на основе критериев работоспособности или изменение существующих правил генерации оповещений о работоспособности в Azure Monitor на портале.  
>

![Панель сведений о выбранном оповещении](./media/vminsights-health/alert-details-pane-01.png)

Также состояние оповещения можно изменить, выбрав одно или несколько оповещений на странице **Все оповещения** в верхнем углу слева и выбрав **Изменить состояние**. На панели **Изменить состояние оповещения** следует выбрать одно из состояний, добавить для него описание в поле **Комментарий** и зафиксировать изменения, нажав кнопку **ОК**. Пока проверяются данные, ход применения изменений можно отслеживать с помощью пункта меню **Уведомления**.  

### <a name="configure-alerts"></a>Настройка оповещений
Задачи, нельзя управлять с помощью портала Azure и должны выполняться с помощью определенных Управление оповещениями [Azure Monitor REST API](https://docs.microsoft.com/rest/api/monitor/microsoft.workloadmonitor/components). В частности:

- Включение или отключение оповещения для критерия работоспособности 
- Настройка уведомлений для оповещений о работоспособности критериев 

Используя этот подход используется в каждом примере [ARMClient](https://github.com/projectkudu/armclient) на компьютере Windows. Если вы не знакомы с этим способом, см. в разделе [ARMClient с помощью](../platform/rest-api-walkthrough.md#use-armclient).  

#### <a name="enable-or-disable-alert-rule"></a>Включить или отключить правило генерации оповещений

Чтобы включить или отключить оповещение для условия конкретного работоспособности, свойство критерии работоспособности *alertGeneration* должно быть изменено со значением либо **отключено** или **включено**. Для идентификации *monitorId* критериев работоспособности определенной, приведенный ниже будет показано, как запрос для этого значения для критериев **Диск\ср секунд на обращения к диску**.

1. В окне терминала введите **armclient.exe login**. При этом появится запрос на вход в Azure.

2. Введите следующую команду, чтобы получить все критерии работоспособности, активных на конкретной виртуальной машины и определить значение для *monitorId* свойство. 

    ```
    armclient GET "subscriptions/subscriptionId/resourceGroups/resourcegroupName/providers/Microsoft.Compute/virtualMachines/vmName/providers/Microsoft.WorkloadMonitor/monitors?api-version=2018-08-31-preview”
    ```

    В примере показан результат выполнения этой команды. Запишите значение *MonitorId*. Это значение является обязательным для выполнения следующего шага, нужно указать идентификатор критерия работоспособности и изменить его свойства, чтобы создать оповещение.

    ```
    "id": "/subscriptions/a7f23fdb-e626-4f95-89aa-3a360a90861e/resourcegroups/Lab/providers/Microsoft.Compute/virtualMachines/SVR01/providers/Microsoft.WorkloadMonitor/monitors/ComponentTypeId='LogicalDisk',MonitorId='Microsoft_LogicalDisk_AvgDiskSecPerRead'",
      "name": "ComponentTypeId='LogicalDisk',MonitorId='Microsoft_LogicalDisk_AvgDiskSecPerRead'",
      "type": "Microsoft.WorkloadMonitor/virtualMachines/monitors"
    },
    {
      "properties": {
        "description": "Monitor the performance counter LogicalDisk\\Avg Disk Sec Per Transfer",
        "monitorId": "Microsoft_LogicalDisk_AvgDiskSecPerTransfer",
        "monitorName": "Microsoft.LogicalDisk.AvgDiskSecPerTransfer",
        "monitorDisplayName": "Average Logical Disk Seconds Per Transfer",
        "parentMonitorName": null,
        "parentMonitorDisplayName": null,
        "monitorType": "Unit",
        "monitorCategory": "PerformanceHealth",
        "componentTypeId": "LogicalDisk",
        "componentTypeName": "LogicalDisk",
        "componentTypeDisplayName": "Logical Disk",
        "monitorState": "Enabled",
        "criteria": [
          {
            "healthState": "Warning",
            "comparisonOperator": "GreaterThan",
            "threshold": 0.1
          }
        ],
        "alertGeneration": "Enabled",
        "frequency": 1,
        "lookbackDuration": 17,
        "documentationURL": "https://aka.ms/Ahcs1r",
        "configurable": true,
        "signalType": "Metrics",
        "signalName": "VMHealth_Avg. Logical Disk sec/Transfer"
      },
      "etag": null,
    ```

3. Введите следующую команду, чтобы изменить *alertGeneration* свойство.

    ```
    armclient patch subscriptions/subscriptionId/resourceGroups/resourcegroupName/providers/Microsoft.Compute/virtualMachines/vmName/providers/Microsoft.WorkloadMonitor/monitors/Microsoft_LogicalDisk_AvgDiskSecPerTransfer?api-version=2018-08-31-preview "{'properties':{'alertGeneration':'Disabled'}}"
    ```   

4. Введите команду GET, использовавшееся на шаге 2, чтобы проверить, присвоено значение свойства **отключено**.  

#### <a name="associate-action-group-with-health-criteria"></a>Связать группу действий с критерия работоспособности

Azure Monitor для работоспособности виртуальных машин поддерживает уведомления, SMS и электронной почты, при создании предупреждений при критерия работоспособности становится неработоспособным. Чтобы настроить уведомления, вам потребуется запомните имя группы действий, который настроен для отправки уведомлений электронной почты или SMS. 

>[!NOTE]
>Это действие требуется возможность выполнить на каждой виртуальной Машины, отслеживать, что вы хотите получать уведомления об, он не применяется ко всем виртуальным машинам в группе ресурсов.  

1. В окне терминала введите **armclient.exe login**. При этом появится запрос на вход в Azure.

2. Введите следующую команду, чтобы связать группу действий с правилами генерации оповещений.
 
    ```
    $payload = "{'properties':{'ActionGroupResourceIds':['/subscriptions/subscriptionId/resourceGroups/resourcegroupName/providers/microsoft.insights/actionGroups/actiongroupName']}}" 
    armclient PUT https://management.azure.com/subscriptions/subscriptionId/resourceGroups/resourcegroupName/providers/Microsoft.Compute/virtualMachines/vmName/providers/Microsoft.WorkloadMonitor/notificationSettings/default?api-version=2018-08-31-preview $payload
    ```

3. Чтобы проверить значение свойства **actionGroupResourceIds** был успешно обновлен, введите следующую команду.

    ```
    armclient GET "subscriptions/subscriptionName/resourceGroups/resourcegroupName/providers/Microsoft.Compute/virtualMachines/vmName/providers/Microsoft.WorkloadMonitor/notificationSettings?api-version=2018-08-31-preview"
    ```

    Результат должен выглядеть так:
    
    ```
    {
      "value": [
        {
          "properties": {
            "actionGroupResourceIds": [
              "/subscriptions/a7f23fdb-e626-4f95-89aa-3a360a90861e/resourceGroups/Lab/providers/microsoft.insights/actionGroups/Lab-IT%20Ops%20Notify"
            ]
          },
          "etag": null,
          "id": "/subscriptions/a7f23fdb-e626-4f95-89aa-3a360a90861e/resourcegroups/Lab/providers/Microsoft.Compute/virtualMachines/SVR01/providers/Microsoft.WorkloadMonitor/notificationSettings/default",
          "name": "notificationSettings/default",
          "type": "Microsoft.WorkloadMonitor/virtualMachines/notificationSettings"
        }
      ],
      "nextLink": null
    }
    ```

## <a name="next-steps"></a>Дальнейшие действия

Чтобы выявить узкие места производительности и общий уровень загрузки для виртуальных машин, изучите статью о [просмотре данных производительности виртуальной машины Azure](vminsights-performance.md). Просмотреть обнаруженные зависимости приложений поможет статья о [функции карты Azure Monitor для виртуальных машин](vminsights-maps.md). 
