---
title: Мониторинг Key Vault с помощью Azure Monitor для Key Vault (Предварительная версия) | Документация Майкрософт
description: В этой статье описывается Azure Monitor для хранилищ ключей.
services: azure-monitor
ms.topic: conceptual
author: mrbullwinkle
ms.author: mbullwin
ms.date: 04/13/2019
ms.openlocfilehash: 2387f14a537c15c891bff968573bf4d698c01770
ms.sourcegitcommit: a8ee9717531050115916dfe427f84bd531a92341
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/12/2020
ms.locfileid: "83211307"
---
# <a name="monitoring-your-key-vault-service-with-azure-monitor-for-key-vault-preview"></a>Мониторинг службы хранилища ключей с помощью Azure Monitor для Key Vault (Предварительная версия)
Azure Monitor для Key Vault (Предварительная версия) обеспечивает полный мониторинг хранилищ ключей, обеспечивая единое представление запросов Key Vault, производительности, сбоев и задержки.
Эта статья поможет вам понять, как подключить и настроить интерфейс Azure Monitor для Key Vault (Предварительная версия).

## <a name="introduction-to-azure-monitor-for-key-vault-preview"></a>Введение в Azure Monitor для Key Vault (Предварительная версия)

Прежде чем переходить к опыту, необходимо понять, как он представляет и визуализирует информацию.
-    **В перспективе масштаба** отображается моментальный снимок производительности, основанный на запросах, разделении сбоев и обзоре операций и задержки.
-   **Детализированный анализ** определенного хранилища ключей для выполнения подробного анализа.
-    **Настраиваемое** расположение позволяет изменить отображаемые метрики, изменить или задать пороговые значения, которые будут совпадать с вашими ограничениями, и сохранить собственную книгу. Диаграммы в книге можно закрепить на панелях мониторинга Azure.

Azure Monitor для Key Vault объединяет как журналы, так и метрики, чтобы обеспечить глобальное решение для мониторинга. Все пользователи могут получить доступ к данным мониторинга на основе метрик, однако включение визуализаций на основе журналов может потребовать от пользователей [включить ведение журнала Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-logging).

## <a name="configuring-your-key-vaults-for-monitoring"></a>Настройка хранилищ ключей для мониторинга

> [!NOTE]
> Включение журналов — это платная служба, которая предоставляет дополнительные возможности мониторинга.

1. Вкладка задержка операций & позволяет определить, сколько хранилищ ключей включено. Чтобы начать сбор данных, нажмите кнопку **Enable (включить** ), чтобы перейти к отдельной книге, в которой перечислены хранилища ключей, требующие включения журналов диагностики.

    ![Снимок экрана вкладки "операции и задержки" с синей кнопкой "включить"](./media/key-vaults-insights-overview/enable-logging.png)

2. Чтобы включить журналы диагностики, щелкните ссылку **включить** под столбцом действия и создайте новый параметр диагностики, который отправляет журналы в рабочую область log Analytics. Рекомендуется отправить все журналы в одну и ту же рабочую область.

3. После сохранения параметров диагностики Вы сможете просматривать все диаграммы и визуализации, основанные на журналах, под Key Vault Insights. Обратите внимание, что начать заполнение журналов может занять несколько минут.

4. Дополнительные сведения о том, как включить журналы диагностики для службы Key Vault, см. в [полной инструкции](https://docs.microsoft.com/azure/key-vault/key-vault-logging).

## <a name="view-from-azure-monitor"></a>Просмотреть из Azure Monitor

С Azure Monitor можно просматривать сведения о запросах, задержках и сбоях из нескольких хранилищ ключей в подписке, а также выявление проблем производительности и сценариев регулирования.

Чтобы просмотреть сведения об использовании и операциях учетных записей хранения во всех подписках, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com/).

2. Выберите **монитор** в области слева в портал Azure и в разделе аналитики выберите **хранилища ключей (Предварительная версия)**.

![Снимок экрана с обзорным интерфейсом с несколькими графами](./media/key-vaults-insights-overview/overview.png)

## <a name="overview-workbook"></a>Обзорная книга

В таблице обзор книги для выбранной подписки отображаются сведения о метриках хранилища ключей, сгруппированных в рамках подписки. Результаты можно фильтровать на основе параметров, выбранных в следующих раскрывающихся списках:

* Подписки — перечислены только подписки с хранилищем ключей.

* Хранилища ключей — по умолчанию предварительно выбрано не более 5 хранилищ ключей. Если в селекторе области выбрать все или несколько хранилищ ключей, будут возвращены до 200 хранилищ ключей. Например, если вы выбрали не более 573 хранилищ ключей в трех выбранных подписках, будут отображаться только хранилища 200.

* Диапазон времени — по умолчанию отображает данные за последние 24 часа на основе соответствующих параметров.

Плитка счетчика в раскрывающемся списке выполняет сведение общего числа хранилищ ключей в выбранных подписках и показывает, сколько выбрано. Для столбцов книги, которые сообщают о запросах, сбоях и метриках задержки, существуют условные тепловые картыи цветом. Самый глубокий цвет имеет наибольшее значение, а светлый — на основе наименьших значений.

## <a name="failures-workbook"></a>Книга "ошибки"

В верхней части страницы выберите **сбои** , после чего откроется вкладка ошибки. Он показывает попадания в API, частоту с течением времени, а также количество определенных кодов откликов.

![Снимок экрана книги "ошибки"](./media/key-vaults-insights-overview/failures.png)

Существует условное выделение цветом или тепловые карты для столбцов в книге, которые сообщают метрики API с синим значением. Самый глубокий цвет имеет наибольшее значение, а светлый — на основе наименьших значений.

В книге отображаются успешные попытки (коды состояния 2xx), ошибки проверки подлинности (коды состояния 401/403), регулирование (коды состояния 429) и другие сбои (коды состояния 4xx).

Чтобы лучше понять, что представляет каждый из кодов состояния, рекомендуем ознакомиться с документацией по [Azure Key Vault состояния и кодов ответа](https://docs.microsoft.com/azure/key-vault/authentication-requests-and-responses).

## <a name="operations--latency-workbook"></a>Книга операций с задержкой &

Выберите **операции & задержка** в верхней части страницы, после чего откроется вкладка **Задержка & операций** . Эта вкладка позволяет подключать хранилища ключей для мониторинга. Подробные инструкции см. в разделе [Настройка хранилища ключей для мониторинга](#configuring-your-key-vaults-for-monitoring) .

Вы можете увидеть, сколько хранилищ ключей включено для ведения журнала. Если по крайней мере одно хранилище настроено правильно, вы увидите таблицы, в которых отображаются операции и коды состояния для каждого хранилища ключей. Можно щелкнуть раздел сведений для строки, чтобы получить дополнительные сведения об отдельной операции.

![Снимок экрана с диаграммами операций и задержки](./media/key-vaults-insights-overview/logs.png)

Если вы не видите данные для этого раздела, ознакомьтесь с разделом, посвященным включению журналов для Azure Key Vault, или см. раздел Устранение неполадок ниже.

## <a name="view-from-a-key-vault-resource"></a>Просмотр из Key Vault ресурса

Чтобы получить доступ к Azure Monitor для Key Vault непосредственно из хранилища ключей:

1. В портал Azure выберите хранилища ключей.

2. В списке выберите хранилище ключей. В разделе Мониторинг выберите Insights (Предварительная версия).

Эти представления также доступны, если выбрать имя ресурса хранилища ключей из книги Azure Monitor уровня.

![Снимок экрана представления из ресурса хранилища ключей](./media/key-vaults-insights-overview/key-vault-resource-view.png)

В книге **Обзор** для хранилища ключей показаны несколько метрик производительности, которые помогут вам быстро оценить следующее:

- Интерактивные диаграммы производительности, отображающие наиболее важные сведения о транзакциях, задержках и доступности хранилища ключей.

- Метрики и плитки состояния выделяют доступность службы, общее число транзакций для ресурса хранилища ключей и общую задержку.

При выборе любой из других вкладок для **сбоев** или **операций** открывается соответствующая книга.

![Снимок экрана: представление ошибок](./media/key-vaults-insights-overview/resource-failures.png)

В книге "ошибки" разбиваются результаты всех запросов хранилища ключей за выбранный промежуток времени, а также предоставляется классификация успешных операций (2xx), ошибок проверки подлинности (401/403), регулирования (429) и других сбоев.

![Снимок экрана представления операций](./media/key-vaults-insights-overview/operations.png)

Книга операций позволяет пользователям глубоко разобраться в подробных сведениях о всех транзакциях, которые можно отфильтровать по состоянию результата с помощью плиток верхнего уровня.

![Снимок экрана представления операций](./media/key-vaults-insights-overview/info.png)

Пользователи также могут выровнять представления на основе конкретных типов транзакций в верхней таблице, что динамически обновляет нижнюю таблицу, где пользователи могут просматривать полные сведения об операции во всплывающей области контекста.

>[!NOTE]
> Обратите внимание, что для просмотра этой книги пользователям необходимо включить параметры диагностики. Дополнительные сведения о включении параметра диагностики см. в статье [ведение журнала Azure Key Vault](https://docs.microsoft.com/azure/key-vault/general/logging).

## <a name="pin-and-export"></a>Закрепление и экспорт

Вы можете закрепить один из разделов метрик на панели мониторинга Azure, щелкнув значок канцелярской кнопки в правом верхнем углу раздела.

Рабочие книги с несколькими подписками и хранилищами ключей поддерживают экспорт результатов в формате Excel, щелкнув значок скачивания слева от значка канцелярской кнопки.

![Снимок экрана с выбранным значком закрепления](./media/key-vaults-insights-overview/pin.png)

## <a name="customize-azure-monitor-for-key-vault"></a>Настройка Azure Monitor для Key Vault

В этом разделе описываются распространенные сценарии редактирования книги для настройки в целях поддержки потребностей в анализе данных.
*  Область действия книги всегда выбирайте определенную подписку или хранилище ключей
* Изменение метрик в сетке
* Изменение порога запросов
* Изменение отображения цвета

Чтобы начать настройку, включите режим редактирования, нажав кнопку **Настройка** на верхней панели инструментов.

![Снимок экрана: кнопка "настроить"](./media/key-vaults-insights-overview/customize.png)

Настройки сохраняются в пользовательской книге, чтобы предотвратить перезапись конфигурации по умолчанию в нашей опубликованной книге. Книги сохраняются в группе ресурсов либо в разделе Мои отчеты, который является частным, либо в разделе Общие отчеты, доступном всем пользователям с доступом к группе ресурсов. После сохранения пользовательской книги необходимо перейти в коллекцию книг, чтобы запустить ее.

![Снимок экрана: коллекция книг](./media/key-vaults-insights-overview/gallery.png)

### <a name="specifying-a-subscription-or-key-vault"></a>Указание подписки или хранилища ключей

Вы можете настроить общие сведения о нескольких подписках и хранилищах ключей или сбоях для рабочих книг, чтобы ограничить область до определенных подписок или хранилищ ключей при каждом запуске, выполнив следующие действия.

1. Выберите **монитор** на портале, а затем в области слева выберите **хранилища ключей (Предварительная версия)** .
2. В рабочей книге **Обзор** на панели команд выберите **изменить**.
3. В раскрывающемся списке **подписки** выберите одну или несколько подписок, которые будут использоваться по умолчанию. Помните, что книга поддерживает выбор всего 10 подписок.
4. В раскрывающемся списке **хранилища ключей** выберите одну или несколько учетных записей, которые будут использоваться по умолчанию. Помните, что книга поддерживает выбор всего 200 учетных записей хранения.
5. Выберите команду **Сохранить как** на панели команд, чтобы сохранить копию книги с вашими настройками, а затем нажмите кнопку **Готово к редактированию** , чтобы вернуться в режим чтения.

## <a name="troubleshooting"></a>Устранение неполадок

Этот раздел поможет вам в диагностике и устранении неполадок некоторых распространенных проблем, которые могут возникнуть при использовании Azure Monitor для Key Vault (Предварительная версия). Чтобы найти информацию о конкретной проблеме, просмотрите список ниже.

### <a name="resolving-performance-issues-or-failures"></a>Устранение проблем с производительностью или сбоев

Дополнительные сведения об устранении неполадок, связанных с хранилищем ключей, которые можно определить с помощью Azure Monitor для Key Vault (Предварительная версия), см. в [документации по Azure Key Vault](https://docs.microsoft.com/azure/key-vault/).

### <a name="why-can-i-only-see-200-key-vaults"></a>Почему можно видеть только хранилище ключей 200?

Существует ограничение в 200 хранилища ключей, которое можно выбрать и просмотреть. Независимо от числа выбранных подписок количество выбранных хранилищ ключей ограничено 200.

### <a name="what-will-happen-when-a-pinned-item-is-clicked"></a>Что произойдет при щелчке закрепленного элемента?

При щелчке закрепленного элемента на панели мониторинга откроется одно из двух действий:
* Если аналитика была сохранена, откроется экземпляр Insights, из которого был сохранен ПИН-код.
* Если аналитика была несохраненной — он откроет новый экземпляр Insights по умолчанию.

### <a name="why-dont-i-see-all-my-subscriptions-in-the-subscription-picker"></a>Почему в средстве выбора подписки не отображаются все подписки?

Мы видим только те подписки, которые содержат хранилища ключей, выбранные в фильтре подписок "Каталог + подписка" в заголовке портал Azure.

![Снимок экрана: фильтр подписки](./media/key-vaults-insights-overview/Subscriptions.png)

### <a name="i-am-getting-an-error-message-that-the-query-exceeds-the-maximum-number-of-workspacesregions-allowed-what-to-do-now"></a>Я получаю сообщение об ошибке "запрос превышает максимально допустимое число рабочих областей и регионов", что делать сейчас?

В настоящее время существует ограничение в 25 регионов и 200 рабочих областей для просмотра данных, необходимо уменьшить число подписок и/или групп ресурсов.

### <a name="i-want-to-make-changes-or-add-additional-visualizations-to-key-vault-insights-how-do-i-do-so"></a>Я хочу внести изменения или добавить дополнительные визуализации для Key Vault Insights, как это сделать?

Чтобы внести изменения, выберите режим редактирования, чтобы изменить книгу, после чего можно сохранить работу в виде новой книги, привязанной к назначенной подписке и группе ресурсов.

### <a name="what-is-the-time-grain-once-we-pin-any-part-of-the-workbooks"></a>Что такое промежуток времени после закрепления любой части книг?

Мы используем интервал времени "Auto", поэтому он зависит от выбранного диапазона времени.

### <a name="what-is-the-time-range-when-any-part-of-the-workbook-is-pinned"></a>Каков диапазон времени, когда какая-либо часть книги закреплена?

Диапазон времени будет зависеть от параметров панели мониторинга.

### <a name="why-do-i-not-see-any-data-for-my-key-vault-under-the-operations--latency-sections"></a>Почему в разделах "операции & задержка" не отображаются данные для Key Vault?

Для просмотра данных на основе журналов необходимо включить журналы для каждого хранилища ключей, которое необходимо отслеживать. Это можно сделать в параметрах диагностики для каждого хранилища ключей. Вам потребуется отправить данные в назначенную рабочую область Log Analytics.

### <a name="i-have-already-enabled-logs-for-my-key-vault-why-am-i-still-unable-to-see-my-data-under-operations--latency"></a>Я уже включил журналы для моей Key Vault, почему я по-прежнему не вижу данных в разделе Operations & задержка?

В настоящее время журналы диагностики не работают задним числом, поэтому данные будут отображаться только после того, как были сделаны действия в хранилищах ключей. Таким образом, в зависимости от того, как активно ваше хранилище ключей, может потребоваться некоторое время в диапазоне от нескольких часов до определенного дня.

Кроме того, если выбрано большое количество хранилищ ключей и подписок, просмотр данных может быть недоступен из-за ограничений запросов. Для просмотра данных может потребоваться уменьшить количество выбранных подписок или хранилищ ключей. 

### <a name="what-if-i-want-to-see-other-data-or-make-my-own-visualizations-how-can-i-make-changes-to-the-key-vault-insights"></a>Что делать, если нужно просмотреть другие данные или создать собственные визуализации? Как внести изменения в Key Vaultную аналитику?

Можно изменить существующую книгу, используя режим редактирования, а затем сохранить работу в виде новой книги, в которой будут внесены все новые изменения.

## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь с книгами сценариев, предназначенными для поддержки, создания новых и настройки существующих отчетов и многого другого, изучив [Создание интерактивных отчетов с помощью Azure Monitor книг](https://docs.microsoft.com/azure/azure-monitor/app/usage-workbooks).
