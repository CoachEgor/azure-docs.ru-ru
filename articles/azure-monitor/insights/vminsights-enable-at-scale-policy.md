---
title: Включение Azure Monitor для виртуальных машин с помощью "Политика Azure" | Документация Майкрософт
description: В этой статье описывается, как включить Azure Monitor для виртуальных машин для нескольких виртуальных машин Azure или масштабируемые наборы виртуальных машин с помощью политики Azure.
services: azure-monitor
documentationcenter: ''
author: mgoedtel
manager: carmonm
editor: ''
ms.assetid: ''
ms.service: azure-monitor
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/07/2019
ms.author: magoedte
ms.openlocfilehash: cf06004c70609dbea59a47b207e3568299260a82
ms.sourcegitcommit: ccb9a7b7da48473362266f20950af190ae88c09b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/05/2019
ms.locfileid: "67594450"
---
# <a name="enable-azure-monitor-for-vms-preview-by-using-azure-policy"></a>Включить монитор Azure для виртуальных машин (Предварительная версия) с помощью политики Azure

В этой статье объясняется, как включить Azure Monitor для виртуальных машин (Предварительная версия) для виртуальных машин Azure или масштабируемые наборы виртуальных машин с помощью политики Azure. В конце этого процесса будет успешно настроена, позволяя Log Analytics и агенты зависимостей и обнаружили виртуальные машины, которые не соответствуют.

Чтобы найти, управление и включить Azure Monitor для виртуальных машин для всех виртуальных машинах Azure или масштабируемые наборы виртуальных машин, можно использовать политики Azure или Azure PowerShell. "Политика Azure" — это метод, рекомендуется, так как вы можете управлять определений политик, чтобы эффективно регулировать ваших подписок, чтобы обеспечить согласованное соответствие требованиям и автоматического включения вновь подготовки виртуальных машин. Эти определения политик:

* Развернуть агент Log Analytics и Dependency Agent.
* Создать отчет о результатах проверки на соответствие.
* Исправление для несоответствующих виртуальных машин.

Если вы заинтересованы в выполнении этих задач с помощью Azure PowerShell или шаблона Azure Resource Manager, см. в разделе [включить Azure Monitor для виртуальных машин (Предварительная версия) с помощью шаблонов Azure Resource Manager или Azure PowerShell](vminsights-enable-at-scale-powershell.md).

## <a name="manage-policy-coverage-feature-overview"></a>Общие сведения о функции покрытия политики управления

Изначально опыт работы с политиками Azure для развертывания определения политик для Azure Monitor для виртуальных машин и управления ими было сделано исключительно на основе политики Azure. Управление покрытия политики позволяют проще и легче находить, включить в нужном масштабе и управлять **включить Azure Monitor для виртуальных машин** инициативы, включая определения политик, упомянутых ранее. Можно получить доступ к этой новой функции из **приступить к работе** вкладки в мониторе Azure для виртуальных машин. Выберите **управление покрытия политики** открыть **Azure Monitor для покрытия политики виртуальных машин** страницы.

![Azure Monitor вкладке "виртуальные машины приступить к работе"](./media/vminsights-enable-at-scale-policy/get-started-page-01.png)

На этой странице можно проверять и управлять покрытия инициативы нескольких групп управления и подписок. Можно понять, сколько виртуальных машин существует в каждой из групп управления, подписок и их состояния соответствия.

![Azure Monitor для страницы политики управления виртуальными машинами](./media/vminsights-enable-at-scale-policy/manage-policy-page-01.png)

Эта информация полезна для планированием и выполнением сценария управления для Azure Monitor для виртуальных машин из одного центрального расположения. "Политика Azure" обеспечивает представление соответствия, при назначении политики или инициативы области, с помощью этой новой странице можно определить, где политики или инициативы не назначена и назначьте его на месте. Все действия, такие как назначение, просматривать и редактировать перенаправления политику Azure напрямую. **Azure Monitor для покрытия политики виртуальных машин** страницы — это расширенная и интегрированная среда только инициативы **включить Azure Monitor для виртуальных машин**.

На этой странице вы также можете настроить рабочую область Log Analytics для Azure Monitor для виртуальных машин, который:

- Устанавливает решения Установка схемы услуги и Infrastructure Insights.
- Включает счетчики производительности операционной системы, используемый диаграммы производительности, книг и ваш пользовательский журнал запросов и оповещений.

![Azure Monitor для виртуальных машин Настройка рабочей области](./media/vminsights-enable-at-scale-policy/manage-policy-page-02.png)

Этот параметр не связано с каких-либо действий политики. Она доступна для предоставляют простой способ для удовлетворения [предварительные требования](vminsights-enable-overview.md) необходимые для включения Azure Monitor для виртуальных машин.  

### <a name="what-information-is-available-on-this-page"></a>Какие сведения можно найти на этой странице?
В следующей таблице представлена декомпозиция сведения, представленные на странице покрытия политики и их интерпретации.

| Функция | Описание | 
|----------|-------------| 
| **Область** | Группы управления и подписок, у вас есть или унаследован доступ с возможностью выполнять детализацию иерархией групп управления.|
| **Роль** | Роли в область, которая может быть читателя, владельца или участника. В некоторых случаях может оказаться пустым, чтобы указать, что может иметь доступ к подписке, но не в группу управления он принадлежит. Сведения из других столбцов зависит от вашей роли. Роль является ключевым фактором при определении данных, можно увидеть и действия можно выполнять с точки зрения назначение политик или инициатив (owner), редактирование или Просмотр соответствия. |
| **Общее число виртуальных машин** | Число виртуальных машин в пределах данной области. Для группы управления это сумма виртуальных машин, вложен в узел подписки или дочерней группы управления. |
| **Назначение покрытия** | Процент от виртуальных машин, которые покрываются политики или инициативы. |
| **Состояние назначения** | Сведения о состоянии назначения политики или инициативы. |
| **Совместимые виртуальные машины** | Число виртуальных машин, которые соответствуют требованиям политики или инициативы. Инициативы **включить Azure Monitor для виртуальных машин**, это количество виртуальных машин, имеющих агент Log Analytics и агент зависимостей. В некоторых случаях может оказаться пустым из-за назначение не, нет виртуальных машин или недостаточно разрешений. Информация в разделе **состояние соответствия**. |
| **Соответствие требованиям** | Общее число соответствия является суммой различных ресурсов, которые соответствуют требованиям разделить на сумму всех различных ресурсов. |
| **Состояние соответствия** | Сведения о состоянии соответствия для назначения политики или инициативы.|

При назначении политики или инициативы, области, выбранным в назначения может быть области в списке или его часть. Например вы могли создать назначение для подписки (область действия политики), а не группой управления (покрытия область). В этом случае значение **покрытия назначения** указывает виртуальные машины в той политики или инициативы области, деленное на виртуальные машины в области покрытия. В другом случае может исключенные некоторые виртуальные машины, группы ресурсов или подписку из области действия политики. Если значение пусто, это означает, что политики или инициативы не существует или у вас нет разрешения. Информация в разделе **состояние назначения**.

## <a name="enable-by-using-azure-policy"></a>Включение при помощи Политики Azure

Чтобы включить Azure Monitor для виртуальных машин с помощью Политики Azure в своем арендаторе, выполните следующие действия:

- Назначить инициативу области: группы управления, подписки или группы ресурсов.
- Просмотрите и исправлять результатов проверки на соответствие.

Дополнительные сведения о назначении Политики Azure см. в [обзоре Политики Azure](../../governance/policy/overview.md#policy-assignment). Кроме того, прежде чем продолжить, ознакомьтесь с [обзором групп управления](../../governance/management-groups/index.md).

### <a name="policies-for-azure-vms"></a>Политики для виртуальных машин Azure

Определения политик для виртуальной Машины Azure, перечислены в следующей таблице.

|ИМЯ |Описание |Type |
|-----|------------|-----|
|\[Предварительная версия.\] Включение Azure Monitor для виртуальных машин |Включите монитор Azure для виртуальных машин в указанной области (группы управления, подписки или группы ресурсов). В качестве параметра принимается рабочая область Log Analytics. |Инициатива |
|\[Предварительная версия.\] Аудит развертывания агента зависимостей — образ виртуальной Машины (ОС) удалена из списка |О виртуальных машин считается несоответствующим, если образ виртуальной Машины (ОС) не определено в списке и агент не установлен. |Политика |
|\[Предварительная версия.\] Аудит развертывания агента Log Analytics — образ виртуальной Машины (ОС) удалена из списка |О виртуальных машин считается несоответствующим, если образ виртуальной Машины (ОС) не определено в списке и агент не установлен. |Политика |
|\[Предварительная версия.\] Развернуть агент зависимостей для виртуальных машин Linux |Разверните агент зависимостей для виртуальных машин Linux, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |
|\[Предварительная версия.\] Развернуть агент зависимостей для виртуальных машин Windows |Разверните агент зависимостей для виртуальных машин Windows, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |
|\[Предварительная версия.\] Развернуть агент Log Analytics для виртуальных машин Linux |Разверните агент Log Analytics для виртуальных машин Linux, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |
|\[Предварительная версия.\] Развернуть агент Log Analytics для виртуальных машин Windows |Разверните агент Log Analytics для виртуальных машин Windows, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |

### <a name="policies-for-azure-virtual-machine-scale-sets"></a>Наборы масштабирования политик для виртуальных машин Azure

Определения политик для масштабируемого набора виртуальных машин Azure, перечислены в следующей таблице.

|ИМЯ |Описание |Тип |
|-----|------------|-----|
|\[Предварительная версия.\] Включение Azure Monitor для масштабируемых наборов виртуальных машин |Включение Azure Monitor для масштабируемых наборов виртуальных машин в указанной области (группы управления, подписки или группы ресурсов). В качестве параметра принимается рабочая область Log Analytics. Примечание. Если политика обновления набора масштабирования присвоено вручную, примените расширение для всех виртуальных машин в наборе, вызвав их обновление. В интерфейсе командной строки это az vmss update-instances. |Инициатива |
|\[Предварительная версия.\] Аудит развертывания агента зависимостей в масштабируемых наборах виртуальных машин — образ виртуальной Машины (ОС) удалена из списка |Сообщает масштабируемый набор считается несоответствующим, если агент не установлен образ виртуальной Машины (ОС) не определено в списке виртуальных машин. |Политика |
|\[Предварительная версия.\] Аудит развертывания агентов Log Analytics в масштабируемых наборах виртуальных машин — образ виртуальной Машины (ОС) удалена из списка |Сообщает масштабируемый набор считается несоответствующим, если агент не установлен образ виртуальной Машины (ОС) не определено в списке виртуальных машин. |Политика |
|\[Предварительная версия.\] Развернуть агент зависимостей для масштабируемых наборов виртуальных машин Linux |Разверните агент зависимостей для Linux, наборы масштабирования виртуальных машин, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |
|\[Предварительная версия.\] Развернуть агент зависимостей для масштабируемых наборов виртуальных машин Windows |Разверните агент зависимостей для Windows, наборы масштабирования виртуальных машин, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |
|\[Предварительная версия.\] Развертывание агента Log Analytics для масштабируемых наборов виртуальных машин Linux |Разверните агент Log Analytics для Linux, наборы масштабирования виртуальных машин, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |
|\[Предварительная версия.\] Развертывание агента Log Analytics для масштабируемых наборов виртуальных машин Windows |Разверните агент Log Analytics для Windows, наборы масштабирования виртуальных машин, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |

Автономная политика (не включена в инициативу) описана здесь:

|ИМЯ |Описание |Type |
|-----|------------|-----|
|\[Предварительная версия.\] Аудит рабочей области Log Analytics для виртуальной Машины — несоответствие отчета |Виртуальные машины отчетов считается несоответствующим, если они не являются вход в рабочую область Log Analytics, указанное в назначении политики или инициативы. |Политика |

### <a name="assign-the-azure-monitor-initiative"></a>Назначение инициативы Azure Monitor
Чтобы создать назначение политики из **Azure Monitor для покрытия политики виртуальных машин** странице, выполните следующие действия. Чтобы понять, как выполняются эти шаги, изучите статью  [Создание назначения политики для идентификации ресурсов, не соответствующих требованиям, в среде Azure](../../governance/policy/assign-policy-portal.md).

При назначении политики или инициативы, области, выбранным в назначения может быть в области, перечисленные здесь или его часть. Например вы могли создать назначение для подписки (область действия политики) и не данной группы управления (покрытия область). В этом случае процент покрытия означает виртуальных машин в уровне политики или инициативы области, деленное на виртуальных машинах в области действия покрытия. В другом случае может исключенные некоторые виртуальные машины или группы ресурсов или подписку из области действия политики. Если оно пустое, это означает, что политики или инициативы не существует или у вас нет разрешений. Информация в разделе **состояние назначения**.

1. Войдите на [портале Azure](https://portal.azure.com).

2. На портале Azure выберите **Монитор**. 

3. В разделе **Аналитика** выберите пункт **Виртуальные машины (ознакомительная версия)** .
 
4. Выберите **приступить к работе** вкладки. На странице выберите **управление покрытия политики**.

5. Выберите группу управления или подписки из таблицы. Выберите **область** нужно щелкнуть многоточие (...). В примере область ограничивает назначения политики для группирование виртуальных машин в случае принудительного применения.

6. На **назначение политики Azure** страницы, он предварительно заполненный инициативы **включить Azure Monitor для виртуальных машин**. 
    **Имя назначения** поле автоматически заполняется имя инициативы, но его можно изменить. Также можно добавить описание (необязательно). **Назначенный** поле автоматически заполняется зависимости от текущего пользователя. Это значение является необязательным.

7. Чтобы удалить один или несколько ресурсов из области, выберите **Исключения** (необязательно).

8. В раскрывающемся списке **Рабочая область Log Analytics** для поддерживаемого региона выберите рабочую область.

   > [!NOTE]
   > Если рабочая область находится за пределами области назначения, предоставьте разрешения *участника Log Analytics* для идентификатора участника назначения политики. Если этого не сделать, может появиться ошибка развертывания как `The client '343de0fe-e724-46b8-b1fb-97090f7054ed' with object id '343de0fe-e724-46b8-b1fb-97090f7054ed' does not have authorization to perform action 'microsoft.operationalinsights/workspaces/read' over scope ...` предоставить доступ, см. в статье [Ручная настройка управляемого удостоверения](../../governance/policy/how-to/remediate-resources.md#manually-configure-the-managed-identity).
   > 
   >  **Управляемое удостоверение** флажок установлен, так как назначение инициативы включает в себя политику с *deployIfNotExists* эффект.
    
9. В раскрывающемся списке **Manage Identity location** (Расположение для управления удостоверениями) выберите соответствующий регион.

10. Выберите **Назначить**.

После создания назначения, **Azure Monitor для покрытия политики виртуальных машин** обновлений страниц **покрытия назначения**, **состояние назначения**, **соответствует Виртуальные машины**, и **состояние соответствия** в соответствии с изменениями. 

Приведенной ниже таблице сопоставляет каждого состояния возможные соответствия инициативы.  

| Состояние соответствия | Описание | 
|------------------|-------------|
| **Соответствует** | Все виртуальные машины в области имеют агентов Log Analytics и зависимостей, развернутые на них.|
| **Не соответствует** | Не все виртуальные машины в области имеют Log Analytics и агенты зависимостей, развернутые на них и потребовать исправления.|
| **Не запущена** | Было добавлено новое назначение. |
| **Блокировки** | У вас нет необходимых прав для данной группы управления. <sup>1</sup> | 
| **Пустой** | Политика не назначается. | 

<sup>1</sup> Если у вас нет доступа к группе управления, обратитесь к владельцу, чтобы предоставить доступ. Просмотр соответствия или управлять назначением через дочерние группы управления или подписок. 

В следующей таблице сопоставлены состояние каждого возможное назначение инициативы.

| Состояние назначения | Описание | 
|------------------|-------------|
| **Success** | Все виртуальные машины в области имеют агентов Log Analytics и зависимостей, развернутые на них.|
| **Предупреждение;** | Подписка не в группе управления.|
| **Не запущена** | Было добавлено новое назначение. |
| **Блокировки** | У вас нет необходимых прав для данной группы управления. <sup>1</sup> | 
| **Пустой** | Виртуальные машины не существует, или ему не назначена политика. | 
| **Действие** | Назначение политики, или измените назначения. | 

<sup>1</sup> Если у вас нет доступа к группе управления, обратитесь к владельцу, чтобы предоставить доступ. Просмотр соответствия или управлять назначением через дочерние группы управления или подписок.

## <a name="review-and-remediate-the-compliance-results"></a>Просмотр результатов проверки на соответствие и внесение исправлений

Следующий пример приведен для виртуальной Машины Azure, но это также относится к масштабируемые наборы виртуальных машин. Чтобы узнать, как для просмотра результатов проверки на соответствие, см. в разделе [определить несоответствия результаты](../../governance/policy/assign-policy-portal.md#identify-non-compliant-resources). На **Azure Monitor для покрытия политики виртуальных машин** выберите группу управления или подписки из таблицы. Выберите **Просмотр соответствия** нужно щелкнуть многоточие (...).   

![Соответствие политикам для виртуальных машин Azure](./media/vminsights-enable-at-scale-policy/policy-view-compliance-01.png)

На основе результатов из политик, включенных инициативы, виртуальных машин они помечаются как несоответствующие в следующих сценариях:

* Агент log Analytics или агент зависимостей не был развернут.  
    Этот сценарий характерен для области с существующими виртуальными машинами. Чтобы устранить ее, развертывание требуемых агентов по [создания задачи по исправлению](../../governance/policy/how-to/remediate-resources.md) несоответствующих политике.  
    - \[Предварительная версия.\] Развернуть агент зависимостей для виртуальных машин Linux
    - \[Предварительная версия.\] Развернуть агент зависимостей для виртуальных машин Windows
    - \[Предварительная версия.\] Развернуть агент Log Analytics для виртуальных машин Linux
    - \[Предварительная версия.\] Развернуть агент Log Analytics для виртуальных машин Windows

* Образ виртуальной Машины (ОС) не определены в определении политики.  
    Условия политики развертывания включают в себя только виртуальные машины, развернутые на основе известных образов виртуальных машин Azure. Проверьте документацию, чтобы узнать, поддерживается ли ОС виртуальных машин. Если ОС не поддерживается, создайте копию политики развертывания и измените ее таким образом, чтобы образ соответствовал ее требованиям.  
    - \[Предварительная версия.\] Аудит развертывания агента зависимостей — образ виртуальной Машины (ОС) удалена из списка
    - \[Предварительная версия.\] Аудит развертывания агента Log Analytics — образ виртуальной Машины (ОС) удалена из списка

* Виртуальные машины не выполняют вход в указанную рабочую область Log Analytics.  
    Возможно, некоторые виртуальные машины в области инициативы выполняют вход в рабочую область Log Analytics, отличную от той, которая указана в назначении политики. Эта политика — это средство, чтобы определить, какие виртуальные машины отправляют отчеты несоответствующих рабочей области.  
    - \[Предварительная версия.\] Аудит рабочей области Log Analytics для виртуальной Машины — несоответствие отчета

## <a name="edit-an-initiative-assignment"></a>Изменить назначение инициативы

В любое время после назначения инициативы в группе управления или подписку, можно изменить его, чтобы изменять следующие свойства:

- Имя назначения
- Описание
- Назначенный
- Рабочая область Log Analytics
- Исключения

## <a name="next-steps"></a>Следующие шаги

Теперь, когда мониторинг включен для виртуальных машин, эти сведения можно получить для анализа с помощью Azure Monitor для виртуальных машин. 

- Чтобы узнать, как использовать функцию работоспособности, см. в разделе [представление Azure Monitor для виртуальных машин работоспособности](vminsights-health.md). 
- Для просмотра обнаруженных зависимостей приложений см. статью о [просмотре схемы Azure Monitor для виртуальных машин](vminsights-maps.md). 
- Чтобы определить узкие места и общее использование с производительностью виртуальной Машины, см. в разделе [производительности виртуальной Машины Azure представление](vminsights-performance.md). 
- Для просмотра обнаруженных зависимостей приложений см. статью о [просмотре схемы Azure Monitor для виртуальных машин](vminsights-maps.md).
