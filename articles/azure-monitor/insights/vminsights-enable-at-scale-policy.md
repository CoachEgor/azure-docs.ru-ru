---
title: Включение Azure Monitor для виртуальных машин с помощью "Политика Azure" | Документация Майкрософт
description: В этой статье описывается, как включить Azure Monitor для виртуальных машин для нескольких виртуальных машинах или масштабируемых наборов виртуальных машин с помощью политики Azure.
services: azure-monitor
documentationcenter: ''
author: mgoedtel
manager: carmonm
editor: ''
ms.assetid: ''
ms.service: azure-monitor
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/07/2019
ms.author: magoedte
ms.openlocfilehash: 9664ad5272ffeb55bd85e3d4c4f4b70d05e97702
ms.sourcegitcommit: bb85a238f7dbe1ef2b1acf1b6d368d2abdc89f10
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/10/2019
ms.locfileid: "65524150"
---
# <a name="enable-azure-monitor-for-vms-preview-using-azure-policy"></a>Включить монитор Azure для виртуальных машин (Предварительная версия) с помощью политики Azure

В этой статье объясняется, как включить Azure Monitor для виртуальных машин (Предварительная версия) для виртуальных машин Azure или масштабируемые наборы виртуальных машин с помощью политики Azure. В конце этого процесса будет успешно настроена, позволяя Log Analytics и агенты зависимостей и обнаружили виртуальные машины, которые не являются совместимыми.

Чтобы найти, управление и включить Azure Monitor для виртуальных машин для всех виртуальных машинах Azure или масштабируемые наборы виртуальных машин, можно использовать политики Azure или Azure PowerShell. "Политика Azure" является рекомендуемым методом, так как вы можете управлять определений политик, чтобы эффективно регулировать ваших подписок, чтобы обеспечить согласованное соответствие требованиям и автоматического включения вновь подготовки виртуальных машин. Эти определения политик:

* Развернуть агент Log Analytics и Dependency Agent.
* Создать отчет о результатах проверки на соответствие.
* Исправить несоответствующие виртуальные машины.

Если вы заинтересованы в относящееся к элементу управления с помощью шаблона Azure Resource Manager или Azure PowerShell, см. в разделе [включить с помощью шаблона Resource Manager или Azure PowerShell](vminsights-enable-at-scale-powershell.md). 

## <a name="manage-policy-coverage-feature-overview"></a>Общие сведения о функции покрытия политики управления

Изначально опыт работы с политиками Azure для управления и развертывания определения политик для Azure Monitor для виртуальных машин выполнялось исключительно на основе политики Azure. С помощью **управление покрытия политики** , он позволяет проще и легче находить, включить в нужном масштабе и управлять **включить Azure Monitor для виртуальных машин** инициативы, включая определения политик упоминалось ранее. Можно получить доступ к этой новой функции из **приступить к работе** вкладки в мониторе Azure для виртуальных машин, выбрав **управление покрытия политики**. Открывается страница покрытия политики виртуальных машин. 

![Azure Monitor вкладке "виртуальные машины приступить к работе"](./media/vminsights-enable-at-scale-policy/get-started-page-01.png)

Отсюда вы можно проверять и управлять покрытия инициативы нескольких групп управления и подписок, а также понять, сколько виртуальных машин существует в каждой из групп управления, подписок и их состояния соответствия.   

![Azure Monitor для страницы политики управления виртуальными машинами](./media/vminsights-enable-at-scale-policy/manage-policy-page-01.png)

Эта информация полезна для планирования и выполнения сценария управления для Azure Monitor для виртуальных машин из одного центрального расположения. "Политика Azure" обеспечивает представление соответствия, при назначении инициатива политики и области, с помощью этой новой странице можно определить, где инициатива политики или не назначена и назначьте его на месте. Все действия (назначение, просмотр, Правка) непосредственно перенаправить "Политика Azure". Azure Monitor для страницы покрытия политики виртуальных машин — это расширенная и интегрированная среда только инициативы **включить Azure Monitor для виртуальных машин**. 

На этой странице можно также настроить рабочую область Log Analytics для Azure Monitor для виртуальных машин, который выполняет следующие операции:

- Устанавливает решения Установка схемы услуги и Infrastructure Insights
- Включает счетчики производительности операционной системы, используемый диаграммы производительности, книг и ваш пользовательский журнал запросов и оповещений.

![Azure Monitor для виртуальных машин Настройка рабочей области](./media/vminsights-enable-at-scale-policy/manage-policy-page-02.png)

Этот параметр не связано с каких-либо действий политики и может предоставлять простой способ удовлетворения [предварительные требования](vminsights-enable-overview.md) необходимые для включения Azure Monitor для виртуальных машин.  

### <a name="what-information-is-available-on-this-page"></a>Какие сведения можно найти на этой странице?
В следующей таблице приведены разбивку составом выводимых сведений на странице покрытия политики и их интерпретации.

| Функция | Описание | 
|----------|-------------| 
| **Область** | Группы управления и подписок, у вас есть или унаследован доступ с возможностью выполнять детализацию Управление иерархией групп.|
| **Роль** | Роли в область, может быть чтения владельца или участника. В некоторых случаях может оказаться пустым, чтобы указать, что имеется доступ к подписке, но не в группу управления он принадлежит. Сведения из других столбцов будет зависеть от вашей роли, так как он является ключевым фактором при определении данных, можно увидеть и действия можно выполнять с точки зрения назначения инициативы/политики (owner), их изменения или просмотра соответствия. |
| **Общее число виртуальных машин** | Число виртуальных машин в пределах данной области. Для группы управления это сумма виртуальных машин, вложен в узел подписки и/или дочерней группы управления. |
| **Назначение покрытия** | Процент от виртуальных машин, которые покрываются инициативы/политики. |
| **Состояние назначения** | В этой статье вы найдете сведения о состоянии политики или инициативы назначения. |
| **Совместимые виртуальные машины** | Число виртуальных машин, инициатива или политики соответствия. Инициативы **включить Azure Monitor для виртуальных машин** это количество виртуальных машин, имеющих агент Log Analytics и агент зависимостей. В некоторых случаях может оказаться пустым из-за назначение не, и нет виртуальных машин либо недостаточно разрешений. Информация в разделе состояния соответствия. |
| **Соответствие требованиям** | Общее число соответствия является суммой различных ресурсов, которые используются совместимые разделить на сумму всех различных ресурсов. |
| **Состояние соответствия** | Сведения о состоянии соответствия для политики или инициативы назначения.|

При назначении политики или инициативы, области, выбранным в назначения может быть области в списке или его часть. Например созданные назначения для подписки (область действия политики), а не группой управления (покрытия область). В этом случае значение **покрытия назначения** укажет виртуальных машин в политики (или инициативы) область, деленное на виртуальных машин в области покрытия. В другом случае может исключенные некоторые виртуальные машины, группы ресурсов или подписку из области действия политики. Если значение пусто, оно указывает, что инициатива политики или не существует или у вас нет разрешений (информация приведена в состояние назначения).

## <a name="enable-using-azure-policy"></a>Включение при помощи Политики Azure

Чтобы включить Azure Monitor для виртуальных машин с помощью Политики Azure в своем арендаторе, выполните следующие действия:

- Назначьте инициативу области: группе управления, подписке или группе ресурсов.
- Просмотрите и исправьте результаты проверки на соответствие требованиям.

Дополнительные сведения о назначении Политики Azure см. в [обзоре Политики Azure](../../governance/policy/overview.md#policy-assignment). Кроме того, прежде чем продолжить, ознакомьтесь с [обзором групп управления](../../governance/management-groups/index.md).

### <a name="policies-for-azure-vms"></a>Политики для виртуальных машин Azure

Определения политик для виртуальной Машины Azure, перечислены в следующей таблице:

|ИМЯ |Описание |type |
|-----|------------|-----|
|[Предварительный просмотр] Включение Azure Monitor для виртуальных машин |Включение Azure Monitor для виртуальных машин в указанной области (группе управления, подписке или группе ресурсов). В качестве параметра принимается рабочая область Log Analytics. |Инициатива |
|[Предварительный просмотр] Проверка развертывания Dependency Agent — образ виртуальной машины (ОС) отсутствует в списке |Если образ виртуальной машины (ОС) не определен в заданном списке и агент не установлен, поступает сообщение о несоответствии виртуальной машины. |Политика |
|[Предварительный просмотр] Проверка развертывания агента Log Analytics — образ виртуальной машины (ОС) отсутствует в списке |Если образ виртуальной машины (ОС) не определен в заданном списке и агент не установлен, поступает сообщение о несоответствии виртуальной машины. |Политика |
|[Предварительный просмотр] Развертывание Dependency Agent для виртуальных машин Linux |Развертывание Dependency Agent для виртуальных машин Linux, если образ виртуальной машины (ОС) определен в заданном списке, а агент не установлен. |Политика |
|[Предварительный просмотр] Развертывание Dependency Agent для виртуальных машин Windows |Развертывание Dependency Agent для виртуальных машин Windows, если образ виртуальной машины (ОС) определен в заданном списке, а агент не установлен. |Политика |
|[Предварительный просмотр] Развертывание агента Log Analytics для виртуальных машин Linux |Развертывание агента Log Analytics для виртуальных машин Linux, если образ виртуальной машины (ОС) определен в заданном списке, а агент не установлен. |Политика |
|[Предварительный просмотр] Развертывание агента Log Analytics для виртуальных машин Windows |Развертывание агента Log Analytics для виртуальных машин Windows, если в списке определен образ виртуальной машины (OS), а агент не установлен. |Политика |

### <a name="policies-for-azure-virtual-machine-scale-sets"></a>Наборы масштабирования политик для виртуальных машин Azure

Определения политик для масштабируемого набора виртуальных машин Azure, перечислены в следующей таблице:

|ИМЯ |Описание |type |
|-----|------------|-----|
|[Предварительный просмотр] Включение Azure Monitor для масштабируемых наборов виртуальных Машин (VMSS) |Включение Azure Monitor для масштабируемых наборов виртуальных машин в указанной области (управления группы, подписки или группы ресурсов). В качестве параметра принимается рабочая область Log Analytics. Примечание: Если ваш upgradePolicy масштабируемого набора задано значение Manual, необходимо применить расширение для всех виртуальных машин в наборе, вызвав их обновление. В CLI это будет az vmss update-instances. |Инициатива |
|[Предварительный просмотр] Аудит развертывания агента зависимостей в масштабируемого набора виртуальных МАШИН — образ виртуальной Машины (ОС) удалена из списка |Отчеты масштабируемый набор виртуальных машин как несоответствующее, если образ виртуальной Машины (ОС) не определено в списке, а также агент не установлен. |Политика |
|[Предварительный просмотр] Развертывание агента аналитики журналов аудита в масштабируемого набора виртуальных МАШИН — образ виртуальной Машины (ОС) удалена из списка |Отчеты масштабируемый набор виртуальных машин как несоответствующее, если образ виртуальной Машины (ОС) не определено в списке, а также агент не установлен. |Политика |
|[Предварительный просмотр] Развернуть агент зависимостей для наборов масштабирования виртуальных Машин Linux (VMSS) |Разверните агент зависимостей для Linux, наборы масштабирования виртуальных машин, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |
|[Предварительный просмотр] Развернуть агент зависимостей для масштабируемых наборов виртуальных Машин Windows (VMSS) |Развертывание зависимостей агент для Windows наборы масштабирования виртуальных машин, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |
|[Предварительный просмотр] Развертывание агента Log Analytics для Масштабируемых наборов виртуальных машин Linux (VMSS) |Развертывание агента Log Analytics для Linux, наборы масштабирования виртуальных машин, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |
|[Предварительный просмотр] Развертывание агента Log Analytics для Масштабируемых наборов виртуальных машин Windows (VMSS) |Разверните Log Analytics агент для Windows наборы масштабирования виртуальных машин, если образ виртуальной Машины (ОС), определенных в списке, а агент не установлен. |Политика |

Автономная политика (не включена в инициативу) описана здесь:

|ИМЯ |Описание |type |
|-----|------------|-----|
|[Предварительный просмотр] Проверка рабочей области Log Analytics для виртуальной машины — сообщение о несоответствии |Если для виртуальных машин не ведется журнал в рабочей области Log Analytics, указанной в назначении политики или инициативы, поступает сообщение о несоответствии виртуальных машин. |Политика |

### <a name="assign-the-azure-monitor-initiative"></a>Назначение инициативы Azure Monitor
Чтобы создать назначение политики из Azure Monitor для страницы покрытия политики виртуальных машин, выполните следующие действия. Чтобы понять, как выполняются эти шаги, изучите статью  [Создание назначения политики для идентификации ресурсов, не соответствующих требованиям, в среде Azure](../../governance/policy/assign-policy-portal.md).

При назначении политики или инициативы, области, выбранным в назначения может быть в области, перечисленные здесь или его часть. Например созданные назначения для подписки (область действия политики) и не группы управления (покрытия область) в котором регистр покрытия % означает виртуальных машин в политики (или инициативы) область, деленное на виртуальных машин в области покрытия. В других случаях может исключенные некоторых виртуальных машин или групп ресурсов или подписки из области действия политики.  На случай, если оно пустое, это показывает, что политика / инициативы не существует или у вас нет разрешения (info в состояние назначения)  

1. Войдите на [портале Azure](https://portal.azure.com).

2. На портале Azure выберите **Монитор**. 

3. В разделе **Аналитика** выберите пункт **Виртуальные машины (ознакомительная версия)**.
 
4. Выберите **приступить к работе** , а на странице выберите **управление покрытия политики**.

5. Выберите подписку или группу управления из таблицы и выберите **область** , нажав кнопку с многоточием (...).      В нашем примере область действия ограничивает назначение политики группой виртуальных машин для принудительного применения.

6. На **назначение политики Azure** страницы, он предварительно заполняется инициативы **включить Azure Monitor для виртуальных машин**. 
    **Имя назначения** поле автоматически заполняется имя инициативы, но его можно изменить. При желании можно добавить необязательное описание. Поле **Кем назначено** заполняется автоматически в соответствии со сведениями о текущем пользователе. Это поле является необязательным.

7. Чтобы удалить один или несколько ресурсов из области, выберите **Исключения** (необязательно).

8. В раскрывающемся списке **Рабочая область Log Analytics** для поддерживаемого региона выберите рабочую область.

   > [!NOTE]
   > Если рабочая область находится за пределами области назначения, предоставьте разрешения *участника Log Analytics* для идентификатора участника назначения политики. Если этого не сделать, может появиться ошибка развертывания, например: `The client '343de0fe-e724-46b8-b1fb-97090f7054ed' with object id '343de0fe-e724-46b8-b1fb-97090f7054ed' does not have authorization to perform action 'microsoft.operationalinsights/workspaces/read' over scope ...` Чтобы предоставить доступ, просмотрите описание [настройки управляемого удостоверения вручную](../../governance/policy/how-to/remediate-resources.md#manually-configure-the-managed-identity).
   > 
   >  Флажок **Управляемое удостоверение** устанавливается, когда назначаемая инициатива содержит политику с эффектом *deployIfNotExists*.
    
9. В раскрывающемся списке **Manage Identity location** (Расположение для управления удостоверениями) выберите соответствующий регион.

10. Выберите **Назначить**.

После создания назначения, Azure Monitor для покрытия политики виртуальных машин страницы обновит покрытия назначения, состояние назначения, соответствия виртуальные машины и состояние соответствия для отражения изменений. 

Приведенной ниже таблице сопоставляет каждого состояния возможные соответствия инициативы.  

| Состояние соответствия | Описание | 
|------------------|-------------|
| **Соответствует** | Все виртуальные машины в области имеют агентов Log Analytics и зависимостей, развернутые на них.|
| **Не соответствует** | Не все виртуальные машины в области имеют Log Analytics и развернутые на них агенты зависимостей и может потребовать исправления.|
| **Не запущена** | Было добавлено новое назначение. |
| **Блокировки** | У вас нет необходимых прав для данной группы управления. <sup>1</sup> | 
| **Пустой** | Политика не назначена. | 

<sup>1</sup> Если у вас нет доступа к группе управления, обратитесь к владельцу, чтобы предоставить доступ или Просмотр соответствия назначений и управление ими через дочерние группы управления или подписок. 

В следующей таблице сопоставлены состояние каждого возможное назначение инициативы.

| Состояние назначения | Описание | 
|------------------|-------------|
| **Success** | Все виртуальные машины в области имеют агентов Log Analytics и зависимостей, развернутые на них.|
| **Предупреждение;** | Подписка не существует в группе управления.|
| **Не запущена** | Было добавлено новое назначение. |
| **Блокировки** | У вас нет необходимых прав для данной группы управления. <sup>1</sup> | 
| **Пустой** | Виртуальные машины не существует или не назначена политика. | 
| **Действие** | Назначение политики или изменить назначение | 

<sup>1</sup> Если у вас нет доступа к группе управления, обратитесь к владельцу, чтобы предоставить доступ или Просмотр соответствия назначений и управление ими через дочерние группы управления или подписок. 

## <a name="review-and-remediate-the-compliance-results"></a>Просмотр результатов проверки на соответствие и внесение исправлений

В следующем примере для виртуальной Машины Azure, но также применяется к масштабируемые наборы виртуальных машин. Чтобы узнать, как просмотреть результаты проверки на соответствие, прочитайте раздел [Выявление несоответствующих ресурсов](../../governance/policy/assign-policy-portal.md#identify-non-compliant-resources). На Azure Monitor для страницы покрытия политики виртуальных машин, выберите подписки или группы управления из таблицы, а затем выберите **Просмотр соответствия** , нажав кнопку с многоточием (...).   

![Соответствие политикам для виртуальных машин Azure](./media/vminsights-enable-at-scale-policy/policy-view-compliance-01.png)

На основе результатов политик в инициативе виртуальные машины указываются как несоответствующие в следующих сценариях:

* Агент Log Analytics или Dependency Agent не развернут.  
    Этот сценарий характерен для области с существующими виртуальными машинами. Чтобы устранить это несоответствие, разверните необходимые агенты. Для этого [создайте задачи по исправлению](../../governance/policy/how-to/remediate-resources.md) несоответствующей политики.  
    - [Предварительный просмотр]: Deploy Dependency Agent for Linux VMs
    - [Предварительный просмотр]: Deploy Dependency Agent for Windows VMs
    - [Предварительный просмотр]: Deploy Log Analytics Agent for Linux VMs
    - [Предварительный просмотр]: Deploy Log Analytics Agent for Windows VMs

* Образ виртуальной машины (ОС) не задан в определении политики.  
    Условия политики развертывания включают в себя только виртуальные машины, развернутые на основе известных образов виртуальных машин Azure. Проверьте документацию, чтобы узнать, поддерживается ли ОС виртуальных машин. Если ОС не поддерживается, создайте копию политики развертывания и измените ее таким образом, чтобы образ соответствовал ее требованиям.  
    - [Предварительный просмотр] Проверка развертывания Dependency Agent — образ виртуальной машины (ОС) отсутствует в списке
    - [Предварительный просмотр] Проверка развертывания агента Log Analytics — образ виртуальной машины (ОС) отсутствует в списке

* Виртуальные машины не выполняют вход в указанную рабочую область Log Analytics.  
    Возможно, некоторые виртуальные машины в области инициативы выполняют вход в рабочую область Log Analytics, отличную от той, которая указана в назначении политики. Данная политика — это инструмент, позволяющий определить, какие виртуальные машины отправляют отчеты в несоответствующую рабочую область.  
    - [Предварительный просмотр]: Audit Log Analytics Workspace for VM - Report Mismatch

## <a name="edit-initiative-assignment"></a>Изменить назначение инициативы

В любое время после назначения инициативы в группу управления или подписку его можно изменить, чтобы изменить следующие свойства:

- Название назначения
- Описание
- Кем назначено
- Рабочая область Log Analytics
- Исключения

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда мониторинг включен для виртуальных машин, эти сведения можно получить для анализа с помощью Azure Monitor для виртуальных машин. Чтобы узнать, как использовать функцию работоспособности, см. статью о [просмотре сведений о работоспособности Azure Monitor для виртуальных машин](vminsights-health.md). Для просмотра обнаруженных зависимостей приложений см. статью о [просмотре схемы Azure Monitor для виртуальных машин](vminsights-maps.md). Чтобы выявить узкие места производительности и общий уровень загрузки для виртуальных машин, изучите статью о [просмотре данных производительности виртуальной машины Azure](vminsights-performance.md). Просмотреть обнаруженные зависимости приложений поможет статья о [функции карты Azure Monitor для виртуальных машин](vminsights-maps.md).