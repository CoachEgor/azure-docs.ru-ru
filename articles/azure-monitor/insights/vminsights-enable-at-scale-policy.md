---
title: Включение Azure Monitor для виртуальных машин с помощью Политики Azure
description: В этой статье описывается, как вы используете Azure Monitor для виртуальных компьютеров для нескольких виртуальных машин Azure или виртуальных наборов масштабов машин с помощью azure Policy.
ms.subservice: ''
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 03/12/2020
ms.openlocfilehash: 73c18d45136eea90ad29dc1bd40c4539dddc0ee6
ms.sourcegitcommit: d57d2be09e67d7afed4b7565f9e3effdcc4a55bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2020
ms.locfileid: "81767257"
---
# <a name="enable-azure-monitor-for-vms-by-using-azure-policy"></a>Включение Azure Monitor для виртуальных машин с помощью Политики Azure

В этой статье объясняется, как включить Azure Monitor для виртуальных компьютеров Azure или виртуальных наборов масштабов машин с помощью azure Policy. В конце этого процесса вы успешно настроите, что позволит агентам log Analytics и зависимостей, а также идентифицируйте виртуальные машины, которые не соответствуют требованиям.

Для обнаружения, управления и включения Azure Monitor для виртуальных компьютеров для всех виртуальных машин Azure или виртуальных наборов масштабов машин можно использовать либо политику Azure, либо Azure PowerShell. Политика Azure — это метод, который мы рекомендуем, потому что вы можете управлять определениями политики, чтобы эффективно управлять подписками, чтобы обеспечить постоянное соответствие и автоматическое включение новых вобысленных VM. Эти определения политики:

* Развернуть агент Log Analytics и Dependency Agent.
* Создать отчет о результатах проверки на соответствие.
* Исправление для несовместимых VMs.

Если вы заинтересованы в выполнении этих задач с помощью шаблона [Enable Azure Monitor for VMs using Azure PowerShell or Azure Resource Manager templates](vminsights-enable-at-scale-powershell.md)Azure PowerShell или шаблона менеджера ресурсов Azure, см.

## <a name="prerequisites"></a>Предварительные требования
Прежде чем использовать политику для борта вс-чатов Azure и виртуальных наборов масштабов машин для мониторинга Azure для виртуальных выв., необходимо включить решение VMInsights в рабочей области, которую вы будете использовать для хранения данных мониторинга. Эта задача может быть выполнена со страницы **Get Started** в azure Monitor на вкладке **«Другие варианты набегов».**  Выберите **накончись рабочее пространство,** которое подскажет вам выбрать рабочее пространство для настройки.

![Настройка рабочей области](media/vminsights-enable-at-scale-policy/configure-workspace.png)

Вы также можете настроить рабочее пространство, выбрав **Enable с помощью политики,** а затем выберите кнопку панели инструментов **Настройки.**  Это позволит установить решение VMInsights на выбранном рабочем пространстве, которое позволит рабочей области хранить данные мониторинга, отправленные виртуальными машинами, и виртуальные наборы масштабов машин, которые вы позволяете использовать Policy. 

![Включить политику использования](media/vminsights-enable-at-scale-policy/enable-using-policy.png)

## <a name="manage-policy-coverage-feature-overview"></a>Обзор функции «Управление политикой»

Azure Monitor для покрытия политики Для вс-м упрощает обнаружение, управление и включение в масштаб **инициативу Enable Azure Monitor для VMs,** которая включает определения политики, упомянутые ранее. Чтобы получить доступ к этой функции, выберите **другие варианты нагорной посадки** из вкладки **Get Started** в Azure Monitor для vMs. Выберите **покрытие политики управления,** чтобы открыть страницу **Azure Monitor для страницы по вопросам политики ВМ.**

![Azure Monitor с вкладки VMs Get Started](./media/vminsights-enable-at-scale-policy/get-started-page.png)

Здесь вы можете проверить и управлять охватом инициативы в группах управления и подписках. Вы можете понять, сколько ВМ существует в каждой из групп управления и подписки и их статус соответствия.

![Azure Monitor для страницы управления политиками с вымами](media/vminsights-enable-at-scale-policy/manage-policy-page-01.png)

Эта информация полезна для планирования и выполнения сценария управления для Azure Monitor для vMs из одного центрального местоположения. В то время как Azure Policy предоставляет представление о соответствии при присвоении области политики или инициативы, с помощью этой новой страницы можно узнать, где не назначена политика или инициатива, и назначить ее на место. Все действия, такие как присваивать, просматривать и ототраживать напрямую в Azure Policy. Страница **Azure Monitor для покрытия политики Для ВМ** — это расширенный и интегрированный опыт только для **инициативы Enable Azure Monitor для VMs.**

На этой странице можно также настроить рабочее пространство log Analytics для Azure Monitor для вс-джеев, которые:

- Устанавливает решение карты обслуживания.
- Позволяет использовать счетчики производительности операционной системы, используемые диаграммами производительности, трудовыми книжками и пользовательскими запросами и оповещениями.

![Azure Monitor для VMs настраивает рабочее пространство](media/vminsights-enable-at-scale-policy/manage-policy-page-02.png)

Этот параметр не связан с какими-либо действиями политики. Он доступен, чтобы обеспечить простой способ для удовлетворения [предпосылок, необходимых](vminsights-enable-overview.md) для включения Azure Monitor для ВМ.  

### <a name="what-information-is-available-on-this-page"></a>Какая информация доступна на этой странице?

В следующей таблице приводится разбивка информации, представленной на странице покрытия политики, и способов ее интерпретации.

| Компонент | Описание | 
|----------|-------------| 
| **Область действия** | Группа управления и подписки, к которым вы имеете или унаследовали доступ, с возможностью сверления через иерархию группы управления.|
| **Role** | Ваша роль в области, которая может быть читателя, владельца или вкладчика. В некоторых случаях может показаться пустым указать, что у вас может быть доступ к подписке, но не к группе управления, к которой она принадлежит. Информация в других столбцах варьируется в зависимости от вашей роли. Роль имеет ключевое значение для определения того, какие данные вы можете видеть и действия, которые вы можете выполнять с точки зрения назначения политик или инициатив (владелец), редактирования их или просмотра соответствия. |
| **Всего VMs** | Количество вм в рамках этой области. Для группы управления это сумма вс-миноносцев, вложенных под подписку или группу управления детьми. |
| **Покрытие назначения** | Процент вм, охватываемых политикой или инициативой. |
| **Статус назначения** | Информация о состоянии вашей политики или назначения инициативы. |
| **Совместимые VM** | Количество вм, соответствующих политике или инициативе. Для **инициативы Включить Azure monitor для VMs**, это число VMs, которые имеют как агент аналитики журнала и агента зависимости. В некоторых случаях он может показаться пустым из-за отсутствия назначения, без вхдилия или недостаточного количества разрешений. Информация предоставляется в соответствии с **государством соответствия**. |
| **Соответствие нормативным требованиям** | Общее число требований представляет собой сумму различных ресурсов, которые соответствуют сумме всех различных ресурсов. |
| **Состояние соответствия** | Информация о состоянии соответствия требованиям для вашего назначения политики или инициативы.|

При назначении политики или инициативы область, выбранная в назначении, может быть областью, указанной в списке, или ее подмножеством. Например, возможно, было создано назначение для подписки (область политики), а не группы управления (область покрытия). В этом случае значение **покрытия назначения** указывает на вм в области политики или инициативы, разделенные на ВМ в области охвата. В другом случае можно исключить некоторые вс-ми, группы ресурсов или подписку из сферы политики. Если значение пусто, это означает, что политика или инициатива не существует или у вас нет разрешения. Информация предоставляется в соответствии **со статусом назначения**.

## <a name="enable-by-using-azure-policy"></a>Включение при помощи Политики Azure

Чтобы включить Azure Monitor для виртуальных машин с помощью Политики Azure в своем арендаторе, выполните следующие действия:

- Назначаем инициативу области: группе управления, подписке или группе ресурсов.
- Обзор и исправление результатов соответствия.

Дополнительные сведения о назначении Политики Azure см. в [обзоре Политики Azure](../../governance/policy/overview.md#assignments). Кроме того, прежде чем продолжить, ознакомьтесь с [обзором групп управления](../../governance/management-groups/overview.md).

### <a name="policies-for-azure-vms"></a>Политики для M-м ми-ми Azure

Определения политики для Azure VM перечислены в следующей таблице.

|Имя |Описание |Тип |
|-----|------------|-----|
|Включение Azure Monitor для виртуальных машин |Включите Azure Monitor для виртуальных машин в указанной области (группа управления, подписка или группа ресурсов). В качестве параметра принимается рабочая область Log Analytics. |Инициатива |
|Развертывание агента зависимости аудита - Изображение VM (OS) не включено в список |Отчеты о вдву т.д. как несовместимые, если изображение VM (OS) не определено в списке и агент не установлен. |Политика |
|Развертывание агента аналитики аудита журнала - Изображение VM (OS) не включено в список |Отчеты о вдву т.д. как несовместимые, если изображение VM (OS) не определено в списке и агент не установлен. |Политика |
|Развертывание Dependency Agent для виртуальных машин Linux |Развертывание агента зависимости для Linux VMs, если изображение VM (OS) определено в списке и агент не установлен. |Политика |
|Развертывание Dependency Agent для виртуальных машин Windows |Развертывание агента зависимости для Windows VMs, если изображение VM (OS) определено в списке и агент не установлен. |Политика |
|Развертывание агента Log Analytics для виртуальных машин Linux |Развертывание агента анализа журнала для Linux VMs, если изображение VM (OS) определено в списке и агент не установлен. |Политика |
|Развертывание агента Log Analytics для виртуальных машин Windows |Развертывание агента анализа журналов для Windows VMs, если изображение VM (OS) определено в списке и агент не установлен. |Политика |

### <a name="policies-for-azure-virtual-machine-scale-sets"></a>Политики для наборов виртуальных машин Azure

Определения политики для набора виртуальной машины Azure перечислены в следующей таблице.

|Имя |Описание |Тип |
|-----|------------|-----|
|Включить Azure Monitor для виртуальных наборов масштабов машин |Включить Azure Monitor для виртуальных наборов масштабов машин в указанной области (группа управления, подписка или группа ресурсов). В качестве параметра принимается рабочая область Log Analytics. Примечание: Если политика обновления набора масштабов настроена на руководство, примените расширение ко всем вс-кавам в наборе, вызывая обновление на них. В CLI, это `az vmss update-instances`. |Инициатива |
|Развертывание агента зависимости аудита в виртуальных наборах масштабов машин - VM-изображение (ОС) не включено в список |Отчеты виртуального масштаба машины, установленного как несовместимые, если изображение VM (OS) не определено в списке и агент не установлен. |Политика |
|Развертывание агента анализа log Analytics в виртуальных наборах масштабов машин - VM-изображение (ОС) не включено в список |Отчеты виртуального масштаба машины, установленного как несовместимые, если изображение VM (OS) не определено в списке и агент не установлен. |Политика |
|Развертывание Dependency Agent для масштабируемых наборов виртуальных машин Linux |Развертывание агента зависимости для набора виртуальной машины Linux, если изображение VM (OS) определено в списке и агент не установлен. |Политика |
|Развертывание Dependency Agent для масштабируемых наборов виртуальных машин Windows |Развертывание агента зависимости для наборов виртуальной шкалы машин Windows, если изображение VM (OS) определено в списке и агент не установлен. |Политика |
|Развертывание агента Log Analytics для масштабируемых наборов виртуальных машин Linux |Развертывание агента анализа журнала для Linux виртуальных наборов машин, если VM Image (OS) определяется в списке и агент не установлен. |Политика |
|Развертывание агента Log Analytics для масштабируемых наборов виртуальных машин Windows |Развертывание агента анализа журнала для наборов виртуальной машины Windows, если изображение VM (OS) определено в списке и агент не установлен. |Политика |

Автономная политика (не включена в инициативу) описана здесь:

|Имя |Описание |Тип |
|-----|------------|-----|
|Аудит журнал Аналитика рабочее пространство для VM - Отчет несоответствие |Сообщить о вдовых в качестве несовместимых, если они не заходят в рабочее пространство Log Analytics, указанное в назначении политики или инициативы. |Политика |

### <a name="assign-the-azure-monitor-initiative"></a>Назначение инициативы Azure Monitor

Чтобы создать назначение политики со страницы **Azure Monitor для покрытия политики для вс-ми,** выполните следующие действия. Чтобы понять, как выполняются эти шаги, изучите статью  [Создание назначения политики для идентификации ресурсов, не соответствующих требованиям, в среде Azure](../../governance/policy/assign-policy-portal.md).

При назначении политики или инициативы область, выбранная в назначении, может быть областью, указанной здесь, или ее подмножеством. Например, возможно, было создано назначение для подписки (область политики), а не для группы управления (область покрытия). В этом случае процент охвата будет указывать на ВМ в области политики или инициативы, разделенных на ВМ в области охвата. В другом случае можно исключить из сферы политики некоторые вс-ми-м, группы ресурсов или подписку. Если она пуста, это означает, что политика или инициатива не существует или у вас нет разрешений. Информация предоставляется в соответствии **со статусом назначения**.

1. Войдите на [портал Azure](https://portal.azure.com).

2. На портале Azure выберите **Monitor**. 

3. Выберите **виртуальные машины** в разделе **Исследования.**
 
4. Выберите вкладку **Get Started.** На странице выберите **Покрытие политики управления.**

5. Выберите из таблицы группу управления или подписку. Выберите **область действия,** выбрав эллипсис (...). В этом примере область ограничивает назначение политики группировкой виртуальных машин для обеспечения соблюдения.

6. На странице **назначения политики Azure** она предварительно заселена инициативой **Включить azure Monitor для vMs.** 
    Поле **имени назначения** автоматически заполняется именем инициативы, но его можно изменить. Вы также можете добавить дополнительное описание. **Присвоенный** по коробке автоматически заполняется в зависимости от того, кто входит в систему. Это значение является необязательным.

7. Чтобы удалить один или несколько ресурсов из области, выберите **Исключения** (необязательно).

8. В раскрывающемся списке **Рабочая область Log Analytics** для поддерживаемого региона выберите рабочую область.

   > [!NOTE]
   > Если рабочая область находится за пределами области назначения, предоставьте разрешения *участника Log Analytics* для идентификатора участника назначения политики. Если вы этого не сделаете, вы можете `The client '343de0fe-e724-46b8-b1fb-97090f7054ed' with object id '343de0fe-e724-46b8-b1fb-97090f7054ed' does not have authorization to perform action 'microsoft.operationalinsights/workspaces/read' over scope ...` увидеть сбой развертывания, например предоставить доступ, просмотрите, [как вручную настроить управляемое удостоверение.](../../governance/policy/how-to/remediate-resources.md#manually-configure-the-managed-identity)
   > 
   >  Выбирается флажок **управляемой идентификации,** поскольку назначенная инициатива включает в себя политику с эффектом *deployIfNotExists.*
    
9. В раскрывающемся списке **Manage Identity location** (Расположение для управления удостоверениями) выберите соответствующий регион.

10. Выберите **Назначить**.

После создания назначения страница Azure Monitor для покрытия **политики Для вс-м** обновлений обновляет **покрытие назначения,** **статус назначения,** соответствующие **вм**пределотему и **состояние соответствия** изменениям. 

Следующие матричные карты каждого возможного состояния соответствия для инициативы.  

| Состояние соответствия | Описание | 
|------------------|-------------|
| **Совместимый** | Все ВМ в области имеют журнал аналитики и зависимости агентов развернуты для них.|
| **Не соответствует требованиям** | Не все ВМ в области имеют журнал analytics и зависимости агентов развернуты для них и может потребовать исправления.|
| **Не запущен** | Добавлено новое назначение. |
| **Блокировки** | У вас нет достаточных привилегий для группы управления. <sup>1</sup> | 
| **Пустой** | Политика не назначается. | 

<sup>1</sup> Если у вас нет доступа к группе управления, попросите владельца предоставить доступ. Или просмотрите соответствие требованиям и управление уступками через группы управления детьми или подписки. 

В следующей таблице отображается каждый возможный статус назначения для инициативы.

| Статус назначения | Описание | 
|------------------|-------------|
| **Success** | Все ВМ в области имеют журнал аналитики и зависимости агентов развернуты для них.|
| **Предупреждение** | Подписка не входят в группу управления.|
| **Не запущен** | Добавлено новое назначение. |
| **Блокировки** | У вас нет достаточных привилегий для группы управления. <sup>1</sup> | 
| **Пустой** | Нет VMs существует или политика не назначена. | 
| **Действие** | Назначай политику или отсваивай задание. | 

<sup>1</sup> Если у вас нет доступа к группе управления, попросите владельца предоставить доступ. Или просмотрите соответствие требованиям и управление уступками через группы управления детьми или подписки.

## <a name="review-and-remediate-the-compliance-results"></a>Просмотр результатов проверки на соответствие и внесение исправлений

Следующим примером является Azure VM, но он также применим к виртуальным наборам масштабов машин. Чтобы узнать, как просмотреть результаты соблюдения, [см.](../../governance/policy/assign-policy-portal.md#identify-non-compliant-resources) На странице Azure Monitor для покрытия **политики Для вс-м** выберите из таблицы группу управления или подписку. Выберите **соответствие просмотру,** выбрав эллипсис (...).   

![Соответствие политикам для виртуальных машин Azure](./media/vminsights-enable-at-scale-policy/policy-view-compliance.png)

На основе результатов политики, включенной в инициативу, в соответствии с инициативой, в соответствии с инициативой, в соответствии с этой инициативой, в следующих сценариях сообщается, что в несовместимых с проектами:

* Агент аналитики журнала или агент зависимости не развернут.  
    Этот сценарий характерен для области с существующими виртуальными машинами. Чтобы смягчить его, разместите требуемые агенты, [создав задачи исправления](../../governance/policy/how-to/remediate-resources.md) в несовместимой политике.  
    - Развертывание Dependency Agent для виртуальных машин Linux
    - Развертывание Dependency Agent для виртуальных машин Windows
    - Развертывание агента Log Analytics для виртуальных машин Linux
    - Развертывание агента Log Analytics для виртуальных машин Windows

* Изображение VM (OS) не определено в определении политики.  
    Условия политики развертывания включают в себя только виртуальные машины, развернутые на основе известных образов виртуальных машин Azure. Проверьте документацию, чтобы узнать, поддерживается ли ОС виртуальных машин. Если ОС не поддерживается, создайте копию политики развертывания и измените ее таким образом, чтобы образ соответствовал ее требованиям.  
    - Развертывание агента зависимости аудита - Изображение VM (OS) не включено в список
    - Развертывание агента аналитики аудита журнала - Изображение VM (OS) не включено в список

* Виртуальные машины не выполняют вход в указанную рабочую область Log Analytics.  
    Возможно, некоторые виртуальные машины в области инициативы выполняют вход в рабочую область Log Analytics, отличную от той, которая указана в назначении политики. Эта политика является инструментом для определения того, какие вс-м вс-м внебюджетных данных отчитываются перед несовместимым рабочим пространством.  
    - Аудит журнал Аналитика рабочее пространство для VM - Отчет несоответствие

## <a name="edit-an-initiative-assignment"></a>Отсечение инициативного задания

В любое время после того, как вы назначаете инициативу группе управления или подписке, вы можете отсваивать ее, чтобы изменить следующие свойства:

- Имя назначения
- Описание
- Назначено
- Рабочая область Log Analytics
- Исключения

## <a name="next-steps"></a>Следующие шаги

Теперь, когда мониторинг включен для ваших виртуальных машин, эта информация доступна для анализа с Azure Monitor для виртуальных технологий. 

- Для просмотра обнаруженных зависимостей приложений см. статью о [просмотре схемы Azure Monitor для виртуальных машин](vminsights-maps.md). 

- Чтобы определить узкие места и общее использование с производительностью VM, [см.](vminsights-performance.md) 
