---
title: Конечные точки служб для виртуальной сети Azure
titlesuffix: Azure Virtual Network
description: Узнайте, как включить прямой доступ к ресурсам Azure из виртуальной сети с помощью конечных точек служб.
services: virtual-network
documentationcenter: na
author: sumeetmittal
ms.service: virtual-network
ms.devlang: NA
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/08/2019
ms.author: sumi
ms.custom: ''
ms.openlocfilehash: b75e0c1e53f1e00579de73897197cdd2f14d79af
ms.sourcegitcommit: b55d7c87dc645d8e5eb1e8f05f5afa38d7574846
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81455416"
---
# <a name="virtual-network-service-endpoints"></a>Конечные точки служб для виртуальной сети

Конечные точки службы Virtual Network (VNet) расширяют пространство виртуальной сети для личного адреса. Конечные точки также расширяют идентификацию вашего VNet на службы Azure посредством прямого соединения. Конечные точки позволяют защищать критически важные ресурсы служб Azure в пределах отдельных виртуальных сетей. Трафик, поступающий из виртуальной сети в службу Azure, всегда остается в магистральной сети Microsoft Azure.

Эта функция доступна для следующих служб Azure и регионов. Ресурс *Microsoft.\* * находится в скобках. Включить этот ресурс со стороны подсети при настройке конечных точек службы для службы:

**Общедоступная версия**

- **[Хранение Azure](../storage/common/storage-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network)** *(Microsoft.Storage):* Как правило, доступны во всех регионах Azure.
- **[База данных Azure S'L](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** *(Microsoft.Sql):* Как правило, доступна во всех регионах Azure.
- **[Хранилище данных Azure S'L](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** *(Microsoft.Sql):* Как правило, доступны во всех регионах Azure.
- **[База данных Azure для сервера PostgreS-L](../postgresql/howto-manage-vnet-using-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** *(Microsoft.Sql):* Как правило, доступна в регионах Azure, где доступна служба баз данных.
- **[База данных Azure для сервера MyS'L](../mysql/howto-manage-vnet-using-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** *(Microsoft.Sql):* Как правило, доступна в регионах Azure, где доступна служба баз данных.
- **[База данных Azure для MariaDB](https://docs.microsoft.com/azure/mariadb/concepts-data-access-security-vnet)** *(Microsoft.Sql):* Как правило, доступна в регионах Azure, где доступна служба баз данных.
- **[Azure Cosmos DB](../cosmos-db/vnet-service-endpoint.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** *(Microsoft.AzureCosmosDB):* Как правило, доступны во всех регионах Azure.
- **[Убежище ключей Azure](../key-vault/general/overview-vnet-service-endpoints.md)** (*Microsoft.KeyVault):* Как правило, доступны во всех регионах Azure.
- **[Автобус службы Azure](../service-bus-messaging/service-bus-service-endpoints.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (*Microsoft.ServiceBus):* Как правило, доступен во всех регионах Azure.
- **[Концентраторы событий Azure](../event-hubs/event-hubs-service-endpoints.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (*Microsoft.EventHub):* Обычно доступны во всех регионах Azure.
- **[Azure Data Lake Store Gen 1](../data-lake-store/data-lake-store-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** *(Microsoft.AzureActiveDirectory):* Как правило, доступен во всех регионах Azure, где доступен ADLS Gen1.
- **[Служба приложений Azure:](https://docs.microsoft.com/azure/app-service/app-service-ip-restrictions)** как правило, доступна во всех регионах Azure, где доступна служба приложений.

**Общедоступная предварительная версия**

- **[Реестр контейнеров Azure](../container-registry/container-registry-vnet.md)** (*Microsoft.ContainerRegistry*): Предварительный просмотр доступен во всех регионах Azure, где доступен реестр контейнеров Azure.

Для получения самых современных уведомлений проверьте страницу [обновлений виртуальной сети Azure.](https://azure.microsoft.com/updates/?product=virtual-network)

## <a name="key-benefits"></a>Основные преимущества

Конечные точки служб обеспечивают следующие преимущества.

- **Улучшенная безопасность ресурсов службы Azure:** частные адресные пространства VNet могут перекрываться. Вы не можете использовать перекрывающиеся пространства для однозначного определения трафика, который исходит от вашего VNet. Конечные точки обслуживания обеспечивают возможность защиты ресурсов службы Azure в виртуальной сети, расширяя идентификацию VNet в службе. После включения конечных точек обслуживания в виртуальной сети можно добавить виртуальное сетевое правило для обеспечения безопасности ресурсов службы Azure в виртуальной сети. Добавление правил обеспечивает повышенную безопасность, полностью удаляя доступ к ресурсам в открытом интернете и разрешая трафик только из вашей виртуальной сети.
- **Оптимальная маршрутизирующая маршрутизм для сервисного трафика Azure из виртуальной сети:** Сегодня любые маршруты в виртуальной сети, которые заставляют интернет-трафик к вашим натерритории и/или виртуальным приборам, также вынуждают сервисный трафик Azure идти по тому же маршруту, что и интернет-трафик. Конечные точки служб обеспечивают оптимальную маршрутизацию трафика Azure. 

  Конечные точки всегда направляют трафик служб непосредственно из виртуальной сети в службу в магистральной сети Microsoft Azure. Так как трафик не покидает пределы магистральной сети, это позволяет и дальше выполнять аудит и мониторинг исходящего интернет-трафика из виртуальных сетей при помощи принудительного туннелирования без воздействия на трафик служб. Для получения дополнительной информации о маршрутах, определяемых пользователями, и принудительном туннеле [см.](virtual-networks-udr-overview.md)
- **Простота настройки и управления.** Больше не нужны зарезервированные общедоступные IP-адреса в виртуальных сетях для защиты ресурсов Azure с помощью брандмауэра IP-адресов. Для настройки конечных точек службы не требуется сетевого адреса или шлюза. Вы можете настроить конечные точки службы простым нажатием кнопки на поднет. Нет никаких дополнительных накладных расходов на поддержание конечных точек.

## <a name="limitations"></a>Ограничения

- Функция доступна только для виртуальных сетей, развернутых посредством модели развертывания с помощью Azure Resource Manager.
- Конечные точки включаются в подсетях, которые настроены в виртуальных сетях Azure. Конечные точки не могут использоваться для трафика из ваших помещений в службы Azure. Для получения дополнительной информации смотрите [доступ к службе Secure Azure из предварительных](#secure-azure-services-to-virtual-networks)
- В SQL Azure конечная точка службы применяется только к трафику службы Azure в пределах региона виртуальной сети. Для хранения Azure конечные точки также распространяются на парные области, в которых развертывается виртуальная сеть для поддержки гео-избыточного хранения (RA-GRS) и гео-избыточного трафика хранения (GRS). Дополнительные сведения см. в статье [Непрерывность бизнес-процессов и аварийное восстановление в службах BizTalk: пары регионов Azure](../best-practices-availability-paired-regions.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-paired-regions).
- Для хранения озер данных Azure (ADLS) Gen 1 возможность интеграции VNet доступна только для виртуальных сетей в одном регионе. Также обратите внимание, что виртуальная сетевая интеграция для ADLS Gen1 использует безопасность конечных точек виртуального сетевого обслуживания между виртуальной сетью и Active Directory Azure (Azure AD) для генерации дополнительных требований безопасности в токене доступа. Эти утверждения используются для проверки подлинности виртуальной сети в учетной записи ADLS 1-го поколения и для предоставления доступа. Тег *Microsoft.AzureActiveDirectory,* указанный в конечных точках службподдержки, используется только для поддержки конечных точек службы aDLS Gen 1. Azure AD не поддерживает конечные точки службы. Для получения дополнительной информации об интеграции Azure [Network security in Azure Data Lake Storage Gen1](../data-lake-store/data-lake-store-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json)Data Lake Store Gen 1 VNet см.

## <a name="secure-azure-services-to-virtual-networks"></a>Безопасные службы Azure для виртуальных сетей

- Конечная точка службы для виртуальной сети предоставляет службе Azure удостоверение виртуальной сети. После включения конечных точек обслуживания в виртуальной сети можно добавить виртуальное сетевое правило для обеспечения безопасности ресурсов службы Azure в виртуальной сети.
- В настоящее время трафик служб Azure из виртуальной сети использует общедоступные IP-адреса в качестве исходных IP-адресов. При помощи конечных точек служб трафик в качестве исходных IP-адресов использует частные адреса виртуальной сети при обращении к службе Azure из виртуальной сети. Это переключение позволяет осуществлять доступ к службам без необходимости в зарезервированных общедоступных IP-адресах, которые используются в брандмауэрах.

   >[!NOTE]
   > При использовании конечных точек службы исходные IP-адреса виртуальных машин в подсети для трафика служб переключаются с общедоступных адресов IPv4 на частные. Существующие правила брандмауэра службы Azure, использующие общедоступные IP-адреса Azure, перестанут работать после этого переключения. Перед настройкой конечных точек службы убедитесь, что правила брандмауэра службы Azure поддерживают переключение. При настройке конечных точек службы также может наблюдаться временное прерывание трафика служб из этой подсети. 
 
## <a name="secure-azure-service-access-from-on-premises"></a>Безопасный доступ к службам Azure из предварительных помещений

  По умолчанию ресурсы службы Azure, защищенные для виртуальных сетей, недоступны из предварительных сетей. Чтобы разрешить трафик из локальной среды, необходимо также разрешить общедоступные IP-адреса (обычно это NAT) из локальных каналов или каналов ExpressRoute. Эти IP-адреса можно добавить через конфигурацию БРАНДмауэра IP для ресурсов службы Azure.

  Express Route: Если вы используете [ExpressRoute](../expressroute/expressroute-introduction.md?toc=%2fazure%2fvirtual-network%2ftoc.json) для публичного пиринга или microsoft peering из вашего помещения, вам нужно определить IP-адреса NAT, которые вы используете. Для публичного пиринга каждая схема ExpressRoute использует два IP-адреса NAT, по умолчанию применяемые к трафику службы Azure при входе в магистрательную сеть Microsoft Azure. Для пиринга корпорации Майкрософт IP-адреса NAT являются либо клиентами, предоставляемыми или предоставляемыми поставщиком услуг.Чтобы разрешить доступ к ресурсам служб, необходимо разрешить эти общедоступные IP-адреса в настройках брандмауэра IP-адресов ресурсов.Чтобы найти IP-адреса канала ExpressRoute для общедоступного пиринга, [отправьте запрос по ExpressRoute в службу поддержки](https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview) через портал Azure. Для получения дополнительной информации о NAT для expressRoute общественности и Microsoft пиринг, см [ExpressRoute NAT требования](../expressroute/expressroute-nat.md?toc=%2fazure%2fvirtual-network%2ftoc.json#nat-requirements-for-azure-public-peering).

![Защита служб Azure в виртуальных сетях](./media/virtual-network-service-endpoints-overview/VNet_Service_Endpoints_Overview.png)

### <a name="configuration"></a>Конфигурация

- Настройка конечных точек службы в подсети в виртуальной сети. Конечные точки работают с любым типом вычислительных экземпляров, выполняющихся в этой подсети.
- Можно настроить несколько конечных точек службы для всех поддерживаемых служб Azure (например, база данных Azure Storage или Azure S'L Database).
- Для Базы данных SQL Azure виртуальные сети должны относиться к тому же региону, что и ресурс службы Azure. При использовании учетных записей хранения Azure GRS и RA-GRS основная учетная запись должна принадлежать тому же региону, что и виртуальная сеть. Для всех других служб можно обеспечить безопасность ресурсов службы Azure для виртуальных сетей в любом регионе. 
- Виртуальная сеть, в которой настраивается конечная точка, может относиться к той же подписке, что и ресурс службы Azure, либо же к другой подписке. Дополнительные сведения о разрешениях, которые требуются для настройки конечных точек и защиты служб Azure, см. в разделе [Подготовка](#provisioning).
- Вы можете защитить новые или существующие ресурсы в виртуальных сетях с помощью конечных точек служб для поддерживаемых служб.

### <a name="considerations"></a>Особенности

- После включения конечной точки службы, исходные IP-адреса виртуальных машин в коммутаторе подсети. Исходные IP-адреса переключаются с использования общедоступных адресов IPv4 на использование их частного адреса IPv4 при общении с службой из этой подсети. Во время этого переключения все открытые TCP-подключения к службе закрываются. Убедитесь, что при включении или отключении конечной точки службы в подсети не выполняются критически важные задачи. Также удостоверьтесь, что приложения могут автоматически подключаться к службам Azure после этого переключения IP-адресов.

  Коммутатор IP-адресов влияет только на трафик служб из виртуальной сети. Там нет влияния на любой другой трафик, адресованный или из публичных адресов IPv4, назначенных для ваших виртуальных машин. Если для служб Azure установлены правила брандмауэра с использованием общедоступных IP-адресов Azure, то после переключения на частные адреса виртуальной сети эти правила перестают работать.
- С конечными точками обслуживания записи DNS для служб Azure остаются такими же, как и сегодня, и продолжают разрешаться с общедоступными IP-адресами, назначенными службе Azure.

- Группы безопасности сети (NSG) с конечными точками служб:
  - По умолчанию НСГ разрешают исходящий интернет-трафик, а также позволяют трафик из служб VNet в Azure. Этот трафик продолжает работать с конечными точками обслуживания как есть. 
  - Если вы хотите отказать в исходящих интернет-трафиках и разрешить трафик только определенным службам Azure, вы можете сделать это с помощью [тегов служб](security-overview.md#service-tags) в нСУ. Вы можете указать поддерживаемые службы Azure в качестве пункта назначения в правилах NSG, а Azure также обеспечивает обслуживание IP-адресов, лежащих в основе каждого тега. Дополнительные сведения см. в статье о [тегах служб Azure для групп NSG](security-overview.md#service-tags). 

### <a name="scenarios"></a>Сценарии

- **Пиринговые виртуальные сети, связанные виртуальные сети или несколько виртуальных сетей**. Чтобы обеспечить защиту служб Azure в нескольких подсетях в виртуальной сети или в нескольких виртуальных сетях, вы можете включить конечные точки служб для каждой из этих подсетей независимо друг от друга и защитить ресурсы служб Azure во всех этих подсетях.
- **Фильтрация исходящего трафика из виртуальной сети в службы Azure:** Если вы хотите проверить или отфильтровать трафик, отправленный в службу Azure из виртуальной сети, можно развернуть виртуальный прибор сети в виртуальной сети. Это позволяет применять конечные точки служб к подсети, в которой развертывается виртуальное сетевое устройство, и обеспечить защиту ресурса службы Azure только в этой подсети. Этот сценарий может быть полезен, если требуется фильтрация виртуальных приборов сети для ограничения доступа службы Azure от виртуальной сети только к определенным ресурсам Azure. Дополнительные сведения см. в разделе [Deploy highly available network virtual appliances](/azure/architecture/reference-architectures/dmz/nva-ha) (Развертывание высокодоступных сетевых устройств).
- **Обеспечение безопасности ресурсов Azure для служб, развернутых непосредственно в виртуальных сетях:** вы можете непосредственно развернуть различные службы Azure в определенные подсети в виртуальной сети. Вы можете защитить ресурсы служб Azure в подсетях [управляемой службы](virtual-network-for-azure-services.md), настроив конечную точку службы в подсети управляемой службы.
- **Трафик дисков с виртуальной машины Azure:** Виртуальный трафик машинного диска для управляемых и неуправляемых дисков не зависит от изменений конечной точки обслуживания для Azure Storage. Этот трафик включает в себя diskIO, а также горе и немонтировать. Можно ограничить доступ REST к каплям страниц для выбора сетей через конечные точки обслуживания и [правила сети хранения azure.](../storage/common/storage-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json) 

### <a name="logging-and-troubleshooting"></a>Ведение журнала и устранение неполадок

Как только вы наверснете конечные точки службы в конкретную службу, подтвердите, что маршрут конечных точек службы действует: 
 
- Проверка исходного IP-адреса любого запроса к службе при ее диагностике. Во всех новых запросах с использованием конечных точек служб исходный IP-адрес отображается как частный IP-адрес виртуальной сети, который назначен клиенту, выполняющему запрос из виртуальной сети. Без конечной точки этот адрес является общедоступным IP-адресом Azure.
- Просмотр действующих маршрутов любого сетевого интерфейса в подсети. Маршрут к службе:
  - отображает более точный маршрут по умолчанию с учетом префиксов адресов каждой службы;
  - использует значение *VirtualNetworkServiceEndpoint* параметра nextHopType;
  - Указывает на то, что более прямое подключение к службе действует по сравнению с любыми маршрутами принудительного туннелирования

>[!NOTE]
> Маршрут конечной точки службы переопределяет маршруты BGP или UDR при совпадении префиксов адресов для службы Azure. Для получения дополнительной [troubleshooting with effective routes](diagnose-network-routing-problem.md)информации см.

## <a name="provisioning"></a>Подготовка

Конечные точки службы могут быть настроены в виртуальных сетях независимо от пользователя, доступного для записи, доступа к виртуальной сети. Чтобы защитить ресурсы службы Azure в VNet, пользователь должен иметь разрешение на *Microsoft.Network/virtualNetworks/subnets/joinViaServiceEndpoint/action* для добавленных подсетей. Встроенные роли администратора службы включают это разрешение по умолчанию. Можно изменить разрешение, создав пользовательские роли.

Для получения дополнительной информации о [Built-in roles for Azure resources](../role-based-access-control/built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json)встроенных ролях см. Для получения дополнительной информации о назначении [Custom roles for Azure resources](../role-based-access-control/custom-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json)определенных разрешений пользовательским ролям см.

Виртуальные сети и ресурсы служб Azure могут находиться в одной или разных подписках. Если они находятся в разных подписках, ресурсы должны быть размещены в одном клиенте Active Directory (AD). 

## <a name="pricing-and-limits"></a>Цены и ограничения

Дополнительная плата за использование конечных точек обслуживания не взимается. Текущая модель ценообразования для служб Azure (Azure Storage, база данных Azure S-L и т.д.) применяется как сегодня.

В виртуальной сети нет ограничений на общее количество конечных точек обслуживания.

Некоторые службы Azure, такие как учетные записи хранения Azure, могут напоровать ограничения на количество подсетей, используемых для обеспечения безопасности ресурса. Для получения подробной информации обратитесь к документации для различных служб в разделе [«Следующие шаги».](#next-steps)

## <a name="vnet-service-endpoint-policies"></a>Политики конечных точек службы VNet 

Политики конечных точек службы VNet позволяют фильтровать виртуальный сетевой трафик в службы Azure. Этот фильтр позволяет использовать только определенные ресурсы службы Azure над конечными точками обслуживания. Политики конечных точек служб предоставляют возможность детального контроля доступа трафика из виртуальной сети к службам Azure. Для получения дополнительной [информации см.](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoint-policies-overview)

## <a name="faqs"></a>Часто задаваемые вопросы

Для часто задаваемых вопросов, см [Виртуальная сеть службы конечных часто задаваемых вопросов](https://docs.microsoft.com/azure/virtual-network/virtual-networks-faq#virtual-network-service-endpoints).

## <a name="next-steps"></a>Следующие шаги

- [Настройка конечных точек служб для виртуальной сети](tutorial-restrict-network-access-to-resources.md)
- [Защищайте учетную запись хранения Azure в виртуальной сети](../storage/common/storage-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json)
- [Защищайте базу данных Azure S'L для виртуальной сети](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json)
- [Защищайте хранилище данных Azure S'L в виртуальной сети](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fsql-data-warehouse%2ftoc.json)
- [Интеграция сервисов Azure в виртуальные сети](virtual-network-for-azure-services.md)
- [Политики конечных точек служб для виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoint-policies-overview)
- [Шаблон Azure Resource Manager](https://azure.microsoft.com/resources/templates/201-vnet-2subnets-service-endpoints-storage-integration)

