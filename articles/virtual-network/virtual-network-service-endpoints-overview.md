---
title: Конечные точки служб для виртуальной сети Azure
titlesuffix: Azure Virtual Network
description: Узнайте, как включить прямой доступ к ресурсам Azure из виртуальной сети с помощью конечных точек служб.
services: virtual-network
documentationcenter: na
author: sumeetmittal
ms.service: virtual-network
ms.devlang: NA
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/15/2018
ms.author: sumi
ms.custom: ''
ms.openlocfilehash: 8420142e67fe4af12045a2b6fe7f7461ef384f81
ms.sourcegitcommit: 19a821fc95da830437873d9d8e6626ffc5e0e9d6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2019
ms.locfileid: "70164473"
---
# <a name="virtual-network-service-endpoints"></a>Конечные точки службы для виртуальной сети

Конечные точки служб виртуальной сети расширяют пространство частных адресов и возможности идентификации вашей виртуальной сети в службах Azure благодаря прямому соединению. Конечные точки позволяют защищать критически важные ресурсы служб Azure в пределах отдельных виртуальных сетей. Трафик, поступающий из виртуальной сети в службу Azure, всегда остается в магистральной сети Microsoft Azure.

Эта функция доступна для следующих служб и регионов Azure, и вы также найдете ресурс Microsoft. * в круглых скобках, который должен быть включен на стороне подсети при настройке конечных точек службы для службы:

**Общедоступная версия**

- Служба **[хранилища Azure](../storage/common/storage-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network)** (Microsoft. Storage): общедоступная версия во всех регионах Azure.
- **[База данных SQL Azure](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (Microsoft. SQL): общедоступная версия во всех регионах Azure.
- **[Хранилище данных SQL Azure](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (Microsoft. SQL): общедоступная версия во всех регионах Azure.
- **[Сервер базы данных Azure для PostgreSQL](../postgresql/howto-manage-vnet-using-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (Microsoft. SQL): общедоступная версия в регионах Azure, в которых доступна служба базы данных.
- **[Сервер базы данных Azure для MySQL](../mysql/howto-manage-vnet-using-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (Microsoft. SQL): общедоступная версия в регионах Azure, в которых доступна служба базы данных.
- **[База данных Azure для MariaDB](https://docs.microsoft.com/azure/mariadb/concepts-data-access-security-vnet)** (Microsoft. SQL): общедоступная версия в регионах Azure, в которых доступна служба базы данных.
- **[Azure Cosmos DB](../cosmos-db/vnet-service-endpoint.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (Microsoft. Азурекосмосдб): общедоступная версия во всех регионах Azure.
- **[Azure Key Vault](../key-vault/key-vault-overview-vnet-service-endpoints.md)** (Microsoft. KeyVault): общедоступная версия во всех регионах Azure.
- **[Служебная шина Azure](../service-bus-messaging/service-bus-service-endpoints.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (Microsoft. ServiceBus): общедоступная версия во всех регионах Azure.
- **[Концентраторы событий Azure](../event-hubs/event-hubs-service-endpoints.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (Microsoft. EventHub): общедоступная версия во всех регионах Azure.
- **[Azure Data Lake Store Gen 1](../data-lake-store/data-lake-store-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json)** (Microsoft. AzureActiveDirectory): общедоступная версия во всех регионах Azure, в которых доступна ADLS 1-го поколения.
- **[Служба приложений Azure](https://docs.microsoft.com/azure/app-service/app-service-ip-restrictions)** : Общедоступно во всех регионах Azure, где доступна служба приложений

**Общедоступная предварительная версия**

- **[Реестр контейнеров Azure](../container-registry/container-registry-vnet.md)** (Microsoft. ContainerRegistry): Предварительная версия доступна во всех регионах Azure, где доступен реестр контейнеров Azure.

Самые актуальные уведомления доступны на странице [обновлений виртуальной сети Azure](https://azure.microsoft.com/updates/?product=virtual-network).

## <a name="key-benefits"></a>Основные преимущества

Конечные точки служб обеспечивают следующие преимущества.

- **Повышение уровня безопасности для ресурсов служб Azure**. Частное адресное пространство виртуальной сети может перекрываться, поэтому его нельзя использовать для уникальной идентификации трафика, поступающего из виртуальной сети. Конечные точки службы дают возможность защитить ресурсы службы Azure в виртуальной сети путем расширения удостоверения виртуальной сети на эту службу. Включив конечные точки служб в виртуальной сети, вы можете защитить в ней ресурсы служб Azure, добавив правило виртуальной сети для ресурсов. Это повысит уровень безопасности, поскольку полностью исключается открытый доступ к ресурсам из Интернета и разрешается трафик только из виртуальной сети.
- **Оптимальная маршрутизация трафика службы Azure из виртуальной сети**. Сейчас по всем маршрутам в виртуальной сети, по которым к локальным или виртуальным устройствам принудительно направляется интернет-трафик (процесс принудительного туннелирования), также принудительно направляется трафик служб Azure. Конечные точки служб обеспечивают оптимальную маршрутизацию трафика Azure. 

  Конечные точки всегда направляют трафик служб непосредственно из виртуальной сети в службу в магистральной сети Microsoft Azure. Так как трафик не покидает пределы магистральной сети, это позволяет и дальше выполнять аудит и мониторинг исходящего интернет-трафика из виртуальных сетей при помощи принудительного туннелирования без воздействия на трафик служб. Ознакомьтесь со сведениями об [определяемых пользователем маршрутах и принудительном туннелировании](virtual-networks-udr-overview.md).
- **Простота настройки и управления**. Вам больше не требуются зарезервированные общедоступные IP-адреса в виртуальных сетях для защиты ресурсов Azure при помощи брандмауэра для IP-адресов. Для настройки конечных точек служб не нужны устройства NAT или шлюзы. Чтобы настроить конечную точку службы, достаточно щелкнуть подсеть. Обслуживание конечных точек не требует дополнительных расходов.

## <a name="limitations"></a>Ограничения

- Функция доступна только для виртуальных сетей, развернутых посредством модели развертывания с помощью Azure Resource Manager.
- Конечные точки включаются в подсетях, которые настроены в виртуальных сетях Azure. Конечные точки нельзя использовать для трафика, поступающего из локальной среды в службы Azure. Дополнительные сведения см. в разделе о [защите доступа к службам Azure из локальной среды](#securing-azure-services-to-virtual-networks).
- В SQL Azure конечная точка службы применяется только к трафику службы Azure в пределах региона виртуальной сети. В службе хранилища Azure для поддержки трафика RA-GRS и GRS конечные точки также применяются к сопряженным регионам, в которых развернута виртуальная сеть. См. дополнительные сведения о [парах регионов Azure](../best-practices-availability-paired-regions.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-paired-regions).
- У Azure Data Lake Storage 1-го поколения возможность интеграции с виртуальной сетью доступна только для виртуальных сетей из одного региона. Также обратите внимание, что интеграция виртуальной сети для Azure Data Lake Storage 1-го поколения использует безопасность конечной точки службы виртуальной сети между виртуальной сетью и Azure Active Directory (Azure AD) для создания дополнительных утверждений безопасности в маркере доступа. Эти утверждения используются для проверки подлинности виртуальной сети в учетной записи ADLS 1-го поколения и для предоставления доступа. Тег Microsoft. AzureActiveDirectory, указанный в разделе службы, поддерживающие конечные точки службы, используется только для вспомогательных конечных точек службы для ADLS Gen 1. Azure Active Directory (Azure AD) не поддерживает конечные точки службы изначально. Дополнительные сведения об [интеграции с виртуальной сетью Azure Data Lake Store Gen 1](../data-lake-store/data-lake-store-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

## <a name="securing-azure-services-to-virtual-networks"></a>Защита служб Azure в виртуальных сетях

- Конечная точка службы для виртуальной сети предоставляет службе Azure удостоверение виртуальной сети. Включив конечные точки служб в виртуальной сети, вы можете защитить в ней ресурсы служб Azure, добавив правило виртуальной сети для ресурсов.
- В настоящее время трафик служб Azure из виртуальной сети использует общедоступные IP-адреса в качестве исходных IP-адресов. При помощи конечных точек служб трафик в качестве исходных IP-адресов использует частные адреса виртуальной сети при обращении к службе Azure из виртуальной сети. Это переключение позволяет осуществлять доступ к службам без необходимости в зарезервированных общедоступных IP-адресах, которые используются в брандмауэрах.

>[!NOTE]
> При использовании конечных точек службы исходные IP-адреса виртуальных машин в подсети для трафика служб переключаются с общедоступных адресов IPv4 на частные. Существующие правила брандмауэра службы Azure, использующие общедоступные IP-адреса Azure, перестанут работать после этого переключения. Перед настройкой конечных точек службы убедитесь, что правила брандмауэра службы Azure поддерживают переключение. При настройке конечных точек службы также может наблюдаться временное прерывание трафика служб из этой подсети. 
 
- __Защита доступа к службам Azure из локальной среды.__

  По умолчанию ресурсы служб Azure, которые защищены в виртуальной сети, недоступны для локальных сетей. Чтобы разрешить трафик из локальной среды, необходимо также разрешить общедоступные IP-адреса (обычно это NAT) из локальных каналов или каналов ExpressRoute. Эти IP-адреса можно добавить в конфигурации брандмауэра IP-адресов для ресурсов служб Azure.

  ExpressRoute. Если вы используете [ExpressRoute](../expressroute/expressroute-introduction.md?toc=%2fazure%2fvirtual-network%2ftoc.json) для локальной среды, для общедоступного пиринга или пиринга Майкрософт, то вам необходимо определить используемые IP-адреса NAT. Для общедоступного пиринга в каждом канале ExpressRoute по умолчанию используется два IP-адреса NAT для трафика служб Azure, когда он входит в основную магистральную сеть Microsoft Azure. Для пиринга Майкрософт используются IP-адреса NAT, предоставленные клиентом или поставщиком услуг. Чтобы разрешить доступ к ресурсам служб, необходимо разрешить эти общедоступные IP-адреса в настройках брандмауэра IP-адресов ресурсов. Чтобы найти IP-адреса канала ExpressRoute для общедоступного пиринга, [отправьте запрос по ExpressRoute в службу поддержки](https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview) через портал Azure. Узнайте больше о [NAT для общедоступного пиринга и пиринга Майкрософт](../expressroute/expressroute-nat.md?toc=%2fazure%2fvirtual-network%2ftoc.json#nat-requirements-for-azure-public-peering).

![Защита служб Azure в виртуальных сетях](./media/virtual-network-service-endpoints-overview/VNet_Service_Endpoints_Overview.png)

### <a name="configuration"></a>Конфигурация

- Конечные точки служб настраиваются в подсети виртуальной сети. Конечные точки работают с любым типом вычислительных экземпляров, выполняющихся в этой подсети.
- Можно настроить несколько конечных точек служб для всех поддерживаемых служб Azure (например, для службы хранилища Azure или Базы данных SQL Azure) в подсети.
- Для Базы данных SQL Azure виртуальные сети должны относиться к тому же региону, что и ресурс службы Azure. При использовании учетных записей хранения Azure GRS и RA-GRS основная учетная запись должна принадлежать тому же региону, что и виртуальная сеть. Для всех остальных служб можно обеспечить защиту ресурсов Azure в виртуальных сетях в любом регионе. 
- Виртуальная сеть, в которой настраивается конечная точка, может относиться к той же подписке, что и ресурс службы Azure, либо же к другой подписке. Дополнительные сведения о разрешениях, которые требуются для настройки конечных точек и защиты служб Azure, см. в разделе [Подготовка](#provisioning).
- Вы можете защитить новые или существующие ресурсы в виртуальных сетях с помощью конечных точек служб для поддерживаемых служб.

### <a name="considerations"></a>Рекомендации

- После включения конечной точки службы исходные IP-адреса виртуальных машин в подсети переключаются с общедоступных IPv4-адресов на частные, если осуществляется обмен данными со службой из этой подсети. Во время этого переключения все открытые TCP-подключения к службе закрываются. Убедитесь, что при включении или отключении конечной точки службы в подсети не выполняются критически важные задачи. Также удостоверьтесь, что приложения могут автоматически подключаться к службам Azure после этого переключения IP-адресов.

  Коммутатор IP-адресов влияет только на трафик служб из виртуальной сети. Он не влияет ни на какой другой входящий или исходящий трафик, передаваемый по общедоступным IPv4-адресам, которые назначены виртуальным машинам. Если для служб Azure установлены правила брандмауэра с использованием общедоступных IP-адресов Azure, то после переключения на частные адреса виртуальной сети эти правила перестают работать.
- Если используются конечные точки служб, текущие записи DNS для служб Azure остаются без изменений и продолжают разрешать общедоступные IP-адреса, которые назначены службе Azure.

- Группы безопасности сети (NSG) с конечными точками служб:
  - По умолчанию группы NSG разрешают исходящий интернет-трафик и, следовательно, трафик из виртуальной сети в службы Azure. При настройке конечных точек служб этот подход продолжает использоваться. 
  - Чтобы запретить весь исходящий интернет-трафик и разрешить трафик только в определенные службы Azure, воспользуйтесь [тегами служб](security-overview.md#service-tags) в группах NSG. Вы можете указать поддерживаемые службы Azure как место назначения в правилах NSG, и обслуживание IP-адресов, которые определены в каждом теге, будет выполняться средствами Azure. Дополнительные сведения см. в статье о [тегах служб Azure для групп NSG](security-overview.md#service-tags). 

### <a name="scenarios"></a>Сценарии

- **Пиринговые или подключенные виртуальные сети либо же несколько виртуальных сетей**. Чтобы обеспечить защиту служб Azure в нескольких подсетях в виртуальной сети или в нескольких виртуальных сетях, вы можете включить конечные точки служб для каждой из этих подсетей независимо друг от друга и защитить ресурсы служб Azure во всех этих подсетях.
- **Фильтрация исходящего трафика, который поступает из виртуальной сети в службы Azure**. Чтобы проверить или отфильтровать трафик, который поступает в службу Azure из виртуальной сети, можно развернуть в этой виртуальной сети виртуальное сетевое устройство. Это позволяет применять конечные точки служб к подсети, в которой развертывается виртуальное сетевое устройство, и обеспечить защиту ресурса службы Azure только в этой подсети. Это может быть полезно, если вам требуется разрешить доступ к службе Azure из виртуальной сети только для определенных ресурсов Azure с использованием фильтрации виртуального сетевого устройства. Дополнительные сведения см. в разделе [Deploy highly available network virtual appliances](/azure/architecture/reference-architectures/dmz/nva-ha) (Развертывание высокодоступных сетевых устройств).
- **Защита ресурсов Azure для служб, развернутых непосредственно в виртуальных сетях**. Различные службы Azure можно развернуть непосредственно в определенных подсетях в виртуальной сети. Вы можете защитить ресурсы служб Azure в подсетях [управляемой службы](virtual-network-for-azure-services.md), настроив конечную точку службы в подсети управляемой службы.
- **Трафик диска с виртуальной машины Azure**. На трафик управляемых и неуправляемых дисков виртуальной машины (включая подключение, отключение и операции ввода-вывода диска) не влияет изменение маршрутов для конечных точек служб в службе хранилища Azure. Вы можете ограничить доступ REST для выбора сетей страничными BLOB-объектами с помощью конечных точек служб и [сетевых правил службы хранилища Azure](../storage/common/storage-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json). 

### <a name="logging-and-troubleshooting"></a>Ведение журнала и устранение неполадок

Настроив конечные точки для определенной службы, убедитесь, что для маршрута конечной точки службы поддерживаются: 
 
- Проверка исходного IP-адреса любого запроса к службе при ее диагностике. Во всех новых запросах с использованием конечных точек служб исходный IP-адрес отображается как частный IP-адрес виртуальной сети, который назначен клиенту, выполняющему запрос из виртуальной сети. Без конечной точки этот адрес является общедоступным IP-адресом Azure.
- Просмотр действующих маршрутов любого сетевого интерфейса в подсети. Маршрут к службе:
  - отображает более точный маршрут по умолчанию с учетом префиксов адресов каждой службы;
  - использует значение *VirtualNetworkServiceEndpoint* параметра nextHopType;
  - указывает, что для службы применяется прямое соединение более высокого уровня, чем соединение любого маршрута с принудительным туннелированием.

>[!NOTE]
> Маршрут конечной точки службы переопределяет маршруты BGP или UDR при совпадении префиксов адресов для службы Azure. Ознакомьтесь со сведениями об [устранении неполадок с действующими маршрутами](diagnose-network-routing-problem.md).

## <a name="provisioning"></a>Идет подготовка

Пользователь с правами на запись в виртуальной сети может настроить конечные точки служб в виртуальных сетях независимо друг от друга. Чтобы защитить ресурсы службы Azure для виртуальной сети, пользователь должен иметь разрешение на доступ к *Microsoft. Network/virtualNetworks/подсети/жоинвиасервицеендпоинт/Action* для добавляемых подсетей. Это разрешение по умолчанию включено во встроенные роли администраторов служб и может быть изменено при создании настраиваемых ролей.

Узнайте больше о [встроенных ролях](../role-based-access-control/built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json) и назначении разрешений, определенных для [настраиваемых ролей](../role-based-access-control/custom-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

Виртуальные сети и ресурсы служб Azure могут находиться в одной или разных подписках. Если они находятся в разных подписках, ресурсы должны быть размещены в одном клиенте Active Directory (AD). 

## <a name="pricing-and-limits"></a>Цены и ограничения

За использование конечных точек службы дополнительная плата не взимается. Текущие цены на службы Azure (служба хранилища Azure, База данных SQL Azure и т. д.) применяются без изменений.

Общее количество конечных точек служб в виртуальной сети не ограничено.

Некоторые службы Azure, такие как учетные записи хранения Azure, могут применять ограничения на количество подсетей, используемых для защиты ресурса. Дополнительные сведения см. в документации по различным службам в разделе [Дальнейшие действия](#next-steps).

## <a name="virtual-network-service-endpoint-policies"></a>Политики конечных точек служб для виртуальной сети 

Политики конечных точек служб для виртуальной сети позволяют фильтровать трафик из виртуальной сети к службам Azure, разрешая трафик определенных ресурсов служб через конечные точки служб. Политики конечных точек служб предоставляют возможность детального контроля доступа трафика из виртуальной сети к службам Azure. Дополнительные сведения см. в статье [Политики конечных точек служб для виртуальной сети (предварительная версия)](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoint-policies-overview).

## <a name="faqs"></a>Часто задаваемые вопросы

Часто задаваемые вопросы о конечной точке службы для виртуальной сети см. [здесь](https://docs.microsoft.com/azure/virtual-network/virtual-networks-faq#virtual-network-service-endpoints).

## <a name="next-steps"></a>Следующие шаги

- Узнайте, как [настроить конечные точки служб для виртуальной сети](tutorial-restrict-network-access-to-resources.md).
- Узнайте, как [защитить учетную запись хранения Azure с помощью виртуальной сети](../storage/common/storage-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json).
- Узнайте, как [защитить базу данных SQL Azure с помощью виртуальной сети](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json).
- Узнайте, как [защитить Хранилище данных SQL Azure с помощью виртуальной сети](../sql-database/sql-database-vnet-service-endpoint-rule-overview.md?toc=%2fazure%2fsql-data-warehouse%2ftoc.json).
- Узнайте об [интеграции служб Azure в виртуальных сетях](virtual-network-for-azure-services.md).
- Узнайте о [политиках конечных точек служб для виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoint-policies-overview).
-  Используйте для быстрого запуска [шаблон Azure Resource Manager](https://azure.microsoft.com/resources/templates/201-vnet-2subnets-service-endpoints-storage-integration), с помощью которого можно настроить конечную точку службы в подсети виртуальной сети и защитить учетную запись хранения Azure в этой подсети.

