---
title: Устранение проблем с подключением к NAT виртуальной сети Azure
titleSuffix: Azure Virtual Network NAT troubleshooting
description: Устранение неполадок с NAT виртуальной сети.
services: virtual-network
documentationcenter: na
author: asudbring
manager: KumudD
ms.service: virtual-network
Customer intent: As an IT administrator, I want to troubleshoot Virtual Network NAT.
ms.devlang: na
ms.topic: overview
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/04/2020
ms.author: allensu
ms.openlocfilehash: d56cd3b3d286d69a51d8cc14eb8020343cf7295a
ms.sourcegitcommit: f915d8b43a3cefe532062ca7d7dbbf569d2583d8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2020
ms.locfileid: "78302990"
---
# <a name="troubleshoot-azure-virtual-network-nat-connectivity-problems"></a>Устранение проблем с подключением к NAT виртуальной сети Azure

Эта статья поможет администраторам диагностировать и устранять проблемы с подключением при использовании NAT виртуальной сети.

>[!NOTE] 
>Сейчас NAT виртуальной сети предоставляется в общедоступной предварительной версии. В данный момент оно доступно только в ограниченном наборе [регионов](nat-overview.md#region-availability). Предварительная версия предоставляется без соглашения об уровне обслуживания. Не рекомендуем использовать ее в рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены. См. [дополнительные условия использования для предварительных версий Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms).

## <a name="problems"></a>Проблемы

- [Нехватка SNAT](#snat-exhaustion).
- [Сбой проверки связи ICMP](#icmp-ping-is-failing).

Чтобы устранить эти проблемы, выполните описанные в следующем разделе действия.

## <a name="resolution"></a>Решение

### <a name="snat-exhaustion"></a>Нехватка SNAT

Один [ресурс шлюза NAT](nat-gateway-resource.md) поддерживает от 64 000 до 1 000 000 параллельных потоков.  Каждый IP-адрес пополняет доступные ресурсы на 64 000 портов SNAT. Один ресурс шлюза NAT позволяет использовать до 16 статических IP-адресов.  Механизм SNAT более подробно описан [здесь](nat-gateway-resource.md#source-network-address-translation).

#### <a name="steps"></a>Шаги:

1. Выясните, как приложение создает исходящее подключение (например, изучите код или соберите пакеты). 
2. Определите, является ли действие ожидаемым или поведение приложения некорректным.  Для подтверждения результатов используйте [метрики](nat-metrics.md) Azure Monitor.
3. Оцените, соблюдаются ли применимые шаблоны действий.
4. Выясните, нужно ли устранять нехватку портов SNAT путем назначения ресурсу шлюза NAT дополнительных IP-адресов.

#### <a name="design-pattern"></a>Конструктивный шаблон.

Старайтесь повторно использовать подключения и создавать пулы подключений везде, где это возможно.  Этот шаблон позволяет в корне устранить проблему нехватки ресурсов и гарантировать предсказуемое поведение. Примитивы для этих шаблонов можно найти во многих библиотеках и платформах разработки.
- Попробуйте применить [шаблоны асинхронного опроса](https://docs.microsoft.com/azure/architecture/patterns/async-request-reply) для длительных операций, чтобы освободить ресурсы подключений для других операций.
- Долгосрочные потоки (например, повторно используемые TCP-подключения) должны использовать методы проверки активности на уровне протокола TCP или приложения, чтобы не истекало время ожидания в промежуточных системах.
- Следует использовать аккуратные [шаблоны повторных попыток](https://docs.microsoft.com/azure/architecture/patterns/retry), чтобы избежать агрессивных всплесков нагрузки при временном сбое или при восстановлении после сбоя.
Создание нового TCP-подключения для каждой операции HTTP известно как антишаблон "атомарных подключений".  Атомарные подключения не дают приложению хорошо масштабироваться и тратят много ресурсов впустую.  Обязательно объединяйте последовательные операции в один конвейер в пределах одного подключения.  Это повысит скорость транзакций в приложении и снизит затраты ресурсов.  Если приложение использует шифрование на транспортном уровне (например, TLS), обработка новых подключений влечет значительные затраты.  Изучите статью [Конструктивные шаблоны облачных решений](https://docs.microsoft.com/azure/architecture/patterns/) с дополнительными рекомендациями по проектированию.

#### <a name="mitigations"></a>Устранение проблем

Для масштабирования исходящих подключений можно использовать следующий механизм.

| Сценарий | Меры по снижению риска |
|---|---|
| Проявляется конкуренция за порты SNAT и их нехватка в периоды высокой нагрузки. | Определите, можно ли использовать дополнительные ресурсы общедоступных IP-адресов и (или) ресурсы префиксов общедоступных IP-адресов. Вы можете добавить к шлюзу NAT в общей сложности до 16 IP-адресов. Такое дополнение увеличит запас доступных портов SNAT (по 64 000 на каждый IP-адрес) и позволит увеличить масштаб системы.|
| Вы уже используете 16 IP-адресов, но проблемы с исчерпанием портов SNAT сохраняются. | Распределите среду приложения по нескольким подсетям и создайте для каждой из них собственный ресурс шлюза NAT. |

>[!NOTE]
>Важно понимать, почему происходит исчерпание портов SNAT. Убедитесь, что соблюдаете все разумные рекомендации по обеспечению масштиабируемости и надежности.  Добавление в систему портов SNAT без понимания причин высокого спроса допустимо применять только в крайних случаях. Если вы не знаете, почему в системе создается высокий спрос на ресурсы портов SNAT, добавление новых портов через дополнительные IP-адреса лишь отсрочит новые проявления той же проблемы, которые неизбежно повторятся при увеличении масштаба.  Возможно, вы будете затыкать дыры, созданные неэффективностью или антишаблоном в приложении.

### <a name="icmp-ping-is-failing"></a>Сбой проверки связи ICMP

[NAT виртуальной сети](nat-overview.md) поддерживает протоколы UDP и TCP в IPv4. Протокол ICMP не поддерживается и работать не должен.  Вместо него для сквозной проверки связи используйте тесты подключения на основе TCP (например, так называемый "TCP ping") и UDP, выполняемые на уровне приложения.

В качестве отправной точки при выборе средств для запуска тестов можно использовать следующую таблицу.

| Операционная система | Универсальная проверка TCP-подключения. | Тест TCP на уровне приложения | UDP |
|---|---|---|---|
| Linux | nc (универсальный тест подключения) | curl (тест TCP на уровне приложения) | в зависимости от приложения |
| Windows | [PsPing](https://docs.microsoft.com/sysinternals/downloads/psping) | PowerShell [Invoke-WebRequest](https://docs.microsoft.com/powershell/module/microsoft.powershell.utility/invoke-webrequest) | в зависимости от приложения |

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о [NAT виртуальной сети](nat-overview.md).
- Дополнительные сведения о [ресурсе шлюза NAT](nat-gateway-resource.md).
- Дополнительные сведения о [метриках и оповещениях для ресурсов шлюза NAT](nat-metrics.md).
