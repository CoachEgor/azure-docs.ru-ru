---
title: Устранение проблем с подключением к NAT виртуальной сети Azure
titleSuffix: Azure Virtual Network NAT troubleshooting
description: Устранение неполадок с NAT виртуальной сети.
services: virtual-network
documentationcenter: na
author: asudbring
manager: KumudD
ms.service: virtual-network
Customer intent: As an IT administrator, I want to troubleshoot Virtual Network NAT.
ms.devlang: na
ms.topic: overview
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/05/2020
ms.author: allensu
ms.openlocfilehash: c629b3425cd095a6ac9d305b5cd6de58ed9d572a
ms.sourcegitcommit: bc792d0525d83f00d2329bea054ac45b2495315d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78674329"
---
# <a name="troubleshoot-azure-virtual-network-nat-connectivity-problems"></a>Устранение проблем с подключением к NAT виртуальной сети Azure

Эта статья поможет администраторам диагностировать и устранять проблемы с подключением при использовании NAT виртуальной сети.

>[!NOTE] 
>Сейчас NAT виртуальной сети предоставляется в общедоступной предварительной версии. В данный момент оно доступно только в ограниченном наборе [регионов](nat-overview.md#region-availability). Предварительная версия предоставляется без соглашения об уровне обслуживания. Не рекомендуем использовать ее в рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены. См. [дополнительные условия использования для предварительных версий Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms).

## <a name="problems"></a>Проблемы

* [Нехватка SNAT](#snat-exhaustion)
* [Сбой проверки связи ICMP](#icmp-ping-is-failing)
* [Сбои подключений](#connectivity-failures)
* [Совместная работа c IPv6](#ipv6-coexistence)

Чтобы устранить эти проблемы, выполните описанные в следующем разделе действия.

## <a name="resolution"></a>Решение

### <a name="snat-exhaustion"></a>Нехватка SNAT

Один [ресурс шлюза NAT](nat-gateway-resource.md) поддерживает от 64 000 до 1 000 000 параллельных потоков.  Каждый IP-адрес пополняет доступные ресурсы на 64 000 портов SNAT. Один ресурс шлюза NAT позволяет использовать до 16 статических IP-адресов.  Механизм SNAT более подробно описан [здесь](nat-gateway-resource.md#source-network-address-translation).

Часто первопричиной нехватки SNAT является антишаблон для установки исходящего подключения и управления им.  Внимательно просмотрите этот раздел.

#### <a name="steps"></a>Шаги

1. Выясните, как приложение создает исходящее подключение (например, изучите код или соберите пакеты). 
2. Определите, является ли действие ожидаемым или поведение приложения некорректным.  Для подтверждения результатов используйте [метрики](nat-metrics.md) Azure Monitor. Используйте категорию "Сбой" для метрики подключений SNAT.
3. Оцените, соблюдаются ли применимые шаблоны действий.
4. Выясните, нужно ли устранять нехватку портов SNAT путем назначения ресурсу шлюза NAT дополнительных IP-адресов.

#### <a name="design-patterns"></a>Шаблоны проектирования

Старайтесь повторно использовать подключения и создавать пулы подключений везде, где это возможно.  Эти шаблоны позволяют в корне устранить проблему нехватки ресурсов и гарантировать предсказуемое, надежное и масштабируемое поведение. Примитивы для этих шаблонов можно найти во многих библиотеках и платформах разработки.

_**Решение.**_ Используйте подходящие шаблоны.

- Попробуйте применить [шаблоны асинхронного опроса](https://docs.microsoft.com/azure/architecture/patterns/async-request-reply) для длительных операций, чтобы освободить ресурсы подключений для других операций.
- Долгосрочные потоки (например, повторно используемые TCP-подключения) должны использовать методы проверки активности на уровне протокола TCP или приложения, чтобы не истекало время ожидания в промежуточных системах.
- Следует использовать аккуратные [шаблоны повторных попыток](https://docs.microsoft.com/azure/architecture/patterns/retry), чтобы избежать агрессивных всплесков нагрузки при временном сбое или при восстановлении после сбоя.
Создание нового TCP-подключения для каждой операции HTTP известно как антишаблон "атомарных подключений".  Атомарные подключения не дают приложению хорошо масштабироваться и тратят много ресурсов впустую.  Обязательно объединяйте последовательные операции в один конвейер в пределах одного подключения.  Это повысит скорость транзакций в приложении и снизит затраты ресурсов.  Если приложение использует шифрование на транспортном уровне (например, TLS), обработка новых подключений влечет значительные затраты.  Изучите статью [Конструктивные шаблоны облачных решений](https://docs.microsoft.com/azure/architecture/patterns/) с дополнительными рекомендациями по проектированию.

#### <a name="possible-mitigations"></a>Возможные способы устранения

_**Решение.**_ Для масштабирования исходящих подключений можно использовать следующий механизм.

| Сценарий | Свидетельство |Меры по снижению риска |
|---|---|---|
| Проявляется конкуренция за порты SNAT и их нехватка в периоды высокой нагрузки. | В категории "Сбой" для [метрики](nat-metrics.md) подключений SNAT в Azure Monitor отображаются временные или постоянные сбои с течением времени и большое количество подключений.  | Определите, можно ли использовать дополнительные ресурсы общедоступных IP-адресов и (или) ресурсы префиксов общедоступных IP-адресов. Вы можете добавить к шлюзу NAT в общей сложности до 16 IP-адресов. Такое дополнение увеличит запас доступных портов SNAT (по 64 000 на каждый IP-адрес) и позволит увеличить масштаб системы.|
| Вы уже используете 16 IP-адресов, но проблемы с исчерпанием портов SNAT сохраняются. | Не удалось добавить дополнительный IP-адрес. Общее число IP-адресов из ресурсов общедоступных IP-адресов или ресурсов префиксов общедоступных IP-адресов превышает 16 байт. | Распределите среду приложения по нескольким подсетям и создайте для каждой из них собственный ресурс шлюза NAT.  Оцените повторно конструктивные шаблоны, чтобы оптимизировать их, основываясь на приведенных выше [рекомендациях](#design-patterns). |

>[!NOTE]
>Важно понимать, почему происходит исчерпание портов SNAT. Убедитесь, что соблюдаете все разумные рекомендации по обеспечению масштиабируемости и надежности.  Добавление в систему портов SNAT без понимания причин высокого спроса допустимо применять только в крайних случаях. Если вы не знаете, почему в системе создается высокий спрос на ресурсы портов SNAT, добавление новых портов через дополнительные IP-адреса лишь отсрочит новые проявления той же проблемы, которые неизбежно повторятся при увеличении масштаба.  Возможно, вы будете затыкать дыры, созданные неэффективностью или антишаблоном в приложении.

### <a name="icmp-ping-is-failing"></a>Сбой проверки связи ICMP

[NAT виртуальной сети](nat-overview.md) поддерживает протоколы UDP и TCP в IPv4. Протокол ICMP не поддерживается и работать не должен.  

_**Решение.**_ Вместо него для сквозной проверки связи используйте тесты подключения на основе TCP (например, так называемый "TCP ping") и UDP, выполняемые на уровне приложения.

В качестве отправной точки при выборе средств для запуска тестов можно использовать следующую таблицу.

| Операционная система | Универсальная проверка TCP-подключения. | Тест TCP на уровне приложения | UDP |
|---|---|---|---|
| Linux | nc (универсальный тест подключения) | curl (тест TCP на уровне приложения) | в зависимости от приложения |
| Windows | [PsPing](https://docs.microsoft.com/sysinternals/downloads/psping) | PowerShell [Invoke-WebRequest](https://docs.microsoft.com/powershell/module/microsoft.powershell.utility/invoke-webrequest) | в зависимости от приложения |

### <a name="connectivity-failures"></a>Сбои подключений

Проблемы с подключением при использовании [NAT виртуальной сети](nat-overview.md) могут возникать по нескольким причинам:

* временная или постоянная [нехватка SNAT](#snat-exhaustion) для шлюза NAT;
* временные сбои в инфраструктуре Azure; 
* временные сбои на пути между Azure и общедоступным местом назначения в Интернете; 
* временные или постоянные сбои в общедоступном месте назначения в Интернете.

Для проверки подключения используйте такие средства, как указано ниже. [Проверка связи ICMP не поддерживается](#icmp-ping-is-failing).

| Операционная система | Универсальная проверка TCP-подключения. | Тест TCP на уровне приложения | UDP |
|---|---|---|---|
| Linux | nc (универсальный тест подключения) | curl (тест TCP на уровне приложения) | в зависимости от приложения |
| Windows | [PsPing](https://docs.microsoft.com/sysinternals/downloads/psping) | PowerShell [Invoke-WebRequest](https://docs.microsoft.com/powershell/module/microsoft.powershell.utility/invoke-webrequest) | в зависимости от приложения |

#### <a name="snat-exhaustion"></a>Нехватка SNAT

Ознакомьтесь с разделом [Нехватка SNAT](#snat-exhaustion) в этой статье.

#### <a name="azure-infrastructure"></a>Инфраструктура Azure

Несмотря на то, что Azure тщательно следит за своей инфраструктурой и использует ее очень осторожно, из-за невозможности гарантировать передачу без потерь возможны временные сбои.  Используйте конструктивные шаблоны, позволяющие повторно передавать SYN для приложений TCP. Используйте достаточно большие значения для времени ожидания соединения, чтобы обеспечить повторную передачу SYN по протоколу TCP для уменьшения влияния временного сбоя, вызванного потерей пакета SYN.

_**Решение**_

* Проверьте, нет ли [нехватки SNAT](#snat-exhaustion).
* Параметр конфигурации в стеке TCP, управляющий поведением при повторной передаче SYN, называется RTO ([время ожидания повторной отправки](https://tools.ietf.org/html/rfc793)). Значение RTO можно изменить, но обычно по умолчанию оно равно 1 секунде или более с экспоненциальной задержкой.  Если время ожидания подключения приложения слишком короткое (например, 1 секунда), время от времени могут происходить тайм-ауты подключения.  Увеличьте время ожидания подключения приложения.
* Если в поведении приложения по умолчанию замечены более длительные непредвиденные тайм-ауты, отправьте запрос в службу поддержки для дальнейшего устранения неполадок.

Не рекомендуется искусственно уменьшать время ожидания подключения TCP или настраивать параметр RTO.

#### <a name="public-internet-transit"></a>Транзит в общедоступное расположение через Интернет

Чем длиннее путь к месту назначения и больше промежуточных систем, тем выше вероятность появления временных сбоев. Предполагается, что временные сбои в [инфраструктуре Azure](#azure-infrastructure) могут учащаться. 

Следуйте тем же рекомендациям, что и в предыдущем разделе [Инфраструктура Azure](#azure-infrastructure).

#### <a name="internet-endpoint"></a>Конечная точка Интернета

Помимо изложенного в приведенных выше разделах, следует также принимать во внимание конечною точку Интернета, с которой устанавливается связь. На успешность подключения могут также повлиять другие факторы:

* управление трафиком на стороне назначения;
- ограничение скорости API, накладываемое со стороны места назначения;
- устранение рисков объемных атак DDoS или формирование трафика транспортного уровня;
* брандмауэр или другие компоненты в месте назначения. 

Обычно, чтобы установить, что происходит, требуется захват пакетов в источнике и (если возможно) месте назначения.

_**Решение**_

* Проверьте, нет ли [нехватки SNAT](#snat-exhaustion). 
* Для сравнения проверьте подключение к конечной точке в том же регионе или в другом месте.  
* Если вы создаете большой объем или тестируете скорость транзакций, проверьте, уменьшится ли частота возникновения сбоев, если снизить скорость.
* Если скорость влияет на частоту сбоев, проверьте, не достигнуты ли предельные значения скорости API и не превышены ли иные ограничения на стороне назначения.
* Если по результатам исследования не удалось прийти к окончательному заключению, отправьте запрос в службу поддержки для дальнейшего устранения неполадок.

#### <a name="tcp-resets-received"></a>Полученные сбросы TCP

Если на исходной виртуальной машине наблюдаются сбросы TCP (TCP-пакеты RST), они могут быть созданы шлюзом NAT на частной стороне для потоков, не распознанных как выполняющиеся.  Одна из возможных причин — превышение времени ожидания в состоянии бездействия для подключения TCP.  Время ожидания при бездействии можно настроить в пределах от 4 до 120 минут.

Сбросы TCP не создаются на общедоступной стороне ресурсов шлюза NAT. Если на стороне назначения наблюдаются сбросы TCP, они создаются стеком исходной виртуальной машины, а не ресурсом шлюза NAT.

_**Решение:**_

* Ознакомьтесь с рекомендациями по созданию [конструктивных шаблонов](#design-patterns).  
* При необходимости отправьте запрос в службу поддержки для дальнейшего устранения неполадок.

### <a name="ipv6-coexistence"></a>Совместная работа c IPv6

[NAT виртуальной сети](nat-overview.md) поддерживает протоколы UDP и TCP через IPv4, а развертывание в [подсети с префиксом IPv6 не поддерживается](nat-overview.md#limitations).

_**Решение:**_ Разверните шлюз NAT в подсети без префикса IPv6.

Вы можете сообщить о заинтересованности в дополнительных возможностях с помощью [UserVoice для NAT виртуальной сети](https://aka.ms/natuservoice).

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о [NAT виртуальной сети](nat-overview.md).
* Дополнительные сведения о [ресурсе шлюза NAT](nat-gateway-resource.md).
* Дополнительные сведения о [метриках и оповещениях для ресурсов шлюза NAT](nat-metrics.md).
* [Расскажите в UserVoice, что нам следует создать далее для NAT виртуальной сети](https://aka.ms/natuservoice).

