---
title: Учебник. Ограничение доступа к ресурсам PaaS с помощью портала Azure
description: В этом руководстве описано, как ограничить сетевой доступ к ресурсам Azure, таким как служба хранилища Azure и База данных SQL Azure, с помощью конечных точек служб для виртуальной сети и портала Azure.
services: virtual-network
documentationcenter: virtual-network
author: KumudD
manager: mtillman
editor: ''
tags: azure-resource-manager
Customer intent: I want only resources in a virtual network subnet to access an Azure PaaS resource, such as an Azure Storage account.
ms.assetid: ''
ms.service: virtual-network
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: virtual-network
ms.workload: infrastructure
ms.date: 08/23/2018
ms.author: kumud
ms.openlocfilehash: 85fc5687b82947ed16bde0c30ca2b947514ba958
ms.sourcegitcommit: 0947111b263015136bca0e6ec5a8c570b3f700ff
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2020
ms.locfileid: "74186373"
---
# <a name="tutorial-restrict-network-access-to-paas-resources-with-virtual-network-service-endpoints-using-the-azure-portal"></a>Руководство. Ограничение сетевого доступа к ресурсам PaaS с помощью конечных точек служб для виртуальной сети и портала Azure

Конечные точки служб для виртуальной сети позволяют ограничить сетевой доступ к некоторым ресурсам службы Azure определенной подсетью виртуальной сети. Можно также запретить доступ к ресурсам через Интернет. Конечные точки службы предоставляют прямое подключение из виртуальной сети к поддерживаемым службам Azure. Это позволяет использовать закрытый диапазон адресов виртуальной сети для доступа к службам Azure. Трафик, поступающий к ресурсам Azure через конечные точки службы, всегда остается в магистральной сети Microsoft Azure. В этом руководстве описано следующее.

> [!div class="checklist"]
> * Создание виртуальной сети с одной подсетью.
> * Добавление подсети и включение конечной точки службы.
> * Создание ресурса Azure и разрешение сетевого доступа к нему только из подсети.
> * Развертывание виртуальной машины в каждой подсети.
> * Подтверждение прав доступа к ресурсу из подсети.
> * Подтверждение запрета доступа к ресурсу из подсети и Интернета.

При необходимости инструкции из этого руководства можно выполнить с помощью [Azure CLI](tutorial-restrict-network-access-to-resources-cli.md) или [Azure PowerShell](tutorial-restrict-network-access-to-resources-powershell.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="log-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу https://portal.azure.com.

## <a name="create-a-virtual-network"></a>Создание виртуальной сети

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Щелкните **Сеть** и выберите **Виртуальная сеть**.
3. Выберите или введите следующие сведения, а затем щелкните **Создать**.

   |Параметр|Значение|
   |----|----|
   |Имя| myVirtualNetwork |
   |Пространство адресов| 10.0.0.0/16|
   |Subscription| Выберите свою подписку.|
   |группа ресурсов. | Выберите **Создать новую**, а затем введите *myResourceGroup*.|
   |Location| Выберите **Восточная часть США**. |
   |Имя подсети| Общедоступные|
   |Диапазон адресов подсети| 10.0.0.0/24|
   |Защита от атак DDoS| Basic|
   |Конечные точки служб| Выключено|
   |Брандмауэр| Выключено|

   ![Ввод основных сведений о виртуальной сети](./media/tutorial-restrict-network-access-to-resources/create-virtual-network.png)

## <a name="enable-a-service-endpoint"></a>Включение конечной точки службы

Конечные точки службы включены для каждой службы, для каждой подсети. Создайте подсеть и включите конечную точку службы для подсети.

1. В поле **Search resources, services, and docs** (Поиск ресурсов, служб и документов) в верхней части портала введите *myVirtualNetwork*. Когда в результатах поиска появится пункт **myVirtualNetwork**, выберите его.
2. Добавьте подсеть в виртуальную сеть. В разделе **Параметры** выберите  **Подсети**, а затем — **+ Подсеть**, как показано на следующем рисунке.

    ![Добавление подсети](./media/tutorial-restrict-network-access-to-resources/add-subnet.png) 

3. В разделе **Добавление подсети** выберите или введите следующие сведения, а затем нажмите кнопку **ОК**.

    |Параметр|Значение|
    |----|----|
    |Имя| Private |
    |Диапазон адресов| 10.0.1.0/24|
    |Конечные точки служб| Выберите **Microsoft.Storage** в разделе **Службы**.|

> [!CAUTION]
> Перед включением конечной точки службы для существующей подсети, которая содержит ресурсы, см. раздел [Изменение параметров подсети](virtual-network-manage-subnet.md#change-subnet-settings).

## <a name="restrict-network-access-for-a-subnet"></a>Ограничение сетевого доступа для подсети

По умолчанию все виртуальные машины в подсети могут обмениваться данными со всеми ресурсами. Вы можете ограничить обмен данными со всеми ресурсами в подсети, создав группу безопасности сети и связав ее с подсетью.

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Выберите **Сеть**, а затем — **Группа безопасности сети**.
3. В разделе **Создание группы безопасности сети** выберите или введите приведенные ниже сведения, а затем щелкните **Создать**.

    |Параметр|Значение|
    |----|----|
    |Имя| myNsgPrivate |
    |Subscription| Выберите свою подписку.|
    |группа ресурсов. | Щелкните **Использовать существующую** и выберите *myResourceGroup*.|
    |Location| Выберите **Восточная часть США**. |

4. После создания группы безопасности сети введите *myNsgPrivate* в поле **Search resources, services, and docs** (Поиск ресурсов, служб и документов) в верхней части портала. При появлении **myNsgPrivate** в результатах поиска выберите этот пункт.
5. В разделе **Параметры** выберите **Правила безопасности для исходящего трафика**.
6. Щелкните **+ Добавить**.
7. Создайте правило, разрешающее исходящий обмен данными в службе хранилища Azure. Выберите или введите следующие сведения, а затем нажмите кнопку **Добавить**:

    |Параметр|Значение|
    |----|----|
    |Источник| Выберите **VirtualNetwork** (Виртуальная сеть). |
    |Диапазоны исходных портов| * |
    |Назначение | Выберите **Service Tag** (Тег службы).|
    |Тег целевой службы | Выберите **Хранилище**.|
    |Диапазоны портов назначения| * |
    |Протокол|Любой|
    |Действие|Allow|
    |Приоритет|100|
    |Имя|Allow-Storage-All|

8. Создайте другое правило безопасности, которое запрещает исходящие подключения через Интернет. Это правило переопределяет правило по умолчанию во всех группах безопасности сети, которое позволяет исходящую связь через Интернет. Выполните шаги 5–7 еще раз, указав следующие значения:

    |Параметр|Значение|
    |----|----|
    |Источник| Выберите **VirtualNetwork** (Виртуальная сеть). |
    |Диапазоны исходных портов| * |
    |Назначение | Выберите **Service Tag** (Тег службы).|
    |Тег целевой службы| Выберите **Интернет**.|
    |Диапазоны портов назначения| * |
    |Протокол|Любой|
    |Действие|Запрет|
    |Приоритет|110|
    |Имя|Deny-Internet-All|

9. В разделе **Параметры** выберите **Правила безопасности для входящего трафика**.
10. Щелкните **+ Добавить**.
11. Создайте правило безопасности, которое разрешает для подсети входящий трафик протокола удаленного рабочего стола (RDP), поступающий из любого расположения. Это правило переопределяет правило безопасности по умолчанию, запрещающее весь входящий трафик из Интернета. Подключения к удаленному рабочему столу в подсети разрешены, чтобы позже можно было проверить подключение. В разделе **Параметры** выберите **Правила безопасности для входящего трафика**, щелкните **+Добавить**, введите следующие значения и нажмите кнопку **Добавить**:

    |Параметр|Значение|
    |----|----|
    |Источник| Любой |
    |Диапазоны исходных портов| * |
    |Назначение | Выберите **VirtualNetwork** (Виртуальная сеть).|
    |Диапазоны портов назначения| 3389 |
    |Протокол|Любой|
    |Действие|Allow|
    |Приоритет|120|
    |Имя|Allow-RDP-All|

12. В разделе **Параметры** выберите **Subnets** (Подсети).
13. Выберите **+ Associate** (+ Связать).
14. В разделе **Связать подсеть** выберите **Виртуальная сеть**, а затем в разделе **Выбор виртуальной сети** выберите **myVirtualNetwork**.
15. В разделе **Выбор подсети** выберите **Private**, затем нажмите кнопку **ОК**.

## <a name="restrict-network-access-to-a-resource"></a>Ограничение сетевого доступа к ресурсу

Действия, необходимые для ограничения сетевого доступа к ресурсам, созданным с помощью служб Azure, использующих конечные точки службы, отличаются в зависимости службы. Ознакомьтесь с документацией по отдельным службам, чтобы получить точные инструкции для них. В оставшейся части этого руководства в качестве примера приведены инструкции по ограничению сетевого доступа для учетной записи хранения Azure.

### <a name="create-a-storage-account"></a>Создание учетной записи хранения

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Выберите **Хранилище**, а затем выберите **Учетная запись хранения — BLOB-объект, файл, таблица, очередь**.
3. Введите или выберите приведенные ниже сведения, примите значения по умолчанию для остальных параметров и щелкните **Создать**.

    |Параметр|Значение|
    |----|----|
    |Имя| Введите имя, которое является уникальным для всех расположений Azure, содержащим только цифры и строчные буквы (длиной от 3 до 24 знаков).|
    |Тип учетной записи|StorageV2 (учетная запись общего назначения версии 2)|
    |Location| Выберите **Восточная часть США**. |
    |Репликация| Локально избыточное хранилище (LRS)|
    |Subscription| Выберите свою подписку.|
    |группа ресурсов. | Щелкните **Использовать существующую** и выберите *myResourceGroup*.|

### <a name="create-a-file-share-in-the-storage-account"></a>Создание файлового ресурса в учетной записи хранения

1. После создания учетной записи хранения введите ее имя в поле **Поиск ресурсов, служб и документов** в верхней части портала. Когда имя учетной записи отобразится в результатах поиска, выберите его.
2. Щелкните **Файлы**, как показано на следующем рисунке.

   ![Учетная запись хранения](./media/tutorial-restrict-network-access-to-resources/storage-account.png) 

3. Выберите **+Файловый ресурс**.
4. Введите *my-file-share* в поле **Имя** и нажмите кнопку **ОК**.
5. Закройте окно **Служба файлов**.

### <a name="restrict-network-access-to-a-subnet"></a>Ограничение сетевого доступа к подсети

По умолчанию учетные записи хранения принимают сетевые подключения от клиентов из любой сети, включая Интернет. Запретите сетевой доступ из Интернета и всех других подсетей во всех виртуальных сетях, за исключением подсети *Private* в виртуальной сети *myVirtualNetwork*.

1. В разделе **Параметры** учетной записи хранения выберите **Firewalls and virtual networks** (Брандмауэры и виртуальные сети).
2. Выберите **Выбранные сети**.
3. Выберите **+Добавить существующую виртуальную сеть**.
4. В разделе **Добавить сети** укажите приведенные ниже значения, а затем щелкните **Добавить**.

    |Параметр|Значение|
    |----|----|
    |Subscription| Выберите свою подписку.|
    |Виртуальные сети|В разделе **Виртуальные сети** выберите **myVirtualNetwork**.|
    |Подсети| В разделе **Подсети** выберите **Private**.|

    ![Брандмауэры и виртуальные сети](./media/tutorial-restrict-network-access-to-resources/storage-firewalls-and-virtual-networks.png)

5. Щелкните **Сохранить**.
6. Закройте окно **Firewalls and virtual networks** (Брандмауэры и виртуальные сети).
7. В разделе **Параметры** учетной записи хранения выберите **Ключи доступа**, как показано на следующем рисунке.

      ![Брандмауэры и виртуальные сети](./media/tutorial-restrict-network-access-to-resources/storage-access-key.png)

8. Запишите значение **Ключ**, так как позже его потребуется ввести вручную при подключении файлового ресурса как диска на виртуальной машине.

## <a name="create-virtual-machines"></a>Создание виртуальных машин

Чтобы проверить сетевой доступ к учетной записи хранения, разверните виртуальную машину в каждой подсети.

### <a name="create-the-first-virtual-machine"></a>Создание первой виртуальной машины

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Выберите **Вычисления**, а затем — **Windows Server 2016 Datacenter**.
3. Выберите или введите следующие сведения, а затем нажмите кнопку **ОК**:

   |Параметр|Значение|
   |----|----|
   |Имя| myVmPublic|
   |Имя пользователя|Введите выбранное имя пользователя.|
   |Пароль| Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
   |Subscription| Выберите свою подписку.|
   |группа ресурсов.| Щелкните **Использовать существующую** и выберите **myResourceGroup**.|
   |Location| Выберите **Восточная часть США**.|

   ![Ввод базовых сведений о виртуальной машине](./media/tutorial-restrict-network-access-to-resources/virtual-machine-basics.png)
4. Выберите размер виртуальной машины и щелкните **Выбрать**.
5. В разделе **Параметры** выберите **Сеть**, а затем выберите **myVirtualNetwork**. Выберите **Подсети**, а затем выберите **Public**, как показано на следующем рисунке.

   ![Выбор виртуальной сети](./media/tutorial-restrict-network-access-to-resources/virtual-machine-settings.png)

6. В разделе **Группы безопасности сети** выберите **Дополнительно**. Портал автоматически создаст группу безопасности сети, которая открывает порт 3389. Это требуется для подключения к виртуальной машине на следующем шаге. Щелкните **ОК** на странице **Параметры**.
7. На странице **Сводка** выберите **Создать**, чтобы начать развертывание виртуальной машины. Развертывание виртуальной машины займет несколько минут, но вы можете перейти к следующему шагу, пока создается виртуальная машина.

### <a name="create-the-second-virtual-machine"></a>Создание второй виртуальной машины

Повторите шаги 1–7, но на шаге 3 назовите виртуальную машину *myVmPrivate*, а на шаге 5 выберите подсеть **Private**.

Развертывание виртуальной машины занимает несколько минут. Не переходите к следующему шагу, пока не завершится создание виртуальной машины и ее параметры не отобразятся на портале.

## <a name="confirm-access-to-storage-account"></a>Подтверждение прав доступа к учетной записи хранения

1. Когда создание виртуальной машины *myVmPrivate* завершится, Azure отобразит ее параметры. Подключитесь к этой виртуальной машине, нажав кнопку **Подключиться**, как показано на следующем рисунке.

   ![Подключение к виртуальной машине](./media/tutorial-restrict-network-access-to-resources/connect-to-virtual-machine.png)

2. После нажатия кнопки **Подключиться** создается файл протокола удаленного рабочего стола (RDP-файл), который скачивается на ваш компьютер.  
3. Откройте этот RDP-файл. При появлении запроса выберите **Подключиться**. Введите имя пользователя и пароль, указанные при создании виртуальной машины. Возможно, потребуется выбрать **More choices** (Дополнительные варианты), а затем **Use a different account** (Использовать другую учетную запись), чтобы указать учетные данные, введенные при создании виртуальной машины. 
4. Нажмите кнопку **ОК**.
5. При входе в систему может появиться предупреждение о сертификате. Если вы получили предупреждение, выберите **Да** или **Продолжить**.
6. На виртуальной машине *myVmPrivate* с помощью PowerShell подключите файловый ресурс Azure как диск Z. Перед выполнением следующих команд замените `<storage-account-key>` и `<storage-account-name>` собственными значениями или значениями, полученными при [создании учетной записи хранения](#create-a-storage-account).

   ```powershell
   $acctKey = ConvertTo-SecureString -String "<storage-account-key>" -AsPlainText -Force
   $credential = New-Object System.Management.Automation.PSCredential -ArgumentList "Azure\<storage-account-name>", $acctKey
   New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<storage-account-name>.file.core.windows.net\my-file-share" -Credential $credential
   ```

   PowerShell вернет выходные данные, как в следующем примере.

   ```powershell
   Name           Used (GB)     Free (GB) Provider      Root
   ----           ---------     --------- --------      ----
   Z                                      FileSystem    \\vnt.file.core.windows.net\my-f...
   ```

   Файловый ресурс Azure успешно подключен как диск Z.

7. С помощью командной строки убедитесь, что виртуальная машина запрещает исходящие подключения в Интернете:

   ```
   ping bing.com
   ```

   Ответы не отобразятся, так как группа безопасности сети, связанная с подсетью *Private*, запрещает исходящий доступ к Интернету.

8. Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmPrivate*.

## <a name="confirm-access-is-denied-to-storage-account"></a>Подтверждение запрета доступа к учетной записи хранения

1. В поле *Search resources, services, and docs* (Поиск ресурсов, служб и документов) в верхней части портала введите **myVmPublic**.
2. При появлении пункта **myVmPublic** в результатах поиска выберите его.
3. Выполните шаги 1–6 из подраздела [Подтверждение прав доступа к учетной записи хранения](#confirm-access-to-storage-account) для виртуальной машины *myVmPublic*.

   После короткого ожидания отобразится ошибка `New-PSDrive : Access is denied`. В доступе будет отказано, так как виртуальная машина *myVmPublic* развернута в подсети *Public*. Подсеть *Public* не поддерживает конечную точку службы для службы хранилища Azure. Учетная запись хранения разрешает доступ к сети только из подсети *Private*, но не из подсети *Public*.

4. Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmPublic*.

5. На своем компьютере перейдите на [портал](https://portal.azure.com) Azure.
6. Введите имя созданной учетной записи хранения в поле **Search resources, services, and docs** (Поиск ресурсов, служб и документов). Когда имя учетной записи отобразится в результатах поиска, выберите его.
7. Выберите **Файлы**.
8. Появится сообщение об ошибке, как показано на следующем рисунке.

   ![Доступ запрещен](./media/tutorial-restrict-network-access-to-resources/access-denied-error.png)

   Доступ запрещен, так как ваш компьютер не находится в подсети *Private* виртуальной сети *MyVirtualNetwork*.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов и все содержащиеся в ней ресурсы, когда она станет не нужна.

1. В поле **Поиск** в верхней части портала введите *myResourceGroup*. Когда группа ресурсов **myResourceGroup** появится в результатах поиска, выберите ее.
2. Выберите **Удалить группу ресурсов**.
3. Введите *myResourceGroup* в поле **TYPE THE RESOURCE GROUP NAME:** (Введите имя группы ресурсов:) и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы включили конечную точку службы для подсети виртуальной сети. Вы узнали, что конечные точки службы можно включать для ресурсов, развернутых несколькими службами Azure. Вы создали учетную запись хранения Azure и ограничили сетевой доступ к учетной записи хранения ресурсами одной подсети в виртуальной сети. См. дополнительные сведения о [конечных точках службы](virtual-network-service-endpoints-overview.md) и [управляемых подсетях](virtual-network-manage-subnet.md).

Если в вашей учетной записи имеется несколько виртуальных сетей, можно соединить две виртуальные сети, чтобы ресурсы в каждой из них могли взаимодействовать друг с другом. Перейдите к следующему руководству, чтобы научиться подключать виртуальные сети.

> [!div class="nextstepaction"]
> [Подключение виртуальных сетей](./tutorial-connect-virtual-networks-portal.md)
