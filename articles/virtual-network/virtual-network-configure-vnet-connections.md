---
title: Настройка и проверка VPN-подключений и подключений между виртуальными сетями
description: Пошаговое руководство по настройке и проверке различных развертываний VPN и виртуальной сети Azure
services: virtual-network
documentationcenter: na
author: v-miegge
manager: dcscontentpm
editor: ''
ms.assetid: 0433a4f4-b5a0-476d-b398-1506c57eafa2
ms.service: virtual-network
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/28/2019
ms.author: kaushika
ms.openlocfilehash: fc4b649ce8d082d8d854c4c19b617c088ff3141c
ms.sourcegitcommit: 3e7646d60e0f3d68e4eff246b3c17711fb41eeda
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2019
ms.locfileid: "70901897"
---
# <a name="configure-and-validate-vnet-or-vpn-connections"></a>Настройка и проверка VPN-подключений и подключений между виртуальными сетями

В этом пошаговом руководстве содержатся пошаговые инструкции по настройке и проверке различных развертываний VPN и виртуальных сетей Azure в таких сценариях, как транзитная маршрутизация, подключение между виртуальными сетями, BGP, несколько сайтов, подключение типа "точка — сеть" и т. д.

VPN-шлюзы Azure обеспечивают гибкость при размещении почти любой разновидности топологии виртуальных сетей (VNet) в Azure. Вы можете подключать виртуальных сетей между регионами, между типами виртуальной сети (Azure Resource Manager и Классическая модель), в Azure или с локальной гибридной средой, в разных подписках и т. д. 

## <a name="scenario-1-vnet-to-vnet-vpn-connection"></a>Сценарий 1. VPN-подключение между виртуальными сетями

Подключение виртуальной сети к другой виртуальной сети (VNet-to-VNet) через VPN аналогично подключению к локальному расположению сайта. Оба типа подключения используют VPN-шлюз для обеспечения защищенного туннеля с помощью **IPSec/IKE**. Виртуальные сети могут относиться к одному или разным регионам и к одной или разным подпискам.

![ЭСКИЗ](./media/virtual-network-configure-vnet-connections/4034386_en_2.png)
 
Рис. 1. Виртуальная сеть-виртуальная сеть с IPsec

Если виртуальных сетей находятся в одном регионе, вы можете рассмотреть возможность их подключения с помощью пиринга виртуальных сетей, который не использует VPN-шлюз, увеличивает пропускную способность и сокращает задержку, выберите **настроить и проверить пиринг виртуальной** сети, чтобы настроить пиринг виртуальных сетей. соединен.

Если виртуальных сетей созданы с помощью модели развертывания диспетчера ресурсов Azure, выберите **настроить и проверить диспетчер ресурсов виртуальную сеть для подключения к Диспетчер ресурсов виртуальной сети** , чтобы настроить VPN-подключение.

Если одна из виртуальных сетей создается с помощью классической модели развертывания Azure, она создается диспетчер ресурсов, выберите **настроить и проверить классическую виртуальную сеть диспетчер ресурсов подключение к виртуальной сети** для настройки VPN-подключения.

### <a name="configuration-1-configure-vnet-peering-for-two-vnets-in-the-same-region"></a>Конфигурация 1: Настройка пиринга виртуальной сети для двух виртуальных сетей в одном регионе

Прежде чем приступить к реализации пиринга Azure VNet, убедитесь, что выполнены следующие предварительные требования для настройки пиринга в виртуальной сети.

* Пиринговые виртуальные сети должны находиться в одном регионе Azure.
* Одноранговые виртуальные сети должны иметь неперекрывающиеся пространства IP-адресов.
* Пиринговая связь устанавливается между двумя виртуальными сетями. Между одноранговыми узлами нет производной промежуточной связи. Например, если для виртуальной сети A установлена пиринговая связь с виртуальной сетью В, а для виртуальной сети В — с виртуальной сетью С, эта связь *не* преобразуется в пиринговую связь между сетями A и С.

При соблюдении требований можно следовать инструкциям в статье [Создание пиринга виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-create-peering) для создания и настройки пиринга виртуальных сетей.

Чтобы проверить конфигурацию пиринга виртуальной сети, используйте следующие методы.

1. Войдите в [портал Azure](https://portal.azure.com/) с помощью учетной записи, обладающей необходимыми [ролями и разрешениями](https://docs.microsoft.com/azure/virtual-network/virtual-network-manage-peering#roles-permissions).
2. В верхней части портала Azure в поле с текстом *Поиск ресурсов* введите *виртуальные сети*. Когда в результатах поиска появится пункт **Виртуальные машины**, щелкните его.
3. В появившейся колонке **Виртуальные сети** щелкните виртуальную сеть, для которой нужно создать пиринг.
4. В области, которая отображается для выбранной виртуальной сети, щелкните **узлы** в разделе **Параметры** .
5. Щелкните пиринг, для которого нужно проверить конфигурацию.

![ЭСКИЗ](./media/virtual-network-configure-vnet-connections/4034496_en_1.png)
 
С помощью Azure PowerShell выполните команду [Get-azurermvirtualnetworkpeering —](https://docs.microsoft.com/powershell/module/azurerm.network/get-azurermvirtualnetworkpeering?view=azurermps-4.1.0) , чтобы получить пиринг виртуальной сети, например:

```
PS C:\Users\User1> Get-AzureRmVirtualNetworkPeering -VirtualNetworkName Vnet10-01 -ResourceGroupName dev-vnets
Name                             : LinkToVNET10-02
Id                               : /subscriptions/GUID/resourceGroups/dev-vnets/providers/Microsoft.Network/virtualNetworks/VNET10-01/virtualNetworkPeerings/LinkToVNET10-0
2
Etag                             : W/"GUID"
ResourceGroupName                : dev-vnets
VirtualNetworkName               : vnet10-01
ProvisioningState                : Succeeded
RemoteVirtualNetwork             : {
                                  "Id": "/subscriptions/GUID/resourceGroups/DEV-VNET
                                   s/providers/Microsoft.Network/virtualNetworks/VNET10-02"
                                   }
AllowVirtualNetworkAccess        : True
AllowForwardedTraffic            : False
AllowGatewayTransit              : False
UseRemoteGateways                : False
RemoteGateways                   : null
RemoteVirtualNetworkAddressSpace : null
```

### <a name="connection-type-1-connect-a-resource-manager-vnet-to-anther-resource-manager-vnet-azure-resource-manager-to-azure-resource-manager"></a>Тип подключения 1: Подключение диспетчер ресурсовной виртуальной сети к виртуальной сети диспетчер ресурсов другом (Azure Resource Manager для Azure Resource Manager)

Вы можете настроить подключение из одной диспетчер ресурсов виртуальной сети к другой диспетчер ресурсов виртуальной сети напрямую или настроить подключение по протоколу IPsec.

### <a name="configuration-2-configure-vpn-connection-between-resource-manager-vnets"></a>Конфигурация 2: Настройка VPN-подключения между диспетчер ресурсов виртуальных сетей

Сведения о настройке подключения между диспетчер ресурсов виртуальных сетей без IPsec см. [в статье Настройка подключения VPN-шлюза между виртуальными сетями с помощью портал Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal).

Чтобы настроить подключение по протоколу IPsec между двумя диспетчер ресурсов виртуальных сетей, выполните шаги 1-5 в разделе [Создание подключения типа "сеть — сеть" в портал Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal) для каждой виртуальной сети.

> [!Note]
> Эти действия выполняются только для виртуальных сетей в одной подписке. Если виртуальные сети связаны с разными подписками, для подключения необходимо использовать PowerShell. См. статью, посвященную использованию [PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-vnet-vnet-rm-ps).

### <a name="validate-vpn-connection-between-resource-manager-vnets"></a>Проверка VPN-подключения между диспетчер ресурсов виртуальных сетей

![ЭСКИЗ](./media/virtual-network-configure-vnet-connections/4034493_en_2.png)

Рис. 4. Подключение классической виртуальной сети к Azure Resource Manager виртуальной сети

Чтобы проверить, правильно ли настроено VPN-подключение, следуйте инструкциям:

> [!Note]
> Число после компонентов виртуальной сети, например "vnet 1", в приведенных ниже шагах соответствует числам на рис. 4.

1. Проверьте перекрывающиеся адресные пространства в подключенном виртуальных сетей.

   > [!Note]
   > В vnet 1 и vnet 6 не должно быть перекрывающихся адресных пространств. 

2. Убедитесь, что диапазон адресов Azure Resource Manager vnet 1 точно определен в **объекте Connection** 4.
3. Убедитесь, что диапазон адресов Azure Resource Manager vnet 6 точно определен в **объекте Connection** 3.
4. Убедитесь, что предварительные ключи совпадают с объектами соединения 3 и 4.
5. Убедитесь, что виртуальный IP-адрес шлюза Azure Resource Manager vnet 2 точно определен в **объекте подключения** 4.
6. Убедитесь, что виртуальный IP-адрес шлюза Azure Resource Manager vnet 5 определен точно в **объекте Connection** 3.

### <a name="connection-type-2-connect-a-classic-vnet-to-a-resource-manager-vnet"></a>Тип соединения 2: Подключение классической виртуальной сети к диспетчеру ресурсов виртуальной сети

Подключение можно создать между виртуальными сетями, которые находятся в разных подписках и разных регионах. Вы также можете подключить виртуальных сетей, которые уже имеют подключения к локальным сетям, если тип шлюза настроен как на основе маршрутов.

Дополнительные сведения о настройке подключения между классической виртуальной сетью и диспетчер ресурсов VNet см. [в статье подключение виртуальных сетей из разных моделей развертывания с помощью портал Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-connect-different-deployment-models-portal) .

![ЭСКИЗ](./media/virtual-network-configure-vnet-connections/4034389_en_2.png)

Рис. 5. Подключение классической виртуальной сети к Azure Resource Manager виртуальной сети

Чтобы проверить конфигурацию при подключении классической виртуальной сети к Azure Resource Manager виртуальной сети, следуйте инструкциям:

> [!Note]
> Число после компонентов виртуальной сети, например "vnet 1" в приведенных ниже шагах, соответствует числам на рис. 5.

1. Проверьте перекрывающиеся адресные пространства в подключенном виртуальных сетей.

   > [!Note]
   > Не допускается перекрытие адресных пространств в vnet 1 и vnet 6

2. Убедитесь, что диапазон адресов Azure Resource Manager VNet 6 точно определен в классическом определении локальной сети 3.
3. Убедитесь, что классический диапазон адресов виртуальной сети 1 точно определен в **объекте подключения** Azure Resource Manager 4.
4. Убедитесь, что виртуальный IP-адрес классического шлюза виртуальной сети 2 точно определен в **объекте подключения** Azure Resource Manager 4.
5. Убедитесь, что виртуальный IP-адрес шлюза Azure Resource Manager VNet 5 точно определен в классической **локальной сети с определением** 3.
6. Убедитесь, что предварительные ключи совпадают с подключенными виртуальных сетей:
   1. Классическая виртуальная сеть — определение локальной сети 3
   2. Azure Resource Manager vnet — объект подключения 4

## <a name="scenario-2-point-to-site-vpn-connection"></a>Сценарий 2. VPN-подключение типа "точка — сеть"

Конфигурация типа "точка — сеть" позволяет создать безопасное подключение к виртуальной сети с отдельного клиентского компьютера. Это эффективное решение для подключений типа "точка — сеть" к виртуальной сети из удаленного расположения, например, если вы находитесь дома или на конференции, или если подключение к виртуальной сети требуется всего нескольким клиентам. VPN-подключение типа "точка — сеть" инициируется клиентским компьютером с помощью собственного VPN-клиента Windows. Для проверки подлинности подключений клиентов используются сертификаты.

![ЭСКИЗ](./media/virtual-network-configure-vnet-connections/4034387_en_3.png)

Рис. 2. подключение "точка — сеть"

Для подключений типа "точка — сеть" не требуется VPN-устройство. Подключение типа "точка — сеть" — это VPN-подключение по протоколу SSTP (Secure Socket Tunneling Protocol). Подключение типа "точка — сеть" к виртуальной сети можно подключить с помощью различных средств развертывания и моделей развертывания.

* [Настройка подключения типа "точка — сеть" к виртуальной сети с помощью портала Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal)
* [Настройка подключения типа "точка — сеть" к виртуальной сети с помощью портал Azure (классическая модель)](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-classic-azure-portal)
* [Настройка подключения типа "точка — сеть" к виртуальной сети с помощью PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-rm-ps)

### <a name="validate-your-point-to-site-connections"></a>Проверка подключений "точка — сеть"

Устранение [неполадок в статье: Проблемы](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-troubleshoot-vpn-point-to-site-connection-problems) с подключением "точка — сеть" в Azure проходят через общие проблемы с подключением "точка — сеть".

## <a name="scenario-3-multi-site-vpn-connection"></a>Сценарий 3. VPN-подключение с несколькими сайтами

Вы можете добавить подключение типа "сеть — сеть" (S2S) к виртуальной сети, в которой уже есть подключение типа S2S, подключение типа "точка — сеть" или подключение между виртуальными сетями. Этот тип подключения часто называется конфигурацией с **несколькими сайтами** . 

![ЭСКИЗ](./media/virtual-network-configure-vnet-connections/4034497_en_2.png)

Рис. 3. подключение к нескольким сайтам

В настоящее время Azure работает с двумя моделями развертывания: Диспетчер ресурсов и Classic. Эти две модели не полностью совместимы друг с другом. Чтобы настроить **многосайтовое** подключение с разными моделями, ознакомьтесь со следующими статьями:

* [Добавление подключения типа "сеть — сеть" в виртуальную сеть с существующим VPN-шлюзом](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-multi-site-to-site-resource-manager-portal)
* [Добавление подключения типа "сеть — сеть" к виртуальной сети с использованием существующего подключения VPN-шлюза (классическая модель)](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-multi-site)

> [!Note]
> Эти действия не применяются к конфигурациям подключений ExpressRoute и "сеть — сеть". Дополнительные сведения о сосуществующих подключениях см. в разделе [сосуществующие соединения ExpressRoute/S2S](https://docs.microsoft.com/azure/expressroute/expressroute-howto-coexist-resource-manager).

## <a name="scenario-4-configure-transit-routing"></a>Сценарий 4. Настройка транзитной маршрутизации

Транзитная маршрутизация — это конкретный сценарий маршрутизации, при котором несколько сетей можно подключить к топологии "последовательной цепочки". Эта маршрутизация позволяет ресурсам в виртуальных сетей с любого конца цепочки взаимодействовать друг с другом через виртуальных сетей. Без транзитивных маршрутизации сети или устройства, которые были соединены через концентратор, не могут подключиться друг к другу.

### <a name="configuration-1-configure-transit-routing-in-a-point-to-site-connection"></a>Конфигурация 1: Настройка транзитной маршрутизации в подключении типа "точка — сеть"

В этом сценарии вы настраиваете VPN-подключение типа "сеть — сеть" между VNetA и VNetB, а также настраиваете VPN типа "точка — сеть" для подключения клиента к шлюзу VNetA. Затем необходимо включить транзитную маршрутизацию для клиентов "точка — сеть", чтобы подключиться к VNetB, который проходит через VNetA. Этот сценарий поддерживается при включении BGP для VPN типа "сеть-сеть" между VNetA и VNetB. Дополнительные сведения см. в статье [о маршрутизации VPN типа "точка — сеть](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-point-to-site-routing)".

### <a name="configuration-2-configure-transit-routing-in-an-expressroute-connection"></a>Конфигурация 2: Настройка транзитной маршрутизации в подключении ExpressRoute

Microsoft Azure ExpressRoute позволяет переносить локальные сети в облако Microsoft по выделенному закрытому соединению, которое обеспечивается поставщиком услуг подключения. ExpressRoute позволяет устанавливать подключения к облачным службам Майкрософт, таким как Microsoft Azure, Office 365 и Dynamics 365.  Дополнительные сведения см. в статье [Обзор ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-introduction).

![ЭСКИЗ](./media/virtual-network-configure-vnet-connections/4034395_en_1.png)

Рис. 6. подключение частного пиринга ExpressRoute к Azure виртуальных сетей

> [!Note]
> Рекомендуется, чтобы если VNetA и VNetB находятся в одном регионе с геостатусом, который [связывает виртуальных сетей с каналом ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-howto-linkvnet-arm) вместо настройки транзитной маршрутизации. Если виртуальных сетей находятся в разных регионах, вы также можете связать их с каналом напрямую, если у вас есть [ExpressRoute Premium](https://docs.microsoft.com/azure/expressroute/expressroute-faqs#expressroute-premium). 

Если у вас есть ExpressRoute и сосуществование между сайтами, транзитная маршрутизация не поддерживается. Дополнительные сведения см. в статье Настройка параллельных [подключений ExpressRoute и подключения "сеть — сеть](https://docs.microsoft.com/azure/expressroute/expressroute-howto-coexist-resource-manager)".

Если вы включили ExpressRoute для подключения локальных сетей к виртуальной сети Azure, можно включить пиринг между виртуальными сетями между виртуальных сетей, для которых требуется транзитная маршрутизация. Чтобы разрешить локальным сетям подключение к удаленной виртуальной сети, необходимо настроить [пиринг виртуальных сетей](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview#gateways-and-on-premises-connectivity). 

> [!Note]
> Пиринг виртуальной сети доступен только для виртуальных сетей в том же регионе.

Чтобы проверить, настроен ли транзитный маршрут для пиринга виртуальной сети, следуйте инструкциям:

1. Войдите в [портал Azure](https://portal.azure.com/) с помощью учетной записи, обладающей необходимыми [ролями и разрешениями](https://docs.microsoft.com/azure/virtual-network/virtual-network-manage-peering#roles-permissions).
2. [Создайте пиринг между виртуальной сетью a и B](https://docs.microsoft.com/azure/virtual-network/virtual-network-create-peering) , как показано на схеме выше (рис. 6). 
3. В области, которая отображается для выбранной виртуальной сети, щелкните **узлы** в разделе **Параметры** .
4. Щелкните пиринг, который нужно просмотреть и **настроить** , чтобы проверить, включен ли параметр **Разрешить транзит шлюза** на VNetA, подключенном к каналу Expressroute, и **использовать удаленный шлюз** на удаленном VNetB, не подключенном к ExpressRoute. цепи.

### <a name="configuration-3-configure-transit-routing-in-a-vnet-peering-connection"></a>Конфигурация 3: Настройка транзитной маршрутизации в одноранговом соединении виртуальной сети

Если между виртуальными сетями установлена пиринговая связь, можно использовать шлюз в одной из этих сетей в качестве транзитного пункта при подключении к локальной сети. Чтобы настроить транзитный маршрут в пиринга виртуальных сетей, проверьте [подключения между виртуальными сетями](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-vnet-vnet-rm-ps?toc=/azure/virtual-network/toc.json).

> [!Note]
> Транзитный шлюз не поддерживается в связи пиринга между виртуальными сетями, созданными с помощью разных моделей развертывания. Он поддерживается, только если обе пиринговые виртуальные сети созданы с помощью Resource Manager.

Чтобы проверить, настроен ли транзитный маршрут для пиринга виртуальной сети, следуйте инструкциям:

1. Войдите в [портал Azure](https://portal.azure.com/) с помощью учетной записи, обладающей необходимыми [ролями и разрешениями](https://docs.microsoft.com/azure/virtual-network/virtual-network-manage-peering#roles-permissions).
2. В поле с текстом Поиск ресурсов в верхней части портал Azure введите *виртуальные сети*. Когда в результатах поиска появится пункт **Виртуальные машины**, щелкните его.
3. В открывшейся колонке **виртуальные сети** щелкните виртуальную сеть, для которой нужно проверить параметр пиринга.
4. В области, которая отображается для выбранной виртуальной сети, щелкните **узлы** в разделе **Параметры** .
5. Щелкните пиринг, который вы хотите просмотреть, и убедитесь, что вы включили параметр **Разрешить транзит шлюза** и **использовать удаленный шлюз** в **конфигурации**.

![ЭСКИЗ](./media/virtual-network-configure-vnet-connections/4035414_en_1.png)

### <a name="configuration-4-configure-transit-routing-in-a-vnet-to-vnet-connection"></a>Конфигурация 4: Настройка транзитной маршрутизации в подключении между виртуальными сетями

Чтобы настроить транзитную маршрутизацию между виртуальных сетей, необходимо включить протокол BGP для всех промежуточных подключений между виртуальными сетями с помощью модели развертывания диспетчер ресурсов и PowerShell. Инструкции см. [в статье Настройка BGP на VPN-шлюзах Azure с помощью PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-bgp-resource-manager-ps).

Транзитный трафик через VPN-шлюз Azure можно перемещать с помощью классической модели развертывания, но использует статически определенные адресные пространства в файле конфигурации сети. Служба BGP пока не поддерживается виртуальными сетями Azure и VPN-шлюзами с помощью классической модели развертывания. Без BGP определение адресов транзитного пространства вручную может привести к ошибке и не рекомендуется.

> [!Note]
> Классические подключения между виртуальными сетями настраиваются с помощью портал Azure (классической) или с помощью файла конфигурации сети на классическом портале. Вы не можете создать или изменить классическую виртуальную сеть с помощью модели развертывания Azure Resource Manager или портал Azure. Дополнительные сведения о транзитной маршрутизации для классических виртуальных сетей см. в статье шлюзы [виртуальной сети Hub &, сквозной цепочки и полной сетки в Azure ARM с помощью VPN (v1)](https://blogs.msdn.microsoft.com/igorpag/2015/10/01/hubspoke-daisy-chain-and-full-mesh-vnet-topologies-in-azure-arm-using-vpn-v1/).

### <a name="configuration-5-configure-transit-routing-in-a-site-to-site-connection"></a>Конфигурация 5. Настройка транзитной маршрутизации в подключении типа "сеть — сеть"

Чтобы настроить транзитную маршрутизацию между локальной и виртуальной сетями с подключением типа "сеть — сеть", необходимо включить протокол BGP для всех промежуточных подключений типа "сеть — сеть", используя модель развертывания диспетчер ресурсов и PowerShell, см. [инструкции по настройке. Использование BGP на VPN-шлюзах Azure с помощью PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-bgp-resource-manager-ps) для получения инструкций.

Транзитный трафик через VPN-шлюз Azure можно перемещать с помощью классической модели развертывания, но использует статически определенные адресные пространства в файле конфигурации сети. Служба BGP пока не поддерживается виртуальными сетями Azure и VPN-шлюзами с помощью классической модели развертывания. Без BGP определение адресов транзитного пространства вручную может привести к ошибке и не рекомендуется.

> [!Note]
> Классические подключения типа "сеть — сеть" настраиваются с помощью портал Azure (классической) или с помощью файла конфигурации сети на классическом портале. Вы не можете создать или изменить классическую виртуальную сеть с помощью модели развертывания Azure Resource Manager или портал Azure. Дополнительные сведения о транзитной маршрутизации для классических виртуальных сетей см. в статье шлюзы [виртуальной сети Hub &, сквозной цепочки и полной сетки в Azure ARM с помощью VPN (v1)](https://blogs.msdn.microsoft.com/igorpag/2015/10/01/hubspoke-daisy-chain-and-full-mesh-vnet-topologies-in-azure-arm-using-vpn-v1/).

## <a name="scenario-5-configure-bgp-for-a-vpn-gateway"></a>Сценарий 5. Настройка BGP для VPN-шлюза

BGP — это стандартный протокол маршрутизации, используемый в Интернете для обмена информацией о маршрутизации и достижимости между двумя или более сетями. При использовании BGP в контексте виртуальных сетей Azure BGP включает VPN-шлюзы Azure и локальные VPN-устройства, называемые одноранговыми узлами BGP или соседями. Они обмениваются "маршрутами", которые будут сообщать о доступности и достижимости обоих шлюзов, чтобы эти префиксы продавались через шлюзы или маршрутизаторы. Также BGP позволяет передавать трафик транзитом через несколько сетей. Для этого шлюз BGP распространяет на все известные ему узлы BGP информацию о маршрутах, полученную от остальных узлов BGP. Дополнительные сведения см. в статье Общие сведения о [BGP с VPN-шлюзами Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-bgp-overview).

### <a name="configure-bgp-for-a-vpn-connection"></a>Настройка BGP для VPN-подключения

Сведения о настройке VPN-подключения, использующего BGP, см. в статье [Настройка BGP на VPN-шлюзах Azure с помощью PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-bgp-resource-manager-ps).

> [!Note]
> 1. Включите протокол BGP для шлюза виртуальной сети, создав для него номер AS. Основные шлюзы не поддерживают BGP. Чтобы проверить номер SKU шлюза, перейдите к разделу Обзор колонки VPN-шлюза в портал Azure. Если номер SKU является **базовым**, необходимо изменить номер SKU (изменение[размера шлюза](https://docs.microsoft.com/powershell/module/azurerm.network/resize-azurermvirtualnetworkgateway?view=azurermps-4.1.0&viewFallbackFrom=azurermps-4.0.0)) на номер SKU **VpnGw1** . Проверка номера SKU приведет к простою в 20-30 минут. Как только шлюз будет иметь правильный номер SKU, можно добавить его с помощью команды PowerShell [Set-AzureRmVirtualNetworkGateway](https://docs.microsoft.com/powershell/module/azurerm.network/set-azurermvirtualnetworkgateway?view=azurermps-3.8.0) . let. Когда вы настроите значение AS, IP-адрес узла BGP для шлюза будет предоставляться автоматически.
> 2. Шлюз локальной сети необходимо указать **вручную** с номером AS и адресом узла BGP. Значения **ASN** и **-BgpPeeringAddress** можно задать с помощью команды PowerShell [New-азурермлокалнетворкгатевай](https://docs.microsoft.com/powershell/module/azurerm.network/new-azurermlocalnetworkgateway?view=azurermps-4.1.0) или [Set-азурермлокалнетворкгатевай](https://docs.microsoft.com/powershell/module/azurerm.network/set-azurermlocalnetworkgateway?view=azurermps-4.1.0) . let. Некоторые цифры зарезервированы для Azure, и их нельзя использовать, как описано в статье [о BGP с VPN-шлюзом Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-bgp-overview#bgp-faq).
> 3. Наконец, для объекта соединения должен быть включен BGP. Для`$True` параметра **-EnableBGP** можно задать значение с помощью [New-AzureRmVirtualNetworkGatewayConnection](https://docs.microsoft.com/powershell/module/azurerm.network/new-azurermvirtualnetworkgatewayconnection?view=azurermps-4.1.0) или [Set-AzureRmVirtualNetworkGatewayConnection](https://docs.microsoft.com/powershell/module/azurerm.network/set-azurermvirtualnetworkgatewayconnection?view=azurermps-4.1.0).

### <a name="validate-the-bgp-configuration"></a>Проверка конфигурации BGP

Чтобы проверить, правильно ли настроен протокол BGP, можно выполнить командлет `get-AzureRmVirtualNetworkGateway` , а `get-AzureRmLocalNetworkGateway`затем увидеть выходные данные BGP в части бгпсеттингстекст. Пример: Бгпсеттингстекст:

```
{

"Asn": AsnNumber,

"BgpPeeringAddress": "IP address",

"PeerWeight": 0

}
```

## <a name="scenario-6-highly-available-active-active-vpn-connection"></a>Сценарий 6. Высокодоступное VPN-подключение типа "активный — активный"

Между шлюзами в режиме "активный — активный" и "активный — резервный" существуют такие основные различия:

* Необходимо создать две IP-конфигурации шлюза с двумя общедоступными IP-адресами
* Необходимо задать флаг *енаблеактивеактивефеатуре*
* Номер SKU шлюза должен быть VpnGw1, VpnGw2, VpnGw3

Чтобы добиться высокого уровня доступности для подключений между локальными и виртуальными сетями, следует развернуть несколько VPN-шлюзов и установить несколько параллельных подключений между сетями и Azure. Общие сведения о вариантах подключения и топологии см. в статье [подключение между локальными и виртуальными сетями с высокой доступностью](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-highlyavailable).

Чтобы создать подключения между локальными и виртуальными сетями в режиме "активный — активный", следуйте инструкциям в статье [Настройка активных VPN-подключений S2S с помощью VPN-шлюзов Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-activeactive-rm-powershell) .

> [!Note]  
> 1. При добавлении адресов в шлюз локальной сети для включения BGP режим "активный — активный" *добавляет только адреса узлов BGP (/32)* . Если добавить дополнительные адреса, они будут рассматриваться как статические маршруты и имеют приоритет над маршрутами BGP.
> 2. Для локальных сетей, подключающихся к Azure, необходимо использовать разные ASN BGP. (Если они совпадают, необходимо изменить ASN виртуальной сети, если локальное VPN-устройство уже использует ASN для пиринга с другими соседями BGP.)

## <a name="scenario-7-change-an-azure-vpn-gateway-type-after-deployment"></a>Сценарий 7. Изменение типа VPN-шлюза Azure после развертывания

Нельзя изменить тип шлюза виртуальной сети Azure с политики на основанный на маршрутах или наоборот. Необходимо удалить шлюз после сохранения IP-адреса и предварительно общего ключа (PSK) вон'тбе. Затем можно создать новый шлюз требуемого типа. Чтобы удалить и создать шлюз, выполните следующие действия.

1. Удалите все подключения, связанные с исходным шлюзом.
2. Удалите шлюз с помощью портал Azure, PowerShell или классической оболочки PowerShell: 
   * [Удаление шлюза виртуальной сети с помощью портал Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-delete-vnet-gateway-portal)
   * [Удаление шлюза виртуальной сети с помощью PowerShell](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-delete-vnet-gateway-powershell)
   * [Удаление шлюза виртуальной сети с помощью PowerShell (классическая модель)](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-delete-vnet-gateway-classic-powershell)
3. Выполните действия, описанные в разделе [Создание VPN-шлюза](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal#a-namevnetgatewaya4-create-the-vpn-gateway) , чтобы создать новый шлюз требуемого типа и завершить настройку VPN.

> [!Note]
> Этот процесс займет около 60 минут.

## <a name="next-steps"></a>Следующие шаги

* [Устранение проблем с подключением между виртуальными машинами Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-troubleshoot-connectivity-problem-between-vms)

