---
title: Общие сведения о группах безопасности в Azure
titlesuffix: Azure Virtual Network
description: Узнайте о группах безопасности приложений и сети. Группы безопасности помогают отфильтровывать сетевой трафик между ресурсами Azure.
services: virtual-network
documentationcenter: na
author: malopMSFT
ms.service: virtual-network
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 07/26/2018
ms.author: malop
ms.reviewer: kumud
ms.openlocfilehash: ca4908e642644ccbf349841d143bfcc18e944025
ms.sourcegitcommit: 770b060438122f090ab90d81e3ff2f023455213b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/17/2019
ms.locfileid: "68305841"
---
# <a name="security-groups"></a>Группы безопасности
<a name="network-security-groups"></a>

Отфильтровать трафик, поступающий из ресурсов Azure и обратно, в [виртуальной сети](virtual-networks-overview.md) можно с помощью группы безопасности сети. В этой группе содержатся [правила безопасности](#security-rules), которые разрешают или запрещают исходящий и входящий трафик нескольких типов ресурсов Azure. Дополнительные сведения о том, какие ресурсы Azure можно развернуть в виртуальной сети и какие группы безопасности сети можно связать с ними, см. в статье [Интеграция виртуальной сети для служб Azure](virtual-network-for-azure-services.md). Для каждого правила можно указать источник и назначение, порт и протокол.

В этой статье объясняются основные понятия групп безопасности сети, что позволит использовать их эффективно. Если вы еще не создавали группу безопасности сети, вы можете пройти краткое [руководство](tutorial-filter-network-traffic.md), чтобы получить такой опыт создания. Если вы ознакомлены с группами безопасности сети и вам нужно управлять ими, см. сведения в статье [Создание, изменение и удаление группы безопасности сети](manage-network-security-group.md). Если возникают проблемы с обменом данными и вам необходимо устранить неполадки с группами безопасности сети, см. сведения в статье [Диагностика проблемы с фильтрацией трафика на виртуальной машине](diagnose-network-traffic-filter-problem.md). Для [анализа трафика](../network-watcher/traffic-analytics.md?toc=%2fazure%2fvirtual-network%2ftoc.json), поступающего из ресурсов со связанной группой безопасности сети и обратно, можно включить [журналы потоков группы безопасности сети](../network-watcher/network-watcher-nsg-flow-logging-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

## <a name="security-rules"></a>Правила безопасности

Группа безопасности сети может не содержать правила или содержать любое их число в пределах [ограничений](../azure-subscription-service-limits.md?toc=%2fazure%2fvirtual-network%2ftoc.json#azure-resource-manager-virtual-networking-limits) подписки Azure. В каждом правиле указываются следующие свойства:

|Свойство  |Объяснение  |
|---------|---------|
|Имя|Уникальное имя в пределах группы безопасности сети.|
|Priority | Значение в диапазоне от 100 до 4096. Правила обрабатываются в порядке приоритета. Числа обрабатываются по возрастанию, так как меньшие числа имеют более высокий приоритет. Если показатель трафика соответствует установленному в правиле, обработка останавливается. В результате все правила с более низким приоритетом (большие числа) и тем же атрибутом,что и правила с высоким приоритетом, не обрабатываются.|
|Источник или назначение| Значение "Любой" или отдельный IP-адрес, блок бесклассовой междоменной маршрутизации (CIDR) (например, 10.0.0.0/24), [тег службы](#service-tags) или [группа безопасности приложений](#application-security-groups). При указании адреса ресурса Azure необходимо указать частный IP-адрес, назначенный ресурсу. Группы безопасности сети обрабатываются после того, как Azure преобразует общедоступный IP-адрес в частный для входящего трафика, и до того, как Azure преобразует частный IP-адрес в общедоступный для исходящего трафика. Узнайте больше об [IP-адресах](virtual-network-ip-addresses-overview-arm.md). Если выбрать диапазон, тег службы или группу безопасности приложений, можно создавать меньше правил безопасности. Возможность указать несколько отдельных IP-адресов и диапазонов (нельзя указать несколько тегов служб или групп приложений) в правиле относится к [расширенным правилам безопасности](#augmented-security-rules). Расширенные правила безопасности можно создавать только в группах безопасности сети, развернутых с помощью модели Resource Manager. Нельзя одновременно задать несколько IP-адресов и их диапазонов в группах безопасности сети, созданных с помощью классической модели развертывания. Узнайте больше о [моделях развертывания Azure](../azure-resource-manager/resource-manager-deployment-model.md?toc=%2fazure%2fvirtual-network%2ftoc.json).|
|Протокол     | TCP, UDP, ICMP или любой.|
|Direction| Определяет тип трафика (входящий или исходящий), к которому применяется правило.|
|Диапазон портов     |Можно задать отдельный порт или их диапазон. Например, вы можете указать 80 или 10000–10005. Если указать диапазон, можно создавать меньше правил безопасности. Расширенные правила безопасности можно создавать только в группах безопасности сети, развернутых с помощью модели Resource Manager. Нельзя задать несколько портов или их диапазонов в одном и том же правиле безопасности в группах безопасности сети, созданных с помощью классической модели развертывания.   |
|Action     | Разрешить или запретить доступ        |

Правила безопасности групп безопасности сети оцениваются по приоритету и на основе кортежей из 5 элементов (источник, порт источника, назначение, порт назначения и протокол), чтобы разрешить или запретить трафик. Запись потока создается для имеющихся подключений. Обмен данными разрешен или запрещен в зависимости от состояния подключения записи потока. С помощью записи потока можно отслеживать состояние группы безопасности сети. Если вы задаете правило безопасности для исходящего трафика по любому адресу, например, через порт 80, устанавливать правило безопасности входящего трафика для ответа на исходящий трафик не обязательно. Если связь инициируется извне, достаточно задать правило безопасности для входящего трафика. Обратное также верно. Если через порт разрешено поступление входящего трафика, задавать правило безопасности исходящего трафика для ответа на трафик через порт не требуется.
Имеющиеся подключения могут не прерываться, когда вы удаляете правило безопасности, разрешавшее этот поток. Поток трафика прерывается, когда подключения разрываются, то есть в течение нескольких минут трафик не передается в любом направлении.

Количество правил безопасности, которые можно создать в группе безопасности сети, ограничено. Дополнительные сведения см. в разделе [Ограничения сети](../azure-subscription-service-limits.md?toc=%2fazure%2fvirtual-network%2ftoc.json#azure-resource-manager-virtual-networking-limits).

## <a name="augmented-security-rules"></a>Расширенные правила безопасности

Расширенные правила безопасности упрощают определение безопасности для виртуальных сетей, позволяя определять масштабные и комплексные политики безопасности сети с меньшим числом правил. Несколько портов, несколько явных IP-адресов и диапазонов можно объединить в одном простом правиле безопасности. Используйте расширенные правила в полях источника, назначения и порта для правила. Чтобы упростить поддержку для определения правила безопасности, объедините расширенные правила безопасности с [тегами служб](#service-tags) или [группами безопасности приложений](#application-security-groups). Количество адресов, диапазонов и портов, которые можно указать в правиле, ограничено. Дополнительные сведения см. в разделе [Ограничения сети](../azure-subscription-service-limits.md?toc=%2fazure%2fvirtual-network%2ftoc.json#azure-resource-manager-virtual-networking-limits).

## <a name="service-tags"></a>Теги служб

Тег службы представляет группу префиксов IP-адресов, чтобы упростить создание правила безопасности. Нельзя создать собственный тег службы или задать IP-адреса, которые будут входить в тег. Корпорация Майкрософт управляет префиксами адресов, входящих в тег службы, и автоматически обновляет этот тег при изменении адресов. Теги служб можно использовать вместо определенных IP-адресов при создании правил безопасности. 

Следующие теги служб доступны для использования в правилах [групп безопасности сети](https://docs.microsoft.com/azure/virtual-network/security-overview#security-rules). Теги службы со звездочкой в конце (т. е. AzureCloud *) также можно использовать в [правилах сети брандмауэра Azure](https://docs.microsoft.com/azure/firewall/service-tags). 

* **VirtualNetwork** (для развертываний Resource Manager) или **VIRTUAL_NETWORK** (для классических развертываний). Этот тег включает адресное пространство виртуальной сети (все диапазоны CIDR, определенные для виртуальной сети), все подключенные локальные адресные пространства, [одноранговые](virtual-network-peering-overview.md) виртуальные сети или виртуальную сеть, подключенные к шлюзу и адресу [виртуальной сети](../vpn-gateway/vpn-gateway-about-vpngateways.md?toc=%2fazure%2fvirtual-network%2ftoc.json) . префиксы, используемые в [определяемых пользователем маршрутах](virtual-networks-udr-overview.md). Имейте в виду, что этот тег может содержать маршрут по умолчанию. 
* **AzureLoadBalancer** (для развертываний Resource Manager) или **AZURE_LOADBALANCER** (для классических развертываний). Это тег по умолчанию, обозначающий подсистему балансировки нагрузки для инфраструктуры Azure. Этот тег преобразуется в [виртуальный IP-адрес узла](security-overview.md#azure-platform-considerations) (168.63.129.16), из которого поступают пробы работоспособности Azure. Если подсистема балансировки нагрузки Azure не используется, это правило можно переопределить.
* **Internet** (для развертываний Resource Manager) или **INTERNET** (для классических развертываний). Это тег, обозначающий пространство IP-адресов, которые находятся за пределами виртуальной сети и к которым можно получить доступ из общедоступного сегмента Интернета. К этим адресам относится [общедоступное пространство IP-адресов, принадлежащее Azure](https://www.microsoft.com/download/details.aspx?id=41653).
* **AzureCloud*** (только диспетчер ресурсов): Этот тег определяет пространство IP-адресов для Azure, включая все [общедоступные IP-адреса центра обработки данных](https://www.microsoft.com/download/details.aspx?id=41653). Значение *AzureCloud* отвечает за разрешение или запрет трафика к общедоступным IP-адресам Azure. Если вы хотите разрешить доступ только к AzureCloud в определенном [регионе](https://azure.microsoft.com/regions), можно указать регион в следующем формате AzureCloud. [имя региона]. Этот тег рекомендуется для исходящего правила безопасности. 
* **AzureTrafficManager*** (только диспетчер ресурсов): Этот тег определяет диапазон IP-адресов для IP-адресов пробы диспетчера трафика Azure. Дополнительные сведения об IP-адресах пробы диспетчера трафика см. в статье [Диспетчер трафика Azure: вопросы и ответы](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-faqs). Этот тег рекомендуется для правила безопасности входящего трафика.  
* **Хранилище*** (только диспетчер ресурсов): Этот тег определяет пространство IP-адресов для службы хранилища Azure. Если указать значение *Storage*, трафик будет разрешен или запрещен в хранилище. Если вы хотите разрешить доступ только к хранилищу в определенном [регионе](https://azure.microsoft.com/regions), вы можете указать регион в следующем формате хранилища. [имя региона]. Тег представляет службу, но не определенные экземпляры службы. Например, тег представляет службу хранилища Azure, но не определенную учетную запись хранения Azure. Этот тег рекомендуется для исходящего правила безопасности. 
* **SQL*** (только диспетчер ресурсов): Этот тег указывает префиксы адресов базы данных SQL Azure, базы данных Azure для MySQL, базы данных Azure для PostgreSQL и служб хранилища данных SQL Azure. Значение *Sql* отвечает за разрешение или запрет трафика в SQL. Если вы хотите разрешить доступ только к SQL в определенном [регионе](https://azure.microsoft.com/regions), можно указать регион в следующем формате: SQL. [имя региона]. Тег представляет службу, но не определенные экземпляры службы. Например, тег представляет службу "База данных SQL Microsoft Azure", но не определенную базу данных или сервер SQL Azure. Этот тег рекомендуется для исходящего правила безопасности. 
* **Азурекосмосдб*** (только диспетчер ресурсов): Этот тег определяет префиксы адресов для службы базы данных Azure Cosmos. Значение *AzureCosmosDB* отвечает за разрешение или запрет трафика к Azure Cosmos DB. Если вы хотите только разрешить доступ к Azure Cosmos DB в определенном [регионе](https://azure.microsoft.com/regions), укажите этот регион в формате AzureCosmosDB.[имя региона]. Этот тег рекомендуется для исходящего правила безопасности. 
* **AzureKeyVault*** (только диспетчер ресурсов): Этот тег определяет префиксы адресов для службы Azure Key Vault. Значение *AzureKeyVault* отвечает за разрешение или запрет трафика к Azure Key Vault. Если вы хотите только разрешить доступ к Azure Key Vault в определенном [регионе](https://azure.microsoft.com/regions), укажите этот регион в формате AzureKeyVault.[имя региона]. Этот тег имеет зависимость от тега **AzureActiveDirectory** . Этот тег рекомендуется для исходящего правила безопасности.  
* **EventHub*** (только диспетчер ресурсов): Этот тег определяет префиксы адресов для службы концентратора событий Azure. Значение *EventHub* отвечает за разрешение или запрет трафика в концентратор событий. Если вы хотите только разрешить доступ к концентратору событий в определенном [регионе](https://azure.microsoft.com/regions), укажите этот регион в формате "EventHub.[имя региона]". Этот тег рекомендуется для исходящего правила безопасности. 
* **Servicebus*** (только диспетчер ресурсов): Этот тег обозначает префиксы адресов службы Azure ServiceBus, используя уровень служб Premium. Значение *ServiceBus* отвечает за разрешение или запрет трафика в Служебную шину. Если вы хотите разрешить доступ к Служебной шине только в определенном [регионе](https://azure.microsoft.com/regions), укажите этот регион в формате "ServiceBus.[имя региона]". Этот тег рекомендуется для исходящего правила безопасности. 
* **Микрософтконтаинеррегистри*** (только диспетчер ресурсов): Этот тег определяет префиксы адресов для службы "Реестр контейнеров Майкрософт". Значение *MicrosoftContainerRegistry* отвечает за разрешение или запрет трафика в Реестр контейнеров Майкрософт. Если вы хотите разрешить доступ к Реестру контейнеров Майкрософт только в определенном [регионе](https://azure.microsoft.com/regions), укажите этот регион в формате "MicrosoftContainerRegistry.[имя региона]". Этот тег рекомендуется для исходящего правила безопасности. 
* **Азуреконтаинеррегистри*** (только диспетчер ресурсов): Этот тег определяет префиксы адресов для службы "Реестр контейнеров Azure". Значение *AzureContainerRegistry* отвечает за разрешение или запрет трафика в Реестр контейнеров Azure. Если вы хотите разрешить доступ к Реестру контейнеров Azure только в определенном [регионе](https://azure.microsoft.com/regions), укажите этот регион в формате "AzureContainerRegistry.[имя региона]". Этот тег рекомендуется для исходящего правила безопасности. 
* **AppService*** (только диспетчер ресурсов): Этот тег определяет префиксы адресов для Службы приложений Azure. Значение *AppService* отвечает за разрешение или запрет трафика в Службу приложений. Если вы хотите разрешить доступ к Службе приложений только в определенном [регионе](https://azure.microsoft.com/regions), укажите этот регион в формате "AppService.[имя региона]". Этот тег рекомендуется для исходящего правила безопасности для внешних интерфейсов веб-приложений.  
* **Аппсервицеманажемент*** (только диспетчер ресурсов): Этот тег обозначает префиксы адресов трафика управления для Среда службы приложений выделенных развертываний. Значение *AppServiceManagement* отвечает за разрешение или запрет трафика в службу "Управление Службой приложений". Этот тег рекомендуется для правила безопасности входящего и исходящего трафика. 
* **ApiManagement*** (только диспетчер ресурсов): Этот тег обозначает префиксы адресов трафика управления для выделенных развертываний APIM. Значение *ApiManagement* отвечает за разрешение или запрет трафика в службу управления API. Этот тег рекомендуется для правила безопасности входящего и исходящего трафика. 
* **Азуреконнекторс*** (только диспетчер ресурсов): Этот тег обозначает префиксы адресов Logic Apps соединителей для подключений проверки/внутреннего сервера. Значение *AzureConnectors* отвечает за разрешение или запрет трафика в Соединители Azure. Если вы хотите разрешить доступ к Соединителям Azure только в определенном [регионе](https://azure.microsoft.com/regions), укажите этот регион в формате "AzureConnectors.[имя региона]". Этот тег рекомендуется для правила безопасности входящего трафика. 
* **GatewayManager** (только для развертываний с помощью Resource Manager). Этот тег указывает префиксы адресов трафика управления для выделенных развертываний VPN и шлюзов приложений. Значение *GatewayManager* отвечает за разрешение или запрет трафика в Диспетчер шлюзов. Этот тег рекомендуется для правила безопасности входящего трафика. 
* **AzureDataLake*** (только диспетчер ресурсов): Этот тег определяет префиксы адресов для службы Azure Data Lake. Значение *AzureDataLake* отвечает за разрешение или запрет трафика в Azure Data Lake. Этот тег рекомендуется для исходящего правила безопасности. 
* **AzureActiveDirectory*** (только диспетчер ресурсов): Этот тег определяет префиксы адресов для службы Azure Active Directory. Значение *AzureActiveDirectory* отвечает за разрешение или запрет трафика в Azure Active Directory. Этот тег рекомендуется для исходящего правила безопасности.
* **Азуремонитор*** (только диспетчер ресурсов): Этот тег обозначает префиксы адресов Log Analytics, Application Insights, Азмон и пользовательские метрики (конечные точки с префиксом "ГБ"). Значение *AzureMonitor* отвечает за разрешение или запрет трафика в AzureMonitor. Для Log Analytics Этот тег имеет зависимость от тега **хранилища** . Этот тег рекомендуется для исходящего правила безопасности.
* **ServiceFabric*** (только диспетчер ресурсов): Этот тег определяет префиксы адресов для службы ServiceFabric. Значение *ServiceFabric* отвечает за разрешение или запрет трафика в службе ServiceFabric. Этот тег рекомендуется для исходящего правила безопасности. 
* **Азуремачинелеарнинг*** (только диспетчер ресурсов): Этот тег определяет префиксы адресов для службы AzureMachineLearning. Значение *AzureMachineLearning* отвечает за разрешение или запрет трафика в службе AzureMachineLearning. Этот тег рекомендуется для исходящего правила безопасности. 
* **Батчнодеманажемент*** (только диспетчер ресурсов): Этот тег указывает префиксы адресов трафика управления для выделенных развертываний пакетной службы Azure. Если указать значение *батчнодеманажемент* , трафик будет разрешен или запрещен в пакетной службе для вычислений узлов. Этот тег рекомендуется для правила безопасности входящего и исходящего трафика. 
* **AzureBackup*** (только диспетчер ресурсов): Этот тег обозначает префиксы адресов службы AzureBackup. При указании значения *AzureBackup* для параметра трафик разрешается или отклоняется для AzureBackup. Этот тег имеет зависимость от **хранилища** и тега **AzureActiveDirectory** . Этот тег рекомендуется для исходящего правила безопасности. 
* **Азуреактиведиректоридомаинсервицес*** (только диспетчер ресурсов): Этот тег обозначает префиксы адресов трафика управления для Azure Active Directory выделенных развертываний доменных служб. При указании значения *азуреактиведиректоридомаинсервицес* для параметра трафик разрешается или отклоняется для азуреактиведиректоридомаинсервицес. Этот тег рекомендуется для правила безопасности входящего и исходящего трафика.  
* **SqlManagement*** (только диспетчер ресурсов): Этот тег обозначает префиксы адресов трафика управления для выделенных развертываний SQL. При указании значения *SqlManagement* для параметра трафик разрешается или отклоняется для SqlManagement. Этот тег рекомендуется для правила безопасности входящего и исходящего трафика. 
* **Когнитивесервицесманажемент** (Только диспетчер ресурсов): Этот тег обозначает префиксы адресов трафика для Cognitive Services. При указании значения *когнитивесервицесманажемент* для параметра трафик разрешается или отклоняется для когнитивесервицесманажемент. Этот тег рекомендуется для исходящего правила безопасности.  
* **Dynamics365ForMarketingEmail** (Только диспетчер ресурсов): Этот тег обозначает префиксы адресов службы маркетинговой электронной почты Dynamics 365. При указании значения *Dynamics365ForMarketingEmail* для параметра трафик разрешается или отклоняется для Dynamics365ForMarketingEmail. Если вы хотите разрешить доступ только к Dynamics365ForMarketingEmail в определенном [регионе](https://azure.microsoft.com/regions), можно указать регион в следующем формате Dynamics365ForMarketingEmail. [имя региона].
* **Азуреплатформднс** (Только диспетчер ресурсов): Этот тег указывает DNS, который является базовой службой инфраструктуры. Если для значения задано значение *азуреплатформднс* , можно отключить заданную по умолчанию [ПЛАТФОРМУ Azure](https://docs.microsoft.com/azure/virtual-network/security-overview#azure-platform-considerations) для DNS. Будьте внимательны при использовании этого тега. Перед использованием этого тега рекомендуется тестирование. 
* **Азуреплатформимдс** (Только диспетчер ресурсов): Этот тег обозначает IMDS, который является базовой службой инфраструктуры. Если для этого параметра задано значение *азуреплатформимдс* , можно отключить заданную по умолчанию [ПЛАТФОРМУ Azure](https://docs.microsoft.com/azure/virtual-network/security-overview#azure-platform-considerations) для IMDS. Будьте внимательны при использовании этого тега. Перед использованием этого тега рекомендуется тестирование. 
* **Азуреплатформлкм** (Только диспетчер ресурсов): Этот тег обозначает лицензирование Windows или службу управления ключами. Если для значения задано значение *азуреплатформлкм* , то для лицензирования можно отключить заданную по умолчанию [платформу Azure](https://docs.microsoft.com/azure/virtual-network/security-overview#azure-platform-considerations) . Будьте внимательны при использовании этого тега. Перед использованием этого тега рекомендуется тестирование. 

> [!NOTE]
> Теги службы для служб Azure обозначают используемые префиксы адресов из определенного облака. 

> [!NOTE]
> Если вы реализуете [конечную точку службы для виртуальной сети](virtual-network-service-endpoints-overview.md) для службы, такой как служба хранилища Azure или "База данных SQL Azure", Azure добавляет для нее [маршрут](virtual-networks-udr-overview.md#optional-default-routes) в подсеть виртуальной сети. Префиксы адресов для маршрута — это те же префиксы или диапазоны CIDR, которые заданы в теге соответствующей службы.

### <a name="service-tags-in-on-premises"></a>Теги службы в локальной среде  
Вы можете скачать и интегрировать его с локальным брандмауэром. список тегов служб с префиксом см. в следующих еженедельных публикациях для [общедоступных](https://www.microsoft.com/download/details.aspx?id=56519) публикаций Azure, [государственных организаций США](https://www.microsoft.com/download/details.aspx?id=57063), [Китая](https://www.microsoft.com/download/details.aspx?id=57062)и [Германии](https://www.microsoft.com/download/details.aspx?id=57064).

Кроме того, эти сведения можно получить программным способом с помощью **API обнаружения тегов службы** (общедоступная Предварительная версия) — [RESTful](https://aka.ms/discoveryapi_rest), [Azure PowerShell](https://aka.ms/discoveryapi_powershell)и [Azure CLI](https://aka.ms/discoveryapi_cli). 

> [!NOTE]
> Следующие еженедельные публикации (старая версия) для [общедоступных](https://www.microsoft.com/en-us/download/details.aspx?id=41653), [китайских](https://www.microsoft.com/en-us/download/details.aspx?id=42064) и [Германии](https://www.microsoft.com/en-us/download/details.aspx?id=54770) облаков станут устаревшими до 30 июня 2020. Начните использовать обновленные публикации, как описано выше. 

## <a name="default-security-rules"></a>Правила безопасности по умолчанию

Azure создает следующие правила по умолчанию в каждой создаваемой группе безопасности сети:

### <a name="inbound"></a>Входящий трафик

#### <a name="allowvnetinbound"></a>AllowVNetInBound

|Priority|Source|Исходные порты|Назначение|Конечные порты|Протокол|Access|
|---|---|---|---|---|---|---|
|65000|VirtualNetwork|0-65535|VirtualNetwork|0-65535|Any|РАЗРЕШИТЬ|

#### <a name="allowazureloadbalancerinbound"></a>AllowAzureLoadBalancerInBound

|Priority|Source|Исходные порты|Назначение|Конечные порты|Протокол|Access|
|---|---|---|---|---|---|---|
|65001|AzureLoadBalancer|0-65535|0.0.0.0/0|0-65535|Any|РАЗРЕШИТЬ|

#### <a name="denyallinbound"></a>DenyAllInbound

|Priority|Source|Исходные порты|Назначение|Конечные порты|Протокол|Access|
|---|---|---|---|---|---|---|
|65500|0.0.0.0/0|0-65535|0.0.0.0/0|0-65535|Any|Запрет|

### <a name="outbound"></a>Исходящие

#### <a name="allowvnetoutbound"></a>AllowVnetOutBound

|Priority|Source|Исходные порты| Назначение | Конечные порты | Протокол | Access |
|---|---|---|---|---|---|---|
| 65000 | VirtualNetwork | 0-65535 | VirtualNetwork | 0-65535 | Any | РАЗРЕШИТЬ |

#### <a name="allowinternetoutbound"></a>AllowInternetOutBound

|Priority|Source|Исходные порты| Назначение | Конечные порты | Протокол | Access |
|---|---|---|---|---|---|---|
| 65001 | 0.0.0.0/0 | 0-65535 | Интернет | 0-65535 | Any | РАЗРЕШИТЬ |

#### <a name="denyalloutbound"></a>DenyAllOutBound

|Priority|Source|Исходные порты| Назначение | Конечные порты | Протокол | Access |
|---|---|---|---|---|---|---|
| 65500 | 0.0.0.0/0 | 0-65535 | 0.0.0.0/0 | 0-65535 | Any | Запрет |

В столбцах **Источник** и **Место назначения** значения *VirtualNetwork*, *AzureLoadBalancer* и *Internet* являются [тегами служб](#service-tags), а не IP-адресами. В столбце **Протокол включает TCP** , UDP и ICMP. При создании правила можно указать TCP, UDP, ICMP или любой из них. *0.0.0.0/0* в столбцах **Источник** и **Назначение** представляет все адреса. Такие клиенты, как портал Azure, Azure CLI или PowerShell, могут использовать для этого выражения * или ANY.
 
Правила по умолчанию нельзя удалить, но их можно переопределить, создав правила с более высоким приоритетом.

## <a name="application-security-groups"></a>Группы безопасности приложений

Группы безопасности приложений позволяют настроить сетевую безопасность как естественное расширение в структуре приложения. Это позволяет группировать виртуальные машины и определять политики безопасности сети на основе таких групп. Вы можете повторно использовать политику безопасности в нужном масштабе без обслуживания явных IP-адресов вручную. Платформа сама обрабатывает явные IP-адреса и множество наборов правил, позволяя вам сосредоточиться на бизнес-логике. Чтобы лучше понять группы безопасности приложений, рассмотрим следующий пример:

![Группы безопасности приложений](./media/security-groups/application-security-groups.png)

На предыдущем рисунке *NIC1* и *NIC2* — это члены группы безопасности приложений *AsgWeb*. *NIC3* — это член группы безопасности приложений *AsgLogic*. *NIC4* — это член группы безопасности приложений *AsgDb*. Несмотря на то что в этом примере каждый сетевой интерфейс является членом только одной группы безопасности приложений, он может быть членом нескольких групп безопасности приложений в соответствии с [ограничениями Azure](../azure-subscription-service-limits.md?toc=%2fazure%2fvirtual-network%2ftoc.json#azure-resource-manager-virtual-networking-limits). Ни один из сетевых интерфейсов не имеет связанных групп безопасности сети. *NSG1* связана с обеими подсетями и содержит следующие правила.

### <a name="allow-http-inbound-internet"></a>Allow-HTTP-Inbound-Internet

Это правило требуется для разрешения трафика из Интернета на веб-серверы. Так как входящий трафик из Интернета запрещен правилом безопасности по умолчанию [DenyAllInbound](#denyallinbound), для групп безопасности приложений *AsgLogic* или *AsgDb* дополнительных правил не требуется.

|Priority|Source|Исходные порты| Назначение | Конечные порты | Протокол | Access |
|---|---|---|---|---|---|---|
| 100 | Интернет | * | AsgWeb | 80 | TCP | РАЗРЕШИТЬ |

### <a name="deny-database-all"></a>Deny-Database-All

Так как правило безопасности по умолчанию [AllowVNetInBound](#allowvnetinbound) разрешает весь обмен данными между ресурсами в одной и той же виртуальной сети, это правило необходимо для запрета трафика из всех ресурсов.

|Priority|Source|Исходные порты| Назначение | Конечные порты | Протокол | Access |
|---|---|---|---|---|---|---|
| 120 | * | * | AsgDb | 1433 | Any | Запрет |

### <a name="allow-database-businesslogic"></a>Allow-Database-BusinessLogic

Это правило разрешает трафик из группы безопасности приложений *AsgLogic* в группу безопасности приложений *AsgDb*. Приоритет для этого правила выше, чем приоритет правила *Deny-Database-All*. Таким образом, это правило обрабатывается до правила *Deny-Database-All*, поэтому трафик из группы безопасности приложений *AsgLogic* разрешен, тогда как весь остальной трафик запрещен.

|Priority|Source|Исходные порты| Назначение | Конечные порты | Протокол | Access |
|---|---|---|---|---|---|---|
| 110 | AsgLogic | * | AsgDb | 1433 | TCP | РАЗРЕШИТЬ |

Правила, определяющие группу безопасности приложений в качестве источника или назначения, применяются только к сетевым интерфейсам, которые входят в ее состав. Если сетевой интерфейс не является членом группы безопасности приложений, правило не применяется к нему, несмотря на то, что группа безопасности сети связана с подсетью.

Группы безопасности приложений имеют следующие ограничения:

-   Есть ограничения на количество групп безопасности приложений в подписке, а также другие ограничения, связанные с группами безопасности приложений. Дополнительные сведения см. в разделе [Ограничения сети](../azure-subscription-service-limits.md?toc=%2fazure%2fvirtual-network%2ftoc.json#azure-resource-manager-virtual-networking-limits).
- Вы можете указать одну группу безопасности приложений в правиле безопасности как источник и назначение. Указать несколько групп безопасности приложений как источник или назначение нельзя.
- Все сетевые интерфейсы, назначенные группе безопасности приложений, должны существовать в той же виртуальной сети, где размещался первый сетевой интерфейс, назначенный этой группе безопасности приложений. Например, если группе безопасности приложений был первым назначен сетевой интерфейс с именем *AsgWeb* в виртуальной сети *VNet1*, все остальные сетевые интерфейсы, назначаемые *ASGWeb*, должны существовать в *VNet1*. Невозможно добавить сетевые интерфейсы из разных виртуальных сетей в одну группу безопасности приложения.
- При указании группы безопасности приложений в качестве источника и назначения в правиле безопасности сетевые интерфейсы в обеих группах безопасности приложения должны существовать в одной виртуальной сети. Например, если *AsgLogic* содержит сетевые интерфейсы из *VNet1*, а *AsgDb* — сетевые интерфейсы из *VNet2*, вы не сможете назначить *AsgLogic* в качестве источника и *AsgDb* в качестве назначения в правиле. Все сетевые интерфейсы для групп безопасности приложений источника и назначения должны существовать в одной и той же виртуальной сети.

> [!TIP]
> Чтобы свести к минимуму количество требуемых правил безопасности и необходимость изменять правила, составьте план необходимых групп безопасности приложений и создайте правила, по возможности используя теги служб или группы безопасности приложений вместо отдельных IP-адресов или диапазонов IP-адресов.

## <a name="how-traffic-is-evaluated"></a>Оценка трафика

В виртуальную сеть Azure можно развернуть ресурсы из нескольких служб Azure. Полный список см. в разделе [Службы, которые можно развернуть в виртуальной сети](virtual-network-for-azure-services.md#services-that-can-be-deployed-into-a-virtual-network). Вы можете связать не более одной группы безопасности сети с каждой [подсетью](virtual-network-manage-subnet.md#change-subnet-settings) виртуальной сети и [сетевым интерфейсом](virtual-network-network-interface.md#associate-or-dissociate-a-network-security-group) на виртуальной машине. Одну и ту же группу безопасности сети можно связать с любым выбранным количеством подсетей или сетевых интерфейсов.

На следующем рисунке показаны различные сценарии развертывания групп безопасности сети для разрешения трафика, поступающего из Интернета и обратно через TCP-порт 80:

![NSG-processing](./media/security-groups/nsg-interaction.png)

Чтобы понять, как Azure обрабатывает входящие и исходящие правила для групп безопасности сети, см. предыдущий рисунок, а также следующий текст.

### <a name="inbound-traffic"></a>Входящий трафик

Для входящего трафика Azure сначала обрабатывает правила в группе безопасности сети, связанной с подсетью, если таковая имеется, а затем правила в группе безопасности сети, связанной с сетевым интерфейсом, если таковой имеется.

- **VM1**. Обрабатываются правила безопасности в *NSG1*, так как она связана с *Subnet1*, а *VM1* находится в *Subnet1*. Если вы не создали правило, разрешающее входящий трафик через порт 80, трафик будет запрещен правилом безопасности по умолчанию [DenyAllInbound](#denyallinbound) и никогда не будет вычислен группой *NSG2*, так как *NSG2* связана с сетевым интерфейсом. Если в группе *NSG1* есть правило безопасности, разрешающее трафик через порт 80, трафик будет обрабатываться группой *NSG2*. Чтобы разрешить трафик к виртуальной машине через порт 80, в *NSG1* и *NSG2* должно быть правило, разрешающее трафик из Интернета через порт 80.
- **VM2**. Обрабатываются правила в *NSG1*, потому что *VM2* также находится в *Subnet1*. Так как у *VM2* нет группы безопасности сети, связанной с ее сетевым интерфейсом, она получает весь трафик, разрешенный *NSG1*, или не получает трафик, запрещенный *NSG1*. Если группа безопасности сети связана с подсетью, трафик разрешен или запрещен для всех ресурсов в одной и той же подсети.
- **VM3**. Так как с *Subnet2* не связана ни одна группа безопасности сети, трафик разрешен в подсеть и обрабатывается *NSG2*, потому что *NSG2* связана с сетевым интерфейсом, подключенным к *VM3*.
- **VM4**. Трафик разрешен в *VM4*, так как группа безопасности сети не связана с *Subnet3* или сетевым интерфейсом в виртуальной машине. Весь трафик пропускается через подсеть и сетевой интерфейс, если с ними не связана группа безопасности сети.

### <a name="outbound-traffic"></a>Исходящий трафик

Для исходящего трафика Azure сначала обрабатывает правила в группе безопасности сети, связанной с сетевым интерфейсом, если таковой имеется, а затем правила в группе безопасности сети, связанной с подсетью, если таковая имеется.

- **VM1**. Обрабатываются правила безопасности в *NSG2*. Если вы не создали правило безопасности, которое запрещает исходящий трафик в Интернет через порт 80, трафик разрешается правилом безопасности по умолчанию [AllowInternetOutbound](#allowinternetoutbound) в *NSG1* и *NSG2*. Если в *NSG2* есть правило безопасности, которое запрещает трафик через порт 80, трафик запрещен и никогда не вычисляется *NSG1*. Чтобы запретить исходящий трафик через порт 80 на виртуальной машине, у одной из группы безопасности сети или у обеих должно быть правило, которое запрещает трафик, поступающий в Интернет через порт 80.
- **VM2**. Весь трафик отправляется через этот сетевой интерфейс к подсети, так как с сетевым интерфейсом, подключенным к *VM2*, не связана группа безопасности сети. Обрабатываются правила в *NSG1*.
- **VM3**. Если в *NSG2* есть правило безопасности, которое запрещает трафик через порт 80, трафик запрещается. Если в *NSG2* есть правило безопасности, разрешающее трафик через порт 80, входящий трафик, поступающий в Интернет, разрешается через порт 80, так как группа безопасности сети не связана с *Subnet2*.
- **VM4**. Весь трафик разрешен из *VM4*, так как группа безопасности сети не связана с сетевым интерфейсом, подключенным к виртуальной машине или к *Subnet3*.

Все правила, применяемые к сетевому интерфейсу, можно просмотреть в списке [действующих правил безопасности](virtual-network-network-interface.md#view-effective-security-rules) сетевого интерфейса. Кроме того, вы можете воспользоваться функцией [Проверка IP-потока](../network-watcher/diagnose-vm-network-traffic-filtering-problem.md?toc=%2fazure%2fvirtual-network%2ftoc.json) в службе "Наблюдатель за сетями Azure", чтобы определить, разрешен ли обмен данными с сетевым интерфейсом. Проверка IP-потока позволяет узнать, разрешен ли обмен данными или запрещен и какие правила безопасности сети разрешают или запрещают трафик.

> [!NOTE]
> Группы безопасности сети связаны с подсетями или с виртуальными машинами и облачными службами, развернутыми в классической модели развертывания, а также с подсетями или сетевыми интерфейсами в модели развертывания диспетчер ресурсов. Дополнительные сведения о моделях развертывания Azure см. в статье [Развертывание с помощью Azure Resource Manager и классическое развертывание: сведения о моделях развертывания и состоянии ресурсов](../azure-resource-manager/resource-manager-deployment-model.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

> [!TIP]
> Если у вас нет особых причин сделать обратное, мы рекомендуем связать группу безопасности сети с подсетью или сетевым интерфейсом, но не обоими сразу. Так как правила в группе безопасности сети, связанной с подсетью, могут конфликтовать с правилами в группе безопасности сети, связанной с сетевым интерфейсом, могут возникнуть непредвиденные проблемы с обменом данными, требующие устранения неполадок.

## <a name="azure-platform-considerations"></a>Сведения о платформе Azure

- **Виртуальный IP-адрес главного узла**. Базовые службы инфраструктуры, например DHCP, DNS, IMDS и служба мониторинга работоспособности, предоставляются через виртуальные IP-адреса 168.63.129.16 и 169.254.169.254. Эти IP-адреса принадлежат корпорации Майкрософт. Они являются единственными виртуализированными IP-адресами, которые используются для этих целей во всех регионах.
- **Лицензирование (служба управления ключами)** . Для используемых на виртуальных машинах образов Windows требуется лицензия. Чтобы получить лицензию, на серверы узлов службы управления ключами отправляется соответствующий запрос. Для отправки запроса используется исходящий порт 1688. Для развертываний, в которых используется конфигурация [маршрута по умолчанию 0.0.0.0/0](virtual-networks-udr-overview.md#default-route), это правило платформы будет отключено.
- **Виртуальные машины в пулах с балансировкой нагрузки**. Применяемые исходный порт и диапазон адресов относятся к исходному компьютеру, а не подсистеме балансировки нагрузки. Конечный порт и диапазон адресов относятся к целевому компьютеру, а не подсистеме балансировки нагрузки.
- **Экземпляры служб Azure**. В подсетях виртуальной сети развертываются экземпляры нескольких служб Azure, таких как HDInsight, среды службы приложений и Масштабируемые наборы виртуальных машин. Полный список служб, которые можно развернуть в виртуальной сети, см. в статье [Интеграция виртуальной сети для служб Azure](virtual-network-for-azure-services.md#services-that-can-be-deployed-into-a-virtual-network). Обязательно ознакомьтесь с требования к портам для каждой службы, прежде чем применять группу безопасности сети к подсети, в которой развернут ресурс. Если запретить порты, которые требуются для службы, она будет работать неправильно.
- **Отправка исходящих сообщений электронной почты**. Корпорация Майкрософт рекомендует использовать аутентифицированные службы ретрансляции SMTP (обычно подключаются через TCP-порт 587, но часто через другие порты) для отправки электронной почты с виртуальных машин Azure. Службы ретрансляции SMTP оптимизируют репутацию отправителя, чтобы минимизировать риск отклонения сообщений сторонними поставщиками почтовых служб. Такие службы ретрансляции SMTP включают среди прочих Exchange Online Protection и SendGrid. Использование служб ретрансляции SMTP никак не ограничено в Azure независимо от типа подписки. 

  Если вы создали подписку Azure до 15 ноября 2017 г., кроме возможности использовать службы ретрансляции SMTP, вы также можете отправлять электронную почту непосредственно через TCP-порт 25. Если вы создали подписку Azure после 15 ноября 2017 г., вам может быть недоступна отправка электронной почты непосредственно через порт 25. Поведение исходящего трафика через порт 25, зависит от типа вашей подписки, как показано ниже.

     - **Соглашение Enterprise**. Разрешен исходящий трафик через порт 25. Вы можете отправлять исходящие сообщения электронной почты непосредственно с виртуальных машин на платформе Azure внешним поставщикам почтовых служб без ограничений. 
     - **Оплата по мере использования**. Передача исходящих данных через порт 25 заблокирована для всех ресурсов. Если необходимо отправить электронное письмо с виртуальной машины непосредственно внешним поставщикам почтовых служб (без использования аутентифицированной ретрансляции SMTP), можно сделать запрос на снятие ограничения. Запросы проверяет и одобряет только корпорация Майкрософт. Они утверждаются только после проверок для защиты от мошенничества. Чтобы создать запрос, откройте обращение в службу поддержки с типом проблемы *Техническая*, *Подключение к виртуальной сети*, *Не удается отправить сообщение электронной почты (SMTP/порт 25)* . В обращении в службу поддержки объясните, зачем для вашей подписки требуется отправка электронной почты непосредственно поставщикам почтовых служб вместо отправки с помощью аутентифицированной службы ретрансляции SMTP. Если для вашей подписки будет создано исключение из правила, только виртуальные машины, созданные после даты создания исключения, смогут передавать исходящие данные через порт 25.
     - **MSDN, Azure Pass, Azure с открытой лицензией, для образования, BizSpark и бесплатная пробная версия**. Передача исходящих данных через порт 25 заблокирована для всех ресурсов. Запросы на снятие ограничения отправить невозможно. Если нужно отправить сообщение электронной почты с виртуальной машины, используйте службу ретрансляции SMTP.
     - **Поставщик облачных служб**. Клиенты, которые используют ресурсы Azure через поставщика облачных служб, могут обратиться к своему поставщику с просьбой разблокировки от своего имени, если безопасную ретрансляцию SMTP использовать нельзя.

  Если Azure позволяет отправлять сообщения электронной почты через порт 25, корпорация Майкрософт не гарантирует, что поставщики электронной почты примут такие сообщения, отправленные с вашей виртуальной машины. Если конкретный поставщик отклоняет почту, отправленную с вашей виртуальной машины, обратитесь к такому поставщику, чтобы решить проблемы, связанные с доставкой сообщений или фильтрацией нежелательной почты. Или используйте службу ретрансляции SMTP, прошедшую проверку подлинности.

## <a name="next-steps"></a>Следующие шаги

* Узнайте, как [создать группу безопасности сети](tutorial-filter-network-traffic.md).
