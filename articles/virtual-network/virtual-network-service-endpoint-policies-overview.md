---
title: Политики конечных точек служб для виртуальной сети Azure | Документация Майкрософт
description: Сведения о фильтрации трафика из виртуальной сети к ресурсам Azure с помощью политик конечных точек служб.
services: virtual-network
documentationcenter: na
author: sumeetmittal
ms.service: virtual-network
ms.devlang: NA
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/18/2018
ms.author: sumi
ms.openlocfilehash: 86726eefb53638036a4e9207c648bf5ffe6c866e
ms.sourcegitcommit: ccb9a7b7da48473362266f20950af190ae88c09b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/05/2019
ms.locfileid: "67595385"
---
# <a name="virtual-network-service-endpoint-policies-preview"></a>Политики конечных точек служб для виртуальной сети (предварительная версия)

Политики конечных точек служб виртуальной сети позволяют фильтровать трафик из виртуальной сети к службам Azure, разрешая тем самым только определенные ресурсы служб, через конечные точки служб. Политики конечных точек предоставляют возможность детального контроля доступа трафика из виртуальной сети к службам Azure.

Эта функция доступна в __предварительной версии__ для следующих служб и регионов Azure:

__Служба хранилища Azure__. WestCentralUS, WestUS2, NorthCentralUS, SouthCentralUS, CentralUS, EastUS2.

Самые актуальные уведомления касательно предварительной версии см. на странице с [обновлениями виртуальной сети Azure](https://azure.microsoft.com/updates/?product=virtual-network).

> [!NOTE]  
> В период действия предварительной версии политики конечных точек служб для виртуальной сети могут не отличаться таким же уровнем доступности и надежности, как функции, предоставляемые в общедоступной версии. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="key-benefits"></a>Основные преимущества

Политики конечных точек служб для виртуальной сети предоставляют следующие преимущества:

- __Повышение уровня безопасности трафика из виртуальной сети к службам Azure__

  [Теги служб Azure для групп безопасности сети](https://aka.ms/servicetags) позволяют ограничить исходящий трафик из виртуальной сети в определенных службах Azure. Тем не менее это разрешает трафик к любым ресурсам соответствующей службы Azure. 
  
  С помощью политик конечных точек вы можете предоставлять исходящий доступ из виртуальной сети только к определенным ресурсам Azure. Это позволяет на более детальном уровне контролировать защиту данных, к которым обращаются из виртуальной сети. 

- __Фильтрация трафика служб Azure с помощью масштабируемых высокодоступных политик__

   Политики конечных точек — это горизонтально масштабируемое высокодоступное решение, позволяющее фильтровать трафик служб Azure из виртуальных сетей через конечные точки служб. Обслуживание центральных сетевых устройств обработки этого трафика в виртуальных сетях не требует дополнительных расходов.

## <a name="configuration"></a>Конфигурация

- С помощью политик конечных точек вы можете ограничивать трафик из виртуальной сети к определенным ресурсам служб Azure. В предварительной версии реализована поддержка политик конечных точек службы хранилища Azure. 
- Политика конечной точки настраивается в подсети виртуальной сети. Чтобы применить политику, в подсети необходимо включить конечные точки всех служб, перечисленных в этой политике.
- Политика конечной точки позволяет разрешать ресурсы конкретных служб Azure, используя формат resourceID. Вы можете ограничить доступ ко всем ресурсам в подписке или группе ресурсов. Кроме того, доступ можно ограничивать только к определенным ресурсам. 
- По умолчанию, если в подсети с конечными точками не применена политика, доступ можно получать ко всем ресурсам в службе. Если настроить политику, доступ из вычислительных экземпляров в подсети можно получать только к ресурсам, указанным в этой подсети. Доступ к другим ресурсам определенной службы отклоняется. 
- Трафик к ресурсам служб Azure можно фильтровать в регионах с настроенными конечными точками служб. Доступ к ресурсам служб в других регионах разрешается по умолчанию. 

  > [!NOTE]  
  > Чтобы полностью заблокировать исходящий доступ с виртуальной сети к ресурсам Azure в регионах конечных точек служб, необходимо также настроить правила группы безопасности сети, разрешив с помощью [тегов служб](security-overview.md#service-tags) трафик только к областям конечных точек служб.

- К подсети можно применять несколько политик. Если с подсетью связаны несколько политик одной и той же службы, трафик виртуальной сети к ресурсам, указанным в любой из этих политик, разрешается. Доступ ко всем другим ресурсам служб, не указанным в любой из этих политик, отклоняется. 

  > [!NOTE]  
  > Политика разрешает доступ из виртуальной сети только к указанным ресурсам службы. При добавлении определенных ресурсов в политику весь остальной трафик к службе автоматически отклоняется. Убедитесь, что все зависимости ресурсов службы для приложений можно задать и указать в политике.

  > [!WARNING]  
  > В соответствии с требованиями к инфраструктуре службы Azure, развернутые в виртуальной сети, например Azure HDInsight, получают доступ к другим службам Azure, например служба хранилища Azure. Ограничение доступа к определенным ресурсам с помощью политики конечных точек может заблокировать доступ к этим ресурсам инфраструктуры для служб, развернутых в виртуальной сети. Сведения касательно определенных служб см. в разделе [ограничений](#limitations). В период действия предварительной версии политики конечных точек не поддерживаются любыми управляемыми службами Azure, развернутыми в виртуальной сети.

- Служба хранилища Azure: 
  -  Вы можете ограничить доступ, указав *идентификатор ресурса* Azure Resource Manager учетной записи хранения. Это позволит блокировать трафик к большим двоичным объектам, таблицам, очередям, файлам и Azure Data Lake Storage 2-го поколения.

     Например, ниже показано, как указать учетные записи хранения Azure в определении политики конечной точки.
    
     Разрешение конкретной учетной записи хранения:         
     `subscriptions/subscriptionId/resourceGroups/resourceGroup/providers/Microsoft.Storage/storageAccounts/storageAccountName`
      
     Разрешение всех учетных записей в подписке и группе ресурсов: `/subscriptions/subscriptionId/resourceGroups/resourceGroup`
     
     Разрешение всех учетных записей в подписке: `/subscriptions/subscriptionId`
    
- В политике конечных точек можно указывать только учетные записи хранения, использующие модель ресурсов Azure.  

  > [!NOTE]  
  > С помощью политик конечных точек можно блокировать доступ к классическим учетным записям хранения.

- Приведенные в политике учетные записи должны находиться (основное расположение) в регионах геосвязи конечной точки службы, указанной в подсети. 

  > [!NOTE]  
  > Политики позволяют указывать ресурсы служб из других регионов. Доступ из виртуальной сети к службам Azure фильтруется только в областях геосвязи. Если группы безопасности сети не ограничены в регионах геосвязи службы хранилища Azure, из виртуальной сети можно получить доступ ко всем учетным записям хранения за пределами этих областей.

- Если в политике указана основная учетная запись, доступ к дополнительным учетным записям геоизбыточного хранилища с доступом на чтение автоматически разрешается. 
- Учетные записи хранения могут находиться в той же либо другой подписке или клиенте Azure Active Directory, что и виртуальная сеть. 

## <a name="limitations"></a>Ограничения

- Политики конечных точек служб можно применять только в виртуальных сетях, развернутых на основе модели развертывания с помощью Azure Resource Manager.
- Виртуальные сети должны относиться к тому же региону, что и политика конечных точек служб.
- Политику конечных точек служб можно применять в подсети, только если в указанных в этой политике службах Azure настроены конечные точки служб.
- Политики конечных точек служб нельзя применять к трафику из локальной сети к службам Azure.
- В соответствии с требованиями к инфраструктуре политики конечных точек нельзя применять к подсетям с управляемыми службами Azure с зависимостью от служб Azure. 

  > [!WARNING]  
  > В соответствии с требованиями к инфраструктуре службы Azure, развернутые в виртуальной сети, например Azure HDInsight, получают доступ к другим службам Azure, например служба хранилища Azure. Ограничение доступа к определенным ресурсам с помощью политики конечных точек может заблокировать доступ к этим ресурсам инфраструктуры для служб Azure, развернутых в виртуальной сети.
  
  - Некоторые службы Azure можно развернуть в подсети с другими вычислительными экземплярами. Убедитесь, что политики конечных точек не применяются в подсети, если в ней развернуты перечисленные ниже управляемые службы.
   
    - Azure HDInsight
    - Пакетная служба Azure (Azure Resource Manager)
    - Доменные службы Azure Active Directory (Azure Resource Manager)
    - Шлюз приложений Azure (Azure Resource Manager)
    - VPN-шлюз Azure (Azure Resource Manager)
    - Брандмауэр Azure

  - Некоторые службы Azure развертываются в выделенных подсетях. Ниже перечислены все службы, в которых в период действия предварительной версии блокируются политики конечных точек. 

     - Среда Службы приложений Azure
     - Кэш Redis для Azure
     - Cлужба управления Azure API
     - Управляемый экземпляр SQL Azure
     - Доменные службы Azure Active Directory
     - Шлюз приложений Azure (классическая модель)
     - VPN-шлюз Azure (классическая модель)

- Служба хранилища Azure. Классические учетные записи хранения не поддерживаются в политиках конечных точек. По умолчанию политики запрещают доступ ко всем таким учетным записям. Если приложению требуется доступ к Azure Resource Manager и классическим учетным записям хранения, политики конечных точек не следует применять к трафику. 

## <a name="nsgs-with-service-endpoint-policies"></a>Группы безопасности сети с политиками конечных точек служб
- По умолчанию группы NSG разрешают исходящий интернет-трафик, в том числе трафик из виртуальной сети в службы Azure.
- Чтобы запретить весь исходящий интернет-трафик и разрешить трафик только к определенным ресурсам служб Azure, сделайте следующее: 

  Шаг 1. С помощью *тегов служб Azure* настройте группы безопасности сети, чтобы разрешить исходящий трафик только к службам Azure в регионах конечных точек. Дополнительные сведения см. в разделе [Теги служб](https://aka.ms/servicetags).
      
  Например, правила групп безопасности сети, ограничивающие доступ только к регионам конечных точек, выглядят следующим образом:

  ```
  Allow AzureStorage.WestUS2,
  Allow AzureStorage.WestCentralUS,
  Deny all
  ```

  Шаг 2. Примените политику конечных точек с доступом только к определенным ресурсам служб Azure.

  > [!WARNING]  
  > Если группа безопасности сети не ограничивает доступ служб Azure в виртуальной сети к регионам конечных точек, вы можете обращаться к ресурсам служб в других регионах, даже если применяется политика конечных точек служб.

## <a name="scenarios"></a>Сценарии

- **Пиринговые или подключенные виртуальные сети либо несколько виртуальных сетей**. Чтобы фильтровать трафик в одноранговых виртуальных сетях, политики конечных точек следует применять отдельно к каждой из них.
- **Фильтрация интернет-трафика с помощью сетевых модулей или Брандмауэра Azure.** Часть трафика служб Azure можно фильтровать с помощью политик через конечные точки, а остальную часть интернет-трафика или трафика Azure — через модули или Брандмауэр Azure. 
- **Фильтрация трафика в службах Azure, развернутых в виртуальных сетях.** В период действия предварительной версии политики конечных точек не поддерживаются управляемыми службами Azure, развернутыми в виртуальной сети. 
 Сведения касательно определенных служб см. в разделе [ограничений](#limitations).
- **Фильтрация трафика к службам Azure из локальной среды.** Политики конечных точек служб применяются только к связанным с этими политиками подсетям. Чтобы разрешить доступ к определенным ресурсам служб Azure из локальной среды, трафик следует фильтровать с помощью виртуальных сетевых модулей или брандмауэров.

## <a name="logging-and-troubleshooting"></a>Ведение журнала и устранение неполадок
Политики конечных точек служб не поддерживают централизованное ведение журнала. Сведения о журналах диагностики служб см. в разделе [Ведение журнала и устранение неполадок](virtual-network-service-endpoints-overview.md#logging-and-troubleshooting).

### <a name="troubleshooting-scenarios"></a>Сценарии устранения неисправностей
- Доступ предоставлен к учетным записям хранения, не указанным в политиках конечных точек
  - Группы безопасности сети могут иметь доступ к учетным записям в Интернете и учетным записям хранения Azure в других регионах.
  - В группах безопасности сети необходимо настроить отклонение всего исходящего интернет-трафика и разрешить трафик только к определенным регионам службы хранилища Azure. См. дополнительные сведения о группах безопасности сети.
- Доступ запрещен к учетным записям, указанным в политиках конечных точек
  - Группы безопасности сети или брандмауэр могут блокировать доступ.
  - Если после удаления и повторного применения политики исчезает подключение, сделайте следующее:
    - Проверьте, разрешен ли в службе Azure доступ из виртуальной сети через конечные точки или имеет ли политика ресурса по умолчанию значение *Allow All* (Разрешить все).
      > [!NOTE]      
      > Чтобы получить доступ через политики конечных точек, ресурсы служб не должны быть защищены в виртуальных сетях. Тем не менее по соображениям безопасности мы рекомендуем защищать ресурсы служб в доверенных сетях, например в виртуальных сетях Azure через конечные точки служб и в локальной среде через IP-адреса брандмауэра.
  
    - Проверьте, имеются ли в журнале диагностики службы данные о трафике через конечные точки.
    - Проверьте, имеются ли в журналах потоков групп безопасности сети данные о доступе, а также имеются ли в журналах хранилища сведения о доступе через конечные точки служб (как и предполагается).
    - Обратитесь в службу поддержки Azure.
- Доступ запрещен к учетным записям, не указанным в политиках конечных точек служб
  - Группы безопасности сети или брандмауэр могут блокировать доступ. Убедитесь, что тег *службы хранилища Azure* разрешен в областях конечных точек. Ограничения политики см. [здесь](#limitations).
  Например, если применяется политика, доступ к классическим учетным записям хранения запрещен.
  - Проверьте, разрешен ли в службе Azure доступ из виртуальной сети через конечные точки или имеет ли политика ресурса по умолчанию значение *Allow All* (Разрешить все).

## <a name="provisioning"></a>Подготовка

Политики конечных точек служб может настроить пользователь с правами на запись в виртуальной сети. Узнайте больше о [встроенных ролях](../role-based-access-control/built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json) Azure и назначении разрешений, определенных для [настраиваемых ролей](../role-based-access-control/custom-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

Виртуальные сети и ресурсы служб Azure могут находиться в одной или разных подписках или клиентах Azure Active Directory. 

## <a name="pricing-and-limits"></a>Цены и ограничения

За использование политик конечных точек служб дополнительная плата не взимается. Текущие цены на службы Azure, например службу хранилища Azure, применяются без изменений (через конечные точки служб).

К политикам конечных точек служб применяются следующие ограничения: 

 |Resource | Ограничение по умолчанию |
 |---------|---------------|
 |Количество политик конечных точек служб на подписку |500 |
 |Количество политик конечных точек служб на подсеть|100 |
 |Ресурсы служб на определение политики конечных точек служб|200 |

## <a name="next-steps"></a>Следующие шаги

- Узнайте, как [настроить политики конечных точек служб для виртуальной сети](virtual-network-service-endpoint-policies-portal.md).
- Дополнительные сведения о конечных точках служб для виртуальной сети см. [здесь](virtual-network-service-endpoints-overview.md).

