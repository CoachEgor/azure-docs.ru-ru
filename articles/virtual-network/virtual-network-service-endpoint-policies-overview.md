---
title: Политики конечных точек служб для виртуальной сети Azure | Документация Майкрософт
description: Сведения о фильтрации трафика из виртуальной сети к ресурсам Azure с помощью политик конечных точек служб.
services: virtual-network
documentationcenter: na
author: RDhillon
ms.service: virtual-network
ms.devlang: NA
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/21/2020
ms.author: rdhillon
ms.openlocfilehash: 926da07ffaf0c61ca2a7fd02351ef3635ec4d73b
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77651306"
---
# <a name="virtual-network-service-endpoint-policies-for-azure-storage"></a>Политики виртуальной точки конечных точек сетевого обслуживания для хранения Azure

Политики конечных точек службы Virtual Network (VNet) позволяют фильтровать виртуальный сетевой трафик в учетные записи Azure Storage через конечную точку службы и позволяют эксфильтрацию данных только конкретным учетным записям Хранения Azure. Политики конечных точек обеспечивают детальный контроль доступа к виртуальному сетевому трафику в Azure Storage при подключении к конечная точка службы.

![Защита виртуального исходящего трафика сети для учетных записей хранения Azure](./media/virtual-network-service-endpoint-policies-overview/vnet-service-endpoint-policies-overview.png)

Эта функция обычно доступна для __хранения Azure__ во __всех глобальных регионах Azure.__

## <a name="key-benefits"></a>Основные преимущества

Политики конечных точек служб для виртуальной сети предоставляют следующие преимущества:

- __Улучшенная безопасность трафика виртуальной сети в Azure Storage__

  [Теги службы Azure для групп сетевой безопасности](https://aka.ms/servicetags) позволяют ограничить виртуальный исходящий трафик сети определенными областями хранения данных Azure. Однако это позволяет трафик на любую учетную запись в выбранном регионе хранения Azure.
  
  Политики конечных точек позволяют указывать учетные записи системы хранения Azure, которые разрешены виртуальному доступу к исходящим сетям, и ограничивают доступ ко всем другим учетным записям хранения. Это дает гораздо более детальный контроль безопасности для защиты эксфильтрации данных из вашей виртуальной сети.

- __Фильтрация трафика служб Azure с помощью масштабируемых высокодоступных политик__

   Политики конечных точек — это горизонтально масштабируемое высокодоступное решение, позволяющее фильтровать трафик служб Azure из виртуальных сетей через конечные точки служб. Обслуживание центральных сетевых устройств обработки этого трафика в виртуальных сетях не требует дополнительных расходов.

## <a name="json-object-for-service-endpoint-policies"></a>Политики конечных точек объекта JSON для службы
Рассмотрим объект политики конечных точек службы.

```json
"serviceEndpointPolicyDefinitions": [
    {
            "description": null,
            "name": "MySEP-Definition",
            "resourceGroup": "MySEPDeployment",
            "service": "Microsoft.Storage",
            "serviceResources": [ 
                    "/subscriptions/subscriptionID/resourceGroups/MySEPDeployment/providers/Microsoft.Storage/storageAccounts/mystgacc"
            ],
            "type": "Microsoft.Network/serviceEndpointPolicies/serviceEndpointPolicyDefinitions"
    }
]
```

## <a name="configuration"></a>Параметр Configuration

-   Можно настроить конечные политики для ограничения виртуального сетевого трафика определенными учетными записями хранения Azure.
-   Политика конечной точки настраивается в подсети виртуальной сети. Для применения политики следует ввести конечные точки службы для хранения Azure.
-   Политика конечных точек позволяет добавлять определенные учетные записи хранилища Azure, чтобы разрешить список, используя формат resourceID. Вы можете ограничить доступ к
    - все учетные записи хранения в подписке<br>
      `E.g. /subscriptions/subscriptionId`

    - все учетные записи хранилища в группе ресурсов<br>
      `E.g. subscriptions/subscriptionId/resourceGroups/resourceGroupName`
     
    - индивидуальная учетная запись хранилища, перечисляя соответствующий ресурс Azure Resource ManagerId. Это позволит блокировать трафик к большим двоичным объектам, таблицам, очередям, файлам и Azure Data Lake Storage 2-го поколения. <br>
    `E.g. /subscriptions/subscriptionId/resourceGroups/resourceGroupName/providers/Microsoft.Storage/storageAccounts/storageAccountName`
-   По умолчанию, если политики не подключены к подсети с конечными точками, можно получить доступ ко всем учетным записям хранилища в службе. Если настроить политику, доступ из вычислительных экземпляров в подсети можно получать только к ресурсам, указанным в этой подсети. Доступ ко всем другим учетным записям хранения будет отказано.
-   При применении политики endpoint службы в подсети *область конечных точек* хранения данных Azure Storage обновляется с регионального на **глобальный.** Это означает, что после этого весь трафик в Хранилище Azure защищен через конечную точку обслуживания. Политики конечных точек Службы также применимы во всем мире, поэтому любые учетные записи хранения, которые явно не разрешены, будут лишены доступа. 
-   К подсети можно применять несколько политик. Когда несколько политик связаны с подсетью, виртуальный сетевой трафик на ресурсы, указанные в любой из этих политик, будет разрешен. Доступ ко всем другим ресурсам служб, не указанным в любой из этих политик, отклоняется.

    > [!NOTE]  
    > Политики конечных точек службы **позволяют проводить политики,** поэтому, помимо указанных ресурсов, все остальные ресурсы ограничены. Пожалуйста, убедитесь, что все зависимости ресурсов службы для ваших приложений будут идентифицированы и перечислены в политике.

- В политике конечных точек можно указывать только учетные записи хранения, использующие модель ресурсов Azure. Классические учетные записи хранилища Azure не будут поддерживать конечные политики службы Azure.
- Если в политике указана основная учетная запись, доступ к дополнительным учетным записям геоизбыточного хранилища с доступом на чтение автоматически разрешается.
- Учетные записи хранения могут находиться в той же либо другой подписке или клиенте Azure Active Directory, что и виртуальная сеть.

## <a name="scenarios"></a>Сценарии

- **Одноранговая, подключенная виртуальная сеть или несколько виртуальных сетей.** Чтобы фильтровать трафик в одноранговых виртуальных сетях, политики конечных точек следует применять отдельно к каждой из них.
- **Фильтрация интернет-трафика с помощью сетевых приборов или брандмауэра Azure Firewall:** Фильтрующий трафик службы Azure с политиками, над конечными точками обслуживания и фильтрующий остальной трафик Интернета или Azure с помощью бытовой техники или брандмауэра Azure Firewall.
- **Фильтрация трафика в службах Azure, развернутых в виртуальных сетях:** В настоящее время политики конечных точек Azure не поддерживаются для любых управляемых служб Azure, которые развернуты в вашей виртуальной сети. 
- **Фильтрация трафика к службам Azure из локальной среды.** Политики конечных точек служб применяются только к связанными с ними подсетям. Чтобы разрешить доступ к определенным ресурсам служб Azure из локальной среды, трафик следует фильтровать с помощью виртуальных сетевых модулей или брандмауэров.

## <a name="logging-and-troubleshooting"></a>Ведение журнала и устранение неполадок
Политики конечных точек служб не поддерживают централизованное ведение журнала. Сведения о журналах диагностики служб см. в разделе [Ведение журнала и устранение неполадок](virtual-network-service-endpoints-overview.md#logging-and-troubleshooting).

### <a name="troubleshooting-scenarios"></a>Сценарии устранения неисправностей
- Доступ к учетным записям хранения, которые работали в предварительном просмотре (не в гео-паре области)
  - С обновлением хранилища Azure для использования тегов глобальной службы сфера действия конечных точек службы и, таким образом, политики конечной точки службы теперь глобальны. Таким образом, любой трафик в Azure Storage шифруется через конечные точки службы, и доступ разрешен только учетным записям хранения, которые явно перечислены в политике.
  - Явно позвольте перечислить все необходимые учетные записи хранилища для восстановления доступа.  
  - Обратитесь в службу поддержки Azure.
- Доступ запрещен к учетным записям, указанным в политиках конечных точек
  - Группы безопасности сети или брандмауэр могут блокировать доступ.
  - Если после удаления и повторного применения политики исчезает подключение, сделайте следующее:
    - Проверка того, настроена ли служба Azure для обеспечения доступа из виртуальной сети через конечные точки, или что политика по умолчанию для ресурса настроена *на разрешите все.*
    - Проверьте, имеются ли в журнале диагностики службы данные о трафике через конечные точки.
    - Проверьте, имеются ли в журналах потоков групп безопасности сети данные о доступе, а также имеются ли в журналах хранилища сведения о доступе через конечные точки служб (как и предполагается).
    - Обратитесь в службу поддержки Azure.
- Доступ запрещен к учетным записям, не указанным в политиках конечных точек служб
  - Проверка того, настроена ли Azure Storage для обеспечения доступа из виртуальной сети через конечные точки, или же политика по умолчанию для ресурса настроена *на разрешите все.*
  - Убедитесь, что учетные записи не являются **классическими учетными записями хранения** с политиками конечных точек службы в подсети.
- Управляемая служба Azure прекратила работу после применения политики endpoint службы в подсети
  - В настоящее время управляемые службы не поддерживаются политиками конечных точек обслуживания. *Смотреть это пространство для обновления*.

## <a name="provisioning"></a>Подготовка

Политики конечных точек служб может настроить пользователь с правами на запись в виртуальной сети. Узнайте больше о [встроенных ролях](../role-based-access-control/built-in-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json) Azure и назначении разрешений, определенных для [настраиваемых ролей](../role-based-access-control/custom-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

Виртуальные сети и учетные записи хранилища Azure могут быть в одних и тех же или разных подписях или налаживателях Active Directory.

## <a name="limitations"></a>Ограничения

- Политики конечных точек служб можно применять только в виртуальных сетях, развернутых на основе модели развертывания с помощью Azure Resource Manager.
- Виртуальные сети должны относиться к тому же региону, что и политика конечных точек служб.
- Политику конечных точек служб можно применять в подсети, только если в указанных в этой политике службах Azure настроены конечные точки служб.
- Политики конечных точек служб нельзя применять к трафику из локальной сети к службам Azure.
- Управляемые службы Azure в настоящее время не поддерживают политики Endpoint. Это включает в себя управляемые службы, развернутые в общих подсетях (например, *Azure HDInsight, Azure Batch, Azure ADDS, Azure APplication Gateway, Azure VPN gateway, Azure Firewall*) или в специализированные подсети (например, *Azure App Service Environment, Azure Redis Cache, Azure API Management, Azure S'L MI, управляемые классические сервисы).*

 > [!WARNING]
 > В соответствии с требованиями к инфраструктуре службы Azure, развернутые в виртуальной сети, например Azure HDInsight, получают доступ к другим службам Azure, например служба хранилища Azure. Ограничение доступа к определенным ресурсам с помощью политики конечных точек может заблокировать доступ к этим ресурсам инфраструктуры для служб Azure, развернутых в виртуальной сети.

- Классические учетные записи хранения не поддерживаются в политиках конечных точек. По умолчанию политики запрещают доступ ко всем таким учетным записям. Если приложению требуется доступ к Azure Resource Manager и классическим учетным записям хранения, политики конечных точек не следует применять к трафику.

## <a name="pricing-and-limits"></a>Цены и ограничения

За использование политик конечных точек служб дополнительная плата не взимается. Текущие цены на службы Azure, например службу хранилища Azure, применяются без изменений (через конечные точки служб).

К политикам конечных точек служб применяются следующие ограничения: 

 |Ресурс | Ограничение по умолчанию |
 |---------|---------------|
 |Количество политик конечных точек служб на подписку |500 |
 |Количество политик конечных точек служб на подсеть|100 |
 |Ресурсы служб на определение политики конечных точек служб|200 |

## <a name="next-steps"></a>Next Steps

- Узнайте, как [настроить политики конечных точек служб для виртуальной сети](virtual-network-service-endpoint-policies-portal.md).
- Узнайте больше о [конечных точках виртуального сетевого обслуживания](virtual-network-service-endpoints-overview.md)
