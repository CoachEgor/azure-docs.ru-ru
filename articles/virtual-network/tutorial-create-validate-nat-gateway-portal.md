---
title: Руководство по созданию и проверке шлюза NAT — портал Azure
titlesuffix: Azure Virtual Network NAT
description: В этом учебнике объясняется, как создать шлюз NAT с помощью портала Azure и проверить NAT.
services: virtual-network
documentationcenter: na
author: asudbring
manager: KumundD
Customer intent: I want to test a NAT Gateway for outbound connectivity for my virtual network.
ms.service: virtual-network
ms.subservice: nat
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/24/2020
ms.author: allensu
ms.openlocfilehash: d798725892a9586c17cd7023863fe5cf7df05cb6
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "84417843"
---
# <a name="tutorial-create-a-nat-gateway-using-the-azure-portal-and-test-the-nat-service"></a>Руководство по созданию шлюза NAT с помощью портала Azure и проверке NAT

Из этого учебника вы узнаете, как создать шлюз NAT для обеспечения исходящего подключения в виртуальных машинах в Azure. Чтобы протестировать шлюз NAT, необходимо развернуть виртуальные машины источника и назначения. Чтобы проверить шлюз NAT, установите исходящие подключения по общедоступному IP-адресу из исходной виртуальной машины к виртуальной машине назначения.  В этом учебнике развертываются исходная виртуальная машина и виртуальная машина назначения в двух разных виртуальных сетях, но для простоты — в одной и той же группе ресурсов.

При желании эти действия можно выполнить с помощью [Azure CLI](tutorial-create-validate-nat-gateway-cli.md) или [Azure PowerShell](tutorial-create-validate-nat-gateway-powershell.md) вместо портала.

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на [портал Azure](https://portal.azure.com).

## <a name="prepare-the-source-for-outbound-traffic"></a>Подготовка источника для исходящего трафика

На следующих шагах мы покажем вам, как полностью настроить тестовую среду и выполнить тесты. Мы начнем с источника, который будет использовать ресурс шлюза NAT, созданный в последующих шагах.

## <a name="virtual-network-and-parameters"></a>Виртуальные сети и параметры

Прежде чем развертывать виртуальную машину и использовать шлюз NAT, необходимо создать группу ресурсов и виртуальную сеть.

В этом разделе необходимо заменить в выполняемых действиях указанные параметры приведенными ниже сведениями.

| Параметр                   | Значение                |
|-----------------------------|----------------------|
| **\<resource-group-name>**  | myResourceGroupNAT |
| **\<virtual-network-name>** | myVNetsource          |
| **\<region-name>**          | восточная часть США 2      |
| **\<IPv4-address-space>**   | 192.168.0.0/16          |
| **\<subnet-name>**          | mySubnetsource        |
| **\<subnet-address-range>** | 192.168.0.0/24          |

[!INCLUDE [virtual-networks-create-new](../../includes/virtual-networks-create-new.md)]

## <a name="create-source-virtual-machine"></a>Создание исходной виртуальной машины

Теперь мы создадим виртуальную машину для использования NAT. У этой виртуальной машины будет общедоступный IP-адрес для использования на уровне экземпляра, чтобы вы могли получать доступ к ней. В NAT учитывается направление потоков и заменяется назначение в Интернете по умолчанию в подсети. Общедоступный IP-адрес виртуальной машины не будет использоваться для исходящих соединений.

Чтобы протестировать шлюз NAT, ресурс общедоступного IP-адреса будет назначен как общедоступный IP-адрес уровня экземпляра для доступа к этой виртуальной машине извне. Этот адрес используется, только чтобы получить доступ для теста.  Мы покажем, что настройки NAT будут приоритетнее, чем другие параметры исходящего трафика.

В качестве упражнения можно создать эту виртуальную машину без общедоступного IP-адреса, а также другую виртуальную машину, чтобы использовать ее как инсталяционный сервер без общедоступного IP-адреса.

1. В левом верхнем углу на портале выберите **Создать ресурс** > **Вычисление** > **Ubuntu Server 18.04 LTS** или найдите **Ubuntu Server 18.04 LTS** с помощью функции поиска на Marketplace.

2. В окне **Создание виртуальной машины** введите или выберите следующие значения на вкладке **Основные сведения**:
   - **Подписка** > **Группа ресурсов**. Выберите **myResourceGroupNAT**.
   - **Сведения об экземпляре** > **Имя виртуальной машины**: введите **myVMsource**.
   - **Сведения об экземпляре** > **Регион**: выберите **Восточная часть США 2**.
   - **Учетная запись администратора** > **Authentication enter** (Ввод проверки подлинности): выберите **Пароль**.
   - **Учетная запись администратора**: введите данные в полях **Имя пользователя**, **Пароль** и **Подтверждение пароля**.
   - **Правила для входящих портов** > **Общедоступные входящие порты**. Выберите **Разрешить выбранные порты**.
   - **Правила для входящих портов** > **Выбрать входящие порты**: выберите значение **SSH (22)** .
   - Выберите вкладку **Сеть** или **Далее: диски**, затем **Далее: сеть**.

3. На вкладке **Сети** выберите следующее:
   - **Виртуальная сеть**: **myVnetsource**.
   - **Подсеть**: **mySubnetsource**.
   - **Общедоступный IP-адрес**: **Создать**.  В окне **Создание общедоступного IP-адреса** в поле **Имя** введите **myPublicIPsourceVM**. Выберите **Стандартный** для **SKU**. Сохраните остальные значения по умолчанию и нажмите кнопку **ОК**.
   - **Сетевая группа безопасности сетевого адаптера**. Выберите **Базовый**.
   - **Общедоступные входящие порты**. Выберите **Разрешить выбранные порты**.
   - **Выбрать входящие порты**: подтвердите выбор **SSH**.

4. На вкладке **Управление** в разделе **Мониторинг** задайте значение **Выкл.** для параметра **Диагностика загрузки**.

5. Выберите **Review + create** (Просмотреть и создать).

6. Проверьте параметры и нажмите кнопку **Создать**.

## <a name="create-the-nat-gateway"></a>Создание шлюза NAT

Со шлюзом NAT можно использовать один или несколько ресурсов общедоступных IP-адресов, префиксов общедоступных IP-адресов или оба варианта. Мы добавим ресурс общедоступного IP-адреса, префикс общедоступного IP-адреса, а также ресурс шлюза NAT.

В этом разделе подробно описано, как создать и настроить следующие компоненты NAT с использованием ресурса Шлюза NAT:
  - пул общедоступных IP-адресов и префикс общедоступного IP-адреса, которые будут использоваться для исходящих потоков, преобразованных ресурсом шлюза NAT;
  - изменение значения времени ожидания простоя с 4 минут по умолчанию на 10 минут.

### <a name="create-a-public-ip-address"></a>Создание общедоступного IP-адреса

1. В левом верхнем углу портала выберите **Создать ресурс** > **Сеть** > **Общедоступный IP-адрес** или найдите **Общедоступный IP-адрес** с помощью функции поиска на Marketplace. 

2. В окне **Создать общедоступный IP-адрес** введите или выберите следующую информацию:

    | Параметр | Значение |
    | ------- | ----- |
    | Версия IP-адреса | Выберите значение **IPv4**.
    | номер SKU | Выберите **Стандартная**.
    | Имя | Введите **myPublicIPsource**. |
    | Подписка | Выберите свою подписку.|
    | Группа ресурсов | Выберите **myResourceGroupNAT**. |
    | Расположение | Выберите регион **Восточная часть США 2**.|

3. Сохраните остальные значения по умолчанию и нажмите кнопку **Создать**.

### <a name="create-a-public-ip-prefix"></a>Создание префикса общедоступного IP-адреса

1. В левом верхнем углу портала выберите **Создать ресурс** > **Сеть** > **Общедоступный IP-префикс** или найдите **Общедоступный IP-префикс** с помощью функции поиска на Marketplace.

2. В разделе **Создать общедоступный IP-префикс** на вкладке **Основные сведения** введите или выберите следующие значения:
   - **Подписка** > **Группа ресурсов**. Выберите **myResourceGroupNAT**>
   - **Сведения об экземпляре** > **Имя**: введите **myPublicIPprefixsource**.
   - **Сведения об экземпляре** > **Регион**. Выберите регион **Восточная часть США 2**.
   - **Сведения об экземпляре** > **Размер префикса**: выберите значение **/31 (2 addresses)** (/31 (2 адреса)).

3. Сохраните остальные значения по умолчанию и щелкните **Просмотр и создание**.

4. Проверьте параметры, а затем нажмите кнопку **Создать**.


### <a name="create-a-nat-gateway-resource"></a>Создание ресурса шлюза NAT

1. В левом верхнем углу портала выберите **Создать ресурс** > **Сеть** > **Шлюз NAT** или найдите **Шлюз NAT** с помощью функции поиска на Marketplace.

2. В разделе **Создание шлюза NAT** на вкладке **Основные сведения** введите или выберите следующие значения:
   - **Подписка** > **Группа ресурсов**. Выберите **myResourceGroupNAT**.
   - **Сведения об экземпляре** > **Имя шлюза NAT**: введите **myNATgateway**.
   - **Сведения об экземпляре** > **Регион**. Выберите регион **Восточная часть США 2**.
   - **Сведения об экземпляре** > **Время ожидания простоя (в минутах)** : введите **10**.
   - Перейдите на вкладку **Общедоступный IP-адрес** или выберите **Далее: Общедоступный IP-адрес**.

3. На вкладке **Общедоступный IP-адрес** введите или выберите следующие значения:
   - **Общедоступные IP-адреса** Выберите **myPublicIPsource**.
   - **Общедоступные IP-префиксы**: выберите **myPublicIPprefixsource**.
   - Перейдите на вкладку **Подсеть** или выберите **Далее: Подсеть**.

4. На вкладке **Подсеть** введите или выберите следующие значения:
   - **Виртуальная сеть**. Выберите **myResourceGroupNAT** > **myVnetsource**.
   - **Имя подсети**. Установите флажок рядом с **mySubnetsource**.

5. Выберите **Review + create** (Просмотреть и создать).

6. Проверьте параметры, а затем нажмите кнопку **Создать**.

NAT теперь используется для всего исходящего трафика для назначений в Интернете.  Нет необходимости настраивать UDR.


## <a name="prepare-destination-for-outbound-traffic"></a>Подготовка назначения для исходящего трафика

Теперь мы создадим виртуальную машину назначения для исходящего трафика, преобразовываемого с помощью NAT, чтобы протестировать эту машину.


## <a name="virtual-network-and-parameters-for-destination"></a>Виртуальные сети и параметры для целевого объекта

Перед развертыванием виртуальной машины назначения необходимо создать виртуальную сеть, к которой она может принадлежать. Ниже приведены те же действия, что и для исходной виртуальной машины, с небольшими изменениями для предоставления конечной точки назначения.

В этом разделе необходимо заменить в выполняемых действиях указанные параметры приведенными ниже сведениями.

| Параметр                   | Значение                |
|-----------------------------|----------------------|
| **\<resource-group-name>**  | myResourceGroupNAT |
| **\<virtual-network-name>** | myVNetdestination          |
| **\<region-name>**          | восточная часть США 2      |
| **\<IPv4-address-space>**   | 10.1.0.0/16          |
| **\<subnet-name>**          | mySubnetdestination        |
| **\<subnet-address-range>** | 10.1.0.0/24          |

[!INCLUDE [virtual-networks-create-new](../../includes/virtual-networks-create-new.md)]

## <a name="create-destination-virtual-machine"></a>Создание виртуальной машины назначения

1. В левом верхнем углу на портале выберите **Создать ресурс** > **Вычисление** > **Ubuntu Server 18.04 LTS** или найдите **Ubuntu Server 18.04 LTS** с помощью функции поиска на Marketplace.

2. В окне **Создание виртуальной машины** введите или выберите следующие значения на вкладке **Основные сведения**:
   - **Подписка** > **Группа ресурсов**. Выберите **myResourceGroupNAT**.
   - **Сведения об экземпляре** > **Имя виртуальной машины**: введите **myVMdestination**.
   - **Сведения об экземпляре** > **Регион**: выберите **Восточная часть США 2**.
   - **Учетная запись администратора** > **Authentication enter** (Ввод проверки подлинности): выберите **Пароль**.
   - **Учетная запись администратора**: введите данные в полях **Имя пользователя**, **Пароль** и **Подтверждение пароля**.
   - **Правила для входящих портов** > **Общедоступные входящие порты**. Выберите **Разрешить выбранные порты**.
   - **Правила для входящих портов** > **Выбрать входящие порты**: выберите значения **SSH (22)** и **HTTP (80)** .
   - Выберите вкладку **Сеть** или **Далее: диски**, затем **Далее: сеть**.

3. На вкладке **Сети** выберите следующее:
   - **Виртуальная сеть**: **myVnetdestination**.
   - **Подсеть**: **mySubnetdestination**.
   - **Общедоступный IP-адрес**: **Создать**.  В окне **Создание общедоступного IP-адреса** в поле **Имя** введите **myPublicIPdestinationVM**. Выберите **Стандартный** для **SKU**. Сохраните остальные значения по умолчанию и нажмите кнопку **ОК**.
   - **Сетевая группа безопасности сетевого адаптера**. Выберите **Базовый**.
   - **Общедоступные входящие порты**. Выберите **Разрешить выбранные порты**.
   - **Выбрать входящие порты**: убедитесь, что выбраны **SSH** и **HTTP**.

4. На вкладке **Управление** в разделе **Мониторинг** задайте значение **Выкл.** для параметра **Диагностика загрузки**.

5. Выберите **Review + create** (Просмотреть и создать).

6. Проверьте параметры, а затем нажмите кнопку **Создать**.

## <a name="prepare-a-web-server-and-test-payload-on-destination-vm"></a>Подготовка веб-сервера и тестовых полезных данных для виртуальной машины назначения

Сначала необходимо найти IP-адрес виртуальной машины назначения. 

1. В левой части портала щелкните **Группы ресурсов**.
2. Выберите **myResourceGroupNAT**.
3. Выберите **myVMdestination**.
4. В разделе **Обзор** скопируйте значение в поле **Общедоступный IP-адрес** и вставьте его в блокнот, чтобы использовать для доступа к виртуальной машине.

>[!IMPORTANT]
>Скопируйте общедоступный IP-адрес и вставьте его в блокнот, чтобы его можно было использовать в дальнейшем. Укажите, что это виртуальная машина назначения.

### <a name="sign-in-to-destination-vm"></a>Вход в виртуальную машину назначения

Откройте [Azure Cloud Shell](https://shell.azure.com) в браузере. Используйте IP-адрес, полученный на предыдущем шаге, для подключения к виртуальной машине по протоколу SSH.

```azurecli-interactive
ssh <username>@<ip-address-destination>
```

После входа скопируйте и вставьте следующие команды.  

```bash
sudo apt-get -y update && \
sudo apt-get -y upgrade && \
sudo apt-get -y dist-upgrade && \
sudo apt-get -y autoremove && \
sudo apt-get -y autoclean && \
sudo apt-get -y install nginx && \
sudo ln -sf /dev/null /var/log/nginx/access.log && \
sudo touch /var/www/html/index.html && \
sudo rm /var/www/html/index.nginx-debian.html && \
sudo dd if=/dev/zero of=/var/www/html/100k bs=1024 count=100
```

Эти команды обновят виртуальную машину, установят nginx и создадут файл размером 100 КБ. Этот файл будет извлечен из виртуальной машины источника с помощью NAT.

Закройте сеанс SSH с виртуальной машиной назначения.

## <a name="prepare-test-on-source-vm"></a>Подготовка теста для виртуальной машины источника

Сначала необходимо найти IP-адрес виртуальной машины источника.

1. В левой части портала щелкните **Группы ресурсов**.
2. Выберите **myResourceGroupNAT**.
3. Выберите **myVMsource**.
4. В разделе **Обзор** скопируйте значение в поле **Общедоступный IP-адрес** и вставьте его в блокнот, чтобы использовать для доступа к виртуальной машине.

>[!IMPORTANT]
>Скопируйте общедоступный IP-адрес и вставьте его в блокнот, чтобы его можно было использовать в дальнейшем. Укажите, что это виртуальная машина-источник.

### <a name="log-into-source-vm"></a>Вход в виртуальную машину-источник

Откройте новую вкладку для [Azure Cloud Shell](https://shell.azure.com) в браузере.  Используйте IP-адрес, полученный на предыдущем шаге, для подключения к виртуальной машине по протоколу SSH. 

```azurecli-interactive
ssh <username>@<ip-address-source>
```

Скопируйте и вставьте следующие команды, чтобы подготовиться к тестированию NAT.

```bash
sudo apt-get -y update && \
sudo apt-get -y upgrade && \
sudo apt-get -y dist-upgrade && \
sudo apt-get -y autoremove && \
sudo apt-get -y autoclean && \
sudo apt-get install -y nload golang && \
echo 'export GOPATH=${HOME}/go' >> .bashrc && \
echo 'export PATH=${PATH}:${GOPATH}/bin' >> .bashrc && \
. ~/.bashrc &&
go get -u github.com/rakyll/hey

```

Эти команды обновят виртуальную машину и среду оболочки, установят компоненты Go и [hey](https://github.com/rakyll/hey) из GitHub.

Теперь вы готовы к тестированию NAT.

## <a name="validate-nat-service"></a>Проверка NAT

Войдите в исходную виртуальную машину и используйте **curl** и **hey** для создания запросов по IP-адресу назначения.

Используйте curl для извлечения файла размером 100 КБ.  В примере ниже замените **\<ip-address-destination>** IP-адресом назначения, скопированным ранее.  Параметр **--output** указывает, что полученный файл будет удален.

```bash
curl http://<ip-address-destination>/100k --output /dev/null
```

Можно также создать серию запросов с помощью **hey**. Снова замените **\<ip-address-destination>** IP-адресом назначения, скопированным ранее.

```bash
hey -n 100 -c 10 -t 30 --disable-keepalive http://<ip-address-destination>/100k
```

Эта команда создаст 100 запросов, 10 — параллельных. Время ожидания — 30 секунд, и TCP-соединение не будет использоваться повторно.  Каждый запрос будет получать файл размером 100 КБ.  В конце выполнения **hey** сообщит некоторые статистические данные о качестве работы NAT.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите ставшие ненужными группу ресурсов, шлюз NAT и все связанные ресурсы. Выберите группу ресурсов **myResourceGroupNAT**, которая содержит шлюз NAT, а затем выберите **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия
В этом учебнике вы создали шлюз NAT, виртуальные машины источника и назначения, а затем проверили шлюз NAT.

Просмотрите метрики в Azure Monitor, чтобы проверить работу NAT. Выполните диагностику проблем, таких как нехватка ресурсов доступных портов SNAT.  Эта проблема легко устраняется путем добавления ресурсов общедоступного IP-адреса, ресурсов префикса общедоступного IP-адреса, или их сочетания.

- Дополнительные сведения о [NAT виртуальной сети](./nat-overview.md).
- Дополнительные сведения о [ресурсе шлюза NAT](./nat-gateway-resource.md).
- Краткое руководство по развертыванию [ресурса Шлюза NAT с помощью Azure CLI](./quickstart-create-nat-gateway-cli.md).
- Краткое руководство по развертыванию [ресурса Шлюза NAT с помощью Azure PowerShell](./quickstart-create-nat-gateway-powershell.md).
- Краткое руководство по развертыванию [ресурса Шлюза NAT с помощью портала Azure](./quickstart-create-nat-gateway-portal.md).

> [!div class="nextstepaction"]

