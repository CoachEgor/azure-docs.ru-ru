---
title: Руководство. Маршрутизация сетевого трафика с помощью портала Azure
titlesuffix: Azure Virtual Network
description: В этом руководстве описано, как маршрутизировать сетевой трафик с помощью таблицы маршрутов и портала Azure.
services: virtual-network
documentationcenter: virtual-network
author: KumudD
manager: twooley
editor: ''
tags: azure-resource-manager
Customer intent: I want to route traffic from one subnet, to a different subnet, through a network virtual appliance.
ms.assetid: ''
ms.service: virtual-network
ms.devlang: azurecli
ms.topic: tutorial
ms.tgt_pltfrm: virtual-network
ms.workload: infrastructure
ms.date: 12/12/2018
ms.author: kumud
ms.custom: mvc
ms.openlocfilehash: 153c692a8fb0fa538ec49c6eafa11815dd794b5d
ms.sourcegitcommit: 44a85a2ed288f484cc3cdf71d9b51bc0be64cc33
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64681543"
---
# <a name="tutorial-route-network-traffic-with-a-route-table-using-the-azure-portal"></a>Руководство. Маршрутизация сетевого трафика с помощью таблицы маршрутов с использованием портала Azure

По умолчанию Azure маршрутизирует трафик между всеми подсетями в виртуальной сети. Для переопределения маршрутизации Azure по умолчанию можно создать собственные маршруты. Возможность создания настраиваемых маршрутов полезна, если, к примеру, требуется маршрутизировать трафик между подсетями через виртуальный сетевой модуль. Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание таблицы маршрутов
> * Создание маршрута
> * Создание виртуальной сети с несколькими подсетями
> * Связывание таблицы маршрутов с подсетью
> * создание виртуального сетевого модуля, который перенаправляет трафик;
> * развертывание виртуальных машин в разных подсетях;
> * направление трафика из одной подсети в другую через виртуальный сетевой модуль.

При желании инструкции из этого руководства можно выполнить с помощью [Azure CLI](tutorial-create-route-table-cli.md) или [Azure PowerShell](tutorial-create-route-table-powershell.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на [портале Azure](https://portal.azure.com).

## <a name="create-a-route-table"></a>Создание таблицы маршрутов

1. В верхней левой части экрана последовательно выберите **Создать ресурс** > **Сети** > **Таблица маршрутов**.

1. В подменю **Создание таблицы маршрутов** введите или выберите следующую информацию:

    | Параметр | Значение |
    | ------- | ----- |
    | ИМЯ | Введите *myRouteTablePublic*. |
    | Подписка | Выберите свою подписку. |
    | Группа ресурсов | Выберите **Создать**, а затем введите *myResourceGroup* и нажмите кнопку *ОК*. |
    | Расположение | Оставьте значение по умолчанию **Восточная часть США**.
    | Распространение маршрутов BGP | Оставьте значение по умолчанию **Включено**. |

1. Нажмите кнопку **Создать**.

## <a name="create-a-route"></a>Создание маршрута

1. На портале на панели поиска введите *myRouteTablePublic*.

1. Когда таблица **myRouteTablePublic** появится в результатах поиска, выберите ее.

1. В разделе **Параметры** в подразделе **myRouteTablePublic** выберите **Маршруты** > **+ Добавить**.

    ![Добавление маршрута](./media/tutorial-create-route-table-portal/add-route.png)

1. В подменю **Добавление маршрута** введите или выберите следующую информацию:

    | Параметр | Значение |
    | ------- | ----- |
    | Имя маршрута | Введите *ToPrivateSubnet*. |
    | Префикс адреса | Введите *10.0.1.0/24*. |
    | Тип следующего прыжка | Выберите **Виртуальный модуль**. |
    | Адрес следующего прыжка | Введите *10.0.2.4*. |

1. Нажмите кнопку **ОК**.

## <a name="associate-a-route-table-to-a-subnet"></a>Связывание таблицы маршрутов с подсетью

Чтобы связать таблицу маршрутов с подсетью, необходимо создать виртуальную сеть и подсеть.

### <a name="create-a-virtual-network"></a>Создать виртуальную сеть

1. Вверху с левой стороны экрана последовательно выберите **Создать ресурс** > **Сети** > **Виртуальная сеть**.

1. В подменю **Создать виртуальную сеть** введите или выберите следующую информацию:

    | Параметр | Значение |
    | ------- | ----- |
    | ИМЯ | Введите *myVirtualNetwork*. |
    | Пространство адресов | Введите *10.0.0.0/16*. |
    | Подписка | Выберите свою подписку. |
    | Группа ресурсов | Выберите ***Выбрать существующую*** > **myResourceGroup**. |
    | Расположение | Оставьте значение по умолчанию **Восточная часть США**. |
    | Имя подсети | Введите *Общедоступный*. |
    | Диапазон адреса подсети | Введите *10.0.0.0/24*. |

1. Оставьте остальные значения по умолчанию и нажмите **Создать**.

### <a name="add-subnets-to-the-virtual-network"></a>Добавление подсети в виртуальную сеть

1. На портале в панели поиска введите *myVirtualNetwork*.

1. Когда в результатах поиска появится пункт **myVirtualNetwork**, выберите его.

1. В разделе **Параметры** в подразделе **myVirtualNetwork** выберите **Подсети** > **+ Subnet** (+ Подсеть).

    ![Добавление подсети](./media/tutorial-create-route-table-portal/add-subnet.png)

1. В окне **Добавление подсети** введите следующие сведения:

    | Параметр | Значение |
    | ------- | ----- |
    | ИМЯ | Введите *Частный*. |
    | Пространство адресов | Введите *10.0.1.0/24*. |

1. Сохраните остальные значения по умолчанию и нажмите кнопку **ОК**.

1. Выберите **+ Subnet** (+ Подсеть) снова. На этот раз введите такие значения:

    | Параметр | Значение |
    | ------- | ----- |
    | ИМЯ | Введите *DMZ*. |
    | Пространство адресов | Введите *10.0.2.0/24*. |

1. Как и в прошлый раз оставьте остальные значения по умолчанию и нажмите кнопку **ОК**.

    Azure покажет три подсети: **общедоступную**, **частную** и **DMZ**.

### <a name="associate-myroutetablepublic-to-your-public-subnet"></a>Связывание myRouteTablePublic с вашей общедоступной подсетью

1. Щелкните **Общедоступный**.

1. В разделе **Общедоступные** выберите **Таблица маршрутов** > **MyRouteTablePublic** > **Сохранить**.

    ![Связывание таблицы маршрутов](./media/tutorial-create-route-table-portal/associate-route-table.png)

## <a name="create-an-nva"></a>Создание виртуального сетевого модуля

Виртуальные сетевые модули — это виртуальные машины, которые предназначены для работы с сетевыми функциями, такими как оптимизация маршрутизации и брандмауэра. Если требуется, можно выбрать другую операционную систему. В этом руководстве используется **Windows Server 2016 Datacenter**.

1. В верхней левой части экрана последовательно выберите **Создать ресурс** > **Среда выполнения приложений** > **Windows Server 2016 Datacenter**.

1. В окне **Создание виртуальной машины — Основы** введите или выберите следующую информацию:

    | Параметр | Значение |
    | ------- | ----- |
    | **Сведения о проекте** | |
    | Подписка | Выберите свою подписку. |
    | Группа ресурсов | Выберите **myResourceGroup**. |
    | **Подробности об экземпляре** |  |
    | Имя виртуальной машины | Введите *myVmNva*. |
    | Регион | Выберите **Восточная часть США**. |
    | Параметры доступности | Оставьте значение по умолчанию **No infrastructure redundancy required** (Избыточность инфраструктуры не требуется). |
    | Образ — | Оставьте значение по умолчанию **Microsoft Windows Server 2016 Datacenter**. |
    | Размер | Оставьте значение по умолчанию **Standard DS1 v2**. |
    | **Учетная запись администратора** |  |
    | Имя пользователя | Введите выбранное имя пользователя. |
    | Пароль | Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
    | Подтверждение пароля | Введите пароль еще раз. |
    | **Правила входящего порта** |  |
    | Общедоступные входящие порты | Оставьте значение по умолчанию **Отсутствует**.
    | **Экономия** |  |
    | Already have a Windows license? (У вас уже есть лицензия Windows?) | Оставьте значение по умолчанию **Нет**. |

1. Выберите **Далее: диски**.

1. В окне **Create a virtual machine — Disks** (Создание виртуальной машины — Диски) выберите необходимые параметры.

1. Выберите **Далее: сеть**.

1. В окне **Create a virtual machine — Networking** (Создание виртуальной машины — Сетевые подключения) выберите такую информацию:

    | Параметр | Значение |
    | ------- | ----- |
    | Виртуальная сеть | Оставьте значение по умолчанию **myVirtualNetwork**. |
    | Подсеть | Выберите **DMZ (10.0.2.0/24)**. |
    | Общедоступный IP-адрес | Выберите **Отсутствует**. Вам не требуется общедоступный IP-адрес. Виртуальная машина не будет подключаться через Интернет.|

1. Оставьте остальные значения значениями по умолчанию и нажмите **Далее: управление**.

1. В окне **Создание виртуальной машины — Управление** в поле **Учетная запись хранения диагностики** выберите **Создать**.

1. В подменю **Создание учетной записи хранения** введите или выберите следующую информацию:

    | Параметр | Значение |
    | ------- | ----- |
    | ИМЯ | Введите *mynvastorageaccount*. |
    | Тип учетной записи | Оставьте значение по умолчанию **Storage (general purpose v1)** (Хранилище (общего назначения версии 1)). |
    | Производительность | Оставьте значение по умолчанию **Стандартная**. |
    | Репликация | Оставьте значение по умолчанию **Локально избыточное хранилище (LRS)**.

1. Нажмите кнопку **ОК**.

1. Выберите **Review + create** (Просмотреть и создать). Вы будете перенаправлены на страницу **Review + create** (Просмотр и создание), и Azure проверит вашу конфигурацию.

1. Когда увидите оповещение **Проверка пройдена**, щелкните **Создать**.

    Создание виртуальной машины занимает несколько минут. Не продолжайте работу, пока Azure не завершит создание виртуальной машины. На странице **Развертывание выполняется** вы увидите сведения о развертывании.

1. После создания виртуальной машины выберите **Перейти к ресурсу**.

## <a name="turn-on-ip-forwarding"></a>Включение IP-пересылки

Включите IP-пересылку для *myVmNva*. Когда Azure отправляет трафик к *myVmNva*, а он предназначается для других IP-адресов, IP-пересылка будет перенаправлять трафик в правильное расположение.

1. В разделе **Параметры** в подразделе **myVmNva** выберите **Сеть**.

1. Выберите **myvmnva123**. Это сетевой интерфейс Azure, созданный для вашей виртуальной машины. Строка из чисел, из которой он состоит, делает его уникальным.

    ![Сеть виртуальной машины](./media/tutorial-create-route-table-portal/virtual-machine-networking.png)

1. Выберите **Конфигурации IP** в разделе **Параметры**.

1. В окне **myvmnva123 — IP configurations** (myvmnva123 — Конфигурации IP) в поле **IP-пересылка** выберите **Включено**, а затем нажмите **Сохранить**.

    ![Включение IP-пересылки](./media/tutorial-create-route-table-portal/enable-ip-forwarding.png)

## <a name="create-public-and-private-virtual-machines"></a>Создание общедоступных и частных виртуальных машин

Создайте общедоступную и частную виртуальную машину в виртуальной сети. Вы будете их использовать для просмотра, чтобы убедиться, что Azure направляет трафик *общедоступной* подсети в *частную* подсеть через виртуальные сетевые модули.

Выполните шаги 1–12 из раздела [Создание виртуального сетевого модуля](#create-an-nva). Используйте большую часть тех же параметров. Ниже перечислены значения, которые должны отличаться:

| Параметр | Значение |
| ------- | ----- |
| **Public VM** (Общедоступная виртуальная машина) | |
| ОСНОВНЫЕ ДАННЫЕ |  |
| Имя виртуальной машины | Введите *myVmPublic*. |
| СЕТИ | |
| Подсеть | Выберите **Public (10.0.0.0/24)** (Публичная (10.0.0.0/24)). |
| Общедоступный IP-адрес | Примите значение по умолчанию. |
| Общедоступные входящие порты | Выберите **Разрешить выбранные порты**. |
| Выбрать входящие порты | Выберите **HTTP** и **RDP**. |
| УПРАВЛЕНИЕ | |
| Учетная запись хранения для диагностики | Оставьте значение по умолчанию **mynvastorageaccount**. |
| **Private VM** (Частная виртуальная машина) | |
| ОСНОВНЫЕ ДАННЫЕ |  |
| Имя виртуальной машины | Введите *myVmPrivate*. |
| СЕТИ | |
| Подсеть | Выберите **Private (10.0.1.0/24)** (Частная (10.0.1.0/24)). |
| Общедоступный IP-адрес | Примите значение по умолчанию. |
| Общедоступные входящие порты | Выберите **Разрешить выбранные порты**. |
| Выбрать входящие порты | Выберите **HTTP** и **RDP**. |
| УПРАВЛЕНИЕ | |
| Учетная запись хранения для диагностики | Оставьте значение по умолчанию **mynvastorageaccount**. |

Вы можете заняться созданием виртуальной машины *myVmPrivate*, пока Azure создает виртуальную машину *myVmPublic*. Прежде чем переходить к оставшимся действиям, дождитесь, пока Azure создаст обе виртуальные машины.

## <a name="route-traffic-through-an-nva"></a>Перенаправление трафика через виртуальный сетевой модуль

### <a name="sign-in-to-myvmprivate-over-remote-desktop"></a>Вход в myVmPrivate через удаленный рабочий стол

1. На портале в панели поиска введите *myVmPrivate*.

1. Когда в результатах поиска появится виртуальная машина **myVmPrivate**, щелкните ее.

1. Выберите **Подключиться**, чтобы создать подключения удаленного рабочего стола для виртуальной машины *myVmPrivate*.

1. В окне **Connect to virtual machine** (Подключение к виртуальной машине) выберите **Скачать RDP-файл**. Azure создаст и скачает на ваш компьютер файл протокола удаленного рабочего стола (*RDP*).

1. Откройте скачанный файл *RDP*.

    1. При появлении запроса выберите **Подключиться**.

    1. Введите имя пользователя и пароль, указанные при создании частной виртуальной машины.

    1. Чтобы использовать учетные данные частной виртуальной машины, может понадобиться выбрать **More choices** (Дополнительные варианты)  > **Использовать другую учетную запись**.

1. Нажмите кнопку **ОК**.

    При входе в систему может появиться предупреждение о сертификате.

1. Выберите **Да**, чтобы подключиться к виртуальной машине.

### <a name="enable-icmp-through-the-windows-firewall"></a>Разрешите трафик ICMP в брандмауэре Windows

Для проверки маршрутизации вы позже будете использовать средство трассировки маршрута. Средство трассировки маршрута использует протокол ICMP, который по умолчанию запрещен в брандмауэре Windows. Разрешите трафик ICMP в брандмауэре Windows.

1. На удаленном рабочем столе *myVmPrivate* откройте PowerShell.

1. Введите эту команду:

    ```powershell
    New-NetFirewallRule –DisplayName “Allow ICMPv4-In” –Protocol ICMPv4
    ```

    Для проверки маршрутизации в этом руководстве используется трассировка маршрута. Мы не рекомендуем разрешать протокол ICMP в брандмауэре Windows в рабочей среде.

### <a name="turn-on-ip-forwarding-within-myvmnva"></a>Включение IP-пересылки в myVmNva

Вы [включили IP-пересылку](#turn-on-ip-forwarding) для сетевого интерфейса виртуальной машины с помощью Azure. Операционная система виртуальной машины также должна переадресовывать сетевой трафик. Включите IP-пересылку для операционной системы виртуальной машины *myVmNva* с помощью следующих команд.

1. Из командной строки виртуальной машины *myVmPrivate* откройте удаленный рабочий стол виртуальной машины *myVmNva*:

    ```cmd
    mstsc /v:myvmnva
    ```

1. В PowerShell на виртуальной машине *myVmNva* введите следующую команду, чтобы включить IP-пересылку:

    ```powershell
    Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters -Name IpEnableRouter -Value 1
    ```

1. Перезапустите виртуальную машину *myVmNva*. На панели задач выберите **Start button** (Кнопка "Пуск") > **Power button** (Кнопка питания), **Other (Planned)** (Другое (запланированное)) > **Continue** (Продолжить).

    Это прервет сеанс входа в систему.

1. После перезапуска виртуальной машины *myVmNva* создайте сеанс входа в систему с виртуальной машиной *myVmPublic*. Во время подключения к виртуальной машине *myVmPrivate* откройте командную строку и выполните следующую команду:

    ```cmd
    mstsc /v:myVmPublic
    ```
1. На удаленном рабочем столе *myVmPublic* откройте PowerShell.

1. Разрешите протокол ICMP в брандмауэре Windows, введя следующую команду:

    ```powershell
    New-NetFirewallRule –DisplayName “Allow ICMPv4-In” –Protocol ICMPv4
    ```

## <a name="test-the-routing-of-network-traffic"></a>Проверка маршрутизации сетевого трафика

Сначала протестируйте маршрутизацию сетевого трафика из виртуальной машины *myVmPublic* в виртуальную машину *myVmPrivate*.

1. В PowerShell на виртуальной машине *myVmPublic* введите следующую команду:

    ```powershell
    tracert myVmPrivate
    ```

    Вы получите ответ, аналогичный приведенному ниже примеру:

    ```powershell
    Tracing route to myVmPrivate.vpgub4nqnocezhjgurw44dnxrc.bx.internal.cloudapp.net [10.0.1.4]
    over a maximum of 30 hops:

    1    <1 ms     *        1 ms  10.0.2.4
    2     1 ms     1 ms     1 ms  10.0.1.4

    Trace complete.
    ```

    Вы увидите, что первым прыжком является 10.0.2.4. Это частный IP-адрес виртуального сетевого модуля. Второй прыжок — это частный IP-адрес виртуальной машины *myVmPrivate*: 10.0.1.4. Ранее в таблицу маршрутов *myRouteTablePublic* вы добавили маршрут и связали его с *общедоступной* подсетью. Таким образом, Azure передает трафик через виртуальный сетевой модуль, а не непосредственно к *частной* подсети.

1. Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmPublic*, сохраняя подключение к виртуальной машине *myVmPrivate*.

1. В командную строку виртуальной машины *myVmPrivate* введите следующую команду:

    ```cmd
    tracert myVmPublic
    ```

    Таким образом будет проверена маршрутизация сетевого трафика из виртуальной машины *myVmPrivate* в виртуальную машину *myVmPublic*. Вы получите ответ, аналогичный приведенному ниже примеру:

    ```cmd
    Tracing route to myVmPublic.vpgub4nqnocezhjgurw44dnxrc.bx.internal.cloudapp.net [10.0.0.4]
    over a maximum of 30 hops:

    1     1 ms     1 ms     1 ms  10.0.0.4

    Trace complete.
    ```

    Вы увидите, что Azure маршрутизирует трафик непосредственно из виртуальной машины *myVmPrivate* на виртуальную машину *myVmPublic*. По умолчанию Azure маршрутизирует трафик между подсетями напрямую.

1. Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmPrivate*.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов и все содержащиеся в ней ресурсы, когда она станет не нужна.

1. На портале на панели поиска введите *myResourceGroup*.

1. Когда группа ресурсов **myResourceGroup** появится в результатах поиска, выберите ее.

1. Выберите **Удалить группу ресурсов**.

1. Введите *myResourceGroup* в поле **TYPE THE RESOURCE GROUP NAME:** (Введите имя группы ресурсов:) и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

При работе с этим руководстве вы создали таблицу маршрутов и связали ее с подсетью. Вы также создали простой виртуальный сетевой модуль, который направляет трафик из общедоступной подсети в частную подсеть. Теперь, когда вы знаете, как это сделать, можно развернуть различные предварительно настроенные виртуальные сетевые модули из [Microsoft Azure Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/category/networking). Они выполняют много полезных сетевых функций, которые вам понадобятся. См. дополнительные сведения о [маршрутизации](virtual-networks-udr-overview.md) и [управлении таблицей маршрутов](manage-route-table.md).

Хотя в виртуальной сети можно развернуть множество ресурсов, Azure не может развертывать ресурсы в виртуальную сеть для некоторых служб PaaS. Однако можно ограничить доступ к ресурсам некоторых служб PaaS. Это ограничение должно касаться только трафика из подсети виртуальной сети. Перейдите к следующему руководству, чтобы узнать, как ограничить сетевой доступ к ресурсам Azure PaaS.

> [!div class="nextstepaction"]
> [Настройка конечных точек служб виртуальной сети](tutorial-restrict-network-access-to-resources.md)
