---
title: Руководство. Создание геозоны и отслеживание устройств на карте | Microsoft Azure Maps
description: Сведения о настройке геозоны и отслеживании устройств относительно геозоны с помощью службы пространственных данных Microsoft Azure Maps.
author: walsehgal
ms.author: v-musehg
ms.date: 1/15/2020
ms.topic: tutorial
ms.service: azure-maps
services: azure-maps
manager: timlt
ms.custom: mvc
ms.openlocfilehash: 932dfb9624177c299997c4f9f184dc5c973d0fa0
ms.sourcegitcommit: 67e9f4cc16f2cc6d8de99239b56cb87f3e9bff41
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/31/2020
ms.locfileid: "76899216"
---
# <a name="tutorial-set-up-a-geofence-by-using-azure-maps"></a>Руководство. Настройка геозоны с использованием Azure Maps

Это руководство поможет выполнить основные действия по настройке геозоны с помощью Azure Maps. Давайте рассмотрим такой сценарий: диспетчер строительного объекта должен отслеживать потенциально опасное оборудование. Ему важно следить за тем, чтобы это оборудование всегда находилось в определенных областях строительной площадки. Допустимая область строительной площадки является жестко заданным параметром. В нормативных требованиях указано, что оборудование всегда должно оставаться в этой области и о любых нарушениях необходимо уведомлять производственного директора.  

Мы применим API отправки данных для хранения данных о геозоне, а также API геозоны для проверки расположения оборудования относительно этой геозоны. API передачи данных и API геозоны предоставляются в службе Azure Maps. Мы будем использовать Сетку событий Azure для потоковой передачи результатов проверки геозоны и создавать уведомления на основе этих результатов. Дополнительные сведения о Сетке событий Azure см. в статье [Что такое служба "Сетка событий Azure"?](https://docs.microsoft.com/azure/event-grid/overview)

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Передача данных о геозоне в службу данных Azure Maps с помощью API отправки данных.
> *   Настройка Сетки событий для обработки событий геозоны.
> *   Настройка обработчика событий геозоны.
> *   Настройка оповещений на основе событий геозоны с помощью Logic Apps.
> *   Проверка нахождения оборудования на строительной площадке с помощью API службы геозоны Azure Maps.


## <a name="prerequisites"></a>предварительные требования

### <a name="create-an-azure-maps-account"></a>создание учетной записи службы Azure Maps 

Создайте подписку Azure Maps с ценовой категорией S1 по [этим инструкциям](quick-demo-map-app.md#create-an-account-with-azure-maps). В [этом разделе](quick-demo-map-app.md#get-the-primary-key-for-your-account) приводятся инструкции по получению первичного ключа для учетной записи. Дополнительные сведения о проверке подлинности в Azure Maps см. в [этой статье](./how-to-manage-authentication.md).

## <a name="upload-geofences"></a>Отправка данных о геозоне

Предположим, что основной геозоной является subsite1, для которой указан срок действия. В основной геозоне вы можете создать вложенные геозоны в соответствии с вашими требованиями. Этот набор дополнительных геозон можно применить для отслеживания разных участков на строительной площадке. Например, в геозоне subsite1 работы выполняются с 1-й по 4-ю неделю. А subsite2 обозначает участок, где работы ведутся с 5-й по 7-ю неделю. Все эти геозоны можно добавить как один набор данных в начале проекта. Далее они используются для отслеживания правил на основе времени и места. 

Чтобы передать данные о геозоне строительной площадки через API отправки данных, мы воспользуемся приложением Postman. Установите [приложение Postman](https://www.getpostman.com/) и создайте бесплатную учетную запись. 

Когда завершится установка Postman, выполните приведенные далее инструкции по отправке данных о геозоне строительной площадки с использованием API отправки данных службы Azure Maps.

1. Откройте приложение Postman и в раскрывающемся списке "New" (Новый) щелкните "Create New" (Создать новый) и выберите "Request" (Запрос). Введите имя запроса, чтобы отправить данные о геозоне, выберите коллекцию или папку, в которую нужно их сохранить, и щелкните Save (Сохранить).

    ![Отправка данных о геозоне с помощью Postman](./media/tutorial-geofence/postman-new.png)

2. Выберите метод POST HTTP на вкладке конструктора и введите следующий URL-адрес для выполнения запроса POST.

    ```HTTP
    https://atlas.microsoft.com/mapData/upload?subscription-key={subscription-key}&api-version=1.0&dataFormat=geojson
    ```
    
    Параметр GEOJSON в пути URL-адреса определяет формат отправляемых данных.

3. Щелкните **Params** (Параметры) и введите следующие пары "ключ — значение" для URL-адреса запроса POST. Замените заполнитель {subscription-key} ключом подписки Azure Maps, который называется также первичным ключом.
   
    ![Параметры для отправки данных (геозоны) в Postman](./media/tutorial-geofence/postman-key-vals.png)

4. Щелкните **Body** (Текст) и выберите необработанный формат входных данных, а также JSON в качестве формата входных данных в соответствующем раскрывающемся списке. Введите следующие данные для отправки в формате JSON:

   ```JSON
   {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  -122.13393688201903,
                  47.63829579223815
                ],
                [
                  -122.13389128446579,
                  47.63782047131512
                ],
                [
                  -122.13240802288054,
                  47.63783312249837
                ],
                [
                  -122.13238388299942,
                  47.63829037035086
                ],
                [
                  -122.13393688201903,
                  47.63829579223815
                ]
              ]
            ]
          },
          "properties": {
            "geometryId": "1"
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  -122.13374376296996,
                  47.63784758098976
                ],
                [
                  -122.13277012109755,
                  47.63784577367854
                ],
                [
                  -122.13314831256866,
                  47.6382813338708
                ],
                [
                  -122.1334782242775,
                  47.63827591198201
                ],
                [
                  -122.13374376296996,
                  47.63784758098976
                ]
              ]
            ]
          },
          "properties": {
            "geometryId": "2",
            "validityTime": {
              "expiredTime": "2019-01-15T00:00:00",
              "validityPeriod": [
                {
                  "startTime": "2019-01-08T01:00:00",
                  "endTime": "2019-01-08T17:00:00",
                  "recurrenceType": "Daily",
                  "recurrenceFrequency": 1,
                  "businessDayOnly": true
                }
              ]
            }
          }
        }
      ]
   }
   ```

5. Отправьте данные и проверьте заголовок ответа. Если запрос выполнен успешно, заголовок **Location** будет содержать URI проверки состояния. URI проверки состояния имеет следующий формат. 

   ```HTTP
   https://atlas.microsoft.com/mapData/{uploadStatusId}/status?api-version=1.0
   ```

6. Скопируйте URI проверки состояния и добавьте к нему ключ подписки. Итоговый URI проверки состояния должен иметь примерно такой формат. Обратите внимание, что в этом формате нужно заменить строку {subscription-key}, включая фигурные скобки {}, значением ключа подписки.

   ```HTTP
   https://atlas.microsoft.com/mapData/{uploadStatusId}/status?api-version=1.0&subscription-key={Subscription-key}
   ```

7. Чтобы получить значение `udId`, откройте новую вкладку в приложении Postman и выберите метод HTTP GET на вкладке конструктора. Выполните запрос GET по URI проверки состояния, который вы получили на предыдущем шаге. Если передача данных пройдет успешно, вы получите в тексте ответа значение udId. Скопируйте этот udId для последующего использования.

   ```JSON
   {
    "udid" : "{udId}"
   }
   ```

## <a name="set-up-an-event-handler"></a>Настройка обработчика событий

В этом разделе показано, как создать обработчик событий, который получает уведомления. Этот обработчик событий должен уведомлять производственного директора о событиях входа в геозону и выхода из нее для любого оборудования.

Мы создадим два экземпляра службы [Logic Apps](https://docs.microsoft.com/azure/event-grid/event-handlers#logic-apps) для обработки событий пересечения границ геозоны. При возникновении событий в приложений логики последовательно активируются дополнительные события. Задача заключается в том, чтобы отправлять оповещения производственному директору, в нашем примере по электронной почте. Снимок экрана демонстрирует создание приложения логики для геозоны, которое контролирует поступление оборудования. Аналогичным образом можно создать приложение, которое контролирует перемещение оборудования за пределы геозоны. Дополнительные сведения см. в статье [Обработчики событий в службе "Сетка событий Azure"](https://docs.microsoft.com/azure/event-grid/event-handlers).

1. Создайте приложение логики на портале Azure.

   ![Создание Azure Logic Apps для управления событиями геозоны](./media/tutorial-geofence/logic-app.png)

2. В меню параметров для приложения логики перейдите к элементу **Конструктор приложений логики**.

3. Выберите триггер HTTP-запроса, а затем выберите "Новый шаг". В соединителе Outlook выберите действие "Отправка сообщения электронной почты".
  
   ![Схема приложения логики](./media/tutorial-geofence/logic-app-schema.png)

4. Заполните поля для отправки сообщения электронной почты. Оставьте пустым поле URL-адреса HTTP. Этот адрес будет создан автоматически, когда вы нажмете кнопку "Сохранить".

   ![Создание конечной точки Logic Apps](./media/tutorial-geofence/logic-app-endpoint.png)

5. Сохраните приложение логики, чтобы создать конечную точку URL-адреса HTTP и скопируйте URL-адрес HTTP.

## <a name="create-an-azure-maps-events-subscription"></a>Создайте подписку на события Azure Maps.

Azure Maps поддерживает три типа событий. Сведения о типах событий, поддерживаемых Azure Maps, см. [в этой статье](https://docs.microsoft.com/azure/event-grid/event-schema-azure-maps). Нам нужны две разные подписки на события: одна для события входа и другая для событий выхода.

Выполните следующие действия, чтобы создать подписку на события поступления оборудования в геозону. Создать подписку на события вывоза оборудования можно таким же образом.

1. Перейдите к учетной записи Azure Maps. На панели мониторинга выберите "Подписки". Щелкните имя нужной подписки и выберите **События** в меню параметров.

   ![Переход к событиям учетной записи Azure Maps](./media/tutorial-geofence/events-tab.png)

2. Чтобы создать подписку на события, выберите "Подписка на события" на странице событий.

   ![Создайте подписку на события Azure Maps.](./media/tutorial-geofence/create-event-subscription.png)

3. Задайте имя подписке на события и подпишитесь на событие поступления оборудования. Выберите значение "Веб-перехватчик" для параметра "Тип конечной точки". Щелкните "Выбрать конечную точку" и укажите значение URL-адреса конечной точки HTTP для приложения логики вместо заполнителя {Endpoint}.

   ![Детали подписки на события Azure Maps](./media/tutorial-geofence/events-subscription.png)


## <a name="use-geofence-api"></a>Использование API геозоны

С помощью API геозоны можно проверять, находится ли **устройство** (в нашем примере это строительное оборудование) в пределах или за пределами геозоны. Давайте отправим запрос GET в API геозоны, чтобы получить разные расположения, куда периодически перемещается оборудование. На приведенном ниже рисунке показаны пять расположений для пяти объектов оборудования. 

> [!Note]
> В этом сценарии и механизме используется один **идентификатор устройства**, расположение которого фиксировалось в пяти разных местах, как показано на рисунке.

Уникальный идентификатор deviceId устройства вы указываете в запросе GET, чтобы получить расположение устройства. При выполнении асинхронного запроса GET к **API поиска по геозоне** значение deviceId используется для публикации событий геозоны для указанного устройства относительно указанной геозоны. В рамках этого руководства мы выполняли асинхронные запросы к API с уникальным идентификатором deviceId. В руководстве описывается выполнение запросов в хронологическом порядке, как показано на схеме. Свойство isEventPublished в ответе публикуется каждый раз, когда устройство входит в геозону или выходит из нее. Вам не нужно регистрировать устройство, чтобы выполнить инструкции из этого руководства.

Давайте вернемся к нашей схеме. Каждое из этих расположений оценивается для проверки того, находится ли устройство в пределах или за пределами геозоны. Если происходит изменение состояния, служба геозоны активирует событие, которое направляется в приложение логики Сеткой событий. В итоге производственный директор получит по электронной почте сообщение о входе или выходе.

![Схема геозоны в Azure Maps](./media/tutorial-geofence/geofence.png)

В приложении Postman откройте новую вкладку в ранее созданной коллекции. Выберите метод GET HTTP на вкладке конструктора.

Ниже показаны пять запросов HTTP GET к API геозоны с разными координатами расположения оборудования. Эти координаты отображаются в хронологическом порядке. Каждый запрос сопровождается текстом ответа.
 
1. Расположение 1
    
   ```HTTP
   https://atlas.microsoft.com/spatial/geofence/json?subscription-key={subscription-key}&api-version=1.0&deviceId=device_01&udId={udId}&lat=47.638237&lon=-122.1324831&searchBuffer=5&isAsync=True&mode=EnterAndExit
   ```
   ![Первый запрос данных о геозоне](./media/tutorial-geofence/geofence-query1.png)

   В приведенном выше ответе отрицательное значение расстояния от основной геозоны означает, что оборудование находится в этой геозоне. Положительное значение расстояния от дочерней геозоны означает, что оборудование находится за пределами этой геозоны. 

2. Расположение 2: 
   
   ```HTTP
   https://atlas.microsoft.com/spatial/geofence/json?subscription-key={subscription-key}&api-version=1.0&deviceId=device_01&udId={udId}&lat=47.63800&lon=-122.132531&searchBuffer=5&isAsync=True&mode=EnterAndExit
   ```
    
   ![Второй запрос данных о геозоне](./media/tutorial-geofence/geofence-query2.png)

   Из приведенного выше ответа в формате JSON следует, что оборудование находится за пределами дочерней геозоны, но в границах основной геозоны. События не инициируются и сообщение электронной почты не отправляется.

3. Расположение 3 
  
   ```HTTP
   https://atlas.microsoft.com/spatial/geofence/json?subscription-key={subscription-key}&api-version=1.0&deviceId=device_01&udId={udId}&lat=47.63810783315048&lon=-122.13336020708084&searchBuffer=5&isAsync=True&mode=EnterAndExit
   ```

   ![Третий запрос данных о геозоне](./media/tutorial-geofence/geofence-query3.png)

   Произошло изменение состояния, и оборудование теперь находится как в основной, так и в дочерней геозоне. Такое изменение активирует событие и уведомления о нем отправляются по электронной почте производственному директору.

4. Расположение 4 

   ```HTTP
   https://atlas.microsoft.com/spatial/geofence/json?subscription-key={subscription-key}&api-version=1.0&deviceId=device_01&udId={udId}&lat=47.637988&lon=-122.1338344&searchBuffer=5&isAsync=True&mode=EnterAndExit
   ```
  
   ![Четвертый запрос данных о геозоне](./media/tutorial-geofence/geofence-query4.png)

   Из ответа видно, что, хотя оборудование и покинуло дочернюю геозону, событие не было инициировано. Если обратить внимание на указанное пользователем время в запросе GET, видно, что срок действия геозоны к этому времени истек. Оборудование по-прежнему находится в основной геозоне. В строке ответа `expiredGeofenceGeometryId` также можно увидеть идентификатор геометрии дочерней геозоны.


5. Расположение 5
      
   ```HTTP
   https://atlas.microsoft.com/spatial/geofence/json?subscription-key={subscription-key}&api-version=1.0&deviceId=device_01&udId={udId}&lat=47.63799&lon=-122.134505&userTime=2019-01-16&searchBuffer=5&isAsync=True&mode=EnterAndExit
   ```

   ![Пятый запрос данных о геозоне](./media/tutorial-geofence/geofence-query5.png)

   Видно, что оборудование покинуло основную геозону строительной площадки. Публикуется событие, и производственному директору отправляется оповещение по электронной почте.

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как настраивать геозону, передавая ее данные в службу данных Azure Maps с помощью API отправки данных. Вы также научились подписываться на события геозоны и обрабатывать их в Сетке событий Azure Maps. 

* Сведения о создании более сложной логики с помощью Logic Apps и данных в формате JSON см. в статье [Обработка типов содержимого в Azure Logic Apps](https://docs.microsoft.com/azure/logic-apps/logic-apps-content-type).
* Дополнительные сведения об обработчиках событий в службе "Сетка событий" см. в статье [Обработчики событий в службе "Сетка событий Azure"](https://docs.microsoft.com/azure/event-grid/event-handlers).
