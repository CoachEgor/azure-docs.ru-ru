---
title: Руководство по реализации пространственной аналитики Интернета вещей с помощью Microsoft Azure Maps
description: Интеграция Центра Интернета вещей с API-интерфейсами службы Azure Maps.
author: anastasia-ms
ms.author: v-stharr
ms.date: 09/01/2020
ms.topic: tutorial
ms.service: azure-maps
services: azure-maps
manager: philmea
ms.custom: mvc
ms.openlocfilehash: 4150464b5c59b631afea0c788b1e351dee5185f9
ms.sourcegitcommit: 58d3b3314df4ba3cabd4d4a6016b22fa5264f05a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/02/2020
ms.locfileid: "89299412"
---
# <a name="tutorial-implement-iot-spatial-analytics-using-azure-maps"></a>Руководство по Реализация пространственной аналитики Интернета вещей с помощью Azure Maps

В сценарии IoT зачастую фиксируются и отслеживаются соответствующие события, происходящие в пространстве и времени. Примеры таких сценариев: управление автопарком, отслеживание активов, приложения мобильности и "умного" города. В этом учебнике вы изучите решение, которое отслеживает передвижение арендованных автомобилей, используя API-интерфейсы Azure Maps.

Изучив данный учебник, вы научитесь:

> [!div class="checklist"]
> * Создавать учетную запись хранения Azure для записи данных отслеживания автомобилей.
> * Передавать данные о геозоне в службу данных Azure Maps с помощью API отправки данных.
> * Создавать Центр Интернета вещей и регистрировать устройства.
> * Создавать функции в Функциях Azure, которая реализует бизнес-логику на основе пространственной аналитики Azure Maps.
> * Подписываться на события телеметрии устройств Интернета вещей из функции Azure через службу "Сетка событий".
> * Фильтровать события телеметрии с помощью маршрутизации сообщений, предоставляемой Центром Интернета вещей.

## <a name="prerequisites"></a>Предварительные требования

1. Войдите на [портал Azure](https://portal.azure.com).

2. [Создайте учетную запись службы Azure Maps.](quick-demo-map-app.md#create-an-azure-maps-account)

3. [Получите первичный ключ подписки](quick-demo-map-app.md#get-the-primary-key-for-your-account), который иногда называется первичным ключом или ключом подписки. Дополнительные сведения о проверке подлинности в Azure Maps см. в [этой статье](how-to-manage-authentication.md).

4. [Создайте группу ресурсов.](https://docs.microsoft.com/azure/azure-resource-manager/management/manage-resource-groups-portal#create-resource-groups) В этом учебнике мы назовем нашу группу ресурсов *ContosoRental*, но можно выбрать любое имя.

5. Скачайте проект C# [rentalCarSimulation](https://github.com/Azure-Samples/iothub-to-azure-maps-geofencing/tree/master/src/rentalCarSimulation).

В этом руководстве используется приложение [Postman](https://www.postman.com/), но вы можете выбрать другую среду разработки API.

## <a name="use-case-rental-car-tracking"></a>Вариант использования: отслеживание арендованных автомобилей

Ниже перечислены рассматриваемые в данном учебнике сценарии. Компания по аренде автомобилей хочет регистрировать информацию о местоположении, пройденном расстоянии и рабочем состоянии своих транспортных средств. Кроме того, компания хочет сохранять эти сведения каждый раз, когда автомобиль покидает правильный авторизованный географический регион.

В нашем варианте использования арендованные автомобили оснащаются устройствами Интернета вещей, которые регулярно отправляют данные телеметрии в Центр Интернета вещей Azure. Данные телеметрии содержат текущее расположение и сведения о том, работает ли двигатель автомобиля. Схема расположения устройств соответствует схеме [IoT Plug and Play для геопространственных данных.](https://github.com/Azure/opendigitaltwins-dtdl/blob/master/DTDL/v1-preview/schemas/geospatial.md) Схема телеметрии устройства для арендованного автомобиля выглядит примерно так как следующий код JSON:

```JSON
{
    "data": {
        "properties": {
            "Engine": "ON"
        },
        "systemProperties": {
            "iothub-content-type": "application/json",
            "iothub-content-encoding": "utf-8",
            "iothub-connection-device-id": "ContosoRentalDevice",
            "iothub-connection-auth-method": "{\"scope\":\"device\",\"type\":\"sas\",\"issuer\":\"iothub\",\"acceptingIpFilterRule\":null}",
            "iothub-connection-auth-generation-id": "636959817064335548",
            "iothub-enqueuedtime": "2019-06-18T00:17:20.608Z",
            "iothub-message-source": "Telemetry"
        },
        "body": {
            "location": {
                "type": "Point",
                "coordinates": [ -77.025988698005662, 38.9015330523316 ]
            }
        }
    }
}
```

В этом учебнике мы будем отслеживать только один автомобиль. После настройки служб Azure необходимо скачать проект C# [rentalCarSimulation](https://github.com/Azure-Samples/iothub-to-azure-maps-geofencing/tree/master/src/rentalCarSimulation), чтобы запустить симулятор автомобиля. Весь процесс, от события к исполнению функций, приведен в следующих шагах:

1. Устройство, которое находится в автомобиле, отправляет данные телеметрии в центр Интернета вещей.

2. Если двигатель автомобиля работает, центр Интернета вещей публикует данные телеметрии в Сетке событий.

3. Функция Azure срабатывает из-за подписки на события телеметрии устройства.

4. Функция будет регистрировать координаты расположения устройства автомобиля, время события и идентификатор устройства. Затем он будет использовать [API определения пространственной геозоны](https://docs.microsoft.com/rest/api/maps/spatial/getgeofence), чтобы определить, выехал ли автомобиль за пределы геозоны. Если он находится за пределами геозоны, функция сохраняет данные о местоположении, полученные от события, в наш контейнер больших двоичных объектов. Кроме того, наша функция запрашивает [обратный поиск адресов](https://docs.microsoft.com/rest/api/maps/search/getsearchaddressreverse), чтобы перевести координаты местоположения в адрес улицы и сохранить его с остальными данными о расположении устройства.

На следующей схеме представлено обобщенное описание всей системы.

   :::image type="content" source="./media/tutorial-iot-hub-maps/system-diagram.png" border="false" alt-text="Обзор системы":::

На следующем рисунке представлена область геозоны, выделенная синим цветом. Маршрут арендованного автомобиля обозначен зеленой линией.

   :::image type="content" source="./media/tutorial-iot-hub-maps/geofence-route.png" border="false" alt-text="Маршрут по геозоне":::

## <a name="create-an-azure-storage-account"></a>Создание учетной записи хранения Azure

Чтобы сохранить данные отслеживания нарушений автомобиля, создайте [учетную запись хранения общего назначения версии 2](https://docs.microsoft.com/azure/storage/common/storage-account-overview#general-purpose-v2-accounts) в группе ресурсов. Если вы еще не создали группу ресурсов, следуйте указаниям в разделе [Создание группы ресурсов](https://docs.microsoft.com/azure/azure-resource-manager/management/manage-resource-groups-portal#create-resource-groups). В этом учебнике мы назовем нашу группу ресурсов *ContosoRental*.

Чтобы создать учетную запись хранения, следуйте инструкциям в статье [Создание учетной записи хранения Azure](https://docs.microsoft.com/azure/storage/common/storage-account-create?tabs=azure-portal). В этом учебнике мы используем имя учетной записи хранения *contosorentalstorage*, но можно назвать ее как угодно.

После успешного создания учетной записи хранения необходимо создать контейнер для хранения данных журнала.

1. Вернитесь к только что созданной учетной записи хранения. Щелкните ссылку **Контейнеры** в разделе "Основные компоненты".

    :::image type="content" source="./media/tutorial-iot-hub-maps/containers.png" alt-text="Контейнеры хранилища больших двоичных объектов":::

2. Нажмите кнопку **+ Container** (+ Контейнер) в верхнем левом углу. В правой части браузера отобразится панель. Присвойте контейнеру имя *contoso-rental-logs* и нажмите кнопку **Создать**.

     :::image type="content" source="./media/tutorial-iot-hub-maps/container-new.png" alt-text="Создание контейнера больших двоичных объектов":::

3. Откройте колонку **Ключи доступа** в учетной записи хранения и скопируйте значения полей **Имя учетной записи хранения** и **Ключ** в разделе **Key1**. Нам понадобятся оба значения в разделе [Создание функции в службе "Функции Azure" и добавление подписки на службу "Сетка событий"](#create-an-azure-function-and-add-an-event-grid-subscription).

    :::image type="content" source="./media/tutorial-iot-hub-maps/access-keys.png" alt-text="Копирование имени и ключа учетной записи хранения":::

## <a name="upload-a-geofence"></a>Отправка геозоны

Теперь можно использовать [приложение Postman](https://www.getpostman.com), чтобы [отправить геозону](https://docs.microsoft.com/azure/azure-maps/geofence-geojson) в службу Azure Maps. Геозоны определяют авторизованное географическое расположение для арендованного автомобиля.  Мы будем использовать геозоны в нашей функции Azure, чтобы определить, переместился ли автомобиль за пределы области геозоны.

Откройте приложение Postman и выполните приведенные ниже инструкции, чтобы отправить данные о геозоне через API отправки данных Azure Maps.  

1. Откройте приложение Postman. В верхней части приложения Postman выберите элемент **Создать**. В окне **Create New** (Создание) выберите **Collection** (Коллекция).  Присвойте имя коллекции и нажмите кнопку **Создать**.

2. Чтобы создать запрос, нажмите кнопку **Создать** еще раз. В окне **Create New** (Создание) выберите **Request** (Запрос). Введите **Имя запроса** для запроса. Выберите коллекцию, созданную на предыдущем шаге, а затем нажмите кнопку **Сохранить**.

3. Выберите HTTP-метод **POST** на вкладке построителя и введите следующий URL-адрес, чтобы отправить данные о геозоне в API отправки данных. Обязательно замените `{subscription-key}` ключом первичной подписки.

    ```HTTP
    https://atlas.microsoft.com/mapData/upload?subscription-key={subscription-key}&api-version=1.0&dataFormat=geojson
    ```

    Значение geojson для параметра `dataFormat` в пути URL-адреса определяет формат отправляемых данных.

4. Перейдите на вкладку **Основной текст** и выберите **необработанный формат** входных данных, а затем в раскрывающемся списке щелкните **JSON** в качестве формата входных данных. Откройте файл данных JSON [здесь](https://raw.githubusercontent.com/Azure-Samples/iothub-to-azure-maps-geofencing/master/src/Data/geofence.json?token=AKD25BYJYKDJBJ55PT62N4C5LRNN4) и скопируйте JSON в раздел текста. Нажмите кнопку **Отправить**.

5. Нажмите синюю кнопку **Отправить** и дождитесь обработки запроса. После завершения запроса перейдите на вкладку **Заголовки** ответа. Скопируйте значение ключа **Расположение**, который является `status URL`.

    ```http
    https://atlas.microsoft.com/mapData/operations/<operationId>?api-version=1.0
    ```

6. Чтобы проверить состояние вызова API, создайте HTTP-запрос **GET** по `status URL`. Вам потребуется добавить первичный ключ подписки к URL-адресу для проверки подлинности. Запрос **GET** должен быть похож на следующий URL-адрес.

   ```HTTP
   https://atlas.microsoft.com/mapData/<operationId>/status?api-version=1.0&subscription-key={subscription-key}

7. When the **GET** HTTP request completes successfully, it will return a `resourceLocation`. The `resourceLocation` contains the unique `udid` for the uploaded content. You'll need to copy this `udid` for later use in this tutorial.

      ```json
      {
          "status": "Succeeded",
          "resourceLocation": "https://atlas.microsoft.com/mapData/metadata/{udid}?api-version=1.0"
      }
      ```

## <a name="create-an-azure-iot-hub"></a>Создание Центра Интернета вещей Azure

Центр Интернета вещей Azure обеспечивает безопасный и надежный двунаправленный обмен данными между приложением Интернета вещей и управляемыми ими устройствами.  В нашем сценарии мы хотим получить информацию с устройства в автомобиле, чтобы определить его расположение. В этом разделе мы создадим центр Интернета вещей в группе ресурсов *ContosoRental*. Центр Интернета вещей будет отвечать за публикацию событий телеметрии устройства.

> [!NOTE]
> Функция публикации событий телеметрии устройства в службу "Сетка событий" доступна в центре Интернета вещей в режиме общедоступной предварительной версии. Функции общедоступной предварительной версии доступны во всех регионах, кроме следующих: **Восточная часть США, Западная часть США, Западная Европа, Azure для государственных организаций, Azure для Китая 21Vianet** и **Azure для Германии**.

Чтобы создать центр Интернета вещей в группе ресурсов *ContosoRental*, выполните действия, описанные в разделе [Создание центра Интернета вещей](https://docs.microsoft.com/azure/iot-hub/quickstart-send-telemetry-dotnet#create-an-iot-hub).

## <a name="register-a-device-in-iot-hub"></a>Регистрация устройства в центре Интернета вещей

Устройства не могут подключиться к центру Интернета вещей, если они не зарегистрированы в реестре удостоверений центра. В нашем сценарии мы создадим одно устройство с именем *InVehicleDevice*. Чтобы создать и зарегистрировать устройство в центре Интернета вещей, выполните действия, описанные в разделе [Регистрация нового устройства в центре Интернета вещей](https://docs.microsoft.com/azure/iot-hub/iot-hub-create-through-portal#register-a-new-device-in-the-iot-hub). Не забудьте скопировать **основную строку подключения** устройства, так как мы будем использовать ее в следующем шаге.

## <a name="create-an-azure-function-and-add-an-event-grid-subscription"></a>Создание функции в службе "Функции Azure" и добавление подписки на службу "Сетка событий"

Функции Azure — это бессерверная служба вычислений, которая позволяет запускать небольшие фрагменты кода (функции) без необходимости явно подготавливать вычислительную инфраструктуру или управлять ею. Дополнительные сведения о функциях Azure см. в статье [Общие сведения о Функциях Azure](https://docs.microsoft.com/azure/azure-functions/functions-overview).

Функция активируется определенным событием. В нашем сценарии мы создадим функцию, активируемую триггером Сетки событий. Мы создадим связь между триггером и функцией, создав подписку на события для событий телеметрии устройства центра Интернета вещей. При возникновении события телеметрии устройства наша функция будет вызываться как конечная точка и будет получать соответствующие данные для устройства, [которое ранее было зарегистрировано в центре Интернета вещей](#register-a-device-in-iot-hub).

Код скрипта на C#, который будет содержать наша функция, можно просмотреть [здесь](https://github.com/Azure-Samples/iothub-to-azure-maps-geofencing/blob/master/src/Azure%20Function/run.csx).

Теперь мы настроили функцию Azure.

1. На панели мониторинга портала Azure щелкните **Создать ресурс**. В поле поиска введите **Приложение-функция**. Щелкните **Приложение-функция**. Нажмите кнопку **Создать**.

2. На странице создания **приложения-функции** присвойте имя приложению-функции. В разделе **Группа ресурсов** в раскрывающемся списке выберите *ContosoRental*.  Выберите *.NET Core* в качестве значения для параметра **Стек среды выполнения**. Щелкните **Далее: Размещение >** в нижней части страницы.

    :::image type="content" source="./media/tutorial-iot-hub-maps/rental-app.png" alt-text="Создание приложения-функции":::

3. **Учетная запись хранилища** — выберите учетную запись, которую вы создали на [этапе создания учетной записи](#create-an-azure-storage-account). Щелкните **Review + create** (Просмотреть и создать).

4. Просмотрите данные о приложении-функции и нажмите кнопку **Создать**.

5. Завершив создание приложения, мы добавим в него функцию. Перейдите к приложению-функции. Щелкните колонку **Функции**. В верхней части страницы щелкните **+ Добавить**. Отобразится панель шаблона функции. Прокрутите вниз на панели. Щелкните **Azure Event Grid Trigger** (Триггер Сетки событий Azure).

     >[!WARNING]
    > Шаблоны **Триггер концентратора событий Azure** и **триггер Сетки событий Azure** имеют похожие имена. Убедитесь, что выбран шаблон **триггер Сетки событий Azure**.

    :::image type="content" source="./media/tutorial-iot-hub-maps/function-create.png" alt-text="Создание функции":::

6. Присвойте функции имя. В этом учебнике мы будем использовать имя *GetGeoFunction*, но можно использовать любое имя. Нажмите кнопку **Создать функцию**.

7. Щелкните колонку **Code + Test** (Код и тестирование) в меню слева. Скопируйте и вставьте [скрипт C#](https://github.com/Azure-Samples/iothub-to-azure-maps-geofencing/blob/master/src/Azure%20Function/run.csx) в окно кода.

     :::image type="content" source="./media/tutorial-iot-hub-maps/function-code.png" alt-text="Копирование и вставка кода в окно функции":::

8. В коде C# замените следующие параметры. Нажмите кнопку **Сохранить**. Пока не нажимайте кнопку **Test/Run** (Тест/запуск).
    * Замените значение **SUBSCRIPTION_KEY** первичным ключом подписки для учетной записи Azure Maps.
    * Замените значение **UDID** идентификатором `udid` отправленной ранее геозоны в разделе [Отправка геозоны](#upload-a-geofence).
    * Функция **CreateBlobAsync** в скрипте создает большой двоичный объект для каждого события в учетной записи хранения данных. Замените заполнители **ACCESS_KEY**, **ACCOUNT_NAME** и **STORAGE_CONTAINER_NAME** значениями ключа доступа к учетной записи хранения, имени учетной записи и контейнера хранилища данных. Эти значения были созданы при создании учетной записи хранения в [соответствующем](#create-an-azure-storage-account) разделе.

9. Щелкните колонку **Интеграция** в меню слева. Щелкните **Триггер сетки событий** на схеме. Введите имя триггера, например *eventCarTelemetry*, и щелкните кнопку **Создание подписки для Сетки событий**.

     :::image type="content" source="./media/tutorial-iot-hub-maps/function-integration.png" alt-text="Добавление подписки на события":::

10. Заполните сведения о подписке. Назовите подписку на событие. Для пункта *Схема событий* выберите *Схема сетки событий*. Для пункта **Topic Types** (Типы разделов) выберите *Azure IoT Hub Accounts* (Учетные записи Центра Интернета вещей Azure). Выберите **Группы ресурсов**, а затем созданную для этого учебника группу ресурсов. Для пункта **Ресурс** выберите центр Интернета вещей, созданный в разделе [создания центра Интернета вещей Azure](#create-an-azure-iot-hub). Для пункта **Filter to Event Types** (Фильтр по типам событий) выберите *Device Telemetry* (Телеметрия устройства). Завершив выбор параметров, вы увидите, что значение для параметра **Тип раздела** изменится на *Центр Интернета вещей*. Для пункта **System Topic Name** (Имя системного раздела) можно использовать то же имя, что и для ресурса.  Наконец, нажмите кнопку **Выбрать конечную точку** в разделе **Сведения о конечной точке**. Примите все параметры и нажмите кнопку **Подтвердить выбор**.

    :::image type="content" source="./media/tutorial-iot-hub-maps/function-create-event-subscription.png" alt-text="Создание подписки на события":::

11. Проверьте настройки. Убедитесь, что конечная точка указывает функцию, созданную в начале этого раздела. Нажмите кнопку **Создать**.

    :::image type="content" source="./media/tutorial-iot-hub-maps/function-create-event-subscription-confirm.png" alt-text="Подтверждение создания подписки на событие":::

12. Теперь вы снова находитесь на панели **Изменить триггер**. Нажмите кнопку **Сохранить**.

## <a name="filter-events-using-iot-hub-message-routing"></a>Фильтрация событий с помощью маршрутизации сообщений, предоставляемой Центром Интернета вещей

При добавлении подписки службы "Сетка событий" в функцию Azure маршрут обмена сообщениями автоматически создается в указанном центре Интернета вещей. Маршрутизация сообщений позволяет маршрутизировать различные типы данных к разным конечным точкам. Вы можете, например, маршрутизировать сообщения телеметрии устройства, события жизненного цикла устройства и события изменения двойников устройств. Дополнительные сведения о маршрутизации сообщений с помощью Центра Интернета вещей вы найдете [здесь](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-messages-d2c).

:::image type="content" source="./media/tutorial-iot-hub-maps/hub-route.png" alt-text="Настройка маршрутизации сообщений с центром Интернета вещей":::

В нашем примере сценария мы хотим получать сообщения только при перемещении автомобиля. Мы создадим запрос маршрутизации для фильтрации событий, в которых свойство `Engine` равно **ВКЛ**. Чтобы создать запрос маршрутизации, щелкните маршрут **RouteToEventGrid** и замените значение **Запрос маршрутизации** на строку **"Engine='ON'"**, а затем щелкните **Сохранить**. Теперь Центр Интернета вещей будет публиковать только те события телеметрии устройств, в которых параметр Engine имеет значение ON.

:::image type="content" source="./media/tutorial-iot-hub-maps/hub-filter.png" alt-text="Фильтрация маршрутизации сообщений":::

>[!TIP]
>Существует много способов выполнять запросы по сообщениям Интернета вещей, отправляемых с устройства в облако. Дополнительные сведения о синтаксисе маршрутизации сообщений вы найдете в [этой статье](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-routing-query-syntax).

## <a name="send-telemetry-data-to-iot-hub"></a>Отправка данных телеметрии в Центр Интернета вещей

Теперь, когда функция Azure полностью готова и работает, мы можем отправить данные телеметрии в центр Интернета вещей, который передаст их в Сетку событий. Давайте применим приложение C# для имитации данных о местоположении, получаемых с устройства в арендованном автомобиле. Чтобы запустить это приложение, на компьютере разработки необходимо установить пакет SDK для .NET Core версии 2.1.0 или более поздней. Выполните следующие действия, чтобы отправить имитированные данные телеметрии в Центр Интернета вещей.

1. Если вы еще не сделали этого, скачайте проект [rentalCarSimulation](https://github.com/Azure-Samples/iothub-to-azure-maps-geofencing/tree/master/src/rentalCarSimulation) на C#.

2. Откройте файл simulatedCar.cs в любом текстовом редакторе и замените в нем значение `connectionString` тем, которое вы сохранили при регистрации устройства, затем сохраните изменения в файле.

3. Убедитесь, что на компьютере установлена платформа .NET Core. В локальном окне терминала перейдите к корневой папке проекта C# и выполните следующие команды, чтобы установить необходимые пакеты для приложения имитированного устройства.

    ```cmd/sh
    dotnet restore
    ```

4. В том же окне терминала выполните команды, которые компилируют и запускают приложение имитации устройства в арендованном автомобиле:

    ```cmd/sh
    dotnet run
    ```

  Теперь окно терминала должно содержать примерно такие данные:

:::image type="content" source="./media/tutorial-iot-hub-maps/terminal.png" alt-text="Выходные данные терминала":::

Теперь вы можете открыть контейнер хранилища больших двоичных объектов и убедиться, что в нем созданы четыре двоичных объекта для расположений, в которых автомобиль находится за пределами геозоны.

:::image type="content" source="./media/tutorial-iot-hub-maps/blob.png" alt-text="Просмотр больших двоичных объектов в контейнере":::

На карте ниже показаны четыре точки обнаружения автомобилей за пределами геозоны. Каждое расположение записывается в журнал через регулярные интервалы времени.

:::image type="content" source="./media/tutorial-iot-hub-maps/violation-map.png" alt-text="Карта нарушений":::

## <a name="explore-azure-maps-and-iot"></a>Знакомство с Azure Maps и Интернетом вещей

Для изучения API-интерфейсов Azure Maps, используемых в этом руководстве, прочтите следующие статьи.

* [Get Search Address Reverse](https://docs.microsoft.com/rest/api/maps/search/getsearchaddressreverse)
* [Получение геозоны](https://docs.microsoft.com/rest/api/maps/spatial/getgeofence)

Полный список API-интерфейсов Azure Maps вы найдете здесь:

* [Интерфейсы REST API для Azure Maps](https://docs.microsoft.com/rest/api/maps/spatial/getgeofence)

Дополнительные сведения см. в

* статье об [IoT Plug and Play](https://docs.microsoft.com/azure/iot-pnp).

Список устройств, сертифицированных для работы с Интернетом вещей в Azure, размещен на этой странице:

* [Сертифицированные для Azure устройства](https://catalog.azureiotsolutions.com/)

## <a name="next-steps"></a>Next Steps

Дополнительные сведения о том, как отправлять данные телеметрии с устройства в облако или обратно, см. здесь:

> [!div class="nextstepaction"]
> [Отправка данных телеметрии с устройства](https://docs.microsoft.com/azure/iot-hub/quickstart-send-telemetry-dotnet)
