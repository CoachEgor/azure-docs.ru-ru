---
title: Приступая к работе со службой "Интеграция журналов данных Azure" | Документация Майкрософт
description: Узнайте, как установить службу "Интеграция журналов данных Azure" и интегрировать журналы из службы хранилища Azure, журналы аудита Azure и оповещения центра безопасности Azure.
services: security
documentationcenter: na
author: Barclayn
manager: barbkess
editor: TomShinder
ms.assetid: 53f67a7c-7e17-4c19-ac5c-a43fabff70e1
ms.service: security
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ums.workload: na
ms.date: 01/14/2019
ms.author: barclayn
ms.custom: azlog
ms.openlocfilehash: 244b2d1764f30f790c3e51e23cd2fa0af6375960
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60480291"
---
# <a name="azure-log-integration-with-azure-diagnostics-logging-and-windows-event-forwarding"></a>Интеграция журналов данных Azure с ведением журнала системы диагностики Azure и пересылкой событий Windows


>[!IMPORTANT]
> Использование службы интеграции журналов Azure будет прекращено до 01.06.2019. Файлы для скачивания AzLog недоступны с 27 июня 2018 г. Сведения о том, что делать дальше, см. в блоге [Используйте Azure-монитор для интеграции с инструментами SIEM](https://azure.microsoft.com/blog/use-azure-monitor-to-integrate-with-siem-tools/) 

Интеграцию журналов Azure следует использовать, только если у вашего поставщика SIEM (Управление информационной безопасностью и событиями безопасности) еще нет соединителя для [Azure Monitor](../monitoring-and-diagnostics/monitoring-get-started.md).

Она делает журналы Azure доступными для SIEM и позволяет создать единую панель мониторинга безопасности для всех ресурсов.
Дополнительные сведения о состоянии соединителя Azure Monitor можно получить у поставщика SIEM.

> [!IMPORTANT]
> Если вас интересует сбор журналов виртуальных машин, обращайтесь к поставщикам SIEM, так как большинство из них включают эту возможность в свое решение. Использование соединителя, предоставленного поставщиком SIEM, всегда следует рассматривать в первую очередь.

Эта статья поможет приступить к работе со службой "Интеграция журналов данных Azure". Она посвящена установке службы "Интеграция журналов данных Azure" и ее интеграции с системой диагностики Azure. После этого служба "Интеграция журналов данных Azure" сможет собирать данные журнала событий Windows из канала событий безопасности Windows, поступающие из виртуальных машин, развернутых в IaaS Azure. Это похоже на *пересылку событий*, которую вы, возможно, использовали в локальной системе.

> [!NOTE]
> Интеграция выходных данных службы "Интеграция журналов данных Azure" с SIEM выполняется смой системой SIEM. Дополнительные сведения см. в статье [Azure Log Integration SIEM configuration steps](https://blogs.msdn.microsoft.com/azuresecurity/2016/08/23/azure-log-siem-configuration-steps/) (Настройка службы интеграции журналов данных Azure в SIEM).

Служба "Интеграция журналов данных Azure" выполняется на физическом компьютере или виртуальной машине под управлением Windows Server 2008 R2 или более поздней версии (Windows Server 2016 или Windows Server 2012 R2 предпочтительнее).

Физический компьютер может работать в локальной среде или на сайте размещения. Если вы решили выполнять службу "Интеграция журналов данных Azure" на виртуальной машине, эта виртуальная машина может быть расположена в локальной среде или общедоступном облаке, например Microsoft Azure.

У физического компьютера или виртуальной машины, на которой выполняется служба интеграции журналов Azure, должно быть сетевое подключение к общедоступному облаку Azure. Эта статья содержит сведения о требуемой конфигурации.

## <a name="prerequisites"></a>Технические условия

Для установки службы "Интеграция журналов данных Azure" требуются как минимум следующие компоненты.

* **Подписка Azure**. Если у вас ее нет, зарегистрируйте [бесплатную учетную запись](https://azure.microsoft.com/free/).
* **Учетная запись хранения**, которую можно использовать для ведения журнала Диагностики Azure для Windows (WAD). Вы можете использовать имеющуюся учетную запись хранения или создать новую. Далее в этой статье описывается, как настроить учетную запись хранения.

  > [!NOTE]
  > В зависимости от ситуации учетная запись хранения может не потребоваться. Однако она требуется для сценария с использованием системы диагностики Azure, описанного в этой статье.

* **Две системы**: 
  * Компьютер, на котором выполняется служба "Интеграция журналов данных Azure". Этот компьютер собирает все данные журналов, которые впоследствии импортируются в SIEM. Эта система:
    * Может размещаться в локальной среде или в облаке Microsoft Azure.  
    * Должна использовать 64-разрядный выпуск Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более поздней версии и в ней должен быть установлен компонент Microsoft .NET 4.5.1. Установленную версию .NET можно определить, следуя указаниям в статье [Практическое руководство. Определение установленных версий платформы .NET Framework](https://msdn.microsoft.com/library/hh925568).  
    * Она должна иметь возможность подключения к учетной записи хранения Azure, используемой для ведения журнала системы диагностики Azure. Далее в этой статье описывается, как проверить возможность подключения.
  * Компьютер, который нужно отслеживать. Это [виртуальная машина Azure](../virtual-machines/virtual-machines-windows-overview.md). Данные журналов из этой виртуальной машины отправляются на компьютер службы "Интеграция журналов данных Azure".

Быстрая демонстрация процесса создания виртуальной машины с помощью портала Azure показана в видео ниже.<br /><br />


> [!VIDEO https://channel9.msdn.com/Blogs/Azure-Security-Videos/Azure-Log-Integration-Videos-Create-a-Virtual-Machine/player]

## <a name="deployment-considerations"></a>Рекомендации по развертыванию

Во время тестирования можно использовать любую систему, отвечающую минимальным требованиям к операционной системе. Загрузка рабочей среды может потребовать планирования масштабирования ресурсов.

Вы можете запустить несколько экземпляров службы интеграции журналов данных Azure. Однако можно запустить только один экземпляр службы на физический компьютер или виртуальную машину. Кроме того, вы можете распределять нагрузку учетных записей хранения системы диагностики Azure для WAD. Число подписок для предоставления экземпляров зависит от имеющейся емкости.

> [!NOTE]
> В настоящее время у нас нет каких-либо определенных рекомендаций по развертыванию экземпляров компьютера интеграции журналов данных Azure (т. е. компьютеров, на которых запущена служба интеграции журналов Azure) или советов для учетных записей хранения или подписок. Решения о масштабировании следует принимать, исходя из наблюдаемой производительности в каждой из этих областей.

Также имеется возможность развернуть службу "Интеграция журналов данных Azure", чтобы повысить производительность. Ниже приведены метрики производительности, которые помогут выбрать размер компьютеров для выполнения службы "Интеграция журналов данных Azure".

* На компьютере с 8 процессорами (ядрами) один экземпляр службы "Интеграция журналов данных Azure" может обрабатывать около 24 млн событий в день (примерно 1 млн событий в час).
* На компьютере с 4 процессорами (ядрами) один экземпляр службы "Интеграция журналов данных Azure" может обрабатывать около 1,5 млн событий в день (примерно 62 500 событий в час).

## <a name="install-azure-log-integration"></a>Установка службы "Интеграция журналов данных Azure"

Выполните процедуру установки. Выберите, следует ли отправлять данные телеметрии в корпорацию Майкрософт.

Служба "Интеграция журналов данных Azure" собирает данные телеметрии с компьютера, на котором она установлена.  

Собираемые данные телеметрии включают в себя следующее:

* исключения, возникающие при выполнении интеграции журналов Azure;
* метрики о количестве обработанных запросов и событий;
* статистические данные использования параметров командной строки Azlog.exe. 

> [!NOTE]
> Рекомендуется разрешить корпорации Майкрософт собирать данные телеметрии. Сбор данных телеметрии можно отключить, сняв флажок **Allow Microsoft to collect telemetry data** (Разрешить корпорации Майкрософт собирать данные телеметрии).
>

![Снимок экрана: область установки с установленным флажком телеметрии](./media/security-azure-log-integration-get-started/telemetry.png)


В следующем видео рассматривается процесс установки.<br /><br />

> [!VIDEO https://channel9.msdn.com/Blogs/Azure-Security-Videos/Azure-Log-Integration-Videos-Install-Azure-Log-Integration/player]

## <a name="post-installation-and-validation-steps"></a>Действия после установки и проверка

После завершения базовой установки все готово для выполнения послеустановочных действий и проверки.

1. Откройте PowerShell от имени администратора. Перейдите в каталог C:\Program Files\Microsoft Azure Log Integration.
2. Импортируйте командлеты службы "Интеграция журналов данных Azure"? Чтобы импортировать командлеты, выполните сценарий `LoadAzlogModule.ps1`. Введите `.\LoadAzlogModule.ps1` и нажмите клавишу ВВОД (обратите внимание на **.\\** в этой команде). На рисунке ниже показан пример того, что вы должны увидеть на экране.

   ![Снимок экрана: выходные данные сценария LoadAzlogModule.ps1](./media/security-azure-log-integration-get-started/loaded-modules.png)
3. Теперь настройте службу "Интеграция журналов данных Azure" для использования конкретной среды Azure. *Среда Azure* — это тип облачного центра обработки данных Azure, с которым требуется работать. Хотя в настоящее время существует несколько сред Azure, на данный момент доступны значения **AzureCloud** и **AzureUSGovernment**. Запустив сеанс PowerShell с повышенными привилегиями, убедитесь, что вы находитесь в каталоге C:\Program Files\Microsoft Azure Log Integration. Выполните приведенную ниже команду.

   `Set-AzlogAzureEnvironment -Name AzureCloud` (для **AzureCloud**)
  
   Если вы хотите использовать облако Azure для государственных организаций США, для переменной **-Name** следует указать значение **AzureUSGovernment**. В настоящее время другие облака Azure не поддерживаются.  

   > [!NOTE]
   > После успешного завершения команды какие-либо выходные данные отображены не будут. 

4. Прежде чем начать мониторинг системы, необходимо получить имя учетной записи хранения, используемой для системы диагностики Azure. На портале Azure выберите **Виртуальные машины**. Найдите виртуальную машину Windows для мониторинга. В разделе **Свойства** щелкните **Параметры диагностики**.  Затем щелкните **Агент**. Запишите указанное имя учетной записи хранения. Оно потребуется вам в дальнейшем.

   ![Снимок экрана: область параметров системы диагностики Azure](./media/security-azure-log-integration-get-started/storage-account-large.png) 

   ![Снимок экрана: кнопка "Включить мониторинг на гостевом уровне"](./media/security-azure-log-integration-get-started/azure-monitoring-not-enabled-large.png)

   > [!NOTE]
   > Если мониторинг не был включен при создании виртуальной машины, его можно включить, как показано на предыдущем рисунке.

5. Теперь вернитесь к компьютеру интеграции журналов данных Azure. Проверьте возможность подключения к учетной записи хранения из системы, в которой установлена служба "Интеграция журналов данных Azure". Компьютеру, на котором работает служба "Интеграция журналов данных Azure", требуется доступ к учетной записи хранения для получения сведений, регистрируемых системой диагностики Azure, в соответствии с настройками в каждой из отслеживаемых систем. Чтобы проверить подключение, выполните следующее. 
   1. [Скачайте Обозреватель службы хранилища Azure](https://storageexplorer.com/).
   2. Выполните его установку.
   3. По завершении установки щелкните **Далее**. Оставьте установленным флажок **Launch Microsoft Azure Storage Explorer** (Запустить Обозреватель службы хранилища Microsoft Azure).  
   4. Войдите в Azure.
   5. Убедитесь, что на портале отображается учетная запись хранения, настроенная для системы диагностики Azure. 

   ![Снимок экрана: учетные записи хранения в Обозревателе службы хранилища](./media/security-azure-log-integration-get-started/storage-explorer.png)

   1. Под учетными записями хранения отображается несколько параметров. В разделе **Таблицы** отображается таблица **WADWindowsEventLogsTable**.

   Если мониторинг не был включен при создании виртуальной машины, его можно включить, как было описано ранее.


## <a name="integrate-windows-vm-logs"></a>Интеграция журналов виртуальной машины Windows

На этом шаге вы настроите компьютер, на котором выполняется служба "Интеграция журналов данных Azure", для подключения к учетной записи хранения, содержащей файлы журнала.

Для выполнения этого шага необходимо следующее.  
* **FriendlyNameForSource**. Это понятное имя, которое можно применить к учетной записи хранения, настроенной в виртуальной машине для хранения сведений из системы диагностики Azure.
* **StorageAccountName**. Это имя учетной записи хранения, указанной при настройке системы диагностики Azure.  
* **StorageKey**. Это ключ к хранилищу данных для учетной записи хранения, содержащей сведения системы диагностики Azure для данной виртуальной машины.  

Выполните следующее, чтобы получить ключ к хранилищу данных.
1. Перейдите на [портал Azure](https://portal.azure.com).
2. В области слева выберите **Все службы**.
3. В текстовом поле **Фильтр** введите **Учетные записи хранения**. Выберите **Учетные записи хранения**.

   ![Снимок экрана: учетные записи хранения в колонке "Все службы"](./media/security-azure-log-integration-get-started/filter.png)

4. Отобразится список учетных записей хранения. Дважды щелкните учетную запись, выбранную для хранения журналов.

   ![Снимок экрана: список учетных записей хранения](./media/security-azure-log-integration-get-started/storage-accounts.png)

5. В разделе **Параметры** выберите **Ключи доступа**.

   ![Снимок экрана: пункт "Ключи доступа" в меню](./media/security-azure-log-integration-get-started/storage-account-access-keys.png)

6. Скопируйте значение **key1** и поместите его в безопасное место, откуда вы сможете его получить для следующего шага.
7. На сервере, на котором установлена служба "Интеграция журналов данных Azure", откройте окно командной строки с правами администратора. Требуется открыть именно окно командной строки с правами администратора, а не PowerShell.
8. Перейдите в каталог C:\Program Files\Microsoft Azure Log Integration.
9. Выполните следующую команду: `Azlog source add <FriendlyNameForTheSource> WAD <StorageAccountName> <StorageKey>`.
 
   Пример:
  
   `Azlog source add Azlogtest WAD Azlog9414 fxxxFxxxxxxxxywoEJK2xxxxxxxxxixxxJ+xVJx6m/X5SQDYc4Wpjpli9S9Mm+vXS2RVYtp1mes0t9H5cuqXEw==`

   Если требуется отобразить идентификатор подписки в коде XML события, добавьте идентификатор подписки к понятному имени.

   `Azlog source add <FriendlyNameForTheSource>.<SubscriptionID> WAD <StorageAccountName> <StorageKey>`
  
   Пример:
  
   `Azlog source add Azlogtest.YourSubscriptionID WAD Azlog9414 fxxxFxxxxxxxxywoEJK2xxxxxxxxxixxxJ+xVJx6m/X5SQDYc4Wpjpli9S9Mm+vXS2RVYtp1mes0t9H5cuqXEw==`

> [!NOTE]
> Подождите до 60 минут, а затем просмотрите события, извлеченные из учетной записи хранения. Чтобы просмотреть события, в службе "Интеграция журналов данных Azure" выберите **Средство просмотра событий** > **Журналы Windows** > **Пересланные события**.

В следующем видео показаны описанные выше шаги.<br /><br />

> [!VIDEO https://channel9.msdn.com/Blogs/Azure-Security-Videos/Azure-Log-Integration-Videos-Enable-Diagnostics-and-Storage/player]


## <a name="if-data-isnt-showing-up-in-the-forwarded-events-folder"></a>Если данные не отображаются в папке "Пересланные события"
Если через час в папке "Пересланные события" не появились данные, то сделайте следующее.

1. Проверьте компьютер, на котором выполняется служба "Интеграция журналов данных Azure". Убедитесь, что у него есть доступ к Azure. Чтобы проверить подключение, в браузере попробуйте перейти на [портал Azure](https://portal.azure.com).
2. Убедитесь, что учетная запись пользователя AzLog имеет разрешение на запись в папку users\Azlog.
   1. Откройте проводник.
   2. Перейдите в папку C:\users.
   3. Щелкните правой кнопкой мыши папку c:\users\Azlog.
   4. Выберите **Безопасность**.
   5. Выберите **NT Service\Azlog**. Проверьте разрешения для этой учетной записи. Если эта учетная запись отсутствует на вкладке или соответствующие разрешения в настоящее время не отображены, можно предоставить их данной учетной записи на этой вкладке.
3. При выполнении команды `Azlog source list` убедитесь, что учетная запись хранения, добавленная в команду `Azlog source add`, отображается в выходных данных.
4. Щелкните **Просмотр событий** > **Журналы Windows** > **Приложение**, чтобы проверить наличие ошибок, о которых сообщила служба "Интеграция журналов данных Azure".

При наличии проблем во время установки и настройки можно создать [запрос на поддержку](../azure-supportability/how-to-create-azure-support-request.md). Для этой службы выберите **Интеграция журнала**.

Другим источником поддержки служит [форум MSDN по службе "Интеграция журналов данных Azure"](https://social.msdn.microsoft.com/Forums/home?forum=AzureLogIntegration). На этом форуме MSDN сообщество может предоставить помощь, отвечая на вопросы, а также давая советы и рекомендации о том, как максимально эффективно использовать службу "Интеграция журналов данных Azure". Команда разработчиков службу "Интеграция журналов данных Azure" также отслеживает этот форум. Они помогут при любой возможности.

## <a name="integrate-azure-activity-logs"></a>Интеграция журналов действий Azure

Журнал действий Azure — это журнал подписки с подробными сведениями о событиях на уровне подписки, которые произошли в Azure. Сюда входят различные данные — от операционных данных Azure Resource Manager до обновлений в событиях работоспособности службы. Оповещения центра безопасности Azure также включаются в этот журнал.
> [!NOTE]
> Перед выполнением действий в этой статье просмотрите статью [Интеграция журналов Azure с ведением журнала системы диагностики Azure и пересылкой событий Windows](security-azure-log-integration-get-started.md) и выполните указанные в ней действия.

### <a name="steps-to-integrate-azure-activity-logs"></a>Шаги для интеграции журналов действий Azure

1. Откройте командную строку и выполните следующую команду: ```cd c:\Program Files\Microsoft Azure Log Integration```
2. Выполните следующую команду: ```azlog createazureid```

    Эта команда запрашивает имя для входа Azure. Затем она создает субъект-службу Azure Active Directory в клиентах Azure AD, содержащих подписки Azure, для которых вошедший пользователь является администратором, соадминистратором или владельцем. Команда завершится ошибкой, если пользователь является только гостем в клиенте Azure AD. Проверка подлинности в Azure осуществляется через Azure AD. Создание субъекта-службы для службы интеграции Azure приводит к созданию удостоверения Azure AD, которому предоставлен доступ на чтение из подписок Azure.
3. Выполните следующую команду, чтобы авторизовать субъект-службу интеграции журналов Azure, созданный на предыдущем шаге "Доступ для чтения журналов действий подписки". Чтобы выполнить команду, необходимо быть владельцем подписки.

   ```Azlog.exe authorize subscriptionId``` Пример:

   ```AZLOG.exe authorize ba2c2367-d24b-4a32-17b5-4443234859```

4. Проверьте следующие папки, в которых должны создаваться JSON-файлы журнала аудита Azure Active Directory:
   - С:\Users\azlog\AzureResourceManagerJson
   - С:\Users\azlog\AzureResourceManagerJsonLD

> [!NOTE]
> За конкретными инструкциями по переносу данных JSON-файлов в систему управления сведениями о безопасности и событиями (SIEM) обратитесь к поставщику SIEM.

Помощь сообщества можно получить на [форуме MSDN по интеграции журналов Azure](https://social.msdn.microsoft.com/Forums/office/home?forum=AzureLogIntegration). С помощью этого форума участники сообщества по интеграции журналов Azure могут помогать друг другу, делясь вопросами, ответами, советами и рекомендациями. Кроме того, команда разработчиков службы интеграции журналов Azure отслеживает этот форум и помогает при любой возможности.

Можно также отправить [запрос в службу поддержки](../azure-supportability/how-to-create-azure-support-request.md). Выберите интеграцию с журналом в качестве службы, в которую необходимо отправить запрос поддержки.

## <a name="next-steps"></a>Дальнейшие действия

Чтобы узнать больше о службе "Интеграция журналов данных Azure", ознакомьтесь со следующими статьями. Перед выполнением действий в этой статье просмотрите статью о начале работы и выполните указанные в ней действия.

* [Введение в службу интеграции журналов Microsoft Azure](security-azure-log-integration-overview.md). В этой статье рассказывается о службе "Интеграция журналов данных Azure", ее основных возможностях и принципах работы.
* [Azure Log Integration SIEM configuration steps](https://blogs.msdn.microsoft.com/azuresecurity/2016/08/23/azure-log-siem-configuration-steps/) (Настройка SIEM для службы "Интеграция журналов данных Azure"). В этой записи блога показано, как настроить службу "Интеграция журналов данных Azure" для работы с решениями таких партнеров, как Splunk, HP ArcSight и IBM QRadar. В настоящее время это наше руководство по настройке компонентов SIEM. Обратитесь к своему поставщику SIEM для получения дополнительных сведений.
* [Интеграция журналов Azure: часто задаваемые вопросы](security-azure-log-integration-faq.md). Статья содержит ответы на часто задаваемые вопросы о службе "Интеграция журналов данных Azure".
* [Экспорт данных безопасности Azure в SIEM. Конфигурация конвейера [предварительная версия]](../security-center/security-center-integrating-alerts-with-log-integration.md). В этой статье показано, как синхронизировать оповещения центра безопасности и события безопасности виртуальных машин, которые собираются системой диагностики Azure и посредством журналов действий Azure. Журналы синхронизируются с помощью журналов Azure Monitor или решения SIEM.
* [New features for Azure diagnostics and Azure Audit logs](https://azure.microsoft.com/blog/new-features-for-azure-diagnostics-and-azure-audit-logs/) (Новые возможности системы диагностики Azure и журналов аудита Azure). В этой записи блога рассказывается о журналах аудита Azure и других функциях, помогающих лучше понять, как работают ваши ресурсы Azure.
