---
title: Разработка безопасного веб-приложения Azure AD Документы Майкрософт
description: В этом простом примере приложения реализованы рекомендации по безопасности, которые улучшают ваше приложение и безопасность организации при разработке в Azure.
keywords: Нет
services: security
documentationcenter: na
author: TerryLanfear
manager: alclabo
editor: ''
ms.assetid: cd906856-f4f9-4ddc-9249-c998386f4085
ms.service: security
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 09/12/2019
ms.author: terrylan
ms.openlocfilehash: 599c4a31840b47294b43c4c4d1f0200b17f04540
ms.sourcegitcommit: 98e79b359c4c6df2d8f9a47e0dbe93f3158be629
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/07/2020
ms.locfileid: "80810548"
---
# <a name="develop-secure-app-for-an-azure-ad-app"></a>Разработка безопасного приложения для приложения Azure AD
## <a name="overview"></a>Обзор

Этот пример представляет собой простой активный каталог Azure с веб-приложением, которое ссылается на ресурсы безопасности для разработки приложений в Azure. Приложение реализует рекомендации по безопасности, которые могут помочь улучшить ваше приложение и безопасность вашей организации при разработке приложений на Azure.

Скрипты развертывания настраивают инфраструктуру. После запуска сценариев развертывания необходимо сделать ручную конфигурацию на портале Azure, чтобы связать компоненты и службы вместе. Этот пример предназначен для опытных разработчиков ВС УК, которые работают в розничной торговле и хотят создать защищенный активный каталог Azure с защищенной инфраструктурой Azure. 


При разработке и развертывании этого приложения вы узнаете, как 
- Создайте экземпляр Azure Key Vault, храните и извлекайте из него секреты.
- Развертывайте Web App Azure, который выделен изолирован с доступом к фронтовому брандмуму. 
- Создайте и направите экземпляр Azure Application Gateway с помощью брандмауэра, использующему правила OWASP Top 10. 
- Включите шифрование данных в пути и в состоянии покоя с помощью служб Azure. 
- Навлажь центр политики и безопасности Azure для оценки сложностей. 

После разработки и развертывания этого приложения, вы будете настроены следующий образец веб-приложения вместе с конфигурацией и мерами безопасности, которые описаны.

## <a name="architecture"></a>Architecture
Приложение является типичным n-уровня приложение с тремя уровнями. Передний конец, задняя часть и уровень базы данных с интегрированными компонентами мониторинга и секретного управления показаны здесь:

![Архитектура приложения](./media/secure-aad-app/architecture.png)

Это решение использует следующие службы Azure. Подробная информация об архитектуре развертывания отображается в разделе Архитектура развертывания. 

Архитектура состоит из этих компонентов

- [Шлюз приложений Azure.](../../application-gateway/index.yml) Обеспечивает шлюз и брандмауэр для архитектуры приложений.
- [Приложение Исследования](../../azure-monitor/app/app-insights-overview.md). Предоставляет расширяемую службу управления производительностью приложений (APM) на нескольких платформах.
- [Лазурный ключ Убежище](../../key-vault/index.yml). Хранит и шифрует секреты нашего приложения и управляет созданием политик доступа вокруг них.
- [Активный каталог Azure](../../active-directory/fundamentals/active-directory-whatis.md). Предоставляет облачные службы управления идентификацией и доступом, вводом в систему и доступ к ресурсам.
- [Система доменных имен Azure](../../dns/dns-overview.md). Предоставьте услугу для размещения домена.
- [Балансер загрузки Azure](../../load-balancer/load-balancer-overview.md). Обеспечивает масштабирование приложений и создание высокой доступности для ваших служб.
- [Azure Web App](../../app-service/overview.md).  Предоставляет услугу http для хостинга веб-приложений.
- [Центр безопасности Azure](../../security-center/index.yml). обеспечивает расширенную защиту от угроз в гибридных рабочих нагрузках в облаке.
- [Политика Azure](../../governance/policy/overview.md). Предоставляет оценку ресурсов на несоответствие назначенным политикам.

## <a name="threat-model"></a>Модель рисков
Моделирование угроз — это процесс выявления потенциальных угроз безопасности для вашего бизнеса и приложения, а затем обеспечения надлежащего плана смягчения последствий.

В этом примере использовался [инструмент моделирования угроз Майкрософт](https://docs.microsoft.com/azure/security/azure-security-threat-modeling-tool) для реализации моделирования угроз для безопасного примера приложения. Спомощью компонентов и потоков данных можно определить проблемы и угрозы на ранних стадиях процесса разработки. Время и деньги будут сохранены позже с помощью этого.

Вот модель угрозы для примера приложения

![Модель рисков](./media/secure-aad-app/threat-model.png)

Некоторые примеры угроз и потенциальных уязвимостей, генерирующих инструмент моделирования угроз, отображаются на следующем скриншоте. Модель угроз дает обзор выставленной поверхности атаки и побуждает разработчиков задуматься о том, как уменьшить проблемы.

![Выход модели угрозы](./media/secure-aad-app/threat-model-output.png)

### <a name="prerequisites"></a>Предварительные требования
Чтобы запустить приложение, необходимо установить следующие инструменты:

- Редактор кода для изменения и просмотра кода приложения. [Visual Studio Code](https://code.visualstudio.com/) — это вариант с открытым исходным кодом.
- [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest&viewFallbackFrom=azure-cli-latest,) на компьютере разработки.
- [Git](https://git-scm.com/) на вашей системе. Git используется для локального клонирования исходного кода.
- [jq](https://stedolan.github.io/jq/), инструмент UNIX для запроса JSON в удобной для пользователя форме.

Для развертывания ресурсов примерного приложения необходима подписка Azure. Если у вас нет подписки Azure, вы можете [создать бесплатную учетную запись](https://azure.microsoft.com/free/) для тестирования примера приложения.

После установки этих инструментов вы готовы развернуть приложение в Azure.

### <a name="implementation-guidance"></a>Рекомендации по реализации
Сценарий развертывания — это один скрипт, который можно разбить на четыре этапа. Каждая фаза развертывает и настраивает ресурс Azure, который есть в [диаграмме архитектуры,](#architecture)

Четыре фазы

- Развертывание Убежища ключей Azure.
- Развертывание веб-приложений Azure.
- Развертывание шлюза приложений с брандмауэром веб-приложений.
- Назначь Azure AD с помощью развернутого приложения.

Каждый этап основывается на предыдущем, используя конфигурацию из ранее развернутых ресурсов.

Чтобы завершить этапы реализации, убедитесь, что вы установили инструменты, перечисленные в [Prerequisites.](#prerequisites)

#### <a name="deploy-azure-key-vault"></a>Развертывание хранилища ключей Azure
В этом разделе вы создаете и развертываете экземпляр Azure Key Vault, который используется для хранения секретов и сертификатов.

После завершения развертывания в Azure развернут экземпляр Azure Key Vault.

Развертывание Azure Key Vault с помощью Powershell
 
1. Объявить переменные для Убежища ключей Azure.
2. Зарегистрируйте поставщика Azure Key Vault.
3. Создайте группу ресурсов для экземпляра.
4. Создайте экземпляр Azure Key Vault в группе ресурсов, созданной в шаге 3.

#### <a name="the-below-azure-ad-user-will-have-admin-permissions-to-the-key-vault"></a>Ниже пользователь Azure AD получит разрешения на админ для Убежища ключей
    $keyVaultAdminUsers = @($user1,user2)

#### <a name="register-the-az-providers"></a>Регистрация поставщиков Az
    Register-AzResourceProvider -ProviderNamespace Microsoft.KeyVault

#### <a name="create-the-azure-key-vault-instance"></a>Создание экземпляра «Убежище ключей Лазурного»
    New-AzKeyVault -Name $kvName 
                -ResourceGroupName $ResourceGroup 
                -Location 'East US'
                -EnabledForDiskEncryption

#### <a name="add-the-administrator-policies-to-the-key-vault"></a>Добавление политик администратора в Хранилище ключей
    foreach ($keyVaultAdminUser in $keyVaultAdminUsers) {
    $UserObjectId = (Get-AzADUser -SearchString $keyVaultAdminUser).Id
    Set-AzKeyVaultAccessPolicy -VaultName $keyVaultName -ResourceGroupName $resourceGroupName -ObjectId $UserObjectId 
    -PermissionsToKeys all -PermissionsToSecrets all -PermissionsToCertificates all
    }

#### <a name="to-create-an-access-policy-to-allow-a-user-to-get-and-list-cryptographic-keys-certificates-and-secrets-if-you-know-the-user-principal-name"></a>Чтобы создать политику доступа, позволяющую пользователю получать и перечислять криптографические ключи, сертификаты и секреты, если вы знаете имя пользователя:
    Set-AzKeyVaultAccessPolicy -VaultName $keyVaultName 
                           -ResourceGroupName $resourceGroupName 
                           -UserPrincipalName 'user1@contoso.com 
                           -PermissionsToCertificates list, get 
                           -PermissionsToKeys list, get 
                           -PermissionsToSecrets list, get 

Лучше всего использовать управляемые идентификаторы для ресурсов Azure в приложениях, которые используют Key Vault для доступа к ресурсам. Ваша поза безопасности увеличивается, когда ключи доступа к Key Vault не хранятся в коде или в конфигурации.

Корневой сертификат включен в контейнер. Меры, предпринятые для получения сертификата,

1. Скачать файл сертификата из [органа сертификата](https://www.digicert.com/CACerts/BaltimoreCyberTrustRoot.crt).
2. Расшифруйте файл сертификата:

   ```powershell
   openssl x509 -inform DER -in BaltimoreCyberTrustRoot.crt -text -out root.crt
   ```
Этот скрипт создает назначенную идентификацию для экземпляра Службы приложений, которая может быть использована с MSI для взаимодействия с Azure Key Vault без секретов жесткого кодирования в коде или конфигурации.

Перейдите в экземпляр Azure Key Vault на портале, чтобы авторизовать **Add new access policy**назначенную идентификацию на вкладке политики доступа. В соответствии с **принципом Select,** поиск имени приложения, аналогичного названию созданного экземпляра службы приложений.
Директор службы, прикрепленный к приложению, должен быть виден. Выберите его и сохраните страницу политики доступа, как показано на следующем скриншоте.

Поскольку приложению требуется только получение ключей, выберите разрешение **«Получить»** в вариантах секретов, что позволяет получить доступ при одновременном уменьшении предоставленных привилегий.

![Политика доступа к Key Vault](./media/secure-aad-app/kv-access-policy.png)

*Создание политики доступа к Ключу Убежища*

Сохраните политику доступа, а затем сохраните новое изменение на **вкладке Политики доступа** для обновления политик.

#### <a name="deploy-application-gateway-with-web-application-firewall-enabled"></a>Развертывание шлюза приложений с включенным брандмауэром веб-приложений
В веб-приложениях не рекомендуется разоблачать услуги непосредственно внешнему миру в Интернете.
Правила балансировки нагрузки и брандмауэра обеспечивают большую безопасность и контроль над входящим трафиком и помогают управлять им.

Развертывание экземпляра шлюза приложений

1. Создайте группу ресурсов для размещения шлюза приложения.
2. Обеспечение виртуальной сети для присоединения к шлюзу.
3. Создайте подсеть для шлюза в виртуальной сети.
4. Предоставление публичного IP-адреса.
5. Предоставление шлюза приложения.
6. Включить брандмауэр веб-приложений на шлюзе.

```
Connect-AzAccount
Select-AzSubscription -SubscriptionId '$SubscriptionId'
New-AzResourceGroup -Name appgw-rg -Location "East US"

#Create a virtual network and a subnet for the application gateway

#Assign an address range for the subnet to be used for the application gateway.

$gwSubnet = New-AzVirtualNetworkSubnetConfig -Name 'appgwsubnet' -AddressPrefix 10.0.0.0/24

#Assign an address range to be used for the back-end address pool.

$nicSubnet = New-AzVirtualNetworkSubnetConfig  -Name 'appsubnet' -AddressPrefix 10.0.2.0/24

#Create a virtual network with the subnets defined in the preceding steps.

$vnet = New-AzvirtualNetwork -Name 'appgwvnet' -ResourceGroupName appgw-rg -Location "East US" -AddressPrefix 10.0.0.0/16 -Subnet $gwSubnet, $nicSubnet

#Retrieve the virtual network resource and subnet resources to be used in the steps that follow.

$vnet = Get-AzvirtualNetwork -Name 'appgwvnet' -ResourceGroupName appgw-rg
$gwSubnet = Get-AzVirtualNetworkSubnetConfig -Name 'appgwsubnet' -VirtualNetwork $vnet
$nicSubnet = Get-AzVirtualNetworkSubnetConfig -Name 'appsubnet' -VirtualNetwork $vnet


#Create a public IP address for the front-end configuration

$publicip = New-AzPublicIpAddress -ResourceGroupName appgw-rg -Name 'publicIP01' -Location "East US" -AllocationMethod Dynamic

#Create an application gateway configuration object

$gipconfig = New-AzApplicationGatewayIPConfiguration -Name 'gwconfig' -Subnet $gwSubnet

#Create a front-end IP configuration

$fipconfig = New-AzApplicationGatewayFrontendIPConfig -Name 'fip01' -PublicIPAddress $publicip

#Configure the back-end IP address pool with the IP addresses of the back-end web servers

$pool = New-AzApplicationGatewayBackendAddressPool -Name 'pool01' -BackendIPAddresses 10.0.3.11

#Configure the front-end IP port for the public IP endpoint

$fp = New-AzApplicationGatewayFrontendPort -Name 'port01'  -Port 443

#Configure the certificate for the application gateway. This certificate is used to decrypt and reencrypt the traffic on the application gateway

$passwd = ConvertTo-SecureString  "P@ssword!1" -AsPlainText -Force 
$cert = New-AzApplicationGatewaySSLCertificate -Name cert01 -CertificateFile "C:\AAD\Securities\Certificates\sslcert.com.cer" -Password $passwd 


#Create the HTTP listener for the application gateway

$listener = New-AzApplicationGatewayHttpListener -Name listener01 -Protocol Https -FrontendIPConfiguration $fipconfig -FrontendPort $fp -SSLCertificate $cert

#Upload the certificate to be used on the TLS/SSL-enabled back-end pool resources

#$authcert = New-AzApplicationGatewayAuthenticationCertificate -Name 'allowlistcert1' -CertificateFile C:\cert.cer

$trustedRootCert01 = New-AzApplicationGatewayTrustedRootCertificate -Name "test1" -CertificateFile "C:\AAD\Securities\Certificates\sslcert.com.cer"

#Configure the HTTP settings for the application gateway back end

$poolSetting01 = New-AzApplicationGatewayBackendHttpSettings -Name "setting01" -Port 443 -Protocol Https -CookieBasedAffinity Disabled -TrustedRootCertificate $trustedRootCert01 -HostName "test1"

#Create a load-balancer routing rule that configures the load balancer

$rule = New-AzApplicationGatewayRequestRoutingRule -Name 'rule01' -RuleType basic -BackendHttpSettings $poolSetting -HttpListener $listener -BackendAddressPool $pool

#Configure the instance size of the application gateway

$sku = New-AzApplicationGatewaySku -Name Standard_Small -Tier Standard -Capacity 2

#Configure the TLS/SSL policy to be used on the application gateway

$SSLPolicy = New-AzApplicationGatewaySSLPolicy -MinProtocolVersion TLSv1_2 -CipherSuite "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256", "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384", "TLS_RSA_WITH_AES_128_GCM_SHA256" -PolicyType Custom

$appgw = New-AzApplicationGateway -Name appgateway -SSLCertificates $cert -ResourceGroupName "appgw-rg" -Location "East US" -BackendAddressPools $pool -BackendHttpSettingsCollection $poolSetting01 -FrontendIpConfigurations $fipconfig -GatewayIpConfigurations $gipconfig -FrontendPorts $fp -HttpListeners $listener -RequestRoutingRules $rule -Sku $sku -SSLPolicy $SSLPolicy -TrustedRootCertificate $trustedRootCert01 -Verbose

```

#### <a name="deploy-azure-web-apps"></a>Развертывание веб-приложений Azure
Служба приложений Azure позволяет создавать и размещать веб-приложения с использованием таких языков, как Python, Ruby, C и Java. Azure также поддерживает пользовательские контейнеры, которые позволяют практически всем языкам программирования работать на платформе Службы приложений Azure.

#### <a name="create-an-app-service-plan-in-free-tier"></a>Создание плана службы приложений в свободном уровне
    New-AzAppServicePlan -Name $webappname -Location $location -ResourceGroupName $webappname -Tier Free

#### <a name="create-a-web-app"></a>Создание веб-приложения
    New-AzWebApp -Name $webappname -Location $location -AppServicePlan $webappname -ResourceGroupName $webappname

    Write-Host "Configure a CNAME record that maps $fqdn to $webappname.azurewebsites.net"
    Read-Host "Press [Enter] key when ready ..."

#### <a name="before-continuing-go-to-your-azure-domain-name-system-configuration-ui-for-your-custom-domain-and-follow-the-instructions-at-httpsakamsappservicecustomdns-to-configure-a-cname-record-for-the-hostname-www-and-point-it-your-web-apps-default-domain-name"></a>Прежде чем продолжить, перейдите на пользовательский пользовательский пользовательский пользовательский https://aka.ms/appservicecustomdns домен системы системы доменных имен Azure и следуйте инструкциям, чтобы настроить запись CNAME для хост-множа "www" и указать на него доменное имя вашего веб-приложения по умолчанию

#### <a name="upgrade-app-service-plan-to-shared-tier-minimum-required-by-custom-domains"></a>Обновление плана службы приложений до общего уровня (минимум, требуемый пользовательскими доменами)
    Set-AzAppServicePlan -Name $webappname -ResourceGroupName $webappname -Tier Shared

#### <a name="add-a-custom-domain-name-to-the-web-app"></a>Добавление пользовательского доменного имени в веб-приложение
    Set-AzWebApp -Name $webappname -ResourceGroupName $webappname `-HostNames @($fqdn,"$webappname.azurewebsites.net")

## <a name="guidance-and-recommendations"></a>Инструкции и рекомендации

### <a name="network"></a>Сеть
После завершения развертывания у вас есть шлюз приложения с включенным брандмауэром веб-приложений.

Экземпляр шлюза предоставляет порт 443 для HTTPS. Эта конфигурация гарантирует, что наше приложение доступно только на порту 443 через HTTPS.

Блокировка неиспользуемых портов и ограничение экспозиции поверхности атаки является наилучшей практикой безопасности.

#### <a name="add-network-security-groups-to-the-app-service-instance"></a>Добавление групп сетевой безопасности в экземпляр службы приложений

Экземпляры Службы приложений могут быть интегрированы с виртуальными сетями. Эта интеграция позволяет настроить их с политиками группы сетевой безопасности, которые управляют входящим и исходящим трафиком приложения.

1. Для включения этой функции в лопасти экземпляра службы приложений Azure в **настройках**выберите **networking.** В правом стеле, настроить под **VNet интеграции**.

   ![Новая виртуальная сетевая интеграция](./media/secure-web-app/app-vnet-menu.png)

    *Новая виртуальная сетевая интеграция для Службы приложений*
1. На следующей странице выберите **Добавить VNET (предварительный просмотр).**

1. В следующем меню выберите виртуальную сеть, созданную в развертывании, которое начинается с `aad-vnet`. Можно создать новую подсеть или выбрать существующую.
   В этом случае создайте новую подсеть. Установите **диапазон адресов** до **10.0.0.0/24** и назовите **подсеть-подсеть.**

   ![Виртуальная конфигурация сети App Service](./media/secure-web-app/app-vnet-config.png)

    *Виртуальная конфигурация сети для службы приложений*

Теперь, когда вы включили виртуальную сетевую интеграцию, вы можете добавить группы сетевой безопасности в наше приложение.

1. Используйте окно поиска, ищите **группы сетевой безопасности.** Выберите **группы безопасности сети** в результатах.

    ![Поиск групп сетевой безопасности](./media/secure-web-app/nsg-search-menu.png)

    *Поиск групп сетевой безопасности*

2. В следующем меню выберите **Добавить**. Введите **название** NSG и **группы ресурсов,** в которой она должна быть расположена. Эта NSG будет применяться к подсети шлюза приложения.

    ![Создание NSG](./media/secure-web-app/nsg-create-new.png)

    *Создание NSG*

3. После создания NSG выберите его. В лезвии, под **настройками,** выберите **правила входящие безопасности.** Настроили эти настройки, чтобы соединения, поступающие в шлюз приложения, через порт 443.

   ![Настройка NSG](./media/secure-web-app/nsg-gateway-config.png)

   *Настройка NSG*

4. В правилах исходящего шлюза NSG добавьте правило, которое позволяет исходящие соединения в экземпляр службы app, создав правило, нацеленное на тег службы`AppService`

   ![Добавление исходящих правил для NSG](./media/secure-web-app/nsg-outbound-allowappserviceout.png)

   *Добавление исходящих правил для NSG*

    Добавьте еще одно правило исходящего, чтобы шлюз отправлял исходящие правила в виртуальную сеть.

   ![Добавить еще одно исходящие правила](./media/secure-web-app/nsg-outbound-vnet.png)

    *Добавить еще одно исходящие правила*

5. На лезвии подсетей NSG выберите **Associate,** выберите виртуальную сеть, созданную в развертывании, и выберите подсеть шлюза под названием **GW-subnet.** NSG применяется к подсети.

6. Создайте еще один NSG, как и на предыдущем этапе, на этот раз для экземпляра службы приложений. Назови его. Добавьте входящий правило для порта 443, как это было для шлюза приложения NSG.

   Если в экземпляре Службы поддержки приложений развернут экземпляр Службы поддержки, что не относится к данному приложению, вы можете добавить входящие правила, позволяющие зондировать здоровье службы Azure, открыв порты 454-455 в входяных группах безопасности вашей службы безопасности NSG. Вот конфигурация:

   ![Добавление правил для зондов здоровья службы Azure](./media/secure-web-app/nsg-create-healthprobes.png)

    *Добавление правил для зондов здоровья службы Azure (только среда службы приложений)*

Чтобы ограничить поверхность атаки, измените настройки сети Службы App, чтобы получить доступ к приложению только для шлюза приложения.
Чтобы применить настройки, перейдите на вкладку сети App Service, выбрав вкладку **IP Restrictions** и создав правило размнозания, которое позволяет только IP-коду шлюза приложения напрямую получить доступ к службе. Вы можете получить IP-адрес шлюза со страницы обзора. На вкладке **IP-адреса CIDR** введите `<GATEWAY_IP_ADDRESS>/32`IP-адрес в этом формате: .

![Разрешить только шлюз](./media/secure-web-app/app-allow-gw-only.png)

*Разрешить доступ к Службе App Service только ip-адреса шлюза*

### <a name="azure-domain-name-system"></a>Система доменных имен Azure 
Система доменных имен Azure, или система доменных имен Azure, отвечает за перевод (или разрешение) веб-сайта или имени службы на свой IP-адрес. Azure Domain Namehttps://docs.microsoft.com/azure/dns/dns-overview) System (является хостинговой службой для доменов Domain Name System, которая обеспечивает разрешение имен с помощью инфраструктуры Azure. Размещая домены в Azure, пользователи могут управлять записями системы доменных имен, используя те же учетные данные, AIS, инструменты и выставление счетов, что и другие службы Azure. Система доменных имен Azure также поддерживает частные домены Domain Name System.

### <a name="azure-disk-encryption"></a>Шифрование дисков Azure
Служба Шифрование дисков Azure использует компонент BitLocker в Windows, чтобы обеспечить шифрование томов для дисков данных. Решение интегрируется с Azure Key Vault, что помогает управлять ключами шифрования дисков.

### <a name="identity-management"></a>Управление удостоверениями
Следующие технологии предоставляют возможности для управления доступом к данным держателя карт в среде Azure
- Azure Active Directory — это многотентная облачная служба управления каталогами и идентификационными данными корпорации Майкрософт. Все пользователи этого решения созданы в Active Directory Azure, включая пользователей, обращающихся к WebApp Azure.
- Управление доступом на основе ролей Azure позволяет администраторам определять детальные разрешения доступа, предоставляя его ровно в той мере, которая необходима пользователям для выполнения работы. Вместо предоставления каждому пользователю неограниченных разрешений на ресурсы Azure администраторы могут разрешить только определенные действия для доступа к данным держателей карт. Доступ к подписке есть только у администратора подписки.
- Azure Active Directory Privileged Identity Management позволяет клиентам свести к минимуму число пользователей, имеющих доступ к определенной информации, например данным держателей карт. Администраторы могут использовать Azure Active Directory Privileged Identity Management для обнаружения, ограничения и отслеживания привилегированных удостоверений, а также их доступа к ресурсам. Эту функцию можно также задействовать для получения административного JIT-доступа по требованию, когда это необходимо.
- Azure Active Directory Identityy Protection обнаруживает потенциальные уязвимости, влияющие на идентификаторы организации, настраивает автоматизированные ответы на обнаруженные подозрительные действия, связанные с идентификаторами организации, и расследует подозрительные инциденты, чтобы принять соответствующие меры для их устранения.
### <a name="secrets-management"></a>Управление секретами
Для управления ключами и секретами в решении используется Azure Key Vault. Хранилище ключей Azure помогает защитить криптографические ключи и секреты, используемые облачными приложениями и службами. Следующие возможности Azure Key Vault помогают клиентам защищать и получать доступ к таким данным
   - Политики расширенного доступа настраиваются по мере необходимости.
   - Политики доступа к Key Vault определены с минимальными необходимыми разрешениями на использование ключей и секретов.
   - Все ключи и секреты в Key Vault имеют срок действия.
   - Все ключи в Key Vault защищены специализированными аппаратными модулями безопасности. Ключевым типом является модуль аппаратной безопасности (HSM) Защищенный 2048-разрядный ключ RSA.
   - С Key Vault вы можете шифровать ключи и секреты (такие как ключи аутентификации, ключи учетной записи хранилища, ключи шифрования данных. Файлы и пароли PFX с помощью ключей, защищенных аппаратными модулями безопасности (HSM). 
   - Используйте элемент управления доступом на основе ролей (RBAC) для назначения разрешений пользователям, группам и приложениям в определенной области.     
   - Используйте Key Vault для управления сертификатами TLS с помощью автоматического обновления. 
   - Для журналов диагностики хранилища ключей включен срок хранения не менее 365 дней.
   - Допустимые операции шифрования для ключей доступны только тем пользователям, которым они нужны.
### <a name="azure-security-center"></a>Центр безопасности Azure
С помощью Центра безопасности Azure клиенты могут централизованно применять политики безопасности и управлять ими в рабочих нагрузках, ограничивать подверженность системы к угрозам, а также выявлять атаки и реагировать на них. Кроме того 
   - Центр безопасности Azure получает доступ к существующим конфигурациям служб Azure, чтобы предоставить рекомендации по настройке и обслуживанию, чтобы улучшить безопасность и защитить данные.
   - В центре безопасности Azure используются различные возможности обнаружения, чтобы оповещать клиентов о потенциальных атаках на их среды. Эти оповещения содержат важные сведения о причине их активации, ресурсах, на которые нацелена атака, и ее источнике. Центр безопасности Azure имеет ряд предопределенных оповещений безопасности, которые активируются при возникновении угрозы или подозрительной активности. Настраиваемые правила генерации оповещений в центре безопасности Azure позволяют клиентам определять новые оповещения безопасности на основе данных, собранных из их среды.
   - Центр безопасности Azure предоставляет приоритетные оповещения безопасности и инциденты, упрощая процедуры обнаружения и устранения потенциальных проблем безопасности. Для каждой обнаруженной угрозы создается отчет об исследовании угроз. Это позволяет командам реагирования на инциденты расследовать и устранять угрозы.
### <a name="azure-application-gateway"></a>Шлюз приложений Azure 
   Архитектура снижает риск уязвимостей безопасности с помощью шлюза приложений Azure с настроенным брандмауэром веб-приложения и включенным набором правил OWASP. Дополнительные возможности включают
   - Сквозной TLS.
   - отключение TLS версий 1.0 и 1.1;
   - Включить TLSv1.2.
   - Брандмауэр веб-приложений (режим предотвращения).
   - Режим профилактики с набором правил OWASP 3.0.
   - Включить журнал диагностики.
   - Пользовательские зонды здоровья.
   - Центр безопасности Azure и советник Azure обеспечивают дополнительную защиту и уведомления. Центр безопасности Azure также предоставляет систему репутации.
### <a name="logging-and-auditing"></a>Ведение журналов и аудит
Службы Azure обеспечивают детальную запись системных и пользовательских действий, а также сведений о работоспособности системы.
   - Журналы активности: [журналы активности](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-overview-activity-logs) дают представление об операциях, выполняемых на ресурсах в подписке. Журналы действий помогают определить инициатора операции, время события и состояние.
   - Диагностические журналы: [Диагностические журналы](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs) включают все журналы, испускаемые каждым ресурсом. Эти журналы включают журналы систем событий Windows, журналы хранения azure, журналы аудита Key Vault, а также журналы доступа к порталу приложений и журналы firewall. Все журналы диагностики обеспечивают запись данных в централизованную и зашифрованную учетную запись Azure для архивирования. В соответствии с требованиями конкретной организации пользователь может настроить срок хранения до 730 дней.
### <a name="azure-monitor-logs"></a>Журналы Azure Monitor
   Эти журналы объединены в [журналы Azure Monitor для обработки,](https://azure.microsoft.com/services/log-analytics/) хранения и отчетности панели мониторинга. Собранные данные объединяются в отдельные таблицы для каждого типа данных в рабочих областях Log Analytics, что позволяет анализировать все данные независимо от первичного источника. Кроме того, Центр безопасности Azure интегрируется с журналами Azure Monitor, позволяя клиентам использовать запросы Kusto для доступа к данным событий безопасности и объединения их с данными других служб.

   Следующие [решения мониторинга](https://docs.microsoft.com/azure/log-analytics/log-analytics-add-solutions) Azure включены в эту архитектуру

   - [Активная оценка каталога](https://docs.microsoft.com/azure/log-analytics/log-analytics-ad-assessment): Решение Active Directory Health Check оценивает риск и работоспособность серверных сред на регулярном интервале и предоставляет приоритетный список рекомендаций, характерных для развернутой серверной инфраструктуры.
   - [Agent Health](https://docs.microsoft.com/azure/operations-management-suite/oms-solution-agenthealth): Решение Agent Health сообщает, сколько агентов развернуто и их географическое распределение, а также сколько агентов, которые не отвечают, и количество агентов, которые представляют оперативные данные.
   - [Аналитика журнала действий](https://docs.microsoft.com/azure/log-analytics/log-analytics-activity). Решение "Аналитика журнала действий" помогает анализировать журналы действий Azure во всех подписках Azure для клиента.
### <a name="azure-monitor"></a>Azure Monitor
   [Azure Monitor](https://docs.microsoft.com/azure/monitoring-and-diagnostics/)помогает пользователям отслеживать производительность, поддерживать безопасность и выявлять тенденции, позволяя организациям проводить аудит, создавать оповещения и архивировать данные, включая отслеживание вызовов API в ресурсах Azure.
### <a name="application-insights"></a>Application Insights 
   [Application Insights](https://docs.microsoft.com/azure/application-insights/app-insights-overview) — это расширяемая служба управления производительностью приложений для веб-разработчиков на нескольких платформах. Application Insights обнаруживает аномалии производительности и может использоваться клиентами для мониторинга динамического веб-приложения. Эта служба содержит мощные аналитические средства, которые помогают клиентам диагностировать проблемы и понять, что пользователи фактически делают в их приложении. Эта служба помогает клиентам постоянно улучшать производительность и удобство использования.

### <a name="azure-key-vault"></a>Azure Key Vault
   Создайте хранилище для организации, в которой можно хранить ключи, и поддерживать подотчетность для выполнения оперативных задач, как ниже

   - Данные, хранящиеся в Key Vault, включают   
   - ключ Application Insights;
   - Ключ доступа к хранению данных
   - Строка подключения
   - Имя таблицы данных
   - учетные данные пользователя;
   - Политики расширенного доступа настраиваются по мере необходимости.
   - Политики доступа Key Vault определяются с минимальными необходимыми разрешениями на ключи и секреты
   - Все ключи и секреты в хранилище ключей имеют срок действия.
   - Все клавиши в Key Vault защищены аппаратным модулем безопасности (HSM) «Ключевой тип» (HSM) Защищенный модуль безопасности оборудования (HSM)       
     2048-разрядный ключ RSA
   - Всем пользователям/идентификационным данным предоставляются минимальные необходимые разрешения с помощью элемента управления доступом на основе ролей (RBAC)
   - Приложения используют общее хранилище ключей, только если у них настроено взаимное доверие и им нужен доступ к одним и тем же секретам во время выполнения.
   - Для журналов диагностики хранилища ключей включен срок хранения не менее 365 дней.
   - Допустимые операции шифрования для ключей доступны только тем пользователям, которым они нужны.

### <a name="vpn-and-expressroute"></a>VPN и ExpressRoute
   Безопасный VPN туннель или [ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-introduction) необходимо настроить путем надежного установления подключения к ресурсам, развернутым в рамках этой архитектуры ссылки web-приложений PaaS. Правильно настроив VPN-подключение или ExpressRoute, клиенты могут добавить уровень защиты передаваемых данных.

   При реализации защищенного VPN-туннеля с помощью Azure можно создать виртуальное частное подключение между локальной сетью и виртуальной сетью Azure. Это соединение происходит через Интернет и позволяет клиентам надежно "туннель" информацию внутри зашифрованной связи между сетью клиента и Azure. VPN типа "сеть-сеть" — это безопасная проверенная технология, которая десятилетиями применяется на предприятиях всех размеров. Режим туннеля IPsec используется в этом решении как механизм шифрования.

   Так как трафик в VPN-туннеле проходит через Интернет с VPN типа "сеть-сеть", Майкрософт предлагает другой, еще более защищенный вариант подключения. Azure ExpressRoute — это выделенный канал связи в глобальной сети между Azure и локальной средой или поставщиком услуг размещения Exchange. Подключения ExpressRoute не осуществляются через Интернет и обеспечивают повышенный уровень безопасности, надежности и быстродействия подключений с низким уровнем задержки по сравнению со стандартными подключениями через Интернет. Более того, так как это прямое подключение поставщика телекоммуникационных услуг клиента, данные не передаются через Интернет и поэтому недоступны в нем.

   См. [рекомендации](https://docs.microsoft.com/azure/architecture/reference-architectures/dmz/secure-vnet-hybrid) по реализации защищенной гибридной сети, расширяющей локальную сеть в Azure.

#### <a name="implement-azure-active-directory-oidc"></a>Реализация Active Directory ОтЛаВа Azure

1. Чтобы клонировать репозиторий исходного кода, используйте эту команду Git

 ``` git
 git clone https://github.com/Azure-Samples/AAD-Security
   ```
## <a name="update-the-redirect-urls"></a>Обновление ренапрямых URL-адресов
1.  Вернитесь на портал Azure. В области навигации слева выберите службу Azure Active Directory, а затем выберите Регистрация приложений.
2.  В резуном экране выберите приложение WebApp-OpenIDConnect-DotNet-code-v2.
3.  В разделе «Проверка подлинности» o In the Redirect URIs выберите Web в комбо-коробке и добавьте следующие URL-е УРИ.
    https://WebApp-OpenIDConnect-DotNet-code-v2-contoso.azurewebsites.nethttps://WebApp-OpenIDConnect-DotNet-code-v2-contoso.azurewebsites.net/signin-oidc o В разделе Расширенные настройки установить URL-адрес Logouthttps://WebApp-OpenIDConnect-DotNet-code-v2-contoso.azurewebsites.net/signout-oidc
4.  Например, на вкладке «Брендинг» o обновление URL-адреса https://WebApp-OpenIDConnect-DotNet-code-v2-contoso.azurewebsites.netглавной страницы по адресу службы приложений.
        o Сохранить конфигурацию.
5.  Если приложение вызывает веб-апи, обязательно примените необходимые изменения в проекте appsettings.json, поэтому оно вызывает опубликованный URL API вместо локального хоста.
Публикация образца
    1.  На вкладке Обзор службы приложений скачайте профиль публикации, щелкнув ссылку Скачать профиль публикации, и сохраните его. Вы также можете использовать и другие механизмы развертывания, например развертывание из системы управления версиями.
    2.  Переключитесь на Visual Studio и перейдите на проект WebApp-OpenIDConnect-DotNet-code-v2. В обозревателе решений щелкните правой кнопкой мыши проект и выберите Опубликовать. Щелкните Импортировать профиль на нижней панели и импортируйте скачанный ранее профиль публикации.
    3.  Нажмите на настройку и в вкладке "Соединение" обновите URL-адрес https://WebApp-OpenIDConnect-DotNet-code-v2-contoso.azurewebsites.netназначения, чтобы он был, например, https в URL-адресе главной страницы. Нажмите кнопку Далее.
    4.  На вкладке «Настройки» убедитесь, что не выбрана организационная аутентификация Enable. Нажмите кнопку «Сохранить». Щелкните Опубликовать на главном экране.
    5.  Visual Studio опубликует проект и автоматически откроет в браузере URL-адрес проекта. Если отображается веб-страница по умолчанию проекта, публикация прошла успешно.
#### <a name="implement-multi-factor-authentication-for-azure-active-directory"></a>Внедрение мультифакторной аутентификации для активного каталога Azure
   Администраторы должны обеспечить защиту учетных записей подписок на портале. Подписка уязвима для атак, поскольку она управляет созданными ресурсами. Для защиты подписки включите многофакторную аутентификацию на вкладке **Azure Active Directory** подписки.

   AD Azure работает на основе политик, которые применяются к пользователю или группам пользователей, которые соответствуют определенным критериям.
Azure создает политику по умолчанию, определяющую, что администраторам нужна двухфакторная аутентификация для вхинга на портал.
После включения этой политики вам может быть предложено войти в систему и войти обратно на портал Azure.

Для того, чтобы МИД для админ-ввоза

   1. Перейдите на вкладку **Active Directory Azure** на портале Azure
   2. Под категорией безопасности выберите условный доступ. Вы видите этот экран

       ![Условный доступ - Политики](./media/secure-aad-app/ad-mfa-conditional-add.png)

Если вы не можете создать новую политику

   1. Перейдите на вкладку **МИД.**
   2. Выберите **бесплатную пробную** ссылку Azure AD Premium, чтобы подписаться на бесплатную пробную версию.

   ![Бесплатная пробная версия Azure AD Premium](./media/secure-aad-app/ad-trial-premium.png)

Возвращение на условный экран доступа.

   1. Выберите новую вкладку политики.
   2. Введите имя политики.
   3. Выберите пользователей или группы, для которых вы хотите включить MFA.
   4. Под **управлением доступа**выберите вкладку **Гранта,** а затем выберите **многофакторную аутентификацию** (и другие параметры, если хотите).

   ![Требовать многофакторную идентификацию](./media/secure-aad-app/ad-mfa-conditional-add.png)

   Вы можете включить политику, выбрав флажок в верхней части экрана или сделайте это на вкладке **«Условный доступ».** Когда политика включена, пользователям необходимо, чтобы МИД вписался на портал.

   Существует базовая политика, требующая МИД для всех администраторов Azure. Вы можете включить его сразу на портале. Включение этой политики может привести к аннулированию текущей сессии и заставить вас войти снова.

   Если базовая политика не включена
   1.   Выберите **Требование МИД для админов.**
   2.   Немедленно выберите **политику использования.**

   ![Немедленно выберите политику использования](./media/secure-aad-app/ad-mfa-conditional-enable.png)

#### <a name="use-azure-sentinel-to-monitor-apps-and-resources"></a>Используйте Azure Sentinel для мониторинга приложений и ресурсов

   По мере роста приложения становится трудно агрегировать все сигналы безопасности и метрики, полученные от ресурсов, и делать их полезными в ориентированном на действия виде.

   Azure Sentinel предназначен для сбора данных, обнаружения возможных типов угроз и обеспечения видимости инцидентов безопасности.
В то время как он ждет ручного вмешательства, Azure Sentinel может полагаться на заранее написанные игровые книги, чтобы начать оповещения и процессы управления инцидентами.

   Пример приложения состоит из нескольких ресурсов, которые Azure Sentinel может контролировать.
Чтобы настроить Azure Sentinel, сначала необходимо создать рабочее пространство для анализа журналов, в которое хранятся все данные, собранные из различных ресурсов.

Для создания этого рабочего пространства

   1. В поле поиска на портале Azure ищите **аналитику журнала.** Выберите **Рабочие области Log Analytics**.

   ![Поиск рабочих областей анализа журналов](./media/secure-aad-app/sentinel-log-analytics.png)

   *Поиск рабочих областей анализа журналов*

   2. На следующей странице выберите **Добавить,** а затем укажите имя, группу ресурсов и местоположение рабочего пространства.
   ![Создание рабочей области Log Analytics с помощью PowerShell](./media/secure-aad-app/sentinel-log-analytics-create.png)

   *Создание рабочего пространства анализа журналов*

   3. Используйте поле поиска для поиска **Azure Sentinel.**

   ![Поиск по фразе "Azure Sentinel"](./media/secure-aad-app/sentinel-add.png)

   *Поиск Azure Sentinel*

   4. Выберите **Добавить,** а затем выберите рабочее пространство Log Analytics, созданное ранее.

   ![Добавление рабочего пространства анализа журналов](./media/secure-aad-app/sentinel-workspace-add.png)

   *Добавление рабочего пространства анализа журналов*

   5. На **странице Разъемов данных Azure Sentinel - Под** **конфигурацией**выберите **разъемы данных.** Вы видите массив служб Azure, которые можно связать с экземпляром хранения журналов Analytics для анализа в Azure Sentinel.

   ![Разъемы данных «Аналитика журнала»](./media/secure-aad-app/sentinel-connectors.png)

      *Добавление разъема данных в Azure Sentinel*

   Например, чтобы подключить шлюз приложения, следующие действия:

   1. Откройте лопасти экземпляра экземпляра Azure Application Gateway.
   2. В разделе **Мониторинг** выберите **Параметры диагностики**.
   3. Выберите **Диагностическую настройку добавления.**

   ![Добавление диагностики шлюзов приложений](./media/secure-aad-app/sentinel-gateway-connector.png)
         
   *Добавление диагностики шлюзов приложений*

   4. На странице **«Диагностические настройки»** выберите созданное вами рабочее пространство «Аналитика журнала», а затем выберите все метрики, которые вы хотите собрать и отправить в Azure Sentinel. Щелкните **Сохранить**.

   ![Настройки разъема Azure Sentinel](./media/secure-aad-app/sentinel-connector-settings.png)



## <a name="cost-considerations"></a>Рекомендации по стоимости
   Если у вас еще нет учетной записи Azure, можно создать бесплатную учетную запись. Перейдите на [бесплатную страницу учетной записи,](https://azure.microsoft.com/free/) чтобы начать работу, узнайте, что вы можете сделать с бесплатной учетной записью Azure, и узнайте, какие продукты бесплатны в течение 12 месяцев.

   Чтобы развернуть ресурсы в примере приложения с функциями безопасности, необходимо оплатить некоторые премиум-функции. Поскольку масштабы приложения и бесплатные уровни и пробные версии, предлагаемые Azure, должны быть обновлены в соответствии с требованиями приложения, ваши затраты могут возрасти. Используйте [калькулятор ценообразования](https://azure.microsoft.com/pricing/calculator/) Azure для оценки затрат.

## <a name="next-steps"></a>Дальнейшие действия
   Следующие статьи помогут вам разрабатывать, разрабатывать и развертывать безопасные приложения.

- [Конструирование](secure-design.md)
- [Разработка](secure-develop.md)
- [Развернуть](secure-deploy.md)
