---
title: Разработка безопасного веб-приложения Azure AD | Документация Майкрософт
description: В этом простом примере приложения реализованы рекомендации по обеспечению безопасности, которые улучшают приложение и уровень безопасности Организации при разработке в Azure.
keywords: строч
services: security
documentationcenter: na
author: fehase
manager: alclabo
editor: ''
ms.assetid: cd906856-f4f9-4ddc-9249-c998386f4085
ms.service: security
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 09/12/2019
ms.author: v-fehase
ms.openlocfilehash: 87df7824a182e68d849fdf967f96b2974b7e0c16
ms.sourcegitcommit: b03516d245c90bca8ffac59eb1db522a098fb5e4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/19/2019
ms.locfileid: "71148176"
---
# <a name="develop-secure-app-for-an-azure-ad-app"></a>Разработка защищенного приложения для приложения Azure AD
## <a name="overview"></a>Обзор

Этот пример представляет собой простой Azure Active Directory с веб-приложением, которое содержит ссылки на ресурсы по безопасности для разработки приложений в Azure. Приложение реализует рекомендации по обеспечению безопасности, которые помогут улучшить приложение и уровень безопасности Организации при разработке приложений в Azure.

Скрипты развертывания настроили инфраструктуру. После запуска скриптов развертывания необходимо выполнить некоторые настройки вручную в портал Azure, чтобы связать компоненты и службы вместе. Этот пример предназначен для опытных разработчиков в Azure, которые работают в розничной отрасли и хотят создать защищенную Azure Active Directory с безопасной инфраструктурой Azure. 


При разработке и развертывании этого приложения вы узнаете, как 
- Создайте экземпляр Azure Key Vault, сохраните и извлеките из него секреты.
- Разверните веб-приложение Azure, выделенное изолированным с помощью доступа к брандмауэру внешнего интерфейса. 
- Создайте и настройте экземпляр шлюза приложений Azure с брандмауэром, использующим набор правил OWASP Top 10. 
- Включение шифрования передаваемых и неактивных данных с помощью служб Azure. 
- Настройте политику Azure и центр безопасности, чтобы оценить комплианЦиес. 

После разработки и развертывания этого приложения вы настроили следующий пример веб-приложения вместе с описанными мерами конфигурации и безопасности.

## <a name="architecture"></a>Архитектура
Приложение представляет собой типичное n-уровневое приложение с тремя уровнями. Внешний интерфейс, серверная часть и уровень базы данных с интегрированными компонентами мониторинга и управления секретами показаны здесь:

![Архитектура приложения](./media/secure-aad-app/architecture.png)

Это решение использует следующие службы Azure. Сведения об архитектуре развертывания см. в разделе Архитектура развертывания. 

Архитектура состоит из этих компонентов.

- [Шлюз приложений Azure.](../../application-gateway/index.yml) Предоставляет шлюз и брандмауэр для нашей архитектуры приложения.
- [Application Insights](../../azure-monitor/app/app-insights-overview.md). Предоставляет расширяемую службу управления производительностью приложений (APM) на нескольких платформах.
- [Azure Key Vault.](../../key-vault/index.yml) Сохраняет и шифрует секреты нашего приложения и управляет созданием политик доступа, связанных с ними.
- [Azure Active Directory](../../active-directory/fundamentals/active-directory-whatis.md). Предоставляет облачную службу управления удостоверениями и доступом, а также вход и доступ к ресурсам.
- [Система доменных имен Azure](../../dns/dns-overview.md). Укажите службу для размещения домена.
- [Azure Load Balancer.](../../load-balancer/load-balancer-overview.md) Позволяет масштабировать приложения и создавать высокий уровень доступности для служб.
- [Веб-приложение Azure](../../app-service/overview.md).  Предоставляет службу на основе HTTP для размещения веб-приложений.
- [Центр безопасности Azure](../../security-center/index.yml). обеспечивает расширенную защиту от угроз для гибридных рабочих нагрузок в облаке.
- [Политика Azure](../../governance/policy/overview.md). Обеспечивает оценку ресурсов для несоответствия назначенным политикам.

## <a name="threat-model"></a>Модель рисков
Моделирование угроз — это процесс выявления потенциальных угроз безопасности для вашего бизнеса и приложения и последующего обеспечения надлежащего плана по устранению рисков.

В этом примере используется [Microsoft Threat Modeling Tool](https://docs.microsoft.com/azure/security/azure-security-threat-modeling-tool) для реализации моделирования угроз для безопасного примера приложения. Благодаря диаграмме компонентов и потоков данных можно определить проблемы и угрозы на ранних этапах процесса разработки. Время и деньги будут сохранены позже с помощью.

Ниже приведена модель угроз для примера приложения.

![Модель рисков](./media/secure-aad-app/threat-model.png)

В следующем снимке экрана показаны некоторые примеры угроз и потенциальные уязвимости, которые создает средство моделирования угроз. Модель угроз предоставляет обзор уязвимой уязвимой зоны и предлагает разработчикам подумать о том, как устранить проблемы.

![Выходные данные модели угроз](./media/secure-aad-app/threat-model-output.png)

### <a name="prerequisites"></a>Предварительные требования
Чтобы запустить приложение, необходимо установить следующие средства:

- Редактор кода для изменения и просмотра кода приложения. [Visual Studio Code](https://code.visualstudio.com/) является параметром с открытым исходным кодом.
- [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest&viewFallbackFrom=azure-cli-latest,) на компьютере разработчика.
- [Git](https://git-scm.com/) в вашей системе. Git используется для локального клонирования исходного кода.
- [JQ](https://stedolan.github.io/jq/), средство UNIX для запроса JSON в удобном для пользователя виде.

Для развертывания ресурсов примера приложения необходима подписка Azure. Если у вас нет подписки Azure, можно [создать бесплатную учетную запись](https://azure.microsoft.com/free/) для тестирования примера приложения.

После установки этих средств все готово к развертыванию приложения в Azure.

### <a name="implementation-guidance"></a>Рекомендации по реализации
Скрипт развертывания — это один сценарий, который можно разделить на четыре этапа. Каждый этап развертывает и настраивает ресурс Azure, который находится на [схеме архитектуры](#architecture).

Четыре этапа

- Развертывание Azure Key Vault.
- Развертывание веб-приложений Azure.
- Развертывание шлюза приложений с брандмауэром веб-приложения.
- Настройка Azure AD с развернутым приложением.

Каждый этап строится на основе предыдущего с помощью конфигурации из ранее развернутых ресурсов.

Чтобы выполнить действия по реализации, убедитесь, что установлены средства, перечисленные в разделе [Предварительные требования](#prerequisites).

#### <a name="deploy-azure-key-vault"></a>Развертывание Azure Key Vault
В этом разделе вы создадите и развернете экземпляр Azure Key Vault, который используется для хранения секретов и сертификатов.

После завершения развертывания вы получите Azure Key Vault экземпляр, развернутый в Azure.

Развертывание Azure Key Vault с помощью PowerShell
 
1. Объявите переменные для Azure Key Vault.
2. Зарегистрируйте поставщик Azure Key Vault.
3. Создайте группу ресурсов для экземпляра.
4. Создайте экземпляр Azure Key Vault в группе ресурсов, созданной на шаге 3.

#### <a name="the-below-azure-ad-user-will-have-admin-permissions-to-the-key-vault"></a>Указанный ниже пользователь Azure AD будет иметь разрешения администратора для Key Vault
    $keyVaultAdminUsers = @($user1,user2)

#### <a name="register-the-az-providers"></a>Регистрация поставщиков AZ
    Register-AzResourceProvider -ProviderNamespace Microsoft.KeyVault

#### <a name="create-the-azure-key-vault-instance"></a>Создание экземпляра Azure Key Vault
    New-AzKeyVault -Name $kvName 
                -ResourceGroupName $ResourceGroup 
                -Location 'East US'
                -EnabledForDiskEncryption

#### <a name="add-the-administrator-policies-to-the-key-vault"></a>Добавьте политики администратора в Key Vault
    foreach ($keyVaultAdminUser in $keyVaultAdminUsers) {
    $UserObjectId = (Get-AzADUser -SearchString $keyVaultAdminUser).Id
    Set-AzKeyVaultAccessPolicy -VaultName $keyVaultName -ResourceGroupName $resourceGroupName -ObjectId $UserObjectId 
    -PermissionsToKeys all -PermissionsToSecrets all -PermissionsToCertificates all
    }

#### <a name="to-create-an-access-policy-to-allow-a-user-to-get-and-list-cryptographic-keys-certificates-and-secrets-if-you-know-the-user-principal-name"></a>Чтобы создать политику доступа, позволяющую пользователю получать и перечислять криптографические ключи, сертификаты и секреты, если известно имя участника-пользователя:
    Set-AzKeyVaultAccessPolicy -VaultName $keyVaultName 
                           -ResourceGroupName $resourceGroupName 
                           -UserPrincipalName 'user1@contoso.com 
                           -PermissionsToCertificates list, get 
                           -PermissionsToKeys list, get 
                           -PermissionsToSecrets list, get 

Рекомендуется использовать управляемые удостоверения для ресурсов Azure в приложениях, которые используют Key Vault для доступа к ресурсам. Уровень безопасности увеличивается, когда ключи доступа Key Vault не хранятся в коде или в конфигурации.

Корневой сертификат входит в контейнер. Действия, предпринятые для получения сертификата,

1. Скачайте файл сертификата из [центра сертификации](https://www.digicert.com/CACerts/BaltimoreCyberTrustRoot.crt).
2. Декодирование файла сертификата:

   ```powershell
   openssl x509 -inform DER -in BaltimoreCyberTrustRoot.crt -text -out root.crt
   ```
Этот скрипт создает назначенное удостоверение для экземпляра службы приложений, который можно использовать с MSI для взаимодействия с Azure Key Vault без жестко кодированных секретов в коде или конфигурации.

Перейдите на Azure Key Vault экземпляр на портале, чтобы авторизовать назначенное удостоверение на вкладке Политика доступа. Выберите **Добавить новую политику доступа**. В разделе **Выбор субъекта**найдите имя приложения, похожее на имя созданного экземпляра службы приложений.
Субъект-служба, присоединенная к приложению, должна быть видимой. Выберите страницу и сохраните политику доступа, как показано на следующем снимке экрана.

Так как приложению необходимо получить только ключи, выберите разрешение **Get** в параметрах секреты, чтобы разрешить доступ, одновременно уменьшая предоставленные привилегии.

![Политика доступа к Key Vault](./media/secure-aad-app/kv-access-policy.png)

*Создание политики доступа Key Vault*

Сохраните политику доступа, а затем сохраните новое изменение на вкладке **политики доступа** , чтобы обновить политики.

#### <a name="deploy-application-gateway-with-web-application-firewall-enabled"></a>Развертывание шлюза приложений с включенным брандмауэром веб-приложения
В веб-приложениях не рекомендуется предоставлять службы непосредственно внешнему миру в Интернете.
Правила балансировки нагрузки и брандмауэра обеспечивают более безопасный и контроль над входящим трафиком и помогают управлять им.

Развертывание экземпляра шлюза приложений

1. Создайте группу ресурсов, в которой будет размещен шлюз приложений.
2. Подготавливает виртуальную сеть для подключения к шлюзу.
3. Создайте подсеть для шлюза в виртуальной сети.
4. Подготавливает общедоступный IP-адрес.
5. Подготавливает шлюз приложений.
6. Включите брандмауэр веб-приложения на шлюзе.

```
Connect-AzAccount
Select-AzSubscription -SubscriptionId '$SubscriptionId'
New-AzResourceGroup -Name appgw-rg -Location "East US"

#Create a virtual network and a subnet for the application gateway

#Assign an address range for the subnet to be used for the application gateway.

$gwSubnet = New-AzVirtualNetworkSubnetConfig -Name 'appgwsubnet' -AddressPrefix 10.0.0.0/24

#Assign an address range to be used for the back-end address pool.

$nicSubnet = New-AzVirtualNetworkSubnetConfig  -Name 'appsubnet' -AddressPrefix 10.0.0.0/24

#Create a virtual network with the subnets defined in the preceding steps.

$vnet = New-AzvirtualNetwork -Name 'appgwvnet' -ResourceGroupName appgw-rg -Location "East US" -AddressPrefix 10.0.0.0/16 -Subnet $gwSubnet, $nicSubnet

#Retrieve the virtual network resource and subnet resources to be used in the steps that follow.

$vnet = Get-AzvirtualNetwork -Name 'appgwvnet' -ResourceGroupName appgw-rg
$gwSubnet = Get-AzVirtualNetworkSubnetConfig -Name 'appgwsubnet' -VirtualNetwork $vnet
$nicSubnet = Get-AzVirtualNetworkSubnetConfig -Name 'appsubnet' -VirtualNetwork $vnet


#Create a public IP address for the front-end configuration

$publicip = New-AzPublicIpAddress -ResourceGroupName appgw-rg -Name 'publicIP01' -Location "East US" -AllocationMethod Dynamic

#Create an application gateway configuration object

$gipconfig = New-AzApplicationGatewayIPConfiguration -Name 'gwconfig' -Subnet $gwSubnet

#Create a front-end IP configuration

$fipconfig = New-AzApplicationGatewayFrontendIPConfig -Name 'fip01' -PublicIPAddress $publicip

#Configure the back-end IP address pool with the IP addresses of the back-end web servers

$pool = New-AzApplicationGatewayBackendAddressPool -Name 'pool01' -BackendIPAddresses 10.0.0.0

#Configure the front-end IP port for the public IP endpoint

$fp = New-AzApplicationGatewayFrontendPort -Name 'port01'  -Port 443

#Configure the certificate for the application gateway. This certificate is used to decrypt and reencrypt the traffic on the application gateway

$passwd = ConvertTo-SecureString  "P@ssword!1" -AsPlainText -Force 
$cert = New-AzApplicationGatewaySSLCertificate -Name cert01 -CertificateFile "C:\AAD\Securities\Certificates\sslcert.com.cer" -Password $passwd 

#Create the HTTP listener for the application gateway

$listener = New-AzApplicationGatewayHttpListener -Name listener01 -Protocol Https -FrontendIPConfiguration $fipconfig -FrontendPort $fp -SSLCertificate $cert

#Upload the certificate to be used on the SSL-enabled back-end pool resources

#$authcert = New-AzApplicationGatewayAuthenticationCertificate -Name 'allowlistcert1' -CertificateFile C:\cert.cer

$trustedRootCert01 = New-AzApplicationGatewayTrustedRootCertificate -Name "test1" -CertificateFile "C:\AAD\Securities\Certificates\sslcert.com.cer"

#Configure the HTTP settings for the application gateway back end

$poolSetting01 = New-AzApplicationGatewayBackendHttpSettings -Name “setting01” -Port 443 -Protocol Https -CookieBasedAffinity Disabled -TrustedRootCertificate $trustedRootCert01 -HostName "test1"

#Create a load-balancer routing rule that configures the load balancer

$rule = New-AzApplicationGatewayRequestRoutingRule -Name 'rule01' -RuleType basic -BackendHttpSettings $poolSetting -HttpListener $listener -BackendAddressPool $pool

#Configure the instance size of the application gateway

$sku = New-AzApplicationGatewaySku -Name Standard_Small -Tier Standard -Capacity 2

#Configure the SSL policy to be used on the application gateway

$SSLPolicy = New-AzApplicationGatewaySSLPolicy -MinProtocolVersion TLSv1_2 -CipherSuite "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256", "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384", "TLS_RSA_WITH_AES_128_GCM_SHA256" -PolicyType Custom

$appgw = New-AzApplicationGateway -Name appgateway -SSLCertificates $cert -ResourceGroupName "appgw-rg" -Location "East US" -BackendAddressPools $pool -BackendHttpSettingsCollection $poolSetting01 -FrontendIpConfigurations $fipconfig -GatewayIpConfigurations $gipconfig -FrontendPorts $fp -HttpListeners $listener -RequestRoutingRules $rule -Sku $sku -SSLPolicy $SSLPolicy -TrustedRootCertificate $trustedRootCert01 -Verbose

```

#### <a name="deploy-azure-web-apps"></a>Развертывание веб-приложений Azure
Служба приложений Azure позволяет создавать и размещать веб-приложения с помощью таких языков, как Python, Ruby C#, и Java. Azure также поддерживает пользовательские контейнеры, которые могут позволить практически всем языкам программирования работать на платформе службы приложений Azure.

#### <a name="create-an-app-service-plan-in-free-tier"></a>Создание плана службы приложений на уровне "бесплатный"
    New-AzAppServicePlan -Name $webappname -Location $location -ResourceGroupName $webappname -Tier Free

#### <a name="create-a-web-app"></a>Создание веб-приложения
    New-AzWebApp -Name $webappname -Location $location -AppServicePlan $webappname -ResourceGroupName $webappname

    Write-Host "Configure a CNAME record that maps $fqdn to $webappname.azurewebsites.net"
    Read-Host "Press [Enter] key when ready ..."

#### <a name="before-continuing-go-to-your-azure-domain-name-system-configuration-ui-for-your-custom-domain-and-follow-the-instructions-at-httpsakamsappservicecustomdns-to-configure-a-cname-record-for-the-hostname-www-and-point-it-your-web-apps-default-domain-name"></a>Прежде чем продолжить, перейдите в пользовательский интерфейс настройки системы доменных имен Azure для личного домена и следуйте инструкциям https://aka.ms/appservicecustomdns по настройке записи CNAME для имени узла "www" и укажите имя домена по умолчанию для веб-приложения.

#### <a name="upgrade-app-service-plan-to-shared-tier-minimum-required-by-custom-domains"></a>Обновите план службы приложений до общего уровня (минимально требуется для пользовательских доменов)
    Set-AzAppServicePlan -Name $webappname -ResourceGroupName $webappname -Tier Shared

#### <a name="add-a-custom-domain-name-to-the-web-app"></a>Добавление пользовательского доменного имени в веб-приложение
    Set-AzWebApp -Name $webappname -ResourceGroupName $webappname `-HostNames @($fqdn,"$webappname.azurewebsites.net")

## <a name="guidance-and-recommendations"></a>Инструкции и рекомендации

### <a name="network"></a>Сеть
После завершения развертывания вы получите шлюз приложений с включенным брандмауэром веб-приложения.

Экземпляр шлюза предоставляет порт 443 для HTTPS. Такая конфигурация гарантирует, что наше приложение будет доступно только через порт 443 по протоколу HTTPS.

Блокирование неиспользуемых портов и ограничение уязвимости в области атаки является рекомендуемой практикой безопасности.

#### <a name="add-network-security-groups-to-the-app-service-instance"></a>Добавление групп безопасности сети в экземпляр службы приложений

Экземпляры службы приложений можно интегрировать с виртуальными сетями. Такая интеграция позволяет настроить для них политики групп безопасности сети, которые управляют входящим и исходящим трафиком приложения.

1. Чтобы включить эту функцию, в колонке экземпляра службы приложений Azure в разделе **Параметры**выберите **сеть**. В области справа настройте в разделе **Интеграция виртуальной сети**.

   ![Новая интеграция виртуальной сети](./media/secure-web-app/app-vnet-menu.png)

    *Новая интеграция виртуальной сети для службы приложений*
1. На следующей странице выберите **добавить виртуальную сеть (Предварительная версия)** .

1. В следующем меню выберите виртуальную сеть, созданную в развертывании, которое начинается `aad-vnet`с. Можно либо создать новую подсеть, либо выбрать существующую.
   В этом случае создайте новую подсеть. Задайте для **диапазона адресов** значение **10.0.3.0/24** и укажите имя **подсети App-Subnet**.

   ![Конфигурация виртуальной сети службы приложений](./media/secure-web-app/app-vnet-config.png)

    *Конфигурация виртуальной сети для службы приложений*

Теперь, когда вы включили интеграцию с виртуальной сетью, к нашему приложению можно добавить группы безопасности сети.

1. Используйте поле поиска, чтобы найти **группы безопасности сети**. В результатах выберите **группы безопасности сети** .

    ![Поиск групп безопасности сети](./media/secure-web-app/nsg-search-menu.png)

    *Поиск групп безопасности сети*

2. В следующем меню выберите **Добавить**. Введите **имя** NSG и **группу ресурсов** , в которой он должен находиться. Эта NSG будет применена к подсети шлюза приложений.

    ![Создание NSG](./media/secure-web-app/nsg-create-new.png)

    *Создание NSG*

3. После создания NSG выберите его. В колонке в разделе **Параметры**выберите **правила безопасности для входящего трафика**. Настройте эти параметры, чтобы разрешить подключения к шлюзу приложений через порт 443.

   ![Настройка NSG](./media/secure-web-app/nsg-gateway-config.png)

   *Настройка NSG*

4. В правилах исходящего трафика для шлюза NSG добавьте правило, разрешающее исходящие подключения к экземпляру службы приложений, создав правило, предназначенное для тега службы.`AppService`

   ![Добавление правил для исходящего трафика для NSG](./media/secure-web-app/nsg-outbound-allowappserviceout.png)

   *Добавление правил для исходящего трафика для NSG*

    Добавьте еще одно правило для исходящего трафика, чтобы разрешить шлюзу отправку правил исходящего трафика в виртуальную сеть.

   ![Добавить другое правило для исходящего трафика](./media/secure-web-app/nsg-outbound-vnet.png)

    *Добавить другое правило для исходящего трафика*

5. В колонке подсети NSG выберите **сопоставить**, выберите виртуальную сеть, созданную в развертывании, и выберите подсеть шлюза с именем **GW-Subnet**. NSG применяется к подсети.

6. Создайте еще один NSG, как на предыдущем шаге, на этот раз для экземпляра службы приложений. Присвойте ему имя. Добавьте правило входящего трафика для порта 443, как и для шлюза приложений NSG.

   При наличии экземпляра службы приложений, развернутого на Среда службы приложений экземпляре, который не используется для этого приложения, можно добавить правила для входящего трафика, чтобы разрешить проверки работоспособности служб Azure, открыв порты 454-455 в группах безопасности входящих данных службы приложений NSG. Ниже приведена конфигурация.

   ![Добавление правил для проверок работоспособности служб Azure](./media/secure-web-app/nsg-create-healthprobes.png)

    *Добавление правил для проверок работоспособности служб Azure (только Среда службы приложений)*

Чтобы ограничить область атак, измените параметры сети службы приложений, чтобы разрешить доступ к приложению только шлюзу приложений.
Чтобы применить эти параметры, перейдите на вкладку Сеть службы приложений, выберите вкладку **ограничения IP-адресов** и создайте правило разрешения, которое разрешает доступ к службе только для IP-адреса шлюза приложений. IP-адрес шлюза можно получить на странице обзора. На вкладке **CIDR. IP-адрес** введите IP-адрес в следующем формате: `<GATEWAY_IP_ADDRESS>/32`.

![Разрешить только шлюз](./media/secure-web-app/app-allow-gw-only.png)

*Разрешить доступ к службе приложений только IP-адресу шлюза*

### <a name="azure-domain-name-system"></a>Система доменных имен Azure 
Система доменных имен Azure или служба доменных имен Azure отвечает за преобразование (или разрешение) имени веб-сайта или службы в IP-адрес. Система доменных имен Azure https://docs.microsoft.com/azure/dns/dns-overview) (это служба размещения для доменов системы доменных имен, которая обеспечивает разрешение имен с помощью инфраструктуры Azure. При размещении доменов в Azure пользователи могут управлять записями системы доменных имен, используя те же учетные данные, API, средства и выставление счетов, что и другие службы Azure. Система доменных имен Azure также поддерживает домены системы частных доменных имен.

### <a name="azure-disk-encryption"></a>Шифрование диска Azure
Шифрование дисков Azure использует функцию BitLocker Windows, чтобы обеспечить шифрование томов для дисков данных. Решение интегрируется с Azure Key Vault, что помогает управлять ключами шифрования дисков.

### <a name="identity-management"></a>Управление удостоверениями
Следующие технологии предоставляют возможности для управления доступом к данным владельцев карт в среде Azure.
- Azure Active Directory является облачным каталогом Майкрософт и службой управления удостоверениями, основанным на нескольких клиентах. Все пользователи этого решения создаются в Azure Active Directory, включая пользователей, обращающихся к Azure WebApp.
- Управление доступом на основе ролей в Azure позволяет администраторам определять детализированные разрешения на доступ, чтобы предоставить пользователям доступ только для выполнения своих заданий. Вместо предоставления каждому пользователю неограниченных разрешений на ресурсы Azure администраторы могут разрешить только определенные действия для доступа к данным держателей карт. Доступ к подписке есть только у администратора подписки.
- Azure Active Directory Privileged Identity Management позволяет пользователям максимально сокращать количество пользователей, имеющих доступ к определенным сведениям, таким как данные владельцев карт. Администраторы могут использовать Azure Active Directory Privileged Identity Management для обнаружения, ограничения и отслеживания привилегированных удостоверений, а также их доступа к ресурсам. Эту функцию можно также задействовать для получения административного JIT-доступа по требованию, когда это необходимо.
- Защита идентификации Azure Active Directory обнаруживает потенциальные уязвимости, влияющие на удостоверения Организации, настраивает автоматические ответы на обнаруженные подозрительные действия, связанные с удостоверениями организации, и изучает подозрительные инциденты для выполнения соответствующих действий по их устранению.
### <a name="secrets-management"></a>Управление секретами
Решение использует Azure Key Vault для управления ключами и секретами. Хранилище ключей Azure помогает защитить криптографические ключи и секреты, используемые облачными приложениями и службами. Следующие возможности Azure Key Vault помогают клиентам защитить такие данные и получать к ним доступ
   - Политики расширенного доступа настраиваются по мере необходимости.
   - Политики доступа к Key Vault определены с минимальными необходимыми разрешениями на использование ключей и секретов.
   - Все ключи и секреты в Key Vault имеют срок действия.
   - Все ключи в Key Vault защищены специализированными аппаратными модулями безопасности. Тип ключа — это защищенный 2048-разрядный ключ RSA аппаратного модуля безопасности (HSM).
   - С помощью Key Vault можно зашифровать ключи и секреты (например, ключи проверки подлинности, ключи учетной записи хранения, ключи шифрования данных). PFX-файлы и пароли) с помощью ключей, защищенных аппаратными модулями безопасности (HSM). 
   - Используйте управление доступом на основе ролей (RBAC) для назначения разрешений пользователям, группам и приложениям в определенной области.     
   - Используйте Key Vault для управления сертификатами TLS с помощью автопродления. 
   - Для журналов диагностики хранилища ключей включен срок хранения не менее 365 дней.
   - Допустимые операции шифрования для ключей доступны только тем пользователям, которым они нужны.
### <a name="azure-security-center"></a>Центр безопасности Azure
С помощью центра безопасности Azure клиенты могут централизованно применять политики безопасности и управлять ими в рабочих нагрузках, ограничивать риск угроз, а также обнаруживать атаки и реагировать на них. Дополнительного 
   - Центр безопасности Azure обращается к существующим конфигурациям служб Azure, чтобы предоставить рекомендации по настройке и обслуживанию для повышения безопасности и защиты данных.
   - В центре безопасности Azure используются различные возможности обнаружения, чтобы оповещать клиентов о потенциальных атаках на их среды. Эти оповещения содержат важные сведения о причине их активации, ресурсах, на которые нацелена атака, и ее источнике. Центр безопасности Azure имеет набор стандартных оповещений системы безопасности, которые запускаются при возникновении угрозы или подозрительных действий. Настраиваемые правила генерации оповещений в центре безопасности Azure позволяют клиентам определять новые оповещения системы безопасности на основе данных, уже собранных из их среды.
   - Центр безопасности Azure предоставляет приоритетные оповещения безопасности и инциденты, упрощая процедуры обнаружения и устранения потенциальных проблем безопасности. Отчет по анализу угроз создается для каждой обнаруженной угрозы, чтобы помочь группам реагирования на инциденты в исследовании и устранения угрозах.
### <a name="azure-application-gateway"></a>Шлюз приложений Azure 
   Архитектура снижает риск уязвимостей безопасности с помощью шлюза приложений Azure с настроенным брандмауэром веб-приложения и включенным набором правил OWASP. К дополнительным возможностям относятся
   - Сквозной интерфейс SSL.
   - Отключите TLS v 1.0 и v 1.1.
   - Включите TLSv 1.2.
   - Брандмауэр веб-приложения (режим предотвращения).
   - Режим предотвращения с набором правил OWASP 3,0.
   - Включите ведение журнала диагностики.
   - Настраиваемые пробы работоспособности.
   - Центр безопасности Azure и помощник по Azure обеспечивают дополнительную защиту и уведомления. Центр безопасности Azure также предоставляет систему репутации.
### <a name="logging-and-auditing"></a>Ведение журналов и аудит
Службы Azure обеспечивают детальную запись системных и пользовательских действий, а также сведений о работоспособности системы.
   - Журналы действий: [Журналы действий](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-overview-activity-logs) предоставляют информацию об операциях, которые выполнялись с ресурсами в подписке. Журналы действий помогают определить инициатора операции, время события и состояние.
   - Журналы диагностики: [Журналы диагностики](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs) включают в себя все журналы, создаваемые ресурсами. Эти журналы включают системные журналы событий Windows, журналы службы хранилища Azure, Key Vault журналы аудита, доступ к шлюзу приложений и журналы брандмауэра. Все журналы диагностики обеспечивают запись данных в централизованную и зашифрованную учетную запись Azure для архивирования. В соответствии с требованиями конкретной организации пользователь может настроить срок хранения до 730 дней.
### <a name="azure-monitor-logs"></a>Журналы Azure Monitor
   Эти журналы консолидируются в [журналы Azure Monitor](https://azure.microsoft.com/services/log-analytics/) для обработки, хранения и создания отчетов на панели мониторинга. Собранные данные объединяются в отдельные таблицы для каждого типа данных в рабочих областях Log Analytics, что позволяет анализировать все данные независимо от первичного источника. Кроме того, центр безопасности Azure интегрируется с журналами Azure Monitor, что позволяет клиентам использовать запросы Kusto для доступа к данным событий безопасности и объединения их с данными из других служб.

   В состав этой архитектуры входят следующие [решения мониторинга](https://docs.microsoft.com/azure/log-analytics/log-analytics-add-solutions) Azure.

   - [Оценка Active Directory](https://docs.microsoft.com/azure/log-analytics/log-analytics-ad-assessment). Решение "Проверка работоспособности Active Directory" регулярно оценивает риски и работоспособность серверных сред и предоставляет список рекомендаций, относящихся к развернутой серверной инфраструктуре, в порядке приоритета.
   - [Работоспособность агентов](https://docs.microsoft.com/azure/operations-management-suite/oms-solution-agenthealth). Решение Работоспособность агентов сообщает, сколько агентов развернуто и их географическое распределение, а также количество агентов, которые не отвечают, и количество агентов, которые отправляют операционные данные.
   - [Activity Log Analytics](https://docs.microsoft.com/azure/log-analytics/log-analytics-activity). Решение "Аналитика журнала действий" помогает анализировать журналы действий Azure во всех подписках Azure для клиента.
### <a name="azure-monitor"></a>Azure Monitor
   [Azure Monitor](https://docs.microsoft.com/azure/monitoring-and-diagnostics/)помогает пользователям отслеживать производительность, обеспечивать безопасность и выявление тенденций, позволяя организациям проводить аудит, создавать оповещения и архивировать данные, включая отслеживание вызовов API в своих ресурсах Azure.
### <a name="application-insights"></a>Application Insights 
   [Application Insights](https://docs.microsoft.com/azure/application-insights/app-insights-overview) — это расширяемая служба управления производительностью приложений для веб-разработчиков на нескольких платформах. Application Insights обнаруживает аномалии производительности и может использоваться клиентами для мониторинга динамического веб-приложения. Эта служба содержит мощные аналитические средства, которые помогают клиентам диагностировать проблемы и понять, что пользователи фактически делают в их приложении. Эта служба помогает клиентам постоянно улучшать производительность и удобство использования.

### <a name="azure-key-vault"></a>Хранилище Azure Key Vault
   Создайте хранилище для Организации, в котором должны храниться ключи, и обеспечьте ведение отчетности для рабочих задач, как показано ниже.

   - Данные, хранящиеся в Key Vault, включают   
   - ключ Application Insights;
   - Ключ доступа к хранилищу данных
   - Строка подключения
   - Имя таблицы данных
   - Учетные данные пользователя
   - Политики расширенного доступа настраиваются по мере необходимости.
   - Политики доступа Key Vault определяются с минимальными необходимыми разрешениями для ключей и секретов.
   - Все ключи и секреты в хранилище ключей имеют срок действия.
   - Все ключи в Key Vault защищены аппаратным модулем безопасности (HSM) [Key Type = аппаратный модуль безопасности (HSM) с защитой       
     2048-разрядный ключ RSA]
   - Всем пользователям и удостоверениям предоставляются минимальные необходимые разрешения с помощью управления доступом на основе ролей (RBAC).
   - Приложения используют общее хранилище ключей, только если у них настроено взаимное доверие и им нужен доступ к одним и тем же секретам во время выполнения.
   - Для журналов диагностики хранилища ключей включен срок хранения не менее 365 дней.
   - Допустимые операции шифрования для ключей доступны только тем пользователям, которым они нужны.

### <a name="vpn-and-expressroute"></a>VPN и ExpressRoute
   Защищенный туннель VPN или [ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-introduction) , который необходимо настроить, безопасно устанавливает подключение к ресурсам, развернутым в рамках этой эталонной архитектуры веб-приложения PaaS. Правильно настроив VPN-подключение или ExpressRoute, клиенты могут добавить уровень защиты передаваемых данных.

   При реализации защищенного VPN-туннеля с помощью Azure можно создать виртуальное частное подключение между локальной сетью и виртуальной сетью Azure. Это подключение выполняется через Интернет и позволяет клиентам безопасно подключать сведения о туннеле в зашифрованной связи между сетью клиента и Azure. VPN типа "сеть-сеть" — это безопасная проверенная технология, которая десятилетиями применяется на предприятиях всех размеров. Режим туннелирования IPsec используется в этом параметре в качестве механизма шифрования.

   Так как трафик в VPN-туннеле проходит через Интернет с VPN типа "сеть-сеть", Майкрософт предлагает другой, еще более защищенный вариант подключения. Azure ExpressRoute — это выделенный канал связи в глобальной сети между Azure и локальной средой или поставщиком услуг размещения Exchange. Подключения ExpressRoute не осуществляются через Интернет и обеспечивают повышенный уровень безопасности, надежности и скорости соединения с низким уровнем задержки по сравнению со стандартными подключениями через Интернет. Более того, так как это прямое подключение поставщика телекоммуникационных услуг клиента, данные не передаются через Интернет и поэтому недоступны в нем.

   См. [рекомендации](https://docs.microsoft.com/azure/architecture/reference-architectures/dmz/secure-vnet-hybrid) по реализации защищенной гибридной сети, расширяющей локальную сеть в Azure.

#### <a name="implement-azure-active-directory-oidc"></a>Реализация Azure Active Directory OIDC

1. Чтобы клонировать репозиторий исходного кода, используйте эту команду git.

 ``` git
 git clone https://github.com/Azure-Samples/AAD-Security
   ```
## <a name="update-the-redirect-urls"></a>Обновление URL-адресов перенаправления
1.  Вернитесь к портал Azure. В области навигации слева выберите Azure Active Directory служба, а затем выберите Регистрация приложений.
2.  В окне результатов выберите приложение WebApp-OpenIDConnect-DotNet-Code-v2.
3.  На вкладке Проверка подлинности o в разделе URI перенаправления выберите веб в поле со списком и добавьте следующие URI перенаправления.
    [https://WebApp-OpenIDConnect-DotNet-code-v2-contoso.azurewebsites.net](https://WebApp-OpenIDConnect-DotNet-code-v2-contoso.azurewebsites.net ) https://WebApp-OpenIDConnect-DotNet-code-v2-contoso.azurewebsites.net/signin-oidc o в разделе Дополнительные параметры задайте для параметра URL-адрес выхода значение https://WebApp-OpenIDConnect-DotNet-code-v2-contoso.azurewebsites.net/signout-oidc
4.  На вкладке фирменная символика измените URL-адрес домашней страницы на адрес службы приложений, https://WebApp-OpenIDConnect-DotNet-code-v2-contoso.azurewebsites.net например.
        o сохраните конфигурацию.
5.  Если приложение вызывает веб-API, обязательно примените необходимые изменения к проекту appSettings. JSON, чтобы он вызывал URL-адрес опубликованного API, а не localhost.
Публикация примера
    1.  На вкладке Обзор службы приложений Скачайте профиль публикации, щелкнув ссылку получить профиль публикации и сохранив его. Также можно использовать и другие механизмы развертывания, например из системы управления версиями.
    2.  Перейдите в Visual Studio и перейдите к проекту WebApp-OpenIDConnect-DotNet-Code-v2. Щелкните правой кнопкой мыши проект в обозреватель решений и выберите Опубликовать. Щелкните Импортировать профиль на нижней панели и импортируйте скачанный ранее профиль публикации.
    3.  Щелкните Настройка и на вкладке Подключение обновите URL-адрес назначения, чтобы он был HTTPS в URL-адресе домашней страницы, например https://WebApp-OpenIDConnect-DotNet-code-v2-contoso.azurewebsites.net. Нажмите кнопку Далее.
    4.  На вкладке Параметры убедитесь, что флажок Включить проверку подлинности организации не установлен. Щелкните Сохранить. На главном экране щелкните Опубликовать.
    5.  Visual Studio опубликует проект и автоматически откроет браузер по URL-адресу проекта. Если отображается веб-страница по умолчанию проекта, публикация прошла успешно.
#### <a name="implement-multi-factor-authentication-for-azure-active-directory"></a>Реализация многофакторной проверки подлинности для Azure Active Directory
   Администраторам необходимо обеспечить защиту учетных записей подписки на портале. Подписка уязвима для атак, так как она управляет созданными ресурсами. Чтобы защитить подписку, включите многофакторную проверку подлинности на вкладке **Azure Active Directory** подписки.

   Azure AD работает на основе политик, применяемых к пользователям или группам пользователей, которые соответствуют определенным критериям.
Azure создает политику по умолчанию, указывающую, что администраторам требуется двухфакторная проверка подлинности для входа на портал.
После включения этой политики вам может быть предложено выйти из портал Azure и снова войти в нее.

Включение MFA для входа администратора

   1. Перейдите на вкладку **Azure Active Directory** в портал Azure
   2. В категории Безопасность выберите условный доступ. Вы видите этот экран

       ![Условный доступ — политики](./media/secure-aad-app/ad-mfa-conditional-add.png)

Если не удается создать новую политику

   1. Перейдите на вкладку **MFA** .
   2. Выберите ссылку на **бесплатную пробную** версию Azure AD Premium, чтобы подписываться на бесплатную пробную версию.

   ![Бесплатная пробная версия Azure AD Premium](./media/secure-aad-app/ad-trial-premium.png)

Вернитесь к экрану условного доступа.

   1. Перейдите на вкладку Новая политика.
   2. Введите имя политики.
   3. Выберите пользователей или группы, для которых требуется включить MFA.
   4. В разделе **элементы управления доступом**перейдите на вкладку **предоставление** , а затем выберите **требовать многофакторную проверку подлинности** (и другие параметры при необходимости).

   ![Требовать многофакторную идентификацию](./media/secure-aad-app/ad-mfa-conditional-add.png)

   Политику можно включить, установив флажок в верхней части экрана, или сделать это на вкладке **Условный доступ** . Если политика включена, пользователям требуется MFA для входа на портал.

   Существует базовая политика, которая требует MFA для всех администраторов Azure. Вы можете немедленно включить его на портале. Включение этой политики может сделать недействительным текущий сеанс и принудительно выполнить вход.

   Если базовая политика не включена
   1.   Выберите параметр **требовать MFA для администраторов**.
   2.   Выберите **параметр использовать политику немедленно**.

   ![Выберите параметр использовать политику немедленно.](./media/secure-aad-app/ad-mfa-conditional-enable.png)

#### <a name="use-azure-sentinel-to-monitor-apps-and-resources"></a>Использование Sentinel Azure для мониторинга приложений и ресурсов

   По мере роста приложения становится трудно объединить все сигналы и метрики безопасности, полученные от ресурсов, и сделать их полезными в действии, ориентированном на действия.

   Azure Sentinel предназначен для получения данных, выявления возможных типов угроз и предоставления сведений об инцидентах безопасности.
Хотя он ожидает вмешательства вручную, Azure Sentinel может полагаться на предварительно написанный модули PlayBook, чтобы запускать оповещения и процессы управления инцидентами.

   Пример приложения состоит из нескольких ресурсов, которые может отслеживать метка Azure Sentinel.
Чтобы настроить метку Azure, сначала необходимо создать рабочую область Log Analytics, в которой будут храниться все данные, собранные из различных ресурсов.

Создание рабочей области

   1. В поле поиска в портал Azure найдите **log Analytics**. Выберите **Рабочие области Log Analytics**.

   ![Поиск рабочих областей Log Analytics](./media/secure-aad-app/sentinel-log-analytics.png)

   *Поиск рабочих областей Log Analytics*

   2. На следующей странице выберите **Добавить** , а затем укажите имя, группу ресурсов и расположение для рабочей области.
   ![Создание рабочей области Log Analytics с помощью PowerShell](./media/secure-aad-app/sentinel-log-analytics-create.png)

   *Создание рабочей области Log Analytics с помощью PowerShell*

   3. Используйте поле поиска, чтобы найти **метку Azure**.

   ![Поиск Sentinel Azure](./media/secure-aad-app/sentinel-add.png)

   *Поиск Sentinel Azure*

   4. Выберите **Добавить** , а затем выберите созданную ранее рабочую область log Analytics.

   ![Добавление рабочей области Log Analytics](./media/secure-aad-app/sentinel-workspace-add.png)

   *Добавление рабочей области Log Analytics*

   5. На странице **Azure Sentinel — соединители данных** в разделе **Конфигурация**выберите пункт **соединители данных**. Вы увидите массив служб Azure, который можно связать с экземпляром хранилища Log Analytics для анализа в Azure Sentinel.

   ![Log Analytics соединителей данных](./media/secure-aad-app/sentinel-connectors.png)

      *Добавление соединителя данных в Azure Sentinel*

   Например, чтобы подключить шлюз приложений, сделайте следующее:

   1. Откройте колонку экземпляр шлюза приложений Azure.
   2. В разделе **Мониторинг** выберите **Параметры диагностики**.
   3. Выберите **Добавить параметр диагностики**.

   ![Добавление диагностики шлюза приложений](./media/secure-aad-app/sentinel-gateway-connector.png)
         
   *Добавление диагностики шлюза приложений*

   4. На странице **параметры диагностики** выберите созданную рабочую область log Analytics, а затем выберите все метрики, которые требуется получить и отправить в Azure Sentinel. Щелкните **Сохранить**.

   ![Параметры соединителя Azure Sentinel](./media/secure-aad-app/sentinel-connector-settings.png)



## <a name="cost-considerations"></a>Рекомендации по стоимости
   Если у вас еще нет учетной записи Azure, вы можете создать ее бесплатно. Перейдите на [страницу бесплатной учетной записи](https://azure.microsoft.com/free/) , чтобы начать работу, Узнайте, что можно делать с бесплатной учетной записью Azure, и Узнайте, какие продукты доступны в течение 12 месяцев.

   Чтобы развернуть ресурсы в примере приложения с помощью функций безопасности, необходимо заплатить за некоторые функции уровня "Премиум". По мере того как приложение масштабируется, а бесплатные уровни и пробные версии, предлагаемые Azure, должны быть обновлены в соответствии с требованиями приложения, ваши затраты могут увеличиться. Используйте [Калькулятор цен](https://azure.microsoft.com/pricing/calculator/) Azure для оценки затрат.

## <a name="next-steps"></a>Следующие шаги
   Следующие статьи помогут в проектировании, разработке и развертывании безопасных приложений.

- [Design](secure-design.md) (Конструктор)
- [Разработка](secure-develop.md)
- [Развертывание](secure-deploy.md)
