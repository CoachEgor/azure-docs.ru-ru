---
title: Запретить поддомену такеоверс с записями псевдонимов Azure DNS и проверкой пользовательского домена службы приложений Azure
description: Узнайте, как избежать распространенных угроз с высокой серьезностью поддоменных перенаправление
services: security
author: memildin
manager: rkarlin
ms.assetid: ''
ms.service: security
ms.subservice: security-fundamentals
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 06/23/2020
ms.author: memildin
ms.openlocfilehash: 2baf2b209cae11f734494c377aebd731f69f514d
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85610869"
---
# <a name="prevent-dangling-dns-entries-and-avoid-subdomain-takeover"></a>Предотвращение висячих записей DNS и избежание поддоменного перенаправление

В этой статье описывается распространенная угроза безопасности поддоменных перенаправление и действия, которые можно предпринять для устранения проблемы.


## <a name="what-is-subdomain-takeover"></a>Что такое поддомены перенаправление?

Такеоверс поддоменов — это распространенная угроза высокой серьезности для организаций, которые регулярно создают и удаляют множество ресурсов. Дочерний домен перенаправление может возникать, если имеется запись DNS, указывающая на отозванный ресурс Azure. Такие записи DNS также называются "висячими DNS" записями. Записи CNAME особенно уязвимы для этой угрозы.

Распространенный сценарий для поддомена перенаправление:

1. Создается веб-сайт. 

    В этом примере — `app-contogreat-dev-001.azurewebsites.net`.

1. Запись CNAME добавляется в DNS, указывающую на веб-сайт. 

    В этом примере было создано следующее понятное имя: `greatapp.contoso.com` .

1. Через несколько месяцев сайт больше не нужен, поэтому он удаляется **без** удаления соответствующей записи DNS. 

    DNS-запись CNAME теперь называется "висячим".

1. Практически сразу после удаления сайта субъект угрозы обнаруживает отсутствующий сайт и создает свой собственный веб-сайт по адресу `app-contogreat-dev-001.azurewebsites.net` .

    Теперь трафик, предназначенный для, `greatapp.contoso.com` передается на сайт Azure субъекта угрозы, и субъект угрозы контролирует отображаемое содержимое. 

    Использование висячего DNS было злоумышленником, а поддомен Contoso "Греатапп" был жертвой поддомена перенаправление. 

![Дочерний домен перенаправление от отозванного веб-сайта](./media/subdomain-takeover/subdomain-takeover.png)



## <a name="the-risks-of-subdomain-takeover"></a>Риски поддомена перенаправление

Если запись DNS указывает на недоступный ресурс, сама запись должна быть удалена из зоны DNS. Если он не был удален, это запись «висячий DNS» и создает возможность для поддомена перенаправление.

Висячие записи DNS позволяют субъектам-угрозам управлять связанным DNS-именем для размещения вредоносного веб-сайта или службы. Вредоносные страницы и службы в поддомене организации могут привести к следующим результатам:

- **Утрата контроля за содержимым поддоменом** — отрицательное воздействие Организации на невозможность защитить ее содержимое, а также ущерб торговой марки и потери доверия.

- Файл cookie, который получается **от неподозрительных посетителей** . обычно веб-приложениям предоставляется доступ к файлам cookie сеанса в поддоменах (*. contoso.com), поэтому к ним могут обращаться все поддомены. Актеры угроз могут использовать поддомен перенаправление для создания подлинной страницы, обманным путем, чтобы пользователи могли посетить эту страницу и собирать свои файлы cookie (даже безопасные файлы cookie). Распространенное заблуждение заключается в том, что использование SSL-сертификатов защищает сайт и файлы cookie пользователей от перенаправление. Однако субъект угрозы может использовать захваченный поддомен для применения и получения действительного SSL-сертификата. После этого они получают доступ к защищенным файлам cookie и могут еще больше повысить восприятный закон от вредоносного веб-узла.

- **Фишинговые кампании** . подлинные поддомены можно использовать в кампаниях с фишингом. Это справедливо для вредоносных веб-узлов, а также для записей MX, которые позволяют субъекту угрозы получать сообщения электронной почты, адресованные законному поддомену известной торговой марки.

- **Дополнительные риски** — вредоносные веб-сайты можно использовать для эскалации на другие классические атаки, такие как XSS, CSRF, CORS и т. д.



## <a name="preventing-dangling-dns-entries"></a>Предотвращение висячих записей DNS

Обеспечение того, что в организации реализованы процессы для предотвращения висячих DNS-записей, а результирующий такеоверс поддомена является важной частью программы безопасности.

Доступные сегодня меры по превентивной работе перечислены ниже.


### <a name="use-azure-dns-alias-records"></a>Использование записей псевдонимов Azure DNS

При тесном связывании жизненного цикла записи DNS с ресурсом Azure [записи псевдонимов](https://docs.microsoft.com/azure/dns/dns-alias#scenarios) Azure DNS могут препятствовать висячим ссылкам. Например, рассмотрим запись DNS, которая является псевдонимом и указывает на общедоступный IP-адрес или профиль диспетчера трафика. Если удалить эти базовые ресурсы, запись псевдонима DNS станет пустым набором записей. Он больше не ссылается на удаленный ресурс. Важно отметить, что существует ряд ограничений, которые можно защищать с помощью записей псевдонимов. Сейчас список ограничен:

- Azure Front Door
- Профили диспетчера трафика
- Конечные точки сети доставки содержимого Azure (CDN)
- Общедоступные IP-адреса.

Если у вас есть ресурсы, которые можно защитить от поддоменных перенаправление с записями псевдонимов, мы рекомендуем сделать это, несмотря на ограниченные предложения на услуги.

Дополнительные [сведения](https://docs.microsoft.com/azure/dns/dns-alias#capabilities) о возможностях записей псевдонимов Azure DNS.



### <a name="use-azure-app-services-custom-domain-verification"></a>Использовать проверку пользовательского домена службы приложений Azure

При создании записей DNS для службы приложений Azure создайте АСУиД. поддомен Запись типа TXT с ИДЕНТИФИКАТОРом проверки домена. Если такая запись типа TXT существует, никакая другая подписка Azure не может проверить личный домен, который перестоит. 

Эти записи не запрещают пользователям создавать службу приложений Azure с тем же именем, что и запись CNAME. Без возможности доказательства владельца имени домена субъекты угроз не могут получить трафик или управлять содержимым.

Дополнительные [сведения](https://docs.microsoft.com/Azure/app-service/app-service-web-tutorial-custom-domain) о сопоставлении существующего НАСТРАИВАЕМОГО DNS-имени с службой приложений Azure.



### <a name="build-and-automate-processes-to-mitigate-the-threat"></a>Создание и автоматизация процессов для устранения угрозы

Часто разработчики и группы операций могут запускать процессы очистки, чтобы избежать висячих угроз DNS. Приведенные ниже рекомендации помогут вашей организации избежать низкий от этой угрозы. 

- **Создание процедур для предотвращения:**

    - Обучить разработчикам приложений возможность перенаправлять адреса при удалении ресурсов.

    - Вставьте "удалить запись DNS" в списке обязательных проверок при списании службы.

    - Разместите [блокировки удаления](https://docs.microsoft.com/azure/azure-resource-manager/management/lock-resources) для всех ресурсов, имеющих пользовательскую запись DNS. Блокировка удаления служит индикатором того, что сопоставление должно быть удалено до отмены наполнения ресурса. Такие меры могут работать только вместе с внутренними программами для образования.

- **Создание процедур для обнаружения:**

    - Регулярно просматривайте свои записи DNS, чтобы убедиться, что поддомены сопоставлены с ресурсами Azure, которые:

        - **Существует** . запросите зоны DNS для ресурсов, указывающих на поддомены Azure, такие как *. azurewebsites.NET или *. cloudapp.Azure.com (см. [этот список ссылок](azure-domains.md)).
        - **Вы сами** подтверждаете, что являетесь владельцем всех ресурсов, на которые нацелены поддомены DNS.

    - Настройте каталог услуг конечных точек полного доменного имени (FQDN) Azure и владельцев приложений. Чтобы создать каталог услуг, выполните следующий запрос графа ресурсов Azure с параметрами из следующей таблицы:
    
        >[!IMPORTANT]
        > **Разрешения** . Запустите запрос от имени пользователя с доступом ко всем подпискам Azure. 
        >
        > **Ограничения** . в графе ресурсов Azure есть ограничения на регулирование и разбиение на страницы, которые следует учитывать при наличии крупной среды Azure. Дополнительные [сведения](https://docs.microsoft.com/azure/governance/resource-graph/concepts/work-with-data) о работе с большими наборами данных ресурсов Azure.  

        ```
        Search-AzGraph -Query "resources | where type == '[ResourceType]' | project tenantId, subscriptionId, type, resourceGroup, name, endpoint = [FQDNproperty]"
        ``` 
        
        Например, этот запрос возвращает ресурсы из службы приложений Azure:

        ```
        Search-AzGraph -Query "resources | where type == 'microsoft.web/sites' | project tenantId, subscriptionId, type, resourceGroup, name, endpoint = properties.defaultHostName"
        ```
        
        Можно также сочетать несколько типов ресурсов. Этот пример запроса возвращает ресурсы из службы приложений Azure **и** слотов службы приложений Azure:

        ```
        Search-AzGraph -Query "resources | where type in ('microsoft.web/sites', 'microsoft.web/sites/slots') | project tenantId, subscriptionId, type, resourceGroup, name, endpoint = properties.defaultHostName"
        ```

        |Имя ресурса  |[тип_ресурса]  | [Фкднпроперти]  |
        |---------|---------|---------|
        |Azure Front Door|microsoft.network/frontdoors|Properties. cName|
        |хранилище BLOB-объектов Azure|microsoft.storage/storageaccounts|Properties. первичных. BLOB|
        |Azure CDN|microsoft.cdn/profiles/endpoints|Свойства. имя узла|
        |Общедоступные IP-адреса|microsoft.network/publicipaddresses|Properties. dnsSettings. FQDN|
        |Azure Traffic Manager|microsoft.network/trafficmanagerprofiles|Properties. dnsConfig. FQDN|
        |Экземпляр контейнера Azure|microsoft.containerinstance/containergroups|Properties. ipAddress. FQDN|
        |Cлужба управления Azure API|microsoft.apimanagement/service|Properties. Хостнамеконфигуратионс. имя_узла|
        |Служба приложений Azure|microsoft.web/sites|Properties. параметром DefaultHostName|
        |Служба приложений Azure — слоты|microsoft.web/sites/slots|Properties. параметром DefaultHostName|


- **Создание процедур для исправления:**
    - При обнаружении висячих DNS-записей команде необходимо выяснить, не произошло ли нарушение безопасности.
    - Выясните, почему адрес не был перенаправлен при списании ресурса.
    - Удалите запись DNS, если она больше не используется, или укажите правильный ресурс Azure (FQDN), принадлежащий вашей организации.
 

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения о связанных службах и функциях Azure, которые можно использовать для защиты от перенаправление поддоменов, см. на следующих страницах.

- [Azure DNS поддерживает использование записей псевдонимов для пользовательских доменов](https://docs.microsoft.com/azure/dns/dns-alias#prevent-dangling-dns-records)

- [Использовать идентификатор проверки домена при добавлении пользовательских доменов в службе приложений Azure](https://docs.microsoft.com/azure/app-service/app-service-web-tutorial-custom-domain#get-domain-verification-id) 

-    [Краткое руководство. Выполните первый запрос графика ресурсов с помощью Azure PowerShell](https://docs.microsoft.com/azure/governance/resource-graph/first-query-powershell)