---
title: Брандмауэр Web Application Firewall (WAF) v2 пользовательские правила на шлюзе приложения
description: В этой статье приводится обзор пользовательских правил Web Application Firewall (WAF) v2 на шлюзе приложений Azure.
services: web-application-firewall
ms.topic: article
author: vhorne
ms.service: web-application-firewall
ms.date: 01/30/2020
ms.author: victorh
ms.openlocfilehash: 072c7bd5b5b292ca4f0e53c59fcb7e9771331a94
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77031737"
---
# <a name="custom-rules-for-web-application-firewall-v2-on-azure-application-gateway"></a>Пользовательские правила для веб-приложений Firewall v2 на портале приложений Azure

Брандмауэр Web Application Firewall Azure Application Gateway (WAF) поставляется с предварительно настроенным, управляемым платформой набором правил, который обеспечивает защиту от различных типов атак. Эти атаки включают в себя перекрестные сценарии сайта, инъекции S'L и другие. Если вы являетесь админ-амином WAF, вы можете написать свои собственные правила, чтобы увеличить установленные правила основного правила (CRS). Ваши правила могут либо блокировать, либо разрешать запрашиваемый трафик на основе соответствующих критериев.

Пользовательские правила позволяют создавать свои собственные правила, которые оцениваются для каждого запроса, который проходит через WAF. Эти правила имеют более высокий приоритет, чем любые правила из управляемых наборов правил. Пользовательские правила содержат имя правила, приоритет правила и массив соответствующих условий. Если эти условия выполнены, принимается действие (разрешить или заблокировать).

Например, можно заблокировать все запросы с IP-адреса в диапазоне 192.168.5.4/24. В этом правиле оператором является *IPMatch,* matchValues является диапазоном IP-адресов (192.168.5.4/24), и действие заключается в блокировании трафика. Вы также устанавливаете имя и приоритет правила.

Пользовательские правила поддерживают использование логики соединения для более продвинутых правил, которые удовлетворяют ваши потребности в безопасности. Например, (Условие 1 **и** Состояние 2) **или** Состояние 3). Это означает, что если условие 1 **и** Условие 2 выполнены, **или** если Условие 3 выполнено, WAF должен принять действие, указанное в пользовательском правиле.

Различные условия сопоставления в рамках одного и того же правила всегда усугубляются использованием **и**. Например, блокировать трафик с определенного IP-адреса, и только если они используют определенный браузер.

Если вы хотите **или** два различных условиях, два условия должны быть в разных правилах. Например, блокировать трафик с определенного IP-адреса или блокировать трафик, если они используют определенный браузер.

> [!NOTE]
> Максимальное количество пользовательских правил WAF составляет 100. Для получения дополнительной информации об [Azure subscription and service limits, quotas, and constraints](../../azure-resource-manager/management/azure-subscription-service-limits.md#application-gateway-limits)ограничениях шлюза приложений см.

Регулярные выражения также поддерживаются в пользовательских правилах, как и в правилах CRS. Например, см. Примеры 3 и 5 в [создании и использовании пользовательских правил брандмауэра веб-приложений.](create-custom-waf-rules.md)

## <a name="allowing-vs-blocking"></a>Разрешение против блокировки

Разрешение и блокирование трафика просто с пользовательскими правилами. Например, можно заблокировать весь трафик, поступающий с различных IP-адресов. Вы можете сделать другое правило, чтобы разрешить трафик, если запрос исходит от конкретного браузера.

Чтобы что-то разрешить, убедитесь, что `-Action` параметр установлен, чтобы **разрешить.** Чтобы что-то заблокировать, убедитесь, что `-Action` параметр настроен на **блокировку.**

```azurepowershell
$AllowRule = New-AzApplicationGatewayFirewallCustomRule `
   -Name example1 `
   -Priority 2 `
   -RuleType MatchRule `
   -MatchCondition $condition `
   -Action Allow

$BlockRule = New-AzApplicationGatewayFirewallCustomRule `
   -Name example2 `
   -Priority 2 `
   -RuleType MatchRule `
   -MatchCondition $condition `
   -Action Block
```

Предыдущие `$BlockRule` карты к следующему пользовательскому правилу в менеджере ресурсов Azure:

```json
"customRules": [
      {
        "name": "blockEvilBot",
        "priority": 2,
        "ruleType": "MatchRule",
        "action": "Block",
        "matchConditions": [
          {
            "matchVariables": [
              {
                "variableName": "RequestHeaders",
                "selector": "User-Agent"
              }
            ],
            "operator": "Contains",
            "negationConditon": false,
            "matchValues": [
              "evilbot"
            ],
            "transforms": [
              "Lowercase"
            ]
          }
        ]
      }
    ], 
```

Это пользовательское правило содержит имя, приоритет, действие и массив соответствующих условий, которые должны быть выполнены для выполнения действия. Для дальнейшего объяснения этих полей см. Например, пользовательские правила, [см. Создать и использовать пользовательские правила брандмауэра веб-приложений.](create-custom-waf-rules.md)

## <a name="fields-for-custom-rules"></a>Поля для пользовательских правил

### <a name="name-optional"></a>Имя (необязательно)

Имя правила.  Он отображается в журналах.

### <a name="priority-required"></a>Приоритет (обязательно)

- Определяет порядок оценки правил. Чем ниже значение, тем раньше оценка правила. Допустимый диапазон от 1-100. 
- Должен быть уникальным во всех пользовательских правил. Правило с приоритетом 40 оценивается перед правилом с приоритетом 80.

### <a name="rule-type-required"></a>Тип правила (требуется)

В настоящее время, должны быть **MatchRule**.

### <a name="match-variable-required"></a>Переменная соответствия (обязательно)

Должна быть одна из переменных:

- RemoteAddr - IP-адрес/хостимя удаленного компьютерного соединения
- RequestMethod - метод запроса HTTP (GET, POST, PUT, DELETE и так далее.)
- QueryString - Переменный в URI
- PostArgs - Аргументы, отправленные в органе POST. Пользовательские правила, использующие эту переменную матча, применяются только в том случае, если заголовок 'Content-Type' установлен на 'application/x-www-form-urlencoded' и 'multipart/form-data'.
- Запрос - URI запроса
- Запросзаголовки - Заголовки запроса
- RequestBody - Это содержит весь орган запроса в целом. Пользовательские правила, использующие эту переменную матча, применяются только в том случае, если заголовок 'Content-Type' установлен на 'application/x-www-form-urlencoded'. 
- RequestCookies - Cookies запроса

### <a name="selector-optional"></a>Селектор (необязательно)

Описывает поле матчаПеременная коллекция. Например, если matchVariable является RequestHeaders, селектор может быть на заголовке *Пользователя-Агента.*

### <a name="operator-required"></a>Оператор (обязательно)

Должен быть одним из следующих операторов:

- IPMatch - используется только тогда, когда переменный матч является *RemoteAddr*
- Равные - вход такой же, как MatchValue
- Содержит
- LessThan;
- GreaterThan
- LessThanOrEqual;
- GreaterThanOrEqual;
- BeginsWith
- EndsWith
- Регулярное выражение
- Геоматч (предварительный просмотр)

### <a name="negate-condition-optional"></a>Условие «Негат» (необязательно)

Отменяет текущее состояние.

### <a name="transform-optional"></a>Преобразование (необязательно)

Список строк с именами преобразований, которые необходимо сделать перед началом матча. Это могут быть следующие преобразования:

- Нижний регистр
- Trim
- UrlDecode
- UrlEncode 
- УдалитьНуллы
- HtmlEntityDecode

### <a name="match-values-required"></a>Значения соответствия (обязательно)

Список значений, чтобы соответствовать, которые можно рассматривать как *ИЛИ*'ed. Например, это могут быть IP-адреса или другие строки. Формат значения зависит от предыдущего оператора.

### <a name="action-required"></a>Действия (обязательно)

- Разрешить - Разрешает транзакцию, пропуская все другие правила. Указанный запрос добавляется в список разрешений и после сопоставления запрос прекращает дальнейшую оценку и отправляется в пул бэкэнда. Правила, которые находятся в списке разрешений, не оцениваются для каких-либо дальнейших пользовательских правил или управляемых правил.
- Блок - Блокирует транзакцию на основе *SecDefaultAction* (режим обнаружения/предотвращения). Так же, как действие Allow, после оценки запроса и добавления в список блоков оценка прекращается и запрос блокируется. Любой запрос после этого соответствует тем же условиям, не будет оценен и просто заблокирован. 
- Войти - Позволяет правило писать в журнал, но позволяет остальным правилам работать для оценки. Другие пользовательские правила оцениваются в порядке приоритета, а затем управляемые правила.

## <a name="geomatch-custom-rules-preview"></a>Пользовательские правила Geomatch (предварительный просмотр)

Пользовательские правила позволяют создавать индивидуальные правила в соответствии с точными потребностями приложений и политики безопасности. Вы можете ограничить доступ к веб-приложениям по странам/регионам. Для получения дополнительной информации [см.](geomatch-custom-rules.md)

## <a name="next-steps"></a>Дальнейшие действия

После того как вы узнаете об пользовательских правилах, [создайте свои собственные пользовательские правила.](create-custom-waf-rules.md)
