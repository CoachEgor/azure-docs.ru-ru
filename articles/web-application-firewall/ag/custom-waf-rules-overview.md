---
title: Настраиваемые правила брандмауэра веб-приложения Azure (WAF) v2 в шлюзе приложений
description: В этой статье представлен обзор настраиваемых правил брандмауэра веб-приложения (WAF) v2 в шлюзе приложений Azure.
services: web-application-firewall
ms.topic: article
author: vhorne
ms.service: web-application-firewall
ms.date: 10/04/2019
ms.author: victorh
ms.openlocfilehash: 844e24466e9a9b46be3212690767a408e75f234d
ms.sourcegitcommit: c22327552d62f88aeaa321189f9b9a631525027c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2019
ms.locfileid: "73516621"
---
# <a name="custom-rules-for-web-application-firewall-v2-on-azure-application-gateway"></a>Настраиваемые правила для брандмауэра веб-приложения версии 2 в шлюзе приложений Azure

Брандмауэр веб-приложения шлюза приложений Azure (WAF) версии 2 поставляется с предварительно настроенным, управляемым платформой набором правил, который обеспечивает защиту от различных типов атак. Эти атаки включают межсайтовые сценарии, внедрение кода SQL и другие. Если вы являетесь администратором WAF, вам может потребоваться написать собственные правила, чтобы расширить правила набора правил (CR). Правила могут блокировать или разрешать запрошенный трафик на основе критериев сопоставления.

Настраиваемые правила позволяют создавать собственные правила, которые оцениваются для каждого запроса, который проходит через WAF. Эти правила содержат более высокий приоритет, чем остальные правила в наборах управляемых правил. Пользовательские правила содержат имя правила, приоритет правила и массив условий сопоставления. Если эти условия выполнены, предпринимается действие (для разрешения или блокировки).

Например, можно заблокировать все запросы с IP-адреса в диапазоне 192.168.5.4/24. В этом правиле оператором является *ипматч*, матчвалуес — диапазон IP-адресов (192.168.5.4/24), а действие — блокировать трафик. Вы также задаете имя и приоритет правила.

Настраиваемые правила поддерживают использование логики объединения для создания более сложных правил, которые удовлетворяют требованиям безопасности. Например, (условие 1 **и** условие 2) **или** условие 3).  Этот пример означает, что если условие 1 **и** условие 2 выполнены **или** условие 3 выполняется, WAF должен принять действие, указанное в настраиваемом правиле.

Разные условия сопоставления в рамках одного правила всегда составны с помощью **и**. Например, можно заблокировать трафик с определенного IP-адреса и только в том случае, если они используют определенный браузер.

Если требуется **или** два условия, два условия должны быть в разных правилах. Например, можно блокировать трафик с определенного IP-адреса или блокировать трафик, если они используют конкретный браузер.

> [!NOTE]
> Максимальное число настраиваемых правил WAF — 100. Дополнительные сведения об ограничениях шлюза приложений см. в статье [Подписка Azure, границы, квоты и ограничения службы](../../azure-subscription-service-limits.md#application-gateway-limits).

Регулярные выражения также поддерживаются в пользовательских правилах, как и в наборах правил CR. Примеры см. в примерах 3 и 5 в статье [Создание и использование настраиваемых правил брандмауэра веб-приложения](create-custom-waf-rules.md).

## <a name="allowing-vs-blocking"></a>Разрешение и блокировка

Разрешить и заблокировать трафик просто с помощью настраиваемых правил. Например, можно заблокировать весь трафик, поступающий из диапазона IP-адресов. Можно сделать еще одно правило, разрешающее трафик, если запрос поступает из конкретного браузера.

Чтобы разрешить что-либо, убедитесь, что параметр `-Action` имеет значение **allow**. Чтобы заблокировать что-либо, убедитесь, что параметр `-Action` имеет значение **Block**.

```azurepowershell
$AllowRule = New-AzApplicationGatewayFirewallCustomRule `
   -Name example1 `
   -Priority 2 `
   -RuleType MatchRule `
   -MatchCondition $condition `
   -Action Allow

$BlockRule = New-AzApplicationGatewayFirewallCustomRule `
   -Name example2 `
   -Priority 2 `
   -RuleType MatchRule `
   -MatchCondition $condition `
   -Action Block
```

Предыдущая `$BlockRule` сопоставляется со следующим настраиваемым правилом в Azure Resource Manager:

```json
"customRules": [
      {
        "name": "blockEvilBot",
        "priority": 2,
        "ruleType": "MatchRule",
        "action": "Block",
        "matchConditions": [
          {
            "matchVariables": [
              {
                "variableName": "RequestHeaders",
                "selector": "User-Agent"
              }
            ],
            "operator": "Contains",
            "negationConditon": false,
            "matchValues": [
              "evilbot"
            ],
            "transforms": [
              "Lowercase"
            ]
          }
        ]
      }
    ], 
```

Это пользовательское правило содержит имя, приоритет, действие и массив условий соответствия, которые должны быть выполнены для выполнения действия. Более подробное описание этих полей см. в следующих описаниях полей. Примеры пользовательских правил см. в разделе [Создание и использование пользовательских правил брандмауэра веб-приложения](create-custom-waf-rules.md).

## <a name="fields-for-custom-rules"></a>Поля для настраиваемых правил

### <a name="name-optional"></a>Имя [необязательно]

Это имя правила. Это имя появится в журналах.

### <a name="priority-required"></a>Priority [обязательный]

- Определяет порядок оценки правила. Чем ниже значение, тем выше оценка правила. Допустимый диапазон — от 1-100. 
- Должно быть уникальным для всех настраиваемых правил. Правило с приоритетом 40 оценивается перед правилом с приоритетом 80.

### <a name="rule-type-required"></a>Тип правила [обязательный]

В настоящее время должен быть **матчруле**.

### <a name="match-variable-required"></a>Match, переменная [обязательный]

Должна быть одной из переменных:

- Ремотеаддр — IP-адрес или имя узла для подключения к удаленному компьютеру
- Рекуестмесод — метод запроса HTTP (GET, POST, WHERE, DELETE и т. д.).
- QueryString — переменная в URI
- I args — аргументы, отправляемые в теле сообщения POST. Пользовательские правила, использующие эту переменную соответствия, применяются только в том случае, если для заголовка Content-Type задано значение Application/x-www-Form-UrlEncoded ' и ' multipart/form-data '.
- RequestUri — URI запроса.
- RequestHeaders — заголовки запроса
- RequestBody — содержит весь текст запроса целиком. Пользовательские правила, использующие эту переменную соответствия, применяются только в том случае, если для заголовка Content-Type задано значение Application/x-www-Form-UrlEncoded. 
- Рекуесткукиес — файлы Cookie запроса;

### <a name="selector-optional"></a>Selector [необязательно]

Описывает поле коллекции Матчвариабле. Например, если Матчвариабле имеет значение RequestHeaders, то селектор может находиться в заголовке *User-Agent* .

### <a name="operator-required"></a>Operator [обязательный]

Должен быть одним из следующих операторов:

- Ипматч используется только в том случае, если переменная match имеет *ремотеаддр*
- Equals — входные данные совпадают с Матчвалуе
- Содержит
- LessThan;
- GreaterThan
- LessThanOrEqual;
- GreaterThanOrEqual;
- Начинается с
- EndsWith
- Регулярное выражение
- Геосоответствие (Предварительная версия)

### <a name="negate-condition-optional"></a>Условие отрицания [необязательно]

Инвертирует текущее условие.

### <a name="transform-optional"></a>Преобразование [необязательно]

Список строк с именами преобразований, которые необходимо выполнить до попытки сопоставления. Это могут быть следующие преобразования:

- Нижний регистр
- Trim
- урлдекоде
- UrlEncode 
- ремовенуллс
- хтмлентитидекоде

### <a name="match-values-required"></a>Совпадение значений [обязательный]

Список значений для сопоставления, которые можно рассматривать как " *или*" ED. Например, это могут быть IP-адреса или другие строки. Формат значения зависит от оператора Previous.

### <a name="action-required"></a>Действие [обязательный]

- Разрешить — разрешает транзакцию, пропуская все последующие правила. Это означает, что указанный запрос добавляется в список разрешений и после сопоставления запрос прекращает дальнейшую оценку и отправляется во внутренний пул. Правила, которые находятся в списке разрешений, не оцениваются для дополнительных настраиваемых правил или управляемых правил.
- Block — блокирует транзакцию на основе *секдефаултактион* (режим обнаружения и предотвращения). Как и действие Allow, после вычисления запроса и добавления в список блокировок вычисление останавливается и запрос блокируется. Любой запрос, удовлетворяющий тем же условиям, не будет оцениваться и будет просто заблокирован. 
- Log — позволяет правилу записывать в журнал, но позволяет выполнять остальные правила для оценки. Последующие пользовательские правила оцениваются в порядке приоритета, за которыми следуют управляемые правила.

## <a name="geomatch-custom-rules-preview"></a>Настраиваемые правила геосоответствия (Предварительная версия)

Если вы используете оператор геосоответствия, селекторы могут быть любым из следующих двух цифр: кодов стран. 

|Код страны | Название страны |
| ----- | ----- |
| AD | Андорра |
| AE | Объединенные Арабские Эмираты|
| AF | Афганистан|
| AG | Антигуа и Барбуда|
| AL | Албания|
| AM | Армения|
| АО | Ангола|
| AR | Аргентина|
| AS | Американское Самоа|
| AT | Австрия|
| AU | Австралия|
| AZ | Азербайджан|
| BA | Босния и Герцеговина|
| BB | Барбадос|
| BD | Бангладеш|
| BE | Бельгия|
| BF | Буркина-Фасо|
| BG | Болгария|
| BH | Бахрейн|
| BI | Бурунди|
| BJ | Бенин|
| BL | Сен-Бартельми|
| BN | Бруней-Даруссалам|
| BO | Боливия|
| BR | Бразилия|
| BS | Багамские о-ва|
| BT | Бутан|
| BW | Ботсвана|
| BY | Беларусь|
| BZ | Белиз|
| CA | Канада|
| CD | Демократическая Республика Конго|
| CF | Центрально-Африканская Республика|
| CH | Швейцария|
| CI | Кот-д'Ивуар|
| CL | Чили|
| CM | Камерун|
| CN | Китай|
| CO | Колумбия|
| CR | Коста-Рика|
| CU | Куба|
| CV | Кабо-Верде|
| CY | Кипр|
| CZ | Чешская Республика|
| DE | Германия|
| DK | Дания|
| DO | Доминиканская Республика|
| DZ | Алжир|
| EC | Эквадор|
| EE | Эстония|
| EG | Египет|
| ES | Испания|
| ET | Эфиопия|
| FI | Финляндия|
| FJ | Фиджи|
| FM | Микронезия, Федеративные Штаты|
| СВ | Франция|
| GB | Великобритания|
| GE | Джорджия|
| GF | Французская Гвиана|
| GH | Гана|
| GN | Гвинея|
| GP | Гваделупа|
| GR | Греция|
| GT | Гватемала|
| GY | Гайана|
| HK | Гонконг, САР|
| HN | Гондурас|
| HR | Хорватия|
| HT | Гаити|
| HU | Венгрия|
| ИД | Индонезия|
| IE | Ирландия|
| IL | Израиль|
| IN | Индия|
| IQ | Ирак|
| IR | Иран, Исламская Республика|
| IS | Исландия|
| IT | Италия|
| JM | Ямайка|
| JO | Иордания|
| JP | Япония|
| KE | Кения|
| KG | Киргизия|
| KH | Камбоджа|
| KI | Кирибати|
| KN | Сент-Китс и Невис|
| KP | Корея, Народно-Демократическая Республика|
| KR | Республика Корея|
| KW | Кувейт|
| KY | Каймановы о-ва|
| KZ | Казахстан|
| LA | Лаосская Народно-Демократическая Республика|
| LB | Ливан|
| LI | Лихтенштейн|
| LK | Шри-Ланка|
| LR | Либерия|
| LS | Лесото|
| LT | Литва|
| LU | Люксембург|
| LV | Латвия|
| LY | Ливия |
| MA | Марокко|
| MD | Молдова, Республика|
| MG | Мадагаскар|
| MK | Северная Македония|
| ML | Мали|
| ММ | Мьянма|
| MN | Монголия|
| MO | Макао (САР)|
| Магический квадрант | Мартиника|
| MR | Мавритания|
| MT | Мальта|
| MV | Мальдивские острова|
| MW | Малави|
| MX | Мексика|
| MY | Малайзия|
| MZ | Мозамбик|
| Нет данных | Намибия|
| NE | Нигер|
| NG | Нигерия|
| NI | Никарагуа|
| NL | Нидерланды|
| НЕТ | Норвегия|
| NP | Непал|
| NR | Науру|
| NZ | Новая Зеландия|
| OM | Оман|
| PA | Панама|
| PE | Перу|
| PH | Филиппины|
| PK | Пакистан|
| PL | Польша|
| PR | Пуэрто-Рико|
| PT | Португалия|
| PW | Палау|
| PY | Парагвай|
| QA | Катар|
| RE | Реюньон|
| RO | Румыния|
| RS | Сербия|
| RU | Российская Федерация|
| RW | Руанда|
| SA | Саудовская Аравия|
| SD | Судан|
| SE | Швеция|
| SG | Сингапур|
| SI | Словения|
| SK | Словакия|
| SN | Сенегал|
| SO | Сомали|
| SR | Суринам|
| SS | Южный Судан|
| SV | Эль-Сальвадор|
| SY | Сирийская Арабская Республика|
| SZ | Свазиленд|
| TC | Острова Теркс и Кайкос|
| TG | Того|
| ВП | Таиланд|
| TN | Тунис|
| TR | Турция|
| TT | Тринидад и Тобаго|
| TW | Тайвань|
| TZ | Танзания, Объединенная Республика|
| UA | Украина|
| UG | Уганда|
| США | США|
| UY | Уругвай|
| UZ | Узбекистан|
| VC | Сент-Винсент и Гренадины|
| VE | Венесуэла|
| VG | Британские Виргинские острова|
| VI | Виргинские острова, США|
| VN | Вьетнам|
| ZA | ЮАР|
| ZM | Замбия|
| ZW | Зимбабве|

## <a name="next-steps"></a>Дальнейшие действия

После получения сведений о настраиваемых правилах [Создайте собственные настраиваемые правила](create-custom-waf-rules.md).
