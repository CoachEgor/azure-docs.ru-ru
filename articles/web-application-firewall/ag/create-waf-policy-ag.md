---
title: Создание политик веб-приложений (WAF) для шлюза приложений
description: Узнайте, как создать политики веб-приложений Firewall для шлюза приложений.
services: web-application-firewall
ms.topic: conceptual
author: vhorne
ms.service: web-application-firewall
ms.date: 02/08/2020
ms.author: victorh
ms.openlocfilehash: 3e8cd2f1e594cd6a60296b2df135f275641df313
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77086987"
---
# <a name="create-web-application-firewall-policies-for-application-gateway"></a>Создание политик веб-приложений firewall для шлюза приложений

Связывание политики WAF со слушателями позволяет нескольким сайтам, стоящим за одним WAF, быть защищенными различными политиками. Например, если за WAF стоит пять сайтов, вы можете иметь пять отдельных политик WAF (по одному для каждого слушателя) для настройки исключений, пользовательских правил и управляемых правил для одного сайта без осуществления других четырех. Если вы хотите, чтобы единая политика применялась ко всем сайтам, вы можете просто связать политику с шлюзом приложений, а не с отдельными слушателями, чтобы она применялась во всем мире. Политики также могут быть применены к правилу маршрутирования на основе маршрутов. 

Вы можете сделать столько политик, сколько вы хотите. После создания политики она должна быть связана с шлюзом приложения, чтобы вступить в силу, но она может быть связана с любой комбинацией шлюзов приложений и слушателей. 

Если ваш шлюз приложения применяется политика, а затем вы применяете другую политику к слушателю на этом шлюзе приложения, политика слушателя вступит в силу, но только для слушателя (ы), который он назначен. Политика Gateway приложений по-прежнему применяется ко всем другим слушателям, у которых нет определенной политики, возложенной на них. 

   > [!NOTE]
   > Политики WAF для отдельных сайтов и отдельных URI предоставляются в общедоступной предварительной версии. Это означает, что на них распространяются дополнительные условия использования корпорации Майкрософт. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

Все новые настройки WAF-излгин-файервола web-приложений (таможенные правила, управляемые конфигурации rulset, исключения и т.д.) живут внутри политики WAF. Если у вас есть существующий WAF, эти настройки все еще могут существовать в вашей конфигурации WAF. Подробнее о том, как перейти к новой политике WAF, можно [узнать](#migrate) о том, как перейти к новой политике WAF, см. 

## <a name="create-a-policy"></a>Создание политики

Во-первых, создайте базовую политику WAF с управляемым набором правил по умолчанию (DRS) с помощью портала Azure.

1. На верхней левой стороне портала выберите **Создать ресурс.** Поиск **для WAF**, выберите **веб-приложение firewall**, а затем выберите **Создать**.
2. На **странице политики WAF,** **вкладка Основы,** введите или выберите следующую информацию, примите по умолчанию для остальных настроек, а затем выберите **Обзор и создайте:**

   |Параметр  |Значение  |
   |---------|---------|
   |Политика для     |Региональный WAF (Прикладной шлюз)|
   |Подписка     |Выберите имя подписки|
   |Группа ресурсов     |Выберите группу ресурсов|
   |Имя политики     |Введите уникальное имя для вашей политики WAF.|
3. На вкладке **Ассоциации** введите одну из следующих настроек, а затем выберите **Добавить:**

   |Параметр  |Значение  |
   |---------|---------|
   |Ассоциированное приложение шлюз     |Выберите имя профиля шлюза приложения.|
   |Ассоциированные слушатели     |Выберите имя слушателя шлюза приложения, а затем выберите **Добавить**.|

   > [!NOTE]
   > Если вы назначаете политику шлюзу приложения (или слушателю), которая уже имеет политику, исходная политика перезаписана и заменена новой политикой.
4. Выберите **Проверить и создать**, а затем выберите **Создать**.

   ![Основы политики WAF](../media/create-waf-policy-ag/waf-policy-basics.png)

## <a name="configure-waf-rules-optional"></a>Настройка правил WAF (необязательно)

При создании политики WAF по умолчанию она находится в режиме *обнаружения.* В режиме обнаружения WAF не блокирует запросы. Вместо этого соответствующие правила WAF регистрируются в журналах WAF. Чтобы увидеть WAF в действии, можно изменить настройки режима на *prevention.* В режиме предотвращения правила соответствия, определенные в выбранном вами правиле CRS, блокируются и/или регистрируются в журналах WAF.

## <a name="managed-rules"></a>Управляемые правила

Правила OWASP, управляемые Azure, включены по умолчанию. Чтобы отключить отдельное правило в группе правил, расширьте правила в этой группе правил, выберите флажок перед номером правила и выберите **"Отключить"** на вкладке выше.

[![Управляемые](../media/create-waf-policy-ag/managed-rules.png) правила](../media/create-waf-policy-ag/managed-rules-lrg.png#lightbox)

## <a name="custom-rules"></a>Настраиваемые правила

Чтобы создать пользовательское правило, выберите **Добавить пользовательское правило** под вкладкой **пользовательские правила.** Это открывает страницу конфигурации пользовательских правил. На следующем скриншоте показанпримерное пользовательское правило, настроенное для блокировки запроса, если строка запроса содержит текстовый *блок.*

[![Отодвить пользовательское правило](../media/create-waf-policy-ag/edit-custom-rule.png)](../media/create-waf-policy-ag/edit-custom-rule-lrg.png#lightbox)

## <a name="migrate-your-waf-config-to-a-waf-policy"></a><a name="migrate"></a>Перенести ваш WAF Config в политику WAF

Если у вас есть существующий WAF, вы, возможно, заметили некоторые изменения в портале. Сначала вам нужно определить, какую политику вы включили на WAF. Есть три потенциальных состояния:

- Нет политики WAF
- Только пользовательские правила
- Политика WAF

Вы можете сказать, в каком состоянии находится ваш WAF, посмотрев на него на портале. Если настройки WAF видны и могут быть изменены из представления портала приложения, ваш WAF находится в состоянии 1.

[![Конфигурация](../media/create-waf-policy-ag/waf-configure.png) WAF](../media/create-waf-policy-ag/waf-configure-lrg.png#lightbox)

Если вы выберете **Web Application Firewall** и он покажет вам связанную политику, WAF находится в состоянии 2 или состоянии 3. После навигации по политике, если она показывает **только** пользовательские правила и шлюзы Associated Application, то это только политика пользовательских правил.

![Настраиваемые правила WAF](../media/create-waf-policy-ag/waf-custom-rules.png)

Если в нем также отображается параметры политики и управляемые правила, то это полная политика веб-приложений Firewall. 

![Настройки политики WAF](../media/create-waf-policy-ag/waf-policy-settings.png)

## <a name="migrate-to-waf-policy"></a>Переход на политику WAF

Если у вас есть пользовательские правила только политика WAF, то вы можете перейти к новой политике WAF. В дальнейшем политика брандмауэра будет поддерживать параметры политики WAF, управляемые правила, исключения и отключенные группы правил. По существу, все конфигурации WAF, которые ранее были сделаны внутри шлюза приложения, теперь выполняются через политику WAF. 

Изменение пользовательского правила отключено только от политики WAF. Для отсечения любых настроек WAF, таких как отключение правил, добавление исключений и т.д., необходимо перейти на новый ресурс политики брандмауэра верхнего уровня.

Для этого создайте *политику веб-приложений firewall* и приспособьте ее к шлюзу приложения (ы) и слушателю (ы) выбора. Эта новая политика **должна** быть точно такой же, как текущая конфигурация WAF, то есть каждое пользовательское правило, исключение, правило отключений и т.д. должны быть скопированы в новую политику, которая вы создаете. Если у вас есть политика, связанная с вашим шлюзом приложения, вы можете продолжать вносить изменения в правила и настройки WAF. Вы также можете сделать это с Azure PowerShell. Для получения дополнительной информации [см.](associate-waf-policy-existing-gateway.md)

В желании можно использовать скрипт миграции для перехода в политику WAF. Для получения дополнительной [информации](migrate-policy.md)см.

## <a name="next-steps"></a>Дальнейшие действия

Подробнее о [группах и правилах Web Application Firewall CRS.](application-gateway-crs-rulegroups-rules.md)
