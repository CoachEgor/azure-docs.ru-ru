---
title: Пользовательское правило брандмауэра веб-приложений для Передней двери Azure
description: Узнайте, как использовать пользовательские правила Web Application Firewall (WAF), защищающие веб-приложения от вредоносных атак.
author: vhorne
ms.service: web-application-firewall
ms.topic: article
services: web-application-firewall
ms.date: 09/05/2019
ms.author: victorh
ms.openlocfilehash: 158bfe30bf48ee420be8efb9ff32fff0e555d9e7
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79475830"
---
#  <a name="custom-rules-for-web-application-firewall-with-azure-front-door"></a>Пользовательские правила для веб-приложений брандмауэр с Azure Front Door

Azure Web Application Firewall (WAF) с Front Door позволяет контролировать доступ к веб-приложениям на основе условий, которые вы определяете. Пользовательское правило WAF состоит из номера приоритета, типа правил, условий соответствия и действия. Существует два типа пользовательских правил: правила соответствия и правила ограничения скорости. Правило соответствия контролирует доступ на основе набора условий соответствия, в то время как правило ограничения скорости контролирует доступ на основе условий соответствия и скорости входящих запросов. Вы можете отключить пользовательское правило, чтобы предотвратить его оценку, но при этом сохранить конфигурацию. 

## <a name="priority-match-conditions-and-action-types"></a>Приоритет, условия соответствия и типы действий

Вы можете управлять доступом с помощью пользовательского правила WAf, которое определяет приоритетное число, тип правил, массив условий соответствия и действие. 

- **Приоритет:** это уникальный ряд, который описывает порядок оценки правил WAF. Правила с более низкими значениями приоритета оцениваются перед правилами с более высокими значениями. Приоритетные номера должны быть уникальными среди всех пользовательских правил.

- **Действие:** определяет способ маршрутизатовать запрос, если совмещено правило WAF. Вы можете выбрать одно из приведенных ниже действий, чтобы применить, когда запрос соответствует пользовательскому правилу.

    - *Разрешить* - WAF препровожжает поиски в бэк-энд, регистрирует запись в журналах и выходах WAF.
    - *Блок* - Запрос заблокирован, WAF отправляет ответ клиенту без переадресировки запроса в бэк-энд. WAF регистрирует запись в журналах WAF.
    - *Войти* - WAF регистрирует запись в журналах WAF и продолжает оценивать следующее правило.
    - *Перенаправление* - WAF перенаправляет запрос на указанный URI, регистрирует запись в журналах WAF и выходит.

- **Условие соответствия:** определяет переменную соответствия, оператора и значение соответствия. Каждое правило может содержать несколько условий совпадения. Условие соответствия может основываться на геолокации, IP-адресах клиента (CIDR), размере или сопоставлении строки. Строка матч может быть против списка переменных матча.
  - **Переменная матча:**
    - ЗапросМетод
    - QueryString
    - Постаргс
    - ЗапросУри
    - RequestHeader
    - RequestBody
    - Файлы cookie
  - **Оператор:**
    - Любое: часто используется для определения действия по умолчанию, если правила не совпадают. Любой соответствует всем операторам.
    - Равно
    - Содержит
    - LessThan: ограничение размера
    - GreaterThan: ограничение размера
    - LessThanOrEqual: ограничение размера
    - GreaterThanOrEqual: ограничение размера
    - BeginsWith
    - EndsWith
    - Регулярное выражение
  
  - **Regex** не поддерживает следующие операции: 
    - Обратные ссылки и захват субвыражений
    - Произвольные утверждения нулевой ширины
    - Подпрограммные ссылки и рекурсивные закономерности
    - Условные закономерности
    - Глаголы управления откатом
    - Однобайная директива КК
    - Директива о совпадении новой линии QR
    - Директива о начале сбросить матч
    - Вызовы и встроенный код
    - Атомная группировка и притяжательные квантификаторы

  - **Негат (необязательно):** Вы можете установить *условие отрицания* к истине, если результат состояния должен быть сведен на нет.
      
  - **Преобразование «необязательно»:** Список строк с именами преобразований, которые необходимо сделать перед началом матча. Это могут быть следующие преобразования:
     - Верхний регистр 
     - Нижний регистр
     - Trim
     - УдалитьНуллы
     - UrlDecode
     - UrlEncode
     
   - **Значение соответствия:** Поддерживаемые значения метода запроса HTTP включают:
     - GET
     - POST
     - ОТПРАВКА
     - HEAD
     - DELETE
     - LOCK
     - UNLOCK
     - ПРОФИЛЬ
     - OPTIONS
     - PROPFIND
     - ПРОППАТЧ
     - MKCOL
     - КОПИРОВАТЬ
     - MOVE

## <a name="examples"></a>Примеры

### <a name="waf-custom-rules-example-based-on-http-parameters"></a>Пример пользовательских правил WAF, основанный на параметрах http

Вот пример, который показывает конфигурацию пользовательского правила с двумя условиями соответствия. Запросы от определенного сайта, как это определено реферером, и строка запроса не содержит "пароль".

```
# http rules example
{
  "name": "AllowFromTrustedSites",
  "priority": 1,
  "ruleType": "MatchRule",
  "matchConditions": [
    {
      "matchVariable": "RequestHeader",
      "selector": "Referer",
      "operator": "Equal",
      "negateCondition": false,
      "matchValue": [
        "www.mytrustedsites.com/referpage.html"
      ]
    },
    {
      "matchVariable": "QueryString",
      "operator": "Contains",
      "matchValue": [
        "password"
      ],
      "negateCondition": true
    }
  ],
  "action": "Allow",
  "transforms": []
}

```
Примерная конфигурация для блокировки метода "PUT" показана ниже:

``` 
# http Request Method custom rules
{
  "name": "BlockPUT",
  "priority": 2,
  "ruleType": "MatchRule",
  "matchConditions": [
    {
      "matchVariable": "RequestMethod",
      "selector": null,
      "operator": "Equal",
      "negateCondition": false,
      "matchValue": [
        "PUT"
      ]
    }
  ],
  "action": "Block",
  "transforms": []
}
```

### <a name="size-constraint"></a>Ограничение размера

Можно создать пользовательское правило, которое определяет ограничение размера по части входящего запроса. Например, ниже правило блокирует Url, который длиннее 100 символов.

```
# http parameters size constraint
{
  "name": "URLOver100",
  "priority": 5,
  "ruleType": "MatchRule",
  "matchConditions": [
    {
      "matchVariable": "RequestUri",
      "selector": null,
      "operator": "GreaterThanOrEqual",
      "negateCondition": false,
      "matchValue": [
        "100"
      ]
    }
  ],
  "action": "Block",
  "transforms": []
}
```

## <a name="next-steps"></a>Дальнейшие действия
- [Налажить политику веб-приложений с помощью Azure PowerShell](waf-front-door-custom-rules-powershell.md) 
- Узнайте больше о [веб-приложении брандмауэр с передней дверью](afds-overview.md)
- Дополнительные сведения о [создании Front Door](../../frontdoor/quickstart-create-front-door.md).

