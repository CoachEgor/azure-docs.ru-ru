---
title: Передняя дверца Azure — методы маршрутизации трафика | Документация Майкрософт
description: Эта статья поможет вам разобраться в различных методах маршрутизации трафика, используемых Front Door.
services: front-door
documentationcenter: ''
author: duongau
ms.service: frontdoor
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/10/2018
ms.author: duau
ms.openlocfilehash: d12eb67abbc216afb241fa6c5a9ef9c66e65040c
ms.sourcegitcommit: 5a3b9f35d47355d026ee39d398c614ca4dae51c6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/02/2020
ms.locfileid: "89399316"
---
# <a name="front-door-routing-methods"></a>Методы маршрутизации Front Door

Передняя дверца Azure поддерживает различные методы маршрутизации трафика для определения способа маршрутизации трафика HTTP/HTTPS к различным конечным точкам службы. К каждому запросу клиента, поступившему во Front Door, применяется настроенный метод маршрутизации. Это гарантирует, что запросы пересылаются на оптимальный экземпляр внутреннего сервера. 

В службе Front Door используются четыре основных принципа маршрутизации трафика.

* **[Задержка](#latency)**. Маршрутизация на основе задержки гарантирует, что запросы отправляются на внутренние серверы с минимальной допустимой задержкой в диапазоне чувствительности. По сути запросы пользователей направляются в "ближайший" набор внутренних серверов с точки зрения сетевой задержки.
* ** [Приоритет](#priority):** Вы можете назначить приоритеты для различных серверных систем, если вы хотите использовать основную внутреннюю службу для всего трафика, и создать резервные копии в случае недоступности основной или резервной копии.
* **[Вес](#weighted)**. Если вы хотите распределять трафик по всему набору внутренних серверов (равномерно или с учетом весовых коэффициентов), можно назначить различным внутренним серверам разный вес.
* **[Сходство сеансов](#affinity)**. Вы можете настроить сходство сеансов для интерфейсных узлов или доменов, если вы хотите, чтобы последующие запросы пользователя отправлялись на тот же внутренний сервер до тех пор, пока сеанс пользователя остается активным и экземпляр внутреннего сервера сообщает о своей работоспособности на основании проб работоспособности. 

Все конфигурации Front Door включают в себя мониторинг работоспособности внутренних серверов и немедленную глобальную автоматическую отработку отказа. Дополнительные сведения см. в разделе [Пробы работоспособности](front-door-health-probes.md). Front Door можно настроить для применения одного метода маршрутизации. В зависимости от потребностей приложения можно сочетать несколько или все доступные методы маршрутизации, чтобы создать оптимальную топологию маршрутизации.

## <a name="lowest-latencies-based-traffic-routing"></a><a name = "latency"></a>Маршрутизация трафика на основе минимальной задержки

Скорость реагирования многих приложений можно повысить, развернув внутренние серверы в двух или больше расположениях в разных регионах и направляя трафик в ближайшее к пользователю расположение. Метод маршрутизации трафика по умолчанию для конфигурации Front Door пересылает запросы пользователей на внутренний сервер, ближайший к среде Front Door, получившей запрос. В сочетании с архитектурой первого уровня для передней дверцы Azure этот подход гарантирует, что каждый пользователь будет получать максимальную производительность в соответствии с их расположением.

Под ближайшим внутренним сервером не обязательно подразумевается тот, который расположен ближе всего географически. Вместо этого Front Door определяет ближайший внутренний сервер, измеряя сетевую задержку. Узнайте больше об [архитектуре маршрутизации Front Door](front-door-routing-architecture.md). 

Ниже приведен общий процесс принятия решений.

| Доступные внутренние серверы | Приоритет | Задержка (с учетом пробы работоспособности) | Веса |
|-------------| ----------- | ----------- | ----------- |
| Сначала выберите все внутренние серверы, которые включены и возвращают работоспособное состояние (200 ОК) для пробы работоспособности. Предположим, имеются шесть внутренних серверов, A, B, C, D, E и F, и сервер C находится в неработоспособном состоянии, а сервер E отключен. Поэтому список доступных внутренних серверов будет содержать A, B, D и F.  | Затем выбираются наиболее приоритетные внутренние серверы из доступных. Скажем, внутренние серверы A, B и D имеют приоритет 1, а внутренний сервер F имеет приоритет 2. Поэтому будут выбраны внутренние серверы A, B и D.| Выберите внутренние серверы с диапазоном задержки (минимальная задержка и чувствительность к задержке в миллисекундах). Например, если задержка сервера A составляет 15 мс, задержка сервера B — 30 мс и задержка сервера D — 60 мс для среды Front Door и чувствительность к задержке составляет 30 мс, то пул с минимальной задержкой будет состоять из внутренних серверов A и B, так как задержка сервера D на 30 мс выше, чем задержка ближайшего сервера, A. | Наконец, Front Door будет циклически перебирать трафик в окончательном выбранном пуле внутренних серверов с учетом указанных весовых коэффициентов. Например, если внутренний сервер A имеет вес 5, а внутренний сервер B имеет вес 8, то трафик между внутренним серверами A и B будет распределяться в соотношении 5:8. |

>[!NOTE]
> По умолчанию задано значение свойства чувствительности к задержке, равное 0 мс, то есть запрос всегда пересылается на самый быстрый внутренний сервер.


## <a name="priority-based-traffic-routing"></a><a name = "priority"></a>Маршрутизация трафика по приоритету

Как правило, организация стремится обеспечить надежность своих служб, развертывая одну или несколько резервных служб на случай, если основная служба выйдет из строя. В отрасли эта топология также называется топологией развертывания "активный — резервный" или "активный — пассивный". Метод маршрутизации трафика "По приоритету" позволяет клиентам Azure легко реализовать эту схему отработки отказа.

По умолчанию Front Door содержит список внутренних серверов с одинаковым приоритетом. По умолчанию Front Door отправляет трафик только на внутренние серверы с максимальным приоритетом (наименьшим значением приоритета), то есть в основной набор внутренних серверов. Если основные внутренние серверы недоступны, Front Door направляет трафик в дополнительный набор внутренних серверов (с вторым наименьшим значением приоритета). Если и основные, и дополнительные внутренние серверы становятся недоступны, трафик направляется в третий набор внутренних серверов в порядке приоритетности и т. д. Доступность внутреннего сервера основывается на настроенном состоянии (включен или отключен) и текущем состоянии работоспособности внутреннего сервера, которое определяют пробы работоспособности.

### <a name="configuring-priority-for-backends"></a>Настройка приоритета внутренних серверов

Каждый из внутренних серверов во внутреннем пуле в конфигурации Front Door имеет свойство Priority, которое может иметь значение от 1 до 5. С помощью передней дверцы Azure вы настраиваете приоритет серверной части явным образом, используя это свойство для каждой серверной части. Это свойство может принимать значения от 1 до 5. Чем меньше значение, тем выше приоритет. У внутренних серверов могут быть одинаковые значения приоритета.

## <a name="weighted-traffic-routing-method"></a><a name = "weighted"></a>Метод маршрутизации трафика со взвешиванием
Маршрутизация трафика по методу взвешивания позволяет распределять трафик равномерно или в соответствии с предустановленными весовыми коэффициентами.

При использовании метода маршрутизации трафика со взвешиванием каждому внутреннему серверу в конфигурации Front Door присваивается определенный вес. Это целое число в диапазоне от 1 до 1000. По умолчанию этот параметр задает вес, равный 50.

Трафик распределяется среди доступных внутренних серверов с указанной допустимой чувствительностью к задержке методом циклического перебора с учетом указанных весовых коэффициентов. Если чувствительность к задержке имеет значение 0 миллисекунд, то это свойство не учитывается, если только в пуле не доступны два внутренних сервера с одинаковой сетевой задержкой. 

Метод взвешивания позволяет реализовать некоторые полезные сценарии.

* **Постепенное обновление приложения**. Направляйте часть трафика на новый внутренний сервер и постепенно доведите объем трафика до 100 %, чтобы соблюсти паритет с остальными внутренними серверами.
* **Перенос приложений в Azure**. Создайте внутренний пул, который включает в себя внутренние серверы, расположенные в среде Azure и за ее пределами. Настройте веса внутренних серверов так, чтобы приоритет отдавался новым внутренним серверам. Это можно делать постепенно, начиная с отключенных новых внутренних серверов, а затем назначая им наименьшие веса, медленно увеличивая их до уровня, при котором они будут принимать большую часть трафика. Затем можно будет отключить менее предпочтительные внутренние серверы и удалить их из пула.  
* **Переход в облако для получения дополнительной емкости**. Быстро расширьте локальное развертывание в облако, воспользовавшись службой Front Door. Если вам требуется дополнительная емкость в облаке, можно добавить или включить дополнительные внутренние серверы и указать, какая часть трафика направляется на каждый из них.

## <a name="session-affinity"></a><a name = "affinity"></a>Сходство сеансов
По умолчанию, без сходства сеансов, передняя дверца перенаправляет запросы от одного клиента к разным серверным сторонам на основе конфигурации балансировки нагрузки, особенно в случае задержки для различных изменений серверной части, или других запросов от тех же самых пользователей в другой среде передней дверцы. Тем не менее для некоторых приложений с отслеживанием состояния и сценариев предпочтительно, чтобы последующие запросы от одного пользователя поступали на внутренний сервер, который обработал предыдущий запрос. Функция сходства сеансов на основе файлов cookie удобна, если нужно, чтобы сеанс пользователя выполнялся на одном и том же внутреннем сервере. С помощью управляемых файлов cookie для передней дверцы, передняя дверца Azure может направить последующий трафик из сеанса пользователя на ту же серверную часть для обработки, если серверная служба работоспособна и срок действия сеанса пользователя не истек. 

Сходство сеансов можно включить на уровне интерфейсного узла для всех настроенных доменов (или поддоменов). После включения служба Front Door добавляет файл cookie в сеанс пользователя. Используя сходство сеансов на основе файлов cookie, служба Front Door может идентифицировать различных пользователей, даже если они используют один и тот же IP-адрес. В свою очередь, это обеспечивает более равномерное распределение трафика между различными внутренними серверами.

Время существования файла cookie и сеанса пользователя одинаковы, так как сейчас Front Door поддерживает только файл cookie сеанса. 

> [!NOTE]
> Общедоступные прокси-серверы могут мешать использовать сходство сеансов. Это обусловлено тем, что для установления сеанса службе Front Door требуется добавить файл cookie сходства сеансов в ответ. Это невозможно сделать в том случае, если ответ может быть сохранен в кэше, так как это помешает использовать файлы cookie из других клиентов, запрашивающих тот же ресурс. Чтобы избежать этого, сходство сеансов **не** устанавливается, если внутренний сервер отправляет кэшируемый ответ при попытке установить сеанс. Если сеанс уже установлен, то не важно, кэшируется ли ответ от внутреннего сервера.
> В следующих обстоятельствах будет установлено сходство сеансов, **если только** ответ не содержит код состояния HTTP 304:
> - В ответе заданы определенные значения ```Cache-Control``` заголовка, которые предотвращают кэширование, например "Private" или "No-Store".
> - Ответ содержит заголовок ```Authorization```, срок действия которого не истек.
> - Ответ содержит код состояния HTTP 302.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о [создании Front Door](quickstart-create-front-door.md).
- Дополнительные сведения о том, [как работает Front Door](front-door-routing-architecture.md).
