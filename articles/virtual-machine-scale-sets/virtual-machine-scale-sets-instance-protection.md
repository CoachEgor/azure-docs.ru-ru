---
title: Экземпляры Защита для виртуальных машин Azure набор экземпляров
description: Узнайте, как защитить экземпляры виртуального масштаба машин Azure от операций, связанных с масштабированием и масштабированием.
author: avirishuv
tags: azure-resource-manager
ms.service: virtual-machine-scale-sets
ms.topic: conceptual
ms.date: 02/26/2020
ms.author: avverma
ms.openlocfilehash: 021faad28fb575c4ffeb4d895ad451d8cd82b1a5
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79254122"
---
# <a name="instance-protection-for-azure-virtual-machine-scale-set-instances"></a>Экземпляры Защита для виртуальных машин Azure набор экземпляров

Наборы виртуальных машин Azure обеспечивают лучшую эластичность рабочих нагрузок через [Autoscale,](virtual-machine-scale-sets-autoscale-overview.md)поэтому вы можете настроить, когда ваша инфраструктура масштабируется и когда она масштабируется. Наборы масштабов также позволяют централизованно управлять, настраивать и обновлять большое количество вс-а-а через различные параметры [политики обновления.](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model) Вы можете настроить обновление на модель набора масштаба, и новая конфигурация автоматически применяется к каждому экземпляру набора масштаба, если вы установили политику обновления на Automatic или Rolling.

По мере того как приложение обрабатывает трафик, могут возникать ситуации, когда вы хотите, чтобы к определенным экземплярам относились иначе, чем к остальной части набора масштаба. Например, некоторые экземпляры в наборе масштабов могут выполнять длительные операции, и вы не хотите, чтобы эти экземпляры были масштабированы до завершения операций. Возможно, вы также специализировали несколько экземпляров в наборе масштабов для выполнения дополнительных или иных задач, чем другие участники набора шкалы. Вы требуете, чтобы эти "специальные" ВМ не были изменены с другими экземплярами в наборе масштаба. Защита экземпляров обеспечивает дополнительные элементы управления для включения этих и других сценариев для вашего приложения.

В этой статье описывается, как можно применять и использовать различные возможности защиты экземпляров с набором масштабов экземпляров.

## <a name="types-of-instance-protection"></a>Виды защиты экземпляров
Наборы масштабов обеспечивают два типа возможностей защиты экземпляров:

-   **Защита от масштабирования**
    - Включено с **помощью защитыFromScaleIn** свойство на экземпляре набора шкалы
    - Защищает экземпляр от инициированного масштабирования Autoscale
    - Операции, инициированные пользователем, (включая удаление экземпляров) **не блокируются**
    - Операции, начатые в наборе масштабов (обновление, переизображение, дераспределение и т.д.), **не блокируются**

-   **Защита от действий, установленных масштабами**
    - Включено с **помощью свойства protectFromScaleSetActions** в экземпляре набора масштаба
    - Защищает экземпляр от инициированного масштабирования Autoscale
    - Защищает экземпляр от операций, начатых в наборе масштабов (таких как обновление, переизображение, дераспределение и т.д.)
    - Операции, инициированные пользователем, (включая удаление экземпляров) **не блокируются**
    - Удаление полного набора не **заблокировано**

## <a name="protect-from-scale-in"></a>Защита от масштабирования
Защита экземпляров может быть применена к маштабу установленных экземпляров после создания экземпляров. Защита применяется и модифицируется только на [экземплярной модели,](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-vm-model-view) а не на [модель набора масштаба.](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-model)

Существует несколько способов применения защиты масштабирования в случаях набора шкалы, описанных в приведенных ниже примерах.

### <a name="azure-portal"></a>Портал Azure

Защита масштабирования можно применить через портал Azure к экземпляру в наборе масштабов. Вы не можете настроить более одного экземпляра одновременно. Повторите шаги для каждого экземпляра, который вы хотите защитить.
 
1. Перейдите к существующему набору виртуальной шкалы машин.
1. Выберите **инстанции** из меню слева, под **настройками.**
1. Выберите имя экземпляра, который вы хотите защитить.
1. Выберите вкладку **«Политика защиты».**
1. В лезвии **политики защиты** выберите опцию **«Защита» из опции «Масштабирование».**
1. Нажмите кнопку **Сохранить**. 

### <a name="rest-api"></a>REST API

Следующий пример применяет защиту масштабирования к экземпляру в наборе масштабов.

```
PUT on `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}/virtualMachines/{instance-id}?api-version=2019-03-01`
```

```json
{
  "properties": {
    "protectionPolicy": {
      "protectFromScaleIn": true
    }
  }        
}

```

> [!NOTE]
>Защита экземпляров поддерживается только с версией API 2019-03-01 и выше

### <a name="azure-powershell"></a>Azure PowerShell

Используйте смдlet [Update-AzVmssVM,](/powershell/module/az.compute/update-azvmssvm) чтобы применить защиту масштабирования к экземпляру набора масштаба.

Следующий пример применяет защиту масштабирования к экземпляру в наборе шкалы, имеющий идентификатор экземпляра 0.

```azurepowershell-interactive
Update-AzVmssVM `
  -ResourceGroupName "myResourceGroup" `
  -VMScaleSetName "myVMScaleSet" `
  -InstanceId 0 `
  -ProtectFromScaleIn $true
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

Используйте [обновление az vmss](/cli/azure/vmss#az-vmss-update) для применения защиты масштабирования к экземпляру набора масштаба.

Следующий пример применяет защиту масштабирования к экземпляру в наборе шкалы, имеющий идентификатор экземпляра 0.

```azurecli-interactive
az vmss update \  
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --instance-id 0 \
  --protect-from-scale-in true
```

## <a name="protect-from-scale-set-actions"></a>Защита от действий, установленных масштабами
Защита экземпляров может быть применена к маштабу установленных экземпляров после создания экземпляров. Защита применяется и модифицируется только на [экземплярной модели,](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-vm-model-view) а не на [модель набора масштаба.](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-model)

Защита экземпляра от действий набора масштабов также защищает экземпляр от инициированного масштабирования Autoscale.

Существует несколько способов применения защиты от установленных действий в наборах масштабов, описанных в приведенных ниже примерах.

### <a name="azure-portal"></a>Портал Azure

Можно применить защиту от действий, установленных в масштабе, через портал Azure к экземпляру в наборе. Вы не можете настроить более одного экземпляра одновременно. Повторите шаги для каждого экземпляра, который вы хотите защитить.
 
1. Перейдите к существующему набору виртуальной шкалы машин.
1. Выберите **инстанции** из меню слева, под **настройками.**
1. Выберите имя экземпляра, который вы хотите защитить.
1. Выберите вкладку **«Политика защиты».**
1. В лезвии **политики защиты** выберите опцию **«Защита от установленных масштабов действий».**
1. Нажмите кнопку **Сохранить**. 

### <a name="rest-api"></a>REST API

В следующем примере защита от действий, установленных в масштабе, относится к экземпляру в наборе шкалы.

```
PUT on `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vMScaleSetName}/virtualMachines/{instance-id}?api-version=2019-03-01`
```

```json
{
  "properties": {
    "protectionPolicy": {
      "protectFromScaleIn": true,
      "protectFromScaleSetActions": true
    }
  }        
}

```

> [!NOTE]
>Защита экземпляров поддерживается только с версией API 2019-03-01 и выше.</br>
Защита экземпляра от действий набора масштабов также защищает экземпляр от инициированного масштабирования Autoscale. Вы не можете указать "protectFromScaleIn": ложное при настройке "ProtectFromScaleSetActions": правда

### <a name="azure-powershell"></a>Azure PowerShell

Используйте смдlet [Update-AzVmssVM,](/powershell/module/az.compute/update-azvmssvm) чтобы применить защиту от действий, установленных в масштабе, к экземпляру набора масштаба.

В следующем примере защита от действий, установленных в масштабе, относится к экземпляру в наборе шкалы, имеющего идентификатор экземпляра 0.

```azurepowershell-interactive
Update-AzVmssVM `
  -ResourceGroupName "myResourceGroup" `
  -VMScaleSetName "myVMScaleSet" `
  -InstanceId 0 `
  -ProtectFromScaleIn $true `
  -ProtectFromScaleSetAction $true
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

Используйте [обновление az vmss](/cli/azure/vmss#az-vmss-update) для применения защиты от действий, установленных масштабом, к экземпляру набора масштаба.

В следующем примере защита от действий, установленных в масштабе, относится к экземпляру в наборе шкалы, имеющего идентификатор экземпляра 0.

```azurecli-interactive
az vmss update \  
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --instance-id 0 \
  --protect-from-scale-in true \
  --protect-from-scale-set-actions true
```

## <a name="troubleshoot"></a>Устранение неполадок
### <a name="no-protectionpolicy-on-scale-set-model"></a>Отсутствие protectionPolicy на модели комплекта маштаба
Защита экземпляров применима только в установленных случаях масштаба, а не в модели набора масштаба.

### <a name="no-protectionpolicy-on-scale-set-instance-model"></a>Отсутствие защитыПолитика на модели набора масштаба
По умолчанию политика защиты не применяется к экземпляру при ее создании.

Можно применить защиту экземпляра для масштабирования установленных экземпляров после создания экземпляров.

### <a name="not-able-to-apply-instance-protection"></a>Не в состоянии применить защиту экземпляров
Защита экземпляров поддерживается только с версией API 2019-03-01 и выше. Проверьте используемую версию API и обновляйте по мере необходимости. Возможно, вам также потребуется обновить PowerShell или CLI до последней версии.

## <a name="next-steps"></a>Дальнейшие действия
Узнайте, как [развертывать приложение](virtual-machine-scale-sets-deploy-app.md) в масштабируемых наборах виртуальных машин.
