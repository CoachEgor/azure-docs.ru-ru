---
title: Защита экземпляра для экземпляров масштабируемых наборов виртуальных машин Azure
description: Узнайте, как защитить экземпляры масштабируемых наборов виртуальных машин Azure из операций масштабирования и масштабирования.
author: avirishuv
tags: azure-resource-manager
ms.service: virtual-machine-scale-sets
ms.topic: conceptual
ms.date: 02/26/2020
ms.author: avverma
ms.openlocfilehash: 021faad28fb575c4ffeb4d895ad451d8cd82b1a5
ms.sourcegitcommit: 7b25c9981b52c385af77feb022825c1be6ff55bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2020
ms.locfileid: "79254122"
---
# <a name="instance-protection-for-azure-virtual-machine-scale-set-instances"></a>Защита экземпляра для экземпляров масштабируемых наборов виртуальных машин Azure

Масштабируемые наборы виртуальных машин Azure обеспечивают лучшую эластичность рабочих нагрузок с помощью [автомасштабирования](virtual-machine-scale-sets-autoscale-overview.md), поэтому вы можете настроить время масштабирования инфраструктуры и время ее масштабирования. Масштабируемые наборы также позволяют централизованно управлять, настраивать и обновлять большое количество виртуальных машин с помощью различных параметров [политики обновления](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model) . Вы можете настроить обновление для модели масштабируемого набора, и Новая конфигурация будет автоматически применена к каждому экземпляру масштабируемого набора, если политика обновления настроена на автоматическое или пошаговое развертывание.

Так как приложение обрабатывает трафик, возможны ситуации, когда требуется, чтобы определенные экземпляры обрабатывались иначе, чем остальная часть экземпляра масштабируемого набора. Например, некоторые экземпляры в масштабируемом наборе могут выполнять длительные операции, и вы не хотите, чтобы эти экземпляры были масштабированы до завершения операций. Кроме того, может быть специализировано несколько экземпляров в масштабируемом наборе для выполнения дополнительных или других задач, отличных от других элементов масштабируемого набора. Эти "специальные" виртуальные машины необходимо не изменять с помощью других экземпляров в масштабируемом наборе. Защита экземпляра предоставляет дополнительные элементы управления для включения этих и других сценариев в приложение.

В этой статье описывается, как применять различные возможности защиты экземпляра с помощью экземпляров масштабируемых наборов.

## <a name="types-of-instance-protection"></a>Типы защиты экземпляров
Масштабируемые наборы предоставляют два типа возможностей защиты экземпляров:

-   **Защита от масштабирования**
    - Включено с помощью свойства **протектфромскалеин** в экземпляре масштабируемого набора
    - Защищает экземпляр от автоматического масштабирования, инициированного автомасштабированием
    - Операции с экземплярами, инициированные пользователем (включая удаление экземпляра), **не блокируются**
    - Операции, инициированные в масштабируемом наборе (обновление, повторное создание образа, освобождение и т. д.), **не блокируются**

-   **Защита от действий масштабируемого набора**
    - Включено с помощью свойства **протектфромскалесетактионс** в экземпляре масштабируемого набора
    - Защищает экземпляр от автоматического масштабирования, инициированного автомасштабированием
    - Защищает экземпляр от операций, инициированных в масштабируемом наборе (например, обновление, повторное создание образа, освобождение и т. д.).
    - Операции с экземплярами, инициированные пользователем (включая удаление экземпляра), **не блокируются**
    - Удаление полного масштабируемого набора **не заблокировано**

## <a name="protect-from-scale-in"></a>Защита от масштабирования
Защиту экземпляра можно применить к экземплярам масштабируемого набора после создания экземпляров. Защита применяется и изменяется только в [модели экземпляра](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-vm-model-view) , а не в [модели масштабируемого набора](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-model).

Существует несколько способов применения защиты масштабирования к экземплярам масштабируемого набора, как описано в примерах ниже.

### <a name="azure-portal"></a>Портал Azure

Вы можете применить защиту с помощью портал Azure к экземпляру в масштабируемом наборе. В каждый момент времени нельзя изменять более одного экземпляра. Повторите шаги для каждого экземпляра, который необходимо защитить.
 
1. Перейдите к существующему масштабируемому набору виртуальных машин.
1. Выберите **экземпляры** в меню слева, в разделе **Параметры**.
1. Выберите имя экземпляра, который необходимо защитить.
1. Перейдите на вкладку **Политика защиты** .
1. В колонке **Политика защиты** выберите параметр **защитить от масштабирования** .
1. Щелкните **Сохранить**. 

### <a name="rest-api"></a>REST API

В следующем примере применяется защита с помощью масштабирования для экземпляра в масштабируемом наборе.

```
PUT on `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}/virtualMachines/{instance-id}?api-version=2019-03-01`
```

```json
{
  "properties": {
    "protectionPolicy": {
      "protectFromScaleIn": true
    }
  }        
}

```

> [!NOTE]
>Защита экземпляра поддерживается только с API версии 2019-03-01 и выше

### <a name="azure-powershell"></a>Azure PowerShell

Используйте командлет [Update-азвмссвм](/powershell/module/az.compute/update-azvmssvm) , чтобы применить защиту масштабирования к экземпляру масштабируемого набора.

В следующем примере применяется защита с помощью масштабирования для экземпляра в масштабируемом наборе с ИДЕНТИФИКАТОРом 0.

```azurepowershell-interactive
Update-AzVmssVM `
  -ResourceGroupName "myResourceGroup" `
  -VMScaleSetName "myVMScaleSet" `
  -InstanceId 0 `
  -ProtectFromScaleIn $true
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

Используйте команду [AZ vmss Update](/cli/azure/vmss#az-vmss-update) , чтобы применить защиту масштабирования к экземпляру масштабируемого набора.

В следующем примере применяется защита с помощью масштабирования для экземпляра в масштабируемом наборе с ИДЕНТИФИКАТОРом 0.

```azurecli-interactive
az vmss update \  
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --instance-id 0 \
  --protect-from-scale-in true
```

## <a name="protect-from-scale-set-actions"></a>Защита от действий масштабируемого набора
Защиту экземпляра можно применить к экземплярам масштабируемого набора после создания экземпляров. Защита применяется и изменяется только в [модели экземпляра](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-vm-model-view) , а не в [модели масштабируемого набора](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-model).

Защита экземпляра из действий масштабируемого набора также защищает экземпляр от автоматического масштабирования, инициированного автомасштабированием.

Существует несколько способов применения защиты действий масштабируемого набора к экземплярам масштабируемого набора, как описано в примерах ниже.

### <a name="azure-portal"></a>Портал Azure

Защиту можно применить из действий масштабируемого набора с помощью портал Azure к экземпляру в масштабируемом наборе. В каждый момент времени нельзя изменять более одного экземпляра. Повторите шаги для каждого экземпляра, который необходимо защитить.
 
1. Перейдите к существующему масштабируемому набору виртуальных машин.
1. Выберите **экземпляры** в меню слева, в разделе **Параметры**.
1. Выберите имя экземпляра, который необходимо защитить.
1. Перейдите на вкладку **Политика защиты** .
1. В колонке **Политика защиты** выберите параметр **защитить от действий масштабируемого набора** .
1. Щелкните **Сохранить**. 

### <a name="rest-api"></a>REST API

Следующий пример применяет защиту от действий масштабируемого набора к экземпляру в масштабируемом наборе.

```
PUT on `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vMScaleSetName}/virtualMachines/{instance-id}?api-version=2019-03-01`
```

```json
{
  "properties": {
    "protectionPolicy": {
      "protectFromScaleIn": true,
      "protectFromScaleSetActions": true
    }
  }        
}

```

> [!NOTE]
>Защита экземпляра поддерживается только в API версии 2019-03-01 и выше.</br>
Защита экземпляра из действий масштабируемого набора также защищает экземпляр от автоматического масштабирования, инициированного автомасштабированием. Нельзя указать "Протектфромскалеин": false при задании "Протектфромскалесетактионс": true

### <a name="azure-powershell"></a>Azure PowerShell

Используйте командлет [Update-азвмссвм](/powershell/module/az.compute/update-azvmssvm) , чтобы применить защиту от действий масштабируемого набора к экземпляру масштабируемого набора.

Следующий пример применяет защиту от действий масштабируемого набора к экземпляру в масштабируемом наборе с ИДЕНТИФИКАТОРом 0.

```azurepowershell-interactive
Update-AzVmssVM `
  -ResourceGroupName "myResourceGroup" `
  -VMScaleSetName "myVMScaleSet" `
  -InstanceId 0 `
  -ProtectFromScaleIn $true `
  -ProtectFromScaleSetAction $true
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

Используйте команду [AZ vmss Update](/cli/azure/vmss#az-vmss-update) , чтобы применить защиту от действий масштабируемого набора к экземпляру масштабируемого набора.

Следующий пример применяет защиту от действий масштабируемого набора к экземпляру в масштабируемом наборе с ИДЕНТИФИКАТОРом 0.

```azurecli-interactive
az vmss update \  
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --instance-id 0 \
  --protect-from-scale-in true \
  --protect-from-scale-set-actions true
```

## <a name="troubleshoot"></a>Устранение неполадок
### <a name="no-protectionpolicy-on-scale-set-model"></a>Нет Протектионполици в модели масштабируемого набора
Защита экземпляра применима только к экземплярам масштабируемых наборов, а не к модели масштабируемого набора.

### <a name="no-protectionpolicy-on-scale-set-instance-model"></a>Нет Протектионполици в модели экземпляра масштабируемого набора
По умолчанию политика защиты не применяется к экземпляру при его создании.

Защиту экземпляра можно применить к экземплярам масштабируемого набора после создания экземпляров.

### <a name="not-able-to-apply-instance-protection"></a>Не удается применить защиту экземпляра
Защита экземпляра поддерживается только в API версии 2019-03-01 и выше. Проверьте используемую версию API и обновите ее при необходимости. Вам также может потребоваться обновить PowerShell или CLI до последней версии.

## <a name="next-steps"></a>Дальнейшие действия
Узнайте, как [развертывать приложение](virtual-machine-scale-sets-deploy-app.md) в масштабируемых наборах виртуальных машин.
