---
title: Используйте пользовательские политики масштабирования с наборами виртуальных машин Azure
description: Узнайте, как использовать пользовательские политики масштабирования с наборами виртуальных машин Azure, которые используют автомасштабную конфигурацию для управления количеством экземпляров
services: virtual-machine-scale-sets
author: avirishuv
manager: vashan
tags: azure-resource-manager
ms.service: virtual-machine-scale-sets
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm
ms.topic: conceptual
ms.date: 02/26/2020
ms.author: avverma
ms.openlocfilehash: ffcdaf76bdd08ee5505ddbeff6a6698e231b6171
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77919844"
---
# <a name="use-custom-scale-in-policies-with-azure-virtual-machine-scale-sets"></a>Используйте пользовательские политики масштабирования с наборами виртуальных машин Azure

Развертывание виртуального набора масштабов машины может быть масштабировано или масштабировано на основе массива метрик, включая платформу и пользовательские метрики, определяемые пользователем. В то время как масштабирование создает новые виртуальные машины на основе модели набора масштаба, масштаб влияет на запуск виртуальных машин, которые могут иметь различные конфигурации и/или функции по мере развития рабочей нагрузки набора масштаба. 

Функция политики масштабирования предоставляет пользователям способ настройки порядка, в котором виртуальные машины масштабируются, с помощью трех конфигураций масштабирования: 

1. Значение по умолчанию
2. НовейшееVM
3. СтарейшийVM

### <a name="default-scale-in-policy"></a>Политика масштабирования по умолчанию

По умолчанию набор виртуальной шкалы машин применяет эту политику, чтобы определить, в каком экземпляре (s) будет масштабироваться. С политикой *по умолчанию,* VMs выбираются для масштабирования в следующем порядке:

1. Баланс виртуальных машин в зонах доступности (если набор масштабов развернут в зональной конфигурации)
2. Баланс виртуальных машин в развиных доменах (лучшие усилия)
3. Удалить виртуальную машину с самым высоким идентификатором экземпляра

Пользователям не нужно указывать политику масштабирования, если они просто хотят, чтобы заказ по умолчанию следовал.

Обратите внимание, что балансирование между зонами доступности или доменами неисправностей не перемещает экземпляры по зонам доступности или доменам неисправностей. Балансировка достигается за счет удаления виртуальных машин из несбалансированных зон доступности или доменов разлома до тех пор, пока распределение виртуальных машин не станет сбалансированным.

### <a name="newestvm-scale-in-policy"></a>Новейшая политика масштабирования VM

Эта политика удалит новейшую созданную виртуальную машину в наборе масштабов после балансировки Виртуальных Технологий в зонах доступности (для зональных развертываний). Включение этой политики требует изменения конфигурации на модели набора виртуальной шкалы машин.

### <a name="oldestvm-scale-in-policy"></a>Старейшая политика масштабирования VM

Эта политика удалит старейшую созданную виртуальную машину в наборе масштабов после балансировки Виртуальных Технологий в зонах доступности (для зональных развертываний). Включение этой политики требует изменения конфигурации на модели набора виртуальной шкалы машин.

## <a name="enabling-scale-in-policy"></a>Включение политики масштабирования

Политика масштабирования определена в модели набора виртуальной шкалы машин. Как отмечается в приведенных выше разделах, при использовании политики "NewestVM" и "OldestVM" необходимо определение политики масштаба. Виртуальный набор масштабов машин будет автоматически использовать политику масштабирования 'Default', если в модели набора шкалы не найдено определение политики масштаба. 

Политика масштабирования может быть определена на модели набора виртуальной шкалы машин следующим образом:

### <a name="azure-portal"></a>Портал Azure
 
Следующие шаги определяют политику масштабирования при создании нового набора масштабов. 
 
1. Перейти к **виртуальным наборам масштабов машины.**
1. Выберите **и добавьте,** чтобы создать новый набор масштабов.
1. Перейдите на вкладку **Масштабирования.** 
1. Найдите раздел **политики масштабирования.**
1. Выберите политику масштабирования из выпадения.
1. Когда вы закончите создание нового набора шкалы, выберите кнопку **«Обзор» и «Создайте».**

### <a name="using-api"></a>С помощью API

Выполните PUT по виртуальному масштабу машины, установленную с помощью API 2019-03-01:

```
PUT
https://management.azure.com/subscriptions/<sub-id>/resourceGroups/<myRG>/providers/Microsoft.Compute/virtualMachineScaleSets/<myVMSS>?api-version=2019-03-01

{ 
"location": "<VMSS location>", 
    "properties": { 
        "scaleInPolicy": {  
            "rules": ["OldestVM"]  
        } 
    }    
} 
```
### <a name="azure-powershell"></a>Azure PowerShell

Создайте группу ресурсов, а затем создайте новый набор шкалы с набором политики масштабирования как *OldestVM.*

```azurepowershell-interactive
New-AzResourceGroup -ResourceGroupName "myResourceGroup" -Location "<VMSS location>"
New-AzVmss `
  -ResourceGroupName "myResourceGroup" `
  -Location "<VMSS location>" `
  -VMScaleSetName "myScaleSet" `
  -ScaleInPolicy “OldestVM”
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

Следующий пример добавляет политику масштабирования при создании нового набора масштабов. Сначала создайте группу ресурсов, а затем создайте новый набор масштабов с политикой масштабирования, как *OldestVM.* 

```azurecli-interactive
az group create --name <myResourceGroup> --location <VMSSLocation>
az vmss create \
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --image UbuntuLTS \
  --admin-username <azureuser> \
  --generate-ssh-keys \
  --scale-in-policy OldestVM
```

### <a name="using-template"></a>Использование шаблона

В шаблоне под "свойствами" добавьте следующее:

```json
"scaleInPolicy": {  
      "rules": ["OldestVM"]  
}
```

Вышеуказанные блоки указывают, что набор виртуальной шкалы машины будет удалять старейший VM в зоне сбалансированного набора масштаба, когда масштаб срабатывает (через Autoscale или ручной удаление).

Когда набор виртуальной шкалы машин не сбалансирован, набор масштабов сначала удаляет виртуальные компьютеры в несбалансированной зоне (ы). В несбалансированных зонах в наборе масштабов будет использоваться политика масштабирования, указанная выше, чтобы определить, в каком ВМ масштабироваться. В этом случае в несбалансированной зоне набор масштабов выберет старейший VM в этой зоне, который будет удален.

Для незонального набора виртуальной шкалы машин политика выбирает старейший VM по шкале, установленной для удаления.

Тот же процесс применяется при использовании 'NewestVM' в вышеупомянутой политике масштабирования.

## <a name="modifying-scale-in-policies"></a>Изменение политикмасштабирования масштабирования

Изменение политики масштабирования следует тому же процессу, что и применение политики масштабирования. Например, если в приведенном выше примере требуется изменить политику с 'OldestVM' на 'NewestVM', вы можете сделать это:

### <a name="azure-portal"></a>Портал Azure

Можно изменить политику масштабирования существующей шкалы, установленную через портал Azure. 
 
1. В существующем наборе виртуальной шкалы машин выберите **масштабирование** из меню слева.
1. Выберите вкладку **«Политика масштабирования».**
1. Выберите политику масштабирования из выпадения.
1. По завершении нажмите кнопку **Сохранить**. 

### <a name="using-api"></a>С помощью API

Выполните PUT по виртуальному масштабу машины, установленную с помощью API 2019-03-01:

```
PUT
https://management.azure.com/subscriptions/<sub-id>/resourceGroups/<myRG>/providers/Microsoft.Compute/virtualMachineScaleSets/<myVMSS>?api-version=2019-03-01 

{ 
"location": "<VMSS location>", 
    "properties": { 
        "scaleInPolicy": {  
            "rules": ["NewestVM"]  
        } 
    }    
}
```
### <a name="azure-powershell"></a>Azure PowerShell

Обновление политики масштабирования существующего набора масштабов:

```azurepowershell-interactive
Update-AzVmss `
 -ResourceGroupName "myResourceGroup" `
 -VMScaleSetName "myScaleSet" `
 -ScaleInPolicy “OldestVM”
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

Ниже приводится пример обновления политики масштабирования существующего набора масштабов: 

```azurecli-interactive
az vmss update \  
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --scale-in-policy OldestVM
```

### <a name="using-template"></a>Использование шаблона

В шаблоне под "свойствами" измените шаблон ниже и передислоцируйте: 

```json
"scaleInPolicy": {  
      "rules": ["NewestVM"]  
} 
```

Тот же процесс будет применяться, если вы решите изменить 'NewestVM' на 'По умолчанию' или 'OldestVM'

## <a name="instance-protection-and-scale-in-policy"></a>Политика защиты и масштабирования инстанций

Виртуальные наборы масштаба машины обеспечивают два типа [защиты экземпляра:](./virtual-machine-scale-sets-instance-protection.md#types-of-instance-protection)

1. Защита от масштабирования
2. Защита от масштабных действий

Защищенная виртуальная машина не удаляется через действие масштабирования, независимо от применяемой политики масштабирования. Например, если VM_0 (самый старый VM в наборе масштабов) защищен от масштабирования, а набор масштабов включен в политику "OldestVM", VM_0 не будет рассматриваться как масштабирование, даже если это самый старый VM в наборе масштабов. 

Защищенная виртуальная машина может быть удалена вручную пользователем в любое время, независимо от политики масштабирования, включенной в наборе масштабов. 

## <a name="usage-examples"></a>Примеры использования 

Приведенные ниже примеры демонстрируют, как виртуальный набор масштабов машины выберет виртуальные компьютеры для удаления при срабатывании события масштабирования. Виртуальные машины с самым высоким идентизацией экземпляра считаются новейшими VMs в наборе масштаба, а Виртуальные с наименьшими идентизациями экземпляра считаются самыми старыми виртуальными машинами в наборе масштабов. 

### <a name="oldestvm-scale-in-policy"></a>Старейшая политика масштабирования VM

| Событие                 | Идоты экземпляров в зоне1  | Иты экземпляра в зоне2  | Иты экземпляра в зоне3  | Масштабирование                                                                                                               |
|-----------------------|------------------------|------------------------|------------------------|----------------------------------------------------------------------------------------------------------------------------------|
| Initial               | 3, 4, 5, 10            | 2, 6, 9, 11            | 1, 7, 8                |                                                                                                                                  |
| Масштабирование              | 3, 4, 5, 10            | ***2,*** 6, 9, 11      | 1, 7, 8                | Выберите между Зоной 1 и 2, хотя зона 3 имеет старейший VM. Удалите VM2 из зоны 2, так как это самый старый VM в этой зоне.   |
| Масштабирование              | ***3,*** 4, 5, 10      | 6, 9, 11               | 1, 7, 8                | Выберите Зону 1, несмотря на то, что зона 3 имеет старейший VM. Удалите VM3 из зоны 1, так как это самый старый VM в этой зоне.                  |
| Масштабирование              | 4, 5, 10               | 6, 9, 11               | ***1,*** 7, 8          | Зоны сбалансированы. Удалите VM1 в зоне 3, так как он является старейшим VM в наборе масштаба.                                               |
| Масштабирование              | ***4***, 5, 10         | 6, 9, 11               | 7, 8                   | Выберите между Зоной 1 и Зоной 2. Удалите VM4 в зоне 1, так как он является старейшим VM в двух зонах.                              |
| Масштабирование              | 5, 10                  | ***6,*** 9, 11         | 7, 8                   | Выберите Зону 2, несмотря на то, что зона 1 имеет старейший VM. Удалите VM6 в зоне 1, так как он является старейшим VM в этой зоне.                    |
| Масштабирование              | ***5***, 10            | 9, 11                  | 7, 8                   | Зоны сбалансированы. Удалите VM5 в зоне 1, так как он является старейшим VM в наборе масштаба.                                                |

Для незональных виртуальных наборов масштабов машин политика выбирает старейший VM по шкале, установленной для удаления. Любой "защищенный" VM будет пропущен для удаления.

### <a name="newestvm-scale-in-policy"></a>Новейшая политика масштабирования VM

| Событие                 | Идоты экземпляров в зоне1  | Иты экземпляра в зоне2  | Иты экземпляра в зоне3  | Масштабирование                                                                                                               |
|-----------------------|------------------------|------------------------|------------------------|----------------------------------------------------------------------------------------------------------------------------------|
| Initial               | 3, 4, 5, 10            | 2, 6, 9, 11            | 1, 7, 8                |                                                                                                                                  |
| Масштабирование              | 3, 4, 5, 10            | 2, 6, 9, ***11***      | 1, 7, 8                | Выберите между Зоной 1 и 2. Удалите VM11 из зоны 2, так как это новейший VM через две зоны.                                |
| Масштабирование              | 3, 4, 5, ***10***      | 2, 6, 9                | 1, 7, 8                | Выберите зону 1, поскольку она имеет больше vMs, чем две другие зоны. Удалите VM10 из зоны 1, так как это новейший VM в этой зоне.          |
| Масштабирование              | 3, 4, 5                | 2, 6, ***9***          | 1, 7, 8                | Зоны сбалансированы. Удалите VM9 в зоне 2, так как это новейший VM в наборе масштаба.                                                |
| Масштабирование              | 3, 4, 5                | 2, 6                   | 1, 7, ***8***          | Выберите между зоной 1 и зоной 3. Удалите VM8 в зоне 3, так как это новейший VM в этой зоне.                                      |
| Масштабирование              | 3, 4, ***5***          | 2, 6                   | 1, 7                   | Выберите зону 1, несмотря на то, что зона 3 имеет новейший VM. Удалите VM5 в зоне 1, так как это новейший VM в этой зоне.                    |
| Масштабирование              | 3, 4                   | 2, 6                   | 1, ***7***             | Зоны сбалансированы. Удалите VM7 в зоне 3, так как это новейший VM в наборе масштаба.                                                |

Для незональных виртуальных наборов масштабов машин политика выбирает новейший VM по шкале, установленной для удаления. Любой "защищенный" VM будет пропущен для удаления. 

## <a name="troubleshoot"></a>Устранение неполадок

1. Неспособность включить scaleInPolicy Если вы получаете ошибку 'BadRequest' с сообщением об ошибке о том, что "не удалось найти участника 'scaleInPolicy' на объекте типа 'свойства', то проверьте версию API, используемую для виртуального набора масштабов машины. Для этой функции требуется версия API 2019-03-01 или выше.

2. Неправильный выбор VMs для масштабирования в ссылке на приведенные выше примеры. Если ваш виртуальный набор масштабов машины является зональным развертыванием, политика масштабирования применяется сначала к несбалансированным зонам, а затем к шкале, установленной после того, как она будет сбалансирована зоной. Если порядок масштабирования не согласуется с приведенными выше примерами, выработайте запрос с командой, установленной виртуальной шкалой машины, для устранения неполадок.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [развертывать приложение](virtual-machine-scale-sets-deploy-app.md) в масштабируемых наборах виртуальных машин.