---
title: Автоматическое обновление изображений ОС с наборами виртуальных машин Azure
description: Узнайте, как автоматически обновить изображение ОС на экземплярах VM в наборе масштабов
author: mimckitt
tags: azure-resource-manager
ms.service: virtual-machine-scale-sets
ms.topic: conceptual
ms.date: 04/14/2020
ms.author: mimckitt
ms.openlocfilehash: ee6a25ac5a4cc7de8b8340afb186d170cc147a38
ms.sourcegitcommit: d6e4eebf663df8adf8efe07deabdc3586616d1e4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/15/2020
ms.locfileid: "81393791"
---
# <a name="azure-virtual-machine-scale-set-automatic-os-image-upgrades"></a>Автоматические обновления образа ОС масштабируемого набора виртуальных машин Azure

Включение автоматического обновления образа ОС в масштабируемом наборе помогает обновить управление путем безопасного автоматического обновления диска ОС для всех экземпляров в масштабируемом наборе.

Автоматическое обновление ОС имеет следующие характеристики:

- После настройки последний образ ОС, опубликованный издателем, автоматически применяется к масштабируемому набору без вмешательства пользователя.
- Обновляет пакеты экземпляров в подвижном порядке каждый раз, когда новое изображение публикуется издателем.
- Интегрируется с пробами работоспособности приложения и [расширения работоспособности приложения](virtual-machine-scale-sets-health-extension.md).
- Работает для всех размеров VM, а также для Windows и Linux изображений.
- Автоматические обновления можно в любое время отключить (обновление ОС также можно инициировать вручную).
- Диск ОС виртуальной машины заменяется новым диском ОС с последней версией образа. Запускаются настраиваемые расширения и сценарии пользовательских данных, а сохраненные диски данных сохраняются.
- Поддерживается [расширение виртуализации](virtual-machine-scale-sets-extension-sequencing.md).
- Автоматическое обновление изображения ОС может быть включено в масштабе набора любого размера.

## <a name="how-does-automatic-os-image-upgrade-work"></a>Как работает автоматическое обновление образа ОС?

Обновление выполняется путем замены диска операционной системы виртуальной машины на диск, созданный с использованием последней версии образа. Настроенные расширения и скрипты пользовательских данных выполняются на диске ОС, а сохраненные диски данных сохраняются. Чтобы свести к минимуму время простоя приложений, обновления выполняются для пакетов и в любое время обновляется не более чем 20 % масштабируемого набора. Вы также можете интегрировать проверку работоспособности приложений Azure Load Balancer или [расширение работоспособности приложения](virtual-machine-scale-sets-health-extension.md). Рекомендуем добавить пакет пульса приложения и проверять успешность обновления для каждого пакета в процессе обновления.

Процесс обновления работает следующим образом:
1. Перед началом процесса обновления оркестратор убедится, что не более чем 20 % экземпляров во всем масштабируемом наборе являются неработоспособными (по любой причине).
2. Оркестр обновления определяет пакет экземпляров VM для обновления, при этом любая партия, имеющая максимум 20% от общего количества экземпляров, при условии минимального размера партии одной виртуальной машины.
3. Диск ОС выбранной партии экземпляров VM заменяется новым диском ОС, созданным из последнего изображения. Все указанные расширения и конфигурации в модели набора масштаба применяются к обновленному экземпляру.
4. Если масштабируемые наборы настроены с помощью проверок работоспособности приложения или расширения работоспособности приложения, обновление останавливается на 5 минут, чтобы экземпляр стал работоспособным, прежде чем перейти к обновлению нового пакета. Если экземпляр не восстанавливает свое здоровье через 5 минут после обновления, то по умолчанию предыдущий диск ОС для экземпляра восстанавливается.
5. Оркестратор обновления также отслеживает процент экземпляров, которые становятся неработоспособными после обновления. Обновление будет прервано, если более чем 20 % обновленных экземпляров утрачивают работоспособность во время обновления.
6. Описанный выше процесс продолжается, пока все экземпляры в масштабируемом наборе не будут обновлены.

Оркестратор обновления ОС масштабируемого набора проверяет общее состояние работоспособности масштабируемого набора перед обновлением каждого пакета. При обновлении пакета может быть выполнено другое параллельное плановое или внеплановое обслуживание, которое может повлиять на работоспособность экземпляров масштабируемого набора. В таких случаях более 20 % экземпляров масштабируемого набора становятся неработоспособными, обновление масштабируемого набора останавливается в конце текущего пакета.

## <a name="supported-os-images"></a>Поддерживаемые образы ОС
В настоящее время поддерживаются только определенные образы платформ ОС. Пользовательская поддержка изображений доступна [в предварительном просмотре](virtual-machine-scale-sets-automatic-upgrade.md#automatic-os-image-upgrade-for-custom-images-preview) для пользовательских изображений через [Shared Image Gallery.](shared-image-galleries.md)

Следующая платформа SKUs в настоящее время поддерживается (и больше добавляются периодически):

| Издатель               | Предложение ОС      |  Sku               |
|-------------------------|---------------|--------------------|
| Canonical               | UbuntuServer  | 16.04-LTS          |
| Canonical               | UbuntuServer  | 18.04-LTS          |
| Rogue Wave (OpenLogic)  | CentOS        | 7.5                |
| CoreOS                  | CoreOS        | объем стабилен             |
| Корпорация Майкрософт   | WindowsServer | 2012-R2-Datacenter |
| Корпорация Майкрософт   | WindowsServer | 2016-Datacenter    |
| Корпорация Майкрософт   | WindowsServer | 2016-Datacenter-Smalldisk |
| Корпорация Майкрософт   | WindowsServer | 2016-Datacenter-with-Containers |
| Корпорация Майкрософт   | WindowsServer | 2019-Datacenter |
| Корпорация Майкрософт   | WindowsServer | 2019-Центр-Smalldisk |
| Корпорация Майкрософт   | WindowsServer | 2019-Datacenter-with-Containers |
| Корпорация Майкрософт   | WindowsServer | Центр обработки данных-Core-1903-с-контейнеры-малый диск |


## <a name="requirements-for-configuring-automatic-os-image-upgrade"></a>Требования к настройке автоматического обновления образа ОС

- Свойство *версии* изображения должно быть установлено до *последней.*
- Используйте проверки работоспособности приложений или [расширения работоспособности приложения](virtual-machine-scale-sets-health-extension.md) для масштабируемых наборов, не связанных с Service Fabric.
- Используйте версию Compute API 2018-10-01 или выше.
- Убедитесь, что внешние ресурсы, указанные в модели масштабируемого набора, доступны и обновлены. Примеры включают универсальный код ресурса (URI) SAS для начальной загрузки полезных данных в свойствах расширения виртуальной машины, полезные данные в учетной записи хранения, ссылки на секреты в модели и многое другое.
- Для наборов масштаба с использованием виртуальных машин Windows, начиная с версии Compute API 2019-03-01, свойство *virtualMachineProfile.osProfile.windowsConfiguration.enableAutomaticUpdates* свойство должно быть установлено *ложным* в определении модели, установленной шкалой. Вышеупомянутое свойство позволяет в-VM обновления, где "Обновление Windows" применяется операционная система патчи без замены диска ОС. С автоматическим обновлением изображений ОС включен в наборе масштаба, дополнительное обновление через "Обновление Windows" не требуется.

### <a name="service-fabric-requirements"></a>Требования к сервисной ткани

Если вы используете Service Fabric, убедитесь, что следующие условия выполнены:
-   Сервис Ткань [прочность уровня](../service-fabric/service-fabric-cluster-capacity.md#the-durability-characteristics-of-the-cluster) серебра или золота, а не бронза.
-   Расширение Service Fabric в определении модели набора масштаба должно иметь TypeHandlerVersion 1.1 или выше.
-   Уровень долговечности должен быть одинаковым при кластере Service Fabric и расширении Service Fabric в определении модели набора масштаба.

Убедитесь, что параметры долговечности не совпадают с кластером Service Fabric и расширением Service Fabric, так как несоответствие приведет к ошибкам обновления. Уровни долговечности могут быть изменены в руководящих принципах, изложенных на [этой странице.](../service-fabric/service-fabric-cluster-capacity.md#changing-durability-levels)


## <a name="automatic-os-image-upgrade-for-custom-images-preview"></a>Автоматическое обновление изображения ОС для пользовательских изображений (предварительный просмотр)

> [!IMPORTANT]
> Автоматическое обновление изображения ОС для пользовательских изображений в настоящее время находится в публичном предварительном просмотре. Процедура отказа в использовании общедоступной функциональности предварительного просмотра, описанной ниже.
> Предварительная версия предоставляется без соглашения об уровне обслуживания. Мы не рекомендуем использовать ее в рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены.
> Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

Автоматическое обновление изображения ОС доступно в предварительном просмотре для пользовательских изображений, развернутых через [Shared Image Gallery.](shared-image-galleries.md) Другие пользовательские изображения не поддерживаются для автоматического обновления изображений ОС.

Включение функции предварительного просмотра требует единовременного отказа в функции *AutomaticOSUpgradeWithGalleryImage* за подписку, как описано ниже.

### <a name="rest-api"></a>REST API
В следующем примере описывается, как включить предварительный просмотр подписки:

```
POST on `/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/AutomaticOSUpgradeWithGalleryImage/register?api-version=2015-12-01`
```

Регистрация функций может занять до 15 минут. Чтобы проверить статус регистрации:

```
GET on `/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/AutomaticOSUpgradeWithGalleryImage?api-version=2015-12-01`
```

После того, как функция была зарегистрирована для вашей подписки, завершите процесс отказа, распространяя изменения в поставщике ресурсов Compute.

```
POST on `/subscriptions/{subscriptionId}/providers/Microsoft.Compute/register?api-version=2019-12-01`
```

### <a name="azure-powershell"></a>Azure PowerShell
Используйте cmdlet [Register-AzProviderFeature,](/powershell/module/az.resources/register-azproviderfeature) чтобы включить предварительный просмотр подписки.

```azurepowershell-interactive
Register-AzProviderFeature -FeatureName AutomaticOSUpgradeWithGalleryImage -ProviderNamespace Microsoft.Compute
```

Регистрация функций может занять до 15 минут. Чтобы проверить статус регистрации:

```azurepowershell-interactive
Get-AzProviderFeature -FeatureName AutomaticOSUpgradeWithGalleryImage -ProviderNamespace Microsoft.Compute
```

После того, как функция была зарегистрирована для вашей подписки, завершите процесс отказа, распространяя изменения в поставщике ресурсов Compute.

```azurepowershell-interactive
Register-AzResourceProvider -ProviderNamespace Microsoft.Compute
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
Используйте [регистр функций az,](/cli/azure/feature#az-feature-register) чтобы включить предварительный просмотр подписки.

```azurecli-interactive
az feature register --namespace Microsoft.Compute --name AutomaticOSUpgradeWithGalleryImage
```

Регистрация функций может занять до 15 минут. Чтобы проверить статус регистрации:

```azurecli-interactive
az feature show --namespace Microsoft.Compute --name AutomaticOSUpgradeWithGalleryImage
```

После того, как функция была зарегистрирована для вашей подписки, завершите процесс отказа, распространяя изменения в поставщике ресурсов Compute.

```azurecli-interactive
az provider register --namespace Microsoft.Compute
```

### <a name="additional-requirements-for-custom-images"></a>Дополнительные требования к пользовательским изображениям
- Процесс отказа, описанный выше, должен быть завершен только один раз за подписку. После завершения выбора, автоматическое обновление ОС может быть включено для любого масштаба, установленного в этой подписке.
- Общая галерея изображений может быть в любой подписке и не требует, чтобы она была выбрана отдельно. Только шкала набора подписки требует функции выбора в.
- Процесс конфигурации для автоматического обновления изображения ОС одинаков для всех наборов масштабов, как описано в [разделе конфигурации](virtual-machine-scale-sets-automatic-upgrade.md#configure-automatic-os-image-upgrade) этой страницы.
- Масштаб наборы экземпляров, настроенных для автоматического обновления изображений ОС, будут обновлены до последней версии изображения Общей галереи изображений при публикации и [воспроизведении](shared-image-galleries.md#replication) новой версии изображения в регионе этого набора масштаба. Если новое изображение не будет реплицировано в область, где используется шкала, экземпляры набора масштабов не будут обновлены до последней версии. Региональная репликация изображений позволяет управлять развертыванием нового изображения для наборов масштабов.
- Новая версия изображения не должна быть исключена из последней версии для этого изображения галереи. Версии изображений, исключенные из последней версии изображения галереи, не выкатываются в масштаб, установленный с помощью автоматического обновления изображения ОС.

> [!NOTE]
>Это может занять до 2 часов для набора масштаба, чтобы получить первое развертывание изображения после набора масштаба настроен для автоматического обновления ОС. Это одноразовая задержка для набора масштабов. Последующие развертывания изображений применяются к набору масштаба без этой задержки.


## <a name="configure-automatic-os-image-upgrade"></a>Настройка автоматического обновления образа ОС
Чтобы настроить автоматическое обновление образа ОС, убедитесь, что свойство *automaticOSUpgradePolicy.enableAutomaticOSUpgrade* установлено как *true* в определении модели масштабируемого набора.

### <a name="rest-api"></a>REST API
В следующем примере описано, как настроить автоматические обновления ОС в модели масштабируемого набора.

```
PUT or PATCH on `/subscriptions/subscription_id/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachineScaleSets/myScaleSet?api-version=2019-12-01`
```

```json
{
  "properties": {
    "upgradePolicy": {
      "automaticOSUpgradePolicy": {
        "enableAutomaticOSUpgrade":  true
      }
    }
  }
}
```

### <a name="azure-powershell"></a>Azure PowerShell
Используйте смдlet [Update-AzVmss](/powershell/module/az.compute/update-azvmss) для настройки автоматического обновления изображений ОС для набора масштабов. Следующий пример настраивает автоматические обновления для набора масштаба под названием *myScaleSet* в группе ресурсов под названием *myResourceGroup:*

```azurepowershell-interactive
Update-AzVmss -ResourceGroupName "myResourceGroup" -VMScaleSetName "myScaleSet" -AutomaticOSUpgrade $true
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
Используйте [обновление az vmss](/cli/azure/vmss#az-vmss-update) для настройки автоматического обновления изображений ОС для набора масштабов. Использование Azure CLI 2.0.47 или более поздней версии Следующий пример настраивает автоматические обновления для набора масштаба под названием *myScaleSet* в группе ресурсов под названием *myResourceGroup:*

```azurecli-interactive
az vmss update --name myScaleSet --resource-group myResourceGroup --set UpgradePolicy.AutomaticOSUpgradePolicy.EnableAutomaticOSUpgrade=true
```

## <a name="using-application-health-probes"></a>Использование проверок работоспособности приложений

Во время обновления ОС экземпляры виртуальных машин в масштабируемом наборе обновляются по одному пакету. Обновление должно продолжаться, только если приложение клиента работоспособно на обновленных экземплярах виртуальных машин. Мы рекомендуем настроить приложение таким образом, чтобы оно сообщало о работоспособности в модуль обновления ОС масштабируемого набора. По умолчанию при обновлении ОС платформа анализирует состояние энергопотребления виртуальной машины и состояние подготовки расширений, чтобы определить, является ли экземпляр виртуальной машины работоспособным после обновления. Во время обновления ОС экземпляра виртуальной машины диск ОС экземпляра заменяется новым диском на основе последней версии образа. После обновления ОС настроенные расширения запускаются на этих виртуальных машинах. Приложение считается работоспособным, только если все расширения в экземпляре успешно подготовлены.

Для масштабируемого набора можно дополнительно настроить проверки работоспособности приложений, с помощью которых платформа сможет получать точную информацию о текущем состоянии приложения. Проверки работоспособности приложения — это проверки пользовательского балансировщика нагрузки, которые используются в качестве сообщения о работоспособности. Приложение, работающее на экземпляре виртуальной машины из масштабируемого набора, может отвечать на внешние HTTP- или TCP-запросы, указывающие на его работоспособность. Дополнительные сведения о работе проверок пользовательского балансировщика нагрузки см. в статье [Проверки балансировщика нагрузки](../load-balancer/load-balancer-custom-probe-overview.md). Зонды работоспособности приложений не поддерживаются для наборов масштабов Service Fabric. Для не связанных с Service Fabric масштабируемых наборов требуются или проверки работоспособности приложения Load Balancer, или [расширение работоспособности приложения](virtual-machine-scale-sets-health-extension.md).

Если масштабируемый набор настроен для использования нескольких групп размещения, необходимо использовать проверки с [балансировщиком нагрузки уровня "Стандартный"](https://docs.microsoft.com/azure/load-balancer/load-balancer-standard-overview).

### <a name="configuring-a-custom-load-balancer-probe-as-application-health-probe-on-a-scale-set"></a>Настройка пользовательской проверки балансировщика нагрузки в качестве проверки работоспособности приложения в масштабируемом наборе
Мы рекомендуем явно создать проверку балансировщика нагрузки на работоспособность масштабируемого набора. Вы можете использовать одну конечную точку для имеющейся пробы HTTP или TCP, но для пробы работоспособности может потребоваться подход, отличный от традиционного для пробы подсистемы балансировки нагрузки. Например, при традиционной проверке подсистемы балансировки нагрузки может вернуться сообщение о нерабочем состоянии, если нагрузка на экземпляр слишком высока. Такая проверка может оказаться непригодной для определения работоспособности экземпляра во время автоматического обновления ОС. Настройте для проверки высокую частоту (менее двух минут).

Проверка балансировщика нагрузки может быть указана в параметре *networkProfile* масштабируемого набора и может быть связана либо с внутренним, либо с общедоступным балансировщиком нагрузки следующим образом:

```json
"networkProfile": {
  "healthProbe" : {
    "id": "[concat(variables('lbId'), '/probes/', variables('sshProbeName'))]"
  },
  "networkInterfaceConfigurations":
  ...
}
```

> [!NOTE]
> При использовании автоматического обновления ОС с помощью Service Fabric домен обновления развертывает новый образ ОС, чтобы обеспечить высокий уровень доступности для служб, работающих в Service Fabric. Для использования автоматических обновлений ОС в Service Fabric ваш кластер должен быть настроен на использование уровня надежности Silver или выше. Дополнительные сведения о характеристиках устойчивости кластера Service Fabric см. в [этой документации](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster).

### <a name="keep-credentials-up-to-date"></a>Держите учетные данные в актуальном состоянии
Если набор масштабов использует какие-либо учетные данные для доступа к внешним ресурсам, например, расширение VM, настроенное для использования маркера SAS для учетной записи хранилища, убедитесь, что учетные данные обновляются. Если срок действия каких-либо учетных данных, включая сертификаты и токены, истек, обновление завершится неудачей, и первая партия VMs останется в неисправном состоянии.

В случае сбоя аутентификации ресурса рекомендуем выполнить следующие шаги по восстановлению виртуальных машин и повторному включению автоматического обновления ОС.

* Повторно создайте маркер (или любые другие учетные данные), переданный в ваши расширения.
* Убедитесь, что все учетные данные, используемые внутри виртуальной машины для взаимодействия с внешними сущностями, обновлены.
* Обновите расширения в модели масштабируемого набора с новыми маркерами.
* Разверните обновленный масштабируемый набор, в котором будут обновлены все экземпляры виртуальных машин, включая сбойные.

## <a name="using-application-health-extension"></a>Использование расширения "Работоспособность приложения"
Расширение "Работоспособность приложения" развертывается внутри экземпляра масштабируемого набора виртуальных машин и сообщает о состоянии работоспособности виртуальной машины изнутри этого экземпляра. Вы можете настроить расширение так, чтобы оно проверяло конечную точку приложения и обновляло состояние приложения на этом экземпляре. Azure проверяет состояние этого экземпляра, чтобы определить, подходит ли экземпляр для операций обновления.

Так как расширение сообщает о состоянии работоспособности из виртуальной машины, это расширение можно применять в ситуациях, когда внешние пробы, например, пробы работоспособности приложений (использующие пользовательские [пробы](../load-balancer/load-balancer-custom-probe-overview.md) Azure Load Balancer), не могут использоваться.

Существует несколько способов развертывания расширения "Работоспособность приложения" в масштабируемые наборы, которые описаны в [этой статье](virtual-machine-scale-sets-health-extension.md#deploy-the-application-health-extension).

## <a name="get-the-history-of-automatic-os-image-upgrades"></a>Получение журнала автоматического обновления образа ОС
Вы можете проверить журнал последнего обновления ОС масштабируемого набора с помощью Azure PowerShell, Azure CLI 2.0 или интерфейсов REST API. Можно просмотреть журнал для последних пяти попыток обновлений операционной системы в течение последних двух месяцев.

### <a name="rest-api"></a>REST API
Следующий пример использует [REST API](/rest/api/compute/virtualmachinescalesets/getosupgradehistory) для проверки статуса набора шкалы под названием *myScaleSet* в группе ресурсов под названием *myResourceGroup:*

```
GET on `/subscriptions/subscription_id/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachineScaleSets/myScaleSet/osUpgradeHistory?api-version=2019-12-01`
```

Вызов GET возвращает подобные свойства:

```json
{
    "value": [
        {
            "properties": {
        "runningStatus": {
          "code": "RollingForward",
          "startTime": "2018-07-24T17:46:06.1248429+00:00",
          "completedTime": "2018-04-21T12:29:25.0511245+00:00"
        },
        "progress": {
          "successfulInstanceCount": 16,
          "failedInstanceCount": 0,
          "inProgressInstanceCount": 4,
          "pendingInstanceCount": 0
        },
        "startedBy": "Platform",
        "targetImageReference": {
          "publisher": "MicrosoftWindowsServer",
          "offer": "WindowsServer",
          "sku": "2016-Datacenter",
          "version": "2016.127.20180613"
        },
        "rollbackInfo": {
          "successfullyRolledbackInstanceCount": 0,
          "failedRolledbackInstanceCount": 0
        }
      },
      "type": "Microsoft.Compute/virtualMachineScaleSets/rollingUpgrades",
      "location": "westeurope"
    }
  ]
}
```

### <a name="azure-powershell"></a>Azure PowerShell
Используйте командлет [Get-AzVmss](/powershell/module/az.compute/get-azvmss), чтобы проверить журнал обновлений ОС для масштабируемого набора. В следующем примере подробно описано, как вы просматриваете статус обновления ОС для набора масштабов под названием *myScaleSet* в группе ресурсов под названием *myResourceGroup:*

```azurepowershell-interactive
Get-AzVmss -ResourceGroupName "myResourceGroup" -VMScaleSetName "myScaleSet" -OSUpgradeHistory
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
Используйте командлет [az vmss get-os-upgrade-history](/cli/azure/vmss#az-vmss-get-os-upgrade-history), чтобы проверить журнал обновления ОС масштабируемого набора. Использование Azure CLI 2.0.47 или более поздней версии В следующем примере подробно описано, как вы просматриваете статус обновления ОС для набора масштабов под названием *myScaleSet* в группе ресурсов под названием *myResourceGroup:*

```azurecli-interactive
az vmss get-os-upgrade-history --resource-group myResourceGroup --name myScaleSet
```

## <a name="how-to-get-the-latest-version-of-a-platform-os-image"></a>Как получить последнюю версию образа платформы ОС?

Вы можете получить доступные версии изображений для автоматического обновления ОС поддерживается SKUs, используя приведенные ниже примеры:

### <a name="rest-api"></a>REST API
```
GET on `/subscriptions/subscription_id/providers/Microsoft.Compute/locations/{location}/publishers/{publisherName}/artifacttypes/vmimage/offers/{offer}/skus/{skus}/versions?api-version=2019-12-01`
```

### <a name="azure-powershell"></a>Azure PowerShell
```azurepowershell-interactive
Get-AzVmImage -Location "westus" -PublisherName "Canonical" -Offer "UbuntuServer" -Skus "16.04-LTS"
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
```azurecli-interactive
az vm image list --location "westus" --publisher "Canonical" --offer "UbuntuServer" --sku "16.04-LTS" --all
```

## <a name="manually-trigger-os-image-upgrades"></a>Ручной запуск обновлений изображений ОС
С автоматическим обновлением изображения ОС включен в наборе масштаба, вам не нужно вручную запускать обновления изображений в наборе масштаба. Оркестр обновления ОС автоматически применяет последнюю доступную версию изображений к набору экземпляров без ручного вмешательства.

В конкретных случаях, когда вы не хотите ждать, пока оркестратор применит последнее изображение, вы можете запустить обновление изображения ОС вручную, используя приведенные ниже примеры.

> [!NOTE]
> Ручной триггер обновления изображений ОС не обеспечивает возможности автоматического отката. Если экземпляр не восстанавливает свое здоровье после операции обновления, его предыдущий диск ОС не может быть восстановлен.

### <a name="rest-api"></a>REST API
Используйте вызов [Start OS Upgrade](/rest/api/compute/virtualmachinescalesetrollingupgrades/startosupgrade) API, чтобы начать обновление подвижного состава, чтобы переместить все экземпляры виртуального набора масштабов машины в последнюю доступную версию ОС изображений. Случаи, которые уже работают с последней доступной версией ОС, не затрагиваются. В следующем примере подробно описано, как можно начать обновление подвижной ОС в масштабе под названием *myScaleSet* в группе ресурсов под названием *myResourceGroup:*

```
POST on `/subscriptions/subscription_id/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachineScaleSets/myScaleSet/osRollingUpgrade?api-version=2019-12-01`
```

### <a name="azure-powershell"></a>Azure PowerShell
Используйте [cmdlet Start-AzVmssRollingOSUpgrade](/powershell/module/az.compute/Start-AzVmssRollingOSUpgrade) для проверки истории обновления ОС для набора масштабов. В следующем примере подробно описано, как можно начать обновление подвижной ОС в масштабе под названием *myScaleSet* в группе ресурсов под названием *myResourceGroup:*

```azurepowershell-interactive
Start-AzVmssRollingOSUpgrade -ResourceGroupName "myResourceGroup" -VMScaleSetName "myScaleSet"
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
Используйте [az vmss прокатки обновления начать,](/cli/azure/vmss/rolling-upgrade#az-vmss-rolling-upgrade-start) чтобы проверить историю обновления ОС для вашего набора масштаба. Использование Azure CLI 2.0.47 или более поздней версии В следующем примере подробно описано, как можно начать обновление подвижной ОС в масштабе под названием *myScaleSet* в группе ресурсов под названием *myResourceGroup:*

```azurecli-interactive
az vmss rolling-upgrade start --resource-group "myResourceGroup" --name "myScaleSet" --subscription "subscriptionId"
```

## <a name="deploy-with-a-template"></a>Развертывание с помощью шаблона

Вы можете использовать шаблоны для развертывания масштабируемого набора с автоматическими обновлениями ОС для поддерживаемых образов, таких как [Ubuntu 16.04-LTS](https://github.com/Azure/vm-scale-sets/blob/master/preview/upgrade/autoupdate.json).

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fvm-scale-sets%2Fmaster%2Fpreview%2Fupgrade%2Fautoupdate.json" target="_blank"><img src="https://azuredeploy.net/deploybutton.png"/></a>

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные примеры использования автоматических обновлений ОС с масштабируемыми наборами см. в [репозитории GitHub](https://github.com/Azure/vm-scale-sets/tree/master/preview/upgrade).
