---
title: Автоматические обновления образа ОС при использовании масштабируемых наборов виртуальных машин Azure | Документация Майкрософт
description: Узнайте, как выполнять автоматическое обновление образа операционной системы на экземплярах виртуальных машин в масштабируемом наборе
services: virtual-machine-scale-sets
documentationcenter: ''
author: mayanknayar
manager: drewm
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/25/2019
ms.author: manayar
ms.openlocfilehash: 007f2801efed8da4964808056563418dec7f64d5
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60328822"
---
# <a name="azure-virtual-machine-scale-set-automatic-os-image-upgrades"></a>Автоматические обновления образа ОС масштабируемого набора виртуальных машин Azure

Включение автоматического обновления образа ОС в масштабируемом наборе помогает обновить управление путем безопасного автоматического обновления диска ОС для всех экземпляров в масштабируемом наборе.

Автоматическое обновление ОС имеет следующие характеристики:

- После настройки последний образ ОС, опубликованный издателем, автоматически применяется к масштабируемому набору без вмешательства пользователя.
- Пакеты экземпляров последовательно обновляются каждый раз, когда издатель публикует новый образ платформы.
- Интегрируется с пробами работоспособности приложения и [расширения работоспособности приложения](virtual-machine-scale-sets-health-extension.md).
- Эта функция подходит для всех размеров виртуальных машин, а также для образов платформ Windows и Linux.
- Автоматические обновления можно в любое время отключить (обновление ОС также можно инициировать вручную).
- Диск ОС виртуальной машины заменяется новым диском ОС с последней версией образа. Запускаются настраиваемые расширения и сценарии пользовательских данных, а сохраненные диски данных сохраняются.
- Поддерживается [расширение виртуализации](virtual-machine-scale-sets-extension-sequencing.md).

## <a name="how-does-automatic-os-image-upgrade-work"></a>Как работает автоматическое обновление образа ОС?

Обновление выполняется путем замены диска операционной системы виртуальной машины на диск, созданный с использованием последней версии образа. Настроенные расширения и скрипты пользовательских данных выполняются на диске ОС, а сохраненные диски данных сохраняются. Чтобы свести к минимуму время простоя приложений, обновления выполняются для пакетов и в любое время обновляется не более чем 20 % масштабируемого набора. Вы также можете интегрировать проверку работоспособности приложений Azure Load Balancer или [расширение работоспособности приложения](virtual-machine-scale-sets-health-extension.md). Рекомендуем добавить пакет пульса приложения и проверять успешность обновления для каждого пакета в процессе обновления.

Процесс обновления работает следующим образом:
1. Перед началом процесса обновления оркестратор убедится, что не более чем 20 % экземпляров во всем масштабируемом наборе являются неработоспособными (по любой причине).
2. Этот оркестратор обновления определит пакет экземпляров виртуальных машин для обновления. При этом любой пакет должен содержать максимум 20 % от общего количества экземпляров.
3. Диск ОС выбранного пакета экземпляров виртуальной машины заменяется новым диском ОС, созданным из последнего образа. Все указанные разрешения и конфигурации в модели масштабируемого набора применяются к обновленному экземпляру.
4. Если масштабируемые наборы настроены с помощью проверок работоспособности приложения или расширения работоспособности приложения, обновление останавливается на 5 минут, чтобы экземпляр стал работоспособным, прежде чем перейти к обновлению нового пакета.
5. Оркестратор обновления также отслеживает процент экземпляров, которые становятся неработоспособными после обновления. Обновление будет прервано, если более чем 20 % обновленных экземпляров утрачивают работоспособность во время обновления.
6. Описанный выше процесс продолжается, пока все экземпляры в масштабируемом наборе не будут обновлены.

Оркестратор обновления ОС масштабируемого набора проверяет общее состояние работоспособности масштабируемого набора перед обновлением каждого пакета. При обновлении пакета может быть выполнено другое параллельное плановое или внеплановое обслуживание, которое может повлиять на работоспособность экземпляров масштабируемого набора. В таких случаях более 20 % экземпляров масштабируемого набора становятся неработоспособными, обновление масштабируемого набора останавливается в конце текущего пакета.

## <a name="supported-os-images"></a>Поддерживаемые образы ОС
В настоящее время поддерживаются только определенные образы платформ ОС. Пользовательские образы в настоящее время не поддерживаются.

Сейчас поддерживаются следующие номера SKU (и периодически будут добавляться дополнительные):

| ИЗДАТЕЛЬ               | Предложение ОС      |  Sku               |
|-------------------------|---------------|--------------------|
| Canonical               | UbuntuServer  | 16.04-LTS          |
| Canonical               | UbuntuServer  | 18.04-LTS          |
| Rogue Wave (OpenLogic)  | CentOS        | 7.5                |
| CoreOS                  | CoreOS        | Stable             |
| Корпорация Майкрософт   | WindowsServer | 2012-R2-Datacenter |
| Корпорация Майкрософт   | WindowsServer | 2016-Datacenter    |
| Корпорация Майкрософт   | WindowsServer | 2016-Datacenter-Smalldisk |
| Корпорация Майкрософт   | WindowsServer | 2016-Datacenter-with-Containers |
| Корпорация Майкрософт   | WindowsServer | 2019-Datacenter |
| Корпорация Майкрософт   | WindowsServer | 2019-Datacenter-Smalldisk |
| Корпорация Майкрософт   | WindowsServer | 2019-Datacenter-with-Containers |


## <a name="requirements-for-configuring-automatic-os-image-upgrade"></a>Требования к настройке автоматического обновления образа ОС

- Для свойства *version* образа платформы следует установить значение *latest*.
- Используйте проверки работоспособности приложений или [расширения работоспособности приложения](virtual-machine-scale-sets-health-extension.md) для масштабируемых наборов, не связанных с Service Fabric.
- Убедитесь, что внешние ресурсы, указанные в модели масштабируемого набора, доступны и обновлены. Примеры включают универсальный код ресурса (URI) SAS для начальной загрузки полезных данных в свойствах расширения виртуальной машины, полезные данные в учетной записи хранения, ссылки на секреты в модели и многое другое.

## <a name="configure-automatic-os-image-upgrade"></a>Настройка автоматического обновления образа ОС
Чтобы настроить автоматическое обновление образа ОС, убедитесь, что свойство *automaticOSUpgradePolicy.enableAutomaticOSUpgrade* установлено как *true* в определении модели масштабируемого набора.

### <a name="rest-api"></a>REST API
В следующем примере описано, как настроить автоматические обновления ОС в модели масштабируемого набора.

```
PUT or PATCH on `/subscriptions/subscription_id/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachineScaleSets/myScaleSet?api-version=2018-10-01`
```

```json
{
  "properties": {
    "upgradePolicy": {
      "automaticOSUpgradePolicy": {
        "enableAutomaticOSUpgrade":  true
      }
    }
  }
}
```

### <a name="azure-powershell"></a>Azure PowerShell
Используйте командлет [Update-AzVmss](/powershell/module/az.compute/update-azvmss), чтобы проверить журнал обновлений ОС для масштабируемого набора. В следующем примере настраивается автоматическое обновление масштабируемого набора *myVMSS* в группе ресурсов *myResourceGroup*.

```azurepowershell-interactive
Update-AzVmss -ResourceGroupName "myResourceGroup" -VMScaleSetName "myScaleSet" -AutomaticOSUpgrade $true
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
Используйте командлет [az vmss update](/cli/azure/vmss#az-vmss-update), чтобы проверить журнал обновления ОС масштабируемого набора. Использование Azure CLI 2.0.47 или более поздней версии В следующем примере настраивается автоматическое обновление масштабируемого набора *myVMSS* в группе ресурсов *myResourceGroup*.

```azurecli-interactive
az vmss update --name myVMSS --resource-group myResourceGroup --set UpgradePolicy.AutomaticOSUpgradePolicy.EnableAutomaticOSUpgrade=true
```

## <a name="using-application-health-probes"></a>Использование проверок работоспособности приложений

Во время обновления ОС экземпляры виртуальных машин в масштабируемом наборе обновляются по одному пакету. Обновление должно продолжаться, только если приложение клиента работоспособно на обновленных экземплярах виртуальных машин. Мы рекомендуем настроить приложение таким образом, чтобы оно сообщало о работоспособности в модуль обновления ОС масштабируемого набора. По умолчанию при обновлении ОС платформа анализирует состояние энергопотребления виртуальной машины и состояние подготовки расширений, чтобы определить, является ли экземпляр виртуальной машины работоспособным после обновления. Во время обновления ОС экземпляра виртуальной машины диск ОС экземпляра заменяется новым диском на основе последней версии образа. После обновления ОС настроенные расширения запускаются на этих виртуальных машинах. Приложение считается работоспособным, только если все расширения в экземпляре успешно подготовлены.

Для масштабируемого набора можно дополнительно настроить проверки работоспособности приложений, с помощью которых платформа сможет получать точную информацию о текущем состоянии приложения. Проверки работоспособности приложения — это проверки пользовательского балансировщика нагрузки, которые используются в качестве сообщения о работоспособности. Приложение, работающее на экземпляре виртуальной машины из масштабируемого набора, может отвечать на внешние HTTP- или TCP-запросы, указывающие на его работоспособность. Дополнительные сведения о работе проверок пользовательского балансировщика нагрузки см. в статье [Проверки балансировщика нагрузки](../load-balancer/load-balancer-custom-probe-overview.md). Проверка работоспособности приложения не требуется для масштабируемых наборов Service Fabric, но настоятельно рекомендуется. Для не связанных с Service Fabric масштабируемых наборов требуются или проверки работоспособности приложения Load Balancer, или [расширение работоспособности приложения](virtual-machine-scale-sets-health-extension.md).

Если масштабируемый набор настроен для использования нескольких групп размещения, необходимо использовать проверки с [балансировщиком нагрузки уровня "Стандартный"](https://docs.microsoft.com/azure/load-balancer/load-balancer-standard-overview).

### <a name="configuring-a-custom-load-balancer-probe-as-application-health-probe-on-a-scale-set"></a>Настройка пользовательской проверки балансировщика нагрузки в качестве проверки работоспособности приложения в масштабируемом наборе
Мы рекомендуем явно создать проверку балансировщика нагрузки на работоспособность масштабируемого набора. Вы можете использовать одну конечную точку для имеющейся пробы HTTP или TCP, но для пробы работоспособности может потребоваться подход, отличный от традиционного для пробы подсистемы балансировки нагрузки. Например, при традиционной проверке подсистемы балансировки нагрузки может вернуться сообщение о нерабочем состоянии, если нагрузка на экземпляр слишком высока. Такая проверка может оказаться непригодной для определения работоспособности экземпляра во время автоматического обновления ОС. Настройте для проверки высокую частоту (менее двух минут).

Проверка балансировщика нагрузки может быть указана в параметре *networkProfile* масштабируемого набора и может быть связана либо с внутренним, либо с общедоступным балансировщиком нагрузки следующим образом:

```json
"networkProfile": {
  "healthProbe" : {
    "id": "[concat(variables('lbId'), '/probes/', variables('sshProbeName'))]"
  },
  "networkInterfaceConfigurations":
  ...
}
```

> [!NOTE]
> При использовании автоматического обновления ОС с помощью Service Fabric домен обновления развертывает новый образ ОС, чтобы обеспечить высокий уровень доступности для служб, работающих в Service Fabric. Для использования автоматических обновлений ОС в Service Fabric ваш кластер должен быть настроен на использование уровня надежности Silver или выше. Дополнительные сведения о характеристиках устойчивости кластера Service Fabric см. в [этой документации](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster).

### <a name="keep-credentials-up-to-date"></a>Поддержание актуальности учетных данных
Если ваш масштабируемый набор использует любые учетные данные для доступа к внешним ресурсам, например, если настроено расширение виртуальной машины, которое использует маркер SAS для учетной записи хранения, убедитесь, что учетные данные обновлены. Если срок действия всех учетных данных, в том числе сертификатов и маркеров, истек, обновление завершится сбоем, а первый пакет виртуальных машин останется в состоянии сбоя.

В случае сбоя аутентификации ресурса рекомендуем выполнить следующие шаги по восстановлению виртуальных машин и повторному включению автоматического обновления ОС.

* Повторно создайте маркер (или любые другие учетные данные), переданный в ваши расширения.
* Убедитесь, что все учетные данные, используемые внутри виртуальной машины для взаимодействия с внешними сущностями, обновлены.
* Обновите расширения в модели масштабируемого набора с новыми маркерами.
* Разверните обновленный масштабируемый набор, в котором будут обновлены все экземпляры виртуальных машин, включая сбойные.

## <a name="using-application-health-extension"></a>Использование расширения "Работоспособность приложения"
Расширение "Работоспособность приложения" развертывается внутри экземпляра масштабируемого набора виртуальных машин и сообщает о состоянии работоспособности виртуальной машины изнутри этого экземпляра. Вы можете настроить расширение так, чтобы оно проверяло конечную точку приложения и обновляло состояние приложения на этом экземпляре. Azure проверяет состояние этого экземпляра, чтобы определить, подходит ли экземпляр для операций обновления.

Так как расширение сообщает о состоянии работоспособности из виртуальной машины, расширение можно применять в ситуациях, когда внешние пробы, например, пробы работоспособности приложений (использующие пользовательские [пробы](../load-balancer/load-balancer-custom-probe-overview.md) Azure Load Balancer), не могут использоваться.

Существует несколько способов развертывания расширения "Работоспособность приложения" в масштабируемые наборы, которые описаны в [этой статье](virtual-machine-scale-sets-health-extension.md#deploy-the-application-health-extension).

## <a name="get-the-history-of-automatic-os-image-upgrades"></a>Получение журнала автоматического обновления образа ОС
Вы можете проверить журнал последнего обновления ОС масштабируемого набора с помощью Azure PowerShell, Azure CLI 2.0 или интерфейсов REST API. Можно просмотреть журнал для последних пяти попыток обновлений операционной системы в течение последних двух месяцев.

### <a name="rest-api"></a>REST API
В следующем примере используется [REST API](/rest/api/compute/virtualmachinescalesets/getosupgradehistory) для проверки состояния масштабируемого набора *myVMSS* в группе ресурсов *myResourceGroup*.

```
GET on `/subscriptions/subscription_id/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachineScaleSets/myScaleSet/osUpgradeHistory?api-version=2018-10-01`
```

Вызов GET возвращает подобные свойства:

```json
{
    "value": [
        {
            "properties": {
        "runningStatus": {
          "code": "RollingForward",
          "startTime": "2018-07-24T17:46:06.1248429+00:00",
          "completedTime": "2018-04-21T12:29:25.0511245+00:00"
        },
        "progress": {
          "successfulInstanceCount": 16,
          "failedInstanceCount": 0,
          "inProgressInstanceCount": 4,
          "pendingInstanceCount": 0
        },
        "startedBy": "Platform",
        "targetImageReference": {
          "publisher": "MicrosoftWindowsServer",
          "offer": "WindowsServer",
          "sku": "2016-Datacenter",
          "version": "2016.127.20180613"
        },
        "rollbackInfo": {
          "successfullyRolledbackInstanceCount": 0,
          "failedRolledbackInstanceCount": 0
        }
      },
      "type": "Microsoft.Compute/virtualMachineScaleSets/rollingUpgrades",
      "location": "westeurope"
    }
  ]
}
```

### <a name="azure-powershell"></a>Azure PowerShell
Используйте командлет [Get-AzVmss](/powershell/module/az.compute/get-azvmss), чтобы проверить журнал обновлений ОС для масштабируемого набора. В следующем примере показано, как просмотреть состояние обновления ОС масштабируемого набора *myVMSS* в группе ресурсов *myResourceGroup*:

```azurepowershell-interactive
Get-AzVmss -ResourceGroupName "myResourceGroup" -VMScaleSetName "myVMSS" -OSUpgradeHistory
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
Используйте командлет [az vmss get-os-upgrade-history](/cli/azure/vmss#az-vmss-get-os-upgrade-history), чтобы проверить журнал обновления ОС масштабируемого набора. Использование Azure CLI 2.0.47 или более поздней версии В следующем примере показано, как просмотреть состояние обновления ОС масштабируемого набора *myVMSS* в группе ресурсов *myResourceGroup*:

```azurecli-interactive
az vmss get-os-upgrade-history --resource-group myResourceGroup --name myVMSS
```

## <a name="how-to-get-the-latest-version-of-a-platform-os-image"></a>Как получить последнюю версию образа платформы ОС?

Вы можете получить версии образов для автоматического обновления ОС (для поддерживаемых номеров SKU) с помощью приведенных ниже примеров:

### <a name="rest-api"></a>REST API
```
GET on `/subscriptions/subscription_id/providers/Microsoft.Compute/locations/{location}/publishers/{publisherName}/artifacttypes/vmimage/offers/{offer}/skus/{skus}/versions?api-version=2018-10-01`
```

### <a name="azure-powershell"></a>Azure PowerShell
```azurepowershell-interactive
Get-AzVmImage -Location "westus" -PublisherName "Canonical" -Offer "UbuntuServer" -Skus "16.04-LTS"
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
```azurecli-interactive
az vm image list --location "westus" --publisher "Canonical" --offer "UbuntuServer" --sku "16.04-LTS" --all
```

## <a name="deploy-with-a-template"></a>Развертывание с помощью шаблона

Вы можете использовать шаблоны для развертывания масштабируемого набора с автоматическими обновлениями ОС для поддерживаемых образов, таких как [Ubuntu 16.04-LTS](https://github.com/Azure/vm-scale-sets/blob/master/preview/upgrade/autoupdate.json).

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fvm-scale-sets%2Fmaster%2Fpreview%2Fupgrade%2Fautoupdate.json" target="_blank"><img src="https://azuredeploy.net/deploybutton.png"/></a>

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные примеры использования автоматических обновлений ОС с масштабируемыми наборами см. в [репозитории GitHub](https://github.com/Azure/vm-scale-sets/tree/master/preview/upgrade).
