---
title: Автоматическое ремонт экземпляра с наборами виртуальных машин Azure
description: Узнайте, как настроить политику автоматического ремонта для экземпляров VM в наборе масштабов
author: avirishuv
manager: vashan
tags: azure-resource-manager
ms.service: virtual-machine-scale-sets
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm
ms.topic: conceptual
ms.date: 02/28/2020
ms.author: avverma
ms.openlocfilehash: 8156c563573183e51e06650914117f8787922e93
ms.sourcegitcommit: 5e49f45571aeb1232a3e0bd44725cc17c06d1452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81603678"
---
# <a name="automatic-instance-repairs-for-azure-virtual-machine-scale-sets"></a>Автоматическое ремонт экземпляров для наборов виртуальной шкалы смазано Azure

Включение автоматического ремонта экземпляров для виртуальных наборов машин Azure помогает достичь высокой доступности приложений, поддерживая набор полезных экземпляров. Если экземпляр в наборе масштабов признан неработоспособным, как сообщается в зондах [работоспособности Health Application](./virtual-machine-scale-sets-health-extension.md) или [Зонды здоровья балансоровой нагрузки,](../load-balancer/load-balancer-custom-probe-overview.md)то эта функция автоматически выполняет ремонт экземпляра, удаляя неработоспособный экземпляр и создавая новый, чтобы заменить его.

## <a name="requirements-for-using-automatic-instance-repairs"></a>Требования к использованию автоматического ремонта экземпляров

**Включить мониторинг работоспособности приложений для набора масштаба**

В наборе масштабов должен быть включен мониторинг работоспособности приложений для экземпляров. Это может быть сделано с помощью либо [расширения безопасности приложения](./virtual-machine-scale-sets-health-extension.md) или [зонды здоровья баланса нагрузки.](../load-balancer/load-balancer-custom-probe-overview.md) Только один из них может быть включен в то время. Расширение работоспособности приложения или зонды балансо-баланса нагрузки пинг айм-пойнт приложения настроены на виртуальные экземпляры машины для определения состояния работоспособности приложения. Это состояние работоспособности используется оркестратором набора масштаба для мониторинга работоспособности экземпляра и выполнения ремонтных работ при необходимости.

**Настройка конечная точка для обеспечения состояния здоровья**

Прежде чем включить политику автоматического ремонта экземпляров, убедитесь, что в наборах масштабов есть конечная точка приложения, настроенная для испускания состояния работоспособности приложения. Когда экземпляр возвращает статус 200 (OK) в этой конечную точку приложения, то экземпляр помечается как "Здоровый". Во всех остальных случаях экземпляр помечен как "Нездоровый", включая следующие сценарии:

- При отсутствии конечных точек приложения, настроенных внутри экземпляров виртуальной машины для обеспечения состояния работоспособности приложения
- Когда конечная точка приложения неправильно настроена
- Когда конечная точка приложения недостижима

Для экземпляров, помеченных как "Нездоровый", автоматический ремонт запускается набором масштаба. Убедитесь, что конечная точка приложения правильно настроена перед включением политики автоматического ремонта, чтобы избежать непреднамеренных ремонтов экземпляров, в то время как конечная точка настраивается.

**Включить одну группу размещения**

Эта функция в настоящее время доступна только для наборов масштабов, развернутых в качестве единой группы размещения. Свойство *singlePlacementGroup* должно быть установлено в *истинном* для вашего набора масштаба использовать функцию автоматического ремонта экземпляра. Подробнее о [группах размещения.](./virtual-machine-scale-sets-placement-groups.md#placement-groups)

**Версия API**

Политика автоматического ремонта поддерживается для версии API 2018-10-01 или выше.

**Ограничения на перемещение ресурсов или подписки**

Перемещение ресурсов или подписки в настоящее время не поддерживается для наборов масштабов при включении функции автоматического ремонта.

**Ограничение для наборов масштабов тканей обслуживания**

Эта функция в настоящее время не поддерживается для набораов масштабов ткани обслуживания.

## <a name="how-do-automatic-instance-repairs-work"></a>Как работает автоматический ремонт экземпляра?

Функция автоматического ремонта экземпляров опирается на мониторинг работоспособности отдельных экземпляров в наборе масштабов. Экземпляры VM в наборе масштабов могут быть настроены для испускаемого состояния работоспособности приложения с помощью [либо расширения работоспособности приложения,](./virtual-machine-scale-sets-health-extension.md) либо [зондов работоспособности баланса нагрузки.](../load-balancer/load-balancer-custom-probe-overview.md) Если экземпляр признан неработоспособным, то набор масштабов выполняет действие ремонта, удаляя неработоспособный экземпляр и создавая новый, чтобы заменить его. Для создания нового экземпляра используется новейшая модель набора виртуальной шкалы машин. Эта функция может быть включена в виртуальной модели набора масштабов машины с помощью *объекта automaticRepairsPolicy.*

### <a name="batching"></a>Пакетная обработка

Операции автоматического ремонта экземпляров выполняются партиями. В любой момент времени не более 5% экземпляров в наборе масштабов ремонтируются с помощью политики автоматического ремонта. Это помогает избежать одновременного удаления и воссоздания большого количества экземпляров, если они обнаруживаетесь нездоровыми в то же время.

### <a name="grace-period"></a>Льготный период

Когда экземпляр проходит операцию изменения состояния из-за действия PUT, PATCH или POST, выполняемого в наборе масштабов (например, reimage, reimage, update, update и т.д.), то любое действие по ремонту в этом экземпляре выполняется только после ожидания льготного периода. Период благодати — это количество времени, позволяющее экземпляру вернуться в здоровое состояние. Льготный период начинается после завершения изменения состояния. Это помогает избежать любых преждевременных или случайных ремонтных работ. Льготный период чествуется для любого вновь созданного экземпляра в наборе масштаба (включая тот, который был создан в результате ремонта). Льготный период указан в минутах в формате ISO 8601 и может быть установлен с помощью свойства *automaticRepairs.gracePeriod*. Льготный период может варьироваться от 30 минут до 90 минут, и имеет значение по умолчанию 30 минут.

### <a name="suspension-of-repairs"></a>Приостановка ремонта 

Виртуальные наборы масштабов машин обеспечивают возможность временно приостанавливать автоматическое ремонт экземпляра при необходимости. *СервисГосударство* автоматического ремонта под *управлением имущественной организацииУслуги,* например, с учетом виртуального набора масштабов машины показывает текущее состояние автоматического ремонта. При выборе набора масштабов для автоматического ремонта значение *параметра serviceState* устанавливается для *запуска.* Когда автоматический ремонт приостанавливается для набора масштаба, *параметр службыСостояние* устанавливается *для приостановления.* Если *автоматическаяRepairsPolicy* определена на наборе масштаба, но функция автоматического ремонта не включена, то *параметр службыState* настроен *не работает.*

Если вновь созданные экземпляры для замены нездоровых в наборе масштабов продолжают оставаться нездоровыми даже после неоднократного выполнения ремонтных операций, то в качестве меры безопасности платформа обновляет *сервисдля* автоматического ремонта *приостановлено.* Вы можете возобновить автоматический ремонт снова, установив значение *serviceState* для автоматического ремонта *Running.* Подробные инструкции приведены в разделе о [просмотре и обновлении состояния службы автоматического ремонта политики](#viewing-and-updating-the-service-state-of-automatic-instance-repairs-policy) для набора шкалы. 

Процесс автоматического ремонта экземпляра работает следующим образом:

1. [Расширение работоспособности приложения](./virtual-machine-scale-sets-health-extension.md) или [зонды здоровья балансиста нагрузки](../load-balancer/load-balancer-custom-probe-overview.md) пинг аналогов приложения в каждой виртуальной машине в наборе масштаба, чтобы получить состояние здоровья приложения для каждого экземпляра.
2. Если конечная точка отвечает статусом 200 (OK), то экземпляр помечается как "Здоровый". Во всех остальных случаях (в том числе, если конечная точка недостижима), экземпляр помечен как "Нездоровый".
3. Когда экземпляр оказывается неработоспособным, набор масштаба запускает действие ремонта, удаляя неработоспособный экземпляр и создавая новый для его замены.
4. Ремонт экземпляров выполняется партиями. В любой момент времени ремонтируется не более 5% от общего числа экземпляров в наборе масштабов. Если набор масштабов имеет менее 20 экземпляров, ремонт выполняется для одного неработоспособного экземпляра за один раз.
5. Вышеупомянутый процесс продолжается до тех пор, пока не будут восстановлены все неработоспособные экземпляры в наборе масштабов.

## <a name="instance-protection-and-automatic-repairs"></a>Защита экземпляров и автоматический ремонт

Если экземпляр в наборе масштабов защищен одним из [политик защиты,](./virtual-machine-scale-sets-instance-protection.md)то автоматический ремонт в этом случае не выполняется. Это относится как к политикам защиты: *Защита от масштабирования* и *защита от масштабированных действий.* 

## <a name="terminatenotificationandautomaticrepairs"></a>Прекращение уведомления и автоматического ремонта

Если функция [уведомления о завершении](./virtual-machine-scale-sets-terminate-notification.md) включена в наборе масштабов, то во время автоматической операции по ремонту удаление неработоспособного экземпляра следует конфигурации уведомления о завершении. Уведомление о завершении отправляется через службу метаданных Azure - запланированные события - и удаление экземпляра задерживается на время настроенного тайм-аута задержки. Однако создание нового экземпляра для замены неработоспособного не дожидаясь завершения тайм-аута задержки.

## <a name="enabling-automatic-repairs-policy-when-creating-a-new-scale-set"></a>Включение политики автоматического ремонта при создании нового набора масштабов

Для включения политики автоматического ремонта при создании нового набора масштабов убедитесь, что все [требования для](#requirements-for-using-automatic-instance-repairs) выбора этой функции будут выполнены. Конечная точка приложения должна быть правильно настроена для экземпляров набора масштаба, чтобы избежать запуска непреднамеренных ремонтов во время настройки конечной точки. Для вновь созданных наборов масштабов любой экземпляр ремонт выполняется только после ожидания в течение льготного периода. Для автоматического ремонта экземпляра в масштабе, используйте *объект automaticRepairPolicy* в модели набора виртуальной шкалы машины.

Вы также можете использовать этот [шаблон quickstart](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-automatic-repairs-slb-health-probe) для развертывания виртуального набора шкалы машины с зондом работоспособности баланса нагрузки и автоматическим ремонтом экземпляра с льготным периодом в 30 минут.

### <a name="azure-portal"></a>Портал Azure
 
Следующие шаги, позволяющие автоматический ремонт политики при создании нового набора масштаба.
 
1. Перейти к **виртуальным наборам масштабов машины.**
1. Выберите **и добавьте,** чтобы создать новый набор масштабов.
1. Перейдите на вкладку **Здоровье.** 
1. Найдите раздел **Здоровье.**
1. Включить опцию **работоспособности приложения Monitor.**
1. Найдите раздел **политики автоматического ремонта.**
1. **Включите** опцию **автоматического ремонта.**
1. В **период благодати (мин)**, указать льготный период в минутах, разрешенные значения между 30 и 90 минут. 
1. Когда вы закончите создание нового набора шкалы, выберите кнопку **«Обзор» и «Создайте».**

### <a name="rest-api"></a>REST API

В следующем примере показано, как включить автоматический ремонт экземпляра в модели набора масштаба. Используйте версию API 2018-10-01 или выше.

```
PUT or PATCH on '/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}?api-version=2019-07-01'
```

```json
{
  "properties": {
    "automaticRepairsPolicy": {
            "enabled": "true",
            "gracePeriod": "PT30M"
        }
    }
}
```

### <a name="azure-powershell"></a>Azure PowerShell

Функция автоматического ремонта экземпляра может быть включена при создании нового набора масштаба с помощью [cmdlet New-AzVmssConfig.](/powershell/module/az.compute/new-azvmssconfig) Этот пример сценария проходит через создание набора масштаба и связанных с ними ресурсов с помощью файла конфигурации: [Создание полного виртуального набора масштабов машины.](./scripts/powershell-sample-create-complete-scale-set.md) Вы можете настроить политику автоматического ремонта экземпляров, добавив параметры *EnableAutomaticRepair* и *AutomaticRepairGracePeriod* к объекту конфигурации для создания набора масштаба. Следующий пример позволяет функцию с льготным периодом 30 минут.

```azurepowershell-interactive
New-AzVmssConfig `
 -Location "EastUS" `
 -SkuCapacity 2 `
 -SkuName "Standard_DS2" `
 -UpgradePolicyMode "Automatic" `
 -EnableAutomaticRepair $true `
 -AutomaticRepairGracePeriod "PT30M"
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

Следующий пример позволяет автоматической политики ремонта при создании нового набора масштаба с использованием *[az vmss создать.](https://docs.microsoft.com/cli/azure/vmss?view=azure-cli-latest#az-vmss-create)* Сначала создайте группу ресурсов, а затем создайте новый набор шкалы с льготным периодом политики автоматического ремонта, установленным до 30 минут.

```azurecli-interactive
az group create --name <myResourceGroup> --location <VMSSLocation>
az vmss create \
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --image UbuntuLTS \
  --admin-username <azureuser> \
  --generate-ssh-keys \
  --load-balancer <existingLoadBalancer> \
  --health-probe <existingHealthProbeUnderLoaderBalancer> \
  --automatic-repairs-period 30
```

The above example uses an existing load balancer and health probe for monitoring application health status of instances. Если вместо этого вы предпочитаете использовать расширение работоспособности приложения для мониторинга, можно создать набор масштабов, настроить расширение работоспособности приложения, а затем включить политику автоматического ремонта экземпляра с помощью *обновления az vmss,* как это объясняется в следующем разделе.

## <a name="enabling-automatic-repairs-policy-when-updating-an-existing-scale-set"></a>Включение политики автоматического ремонта при обновлении существующего набора масштабов

Прежде чем включить политику автоматического ремонта в существующий набор масштабов, убедитесь, что все [требования](#requirements-for-using-automatic-instance-repairs) для выбора этой функции будут выполнены. Конечная точка приложения должна быть правильно настроена для экземпляров набора масштаба, чтобы избежать запуска непреднамеренных ремонтов во время настройки конечной точки. Для автоматического ремонта экземпляра в масштабе, используйте *объект automaticRepairPolicy* в модели набора виртуальной шкалы машины.

После обновления модели существующего набора масштабов убедитесь, что последняя модель применяется ко всем экземплярам шкалы. Обратитесь к инструкции о [том, как привести ВМ в актуальном состоянии с последней моделью набора масштаба.](./virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model)

### <a name="azure-portal"></a>Портал Azure

Можно изменить политику автоматического ремонта существующей шкалы, установленной через портал Azure. 
 
1. Перейдите к существующему набору виртуальной шкалы машин.
1. В **соответствии** с настройками в меню слева, выберите **Здоровье и ремонт.**
1. Включить опцию **работоспособности приложения Monitor.**
1. Найдите раздел **политики автоматического ремонта.**
1. **Включите** опцию **автоматического ремонта.**
1. В **период благодати (мин)**, указать льготный период в минутах, разрешенные значения между 30 и 90 минут. 
1. По завершении нажмите кнопку **Сохранить**. 

### <a name="rest-api"></a>REST API

Следующий пример позволяет политику с льготным периодом 40 минут. Используйте версию API 2018-10-01 или выше.

```
PUT or PATCH on '/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}?api-version=2019-07-01'
```

```json
{
  "properties": {
    "automaticRepairsPolicy": {
            "enabled": "true",
            "gracePeriod": "PT40M"
        }
    }
}
```

### <a name="azure-powershell"></a>Azure PowerShell

Используйте [cmdlet Update-AzVmss](/powershell/module/az.compute/update-azvmss) для изменения конфигурации функции автоматического ремонта экземпляра в существующем наборе масштабов. Следующий пример обновляет льготный период до 40 минут.

```azurepowershell-interactive
Update-AzVmss `
 -ResourceGroupName "myResourceGroup" `
 -VMScaleSetName "myScaleSet" `
 -EnableAutomaticRepair $true `
 -AutomaticRepairGracePeriod "PT40M"
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

Ниже приводится пример для обновления политики автоматического ремонта экземпляра существующего набора масштабов с использованием *[обновления az vmss.](https://docs.microsoft.com/cli/azure/vmss?view=azure-cli-latest#az-vmss-update)*

```azurecli-interactive
az vmss update \  
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --enable-automatic-repairs true \
  --automatic-repairs-period 30
```

## <a name="viewing-and-updating-the-service-state-of-automatic-instance-repairs-policy"></a>Просмотр и обновление состояния службы политики автоматического ремонта экземпляров

### <a name="rest-api"></a>REST API 

Используйте [Get Instance View](https://docs.microsoft.com/rest/api/compute/virtualmachinescalesets/getinstanceview) с версией API 2019-12-01 или выше для виртуального набора машин для просмотра *сервисаДля* автоматического ремонта в рамках системы *свойств.* 

```http
GET '/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}/instanceView?api-version=2019-12-01'
```

```json
{
  "orchestrationServices": [
    {
      "serviceName": "AutomaticRepairs",
      "serviceState": "Running"
    }
  ]
}
```

Используйте *setOrchestrationServiceState* API с версией API 2019-12-01 или выше по виртуальной шкале машины, установленной для настройки состояния автоматического ремонта. После того, как набор масштабов будет выбран в функцию автоматического ремонта, вы можете использовать этот API для приостановки или возобновления автоматического ремонта для набора масштабов. 

 ```http
 POST '/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}/setOrchestrationServiceState?api-version=2019-12-01'
 ```

```json
{
  "orchestrationServices": [
    {
      "serviceName": "AutomaticRepairs",
      "serviceState": "Suspend"
    }
  ]
}
```

### <a name="azure-cli"></a>Azure CLI 

Используйте cmdlet [get-instance-view](https://docs.microsoft.com/cli/azure/vmss?view=azure-cli-latest#az-vmss-get-instance-view) для просмотра *сервисаДля* автоматического ремонта экземпляров. 

```azurecli-interactive
az vmss get-instance-view \
    --name MyScaleSet \
    --resource-group MyResourceGroup
```

Используйте [сет-оркестр-сервис-состояние](https://docs.microsoft.com/cli/azure/vmss?view=azure-cli-latest#az-vmss-set-orchestration-service-state) cmdlet для обновления *сервисаДля* автоматического ремонта экземпляров. После того, как набор масштаба выбран в функцию автоматического ремонта, то вы можете использовать этот cmdlet приостановить или возобновить автоматический ремонт для вас набор масштаба. 

```azurecli-interactive
az vmss set-orchestration-service-state \
    --service-name AutomaticRepairs \
    --action Resume \
    --name MyScaleSet \
    --resource-group MyResourceGroup
```
### <a name="azure-powershell"></a>Azure PowerShell

Используйте [Get-AzVmss](https://docs.microsoft.com/powershell/module/az.compute/get-azvmss?view=azps-3.7.0) cmdlet с параметром *InstanceView* для просмотра *ServiceState* для автоматического ремонта экземпляров.

```azurepowershell-interactive
Get-AzVmss `
    -ResourceGroupName "myResourceGroup" `
    -VMScaleSetName "myScaleSet" `
    -InstanceView
```

Используйте Set-AzVmssOrchestrationServiceState cmdlet для обновления *сервисаДля* автоматического ремонта экземпляров. После того, как набор масштабов выбран в функцию автоматического ремонта, вы можете использовать этот cmdlet для приостановки или возобновления автоматического ремонта для набора масштабов.

```azurepowershell-interactive
Set-AzVmssOrchestrationServiceState `
    -ResourceGroupName "myResourceGroup" `
    -VMScaleSetName "myScaleSet" `
    -ServiceName "AutomaticRepairs" `
    -Action "Suspend"
```

## <a name="troubleshoot"></a>Диагностика

**Невключение политики автоматического ремонта**

Если вы получаете ошибку 'BadRequest' с сообщением о том, что "Не удалось найти участника 'automaticRepairsPolicy' на объекте типа 'свойства', то проверьте версию API, используемую для набора виртуальной шкалы машины. Для этой функции требуется версия API 2018-10-01 или выше.

**Инстанция не восстанавливается даже при включении политики**

Экземпляр может быть в льготный период. Это время ожидания после изменения состояния в экземпляре перед выполнением ремонтных работ. Это делается для того, чтобы избежать преждевременного или случайного ремонта. Действие ремонта должно произойти после завершения льготного периода для экземпляра.

**Просмотр состояния работоспособности приложения для экземпляров набора масштаба**

Для просмотра состояния работоспособности приложения можно использовать [API просмотра экземпляров Get Instance](/rest/api/compute/virtualmachinescalesetvms/getinstanceview) View для экземпляров в виртуальном наборе машин. С Azure PowerShell вы можете использовать cmdlet [Get-AzVmssVM](/powershell/module/az.compute/get-azvmssvm) с флагом *-InstanceView.* Состояние здоровья приложения предоставляется в соответствии с собственностью *vmHealth*.

На портале Azure также можно увидеть состояние работоспособности. Перейдите к существующему набору **масштабов,** выберите Instances из меню слева и посмотрите на столбец **состояния работоспособности** для состояния работоспособности каждого набора экземпляра шкалы. 

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как настроить [расширение работоспособности приложения](./virtual-machine-scale-sets-health-extension.md) или [зонды работоспособности баланса нагрузки](../load-balancer/load-balancer-custom-probe-overview.md) для наборов масштабов.
