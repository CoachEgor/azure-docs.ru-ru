---
title: Автоматическое восстановление экземпляра с помощью масштабируемых наборов виртуальных машин Azure
description: Узнайте, как настроить политику автоматического восстановления для экземпляров виртуальных машин в масштабируемом наборе.
author: avirishuv
manager: vashan
tags: azure-resource-manager
ms.service: virtual-machine-scale-sets
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm
ms.topic: conceptual
ms.date: 02/28/2020
ms.author: avverma
ms.openlocfilehash: f335b0fb3396103c321d740bcf6d125e60e95086
ms.sourcegitcommit: d45fd299815ee29ce65fd68fd5e0ecf774546a47
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/04/2020
ms.locfileid: "78274818"
---
# <a name="preview-automatic-instance-repairs-for-azure-virtual-machine-scale-sets"></a>Предварительная версия: автоматическое восстановление экземпляра для масштабируемых наборов виртуальных машин Azure

Включение автоматического восстановления экземпляров для масштабируемых наборов виртуальных машин Azure обеспечивает высокий уровень доступности для приложений за счет поддержания набора работоспособных экземпляров. Если экземпляр в масштабируемом наборе находится в состоянии неработоспособности, о котором сообщает [расширение работоспособности приложения](./virtual-machine-scale-sets-health-extension.md) или [проверки работоспособности балансировщика нагрузки](../load-balancer/load-balancer-custom-probe-overview.md), эта функция автоматически выполняет восстановление экземпляра, удаляя неработоспособный экземпляр и создавая новый, чтобы заменить его.

> [!NOTE]
> Эта предварительная версия функции предоставляется без соглашения об уровне обслуживания и не рекомендуется для рабочих нагрузок.

## <a name="requirements-for-using-automatic-instance-repairs"></a>Требования к использованию автоматического восстановления экземпляров

**Согласие на предварительную версию автоматического восстановления экземпляра**

Используйте либо REST API, либо Azure PowerShell, чтобы принять участие в предварительной версии автоматического восстановления экземпляра. Эти действия зарегистрируют подписку для предварительной версии функции. Обратите внимание, что для использования этой функции требуется только одноразовая настройка. Если ваша подписка уже зарегистрирована для предварительной версии автоматического восстановления экземпляра, вам не нужно выполнять повторную регистрацию. 

Использование REST API 

1. Регистрация для использования функции с помощью [функции "регистрация](/rest/api/resources/features/register) " 

```
POST on '/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/RepairVMScaleSetInstancesPreview/register?api-version=2015-12-01'
```

```json
{
  "properties": {
    "state": "Registering"
  },
  "id": "/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/RepairVMScaleSetInstancesPreview",
  "type": "Microsoft.Features/providers/features",
  "name": "Microsoft.Compute/RepairVMScaleSetInstancesPreview"
}
```

2. Подождите несколько минут, пока *состояние* изменится на *зарегистрировано*. Для подтверждения этого можно использовать следующий API.

```
GET on '/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/RepairVMScaleSetInstancesPreview?api-version=2015-12-01'
```

```json
{
  "properties": {
    "state": "Registered"
  },
  "id": "/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/RepairVMScaleSetInstancesPreview",
  "type": "Microsoft.Features/providers/features",
  "name": "Microsoft.Compute/RepairVMScaleSetInstancesPreview"
}
```

3. Когда *состояние* изменится на *зарегистрировано*, выполните следующую команду.

```
POST on '/subscriptions/{subscriptionId}/providers/Microsoft.Compute/register?api-version=2015-12-01'
```

Использование Azure PowerShell

1. Зарегистрируйтесь для использования функции с помощью командлета [Register-AzureRmResourceProvider](/powershell/module/azurerm.resources/register-azurermresourceprovider) , а затем [Register-AzureRmProviderFeature](/powershell/module/azurerm.resources/register-azurermproviderfeature) .

```azurepowershell-interactive
Register-AzureRmResourceProvider `
 -ProviderNamespace Microsoft.Compute

Register-AzureRmProviderFeature `
 -ProviderNamespace Microsoft.Compute `
 -FeatureName RepairVMScaleSetInstancesPreview
```

2. Подождите несколько минут, пока *RegistrationState* не изменится на *Registered*. Чтобы подтвердить это, можно использовать следующий командлет.

```azurepowershell-interactive
Get-AzureRmProviderFeature `
 -ProviderNamespace Microsoft.Compute `
 -FeatureName RepairVMScaleSetInstancesPreview
 ```

 Ответ должен выглядеть следующим образом.

| FeatureName                           | ProviderName            | RegistrationState       |
|---------------------------------------|-------------------------|-------------------------|
| репаирвмскалесетинстанцеспревиев      | Microsoft.Compute;       | Зарегистрировано              |

3. После того как *RegistrationState* изменится на *зарегистрированный*, выполните следующий командлет.

```azurepowershell-interactive
Register-AzureRmResourceProvider `
 -ProviderNamespace Microsoft.Compute
```

**Включение мониторинга работоспособности приложений для масштабируемого набора**

В масштабируемом наборе должен быть включен мониторинг работоспособности приложений для экземпляров. Это можно сделать с помощью [расширения работоспособности приложения](./virtual-machine-scale-sets-health-extension.md) или [проб работоспособности подсистемы балансировки нагрузки](../load-balancer/load-balancer-custom-probe-overview.md). В каждый момент времени можно включить только один из них. Расширение работоспособности приложения или балансировщик нагрузки проверяет связь с конечной точкой приложения, настроенной на экземплярах виртуальной машины, чтобы определить состояние работоспособности приложения. Это состояние работоспособности используется масштабируемым набором Orchestrator для отслеживания работоспособности экземпляра и выполнения восстановления при необходимости.

**Настройка конечной точки для предоставления состояния работоспособности**

Прежде чем включить политику автоматического восстановления экземпляра, убедитесь, что в экземплярах масштабируемого набора настроена конечная точка приложения для отправки состояния работоспособности приложения. Когда экземпляр возвращает в конечной точке приложения состояние 200 (ОК), экземпляр помечается как "Исправен". Во всех остальных случаях экземпляр помечается как "неработоспособный", включая следующие сценарии.

- Если в экземплярах виртуальной машины не настроена конечная точка приложения для предоставления состояния работоспособности приложения
- Если конечная точка приложения настроена неправильно
- Если конечная точка приложения недоступна

Для экземпляров, помеченных как "неработоспособные", автоматическое восстановление инициируется масштабируемым набором. Убедитесь, что конечная точка приложения настроена правильно, прежде чем включать политику автоматического восстановления, чтобы избежать непреднамеренного восстановления экземпляров, пока выполняется настройка конечной точки.

**Включить одну группу размещения**

Сейчас эта предварительная версия доступна только для масштабируемых наборов, развернутых в одной группе размещения. Свойству *singlePlacementGroup* должно быть присвоено *значение true* , чтобы в масштабируемом наборе использовалась функция автоматического восстановления экземпляров. Дополнительные сведения о [группах размещения](./virtual-machine-scale-sets-placement-groups.md#placement-groups).

**Версия API**

Политика автоматического исправления поддерживается для API вычислений версии 2018-10-01 или более поздней.

**Ограничения на перемещение ресурсов или подписок**

В рамках этой предварительной версии перемещение ресурсов или подписок в настоящее время не поддерживается для масштабируемых наборов, если включена политика автоматического исправления.

**Ограничение для масштабируемых наборов Service Fabric**

Эта предварительная версия функции сейчас не поддерживается для масштабируемых наборов Service Fabric.

## <a name="how-do-automatic-instance-repairs-work"></a>Как автоматически выполняется восстановление экземпляра?

Функция автоматического восстановления экземпляра основана на мониторинге работоспособности отдельных экземпляров в масштабируемом наборе. Экземпляры виртуальных машин в масштабируемом наборе можно настроить для отправки состояния работоспособности приложения с помощью [расширения работоспособности приложения](./virtual-machine-scale-sets-health-extension.md) или [проб работоспособности балансировщика нагрузки](../load-balancer/load-balancer-custom-probe-overview.md). Если экземпляр находится в неработоспособном состоянии, то масштабируемый набор выполняет действие по восстановлению, удаляя неработоспособный экземпляр и создавая новый, чтобы заменить его. Эту функцию можно включить в модели масштабируемого набора виртуальных машин с помощью объекта *аутоматикрепаирсполици* .

### <a name="batching"></a>Пакетная обработка

Операции автоматического восстановления экземпляров выполняются в пакетах. В любой момент времени не будет выполнено восстановление более 5% экземпляров в масштабируемом наборе с помощью политики автоматического восстановления. Это позволяет избежать одновременного удаления и повторного создания большого количества экземпляров при обнаружении неработоспособности в то же время.

### <a name="grace-period"></a>Льготный период

Когда экземпляр проходит операцию изменения состояния из-за выполнения операции помещения, исправления или публикации в масштабируемом наборе (например, переобразировать, повторное развертывание, обновление и т. д.), все действия по восстановлению этого экземпляра выполняются только после ожидания льготного периода. Период отсрочки — это время, в течение которого экземпляр возвращается в работоспособное состояние. Льготный период начинается после изменения состояния. Это помогает избежать выполнения преждевременных или случайных операций восстановления. Льготный период учитывается для всех вновь созданных экземпляров в масштабируемом наборе (включая созданный в результате операции восстановления). Льготный период указывается в минутах в формате ISO 8601 и может быть задан с помощью свойства *аутоматикрепаирсполици. грацепериод*. Льготный период может варьироваться от 30 минут до 90 минут и по умолчанию равен 30 минутам.

Процесс автоматического восстановления экземпляра работает следующим образом.

1. [Модуль](./virtual-machine-scale-sets-health-extension.md) проверки работоспособности приложения или [подсистемы балансировки нагрузки проверяет](../load-balancer/load-balancer-custom-probe-overview.md) связь с конечной точкой приложения в каждой виртуальной машине в масштабируемом наборе, чтобы получить состояние работоспособности приложения для каждого экземпляра.
2. Если конечная точка реагирует на состояние 200 (ОК), экземпляр помечается как "Исправен". Во всех остальных случаях (в том числе если конечная точка недоступна) экземпляр помечается как "неработоспособный".
3. Если экземпляр находится в неработоспособном состоянии, масштабируемый набор активирует действие восстановления, удаляя неработоспособный экземпляр и создавая новый, чтобы заменить его.
4. Восстановление экземпляров выполняется в пакетах. В любой момент времени будет восстановлено не более 5% всего экземпляров в масштабируемом наборе. Если масштабируемый набор содержит менее 20 экземпляров, то восстановление выполняется для одного неработоспособного экземпляра за раз.
5. Описанный выше процесс будет продолжен до тех пор, пока не будут восстановлены все неработоспособные экземпляры в масштабируемом наборе.

## <a name="instance-protection-and-automatic-repairs"></a>Защита экземпляра и автоматическое восстановление

Если экземпляр в масштабируемом наборе защищен с помощью *[политики защиты из масштабируемого набора действий](./virtual-machine-scale-sets-instance-protection.md#protect-from-scale-set-actions)* , автоматическое восстановление не выполняется на этом экземпляре.

## <a name="enabling-automatic-repairs-policy-when-creating-a-new-scale-set"></a>Включение политики автоматического восстановления при создании нового масштабируемого набора

Чтобы включить автоматическую политику восстановления при создании масштабируемого набора, убедитесь, что выполнены все [требования](#requirements-for-using-automatic-instance-repairs) к включению этой функции. Конечная точка приложения должна быть правильно настроена для экземпляров масштабируемых наборов, чтобы избежать инициации непреднамеренного восстановления во время настройки конечной точки. Для вновь созданных масштабируемых наборов все операции восстановления экземпляров выполняются только после ожидания в течение периода отсрочки. Чтобы включить автоматическое восстановление экземпляров в масштабируемом наборе, используйте объект *аутоматикрепаирсполици* в модели масштабируемого набора виртуальных машин.

### <a name="rest-api"></a>REST API

В следующем примере показано, как включить автоматическое восстановление экземпляров в модели масштабируемого набора. Используйте API версии 2018-10-01 или более поздней.

```
PUT or PATCH on '/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}?api-version=2019-07-01'
```

```json
{
  "properties": {
    "automaticRepairsPolicy": {
            "enabled": "true",
            "gracePeriod": "PT30M"
        }
    }
}
```

### <a name="azure-powershell"></a>Azure PowerShell

Функцию автоматического восстановления экземпляра можно включить при создании нового масштабируемого набора с помощью командлета [New-азвмссконфиг](/powershell/module/az.compute/new-azvmssconfig) . Этот пример скрипта проходит по созданию масштабируемого набора и связанных ресурсов с помощью файла конфигурации: [Создание полного масштабируемого набора виртуальных машин](./scripts/powershell-sample-create-complete-scale-set.md). Политику автоматического восстановления экземпляра можно настроить, добавив параметры *енаблеаутоматикрепаир* и *аутоматикрепаирграцепериод* в объект конфигурации для создания масштабируемого набора. В следующем примере включается функция с льготным периодом 30 минут.

```azurepowershell-interactive
New-AzVmssConfig `
 -Location "EastUS" `
 -SkuCapacity 2 `
 -SkuName "Standard_DS2" `
 -UpgradePolicyMode "Automatic" `
 -EnableAutomaticRepair $true `
 -AutomaticRepairGracePeriod "PT30M"
```

## <a name="enabling-automatic-repairs-policy-when-updating-an-existing-scale-set"></a>Включение политики автоматического восстановления при обновлении существующего масштабируемого набора

Прежде чем включить автоматическую политику восстановления в существующем масштабируемом наборе, убедитесь, что выполнены все [требования](#requirements-for-using-automatic-instance-repairs) к включению этой функции. Конечная точка приложения должна быть правильно настроена для экземпляров масштабируемых наборов, чтобы избежать инициации непреднамеренного восстановления во время настройки конечной точки. Чтобы включить автоматическое восстановление экземпляров в масштабируемом наборе, используйте объект *аутоматикрепаирсполици* в модели масштабируемого набора виртуальных машин.

### <a name="rest-api"></a>REST API

В следующем примере включается политика с льготным периодом в 40 минут. Используйте API версии 2018-10-01 или более поздней.

```
PUT or PATCH on '/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}?api-version=2019-07-01'
```

```json
{
  "properties": {
    "automaticRepairsPolicy": {
            "enabled": "true",
            "gracePeriod": "PT40M"
        }
    }
}
```

### <a name="azure-powershell"></a>Azure PowerShell

Используйте командлет [Update-азвмсс](/powershell/module/az.compute/update-azvmss) , чтобы изменить конфигурацию функции автоматического восстановления экземпляра в существующем масштабируемом наборе. В следующем примере период отсрочки обновляется до 40 минут.

```azurepowershell-interactive
Update-AzVmss `
 -ResourceGroupName "myResourceGroup" `
 -VMScaleSetName "myScaleSet" `
 -EnableAutomaticRepair $true `
 -AutomaticRepairGracePeriod "PT40M"
```

## <a name="troubleshoot"></a>Устранение неполадок

**Не удалось включить политику автоматического восстановления**

Если вы получаете ошибку "BadRequest" с сообщением "не удалось найти член" Аутоматикрепаирсполици "для объекта типа" Properties ", проверьте версию API, используемую для масштабируемого набора виртуальных машин. Для этой функции требуется API версии 2018-10-01 или выше.

**Экземпляр не восстановился, даже если включена политика**

Экземпляр может находиться в льготном периоде. Время ожидания после любого изменения состояния в экземпляре перед выполнением восстановления. Это позволяет избежать преждевременного или случайного восстановления. Действие по восстановлению должно выполняться по окончании периода отсрочки для экземпляра.

**Просмотр состояния работоспособности приложения для экземпляров масштабируемых наборов**

Вы можете использовать [API получения представления](/rest/api/compute/virtualmachinescalesetvms/getinstanceview) экземпляров для экземпляров в масштабируемом наборе виртуальных машин, чтобы просмотреть состояние работоспособности приложения. С Azure PowerShell можно использовать командлет [Get-азвмссвм](/powershell/module/az.compute/get-azvmssvm) с флагом *-InstanceView* . Состояние работоспособности приложения указывается в свойстве *вмхеалс*.

## <a name="next-steps"></a>Следующие шаги

Узнайте, как настроить [расширение работоспособности приложения](./virtual-machine-scale-sets-health-extension.md) или [пробы работоспособности подсистемы балансировки нагрузки](../load-balancer/load-balancer-custom-probe-overview.md) для масштабируемых наборов.
