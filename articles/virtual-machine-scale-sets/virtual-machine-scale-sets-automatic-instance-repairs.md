---
title: Автоматическое ремонт экземпляра с наборами виртуальных машин Azure
description: Узнайте, как настроить политику автоматического ремонта для экземпляров VM в наборе масштабов
author: avirishuv
manager: vashan
tags: azure-resource-manager
ms.service: virtual-machine-scale-sets
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm
ms.topic: conceptual
ms.date: 02/28/2020
ms.author: avverma
ms.openlocfilehash: f335b0fb3396103c321d740bcf6d125e60e95086
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78274818"
---
# <a name="preview-automatic-instance-repairs-for-azure-virtual-machine-scale-sets"></a>Предварительный просмотр: Автоматическое обновление экземпляров для наборов виртуальных машин Azure

Включение автоматического ремонта экземпляров для виртуальных наборов машин Azure помогает достичь высокой доступности приложений, поддерживая набор полезных экземпляров. Если экземпляр в наборе масштабов признан неработоспособным, как сообщается в зондах [работоспособности Health Application](./virtual-machine-scale-sets-health-extension.md) или [Зонды здоровья балансоровой нагрузки,](../load-balancer/load-balancer-custom-probe-overview.md)то эта функция автоматически выполняет ремонт экземпляра, удаляя неработоспособный экземпляр и создавая новый, чтобы заменить его.

> [!NOTE]
> Эта функция предварительного просмотра предоставляется без соглашения об уровне обслуживания, и она не рекомендуется для производственных нагрузок.

## <a name="requirements-for-using-automatic-instance-repairs"></a>Требования к использованию автоматического ремонта экземпляров

**Выберите для автоматического просмотра ремонта экземпляра**

Используйте либо REST API, либо Azure PowerShell, чтобы выбрать автоматический предварительный просмотр ремонта экземпляра. Эти шаги будут регистрировать подписку на функцию предварительного просмотра. Обратите внимание, что это только одноразовая настройка, необходимая для использования этой функции. Если ваша подписка уже зарегистрирована для автоматического просмотра ремонта экземпляра, то вам не нужно регистрироваться снова. 

Использование REST API 

1. Зарегистрируйтесь для получения функции с помощью [функций - Регистрация](/rest/api/resources/features/register) 

```
POST on '/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/RepairVMScaleSetInstancesPreview/register?api-version=2015-12-01'
```

```json
{
  "properties": {
    "state": "Registering"
  },
  "id": "/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/RepairVMScaleSetInstancesPreview",
  "type": "Microsoft.Features/providers/features",
  "name": "Microsoft.Compute/RepairVMScaleSetInstancesPreview"
}
```

2. Подождите несколько минут, пока *государство* изменится на *зарегистрированное.* Вы можете использовать следующий API, чтобы подтвердить это.

```
GET on '/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/RepairVMScaleSetInstancesPreview?api-version=2015-12-01'
```

```json
{
  "properties": {
    "state": "Registered"
  },
  "id": "/subscriptions/{subscriptionId}/providers/Microsoft.Features/providers/Microsoft.Compute/features/RepairVMScaleSetInstancesPreview",
  "type": "Microsoft.Features/providers/features",
  "name": "Microsoft.Compute/RepairVMScaleSetInstancesPreview"
}
```

3. После того, как *государство* изменилось на *зарегистрированных*, а затем запустить следующее.

```
POST on '/subscriptions/{subscriptionId}/providers/Microsoft.Compute/register?api-version=2015-12-01'
```

Использование Azure PowerShell

1. Зарегистрируйтесь на эту функцию с помощью cmdlet [Register-AzureRmResourceProvider](/powershell/module/azurerm.resources/register-azurermresourceprovider) с последующим [регистрацией-AzureRmProviderFeature](/powershell/module/azurerm.resources/register-azurermproviderfeature)

```azurepowershell-interactive
Register-AzureRmResourceProvider `
 -ProviderNamespace Microsoft.Compute

Register-AzureRmProviderFeature `
 -ProviderNamespace Microsoft.Compute `
 -FeatureName RepairVMScaleSetInstancesPreview
```

2. Подождите несколько минут, пока *Регистрационная государство* изменится на *зарегистрированный.* Вы можете использовать следующие cmdlet, чтобы подтвердить это.

```azurepowershell-interactive
Get-AzureRmProviderFeature `
 -ProviderNamespace Microsoft.Compute `
 -FeatureName RepairVMScaleSetInstancesPreview
 ```

 Ответ должен быть следующим.

| Характеристика                           | ProviderName            | РегистрацияГосударство       |
|---------------------------------------|-------------------------|-------------------------|
| RepairVMScaleSetInstancesПредварительный      | Microsoft.Compute;       | Зарегистрировано              |

3. После *регистрациигосударство* изменить на *зарегистрированный,* а затем запустить следующий cmdlet.

```azurepowershell-interactive
Register-AzureRmResourceProvider `
 -ProviderNamespace Microsoft.Compute
```

**Включить мониторинг работоспособности приложений для набора масштаба**

В наборе масштабов должен быть включен мониторинг работоспособности приложений для экземпляров. Это может быть сделано с помощью либо [расширения безопасности приложения](./virtual-machine-scale-sets-health-extension.md) или [зонды здоровья баланса нагрузки.](../load-balancer/load-balancer-custom-probe-overview.md) Только один из них может быть включен в то время. Расширение работоспособности приложения или зонды балансо-баланса нагрузки пинг айм-пойнт приложения настроены на виртуальные экземпляры машины для определения состояния работоспособности приложения. Это состояние работоспособности используется оркестратором набора масштаба для мониторинга работоспособности экземпляра и выполнения ремонтных работ при необходимости.

**Настройка конечная точка для обеспечения состояния здоровья**

Прежде чем включить политику автоматического ремонта экземпляров, убедитесь, что в наборах масштабов есть конечная точка приложения, настроенная для испускания состояния работоспособности приложения. Когда экземпляр возвращает статус 200 (OK) в этой конечную точку приложения, то экземпляр помечается как "Здоровый". Во всех остальных случаях экземпляр помечен как "Нездоровый", включая следующие сценарии:

- При отсутствии конечных точек приложения, настроенных внутри экземпляров виртуальной машины для обеспечения состояния работоспособности приложения
- Когда конечная точка приложения неправильно настроена
- Когда конечная точка приложения недостижима

Для экземпляров, помеченных как "Нездоровый", автоматический ремонт запускается набором масштаба. Убедитесь, что конечная точка приложения правильно настроена перед включением политики автоматического ремонта, чтобы избежать непреднамеренных ремонтов экземпляров, в то время как конечная точка настраивается.

**Включить одну группу размещения**

Этот предварительный просмотр в настоящее время доступен только для наборов масштабов, развернутых как единая группа размещения. Свойство *singlePlacementGroup* должно быть установлено в *истинном* для вашего набора масштаба использовать функцию автоматического ремонта экземпляра. Подробнее о [группах размещения.](./virtual-machine-scale-sets-placement-groups.md#placement-groups)

**Версия API**

Политика автоматического ремонта поддерживается для версии API 2018-10-01 или выше.

**Ограничения на перемещение ресурсов или подписки**

В рамках этого предварительного просмотра перемещения ресурсов или подписки в настоящее время не поддерживаются для наборов масштабов при включении политики автоматического ремонта.

**Ограничение для наборов масштабов тканей обслуживания**

Эта функция предварительного просмотра в настоящее время не поддерживается для наборов масштабов ткани обслуживания.

## <a name="how-do-automatic-instance-repairs-work"></a>Как работает автоматический ремонт экземпляра?

Функция автоматического ремонта экземпляров опирается на мониторинг работоспособности отдельных экземпляров в наборе масштабов. Экземпляры VM в наборе масштабов могут быть настроены для испускаемого состояния работоспособности приложения с помощью [либо расширения работоспособности приложения,](./virtual-machine-scale-sets-health-extension.md) либо [зондов работоспособности баланса нагрузки.](../load-balancer/load-balancer-custom-probe-overview.md) Если экземпляр признан неработоспособным, то набор масштабов выполняет действие ремонта, удаляя неработоспособный экземпляр и создавая новый, чтобы заменить его. Эта функция может быть включена в виртуальной модели набора масштабов машины с помощью *объекта automaticRepairsPolicy.*

### <a name="batching"></a>Пакетная обработка

Операции автоматического ремонта экземпляров выполняются партиями. В любой момент времени не более 5% экземпляров в наборе масштабов ремонтируются с помощью политики автоматического ремонта. Это помогает избежать одновременного удаления и воссоздания большого количества экземпляров, если они обнаруживаетесь нездоровыми в то же время.

### <a name="grace-period"></a>Льготный период

Когда экземпляр проходит операцию изменения состояния из-за действия PUT, PATCH или POST, выполняемого в наборе масштабов (например, reimage, reimage, update, update и т.д.), то любое действие по ремонту в этом экземпляре выполняется только после ожидания льготного периода. Период благодати — это количество времени, позволяющее экземпляру вернуться в здоровое состояние. Льготный период начинается после завершения изменения состояния. Это помогает избежать любых преждевременных или случайных ремонтных работ. Льготный период чествуется для любого вновь созданного экземпляра в наборе масштаба (включая тот, который был создан в результате ремонта). Льготный период указан в минутах в формате ISO 8601 и может быть установлен с помощью свойства *automaticRepairs.gracePeriod*. Льготный период может варьироваться от 30 минут до 90 минут, и имеет значение по умолчанию 30 минут.

Процесс автоматического ремонта экземпляра работает следующим образом:

1. [Расширение работоспособности приложения](./virtual-machine-scale-sets-health-extension.md) или [зонды здоровья балансиста нагрузки](../load-balancer/load-balancer-custom-probe-overview.md) пинг аналогов приложения в каждой виртуальной машине в наборе масштаба, чтобы получить состояние здоровья приложения для каждого экземпляра.
2. Если конечная точка отвечает статусом 200 (OK), то экземпляр помечается как "Здоровый". Во всех остальных случаях (в том числе, если конечная точка недостижима), экземпляр помечен как "Нездоровый".
3. Когда экземпляр оказывается неработоспособным, набор масштаба запускает действие ремонта, удаляя неработоспособный экземпляр и создавая новый для его замены.
4. Ремонт экземпляров выполняется партиями. В любой момент времени ремонтируется не более 5% от общего числа экземпляров в наборе масштабов. Если набор масштабов имеет менее 20 экземпляров, ремонт выполняется для одного неработоспособного экземпляра за один раз.
5. Вышеупомянутый процесс продолжается до тех пор, пока не будут восстановлены все неработоспособные экземпляры в наборе масштабов.

## <a name="instance-protection-and-automatic-repairs"></a>Защита экземпляров и автоматический ремонт

Если экземпляр в наборе масштабов защищен, применяя *[политику защиты от действия, установленную в масштабе,](./virtual-machine-scale-sets-instance-protection.md#protect-from-scale-set-actions)* то автоматический ремонт в этом случае не выполняется.

## <a name="enabling-automatic-repairs-policy-when-creating-a-new-scale-set"></a>Включение политики автоматического ремонта при создании нового набора масштабов

Для включения политики автоматического ремонта при создании нового набора масштабов убедитесь, что все [требования для](#requirements-for-using-automatic-instance-repairs) выбора этой функции будут выполнены. Конечная точка приложения должна быть правильно настроена для экземпляров набора масштаба, чтобы избежать запуска непреднамеренных ремонтов во время настройки конечной точки. Для вновь созданных наборов масштабов любой экземпляр ремонт выполняется только после ожидания в течение льготного периода. Для автоматического ремонта экземпляра в масштабе, используйте *объект automaticRepairPolicy* в модели набора виртуальной шкалы машины.

### <a name="rest-api"></a>REST API

В следующем примере показано, как включить автоматический ремонт экземпляра в модели набора масштаба. Используйте версию API 2018-10-01 или выше.

```
PUT or PATCH on '/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}?api-version=2019-07-01'
```

```json
{
  "properties": {
    "automaticRepairsPolicy": {
            "enabled": "true",
            "gracePeriod": "PT30M"
        }
    }
}
```

### <a name="azure-powershell"></a>Azure PowerShell

Функция автоматического ремонта экземпляра может быть включена при создании нового набора масштаба с помощью [cmdlet New-AzVmssConfig.](/powershell/module/az.compute/new-azvmssconfig) Этот пример сценария проходит через создание набора масштаба и связанных с ними ресурсов с помощью файла конфигурации: [Создание полного виртуального набора масштабов машины.](./scripts/powershell-sample-create-complete-scale-set.md) Вы можете настроить политику автоматического ремонта экземпляров, добавив параметры *EnableAutomaticRepair* и *AutomaticRepairGracePeriod* к объекту конфигурации для создания набора масштаба. Следующий пример позволяет функцию с льготным периодом 30 минут.

```azurepowershell-interactive
New-AzVmssConfig `
 -Location "EastUS" `
 -SkuCapacity 2 `
 -SkuName "Standard_DS2" `
 -UpgradePolicyMode "Automatic" `
 -EnableAutomaticRepair $true `
 -AutomaticRepairGracePeriod "PT30M"
```

## <a name="enabling-automatic-repairs-policy-when-updating-an-existing-scale-set"></a>Включение политики автоматического ремонта при обновлении существующего набора масштабов

Прежде чем включить политику автоматического ремонта в существующий набор масштабов, убедитесь, что все [требования](#requirements-for-using-automatic-instance-repairs) для выбора этой функции будут выполнены. Конечная точка приложения должна быть правильно настроена для экземпляров набора масштаба, чтобы избежать запуска непреднамеренных ремонтов во время настройки конечной точки. Для автоматического ремонта экземпляра в масштабе, используйте *объект automaticRepairPolicy* в модели набора виртуальной шкалы машины.

### <a name="rest-api"></a>REST API

Следующий пример позволяет политику с льготным периодом 40 минут. Используйте версию API 2018-10-01 или выше.

```
PUT or PATCH on '/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}?api-version=2019-07-01'
```

```json
{
  "properties": {
    "automaticRepairsPolicy": {
            "enabled": "true",
            "gracePeriod": "PT40M"
        }
    }
}
```

### <a name="azure-powershell"></a>Azure PowerShell

Используйте [cmdlet Update-AzVmss](/powershell/module/az.compute/update-azvmss) для изменения конфигурации функции автоматического ремонта экземпляра в существующем наборе масштабов. Следующий пример обновляет льготный период до 40 минут.

```azurepowershell-interactive
Update-AzVmss `
 -ResourceGroupName "myResourceGroup" `
 -VMScaleSetName "myScaleSet" `
 -EnableAutomaticRepair $true `
 -AutomaticRepairGracePeriod "PT40M"
```

## <a name="troubleshoot"></a>Устранение неполадок

**Невключение политики автоматического ремонта**

Если вы получаете ошибку 'BadRequest' с сообщением о том, что "Не удалось найти участника 'automaticRepairsPolicy' на объекте типа 'свойства', то проверьте версию API, используемую для набора виртуальной шкалы машины. Для этой функции требуется версия API 2018-10-01 или выше.

**Инстанция не восстанавливается даже при включении политики**

Экземпляр может быть в льготный период. Это время ожидания после изменения состояния в экземпляре перед выполнением ремонтных работ. Это делается для того, чтобы избежать преждевременного или случайного ремонта. Действие ремонта должно произойти после завершения льготного периода для экземпляра.

**Просмотр состояния работоспособности приложения для экземпляров набора масштаба**

Для просмотра состояния работоспособности приложения можно использовать [API просмотра экземпляров Get Instance](/rest/api/compute/virtualmachinescalesetvms/getinstanceview) View для экземпляров в виртуальном наборе машин. С Azure PowerShell вы можете использовать cmdlet [Get-AzVmssVM](/powershell/module/az.compute/get-azvmssvm) с флагом *-InstanceView.* Состояние здоровья приложения предоставляется в соответствии с собственностью *vmHealth*.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как настроить [расширение работоспособности приложения](./virtual-machine-scale-sets-health-extension.md) или [зонды работоспособности баланса нагрузки](../load-balancer/load-balancer-custom-probe-overview.md) для наборов масштабов.
