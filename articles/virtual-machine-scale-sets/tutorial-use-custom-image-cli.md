---
title: Руководство. Применение пользовательского образа виртуальной машины в масштабируемом наборе с помощью Azure CLI
description: Сведения о создании пользовательского образа виртуальной машины, который можно использовать для развертывания масштабируемого набора виртуальных машин, с помощью Azure CLI
author: cynthn
tags: azure-resource-manager
ms.service: virtual-machine-scale-sets
ms.topic: tutorial
ms.date: 03/27/2018
ms.author: cynthn
ms.custom: mvc
ms.openlocfilehash: 6d9f625bf425a33b690fd303a4f13d032bd59fa0
ms.sourcegitcommit: 0947111b263015136bca0e6ec5a8c570b3f700ff
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2020
ms.locfileid: "80062717"
---
# <a name="tutorial-create-and-use-a-custom-image-for-virtual-machine-scale-sets-with-the-azure-cli"></a>Руководство. Создание и использование пользовательского образа для масштабируемых наборов виртуальных машин с помощью Azure CLI
Создавая масштабируемый набор, вы указываете образ для использования при развертывании экземпляров виртуальных машин. Чтобы сократить количество задач после развертывания экземпляров виртуальных машин, можно использовать пользовательский образ виртуальной машины. Этот образ содержит все необходимые установки или конфигурации приложения. Все экземпляры виртуальных машин, созданные в масштабируемом наборе, используют пользовательский образ виртуальной машины и готовы обслуживать трафик приложения. Из этого руководства вы узнаете, как выполнить следующие задачи:

> [!div class="checklist"]
> * создание и настройка виртуальной машины;
> * отмена подготовки виртуальной машины и подготовка ее к использованию;
> * создание пользовательского образа виртуальной машины;
> * развертывание масштабируемого набора, использующего пользовательский образ виртуальной машины.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

Если вы решили установить и использовать интерфейс командной строки локально, для работы с этим руководством вам понадобится Azure CLI 2.0.29 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0]( /cli/azure/install-azure-cli).


## <a name="create-and-configure-a-source-vm"></a>Создание и настройка исходной виртуальной машины

>[!NOTE]
> В этом руководстве приведены пошаговые инструкции по созданию и использованию универсального образа виртуальной машины. Создание масштабируемого набора на основе специализированного образа виртуальной машины не поддерживается.

Сначала создайте группу ресурсов с помощью команды [az group create](/cli/azure/group), а затем — виртуальную машину с помощью команды [az vm create](/cli/azure/vm). Позже эта виртуальная машина будет использована в качестве источника для пользовательского образа. В следующем примере создается виртуальная машина с именем *myVM* в группе ресурсов *myResourceGroup*.

```azurecli-interactive
az group create --name myResourceGroup --location eastus

az vm create \
  --resource-group myResourceGroup \
  --name myVM \
  --image ubuntults \
  --admin-username azureuser \
  --generate-ssh-keys
```

Общедоступный IP-адрес виртуальной машины указан в выходных данных команды [az vm create](/cli/azure/vm). Подключитесь по протоколу SSH к общедоступному IP-адресу виртуальной машины следующим образом.

```console
ssh azureuser@<publicIpAddress>
```

Чтобы настроить виртуальную машину, установите базовый веб-сервер. Когда экземпляр виртуальной машины в масштабируемом наборе будет развернут, у него будут все пакеты, необходимые для запуска веб-приложения. С помощью команды `apt-get` установите *NGINX*, как показано ниже.

```bash
sudo apt-get install -y nginx
```

Последним шагом подготовки виртуальной машины к использованию в качестве пользовательского образа является ее отзыв. Этот шаг удаляет информацию о конкретном компьютере из виртуальной машины и позволяет развернуть множество виртуальных машин из одного образа. Во время отзыва виртуальной машины имя узла сбрасывается и принимает значение *localhost.localdomain*. Ключи узла SSH, конфигурации сервера доменных имен, пароль учетной записи root и кэшированные аренды DHCP также удаляются.

Чтобы отозвать виртуальную машину, используйте агент виртуальной машины Azure (*waagent*). Агент виртуальной машины Azure установлен на каждой виртуальной машине. Он используется для связи с платформой Azure. Параметр `-force` указывает агенту принять запрос на удаление информации о конкретном компьютере.

```bash
sudo waagent -deprovision+user -force
```

Разорвите SSH-подключение к виртуальной машине.

```bash
exit
```


## <a name="create-a-custom-vm-image-from-the-source-vm"></a>Создание пользовательского образа виртуальной машины из исходной виртуальной машины
Теперь на исходной виртуальной машине установлен веб-сервер Nginx и она настроена. Создайте пользовательский образ виртуальной машины для использования с масштабируемым набором.

Чтобы создать образ, нужно отменить выделение виртуальной машины. Освободите виртуальную машину командой [az vm deallocate](/cli//azure/vm). Затем с помощью командлета [az vm generalize](/cli//azure/vm) измените состояние виртуальной машины на "Generalized" (Готова к использованию), чтобы платформа Azure знала, что виртуальная машина готова к использованию пользовательского образа. Создать образ можно только из подготовленной виртуальной машины.


```azurecli-interactive
az vm deallocate --resource-group myResourceGroup --name myVM
az vm generalize --resource-group myResourceGroup --name myVM
```

Освобождение и подготовка виртуальной машины к использованию может занять несколько минут.

Теперь создайте образ из виртуальной машины с помощью команды [az image create](/cli//azure/image). В следующем примере создается образ *myImage* из виртуальной машины.

> [ПРИМЕЧАНИЕ] Если расположение группы ресурсов и виртуальной машины отличается, можно добавить параметр `--location` к приведенным ниже командам, чтобы определить расположение исходной виртуальной машины, используемой для создания образа. 

```azurecli-interactive
az image create \
  --resource-group myResourceGroup \
  --name myImage \
  --source myVM
```


## <a name="create-a-scale-set-from-the-custom-vm-image"></a>Создание масштабируемого набора на основе пользовательского образа виртуальной машины
Создайте масштабируемый набор с помощью команды [az vmss create](/cli/azure/vmss#az-vmss-create). Вместо образа платформы, например *UbuntuLTS* или *CentOS*, укажите имя своего пользовательского образа виртуальной машины. В следующем примере создается масштабируемый набор с именем *myScaleSet*, использующий пользовательский образ *myImage* из предыдущего шага.

```azurecli-interactive
az vmss create \
  --resource-group myResourceGroup \
  --name myScaleSet \
  --image myImage \
  --admin-username azureuser \
  --generate-ssh-keys
```

Создание и настройка всех ресурсов и виртуальных машин масштабируемого набора занимает несколько минут.


## <a name="test-your-scale-set"></a>Проверка масштабируемого набора
Чтобы разрешить передачу трафика в указанный масштабируемый набор и проверить работу веб-сервера, создайте правило подсистемы балансировки нагрузки с помощью команды [az network lb rule create](/cli/azure/network/lb/rule). В следующем примере создается правило *myLoadBalancerRuleWeb*, которое разрешает трафик через *TCP-порт* *80*.

```azurecli-interactive
az network lb rule create \
  --resource-group myResourceGroup \
  --name myLoadBalancerRuleWeb \
  --lb-name myScaleSetLB \
  --backend-pool-name myScaleSetLBBEPool \
  --backend-port 80 \
  --frontend-ip-name loadBalancerFrontEnd \
  --frontend-port 80 \
  --protocol tcp
```

Чтобы посмотреть, как работает масштабируемый набор, получите общедоступный IP-адрес подсистемы балансировки нагрузки с помощью команды [az network public-ip show](/cli/azure/network/public-ip). Следующий пример получает IP-адрес для *myScaleSetLBPublicIP*, созданного ранее вместе с масштабируемым набором.

```azurecli-interactive
az network public-ip show \
  --resource-group myResourceGroup \
  --name myScaleSetLBPublicIP \
  --query [ipAddress] \
  --output tsv
```

Введите общедоступный IP-адрес в веб-браузер. Отобразится веб-страница NGINX по умолчанию, как показано ниже.

![Nginx, запущенный из пользовательского образа виртуальной машины](media/tutorial-use-custom-image-cli/default-nginx-website.png)


## <a name="clean-up-resources"></a>Очистка ресурсов
Чтобы удалить масштабируемый набор и дополнительные ресурсы, удалите группу ресурсов и все входящие в нее ресурсы с помощью команды [az group delete](/cli/azure/group). При использовании параметра `--no-wait` управление возвращается в командную строку без ожидания завершения операции. Параметр `--yes` подтверждает, что вы хотите удалить ресурсы без дополнительного запроса.

```azurecli-interactive
az group delete --name myResourceGroup --no-wait --yes
```


## <a name="next-steps"></a>Дальнейшие действия
Из этого руководства вы узнали, как создавать и использовать пользовательский образ виртуальной машины для масштабируемых наборов с помощью Azure CLI, в частности, как выполнять такие задачи:

> [!div class="checklist"]
> * создание и настройка виртуальной машины;
> * отмена подготовки виртуальной машины и подготовка ее к использованию;
> * создание пользовательского образа виртуальной машины;
> * развертывание масштабируемого набора, использующего пользовательский образ виртуальной машины.

Перейдите к следующему руководству, чтобы узнать, как развертывать приложения в масштабируемый набор.

> [!div class="nextstepaction"]
> [Руководство по развертыванию приложений в масштабируемых наборах](tutorial-install-apps-cli.md)
