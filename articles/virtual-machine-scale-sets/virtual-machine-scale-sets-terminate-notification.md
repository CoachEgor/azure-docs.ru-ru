---
title: Прекращение уведомления для экземпляров виртуального набора масштабов виртуальной машины Azure
description: Узнайте, как включить уведомление о завершении для экземпляров набора виртуальной шкалы масштабов виртуальной машины Azure
author: avirishuv
tags: azure-resource-manager
ms.service: virtual-machine-scale-sets
ms.topic: conceptual
ms.date: 02/26/2020
ms.author: avverma
ms.openlocfilehash: 6023e9bf7539b79446d0135ba731b61be166dd6e
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79250755"
---
# <a name="terminate-notification-for-azure-virtual-machine-scale-set-instances"></a>Прекращение уведомления для экземпляров виртуального набора масштабов виртуальной машины Azure
Набор масштабов может выбрать для получения уведомлений о прекращении экземпляров и установить заранее определенный тайм-аут задержки для операции завершения. Уведомление о прекращении отправляется через службу Метаданных Azure - [Scheduled Events](../virtual-machines/windows/scheduled-events.md), которая предоставляет уведомления и задержки эффективных операций, таких как перезагрузка и передислокация. Решение добавляет еще одно событие - Прекращение - в список запланированных событий, и связанная с этим задержка события завершения будет зависеть от лимита задержки, указанного пользователями в конфигурациях набора маштаба.

После регистрации в объекте экземпляры набора масштабов не должны ждать, пока истекает указанный тайм-аут, прежде чем экземпляр будет удален. После получения уведомления О прекращении экземпляр может быть удален в любое время до истечения срока завершения.

## <a name="enable-terminate-notifications"></a>Включить уведомления об упразднении
Существует несколько способов включения уведомлений о прекращении в экземплярах набора масштабов, как описано в приведенных ниже примерах.

### <a name="azure-portal"></a>Портал Azure

Следующие шаги позволяют прекратить уведомление при создании нового набора шкалы. 

1. Перейти к **виртуальным наборам масштабов машины.**
1. Выберите **и добавьте,** чтобы создать новый набор масштабов.
1. Перейдите на вкладку **"Управление".** 
1. Найдите раздел **прекращения инстанции.**
1. Для **уведомления о прекращении,** выберите **на**.
1. Для **задержки прекращения (минуты)** установите желаемый тайм-аут по умолчанию.
1. Когда вы закончите создание нового набора шкалы, выберите кнопку **«Обзор» и «Создайте».** 

> [!NOTE]
> Вы не можете установить уведомления о завершении на существующих наборах масштабов на портале Azure

### <a name="rest-api"></a>REST API

Следующий пример позволяет установить прекращение в модели набора шкалы.

```
PUT on `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}?api-version=2019-03-01`
```

```json
{
  "properties": {
    "virtualMachineProfile": {
            "scheduledEventsProfile": {
                "terminateNotificationProfile": {
                    "notBeforeTimeout":"PT5M",
                    "enable":true
                }
            }
        }
    }        
}

```

Вышеупомянутый блок определяет задержку тайм-аута в 5 минут (как указано *PT5M)* для любой операции завершения на всех экземплярах в наборе шкалы. Поле *notBeforeTimeout* может занять от 5 до 15 минут в формате ISO 8601. Вы можете изменить тайм-аут по умолчанию для операции завершения, изменив свойство *notBeforeTimeout* под *завершениемNotificationProfile,* описанное выше.

После включения *scheduledEventsProfile* на модель набора масштаба и установки *notBeforeTimeout,* обновите отдельные экземпляры до [последней модели,](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model) чтобы отразить изменения.

> [!NOTE]
>Упразднение уведомлений в случаях набора масштаба может быть включено только с версией API 2019-03-01 и выше

### <a name="azure-powershell"></a>Azure PowerShell
При создании нового набора шкалы можно включить уведомления о прекращении шкалы, установленной с помощью [cmdlet New-AzVmssConfig.](/powershell/module/az.compute/new-azvmssconfig)

Этот пример сценария проходит через создание набора масштаба и связанных с ними ресурсов с помощью файла конфигурации: [Создание полного виртуального набора масштабов машины.](./scripts/powershell-sample-create-complete-scale-set.md) Вы можете предоставить уведомление о завершении конфигурации, добавив параметры *TerminateScheduledEvents* и *TerminateScheduledEventAndTimeTimeOutInMinutes* к объекту конфигурации для создания набора масштабов. Следующий пример позволяет функцию с задержкой тайм-аута 10 минут.

```azurepowershell-interactive
New-AzVmssConfig `
  -Location "VMSSLocation" `
  -SkuCapacity 2 `
  -SkuName "Standard_DS2" `
  -UpgradePolicyMode "Automatic" `
  -TerminateScheduledEvents $true `
  -TerminateScheduledEventNotBeforeTimeoutInMinutes 10
```

Используйте cmdlet [Update-AzVmss](/powershell/module/az.compute/update-azvmss) для включения уведомлений о прекращении в существующем наборе масштабов.

```azurepowershell-interactive
Update-AzVmss `
  -ResourceGroupName "myResourceGroup" `
  -VMScaleSetName "myScaleSet" `
  -TerminateScheduledEvents $true
  -TerminateScheduledEventNotBeforeTimeoutInMinutes 15
```
Приведенный выше пример позволяет прекратить уведомления в существующем наборе масштабов и устанавливает 15-минутный тайм-аут для события завершения.

После включения запланированных событий в модель набора масштаба и настройки тайм-аута обновите отдельные экземпляры до [последней модели,](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model) чтобы отразить изменения.

### <a name="azure-cli-20"></a>Azure CLI 2.0

Следующий пример — включение уведомления о прекращении при создании нового набора шкалы.

```azurecli-interactive
az group create --name <myResourceGroup> --location <VMSSLocation>
az vmss create \
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --image UbuntuLTS \
  --admin-username <azureuser> \
  --generate-ssh-keys \
  --terminate-notification-time 10
```

Приведенный выше пример сначала создает группу ресурсов, а затем создает новый набор масштабов с включенными уведомлениями о завершении для 10-минутного тайм-аута по умолчанию.

Следующий пример — включение уведомления о прекращении в существующем наборе масштабов.

```azurecli-interactive
az vmss update \  
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --enable-terminate-notification true \
  --terminate-notification-time 10
```

## <a name="get-terminate-notifications"></a>Получайте уведомления об упразднении

Уведомления о прекращении доставляются через [службу запланированных событий,](../virtual-machines/windows/scheduled-events.md)которая является службой Метаданных Azure. Служба метаданных Azure предоставляет сведения о работающих виртуальных машинах через конечную точку REST, доступную из виртуальной машины. Информация доступна через IP-адрес, не связанный с перевалкой, чтобы она не подвергалась воздействию за пределами VM.

Запланированные события включены для набора шкалы при первом запросе на события. Вы можете ожидать задержки ответа в первом звонке до двух минут. Периодически закажив конечную точку для обнаружения предстоящих событий технического обслуживания и состояния текущих мероприятий по техническому обслуживанию.

Запланированные события отключены для набора шкалы, если экземпляры набора шкалы не делают запрос в течение 24 часов.

### <a name="endpoint-discovery"></a>Обнаружение конечных точек
Для VNET включен VMs, Metadata служба доступна с статического не-routable IP, 169.254.169.254.

Полная конечная точка для последней версии службы "Запланированные события" выглядит так:
> 'http://169.254.169.254/metadata/scheduledevents?api-version=2019-01-01'

### <a name="query-response"></a>Ответ на запрос
Ответ содержит массив запланированных событий. Если это будет пустой массив, значит сейчас запланированных событий нет.

Если передаются запланированные события, массив событий в ответе выглядит так: Для события "Terminate" ответ будет выглядеть следующим образом:
```
{
    "DocumentIncarnation": {IncarnationID},
    "Events": [
        {
            "EventId": {eventID},
            "EventType": "Terminate",
            "ResourceType": "VirtualMachine",
            "Resources": [{resourceName}],
            "EventStatus": "Scheduled",
            "NotBefore": {timeInUTC},
        }
    ]
}
```
*DocumentIncarnation* — это ETag и обеспечивает простой способ проверки, изменилась ли полезная нагрузка Событий с момента последнего запроса.

Для получения дополнительной информации о каждом из приведенных [Linux](../virtual-machines/linux/scheduled-events.md#event-properties)выше областей см. [Windows](../virtual-machines/windows/scheduled-events.md#event-properties)

### <a name="respond-to-events"></a>Реагирование на события
После того как вы узнали о предстоящем событии и завершили свою логику для изящного выключения, вы можете утвердить выдающееся событие, сделав post вызов службы метаданных с EventId. Вызов POST указывает Azure, что он может продолжить удаление VM.

Ниже json ожидается в post запрос тела. Запрос должен содержать список StartRequests. Каждый StartRequest содержит EventId для события, которое вы хотите ускорить:
```
{
    "StartRequests" : [
        {
            "EventId": {EventId}
        }
    ]
}
```

Убедитесь, что каждый VM в наборе масштабов только утверждает EventID, актуальный только для этого VM. VM может получить свое собственное имя VM [через метаданные экземпляра.](virtual-machine-scale-sets-instance-ids.md#instance-metadata-vm-name) Это имя принимает форму «масштабно-сет-имя» (instance-id) и будет отображаться в разделе «Ресурсы» ответа запроса, описанного выше.

Вы также можете ссылаться на образцы скриптов для запроса и реагирования на события с помощью [PowerShell](../virtual-machines/windows/scheduled-events.md#powershell-sample) и [Python.](../virtual-machines/linux/scheduled-events.md#python-sample)

## <a name="tips-and-best-practices"></a>Советы и рекомендации
-   Прекращение уведомлений только на операциях 'удалить' - Все операции удаления (ручное удаление или автомасштаб, инициированный масштабом в) будут генерировать события Завершения, если набор масштабов *запланированНаВентПрофиль.* Другие операции, такие как перезагрузка, повторное изображение, передислокация и остановка/делокация, не генерируют события Завершения. Уведомления о прекращении не могут быть включены для малоприоритетных VMs.
-   Нет обязательного ожидания тайм-аута *NotBefore* - Вы можете начать операцию завершения в любое время после получения события и до истечения времени события.
-   Обязательное удаление при тайм-ауте - Нет возможности продления значения тайм-аута после того, как событие было создано. По истечении тайм-аута событие завершения будет обработано и VM будет удален.
-   Изменяемое значение тайм-аута — Вы можете изменить значение тайм-аута в любое время до удаления экземпляра, изменяя свойство *notBeforeTimeout* в модели набора масштаба и обновляя экземпляры VM до последней модели.
-   Утвердить все отложенные удаления - Если есть отложенное удаление на VM_1, которое не утверждено, и вы одобрили еще одно событие завершения на VM_2, то VM_2 не удаляется до тех пор, пока событие завершения для VM_1 не будет утверждено, или его тайм-аут не иссякнет. После утверждения события завершения для VM_1, то VM_1 и VM_2 удаляются.
-   Утвердить все одновременные удаления - Расширение приведенного выше примера, если VM_1 и VM_2 имеют одинаковые *невремя,* то оба события завершения должны быть утверждены или ни VM не удаляется до истечения тайм-аута.

## <a name="troubleshoot"></a>Устранение неполадок
### <a name="failure-to-enable-scheduledeventsprofile"></a>Невключение запланированныхСобытийПрофиль
Если вы получили ошибку 'BadRequest' с сообщением об ошибке о том, что "не удалось найти участника 'scheduledEventsProfile' на объекте типа 'VirtualMachineProfile'", проверьте версию API, используемую для операций набора шкалы. Вычислить API версии **2019-03-01** или выше не требуется. 

### <a name="failure-to-get-terminate-events"></a>Неспособность получить события Завершения
Если вы не получаете никаких событий **«Прекращение»** через запланированные события, проверьте версию API, используемую для получения событий. Версия API службы метаданных **2019-01-01** или выше требуется для событий Прекращения.
>'http://169.254.169.254/metadata/scheduledevents?api-version=2019-01-01'

### <a name="getting-terminate-event-with-incorrect-notbefore-time"></a>Получение события завершения с неправильным неразное время  
После включения *scheduledEventsProfile* на модель набора масштаба и установки *notBeforeTimeout,* обновите отдельные экземпляры до [последней модели,](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model) чтобы отразить изменения.

## <a name="next-steps"></a>Дальнейшие действия
Узнайте, как [развертывать приложение](virtual-machine-scale-sets-deploy-app.md) в масштабируемых наборах виртуальных машин.
