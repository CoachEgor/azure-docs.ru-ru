---
title: Завершение уведомления для экземпляров масштабируемых наборов виртуальных машин Azure | Документация Майкрософт
description: Узнайте, как включить уведомление об увольнении для экземпляров масштабируемых наборов виртуальных машин Azure.
services: virtual-machine-scale-sets
documentationcenter: ''
author: mayanknayar
manager: drewm
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/27/2019
ms.author: manayar
ms.openlocfilehash: de303032fcbbde30534c802e3d5185aedf05cb98
ms.sourcegitcommit: 82499878a3d2a33a02a751d6e6e3800adbfa8c13
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2019
ms.locfileid: "70076242"
---
# <a name="terminate-notification-for-azure-virtual-machine-scale-set-instances-preview"></a>Завершение уведомления для экземпляров масштабируемых наборов виртуальных машин Azure (Предварительная версия)
Экземпляры масштабируемых наборов могут использовать для получения уведомлений об увольнении экземпляра и задать предопределенное время ожидания задержки для операции завершения. Уведомление об увольнении отправляется через службу метаданных Azure — [запланированные события](../virtual-machines/windows/scheduled-events.md), которая предоставляет уведомления для и задержки таких операций, как перезагрузка и повторное развертывание. Решение предварительной версии добавляет еще одно событие — завершение — в список Запланированные события, а связанная задержка события завершения будет зависеть от предельной задержки, заданной пользователями в конфигурации модели масштабируемого набора.

После регистрации в компоненте для экземпляров масштабируемого набора не требуется ждать истечения заданного времени ожидания до удаления экземпляра. После получения уведомления об увольнении экземпляр можно удалить в любое время до истечения времени ожидания завершения.

> [!IMPORTANT]
> Уведомление о прекращении экземпляров масштабируемых наборов в настоящее время находится в общедоступной предварительной версии. Для использования функции общедоступной предварительной версии, описанной ниже, не требуется процедура согласия.
> Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены.
> Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="enable-terminate-notifications"></a>Включить уведомления о прекращении
Существует несколько способов включения уведомлений об увольнении в экземплярах масштабируемого набора, как описано в примерах ниже.

### <a name="rest-api"></a>REST API

В следующем примере включается уведомление о завершении для модели масштабируемого набора.

```
PUT on `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}?api-version=2019-03-01`
```

```json
{
  "properties": {
    "virtualMachineProfile": {
            "scheduledEventsProfile": {
                "terminateNotificationProfile": {
                    "notBeforeTimeout":"PT5M",
                    "enable":true
                }
            }
        }
    }        
}

```

Указанный выше блок задает задержку времени ожидания в 5 минут (как указано в *PT5M*) для любой операции завершения всех экземпляров в масштабируемом наборе. Поле *нотбефоретимеаут* может принимать любое значение от 5 до 15 минут в формате ISO 8601. Вы можете изменить время ожидания по умолчанию для операции завершения, изменив свойство *нотбефоретимеаут* в разделе *терминатенотификатионпрофиле* , описанном выше.

После включения *счедуледевентспрофиле* в модели масштабируемого набора и установки *нотбефоретимеаут*обновите отдельные экземпляры до [последней модели](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model) , чтобы отразить изменения.

> [!NOTE]
>Уведомления об увольнении в экземплярах масштабируемых наборов можно включить только с помощью API версии 2019-03-01 и выше.

### <a name="azure-powershell"></a>Azure PowerShell
При создании нового масштабируемого набора можно включить уведомления об увольнении в масштабируемом наборе с помощью командлета [New-азвмссвм](/powershell/module/az.compute/new-azvmss) .

```azurepowershell-interactive
New-AzVmss `
  -ResourceGroupName "myResourceGroup" `
  -Location "EastUS" `
  -VMScaleSetName "myScaleSet" `
  -VirtualNetworkName "myVnet" `
  -SubnetName "mySubnet" `
  -PublicIpAddressName "myPublicIPAddress" `
  -LoadBalancerName "myLoadBalancer" `
  -UpgradePolicyMode "Automatic" `
  -TerminateScheduledEvents
```

В приведенном выше примере создается новый масштабируемый набор с включенными уведомлениями о прекращении с интервалом в 5 минут по умолчанию. При создании нового масштабируемого набора параметр *терминатесчедуледевентс* не требует значения. Чтобы изменить значение времени ожидания, укажите нужное время ожидания через параметр *терминатесчедуледевентнотбефоретимеаутинминутес* .

Используйте командлет [Update-азвмссвм](/powershell/module/az.compute/update-azvmss) , чтобы включить уведомления об увольнении в существующем масштабируемом наборе.

```azurepowershell-interactive
Update-AzVmss `
  -ResourceGroupName "myResourceGroup" `
  -VMScaleSetName "myScaleSet" `
  -TerminateScheduledEvents $true
  -TerminateScheduledEventNotBeforeTimeoutInMinutes 15
```
Приведенный выше пример включает уведомления о прекращении для существующего масштабируемого набора и устанавливает время ожидания в 15 минут для события Terminate.

После включения запланированных событий в модели масштабируемого набора и установки времени ожидания обновите отдельные экземпляры до [последней модели](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model) , чтобы отразить изменения.

## <a name="get-terminate-notifications"></a>Получение уведомлений о прекращении

Уведомления о прекращении доставки доставляются через [запланированные события](../virtual-machines/windows/scheduled-events.md), которая является службой метаданных Azure. Служба метаданных Azure предоставляет сведения о работающих виртуальных машинах через конечную точку REST, доступную из виртуальной машины. Эта информация доступна через IP-адрес, не поддерживающий маршрутизацию, поэтому он не предоставляется за пределами виртуальной машины.

Запланированные события включен для масштабируемого набора при первом выполнении запроса на события. Отложенный ответ можно ждать при первом вызове до двух минут. Периодически выполняйте запрос к конечной точке для обнаружения ближайших событий обслуживания и состояния текущих действий по обслуживанию.

Запланированные события отключено для масштабируемого набора, если экземпляры масштабируемых наборов не делают запрос в течение 24 часов.

### <a name="endpoint-discovery"></a>Обнаружение конечной точки
Для виртуальных машин с поддержкой виртуальной сети служба метаданных доступна из статического IP-адреса, не поддерживающего маршрутизацию, 169.254.169.254.

Полная конечная точка для последней версии Запланированные события для этого предварительного просмотра:
> 'http://169.254.169.254/metadata/scheduledevents?api-version=2019-01-01 '

### <a name="query-response"></a>Ответ на запрос
Ответ содержит массив запланированных событий. Если это будет пустой массив, значит сейчас запланированных событий нет.

Если передаются запланированные события, массив событий в ответе выглядит так: Для события "Terminate" ответ будет выглядеть следующим образом:
```
{
    "DocumentIncarnation": {IncarnationID},
    "Events": [
        {
            "EventId": {eventID},
            "EventType": "Terminate",
            "ResourceType": "VirtualMachine",
            "Resources": [{resourceName}],
            "EventStatus": "Scheduled",
            "NotBefore": {timeInUTC},
        }
    ]
}
```
DocumentIncarnation — это тег сущности, который позволяет легко проверить, изменились ли полезные данные события с момента предыдущего запроса.

Дополнительные сведения о каждом из полей см. в документации по Запланированные события для [Windows](../virtual-machines/windows/scheduled-events.md#event-properties) и [Linux](../virtual-machines/linux/scheduled-events.md#event-properties).

### <a name="respond-to-events"></a>Реагирование на события
После того как вы узнаете о предстоящем событии и выполнили логику для корректного завершения работы, вы можете утвердить это событие, сделав вызов POST в службу метаданных с кодом EventId. Вызов POST указывает Azure на возможность продолжения удаления виртуальной машины.

Ниже приведен JSON-код, ожидаемый в тексте запроса POST. Запрос должен содержать список Стартрекуестс. Каждый Стартрекуест содержит EventId для события, которое вы хотите ускорить:
```
{
    "StartRequests" : [
        {
            "EventId": {EventId}
        }
    ]
}
```

Убедитесь, что каждая виртуальная машина в масштабируемом наборе утверждает только события EventID, относящиеся только к этой виртуальной машине. Виртуальная машина может получить собственное имя виртуальной машины [через метаданные экземпляра](virtual-machine-scale-sets-instance-ids.md#instance-metadata-vm-name). Это имя имеет вид "{Scale-set-name} _ {Instance-ID}" и будет отображаться в разделе "Resources" в ответе на запрос, описанном выше.

Вы также можете ознакомиться со сценариями примеров для запросов и реагирования на события с помощью [PowerShell](../virtual-machines/windows/scheduled-events.md#powershell-sample) и [Python](../virtual-machines/linux/scheduled-events.md#python-sample).

## <a name="tips-and-best-practices"></a>Советы и рекомендации
-   Прерывать уведомления только для операций "Delete" — все операции удаления (горизонтальное удаление или автоматическое масштабирование, инициированное вручную) будут создавать события завершения, если масштабируемый набор включен *счедуледевентспрофиле* . Другие операции, такие как перезагрузка, пересоздание образа, повторное развертывание, остановка и освобождение, не создают события завершения. Невозможно включить уведомления о прекращении для виртуальных машин с низким приоритетом.
-   Нет обязательного ожидания для времени ожидания — можно запустить операцию завершения в любое время после получения события и до истечения времени *NotBefore* события.
-   Обязательное удаление при превышении времени ожидания — Предварительная версия не предоставляет возможности расширения значения времени ожидания после создания события. По истечении времени ожидания будет обработано событие ожидания завершения, и виртуальная машина будет удалена.
-   Изменяемое значение времени ожидания — вы можете изменить значение времени ожидания в любое время до удаления экземпляра, изменив свойство *нотбефоретимеаут* в модели масштабируемого набора и обновив экземпляры виртуальной машины до последней модели.
-   Утвердить все ожидающие удаления — если имеется Ожидающее удаление в VM_1, которое не утверждено, и вы утвердили другое событие terminate в VM_2, то VM_2 не удаляется до тех пор, пока не будет утверждено событие Terminate для VM_1 или не истечет время ожидания. После утверждения события Terminate для VM_1 удаляются и VM_1, и VM_2.
-   Утвердить все одновременные удаления — расширение приведенного выше примера, если VM_1 и VM_2 имеют одинаковое время *NotBefore* , то оба события завершения должны быть утверждены или ни одна виртуальная машина не будет удалена до истечения времени ожидания.

## <a name="troubleshoot"></a>Устранение неполадок
### <a name="failure-to-enable-scheduledeventsprofile"></a>Не удалось включить Счедуледевентспрофиле
Если возникает ошибка "BadRequest" с сообщением об ошибке "не удалось найти член" Счедуледевентспрофиле "для объекта типа" VirtualMachineProfile "", проверьте версию API, используемую для операций масштабируемого набора. Для этой предварительной версии требуется API вычислений версии **2019-03-01** или более поздней.

### <a name="failure-to-get-terminate-events"></a>Не удалось получить события завершения
Если вы не получаете события **завершения** через запланированные события, проверьте версию API, используемую для получения событий. Для завершения событий требуется API службы метаданных версии **2019-01-01** или более поздней.
>'http://169.254.169.254/metadata/scheduledevents?api-version=2019-01-01 '

### <a name="getting-terminate-event-with-incorrect-notbefore-time"></a>Получение события завершения с неправильным временем NotBefore  
После включения *счедуледевентспрофиле* в модели масштабируемого набора и установки *нотбефоретимеаут*обновите отдельные экземпляры до [последней модели](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model) , чтобы отразить изменения.

## <a name="next-steps"></a>Следующие шаги
Узнайте, как [развертывать приложение](virtual-machine-scale-sets-deploy-app.md) в масштабируемых наборах виртуальных машин.
