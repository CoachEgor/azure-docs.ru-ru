---
title: Руководство по потокам устройств Центра Интернета вещей в C для SSH/RDP (предварительная версия) | Документация Майкрософт
description: В этом кратком руководстве будет выполняться запуск двух примеров приложений C# для реализации сценариев SSH/RDP через поток устройств Центра Интернета вещей.
author: rezasherafat
manager: briz
ms.service: iot-hub
services: iot-hub
ms.devlang: csharp
ms.topic: quickstart
ms.custom: mvc
ms.date: 03/14/2019
ms.author: rezas
ms.openlocfilehash: 514c2e0ea1ef33406c6633064434239d8bdd0e3f
ms.sourcegitcommit: 3ced637c8f1f24256dd6ac8e180fff62a444b03c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/17/2019
ms.locfileid: "65832974"
---
# <a name="quickstart-sshrdp-over-an-iot-hub-device-stream-using-a-c-proxy-application-preview"></a>Краткое руководство. Подключение по протоколу SSH или RDP через поток устройств Центра Интернета вещей с помощью прокси-приложения C#

[!INCLUDE [iot-hub-quickstarts-4-selector](../../includes/iot-hub-quickstarts-4-selector.md)]

Центр Интернета вещей Microsoft Azure поддерживает потоки устройств, которые сейчас доступны в режиме [предварительной версии](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

[Потоки устройств Центра Интернета вещей](iot-hub-device-streams-overview.md) позволяют службам и приложениям устройств безопасным и подходящим методом обмениваться данными с брандмауэром. Это краткое руководство включает две программы C#, которые отправляют трафик приложения клиента и сервера (например, SSH и RDP) через поток устройств, установленный через Центр Интернета вещей. Общие сведения о настройке см. на странице с [примером локального прокси-приложения для SSH или RDP](iot-hub-device-streams-overview.md#local-proxy-sample-for-ssh-or-rdp).

Сначала мы опишем настройку для SSH (используя порт 22). Затем опишем, как изменить порт настройки для RDP. Так как потоки устройств не зависят от приложений и протоколов, тот же пример можно изменить для размещения других типов трафика приложений. Обычно это подразумевает только изменение порта связи на тот, который используется нужным приложением.

## <a name="how-it-works"></a>Принцип работы

На рисунке, приведенном ниже показано, как программы локального прокси-сервера устройств и служб в этом примере обеспечивают сквозное подключение между клиентом SSH и управляющей программой SSH. В данном случае предполагается, что управляющая программа запущена на том же устройстве, что и локальный прокси-сервер устройства.

![Настройка локального прокси-приложения](./media/quickstart-device-streams-proxy-csharp/device-stream-proxy-diagram.svg)

1. Локальный прокси-сервер службы подключается к центру Интернета вещей и инициирует поток устройств в целевое устройство с помощью кода устройства.

2. Локальный прокси-сервер устройства завершает подтверждение инициации потоковой передачи и устанавливает сквозной потоковый туннель через конечную точку потоковой передачи Центра Интернета вещей на стороне службы.

3. Локальное прокси-приложение устройства подключается к управляющей программе SSH (SSHD), прослушивающей порт 22 на устройстве (это можно настроить, как описано ниже в разделе о [запуске локального прокси-приложения на устройстве](#run-the-device-local-proxy)).

4. Локальное прокси-приложение службы ожидает новые SSH-подключения от пользователя, прослушивая назначенный порт (в этом случае — порт 2222), который также можно настроить, как описано ниже в разделе о [запуске локального прокси-приложения на устройстве](#run-the-service-local-proxy). Когда пользователь подключается через клиент SSH, туннель позволяет обмениваться трафиком приложения между клиентом SSH и служебными программами.

> [!NOTE]
> Трафик SSH, передаваемый по потоку, будет туннелироваться через конечную точку потоковой передачи Центра Интернета вещей, а не напрямую между службой и устройством. Дополнительные сведения см. в разделе о [преимуществах потоков устройств](./iot-hub-device-streams-overview.md#benefits).

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

Предварительная версия потоков устройств сейчас поддерживается только в Центрах Интернета вещей, созданных в следующих регионах.

*  **Центральная часть США**

*  **Центральная часть США (EUAP)**

Примеры приложений, запускаемые в рамках этого краткого руководства, написаны на языке C#. На компьютере, на котором ведется разработка, необходимо установить пакет SDK для .NET Core версии 2.1.0 или более поздней.

Пакет SDK для .NET Core, предназначенный для нескольких платформ, можно скачать из [раздела, посвященного .NET](https://www.microsoft.com/net/download/all).

Текущую версию C# на компьютере, на котором ведется разработка, можно проверить, используя следующую команду:

```
dotnet --version
```

Выполните следующую команду, чтобы добавить расширение Интернета вещей Microsoft Azure для Azure CLI в экземпляр Cloud Shell. Расширение Интернета вещей добавляет в Azure CLI специальные команды Центра Интернета вещей, IoT Edge и службы подготовки устройств Интернета вещей (DPS).

```azurecli-interactive
az extension add --name azure-cli-iot-ext
```

Скачайте пример проекта C# по ссылке https://github.com/Azure-Samples/azure-iot-samples-csharp/archive/master.zip и извлеките ZIP-архив.

## <a name="create-an-iot-hub"></a>Создание Центра Интернета вещей

[!INCLUDE [iot-hub-include-create-hub-device-streams](../../includes/iot-hub-include-create-hub-device-streams.md)]

## <a name="register-a-device"></a>Регистрация устройства

Устройство должно быть зарегистрировано в Центре Интернета вещей, прежде чем оно сможет подключиться. В этом кратком руководстве для регистрации имитируемого устройства используется Azure Cloud Shell.

1. Выполните приведенные ниже команды в Azure Cloud Shell, чтобы создать удостоверение устройства.

   **YourIoTHubName**. Замените этот заполнитель именем вашего Центра Интернета вещей.

   **MyDevice**. Это имя, присвоенное зарегистрированному устройству. Используйте имя MyDevice, как показано в примере. Если вы выбрали другое имя для устройства, используйте его при работе с этим руководством и обновите имя устройства в примерах приложений перед их запуском.

    ```azurecli-interactive
    az iot hub device-identity create --hub-name YourIoTHubName --device-id MyDevice
    ```

2. Выполните следующую команду в Azure Cloud Shell, чтобы получить _строку подключения_ зарегистрированного устройства:

   **YourIoTHubName**. Замените этот заполнитель именем вашего Центра Интернета вещей.

    ```azurecli-interactive
    az iot hub device-identity show-connection-string --hub-name YourIoTHubName --device-id MyDevice --output table
    ```

    Запишите строку подключения устройства, которая выглядит, как на следующем примере.

   `HostName={YourIoTHubName}.azure-devices.net;DeviceId=MyDevice;SharedAccessKey={YourSharedAccessKey}`

    Это значение понадобится позже в рамках этого краткого руководства.

3. Понадобится также *строка подключения к службе* из Центра Интернета вещей, чтобы включить приложение на стороне службы для подключения к Центру Интернета вещей и установить потоки устройств. Следующая команда получает это значение для Центра Интернета вещей:

   **YourIoTHubName**. Замените этот заполнитель именем вашего Центра Интернета вещей.

    ```azurecli-interactive
    az iot hub show-connection-string --policy-name service --name YourIoTHubName
    ```

    Запомните или запишите возвращаемое значение, которое выглядит следующим образом:

   `"HostName={YourIoTHubName}.azure-devices.net;SharedAccessKeyName=service;SharedAccessKey={YourSharedAccessKey}"`

## <a name="ssh-to-a-device-via-device-streams"></a>SSH-подключение к устройству через потоки устройств

В этом разделе показано, как установить сквозной поток для туннелирования трафика SSH.

### <a name="run-the-device-local-proxy"></a>Запуск локального прокси-сервера устройства

Перейдите к `device-streams-proxy/device` в распакованной папке проекта. Вам понадобятся следующие сведения.

| Имя аргумента | Значение аргумента |
|----------------|-----------------|
| `deviceConnectionString` | Строка подключения созданного ранее устройства. |
| `targetServiceHostName` | IP-адрес, на котором прослушивается сервер SSH (это будет `localhost`, если IP-адрес тот, на котором запущен локальный прокси-сервер устройства). |
| `targetServicePort` | Порт, используемый протоколом приложения (по умолчанию это будет порт 22 для SSH).  |

Скомпилируйте и запустите код, как показано:

```
cd ./iot-hub/Quickstarts/device-streams-proxy/device/

# Build the application
dotnet build

# Run the application
# In Linux/MacOS
dotnet run $deviceConnectionString localhost 22

# In Windows
dotnet run %deviceConnectionString% localhost 22
```

### <a name="run-the-service-local-proxy"></a>Запуск прокси-сервера на стороне службы

Перейдите к `device-streams-proxy/service` в распакованной папке проекта. Вам понадобятся следующие сведения.

| Имя параметра | Значение параметра |
|----------------|-----------------|
| `iotHubConnectionString` | Строка подключения к службе Центра Интернета вещей. |
| `deviceId` | Идентификатор устройства, созданного ранее. |
| `localPortNumber` | Локальный порт, к которому будет подключаться клиент SSH. В этом примере мы используем порт 2222, но его можно заменить другими произвольными числами. |

Скомпилируйте и запустите код, как показано:

```
cd ./iot-hub/Quickstarts/device-streams-proxy/service/

# Build the application
dotnet build

# Run the application
# In Linux/MacOS
dotnet run $serviceConnectionString MyDevice 2222

# In Windows
dotnet run %serviceConnectionString% MyDevice 2222
```

### <a name="run-ssh-client"></a>Запуск клиента SSH

Теперь с помощью программы клиента SSH подключитесь к локальному прокси-серверу службы на порте 2222 (вместо подключения напрямую через управляющую программу SSH).

```
ssh <username>@localhost -p 2222
```

На этом этапе откроется командная строка входа SSH для ввода учетных данных.

Вывод на консоль на стороне службы (локальный прокси-сервер службы прослушивает порт 2222):

![Выходные данные локального прокси-приложения службы](./media/quickstart-device-streams-proxy-csharp/service-console-output.png)

Вывод на консоль на локальном прокси-сервере устройства, который подключается к управляющей программе SSH по адресу `IP_address:22`:

![Вывод локального прокси-приложения на устройстве](./media/quickstart-device-streams-proxy-csharp/device-console-output.png)

Вывод на консоль клиентской программы SSH (клиент SSH связывается с управляющей программой SSH, подключаясь к порту 22, где прослушивает локальный прокси-сервер службы):

![Выходные данные клиентской программы SSH](./media/quickstart-device-streams-proxy-csharp/ssh-console-output.png)

## <a name="rdp-to-a-device-via-device-streams"></a>RDP-подключение к устройству через потоки устройств

Настройка для RDP очень похожа на настройку SSH (описанную выше). Нам нужно использовать вместо этого IP-адрес назначения RDP и порт 3389, а также использовать клиент RDP (вместо клиента SSH).

### <a name="run-the-device-local-proxy-rdp"></a>Запуск локального прокси-сервера устройства (RDP)

Перейдите к `device-streams-proxy/device` в распакованной папке проекта. Вам понадобятся следующие сведения.

| Имя аргумента | Значение аргумента |
|----------------|-----------------|
| `DeviceConnectionString` | Строка подключения созданного ранее устройства. |
| `targetServiceHostName` | Имя узла или IP-адрес, на котором включен сервер RDP (это будет `localhost`, если IP-адрес тот, на котором запущен локальный прокси-сервер устройства). |
| `targetServicePort` | Порт, используемый протоколом приложения (по умолчанию это будет порт 3389 для RDP).  |

Скомпилируйте и запустите код, как показано:

```
cd ./iot-hub/Quickstarts/device-streams-proxy/device

# Run the application
# In Linux/MacOS
dotnet run $DeviceConnectionString localhost 3389

# In Windows
dotnet run %DeviceConnectionString% localhost 3389
```

### <a name="run-the-service-local-proxy-rdp"></a>Запуск локального прокси-сервера службы (RDP)

Перейдите к `device-streams-proxy/service` в распакованной папке проекта. Вам понадобятся следующие сведения.

| Имя параметра | Значение параметра |
|----------------|-----------------|
| `iotHubConnectionString` | Строка подключения к службе Центра Интернета вещей. |
| `deviceId` | Идентификатор устройства, созданного ранее. |
| `localPortNumber` | Локальный порт, к которому будет подключаться клиент SSH. В этом примере мы используем порт 2222, но его можно заменить другими произвольными числами. |

Скомпилируйте и запустите код, как показано:

```
cd ./iot-hub/Quickstarts/device-streams-proxy/service/

# Build the application
dotnet build

# Run the application
# In Linux/MacOS
dotnet run $serviceConnectionString MyDevice 2222

# In Windows
dotnet run %serviceConnectionString% MyDevice 2222
```

### <a name="run-rdp-client"></a>Запуск клиента RDP

Теперь с помощью программы клиента RDP подключитесь к локальному прокси-серверу службы через порт 2222 (это произвольный доступный порт, который был выбран ранее).

![Подключение по протоколу RDP к локальному прокси-приложению службы](./media/quickstart-device-streams-proxy-csharp/rdp-screen-capture.png)

## <a name="clean-up-resources"></a>Очистка ресурсов

[!INCLUDE [iot-hub-quickstarts-clean-up-resources](../../includes/iot-hub-quickstarts-clean-up-resources-device-streams.md)]

## <a name="next-steps"></a>Дополнительная информация

В рамках этого краткого руководства вы настроили Центр Интернета вещей, зарегистрировали устройство, развернули программу локальных прокси-серверов устройств и служб, чтобы установить поток устройств через Центр Интернета вещей, а также использовали прокси-серверы для туннелирования трафика SSH и RDP. Та же парадигма может размещать другие протоколы клиента или сервера (где сервер запущен на устройстве, например на управляющей программе SSH).

Используйте приведенные ниже ссылки для получения дополнительных сведений о потоках устройства:

> [!div class="nextstepaction"]
> [IoT Hub Device Streams (preview)](./iot-hub-device-streams-overview.md) (Потоки устройств (предварительная версия))