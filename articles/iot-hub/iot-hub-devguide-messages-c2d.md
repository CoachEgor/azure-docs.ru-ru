---
title: Принципы отправки сообщений Центра Интернета вещей Azure из облака на устройство | Документы Майкрософт
description: Это руководство для разработчиков описывается использование cloud-to-device обмена сообщениями с центром Интернета вещей. Он содержит сведения о жизненном цикле сообщения и параметры конфигурации.
author: wesmc7777
manager: philmea
ms.author: wesmc
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 03/15/2018
ms.openlocfilehash: 0fc1b65a4ba1c8a3d76b48206d6a4703035e05bc
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67055326"
---
# <a name="send-cloud-to-device-messages-from-an-iot-hub"></a>Отправка сообщений из облака на устройство из центра Интернета вещей

Для отправки односторонних уведомлений в приложение устройства из серверной части решения, отправка сообщений из облака на устройство из центра Интернета вещей на устройство. Обсуждение других вариантов облака на устройство, поддерживаемых центром Интернета вещей Azure, см. в разделе [руководство по обмену данными облака на устройство](iot-hub-devguide-c2d-guidance.md).

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Отправка сообщений из облака на устройство через конечную точку, обращенную к службе, */messages/devicebound*. Устройства затем получают эти сообщения через конечную точку конкретного устройства, */devices/ {deviceId} / messages/devicebound*.

Для каждого сообщения облака на устройство, отдельному устройству, центр Интернета вещей задает **для** свойства */devices/ {deviceId} / messages/devicebound*.

Одна очередь устройства содержит не более 50 сообщений, отправляемых с облака на устройство. Чтобы попытаться отправить несколько сообщений же устройства приведет к ошибке.

## <a name="the-cloud-to-device-message-life-cycle"></a>Жизненный цикл сообщения облака на устройство

Чтобы гарантировать по как минимум однократную доставку, центр Интернета вещей сохраняет облаком и устройством сообщения в очередях устройств. Для удаления сообщений из очереди в центре Интернета вещей устройства необходимо явным образом признаете *завершения*. Этот способ гарантирует устойчивость к сбоям подключения и ошибкам устройств.

Диаграмма жизненного цикла состояние отображается на следующей схеме:

![Жизненный цикл сообщения облака на устройство](./media/iot-hub-devguide-messages-c2d/lifecycle.png)

Когда службы центра Интернета вещей отправляет сообщение на устройство, служба устанавливает состояние сообщения *поставлено в очередь*. Когда устройству нужно *получать* сообщение, центр Интернета вещей *блокировки* сообщения, задав состояния *невидимым*. Это состояние позволяет других потоков на устройстве начали получать другие сообщения. Когда поток устройства завершает обработку сообщения, он уведомляет центр Интернета вещей путем *Завершение* сообщение. Центр Интернета вещей затем устанавливает состояние *завершено*.

Устройство также может:

* *Отклонить* сообщение, в результате чего центр Интернета вещей переводит его *очередь недоставленных происходит* состояния. Устройства, подключаемые по протоколу транспорта очереди телеметрии сообщения (MQTT) не могут отклонять сообщения из облака на устройство.

* *Отказаться от* сообщение, в результате чего центр Интернета вещей помещает сообщения в очередь, с состоянием *поставлено в очередь*. Устройства, подключаемые по протоколу MQTT невозможно отказаться от сообщения из облака на устройство.

Поток не сможет обработать сообщение без уведомления центра Интернета вещей. В этом случае сообщения автоматически меняется с *невидимым* состояния обратно *поставлено в очередь* состоянии отказоустойчивости после *видимость* времени ожидания (или *блокировки* времени ожидания). Значение по умолчанию это время ожидания — одна минута.

**Макс. Число доставок** центра Интернета вещей определяет максимальное количество раз, сообщения может изменяться между *поставлено в очередь* и *невидимым* состояний. После такого количества изменений центр Интернета вещей задает состояние сообщения для *очередь недоставленных происходит*. Таким же образом центр Интернета вещей устанавливает состояние сообщения *очередь недоставленных происходит* после истечения срока. Дополнительные сведения см. в разделе [срок жизни](#message-expiration-time-to-live).

[Способ отправки сообщений из облака на устройство с центром Интернета вещей](iot-hub-csharp-csharp-c2d.md) статье показано, как отправка сообщений из облака на устройство из облака и получать их на устройстве.

Обычно это сообщение завершается устройством сообщение из облака на устройство при потере сообщения не влияет на логику приложения. Примером этого могут быть, когда устройство имеет постоянное содержимое сообщения локально или успешно выполнен операцией. Сообщение может также содержать временные сведения, потеря которых не влияет на функциональность приложения. Иногда при работе с длительно выполняемыми задачами можно сделать следующее:

* Выполните сообщения из облака на устройство, после того устройства имеет постоянное описание задачи в локальном хранилище.

* Отправить одно или несколько сообщений (с устройства в облако) в серверную часть решения на различных этапах выполнения задачи.

## <a name="message-expiration-time-to-live"></a>Срок действия сообщения (срок жизни)

Каждое сообщение из облака на устройство имеет срок действия. Это время задается одно из следующих:

* **ExpiryTimeUtc** свойства в службе
* Центр Интернета вещей, используя значение по умолчанию *срок жизни* , указанный как свойство центра Интернета вещей

Ознакомьтесь с разделом [Параметры конфигурации сообщений, отправляемых из облака на устройство](#cloud-to-device-configuration-options).

Обычно Чтобы воспользоваться преимуществами срок действия сообщения и сообщения не отправлялись на отключенные устройства — присвоить короткий *срок жизни* значения. Этот подход дает тот же результат, что и поддержание состояния подключения устройства, но это более эффективно. При запросе подтверждения сообщений центр Интернета вещей уведомляет о том, какие устройства.

* могут получать сообщения;
* находятся в автономном режиме или в состоянии сбоя.

## <a name="message-feedback"></a>Отзыв на сообщение

При отправке сообщения из облака на устройство, служба может запросить доставку каждого сообщения отзыв о конечное состояние этого сообщения. Это можно сделать, задав **iothub-ack** свойство приложения в сообщении облаком и устройством, которое отправляется одно из следующих четырех значений:

| Значение свойства ACK | Поведение |
| ------------ | -------- |
| нет     | Центр Интернета вещей не создает отзыв на сообщение (поведение по умолчанию). |
| Позитивная | Если сообщения из облака на устройство достигает *завершено* state, центр Интернета вещей создает отзыв на сообщение. |
| Отрицательное | Если сообщения из облака на устройство достигает *очередь недоставленных происходит* state, центр Интернета вещей создает отзыв на сообщение. |
| полный     | Центр Интернета вещей создает отзыв на сообщение в любом случае. |

Если **Ack** значение *полный*и вы не получите отзыв на сообщение, это означает, что сообщение о истек. Служба не знает, что случилось с исходным сообщением. На практике служба должна убедиться, что может обработать отзыв до истечения срока его действия. Максимальный срок действия составляет два дня, времени достаточно для службы повторного запуска при сбое.

Как описано в [конечные точки](iot-hub-devguide-endpoints.md), центр Интернета вещей предоставляет отзывы через конечную точку, обращенную к службе, */messages/servicebound/feedback*, как сообщения. Семантика получения отзыва идентична семантике, используемой для сообщений, отправляемых из облака на устройство. По возможности отзывы на сообщения группируются в одно сообщение, имеющее приведенный ниже формат:

| Свойство     | Описание |
| ------------ | ----------- |
| EnqueuedTime | Метка времени, которое указывает, когда Центр получил отзыв на сообщение |
| UserId       | `{iot hub name}` |
| ContentType  | `application/vnd.microsoft.iothub.feedback.json` |

Основная часть — это сериализованный массив записей JSON, каждая из которых имеет следующие свойства:

| Свойство           | Описание |
| ------------------ | ----------- |
| EnqueuedTimeUtc    | Указывает, когда произошло результат сообщения метку времени (например, центр получил отзыв на сообщение или истек срок действия исходного сообщения) |
| OriginalMessageId  | *MessageId* сообщения облака на устройство, к которому относятся эти сведения отзыва |
| StatusCode         | Требуется строка, используемая в сообщений обратной связи, созданные центром Интернета вещей: <br/> *Success* <br/> *истек срок действия* <br/> *DeliveryCountExceeded* <br/> *Отклонено* <br/> *Очищено* |
| Описание        | Строковые значения для *StatusCode* |
| deviceId           | *DeviceId* целевого устройства сообщения облака на устройство, к которому относится это часть обратной связи |
| DeviceGenerationId | *DeviceGenerationId* целевого устройства сообщения облака на устройство, к которому относится это часть обратной связи |

Сообщения облака на устройство соотнести свой отзыв с исходным сообщением, служба должна указать *MessageId*.

В следующем коде показан текст отзыв на сообщение:

```json
[
  {
    "OriginalMessageId": "0987654321",
    "EnqueuedTimeUtc": "2015-07-28T16:24:48.789Z",
    "StatusCode": 0,
    "Description": "Success",
    "DeviceId": "123",
    "DeviceGenerationId": "abcdefghijklmnopqrstuvwxyz"
  },
  {
    ...
  },
  ...
]
```

## <a name="cloud-to-device-configuration-options"></a>Параметры конфигурации сообщений, отправляемых из облака на устройство

Каждый Центр Интернета вещей предоставляет следующие параметры конфигурации для отправки сообщений из облака на устройство.

| Свойство                  | Описание | Диапазон и значение по умолчанию |
| ------------------------- | ----------- | ----------------- |
| defaultTtlAsIso8601       | По умолчанию срок ЖИЗНИ для сообщений из облака на устройство | Интервал ISO_8601 — до 2 дней (минимум 1 минута); значение по умолчанию: 1 час |
| maxDeliveryCount          | Максимальное число доставок для очереди облаком и устройством на уровне отдельного устройства | 1 до 100; значение по умолчанию: 10 |
| feedback.ttlAsIso8601     | Срок хранения для службы отзывов, направленных | Интервал ISO_8601 — до 2 дней (минимум 1 минута); значение по умолчанию: 1 час |
| feedback.maxDeliveryCount | Максимальное число доставок для очереди отзывов | 1 до 100; значение по умолчанию: 100 |

Дополнительные сведения о настройке этих параметров конфигурации см. в статье [Создание Центра Интернета вещей с помощью портала Azure](iot-hub-create-through-portal.md).

## <a name="next-steps"></a>Дальнейшие действия

Сведения о пакетах SDK, которые можно использовать для получения сообщений из облака на устройство, см. в разделе [Azure IoT SDKs](iot-hub-devguide-sdks.md).

Инструкции по настройке получения сообщений, передаваемых из облака на устройство, см. в статье [Отправка сообщений из облака на устройство с помощью Центра Интернета вещей (.NET)](iot-hub-csharp-csharp-c2d.md).
