---
title: Принципы отправки сообщений Центра Интернета вещей Azure из облака на устройство | Документы Майкрософт
description: В этом руководстве для разработчиков обсуждается, как использовать облачные сообщения с помощью концентратора IoT. Она включает в себя информацию о жизненном цикле сообщения и вариантах конфигурации.
author: wesmc7777
manager: philmea
ms.author: wesmc
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 03/15/2018
ms.custom: mqtt
ms.openlocfilehash: 307ab47c1f7498f71e61108a616d35ef1d4f61c9
ms.sourcegitcommit: ffc6e4f37233a82fcb14deca0c47f67a7d79ce5c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81729997"
---
# <a name="send-cloud-to-device-messages-from-an-iot-hub"></a>Отправка сообщений об облаке и устройства из концентратора IoT

Чтобы отправить односторонние уведомления в приложение устройства из задней части решения, отправьте сообщения от облака к устройству с вашего концентратора IoT на устройство. Для обсуждения других вариантов [связи](iot-hub-devguide-c2d-guidance.md)«облако к устройству», поддерживаемых Концентратором Изоза, см.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Вы отправляете сообщения от облака к устройству через конечную точку *обслуживания, /сообщения/устройства.* Затем устройство получает сообщения через конкретную конечную точку *устройства, /устройства/устройства/устройства/сообщения/устройства.*

Чтобы настроить таргетинг на каждое сообщение обобучки к устройству на одном устройстве, концентратор IoT устанавливает **свойство** *на /устройства/устройства/устройства/сообщения/устройства.*

В каждой очереди устройств содержится не более 50 сообщений от облака к устройству. Попытка отправить больше сообщений на одно и то же устройство приводит к ошибке.

## <a name="the-cloud-to-device-message-life-cycle"></a>Жизненный цикл сообщения от облака к устройству

Чтобы гарантировать доставку сообщений по крайней мере один раз, концентратор IoT сохраняет сообщения от облака к устройству в очередях на устройство. Для удаления концентратора IoT для удаления сообщений из очереди устройства должны четко подтвердить *завершение.* Этот способ гарантирует устойчивость к сбоям подключения и ошибкам устройств.

График состояния жизненного цикла отображается на следующей диаграмме:

![Жизненный цикл сообщения от облака к устройству](./media/iot-hub-devguide-messages-c2d/lifecycle.png)

Когда служба концентратора IoT отправляет сообщение на устройство, служба устанавливает состояние сообщения *в Enqueued.* Когда устройство хочет *получить* сообщение, концентратор IoT *блокирует* сообщение, устанавливая состояние на *невидимое.* Это состояние позволяет другим потокам на устройстве начать получать другие сообщения. Когда поток устройства завершает обработку сообщения, он уведомляет концентратор IoT, *заполнив* сообщение. Затем концентратор IoT устанавливает состояние для *завершения.*

Устройство также может:

* *Отклонить* сообщение, которое заставляет концентратор IoT установить его в состояние *Dead буквенное.* Устройства, которые соединяются по протоколу телеметрии связи сообщений, не могут отклонять сообщения от облака к устройству.

* *Откажитесь от* сообщения, которое заставляет концентратор IoT вернуть сообщение в очередь, при этом состояние настроено на *Enqueued.* Устройства, которые соединяются по протоколу МЗТТ, не могут отказаться от сообщений от облака к устройству.

Поток может не обработать сообщение без уведомления концентратора IoT. В этом случае сообщения автоматически переходят из состояния *Невидимого* обратно в состояние *Enqueued* после тайм-аута *видимости* (или *блокировки* тайм-аута). Значение этого тайм-аута составляет одну минуту и не может быть изменено.

**Свойство max delivery count** на концентраторе IoT определяет максимальное количество раз, когда сообщение может переходить между *состояниями Enqueued* и *Invisible.* После этого количества переходов концентратор IoT устанавливает состояние сообщения *на Dead lettered*. Аналогичным образом концентратор IoT устанавливает состояние сообщения *Dead, буквированного* по истечении срока его действия. Для получения дополнительной информации, см [Время жить](#message-expiration-time-to-live).

В статье «Как отправлять сообщения об [облаке к устройству» в](iot-hub-csharp-csharp-c2d.md) статье IoT Hub показано, как отправлять сообщения обобут-устройств из облака и получать их на устройстве.

Обычно устройство завершает сообщение об лаконик-устройство, когда потеря сообщения не влияет на логику приложения. Примером этого может быть, когда устройство сохранило содержимое сообщения локально или успешно выполнило операцию. Сообщение также может нести переходную информацию, потеря которой не повлияет на функциональность приложения. Иногда при работе с длительно выполняемыми задачами можно сделать следующее:

* Заполните сообщение об лакт-устройстве после того, как устройство сохранило описание задачи в локальном хранилище.

* Отправить одно или несколько сообщений (с устройства в облако) в серверную часть решения на различных этапах выполнения задачи.

## <a name="message-expiration-time-to-live"></a>Срок действия сообщения (срок жизни)

Каждое сообщение из облака на устройство имеет срок действия. Это время устанавливается одним из следующих:

* **Свойство ExpiryTimeUtc** в сервисе
* Концентратор IoT, используя *время* проживания по умолчанию, указанное как свойство концентратора IoT

Ознакомьтесь с разделом [Параметры конфигурации сообщений, отправляемых из облака на устройство](#cloud-to-device-configuration-options).

Распространенным способом воспользоваться истечением срока действия сообщения и избежать отправки сообщений на отключенные устройства является установление короткого *времени для живых* значений. Этот подход достигает того же результата при поддержании состояния соединения устройства, но он более эффективен. При запросе подтверждения сообщений концентратор IoT уведомляет вас, какие устройства являются:

* могут получать сообщения;
* находятся в автономном режиме или в состоянии сбоя.

## <a name="message-feedback"></a>Отзыв на сообщение

При отправке сообщения об облаке к устройству служба может запросить доставку отзывов об окончательном состоянии сообщения. Вы делаете это, устанавливая свойство приложения **iothub-ack** в сообщении об лакт-устройства, которое отправляется в одно из следующих четырех значений:

| Значение свойства Ack | Поведение |
| ------------ | -------- |
| none     | Концентратор IoT не генерирует сообщение обратной связи (поведение по умолчанию). |
| Позитивная | Если сообщение об лакт-устройстве достигает состояния *завершено,* концентратор IoT генерирует сообщение обратной связи. |
| Негативная | Если сообщение «облако-устройство» достигает состояния *Dead lettered,* концентратор IoT генерирует сообщение обратной связи. |
| переполненные     | Концентратор IoT генерирует сообщение обратной связи в любом случае. |

Если значение **Ack** *заполнено,* и вы не получаете сообщение обратной связи, это означает, что сообщение обратной связи истекло. Служба не знает, что случилось с исходным сообщением. На практике служба должна убедиться, что может обработать отзыв до истечения срока его действия. Максимальный срок действия составляет два дня, что оставляет время, чтобы запустить службу снова, если происходит сбой.

Как поясняется в [Endpoints,](iot-hub-devguide-endpoints.md)концентратор IoT обеспечивает обратную связь через конечную точку обслуживания, */сообщения/сервисные/обратную связь,* в виде сообщений. Семантика получения отзыва идентична семантике, используемой для сообщений, отправляемых из облака на устройство. По возможности отзывы на сообщения группируются в одно сообщение, имеющее приведенный ниже формат:

| Свойство.     | Описание |
| ------------ | ----------- |
| EnqueuedTime | Метка времени, указываюслучайная, когда сообщение обратной связи было получено концентратором |
| UserId       | `{iot hub name}` |
| ContentType  | `application/vnd.microsoft.iothub.feedback.json` |

Основная часть — это сериализованный массив записей JSON, каждая из которых имеет следующие свойства:

| Свойство.           | Описание |
| ------------------ | ----------- |
| EnqueuedTimeUtc    | Отметка времени, указываюметода, когда результат сообщения произошел (например, концентратор получил сообщение обратной связи или исходное сообщение истекло) |
| OriginalMessageId  | *Сообщение MessageId* сообщения об лакт-устройстве, к которому относится эта информация обратной связи |
| StatusCode         | Необходимая строка, используемая в сообщениях обратной связи, генерируемых концентратором IoT: <br/> *Success* <br/> *Срок действия истек* <br/> *ДоставкаCountПревысила* <br/> *Отклонено* <br/> *Очищены* |
| Описание        | Значения строки для *StatusCode* |
| deviceId           | *DeviceId* целевого устройства сообщения об лакт-устройства, к которому относится эта часть обратной связи |
| DeviceGenerationId | *DeviceGenerationId* целевого устройства сообщения об лакт-устройства, к которому относится эта часть обратной связи |

Для того чтобы сообщение «облако к устройству» соотведело свою обратную связь с исходным сообщением, служба должна указать *MessageId.*

Тело сообщения обратной связи отображается в следующем коде:

```json
[
  {
    "OriginalMessageId": "0987654321",
    "EnqueuedTimeUtc": "2015-07-28T16:24:48.789Z",
    "StatusCode": 0,
    "Description": "Success",
    "DeviceId": "123",
    "DeviceGenerationId": "abcdefghijklmnopqrstuvwxyz"
  },
  {
    ...
  },
  ...
]
```

**Обратная связь для удаленных устройств**

При удалении устройства все ожидающие обратной связи также удаляются. Обратная связь с устройствами отправляется партиями. Если устройство удаляется в узком окне (часто менее 1 секунды) между тем, когда устройство подтверждает получение сообщения и когда будет подготовлена следующая партия обратной связи, обратная связь не будет получена.

Вы можете решить эту проблему, подяневшись период времени, когда не ожидающая обратной связи, прежде чем удалять устройство. Связанные отзывы сообщений следует считать потерянными после удаления устройства.

## <a name="cloud-to-device-configuration-options"></a>Параметры конфигурации сообщений, отправляемых из облака на устройство

Каждый Центр Интернета вещей предоставляет следующие параметры конфигурации для отправки сообщений из облака на устройство.

| Свойство.                  | Описание | Диапазон и значение по умолчанию |
| ------------------------- | ----------- | ----------------- |
| defaultTtlAsIso8601       | По умолчанию TTL для сообщений от облака до устройства | интервал ISO_8601 до 2 дней (минимум 1 минута); по умолчанию: 1 час |
| maxDeliveryCount          | Максимальное количество доставки для очередей от облака к устройству на устройство | от 1 до 100; по умолчанию: 10 |
| feedback.ttlAsIso8601     | Сохранение сообщений обратной связи, привязанных к службам | интервал ISO_8601 до 2 дней (минимум 1 минута); по умолчанию: 1 час |
| feedback.maxDeliveryCount | Максимальное количество доставки для очереди обратной связи | от 1 до 100; по умолчанию: 10 |
| feedback.lockDurationAsIso8601 | Максимальное количество доставки для очереди обратной связи | интервал ISO_8601 от 5 до 300 секунд (минимум 5 секунд); по умолчанию: 60 секунд. |

Параметры конфигурации можно установить следующим образом:

* **Портал Azure:** Под **настройками** концентратора IoT выберите **встроенные конечные точки** и расширьте **Cloud для обмена сообщениями с устройствами.** (Настройка **свойств feedback.maxDeliveryCount** и **feedback.lockDurationAsIso8601** в настоящее время не поддерживается на портале Azure.)

    ![Установка параметров конфигурации для обмена сообщениями об облаке и устройствах на портале](./media/iot-hub-devguide-messages-c2d/c2d-configuration-portal.png)

* **Azure CLI:** Используйте команду [обновления концентратора az iot:](https://docs.microsoft.com/cli/azure/iot/hub?view=azure-cli-latest#az-iot-hub-update)

    ```azurecli
    az iot hub update --name {your IoT hub name} \
        --set properties.cloudToDevice.defaultTtlAsIso8601=PT1H0M0S

    az iot hub update --name {your IoT hub name} \
        --set properties.cloudToDevice.maxDeliveryCount=10

    az iot hub update --name {your IoT hub name} \
        --set properties.cloudToDevice.feedback.ttlAsIso8601=PT1H0M0S

    az iot hub update --name {your IoT hub name} \
        --set properties.cloudToDevice.feedback.maxDeliveryCount=10

    az iot hub update --name {your IoT hub name} \
        --set properties.cloudToDevice.feedback.lockDurationAsIso8601=PT0H1M0S
    ```

## <a name="next-steps"></a>Следующие шаги

Для получения информации о SDK, которые можно использовать для [Azure IoT SDKs](iot-hub-devguide-sdks.md)получения сообщений от облака до устройства, см.

Инструкции по настройке получения сообщений, передаваемых из облака на устройство, см. в статье [Отправка сообщений из облака на устройство с помощью Центра Интернета вещей (.NET)](iot-hub-csharp-csharp-c2d.md).
