---
title: Как клонировать концентратор Azure IoT
description: Как клонировать концентратор Azure IoT
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 12/09/2019
ms.author: robinsh
ms.openlocfilehash: c54853717f7e0b234df013e5aee575682d0d3d97
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75429153"
---
# <a name="how-to-clone-an-azure-iot-hub-to-another-region"></a>Как клонировать концентратор Azure IoT в другой регион

В этой статье рассматриваются способы клонирования концентратора IoT и приведены некоторые вопросы, на которые необходимо ответить перед началом. Вот несколько причин, по которым вы можете клонировать концентратор IoT:
 
* Вы перемещаете свою компанию из одного региона в другой, например, из Европы в Северную Америку (или наоборот), и вы хотите, чтобы ваши ресурсы и данные были географически близки к вашему новому местоположению, поэтому вам необходимо переместить свой концентратор.

* Вы создаете концентратор для разработки по сравнению с производственной средой.

* Требуется сделать пользовательскую реализацию мультикузонной высокой доступности. Для получения дополнительной информации [см. Как достичь поперечного региона HA раздел IoT концентратор высокой доступности и аварийного восстановления](iot-hub-ha-dr.md#achieve-cross-region-ha).

* Необходимо увеличить количество [разделов,](iot-hub-scaling.md#partitions) настроенных для концентратора. Это устанавливается при первом создании концентратора и не может быть изменено. Информацию в этой статье можно использовать для клонирования концентратора, а при создании клона увеличьте количество разделов.

Чтобы клонировать концентратор, необходима подписка с административным доступом к исходной концентратору. Новый концентратор можно поместить в новую группу ресурсов и регион, в ту же подписку, что и исходный концентратор, или даже в новую подписку. Вы просто не можете использовать одно и то же имя, потому что название концентратора должно быть глобально уникальным.

> [!NOTE]
> В настоящее время нет функции, доступной для автоматического клонирования концентратора IoT. Это в первую очередь ручной процесс, и, таким образом, довольно подвержены ошибкам. Сложность клонирования концентратора прямо пропорциональна сложности концентратора. Например, клонирование концентратора IoT без разгрома сообщений довольно просто. Если добавить разгром сообщений как одну сложность, клонирование концентратора становится по крайней мере на порядок сложнее. Если вы также перемещаете ресурсы, используемые для конечных точек, это еще один порядок магнитуры сложнее. 

## <a name="things-to-consider"></a>Полезная информация

Перед клонированием концентратора IoT необходимо рассмотреть несколько вопросов.

* Убедитесь, что все функции, доступные в исходном месте, также доступны в новом месте. Некоторые службы находятся в предварительном просмотре, и не все функции доступны везде.

* Не удаляйте исходные ресурсы перед созданием и проверкой клонированной версии. После удаления концентратора он исчезнет навсегда, и нет никакого способа восстановить его, чтобы проверить настройки или данные, чтобы убедиться, что концентратор реплицируется правильно.

* Многие ресурсы требуют глобально уникальных имен, поэтому вы должны использовать различные имена для клонированных версий. Также следует использовать другое имя для группы ресурсов, к которой принадлежит клонированный концентратор. 

* Данные для исходного концентратора IoT не мигрируют. Это включает телеметрические сообщения, команды «облако к устройству» (C2D) и информацию о работе, такую как расписание и история. Метрики и результаты регистрации также не мигрируют. 

* Для данных или сообщений, направляемых в Хранилище Azure, можно оставить данные в исходной учетной записи хранилища, перенести эти данные на новую учетную запись хранения в новом регионе или оставить старые данные на месте и создать новую учетную запись хранилища в новом месте для новых данных. Для получения дополнительной информации о перемещении данных в хранилище Blob [см.](../storage/common/storage-use-azcopy-v10.md)

* Данные для концентраторов событий и для тем и очередей служебных автобусов не могут быть перенесены. Это данные по точечной и не хранятся после обработки сообщений.

* Необходимо запланировать время простоя для миграции. Клонирование устройств в новый концентратор требует времени. Если вы используете метод импорта/экспорта, тестирование теста показало, что для перемещения 500 000 устройств может уйти около двух часов, а для перемещения миллиона устройств может уйти четыре часа. 

* Вы можете скопировать устройства в новый концентратор без выключения или изменения устройств. 

    * Если устройства были первоначально подготовлены с помощью DPS, переподготовка их обновляет информацию о подключении, хранящуюся в каждом устройстве. 
    
    * В противном случае необходимо использовать метод импорта/экспорта для перемещения устройств, а затем устройства должны быть изменены, чтобы использовать новый концентратор. Например, можно настроить устройство для потребления имени хоста IoT Hub из желаемых свойств близнецов. Устройство будет принимать это имя хоста Концентратора IoT, отключать устройство от старого концентратора и переподключать его к новому.
    
* Вам необходимо обновить все сертификаты, которые вы используете, чтобы вы могли использовать их с новыми ресурсами. Кроме того, у вас, вероятно, есть концентратор, определенный в таблице DNS где-то - вам нужно будет обновить эту информацию DNS.

## <a name="methodology"></a>Методика

Это общий метод, который мы рекомендуем для перемещения концентратора IoT из одного региона в другой. Для разгрома сообщений это предполагает, что ресурсы не перемещаются в новый регион. Для получения дополнительной информации смотрите [раздел о реутировке сообщений](#how-to-handle-message-routing).

   1. Экспорт концентратора и его настроек в шаблон менеджера ресурсов. 
   
   1. Внести необходимые изменения в шаблон, такие как обновление всех случаев имени и местоположения клонированного концентратора. Для любых ресурсов в шаблоне, используемых для конечных точек разгрома сообщений, обновите ключ в шаблоне для этого ресурса.
   
   1. Импортшаблона в новую группу ресурсов в новом местоположении. Это создает клон.

   1. Отладить по мере необходимости. 
   
   1. Добавьте в шаблон все, что не было экспортировано. 
   
       Например, группы потребителей не экспортируются в шаблон. Необходимо добавить группы потребителей в шаблон вручную или использовать [портал Azure](https://portal.azure.com) после создания концентратора. Есть пример добавления одной группы потребителей в шаблон в статье [Используйте шаблон менеджера ресурсов Azure для настройки разгрома сообщений IoT Hub.](tutorial-routing-config-message-routing-rm-template.md)
       
   1. Копируйте устройства от исходного концентратора до клона. Это описано в разделе [Управление устройствами, зарегистрированными в концентраторе IoT.](#managing-the-devices-registered-to-the-iot-hub)

## <a name="how-to-handle-message-routing"></a>Как обрабатывать разгром сообщений

Если концентратор использует [пользовательский routing,](iot-hub-devguide-messages-read-custom.md)экспорт шаблона для концентратора включает конфигурацию концентрации, но не включает сами ресурсы. Вы должны выбрать, перемещать ли ресурсы реаутинга на новое место или оставить их на месте и продолжать использовать их «как есть». 

Например, например, у вас есть концентратор в Западной США, который перенаследует сообщения на учетную запись хранения (также в Западной ЧАСТИ США), и вы хотите переместить концентратор в Восточную ЧАСТЬ США. Вы можете переместить концентратор и до сих пор направлять сообщения на учетную запись хранения в Западной ЧАСТИ США, или переместить концентратор, а также переместить учетную запись хранилища. В другом регионе может быть небольшой удар производительности от сообщений к конечным точкам.

Можно довольно легко переместить концентратор, который использует разгром сообщений, если не перемещать ресурсы, используемые для конечных точек вхады. 

Если концентратор использует разгром сообщений, у вас есть два варианта. 

1. Переместите ресурсы, используемые для конечных точек реуктора, в новое местоположение.

    * Новые ресурсы необходимо создавать самостоятельно либо вручную на [портале Azure,](https://portal.azure.com) либо с помощью шаблонов «Менеджер ресурсов». 

    * При создании всех ресурсов необходимо переименовать все ресурсы в новом месте, так как они имеют глобально уникальные имена. 
     
    * Перед созданием нового концентратора необходимо обновить имена ресурсов и ключи ресурса в шаблоне нового концентратора. Ресурсы должны присутствовать при создании нового концентратора.

1. Не перемещайте ресурсы, используемые для конечных точек рекрутинга. Используйте их "на месте".

   * На этапе, когда вы отоденали шаблон, вам нужно будет получить ключи для каждого ресурса для разгрома и поместить их в шаблон перед созданием нового концентратора. 

   * Концентратор по-прежнему ссылается на исходные ресурсы маршрутизации и направляет сообщения к ним как настроенные.

   * Вы будете иметь небольшой хит производительности, потому что концентратор и ресурсы конечных точек разгрома не находятся в том же месте.

## <a name="prepare-to-migrate-the-hub-to-another-region"></a>Подготовка к переносу концентра та и ногой в другой регион

В этом разделе содержатся конкретные инструкции по миграции концентратора.

### <a name="find-the-original-hub-and-export-it-to-a-resource-template"></a>Найдите исходный концентратор и экспортируйего его в шаблон ресурса.

1. Войти на [портал Azure](https://portal.azure.com). 

1. Перейдите в **группы ресурсов** и выберите группу ресурсов, содержащую выбранный концентратор, который вы хотите переместить. Вы также можете перейти к **ресурсам** и найти концентратор таким образом. Выберите концентратор.

1. Выберите **шаблон Экспорта** из списка свойств и настроек для концентратора. 

   ![Скриншот, показывающий команду для экспорта шаблона для концентратора IoT.](./media/iot-hub-how-to-clone/iot-hub-export-template.png)

1. Выберите **Скачать,** чтобы загрузить шаблон. Сохранить файл где-то вы можете найти его снова. 

   ![Скриншот, показывающий команду для загрузки шаблона для концентратора IoT.](./media/iot-hub-how-to-clone/iot-hub-download-template.png)

### <a name="view-the-template"></a>Просмотрите шаблон 

1. Перейдите в папку Загрузки (или в какую бы папку вы использовали при экспорте шаблона) и найдите файл застежки-молнии. Откройте почтовый файл и `template.json`найдите файл под названием. Выберите его, а затем выберите Ctrl'C, чтобы скопировать шаблон. Перейти к другой папке, которая не в почтовом файле и вставьте файл (Ctrl'V). Теперь вы можете отодвить его.
 
    Следующий пример для общего концентратора без конфигурации реуктора. Это концентратор уровня S1 (с 1 единицей) называется **ContosoTestHub29358** в регионе **westus**. Вот экспортированный шаблон.

    ``` json
    {
        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {
            "IotHubs_ContosoTestHub29358_name": {
                "defaultValue": "ContosoTestHub29358",
                "type": "String"
            }
        },
        "variables": {},
        "resources": [
            {
                "type": "Microsoft.Devices/IotHubs",
                "apiVersion": "2018-04-01",
                "name": "[parameters('IotHubs_ContosoTestHub29358_name')]",
                "location": "westus",
                "sku": {
                    "name": "S1",
                    "tier": "Standard",
                    "capacity": 1
                },
                "properties": {
                    "operationsMonitoringProperties": {
                        "events": {
                            "None": "None",
                            "Connections": "None",
                            "DeviceTelemetry": "None",
                            "C2DCommands": "None",
                            "DeviceIdentityOperations": "None",
                            "FileUploadOperations": "None",
                            "Routes": "None"
                        }
                    },
                    "ipFilterRules": [],
                    "eventHubEndpoints": {
                        "events": {
                            "retentionTimeInDays": 1,
                            "partitionCount": 2,
                            "partitionIds": [
                                "0",
                                "1"
                            ],
                            "path": "contosotesthub29358",
                            "endpoint": "sb://iothub-ns-contosotes-2227755-92aefc8b73.servicebus.windows.net/"
                        },
                        "operationsMonitoringEvents": {
                            "retentionTimeInDays": 1,
                            "partitionCount": 2,
                            "partitionIds": [
                                "0",
                                "1"
                            ],
                            "path": "contosotesthub29358-operationmonitoring",
                            "endpoint": "sb://iothub-ns-contosotes-2227755-92aefc8b73.servicebus.windows.net/"
                        }
                    },
                    "routing": {
                        "endpoints": {
                            "serviceBusQueues": [],
                            "serviceBusTopics": [],
                            "eventHubs": [],
                            "storageContainers": []
                        },
                        "routes": [],
                        "fallbackRoute": {
                            "name": "$fallback",
                            "source": "DeviceMessages",
                            "condition": "true",
                            "endpointNames": [
                                "events"
                            ],
                            "isEnabled": true
                        }
                    },
                    "storageEndpoints": {
                        "$default": {
                            "sasTtlAsIso8601": "PT1H",
                            "connectionString": "",
                            "containerName": ""
                        }
                    },
                    "messagingEndpoints": {
                        "fileNotifications": {
                            "lockDurationAsIso8601": "PT1M",
                            "ttlAsIso8601": "PT1H",
                            "maxDeliveryCount": 10
                        }
                    },
                    "enableFileUploadNotifications": false,
                    "cloudToDevice": {
                        "maxDeliveryCount": 10,
                        "defaultTtlAsIso8601": "PT1H",
                        "feedback": {
                            "lockDurationAsIso8601": "PT1M",
                            "ttlAsIso8601": "PT1H",
                            "maxDeliveryCount": 10
                        }
                    },
                    "features": "None"
                }
            }
        ]
    }
    ```

### <a name="edit-the-template"></a>Изменение шаблона 

Прежде чем использовать шаблон для создания нового концентратора в новом регионе, необходимо внести некоторые изменения. Используйте [VS Code](https://code.visualstudio.com) или текстовый редактор для редактирования шаблона.

#### <a name="edit-the-hub-name-and-location"></a>Отодеть название и местоположение концентратора

1. Удалите раздел параметров в верхней части - гораздо проще просто использовать название концентратора, потому что у нас не будет нескольких параметров. 

    ``` json
        "parameters": {
            "IotHubs_ContosoTestHub29358_name": {
                "defaultValue": "ContosoTestHub29358",
                "type": "String"
            }
        },
    ```

1. Измените имя, чтобы использовать фактическое (новое) имя, а не извлекать его из параметра (который вы удалили на предыдущем этапе). 

    Для нового концентратора используйте название исходного концентратора плюс *клон* строки, чтобы составить новое имя. Начните с очистки названия и местоположения концентратора.
    
    Старая версия: 

    ``` json 
    "name": "[parameters('IotHubs_ContosoTestHub29358_name')]",
    "location": "westus",
    ```
    
    Новая версия:  

    ``` json 
    "name": "ContosoTestHub29358clone",
    "location": "eastus",
    ```

    Далее вы обнаружите, что значения **для пути** содержат старое имя концентратора. Измените их, чтобы использовать новый. Это значения пути в соответствии **с eventHubEndpoints,** называемые **событиями** и **OperationsMonitoringEvents.**

    Когда вы закончите, раздел конечных точек концентратора событий должен выглядеть следующим образом:

    ``` json
    "eventHubEndpoints": {
        "events": {
            "retentionTimeInDays": 1,
            "partitionCount": 2,
            "partitionIds": [
                "0",
                "1"
            ],
            "path": "contosotesthub29358clone",
            "endpoint": "sb://iothub-ns-contosotes-2227755-92aefc8b73.servicebus.windows.net/"
        },
        "operationsMonitoringEvents": {
            "retentionTimeInDays": 1,
            "partitionCount": 2,
            "partitionIds": [
                "0",
                "1"
            ],
            "path": "contosotesthub29358clone-operationmonitoring",
            "endpoint": "sb://iothub-ns-contosotes-2227755-92aefc8b73.servicebus.windows.net/"
        }
    ```

#### <a name="update-the-keys-for-the-routing-resources-that-are-not-being-moved"></a>Обновление ключей для ресурсов, которые не перемещаются

При экспорте шаблона «Менеджер ресурсов» для концентратора с настройкой концентрирования вы увидите, что ключи для этих ресурсов не указаны в экспортируемом шаблоне — их размещение обозначается звездочками. Вы должны заполнить их, перейдя на эти ресурсы в портале и получить ключи, **прежде чем** импортировать шаблон нового концентратора и создать концентратор. 

1. Извлеките ключи, необходимые для любого из ресурсов, выполнив, и поместите их в шаблон. Можно получить ключ (ы) из ресурса на [портале Azure.](https://portal.azure.com) 

   Например, если вы перенаправило сообщения в контейнер для хранения, найдите учетную запись хранилища на портале. В разделе Настройки выберите **ключи доступа,** а затем скопируйте один из ключей. Вот как выглядит ключ при первом экспорте шаблона:

   ```json
   "connectionString": "DefaultEndpointsProtocol=https;
   AccountName=fabrikamstorage1234;AccountKey=****",
   "containerName": "fabrikamresults",
   ```

1. После получения ключа учетной записи для учетной записи, `AccountKey=****` поместите его в шаблон в пункте вместо звездочек. 

1. Для очередей в автобусы обслуживания получите ключ общего доступа, соответствующий SharedAccessKeyName. Вот ключ и `SharedAccessKeyName` в Json:

   ```json
   "connectionString": "Endpoint=sb://fabrikamsbnamespace1234.servicebus.windows.net:5671/;
   SharedAccessKeyName=iothubroutes_FabrikamResources;
   SharedAccessKey=****;
   EntityPath=fabrikamsbqueue1234",
   ```

1. То же самое относится и к темам обслуживания автобусов и соединениям концентратора событий.

#### <a name="create-the-new-routing-resources-in-the-new-location"></a>Создание новых ресурсов направлений в новом местоположении

Этот раздел применяется только в том случае, если вы перемещаете ресурсы, используемые концентратором, для конечных точек трассировки.

Если требуется переместить ресурсы для передачи, необходимо вручную настроить ресурсы в новом местоположении. Ресурсы для разгрома можно создать с помощью [портала Azure](https://portal.azure.com)или экспортируя шаблон менеджера ресурсов для каждого из ресурсов, используемых в сообщении, редактируя их и импортируя. После настройки ресурсов можно импортировать шаблон концентратора (который включает конфигурацию реуктора).

1. Создайте каждый ресурс, используемый в области реуктора. Вы можете сделать это вручную с помощью [портала Azure](https://portal.azure.com)или создать ресурсы с помощью шаблонов «Менеджер ресурсов». Если вы хотите использовать шаблоны, эти шаги, чтобы следовать:

    1. Для каждого ресурса, используемого в области разгрома, экспортировать его в шаблон менеджера ресурсов.
    
    1. Обновите имя и местоположение ресурса. 

    1. Обновление любых перекрестных ссылок между ресурсами. Например, если вы создаете шаблон для новой учетной записи хранилища, вам необходимо обновить имя учетной записи хранилища в этом шаблоне и любой другой шаблон, который ссылается на него. В большинстве случаев раздел трассировки в шаблоне для концентратора является единственным другим шаблоном, который ссылается на ресурс. 

    1. Импортируйте каждый из шаблонов, который развертывает каждый ресурс.

    После настройки и запуска ресурсов, используемых в области реуктора, можно продолжить работу.

1. В шаблоне для концентратора IoT измените название каждого из ресурсов на новое имя и при необходимости обновите местоположение. 

Теперь у вас есть шаблон, который создаст новый концентратор, который выглядит почти так же, как старый концентратор, в зависимости от того, как вы решили обрабатывать разгром.

## <a name="move----create-the-new-hub-in-the-new-region-by-loading-the-template"></a>Перемещение - создание нового концентратора в новом регионе путем загрузки шаблона

Создайте новый концентратор в новом месте с помощью шаблона. Если у вас есть ресурсы для движения, ресурсы должны быть настроены в новом местоположении, а ссылки в шаблоне обновляются в соответствии. Если вы не перемещаете ресурсы для разгрома, они должны быть в шаблоне с обновленными ключами.

1. Войти на [портал Azure](https://portal.azure.com).

1. Выберите **Создать ресурс**. 

1. В поле поиска поместите в "шаблон развертывания" и выберите Enter.

1. Выберите **развертывание шаблонов (развертывание с помощью пользовательских шаблонов)**. Это приведет вас к экрану для развертывания шаблона. Выберите **Создать**. Появляется следующий экран:

   ![Скриншот, показывающий команду для создания собственного шаблона](./media/iot-hub-how-to-clone/iot-hub-custom-deployment.png)

1. Выберите **Создать свой собственный шаблон в редакторе,** который позволяет загружать шаблон из файла. 

1. Выберите **файл загрузки.** 

   ![Скриншот, показывающий команду для загрузки файла шаблона](./media/iot-hub-how-to-clone/iot-hub-upload-file.png)

1. Просмотрите новый шаблон, который вы отредактировали, и выберите его, а затем выберите **Open.** Он загружает шаблон в окне отослаивать. Нажмите кнопку **Сохранить**. 

   ![Скриншот, показывающий загрузку шаблона](./media/iot-hub-how-to-clone/iot-hub-loading-template.png)

1. Заполните следующие поля.

   **Подписка:** выберите подписку для использования.

   **Группа ресурсов**: создание новой группы ресурсов в новом месте. Если у вас уже есть новый набор, вы можете выбрать его вместо создания нового.

   **Расположение**: Если вы выбрали существующую группу ресурсов, это заполнено для вас, чтобы соответствовать местоположению группы ресурсов. Если вы создали новую группу ресурсов, это будет ее местоположение.

   **Я согласен флажок**: это в основном говорит о том, что вы согласны платить за ресурс (ы) вы создаете.

1. Нажмите кнопку **Приобрести**.

Портал теперь проверяет шаблон и развертывает клонированный концентратор. Если у вас есть данные конфигурации реаутирования, они будут включены в новый концентратор, но укажут на ресурсы в предыдущем месте.

## <a name="managing-the-devices-registered-to-the-iot-hub"></a>Управление устройствами, зарегистрированными в концентраторе IoT

Теперь, когда у вас есть клон и работает, вам нужно скопировать все устройства от исходного концентратора до клона. 

Есть несколько способов для достижения этой цели. Вы либо изначально использовали [службу обеспечения устройств (DPS)](/azure/iot-dps/about-iot-dps)для предоставления устройств, либо нет. Если вы сделали, это не трудно. Если вы этого не сделали, это может быть очень сложным. 

Если вы не использовали DPS для предоставления устройств, вы можете пропустить следующий раздел и начать с [использования импорта / экспорта для перемещения устройств в новый концентратор.](#using-import-export-to-move-the-devices-to-the-new-hub)

## <a name="using-dps-to-re-provision-the-devices-in-the-new-hub"></a>Использование DPS для переобеспечения устройств в новом концентраторе

Чтобы использовать DPS для перемещения устройств на новое место, [см.](../iot-dps/how-to-reprovision.md) Когда вы закончите, вы можете просмотреть устройства на [портале Azure](https://portal.azure.com) и проверить, что они находятся в новом месте.

Перейдите в новый концентратор с помощью [портала Azure](https://portal.azure.com). Выберите концентратор, а затем выберите **IoT Устройства.** Вы видите устройства, которые были переподготовлены к клонированному концентратору. Вы также можете просмотреть свойства для клонированного концентратора. 

Если вы реализовали маршрутизирование, проверьте и убедитесь, что ваши сообщения направляются на ресурсы правильно.

### <a name="committing-the-changes-after-using-dps"></a>Совершение изменений после использования DPS

Это изменение было совершено службой DPS.

### <a name="rolling-back-the-changes-after-using-dps"></a>Откат изменений после использования DPS. 

Если вы хотите откатить изменения, переувите устройства из нового концентратора в старый.

Теперь вы закончили миграцию вашего концентратора и его устройств. Вы можете перейти к [очистке.](#clean-up)

## <a name="using-import-export-to-move-the-devices-to-the-new-hub"></a>Использование импорта-экспорта для перемещения устройств в новый концентратор

Приложение нацелено на ядро .NET, так что вы можете запустить его на Windows или Linux. Вы можете загрузить образец, получить строки соединения, установить флаги, для которых биты вы хотите запустить, и запустить его. Вы можете сделать это, даже не открывая код.

### <a name="downloading-the-sample"></a>Скачивание примера

1. Используйте образцы IoT C с этой страницы: [Azure IoT Образцы для C .](https://azure.microsoft.com/resources/samples/azure-iot-samples-csharp/) Скачать почтовый файл и распаковать его на вашем компьютере. 

1. Соответствующий код находится в ./iot-hub/Samples/service/ImportExportDevicesSample. Для запуска приложения не нужно просматривать или отсвануждать код.

1. Чтобы запустить приложение, укажите три строки соединения и пять вариантов. Вы передаете эти данные в качестве аргументов командной строки или используете переменные среды, или используете комбинацию этих двух. Мы собираемся передать параметры в качестве аргументов командной строки, а строки соединения как переменные среды. 

   Это объясняется тем, что строки соединения длинные и необоснованно, и вряд ли изменятся, но вы можете изменить параметры и запустить приложение более одного раза. Чтобы изменить значение переменной среды, необходимо закрыть окно команды и Visual Studio или VS Code, какой бы вы ни использовали. 

### <a name="options"></a>Параметры

Вот пять вариантов, которые вы указываете при запуске приложения. Мы поставим их на командную линию через минуту.

*   **addDevices** (аргумент 1) - установите это в пользу истины, если вы хотите добавить виртуальные устройства, которые генерируются для вас. Они добавляются в концентратор исходного кода. Кроме того, установите **numToAdd** (аргумент 2), чтобы указать, сколько устройств вы хотите добавить. Максимальное количество устройств, которые можно зарегистрировать в концентраторе, составляет один миллион. Цель юношу опции предназначена для тестирования — можно создать определенное количество устройств, а затем скопировать их в другой концентратор.

*   **copyDevices** (аргумент 3) -- установите это для того чтобы скопировать приборы от одного концентратора к другому. 

*   **deleteSourceDevices** (аргумент 4) -- установите это для того чтобы удалить все приборы зарегистрированные к центру источника. Мы рекомендуем подождать, пока вы не уверены, что все устройства были переданы, прежде чем запустить это. После удаления устройств вы не сможете их вернуть.

*   **deleteDestDevices** (аргумент 5) -- установите это для того чтобы удалить все приборы зарегистрированные концентратор назначения (клон). Вы можете сделать это, если вы хотите скопировать устройства более одного раза. 

Основная команда будет *дотнет азатем -* это говорит .NET, чтобы построить локальный файл csproj, а затем запустить его. Перед запуском аргументы командной строки дополните аргументы командной строки. 

Ваша командная строка будет выглядеть следующими примерами:

``` console 
    // Format: dotnet run add-devices num-to-add copy-devices delete-source-devices delete-destination-devices

    // Add 1000 devices, don't copy them to the other hub, or delete them. 
    // The first argument is true, numToAdd is 50, and the other arguments are false.
    dotnet run true 1000 false false false 

    // Copy the devices you just added to the other hub; don't delete anything.
    // The first argument is false, numToAdd is 0, copy-devices is true, and the delete arguments are both false
    dotnet run false 0 true false false 
```

### <a name="using-environment-variables-for-the-connection-strings"></a>Использование переменных среды для строк соединения

1. Для выполнения образца необходимо строки подключения к старым и новым концентратам IoT, а также учетная запись хранилища, которую можно использовать для временных рабочих файлов. Мы будем хранить значения для них в переменных среды.

1. Чтобы получить значения строки соединения, восвайтесь на [порталAz.](https://portal.azure.com) 

1. Поместите строки соединения куда-нибудь, где их можно получить, например, NotePad. Если вы копируете следующее, вы можете вставить строки соединения непосредственно там, где они идут. Не добавляйте пробелы вокруг равного знака, иначе он изменяет переменное имя. Кроме того, вам не нужны двойные котировки вокруг строк соединения. Если вы размещаете котировки вокруг строки подключения к учетной записи хранилища, она не будет работать.

   Для Windows именно так вы устанавливаете переменные среды:

   ``` console  
   SET IOTHUB_CONN_STRING=<put connection string to original IoT Hub here>
   SET DEST_IOTHUB_CONN_STRING=<put connection string to destination or clone IoT Hub here>
   SET STORAGE_ACCT_CONN_STRING=<put connection string to the storage account here>
   ```
 
   Для Linux именно так вы определяете переменные среды:

   ``` console  
   export IOTHUB_CONN_STRING="<put connection string to original IoT Hub here>"
   export DEST_IOTHUB_CONN_STRING="<put connection string to destination or clone IoT Hub here>"
   export STORAGE_ACCT_CONN_STRING="<put connection string to the storage account here>"
   ```

1. Для строк соединения концентратора IoT перейдите к каждому концентратору портала. Вы можете искать в **Ресурсах** для концентратора. Если вы знаете группу ресурсов, вы можете перейти к **группам ресурсов,** выбрать группу ресурсов, а затем выбрать концентратор из списка ресурсов в этой группе ресурсов. 

1. Выберите **политики общего доступа** из «Настройки» для концентратора, затем выберите **iothubowner** и скопируйте одну из строк соединения. Сделайте то же самое для концентратора назначения. Добавьте их в соответствующие команды SET.

1. Для строки подключения учетной записи хранилища найдите учетную запись хранилища в **Ресурсах** или под **группой ресурсов** и откройте ее. 
   
1. В разделе Настройки выберите **клавиши доступа** и скопируйте одну строку соединения. Поместите строку соединения в текстовый файл для соответствующей команды SET. 

Теперь в файле с командами SET есть переменные среды, и вы знаете, каковы аргументы командной строки. Давайте запустим образец.

### <a name="running-the-sample-application-and-using-command-line-arguments"></a>Запуск примерного приложения и использование аргументов командной строки

1. Откройте окно командной строки. Выберите Windows `command prompt` и введите, чтобы получить окно запроса команды.

1. Копируйте команды, которые устанавливают переменные среды, по одному, и вставьте их в окно запроса команды и выберите Enter. Когда вы закончите, `SET` введите окно запроса команды, чтобы увидеть переменные среды и их значения. После того, как вы скопировали их в окно запроса команды, вам не придется копировать их снова, если только вы не откроете новое окно запроса команды.

1. В окне запроса команды меняйте каталоги до тех пор, пока вы не окажутся в ./ImportExportDevicesSample (где существует файл ImportExportDevicesSample.csproj). Затем введите следующие аргументы и включите аргументы командной строки.

    ``` console
    // Format: dotnet run add-devices num-to-add copy-devices delete-source-devices delete-destination-devices
    dotnet run arg1 arg2 arg3 arg4 arg5
    ```

    Команда Dotnet строит и запускает приложение. Поскольку при запуске приложения вы проходите в вариантах, вы можете изменять их значения каждый раз при запуске приложения. Например, можно запустить его один раз и создать новые устройства, затем запустить его снова и скопировать эти устройства в новый концентратор и так далее. Вы также можете выполнить все шаги в том же запуске, хотя мы рекомендуем не удалять любые устройства, пока вы не уверены, что вы закончили с клонированием. Вот пример, который создает 1000 устройств, а затем копирует их в другой концентратор.

    ``` console
    // Format: dotnet run add-devices num-to-add copy-devices delete-source-devices delete-destination-devices

    // Add 1000 devices, don't copy them to the other hub or delete them. 
    dotnet run true 1000 false false false 

    // Do not add any devices. Copy the ones you just created to the other hub; don't delete anything.
    dotnet run false 0 true false false 
    ```

    После того как вы убедитесь, что устройства были успешно скопированы, вы можете удалить устройства из исходного концентратора, как это:

   ``` console
   // Format: dotnet run add-devices num-to-add copy-devices delete-source-devices delete-destination-devices
   // Delete the devices from the source hub.
   dotnet run false 0 false true false 
   ```

### <a name="running-the-sample-application-using-visual-studio"></a>Запуск примерного приложения с помощью Visual Studio

1. Если вы хотите запустить приложение в Visual Studio, измените текущий каталог в папку, в которой находится файл IoTHubServiceSamples.sln. Затем запустите эту команду в окне запроса команды, чтобы открыть решение в Visual Studio. Это необходимо сделать в том же окне команды, где вы устанавливаете переменные среды, чтобы эти переменные были известны.

   ``` console       
   IoTHubServiceSamples.sln
   ```
    
1. Нажмите на проект *ImportExportDevicesSample* и выберите **Set в качестве стартап-проекта.**    
    
1. Установите переменные в верхней части Program.cs в папке ImportExportDevicesSample для пяти вариантов.

   ``` csharp
   // Add randomly created devices to the source hub.
   private static bool addDevices = true;
   //If you ask to add devices, this will be the number added.
   private static int numToAdd = 0; 
   // Copy the devices from the source hub to the destination hub.
   private static bool copyDevices = false;
   // Delete all of the devices from the source hub. (It uses the IoTHubConnectionString).
   private static bool deleteSourceDevices = false;
   // Delete all of the devices from the destination hub. (Uses the DestIotHubConnectionString).
   private static bool deleteDestDevices = false;
   ```

1. Выберите F5 для запуска приложения. После завершения работы можно просмотреть результаты.

### <a name="view-the-results"></a>Просмотр результатов 

Можно просмотреть устройства на [портале Azure](https://portal.azure.com) и убедиться, что они находятся в новом месте.

1. Перейдите в новый концентратор с помощью [портала Azure](https://portal.azure.com). Выберите концентратор, а затем выберите **IoT Устройства.** Вы видите устройства, которые только что скопировали из старого концентратора в клонированный концентратор. Вы также можете просмотреть свойства для клонированного концентратора. 

1. Проверьте ошибки импорта/экспорта, перейдя на учетную запись хранения `devicefiles` Azure `ImportErrors.log`на [портале Azure](https://portal.azure.com) и ища в контейнере для . Если этот файл пуст (размер 0), ошибок не было. Если вы попытаетесь импортировать одно и то же устройство более одного раза, оно отклоняет устройство во второй раз и добавляет сообщение об ошибке в файл журнала.

### <a name="committing-the-changes"></a>Совершение изменений 

На этом этапе вы скопировали концентратор на новое место и перенесли устройства на новый клон. Теперь вам нужно внести изменения, чтобы устройства работали с клонированным концентратором.

Чтобы выполнить изменения, вот шаги, которые необходимо выполнить: 

* Обновите каждое устройство, чтобы изменить имя хоста Концентратора IoT, чтобы указать имя хоста Концентратора IoT на новый концентратор. Вы должны сделать это с помощью того же метода, который вы использовали при первом подготовке устройства.

* Измените любые приложения, которые относятся к старому концентратору, чтобы указать на новый концентратор.

* После завершения работ новый концентратор должен быть запущен. Старый концентратор не должен иметь активных устройств и находиться в отключенном состоянии. 

### <a name="rolling-back-the-changes"></a>Откат изменений

Если вы решите откатить изменения, вот шаги для выполнения:

* Обновите каждое устройство, чтобы изменить hostname КонцентраторIo, чтобы указать хостимя IoT концентратору для старого концентратора. Вы должны сделать это с помощью того же метода, который вы использовали при первом подготовке устройства.

* Измените любые приложения, которые относятся к новому концентратору, чтобы указать на старый концентратор. Например, если вы используете аналитику Azure, возможно, потребуется перенастроить [ввод Azure Stream Analytics.](../stream-analytics/stream-analytics-define-inputs.md#stream-data-from-iot-hub)

* Удалите новый концентратор. 

* Если у вас есть ресурсы для разгрома, конфигурация старого концентратора должна по-прежнему указывать на правильную конфигурацию реаутинга и должна работать с этими ресурсами после перезапуска концентратора.

### <a name="checking-the-results"></a>Проверка результатов 

Чтобы проверить результаты, измените решение IoT, чтобы указать на концентратор в новом месте и запустить его. Другими словами, выполните те же действия с новым концентратором, который вы выполнили с предыдущим концентратором, и убедитесь, что они работают правильно. 

Если вы реализовали маршрутизирование, проверьте и убедитесь, что ваши сообщения направляются на ресурсы правильно.

## <a name="clean-up"></a>Очистка

Не убирайте, пока вы действительно уверены, что новый концентратор запущен и работает, и устройства работают правильно. Также не забудьте проверить разгром, если вы используете эту функцию. Когда вы будете готовы, очистите старые ресурсы, выполнив следующие действия:

* Если вы еще не сделали этого, удалите старый концентратор. Это удаляет все активные устройства из концентратора.

* Если у вас есть ресурсы, перемещаемые в новое место, можно удалить старые ресурсы для размывания.

## <a name="next-steps"></a>Дальнейшие действия

Вы клонировали концентратор IoT в новый концентратор в новом регионе, в комплекте с устройствами. Для получения дополнительной информации об проведении оптовых операций против реестра идентификационных данных в концентраторе IoT см. [Импорт и экспорт идентификаторы устройств IoT Hub оптом.](iot-hub-bulk-identity-mgmt.md)

Для получения дополнительной информации о Концентраторе IoT и разработке концентратора, пожалуйста, смотрите следующие статьи.

* [Руководство разработчика IoT концентратора](iot-hub-devguide.md)

* [Учебник по разгрому концентратора IoT](tutorial-routing.md)

* [Обзор управления устройствами IoT Hub](iot-hub-device-management-overview.md)

* Если вы хотите развернуть пример приложения, пожалуйста, [см.](https://docs.microsoft.com/dotnet/core/deploying/index)
