---
title: Фильтрация подключений по протоколу IP в Центре Интернета вещей Azure | Документация Майкрософт
description: Сведения об использовании фильтрации IP-адресов для блокирования подключений к Центру Интернета вещей Azure с определенных IP-адресов. Вы можете блокировать подключения с отдельных IP-адресов или их диапазонов.
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 07/22/2017
ms.author: robinsh
ms.openlocfilehash: a6bd8a766f3205358a65ef2fd0816643e4261cab
ms.sourcegitcommit: c556477e031f8f82022a8638ca2aec32e79f6fd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2019
ms.locfileid: "68414283"
---
# <a name="use-ip-filters"></a>Использование фильтрации IP-адресов

Безопасность является важным аспектом любого решения Интернета вещей на базе Центра Интернета вещей Azure. Иногда при настройке системы безопасности необходимо явно указать IP-адреса, с которых могут подключаться устройства. Функция *фильтрации IP-адресов* позволяет настроить правила для отклонения или приема трафика с определенных IPv4-адресов.

## <a name="when-to-use"></a>Сценарии использования

Есть два конкретных варианта применения этой функции, когда рекомендуется заблокировать конечные точки Центра Интернета вещей для определенных IP-адресов:

* Центр Интернета вещей должен принимать трафик только из определенного диапазона IP-адресов и отклонять весь остальной трафик. Допустим, что Центр Интернета вещей используется в сочетании с [Azure Express Route](https://azure.microsoft.com/documentation/articles/expressroute-faqs/#supported-services) для создания частных подключений между Центром Интернета вещей и локальной инфраструктурой.

* В этом случае требуется отклонять трафик с IP-адресов, которые были определены администратором Центра Интернета вещей как подозрительные.

## <a name="how-filter-rules-are-applied"></a>Применение правил фильтрации

Правила фильтрации IP-адресов применяются на уровне службы Центра Интернета вещей. Поэтому они действуют для всех подключений с устройств и внутренних приложений, использующих любые поддерживаемые протоколы.

При попытке подключения с IP-адреса, который соответствует правилу отклонения IP-адресов в Центре Интернета вещей, пользователь получает сообщение об ошибке с кодом состояния 401 (Не авторизовано) и описанием. В ответном сообщении не указывается правило фильтрации IP-адресов.

## <a name="default-setting"></a>Значение по умолчанию

По умолчанию раздел **Фильтрация IP-адресов** на портале для Центра Интернета вещей пуст. Этот означает, что по умолчанию центр принимает подключения с любых IP-адресов. То есть, такое значение параметра по умолчанию равноценно правилу, которое принимает диапазон IP-адресов 0.0.0.0/0.

![Параметры фильтрации IP-адресов по умолчанию для Центра Интернета вещей](./media/iot-hub-ip-filtering/ip-filter-default.png)

## <a name="add-or-edit-an-ip-filter-rule"></a>Добавление или изменение правила фильтрации IP-адресов

Чтобы добавить правило фильтрации IP-адресов, выберите **+ Добавить правило IP-фильтра**.

![Добавление правила фильтрации IP-адресов в Центр Интернета вещей](./media/iot-hub-ip-filtering/ip-filter-add-rule.png)

После нажатия кнопки **Добавить правило IP-фильтра**заполните поля.

![После выбора параметра Добавить правило IP-фильтра](./media/iot-hub-ip-filtering/ip-filter-after-selecting-add.png)

* Укажите **имя** для правила IP-фильтра. Это должна быть уникальная, без учета регистра, буквенно-цифровая строка длиной до 128 символов. Допускаются только 7-разрядные буквы и цифры ASCII, а также `{'-', ':', '/', '\', '.', '+', '%', '_', '#', '*', '?', '!', '(', ')', ',', '=', '@', ';', '''}`.

* Укажите один IPv4-адрес или блок IP-адресов в нотации CIDR. Например, в нотации CIDR 192.168.100.0/22 обозначает диапазон из 1024 IPv4-адресов от 192.168.100.0 до 192.168.103.255.

* Выберите **Разрешить** или **заблокировать** в качестве **действия** для правила IP-фильтра.

После заполнения полей выберите **сохранить** , чтобы сохранить правило. Появится предупреждение о том, что обновление выполняется.

![Уведомление о сохранении правила фильтрации IP-адресов](./media/iot-hub-ip-filtering/ip-filter-save-new-rule.png)

Параметр **Добавить** становится неактивным, когда достигается максимальное число правил фильтрации IP-адресов (10).

Чтобы изменить существующее правило, выберите данные, которые необходимо изменить, внесите изменения, а затем нажмите кнопку **сохранить** , чтобы сохранить изменения.

> [!NOTE]
> Отклонение IP-адресов может препятствовать взаимодействию других служб Azure (таких как Azure Stream Analytics, Виртуальные машины Azure или обозреватель устройств на портале) с Центром Интернета вещей.

> [!WARNING]
> Если для чтения сообщений из Центра Интернета вещей с включенной IP-фильтрацией вы используете Azure Stream Analytics (ASA), укажите в строке подключения ASA совместимые с концентратором событий имя и конечную точку.

## <a name="delete-an-ip-filter-rule"></a>Удаление правила фильтрации IP-адресов

Чтобы удалить правило фильтрации IP-адресов, выберите значок корзины в этой строке и нажмите кнопку **сохранить**. Правило удаляется, а изменение сохраняется.

![Удаление правила фильтрации IP-адресов в Центре Интернета вещей](./media/iot-hub-ip-filtering/ip-filter-delete-rule.png)

## <a name="retrieve-and-update-ip-filters-using-azure-cli"></a>Получение и обновление фильтров IP-адресов с помощью Azure CLI

Фильтры IP-адресов Центра Интернета вещей можно получать и обновлять с помощью [интерфейса командной строки Azure](https://docs.microsoft.com/cli/azure/?view=azure-cli-latest).

Чтобы получить текущие фильтры IP-адресов Центра Интернета вещей, выполните следующую команду:

```azurecli-interactive
az resource show -n <iothubName> -g <resourceGroupName> --resource-type Microsoft.Devices/IotHubs
```

Она возвратит объект JSON, в котором ваши имеющиеся фильтры IP-адресов отображаются в разделе `properties.ipFilterRules`:

```json
{
...
    "properties": {
        "ipFilterRules": [
        {
            "action": "Reject",
            "filterName": "MaliciousIP",
            "ipMask": "6.6.6.6/6"
        },
        {
            "action": "Allow",
            "filterName": "GoodIP",
            "ipMask": "131.107.160.200"
        },
        ...
        ],
    },
...
}
```

Чтобы добавить новый фильтр IP-адреса для Центра Интернета вещей, выполните следующую команду:

```azurecli-interactive
az resource update -n <iothubName> -g <resourceGroupName> --resource-type Microsoft.Devices/IotHubs --add properties.ipFilterRules "{\"action\":\"Reject\",\"filterName\":\"MaliciousIP\",\"ipMask\":\"6.6.6.6/6\"}"
```

Чтобы удалить имеющийся фильтр IP-адреса в Центре Интернета вещей, выполните следующую команду:

```azurecli-interactive
az resource update -n <iothubName> -g <resourceGroupName> --resource-type Microsoft.Devices/IotHubs --add properties.ipFilterRules <ipFilterIndexToRemove>
```

Обратите внимание, что `<ipFilterIndexToRemove>` должен соответствовать порядковому номеру IP-фильтра в Центре Интернета вещей раздела `properties.ipFilterRules`.

## <a name="retrieve-and-update-ip-filters-using-azure-powershell"></a>Получение и обновление фильтров IP-адресов с помощью Azure PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

IP-фильтры центра Интернета вещей можно получить и задать с помощью [Azure PowerShell](/powershell/azure/overview).

```powershell
# Get your IoT Hub resource using its name and its resource group name
$iothubResource = Get-AzResource -ResourceGroupName <resourceGroupNmae> -ResourceName <iotHubName> -ExpandProperties

# Access existing IP filter rules
$iothubResource.Properties.ipFilterRules |% { Write-host $_ }

# Construct a new IP filter
$filter = @{'filterName'='MaliciousIP'; 'action'='Reject'; 'ipMask'='6.6.6.6/6'}

# Add your new IP filter rule
$iothubResource.Properties.ipFilterRules += $filter

# Remove an existing IP filter rule using its name, e.g., 'GoodIP'
$iothubResource.Properties.ipFilterRules = @($iothubResource.Properties.ipFilterRules | Where 'filterName' -ne 'GoodIP')

# Update your IoT Hub resource with your updated IP filters
$iothubResource | Set-AzResource -Force
```

## <a name="update-ip-filter-rules-using-rest"></a>Обновление правил фильтра IP-адреса с помощью REST

Вы также можете получать и изменять фильтры IP-адресов Центра Интернета вещей, используя конечную точку REST поставщика ресурсов Azure. Подробные сведения о `properties.ipFilterRules` см. в статье [Iot Hub Resource — Create Or Update](https://docs.microsoft.com/rest/api/iothub/iothubresource/createorupdate) (Ресурс Центра Интернета вещей. Создание или обновление).

## <a name="ip-filter-rule-evaluation"></a>Оценка правила фильтрации IP-адресов

Правила фильтрации IP-адресов применяются по порядку, поэтому первое правило, которое соответствует IP-адресу, определяет действие (принять или отклонить).

Например, если вы хотите, чтобы адреса в диапазоне 192.168.100.0/22 принимались, а все остальные отклонялись, то первым правилом в списке должно быть именно правило о приеме трафика из диапазона адресов 192.168.100.0/22. Следующим должно быть правило об отклонении всех адресов; для этого используется диапазон 0.0.0.0/0.

Последовательность правил фильтрации IP-адресов в списке можно изменить. Для этого щелкните три вертикальные точки в начале строки и воспользуйтесь функцией перетаскивания.

Чтобы сохранить новую последовательность, нажмите кнопку **Сохранить**.

![Изменение порядка правил фильтрации IP-адресов в Центре Интернета вещей](./media/iot-hub-ip-filtering/ip-filter-rule-order.png)

## <a name="next-steps"></a>Следующие шаги

Для дальнейшего изучения возможностей Центра Интернета вещей см. следующие статьи:

* [Мониторинг операций](iot-hub-operations-monitoring.md)
* [Общие сведения о метриках Центра Интернета вещей](iot-hub-metrics.md)
