---
title: Автоматическое управление устройствами в масштабе с Azure IoT концентратор (CLI) Документы Майкрософт
description: Используйте автоматические конфигурации Azure IoT Hub для управления несколькими устройствами или модулями IoT
author: ChrisGMsft
manager: bruz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 12/13/2019
ms.author: chrisgre
ms.openlocfilehash: 748f3e09fd03a6f37954c8dfaf4b6ae9144384bb
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80235603"
---
# <a name="automatic-iot-device-and-module-management-using-the-azure-cli"></a>Автоматическое управление устройством IoT и модулем с помощью Azure CLI

[!INCLUDE [iot-edge-how-to-deploy-monitor-selector](../../includes/iot-hub-auto-device-config-selector.md)]

Автоматическое управление устройствами в Azure IoT Hub автоматизирует многие повторяющиеся и сложные задачи управления большими парками устройств. С помощью автоматического управления устройствами можно настроить таргетинг на набор устройств на основе их свойств, определить нужную конфигурацию, а затем позволить IoT Hub обновить устройства, когда они появляются в области. Это обновление выполняется с помощью _автоматической конфигурации устройства_ или _автоматической конфигурации модуля,_ которая позволяет суммировать завершение и соответствие требованиям, обрабатывать слияния и конфликты, а также развертывать конфигурации в поэтапном подходе.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Автоматическое управление устройством работает путем обновления набора близнецов устройств или близнецов модулей с желаемыми свойствами и отчетности резюме, которое основано на свойствах близнецов.  Он вводит новый класс и документ JSON под названием *Конфигурация,* который имеет три части:

* **Целевое условие** определяет область действия близнецов устройств или близнецов модулей, которые должны быть обновлены. Целевое условие задается как запрос в тегах двойников устройств или как сообщаемые свойства.

* **Целевой контент** определяет желаемые свойства, которые должны быть добавлены или обновлены в целевых близнецов устройства или близнецов модулей. Содержимое включает в себя путь к разделу требуемых свойств, которые необходимо изменить.

* **Метрики** определяют общее количество различных состояний конфигурации, таких как **Успешно**, **Выполняется** и **Ошибка**. Пользовательские метрики указаны как запросы на свойствах с двумя зарегистрированными.  Системные метрики — это метрики по умолчанию, которые измеряют статус двойного обновления, такие как число близнецов, которые являются целевыми, и число близнецов, которые были успешно обновлены.

Автоматические конфигурации работают впервые вскоре после создания конфигурации, а затем с пятиминутными интервалами. Запросы метрик исходят при запуске автоматической конфигурации.

## <a name="cli-prerequisites"></a>Технические условия CLI

* [Концентратор IoT](../iot-hub/iot-hub-create-using-cli.md) в подписке Azure. 

* [Интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/install-azure-cli) в вашей среде. Как минимум, ваша версия Azure CLI должна быть 2.0.70 или выше. Для проверки используйте `az –-version`. Эта версия поддерживает команды расширения az и представляет собой платформу команд Knack. 

* [Расширение IoT для Azure CLI.](https://github.com/Azure/azure-cli)

[!INCLUDE [iot-hub-cli-version-info](../../includes/iot-hub-cli-version-info.md)]

## <a name="implement-twins"></a>Реализация близнецов

Для автоматических конфигураций устройств требуется использовать двойники устройств, чтобы синхронизировать состояние между облаком и устройствами.  См. [общие сведения о двойниках устройств и их использовании в Центре Интернета вещей](iot-hub-devguide-device-twins.md).

Конфигурации автоматических модулей требуют использования близнецов модулей для синхронизации состояния между облаком и модулями. Для получения дополнительной информации [см. Понимание и использование близнецов модулей в IoT Hub](iot-hub-devguide-module-twins.md).

## <a name="use-tags-to-target-twins"></a>Используйте теги для целевой близнецов

Перед созданием конфигурации необходимо указать, на какие устройства или модули вы хотите повлиять. Azure IoT Концентратор идентифицирует устройства и использует теги в близнеце устройства, и определяет модули с помощью тегов в двойнике модуля. Каждое устройство или модули могут иметь несколько тегов, и вы можете определить их любым способом, который имеет смысл для вашего решения. Например, если вы управляете устройствами в разных местах, добавьте следующие теги к близнецу устройства:

```json
"tags": {
    "location": {
        "state": "Washington",
        "city": "Tacoma"
    }
},
```

## <a name="define-the-target-content-and-metrics"></a>Определение целевого содержимого и метрик

Целевой контент и метрические запросы указаны как документы JSON, описывающие двойные свойства устройства или модуля twin desired для измерения и сообщения свойств.  Чтобы создать автоматическую конфигурацию с помощью Azure CLI, сохраните целевой контент и метрики локально как файлы .txt. При запуске команды используется файловые пути в более позднем разделе, чтобы применить конфигурацию к устройству.

Вот базовый пример целевого содержимого для конфигурации автоматического устройства:

```json
{
  "content": {
    "deviceContent": {
      "properties.desired.chillerWaterSettings": {
        "temperature": 38,
        "pressure": 78
      }
    }
}
```

Конфигурации автоматических модулей ведут `moduleContent` себя `deviceContent`очень похоже, но вы нацелены на .

```json
{
  "content": {
    "moduleContent": {
      "properties.desired.chillerWaterSettings": {
        "temperature": 38,
        "pressure": 78
      }
    }
}
```

Ниже приведены примеры запросов метрики.

```json
{
  "queries": {
    "Compliant": "select deviceId from devices where configurations.[[chillerdevicesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='current'",
    "Error": "select deviceId from devices where configurations.[[chillerdevicesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='error'",
    "Pending": "select deviceId from devices where configurations.[[chillerdevicesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='pending'"
  }
}
```

Метрические запросы для модулей также аналогичны запросам `devices.modules`для устройств, но вы выбираете для. `moduleId` Пример: 

```json
{
  "queries": {
    "Compliant": "select deviceId, moduleId from devices.module where configurations.[[chillermodulesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='current'"
  }
}
```

## <a name="create-a-configuration"></a>Создание конфигурации

Создавая конфигурацию, состоящую из целевого содержимого и метрик, вы настраиваете целевые устройства. 

Создайте конфигурацию с помощью следующей команды.

```azurecli
   az iot hub configuration create --config-id [configuration id] \
     --labels [labels] --content [file path] --hub-name [hub name] \
     --target-condition [target query] --priority [int] \
     --metrics [metric queries]
```

* --**config-id** — имя конфигурации, которая будет создана в центре IoT. Присвойте вашей конфигурации уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.

* --**labels** — добавление меток для облегчения отслеживания конфигураций. Метка представляет собой пару имя и значение, которые описывают развертывание. Например, `HostPlatform, Linux` или `Version, 3.0.1`.

* --**content** — встроенный JSON или путь к целевому содержимому, которому должны быть заданы двойные требуемые свойства. 

* --**hub-name** — имя центра IoT, в котором будет создана конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`

* --**целевое условие** - Введите целевое условие, чтобы определить, какие устройства или модули будут ориентированы с этой конфигурацией.Для автоматической конфигурации устройства условие основано на двухтегах устройства или двух местных свойствах устройства и должно соответствовать формату выражения.Например, `tags.environment='test'` или `properties.desired.devicemodel='4000x'`.Для автоматической конфигурации модуля условие основано на двухтегах модуля или модуле двойных желаемых свойств. Например, `from devices.modules where tags.environment='test'` или `from devices.modules where properties.reported.chillerProperties.model='4000x'`.

* --**priority** — положительные целые числа. В случае, если две или более конфигураций ориентированы на одно и то же устройство или модуль, будет применяться конфигурация с наивысшим числовым значением для Priority.

* --**metrics** — путь к запросам метрик. Метрики обеспечивают сводные подсчеты различных состояний, которые устройство или модуль могут отчитываться после применения содержимого конфигурации. Например, вы можете создать метрику для ожидающих изменений параметров, метрики для ошибок и метрики для успешных изменений параметров. 

## <a name="monitor-a-configuration"></a>Мониторинг конфигурации

Чтобы отобразить содержимое конфигурации, используйте следующую команду.

```azurecli
az iot hub configuration show --config-id [configuration id] \
  --hub-name [hub name]
```

* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`

Проверьте конфигурацию в командном окне.Свойство **metrics** перечисляет количество каждой метрики, которое оценивается каждым центром.

* **targetedCount** - системная метрика, которая определяет количество близнецов устройств или близнецов модулей в IoT Hub, которые соответствуют состоянию таргетинга.

* **appliedCount** - Система метрики определяет количество устройств или модулей, которые имели целевой контент применяется.

* **Пользовательские метрики** - Любые метрики, которые вы определили, являются пользовательскими метриками.

Вы можете показать список интидои устройств, инти-идомимов модулей или объектов для каждой из метрик, используя следующую команду:

```azurecli
az iot hub configuration show-metric --config-id [configuration id] \
   --metric-id [metric id] --hub-name [hub name] --metric-type [type] 
```

* --**config-id** — имя существующего развертывания в центре IoT.

* --**metric-id** - Название метрики, для которой вы хотите увидеть список идентификаторов устройств или идентификаторов модулей, например. `appliedCount`

* --**hub-name** — имя центра IoT, в котором существует развертывание. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

* --**metric-type** — возможные значения типа метрики: `system` или `user`.  Метрики систем: `targetedCount` и `appliedCount`. Все другие метрики — это пользовательские метрики.

## <a name="modify-a-configuration"></a>Изменение конфигурации

При изменении конфигурации изменения немедленно реплицируются во все целевые устройства. 

Если обновить целевое условие, произойдут следующие обновления:

* Если близнец не соответствует старому целевому состоянию, но соответствует новому целевому состоянию, и эта конфигурация является наивысшим приоритетом для этого близнеца, то эта конфигурация применяется. 

* Если близнец, в настоящее время работающий в настоящее время, больше не соответствует целевому условию, настройки из конфигурации будут удалены, а паранджи будет изменен следующей конфигурацией с наивысшим приоритетом. 

* Если близнец, работающий в настоящее время, больше не соответствует целевому состоянию и не соответствует целевому состоянию любых других конфигураций, то настройки из конфигурации будут удалены, и никакие другие изменения не будут внесены на близнеца. 

Обновите конфигурацию с помощью следующей команды.

```azurecli
az iot hub configuration update --config-id [configuration id] \
   --hub-name [hub name] --set [property1.property2='value']
```

* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

* --**set** — обновление свойства в конфигурации. Можно обновлять следующие свойства.

    * targetCondition — например `targetCondition=tags.location.state='Oregon'`

    * метки; 

    * priority

## <a name="delete-a-configuration"></a>Удаление конфигурации

При удалении конфигурации любое устройство близнецов или близнецов модуля берет на себя их следующий высокий приоритет конфигурации. Если близнецы не соответствуют целевому условию любой другой конфигурации, то никакие другие параметры не применяются. 

Удалите конфигурацию с помощью следующей команды.

```azurecli
az iot hub configuration delete --config-id [configuration id] \
   --hub-name [hub name] 
```

* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали, как настроить и контролировать IoT устройств в масштабе. Дополнительные сведения об управлении Центром Интернета вещей в Azure см. по следующим ссылкам:

* [Управление удостоверениями устройств Центра Интернета вещей в пакетном режиме](iot-hub-bulk-identity-mgmt.md)
* [Метрики Центра Интернета вещей](iot-hub-metrics.md)
* [Мониторинг операций](iot-hub-operations-monitoring.md)

Для дальнейшего изучения возможностей Центра Интернета вещей см. следующие статьи:

* [Руководство разработчика для Центра Интернета вещей](iot-hub-devguide.md)
* [Краткое руководство. Развертывание первого модуля IoT Edge на устройстве под управлением 64-разрядной ОС Linux](../iot-edge/tutorial-simulate-device-linux.md)

Узнайте, как использовать службу подготовки устройств для Центра Интернета вещей, чтобы включить автоматическую подготовку JIT, из следующей статьи: 

* [Служба подготовки устройств к добавлению в Центр Интернета вещей Azure](/azure/iot-dps)
