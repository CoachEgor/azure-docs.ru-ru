---
title: Автоматическое управление устройствами в масштабе с помощью центра Интернета вещей Azure (CLI) | Документация Майкрософт
description: Использование автоматической конфигурации центра Интернета вещей Azure для управления несколькими устройствами или модулями Интернета вещей
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 12/13/2019
ms.author: robinsh
ms.openlocfilehash: 60d0ef30a1c7d948a9e837a8bc37c76ace415545
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82024971"
---
# <a name="automatic-iot-device-and-module-management-using-the-azure-cli"></a>Автоматическое управление устройствами IoT и модулем с помощью Azure CLI

[!INCLUDE [iot-edge-how-to-deploy-monitor-selector](../../includes/iot-hub-auto-device-config-selector.md)]

Автоматическое управление устройствами в центре Интернета вещей Azure автоматизирует многие из повторяющихся и сложных задач по управлению большими парками устройств. С помощью автоматического управления устройствами можно выбрать набор устройств на основе их свойств, определить требуемую конфигурацию, а затем разрешить центру Интернета вещей обновлять устройства, когда они поступают в область. Это обновление выполняется с помощью _автоматической конфигурации устройства_ или _автоматической конфигурации модуля_, которая позволяет суммировать завершение и соответствие, обрабатывать объединение и конфликты, а также развертывание конфигураций в поэтапном подходе.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Автоматическое управление устройствами работает путем обновления набора двойникова устройства или модуля двойников с требуемыми свойствами и формирования сводки, основанной на сообщаемых свойствах двойника.  В нем представлен новый класс и документ JSON, называемый *конфигурацией* , которая состоит из трех частей:

* **Целевое условие** определяет область действия двойникова устройства или двойников модуля для обновления. Целевое условие задается как запрос в тегах двойников устройств или как сообщаемые свойства.

* **Целевое содержимое** определяет требуемые свойства для добавления или обновления в целевом устройстве двойников или модуле двойников. Содержимое включает в себя путь к разделу требуемых свойств, которые необходимо изменить.

* **Метрики** определяют общее количество различных состояний конфигурации, таких как **Успешно**, **Выполняется** и **Ошибка**. Пользовательские метрики указываются в виде запросов к сообщаемым свойствам двойника.  Метрики системы — это метрики по умолчанию, которые измеряют состояние обновления двойника, такие как количество целевых двойников и количество двойников, которые были успешно обновлены.

Автоматические конфигурации запускаются в первый раз вскоре после создания конфигурации, а затем с интервалом в пять минут. Запросы метрик запускаются при каждом запуске автоматической настройки.

## <a name="cli-prerequisites"></a>Технические условия CLI

* [Центр Интернета вещей](../iot-hub/iot-hub-create-using-cli.md) в подписке Azure. 

* [Интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/install-azure-cli) в вашей среде. По крайней мере, Azure CLI версия должна быть 2.0.70 или выше. Для проверки используйте `az –-version`. Эта версия поддерживает команды расширения az и представляет собой платформу команд Knack. 

* [Расширение IOT для Azure CLI](https://github.com/Azure/azure-cli).

[!INCLUDE [iot-hub-cli-version-info](../../includes/iot-hub-cli-version-info.md)]

## <a name="implement-twins"></a>Реализация двойников

Для автоматических конфигураций устройств требуется использовать двойники устройств, чтобы синхронизировать состояние между облаком и устройствами.  Дополнительные сведения см. [в статье изучение и использование двойниковов устройств в центре Интернета вещей](iot-hub-devguide-device-twins.md).

Для автоматической настройки модулей необходимо использовать модуль двойников для синхронизации состояния между облаком и модулями. Дополнительные сведения см. в статье сведения об [использовании модуля двойников в центре Интернета вещей](iot-hub-devguide-module-twins.md).

## <a name="use-tags-to-target-twins"></a>Использование тегов для назначения двойников

Перед созданием конфигурации необходимо указать, какие устройства или модули необходимо задействовать. Центр Интернета вещей Azure идентифицирует устройства и использует теги в двойникае устройства, а также определяет модули с помощью тегов в модуле двойника. Каждое устройство или модули могут иметь несколько тегов, и их можно определить любым способом, который имеет смысл для вашего решения. Например, если вы управляете устройствами в разных местах, добавьте следующие теги в двойника устройства:

```json
"tags": {
    "location": {
        "state": "Washington",
        "city": "Tacoma"
    }
},
```

## <a name="define-the-target-content-and-metrics"></a>Определение целевого содержимого и метрик

Целевые запросы содержимого и метрик указываются как документы JSON, описывающие требуемые свойства двойникаа устройства или модуля двойника для задания и сообщаемых свойств для измерения.  Чтобы создать автоматическую конфигурацию с помощью Azure CLI, сохраните целевое содержимое и метрики локально в виде файлов. txt. Пути к файлам можно использовать в следующем разделе при выполнении команды для применения конфигурации к устройству.

Ниже приведен пример базового целевого содержимого для автоматической настройки устройства.

```json
{
  "content": {
    "deviceContent": {
      "properties.desired.chillerWaterSettings": {
        "temperature": 38,
        "pressure": 78
      }
    }
}
```

Автоматические конфигурации модулей ведут себя точно так же, но `moduleContent` вместо нее `deviceContent`нацеливание.

```json
{
  "content": {
    "moduleContent": {
      "properties.desired.chillerWaterSettings": {
        "temperature": 38,
        "pressure": 78
      }
    }
}
```

Ниже приведены примеры запросов метрики.

```json
{
  "queries": {
    "Compliant": "select deviceId from devices where configurations.[[chillerdevicesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='current'",
    "Error": "select deviceId from devices where configurations.[[chillerdevicesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='error'",
    "Pending": "select deviceId from devices where configurations.[[chillerdevicesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='pending'"
  }
}
```

Запросы метрик для модулей также похожи на запросы для устройств, но выбрано для `moduleId` из. `devices.modules` Пример: 

```json
{
  "queries": {
    "Compliant": "select deviceId, moduleId from devices.module where configurations.[[chillermodulesettingswashington]].status = 'Applied' AND properties.reported.chillerWaterSettings.status='current'"
  }
}
```

## <a name="create-a-configuration"></a>Создание конфигурации

Создавая конфигурацию, состоящую из целевого содержимого и метрик, вы настраиваете целевые устройства. 

Создайте конфигурацию с помощью следующей команды.

```azurecli
   az iot hub configuration create --config-id [configuration id] \
     --labels [labels] --content [file path] --hub-name [hub name] \
     --target-condition [target query] --priority [int] \
     --metrics [metric queries]
```

* --**config-id** — имя конфигурации, которая будет создана в центре IoT. Присвойте вашей конфигурации уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.

* --**labels** — добавление меток для облегчения отслеживания конфигураций. Метка представляет собой пару имя и значение, которые описывают развертывание. Например, `HostPlatform, Linux` или `Version, 3.0.1`.

* --**content** — встроенный JSON или путь к целевому содержимому, которому должны быть заданы двойные требуемые свойства. 

* --**hub-name** — имя центра IoT, в котором будет создана конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`

* --**Target — условие** — введите целевое условие, чтобы определить, какие устройства или модули будут нацелены на эту конфигурацию.Для автоматической настройки устройства условие основано на тегах двойникаа устройства или требуемых свойствах двойникаа устройства и должно соответствовать формату выражения.Например, `tags.environment='test'` или `properties.desired.devicemodel='4000x'`.Для автоматической настройки модуля это условие основано на тегах модуля двойника или требуемых свойствах модуля двойника. Например, `from devices.modules where tags.environment='test'` или `from devices.modules where properties.reported.chillerProperties.model='4000x'`.

* --**priority** — положительные целые числа. В случае, если две или более конфигурации нацелены на одно устройство или модуль, будет применяться конфигурация с наибольшим числовым значением приоритета.

* --**metrics** — путь к запросам метрик. Метрики предоставляют сводные показатели различных состояний, которые устройство или модуль могут передавать обратно после применения содержимого конфигурации. Например, вы можете создать метрику для ожидающих изменений параметров, метрики для ошибок и метрики для успешных изменений параметров. 

## <a name="monitor-a-configuration"></a>Мониторинг конфигурации

Чтобы отобразить содержимое конфигурации, используйте следующую команду.

```azurecli
az iot hub configuration show --config-id [configuration id] \
  --hub-name [hub name]
```

* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`

Проверьте конфигурацию в командном окне.Свойство **metrics** перечисляет количество каждой метрики, которое оценивается каждым центром.

* **таржетедкаунт** — системная метрика, указывающая число двойниковов устройств или двойников модуля в центре Интернета вещей, которые соответствуют условию нацеливания.

* **апплиедкаунт** — системная метрика указывает количество устройств или модулей, к которым применено целевое содержимое.

* **Настраиваемая метрика** — все определенные вами метрики являются метриками пользователей.

Список идентификаторов устройств, идентификаторов модулей или объектов для каждой из метрик можно просмотреть с помощью следующей команды:

```azurecli
az iot hub configuration show-metric --config-id [configuration id] \
   --metric-id [metric id] --hub-name [hub name] --metric-type [type] 
```

* --**config-id** — имя существующего развертывания в центре IoT.

* --**Metric-ID** — имя метрики, для которой необходимо просмотреть список идентификаторов устройств или идентификаторов модулей, например `appliedCount`.

* --**hub-name** — имя центра IoT, в котором существует развертывание. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

* --**metric-type** — возможные значения типа метрики: `system` или `user`.  Метрики систем: `targetedCount` и `appliedCount`. Все другие метрики — это пользовательские метрики.

## <a name="modify-a-configuration"></a>Изменение конфигурации

При изменении конфигурации изменения немедленно реплицируются во все целевые устройства. 

Если обновить целевое условие, произойдут следующие обновления:

* Если двойника не соответствует старому целевому условию, но соответствует новому целевому условию, а эта конфигурация является самым высоким приоритетом для этого двойника, то применяется такая конфигурация. 

* Если двойника, в настоящее время выполняющий эту конфигурацию, больше не соответствует целевому условию, параметры из конфигурации будут удалены, а двойника будет изменена следующей конфигурацией с наивысшим приоритетом. 

* Если двойника, выполняющая эту конфигурацию, больше не соответствует целевому условию и не соответствует целевому состоянию каких-либо других конфигураций, параметры из конфигурации будут удалены, а другие изменения в двойника не будут внесены. 

Обновите конфигурацию с помощью следующей команды.

```azurecli
az iot hub configuration update --config-id [configuration id] \
   --hub-name [hub name] --set [property1.property2='value']
```

* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

* --**set** — обновление свойства в конфигурации. Можно обновлять следующие свойства.

    * targetCondition — например `targetCondition=tags.location.state='Oregon'`

    * метки; 

    * priority

## <a name="delete-a-configuration"></a>Удаление конфигурации

При удалении конфигурации любой двойников устройства или модуль двойников принимает их следующую конфигурацию с наивысшим приоритетом. Если двойников не соответствует целевому состоянию какой бы то ни было другой конфигурации, другие параметры не применяются. 

Удалите конфигурацию с помощью следующей команды.

```azurecli
az iot hub configuration delete --config-id [configuration id] \
   --hub-name [hub name] 
```

* --**config-id** — имя существующей конфигурации в центре IoT.

* --**hub-name** — имя центра IoT, в котором существует конфигурация. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`.

## <a name="next-steps"></a>Дальнейшие шаги

В этой статье вы узнали, как настраивать и отслеживать устройства Интернета вещей в масштабе. Дополнительные сведения об управлении Центром Интернета вещей в Azure см. по следующим ссылкам:

* [Управление удостоверениями устройств Центра Интернета вещей в пакетном режиме](iot-hub-bulk-identity-mgmt.md)
* [Метрики Центра Интернета вещей](iot-hub-metrics.md)
* [Мониторинг операций](iot-hub-operations-monitoring.md)

Для дальнейшего изучения возможностей Центра Интернета вещей см. следующие статьи:

* [Руководство разработчика для Центра Интернета вещей](iot-hub-devguide.md)
* [Краткое руководство. Развертывание первого модуля IoT Edge на устройстве под управлением 64-разрядной ОС Linux](../iot-edge/tutorial-simulate-device-linux.md)

Узнайте, как использовать службу подготовки устройств для Центра Интернета вещей, чтобы включить автоматическую подготовку JIT, из следующей статьи: 

* [Служба подготовки устройств к добавлению в Центр Интернета вещей Azure](/azure/iot-dps)
