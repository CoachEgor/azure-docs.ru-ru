---
title: Обзор обогащения сообщений Azure IoT концентратора
description: В этой статье показаны обогащения сообщений, которые дают IoT Hub возможность штамповать сообщения дополнительной информацией до отправки сообщений в назначенную конечную точку.
author: robinsh
manager: philmea
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 05/10/2019
ms.author: robinsh
ms.openlocfilehash: c3dbd01faf61c164c88f09b0da03c07be4abd187
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75429124"
---
# <a name="message-enrichments-for-device-to-cloud-iot-hub-messages"></a>Обогащение сообщений для сообщений IoT Hub от устройства к облаку

*Обогащение сообщений* — это возможность Концентратора IoT *штамповать* сообщения дополнительной информацией до отправки сообщений в назначенную конечную точку. Одной из причин использования обогащения сообщений является включение данных, которые могут быть использованы для упрощения обработки ниже по течению. Например, обогащение телеметрических сообщений устройства с помощью тегов-близнецов устройства может снизить нагрузку на клиентов, чтобы сделать устройство twin API вызывает эту информацию.

![Поток обогащения сообщений](./media/iot-hub-message-enrichments-overview/message-enrichments-flow.png)

Обогащение сообщений имеет три ключевых элемента:

* Имя обогащения или ключ

* Значение

* Одна или несколько [конечных точек,](iot-hub-devguide-endpoints.md) для которых следует применять обогащение.

**Ключ** - это строка. Ключ может содержать только алфавитные символы или эти специальные`-`символы:`_`дефис`.`(), подчеркнуть ( , и период ().

**Значение** может быть любым из следующих примеров:

* Любая статическая строка. Динамические значения, такие как условия, логика, операции и функции, не допускаются. Например, если вы разрабатываете приложение SaaS, используемое несколькими клиентами, можно назначить идентификатор каждому клиенту и сделать этот идентификатор доступным в приложении. При запуске приложения IoT Hub будет штамповать телеметрические сообщения устройства с идентификатором клиента, что позволяет обрабатывать сообщения по-разному для каждого клиента.

* Название концентратора IoT, отправляющий сообщение. Это значение *является $iothubname*.

* Информация от близнеца устройства, например, его путь. Примерами могут быть *$twin.tags.field* и *$twin.tags.latitude*.

   > [!NOTE]
   > В настоящее время поддерживаются только $iothubname, $twin.теги, $twin.properties.desired и $twin.properties.reported, поддерживаемые переменные для обогащения сообщений.

Обогащение сообщений добавляется в качестве свойств приложений в сообщения, отправленные в выбранную конечную точку(ы).  

## <a name="applying-enrichments"></a>Применение обогащения

Сообщения могут поступать из любого источника данных, поддерживаемого [разгромом сообщений IoT Hub,](iot-hub-devguide-messages-d2c.md)включая следующие примеры:

* телеметрия устройства, например, температура или давление
* устройства двойного изменения уведомлений - изменения в устройстве близнец
* события жизненного цикла устройства, например, когда устройство создается или удаляется

Можно добавить обогащения в сообщения, идущие в встроенную конечную точку концентратора IoT, или сообщения, которые направляются в пользовательские конечные точки, такие как хранилище Azure Blob, очередь в автобус службы или тема шины обслуживания.

Вы можете добавить обогащения в сообщения, которые публикуются в Event Grid, выбрав конечную точку в качестве сетки событий. Мы создаем маршрут по умолчанию в Концентраторе IoT для телеметрии устройств, на основе подписки Event Grid. Этот единый маршрут может обрабатывать все ваши подписки Event Grid. Вы можете настроить обогащения для конечной точки сетки событий после создания подписки сетки событий для телеметрии устройства. Для получения дополнительной [Iot Hub and Event Grid](iot-hub-event-grid.md)информации см.

Обогащение применяется на конечную точку. Если указать пять обогащений, которые должны быть проштампованы для конкретной точки, все сообщения, идущие в эту конечную точку штамп с теми же пятью обогащениями.

Обогащение может быть настроено с использованием следующих методов:

| **Метод** | **Команда** |
| ----- | -----| 
| Портал | [Портал Azure](https://portal.azure.com) | Посмотреть учебник по [обогащению сообщений](tutorial-message-enrichments.md) | 
| Azure CLI   | [аз-йот концентратор сообщение-обогащение](https://docs.microsoft.com/cli/azure/iot/hub/message-enrichment?view=azure-cli-latest) |
| Azure PowerShell | [Add-AzIotHubMessageEnrichment;](https://docs.microsoft.com/powershell/module/az.iothub/add-aziothubmessageenrichment?view=azps-2.8.0) |

Добавление обогащения сообщений не добавляет задержки в разгром сообщения.

Чтобы опробовать обогащение сообщений, смотрите учебник по [обогащению сообщений](tutorial-message-enrichments.md)

## <a name="limitations"></a>Ограничения

* Вы можете добавить до 10 обогащений на IoT концентратор для этих концентраторов в стандартном или базовом уровне. Для Концентраторов IoT в свободном уровне можно добавить до 2 обогащений.

* В некоторых случаях, если вы применяете обогащение со значением, установленным для тега или свойства в устройстве близнеца, значение будет штамп в виде строки значение. Например, если значение обогащения установлено на $twin.tags.field, сообщения будут проштампованы строкой "$twin.tags.field", а не значением этого поля от близнеца. Это происходит в следующих случаях:

   * Ваш концентратор IoT находится в базовом уровне. Базовые концентраторы IoT уровня не поддерживают близнецов устройств.

   * Ваш концентратор IoT находится в стандартном уровне, но устройство, отправляющее сообщение, не имеет двойника устройства.

   * Ваш Концентратор IoT находится в стандартном уровне, но двойной путь устройства, используемый для значения обогащения, не существует. Например, если значение обогащения установлено на $twin.tags.location, а близнец устройства не имеет свойства местоположения под тегами, сообщение штампуют строкой "$twin.tags.location". 

* Обновление устройства близнец может занять до пяти минут, чтобы быть отражены в соответствующем значении обогащения.

* Общий размер сообщения, включая обогащение, не может превышать 256 кБ. Если размер сообщения превышает 256 кБ, концентратор IoT откажется от сообщения. Для выявления и оттаивливания ошибок при удалении сообщений можно использовать [метрики Концентратора IoT.](iot-hub-metrics.md) Например, можно следить за d2c.telemetry.egress.invalid.

* Обогащение сообщений не распространяется на цифровые события изменения близнецов (часть [публичного предварительного просмотра IoT Plug and Play).](../iot-pnp/overview-iot-plug-and-play.md)

## <a name="pricing"></a>Цены

Обогащение сообщений доступно без дополнительной платы. В настоящее время с вас взимается плата при отправке сообщения в концентратор IoT. Плата за это сообщение взимается только один раз, даже если сообщение попадает в несколько конечных точек.

## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь с этими статьями для получения дополнительной информации о направлении сообщений в концентратор IoT:

* [Учебник по обогащению сообщений](tutorial-message-enrichments.md)

* [Используйте разгром сообщений IoT Hub для отправки сообщений от устройства в облако в различные конечные точки](iot-hub-devguide-messages-d2c.md)

* [Учебник: Разгром концентратора IoT](tutorial-routing.md)
