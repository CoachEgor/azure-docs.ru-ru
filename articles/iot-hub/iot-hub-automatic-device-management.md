---
title: Автоматическое управление устройствами в масштабе с Azure IoT концентратором Документы Майкрософт
description: Используйте автоматические конфигурации Azure IoT Hub для управления несколькими устройствами и модулями IoT
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 12/13/2019
ms.author: robinsh
ms.openlocfilehash: 276f115f579fbd1ab077722b220a4a0c6c571850
ms.sourcegitcommit: 75089113827229663afed75b8364ab5212d67323
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2020
ms.locfileid: "82025073"
---
# <a name="automatic-iot-device-and-module-management-using-the-azure-portal"></a>Автоматическое управление устройством IoT и модулем с помощью портала Azure

[!INCLUDE [iot-edge-how-to-deploy-monitor-selector](../../includes/iot-hub-auto-device-config-selector.md)]

Автоматическое управление устройствами в Azure IoT Hub автоматизирует многие повторяющиеся и сложные задачи управления большими парками устройств. С помощью автоматического управления устройствами можно настроить таргетинг на набор устройств на основе их свойств, определить нужную конфигурацию, а затем позволить IoT Hub обновить устройства, когда они появляются в области. Это обновление выполняется с помощью _автоматической конфигурации устройства_ или _автоматической конфигурации модуля,_ которая позволяет суммировать завершение и соответствие требованиям, обрабатывать слияния и конфликты, а также развертывать конфигурации в поэтапном подходе.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Автоматическое управление устройством работает путем обновления набора близнецов устройств или близнецов модулей с желаемыми свойствами и отчетности резюме, которое основано на свойствах близнецов.  Он вводит новый класс и документ JSON под названием *Конфигурация,* который имеет три части:

* **Целевое условие** определяет область действия близнецов устройств или близнецов модулей, которые должны быть обновлены. Целевое условие указывается как запрос на тегов-близнецов и/или сообщаемых свойствах.

* **Целевой контент** определяет желаемые свойства, которые должны быть добавлены или обновлены в целевых близнецов устройства или близнецов модулей. Содержимое включает в себя путь к разделу требуемых свойств, которые необходимо изменить.

* **Метрики** определяют общее количество различных состояний конфигурации, таких как **Успешно**, **Выполняется** и **Ошибка**. Пользовательские метрики указаны как запросы на свойствах с двумя зарегистрированными.  Системные метрики — это метрики по умолчанию, которые измеряют статус двойного обновления, такие как число близнецов, которые являются целевыми, и число близнецов, которые были успешно обновлены.

Автоматические конфигурации работают впервые вскоре после создания конфигурации, а затем с пятиминутными интервалами. Запросы метрик исходят при запуске автоматической конфигурации.

## <a name="implement-twins"></a>Реализация близнецов

Для автоматических конфигураций устройств требуется использовать двойники устройств, чтобы синхронизировать состояние между облаком и устройствами.  См. [общие сведения о двойниках устройств и их использовании в Центре Интернета вещей](iot-hub-devguide-device-twins.md).

Конфигурации автоматических модулей требуют использования близнецов модулей для синхронизации состояния между облаком и модулями. Для получения дополнительной информации [см. Понимание и использование близнецов модулей в IoT Hub](iot-hub-devguide-module-twins.md).

## <a name="use-tags-to-target-twins"></a>Используйте теги для целевой близнецов

Перед созданием конфигурации необходимо указать, на какие устройства или модули вы хотите повлиять. Azure IoT Концентратор идентифицирует устройства и использует теги в близнеце устройства, и определяет модули с помощью тегов в двойнике модуля. Каждое устройство или модули могут иметь несколько тегов, и вы можете определить их любым способом, который имеет смысл для вашего решения. Например, если вы управляете устройствами в разных местах, добавьте следующие теги к близнецу устройства:

```json
"tags": {
    "location": {
        "state": "Washington",
        "city": "Tacoma"
    }
},
```

## <a name="create-a-configuration"></a>Создание конфигурации

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**.

3. Выберите **Конфигурацию устройства добавить** или **добавить конфигурацию модуля.**

   ![Добавление конфигурации или модуля устройства](./media/iot-hub-automatic-device-management/create-automatic-configuration.png)

Процедура создания конфигурации состоит из пяти шагов. В следующих разделах описан каждый из этих шагов. 

### <a name="name-and-label"></a>Имя и метка

1. Присвойте вашей конфигурации уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.

2. Добавьте метки для отслеживания конфигураций. Метки представляют собой пары **имени** и **значения**, которые описывают конфигурацию. Например, `HostPlatform, Linux` или `Version, 3.0.1`.

3. Чтобы перейти к следующему шагу, нажмите кнопку **Далее**. 

### <a name="specify-settings"></a>Указание параметров

В этом разделе определяется содержимое, которое будет установлено в целевых близнецах устройства или модуля. Для каждого набора параметров есть два вида входных данных. Во-первых, это путь близнецов, который является путь к разделу JSON в близнецов желаемых свойств, которые будут установлены.  Второй — это содержимое JSON, которое должно быть вставлено в этот раздел. 

Например, можно установить двойной путь, `properties.desired.chiller-water` а затем предоставить следующее содержимое JSON: 

```json
{
  "temperature": 66,
  "pressure": 28
}
```

![Установите путь близнецов и содержание](./media/iot-hub-automatic-device-management/module-config-twin-settings.png)


Можно также установить индивидуальные настройки, указав весь путь близнецов и предоставив значение без скобок. Например, с двойным `properties.desired.chiller-water.temperature`путем, `66`установите содержание. Затем создайте новую настройку близнецов для свойства давления. 

Если две или более конфигураций нацелены на один и тот же двойной путь, будет применяться содержимое из конфигурации с наивысшим приоритетом (приоритет определяется в шаге 4).

Если вы хотите удалить существующее свойство, `null`укажите стоимость свойства.

Вы можете добавить дополнительные настройки, выбрав **Настройка twin устройства или** **добавить модуль Twin Setting.**

### <a name="specify-metrics-optional"></a>Указание метрик (необязательно)

Метрики обеспечивают сводные подсчеты различных состояний, которые устройство или модуль могут отчитываться после применения содержимого конфигурации. Например, вы можете создать метрику для ожидающих изменений параметров, метрики для ошибок и метрики для успешных изменений параметров.

Каждая конфигурация может иметь до пяти пользовательских метрик. 

1. Введите имя **для метеоиментного имени.**

2. Введите запрос для параметра **Metric Criteria** (Критерии метрики).  Запрос основан на сообщаемых свойствах двойников устройств.  Метрика представляет количество строк, возвращаемых запросом.

Пример:

```sql
SELECT deviceId FROM devices 
  WHERE properties.reported.chillerWaterSettings.status='pending'
```

Предложение с указанием того, что конфигурация была применена, см. в примере. 

```sql
/* Include the double brackets. */
SELECT deviceId FROM devices 
  WHERE configurations.[[yourconfigname]].status='Applied'
```

Если вы строите метрику для отчета о `moduleId` `devices.modules`настроенных модулях, выберите один из. Пример:

```sql
SELECT deviceId, moduleId FROM devices.modules
  WHERE properties.reported.lastDesiredStatus.code = 200
```

### <a name="target-devices"></a>Целевые устройства

Используйте свойство тегов от близнецов, чтобы настроить таргетинг на определенные устройства или модули, которые должны получить эту конфигурацию. Вы также можете настроить таргетинг на свойства близнецов.

Автоматические конфигурации устройств могут быть нацелены только на двойные метки устройства, а автоматические конфигурации модулей могут быть нацелены только на двойные метки модуля. 

Поскольку несколько конфигураций могут быть нацелены на одно и то же устройство или модуль, каждая конфигурация нуждается в приоритетном номере. Если возникает конфликт, побеждает конфигурация с наивысшим приоритетом. 

1. Введите положительное целое число для **приоритета** конфигурации. Наивысшее числовое значение считается наивысшим приоритетом. Когда обе конфигурации имеют одинаковый номер приоритета, побеждает та, которая была создана недавно. 

2. Введите **условие цели,** чтобы определить, какие устройства или модули будут нацелены на эту конфигурацию. Условие основано на двух тегах или двухзарегистрированных свойствах и должно соответствовать формату выражения. 

   Для автоматической конфигурации устройства можно указать только тег или объект свойства. Например, `tags.environment='test'` или `properties.reported.chillerProperties.model='4000x'`. Вы можете выбрать `*` для всех устройств. 
   
   Для автоматической конфигурации модуля используйте запрос для указания тегов или объектов, указанных в модулях, зарегистрированных в концентраторе IoT. Например, `from devices.modules where tags.environment='test'` или `from devices.modules where properties.reported.chillerProperties.model='4000x'`. Подстановочный знак не может быть использован для таргетинга на все модули. 

3. Нажмите кнопку **Далее**, чтобы перейти к последнему шагу.

### <a name="review-configuration"></a>Просмотр конфигурации

Просмотрите сведения о конфигурации, а затем выберите **Отправить**.

## <a name="monitor-a-configuration"></a>Мониторинг конфигурации

Чтобы просмотреть сведения о конфигурации и узнать, какое устройство ее использует, сделайте следующее:

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**.

3. Проверьте список конфигураций. Для каждой конфигурации можно просмотреть следующие сведения:

   * **Идентификатор**. Имя конфигурации.

   * **Целевое состояние** - запрос, используемый для определения целевых устройств или модулей.

   * **Приоритет**. Номер приоритета, назначенный для конфигурации.

   * **Время создания**. Метка времени, когда была создана конфигурация. Метка времени используется, чтобы разорвать связи, если две конфигурации имеют одинаковый приоритет. 

   * **Системные метрики**. Метрики, которые вычисляются Центром Интернета вещей и не могут быть настроены разработчиками. Целевое условие указывает количество двойников устройств, которые соответствуют целевому состоянию. Применяет заданное количество двойников устройств, которые были изменены конфигурацией, а также могут содержать частичные изменения в случае, если они были сделаны отдельной конфигурацией с более высоким приоритетом. 

   * **Пользовательские метрики** - метрики, которые были указаны разработчиком в качестве запросов в отношении свойств, сообщаемых о близнецах.  Для каждой конфигурации можно определить до пяти пользовательских метрик. 
   
4. Выберите конфигурацию, которую следует отслеживать.  

5. Проверьте сведения о конфигурации. С помощью вкладок можно просмотреть конкретные сведения об устройствах, к которым применена конфигурация.

   * **Целевое состояние** - устройства или модули, которые соответствуют целевому состоянию. 

   * **Метрики**. Список системных и пользовательских метрик.  Вы можете просмотреть список устройств или модулей, которые учитываются для каждой метрики, выбрав метрику в выпадающих **устройствах,** а затем выбрав **модули View Devices** или View.

   * **Настройки двух устройств** или **настройки Twin Module** - двойные настройки, которые устанавливаются конфигурацией. 

   * **Configuration Labels** (Метки конфигурации). Пары "ключ — значение", используемые для описания конфигурации.  Метки не влияют на функциональность. 

## <a name="modify-a-configuration"></a>Изменение конфигурации

При изменении конфигурации изменения немедленно реплицируются на все целевые устройства или модули. 

Если обновить целевое условие, произойдут следующие обновления:

* Если близнец не соответствует старому целевому состоянию, но соответствует новому целевому состоянию, и эта конфигурация является наивысшим приоритетом для этого близнеца, то эта конфигурация применяется. 

* Если близнец, в настоящее время работающий в настоящее время, больше не соответствует целевому условию, настройки из конфигурации будут удалены, а паранджи будет изменен следующей конфигурацией с наивысшим приоритетом. 

* Если близнец, работающий в настоящее время, больше не соответствует целевому состоянию и не соответствует целевому состоянию любых других конфигураций, то настройки из конфигурации будут удалены, и никакие другие изменения не будут внесены на близнеца. 

Чтобы изменить конфигурацию, сделайте следующее: 

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**. 

3. Выберите конфигурацию, которую следует изменить. 

4. Внесите изменения в следующие поля: 

   * Условие назначения 
   * Метки 
   * Priority 
   * Метрики

4. Щелкните **Сохранить**.

5. Следуйте указаниям раздела [Мониторинг конфигурации](#monitor-a-configuration) для отслеживания выполнения изменений. 

## <a name="delete-a-configuration"></a>Удаление конфигурации

Когда вы удаляете конфигурацию, все двойники устройств принимают следующую конфигурацию с самым высоким приоритетом. Если двойники устройств не соответствуют целевому условию любой другой конфигурации, то другие параметры не применяются. 

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**. 

3. Установите флажок, чтобы выбрать конфигурацию, которую необходимо удалить. 

4. Выберите команду **Удалить**.

5. Появится запрос на подтверждение.

## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали, как настроить и контролировать IoT устройств в масштабе. Дополнительные сведения об управлении Центром Интернета вещей в Azure см. по следующим ссылкам:

* [Управление удостоверениями устройств Центра Интернета вещей в пакетном режиме](iot-hub-bulk-identity-mgmt.md)
* [Метрики Центра Интернета вещей](iot-hub-metrics.md)
* [Мониторинг операций](iot-hub-operations-monitoring.md)

Для дальнейшего изучения возможностей Центра Интернета вещей см. следующие статьи:

* [Руководство разработчика для Центра Интернета вещей](iot-hub-devguide.md)
* [Краткое руководство. Развертывание первого модуля IoT Edge на устройстве под управлением 64-разрядной ОС Linux](../iot-edge/tutorial-simulate-device-linux.md)

Узнайте, как использовать службу подготовки устройств для Центра Интернета вещей, чтобы включить автоматическую подготовку JIT, из следующей статьи: 

* [Служба подготовки устройств к добавлению в Центр Интернета вещей Azure](/azure/iot-dps)
