---
title: Автоматическое управление устройствами в масштабе с помощью центра Интернета вещей Azure | Документация Майкрософт
description: Использование автоматической конфигурации центра Интернета вещей Azure для управления несколькими устройствами и модулями Интернета вещей
author: ChrisGMsft
manager: bruz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 12/13/2019
ms.author: chrisgre
ms.openlocfilehash: 75c6b7d89e7ae540e7428afde127281aa3f15fc6
ms.sourcegitcommit: 7b25c9981b52c385af77feb022825c1be6ff55bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2020
ms.locfileid: "79271308"
---
# <a name="automatic-iot-device-and-module-management-using-the-azure-portal"></a>Автоматическое управление устройствами IoT и модулем с помощью портал Azure

[!INCLUDE [iot-edge-how-to-deploy-monitor-selector](../../includes/iot-hub-auto-device-config-selector.md)]

Автоматическое управление устройствами в центре Интернета вещей Azure автоматизирует многие из повторяющихся и сложных задач по управлению большими парками устройств. С помощью автоматического управления устройствами можно выбрать набор устройств на основе их свойств, определить требуемую конфигурацию, а затем разрешить центру Интернета вещей обновлять устройства, когда они поступают в область. Это обновление выполняется с помощью _автоматической конфигурации устройства_ или _автоматической конфигурации модуля_, которая позволяет суммировать завершение и соответствие, обрабатывать объединение и конфликты, а также развертывание конфигураций в поэтапном подходе.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Автоматическое управление устройствами работает путем обновления набора двойникова устройства или модуля двойников с требуемыми свойствами и формирования сводки, основанной на сообщаемых свойствах двойника.  В нем представлен новый класс и документ JSON, называемый *конфигурацией* , которая состоит из трех частей:

* **Целевое условие** определяет область действия двойникова устройства или двойников модуля для обновления. Целевое условие указывается как запрос к тегам двойника и/или сообщаемым свойствам.

* **Целевое содержимое** определяет требуемые свойства для добавления или обновления в целевом устройстве двойников или модуле двойников. Содержимое включает в себя путь к разделу требуемых свойств, которые необходимо изменить.

* **Метрики** определяют общее количество различных состояний конфигурации, таких как **Успешно**, **Выполняется** и **Ошибка**. Пользовательские метрики указываются в виде запросов к сообщаемым свойствам двойника.  Метрики системы — это метрики по умолчанию, которые измеряют состояние обновления двойника, такие как количество целевых двойников и количество двойников, которые были успешно обновлены.

Автоматические конфигурации запускаются в первый раз вскоре после создания конфигурации, а затем с интервалом в пять минут. Запросы метрик запускаются при каждом запуске автоматической настройки.

## <a name="implement-twins"></a>Реализация двойников

Для автоматических конфигураций устройств требуется использовать двойники устройств, чтобы синхронизировать состояние между облаком и устройствами.  См. [общие сведения о двойниках устройств и их использовании в Центре Интернета вещей](iot-hub-devguide-device-twins.md).

Для автоматической настройки модулей необходимо использовать модуль двойников для синхронизации состояния между облаком и модулями. Дополнительные сведения см. в статье сведения об [использовании модуля двойников в центре Интернета вещей](iot-hub-devguide-module-twins.md).

## <a name="use-tags-to-target-twins"></a>Использование тегов для назначения двойников

Перед созданием конфигурации необходимо указать, какие устройства или модули необходимо задействовать. Центр Интернета вещей Azure идентифицирует устройства и использует теги в двойникае устройства, а также определяет модули с помощью тегов в модуле двойника. Каждое устройство или модули могут иметь несколько тегов, и их можно определить любым способом, который имеет смысл для вашего решения. Например, если вы управляете устройствами в разных местах, добавьте следующие теги в двойника устройства:

```json
"tags": {
    "location": {
        "state": "Washington",
        "city": "Tacoma"
    }
},
```

## <a name="create-a-configuration"></a>Создание конфигурации

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**.

3. Выберите **Добавить конфигурацию устройства** или **Добавить конфигурацию модуля**.

   ![Добавление конфигурации устройства или конфигурации модуля](./media/iot-hub-automatic-device-management/create-automatic-configuration.png)

Процедура создания конфигурации состоит из пяти шагов. В следующих разделах описан каждый из этих шагов. 

### <a name="name-and-label"></a>Имя и метка

1. Присвойте вашей конфигурации уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.

2. Добавьте метки для отслеживания конфигураций. Метки представляют собой пары **имени** и **значения**, которые описывают конфигурацию. Например, `HostPlatform, Linux` или `Version, 3.0.1`.

3. Чтобы перейти к следующему шагу, нажмите кнопку **Далее**. 

### <a name="specify-settings"></a>Указание параметров

В этом разделе определяется содержимое, устанавливаемое в целевом устройстве или модуле двойников. Для каждого набора параметров есть два вида входных данных. Первый — это путь двойника, который является путем к разделу JSON в пределах требуемых свойств двойника, которые будут установлены.  Второй — это содержимое JSON, которое должно быть вставлено в этот раздел. 

Например, можно задать путь двойника к `properties.desired.chiller-water`, а затем предоставить следующее содержимое JSON: 

```json
{
  "temperature": 66,
  "pressure": 28
}
```

![Задание пути и содержимого двойника](./media/iot-hub-automatic-device-management/module-config-twin-settings.png)


Можно также задать отдельные параметры, указав весь путь двойника и указав значение без квадратных скобок. Например, для `properties.desired.chiller-water.temperature`пути двойника задайте для содержимого значение `66`. Затем создайте новый параметр двойника для свойства нажима. 

Если две или более конфигурации нацелены на один и тот же путь двойника, будет применено содержимое из конфигурации с наивысшим приоритетом (приоритет определяется на шаге 4).

Если вы хотите удалить существующее свойство, укажите значение свойства `null`.

Можно добавить дополнительные параметры, выбрав **Добавить параметр двойникаи устройства** или **Добавить параметр модуля двойника**.

### <a name="specify-metrics-optional"></a>Указание метрик (необязательно)

Метрики предоставляют сводные показатели различных состояний, которые устройство или модуль могут передавать обратно после применения содержимого конфигурации. Например, вы можете создать метрику для ожидающих изменений параметров, метрики для ошибок и метрики для успешных изменений параметров.

Каждая конфигурация может иметь до пяти пользовательских метрик. 

1. Введите имя для параметра **Имя метрики**.

2. Введите запрос для параметра **Metric Criteria** (Критерии метрики).  Запрос основан на сообщаемых свойствах двойников устройств.  Метрика представляет количество строк, возвращаемых запросом.

Пример:

```sql
SELECT deviceId FROM devices 
  WHERE properties.reported.chillerWaterSettings.status='pending'
```

Предложение с указанием того, что конфигурация была применена, см. в примере. 

```sql
/* Include the double brackets. */
SELECT deviceId FROM devices 
  WHERE configurations.[[yourconfigname]].status='Applied'
```

Если вы собираете метрику для создания отчета о настроенных модулях, выберите `moduleId` из `devices.modules`. Пример:

```sql
SELECT deviceId, moduleId FROM devices.modules
  WHERE properties.reported.lastDesiredStatus.code = 200
```

### <a name="target-devices"></a>Целевые устройства

Используйте свойство Tags из двойников для выбора конкретных устройств или модулей, которые должны получить эту конфигурацию. Можно также указать целевые свойства двойника.

Автоматические конфигурации устройств могут указывать только на теги двойникаов устройств, а автоматические конфигурации модулей — только для тегов двойника. 

Так как несколько конфигураций могут быть нацелены на одно устройство или модуль, для каждой конфигурации требуется номер приоритета. Если возникает конфликт, побеждает конфигурация с наивысшим приоритетом. 

1. Введите положительное целое число для **приоритета** конфигурации. Наивысшее числовое значение считается наивысшим приоритетом. Когда обе конфигурации имеют одинаковый номер приоритета, побеждает та, которая была создана недавно. 

2. Введите **целевое условие** , чтобы определить, какие устройства или модули будут нацелены на эту конфигурацию. Условие основано на тегах двойника или сообщаемых свойствах двойника и должно соответствовать формату выражения. 

   Для автоматической настройки устройства можно указать целевой объект только для тега или сообщаемого свойства. Например, `tags.environment='test'` или `properties.reported.chillerProperties.model='4000x'`. Вы можете выбрать `*` для всех устройств. 
   
   Для автоматической настройки модуля используйте запрос, чтобы указать теги или сообщаемые свойства из модулей, зарегистрированных в центре Интернета вещей. Например, `from devices.modules where tags.environment='test'` или `from devices.modules where properties.reported.chillerProperties.model='4000x'`. Подстановочный знак не может использоваться для всех модулей. 

3. Нажмите кнопку **Далее**, чтобы перейти к последнему шагу.

### <a name="review-configuration"></a>Просмотр конфигурации

Просмотрите сведения о конфигурации, а затем выберите **Отправить**.

## <a name="monitor-a-configuration"></a>Мониторинг конфигурации

Чтобы просмотреть сведения о конфигурации и узнать, какое устройство ее использует, сделайте следующее:

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**.

3. Проверьте список конфигураций. Для каждой конфигурации можно просмотреть следующие сведения:

   * **Идентификатор**. Имя конфигурации.

   * **Целевое условие** — запрос, используемый для определения целевых устройств или модулей.

   * **Приоритет**. Номер приоритета, назначенный для конфигурации.

   * **Время создания**. Метка времени, когда была создана конфигурация. Метка времени используется, чтобы разорвать связи, если две конфигурации имеют одинаковый приоритет. 

   * **Системные метрики**. Метрики, которые вычисляются Центром Интернета вещей и не могут быть настроены разработчиками. Целевое условие указывает количество двойников устройств, которые соответствуют целевому состоянию. Применяет заданное количество двойников устройств, которые были изменены конфигурацией, а также могут содержать частичные изменения в случае, если они были сделаны отдельной конфигурацией с более высоким приоритетом. 

   * **Пользовательские метрики** — метрики, заданные разработчиком как запросы к сообщаемым свойствам двойника.  Для каждой конфигурации можно определить до пяти пользовательских метрик. 
   
4. Выберите конфигурацию, которую следует отслеживать.  

5. Проверьте сведения о конфигурации. С помощью вкладок можно просмотреть конкретные сведения об устройствах, к которым применена конфигурация.

   * **Целевое условие** — устройства или модули, соответствующие целевому условию. 

   * **Метрики**. Список системных и пользовательских метрик.  Вы можете просмотреть список устройств или модулей, подсчитанных для каждой метрики, выбрав метрику в раскрывающемся списке и выбрав **просмотреть устройства** или **модули просмотра**.

   * Параметры **двойникаа устройства** или **Параметры двойника модуля** — параметры двойника, заданные конфигурацией. 

   * **Configuration Labels** (Метки конфигурации). Пары "ключ — значение", используемые для описания конфигурации.  Метки не влияют на функциональность. 

## <a name="modify-a-configuration"></a>Изменение конфигурации

При изменении конфигурации изменения немедленно реплицируются на все целевые устройства или модули. 

Если обновить целевое условие, произойдут следующие обновления:

* Если двойника не соответствует старому целевому условию, но соответствует новому целевому условию, а эта конфигурация является самым высоким приоритетом для этого двойника, то применяется такая конфигурация. 

* Если двойника, в настоящее время выполняющий эту конфигурацию, больше не соответствует целевому условию, параметры из конфигурации будут удалены, а двойника будет изменена следующей конфигурацией с наивысшим приоритетом. 

* Если двойника, выполняющая эту конфигурацию, больше не соответствует целевому условию и не соответствует целевому состоянию каких-либо других конфигураций, параметры из конфигурации будут удалены, а другие изменения в двойника не будут внесены. 

Чтобы изменить конфигурацию, сделайте следующее: 

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**. 

3. Выберите конфигурацию, которую следует изменить. 

4. Внесите изменения в следующие поля: 

   * Условие назначения 
   * Метки 
   * Приоритет 
   * Метрики

4. Щелкните **Сохранить**.

5. Следуйте указаниям раздела [Мониторинг конфигурации](#monitor-a-configuration) для отслеживания выполнения изменений. 

## <a name="delete-a-configuration"></a>Удаление конфигурации

Когда вы удаляете конфигурацию, все двойники устройств принимают следующую конфигурацию с самым высоким приоритетом. Если двойники устройств не соответствуют целевому условию любой другой конфигурации, то другие параметры не применяются. 

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 

2. Выберите **Конфигурация устройства Интернета вещей**. 

3. Установите флажок, чтобы выбрать конфигурацию, которую необходимо удалить. 

4. Выберите команду **Удалить**.

5. Появится запрос на подтверждение.

## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали, как настраивать и отслеживать устройства Интернета вещей в масштабе. Дополнительные сведения об управлении Центром Интернета вещей в Azure см. по следующим ссылкам:

* [Управление удостоверениями устройств Центра Интернета вещей в пакетном режиме](iot-hub-bulk-identity-mgmt.md)
* [Общие сведения о метриках Центра Интернета вещей](iot-hub-metrics.md)
* [Мониторинг операций](iot-hub-operations-monitoring.md)

Для дальнейшего изучения возможностей Центра Интернета вещей см. следующие статьи:

* [Руководство разработчика для Центра Интернета вещей](iot-hub-devguide.md)
* [Краткое руководство. Развертывание первого модуля IoT Edge на устройстве под управлением 64-разрядной ОС Linux](../iot-edge/tutorial-simulate-device-linux.md)

Узнайте, как использовать службу подготовки устройств для Центра Интернета вещей, чтобы включить автоматическую подготовку JIT, из следующей статьи: 

* [Служба подготовки устройств для Центра Интернета вещей Azure](/azure/iot-dps)
