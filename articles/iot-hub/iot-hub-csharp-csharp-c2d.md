---
title: Отправка сообщений из облака на устройство с помощью Центра Интернета вещей Azure (.NET) | Документация Майкрософт
description: Сведения об отправке сообщений из облака на устройство из Центра Интернета вещей Azure с помощью пакетов SDK для Интернета вещей Azure для .NET. Для получения сообщений, отправляемых из облака на устройство, следует изменить приложение для устройства, а для отправки таких сообщений — внутреннее приложение.
author: robinsh
manager: philmea
ms.service: iot-hub
services: iot-hub
ms.devlang: csharp
ms.topic: conceptual
ms.date: 04/03/2019
ms.author: robinsh
ms.openlocfilehash: 7805b9b3f000b2bc2e45272ab9ff469d5711e581
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77110196"
---
# <a name="send-messages-from-the-cloud-to-your-device-with-iot-hub-net"></a>Отправка сообщений из облака на устройство с помощью Центра Интернета вещей (.NET)

[!INCLUDE [iot-hub-selector-c2d](../../includes/iot-hub-selector-c2d.md)]

Центр Интернета вещей Azure — это полностью управляемая служба, которая обеспечивает надежный и защищенный двунаправленный обмен данными между миллионами устройств и серверной частью решения. [Телеметрия отправки с устройства на быстрый запуск концентратора IoT](quickstart-send-telemetry-dotnet.md) показывает, как создать концентратор IoT, предоставить в нем идентификацию устройства и кодировать приложение устройства, которое отправляет сообщения от устройства к облаку.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Этот учебник основан на [отправке телеметрии с устройства на концентратор IoT.](quickstart-send-telemetry-dotnet.md) Он показывает вам, как сделать следующие задачи:

* Отправка сообщений, передаваемых из облака на устройство, из серверной части решения на одно устройство через Центр Интернета вещей.

* Получение на устройстве сообщений, передаваемых из облака на устройство.

* От задней части решения — запрос подтверждения доставки *(обратной связи)* для сообщений, отправленных на устройство из Концентратора IoT.

Дополнительные сведения о сообщениях, отправляемых из облака на устройство, см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

В конце этого урока вы запустите два консольных приложения .NET.

* **ИмитированоеУстройство**. Это приложение подключается к концентратору IoT и получает сообщения от облака к устройству. Это приложение представляет собой модифицированную версию приложения, созданного в [Телеметрии Отправить с устройства на концентратор IoT](quickstart-send-telemetry-dotnet.md).

* **ОтправитьCloudToDevice**. Это приложение отправляет сообщение об облаке к устройству в приложение устройства через IoT Концентратор, а затем получает подтверждение его доставки.

> [!NOTE]
> IoT Концентратор имеет поддержку SDK для многих платформ устройств и языков, включая C, Java, Python и Javascript, через [SDK-устройства Azure IoT.](iot-hub-devguide-sdks.md) Пошаговые инструкции по связыванию устройства с кодом из этого руководства, а также по подключению к Центру Интернета вещей Azure см. в [руководстве разработчика для Центра Интернета вещей](iot-hub-devguide.md).
>

## <a name="prerequisites"></a>Предварительные требования

* Visual Studio

* Активная учетная запись Azure. Если у вас нет учетной записи, вы можете создать [бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/) всего за пару минут.

* Убедитесь, что в брандмауэре открыт порт 8883. Образец устройства в этой статье использует протокол МЗТТ, который общается по порту 8883. В некоторых корпоративных и академических сетях этот порт может быть заблокирован. Дополнительные сведения и способы устранения этой проблемы см. в разделе о [подключении к Центру Интернета вещей по протоколу MQTT](iot-hub-mqtt-support.md#connecting-to-iot-hub).

## <a name="receive-messages-in-the-device-app"></a>Получение сообщений в приложении для устройства

В этом разделе измените приложение устройства, созданное в [телеметрии Отправки с устройства на концентратор IoT,](quickstart-send-telemetry-dotnet.md) чтобы получать сообщения от облака к устройству из концентратора IoT.

1. В Visual Studio в проекте **SimulatedDevice** добавьте в класс **Program** следующий метод:

   ```csharp
    private static async void ReceiveC2dAsync()
    {
        Console.WriteLine("\nReceiving cloud to device messages from service");
        while (true)
        {
            Message receivedMessage = await s_deviceClient.ReceiveAsync();
            if (receivedMessage == null) continue;

            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("Received message: {0}", 
            Encoding.ASCII.GetString(receivedMessage.GetBytes()));
            Console.ResetColor();

            await s_deviceClient.CompleteAsync(receivedMessage);
        }
    }
   ```

1. Добавьте в метод **Main** непосредственно перед строкой `Console.ReadLine()` следующий метод:

   ```csharp
   ReceiveC2dAsync();
   ```

Метод `ReceiveAsync` асинхронно возвращает полученное сообщение, когда устройство его получило. Он *возвращаетнулся недействительным* после определенного периода тайм-аута. В этом примере используется значение по умолчанию одной минуты. Когда приложение получит значение *NULL*, оно продолжит ожидание новых сообщений. Из-за этого требования присутствует строка `if (receivedMessage == null) continue`.

Вызов `CompleteAsync()` уведомляет Центр Интернета вещей об успешной обработке сообщения. Можно спокойно удалить сообщение из очереди устройства. Если что-то помешает приложению устройства завершить обработку сообщения, Центр Интернета вещей доставит его снова. Логика обработки сообщений в приложении устройства должна быть *идемпотентной,* так что получение одного и того же сообщения несколько раз дает один и тот же результат.

Приложение может также временно отказаться от сообщения. Тогда Центр Интернета вещей будет хранить сообщение в очереди для последующей обработки. Или приложение может отклонить сообщение, и тогда оно будет окончательно удалено из очереди. Дополнительные сведения о жизненном цикле сообщений, передаваемых из облака на устройство, см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

   > [!NOTE]
   > При использовании HTTPS вместо MQTT или AMQP в качестве транспорта немедленно возвращается метод `ReceiveAsync`. Схема сообщений, передаваемых из облака на устройство с помощью HTTPS, может использоваться на периодически подключаемых устройствах, которые редко проверяют наличие новых сообщений (реже, чем раз в 25 минут). Если HTTPS получает много результатов, регулируются запросы в Центре Интернета вещей. Дополнительные сведения о различиях между поддержкой MQTT, AMQP и HTTPS, а также регулировании Центра Интернета вещей см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).
   >

## <a name="get-the-iot-hub-connection-string"></a>Получите строку соединения концентратора IoT

В этой статье создается бэк-энд-сервис для отправки сообщений от облака к устройству через созданный концентратор IoT, созданный в [телеметрии Отправки с устройства на концентратор IoT.](quickstart-send-telemetry-dotnet.md) Для отправки сообщений об облаке и устройстве службе требуется разрешение **на подключение службы.** По умолчанию каждый концентратор IoT создается с помощью службы общего доступа, названной **службой,** которая предоставляет это разрешение.

[!INCLUDE [iot-hub-include-find-service-connection-string](../../includes/iot-hub-include-find-service-connection-string.md)]

## <a name="send-a-cloud-to-device-message"></a>Отправка сообщения из облака на устройство

Теперь вы пишете консоль .NET приложение, которое отправляет сообщения от облака к устройству в приложение устройства.

1. В текущем решении Visual Studio выберите **Файл** > **Новый** > **проект**. В **создании нового проекта**выберите **консоль новейшее приложение (.NET Framework),** а затем выберите **Следующий**.

1. Присвойте проекту имя *SendCloudToDevice*. В **рамках решения**выберите **Добавить в решение** и примите самую самую недавнюю версию рамочной программы .NET. Выберите **Создать**, чтобы создать проект.

   ![Настройка нового проекта в Visual Studio](./media/iot-hub-csharp-csharp-c2d/sendcloudtodevice-project-configure.png)

1. В Solution Explorer нажмите правой кнопкой мыши на новое решение, а затем выберите **Пакеты Управления NuGet.**

1. В **пакетах Manage NuGet**выберите **просмотр,** а затем поиск и выбор **Microsoft.Azure.Devices**. Выберите **Установить**.

   Этот шаг загружает, устанавливает и добавляет ссылку на [пакет Службы SDK NuGet службы Azure IoT.](https://www.nuget.org/packages/Microsoft.Azure.Devices/)

1. Добавьте `using` следующее утверждение в верхней части **файла Program.cs.**

   ``` csharp
   using Microsoft.Azure.Devices;
   ```

1. Добавьте следующие поля в класс **Program** . Замените значение заполнителя строкой подключения концентратора IoT, скопированной ранее в [строке подключения концентратора YouT.](#get-the-iot-hub-connection-string)

   ``` csharp
   static ServiceClient serviceClient;
   static string connectionString = "{iot hub connection string}";
   ```

1. Добавьте следующий метод в класс **Program**. Установите имя устройства на то, что вы использовали при определении устройства в [Отправить телеметрии с устройства на концентратор IoT.](quickstart-send-telemetry-dotnet.md)

   ``` csharp
   private async static Task SendCloudToDeviceMessageAsync()
   {
        var commandMessage = new
         Message(Encoding.ASCII.GetBytes("Cloud to device message."));
        await serviceClient.SendAsync("myFirstDevice", commandMessage);
   }
   ```

   Этот метод отправляет на устройство с идентификатором `myFirstDevice`новое сообщение, передаваемое из облака на устройство. Измените этот параметр только в том случае, если вы изменили его с той, которая используется в [телеметрии Отправки с устройства на концентратор IoT.](quickstart-send-telemetry-dotnet.md)

1. Наконец, добавьте следующие строки в **основной** метод.

   ``` csharp
   Console.WriteLine("Send Cloud-to-Device message\n");
   serviceClient = ServiceClient.CreateFromConnectionString(connectionString);

   Console.WriteLine("Press any key to send a C2D message.");
   Console.ReadLine();
   SendCloudToDeviceMessageAsync().Wait();
   Console.ReadLine();
   ```

1. В Solutions Explorer нажмите правой кнопкой мыши и выберите **проекты StartUp.**

1. В**проекте запуска** **Common Properties** > выберите **несколько проектов запуска,** затем выберите действие **Start** для **ReadDeviceToCloudMessages,** **SimulatedDevice**и **SendCloudToDevice.** Нажмите кнопку **ОК** , чтобы сохранить изменения.

1. Нажмите клавишу **F5**. Должны запуститься все три приложения. Выберите окна **SendCloudToDevice** и нажмите клавишу **ВВОД**. Приложение для устройства должно получить сообщение.

   ![Приложение получает сообщение](./media/iot-hub-csharp-csharp-c2d/sendc2d1.png)

## <a name="receive-delivery-feedback"></a>Получение подтверждений доставки

Для каждого сообщения об облаке к устройству можно запросить подтверждение доставки (или истечения срока действия) от IoT Hub. Этот параметр позволяет серверной части решения легко передавать данные в логику повторных попыток или компенсаций. Дополнительные сведения об отзывах сообщений, передаваемых из облака на устройство, см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

В этом разделе вы измените приложение **SendCloudToDevice**, чтобы оно запрашивало подтверждение и получало его из Центра Интернета вещей.

1. В Visual Studio в проекте **SendCloudToDevice** добавьте в класс **Program** следующий метод:

   ```csharp
   private async static void ReceiveFeedbackAsync()
   {
        var feedbackReceiver = serviceClient.GetFeedbackReceiver();

        Console.WriteLine("\nReceiving c2d feedback from service");
        while (true)
        {
            var feedbackBatch = await feedbackReceiver.ReceiveAsync();
            if (feedbackBatch == null) continue;

            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("Received feedback: {0}",
              string.Join(", ", feedbackBatch.Records.Select(f => f.StatusCode)));
            Console.ResetColor();

            await feedbackReceiver.CompleteAsync(feedbackBatch);
        }
    }
    ```

    Обратите внимание, что шаблон получения здесь аналогичен шаблону, использовавшемуся для получения сообщений из облака на устройство из приложения устройства.

1. Добавьте следующую строку в `serviceClient = ServiceClient.CreateFromConnectionString(connectionString)` **основной** метод, сразу после .

   ``` csharp
   ReceiveFeedbackAsync();
   ```

1. Чтобы запросить подтверждение доставки сообщения из облака на устройство, необходимо указать свойство в методе **SendCloudToDeviceMessageAsync** . Добавьте следующую строку, сразу после линии. `var commandMessage = new Message(...);`

   ``` csharp
   commandMessage.Ack = DeliveryAcknowledgement.Full;
   ```

1. Запустите приложения, нажав клавишу **F5**. Должны запуститься все три приложения. Выберите окна **SendCloudToDevice** и нажмите клавишу **ВВОД**. Приложение для устройства должно получить сообщение, а через несколько секунд ваше приложение **SendCloudToDevice** должно получить сообщение о подтверждении.

   ![Приложение получает сообщение](./media/iot-hub-csharp-csharp-c2d/sendc2d2.png)

> [!NOTE]
> Для простоты, этот учебник не реализует какой-либо политики повторной попытки. В производственном коде следует реализовать политики повторная попытка, такие как экспоненциальное резервное копирование, как это предлагается при [обработке временных неисправностей.](/azure/architecture/best-practices/transient-faults)
>

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы научились отправлять и получать сообщения из облака на устройство.

Примеры комплексных решений, в которых используется Центр Интернета вещей, см. в [документации по акселератору решения Azure IoT для удаленного мониторинга](https://docs.microsoft.com/azure/iot-suite/).

Дополнительные сведения о разработке решений с помощью Центра Интернета вещей см. в [руководстве разработчика для Центра Интернета вещей](iot-hub-devguide.md).
