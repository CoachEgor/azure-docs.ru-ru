---
title: Отправка сообщений из облака на устройство с помощью Центра Интернета вещей Azure (.NET) | Документация Майкрософт
description: Сведения об отправке сообщений из облака на устройство из Центра Интернета вещей Azure с помощью пакетов SDK для Интернета вещей Azure для .NET. Для получения сообщений, отправляемых из облака на устройство, следует изменить приложение для устройства, а для отправки таких сообщений — внутреннее приложение.
author: robinsh
manager: philmea
ms.service: iot-hub
services: iot-hub
ms.devlang: csharp
ms.topic: conceptual
ms.date: 04/03/2019
ms.author: robinsh
ms.custom:
- amqp
- mqtt
ms.openlocfilehash: 41c29e55f04f9edf06ba375ad4539e5fb3f82c18
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81733421"
---
# <a name="send-messages-from-the-cloud-to-your-device-with-iot-hub-net"></a>Отправка сообщений из облака на устройство с помощью Центра Интернета вещей (.NET)

[!INCLUDE [iot-hub-selector-c2d](../../includes/iot-hub-selector-c2d.md)]

Центр Интернета вещей Azure — это полностью управляемая служба, которая обеспечивает надежный и защищенный двунаправленный обмен данными между миллионами устройств и серверной частью решения. В кратком руководстве [Отправка данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md) показано, как создать центр Интернета вещей, подготавливать в нем удостоверение устройства и создать код для приложения устройства, отправляющего сообщения с устройства в облако.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Это руководство строится на [отправке данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md). В нем показано, как выполнять следующие задачи:

* Отправка сообщений, передаваемых из облака на устройство, из серверной части решения на одно устройство через Центр Интернета вещей.

* Получение на устройстве сообщений, передаваемых из облака на устройство.

* В серверной части решения запросите подтверждение доставки (*обратная связь*) для сообщений, отправляемых на устройство из центра Интернета вещей.

Дополнительные сведения о сообщениях, отправляемых из облака на устройство, см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

По завершении работы с этим руководством вы запустите два консольных приложения .NET.

* **SimulatedDevice**. Это приложение подключается к центру Интернета вещей и получает сообщения, отправляемые из облака на устройство. Это приложение является измененной версией приложения, созданного при [отправке данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md).

* **SendCloudToDevice**. Это приложение отправляет сообщение из облака на устройство в приложение устройства через центр Интернета вещей, а затем получает подтверждение доставки.

> [!NOTE]
> В центре Интернета вещей предусмотрена поддержка пакетов SDK для многих платформ устройств и языков, включая C, Java, Python и JavaScript, с помощью [пакетов SDK для устройств Azure IOT](iot-hub-devguide-sdks.md). Пошаговые инструкции по связыванию устройства с кодом из этого руководства, а также по подключению к Центру Интернета вещей Azure см. в [руководстве разработчика для Центра Интернета вещей](iot-hub-devguide.md).
>

## <a name="prerequisites"></a>Предварительные условия

* Visual Studio

* Активная учетная запись Azure. Если у вас нет учетной записи, можно создать [бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/) всего за несколько минут.

* Убедитесь, что в брандмауэре открыт порт 8883. В примере для устройства в этой статье используется протокол MQTT, который обменивается данными через порт 8883. В некоторых корпоративных и академических сетях этот порт может быть заблокирован. Дополнительные сведения и способы устранения этой проблемы см. в разделе о [подключении к Центру Интернета вещей по протоколу MQTT](iot-hub-mqtt-support.md#connecting-to-iot-hub).

## <a name="receive-messages-in-the-device-app"></a>Получение сообщений в приложении для устройства

В этом разделе вы измените приложение устройства, созданное при [отправке данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md) для получения сообщений из облака на устройство из центра Интернета вещей.

1. В Visual Studio в проекте **SimulatedDevice** добавьте в класс **Program** следующий метод:

   ```csharp
    private static async void ReceiveC2dAsync()
    {
        Console.WriteLine("\nReceiving cloud to device messages from service");
        while (true)
        {
            Message receivedMessage = await s_deviceClient.ReceiveAsync();
            if (receivedMessage == null) continue;

            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("Received message: {0}", 
            Encoding.ASCII.GetString(receivedMessage.GetBytes()));
            Console.ResetColor();

            await s_deviceClient.CompleteAsync(receivedMessage);
        }
    }
   ```

1. Добавьте в метод **Main** непосредственно перед строкой `Console.ReadLine()` следующий метод:

   ```csharp
   ReceiveC2dAsync();
   ```

Метод `ReceiveAsync` асинхронно возвращает полученное сообщение, когда устройство его получило. Он возвращает *значение NULL* после указанного периода ожидания. В этом примере используется значение по умолчанию, равное одной минуте. Когда приложение получит значение *NULL*, оно продолжит ожидание новых сообщений. Из-за этого требования присутствует строка `if (receivedMessage == null) continue`.

Вызов `CompleteAsync()` уведомляет Центр Интернета вещей об успешной обработке сообщения. Можно спокойно удалить сообщение из очереди устройства. Если что-то помешает приложению устройства завершить обработку сообщения, Центр Интернета вещей доставит его снова. Логика обработки сообщений в приложении устройства должна быть *идемпотентными*, поэтому получение одного и того же сообщения несколько раз приводит к одному и тому же результату.

Приложение может также временно отказаться от сообщения. Тогда Центр Интернета вещей будет хранить сообщение в очереди для последующей обработки. Или приложение может отклонить сообщение, и тогда оно будет окончательно удалено из очереди. Дополнительные сведения о жизненном цикле сообщений, передаваемых из облака на устройство, см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

   > [!NOTE]
   > При использовании HTTPS вместо MQTT или AMQP в качестве транспорта немедленно возвращается метод `ReceiveAsync`. Схема сообщений, передаваемых из облака на устройство с помощью HTTPS, может использоваться на периодически подключаемых устройствах, которые редко проверяют наличие новых сообщений (реже, чем раз в 25 минут). Если HTTPS получает много результатов, регулируются запросы в Центре Интернета вещей. Дополнительные сведения о различиях между поддержкой MQTT, AMQP и HTTPS, а также регулировании Центра Интернета вещей см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).
   >

## <a name="get-the-iot-hub-connection-string"></a>Получение строки подключения для центра Интернета вещей

В этой статье вы создадите серверную службу для отправки сообщений из облака на устройство через центр Интернета вещей, созданный при [отправке данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md). Для отправки сообщений из облака на устройство службе требуется разрешение на **Подключение к службе** . По умолчанию каждый центр Интернета вещей создается с помощью политики общего доступа с именем **Service** , предоставляющей это разрешение.

[!INCLUDE [iot-hub-include-find-service-connection-string](../../includes/iot-hub-include-find-service-connection-string.md)]

## <a name="send-a-cloud-to-device-message"></a>Отправка сообщения из облака на устройство

Теперь вы пишете консольное приложение .NET, которое отправляет сообщения из облака на устройство в приложение устройства.

1. В текущем решении Visual Studio выберите **файл** > **создать** > **проект**. В окне **Создание нового проекта**выберите **консольное приложение (.NET Framework)**, а затем нажмите кнопку **Далее**.

1. Присвойте проекту имя *SendCloudToDevice*. В разделе **решение**выберите **Добавить в решение** и примите последнюю версию .NET Framework. Выберите **Создать**, чтобы создать проект.

   ![Настройка нового проекта в Visual Studio](./media/iot-hub-csharp-csharp-c2d/sendcloudtodevice-project-configure.png)

1. В обозреватель решений щелкните новое решение правой кнопкой мыши и выберите пункт **Управление пакетами NuGet**.

1. В окне **Управление пакетами NuGet**нажмите кнопку **Обзор**, а затем найдите и выберите **Microsoft. Azure. Devices**. Нажмите кнопку **установить**.

   На этом шаге выполняется скачивание, установка и Добавление ссылки на [пакет SDK для службы Azure IOT](https://www.nuget.org/packages/Microsoft.Azure.Devices/).

1. Добавьте следующую `using` инструкцию в начало файла **Program.CS** .

   ``` csharp
   using Microsoft.Azure.Devices;
   ```

1. Добавьте следующие поля в класс **Program** . Замените значение заполнителя строкой подключения центра Интернета вещей, скопированным ранее в поле [Получение строки подключения для центра Интернета вещей](#get-the-iot-hub-connection-string).

   ``` csharp
   static ServiceClient serviceClient;
   static string connectionString = "{iot hub connection string}";
   ```

1. Добавьте следующий метод в класс **Program**. Задайте имя устройства, которое использовалось при определении устройства в поле [Отправка данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md).

   ``` csharp
   private async static Task SendCloudToDeviceMessageAsync()
   {
        var commandMessage = new
         Message(Encoding.ASCII.GetBytes("Cloud to device message."));
        await serviceClient.SendAsync("myFirstDevice", commandMessage);
   }
   ```

   Этот метод отправляет на устройство с идентификатором `myFirstDevice`новое сообщение, передаваемое из облака на устройство. Измените этот параметр только в том случае, если он был изменен с того, который использовался при [отправке данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md).

1. Наконец, добавьте следующие строки в метод **Main** .

   ``` csharp
   Console.WriteLine("Send Cloud-to-Device message\n");
   serviceClient = ServiceClient.CreateFromConnectionString(connectionString);

   Console.WriteLine("Press any key to send a C2D message.");
   Console.ReadLine();
   SendCloudToDeviceMessageAsync().Wait();
   Console.ReadLine();
   ```

1. В обозревателе решений щелкните правой кнопкой мыши решение и выберите команду **задать запускаемые проекты**.

1. В меню **стандартные свойства** > **Запуск проекта**выберите **Несколько запускаемых проектов**, а затем выберите действие при **запуске** для **ReadDeviceToCloudMessages**, **SimulatedDevice**и **SendCloudToDevice**. Нажмите кнопку **ОК** , чтобы сохранить изменения.

1. Нажмите клавишу **F5**. Должны запуститься все три приложения. Выберите окна **SendCloudToDevice** и нажмите клавишу **ВВОД**. Приложение для устройства должно получить сообщение.

   ![Приложение получает сообщение](./media/iot-hub-csharp-csharp-c2d/sendc2d1.png)

## <a name="receive-delivery-feedback"></a>Получение подтверждений доставки

Можно запросить подтверждения доставки (или истечения срока действия) из центра Интернета вещей для каждого сообщения, переданного из облака на устройство. Этот параметр позволяет серверной части решения легко передавать данные в логику повторных попыток или компенсаций. Дополнительные сведения об отзывах сообщений, передаваемых из облака на устройство, см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

В этом разделе вы измените приложение **SendCloudToDevice**, чтобы оно запрашивало подтверждение и получало его из Центра Интернета вещей.

1. В Visual Studio в проекте **SendCloudToDevice** добавьте в класс **Program** следующий метод:

   ```csharp
   private async static void ReceiveFeedbackAsync()
   {
        var feedbackReceiver = serviceClient.GetFeedbackReceiver();

        Console.WriteLine("\nReceiving c2d feedback from service");
        while (true)
        {
            var feedbackBatch = await feedbackReceiver.ReceiveAsync();
            if (feedbackBatch == null) continue;

            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("Received feedback: {0}",
              string.Join(", ", feedbackBatch.Records.Select(f => f.StatusCode)));
            Console.ResetColor();

            await feedbackReceiver.CompleteAsync(feedbackBatch);
        }
    }
    ```

    Обратите внимание, что шаблон получения здесь аналогичен шаблону, использовавшемуся для получения сообщений из облака на устройство из приложения устройства.

1. Добавьте следующую строку в метод **Main** , прямо после `serviceClient = ServiceClient.CreateFromConnectionString(connectionString)`.

   ``` csharp
   ReceiveFeedbackAsync();
   ```

1. Чтобы запросить подтверждение доставки сообщения из облака на устройство, необходимо указать свойство в методе **SendCloudToDeviceMessageAsync** . Добавьте следующую строку сразу после `var commandMessage = new Message(...);` строки.

   ``` csharp
   commandMessage.Ack = DeliveryAcknowledgement.Full;
   ```

1. Запустите приложения, нажав клавишу **F5**. Должны запуститься все три приложения. Выберите окна **SendCloudToDevice** и нажмите клавишу **ВВОД**. Приложение для устройства должно получить сообщение, а через несколько секунд ваше приложение **SendCloudToDevice** должно получить сообщение о подтверждении.

   ![Приложение получает сообщение](./media/iot-hub-csharp-csharp-c2d/sendc2d2.png)

> [!NOTE]
> Для простоты в этом руководстве не реализована политика повтора. В рабочем коде следует реализовать политики повтора, такие как экспоненциальная задержка, как предлагается при [обработке временных сбоев](/azure/architecture/best-practices/transient-faults).
>

## <a name="next-steps"></a>Дальнейшие шаги

В этом руководстве вы научились отправлять и получать сообщения из облака на устройство.

Примеры комплексных решений, в которых используется Центр Интернета вещей, см. в [документации по акселератору решения Azure IoT для удаленного мониторинга](https://docs.microsoft.com/azure/iot-suite/).

Дополнительные сведения о разработке решений с помощью Центра Интернета вещей см. в [руководстве разработчика для Центра Интернета вещей](iot-hub-devguide.md).
