---
title: Отправка сообщений из облака на устройство с помощью Центра Интернета вещей Azure (.NET) | Документация Майкрософт
description: Сведения об отправке сообщений из облака на устройство из Центра Интернета вещей Azure с помощью пакетов SDK для Интернета вещей Azure для .NET. Для получения сообщений, отправляемых из облака на устройство, следует изменить приложение для устройства, а для отправки таких сообщений — внутреннее приложение.
author: robinsh
manager: philmea
ms.service: iot-hub
services: iot-hub
ms.devlang: csharp
ms.topic: conceptual
ms.date: 04/03/2019
ms.author: robinsh
ms.openlocfilehash: 629342e44af16b6d23f9ed85f8c5306c807b8bfc
ms.sourcegitcommit: 6a42dd4b746f3e6de69f7ad0107cc7ad654e39ae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/07/2019
ms.locfileid: "67621902"
---
# <a name="send-messages-from-the-cloud-to-your-device-with-iot-hub-net"></a>Отправка сообщений из облака на устройство с помощью Центра Интернета вещей (.NET)

[!INCLUDE [iot-hub-selector-c2d](../../includes/iot-hub-selector-c2d.md)]

## <a name="introduction"></a>Общие сведения

Центр Интернета вещей Azure — это полностью управляемая служба, которая обеспечивает надежный и защищенный двунаправленный обмен данными между миллионами устройств и серверной частью решения. [Отправки данных телеметрии с устройства в центре Интернета вещей](quickstart-send-telemetry-dotnet.md) кратком руководстве показано, как создать центр Интернета вещей, подготовить в нем удостоверение устройства и написать код приложения устройства, которое отправляет сообщения с устройства в облако.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Этот учебник основан на [отправки данных телеметрии с устройства в центре Интернета вещей](quickstart-send-telemetry-dotnet.md). В нем описывается, как сделать следующее:

* Отправка сообщений, передаваемых из облака на устройство, из серверной части решения на одно устройство через Центр Интернета вещей.

* Получение на устройстве сообщений, передаваемых из облака на устройство.

* Из серверной части решения, запроса подтверждения доставки (*отзывы*) для сообщений, отправленных на устройство из центра Интернета вещей.

Дополнительные сведения о сообщениях, отправляемых из облака на устройство, см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

По завершении работы с этим руководством вы запустите два консольных приложения .NET.

* **SimulatedDevice**, измененную версию приложения, созданного в [отправки данных телеметрии с устройства в центре Интернета вещей](quickstart-send-telemetry-dotnet.md), которое подключается к центру Интернета вещей и получает сообщения из облака на устройство.

* **SendCloudToDevice**, которое отправляет сообщение из облака на устройство через Центр Интернета вещей в приложение устройства, а затем получает подтверждение его доставки.

> [!NOTE]
> В Центре Интернета вещей реализована поддержка для пакетов SDK для многих платформ устройств и языков (включая C, Java и Javascript). Эти пакеты работают на основе [пакетов SDK для устройств Azure IoT](iot-hub-devguide-sdks.md). Пошаговые инструкции по связыванию устройства с кодом из этого руководства, а также по подключению к Центру Интернета вещей Azure см. в [руководстве разработчика для Центра Интернета вещей](iot-hub-devguide.md).
>

Для работы с этим учебником требуется:

* Visual Studio

* Активная учетная запись Azure. Если ее нет, можно создать [бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/) всего за несколько минут.

## <a name="receive-messages-in-the-device-app"></a>Получение сообщений в приложении для устройства

В этом разделе вы измените приложение устройства, созданное в [отправки данных телеметрии с устройства в центре Интернета вещей](quickstart-send-telemetry-dotnet.md) для получения сообщений из облака на устройство из центра Интернета вещей.

1. В Visual Studio в проекте **SimulatedDevice** добавьте в класс **Program** следующий метод:

   ```csharp
    private static async void ReceiveC2dAsync()
    {
        Console.WriteLine("\nReceiving cloud to device messages from service");
        while (true)
        {
            Message receivedMessage = await s_deviceClient.ReceiveAsync();
            if (receivedMessage == null) continue;

            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("Received message: {0}", 
            Encoding.ASCII.GetString(receivedMessage.GetBytes()));
            Console.ResetColor();

            await s_deviceClient.CompleteAsync(receivedMessage);
        }
    }
   ```

   Метод `ReceiveAsync` асинхронно возвращает полученное сообщение, когда устройство его получило. Он возвращает значение *NULL* после истечения заданного времени ожидания (в этом примере используется значение по умолчанию, равное одной минуте). Когда приложение получит значение *NULL*, оно продолжит ожидание новых сообщений. Из-за этого требования присутствует строка `if (receivedMessage == null) continue`.

    Вызов `CompleteAsync()` уведомляет Центр Интернета вещей об успешной обработке сообщения. Можно спокойно удалить сообщение из очереди устройства. Если что-то помешает приложению устройства завершить обработку сообщения, Центр Интернета вещей доставит его снова. Поэтому важно, чтобы логика обработки сообщений в приложении устройства была *идемпотентной*. Это обеспечит одинаковый результат при многократном получении одного и того же сообщения. 

    Приложение может также временно отказаться от сообщения. Тогда Центр Интернета вещей будет хранить сообщение в очереди для последующей обработки. Или приложение может отклонить сообщение, и тогда оно будет окончательно удалено из очереди. Дополнительные сведения о жизненном цикле сообщений, передаваемых из облака на устройство, см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

   > [!NOTE]
   > При использовании HTTPS вместо MQTT или AMQP в качестве транспорта немедленно возвращается метод `ReceiveAsync`. Схема сообщений, передаваемых из облака на устройство с помощью HTTPS, может использоваться на периодически подключаемых устройствах, которые редко проверяют наличие новых сообщений (реже, чем раз в 25 минут). Если HTTPS получает много результатов, регулируются запросы в Центре Интернета вещей. Дополнительные сведения о различиях между поддержкой MQTT, AMQP и HTTPS, а также регулировании Центра Интернета вещей см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).
   >

2. Добавьте в метод **Main** непосредственно перед строкой `Console.ReadLine()` следующий метод:

   ```csharp
   ReceiveC2dAsync();
   ```

## <a name="get-the-iot-hub-connection-string"></a>Получение строки подключения центра Интернета вещей

Во-первых получите строку подключения центра Интернета вещей на портале.

1. Войдите в [портала Azure](https://portal.azure.com)выберите **групп ресурсов**.

2. Выберите группу ресурсов, которую вы используете для этого практического руководства.

3. Выберите центр Интернета вещей, которые вы используете.

4. В области для центра, выберите **политики общего доступа**.

5. Выберите **iothubowner**. Строки подключения могут быть показаны на **iothubowner** панели. Щелкните значок копирования для **строка подключения — первичный ключ**. Сохраните строку подключения для дальнейшего использования.

   ![Получение строки подключения центра Интернета вещей](./media/iot-hub-csharp-csharp-c2d/get-iot-hub-connection-string.png)

## <a name="send-a-cloud-to-device-message"></a>Отправка сообщения из облака на устройство

Теперь можно написать консольное приложение .NET, которое отправляет сообщения из облака на устройство приложение для устройства.

1. В текущем решении Visual Studio, щелкните правой кнопкой мыши решение и выберите Добавить > Новый проект. Выберите **Windows Desktop** и затем **консольное приложение (.NET Framework)** . Назовите проект **SendCloudToDevice** и выберите самую последнюю версию платформы .NET Framework, а затем **ОК** для создания проекта.

   ![Создание проекта в Visual Studio](./media/iot-hub-csharp-csharp-c2d/create-identity-csharp1.png)

2. В обозревателе решений щелкните правой кнопкой мыши решение и выберите пункт **Управление пакетами NuGet для решения...** .

   Это действие откроет окно **Управление пакетами NuGet**.

3. Поиск **Microsoft.Azure.Devices**, выберите вкладку "Обзор". Когда вы нашли пакет, нажмите кнопку **установить**и примите условия использования.

   После этого будут выполнены скачивание, установка и добавление ссылки на [пакет SDK NuGet для служб Azure IoT](https://www.nuget.org/packages/Microsoft.Azure.Devices/).

4. Добавьте следующий `using` инструкция в верхней части **Program.cs** файл.

   ``` csharp
   using Microsoft.Azure.Devices;
   ```

5. Добавьте следующие поля в класс **Program** . Замените значение заполнителя строкой подключения центра Интернета вещей, сохраненный ранее в этом разделе. 

   ``` csharp
   static ServiceClient serviceClient;
   static string connectionString = "{iot hub connection string}";
   ```

6. Добавьте следующий метод в класс **Program**. Задайте имя устройства для использования при определении устройства в [отправки данных телеметрии с устройства в центре Интернета вещей](quickstart-send-telemetry-dotnet.md).

   ``` csharp
   private async static Task SendCloudToDeviceMessageAsync()
   {
        var commandMessage = new
         Message(Encoding.ASCII.GetBytes("Cloud to device message."));
        await serviceClient.SendAsync("myDevice", commandMessage);
   }
   ```

   Этот метод отправляет на устройство с идентификатором `myFirstDevice`новое сообщение, передаваемое из облака на устройство. Измените этот параметр только в том случае, если он изменен от используемой в [отправки данных телеметрии с устройства в центре Интернета вещей](quickstart-send-telemetry-dotnet.md).

7. Наконец, добавьте следующие строки в метод **Main** .

   ``` csharp
   Console.WriteLine("Send Cloud-to-Device message\n");
   serviceClient = ServiceClient.CreateFromConnectionString(connectionString);

   Console.WriteLine("Press any key to send a C2D message.");
   Console.ReadLine();
   SendCloudToDeviceMessageAsync().Wait();
   Console.ReadLine();
   ```

8. В Visual Studio щелкните правой кнопкой мыши свое решение и выберите пункт **Назначить запускаемые проекты**. Щелкните **Несколько запускаемых проектов**, а затем выберите действие **Запуск** для **ReadDeviceToCloudMessages**, **SimulatedDevice** и **SendCloudToDevice**.

9. Нажмите клавишу **F5**. Должны запуститься все три приложения. Выберите окна **SendCloudToDevice** и нажмите клавишу **ВВОД**. Приложение для устройства должно получить сообщение.

   ![Приложение получает сообщение](./media/iot-hub-csharp-csharp-c2d/sendc2d1.png)

## <a name="receive-delivery-feedback"></a>Получение подтверждений доставки

Это возможно для запроса подтверждения доставки (или истечения срока действия) из центра Интернета вещей для каждого сообщения облака на устройство. Этот параметр позволяет серверной части решения легко передавать данные в логику повторных попыток или компенсаций. Дополнительные сведения об отзывах сообщений, передаваемых из облака на устройство, см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

В этом разделе вы измените приложение **SendCloudToDevice**, чтобы оно запрашивало подтверждение и получало его из Центра Интернета вещей.

1. В Visual Studio в проекте **SendCloudToDevice** добавьте в класс **Program** следующий метод:

   ```csharp
   private async static void ReceiveFeedbackAsync()
   {
        var feedbackReceiver = serviceClient.GetFeedbackReceiver();

        Console.WriteLine("\nReceiving c2d feedback from service");
        while (true)
        {
            var feedbackBatch = await feedbackReceiver.ReceiveAsync();
            if (feedbackBatch == null) continue;

            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("Received feedback: {0}",
              string.Join(", ", feedbackBatch.Records.Select(f => f.StatusCode)));
            Console.ResetColor();

            await feedbackReceiver.CompleteAsync(feedbackBatch);
        }
    }
    ```

    Обратите внимание, что шаблон получения здесь аналогичен шаблону, использовавшемуся для получения сообщений из облака на устройство из приложения устройства.

2. Добавьте следующий метод в **Main** метод, непосредственно после `serviceClient = ServiceClient.CreateFromConnectionString(connectionString)` строки.

   ``` csharp
   ReceiveFeedbackAsync();
   ```

3. Чтобы запросить подтверждение доставки сообщения из облака на устройство, необходимо указать свойство в методе **SendCloudToDeviceMessageAsync** . Добавьте следующую строку, сразу же после `var commandMessage = new Message(...);` строки.

   ``` csharp
   commandMessage.Ack = DeliveryAcknowledgement.Full;
   ```

4. Запустите приложения, нажав клавишу **F5**. Должны запуститься все три приложения. Выберите окна **SendCloudToDevice** и нажмите клавишу **ВВОД**. Приложение для устройства должно получить сообщение, а через несколько секунд ваше приложение **SendCloudToDevice** должно получить сообщение о подтверждении.

   ![Приложение получает сообщение](./media/iot-hub-csharp-csharp-c2d/sendc2d2.png)

> [!NOTE]
> Для простоты в этом руководстве не реализуются политики повтора. В рабочем коде следует реализовать политики повторных попыток (например, с экспоненциальной задержкой), как указано в статье [Обработка временных сбоев](/azure/architecture/best-practices/transient-faults).
>

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы научились отправлять и получать сообщения из облака на устройство.

Примеры комплексных решений, в которых используется Центр Интернета вещей, см. в [документации по акселератору решения Azure IoT для удаленного мониторинга](https://docs.microsoft.com/azure/iot-suite/).

Дополнительные сведения о разработке решений с помощью Центра Интернета вещей см. в [руководстве разработчика для Центра Интернета вещей](iot-hub-devguide.md).
