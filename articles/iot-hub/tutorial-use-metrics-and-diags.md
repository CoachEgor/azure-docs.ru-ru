---
title: Настройка и использование метрик и журналов диагностики с Центром Интернета вещей Azure
description: Узнайте, как настроить и использовать метрики и журналы диагностики с Центром Интернета вещей Azure. Это обеспечит анализ данных для диагностики проблем, которые могут возникнуть в Центре.
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: tutorial
ms.date: 3/13/2019
ms.author: robinsh
ms.custom: mvc
ms.openlocfilehash: e0094add11755ecb0c303adf874abe5a4a8f5811
ms.sourcegitcommit: 380e3c893dfeed631b4d8f5983c02f978f3188bf
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2020
ms.locfileid: "75746206"
---
# <a name="tutorial-set-up-and-use-metrics-and-diagnostic-logs-with-an-iot-hub"></a>Руководство. Настройка и использование метрик и журналов диагностики с Центром Интернета вещей

Если в рабочей среде запущено решение Центра Интернета вещей, необходимо настроить определенные метрики и включить журналы диагностики. Затем, если возникнет проблема, у вас будут данные, которые помогут быстрее диагностировать проблему и устранить ее. В этой статье вы узнаете, как включить журналы диагностики и как с их помощью выявлять наличие ошибок. Вы также настроите некоторые метрики для отслеживания и оповещения, которые срабатывают при достижении определенного порога. Например, вам может быть отправлено электронное письмо, когда количество отправленных сообщений телеметрии превышает определенную границу или когда количество сообщений приближается к ежедневной квоте сообщений, разрешенных для Центра Интернета вещей. 

Примером использования является заправочная станция, где насосы — это устройства Интернета вещей, которые отправляют сообщения в Центр Интернета вещей. Кредитные карты проверяются, и окончательная транзакция записывается в хранилище данных. Если устройства Интернета вещей перестают подключаться к Интернету вещей и отправлять сообщения, исправить это будет намного сложнее, если у вас не будет сведений о происходящем.

В этом руководстве используется пример Azure [из этой статьи](tutorial-routing.md) для отправки сообщений в Центр Интернета вещей.

Вот какие шаги выполняются в этом руководстве:

> [!div class="checklist"]
> * Создание Центра Интернета вещей, имитированного устройства и учетной записи хранения с помощью Azure CLI.  
> * Включение ведения журналов диагностики.
> * Включение метрик.
> * Настройка оповещений для этих метрик. 
> * Загрузка и запуск приложения, которое имитирует устройство Интернета вещей, отправляющее сообщения в центр. 
> * Запуск приложения до начала срабатывания оповещений. 
> * Просмотр результатов метрик и проверка журналов диагностики. 

## <a name="prerequisites"></a>предварительные требования

- Подписка Azure. Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

- Установить [Visual Studio](https://www.visualstudio.com/). 

- Рабочая учетная запись электронной почты.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

## <a name="set-up-resources"></a>Настройка ресурсов

Для этого руководства требуется Центр Интернета вещей, учетная запись хранения и имитированное устройство Интернета вещей. Эти ресурсы создаются с помощью Azure CLI или Azure PowerShell. Используйте те же группу ресурсов и расположение для всех ресурсов. Затем в конце, удалив группу ресурсов, можно удалить все данные за один шаг.

Ниже приведены необходимые шаги.

1. Создайте [группу ресурсов](../azure-resource-manager/management/overview.md). 

2. Создайте Центр Интернета вещей.

3. Создайте стандартную учетная запись хранения V1 с репликацией Standard_LRS.

4. Создайте идентификатор устройства для имитированного устройства, которое отправляет сообщения концентратору. Сохраните ключ для этапа тестирования.

### <a name="set-up-resources-using-azure-cli"></a>Настройка ресурсов с помощью Azure CLI

Скопируйте и вставьте этот сценарий в Cloud Shell. Предполагая, что вы уже вошли в систему, Cloud Shell запустит сценарий, выполняя одну строку за другой. Новые ресурсы создаются в группе ресурсов ContosoResources.

К переменным, которые должны быть глобально уникальными, добавляется `$RANDOM`. При запуске сценария и назначении переменных в конец фиксированной строки добавляется сгенерированная случайным образом числовая строка, чтобы сделать значение уникальным.

```azurecli-interactive

# This is the IOT Extension for Azure CLI.
# You only need to install this the first time.
# You need it to create the device identity. 
az extension add --name azure-cli-iot-ext

# Set the values for the resource names that don't have to be globally unique.
# The resources that have to have unique names are named in the script below
#   with a random number concatenated to the name so you can probably just
#   run this script, and it will work with no conflicts.
location=westus
resourceGroup=ContosoResources
iotDeviceName=Contoso-Test-Device 

# Create the resource group to be used
#   for all the resources for this tutorial.
az group create --name $resourceGroup \
    --location $location

# The IoT hub name must be globally unique, so add a random number to the end.
iotHubName=ContosoTestHub$RANDOM
echo "IoT hub name = " $iotHubName

# Create the IoT hub in the Free tier.
az iot hub create --name $iotHubName \
    --resource-group $resourceGroup \
    --sku F1 --location $location

# The storage account name must be globally unique, so add a random number to the end.
storageAccountName=contosostoragemon$RANDOM
echo "Storage account name = " $storageAccountName

# Create the storage account.
az storage account create --name $storageAccountName \
    --resource-group $resourceGroup \
    --location $location \
    --sku Standard_LRS

# Create the IoT device identity to be used for testing.
az iot hub device-identity create --device-id $iotDeviceName \
    --hub-name $iotHubName 

# Retrieve the information about the device identity, then copy the primary key to
#   Notepad. You need this to run the device simulation during the testing phase.
az iot hub device-identity show --device-id $iotDeviceName \
    --hub-name $iotHubName

```

>[!NOTE]
>При создании удостоверения устройства может появиться следующее сообщение об ошибке: *No keys found for policy iothubowner of IoT Hub ContosoTestHub* (Ключи для политики iothubowner Центра Интернета вещей ContosoTestHub не найдены). Чтобы устранить эту ошибку, обновите расширение Azure CLI для Интернета вещей и снова выполните две последние команды скрипта. 
>
>Ниже приведена команда для обновления расширения. Выполните ее в экземпляре Cloud Shell.
>
>```cli
>az extension update --name azure-cli-iot-ext
>```

## <a name="enable-the-diagnostic-logs"></a>Включение ведения журналов диагностики 

При создании нового центра Интернета вещей [журналы диагностики](../azure-monitor/platform/platform-logs-overview.md) отключены по умолчанию. В этом разделе включите журналы диагностики для центра.

1. Во-первых, если вы еще не перешли к центру на портале, щелкните **Группы ресурсов** и выберите группу ресурсов Contoso-Resources. Выберите центр из списка отображаемых ресурсов. 

2. Найдите раздел **Мониторинг** в колонке Центра Интернета вещей. Щелкните **Параметры диагностики**. 

   ![Снимок экрана, отображающий часть параметров диагностики в колонке Центра Интернета вещей.](./media/tutorial-use-metrics-and-diags/01-diagnostic-settings.png)


3. Убедитесь в правильности подписки и группы ресурсов. В разделе **Тип ресурса** снимите флажок **Выбрать все**, а затем найдите в списке **Центр Интернета вещей** и установите флажок напротив него. (В результате снова будет установлен флажок рядом с полем *Выбрать все*, на что можно не обращать внимания.) В разделе **Ресурс** выберите имя центра. Экран должен выглядеть следующим образом: 

   ![Снимок экрана, отображающий часть параметров диагностики в колонке Центра Интернета вещей.](./media/tutorial-use-metrics-and-diags/02-diagnostic-settings-start.png)

4. Щелкните **Включить диагностику**. Откроется панель параметров диагностики. Укажите diags-hub в качестве имени параметров журналов диагностики.

5. Установите флажок **Архивировать в учетной записи хранения**. 

   ![Снимок экрана: настройка диагностики для архивации в учетной записи хранения.](./media/tutorial-use-metrics-and-diags/03-diagnostic-settings-storage.png)

    Щелкните **Настройка**, чтобы открыть окно **Выбрать учетную запись хранения**, выберите *contosostoragemon* (справа) и нажмите кнопку **ОК**, чтобы вернуться на панель "Параметры диагностики". 

   ![Снимок экрана: настройка журналов диагностики для архивации в учетной записи хранения.](./media/tutorial-use-metrics-and-diags/04-diagnostic-settings-after-storage.png)

6. В разделе **Журнал** установите флажки напротив параметров **Подключения** и **Device Telemetry** (Телеметрия устройства) и установите для значения **Хранение (дни)** 7 дней для каждого из них. Теперь экран параметров диагностики должен выглядеть следующим образом:

   ![Снимок экрана с окончательными параметрами журнала диагностики.](./media/tutorial-use-metrics-and-diags/05-diagnostic-settings-done.png)

7. Нажмите кнопку **Сохранить** , чтобы сохранить параметры. Закройте панель параметров диагностики.

Позже, когда вы будете просматривать журналы диагностики, вы увидите зарегистрированные подключения и отключения устройства. 

## <a name="set-up-metrics"></a>Настройка метрик 

Теперь настройте некоторые метрики для отслеживания отправки сообщений в центр. 

1. В области параметров Центра Интернета вещей щелкните параметр **Метрики** в разделе **Мониторинг**.

2. В верхней части экрана щелкните **Last 24 hours (Automatic)** (Последние 24 часа (автоматически)). В открывшемся списке выберите **Last 4 hours** (Последние 4 часа) для параметра **Диапазон времени**, а для параметра **Степень детализации времени** выберите **1 минуту** и местное время. Нажмите кнопку **Применить**, чтобы сохранить эти параметры. 

   ![Снимок экрана с параметрами времени метрик.](./media/tutorial-use-metrics-and-diags/06-metrics-set-time-range.png)

3. По умолчанию существует одна запись метрики. Оставьте значения по умолчанию группы ресурсов и пространства имен метрики. В раскрывающемся списке **Метрика** выберите **Telemetry messages sent** (Число отправленных сообщений телеметрии). Для параметра **Агрегирование** задайте значение **Sum** (Сумма).

   ![Снимок экрана, показывающий добавление метрики для числа отправленных сообщений телеметрии.](./media/tutorial-use-metrics-and-diags/07-metrics-telemetry-messages-sent.png)


4. Теперь щелкните **Добавить метрику**, чтобы добавить другую метрику на диаграмму. Выберите свою группу ресурсов (**ContosoTestHub**). В разделе **Метрика** выберите **Total number of messages used** (Общее количество используемых сообщений). Для параметра **Агрегирование** выберите тип **Avg** (Среднее). 

   Теперь на экране отображается свернутая метрика для параметра *Telemetry messages sent* (Число отправленных сообщений телеметрии), а также новая метрика для параметра *Total number of messages used* (Общее количество используемых сообщений).

   ![Снимок экрана, показывающий добавление метрики для числа отправленных сообщений телеметрии.](./media/tutorial-use-metrics-and-diags/07-metrics-num-messages-used.png)

   Щелкните **Закрепить на панели мониторинга**. Метрика будет закреплена на панели мониторинга портала Azure, чтобы вы снова могли получить к ней доступ. Если вы не закрепите ее на панели мониторинга, настройки не сохранятся.

## <a name="set-up-alerts"></a>Настройка оповещений

Перейдите к центру на портале. Щелкните **Группы ресурсов**, а затем щелкните *ContosoResources* и выберите Центр Интернета вещей *ContosoTestHub*. 

Центр Интернета вещей еще не был перенесен в метрики [в Azure Monitor](/azure/azure-monitor/platform/data-collection#metrics). Необходимо использовать [классические оповещения](/azure/azure-monitor/platform/alerts-classic.overview).

1. В разделе **Мониторинг** щелкните **Оповещения**, чтобы отобразился главный экран оповещений. 

   ![Снимок экрана, отображающий, как найти классические оповещения.](./media/tutorial-use-metrics-and-diags/08-find-classic-alerts.png)

2. Чтобы перейти к классическим оповещениям отсюда, щелкните **Просмотреть классические оповещения**. 

    ![Снимок экрана классических оповещений.](./media/tutorial-use-metrics-and-diags/09-view-classic-alerts.png)

    Заполните следующие поля. 

    **Подписка**: Оставьте в этом поле текущую подписку.

    **Источник**. В этом поле укажите значение *Метрики*.

    **Группа ресурсов.** В этом поле укажите текущую группу ресурсов *ContosoResources*. 

    **Тип ресурса**. В этом поле укажите Центр Интернета вещей. 

    **Ресурс**: Выберите Центр Интернета вещей *ContosoTestHub*.

3. Щелкните **Добавить оповещение метрики (классическое)** , чтобы настроить новое оповещение.

    Заполните следующие поля.

    **Name**: Укажите имя для нового правила генерации оповещений, например *telemetry-messages*.

    **Описание**: Укажите описание оповещения, например *оповещение о том, что отправлено 1000 сообщений телеметрии*. 

    **Источник**. Задайте значение *Метрики*.

    Для параметров **Подписка**, **Группа ресурсов** и **Ресурс** следует присвоить значения, выбранные в окне **Просмотреть классические оповещения**. 

    Для параметра **Метрика** задайте значение *Telemetry messages sent* (Число отправленных сообщений телеметрии).

    ![Снимок экрана, где показана настройка классического оповещения для отправленных сообщений телеметрии.](./media/tutorial-use-metrics-and-diags/10-alerts-add-rule-telemetry-top.png)

4. Заполните следующие поля после диаграммы:

   **Условие**. Установите значение *Больше чем*.

   **Пороговое значение.** Установите значение 1000.

   **Период**. Установите значение *За последние 5 минут*.

   **Получатели уведомлений по электронной почте**. Введите свой адрес электронной почты. 

   ![Снимок экрана нижней части окна оповещений.](./media/tutorial-use-metrics-and-diags/11-alerts-add-rule-bottom.png)

   Нажмите кнопку **OК**, чтобы сохранить оповещение. 

5. Теперь настройте другое оповещение для параметра *Total number of messages used* (Общее количество используемых сообщений). Эта метрика полезна, если вы хотите отправить оповещение, когда количество используемых сообщений приближается к квоте, установленной для Центра Интернета вещей. Так вы узнаете, что центр вскоре начнет отклонять сообщения.

   На экране **Просмотреть классические оповещения** щелкните **Добавить оповещение метрики (классическое)** , а затем заполните следующие поля на панели **Добавить правило**.

   **Name**: Укажите имя для нового правила генерации оповещений, например *number-of-messages-used*.

   **Описание**: Укажите описание оповещения, например *оповещение при приближении к квоте*.

   **Источник**. В этом поле укажите значение *Метрики*.

    Для параметров **Подписка**, **Группа ресурсов** и **Ресурс** следует присвоить значения, выбранные в окне **Просмотреть классические оповещения**. 

    Для параметра **Метрика** установите значение *Total number of messages used* (Общее количество используемых сообщений).

6. Под диаграммой заполните следующие поля:

   **Условие**. Установите значение *Больше чем*.

   **Пороговое значение.** Установите значение 1000.

   **Период**. В этом поле установите значение *За последние 5 минут*. 

   **Получатели уведомлений по электронной почте**. Введите свой адрес электронной почты. 

   Нажмите кнопку **OК**, чтобы сохранить правило. 

5. Теперь вы должны увидеть два оповещения на панели классических оповещений: 

   ![Снимок экрана классических оповещений с новыми правилами генерации оповещений.](./media/tutorial-use-metrics-and-diags/12-alerts-done.png)

6. Закройте панель оповещений. 
    
    Установив эти параметры, вы получите оповещение, когда количество отправленных сообщений превысит 400, а общее количество использованных сообщений превысит значение параметра "Количество".

## <a name="run-simulated-device-app"></a>Запуск приложения имитации устройства

Ранее в разделе настройки скрипта было настроено устройство для имитации с использованием устройства IoT. В этом разделе происходит загрузка консольного приложения .NET, которое имитирует устройство, отправляющее сообщения с устройства в облако в Центре Интернета вещей.  

Загрузите решение для [имитации устройств IoT](https://github.com/Azure-Samples/azure-iot-samples-csharp/archive/master.zip). Скачается репозиторий с несколькими приложениями. Нужное решение находится в папке iot-hub/Tutorials/Routing/.

Дважды щелкните файл решения (SimulatedDevice.sln), чтобы открыть код в Visual Studio, а затем откройте файл Program.cs. Замените `{iot hub hostname}` на имя узла Центра IoT. Формат имени узла Центра IoT **{iot-hub-name}.azure-devices.net**. В этом руководстве имя узла концентратора **ContosoTestHub.azure-devices.net**. Затем замените `{device key}` ранее сохраненным ключом устройства при настройке имитированного устройства. 

   ```csharp
        static string myDeviceId = "contoso-test-device";
        static string iotHubUri = "ContosoTestHub.azure-devices.net";
        // This is the primary key for the device. This is in the portal. 
        // Find your IoT hub in the portal > IoT devices > select your device > copy the key. 
        static string deviceKey = "{your device key here}";
   ```

## <a name="run-and-test"></a>Запуск и тестирование 

Откройте файл Program.cs и измените значение `Task.Delay` с 1000 на 10, что сократит время между отправкой сообщений с 1 до 0,01 секунды. Сокращение этой задержки увеличивает количество отправленных сообщений.

```csharp
await Task.Delay(10);
```

Запустите консольное приложение. Подождите несколько минут (10–15). Сообщения, отправляемые с имитируемого устройства в центр, отображаются на экране консоли приложения.

### <a name="see-the-metrics-in-the-portal"></a>Просмотр метрик на портале

Откройте метрики на панели мониторинга. Измените значения времени на *Последние 30 минут* со степенью детализации в *1 минуту*. На диаграмме отображаются отправленные сообщения телеметрии и общее количество сообщений. Самые последние значения показаны в нижней части диаграммы.

   ![Снимок экрана с метриками.](./media/tutorial-use-metrics-and-diags/13-metrics-populated.png)

### <a name="see-the-alerts"></a>Просмотр оповещений

Вернитесь к оповещениям. Щелкните **Группа ресурсов**, выберите *ContosoResources*, а затем выберите центр *ContosoTestHub*. На странице свойств центра выберите **Оповещения**, а затем **Просмотреть классические оповещения**. 

Когда количество отправленных сообщений превысит лимит, вы начнете получать оповещения по электронной почте. Чтобы увидеть, есть ли активные оповещения, перейдите в центр и выберите **Оповещения**. Вы увидите активные оповещения, а также есть ли какие-либо предупреждения. 

   ![Снимок экрана с активированными оповещениями.](./media/tutorial-use-metrics-and-diags/14-alerts-firing.png)

Щелкните оповещение, чтобы увидеть сообщения телеметрии. Откроются результаты метрики и диаграмма с результатами. Сообщение электронной почты, отправленное для предупреждения о срабатывании оповещения, выглядит следующим образом:

   ![Снимок экрана сообщения электронной почты с активированными оповещениями.](./media/tutorial-use-metrics-and-diags/15-alert-email.png)

### <a name="see-the-diagnostic-logs"></a>Просмотр журналов диагностики

Настройте журналы диагностики для экспорта в хранилище BLOB-объектов. Перейдите в свою группу ресурсов и выберите учетную запись хранения *contosostoragemon*. Выберите "Большие двоичные объекты" и откройте контейнер *insights-logs-connections*. Детализируйте до текущей даты и выберите самый последний файл. 

   ![Снимок экрана с детализацией в контейнере хранилища для просмотра журналов диагностики.](./media/tutorial-use-metrics-and-diags/16-diagnostics-logs-list.png)

Нажмите кнопку **Скачать**, чтобы скачать файл, и откройте его. Вы увидите журналы со сведениями о том, когда устройство отключается и подключается, отправляя сообщения в центр. Рассмотрим пример:

``` json
{ 
  "time": "2018-12-17T18:11:25Z", 
  "resourceId": 
    "/SUBSCRIPTIONS/your-subscription-id/RESOURCEGROUPS/CONTOSORESOURCES/PROVIDERS/MICROSOFT.DEVICES/IOTHUBS/CONTOSOTESTHUB", 
  "operationName": "deviceConnect", 
  "category": "Connections", 
  "level": "Information", 
  "properties": 
      {"deviceId":"Contoso-Test-Device",
       "protocol":"Mqtt",
       "authType":null,
       "maskedIpAddress":"73.162.215.XXX",
       "statusCode":null
       }, 
  "location": "westus"
}
{ 
   "time": "2018-12-17T18:19:25Z", 
   "resourceId": 
     "/SUBSCRIPTIONS/your-subscription-id/RESOURCEGROUPS/CONTOSORESOURCES/PROVIDERS/MICROSOFT.DEVICES/IOTHUBS/CONTOSOTESTHUB", 
    "operationName": "deviceDisconnect", 
    "category": "Connections", 
    "level": "Error", 
    "resultType": "404104", 
    "resultDescription": "DeviceConnectionClosedRemotely", 
    "properties": 
        {"deviceId":"Contoso-Test-Device",
         "protocol":"Mqtt",
         "authType":null,
         "maskedIpAddress":"73.162.215.XXX",
         "statusCode":"404"
         }, 
    "location": "westus"
}
```

## <a name="clean-up-resources"></a>Очистка ресурсов 

Чтобы удалить все ресурсы, которые были созданы в этом руководстве, удалите группу ресурсов. При этом будут также удалены все ресурсы, содержащиеся в группе. В этом случае происходит удаление центра Интернета вещей, учетной записи хранения и самой группы ресурсов. Если вы закрепили метрики на панели мониторинга, необходимо будет удалить их вручную, щелкнув три точки в верхнем правом углу каждой метрики и выбрав **Удалить**.

Чтобы удалить группу ресурсов, используйте команду [az group delete](https://docs.microsoft.com/cli/azure/group?view=azure-cli-latest#az-group-delete).

```azurecli-interactive
az group delete --name $resourceGroup
```

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как использовать метрики и журналы диагностики, выполнив следующие задачи:

> [!div class="checklist"]
> * Создание Центра Интернета вещей, имитированного устройства и учетной записи хранения с помощью Azure CLI.  
> * Включение ведения журналов диагностики. 
> * Включение метрик.
> * Настройка оповещений для этих метрик. 
> * Загрузка и запуск приложения, которое имитирует устройство Интернета вещей, отправляющее сообщения в центр. 
> * Запуск приложения до начала срабатывания оповещений. 
> * Просмотр результатов метрик и проверка журналов диагностики. 

Перейдите к следующему руководству, чтобы узнать, как управлять состоянием устройств IoT. 

> [!div class="nextstepaction"]
> [Настройка устройств из внутренней службы](tutorial-device-twins.md)