---
title: Диагностирование отключений от Центра Интернета вещей и устранение неполадок
description: Сведения о диагностировании и устранении распространенных ошибок с подключением устройств к Центру Интернета вещей
author: jlian
manager: briz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 07/19/2018
ms.author: jlian
ms.openlocfilehash: a107689796c58b17c445e7a9cf7c6f0402ef6005
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61440154"
---
# <a name="detect-and-troubleshoot-disconnects-with-azure-iot-hub"></a>Обнаружение отключений от Центра Интернета вещей и устранение неполадок

Иногда проблемы с подключением устройств Интернета вещей трудно устранить, так как существует множество возможных точек отказа. Логика приложения на стороне устройства, физические сети, протоколы, оборудование и Центр Интернета вещей могут быть причиной проблем. В этой статье содержатся рекомендации по обнаружению и устранению неполадок, связанных с подключением устройств на стороне облака, а не на стороне устройства.

## <a name="get-alerts-and-error-logs"></a>Получение оповещений и журналов ошибок

Azure Monitor можно использовать, чтобы получать оповещения и делать записи в журналах при отключении устройства.

### <a name="turn-on-diagnostic-logs"></a>Включение журналов диагностики

Чтобы записывать в журнал события и ошибки с подключением устройства, включите диагностику для Центра Интернета вещей.

1. Войдите на [портале Azure](https://portal.azure.com).

2. Перейдите в центр Интернета вещей.

3. Выберите **Параметры диагностики**.

4. Выберите **Включить диагностику**.

5. Включите сбор данных журналов **подключений**.

6. Чтобы упростить анализ, включите параметр **Send to Log Analytics** (Отправить в Log Analytics) ([см. сведения о ценах](https://azure.microsoft.com/pricing/details/log-analytics/)). Ознакомьтесь с примером в разделе об [устранении ошибок подключения](#resolve-connectivity-errors).

   ![Рекомендуемые параметры](./media/iot-hub-troubleshoot-connectivity/diagnostic-settings-recommendation.png)

Дополнительные сведения см. в статье [Мониторинг работоспособности Центра Интернета вещей Azure и быстрая диагностика неполадок](iot-hub-monitor-resource-health.md).

### <a name="set-up-alerts-for-the-connected-devices-count-metric"></a>Настройка оповещений о метриках для _подключенных устройств_

Чтобы получать предупреждения после отключения устройства, Настройка оповещений о **подключенных устройств (Предварительная версия)** метрики.

1. Войдите на [портале Azure](https://portal.azure.com).

2. Перейдите в центр Интернета вещей.

3. Выберите **Оповещения**.

4. Выберите **новое правило генерации оповещений**.

5. Выберите **добавить условие**, затем выберите «Подключенных устройств (Предварительная версия)».

6. Завершите настройку вашей требуемые пороги и параметры предупреждений, следующие запросы.

Дополнительные сведения см. в статье [Что такое классические оповещения в Microsoft Azure?](../azure-monitor/platform/alerts-overview.md)

## <a name="resolve-connectivity-errors"></a>Устранение ошибок подключения

Если вы включите журналы диагностики и оповещения для подключенных устройств, то при возникновении ошибок будете получать предупреждения. В этом разделе описано, как устранить распространенные проблемы, когда вы получите предупреждение. Ниже предполагается, что вы настроили журналы Azure Monitor для журналов диагностики.

1. Перейдите в рабочую область для **Log Analytics** на портале Azure.

2. Выберите **Поиск по журналам**.

3. Чтобы изолировать журналы ошибок подключения для Центра Интернета вещей, введите следующий запрос, а затем выберите **Запустить**:

    ```
    search *
    | where ( Type == "AzureDiagnostics" and ResourceType == "IOTHUBS")
    | where ( Category == "Connections" and Level == "Error")
    ```

1. В результатах (если они будут) найдите `OperationName`, `ResultType` (код ошибки) и `ResultDescription` (сообщение об ошибке), чтобы получить более подробную информацию об ошибке.

   ![Пример журнала ошибок](./media/iot-hub-troubleshoot-connectivity/diag-logs.png)

2. Сведения в этой таблице помогут вам понять и устранить распространенные ошибки.

    | Ошибка | Первопричина | Способы устранения: |
    |-------|------------|------------|
    | 404104 DeviceConnectionClosedRemotely | Подключение было закрыто устройством, но Центру Интернета вещей причина неизвестна. Общие причины: истекло время ожидания протоколов MQTT и AMQP, а также потеря сетевых подключений. | Убедитесь, что устройство может подключиться к Центру Интернета вещей с помощью [проверки подключения](tutorial-connectivity.md). Если с подключением все в порядке, но устройство время от времени отключается, убедитесь, что вы используете правильную логику поддержания подключения устройства для выбранного протокола (MQTT/AMPQ). |
    | 401003 IoTHubUnauthorized | Центру Интернета вещей не удалось выполнить проверку подлинности подключения. | Убедитесь, что срок действия SAS или другого используемого маркера безопасности не истек. [Пакеты SDK для Azure IoT](iot-hub-devguide-sdks.md) автоматически создают маркеры без специальной настройки. |
    | 409002 LinkCreationConflict | У устройства есть несколько подключений. Когда для устройства появляется новый запрос на подключение, Центр Интернета вещей закрывает предыдущее с этой ошибкой. | В большинстве случаев устройство обнаруживает отключение устройства и пытается восстановить подключение, но Центр Интернета вещей по-прежнему считает, что устройство подключено. Центр Интернета вещей закрывает предыдущее подключение и записывает эту ошибку. Эта ошибка обычно возникает как побочный эффект другой временной проблемы, поэтому рекомендуем проверять журналы на наличие других ошибок для более эффективного устранения неполадок. В противном случае выполняйте новый запрос на подключение только при разрыве подключения. |
    | 500001 ServerError | В Центре Интернета вещей возникла ошибка на стороне сервера. Скорее всего, эта ошибка временная. Команда по работе с Центром Интернета вещей прикладывает все усилия, чтобы выполнять гарантии [Соглашения об уровне обслуживания](https://azure.microsoft.com/support/legal/sla/iot-hub/), но в работе небольших подмножеств узлов Центра Интернета вещей иногда могут возникать сбои. Если устройство пытается подключиться к узлу со сбоем, возникает эта ошибка. | Чтобы устранить временную ошибку, повторно выполните попытку подключения с устройства. Чтобы [автоматически управлять повторами](iot-hub-reliability-features-in-sdks.md#connection-and-retry), используйте последнюю версию [пакетов SDK для Azure IoT](iot-hub-devguide-sdks.md).<br><br>Рекомендации по исправлению временных ошибок и повторном подключении см. в [этой статье](/azure/architecture/best-practices/transient-faults).  <br><br>Если проблема повторится после повторного подключения, проверьте параметр [Работоспособность ресурсов](iot-hub-monitor-resource-health.md#use-azure-resource-health) и [Состояние Azure](https://azure.microsoft.com/status/history/), чтобы узнать, нет ли известной проблемы в работе Центра Интернета вещей. Если такой проблемы нет, но ошибка не устранена, [обратитесь в службу поддержки](https://azure.microsoft.com/support/options/) для дальнейшего исследования. |
    | 500008 GenericTimeout | Центру Интернета вещей не удалось завершить запрос на подключение до истечения времени ожидания. Подобно 500001 ServerError, эта ошибка, скорее всего, временная. | Выполните инструкции по устранению неполадок для ошибки 500001 ServerError, чтобы определить первопричину и устранить эту ошибку.|

## <a name="other-steps-to-try"></a>Дополнительные шаги

Если предыдущие действия не помогли, попробуйте сделать следующее:

* Если у вас есть доступ к проблемным устройствам физически или удаленно (например, через SSH), выполните инструкции в [руководстве по устранению неполадок на стороне устройства](https://github.com/Azure/azure-iot-sdk-node/wiki/Troubleshooting-Guide-Devices), чтобы устранить неполадки.

* Убедитесь, что ваши устройства **включены**. На портале Azure выберите "Центр Интернета вещей > Устройства IoT".

* Получите помощь на форуме [Центра Интернета вещей Azure](https://social.msdn.microsoft.com/Forums/azure/home?forum=azureiothub), [Stack Overflow](https://stackoverflow.com/questions/tagged/azure-iot-hub) или от [службы поддержки Azure](https://azure.microsoft.com/support/options/).

Чтобы помочь улучшить документацию, оставьте комментарий в разделе отзывов, если сведения в этом руководстве не были полезны.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения об устранении временных проблем см. в статье [Обработка временных сбоев](/azure/architecture/best-practices/transient-faults).

* Дополнительные сведения о пакете SDK для Интернета вещей Azure и об управлении механизмами повторов см. в разделе [Управление подключениями и надежный обмен сообщениями](iot-hub-reliability-features-in-sdks.md#connection-and-retry).
