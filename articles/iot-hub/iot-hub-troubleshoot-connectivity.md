---
title: Монитор и устранение неполадок отключается от концентратора Azure IoT
description: Научитесь отслеживать и улаживать распространенные ошибки с подключением к устройству для концентратора Azure IoT
author: jlian
manager: briz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 01/30/2020
ms.author: jlian
ms.openlocfilehash: bed6736fda0c1815964f9017adb1e6fffa9335d9
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77110673"
---
# <a name="monitor-diagnose-and-troubleshoot-disconnects-with-azure-iot-hub"></a>Монитор, диагностика и устранение неполадок отключаются от концентратора Azure IoT

Иногда проблемы с подключением устройств Интернета вещей трудно устранить, так как существует множество возможных точек отказа. Логика приложений, физические сети, протоколы, аппаратное обеспечение, Концентратор IoT и другие облачные службы могут вызвать проблемы. Способность обнаруживать и выявлять источник проблемы имеет решающее значение. Тем не менее, решение IoT в масштабе может иметь тысячи устройств, поэтому нецелесообразно проверять отдельные устройства вручную. Чтобы помочь выявить, диагностировать и устранить эти проблемы в масштабе, используйте возможности мониторинга, которые IoT Hub предоставляет через Azure Monitor. Эти возможности ограничены тем, что ioT Концентратор может наблюдать, поэтому мы также рекомендуем вам следовать рекомендациям мониторинга для ваших устройств и других служб Azure.

## <a name="get-alerts-and-error-logs"></a>Получение оповещений и журналов ошибок

Используйте Azure Monitor для получения оповещений и записи журналов при отключении устройств.

### <a name="turn-on-diagnostic-logs"></a>Включение журналов диагностики

Чтобы записывать в журнал события и ошибки с подключением устройства, включите диагностику для Центра Интернета вещей. Мы рекомендуем включить эти журналы как можно раньше, потому что если диагностические журналы не включены, когда происходит отключение устройства, у вас не будет никакой информации для устранения неполадок.

1. Войдите на [портал Azure](https://portal.azure.com).

2. Перейдите в центр Интернета вещей.

3. Выберите **Параметры диагностики**.

4. Выберите **Включить диагностику**.

5. Включите сбор данных журналов **подключений**.

6. Чтобы упростить анализ, включите параметр **Send to Log Analytics** (Отправить в Log Analytics) ([см. сведения о ценах](https://azure.microsoft.com/pricing/details/log-analytics/)). Ознакомьтесь с примером в разделе об [устранении ошибок подключения](#resolve-connectivity-errors).

   ![Рекомендуемые параметры](./media/iot-hub-troubleshoot-connectivity/diagnostic-settings-recommendation.png)

Дополнительные сведения см. в статье [Мониторинг работоспособности Центра Интернета вещей Azure и быстрая диагностика неполадок](iot-hub-monitor-resource-health.md).

### <a name="set-up-alerts-for-device-disconnect-at-scale"></a>Настройка оповещений для отключения устройства в масштабе

Чтобы получать оповещения при отключении устройств, назначайте оповещения на метметрии **подключенных устройств (предварительный просмотр).**

1. Войдите на [портал Azure](https://portal.azure.com).

2. Перейдите в центр Интернета вещей.

3. Выберите **оповещения**.

4. Выберите **Новое правило генерации оповещений**.

5. Выберите **Условие добавления,** затем выберите "Подключенные устройства (предварительный просмотр)".

6. Настройка порога и оповещения, следуя запросам.

Чтобы узнать больше, смотрите [Что такое оповещения в Microsoft Azure?.](../azure-monitor/platform/alerts-overview.md)

#### <a name="detecting-individual-device-disconnects"></a>Обнаружение отдельных отключений устройства

Чтобы обнаружить разъединение *на устройстве,* например, когда вам нужно знать, что фабрика просто перешла в автономный режим, [настроить события отключения устройства с помощью Event Grid.](iot-hub-event-grid.md)

## <a name="resolve-connectivity-errors"></a>Устранение ошибок подключения

Если вы включите журналы диагностики и оповещения для подключенных устройств, то при возникновении ошибок будете получать предупреждения. В этом разделе описывается, как искать общие проблемы при получении оповещения. Ниже приведены приведенные ниже шаги предполагают, что вы настроили журналы Azure Monitor для диагностических журналов.

1. Войдите на [портал Azure](https://portal.azure.com).

1. Перейдите в центр Интернета вещей.

1. Выберите **Журналы**.

1. Чтобы изолировать журналы ошибок подключения для Центра Интернета вещей, введите следующий запрос, а затем выберите **Запустить**:

    ```kusto
    AzureDiagnostics
    | where ( ResourceType == "IOTHUBS" and Category == "Connections" and Level == "Error")
    ```

1. В результатах (если они будут) найдите `OperationName`, `ResultType` (код ошибки) и `ResultDescription` (сообщение об ошибке), чтобы получить более подробную информацию об ошибке.

   ![Пример журнала ошибок](./media/iot-hub-troubleshoot-connectivity/diag-logs.png)

1. Следуйте руководствам по решению проблем для наиболее распространенных ошибок:

    - **[404104 DeviceConnectionClosedRemotely](iot-hub-troubleshoot-error-404104-deviceconnectionclosedremotely.md)**
    - **[401003 IoTHubUnauthorized](iot-hub-troubleshoot-error-401003-iothubunauthorized.md)**
    - **[409002 LinkCreationConflict](iot-hub-troubleshoot-error-409002-linkcreationconflict.md)**
    - **[500001 ServerError](iot-hub-troubleshoot-error-500xxx-internal-errors.md)**
    - **[500008 GenericTimeout](iot-hub-troubleshoot-error-500xxx-internal-errors.md)**

## <a name="i-tried-the-steps-but-they-didnt-work"></a>Я попробовал шаги, но они не работали

Если предыдущие шаги не помогли, попробуйте:

* Если у вас есть доступ к проблемным устройствам физически или удаленно (например, через SSH), выполните инструкции в [руководстве по устранению неполадок на стороне устройства](https://github.com/Azure/azure-iot-sdk-node/wiki/Troubleshooting-Guide-Devices), чтобы устранить неполадки.

* Убедитесь, что ваши устройства **включены**. На портале Azure выберите "Центр Интернета вещей > Устройства IoT".

* Если устройство использует протокол МЗТТ, убедитесь, что порт 8883 открыт. Для получения дополнительной [информации см. Подключение к концентратору IoT (МЗТТ)](iot-hub-mqtt-support.md#connecting-to-iot-hub).

* Получите помощь на форуме [Центра Интернета вещей Azure](https://social.msdn.microsoft.com/Forums/azure/home?forum=azureiothub), [Stack Overflow](https://stackoverflow.com/questions/tagged/azure-iot-hub) или от [службы поддержки Azure](https://azure.microsoft.com/support/options/).

Чтобы помочь улучшить документацию, оставьте комментарий в разделе отзывов, если сведения в этом руководстве не были полезны.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения об устранении временных проблем см. в статье [Обработка временных сбоев](/azure/architecture/best-practices/transient-faults).

* Дополнительные сведения о пакете SDK для Интернета вещей Azure и об управлении механизмами повторов см. в разделе [Управление подключениями и надежный обмен сообщениями](iot-hub-reliability-features-in-sdks.md#connection-and-retry).
