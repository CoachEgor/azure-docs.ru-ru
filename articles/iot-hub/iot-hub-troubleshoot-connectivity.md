---
title: Мониторинг и устранение неполадок при отсоединении с центром Интернета вещей Azure
description: Узнайте, как отслеживать и устранять распространенные ошибки, связанные с подключением устройств для центра Интернета вещей Azure.
author: jlian
manager: briz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 01/30/2020
ms.author: jlian
ms.openlocfilehash: bed6736fda0c1815964f9017adb1e6fffa9335d9
ms.sourcegitcommit: 9add86fb5cc19edf0b8cd2f42aeea5772511810c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/09/2020
ms.locfileid: "77110673"
---
# <a name="monitor-diagnose-and-troubleshoot-disconnects-with-azure-iot-hub"></a>Мониторинг, диагностика и устранение неполадок при отсоединении с центром Интернета вещей Azure

Иногда проблемы с подключением устройств Интернета вещей трудно устранить, так как существует множество возможных точек отказа. Логика приложения, физические сети, протоколы, оборудование, центр Интернета вещей и другие облачные службы могут вызывать проблемы. Возможность обнаружения и выявления источника проблемы очень важна. Однако решение Интернета вещей в масштабе может иметь тысячи устройств, поэтому проверка отдельных устройств вручную нецелесообразна. Чтобы помочь в обнаружении, диагностике и устранении этих проблем в масштабе, используйте возможности мониторинга центра Интернета вещей с помощью Azure Monitor. Эти возможности ограничены тем, что может наблюдать центр Интернета вещей, поэтому мы также рекомендуем следовать рекомендациям по мониторингу для устройств и других служб Azure.

## <a name="get-alerts-and-error-logs"></a>Получение оповещений и журналов ошибок

Используйте Azure Monitor, чтобы получать оповещения и записывать журналы при отключении устройств.

### <a name="turn-on-diagnostic-logs"></a>Включение журналов диагностики

Чтобы записывать в журнал события и ошибки с подключением устройства, включите диагностику для Центра Интернета вещей. Рекомендуется включить эти журналы как можно раньше, так как если журналы диагностики не включены, при отключении устройств у вас не будет сведений для устранения проблемы.

1. Войдите на [портал Azure](https://portal.azure.com).

2. Перейдите в центр Интернета вещей.

3. Выберите **Параметры диагностики**.

4. Выберите **Включить диагностику**.

5. Включите сбор данных журналов **подключений**.

6. Чтобы упростить анализ, включите параметр **Send to Log Analytics** (Отправить в Log Analytics) ([см. сведения о ценах](https://azure.microsoft.com/pricing/details/log-analytics/)). Ознакомьтесь с примером в разделе об [устранении ошибок подключения](#resolve-connectivity-errors).

   ![Рекомендуемые параметры](./media/iot-hub-troubleshoot-connectivity/diagnostic-settings-recommendation.png)

Дополнительные сведения см. в статье [Мониторинг работоспособности Центра Интернета вещей Azure и быстрая диагностика неполадок](iot-hub-monitor-resource-health.md).

### <a name="set-up-alerts-for-device-disconnect-at-scale"></a>Настройка оповещений для отключения устройства в масштабе

Чтобы получать оповещения при отключении устройств, настройте оповещения для метрики **подключенных устройств (Предварительная версия)** .

1. Войдите на [портал Azure](https://portal.azure.com).

2. Перейдите в центр Интернета вещей.

3. Выберите **Оповещения**.

4. Выберите **новое правило генерации оповещений**.

5. Щелкните **Добавить условие**, а затем выберите "подключенные устройства (Предварительная версия)".

6. Настройте порог и предупреждения, выполнив следующие подсказки.

Дополнительные сведения см. [в разделе что такое оповещения в Microsoft Azure?](../azure-monitor/platform/alerts-overview.md).

#### <a name="detecting-individual-device-disconnects"></a>Обнаружение отдельных отключений устройств

Для обнаружения отключений *для каждого устройства* , например, когда необходимо знать, что фабрика была переведена в режим «вне сети», [Настройте события отключения устройства с помощью сетки событий](iot-hub-event-grid.md).

## <a name="resolve-connectivity-errors"></a>Устранение ошибок подключения

Если вы включите журналы диагностики и оповещения для подключенных устройств, то при возникновении ошибок будете получать предупреждения. В этом разделе описывается, как найти распространенные проблемы при получении предупреждения. В описанных ниже действиях предполагается, что вы настроили журналы диагностики Azure Monitor.

1. Войдите на [портал Azure](https://portal.azure.com).

1. Перейдите в центр Интернета вещей.

1. Выберите **Журналы**.

1. Чтобы изолировать журналы ошибок подключения для Центра Интернета вещей, введите следующий запрос, а затем выберите **Запустить**:

    ```kusto
    AzureDiagnostics
    | where ( ResourceType == "IOTHUBS" and Category == "Connections" and Level == "Error")
    ```

1. В результатах (если они будут) найдите `OperationName`, `ResultType` (код ошибки) и `ResultDescription` (сообщение об ошибке), чтобы получить более подробную информацию об ошибке.

   ![Пример журнала ошибок](./media/iot-hub-troubleshoot-connectivity/diag-logs.png)

1. Для наиболее распространенных ошибок следуйте руководствам по устранению проблем.

    - **[404104 Девицеконнектионклоседремотели](iot-hub-troubleshoot-error-404104-deviceconnectionclosedremotely.md)**
    - **[401003 Иосубунаусоризед](iot-hub-troubleshoot-error-401003-iothubunauthorized.md)**
    - **[409002 Линккреатионконфликт](iot-hub-troubleshoot-error-409002-linkcreationconflict.md)**
    - **[500001 ServerError](iot-hub-troubleshoot-error-500xxx-internal-errors.md)**
    - **[500008 Женериктимеаут](iot-hub-troubleshoot-error-500xxx-internal-errors.md)**

## <a name="i-tried-the-steps-but-they-didnt-work"></a>Я выполнил шаги, но они не работали

Если предыдущие шаги не помогают, попробуйте:

* Если у вас есть доступ к проблемным устройствам физически или удаленно (например, через SSH), выполните инструкции в [руководстве по устранению неполадок на стороне устройства](https://github.com/Azure/azure-iot-sdk-node/wiki/Troubleshooting-Guide-Devices), чтобы устранить неполадки.

* Убедитесь, что ваши устройства **включены**. На портале Azure выберите "Центр Интернета вещей > Устройства IoT".

* Если устройство использует протокол MQTT, убедитесь, что порт 8883 открыт. Дополнительные сведения см. [в статье подключение к центру Интернета вещей (MQTT)](iot-hub-mqtt-support.md#connecting-to-iot-hub).

* Получите помощь на форуме [Центра Интернета вещей Azure](https://social.msdn.microsoft.com/Forums/azure/home?forum=azureiothub), [Stack Overflow](https://stackoverflow.com/questions/tagged/azure-iot-hub) или от [службы поддержки Azure](https://azure.microsoft.com/support/options/).

Чтобы помочь улучшить документацию, оставьте комментарий в разделе отзывов, если сведения в этом руководстве не были полезны.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения об устранении временных проблем см. в статье [Обработка временных сбоев](/azure/architecture/best-practices/transient-faults).

* Дополнительные сведения о пакете SDK для Интернета вещей Azure и об управлении механизмами повторов см. в разделе [Управление подключениями и надежный обмен сообщениями](iot-hub-reliability-features-in-sdks.md#connection-and-retry).
