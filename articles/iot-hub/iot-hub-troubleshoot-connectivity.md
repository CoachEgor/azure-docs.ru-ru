---
title: Мониторинг отключений от Центра Интернета вещей и устранение неполадок
description: Сведения о мониторинге и устранении распространенных ошибок с подключением устройств к Центру Интернета вещей
author: jlian
manager: briz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 01/30/2020
ms.author: jlian
ms.custom:
- mqtt
- 'Role: Cloud Development'
- 'Role: IoT Device'
- 'Role: Technical Support'
ms.openlocfilehash: b194812ef68820a0c310d0bac3b055360c5b5e4a
ms.sourcegitcommit: d767156543e16e816fc8a0c3777f033d649ffd3c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/26/2020
ms.locfileid: "92538431"
---
# <a name="monitor-diagnose-and-troubleshoot-disconnects-with-azure-iot-hub"></a>Мониторинг, диагностика отключений от Центра Интернета вещей и устранение неполадок

Иногда проблемы с подключением устройств Интернета вещей трудно устранить, так как существует множество возможных точек отказа. Логика приложения, физические сети, протоколы, оборудование, Центр Интернета и другие облачные службы вещей могут быть причиной проблем. Очень важно иметь возможность обнаруживать и выявлять источники проблем. Однако крупномасштабное решение Интернета вещей может включать тысячи устройств, поэтому проверка отдельных устройств вручную нецелесообразна. Чтобы помочь в обнаружении, диагностике и устранении этих проблем в большом масштабе, используйте возможности мониторинга Центра Интернета вещей с помощью Azure Monitor. Эти возможности ограничены тем, что может отслеживать Центр Интернета вещей, поэтому мы также рекомендуем следовать рекомендациям по мониторингу для устройств и других служб Azure.

## <a name="get-alerts-and-error-logs"></a>Получение оповещений и журналов ошибок

Azure Monitor можно использовать, чтобы получать оповещения и делать записи в журналах при отключении устройства.

### <a name="turn-on-logs"></a>Включение журналов

Чтобы регистрировать события и ошибки подключения устройства, создайте параметр диагностики для [журналов ресурсов подключений центра Интернета вещей](monitor-iot-hub-reference.md#connections). Рекомендуется создавать этот параметр как можно раньше, поскольку эти журналы не собираются по умолчанию, и без них никакие сведения для устранения неполадок при отсоединении устройств будут отсутствовать.

1. Войдите на [портал Azure](https://portal.azure.com).

1. Перейдите в центр Интернета вещей.

1. Выберите **Параметры диагностики** .

1. Выберите **Добавить параметр диагностики** .

1. Выберите журналы **подключений** .

1. Для упрощения анализа выберите **отправить на log Analytics** ( [см. цены](https://azure.microsoft.com/pricing/details/log-analytics/)). Ознакомьтесь с примером в разделе об [устранении ошибок подключения](#resolve-connectivity-errors).

   ![Рекомендуемые параметры](./media/iot-hub-troubleshoot-connectivity/diagnostic-settings-recommendation.png)

Дополнительные сведения см. в разделе [мониторинг центра Интернета вещей](monitor-iot-hub.md).

### <a name="set-up-alerts-for-device-disconnect-at-scale"></a>Настройка оповещений об отключении устройств в масштабном развертывании

Чтобы получать оповещения об отключениях устройств, настройте оповещения для метрики **Подключенные устройства (предварительная версия)** .

1. Войдите на [портал Azure](https://portal.azure.com).

2. Перейдите в центр Интернета вещей.

3. Выберите **Оповещения** .

4. Выберите **Новое правило генерации оповещений** .

5. Выберите **Добавить условие** , а затем выберите "Подключенные устройства (предварительная версия)".

6. Настройте порог и оповещение с помощью последующих запросов.

Дополнительные сведения см. в статье [Что такое оповещения в Microsoft Azure?](../azure-monitor/platform/alerts-overview.md)

#### <a name="detecting-individual-device-disconnects"></a>Обнаружение отключений отдельных устройств

Для обнаружения отключения *отдельных устройств* , например, когда требуется знать, когда отключается фабрика, [настройте события отключения устройств с помощью Сетки событий Azure](iot-hub-event-grid.md).

## <a name="resolve-connectivity-errors"></a>Устранение ошибок подключения

При включении журналов и оповещений для подключенных устройств вы получаете оповещения при возникновении ошибок. В этом разделе описано, как определить распространенные проблемы, когда вы получите предупреждение. В описанных ниже действиях предполагается, что вы уже создали параметр диагностики для отправки журналов подключений центра Интернета вещей в рабочую область Log Analytics.

1. Войдите на [портал Azure](https://portal.azure.com).

1. Перейдите в центр Интернета вещей.

1. Выберите **Журналы** .

1. Чтобы изолировать журналы ошибок подключения для Центра Интернета вещей, введите следующий запрос, а затем выберите **Запустить** :

    ```kusto
    AzureDiagnostics
    | where ( ResourceType == "IOTHUBS" and Category == "Connections" and Level == "Error")
    ```

1. В результатах (если они будут) найдите `OperationName`, `ResultType` (код ошибки) и `ResultDescription` (сообщение об ошибке), чтобы получить более подробную информацию об ошибке.

   ![Пример журнала ошибок](./media/iot-hub-troubleshoot-connectivity/diag-logs.png)

1. Сведения об устранении наиболее распространенных ошибок см. следующих руководствах:

    - **[404104 DeviceConnectionClosedRemotely](iot-hub-troubleshoot-error-404104-deviceconnectionclosedremotely.md)**
    - **[401003 IoTHubUnauthorized](iot-hub-troubleshoot-error-401003-iothubunauthorized.md)**
    - **[409002 LinkCreationConflict](iot-hub-troubleshoot-error-409002-linkcreationconflict.md)**
    - **[500001 ServerError](iot-hub-troubleshoot-error-500xxx-internal-errors.md)**
    - **[500008 GenericTimeout](iot-hub-troubleshoot-error-500xxx-internal-errors.md)**

## <a name="i-tried-the-steps-but-they-didnt-work"></a>Предложенные шаги не помогли устранить проблему

Если предыдущие действия не помогли, попробуйте следующее.

* Если у вас есть доступ к проблемным устройствам физически или удаленно (например, через SSH), выполните инструкции в [руководстве по устранению неполадок на стороне устройства](https://github.com/Azure/azure-iot-sdk-node/wiki/Troubleshooting-Guide-Devices), чтобы устранить неполадки.

* Убедитесь, что ваши устройства **включены** . На портале Azure выберите "Центр Интернета вещей > Устройства IoT".

* Если устройство использует протокол MQTT, убедитесь, что порт 8883 открыт. Дополнительные сведения см. в разделе [Подключение к Центру Интернета вещей (MQTT)](iot-hub-mqtt-support.md#connecting-to-iot-hub).

* Получите помощь на [странице Майкрософт с вопросами и ответами о Центре Интернета вещей](/answers/topics/azure-iot-hub.html), в [Stack Overflow](https://stackoverflow.com/questions/tagged/azure-iot-hub) или в [службе поддержки Azure](https://azure.microsoft.com/support/options/).

Чтобы помочь улучшить документацию, оставьте комментарий в разделе отзывов, если сведения в этом руководстве не были полезны.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения об устранении временных проблем см. в статье [Обработка временных сбоев](/azure/architecture/best-practices/transient-faults).

* Дополнительные сведения о пакете SDK для Интернета вещей Azure и об управлении механизмами повторов см. в разделе [Управление подключениями и надежный обмен сообщениями](iot-hub-reliability-features-in-sdks.md#connection-and-retry).