---
title: Удаленный мониторинг и отправка уведомлений в Центре Интернета вещей с помощью Azure Logic Apps | Документация Майкрософт
description: Azure Logic Apps можно использовать для мониторинга температуры в Центре Интернета вещей и автоматической отправки уведомлений на электронную почту в случае обнаружения аномалий.
author: robinsh
keywords: мониторинг Центра Интернета вещей, уведомления Центра Интернета вещей, мониторинг температуры в Центре Интернета вещей
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.tgt_pltfrm: arduino
ms.date: 07/18/2019
ms.author: robinsh
ms.openlocfilehash: 2720f9acfa308294b30f9203ba80e3f9b426e1e9
ms.sourcegitcommit: acb82fc770128234f2e9222939826e3ade3a2a28
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81680725"
---
# <a name="iot-remote-monitoring-and-notifications-with-azure-logic-apps-connecting-your-iot-hub-and-mailbox"></a>Удаленный мониторинг и отправка уведомлений в Центре Интернета вещей с помощью службы Azure Logic Apps, обеспечивающей подключение между Центром Интернета вещей и почтовым ящиком

![Комплексная схема](media/iot-hub-monitoring-notifications-with-azure-logic-apps/iot-hub-e2e-logic-apps.png)

[!INCLUDE [iot-hub-get-started-note](../../includes/iot-hub-get-started-note.md)]

[Приложения Azure Logic Apps](https://docs.microsoft.com/azure/logic-apps/) могут помочь вам организовать рабочие процессы в новых и облачных службах, одном или нескольких предприятиях, а также в различных протоколах. Приложение логики начинается с триггера, за которым затем следует одно или несколько действий, которые могут быть секвенированы с помощью встроенных элементов управления, таких как условия и итераторы. Такая гибкость делает Logic Apps идеальным ioT-решением для сценариев мониторинга IoT. Например, прибытие телеметрических данных с устройства в конечную точку IoT Hub может инициировать рабочие процессы логических приложений для хранения данных в blob хранилища Azure, отправлять оповещения по электронной почте, предупреждать об аномалиях данных, планировать посещение специалиста, если устройство сообщает о сбое, и так далее.

## <a name="what-you-learn"></a>Что вы узнаете

Вы научитесь создавать приложение логики, обеспечивающее подключение между Центром Интернета вещей и почтовым ящиком для мониторинга температуры и отправки уведомлений.

Клиентский код, работающий на устройстве, устанавливает свойство приложения, на каждом телеметрическом сообщении, `temperatureAlert`которое оно отправляет в ваш концентратор IoT. Когда код клиента обнаруживает температуру выше 30 C, `true`он устанавливает это свойство; в противном случае, `false`он устанавливает свойство .

Сообщения, поступающие в ваш концентратор IoT, похожи на следующие, `temperatureAlert` с данными телеметрии, содержащимися в теле и свойстве, содержащемся в свойствах приложения (свойства системы не отображаются):

```json
{
  "body": {
    "messageId": 18,
    "deviceId": "Raspberry Pi Web Client",
    "temperature": 27.796111770668457,
    "humidity": 66.77637926438427
  },
  "applicationProperties": {
    "temperatureAlert": "false"
  }
}
```

Чтобы узнать больше о формате сообщений IoT Hub, смотрите [Создать и прочитать сообщения IoT концентратора](iot-hub-devguide-messages-construct.md).

В этой теме вы настраиваете на концентратор IoT для отправки сообщений, в которых `temperatureAlert` свойство находится `true` в конечную точку Service Bus. Затем вы настраиваете логическое приложение, которое запускает сообщения, поступающие в конечную точку Service Bus, и отправляет вам уведомление по электронной почте.

## <a name="what-you-do"></a>Что нужно сделать

* Создайте пространство имен sasи и добавьте в него очередь Service Bus.
* Добавьте пользовательскую конечную точку и правило маршрутизации в концентратор IoT для направления сообщений, содержащих температурное оповещение, в очередь Service Bus.
* Создайте, настройте и протестируйте логическое приложение для потребления сообщений из очереди Service Bus и отправки сообщений уведомлений нужному получателю.

## <a name="what-you-need"></a>Необходимые элементы

* Завершите [учебник онлайн симулятор Raspberry Pi](iot-hub-raspberry-pi-web-simulator-get-started.md) или один из учебников по устройству; например, [Raspberry Pi с node.js](iot-hub-raspberry-pi-kit-node-get-started.md). Они охватывают следующие требования:

  * Активная подписка Azure.
  * Центр Интернета вещей Azure в подписке;
  * Клиентское приложение, работающее на вашем устройстве, которое отправляет телеметрические сообщения в концентратор Azure IoT.

## <a name="create-service-bus-namespace-and-queue"></a>Создание пространства имен сервисного автобуса и очереди

Создайте пространство имен и очередь служебной шины. Позже в этой теме в вашем концентраторе IoT создается правило направления, чтобы направлять сообщения, содержащие температурное оповещение в очередь Service Bus, где они будут подхвачены логическим приложением и запускают его для отправки уведомления.

### <a name="create-a-service-bus-namespace"></a>Создание пространства имен служебной шины

1. На [портале Azure](https://portal.azure.com/)выберите **и создайте ресурсный** > **интеграционный** > **сервис Bus**.

1. На панели **пространства имен Создать** предоставьте следующую информацию:

   **Имя**: Название пространства имен автобуса обслуживания. Пространство имен должно быть уникальным в Azure.

   **Уровень ценообразования**: Выберите **Базовый** из списка выпадающих. Базового уровня для данного учебника достаточно.

   **Группа ресурсов**: Используйте ту же группу ресурсов, что и концентратор IoT.

   **Расположение**. Выберите то же расположение, которое используется для Центра Интернета вещей.

   ![Создание пространства имен служебной шины с помощью портала Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/1-create-service-bus-namespace-azure-portal.png)

1. Нажмите кнопку **создания**. Подождите, пока развертывание будет завершено, прежде чем перейти к следующему шагу.

### <a name="add-a-service-bus-queue-to-the-namespace"></a>Добавление очереди «Автобус обслуживания» в пространство имен

1. Откройте пространство имен сервисного автобуса. Самый простой способ попасть в пространство имен Service Bus — выбрать **группы ресурсов** из панели ресурсов, выбрать группу ресурсов, а затем выбрать пространство имен Service Bus из списка ресурсов.

1. На панели **Namespace автобуса службы** выберите **очередь**.

1. Введите имя для очереди, а затем выберите **Создать**. Когда очередь успешно создана, панель **очереди Create** закрывается.

   ![Добавление очереди служебной шины на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/create-service-bus-queue.png)

1. Вернуться на **панели Namespace автобуса службы,** под **entities**, выберите **Очереди.** Откройте очередь «Автобус обслуживания» из списка, а затем выберите **общие политики** > доступа**и добавьте.**

1. Введите имя для политики, проверьте **Управление,** а затем выберите **Создать.**

   ![Добавление политики очереди автобусов службы на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/2-add-service-bus-queue-azure-portal.png)

## <a name="add-a-custom-endpoint-and-routing-rule-to-your-iot-hub"></a>Добавьте пользовательское правило конечных точек и правил оправился от концентратора IoT

Добавьте в концентратор IoT пользовательскую конечную точку для очереди Service Bus и создайте правило направления сообщений для направления сообщений, содержащих температурное оповещение к этой конечной точке, где они будут подхвачены вашим приложением логики. Правило разгрома использует запрос на изменение `temperatureAlert = "true"`правил для переадресации сообщений `temperatureAlert` на основе значения свойства приложения, установленного кодом клиента, работающим на устройстве. Чтобы узнать больше, смотрите [запрос на разгром сообщения на основе свойств сообщений.](https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-routing-query-syntax#message-routing-query-based-on-message-properties)

### <a name="add-a-custom-endpoint"></a>Добавление пользовательской конечной точки

1. Откройте Центр Интернета вещей. Самый простой способ добраться до концентратора IoT — выбрать **группы ресурсов** из панели ресурсов, выбрать группу ресурсов, а затем выбрать концентратор IoT из списка ресурсов.

1. Под **сообщениями**выберите **разгром сообщения.** На панели **разгрома сообщения** выберите вкладку **пользовательских конечных точек,** а затем выберите **и добавить.** Из списка выпадающих вниз, выберите **очередь автобуса обслуживания.**

   ![Добавление конечной точки в Центр Интернета вещей на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/select-iot-hub-custom-endpoint.png)

1. На **панели конечных точек автобуса обслуживания** введите следующую информацию:

   **Имя конечной точки**: Имя конечной точки.

   **Пространство имен сервисного автобуса**: Выберите созданное вами пространство имен.

   **Очередь автобусов обслуживания**: Выберите созданную очередь.

   ![Добавление конечной точки в Центр Интернета вещей на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/3-add-iot-hub-endpoint-azure-portal.png)

1. Нажмите кнопку **создания**. После успешного создания конечной точки приступай к следующему шагу.

### <a name="add-a-routing-rule"></a>Добавление правила маршрутизации

1. Вернуться на панель **маршрутизатора сообщения,** выберите вкладку **Маршруты,** а затем выберите **и добавить.**

1. На панели **добавления маршрута** введите следующую информацию:

   **Имя**. Имя правила маршрутизации.

   **Конечная точка**. Выберите созданную конечную точку.

   **Источник данных**: Выберите **сообщения телеметрии устройств**.

   **Запрос на реутов:** Введите `temperatureAlert = "true"`.

   ![Добавление правила маршрутизации на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/4-add-routing-rule-azure-portal.png)

1. Щелкните **Сохранить**. Можно закрыть панель **промыкания сообщения.**

## <a name="create-and-configure-a-logic-app"></a>Создание и настройка приложения Logic

В предыдущем разделе вы настроили концентратор IoT для направления сообщений, содержащих температурное оповещение, в очередь Service Bus. Теперь вы настраиваете логическое приложение для мониторинга очереди ВСУ и отправки уведомления по электронной почте при добавлении сообщения в очередь.

### <a name="create-a-logic-app"></a>Создайте приложение логики

1. Выберите Создать приложение**логики интеграции** >  **ресурса** > **.**

1. Введите следующие сведения:

   **Имя**. Имя приложения логики.

   **Группа ресурсов**: Используйте ту же группу ресурсов, что и концентратор IoT.

   **Расположение**. Выберите то же расположение, которое используется для Центра Интернета вещей.

   ![Создание приложения логики на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/create-a-logic-app.png)

1. Нажмите кнопку **создания**.

### <a name="configure-the-logic-app-trigger"></a>Настройка триггера приложения логики

1. Откройте приложение логики. Самый простой способ добраться до приложения логики — выбрать **группы ресурсов** из панели ресурсов, выбрать группу ресурсов, а затем выбрать приложение логики из списка ресурсов. При выборе приложения логики открывается дизайнер приложений логики.

1. В Logic Apps Designer прокрутите вниз к **шаблонам** и выберите **Blank Logic App.**

   ![Начало работы с пустым приложением логики на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/5-start-with-blank-logic-app-azure-portal.png)

1. Выберите вкладку **«Все»,** а затем выберите **служебный автобус.**

   ![Выбор служебной шины для начала создания приложения логики на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/6-select-service-bus-when-creating-blank-logic-app-azure-portal.png)

1. Под **триггерами** **выберите, когда одно или несколько сообщений поступают в очередь (авто-полный).**

   ![Выберите триггер для приложения логики на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/select-service-bus-trigger.png)

1. Создайте подключение к служебной шине.
   1. Введите имя соединения и выберите пространство имен Службы Автобуса из списка. Открывается следующий экран.

      ![Создание подключения к служебной шине для приложения логики на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/create-service-bus-connection-1.png)

   1. Выберите политику автобуса обслуживания (RootManageSharedAccessKey). Затем выберите **Создать**.

      ![Создание подключения к служебной шине для приложения логики на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/7-create-service-bus-connection-in-logic-app-azure-portal.png)

   1. На последнем экране для **имени очереди**выберите созданную очередь из выпадения. Введите `175` для **максимального количества сообщений.**

      ![Установка максимального числа сообщений для подключения к служебной шине в приложении логики](media/iot-hub-monitoring-notifications-with-azure-logic-apps/8-specify-maximum-message-count-for-service-bus-connection-logic-app-azure-portal.png)

   1. Выберите **Сохранить** в меню в верхней части логики Apps Designer, чтобы сохранить ваши изменения.

### <a name="configure-the-logic-app-action"></a>Настройка действия приложения логики

1. Создайте подключение к службе SMTP.

   1. Выберите **новый шаг**. В **выберите действие,** выберите вкладку **«Все».**

   1. Введите `smtp` окно поиска, выберите службу **SMTP** в результате поиска, а затем выберите **Отправить электронную почту.**

      ![Создание подключения к службе SMTP в приложении логики на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/9-create-smtp-connection-logic-app-azure-portal.png)

   1. Введите информацию SMTP для вашего почтового ящика, а затем выберите **Создать**.

      ![Ввод сведений о подключении к службе SMTP в приложении логики на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/10-enter-smtp-connection-info-logic-app-azure-portal.png)

      Получение сведений об SMTP для [Hotmail/Outlook.com](https://support.office.com/article/Add-your-Outlook-com-account-to-another-mail-app-73f3b178-0009-41ae-aab1-87b80fa94970), [Gmail](https://support.google.com/a/answer/176600?hl=en) и [Yahoo Mail](https://help.yahoo.com/kb/SLN4075.html).

      > [!NOTE]
      > Возможно, вам придется отключить TLS/SSL для установления соединения. Если это так, и вы хотите повторно включить TLS после соединения было установлено, см.

   1. Из **Добавить новый параметр** выпадения вниз на шаг **Отправить email,** выберите **из**, **Чтобы,** **Тема** и **тело**. Нажмите или нажмите в любом месте на экране, чтобы закрыть окно выбора.

      ![Выберите поля электронной почты подключения SMTP](media/iot-hub-monitoring-notifications-with-azure-logic-apps/smtp-connection-choose-fields.png)

   1. Введите адрес электронной почты в полях **От** и **Кому** и укажите `High temperature detected` в **теме** и **тексте сообщения**. Если открывается **динамическое содержимое из приложений и разъемов, используемых в диалоге потока,** выберите **Hide,** чтобы закрыть его. Вы не используете динамическое содержание в этом учебнике.

      ![Поля электронной почты подключения SMTP заполните](media/iot-hub-monitoring-notifications-with-azure-logic-apps/fill-in-smtp-connection-fields.png)

   1. Выберите **Сохранить,** чтобы сохранить соединение SMTP.

1. (Необязательно) Если вам пришлось отключить TLS, чтобы установить соединение с вашим поставщиком услуг электронной почты и хотите вновь включить его, выполните следующие действия:

   1. На панели **приложения Логика,** под **инструментами разработки,** выберите **соединения API.**

   1. Из списка соединений API выберите соединение SMTP.

   1. На панели **подключения smtp API** под **общим**испугом выберите **соединение Edit API.**

   1. На панели **подключения Edit API** выберите **Enable SSL?**, повторно введите пароль для учетной записи электронной почты и выберите **Сохранить.**

      ![Отодвиньте соединение API SMTP в приложении логики на портале Azure](media/iot-hub-monitoring-notifications-with-azure-logic-apps/re-enable-smtp-connection-ssl.png)

Приложение логики готово обрабатывать температурные оповещения из очереди Service Bus и отправлять уведомления на ваш адрес электронной почты.

## <a name="test-the-logic-app"></a>Тестирование приложения логики

1. Запустите клиентское приложение на устройстве.

1. Если вы используете физическое устройство, осторожно возьмите источник тепла возле датчика тепла до тех пор, пока температура не превысит 30 градусов по Цельсию. Если вы используете онлайн-симулятор, клиентский код случайным образом выводит телеметрические сообщения, превышаюющие 30 C.

1. Вы должны начать получать уведомления по электронной почте, отправленные приложением логики.

   > [!NOTE]
   > Возможно, поставщику услуг электронной почты потребуется проверить подлинность отправителя и убедиться, что именно вы отправили это сообщение.

## <a name="next-steps"></a>Следующие шаги

Вы успешно создали приложение логики, обеспечивающее подключение между Центром Интернета вещей и почтовым ящиком для мониторинга температуры и отправки уведомлений.

[!INCLUDE [iot-hub-get-started-next-steps](../../includes/iot-hub-get-started-next-steps.md)]
