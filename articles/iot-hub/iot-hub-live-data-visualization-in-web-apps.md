---
title: Визуализация данных в реальном времени ваших данных концентратора IoT в веб-приложении
description: Используйте веб-приложение для визуализации данных о температуре и влажности, которые собираются с датчика и отправляются в концентратор Iot.
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.tgt_pltfrm: arduino
ms.date: 05/31/2019
ms.author: robinsh
ms.openlocfilehash: 138e077f7b47fa9f38a4710db95eb7208cef78e3
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78675318"
---
# <a name="visualize-real-time-sensor-data-from-your-azure-iot-hub-in-a-web-application"></a>Визуализация данных датчиков в реальном времени из концентратора Azure IoT в веб-приложении

![Комплексная схема](./media/iot-hub-live-data-visualization-in-web-apps/1_iot-hub-end-to-end-diagram.png)

[!INCLUDE [iot-hub-get-started-note](../../includes/iot-hub-get-started-note.md)]

## <a name="what-you-learn"></a>Что вы узнаете

В этом уроке вы узнаете, как визуализировать данные датчиков в реальном времени, которые ваш концентратор IoT получает с помощью веб-приложения node.js, работаемого на локальном компьютере. После локального запуска веб-приложения можно дополнительно выполнить шаги по размещению веб-приложения в Службе приложений Azure. Если вы хотите визуализировать данные, поступающие с датчиков в реальном времени, в Центре Интернета вещей с помощью Power BI, см. сведения в [этой статье](iot-hub-live-data-visualization-in-power-bi.md).

## <a name="what-you-do"></a>Что нужно сделать

* Добавьте группу потребителей в свой концентратор IoT, который веб-приложение будет использовать для чтения данных датчиков
* Скачать код веб-приложения с GitHub
* Изучите код веб-приложения
* Настройка переменных среды для хранения артефактов Концентратора IoT, необходимых вашему веб-приложению
* Запустите веб-приложение на машине разработки
* Откройте веб-страницу, чтобы видеть данные о температуре и влажности в режиме реального времени в вашем концентраторе IoT
* (Необязательно) Используйте Azure CLI для размещения веб-приложения в службе приложений Azure

## <a name="what-you-need"></a>Необходимые элементы

* Завершите [учебник онлайн симулятор Raspberry Pi](iot-hub-raspberry-pi-web-simulator-get-started.md) или один из учебников по устройству; например, [Raspberry Pi с node.js](iot-hub-raspberry-pi-kit-node-get-started.md). Они охватывают следующие требования:

  * активная подписка Azure;
  * Центр Интернета вещей в подписке;
  * клиентское приложение, которое отправляет сообщения в Центр Интернета вещей.

* [Скачайте Git](https://www.git-scm.com/downloads).

* Шаги в этой статье предполагают машину разработки Windows; однако, вы можете легко выполнить эти шаги на системе Linux в предпочитаемых оболочки.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

Выполните следующую команду, чтобы добавить расширение Интернета вещей Microsoft Azure для Azure CLI в экземпляр Cloud Shell. Расширение Интернета вещей добавляет в Azure CLI специальные команды Центра Интернета вещей, IoT Edge и службы подготовки устройств Интернета вещей (DPS).

```azurecli-interactive
az extension add --name azure-iot
```

## <a name="add-a-consumer-group-to-your-iot-hub"></a>Добавление группы потребителей в Центр Интернета вещей

[Группы потребителей](https://docs.microsoft.com/azure/event-hubs/event-hubs-features#event-consumers) предоставляют независимые представления в поток еде, которые позволяют приложениям и службам Azure самостоятельно использовать данные из одной и той же точки концентратора событий. В этом разделе вы добавляете группу потребителей в встроенную конечную точку концентратора IoT, с помощью которого веб-приложение будет использоваться для чтения данных.

Запустите следующую команду, чтобы добавить группу потребителей в встроенную конечную точку концентратора IoT:

```azurecli-interactive
az iot hub consumer-group create --hub-name YourIoTHubName --name YourConsumerGroupName
```

Запишите имя, которое вы выберете, оно вам понадобится позже в этом уроке.

## <a name="get-a-service-connection-string-for-your-iot-hub"></a>Получите строку подключения к службе для концентратора IoT

Концентраторы IoT создаются с несколькими политиками доступа по умолчанию. Одной из таких политик является политика **службы,** которая предоставляет достаточное разрешение службе на чтение и запись конечных точек концентратора IoT. Запустите следующую команду, чтобы получить строку соединения для концентратора IoT, которая соответствует политике службы:

```azurecli-interactive
az iot hub show-connection-string --hub-name YourIotHub --policy-name service
```

Строка соединения должна выглядеть так же, как и следующая:

```javascript
"HostName={YourIotHubName}.azure-devices.net;SharedAccessKeyName=service;SharedAccessKey={YourSharedAccessKey}"
```

Запишите строку подключения службы, она вам понадобится позже в этом уроке.

## <a name="download-the-web-app-from-github"></a>Скачать веб-приложение с GitHub

Откройте окно команды и введите следующие команды, чтобы загрузить образец из GitHub и изменить в каталог образца:

```cmd
git clone https://github.com/Azure-Samples/web-apps-node-iot-hub-data-visualization.git
cd web-apps-node-iot-hub-data-visualization
```

## <a name="examine-the-web-app-code"></a>Изучите код веб-приложения

Из веб-приложений-узлов-iot-hub-data-визуализации каталог, откройте веб-приложение в вашем любимом редакторе. Ниже показана структура файлов, рассматриваемая в VS Code:

![Структура файлов веб-приложений](./media/iot-hub-live-data-visualization-in-web-apps/web-app-files.png)

Найдите минутку, чтобы изучить следующие файлы:

* **Server.js** — это скрипт со стороны сервиса, который инициализирует веб-разъем и класс обертки Event Hub. Он обеспечивает обратный вызов в класс обертки Event Hub, который класс использует для трансляции входящих сообщений в веб-гнездо.

* **Event-hub-reader.js** — это скрипт со стороны службы, который подключается к встроенной конечной точке концентратора IoT с помощью указанной строки соединения и группы потребителей. Он извлекает DeviceId и EnqueuedTimeUtc из метаданных на входящие сообщения, а затем ретранслирует сообщение с помощью метода обратного отвоза, зарегистрированного server.js.

* **Chart-device-data.js** — это сценарий на стороне клиента, который слушает на веб-разъеме, отслеживает каждый DeviceId и хранит последние 50 точек входящих данных для каждого устройства. Затем он связывает выбранные данные устройства с объектом диаграммы.

* **Index.html** обрабатывает макет uI для веб-страницы и ссылается на необходимые сценарии для логики клиента.

## <a name="configure-environment-variables-for-the-web-app"></a>Настройка переменных среды для веб-приложения

Для чтения данных из концентратора IoT веб-приложению необходима строка подключения концентратора IoT и название группы потребителей, которую оно должно прочитать. Эти строки можно вычислять из среды процесса в следующих строках на server.js:

```javascript
const iotHubConnectionString = process.env.IotHubConnectionString;
const eventHubConsumerGroup = process.env.EventHubConsumerGroup;
```

Установите переменные среды в окне команды следующими командами. Замените значения заполнителя строкой подключения к вашему концентратору IoT и названию созданной ранее группы потребителей. Не цитируйте строки.

```cmd
set IotHubConnectionString=YourIoTHubConnectionString
set EventHubConsumerGroup=YourConsumerGroupName
```

## <a name="run-the-web-app"></a>Запуск веб-приложения

1. Убедитесь, что устройство работает и отправляет данные.

2. В окне команды запустите следующие строки, чтобы загрузить и установить ссылки пакеты и запустить веб-сайт:

   ```cmd
   npm install
   npm start
   ```

3. Вы должны увидеть выход в консоли, который указывает на то, что веб-приложение успешно подключено к концентратору IoT и слушает на порте 3000:

   ![Веб-приложение запущено на консоли](./media/iot-hub-live-data-visualization-in-web-apps/web-app-console-start.png)

## <a name="open-a-web-page-to-see-data-from-your-iot-hub"></a>Откройте веб-страницу, чтобы увидеть данные из концентратора IoT

Откройте браузер с адресом `http://localhost:3000`.

В списке **«Выберите устройство»** выберите устройство, чтобы увидеть бегущий участок последних 50 точек данных температуры и влажности, отправленных устройством в концентратор IoT.

![Страница веб-приложения с данными о температуре и влажности, полученными в реальном времени](./media/iot-hub-live-data-visualization-in-web-apps/web-page-output.png)

Вы также должны видеть выход в консоли, которая показывает сообщения, которые ваше веб-приложение транслирует клиенту браузера:  

![Выход трансляции веб-приложений на консоли](./media/iot-hub-live-data-visualization-in-web-apps/web-app-console-broadcast.png)

## <a name="host-the-web-app-in-app-service"></a>Размещение веб-приложения в Службе Приложений

[Функция Web Apps Службы приложений Azure](https://docs.microsoft.com/azure/app-service/overview) предоставляет платформу в качестве службы (PAAS) для хостинга веб-приложений. Веб-приложения, размещенные в Службе приложений Azure, могут пользоваться мощными функциями Azure, такими как дополнительная безопасность, балансировка нагрузки и масштабируемость, а также решения Azure и партнеров DevOps, такие как непрерывное развертывание, управление пакетами и так далее. Служба приложений Azure поддерживает веб-приложения, разработанные на многих популярных языках и развернутые на инфраструктуре Windows или Linux.

В этом разделе вы предоставляете веб-приложение в Службе Приложений и развертываете свой код с помощью команд Azure CLI. Вы можете найти подробную информацию о командах, используемых в документации [webapp az.](https://docs.microsoft.com/cli/azure/webapp?view=azure-cli-latest) Перед запуском убедитесь, что вы выполнили шаги по добавлению группы ресурсов в [концентратор IoT,](#add-a-consumer-group-to-your-iot-hub) [получите строку подключения к службе для вашего концентратора IoT](#get-a-service-connection-string-for-your-iot-hub)и [загрузите веб-приложение из GitHub.](#download-the-web-app-from-github)

1. [План Службы приложений](https://docs.microsoft.com/azure/app-service/overview-hosting-plans) определяет набор вычислительных ресурсов для запуска приложения, размещенного в Службе App. В этом учебнике мы используем уровень Developer/Free для размещения веб-приложения. С помощью бесплатного уровня ваше веб-приложение работает на общих ресурсах Windows с другими приложениями Службы приложений, включая приложения других клиентов. Azure также предлагает планы Службы приложений по развертыванию веб-приложений на вычислительных ресурсах Linux. Вы можете пропустить этот шаг, если у вас уже есть план службы приложений, который вы хотите использовать.

   Чтобы создать план службы приложений, используя бесплатный уровень Windows, запустите следующую команду. Используйте ту же группу ресурсов, в какой находится концентратор IoT. Имя плана обслуживания может содержать верхние и нижние буквы, цифры и дефисы.

   ```azurecli-interactive
   az appservice plan create --name <app service plan name> --resource-group <your resource group name> --sku FREE
   ```

2. Теперь предоставить веб-приложение в плане Службы приложений. Параметр `--deployment-local-git` позволяет загружать и развертывать код веб-приложения из репозитория Git на локальной машине. Ваше имя веб-приложения должно быть глобально уникальным и может содержать верхние и нижние буквы, цифры и дефисы. Не забудьте указать версию Node 10.6 или позже для `--runtime` параметра, в зависимости от версии времени выполнения Node.js, который вы используете. Вы можете `az webapp list-runtimes` использовать команду, чтобы получить список поддерживаемых времен выполнения.

   ```azurecli-interactive
   az webapp create -n <your web app name> -g <your resource group name> -p <your app service plan name> --runtime "node|10.6" --deployment-local-git
   ```

3. Теперь добавьте настройки приложений для переменных среды, которые определяют строку соединения концентратора IoT и группу потребителей концентратора событий. Индивидуальные настройки разграничены в параметре. `-settings` Используйте строку подключения службы для вашего концентратора IoT и группы потребителей, созданной ранее в этом учебнике. Не цитируйте значения.

   ```azurecli-interactive
   az webapp config appsettings set -n <your web app name> -g <your resource group name> --settings EventHubConsumerGroup=<your consumer group> IotHubConnectionString=<your IoT hub connection string>
   ```

4. Включите протокол Web Sockets для веб-приложения и установите веб-приложение только для получения запросов HTTPS (запросы HTTP перенаправляются в HTTPS).

   ```azurecli-interactive
   az webapp config set -n <your web app name> -g <your resource group name> --web-sockets-enabled true
   az webapp update -n <your web app name> -g <your resource group name> --https-only true
   ```

5. Для развертывания кода в Службе app — необходимо использовать [учетные данные развертывания на уровне пользователя.](https://docs.microsoft.com/azure/app-service/deploy-configure-credentials) Учетные данные развертывания на уровне пользователя отличаются от учетных данных Azure и используются для локального развертывания Git и FTP для веб-приложения. После установки они действительны во всех приложениях Службы приложений во всех подписках в вашей учетной записи Azure. Если ранее вы устанавливали учетные данные развертывания на уровне пользователя, вы можете использовать их.

   Если ранее вы не устанавливали учетные данные развертывания на уровне пользователя или не можете запомнить пароль, запустите следующую команду. Имя пользователя развертывания должно быть уникальным в Azure и не должно содержать символ «Я» для локальных нажатий Git. Когда вам будет предложено, введите и подтвердите свой новый пароль. Пароль должен содержать не менее восьми символов и включать два из трех следующих элементов: буквы, цифры и символы.

   ```azurecli-interactive
   az webapp deployment user set --user-name <your deployment user name>
   ```

6. Получите URL-адрес Git, чтобы подтолкнуть код к службе app.

   ```azurecli-interactive
   az webapp deployment source config-local-git -n <your web app name> -g <your resource group name>
   ```

7. Добавьте пульт дистанционного управления к клону, который ссылается на репозиторий Git для веб-приложения в App Service. Для \<URL-клона\>Клона Git используйте URL-адрес, возвращенный на предыдущем этапе. Выполнить следующую команду в окне команды.

   ```cmd
   git remote add webapp <Git clone URL>
   ```

8. Чтобы развернуть код в службе app, введите следующую команду в окне команды. Если вам предложено учетные данные, введите учетные данные развертывания на уровне пользователя, созданные на шаг 5. Убедитесь, что вы нажимаете на основной филиал пульта дистанционного управления Службой приложений.

    ```cmd
    git push webapp master:master
    ```

9. Ход развертывания будет обновляться в окне команды. Успешное развертывание завершится строками, аналогичными следующим выводам:

    ```cmd
    remote:
    remote: Finished successfully.
    remote: Running post deployment command(s)...
    remote: Deployment successful.
    To https://contoso-web-app-3.scm.azurewebsites.net/contoso-web-app-3.git
    6b132dd..7cbc994  master -> master
    ```

10. Запустите следующую команду, чтобы заставить заявить о состоянии вашего веб-приложения и убедиться, что оно работает:

    ```azurecli-interactive
    az webapp show -n <your web app name> -g <your resource group name> --query state
    ```

11. Откройте браузер и перейдите по адресу `https://<your web app name>.azurewebsites.net`. Веб-страница, похожая на ту, что вы видели, когда вы запустили веб-приложение локально отображает. Предполагая, что устройство работает и отправляет данные, вы должны увидеть бегущий участок из 50 последних показаний температуры и влажности, отправленных устройством.

## <a name="troubleshooting"></a>Устранение неполадок

Если вы столкнетесь с какими-либо проблемами с этим примером, попробуйте шаги в следующих разделах. Если у вас все еще есть проблемы, пришлите нам обратную связь в нижней части этой темы.

### <a name="client-issues"></a>Вопросы клиентов

* Если устройство не отображается в списке или график не нарисован, убедитесь, что код устройства работает на вашем устройстве.

* В браузере откройте инструменты разработчика (во многих браузерах ключ F12 откроет его) и найдите консоль. Ищите любые предупреждения или ошибки, напечатанные там.

* Вы можете отладить сценарий на стороне клиента в /js/chat-device-data.js.

### <a name="local-website-issues"></a>Местные вопросы веб-сайта

* Следите за выходом в окне, где вы запустили узла для вывода консоли.

* Отогладить код сервера, в частности server.js и /скрипты/событие-hub-reader.js.

### <a name="azure-app-service-issues"></a>Проблемы службы приложений Azure

* На портале Azure перейдите в веб-приложение. Под **мониторингом** в левом стеле выберите **журналы Службы Приложений.** Включите **регистрацию приложений (Файловая система)** в, **установите уровень** к ошибке, а затем выберите **Сохранить**. Затем откройте **поток журнала** (под **мониторингом).**

* Из веб-приложения на портале Azure под **помощью инструментов разработки** выберите **консоль** и проверяйте версии узлов и npm с `node -v` и `npm -v`.

* Если вы видите ошибку в ненахождении пакета, возможно, выполнить ступени из-за порядка. Когда сайт развернут (с `git push`) работает `npm install`служба приложения, которая работает на основе текущей версии узла, который он настроил. Если это будет изменено в конфигурации позже, вам нужно внести бессмысленное изменение в код и нажать снова.

## <a name="next-steps"></a>Дальнейшие действия

Вы успешно использовали веб-приложение для визуализации данных датчика, полученных в реальном времени, из Центра Интернета вещей.

Для получения другой визуализации данных из концентратора Azure IoT см. [Use Power BI для визуализации данных датчиков в реальном времени из концентратора IoT.](iot-hub-live-data-visualization-in-power-bi.md)

[!INCLUDE [iot-hub-get-started-next-steps](../../includes/iot-hub-get-started-next-steps.md)]
