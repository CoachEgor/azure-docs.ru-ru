---
title: Сведения о маршрутизации сообщений Центра Интернета вещей Azure | Документация Майкрософт
description: Руководство разработчика по использованию маршрутизации сообщений для отправки с устройства в облако. Эта статья содержит сведения об отправке данных телеметрии и других данных.
author: ash2017
manager: briz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 05/15/2019
ms.author: asrastog
ms.openlocfilehash: d10744f2536cdf89115cdccd0bea6f1e5155774c
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79370463"
---
# <a name="use-iot-hub-message-routing-to-send-device-to-cloud-messages-to-different-endpoints"></a>Используйте разгром сообщений IoT Hub для отправки сообщений от устройства в облако в различные конечные точки

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-partial.md)]

Маршрутизация сообщений позволяет отправлять сообщения с устройств в облачные службы автоматическим, масштабируемым и надежным способом. Маршрутизацию сообщений можно использовать в следующих случаях. 

* **Отправка сообщений и событий телеметрии устройства**, а именно событий жизненного цикла устройства и событий изменения двойника устройства для встроенной и пользовательских конечных точек. Дополнительные сведения о [конечных точках маршрутизации](#routing-endpoints).

* **Фильтрация данных перед их отправкой по различным конечным точкам** путем применения полнофункциональных запросов. Маршрутизация сообщений позволяет запрашивать свойства сообщения, текст сообщения, теги и свойства двойников устройств. Дополнительные сведения об использовании [запросов для маршрутизации сообщений](iot-hub-devguide-routing-query-syntax.md).

Для маршрутизации сообщений Центру Интернета вещей требуется доступ на запись к этим конечным точкам служб. При настройке конечных точек через портал Azure необходимые разрешения добавляются автоматически. Настройте в службах поддержку ожидаемой пропускной способности. Например, если вы используете концентраторы событий в качестве пользовательской конечной точки, необходимо настроить **блоки пропускной связи** для этого концентратора событий, чтобы он мог обрабатывать вход событий, которые вы планируете отправить через передачу сообщений IoT Hub. Аналогичным образом, при использовании очереди в автобусе службы в качестве конечной точки необходимо настроить **максимальный размер,** чтобы обеспечить, чтобы очередь удерживала все данные, всдаваемые, пока она не будет вытесняться потребителями. При первой настройке решения Интернета вещей может потребоваться отслеживать дополнительные конечные точки, а затем вносить необходимые изменения с учетом реальной нагрузки.

Центр Интернета вещей задает [общий формат](iot-hub-devguide-messages-construct.md) для всех случаев обмена сообщениями с устройства в облако для взаимодействия по различным протоколам. Если сообщение соответствует нескольким маршрутам, которые указывают на одну и ту же конечную точку, то Центр Интернета вещей доставляет сообщение в эту конечную точку только один раз. Таким образом, не требуется настраивать дедупликацию для очереди или раздела служебной шины. В секционированных очередях сопоставление секций гарантирует упорядочивание сообщений. В этом руководстве вы научитесь [настраивать маршрутизацию сообщений](tutorial-routing.md).

## <a name="routing-endpoints"></a>Конечные точки маршрутизации

В Центре Интернета вещей имеется встроенная конечная точка по умолчанию (**messages/events**), совместимая с Центрами событий. Вы можете создать [пользовательские конечные точки](iot-hub-devguide-endpoints.md#custom-endpoints) для маршрутизации сообщений, связав с Центром Интернета вещей другие службы в подписке. 

Каждое сообщение направляется во все конечные точки, маршрутизируя запросы. Другими словами, сообщение может быть направлено в несколько конечных точек.

Сейчас Центр Интернета вещей поддерживает следующие службы в качестве пользовательских конечных точек:

### <a name="built-in-endpoint"></a>Встроенная конечная точка

Вы можете использовать стандартную [интеграцию Центров событий и пакеты SDK](iot-hub-devguide-messages-read-builtin.md), чтобы отправлять сообщения с устройства в облако из встроенной конечной точки (**messages/events**). После создания маршрута данные перестают поступать в встроенную конечную точку, если только маршрут не создан до этой конечной точки.

### <a name="azure-storage"></a>Хранилище Azure

Есть две службы хранения IoT Hub, которые могут направлять сообщения в учетные записи [Azure Blob Storage](../storage/blobs/storage-blobs-introduction.md) и [Azure Data Lake Storage Gen2](../storage/blobs/data-lake-storage-introduction.md) (ADLS Gen2). Учетные записи Azure Data Lake Storage — это иерархические учетные записи хранения с поддержкой [имен,](../storage/blobs/data-lake-storage-namespace.md)построенные поверх хранилища капли. Оба они используют капли для их хранения.

IoT Концентратор поддерживает запись данных в Хранилище Azure в формате [Apache Avro,](https://avro.apache.org/) а также в формате JSON. По умолчанию используется AVRO. Формат кодирования может быть установлен только при настройке конечной точки хранения капли. Формат не может быть отредактирован для существующей конечной точки. При использовании кодирования JSON необходимо установить содержимоеType для **приложения/json** и contentEncoding к **UTF-8** в [свойствах системы](iot-hub-devguide-routing-query-syntax.md#system-properties)сообщений. Оба эти значения нечувствительны. Если кодирование содержимого не установлено, то IoT Hub будет писать сообщения в закодированном формате base 64. Вы можете выбрать формат кодирования с помощью IoT Hub Создать или обновить REST API, в [частности, RoutingStorageContainerProperties](https://docs.microsoft.com/rest/api/iothub/iothubresource/createorupdate#routingstoragecontainerproperties), портал Azure, [Azure CLI](https://docs.microsoft.com/cli/azure/iot/hub/routing-endpoint?view=azure-cli-latest), или [Azure PowerShell.](https://docs.microsoft.com/powershell/module/az.iothub/add-aziothubroutingendpoint?view=azps-1.3.0) На следующей диаграмме показано, как выбрать формат кодирования на портале Azure.

![Кодирование конечных точек хранения Blob](./media/iot-hub-devguide-messages-d2c/blobencoding.png)

IoT Концентратор разъезжает сообщения и записывает данные для хранения всякий раз, когда пакет достигает определенного размера или прошло определенное время. По умолчанию Центр Интернета вещей использует следующее соглашение об именовании файлов: 

```
{iothub}/{partition}/{YYYY}/{MM}/{DD}/{HH}/{mm}
```

Вы можете применять любое соглашение об именовании файлов, однако необходимо использовать все перечисленные токены. Центр Интернета вещей будет записывать пустой большой двоичный объект, если нет данных для записи.

Мы рекомендуем перечислить капли или файлы, а затем итерации над ними, чтобы обеспечить все капли или файлы читаются без каких-либо предположений о разделении. Диапазон секций может измениться в процессе [инициированной корпорацией Майкрософт отработки отказа](iot-hub-ha-dr.md#microsoft-initiated-failover) или при [переходе на другой ресурс вручную](iot-hub-ha-dr.md#manual-failover) с помощью Центра Интернета вещей. Вы можете использовать [API List Blobs](https://docs.microsoft.com/rest/api/storageservices/list-blobs) для перечисления списка капли или [список ADLS Gen2 API](https://docs.microsoft.com/rest/api/storageservices/datalakestoragegen2/path/list) для списка файлов. Пожалуйста, ознакомьтесь со следующим примером в качестве руководства.

```csharp
public void ListBlobsInContainer(string containerName, string iothub)
{
    var storageAccount = CloudStorageAccount.Parse(this.blobConnectionString);
    var cloudBlobContainer = storageAccount.CreateCloudBlobClient().GetContainerReference(containerName);
    if (cloudBlobContainer.Exists())
    {
        var results = cloudBlobContainer.ListBlobs(prefix: $"{iothub}/");
        foreach (IListBlobItem item in results)
        {
            Console.WriteLine(item.Uri);
        }
    }
}
```

> [!NOTE]
> Если в учетной записи хранилища есть конфигурации брандмауэра, ограничивающие подключение Концентратора IoT, рассмотрите возможность использования [доверенного Майкрософт исключения первой партии](./virtual-network-support.md#egress-connectivity-to-storage-account-endpoints-for-routing) (доступно в некоторых регионах для концентраторов IoT с управляемым удостоверением личности службы).

Чтобы создать учетную запись хранения, совместимую с Azure Data Lake Gen2, создайте новую учетную запись хранения V2 и выберите *включенную* на поле *иерархического пространства имен* на вкладке **Advanced,** как показано на следующем изображении:

![Выберите хранилище Azure Date Lake Gen2](./media/iot-hub-devguide-messages-d2c/selectadls2storage.png)


### <a name="service-bus-queues-and-service-bus-topics"></a>Очереди и разделы служебной шины

Для очередей и разделов служебной шины, которые используются как конечные точки Центра Интернета вещей, **сеансы** или **поиск повторяющихся данных** должны быть выключены. Если одна из этих возможностей включена, на портале Azure конечная точка будет отображаться как **недоступная**.

> [!NOTE]
> Если ресурс шины обслуживания имеет конфигурации брандмауэра, ограничивающие подключение Концентратора IoT, рассмотрите возможность использования [доверенного Майкрософт исключения первой партии](./virtual-network-support.md#egress-connectivity-to-service-bus-endpoints-for-routing) (доступно в некоторых регионах для концентраторов IoT с управляемым удостоверением личности службы).


### <a name="event-hubs"></a>Центры событий

Помимо конечной точки, совместимой со встроенными Центрами событий, вы также можете направлять данные в пользовательские конечные точки типа Центров событий. 

> [!NOTE]
> Если ресурс концентраторов событий имеет конфигурации брандмауэра, ограничивающие подключение Концентратора IoT, рассмотрите возможность использования [доверенного Майкрософт исключения первой партии](./virtual-network-support.md#egress-connectivity-to-event-hubs-endpoints-for-routing) (доступнового в некоторых регионах для концентраторов IoT с управляемым удостоверением личности службы).


## <a name="reading-data-that-has-been-routed"></a>Чтение маршрутизированных данных

Вы можете настроить маршрут, следуя инструкциям в [этом руководстве](tutorial-routing.md).

В следующих руководствах вы узнаете, как читать сообщения из конечной точки.

* Считывание данных из [встроенной конечной точки](quickstart-send-telemetry-node.md).

* Считывание данных из [хранилища BLOB-объектов](../storage/blobs/storage-blob-event-quickstart.md).

* Считывание данных из [Центров событий](../event-hubs/event-hubs-dotnet-standard-getstarted-send.md).

* Считывание данных из [очередей служебной шины](../service-bus-messaging/service-bus-dotnet-get-started-with-queues.md).

* Считывание данных из [разделов служебной шины](https://docs.microsoft.com/azure/service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions).


## <a name="fallback-route"></a>Резервный маршрут

Резервный маршрут позволяет отправить все сообщения, которые не соответствуют условиям запроса на любом из имеющихся маршрутов, ко встроенным Центрам событий (**/messages/events**), совместимым со службой [Центры событий](/azure/event-hubs/). Если маршрутизация сообщений включена, вы можете включить возможность резервного маршрута. После создания маршрута данные перестают поступать в встроенную конечную точку, если только маршрут не создан до этой конечной точки. Если маршруты ко встроенной конечной точке отсутствуют и резервный маршрут включен, на встроенную конечную точку будут отправляться только те сообщения, которые не соответствуют каким-либо условиям запроса для маршрутов. Кроме того, если удалить имеющиеся маршруты, необходимо включить резервный маршрут, чтобы все данные поступали на встроенную конечную точку.

Вы можете включить/отключить обратный маршрут в лезвии маршрутной маршрутной трассы Портала >Azure. Вы также можете использовать Azure Resource Manager, чтобы свойства [FallbackRouteProperties](/rest/api/iothub/iothubresource/createorupdate#fallbackrouteproperties) использовали пользовательскую конечную точку для резервного маршрута.

## <a name="non-telemetry-events"></a>События без использования телеметрии

В дополнение к телеметрии устройства, маршрутизирование сообщений также позволяет отправлять события двойного изменения устройства, события жизненного цикла устройства и цифровые события изменения близнецов (в общедоступном предварительном просмотре). Например, при создании маршрута с источником данных со значением **события изменения двойников устройства** Центр Интернета вещей отправляет сообщения на конечную точку, содержащую изменения двойника устройства. Аналогичным образом, если маршрут создается с исходным устройством, установленным для **событий жизненного цикла устройства,** IoT Hub отправляет сообщение с указанием того, было ли устройство удалено или создано. Наконец, в рамках [публичного предварительного просмотра IoT Plug and Play](../iot-pnp/overview-iot-plug-and-play.md)разработчик может создавать маршруты с набором исходных данных для **цифровых событий двойного изменения,** а IoT Hub отправляет сообщения всякий раз, когда устанавливается или изменяется [цифровое двойное свойство, заменяется цифровой близнец](../iot-pnp/iot-plug-and-play-glossary.md) или когда происходит событие изменения для базового близнеца устройства. [property](../iot-pnp/iot-plug-and-play-glossary.md)

[IoT Hub также интегрируется с Azure Event Grid](iot-hub-event-grid.md) для публикации событий устройства для поддержки интеграции в реальном времени и автоматизации рабочих процессов на основе этих событий. Ознакомьтесь с основными различиями [между маршрутизацией сообщений и Сеткой событий](iot-hub-event-grid-routing-comparison.md), чтобы узнать, какой вариант подходит вам больше.

## <a name="testing-routes"></a>Тестирование маршрутов

При создании маршрута или изменении имеющегося маршрута необходимо проверить запрос маршрута, отправив пример сообщения. Вы можете протестировать отдельные маршруты или проверить все маршруты за один раз и не отправлять сообщения на конечные точки во время теста. Для тестирования можно использовать портал Azure, менеджер ресурсов Azure, Azure PowerShell и Azure CLI. Результаты помогают определить, соответствовало ли сообщение образца запросу, сообщение не соответствовало запросу или не удалось выполнить тест, поскольку сообщение образца или синтаксис запроса неверны. Дополнительные сведения см. в статьях о [проверке маршрута](/rest/api/iothub/iothubresource/testroute) и [проверке всех маршрутов](/rest/api/iothub/iothubresource/testallroutes).

## <a name="ordering-guarantees-with-at-least-once-delivery"></a>Гарантии заказа по крайней мере один раз доставки

Гарантии разгрома сообщений IoT Hub упорядочены и хотя бы один раз доставлять сообщения в конечные точки. Это означает, что могут быть дублирующиеся сообщения и ряд сообщений могут быть повторно переданы в честь первоначального заказа сообщения. Например, если исходный заказ на сообщение составляет 1,2,3,4, вы можете получить последовательность сообщений, как «1,2,1,2,3,1,2,3,4». Гарантия заказа заключается в том, что если вы когда-нибудь получите сообщение, то за ним всегда последует «2,3,4».

Для обработки дубликатов сообщений мы рекомендуем штамповать уникальный идентификатор в свойствах приложения сообщения в точке происхождения, которая обычно является устройством или модулем. Служба, потребляющая сообщения, может обрабатывать дубликаты сообщений с помощью этого идентификатора.

## <a name="latency"></a>Задержка

При маршрутизации сообщений телеметрии, передаваемой с устройства в облако с помощью встроенных конечных точек наблюдается небольшое увеличение общей задержки после создания первого маршрута.

В большинстве случаев средняя задержка составляет менее 500 мс. Вы можете отслеживать задержки с помощью метрики Центра Интернета вещей **Routing: message latency for messages/events** (Маршрутизация: задержка сообщений для messages/events) или **d2c.endpoints.latency.builtIn.events**. Последующее создание или удаление любого маршрута не влияет на общую задержку.

## <a name="monitoring-and-troubleshooting"></a>Мониторинг и устранение неполадок

IoT Hub предоставляет несколько метрик, связанных с точностью и конечными точками, чтобы дать вам обзор работоспособности вашего концентратора и отправленных сообщений. Вы можете объединить данные из нескольких метрик, чтобы определить первопричину проблем. Например, используйте **метрическую маршрутизирующую: телеметрические сообщения упали** или **d2c.telemetry.egress.dropped** для определения количества сообщений, которые были удалены, когда они не соответствовали запросам на любом из маршрутов, и обратный маршрут был отключен. В [этой статье](iot-hub-metrics.md) представлены все метрики, включенные по умолчанию для Центра Интернета вещей.

Для [получения состояния здоровья](iot-hub-devguide-endpoints.md#custom-endpoints) конечных точек можно использовать REST API [Get Endpoint Health.](https://docs.microsoft.com/rest/api/iothub/iothubresource/getendpointhealth#iothubresource_getendpointhealth) Мы рекомендуем использовать [метрики Концентратора IoT,](iot-hub-metrics.md) связанные с задержкой сообщений, для выявления и оттачекошибок ошибок при неправильном или нездоровом состоянии. Например, для концентраторов событий типа endpoint можно отслеживать **d2c.endpoints.latency.eventHubs.** Состояние нездоровой конечной точки будет обновлено до здорового, когда IoT Hub установил в конечном итоге стабильное состояние здоровья.

Используя диагностические журналы **маршрутов** в [диагностических настройках](../iot-hub/iot-hub-monitor-resource-health.md)Azure Monitor, можно отслеживать ошибки, возникающие при оценке запроса маршрутов и работоспособности конечных точек, как это воспринимается Концентратором IoT, например, когда конечная точка мертва. Эти диагностические журналы можно отправлять в журналы Azure Monitor, концентраторы событий или хранилище Azure для пользовательской обработки.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о создании маршрутов сообщений см. в статье [Руководство. Настройка маршрутизации сообщений с Центром Интернета вещей](tutorial-routing.md).

* [Краткое руководство. Отправка данных телеметрии с устройства в Центр Интернета вещей и чтение данных телеметрии из центра с помощью внутреннего приложения (Node.js)](quickstart-send-telemetry-node.md)

* Дополнительные сведения о пакетах SDK, которые можно использовать для отправки сообщений с устройства в облако, см. в статье, посвященной [пакетам SDK для Azure IoT](iot-hub-devguide-sdks.md).
