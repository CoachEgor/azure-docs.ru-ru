---
title: Сведения о маршрутизации сообщений Центра Интернета вещей Azure | Документация Майкрософт
description: Руководство разработчика по использованию маршрутизации сообщений для отправки с устройства в облако. Эта статья содержит сведения об отправке данных телеметрии и других данных.
author: ash2017
manager: briz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 05/15/2019
ms.author: asrastog
ms.openlocfilehash: d2d4d39cc7b330794094745851856365ef54b42f
ms.sourcegitcommit: 3073581d81253558f89ef560ffdf71db7e0b592b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/06/2019
ms.locfileid: "68828188"
---
# <a name="use-iot-hub-message-routing-to-send-device-to-cloud-messages-to-different-endpoints"></a>Использование маршрутизации сообщений центра Интернета вещей для отправки сообщений с устройства в облако в разные конечные точки

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-partial.md)]

Маршрутизация сообщений позволяет отправлять сообщения с устройств в облачные службы автоматическим, масштабируемым и надежным способом. Маршрутизацию сообщений можно использовать в следующих случаях. 

* **Отправка сообщений и событий телеметрии устройства**, а именно событий жизненного цикла устройства и событий изменения двойника устройства для встроенной и пользовательских конечных точек. Дополнительные сведения о [конечных точках маршрутизации](#routing-endpoints).

* **Фильтрация данных перед их отправкой по различным конечным точкам** путем применения полнофункциональных запросов. Маршрутизация сообщений позволяет запрашивать свойства сообщения, текст сообщения, теги и свойства двойников устройств. Дополнительные сведения об использовании [запросов для маршрутизации сообщений](iot-hub-devguide-routing-query-syntax.md).

Для маршрутизации сообщений Центру Интернета вещей требуется доступ на запись к этим конечным точкам служб. При настройке конечных точек через портал Azure необходимые разрешения добавляются автоматически. Настройте в службах поддержку ожидаемой пропускной способности. При первой настройке решения Интернета вещей может потребоваться отслеживать дополнительные конечные точки, а затем вносить необходимые изменения с учетом реальной нагрузки.

Центр Интернета вещей задает [общий формат](iot-hub-devguide-messages-construct.md) для всех случаев обмена сообщениями с устройства в облако для взаимодействия по различным протоколам. Если сообщение соответствует нескольким маршрутам, которые указывают на одну и ту же конечную точку, то Центр Интернета вещей доставляет сообщение в эту конечную точку только один раз. Таким образом, не требуется настраивать дедупликацию для очереди или раздела служебной шины. В секционированных очередях сопоставление секций гарантирует упорядочивание сообщений. В этом руководстве вы научитесь [настраивать маршрутизацию сообщений](tutorial-routing.md).

## <a name="routing-endpoints"></a>Конечные точки маршрутизации

В Центре Интернета вещей имеется встроенная конечная точка по умолчанию (**messages/events**), совместимая с Центрами событий. Вы можете создать [пользовательские конечные точки](iot-hub-devguide-endpoints.md#custom-endpoints) для маршрутизации сообщений, связав с Центром Интернета вещей другие службы в подписке. Сейчас Центр Интернета вещей поддерживает следующие службы в качестве пользовательских конечных точек:

### <a name="built-in-endpoint"></a>Встроенная конечная точка

Вы можете использовать стандартную [интеграцию Центров событий и пакеты SDK](iot-hub-devguide-messages-read-builtin.md), чтобы отправлять сообщения с устройства в облако из встроенной конечной точки (**messages/events**). После создания маршрута данные перестают передаваться во встроенную конечную точку, если только маршрут не создан для этой конечной точки.

### <a name="azure-blob-storage"></a>Хранилище BLOB-объектов Azure

Центр Интернета вещей поддерживает запись данных в хранилище BLOB-объектов Azure в формате [Apache Avro](https://avro.apache.org/) , а также в формате JSON. Возможность кодирования формата JSON в целом доступна во всех регионах, где доступен центр Интернета вещей. По умолчанию используется AVRO. Формат кодирования можно задать только при настройке конечной точки хранилища BLOB-объектов. Формат не может быть изменен для существующей конечной точки. При использовании кодировки JSON необходимо задать для contentType значение JSON и contentEncoding в кодировке UTF-8 в [свойствах системы](iot-hub-devguide-routing-query-syntax.md#system-properties)сообщений. Если этот параметр не задан, центр Интернета вещей будет записывать сообщения в формате Base 64. Вы можете выбрать формат кодировки с помощью центра Интернета вещей создание или обновление REST API, в частности [раутингсторажеконтаинерпропертиес](https://docs.microsoft.com/rest/api/iothub/iothubresource/createorupdate#routingstoragecontainerproperties), портал Azure, [Azure CLI](https://docs.microsoft.com/cli/azure/iot/hub/routing-endpoint?view=azure-cli-latest)или [Azure PowerShell](https://docs.microsoft.com/powershell/module/az.iothub/add-aziothubroutingendpoint?view=azps-1.3.0). На следующей схеме показано, как выбрать формат кодировки в портал Azure.

![Кодирование конечной точки хранилища BLOB-объектов](./media/iot-hub-devguide-messages-d2c/blobencoding.png)

Центр Интернета вещей также поддерживает маршрутизацию сообщений в учетные записи ADLS 2-го поколения, которые являются иерархическими учетными записями хранения с поддержкой [пространств имен](https://docs.microsoft.com/azure/storage/blobs/data-lake-storage-namespace), созданными на основе хранилища BLOB-объектов. Эта возможность доступна в общедоступной предварительной версии и доступна для новых учетных записей ADLS 2-го поколения в западной части США 2 и западной центральной части США. Мы вскоре рассмотрим эту возможность для всех облачных регионов.

Центр Интернета вещей собирает сообщения и записывает данные в большой двоичный объект при каждом достижении определенного размера пакета или после истечения отведенного времени. По умолчанию Центр Интернета вещей использует следующее соглашение об именовании файлов:

```
{iothub}/{partition}/{YYYY}/{MM}/{DD}/{HH}/{mm}
```

Вы можете применять любое соглашение об именовании файлов, однако необходимо использовать все перечисленные токены. Центр Интернета вещей будет записывать пустой большой двоичный объект, если нет данных для записи.

При маршрутизации к хранилищу BLOB-объектов мы рекомендуем включить большие двоичные объекты в список, а затем выполнять перебор по ним, чтобы обеспечить считывание всех контейнеров независимо от секции. Диапазон секций может измениться в процессе [инициированной корпорацией Майкрософт отработки отказа](iot-hub-ha-dr.md#microsoft-initiated-failover) или при [переходе на другой ресурс вручную](iot-hub-ha-dr.md#manual-failover-preview) с помощью Центра Интернета вещей. Для перечисления списка больших двоичных объектов можно использовать [API List blobs](https://docs.microsoft.com/rest/api/storageservices/list-blobs) . Ознакомьтесь со следующим примером в качестве руководства.

   ```csharp
        public void ListBlobsInContainer(string containerName, string iothub)
        {
            var storageAccount = CloudStorageAccount.Parse(this.blobConnectionString);
            var cloudBlobContainer = storageAccount.CreateCloudBlobClient().GetContainerReference(containerName);
            if (cloudBlobContainer.Exists())
            {
                var results = cloudBlobContainer.ListBlobs(prefix: $"{iothub}/");
                foreach (IListBlobItem item in results)
                {
                    Console.WriteLine(item.Uri);
                }
            }
        }
   ```

### <a name="service-bus-queues-and-service-bus-topics"></a>Очереди и разделы служебной шины

Для очередей и разделов служебной шины, которые используются как конечные точки Центра Интернета вещей, **сеансы** или **поиск повторяющихся данных** должны быть выключены. Если одна из этих возможностей включена, на портале Azure конечная точка будет отображаться как **недоступная**.

### <a name="event-hubs"></a>Концентраторы событий

Помимо конечной точки, совместимой со встроенными Центрами событий, вы также можете направлять данные в пользовательские конечные точки типа Центров событий. 

## <a name="reading-data-that-has-been-routed"></a>Чтение маршрутизированных данных

Вы можете настроить маршрут, следуя инструкциям в [этом руководстве](tutorial-routing.md).

В следующих руководствах вы узнаете, как читать сообщения из конечной точки.

* Считывание данных из [встроенной конечной точки](quickstart-send-telemetry-node.md).

* Считывание данных из [хранилища BLOB-объектов](../storage/blobs/storage-blob-event-quickstart.md).

* Считывание данных из [Центров событий](../event-hubs/event-hubs-dotnet-standard-getstarted-send.md).

* Считывание данных из [очередей служебной шины](../service-bus-messaging/service-bus-dotnet-get-started-with-queues.md).

* Считывание данных из [разделов служебной шины](https://docs.microsoft.com/azure/service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions).

## <a name="fallback-route"></a>Резервный маршрут

Резервный маршрут позволяет отправить все сообщения, которые не соответствуют условиям запроса на любом из имеющихся маршрутов, ко встроенным Центрам событий ( **/messages/events**), совместимым со службой [Центры событий](/azure/event-hubs/). Если маршрутизация сообщений включена, вы можете включить возможность резервного маршрута. После создания маршрута данные перестают передаваться во встроенную конечную точку, если только маршрут не создан для этой конечной точки. Если маршруты ко встроенной конечной точке отсутствуют и резервный маршрут включен, на встроенную конечную точку будут отправляться только те сообщения, которые не соответствуют каким-либо условиям запроса для маршрутов. Кроме того, если удалить имеющиеся маршруты, необходимо включить резервный маршрут, чтобы все данные поступали на встроенную конечную точку.

Вы можете включить или отключить резервный маршрут в колонке "портал Azure-> маршрутизация сообщений". Вы также можете использовать Azure Resource Manager, чтобы свойства [FallbackRouteProperties](/rest/api/iothub/iothubresource/createorupdate#fallbackrouteproperties) использовали пользовательскую конечную точку для резервного маршрута.

## <a name="non-telemetry-events"></a>События без использования телеметрии

Помимо данных телеметрии функция маршрутизации сообщений также позволяет отправлять события изменения двойников устройств и события жизненного цикла устройства. Например, при создании маршрута с источником данных со значением **события изменения двойников устройства** Центр Интернета вещей отправляет сообщения на конечную точку, содержащую изменения двойника устройства. Аналогично, если маршрут создается с источником данных со значением **события жизненного цикла устройства**, Центр Интернета вещей будет отправлять сообщения, указывающие, было ли удалено или создано устройство. 

[Центр Интернета вещей также интегрируется со службой "Сетка событий Azure](iot-hub-event-grid.md) " для публикации событий устройств для поддержки интеграции и автоматизации рабочих процессов в режиме реального времени на основе этих событий. Ознакомьтесь с основными различиями [между маршрутизацией сообщений и Сеткой событий](iot-hub-event-grid-routing-comparison.md), чтобы узнать, какой вариант подходит вам больше.

## <a name="testing-routes"></a>Тестирование маршрутов

При создании маршрута или изменении имеющегося маршрута необходимо проверить запрос маршрута, отправив пример сообщения. Вы можете протестировать отдельные маршруты или проверить все маршруты за один раз и не отправлять сообщения на конечные точки во время теста. Для тестирования можно использовать портал Azure, Azure Resource Manager, Azure PowerShell и Azure CLI. Результаты помогают определить, соответствует ли образец сообщения запросу, сообщение не совпало с запросом, или тест не удалось выполнить, так как образец сообщения или синтаксис запроса неверны. Дополнительные сведения см. в статьях о [проверке маршрута](/rest/api/iothub/iothubresource/testroute) и [проверке всех маршрутов](/rest/api/iothub/iothubresource/testallroutes).

## <a name="latency"></a>Задержка

При маршрутизации сообщений телеметрии, передаваемой с устройства в облако с помощью встроенных конечных точек наблюдается небольшое увеличение общей задержки после создания первого маршрута.

В большинстве случаев среднее увеличение задержки составляет менее 500 мс. Вы можете отслеживать задержки с помощью метрики Центра Интернета вещей **Routing: message latency for messages/events** (Маршрутизация: задержка сообщений для messages/events) или **d2c.endpoints.latency.builtIn.events**. Последующее создание или удаление любого маршрута не влияет на общую задержку.

## <a name="monitoring-and-troubleshooting"></a>Мониторинг и устранение неполадок

Центр Интернета вещей предоставляет несколько метрик, связанных с маршрутизацией и конечными точками, которые позволяют получить представление о работоспособности центра и отправленных сообщений. Вы можете объединить данные из нескольких метрик, чтобы определить первопричину проблем. Например, используйте маршрутизацию метрики **: сообщения телеметрии, удаленные** или **D2C. телеметрии.** исходящие. удаляется для указания количества сообщений, которые были удалены, если они не совпали с запросами на любом из маршрутов и резервном маршруте. В [этой статье](iot-hub-metrics.md) представлены все метрики, включенные по умолчанию для Центра Интернета вещей.

Для получения [состояния работоспособности](iot-hub-devguide-endpoints.md#custom-endpoints) конечных точек можно использовать REST API [получить работоспособность конечной точки](https://docs.microsoft.com/rest/api/iothub/iothubresource/getendpointhealth#iothubresource_getendpointhealth) . Мы рекомендуем использовать [метрики центра Интернета вещей](iot-hub-metrics.md) , связанные с задержкой сообщений маршрутизации, чтобы выявление и отладка ошибок при неработоспособности или неисправности конечной точки. Например, для концентраторов событий типа конечной точки можно отслеживать **D2C. Endpoints. задержка. eventHubs**. Состояние неработоспособной конечной точки будет обновлено до работоспособного, если центр Интернета вещей установил состояние работоспособности в конечном итоге.

Используя журналы диагностики **маршрутов** в Azure Monitor [параметры диагностики](../iot-hub/iot-hub-monitor-resource-health.md), можно отвести наблюдение за ошибками, возникающими во время оценки запроса маршрутизации и работоспособности конечной точки, как показано в центре Интернета вещей, например, когда конечная точка недоступна. Эти журналы диагностики можно отправлять в журналы Azure Monitor, концентраторы событий или службу хранилища Azure для пользовательской обработки.

## <a name="next-steps"></a>Следующие шаги

* Дополнительные сведения о создании маршрутов сообщений см. в статье [Руководство. Настройка маршрутизации сообщений с Центром Интернета вещей](tutorial-routing.md).

* [Краткое руководство. Отправка данных телеметрии с устройства в Центр Интернета вещей и чтение данных телеметрии из центра с помощью внутреннего приложения (Node.js)](quickstart-send-telemetry-node.md)

* Дополнительные сведения о пакетах SDK, которые можно использовать для отправки сообщений с устройства в облако, см. в статье, посвященной [пакетам SDK для Azure IoT](iot-hub-devguide-sdks.md).
