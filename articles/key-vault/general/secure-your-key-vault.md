---
title: Безопасный доступ к хранилищу ключей
description: Модель доступа для Azure Key Vault, включая Active Directory проверки подлинности и конечных точек ресурсов.
services: key-vault
author: ShaneBala-keyvault
manager: ravijan
tags: azure-resource-manager
ms.service: key-vault
ms.subservice: general
ms.topic: conceptual
ms.date: 05/11/2020
ms.author: sudbalas
ms.openlocfilehash: 9516a32e89b9ad671cf705c8f520c73e28801c19
ms.sourcegitcommit: 32c521a2ef396d121e71ba682e098092ac673b30
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2020
ms.locfileid: "91320597"
---
# <a name="secure-access-to-a-key-vault"></a>Безопасный доступ к хранилищу ключей

Azure Key Vault — это облачная служба, которая обеспечивает защиту ключей шифрования и секретов (например, сертификатов, строк подключения и паролей). Так как это критически важные для бизнеса конфиденциальные данные, следует обеспечить защиту доступа к хранилищу ключей, чтобы доступ могли получить только авторизованные приложения и пользователи. В этой статье содержится обзор модели доступа к Key Vault. Здесь приводится описание процессов аутентификации и авторизации, а также содержатся сведения о том, как защитить доступ к вашему хранилищу ключей.

## <a name="access-model-overview"></a>Общие сведения о модели доступа

Доступ к хранилищу ключей осуществляется с помощью двух интерфейсов: **плоскость управления** и **плоскость данных**. Плоскость управления используется для управления Key Vault. Операции в этой плоскости включают в себя создание и удаление хранилищ ключей, получение свойств Key Vault и обновление политик доступа. Плоскость данных предназначена для работы с данными, хранящимися в хранилище ключей. Вы можете добавлять, удалять и изменять ключи, секреты и сертификаты.

Чтобы получить доступ к хранилищу ключей в любой плоскости, все вызывающие объекты (пользователи или приложения) должны иметь надлежащую аутентификацию и авторизацию. Аутентификация позволяет идентифицировать вызывающую сторону. Авторизация определяет, какие операции может выполнять вызывающий объект.

Для аутентификации в обеих плоскостях используется Azure Active Directory (Azure AD). Для авторизации плоскость управления использует управление доступом на основе ролей (RBAC) Azure, а плоскость данных использует политику доступа Key Vault и Azure RBAC (Предварительная версия).

## <a name="active-directory-authentication"></a>Проверка подлинности Active Directory

При создании хранилища ключей в подписке Azure оно автоматически связывается с арендатором Azure AD этой подписки. Все вызывающие объекты в обеих плоскостях должны быть зарегистрированы в этом арендаторе, а также пройти аутентификацию, чтобы получить доступ к этому хранилищу ключей. В обоих случаях приложение может получить доступ к Key Vault двумя способами.

- **Только для приложений**: приложение представляет собой службу или фоновое задание. Это удостоверение является наиболее распространенным сценарием для приложений, которые периодически нуждаются в доступе к сертификатам, ключам или секретам из хранилища ключей. Для работы этого сценария `objectId` приложение должно быть указано в политике доступа, а `applicationId` _не_ должно быть указано или должно быть `null` .
- **Только для пользователей**. пользователь обращается к хранилищу ключей из любого приложения, зарегистрированного в клиенте. Такой доступ осуществляется с помощью Azure PowerShell и портала Azure. Чтобы этот сценарий работал, `objectId` пользователь должен быть указан в политике доступа, а параметр `applicationId` _не_ должен быть указан или должен быть `null` .
- **Приложение и пользователь** (иногда называется _составным удостоверением_): пользователь должен получить доступ к хранилищу ключей из конкретного приложения _, и_ приложение должно использовать поток проверки подлинности "от имени" (OBO) для олицетворения пользователя. Чтобы этот сценарий работал, оба параметра `applicationId` и `objectId` должны быть указаны в политике доступа. `applicationId`Определяет требуемое приложение и `objectId` определяет пользователя. В настоящее время этот параметр недоступен для плоскости данных Azure RBAC (Предварительная версия).

Во всех типах доступа приложение выполняет проверку подлинности в Azure AD. Приложения используют любой из [поддерживаемых методов аутентификации](../../active-directory/develop/authentication-scenarios.md) в зависимости от своего типа. Приложение получает маркер для ресурса в плоскости, в которой нужно предоставить доступ. Ресурс является конечной точкой в плоскости управления или данных на основе среды Azure. Приложение отправляет запрос REST API в Key Vault с использованием этого маркера. Узнайте больше о [полном потоке аутентификации](../../active-directory/develop/v2-oauth2-auth-code-flow.md).

Модель единого механизма для аутентификации в обеих плоскостях имеет некоторые преимущества:

- организации могут централизованно управлять доступом ко всем принадлежащим им хранилищам ключей;
- когда пользователь покидает организацию, он мгновенно теряет доступ ко всем этим хранилищам ключей;
- организации могут настроить аутентификацию с помощью параметров в Azure AD (например, включение многофакторной проверки подлинности для повышения безопасности).

## <a name="resource-endpoints"></a>Конечные точки ресурсов

Приложения получают доступ к плоскостям через конечные точки. Элементы управления доступом для двух плоскостей работают независимо. Чтобы предоставить приложению доступ для использования ключей в хранилище ключей, вы предоставляете доступ к плоскости данных с помощью политики доступа Key Vault или Azure RBAC (Предварительная версия). Чтобы предоставить пользователю доступ на чтение к свойствам и тегам Key Vault, но не доступ к данным (ключам, секретам или сертификатам), необходимо предоставить доступ к плоскости управления с помощью RBAC.

В следующей таблице показаны конечные точки плоскости управления и плоскости данных.

| Плоскость&nbsp;доступа | Конечные точки доступа | Операции | Механизм&nbsp;управление доступом |
| --- | --- | --- | --- |
| Плоскость управления | **Глобально:**<br> management.azure.com:443<br><br> **Azure China 21Vianet:**<br> management.chinacloudapi.cn:443<br><br> **Azure для US Gov :**<br> management.usgovcloudapi.net:443<br><br> **Azure для Германии:**<br> management.microsoftazure.de:443 | Создание, чтение, изменение и удаление хранилищ ключей<br><br>Настройка политик доступа Key Vault<br><br>Настройка тегов Key Vault | Azure RBAC |
| Плоскость данных | **Глобально:**<br> &lt;vault-name&gt;.vault.azure.net:443<br><br> **Azure China 21Vianet:**<br> &lt;vault-name&gt;.vault.azure.cn:443<br><br> **Azure для US Gov :**<br> &lt;vault-name&gt;.vault.usgovcloudapi.net:443<br><br> **Azure для Германии:**<br> &lt;vault-name&gt;.vault.microsoftazure.de:443 | Ключи: шифрование, расшифровка, wrapKey, unwrapKey, подпись, проверка, получение, перечисление, создание, обновление, импорт, удаление, восстановление, резервное копирование, восстановление, очистка<br><br> Сертификаты: манажеконтактс, поставщики, листиссуерс, сетиссуерс, делетеиссуерс, манажеиссуерс, Get, список, создание, импорт, обновление, удаление, восстановление, резервное копирование, восстановление, очистка<br><br>  Секреты: получение, перечисление, задание, удаление, восстановление, резервное копирование, восстановление, очистка | Политика доступа Key Vault или Azure RBAC (Предварительная версия)|

## <a name="management-plane-and-azure-rbac"></a>Плоскость управления и Azure RBAC

В плоскости управления вы используете управление доступом на основе ролей Azure (Azure RBAC) для авторизации операций, которые может выполнять вызывающий объект. В модели RBAC Azure каждая подписка Azure имеет экземпляр Azure AD. Вы можете предоставить доступ пользователям, группам и приложениям из этого каталога. Доступ предоставляется для управления ресурсами в подписке Azure, использующими модель развертывания Azure Resource Manager.

Вы можете создать хранилище ключей в группе ресурсов и управлять доступом с помощью Azure AD. Можно предоставить пользователям или группе возможность управлять хранилищами ключей в группе ресурсов. Вы предоставляете доступ на определенном уровне области, назначая соответствующие роли Azure. Чтобы предоставить пользователю доступ к управлению хранилищами ключей, ему необходимо назначить предопределенную роль `key vault Contributor` в определенной области. Роли Azure могут быть назначены следующие уровни областей:

- **Подписка**. роль Azure, назначенная на уровне подписки, применяется ко всем группам ресурсов и ресурсам в рамках этой подписки.
- **Группа ресурсов**. роль Azure, назначенная на уровне группы ресурсов, применяется ко всем ресурсам в этой группе ресурсов.
- **Конкретный ресурс**. роль Azure, назначенная конкретному ресурсу, применяется к этому ресурсу. В этом случае ресурс является определенным хранилищем ключей.

Есть несколько заданных по умолчанию ролей. Если заданные роли не соответствуют вашим потребностям, вы можете определить собственные. Дополнительные сведения см. в статье [Встроенные роли Azure](../../role-based-access-control/built-in-roles.md).

> [!IMPORTANT]
> Если у пользователя есть разрешения `Contributor` в плоскости управления хранилища ключей, он может предоставить себе доступ к плоскости данных, настроив политику доступа к хранилищу ключей. Следует очень внимательно контролировать, у кого есть доступ `Contributor` к вашим хранилищам ключей в рамках роли. Убедитесь, что только авторизованные лица могут получать доступ к хранилищам ключей, ключам, секретам и сертификатам, а также управлять ими.
>

<a id="data-plane-access-control"></a>
## <a name="data-plane-and-access-policies"></a>Плоскость данных и политики доступа

Доступ к плоскости данных можно предоставить, задав политики доступа Key Vault для хранилища ключей. Чтобы задать эти политики доступа, пользователь, группа или приложение должны иметь разрешения `Contributor` для плоскости управления этого хранилища ключей.

Пользователю, группе или приложению можно предоставить доступ на выполнение определенных операций с ключами или секретами в хранилище ключей. Хранилище ключей в Key Vault поддерживает до 1024 записей политики доступа. Чтобы предоставить нескольким пользователям доступ к плоскости данных, создайте группу безопасности Azure AD и добавьте в нее пользователей.

Полный список операций с хранилищем и секретами можно просмотреть здесь: [Справочник по операциям Key Vault](https://docs.microsoft.com/rest/api/keyvault/#vault-operations)

<a id="key-vault-access-policies"></a> Политики доступа к Key Vault предоставляют доступ отдельно к ключам, секретам и сертификатам.  Разрешения на доступ к ключам, секретам и сертификатам устанавливаются на уровне хранилища. 

> [!IMPORTANT]
> Политики доступа к Key Vault применяются на уровне хранилища. Если пользователю предоставлено разрешение на создание и удаление ключей, он может выполнять эти операции со всеми ключами в этом хранилище ключей.
Политика доступа к Key Vault не поддерживает детализированные разрешения на уровне объектов, таких как определенный ключ, секрет или сертификат. 
>

## <a name="data-plane-and-azure-rbac-preview"></a>Плоскость данных и Azure RBAC (Предварительная версия)

Управление доступом на основе ролей в Azure — это альтернативная модель разрешений для управления доступом к Azure Key Vault плоскости данных, которую можно включить в отдельных хранилищах ключей. Модель разрешений Azure RBAC является эксклюзивной, и один раз установлен, политики доступа к хранилищу стали неактивными. Azure Key Vault определяет набор встроенных ролей Azure, охватывающих общие наборы разрешений, используемых для доступа к ключам, секретам или сертификатам.

Когда роль Azure назначается субъекту безопасности Azure AD, Azure предоставляет доступ к этим ресурсам для этого субъекта безопасности. Доступ может быть ограничен уровнем подписки, группой ресурсов, хранилищем ключей или отдельным ключом, секретом или сертификатом. Субъект безопасности Azure AD может быть пользователем, группой, субъектом-службой приложения или [управляемым удостоверением для ресурсов Azure](../../active-directory/managed-identities-azure-resources/overview.md).

Основные преимущества использования разрешения RBAC Azure через политики доступа к хранилищу — централизованное управление доступом и интеграция с управление привилегированными пользователями (PIM). Управление привилегированными пользователями обеспечивает активацию ролей на основе времени и утверждений, чтобы снизить риски, связанные с чрезмерным, ненужным или неправильным использованием разрешений на доступ к ресурсам, которые вас интересуют.


## <a name="firewalls-and-virtual-networks"></a>Брандмауэры и виртуальные сети

Для дополнительного уровня безопасности можно настроить брандмауэры и правила виртуальной сети. Брандмауэры и виртуальные сети Key Vault можно настроить так, чтобы по умолчанию запрещать трафик из всех сетей (в том числе из Интернета). Вы можете разрешить доступ для трафика из конкретных виртуальных сетей Azure или диапазонов общедоступных IP-адресов, что позволит определить границу защищенной сети для приложений.

Ниже приведены некоторые примеры использования конечных точек службы.

* Если Key Vault используется для хранения ключей шифрования, секретов приложения и сертификатов, доступ к которым из общедоступного Интернета вы хотите запретить.
* Если вы хотите заблокировать доступ к хранилищу ключей, чтобы к нему могли подключаться только одно приложение или небольшой набор назначенных узлов.
* Если у вас есть приложение, работающее в виртуальной сети Azure, для которой заблокирован любой исходящий и входящий трафик, но приложению требуется подключение к хранилищу ключей для получения секретов, сертификатов или криптографических ключей.

> [!NOTE]
> Правила брандмауэра и виртуальной сети Key Vault применяются только к плоскости данных в Key Vault. Правила брандмауэра и виртуальной сети не влияют на операции плоскости управления Key Vault (создание, удаление, изменение хранилища ключей, настройка политик доступа, настройка правил брандмауэров и виртуальной сети).

## <a name="private-endpoint-connection"></a>Подключение к частной конечной точке

В случае необходимости полностью блокировать Key Vault открытости можно использовать закрытую конечную точку Azure. Частная конечная точка Azure — это сетевой интерфейс, который защищенно и надежно подключается к службе через Приватный канал Azure. Частная конечная точка использует частный IP-адрес из виртуальной сети, по сути перемещая службу в виртуальную сеть. Весь трафик к службе может маршрутизироваться через частную конечную точку, поэтому шлюзы, устройства преобразования сетевых адресов (NAT), подключения ExpressRoute и VPN, а также общедоступные IP-адреса не требуются. Трафик между виртуальной сетью и службой проходит через магистральную сеть Майкрософт, что позволяет избежать рисков общедоступного Интернета. Вы можете подключиться к экземпляру ресурса Azure, обеспечивая наивысшую степень детализации в управлении доступом.

Распространенные сценарии использования закрытой ссылки для служб Azure:

- **Закрытый доступ к службам на платформе Azure**: Подключайте виртуальную сеть к службам, работающим в Azure, не используя публичный IP-адрес источника или пункта назначения. Поставщики услуг могут преобразовать свои службы в собственной виртуальной сети, а потребители могут получить доступ к этим службам в своей локальной виртуальной сети. Платформа Приватного канала будет поддерживать подключение между потребителем и службами через магистральную сеть Azure. 
 
- **Локальные и одноранговые сети**: доступ к службам, выполняемым в Azure, из локальной сети через частные одноранговые или VPN-туннели ExpressRoute и одноранговые виртуальные сети с помощью закрытых конечных точек. Вам не нужно настраивать общедоступный пиринг или пересекать Интернет для доступа к службе. Приватный канал обеспечивает безопасный способ переносить рабочие нагрузки в Azure.
 
- **Защита от утечки данных**: частная конечная точка сопоставляется с экземпляром ресурса PaaS, а не со всей службой. Объекты-получатели могут подключаться только к определенному ресурсу. Доступ к любому другому ресурсу в службе блокируется. Этот механизм обеспечивает защиту от рисков утечки данных. 
 
- **Глобальный доступ**: Устанавливайте частное подключение к службам, работающим в других регионах. Виртуальная сеть объекта-получателя может находиться в регионе А и подключаться к службам за Приватным каналом в регионе В.  
 
- **Расширьте свои собственные службы**: Воспользуйтесь теми же возможностями и функциональностью, чтобы преобразовать для частного просмотра службу объектам-получателям в Azure. Разместив свою службу за Azure Load Balancer уровня "Стандартный", вы можете включить его для Приватного канала. Затем объект-получатель может подключиться непосредственно к службе с помощью закрытой конечной точки в собственной виртуальной сети. Вы можете управлять этими запросами на подключение, используя поток вызова утверждения. Приватный канал Azure работает для объектов-получателей и служб, принадлежащих к разным клиентам Azure Active Directory. 

## <a name="example"></a>Пример

В этом примере мы разрабатываем приложение, которое использует сертификат для TLS/SSL, службу хранилища Azure для хранения данных и ключ RSA 2 048-bit для шифрования данных в службе хранилища Azure. Это приложение выполняется на виртуальной машине Azure (или в масштабируемом наборе виртуальных машин). Мы можем использовать хранилище ключей, чтобы хранить секреты приложения. Мы можем сохранить сертификат начальной загрузки, используемый приложением для аутентификации в Azure AD.

Нам нужен доступ к следующим сохраненным ключам и секретам:
- **TLS/SSL-сертификат**. Используется для протоколов TLS/SSL.
- **Ключ хранилища**. Используется для доступа к учетной записи хранения.
- **RSA 2 048-разрядный ключ**: используется для переноса и распаковки ключей шифрования данных службой хранилища Azure.
- **Управляемое приложением удостоверение**: используется для проверки подлинности в Azure AD. После предоставления доступа к Key Vault приложение может получить ключ и сертификат хранилища.

Нам необходимо определить следующие роли, чтобы указать, кто может развертывать и проверять наше приложение, а также управлять им.
- **Группа безопасности.** Это ИТ-специалисты из отдела руководителя службы безопасности или аналогичного ему. Служба безопасности несет ответственность за надлежащее хранение секретов. Секреты могут включать сертификаты TLS/SSL, ключи RSA для шифрования, строки подключения и ключи учетной записи хранения.
- **Разработчики и операторы**. Сотрудники, которые разрабатывают приложение и развертывают его в Azure. Участники этой команды не являются сотрудниками службы безопасности. Они не должны иметь доступа к конфиденциальным данным, таким как сертификаты TLS/SSL и ключи RSA. Только развертываемое ими приложение должно иметь доступ к конфиденциальным данным.
- **Аудиторы.** Эта роль предназначена для участников, не являющихся сотрудниками отдела разработки или общего ИТ-персонала. Они проверяют надлежащее использование и обслуживание сертификатов, ключей и секретов, а также обеспечивают соответствие стандартам безопасности данных.

Существует другая роль, которая выходит за рамки нашего приложения. Это администратор подписки (или группы ресурсов). Администратор подписки устанавливает начальные права доступа для группы безопасности. Он предоставляет ей доступ с помощью группы ресурсов, которая содержит ресурсы, необходимые для этого приложения.

Нам необходимо авторизовать для наших ролей следующие операции.

**Группа безопасности:**
- создание хранилищ ключей;
- включение ведения журнала Key Vault;
- добавление ключей и секретов;
- создание резервной копии ключей для аварийного восстановления;
- Задайте политики доступа Key Vault и назначьте роли для предоставления разрешений пользователям и приложениям для выполнения конкретных операций.
- периодическое развертывание ключей и секретов.

**Разработчики и операторы:**
- Получите ссылки от группы безопасности для сертификатов начальной загрузки и TLS/SSL (отпечатков), ключа хранилища (URI секрета) и ключа RSA (URI ключа) для переноса и распаковки.
- Разрабатывайте и развертывайте приложения для доступа к сертификатам и секретам программным способом.

**Аудиторы:**
- просмотр журналов Key Vault для подтверждения правильного применения ключей или секретов и соответствия стандартам безопасности данных.

В следующей таблице приведены разрешения доступа для наших ролей и приложения.

| Роль | Разрешения плоскости управления | Разрешения плоскости данных — политики доступа к хранилищу | Разрешения плоскости данных — Azure RBAC (Предварительная версия)  |
| --- | --- | --- | --- |
| Группа безопасности | Участник Key Vault | Сертификаты: все операции <br> Ключи: все операции <br> Секреты: все операции | Администратор Key Vault (Предварительная версия) |
| Разработчики и&nbsp;операторы | Разрешение на развертывание Key Vault<br><br> **Примечание.** Это разрешение позволяет развернутым виртуальным машинам получать секреты из хранилища ключей. | None | None |
| Аудиторы | None | Сертификаты: список <br> Ключи: перечисление<br>Секреты: перечисление<br><br> **Примечание.** Это разрешение позволяет аудиторам проверять атрибуты (теги, даты активации, даты истечения срока действия) ключей и секретов, которые не отправляются в журналы. | Читатель Key Vault (Предварительная версия) |
| Учетная запись хранения Azure | None | Ключи: Get, List, wrapKey, unwrapKey <br> | Key Vault шифрование службы шифрования |
| Приложение | None | Секреты: Get, List <br> Сертификаты: Get, List | Читатель Key Vault (Предварительная версия), Key Vault пользователя секрета (Предварительная версия) |

Трем ролям группы требуется доступ к другим ресурсам вместе с разрешениями Key Vault. Для развертывания виртуальных машин (или компонента "веб-приложения" службы приложений Azure) разработчикам и операторам требуется развернуть доступ. Аудиторам требуется доступ на чтение к учетной записи хранения, где хранятся журналы Key Vault.

В этом примере показан простой сценарий. Реальные сценарии могут быть более сложными. Вы можете настроить разрешения для хранилища ключей в соответствии со своими потребностями. Предположим, что группа безопасности предоставляет ссылки на ключ и секрет (URI и отпечатки), которые команда DevOps использует в своих приложениях. Разработчикам и операторам не требуется доступ к плоскости данных. Эта статья была посвящена вопросам, связанным с безопасностью хранилища ключей.

> [!NOTE]
> В этом примере показано, как доступ к Key Vault будет заблокирован в рабочей среде. У разработчиков должна быть своя подписка или группа ресурсов с полным набором разрешений на управление своими хранилищами, виртуальными машинами, а также учетная запись хранения, в которой они разрабатывают приложения.

## <a name="resources"></a>Ресурсы

* [Управление привилегированными пользователями](../../active-directory/privileged-identity-management/pim-configure.md)

## <a name="next-steps"></a>Дальнейшие действия

[Проверка подлинности в Azure Key Vault](authentication.md)

[Назначение политики доступа Key Vault](assign-access-policy-portal.md)

[Назначение роли Azure доступа к ключам, секретам и сертификатам](rbac-guide.md)

[Настройка брандмауэров Key Vault и виртуальных сетей](network-security.md)

[Установите подключение к частной ссылке для Key Vault](private-link-service.md)
