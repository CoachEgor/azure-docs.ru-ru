---
title: Проверка подлинности в Azure Key Vault
description: Узнайте, как выполнять проверку подлинности в Azure Key Vault
author: ShaneBala-keyvault
ms.author: sudbalas
ms.date: 06/08/2020
ms.service: key-vault
ms.subservice: general
ms.topic: how-to
ms.openlocfilehash: 6336a0d4d8aa9c781befed0470d9a190af5aa9eb
ms.sourcegitcommit: 62e1884457b64fd798da8ada59dbf623ef27fe97
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2020
ms.locfileid: "88930865"
---
# <a name="authenticate-to-azure-key-vault"></a>Проверка подлинности в Azure Key Vault

## <a name="overview"></a>Обзор

Azure Key Vault — это решение для управления секретами, которое позволяет централизовать хранение секретов приложений и управлять их распространением. Azure Key Vault избавляет от необходимости хранить учетные данные в приложениях. Приложение может пройти проверку подлинности в хранилище ключей для получения необходимых учетных данных. В этом документе рассматриваются основные принципы проверки подлинности в хранилище ключей.

Этот документ поможет вам понять суть процесса проверки подлинности в хранилище ключей. Здесь объясняется принцип действия потока проверки подлинности и предоставления доступа к хранилищу ключей. Кроме того, этот документ содержит учебник по извлечению секрета, хранимого в хранилище ключей, из примера приложения Python.

Этот документ состоит из следующих разделов:

* Основные понятия
* Регистрация субъекта безопасности
* Общие сведения о потоке проверки подлинности Key Vault
* Предоставление субъекту-службе доступа к Key Vault
* Учебник (Python)

## <a name="key-concepts"></a>Основные понятия

### <a name="azure-active-directory-concepts"></a>Основные понятия Azure Active Directory

* Azure Active Directory (Azure AD) — это облачная служба Майкрософт для управления удостоверениями и доступом. Она помогает вашим сотрудникам входить в систему и получать доступ к ресурсам.

* Определение роли — это коллекция разрешений.  AAD имеет стандартные роли (владельца, участника или читателя) с определенными уровнями разрешений для выполнения таких операций, как чтение, запись и удаление ресурса Azure. Роли также могут быть пользовательскими определениями, созданными пользователями с конкретными детализированными разрешениями.

* Регистрация приложения — при регистрации приложения Azure AD в клиенте Azure AD создаются два объекта: приложение и субъект-служба. В некотором роде объект-приложение является глобальным представлением вашего приложения (для использования во всех клиентах), а субъект-служба — локальным (для использования в определенных клиентах).

### <a name="security-principal-concepts"></a>Основные понятия с точки зрения субъекта безопасности

* Субъект безопасности — это объект, представляющий пользователя, группу, субъект-службу или управляемое удостоверение, которые запрашивают доступ к ресурсам Azure.

* Пользователь — человек, имеющий профиль в Azure Active Directory.

* Группа — набор пользователей, созданный в Azure Active Directory. При назначении роли группе ее получают все пользователи в этой группе.

* Субъект-служба — это идентификатор безопасности, который используется приложениями или службами для доступа к определенным ресурсам Azure. Это что-то вроде удостоверения пользователя (имя пользователя и пароль или сертификат) для приложения.

* Управляемое удостоверение — это удостоверение, управление которым осуществляется автоматически в Azure Active Directory.

* Идентификатор объекта (Идентификатор клиента) — уникальный идентификатор, созданный с помощью Azure AD, который связан с субъектом-службой на этапе начальной подготовки.

## <a name="security-principal-registration"></a>Регистрация субъекта безопасности

1. Администратор регистрирует пользователя или приложение (субъект-службу) в Azure Active Directory.

2. Администратор создает Azure Key Vault и настраивает политики доступа (ACL).

3. (Необязательно.) Администратор настраивает брандмауэр Azure Key Vault.

![IMAGE](../media/authentication-1.png)

## <a name="understand-the-key-vault-authentication-flow"></a>Общие сведения о потоке проверки подлинности Key Vault

1. Субъект-служба выполняет вызов для проверки подлинности в AAD. Она может осуществляться несколькими способами:
    * пользователь может войти на портал Azure, используя имя пользователя и пароль;
    * приложение может использовать идентификатор клиента и представить его секрет или сертификат в AAD;
    * ресурсу Azure, например виртуальной машине, может быть назначен MSI, и он может обращаться к конечной точке IMDS REST для получения маркера доступа.

2. Если проверка подлинности в AAD выполнена успешно, субъекту-службе будет предоставлен маркер OAuth.
3. Субъект-служба выполняет вызов Key Vault.
4. Брандмауэр Azure Key Vault определяет, разрешать ли вызов.
    * Сценарий 1. Брандмауэр Key Vault отключен, общедоступная конечная точка (URI) хранилища ключей доступна из общедоступного Интернета. Вызов разрешен.
    * Сценарий 2. Вызывающий объект является доверенной службой Azure Key Vault. Если выбран этот параметр, определенные службы Azure могут обходить брандмауэр хранилища ключей. [Список доверенных служб Azure Key Vault](https://docs.microsoft.com/azure/key-vault/general/overview-vnet-service-endpoints#trusted-services)
    * Сценарий 3. Вызывающий объект указан в брандмауэре Azure Key Vault в виде IP-адреса, виртуальной сети или конечной точки службы.
    * Сценарий 4. Вызывающий объект может достичь Azure Key Vault через настроенное подключение к приватному каналу.
    * Сценарий 5. Вызывающий объект не авторизован, и ему возвращается ответ forbidden.
5. Key Vault выполняет вызов AAD для проверки маркера доступа субъекта-службы.
6. Key Vault проверяет, имеет ли субъект-служба достаточные разрешения в политике доступа для выполнения запрошенной операции. В этом примере операция — это получение секрета.
7. Key Vault предоставляет секрет субъекту-службе.

![IMAGE](../media/authentication-2.png)

## <a name="grant-a-service-principal-access-to-key-vault"></a>Предоставление субъекту-службе доступа к Key Vault

1. Если у вас еще нет субъекта-службы, создайте его. [Создание субъекта-службы](https://docs.microsoft.com/azure/active-directory/develop/howto-create-service-principal-portal)
2. Добавьте назначение роли в субъект-службу в настройках IAM хранилища Azure Key Vault. Вы можете добавить предварительно назначенные роли (владельца, участника или читателя). Вы также можете создать настраиваемые роли для субъекта-службы. При этом вы должны следовать принципу минимальных привилегий и предоставить субъекту-службе доступ только в минимально необходимом объеме. 
3.  Настройте брандмауэр хранилища ключей. Вы можете отключить брандмауэр хранилища ключей и разрешить доступ из общедоступного Интернета (менее безопасно, но легче в настройке). Вы также можете ограничить доступ к определенным диапазонам IP-адресов, конечным точкам службы, виртуальным сетям или частным конечным точкам (более безопасно).
4.  Добавьте политику доступа для субъекта-службы. Это список операций, которые может выполнять субъект-служба в хранилище ключей. Следует использовать субъект с минимальными правами доступа и ограничить операции, которые может выполнять субъект-служба. Однако, если не предоставить субъекту-службе достаточные разрешения, ему будет отказано в доступе.

## <a name="tutorial"></a>Учебник

Из этого учебника вы узнаете, как настроить субъект-службу для проверки подлинности в хранилище ключей и получить секрет. 

### <a name="part-1--create-a-service-principal-in-the-azure-portal"></a>Часть 1.  Создание субъекта-службы с помощью портала Azure

1. Войдите на портал Azure.
1. Выполните поиск по запросу Azure Active Directory.
1. Перейдите на вкладку "Регистрация приложений".
1. Щелкните "+ Новая регистрация".
1. Создайте имя для субъекта-службы.
1. Нажмите "Зарегистрироваться".

На этом этапе у вас есть зарегистрированный субъект-служба. Его можно просмотреть, выбрав вкладку "Регистрация приложений". Теперь субъекту-службе будет назначен уникальный идентификатор клиента (GUID). Его можно считать "именем пользователя" для субъекта-службы. Теперь необходимо создать "пароль" для субъекта-службы. Для этого можно использовать секрет клиента или сертификат клиента. Обратите внимание, что секрет клиента для проверки подлинности не является безопасным и должен использоваться только в целях тестирования. В этом учебнике показано, как использовать сертификат клиента.

### <a name="part-2-create-a-client-certificate-for-your-service-principal"></a>Часть 2. Создание сертификата клиента для субъекта-службы

1. Создание сертификата

    * Вариант 1. Создание сертификата с помощью [OpenSSL](https://www.openssl.org/) (только для тестирования, не используйте самозаверяющие сертификаты в рабочей среде)
    * Вариант 2. Создание сертификата в хранилище ключей. [Создайте сертификат в Azure Key Vault](https://docs.microsoft.com/azure/key-vault/certificates/certificate-scenarios#creating-your-first-key-vault-certificate).

1. Скачивание сертификата в формате PEM/PFX
1. Выполните вход на портал Azure и перейдите к разделу Azure Active Directory.
1. Щелкните "Регистрация приложений".
1. Выберите субъект-службу, созданный в части 1.
1. Щелкните вкладку "Сертификаты и Секреты" субъекта-службы.
1. Отправьте сертификат с помощью кнопки "Загрузить сертификат".

### <a name="part-3-configure-an-azure-key-vault"></a>Часть 3. Настройте Azure Key Vault.

1. Создайте [ссылку](https://docs.microsoft.com/azure/key-vault/secrets/quick-create-portal#create-a-vault) на Azure Key Vault.

2. Настройте разрешения IAM для Key Vault.
    1. Перейдите в хранилище ключей.
    1. Выберите вкладку "Управление доступом (IAM)".
    1. Выберите "Добавить назначение ролей".
    1. Выберите из раскрывающегося списка роль "Участник".
    1. Введите имя или идентификатор клиента для созданного субъекта-службы.
    1. Щелкните "Просмотр назначений ролей" и убедитесь, что субъект-служба указан.

3. Настройте разрешения политики доступа для Key Vault.
    1. Перейдите в хранилище ключей.
    1. В разделе "Параметры" выберите вкладку "Политики доступа".
    1. Выберите ссылку "+ Добавить политику доступа".
    1. В раскрывающемся списке "Разрешения секретов" проверьте разрешения "Получение" и "Перечисление".
    1. Выберите субъект-службу по имени или идентификатору клиента.
    1. Выберите "Добавить".
    1. Щелкните "Сохранить".

4. Создайте секрет в хранилище ключей.
    1. Перейдите в хранилище ключей.
    1. В разделе "Параметры" перейдите на вкладку "Секреты".
    1. Щелкните "+ Создать/Импортировать".
    1. Создайте имя секрета. В этом примере секрет будет иметь имя "test".
    1. Создайте значение для секрета. В этом примере будет установлено значение "password123".

Теперь при запуске кода с локального компьютера можно пройти проверку подлинности в хранилище ключей, получив маркер доступа, указав идентификатор клиента и путь к сертификату.

### <a name="part-4-retrieve-the-secret-from-your-azure-key-vault-in-an-application-python"></a>Часть 4. Получение секрета из Azure Key Vault в приложении (Python)

Используйте следующий пример кода, чтобы проверить, может ли приложение получить секрет из хранилища ключей с помощью настроенного субъекта-службы. 

```python
from azure.keyvault.secrets import SecretClient
from azure.identity import CertificateCredential


tenant_id = ""                                             ##ENTER AZURE TENANT ID
vault_url = "https://{VAULT NAME}.vault.azure.net/"        ##ENTER THE URL OF YOUR KEY VAULT
client_id = ""                                             ##ENTER CLIENT ID OF SERVICE PRINCIPAL
cert_path = r"C:\Users\{USERNAME}\{PATH}\{CERT_NAME}.pem"  ##ENTER PATH TO CERTIFICATE

def main():

    #AUTHENTICATION TO AAD USING CLIENT ID AND CLIENT CERTIFICATE
    token = CertificateCredential(tenant_id= tenant_id, client_id=client_id, certificate_path=cert_path)

    #AUTHENTICATION TO KEY VAULT PRESENTING AAD TOKEN
    client = SecretClient(vault_url=vault_url, credential=token)

    #CALL TO KEY VAULT TO GET SECRET
    secret = client.get_secret('{SECRET_NAME}')            ##ENTER NAME OF SECRET IN KEY VAULT

    #GET PLAINTEXT OF SECRET
    print(secret.value)

#CALL MAIN()
if __name__ == "__main__":
    main()
```

![IMAGE](../media/authentication-3.png)


## <a name="next-steps"></a>Next Steps

1. Узнайте, как устранять неполадки при проверке подлинности в хранилище ключей. [Руководство по устранению неполадок в Azure Key Vault](https://docs.microsoft.com/azure/key-vault/general/rest-error-codes)
