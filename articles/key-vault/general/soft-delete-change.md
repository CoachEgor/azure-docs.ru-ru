---
title: Включение обратимого удаления во всех хранилищах Azure Key Vaults | Документация Майкрософт
description: Этот документ поможет внедрить обратимое удаление для всех хранилищ ключей.
services: key-vault
author: ShaneBala-keyvault
manager: ravijan
tags: azure-resource-manager
ms.service: key-vault
ms.subservice: general
ms.topic: conceptual
ms.date: 07/27/2020
ms.author: sudbalas
ms.openlocfilehash: bf758a07cff248fc0da3f279e68a14e88797e382
ms.sourcegitcommit: bdd5c76457b0f0504f4f679a316b959dcfabf1ef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/22/2020
ms.locfileid: "90984597"
---
# <a name="soft-delete-will-be-enabled-on-all-key-vaults"></a>Включение обратимого удаления во всех хранилищах ключей

> [!WARNING]
> **Критическое изменение.** Возможность отказаться от обратимого удаления устареет к концу года, и защита с помощью обратимого удаления будет автоматически включена для всех хранилищ ключей.  Пользователи и администраторы Azure Key Vault должны немедленно включить обратимое удаление для хранилищ ключей.
>
> Для управляемого устройства HSM обратимое удаление включено по умолчанию и его нельзя отключить.

Если секрет удаляется из хранилища ключей без защиты с помощью обратимого удаления, он удаляется окончательно. В настоящее время пользователи могут отказаться от обратимого удаления во время создания хранилища ключей. Однако, чтобы защитить секреты от случайного или намеренного вредоносного удаления пользователем, корпорация Майкрософт в скором времени включит защиту с помощью обратимого удаления во **всех** хранилищах ключей и пользователи больше не смогут отказаться или отключить его.

:::image type="content" source="../media/softdeletediagram.png" alt-text="<alt text>":::

Дополнительные сведения о функции обратимого удаления см. в [этой статье](soft-delete-overview.md).

## <a name="how-do-i-respond-to-breaking-changes"></a>Как реагировать на критические изменения

Объект хранилища ключей не может быть создан с тем же именем, что и объект хранилища ключей, который находится в состоянии обратимого удаления.  Например, если вы удалите ключ с именем `test key` в хранилище ключей A, вы не сможете создать ключ с именем `test key` в хранилище ключей A до тех пор, пока обратимо удаленный объект `test key` не будет удален окончательно.

### <a name="application-changes"></a>Изменения приложений

Если в приложении предполагается, что обратимое удаление не включено, и ожидается, что удаленные секреты или имена хранилищ ключей будут доступны для немедленного повторного использования, логике приложения потребуется внести приведенные ниже изменения, чтобы принять это изменение.

1. Удалить исходное хранилище ключей или секрет.
2. Очистить хранилище ключей или секрет в состоянии обратимого удаления.
3. Подождать некоторое время (немедленное восстановление может привести к конфликту).
4. Повторно создать хранилище ключей с тем же именем.
5. Реализовать повторную попытку, если операция создания все еще приводит к ошибке из-за конфликта имен. В самом худшем случае для обновления записей DNS может потребоваться до 10 минут.

### <a name="administration-changes"></a>Изменения администрирования

Субъектам безопасности, которым необходим доступ для окончательного удаления секретов, должны быть предоставлены дополнительные разрешения политики доступа для очистки этих секретов и хранилища ключей.

Если в хранилищах ключей есть Политика Azure, которая требует отключить обратимое удаление, эту политику необходимо будет отключить.  Вам может потребоваться передать эту проблему администратору, который контролирует Политики Azure, применяемые к среде. Если эта политика не отключена, вы можете потерять возможность создавать хранилища ключей в области применяемой политики.

Если организация подчиняется нормативно-правовому соответствию и не может позволить удаленным хранилищам ключей и секретам в течение длительного периода времени оставаться в состоянии, допускающем восстановление, вам придется настроить период хранения обратимого удаления (который настраивается в пределах 7–90 дней), чтобы соответствовать стандартам организации.

## <a name="procedures"></a>Процедуры

### <a name="audit-your-key-vaults-to-check-if-soft-delete-is-enabled"></a>Выполнение аудита хранилищ ключей для проверки включения обратимого удаления

1. Войдите на портал Azure.
2. Выполните поиск по запросу "Политика Azure".
3. Выберите "Определения".
4. В разделе "Категория" в фильтре выберите Key Vault.
5. Выберите политику "Объекты Key Vault должны быть восстанавливаемыми".
6. Щелкните "Назначить".
7. Настройте область подписки.
8. Выберите "Просмотр и создание".
9. Полное сканирование среды может занять до 24 часов.
10. В колонке "Политика Azure" щелкните "Соответствие".
11. Выберите примененную политику.

Теперь вы сможете применять фильтрацию и видеть, в каких хранилищах ключей включено обратимое удаление (соответствующие ресурсы), а в каких хранилищах ключей не включена эта функция (несоответствующие ресурсы).

### <a name="turn-on-soft-delete-for-an-existing-key-vault"></a>Включение обратимого удаления для имеющегося хранилища ключей

1. Войдите на портал Azure.
2. Найдите Key Vault.
3. В разделе "Параметры" выберите "Свойства".
4. В разделе "Обратимое удаление" установите переключатель, соответствующий параметру "Включить восстановление этого хранилища и его объектов".
5. Настройте срок хранения для обратимого удаления.
6. Щелкните "Сохранить".

### <a name="grant-purge-access-policy-permissions-to-a-security-principal"></a>Предоставление субъекту безопасности разрешения политики доступа на очистку

1. Войдите на портал Azure.
2. Найдите Key Vault.
3. В разделе "Параметры" выберите "Политики доступа".
4. Выберите субъект-службу, которому хотите предоставить доступ.
5. В каждом раскрывающемся списке для ключа, секрета и разрешений сертификата прокрутите вниз до параметра Privileged Operations (Привилегированные операции) и выберите разрешение "Очистить".

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="does-this-change-affect-me"></a>Повлияет ли это изменение на работу?

Если у вас уже включено обратимое удаление или вы не удаляете и не воссоздаете объекты хранилища ключей с тем же именем, вы, скорее всего, не заметите никаких изменений в работе хранилища ключей.

Если у вас есть приложение, которое часто удаляет и воссоздает объекты хранилища ключей с одинаковыми соглашениями об именовании, вам придется вносить изменения в логику приложения, чтобы поддерживать ожидаемое поведение. См. раздел выше "Как реагировать на критические изменения".

### <a name="how-do-i-benefit-from-this-change"></a>Каковы преимущества этого изменения?

Функция обратимого удаления предоставит организации дополнительный уровень защиты от случайного или злонамеренного удаления. Как администратор хранилища ключей вы можете ограничить доступ как к разрешениям на восстановление, так и к разрешениям на очистку.

Если пользователь случайно удалит хранилище ключей или секрет, вы сможете предоставить им права доступа для самостоятельного восстановления секрета без риска того, что они навсегда удалят секрет или хранилище ключей. Этот процесс самообслуживания минимизирует время простоя в среде и гарантирует доступность секретов.

### <a name="how-do-i-find-out-if-i-need-to-take-action"></a>Как узнать, нужно ли предпринимать какие-то действия?

Выполните действия, описанные в приведенном выше разделе "Процедура аудита хранилищ Key Vault для проверки включения обратимого удаления". Это изменение затронет любое хранилище ключей, для которого не включено обратимое удаление. Дополнительные инструменты, которые помогут в аудите, будут доступны в ближайшее время, и в этом документе появится соответствующая информация.

### <a name="what-action-do-i-need-to-take"></a>Какие действия необходимо предпринять?

Убедитесь, что вам не нужно вносить изменения в логику приложения. Как только вы подтвердите это, включите обратимое удаление во всех хранилищах ключей. Это приведет к тому, что критические изменения не повлияют на работу, когда в конце года обратимое удаление будет включено для всех хранилищ ключей.

### <a name="by-when-do-i-need-to-take-action"></a>Когда нужно предпринимать действия?

К концу года обратимое удаление будет включено для всех хранилищ ключей. Чтобы убедиться, что это не повлияет на приложения, как можно скорее включите обратимое удаление для хранилищ ключей.

## <a name="what-will-happen-if-i-dont-take-any-action"></a>Что произойдет, если не предпринять никаких действий?

Если вы не предпримете никаких действий, обратимое удаление будет автоматически включено для всех хранилищ ключей в конце года. Если вы попытаетесь удалить объект хранилища ключей и воссоздать его с тем же именем, не удаляя его сначала из состояния обратимого удаления, это может привести к ошибкам конфликтов. Это может вызвать сбой приложений или автоматизации.

## <a name="next-steps"></a>Дальнейшие действия

- С любыми вопросами, связанными с этим изменением, обращайтесь по адресу [akvsoftdelete@microsoft.com](mailto:akvsoftdelete@microsoft.com).
- Ознакомьтесь со статьей [Общие сведения об обратимом удалении в Azure Key Vault](soft-delete-overview.md).
