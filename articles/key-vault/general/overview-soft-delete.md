---
title: Мягкое удаление Убежища ключей Azure Документы Майкрософт
description: Мягкое удаление в Azure Key Vault позволяет восстановить удаленные хранилища ключей и объекты хранилища ключей, такие как ключи, секреты и сертификаты.
ms.service: key-vault
ms.subservice: general
ms.topic: conceptual
author: msmbaldwin
ms.author: mbaldwin
manager: rkarlin
ms.date: 03/19/2019
ms.openlocfilehash: be4f124863da39cc9f6a61ebe054d451b438e8c3
ms.sourcegitcommit: eefb0f30426a138366a9d405dacdb61330df65e7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81617740"
---
# <a name="azure-key-vault-soft-delete-overview"></a>Общие сведения об обратимом удалении в Azure Key Vault

Функция мягкого удаления Key Vault позволяет восстановить удаленные хранилища и объекты хранилища, известные как мягкое удаление. В частности, рассматриваются следующие сценарии:

- Поддержка восстанавливаемого удаления хранилища ключей
- Поддержка восстанавливаемого удаления объектов Key Vault (например, ключей, секретов, сертификатов).

## <a name="supporting-interfaces"></a>Поддержка интерфейсов

Функция «мягкое удаление» изначально доступна через интерфейсы [REST,](/rest/api/keyvault/) [CLI,](soft-delete-cli.md) [PowerShell](soft-delete-powershell.md) и [.NET/C.](/dotnet/api/microsoft.azure.keyvault?view=azure-dotnet)

## <a name="scenarios"></a>Сценарии

Azure Key Vault — это отслеживаемые ресурсы, управляемые Azure Resource Manager. Azure Resource Manager также задает четко определенное поведение для удаления, которое требует, чтобы после успешной операции удаления этот ресурс больше не был доступен. Функция обратимого восстановления восстанавливает удаленный объект независимо от того, было ли удаление случайным или преднамеренным.

1. В типичном сценарии пользователь может случайно удалить Key Vault или его объект. Если они будут доступны для восстановления в течение предопределенного периода, пользователь сможет отменить удаление и восстановить свои данные.

2. В другом сценарии несанкционированный пользователь может попытаться удалить Key Vault или его объект, например ключ в хранилище, чтобы нарушить работу компании. Разделение удаления Key Vault или его объектов и удаления базовых данных может использоваться как мера предосторожности, к примеру, для ограничения разрешений на удаление данных другой доверенной ролью. По существу, при таком подходе требуется кворум для операции, так как в противном случае может произойти немедленная потеря данных.

### <a name="soft-delete-behavior"></a>Поведение обратимого удаления

При включении "мягкого удаления" ресурсы, отмеченные как удаленные ресурсы, сохраняются в течение определенного периода (90 дней по умолчанию). Затем эта служба предоставляет механизм восстановления удаленного объекта, отменяющий удаление.

При создании нового хранилища ключей по умолчанию происходит удаление. Вы можете создать хранилище ключей без мягкого удаления через [Azure CLI](soft-delete-cli.md) или [Azure PowerShell.](soft-delete-powershell.md) После включения мягкого удаления в хранилище ключей он не может быть отключен

Период удержания по умолчанию составляет 90 дней, но при создании хранилища ключей можно установить интервал политики удержания до значения от 7 до 90 дней через портал Azure. Политика удержания защиты очистки использует тот же интервал. После установки интервал политики удержания не может быть изменен.

Нельзя повторно использовать имя хранилища ключей, которое было удалено по-мягкому, пока не пройдет период хранения.

### <a name="purge-protection"></a>Защита от чистки 

Защита очистки является дополнительным поведением Key Vault и **не включена по умолчанию.** Он может быть включен через [CLI](soft-delete-cli.md#enabling-purge-protection) или [PowerShell](soft-delete-powershell.md#enabling-purge-protection).

При защите от очистки хранилище или объект в удаленном состоянии не могут быть очищены до тех пор, пока не пройдет период хранения. Мягкие удаленные хранилища и объекты все еще могут быть восстановлены, гарантируя, что политика удержания будет следовать. 

Период удержания по умолчанию составляет 90 дней, но можно установить интервал политики удержания до значения от 7 до 90 дней через портал Azure. После установки и сохранения интервала политики удержания он не может быть изменен для этого хранилища. 

### <a name="permitted-purge"></a>Разрешенная очистка

Окончательное удаление и очистку хранилища ключей можно выполнить с помощью операции POST на прокси-ресурсе. Это требует специальных привилегий. Как правило, только владелец подписки может очистить хранилище ключей. Операция POST активирует немедленное и необратимое удаление этого хранилища. 

Исключениями являются:
- Когда подписка Azure была помечена как *неудализмовая.* В этом случае только служба может выполнить фактическое удаление в рамках запланированной процедуры. 
- Когда `--enable-purge-protection flag` включено на хранилище себя. В этом случае Key Vault будет ожидать 90 дней с момента, когда исходный объект секрета был помечен для удаления, прежде чем окончательно удалить объект.

### <a name="key-vault-recovery"></a>Восстановление Key Vault

Когда хранилище ключей будет удалено, служба создаст прокси-ресурс в рамках подписки, добавив достаточное количество метаданных для восстановления. Прокси-ресурс — это хранимый объект, доступный в том же месте, что и удаленное Key Vault. 

### <a name="key-vault-object-recovery"></a>Восстановление объектов Key Vault

После удаления объекта хранилища ключей, например ключа, служба размещает объект в удаленном состоянии, делая его недоступным для любых операций поиска. В этом состоянии объект хранилища ключей можно только внести в список, восстановить, а также принудительно или окончательно удалить. 

В то же время Key Vault запланирует удаление базовых данных удаленного Key Vault или его объекта, чтобы удалить их по истечении предопределенного интервала хранения. Запись DNS, соответствующая хранилищу, также сохраняется в течение этого интервала.

### <a name="soft-delete-retention-period"></a>Период хранения при обратимом удалении

Мягкие удаленные ресурсы сохраняются в течение определенного периода времени, 90 дней. В течение интервала хранения применяются следующие условия:

- Вы можете вести список всех Key Vault и их объектов в состоянии обратимого удаления для вашей подписки, а также просматривать сведения об их удалении и восстановлении.
    - Только пользователи со специальными разрешениями могут вести список удаленных хранилищ. Мы советуем нашим пользователям создать настраиваемую роль с этими разрешениями для управления удаленными хранилищами.
- Хранилище ключей с тем же именем не может быть создано в одном и том же месте. Соответственно, объект хранилища ключей не может быть создан в данном хранилище, если оно содержит объект с тем же именем и находится в удаленном состоянии. 
- Только пользователь со специальными привилегиями может восстановить хранилище ключей или его объект, выполнив команду восстановления на соответствующем прокси-ресурсе.
    - Пользователь, участник настраиваемой роли, у которого есть привилегии создавать хранилище ключей в группе ресурсов, может восстановить хранилище.
- Только пользователь со специальными привилегиями может принудительно удалить хранилище ключей или его объект, выполнив команду удаления на соответствующем прокси-ресурсе.

Если хранилище ключей или его объект не будут восстановлены, служба выполнит очистку обратимо удаленного хранилища ключей или его объекта вместе с содержимым в конце периода хранения. Удаление ресурса нельзя запланировать повторно.

### <a name="billing-implications"></a>Процесс выставления счетов

В общем случае, когда объект (хранилище ключей, ключ или секрета) находится в состоянии удаления, возможны только две операции: очистка и восстановление. Все остальные операции завершатся ошибкой. Таким образом, хотя объект существует, операции выполнять нельзя, следовательно счета за использование не выставляются. Но есть и следующие исключения.

- Действия очистки и удаления будут считаться обычными операциями хранилища ключей, следовательно, они будут тарифицироваться.
- Если объект является ключом HSM, ежемесячная плата за версию каждого ключа с защитой HSM будет взиматься, если версия ключа использовалась в течение последних 30 дней. После этого, так как объект находится в состоянии удаления, операции с ним невозможны, плата не будет взиматься.

## <a name="next-steps"></a>Дальнейшие действия

Следующие два руководства содержат основные сценарии использования обратимого удаления.

- [Как использовать обратимое удаление в Key Vault с помощью PowerShell](soft-delete-powershell.md) 
- [Как использовать обратимое удаление в Key Vault с помощью интерфейса командной строки](soft-delete-cli.md)

