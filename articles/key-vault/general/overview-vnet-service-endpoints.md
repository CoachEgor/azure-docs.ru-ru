---
title: Конечные точки служб для виртуальной сети для Azure Key Vault — Azure Key Vault | Документация Майкрософт
description: Обзор конечных точек служб для виртуальной сети для Key Vault.
services: key-vault
author: amitbapat
ms.author: ambapat
manager: rkarlin
ms.date: 01/02/2019
ms.service: key-vault
ms.subservice: general
ms.topic: conceptual
ms.openlocfilehash: 2a68a50a5d15b9f38407c19494a39a14abfa0a5a
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81432077"
---
# <a name="virtual-network-service-endpoints-for-azure-key-vault"></a>Конечные точки служб для виртуальной сети для Azure Key Vault

Конечные точки служб для виртуальной сети для Azure Key Vault позволяют ограничить доступ к определенной виртуальной сети. Также эти конечные точки позволяют ограничить доступ определенным набором диапазонов адресов IPv4 (протокол IP версии 4). Для любого пользователя при попытке подключения к хранилищу ключей из любых других расположений доступ будет отклонен.

Из этого ограничения есть одно важное исключение. Если пользователь разрешил доступ доверенным службам Майкрософт, брандмауэр будет пропускать подключения из этих служб. К таким службам относятся, к примеру, Office 365 Exchange Online, Office 365 SharePoint Online, служба вычислений Azure, Azure Resource Manager и Azure Backup. Эти пользователи по-прежнему должны предоставить допустимый маркер Azure Active Directory и иметь разрешения (настроенные в политиках доступа) для выполнения запрошенной операции. Дополнительные сведения см. в статье [Конечные точки служб для виртуальной сети](../../virtual-network/virtual-network-service-endpoints-overview.md).

## <a name="usage-scenarios"></a>Сценарии использования

[Брандмауэры и виртуальные сети Key Vault](network-security.md) можно настроить так, чтобы по умолчанию запрещать трафик из всех сетей (в том числе из Интернета). Вы можете разрешить доступ для трафика из конкретных виртуальных сетей Azure или диапазонов общедоступных IP-адресов, что позволит определить границу защищенной сети для приложений.

> [!NOTE]
> Правила брандмауэра и виртуальной сети Key Vault применяются только к [плоскости данных](secure-your-key-vault.md#data-plane-access-control) в Key Vault. Правила брандмауэра и виртуальной сети не влияют на операции плоскости управления Key Vault (создание, удаление, изменение хранилища ключей, настройка политик доступа, настройка правил брандмауэров и виртуальной сети).

Ниже приведены некоторые примеры использования конечных точек службы.

* Если Key Vault используется для хранения ключей шифрования, секретов приложения и сертификатов, доступ к которым из общедоступного Интернета вы хотите запретить.
* Если вы хотите заблокировать доступ к хранилищу ключей, чтобы к нему могли подключаться только одно приложение или небольшой набор назначенных узлов.
* Если у вас есть приложение, работающее в виртуальной сети Azure, для которой заблокирован любой исходящий и входящий трафик, но приложению требуется подключение к хранилищу ключей для получения секретов, сертификатов или криптографических ключей.

## <a name="configure-key-vault-firewalls-and-virtual-networks"></a>Настройка брандмауэров и виртуальных сетей Key Vault

Ниже приведены шаги, необходимые для настройки брандмауэров и виртуальных сетей. Эти шаги применимы к любому методу настройки: PowerShell, Azure CLI или портал Azure.

1. Включить [журнал Key Vault](logging.md), чтобы увидеть подробные журналы доступа. Это поможет анализировать ситуации, в которых правила брандмауэра и виртуальной сети препятствуют доступу к хранилищу ключей. (Этот шаг необязателен, но мы настоятельно рекомендуем его выполнить.)
2. Включите **конечные точки службы для хранилища ключей** для всех целевых виртуальных сетей и подсетей.
3. Установите правила брандмауэра и виртуальной сети для хранилища ключей таким образом, чтобы предоставить доступ к этому хранилищу ключей из определенных виртуальных сетей, подсетей и диапазонов IPv4-адресов.
4. Если это хранилище ключей должно быть доступно доверенным службам Майкрософт, включите параметр, позволяющий **доверенным службам Azure** подключаться к Key Vault.

Дополнительные сведения см. в статье [Настройка брандмауэров и виртуальных сетей Azure Key Vault](network-security.md).

> [!IMPORTANT]
> Когда правила брандмауэра начнут действовать, пользователи смогут выполнять запросы на операции [плоскости данных](secure-your-key-vault.md#data-plane-access-control) в Key Vault только из разрешенных виртуальных сетей или диапазонов IPv4-адресов. Это относится и к получению доступа к Key Vault с портала Azure. Пользователь сможет перейти в хранилище ключей с портала Azure, но не сможет получить список ключей, секретов и сертификатов, если клиентский компьютер не включен в список разрешенных. Это также влияет на выбор хранилища ключей другими службами Azure. Пользователи смогут просматривать список хранилищ ключей, но не список ключей, если правила брандмауэра запрещают доступ их клиентским компьютерам.


> [!NOTE]
> Следует учитывать следующие ограничения конфигурации:
> * Допускается не более 127 правил виртуальной сети и 127 правил IPv4. 
> * Не поддерживаются малые диапазоны адресов с префиксом /31 или /32. Такие диапазоны следует настраивать в отдельных правилах для IP-адресов.
> * Правила IP-сети можно применять только в общедоступных IP-адресах. Диапазоны IP-адресов, зарезервированные для частных сетей (как определено в документе RFC 1918), запрещено использовать в правилах IP. Частные сети включают адреса, которые начинаются с **10.**, **172.16-31,** и **192.168.**. 
> * Сейчас поддерживаются только IPV4-адреса.

## <a name="trusted-services"></a>Доверенные службы

Ниже приведен список **доверенных служб**, которые получают доступ к хранилищу ключей, если включен соответствующий параметр.

|Доверенная служба|Поддерживаемые сценарии использования|
| --- | --- |
|Служба развертывания виртуальных машин Azure|[Развертывание сертификатов на виртуальных машинах из хранилища ключей, управляемого пользователем](https://blogs.technet.microsoft.com/kv/2016/09/14/updated-deploy-certificates-to-vms-from-customer-managed-key-vault/)|
|Служба развертывания шаблонов Azure Resource Manager|[Передача защищенных значений в процессе развертывания](../../azure-resource-manager/templates/key-vault-parameter.md).|
|Служба шифрования томов для шифрования дисков Azure|Разрешение доступа к ключу BitLocker (виртуальная машина Windows), парольной фразе DM (виртуальная машина Linux) и ключу шифрования ключей во время развертывания виртуальной машины. Это позволяет включить [шифрование дисков Azure](../../security/fundamentals/encryption-overview.md).|
|Azure Backup|Разрешение резервного копирования и восстановления соответствующих ключей и секретов во время резервного копирования виртуальной машины Azure с помощью службы [Azure Backup](../../backup/backup-introduction-to-azure-backup.md).|
|Exchange Online и SharePoint Online|Разрешение доступа к ключу клиента для функции шифрования службы хранилища Azure с использованием [ключа пользователя](/microsoft-365/compliance/customer-key-overview).|
|Azure Information Protection|Разрешение доступа к ключу клиента для [Azure Information Protection.](https://docs.microsoft.com/azure/information-protection/what-is-information-protection)|
|Служба приложений Azure|[Развертывание сертификата веб-приложения Azure через Key Vault](https://azure.github.io/AppService/2016/05/24/Deploying-Azure-Web-App-Certificate-through-Key-Vault.html)|
|База данных SQL Azure|[Прозрачное шифрование данных с поддержкой использования собственных ключей для Базы данных SQL Azure и Хранилища данных SQL Azure](../../sql-database/transparent-data-encryption-byok-azure-sql.md?view=sql-server-2017&viewFallbackFrom=azuresqldb-current)|
|Хранилище Azure|[Шифрование службы хранилища с помощью управляемых пользователем ключей в Azure Key Vault](../../storage/common/storage-service-encryption-customer-managed-keys.md).|
|Хранилище озера данных Azure|[Шифрование данных в Azure Data Lake Storage](../../data-lake-store/data-lake-store-encryption.md) с помощью управляемого пользователем ключа.|
|Azure Databricks|[Быстрая и простая служба аналитики на основе Apache Spark для совместной работы](../../azure-databricks/what-is-azure-databricks.md).|
|Cлужба управления Azure API |[Развертывание сертификатов для пользовательского домена из Key Vault с помощью MSI](../../api-management/api-management-howto-use-managed-service-identity.md#use-the-managed-service-identity-to-access-other-resources)|
|Фабрика данных Azure|[Извлечение учетных данных хранилища данных в Key Vault из фабрики данных](https://go.microsoft.com/fwlink/?linkid=2109491)|
|Центры событий Azure|[Разрешить доступ к хранилищу ключей для сценария ключей, управляемых клиентом](https://docs.microsoft.com/azure/event-hubs/configure-customer-managed-key)|
|Служебная шина Azure|[Разрешить доступ к хранилищу ключей для сценария ключей, управляемых клиентом](https://docs.microsoft.com/azure/service-bus-messaging/configure-customer-managed-key)|
|Служба импорта и экспорта Azure| [Используйте ключи, управляемые клиентами, в Сервисе Azure Key Vault для обслуживания импорта/экспорта](https://docs.microsoft.com/azure/storage/common/storage-import-export-encryption-key-portal)

> [!NOTE]
> Настройте политики доступа в Key Vault так, чтобы разрешить доступ к Key Vault соответствующим службам.

## <a name="next-steps"></a>Дальнейшие действия

* [Защитите хранилище ключей)](secure-your-key-vault.md)
* [Настройка брандмауэров и виртуальных сетей Azure Key Vault](network-security.md)
