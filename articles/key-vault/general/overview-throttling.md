---
title: Руководство по регулированию хранилища ключей Azure
description: Регулирование Key Vault позволяет ограничить число одновременных вызовов для предотвращения чрезмерного использования ресурсов.
services: key-vault
author: msmbaldwin
manager: rkarlin
ms.service: key-vault
ms.subservice: general
ms.topic: conceptual
ms.date: 12/02/2019
ms.author: mbaldwin
ms.openlocfilehash: f32a988ec0d75ca8d8eca04e69edd7226bf283b4
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81432090"
---
# <a name="azure-key-vault-throttling-guidance"></a>Руководство по регулированию хранилища ключей Azure

Регулирование — это процесс, позволяющий ограничить число одновременных вызовов к службе Azure для предотвращения чрезмерного использования ресурсов. Хранилище ключей Azure (AKV) может обрабатывать большое число запросов. Если это число превышает приемлемое, для обеспечения оптимальной производительности и надежности службы AKV используется регулирование клиентских запросов.

Ограничения регулирования зависят от сценария. Например, при выполнении большого объема операций записи возможность регулирования будет более высокой по сравнению с ситуацией, когда выполняются только операции чтения.

## <a name="how-does-key-vault-handle-its-limits"></a>Как хранилище ключей обрабатывает свои ограничения?

Ограничения на обслуживание в Key Vault предотвращают неправильное использование ресурсов и обеспечивают качество обслуживания для всех клиентов Key Vault. При превышении порога обслуживания Key Vault ограничивает любые дополнительные запросы от этого клиента на определенное время, возвращает код статуса HTTP 429 (слишком много запросов), и запрос завершается неудачей. Неудачные запросы, которые возвращают 429 кол к границам дроссельной заслонки, отслеживаемым Key Vault. 

Key Vault был первоначально разработан для хранения и получения секретов во время развертывания.  Мир эволюционировал, и Key Vault используется в течение выполнения времени для хранения и получения секретов, и часто приложения и службы хотят использовать Key Vault как базу данных.  Текущие лимиты не поддерживают высокую пропускную скорость.

Key Vault был первоначально создан с ограничениями, указанными в [ограничениях службы Azure Key Vault.](service-limits.md)  Чтобы максимизировать ваш ключ Vault через пут ставки, вот некоторые рекомендуемые руководящие принципы / лучшие практики для максимизации пропускной их пропускной воды:
1. Убедитесь, что у вас есть регулирование на месте.  Клиент должен соблюдать экспоненциальные политики резервного копирования для 429 и убедиться, что вы делаете повторы в рамках руководства ниже.
1. Разделите трафик Key Vault между несколькими хранилищами и различными регионами.   Используйте отдельное хранилище для каждого домена безопасности/доступности.   Если у вас есть пять приложений, каждый в двух регионах, то мы рекомендуем 10 хранилищ, каждый из которых содержит секреты, уникальные для приложения и региона.  Ограничение по подписке для всех типов транзакций в пять раз превышает лимит хранилища ключей. Например, HSM-другие транзакции за подписку ограничены 5000 транзакций за 10 секунд за подписку. Рассмотрите возможность кэширования секрета в вашем сервисе или приложении, чтобы также уменьшить RPS непосредственно к хранилищу ключей и/или обрабатывать трафик на основе всплеска.  Вы также можете разделить трафик между различными регионами, чтобы свести к минимуму задержку и использовать другую подписку/хранилище.  Не отправляйте больше, чем ограничение подписки на службу Key Vault в одном регионе Azure.
1. Кэшите секреты, которые вы извлекли из Убежища ключей Azure в памяти, и повторно использовать из памяти, когда это возможно.  Повторное чтение из Azure Key Vault только тогда, когда кэшированная копия перестает работать (например, потому, что она вращается в источнике). 
1. Key Vault предназначен для ваших собственных секретов услуг.   Если вы храните секреты своих клиентов (особенно для сценариев хранения ключей с высокой пропускной связью), подумайте о том, чтобы поместить ключи в базу данных или учетную запись с шифрованием и сохранить только главный ключ в Azure Key Vault.
1. Шифрование, упаковка и проверка операций с открытым ключом могут выполняться без доступа к Key Vault, что не только снижает риск регулирования, но и повышает надежность (до тех пор, пока вы правильно кэшируете материал общедоступного ключа).
1. Если вы используете Key Vault для хранения учетных данных для службы, проверьте, поддерживает ли эта служба аутентификацию Azure AD для непосредственной аутентификации. Это снижает нагрузку на Key Vault, повышает надежность и упрощает код, так как Key Vault теперь может использовать токен Azure AD.  Многие службы перешли на использование Azure AD Auth.  Ознакомьтесь с текущим списком [служб, которые поддерживают управляемые идентификаторы для ресурсов Azure.](../../active-directory/managed-identities-azure-resources/services-support-managed-identities.md#azure-services-that-support-managed-identities-for-azure-resources)
1. Рассмотрите возможность ошеломляющего нагрузки/развертывания в течение более длительного периода времени, чтобы оставаться в соответствии с текущими лимитами RPS.
1. Если ваше приложение состоит из нескольких узлов, которые должны читать один и тот же секрет (ы), а затем рассмотреть вопрос об использовании вентилятора из шаблона, где одна сущность читает секрет из Key Vault, и вентиляторы из всех узлов.   Кэш извлеченные секреты только в памяти.
Если вы обнаружите, что выше, все еще не отвечает вашим потребностям, пожалуйста, заполните ниже таблицу и свяжитесь с нами, чтобы определить, какие дополнительные возможности могут быть добавлены (пример, приведенный ниже только для иллюстративных целей).

| Имя убежища | Регион Убежища | Тип объекта (Секрет, ключ или сертификат) | Операция (ы) | Тип ключа | Длина ключа или кривая | HSM ключ?| Устойчивое состояние RPS необходимо | Пик RPS необходимо |
|--|--|--|--|--|--|--|--|--|
| https://mykeyvault.vault.azure.net/ | | Клавиши | вход; | EC | P-256 | нет | 200 | 1000 |

\*Полный список возможных значений можно узнать в [операциях Azure Key Vault.](/rest/api/keyvault/key-operations)

Если утверждена дополнительная емкость, обратите внимание на следующее увеличение емкости:
1. Изменения модели согласованности данных. После того, как хранилище включено в список с дополнительной пропускной способностью, согласованность данных службы Key Vault гарантирует изменения (необходимые для удовлетворения более высокого объема RPS, так как базовая служба хранения Azure не может идти в ногу с управлением).  Если говорить кратко,
  1. **Без включения в список**: Служба Key Vault будет отражать результаты операции записи (например. SecretSet, CreateKey) сразу же в последующих вызовах (например. SecretGet, KeySign).
  1. **С размноской :** Служба Key Vault будет отражать результаты операции записи (например. SecretSet, CreateKey) в течение 60 секунд в последующих вызовах (например. SecretGet, KeySign).
1. Код клиента должен соблюдать политику обратного отсылки для 429 повторов. Клиентский код, вызывающий службу Key Vault, не должен немедленно повторить запросы Key Vault, когда он получает код ответа 429.  В опубликованном здесь руководстве azure Key Vault рекомендуетприменять экспоненциальный откат при получении кода ответа 429 Http.

Если у вас есть реальный пример использования с более высокими ограничениями регулирования, пожалуйста, расскажите нам о нем.

## <a name="how-to-throttle-your-app-in-response-to-service-limits"></a>Регулирование приложения в ответ на ограничения служб

Ниже приведены **рекомендации,** которые следует реализовать при задушении службы:
- Сократите число операций на один запрос.
- Уменьшите частоту запросов.
- Избегайте немедленных повторных попыток. 
    - Все запросы учитываются, и их количество сравнивается с ограничениями использования.

При реализации обработки ошибок для приложения используйте код ошибки HTTP 429, чтобы определить необходимость регулирования на стороне клиента. Если запрос снова завершается сбоем с кодом ошибки HTTP 429, это означает, что вы по-прежнему не соблюдаете ограничения службы Azure. Продолжайте использовать рекомендуемый метод регулирования на стороне клиента и повторяйте выполнять запрос, пока он не будет успешно выполнен.

Ниже показан код, который реализует экспоненциальную задержку. 
```
SecretClientOptions options = new SecretClientOptions()
    {
        Retry =
        {
            Delay= TimeSpan.FromSeconds(2),
            MaxDelay = TimeSpan.FromSeconds(16),
            MaxRetries = 5,
            Mode = RetryMode.Exponential
         }
    };
    var client = new SecretClient(new Uri(https://keyVaultName.vault.azure.net"), new DefaultAzureCredential(),options);
                                 
    //Retrieve Secret
    secret = client.GetSecret(secretName);
```


Использование этого кода в клиентском приложении C's является простым. 

### <a name="recommended-client-side-throttling-method"></a>Рекомендуемый метод регулирования на стороне клиента

При возврате кода ошибки HTTP 429 начните регулирование клиента с помощью метода экспоненциального откладывания:

1. Подождите 1 с и повторите запрос
2. Если запрос по-прежнему не выполнен, подождите 2 с и повторите запрос
3. Если запрос по-прежнему не выполнен, подождите 4 с и повторите запрос
4. Если запрос по-прежнему не выполнен, подождите 8 с и повторите запрос
5. Если запрос по-прежнему не выполнен, подождите 16 с и повторите запрос

На этом этапе вы не должны получать коды ответа HTTP 429.

## <a name="see-also"></a>См. также раздел

Более подробные сведения о регулировании для Microsoft Cloud см. в разделе [Шаблон регулирования](https://docs.microsoft.com/azure/architecture/patterns/throttling).

