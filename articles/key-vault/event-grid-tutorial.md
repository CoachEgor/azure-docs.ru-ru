---
title: Получение уведомлений хранилища ключей и реагирование на них с помощью Сетки событий Azure
description: Узнайте, как интегрировать Key Vault со службой "Сетка событий Azure".
services: key-vault
author: msmbaldwin
manager: rkarlin
tags: azure-resource-manager
ms.service: key-vault
ms.topic: tutorial
ms.date: 10/25/2019
ms.author: mbaldwin
ms.openlocfilehash: 3b24da4d988554da240baba2984df44ff4744aaf
ms.sourcegitcommit: c22327552d62f88aeaa321189f9b9a631525027c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2019
ms.locfileid: "73464103"
---
# <a name="how-to-receive-and-respond-to-key-vault-notifications-with-azure-event-grid-preview"></a>Практическое руководство: Получение уведомлений хранилища ключей и реагирование на них с помощью Сетки событий Azure (предварительная версия)

Интеграция Key Vault с Сеткой событий Azure (в настоящее время находится на этапе предварительной версии) позволяет пользователям получать уведомления при изменении состояния секрета, хранящегося в хранилище ключей. Общие сведения об этой функции см. в разделе [Мониторинг Key Vault с помощью службы "Сетка событий Azure" (предварительная версия)](event-grid-overview.md).

В этом руководство показано, как получать уведомления Key Vault через Сетку событий Azure и как реагировать на изменения состояния с помощью службы автоматизации Azure.

## <a name="prerequisites"></a>Предварительные требования

- Подписка Azure. Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.
- Хранилище ключей в подписке Azure. Вы можете быстро создать хранилище ключей, выполнив действия, описанные в разделе [Настройка и получение секрета из Azure Key Vault с помощью Azure CLI](quick-create-cli.md).

## <a name="concepts"></a>Основные понятия

"Сетка событий Azure" — это служба обработки событий для облака. В этом руководстве вы подпишетесь на события хранилища ключей и будете перенаправлять эти события в службу автоматизации Azure. Когда срок действия одного из секретов в хранилище ключей подходит к концу, Сетка событий получает уведомление об изменении состояния и выполняет HTTP-запрос POST к конечной точке. Затем веб-перехватчик активирует выполнение сценария PowerShell в службе автоматизации Azure.

![image](media/image1.png)

## <a name="create-an-azure-automation-account"></a>Создание учетной записи службы автоматизации Azure

Создайте учетную запись службы автоматизации Azure на [портале Azure](https://portal.azure.com).

1.  Перейдите по адресу portal.azure.com и войдите в свою подписку.

1.  В поле поиска введите "учетные записи автоматизации".

1.  В разделе "Службы" раскрывающегося списка на панели поиска выберите "Учетные записи автоматизации".

1.  Нажмите Добавить.

    ![](media/image2.png)

1.  Введите необходимые сведения в колонке "Добавление учетной записи службы автоматизации" и щелкните "Создать".

## <a name="create-a-runbook"></a>Создание runbook

Когда ваша учетная запись службы автоматизации Azure будет готова, создайте runbook.

![](media/image3.png)

1.  Выберите учетную запись службы автоматизации, которую вы только что создали.

1.  В разделе "Автоматизация процессов" щелкните "Модули Runbook".

1.  Щелкните "Создать Runbook".

1.  Введите имя runbook и выберите "PowerShell" в качестве типа runbook.

1.  Щелкните созданный runbook и нажмите кнопку "Изменить".

1.  Введите приведенный ниже код (для тестирования) и нажмите кнопку "Опубликовать". Будет выведен полученный результат запроса POST.

```azurepowershell
param
(
[Parameter (Mandatory = $false)]
[object] $WebhookData
)

#If runbook was called from Webhook, WebhookData will not be null.
if ($WebhookData) {

#rotate secret:
#generate new secret version in key vault
#update db/service with generated secret

#Write-Output "WebhookData <$WebhookData>"
Write-Output $WebhookData.RequestBody
}
else
{
# Error
write-Error "No input data found." 
}
```

![](media/image4.png)

## <a name="create-a-webhook"></a>Создание веб-перехватчика

Теперь создайте веб-перехватчик, чтобы активировать созданный runbook.

1.  Выберите "Веб-перехватчики" в разделе ресурсов только что опубликованного runbook.

1.  Щелкните "Добавить веб-перехватчик".

    ![](media/image5.png)

1.  Выберите "Создать новый веб-перехватчик".

1. Присвойте имя веб-перехватчику, задайте дату окончания срока действия и **скопируйте URL-адрес**.

    > [!IMPORTANT] 
    > Когда создание будет завершено, просмотреть URL-адрес будет невозможно. Обязательно сохраните копию в безопасном месте, к которому можно будет обратиться позже, чтобы выполнить действия в оставшейся части этого руководства.

1. Щелкните "Параметры и настройки запуска" и нажмите кнопку "ОК". Не вводите никаких параметров. Тогда кнопка "Создать" будет активна.

1. Щелкните "ОК", а затем выберите "Создать".

    ![](media/image6.png)

## <a name="create-an-event-grid-subscription"></a>Создание подписки Сетки событий

Создайте подписку Сетки событий на [портале Azure](https://portal.azure.com).

1.  Откройте портал Azure, используя следующую ссылку: https://portal.azure.com/?Microsoft_Azure_KeyVault_ShowEvents=true&Microsoft_Azure_EventGrid_publisherPreview=true

1.  Перейдите в хранилище ключей и выберите вкладку "События". Если вкладка "События" не отображается, убедитесь, что используется [предварительная версия портала](https://ms.portal.azure.com/?Microsoft_Azure_KeyVault_ShowEvents=true&Microsoft_Azure_EventGrid_publisherPreview=true).

    ![](media/image7.png)

1.  Нажмите кнопку "+ Подписка на события".

1.  Введите описательное имя для подписки.

1.  Выберите "Схема сетки событий".

1.  В поле "Ресурс раздела" должно быть указано хранилище ключей, для которого необходимо отслеживать изменение состояний.

1.  В поле "Фильтр по типам событий" оставьте установленными все 9 флажков.

1.  Для параметра "Тип конечной точки" выберите "Веб-перехватчик".

1.  Выберите "Выбрать конечную точку". В новой области контекста в поле "Конечная точка подписчика" вставьте URL-адрес веб-перехватчика из шага [Создание веб-перехватчика](#create-a-webhook).

1.  Выберите "Подтвердить выбор" в области контекста.

1.  Нажмите кнопку "Создать".

    ![](media/image8.png)

## <a name="test-and-verify"></a>Тестирование и проверка

Убедитесь, что подписка Сетки событий настроена правильно.  В этом тесте предполагается, что вы подписались на уведомление "Secret New Version Created" (Создана новая версия секрета) при [создании подписки Сетки событий](#create-an-event-grid-subscription) и у вас есть необходимые привилегии для создания новой версии секрета в хранилище ключей.

![](media/image9.png)

![](media/image10.png)

1.  Переход в хранилище ключей на портале Azure

1.  Создайте секрет. В целях тестирования в качестве срока действия укажите следующий день.

1.  Перейдите на вкладку "События" в хранилище ключей.

1.  Выберите подписку Сетки событий, которую вы создали.

1.  В разделе "Метрики" проверьте, было ли событие записано. Ожидаются два события: SecretNewVersion и SecretNearExpiry. Это подтверждает, что Сетка событий успешно записала изменение состояния секрета в хранилище ключей.

    ![](media/image11.png)

1.  Перейдите к своей учетной записи службы автоматизации Azure.

1.  Перейдите на вкладку "Модули Runbook" и выберите созданный runbook.

1.  Перейдите на вкладку "Веб-перехватчики" и убедитесь, что метка времени "Последняя активация" находится в пределах 60 секунд после времени создания секрета.  Это подтверждает, что Сетка событий отправила запрос POST в веб-перехватчик с данными события об изменении состоянии в хранилище ключей и веб-перехватчик был активирован.

    ![](media/image12.png)

1. Вернитесь к модулю runbook и выберите вкладку "Обзор".

1. Просмотрите список "Последние задания". Вы должны увидеть, что задание было создано, а его состояние — "Завершено".  Это подтверждает, что веб-перехватчик активировал runbook, чтобы запустить выполнение сценария.

    ![](media/image13.png)

1. Выберите последнее задание и просмотрите запрос POST, отправленный из Сетки событий в веб-перехватчик. Проверьте код JSON и убедитесь в правильности параметров для хранилища ключей и типа события. Если параметр "event type" (Тип события) в объекте JSON соответствует событию, которое произошло в хранилище ключей (в данном примере это Microsoft.KeyVault.SecretNearExpiry), то проверка прошла успешно.

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="unable-to-create-event-subscription"></a>Не удалось создать подписку на события

Повторите регистрацию Сетки событий и поставщика Key Vault в поставщиках ресурсов подписки Azure. Ознакомьтесь с разделом [Поставщики и типы ресурсов Azure](../azure-resource-manager/resource-manager-supported-services.md).

## <a name="next-steps"></a>Дополнительная информация

Поздравляем! Если вы выполнили все описанные выше действия, теперь все готово для программного реагирования на изменение состояния секретов в хранилище ключей.

Если вы используете систему на основе опроса для выявления изменений состояния секретов в хранилищах ключей, переходите к использованию этой функции уведомления. Вы можете также заменить сценарий теста в runbook кодом для программного продления секретов, когда срок их действия подходит к концу.

Дополнительные сведения

- [Общие сведения об Azure Key Vault](key-vault-overview.md)
- [Обзор службы "Сетка событий Azure"](../event-grid/overview.md)
- [Мониторинг Key Vault с помощью службы "Сетка событий Azure" (предварительная версия)](event-grid-overview.md)
- [Схема событий службы "Сетка событий Azure" для Azure Key Vault (предварительная версия)](../event-grid/event-schema-key-vault.md)
- [Обзор службы автоматизации Azure](../automation/index.yml)
