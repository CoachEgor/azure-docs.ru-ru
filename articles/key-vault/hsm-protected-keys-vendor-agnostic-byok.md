---
title: Создание ключей, защищенных аппаратным модулем безопасности, и их передача в Azure Key Vault | Документация Майкрософт
description: Данная статья поможет вам подготовить и создать ваши собственные ключи, защищенные аппаратным модулем безопасности, а затем передать их в хранилище ключей Azure. Также известные как собственные ключи или BYOK.
services: key-vault
author: amitbapat
manager: devtiw
tags: azure-resource-manager
ms.service: key-vault
ms.topic: conceptual
ms.date: 02/17/2020
ms.author: ambapat
ms.openlocfilehash: bd70cfb58c9d89f1d454537721e22f36b1fd3d3e
ms.sourcegitcommit: b8f2fee3b93436c44f021dff7abe28921da72a6d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/18/2020
ms.locfileid: "77429297"
---
# <a name="import-hsm-protected-keys-to-key-vault-preview"></a>Импорт ключей, защищенных HSM, в Key Vault (Предварительная версия)

> [!NOTE]
> Эта функция доступна в предварительной версии и доступна только в **восточной части США 2 (euap)** и **центральном регионе США (euap)** . 

Для добавленной гарантии при использовании Azure Key Vault можно импортировать или создать ключи в аппаратных модулях безопасности (HSM), которые никогда не оставляют границу HSM. Сценарий с использованием собственного ключа клиента называется *BYOK*. Azure Key Vault использует семейство nCipher nShield HSM (проверенный FIPS 140-2 уровня 2) для защиты ключей.

Информация в этой статье поможет вам подготовить и создать ваши собственные ключи, защищенные аппаратным модулем безопасности, а затем передать их в хранилище ключей Azure.

> [!NOTE]
> Эта функция недоступна для Azure для Китая в Китае. 
> 
> Этот метод импорта доступен только для [поддерживаемых HSM](#supported-hsms). 

Дополнительные сведения о хранилище ключей Azure см. в статье [Что такое хранилище ключей Azure?](key-vault-overview.md)  Указания по началу работы, включая создание хранилища для ключей, защищенных модулем HSM, см. в [этой статье](key-vault-overview.md).

## <a name="overview"></a>Обзор

* Создайте ключ (именуемый ключом обмена ключами или KEK) в хранилище ключей. Это должен быть ключ RSA-HSM с параметром "import" в качестве единственной операции Key. Ключи RSA-HSM поддерживаются только в хранилище ключей Premium SKU.
* Скачайте открытый ключ KEK в виде PEM-файла.
* Перенесите открытый ключ KEK на автономную рабочую станцию, подключенную к локальному HSM.
* На автономной рабочей станции используйте средство BYOK, предоставленное поставщиком HSM, для создания файла BYOK. 
* Целевой ключ шифруется с помощью KEK, который остается зашифрованным до тех пор, пока он не будет передан в Azure Key Vault HSM. Локальным HSM остается только зашифрованная версия ключа.
* KEK, созданный в Azure Key Vault HSM и не экспортируемый. HSM принудительно определяет, что не может быть четкой версии KEK за пределами Key Vault HSM.
* KEK должен находиться в том же хранилище ключей, в котором будет импортирован целевой ключ.
* Когда файл BYOK загружается в Key Vault, Key Vault HSM использовать закрытый ключ KEK для расшифровки материала целевого ключа и импорта его в качестве ключа HSM. Эта операция выполняется полностью в Key Vault HSM, а целевой ключ всегда остается на границе защиты HSM.

## <a name="prerequisites"></a>предварительные требования

Список предварительных требований для реализации сценария BYOK для хранилища ключей Azure к см. в приведенной ниже таблице.

| Требование | Дополнительные сведения |
| --- | --- |
| Подписка на Azure |Для создания хранилища ключей Azure требуется подписка Azure: [зарегистрируйтесь для получения бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/) |
| Хранилище ключей (SKU Premium) для импорта ключей, защищенных АППАРАТным модулем безопасности |Дополнительные сведения об уровнях служб и возможностях хранилища ключей Azure см. на веб-сайте [Цены на хранилище ключей Azure](https://azure.microsoft.com/pricing/details/key-vault/). |
| Модуль HSM из поддерживаемого списка HSM вместе со средством BYOK и инструкциями, предоставленными поставщиком HSM | Необходимо иметь доступ к аппаратному модулю безопасности и базовым знаниям о работе HSM. См. раздел [Supported HSM](#supported-hsms). |
| Azure CLI версии 2.0.82 или более поздней | Дополнительные сведения см. [в разделе установка Azure CLI](/cli/azure/install-azure-cli?view=azure-cli-latest) .|

## <a name="supported-hsms"></a>Поддерживаемые HSM

|Имя поставщика HSM|Поддерживаемые модели HSM|Дополнительная информация|
|---|---|---|
|Thales|Семейство компании SafeNet Luna HSM 7 с микропрограммным обеспечением версии 7,3 или более поздней| [Средство и документация по компании SafeNet Luna BYOK](https://safenet.gemalto.com/blah-blah)|


> [!NOTE]
> Импорт ключей, защищенных с помощью HSM, из семейства nCipher nShield HSM [использование устаревшей процедуры BYOK](hsm-protected-keys-legacy.md)


## <a name="generate-and-transfer-your-key-to-azure-key-vault-hsm"></a>Создание и передача ключа в аппаратный модуль безопасности хранилища ключей Azure

Чтобы создать и переместить ключ в модуль HSM Azure Key Vault, выполните следующие действия.

* [Шаг 1. Создание KEK](#step-1-generate-a-kek)
* [Шаг 2. скачивание открытого ключа KEK](#step-2-download-kek-public-key)
* [Шаг 3. Создание и подготовка ключа для перемещения](#step-3-generate-and-prepare-your-key-for-transfer)
* [Шаг 4. Перенос ключа в Azure Key Vault](#step-4-transfer-your-key-to-azure-key-vault)

### <a name="step-1-generate-a-kek"></a>Шаг 1. Создание KEK

KEK (ключ обмена ключами) — это ключ RSA, созданный в HSM Key Vault. Этот ключ используется для шифрования импортируемого ключа (целевой ключ).

KEK должен быть:
1. ключ **RSA-HSM** (2048-разрядная или 3072-разрядная или 4096-bit);
2. создано в том же хранилище ключей, в котором планируется импортировать целевой ключ
3. создано с разрешенными операциями Key Set для **импорта**

Используйте команду [AZ keyvault Key Create](/cli/azure/keyvault/key?view=azure-cli-latest#az-keyvault-key-create) , чтобы создать KEK с операциями Key, для которых задано значение Import. Запишите идентификатор ключа "ребенок", возвращенный из команды ниже. Он понадобится на [шаге 3](#step-3-generate-and-prepare-your-key-for-transfer).


```azurecli
az keyvault key create --kty RSA-HSM --size 4096 --name KEKforBYOK --ops import --vault-name ContosoKeyVaultHSM
```

### <a name="step-2-download-kek-public-key"></a>Шаг 2. скачивание открытого ключа KEK

Загрузите открытый ключ KEK в PEM-файл с помощью команды [AZ keyvault Key download](/cli/azure/keyvault/key?view=azure-cli-latest#az-keyvault-key-download) . Импортируемый целевой ключ шифруется с помощью открытого ключа KEK.

```azurecli
az keyvault key download --name KEKforBYOK --vault-name ContosoKeyVaultHSM --file KEKforBYOK.publickey.pem
```

Перенесите файл Кекфорбйок. publickey. pem на автономную рабочую станцию. Этот файл потребуется во время следующего шага.

### <a name="step-3-generate-and-prepare-your-key-for-transfer"></a>Шаг 3. Создание и подготовка ключа для перемещения

Чтобы скачать и установить средство BYOK, обратитесь к документации поставщика HSM. Следуйте инструкциям поставщика HSM, чтобы создать целевой ключ, а затем создайте пакет для перемещения ключа (файл BYOK). Средство BYOK будет использовать идентификатор ключа из файла [Step 1](#step-1-generate-a-kek) и кекфорбйок. publickey. pem, скачанного на [шаге 2](#step-2-download-kek-public-key) , чтобы создать зашифрованный целевой ключ в файле BYOK.

Перенесите файл BYOK на подключенную рабочую станцию.

> [!NOTE] 
> Целевой ключ должен быть ключом RSA, размером 2048-бит или 3072-бит или 4096-bit. Импорт ключей эллиптической кривой в настоящее время не поддерживается.
> <br/><strong>Известная ошибка:</strong> Импорт целевого ключа RSA 4000 из компании SafeNet Luna HSM завершается сбоем. При разрешении проблемы этот документ будет обновлен.

### <a name="step-4-transfer-your-key-to-azure-key-vault"></a>Шаг 4. Перенос ключа в Azure Key Vault

Для выполнения этого заключительного шага перенесите пакет передачи ключей (BYOK-файл) с отключенной рабочей станции на рабочую станцию, подключенную к Интернету, а затем выполните команду [AZ keyvault Key Import](/cli/azure/keyvault/key?view=azure-cli-latest#az-keyvault-key-import) , чтобы передать файл BYOK Azure Key Vault HSM, чтобы завершить импорт ключа.

```azurecli
az keyvault key import --vault-name ContosoKeyVaultHSM --name ContosoFirstHSMkey --byok-file KeyTransferPackage-ContosoFirstHSMkey.byok
```

Если отправка прошла успешно, отобразятся свойства только что импортированного ключа.

## <a name="next-steps"></a>Дальнейшие действия

Теперь ключ, защищенный с помощью аппаратного модуля безопасности, можно использовать в хранилище ключей. Дополнительные сведения см. в этой цене и [сравнении](https://azure.microsoft.com/pricing/details/key-vault/)характеристик.
