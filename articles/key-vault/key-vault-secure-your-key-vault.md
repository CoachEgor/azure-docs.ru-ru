---
title: Безопасный доступ к хранилищу ключей — Azure Key Vault | Документация Майкрософт
description: Управление правами доступа для Azure Key Vault, ключей и секретов. Описание модели проверки подлинности и авторизации для Key Vault и обеспечения защиты вашего хранилища ключей.
services: key-vault
author: amitbapat
manager: rkarlin
tags: azure-resource-manager
ms.service: key-vault
ms.topic: conceptual
ms.date: 01/07/2019
ms.author: ambapat
ms.openlocfilehash: 4857cda7c3387e72be8837422469888adc5504d1
ms.sourcegitcommit: 7c5a2a3068e5330b77f3c6738d6de1e03d3c3b7d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2019
ms.locfileid: "70883106"
---
# <a name="secure-access-to-a-key-vault"></a>Безопасный доступ к хранилищу ключей

Azure Key Vault — это облачная служба, которая обеспечивает защиту ключей шифрования и секретов (например, сертификатов, строк подключения и паролей). Так как это критически важные для бизнеса конфиденциальные данные, следует обеспечить защиту доступа к хранилищу ключей, чтобы доступ могли получить только авторизованные приложения и пользователи. В этой статье содержится обзор модели доступа к Key Vault. Здесь приводится описание процессов аутентификации и авторизации, а также содержатся сведения о том, как защитить доступ к вашему хранилищу ключей.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="access-model-overview"></a>Общие сведения о модели доступа

Доступ к хранилищу ключей осуществляется с помощью двух интерфейсов: **плоскость управления** и **плоскость данных**. Плоскость управления используется для управления Key Vault. Операции в этой плоскости включают в себя создание и удаление хранилищ ключей, получение свойств Key Vault и обновление политик доступа. Плоскость данных предназначена для работы с данными, хранящимися в хранилище ключей. Вы можете добавлять, удалять и изменять ключи, секреты и сертификаты.

Чтобы получить доступ к хранилищу ключей в любой плоскости, все вызывающие объекты (пользователи или приложения) должны иметь надлежащую аутентификацию и авторизацию. Аутентификация позволяет идентифицировать вызывающую сторону. Авторизация определяет, какие операции может выполнять вызывающий объект. 

Для аутентификации в обеих плоскостях используется Azure Active Directory (Azure AD). Для авторизации в плоскости управления используется управление доступом на основе ролей (RBAC), а в плоскости данных — политика доступа к Key Vault.

## <a name="active-directory-authentication"></a>Аутентификация Active Directory

При создании хранилища ключей в подписке Azure оно автоматически связывается с арендатором Azure AD этой подписки. Все вызывающие объекты в обеих плоскостях должны быть зарегистрированы в этом арендаторе, а также пройти аутентификацию, чтобы получить доступ к этому хранилищу ключей. В обоих случаях приложение может получить доступ к Key Vault двумя способами.

- **Доступ с использованием пользователя и приложения**. Приложения получают доступ к Key Vault от имени выполнившего вход пользователя. Такой доступ осуществляется с помощью Azure PowerShell и портала Azure. Есть два способа предоставления доступа пользователям. Пользователи могут получить доступ к Key Vault из любого приложения или только при использовании конкретного приложения (называемого _составным идентификатором_).
- **Доступ только с помощью приложения**. Приложения запускаются в качестве служб управляющих программ или фоновых заданий. Доступ к хранилищу ключей предоставляется по удостоверению приложения.

При доступе обоих типов приложения проходят аутентификацию в Azure AD. Приложения используют любой из [поддерживаемых методов аутентификации](../active-directory/develop/authentication-scenarios.md) в зависимости от своего типа. Приложение получает маркер для ресурса в плоскости, в которой нужно предоставить доступ. Ресурс является конечной точкой в плоскости управления или данных на основе среды Azure. Приложение отправляет запрос REST API в Key Vault с использованием этого маркера. Узнайте больше о [полном потоке аутентификации](../active-directory/develop/v1-protocols-oauth-code.md).

Модель единого механизма для аутентификации в обеих плоскостях имеет некоторые преимущества:

- организации могут централизованно управлять доступом ко всем принадлежащим им хранилищам ключей;
- когда пользователь покидает организацию, он мгновенно теряет доступ ко всем этим хранилищам ключей;
- организации могут настроить аутентификацию с помощью параметров в Azure AD (например, включение многофакторной проверки подлинности для повышения безопасности).

## <a name="resource-endpoints"></a>Конечные точки ресурсов

Приложения получают доступ к плоскостям через конечные точки. Элементы управления доступом для двух плоскостей работают независимо. Чтобы предоставить приложению доступ к использованию ключей в хранилище ключей, необходимо предоставить доступ к плоскости данных с помощью политики доступа к Key Vault. Чтобы предоставить пользователю доступ на чтение к свойствам и тегам Key Vault, но не доступ к данным (ключам, секретам или сертификатам), необходимо предоставить доступ к плоскости управления с помощью RBAC.

В следующей таблице показаны конечные точки плоскости управления и плоскости данных.

| Плоскость&nbsp;доступа | Конечные точки доступа | Операции | Механизм&nbsp;управление доступом |
| --- | --- | --- | --- |
| Плоскость управления | **Глобально:**<br> management.azure.com:443<br><br> **Azure China 21Vianet:**<br> management.chinacloudapi.cn:443<br><br> **Azure для правительства США:**<br> management.usgovcloudapi.net:443<br><br> **Azure для Германии:**<br> management.microsoftazure.de:443 | Создание, чтение, изменение и удаление хранилищ ключей<br><br>Настройка политик доступа Key Vault<br><br>Настройка тегов Key Vault | RBAC Azure Resource Manager |
| Плоскость данных | **Глобально:**<br> &lt;vault-name&gt;.vault.azure.net:443<br><br> **Azure China 21Vianet:**<br> &lt;vault-name&gt;.vault.azure.cn:443<br><br> **Azure для правительства США:**<br> &lt;vault-name&gt;.vault.usgovcloudapi.net:443<br><br> **Azure для Германии:**<br> &lt;vault-name&gt;.vault.microsoftazure.de:443 | Для ключей: расшифровка, шифрование,<br> распаковка, упаковка, проверка, подписывание,<br> получение, перечисление, обновление, создание,<br> импорт, удаление, резервное копирование, восстановление<br><br> Для секретов: получение, перечисление, настройка, удаление | Политика доступа к Key Vault |

## <a name="management-plane-and-rbac"></a>Плоскость управления и RBAC

В плоскости управления для авторизации операций, которые может выполнять вызывающий объект, используется RBAC (Управление доступом на основе ролей). В модели RBAC каждая подписка Azure содержит экземпляр Azure AD. Вы можете предоставить доступ пользователям, группам и приложениям из этого каталога. Доступ предоставляется для управления ресурсами в подписке Azure, использующими модель развертывания Azure Resource Manager. Чтобы предоставить доступ, можно использовать [портал Azure](https://portal.azure.com/), [Azure CLI](../cli-install-nodejs.md), [Azure PowerShell](/powershell/azureps-cmdlets-docs) или [REST API Azure Resource Manager](https://msdn.microsoft.com/library/azure/dn906885.aspx).

Вы можете создать хранилище ключей в группе ресурсов и управлять доступом с помощью Azure AD. Можно предоставить пользователям или группе возможность управлять хранилищами ключей в группе ресурсов. Вы можете предоставить доступ в определенной области путем назначения соответствующей роли RBAC. Чтобы предоставить пользователю доступ к управлению хранилищами ключей, ему необходимо назначить предопределенную роль `key vault Contributor` в определенной области. Роли RBAC можно назначить следующие области:

- **Подписка**: Роль RBAC, назначенная на уровне подписки, применяется ко всем группам ресурсов и ресурсам в этой подписке.
- **Группа ресурсов.** Роль RBAC, назначенная на уровне группы ресурсов, применяется ко всем ресурсам в этой группе ресурсов.
- **Определенный ресурс.** Роль RBAC, назначенная для конкретного ресурса, применяется только к этому ресурсу. В этом случае ресурс является определенным хранилищем ключей.

Есть несколько заданных по умолчанию ролей. Если заданные роли не соответствуют вашим потребностям, вы можете определить собственные. Дополнительные сведения см. в статье [Встроенные роли для управления доступом на основе ролей в Azure](../role-based-access-control/built-in-roles.md).

> [!IMPORTANT]
> Если у пользователя есть разрешения `Contributor` в плоскости управления хранилища ключей, он может предоставить себе доступ к плоскости данных, настроив политику доступа к хранилищу ключей. Следует очень внимательно контролировать, у кого есть доступ `Contributor` к вашим хранилищам ключей в рамках роли. Убедитесь, что только авторизованные лица могут получать доступ к хранилищам ключей, ключам, секретам и сертификатам, а также управлять ими.
>

<a id="data-plane-access-control"></a> 
## <a name="data-plane-and-access-policies"></a>Плоскость данных и политики доступа

Доступ к плоскости данных предоставляется путем настройки политик доступа Key Vault для хранилища ключей. Чтобы задать эти политики доступа, пользователь, группа или приложение должны иметь разрешения `Contributor` для плоскости управления этого хранилища ключей.

Пользователю, группе или приложению можно предоставить доступ на выполнение определенных операций с ключами или секретами в хранилище ключей. Хранилище ключей в Key Vault поддерживает до 1024 записей политики доступа. Чтобы предоставить нескольким пользователям доступ к плоскости данных, создайте группу безопасности Azure AD и добавьте в нее пользователей.

<a id="key-vault-access-policies"></a> Политики доступа к Key Vault предоставляют доступ отдельно к ключам, секретам и сертификатам. Можно предоставить пользователю доступ только к ключам, но не к секретам. Разрешения на доступ к ключам, секретам и сертификатам устанавливаются на уровне хранилища. Политика доступа к Key Vault не поддерживает детализированные разрешения на уровне объектов, таких как определенный ключ, секрет или сертификат. Чтобы задать политики доступа для хранилища ключей, можно использовать [портал Azure](https://portal.azure.com/), [Azure CLI](../cli-install-nodejs.md), [Azure PowerShell](/powershell/azureps-cmdlets-docs) или [REST API управления Key Vault](https://msdn.microsoft.com/library/azure/mt620024.aspx).

> [!IMPORTANT]
> Политики доступа к Key Vault применяются на уровне хранилища. Если пользователю предоставлено разрешение на создание и удаление ключей, он может выполнять эти операции со всеми ключами в этом хранилище ключей.
>

Можно ограничить доступ к плоскости данных с помощью [конечных точек служб для виртуальной сети для Azure Key Vault](key-vault-overview-vnet-service-endpoints.md). Вы можете настроить [брандмауэры и правила виртуальной сети](key-vault-network-security.md) в качестве дополнительного уровня безопасности.

## <a name="example"></a>Пример

В этом примере разрабатывается приложение, в котором используется сертификат для SSL, служба хранилища Azure для хранения данных и 2048-битный ключ RSA для операций подписывания. Это приложение выполняется на виртуальной машине Azure (или в масштабируемом наборе виртуальных машин). Мы можем использовать хранилище ключей, чтобы хранить секреты приложения. Мы можем сохранить сертификат начальной загрузки, используемый приложением для аутентификации в Azure AD.

Нам нужен доступ к следующим сохраненным ключам и секретам:
- **SSL-сертификат**. Используется для SSL.
- **Ключ хранилища**. Используется для доступа к учетной записи хранения.
- **2048-битный ключ RSA**. Используется для операций подписывания.
- **Сертификат начальной загрузки.** Используется для проверки подлинности с помощью Azure AD. После предоставления доступа можно получить ключ к хранилищу данных и использовать ключ RSA для подписывания.

Нам необходимо определить следующие роли, чтобы указать, кто может развертывать и проверять наше приложение, а также управлять им.
- **Группа безопасности.** Это ИТ-специалисты из отдела руководителя службы безопасности или аналогичного ему. Служба безопасности несет ответственность за надлежащее хранение секретов. Это могут быть SSL-сертификаты, ключи RSA для подписывания, строки подключения для баз данных и ключи учетной записи хранения.
- **Разработчики и операторы**. Сотрудники, которые разрабатывают приложение и развертывают его в Azure. Участники этой команды не являются сотрудниками службы безопасности. Они не должны иметь доступа к конфиденциальным данным, таким как сертификаты SSL и ключи RSA. Только развертываемое ими приложение должно иметь доступ к конфиденциальным данным.
- **Аудиторы.** Эта роль предназначена для участников, не являющихся сотрудниками отдела разработки или общего ИТ-персонала. Они проверяют надлежащее использование и обслуживание сертификатов, ключей и секретов, а также обеспечивают соответствие стандартам безопасности данных. 

Существует другая роль, которая выходит за рамки нашего приложения. Это администратор подписки (или группы ресурсов). Администратор подписки устанавливает начальные права доступа для группы безопасности. Он предоставляет ей доступ с помощью группы ресурсов, которая содержит ресурсы, необходимые для этого приложения.

Нам необходимо авторизовать для наших ролей следующие операции.

**Группа безопасности:**
- создание хранилищ ключей;
- включение ведения журнала Key Vault;
- добавление ключей и секретов;
- создание резервной копии ключей для аварийного восстановления;
- установка политики доступа к Key Vault для предоставления пользователям и приложениям разрешений на выполнение определенных операций;
- периодическое развертывание ключей и секретов.

**Разработчики и операторы:**
- получение от группы безопасности ссылок на сертификаты начальной загрузки и SSL-сертификаты (отпечатки), ключ к хранилищу данных (URI секрета) и ключ RSA (URI ключа) для подписывания;
- разработка и развертывание приложения, которое получает доступ к ключам и секретам программным способом.

**Аудиторы:**
- просмотр журналов Key Vault для подтверждения правильного применения ключей или секретов и соответствия стандартам безопасности данных.

В следующей таблице приведены разрешения доступа для наших ролей и приложения. 

| Role | Разрешения плоскости управления | Разрешения плоскости данных |
| --- | --- | --- |
| Группа безопасности | Участник Key Vault | Ключи: резервное копирование, создание, удаление, получение, импорт, перечисление, восстановление<br>Секреты: все операции |
| Разработчики и&nbsp;операторы | Разрешение на развертывание Key Vault<br><br> **Примечание**. Это разрешение позволяет развернутым виртуальным машинам получать секреты из хранилища ключей. | Отсутствуют |
| Аудиторы | Отсутствуют | Ключи: перечисление<br>Секреты: перечисление<br><br> **Примечание**. Это разрешение позволяет аудиторам проверять атрибуты (теги, даты активации, даты истечения срока действия) ключей и секретов, которые не отправляются в журналы. |
| Приложение | Отсутствуют | Ключи: подписывание<br>Секреты: получение |

Трем ролям группы требуется доступ к другим ресурсам вместе с разрешениями Key Vault. Чтобы иметь возможность развернуть виртуальные машины (или компонент "Веб-приложения" Службы приложений Azure), разработчикам и операторам необходим доступ `Contributor` к таким типам ресурсов. Аудиторам требуется доступ на чтение к учетной записи хранения, где хранятся журналы Key Vault.

Дополнительные сведения о программном развертывании сертификатов, ключей доступа и секретов см. в следующих ресурсах:
- Запись блога о том, [как развернуть сертификаты на виртуальных машинах из хранилища ключей, управляемого клиентом](https://blogs.technet.microsoft.com/kv/2016/09/14/updated-deploy-certificates-to-vms-from-customer-managed-key-vault/).
- Скачайте [примеры клиента Azure Key Vault](https://www.microsoft.com/download/details.aspx?id=45343). В них показано, как с помощью сертификата начальной загрузки выполнить аутентификацию в Azure AD и получить доступ к хранилищу ключей.

Большую часть разрешений на доступ можно предоставить с помощью портала Azure. Чтобы предоставить подробные разрешения, можно использовать Azure PowerShell или Azure CLI.

Фрагменты кода PowerShell в этом разделе написаны исходя из следующих предположений.
- Администратор Azure AD создал группы безопасности, представляющие собой три роли: группу безопасности Contoso, группу разработчиков приложения Contoso и группу аудиторов приложения Contoso. Администратор также добавил пользователей в группы, к которым они относятся.
- Все ресурсы находятся в группе ресурсов **ContosoAppRG**.
- Журналы Key Vault хранятся в учетной записи хранения **contosologstorage**. 
- Хранилище ключей **ContosoKeyVault** и учетная запись хранения **contosologstorage** находятся в одном расположении Azure.

Администратор подписки назначает роли `key vault Contributor` и `User Access Administrator` группе безопасности. Эти роли позволяют группе безопасности управлять доступом к другим ресурсам и хранилищам ключей, которые находятся в группе ресурсов **ContosoAppRG**.

```powershell
New-AzRoleAssignment -ObjectId (Get-AzADGroup -SearchString 'Contoso Security Team')[0].Id -RoleDefinitionName "key vault Contributor" -ResourceGroupName ContosoAppRG
New-AzRoleAssignment -ObjectId (Get-AzADGroup -SearchString 'Contoso Security Team')[0].Id -RoleDefinitionName "User Access Administrator" -ResourceGroupName ContosoAppRG
```

Команда безопасности создает хранилище ключей и настраивает ведение журнала и права доступа. Ознакомиться со сведениями о разрешениях политики доступа Key Vault можно в статье [Сведения о ключах, секретах и сертификатах](about-keys-secrets-and-certificates.md).

```powershell
# Create a key vault and enable logging
$sa = Get-AzStorageAccount -ResourceGroup ContosoAppRG -Name contosologstorage
$kv = New-AzKeyVault -Name ContosoKeyVault -ResourceGroup ContosoAppRG -SKU premium -Location 'westus' -EnabledForDeployment
Set-AzDiagnosticSetting -ResourceId $kv.ResourceId -StorageAccountId $sa.Id -Enabled $true -Category AuditEvent

# Set up data plane permissions for the Contoso Security Team role
Set-AzKeyVaultAccessPolicy -VaultName ContosoKeyVault -ObjectId (Get-AzADGroup -SearchString 'Contoso Security Team')[0].Id -PermissionsToKeys backup,create,delete,get,import,list,restore -PermissionsToSecrets get,list,set,delete,backup,restore,recover,purge

# Set up management plane permissions for the Contoso App DevOps role
# Create the new role from an existing role
$devopsrole = Get-AzRoleDefinition -Name "Virtual Machine Contributor"
$devopsrole.Id = $null
$devopsrole.Name = "Contoso App DevOps"
$devopsrole.Description = "Can deploy VMs that need secrets from a key vault"
$devopsrole.AssignableScopes = @("/subscriptions/<SUBSCRIPTION-GUID>")

# Add permissions for the Contoso App DevOps role so members can deploy VMs with secrets deployed from key vaults
$devopsrole.Actions.Add("Microsoft.KeyVault/vaults/deploy/action")
New-AzRoleDefinition -Role $devopsrole

# Assign the new role to the Contoso App DevOps security group
New-AzRoleAssignment -ObjectId (Get-AzADGroup -SearchString 'Contoso App Devops')[0].Id -RoleDefinitionName "Contoso App Devops" -ResourceGroupName ContosoAppRG

# Set up data plane permissions for the Contoso App Auditors role
Set-AzKeyVaultAccessPolicy -VaultName ContosoKeyVault -ObjectId (Get-AzADGroup -SearchString 'Contoso App Auditors')[0].Id -PermissionsToKeys list -PermissionsToSecrets list
```

Определенную пользовательскую роль можно назначить только подписке, где создана группа ресурсов **ContosoAppRG**. Чтобы использовать пользовательскую роль для других проектов в других подписках, добавьте другие подписки в область роли.

Для наших сотрудников DevOps назначение пользовательских ролей для разрешения `deploy/action` хранилища ключей ограничивается группой ресурсов. Доступ к секретам (SSL-сертификат и сертификат начальной загрузки) могут получить только виртуальные машины, созданные в группе ресурсов **ContosoAppRG**. Виртуальные машины, созданные в других группах ресурсов участником DevOps, не могут получить доступ к этим секретам, даже если у виртуальной машины есть URI секретов.

В этом примере показан простой сценарий. Реальные сценарии могут быть более сложными. Вы можете настроить разрешения для хранилища ключей в соответствии со своими потребностями. Предположим, что группа безопасности предоставляет ссылки на ключ и секрет (URI и отпечатки), которые команда DevOps использует в своих приложениях. Разработчикам и операторам не требуется доступ к плоскости данных. Эта статья была посвящена вопросам, связанным с безопасностью хранилища ключей. Похожие рекомендации следует также учитывать при обеспечении защиты [виртуальных машин](https://azure.microsoft.com/services/virtual-machines/security/), [учетных записей хранения](../storage/common/storage-security-guide.md) и других ресурсов Azure.

> [!NOTE]
> В этом примере показано, как доступ к Key Vault будет заблокирован в рабочей среде. У разработчиков должна быть своя подписка или группа ресурсов с полным набором разрешений на управление своими хранилищами, виртуальными машинами, а также учетная запись хранения, в которой они разрабатывают приложения.

Рекомендуем [настроить брандмауэры и виртуальные сети Key Vault](key-vault-network-security.md), чтобы дополнительно обеспечить безопасный доступ к хранилищу ключей.

## <a name="resources"></a>Ресурсы

* [Управление доступом с помощью RBAC и портала Azure](../role-based-access-control/role-assignments-portal.md)

* [Сведения о встроенных ролях встроенные роли](../role-based-access-control/built-in-roles.md).

* [Azure Resource Manager и классическое развертывание: сведения о моделях развертывания и состоянии ресурсов](../azure-resource-manager/resource-manager-deployment-model.md) 

* [Управление доступом с помощью RBAC и Azure PowerShell](../role-based-access-control/role-assignments-powershell.md) 

* [Управление доступом с помощью RBAC и REST API](../role-based-access-control/role-assignments-rest.md)

* [Видео с конференции Ignite по управлению доступом на основе ролей в Microsoft Azure](https://channel9.msdn.com/events/Ignite/2015/BRK2707)

    На этой видеоконференции Microsoft Ignite 2015 обсуждаются возможности управления доступом и отчетности в Azure, а также рассматриваются лучшие методы защиты доступа к подпискам Azure с помощью Azure AD.

* [Авторизация доступа к веб-приложениям Azure Active Directory с помощью потока предоставления кода OAuth 2.0](../active-directory/develop/v1-protocols-oauth-code.md)

* [Сведения об интерфейсах REST API для управления Key Vault](https://msdn.microsoft.com/library/azure/mt620024.aspx).

    Этот руководство по REST API для управления хранилищем ключей программными средствами, включая настройку политики доступа к Key Vault.

* [Сведения об интерфейсах REST API Key Vault](https://msdn.microsoft.com/library/azure/dn903609.aspx).

* [Контроль доступа к ключам](https://msdn.microsoft.com/library/azure/dn903623.aspx#BKMK_KeyAccessControl)
  
* [Контроль доступа к секретам](https://msdn.microsoft.com/library/azure/dn903623.aspx#BKMK_SecretAccessControl)
  
* Сведения о [настройке](/powershell/module/az.keyvault/Set-azKeyVaultAccessPolicy) и [удалении](/powershell/module/az.keyvault/Remove-azKeyVaultAccessPolicy) политики доступа к Key Vault с помощью PowerShell.
  
## <a name="next-steps"></a>Следующие шаги

[Настройка брандмауэров и виртуальных сетей Azure Key Vault](key-vault-network-security.md)

Руководство по началу работы для администраторов см. в статье [Что такое Azure Key Vault?](key-vault-overview.md)

Дополнительные сведения о ведении журнала использования для хранилища ключей см. в статье [Ведение журнала Azure Key Vault](key-vault-logging.md).

Дополнительные сведения об использовании ключей и секретов с помощью Azure Key Vault см. в [этой статье](https://msdn.microsoft.com/library/azure/dn903623.aspx).

Если у вас возникли вопросы о Key Vault, посетите [форумы](https://social.msdn.microsoft.com/forums/azure/home?forum=AzureKeyVault).
