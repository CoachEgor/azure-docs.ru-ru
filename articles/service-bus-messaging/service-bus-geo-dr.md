---
title: Географическое аварийное восстановление в служебной шине Azure | Документация Майкрософт
description: Способы использования географических регионов для отработки отказа и аварийного восстановления в служебной шине Azure
ms.topic: article
ms.date: 06/23/2020
ms.openlocfilehash: 8c203ed197c1e5bfb15cfb503a04df79b85c630e
ms.sourcegitcommit: 5dbea4631b46d9dde345f14a9b601d980df84897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2020
ms.locfileid: "91372529"
---
# <a name="azure-service-bus-geo-disaster-recovery"></a>Географическое аварийное восстановление в служебной шине Azure

При простое целых регионов Azure или центров обработки данных (если не используются [зоны доступности](../availability-zones/az-overview.md)) крайне важно, чтобы обработка данных продолжала работать в другом регионе или центре обработки данных. Таким образом *геоизбыточное аварийное восстановление* является важной функцией для любого предприятия. Служебная шина Azure поддерживает геоизбыточное аварийное восстановление на уровне пространства имен.

Функция географического аварийного восстановления глобально доступна для SKU "Премиум" служебной шины. 

>[!NOTE]
> Геоизбыточное аварийное восстановление в настоящее время только гарантирует, что метаданные (очереди, разделы, подписки, фильтры) копируются из основного пространства имен в дополнительное пространство имен, если они настроены как парные.

## <a name="outages-and-disasters"></a>Сбои и аварийные ситуации

Важно отметить различия между "сбоями" и "авариями". 

*Сбой* — это временная недоступность служебной шины Azure. Он может повлиять на некоторые компоненты службы, такие как хранилище сообщений, или даже весь центр обработки данных. Однако после устранения проблемы служебная шина снова становится доступной. Как правило, простой не приводит к утрате сообщений или других данных. Примером такого сбоя может быть сбой питания в центре обработки данных. Некоторые сбои являются всего лишь короткими потерями подключения из-за временных или сетевых проблем. 

*Авария* определяется как полная или долговременная потеря кластера служебной шины, региона Azure или центра обработки данных. Регион или центр обработки данных может снова стать доступным, но может и не стать или быть отключенным в течение нескольких часов или дней. Примеры аварий — пожар, наводнение или землетрясение. Длительное аварийное состояние может привести к потере некоторых сообщений, событий или других данных. Но в большинстве случаев потеря данных не происходит и сообщения можно восстановить сразу же после резервного копирования в центре обработки данных.

Функция географического аварийного восстановления служебной шины Azure — это решение для аварийного восстановления. Основные понятия и рабочий процесс, описанные в этой статье, относятся к сценариям восстановления после аварий, но не временных сбоев. Дополнительные сведения об аварийном восстановлении в Microsoft Azure см. в статье [Аварийное восстановление для приложений на платформе Azure](/azure/architecture/resiliency/disaster-recovery-azure-applications).   

## <a name="basic-concepts-and-terms"></a>Основные понятия и термины

Функция аварийного восстановления реализует аварийное восстановление метаданных и основывается на первичном и вторичном пространстве имен для аварийного восстановления. Обратите внимание, что функция географического аварийного восстановления доступна только для [SKU "Премиум"](service-bus-premium-messaging.md). Вам не нужно изменять какие-либо строки подключения, так как соединение выполняется через псевдоним.

В этом руководстве используются термины, представленные ниже.

-  *Псевдоним*. Имя настроенной конфигурации аварийного восстановления. Псевдоним предоставляет единую стабильную строку подключения полного доменного имени (FQDN). Приложения используют ее для подключения к пространству имен. Использование псевдонимов гарантирует, что строка подключения не изменится, когда активируется отработка отказа.

-  *Основное или дополнительное пространство имен*. Пространство имен, соответствующее псевдониму. Основное пространство имен является "активным" и получает сообщения (это может быть существующее или новое пространство имен). Дополнительное пространство имен является "пассивным" и не получает сообщений. Метаданные между ними синхронизированы, поэтому они могут беспрепятственно принимать сообщения без каких-либо изменений кода или строки подключения приложения. Чтобы убедиться, что только активное пространство имен получает сообщения, необходимо использовать псевдоним. 

-  *Метаданные*. Сущности, такие как очереди, разделы и подписки, и их свойства службы, связанные с пространством имен. Обратите внимание, что только сущности и их параметры реплицируются автоматически. Сообщения не реплицируются.

-  *Отработка отказа*. Процесс активации дополнительного пространства имен.

## <a name="setup"></a>Настройка

В следующем разделе рассматривается настройка парных пространств имен.

![1][]

Вот как это можно сделать.

1. Подготовьте ***основное*** пространство имен служебной шины ценовой категории "Премиум".

2. Подготовьте ***дополнительное*** пространство имен служебной шины ценовой категории "Премиум" в регионе, *отличном от региона, в котором подготовлено основное пространство имен*. Это поможет изолировать сбои в разных регионах размещения центров обработки данных.

3. Создайте связь между основным и дополнительным пространствами имен, чтобы получить ***псевдоним***.

    >[!NOTE] 
    > Если вы [перенесли пространство имен Служебной шины Azure категории "Стандартный" в Служебную шину Azure категории "Премиум"](service-bus-migrate-standard-premium.md), необходимо использовать существующий псевдоним (т. е. строку подключения к пространству имен Служебной шины категории "Стандартный"), чтобы создать конфигурацию аварийного восстановления через **PS/CLI** или **REST API**.
    >
    >
    > Это связано с тем, что во время миграции имя строки подключения или DNS для пространства имен Служебной шины Azure категории "Стандартный" становится псевдонимом для пространства имен Служебной шины Azure категории "Премиум".
    >
    > Клиентские приложения должны использовать этот псевдоним (т. е. строку подключения к пространству имен Служебной шины Azure категории "Стандартный") для подключения к пространству имен службы категории"Премиум", в котором была установлена пара аварийного восстановления.
    >
    > Если вы используете портал для настройки конфигурации аварийного восстановления, портал выдаст это предостережение.


4. Используйте ***псевдоним***, полученный на шаге 3, для подключения клиентских приложений к основному пространству имен с поддержкой геоизбыточного аварийного восстановления. Изначально псевдоним указывает на основное пространство имен.

5. [Необязательно.] Добавьте некоторые функции мониторинга, чтобы определить, необходимо ли выполнять отработку отказа.

## <a name="failover-flow"></a>Поток отработки отказа

Отработка отказа активируется клиентом вручную (явно командой или посредством клиента с бизнес-логикой, которая выполняет команду), а не Azure. Это дает клиенту полный контроль и видимость для устранения сбоя в магистрали Azure.

![4][]

После активации отработки отказа происходит следующее.

1. Строка подключения с ***псевдонимом*** обновляется и указывает на дополнительное пространство имен ценовой категории "Премиум".

2. Клиенты (отправители и получатели) автоматически подключаются к дополнительному пространству имен.

3. Существующая связь между основным и дополнительным пространствами имен ценовой категории "Премиум" разрывается.

После инициирования отработки отказа происходит следующее.

1. В случае другого сбоя необходимо иметь возможность повторной отработки отказа. Поэтому настройте другое пассивное пространство имен и обновите связывание. 

2. Извлеките сообщения из прежнего основного пространства имен, как только оно станет доступным. После этого используйте это пространство имен для регулярного обмена сообщениями вне настройки географического восстановления или удалите старое основное пространство имен.

> [!NOTE]
> Поддерживается только семантика переадресации сбоя. В этом сценарии выполняется отработка отказа, а затем повторное связывание с новым пространством имен. Восстановление размещения не поддерживается, к примеру, в кластере SQL. 

Отработку отказа можно автоматизировать с помощью систем мониторинга или пользовательских решений для мониторинга. Однако такая автоматизация требует дополнительного планирования и работы, что выходит за рамки данной статьи.

![2][]

## <a name="management"></a>Управление

Если допущена ошибка, например, во время первоначальной настройки связаны неправильные регионы, связь двух пространств имен можно разорвать в любое время. Если вы хотите использовать сопряженные пространства имен в качестве обычных пространств имен, удалите псевдоним.

## <a name="use-existing-namespace-as-alias"></a>Использование имеющихся пространств имен в качестве псевдонима

При наличии сценария, в котором невозможно изменить подключения отправителей и потребителей, можно повторно использовать имя пространства имен в качестве псевдонима. Дополнительные сведения см. в [примере кода на GitHub](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/SBGeoDR2/SBGeoDR_existing_namespace_name).

## <a name="samples"></a>Примеры

В [примере из GitHub](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/SBGeoDR2/) показано, как настроить и инициировать отработку отказа. В этих примерах демонстрируются следующие понятия:

- Пример .NET и параметры, необходимые в Azure Active Directory для настройки и включения географически избыточного восстановления с помощью Azure Resource Manager и служебной шины.
- шаги, необходимые для выполнения примера кода;
- Использование имеющегося пространства имен в качестве псевдонима.
- Инструкции по включению географически избыточного восстановления с помощью PowerShell или CLI.
- [Отправка и получение](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/TestGeoDR/ConsoleApp1) из текущего основного и дополнительного пространства имен с помощью псевдонима.

## <a name="considerations"></a>Рекомендации

Обратите внимание на следующие моменты для этого выпуска:

1. При планировании отработки отказа следует также учитывать фактор времени. Например, в случае потери подключения на более чем 15–20 минут можно запустить отработку отказа.

2. Тот факт, что данные не реплицируются, означает, что в настоящее время активные сеансы не реплицируются. Кроме того, обнаружение дубликатов и запланированные сообщения могут не работать. Новые сеансы, новые запланированные сообщения и новые дубликаты будут работать. 

3. Отработку отказа сложной распределенной инфраструктуры необходимо [протестировать](/azure/architecture/reliability/disaster-recovery#disaster-recovery-plan) по крайней мере один раз.

4. Синхронизация сущностей может занять некоторое время (примерно 50–100 сущностей в минуту). Подписки и правила также учитываются как сущности.

## <a name="availability-zones"></a>зоны доступности;

SKU уровня "Премиум" служебной шины также поддерживает [зоны доступности](../availability-zones/az-overview.md), предоставляя изолированные от сбоев места в регионе Azure.

> [!NOTE]
> Поддержка Зон доступности Служебной шины Azure ценовой категории "Премицм"доступна только в [регионах Azure](../availability-zones/az-region.md), в которых представлены зоны доступности.

Вы можете включить эту функцию только в новых пространствах имен с помощью портала Azure. Служебная шина не поддерживает миграцию существующих пространств имен. Вы не можете отключить избыточность в пределах зоны после ее включения в пространстве имен.

![3][]

## <a name="private-endpoints"></a>Частные конечные точки
В этом разделе приводятся дополнительные рекомендации при использовании геоизбыточного аварийного восстановления с пространствами имен, в которых используются частные конечные точки. Дополнительные сведения об использовании частных конечных точек со Служебной шиной см. в статье [Интеграция Служебной шины Azure с Приватным каналом Azure](private-link-service.md).

### <a name="new-pairings"></a>Новые пары
При попытке создать пару между основным пространством имен с частной конечной точкой и дополнительным пространством имен без частной конечной точки связывание завершится ошибкой. Связывание выполнится успешно, только если у основного и дополнительного пространства имен есть частные конечные точки. Рекомендуется использовать одинаковые конфигурации в основном и дополнительном пространствах имен и в виртуальных сетях, в которых создаются частные конечные точки. 

> [!NOTE]
> При попытке связать основное пространство имен с частной конечной точкой и дополнительное пространство имен проверяется только, существует ли частная конечная точка в дополнительном пространстве имен. Не проверяется, работает ли конечная точка и будет ли она работать после отработки отказа. Вы должны убедиться, что дополнительное пространство имен с частной конечной точкой будет корректно работать после отработки отказа.
>
> Чтобы проверить, совпадают ли конфигурации частных конечных точек, отправьте запрос [Получить очереди](/rest/api/servicebus/stable/queues/get) к дополнительному пространству имен из-за пределов виртуальной сети и убедитесь, что служба выдает сообщение об ошибке.

### <a name="existing-pairings"></a>Существующие пары
Если связывание между основным и дополнительным пространством имен уже существует, создание частной конечной точки в основном пространстве имен завершится ошибкой. Чтобы устранить эту проблему, сначала создайте частную конечную точку в дополнительном пространстве имен, а затем — в основном.

> [!NOTE]
> Хотя мы допускаем доступ только для чтения к дополнительному пространству имен, обновление конфигураций частных конечных точек разрешено. 

### <a name="recommended-configuration"></a>Рекомендуемая конфигурация
При создании конфигурации аварийного восстановления для приложения и Служебной шины необходимо создать частные конечные точки для основного и дополнительного пространств имен Служебной шины для виртуальных сетей, в которых размещаются как первичные, так и вторичные экземпляры приложения.

Предположим, у вас есть две виртуальные сети (VNET-1, VNET-2) и основное и дополнительное пространства имен: ServiceBus-Namespace1-Primary, ServiceBus-Namespace2-Secondary. Сделайте следующее: 

- В ServiceBus-Namespace1-Primary создайте две частные конечные точки, которые используют подсети VNET-1 и VNET-2
- В ServiceBus-Namespace2-Secondary создайте две частные конечные точки, которые используют подсети VNET-1 и VNET-2 

![Частные конечные точки и виртуальные сети](./media/service-bus-geo-dr/private-endpoints-virtual-networks.png)


Преимуществом этого подхода является то, что отработка отказа может происходить на уровне приложения независимо от пространства имен Служебной шины. Рассмотрим следующие сценарии. 

**Отработка отказа только на уровне приложения:** Здесь приложение не будет существовать в VNET-1, но будет перемещено в VNET-2. Так как обе частные конечные точки настроены в VNET-1 и VNET-2 как для основного, так и для дополнительного пространства имен, приложение будет работать. 

**Отработка отказа только в пространстве имен Служебной шины**: И здесь, так как обе частные конечные точки настроены в обеих виртуальных сетях как для основного, так и для дополнительного пространства имен, приложение будет работать. 

> [!NOTE]
> Рекомендации по геоизбыточному аварийному восстановлению виртуальной сети см. в статье [Виртуальная сеть — непрерывность бизнес-процессов](../virtual-network/virtual-network-disaster-recovery-guidance.md).

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь со справочными материалами по [REST API для географического аварийного восстановления](/rest/api/servicebus/stable/disasterrecoveryconfigs).
- Запустите пример географического аварийного восстановления [на GitHub](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/SBGeoDR2/SBGeoDR2).
- Ознакомьтесь с примером [географического аварийного восстановления, отправляющим сообщения псевдониму](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/TestGeoDR/ConsoleApp1).

Дополнительную информацию об обмене сообщениями через служебную шину см. в следующих статьях:

* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)
* [Azure Service Bus REST API](/rest/api/servicebus/) (REST API служебной шины Azure) 

[1]: ./media/service-bus-geo-dr/geodr_setup_pairing.png
[2]: ./media/service-bus-geo-dr/geo2.png
[3]: ./media/service-bus-geo-dr/az.png
[4]: ./media/service-bus-geo-dr/geodr_failover_alias_update.png
