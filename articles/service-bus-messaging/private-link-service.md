---
title: Интеграция служебной шины Azure со службой частной связи Azure
description: Узнайте, как интегрировать служебную шину Azure со службой "Частная связь Azure"
services: service-bus-messaging
author: spelluru
ms.author: spelluru
ms.date: 03/13/2020
ms.service: service-bus-messaging
ms.topic: article
ms.openlocfilehash: f456137b61a96f555b2604e7871516fd1d38ab42
ms.sourcegitcommit: f7d057377d2b1b8ee698579af151bcc0884b32b4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/24/2020
ms.locfileid: "82116712"
---
# <a name="integrate-azure-service-bus-with-azure-private-link-preview"></a>Интеграция служебной шины Azure с частной ссылкой Azure (Предварительная версия)

Служба "Частная связь Azure" позволяет получать доступ к службам Azure (например, служебной шине Azure, службе хранилища Azure и Azure Cosmos DB) и службам клиентов и партнеров Azure, размещенным в **частной конечной точке** в виртуальной сети.

Частная конечная точка — это сетевой интерфейс, который обеспечивает безопасное и надежное подключение к службе с помощью частной связи Azure. Частная конечная точка использует частный IP-адрес из виртуальной сети, по сути перемещая службу в виртуальную сеть. Весь трафик к службе может маршрутизироваться через частную конечную точку, поэтому шлюзы, устройства преобразования сетевых адресов (NAT), подключения ExpressRoute и VPN, а также общедоступные IP-адреса не требуются. Трафик между виртуальной сетью и службой проходит через магистральную сеть Майкрософт, что позволяет избежать рисков общедоступного Интернета. Вы можете подключиться к экземпляру ресурса Azure, обеспечивая наивысшую степень детализации в управлении доступом.

Дополнительные сведения см. в статье [Что такое Приватный канал Azure](../private-link/private-link-overview.md).

>[!WARNING]
> Реализация частных конечных точек может препятствовать взаимодействию других служб Azure с служебной шиной.
>
> Доверенные службы Майкрософт не поддерживаются, если реализованы виртуальные сети.
>
> Распространенные сценарии Azure, которые не работают с виртуальными сетями (обратите внимание, что список **НЕ** является исчерпывающим):
> - Интеграция со службой "Сетка событий Azure".
> - Маршруты Центра Интернета вещей Azure.
> - Device Explorer Интернета вещей Azure.
>
> В виртуальной сети должны присутствовать следующие службы Майкрософт:
> - Служба приложений Azure
> - Функции Azure

> [!IMPORTANT]
> Эта функция поддерживается на уровне **Premium** служебной шины Azure. Дополнительные сведения о категории Premium см. в статье [уровни обмена сообщениями служебной шины Premium и Standard](service-bus-premium-messaging.md) .
>
> Сейчас эта функция доступна в **предварительной версии**. 


## <a name="add-a-private-endpoint-using-azure-portal"></a>Добавление частной конечной точки с помощью портал Azure

### <a name="prerequisites"></a>Предварительные условия

Чтобы интегрировать пространство имен служебной шины с частной ссылкой Azure, вам потребуются следующие сущности или разрешения:

- Пространство имен служебной шины.
- Виртуальная сеть Azure.
- Подсеть в виртуальной сети.
- Разрешения владельца или участника для пространства имен служебной шины и виртуальной сети.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. При выборе региона для частной конечной точки с помощью портала будут автоматически фильтроваться только виртуальные сети в этом регионе. Пространство имен служебной шины может находиться в другом регионе. И частная конечная точка использует частный IP-адрес в виртуальной сети.

### <a name="steps"></a>steps

Если у вас уже есть пространство имен, можно создать частную конечную точку, выполнив следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com). 
2. В строке поиска введите **служебная шина**.
3. Выберите **пространство имен** из списка, в который необходимо добавить частную конечную точку.
4. Выберите вкладку **сети** в разделе **Параметры**.
5. Выберите вкладку **подключения к частным конечным точкам (Предварительная версия)** в верхней части страницы.
6. Нажмите кнопку **+ Частная конечная точка** в верхней части страницы.

    ![Кнопка добавления закрытой конечной точки](./media/private-link-service/private-link-service-3.png)
7. На странице **Основные сведения** выполните следующие действия. 
    1. Выберите **подписку Azure** , в которой вы хотите создать закрытую конечную точку. 
    2. Выберите **группу ресурсов** для ресурса частной конечной точки.
    3. Введите **имя** частной конечной точки. 
    5. Выберите **регион** для закрытой конечной точки. Частная конечная точка должна находиться в том же регионе, что и виртуальная сеть, но может находиться в другом регионе, из ресурс закрытой ссылки, к которому вы подключаетесь. 
    6. Нажмите кнопку **Далее: >ресурсов** в нижней части страницы.

        ![Создание частной конечной точки — страница "Основные сведения"](./media/private-link-service/create-private-endpoint-basics-page.png)
8. На странице **ресурсов** выполните следующие действия.
    1. Если **в моем каталоге выбран вариант подключиться к ресурсу Azure**, то для метода подключения выполните следующие действия.   
        1. Выберите **подписку Azure** , в которой существует **пространство имен служебной шины** . 
        2. Для типа **ресурса**выберите **Microsoft. servicebus/Namespaces** для **типа ресурса**.
        3. В поле **ресурс**выберите пространство имен служебной шины из раскрывающегося списка. 
        4. Убедитесь, что **целевой подресурс** имеет значение **пространство имен**.
        5. Нажмите кнопку **Далее: >конфигурации** в нижней части страницы. 
        
            ![Создание частной конечной точки — страница ресурсов](./media/private-link-service/create-private-endpoint-resource-page.png)
    2. Если вы выбрали **подключиться к ресурсу Azure по идентификатору или псевдониму ресурса**, выполните следующие действия.
        1. Введите идентификатор или **псевдоним** **ресурса** . Это может быть идентификатор ресурса или псевдоним, к которому вам предоставили доступ некоторые.
        2. В качестве **целевого вспомогательного ресурса**введите **Namespace**. Это тип подресурса, к которому имеет доступ частная конечная точка. 
        3. используемых Введите **сообщение запроса**. Владелец ресурса видит это сообщение при управлении подключением к частной конечной точке. 
        4. Затем нажмите кнопку **Далее: настройка >** в нижней части страницы. 

            ![Создание частной конечной точки — подключение с использованием идентификатора ресурса](./media/private-link-service/connect-resource-id.png)
9. На странице **Конфигурация** выберите подсеть в виртуальной сети, в которую требуется развернуть закрытую конечную точку. 
    1. Выберите **виртуальную сеть**. В раскрывающемся списке перечислены только виртуальные сети в выбранной подписке и расположении. 
    2. Выберите **подсеть** в выбранной виртуальной сети. 
    3. Нажмите кнопку **Далее: теги >** в нижней части страницы. 

        ![Создание частной конечной точки — страница конфигурации](./media/private-link-service/create-private-endpoint-configuration-page.png)
10. На странице **теги** создайте теги (имена и значения), которые нужно связать с ресурсом частной конечной точки. Затем в нижней части страницы нажмите кнопку **Просмотр и создание** . 
11. На странице **Просмотр и создание**проверьте все параметры и выберите **создать** , чтобы создать частную конечную точку.
    
    ![Создание закрытой конечной точки — Просмотр и создание страницы](./media/private-link-service/create-private-endpoint-review-create-page.png)
12. Убедитесь, что закрытая конечная точка создана. Если вы являетесь владельцем ресурса и выбрали параметр **подключиться к ресурсу Azure в моем каталоге** для **метода подключения**, то подключение к конечной точке должно быть **утверждено как автоматическое утверждение**. Если он находится в состоянии **ожидания** , см. раздел [управление частными конечными точками с помощью портал Azure](#manage-private-endpoints-using-azure-portal) .

    ![Закрытая конечная точка создана](./media/private-link-service/private-endpoint-created.png)

## <a name="add-a-private-endpoint-using-powershell"></a>Добавление частной конечной точки с помощью PowerShell
В следующем примере показано, как использовать Azure PowerShell для создания частного подключения конечной точки к пространству имен служебной шины.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. Пространство имен служебной шины может находиться в другом регионе. И частная конечная точка использует частный IP-адрес в виртуальной сети.

```azurepowershell-interactive

$rgName = "<RESOURCE GROUP NAME>"
$vnetlocation = "<VNET LOCATION>"
$vnetName = "<VIRTUAL NETWORK NAME>"
$subnetName = "<SUBNET NAME>"
$namespaceLocation = "<NAMESPACE LOCATION>"
$namespaceName = "<NAMESPACE NAME>"
$peConnectionName = "<PRIVATE ENDPOINT CONNECTION NAME>"

# create resource group
az group create -l $vnetLocation -n $rgName

# create virtual network
$virtualNetwork = New-AzVirtualNetwork `
                    -ResourceGroupName $rgName `
                    -Location $vnetlocation `
                    -Name $vnetName `
                    -AddressPrefix 10.0.0.0/16

# create subnet with endpoint network policy disabled
$subnetConfig = Add-AzVirtualNetworkSubnetConfig `
                    -Name $subnetName `
                    -AddressPrefix 10.0.0.0/24 `
                    -PrivateEndpointNetworkPoliciesFlag "Disabled" `
                    -VirtualNetwork $virtualNetwork

# update virtual network
$virtualNetwork | Set-AzVirtualNetwork

# create premium service bus namespace
$namespaceResource = New-AzResource -Location $namespaceLocation -ResourceName $namespaceName -ResourceGroupName $rgName -Sku @{name = "Premium"; capacity = 1} -Properties @{} -ResourceType "Microsoft.ServiceBus/namespaces" -

# create a private link service connection
$privateEndpointConnection = New-AzPrivateLinkServiceConnection `
                                -Name $peConnectionName `
                                -PrivateLinkServiceId $namespaceResource.ResourceId `
                                -GroupId "namespace"

# get subnet object that you will use in the next step                                
$virtualNetwork = Get-AzVirtualNetwork -ResourceGroupName  $rgName -Name $vnetName
$subnet = $virtualNetwork | Select -ExpandProperty subnets `
                                | Where-Object  {$_.Name -eq $subnetName}  
   
# now, create private endpoint   
$privateEndpoint = New-AzPrivateEndpoint -ResourceGroupName $rgName  `
                                -Name $vnetName   `
                                -Location $vnetlocation `
                                -Subnet  $subnet   `
                                -PrivateLinkServiceConnection $privateEndpointConnection

(Get-AzResource -ResourceId $namespaceResource.ResourceId -ExpandProperties).Properties


```


## <a name="manage-private-endpoints-using-azure-portal"></a>Управление частными конечными точками с помощью портал Azure

При создании частной конечной точки подключение должно быть утверждено. Если ресурс, для которого создается частная конечная точка, находится в вашем каталоге, вы можете утвердить запрос на подключение, если у вас есть необходимые разрешения. При подключении к ресурсу Azure в другом каталоге необходимо дождаться, пока владелец этого ресурса утвердит запрос на подключение.

Существует четыре состояния подготовки:

| Действие службы | Состояние частной конечной точки объекта-получателя службы | Описание |
|--|--|--|
| None | Ожидает | Подключение создается вручную и ожидает утверждения от владельца ресурса Приватного канала. |
| Утверждение | Approved | Подключение утверждено автоматически или вручную и готово к использованию. |
| Reject | Отклонено | Подключение отклонил владелец ресурса Приватного канала. |
| Удалить | Отключено | Подключение удалил владелец ресурса Приватного канала. Частная конечная точка станет информативной и подлежит удалению для очистки. |
 
###  <a name="approve-reject-or-remove-a-private-endpoint-connection"></a>Утверждение, отклонение или удаление подключения к частной конечной точке

1. Войдите на портал Azure.
1. В строке поиска введите **служебная шина**.
1. Выберите **пространство имен** , которым требуется управлять.
1. Перейдите на вкладку **сети** .
5. Перейдите к соответствующему разделу в зависимости от операции, которую нужно выполнить: утвердить, отклонить или удалить. 

### <a name="approve-a-private-endpoint-connection"></a>Утверждение подключения к частной конечной точке

1. Если ожидаются какие-либо подключения, в состоянии подготовки вы увидите подключение в списке **Ожидание** . 
2. Выберите **закрытую конечную точку** , которую вы хотите утвердить
3. Нажмите кнопку **утвердить** .

    ![Утвердить закрытую конечную точку](./media/private-link-service/private-endpoint-approve.png)
4. На странице **утверждение соединения** введите необязательный **Комментарий**и нажмите кнопку **Да**. Если выбрано значение **нет**, ничего не происходит. 

    ![Страница «утверждение соединения»](./media/private-link-service/approve-connection-page.png)
5. Вы увидите, что состояние соединения в списке изменено на **утверждено**. 

    ![Состояние подключения — утверждено](./media/private-link-service/connection-status-approved.png)

### <a name="reject-a-private-endpoint-connection"></a>Отклонение подключения к частной конечной точке

1. Если существуют подключения к частным конечным точкам, которые вы хотите отклонить, будь то ожидающий запрос или существующее подключение, которое было утверждено ранее, выберите подключение к конечной точке и нажмите кнопку **отклонить** .

    ![Кнопка "отклонить"](./media/private-link-service/private-endpoint-reject.png)
2. На странице **отклонить подключение** введите необязательный комментарий и нажмите кнопку **Да**. Если выбрано значение **нет**, ничего не происходит. 

    ![Страница «отклонение соединения»](./media/private-link-service/reject-connection-page.png)
3. Состояние подключения должно отобразиться в списке **отклонено**. 

    ![Конечная точка отклонена](./media/private-link-service/endpoint-rejected.png)


### <a name="remove-a-private-endpoint-connection"></a>Удаление подключения к частной конечной точке

1. Чтобы удалить подключение к частной конечной точке, выберите его в списке и нажмите кнопку **Удалить** на панели инструментов. 

    ![Кнопка "Удалить"](./media/private-link-service/remove-endpoint.png)
2. На странице **Удаление подключения** выберите **Да** , чтобы подтвердить удаление закрытой конечной точки. Если выбрано значение **нет**, ничего не происходит. 

    ![Страница «Удаление соединения»](./media/private-link-service/delete-connection-page.png)
3. Вы увидите, что состояние изменилось на **отключено**. Затем вы увидите, что конечная точка исчезнет из списка. 

## <a name="validate-that-the-private-link-connection-works"></a>Проверка работоспособности подключения Приватного канала

Необходимо проверить, что ресурсы в одной подсети ресурса частной конечной точки подключаются к пространству имен служебной шины по частному IP-адресу и что они имеют правильную интеграцию частной зоны DNS.

Сначала создайте виртуальную машину, выполнив действия, описанные в статье [Краткое руководство. Создание виртуальной машины Windows на портале Azure](../virtual-machines/windows/quick-create-portal.md).

На вкладке **Сетевые подключения** выполните следующие действия.

1. Укажите **виртуальную сеть** и **подсеть**. Можно создать виртуальную сеть или выбрать существующую. При выборе существующей сети убедитесь, что регион соответствует.
1. Укажите ресурс **общедоступного IP-адреса** .
1. Для **группы безопасности сети сетевой карты**выберите **нет**.
1. Для **балансировки нагрузки**выберите **нет**.

Откройте командную строку и выполните следующую команду:

```console
nslookup <your-service-bus-namespace-name>.servicebus.windows.net
```

Если выполнить команду NS Lookup для разрешения IP-адреса пространства имен служебной шины на общедоступную конечную точку, вы увидите результат, который выглядит следующим образом:

```console
c:\ >nslookup <your-service-bus-namespace-name>.servicebus.windows.net

Non-authoritative answer:
Name:    
Address:  (public IP address)
Aliases:  <your-service-bus-namespace-name>.servicebus.windows.net
```

Если выполнить команду NS Lookup, чтобы разрешить IP-адрес пространства имен служебной шины через частную конечную точку, вы увидите результат, который выглядит следующим образом:

```console
c:\ >nslookup your_service-bus-namespace-name.servicebus.windows.net

Non-authoritative answer:
Name:    
Address:  10.1.0.5 (private IP address)
Aliases:  <your-service-bus-namespace-name>.servicebus.windows.net
```

## <a name="limitations-and-design-considerations"></a>Проблемы и ограничения разработки

**Цены**. Сведения о ценах на службу "Приватный канал Azure" см. [здесь](https://azure.microsoft.com/pricing/details/private-link/).

**Ограничения**. Частная конечная точка служебной шины Azure доступна в общедоступной предварительной версии. Эта возможность есть во всех общедоступных регионах Azure.

**Максимальное количество частных конечных точек на пространство имен служебной шины**: 120.

Дополнительные сведения см. в разделе [Azure Private Link service: Limitations](../private-link/private-link-service-overview.md#limitations) (Служба "Приватный канал Azure". Ограничения)

## <a name="next-steps"></a>Next Steps

- Дополнительные сведения о службе [Приватный канал Azure](../private-link/private-link-service-overview.md)
- Дополнительные сведения о [служебной шине Azure](service-bus-messaging-overview.md)
