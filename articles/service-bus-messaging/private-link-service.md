---
title: Интеграция автобуса службы Azure с сервисом Azure Private Link
description: Узнайте, как интегрировать автобус службы Azure с службой частных ссылк Azure
services: service-bus-messaging
author: spelluru
ms.author: spelluru
ms.date: 03/13/2020
ms.service: service-bus-messaging
ms.topic: article
ms.openlocfilehash: b8c4248b7275ac96acce96f890f6ff0148116f48
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79478010"
---
# <a name="integrate-azure-service-bus-with-azure-private-link-preview"></a>Интеграция сервисного автобуса Azure с частной ссылкой Azure (Предварительный просмотр)

Служба частных ссылок Azure позволяет получить доступ к службам Azure (например, Azure Service Bus, Azure Storage и Azure Cosmos DB) и Azure размещает услуги клиентов/партнеров через **частную конечную точку** в виртуальной сети.

Частная конечная точка — это сетевой интерфейс, который соединяет вас в частном порядке и надежно к службе, работающей на Azure Private Link. Частная конечная точка использует частный IP-адрес из виртуальной сети, по сути перемещая службу в виртуальную сеть. Весь трафик к службе может маршрутизироваться через частную конечную точку, поэтому шлюзы, устройства преобразования сетевых адресов (NAT), подключения ExpressRoute и VPN, а также общедоступные IP-адреса не требуются. Трафик между виртуальной сетью и службой проходит через магистральную сеть Майкрософт, что позволяет избежать рисков общедоступного Интернета. Вы можете подключиться к экземпляру ресурса Azure, обеспечивая наивысшую степень детализации в управлении доступом.

Для получения дополнительной [What is Azure Private Link?](../private-link/private-link-overview.md) информации см.

> [!NOTE]
> Эта функция поддерживается **премиум-уровнем** сервиса Azure Bus. Для получения дополнительной информации о премиальном уровне можно ознакомиться в статье [Service Bus Premium и Standard messaging tiers.](service-bus-premium-messaging.md)
>
> Эта функция в настоящее время в **предварительном просмотре**. 


## <a name="add-a-private-endpoint-using-azure-portal"></a>Добавление частной конечных точек с помощью портала Azure

### <a name="prerequisites"></a>Предварительные требования

Для интеграции пространства имен Sbus с Azure Private Link вам потребуются следующие сущности или разрешения:

- Пространство имен сервисного автобуса.
- Виртуальная сеть Azure.
- Подсеть в виртуальной сети.
- Разрешения владельца или участника как для пространства имен Service Bus, так и для виртуальной сети.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. При выборе региона для частной конечной точки с помощью портала будут автоматически фильтроваться только виртуальные сети в этом регионе. Пространство имен сервисного автобуса может находиться в другом регионе. И, Ваша частная конечная точка использует частный IP-адрес в вашей виртуальной сети.

### <a name="steps"></a>steps

Если у вас уже есть существующее пространство имен, можно создать частную конечную точку, выдвив на следующий этап:

1. Войдите на [портал Azure](https://portal.azure.com). 
2. В панели поиска введите **служебный автобус.**
3. Выберите **пространство имен** из списка, к которому вы хотите добавить частную конечную точку.
4. Выберите вкладку **Сети** в **настройках.**
5. Выберите вкладку **приватных конечных точек (предварительный просмотр)** в верхней части страницы
6. Выберите кнопку **«Частная конечная точка»** в верхней части страницы.

    ![Добавить приватную кнопку конечных точек](./media/private-link-service/private-link-service-3.png)
7. На странице **Основы** выполните следующие действия: 
    1. Выберите **подписку Azure,** в которой требуется создать частную конечную точку. 
    2. Выберите **группу ресурсов** для частного ресурса конечных точек.
    3. Введите **имя** для частной конечной точки. 
    5. Выберите **регион** для частной конечных точек. Ваша частная конечная точка должна находиться в том же регионе, что и виртуальная сеть, но может находиться в другом регионе сюда с частным ресурсом связи, к которым вы подключаетесь. 
    6. Выберите **далее: кнопка >ресурсов** в нижней части страницы.

        ![Создание частной конечный точки - Страница Основы](./media/private-link-service/create-private-endpoint-basics-page.png)
8. На странице **Ресурса** выполните следующие действия:
    1. Для метода подключения при выборе **ресурса «Подключение к ресурсу Azure» в моем каталоге**выполните следующие действия:   
        1. Выберите **подписку Azure,** в которой существует **пространство имен sins.** 
        2. Для **типа ресурсов**выберите **Microsoft.ServiceBus/namespaces** для типа **ресурса.**
        3. Для **ресурса**выберите пространство имен saбиста службы из списка выпадающих. 
        4. Подтвердите, что **целевой подресурс** настроен на **пространство имен.**
        5. Выберите **следующую: Конфигурация >** кнопку в нижней части страницы. 
        
            ![Создание частной конечный точки - Страница ресурсов](./media/private-link-service/create-private-endpoint-resource-page.png)
    2. При выборе **подключения к ресурсу Azure по идентификатору ресурсов или псевдониму**выполните следующие действия:
        1. Введите **идентификатор ресурса** или **псевдоним**. Это может быть идентификатор ресурсов или псевдоним, которым некоторые из них поделились с вами.
        2. Для **субресурса Target**введите **пространство имен.** Это тип суб-ресурса, к который может получить доступ к вашей частной конечной точке. 
        3. (необязательно) Введите **сообщение запроса**. Владелец ресурса видит это сообщение при управлении частным конечным соединением. 
        4. Затем выберите **кнопку «Следующая: Конфигурация >** в нижней части страницы. 

            ![Создание частной конечный точки - подключение с помощью идентификатора ресурса](./media/private-link-service/connect-resource-id.png)
9. На странице **Configuration** вы выбираете подсеть в виртуальной сети, где требуется развернуть частную конечную точку. 
    1. Выберите **виртуальную сеть.** В списке выпадающих списков перечислены только виртуальные сети в выбранной в настоящее время подписке и местоположении. 
    2. Выберите **подсеть** в выбранной вами виртуальной сети. 
    3. Выберите **далее: Теги >кнопку** в нижней части страницы. 

        ![Создание частной конечный точки - Страница конфигурации](./media/private-link-service/create-private-endpoint-configuration-page.png)
10. На странице **теги** создайте любые теги (имена и значения), которые необходимо связать с частным ресурсом конечных точек. Затем выберите **Кнопку «Обзор» и создайте** кнопку в нижней части страницы. 
11. В **обзоре создайте,** просмотрите все настройки и выберите **Создать** для создания частной конечной точки.
    
    ![Создание частной точки предварительного просмотра - Обзор и создание страницы](./media/private-link-service/create-private-endpoint-review-create-page.png)
12. Подтвердите, что создана частная конечная точка. Если вы являетесь владельцем ресурса и выбрали **ресурс Connect to an Azure в моем** варианте каталога для **метода подключения,** конечное соединение должно быть **автоматически одобрено.** Если он находится в **незавершенном** состоянии, см. [частные конечные точки управления с помощью раздела портала Azure.](#manage-private-endpoints-using-azure-portal)

    ![Создана частная конечная точка](./media/private-link-service/private-endpoint-created.png)

## <a name="add-a-private-endpoint-using-powershell"></a>Добавить частную конечную точку с помощью PowerShell
В следующем примере показано, как использовать Azure PowerShell для создания приватного соединения конечных точек с пространством имен Service Bus.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. Пространство имен сервисного автобуса может находиться в другом регионе. И, Ваша частная конечная точка использует частный IP-адрес в вашей виртуальной сети.

```azurepowershell-interactive

$rgName = "<RESOURCE GROUP NAME>"
$vnetlocation = "<VNET LOCATION>"
$vnetName = "<VIRTUAL NETWORK NAME>"
$subnetName = "<SUBNET NAME>"
$namespaceLocation = "<NAMESPACE LOCATION>"
$namespaceName = "<NAMESPACE NAME>"
$peConnectionName = "<PRIVATE ENDPOINT CONNECTION NAME>"

# create resource group
az group create -l $vnetLocation -n $rgName

# create virtual network
$virtualNetwork = New-AzVirtualNetwork `
                    -ResourceGroupName $rgName `
                    -Location $vnetlocation `
                    -Name $vnetName `
                    -AddressPrefix 10.0.0.0/16

# create subnet with endpoint network policy disabled
$subnetConfig = Add-AzVirtualNetworkSubnetConfig `
                    -Name $subnetName `
                    -AddressPrefix 10.0.0.0/24 `
                    -PrivateEndpointNetworkPoliciesFlag "Disabled" `
                    -VirtualNetwork $virtualNetwork

# update virtual network
$virtualNetwork | Set-AzVirtualNetwork

# create premium service bus namespace
$namespaceResource = New-AzResource -Location $namespaceLocation -ResourceName $namespaceName -ResourceGroupName $rgName -Sku @{name = "Premium"; capacity = 1} -Properties @{} -ResourceType "Microsoft.ServiceBus/namespaces" -

# create a private link service connection
$privateEndpointConnection = New-AzPrivateLinkServiceConnection `
                                -Name $peConnectionName `
                                -PrivateLinkServiceId $namespaceResource.ResourceId `
                                -GroupId "namespace"

# get subnet object that you will use in the next step                                
$virtualNetwork = Get-AzVirtualNetwork -ResourceGroupName  $rgName -Name $vnetName
$subnet = $virtualNetwork | Select -ExpandProperty subnets `
                                | Where-Object  {$_.Name -eq $subnetName}  
   
# now, create private endpoint   
$privateEndpoint = New-AzPrivateEndpoint -ResourceGroupName $rgName  `
                                -Name $vnetName   `
                                -Location $vnetlocation `
                                -Subnet  $subnet   `
                                -PrivateLinkServiceConnection $privateEndpointConnection

(Get-AzResource -ResourceId $namespaceResource.ResourceId -ExpandProperties).Properties


```


## <a name="manage-private-endpoints-using-azure-portal"></a>Управление частными конечными точками с помощью портала Azure

При создании частной конечной точки подключение должно быть утверждено. Если ресурс, для которого вы создаете частную конечную точку, находится в каталоге, вы можете утвердить запрос на подключение при условии наличия достаточных разрешений. Если вы подключаетесь к ресурсу Azure в другом каталоге, необходимо дождаться, когда владелец этого ресурса утвердит запрос на подключение.

Существует четыре состояния подготовки:

| Действия по обслуживанию | Состояние частной конечной точки объекта-получателя службы | Описание |
|--|--|--|
| None | Ожидает | Подключение создается вручную и ожидает утверждения от владельца ресурса Приватного канала. |
| Утверждение | Approved | Подключение утверждено автоматически или вручную и готово к использованию. |
| Reject | Отклонено | Подключение отклонил владелец ресурса Приватного канала. |
| Удалить | Отключено | Подключение удалил владелец ресурса Приватного канала. Частная конечная точка станет информативной и подлежит удалению для очистки. |
 
###  <a name="approve-reject-or-remove-a-private-endpoint-connection"></a>Утверждение, отклонение или удаление приватного соединения конечных точек

1. Войдите на портал Azure.
1. В панели поиска введите **служебный автобус.**
1. Выберите **пространство имен,** которым вы хотите управлять.
1. Выберите вкладку **Сеть.**
5. Перейдите в соответствующий раздел ниже на основе операции, которая вы хотите: утвердить, отклонить или удалить. 

### <a name="approve-a-private-endpoint-connection"></a>Утвердить приватное соединение конечных точек

1. Если есть какие-либо соединения, которые находятся на рассмотрении, вы увидите соединение, указанное в **положении ожидания** в состоянии подготовки. 
2. Выберите **частную конечную точку,** которая вы хотите утвердить
3. Выберите кнопку **«Утвердить».**

    ![Утвердить частную конечную точку](./media/private-link-service/private-endpoint-approve.png)
4. На странице **подключения Утверждение** введите дополнительный **комментарий**и выберите **«Да».** Если вы выберете **Нет,** ничего не происходит. 

    ![Утвердить страницу соединения](./media/private-link-service/approve-connection-page.png)
5. Вы должны увидеть, что статус соединения в списке изменен на **Утвержденный**. 

    ![Статус подключения - утвержден](./media/private-link-service/connection-status-approved.png)

### <a name="reject-a-private-endpoint-connection"></a>Отклонить частное соединение конечных точек

1. Если есть какие-либо частные соединения конечных точек, которые вы хотите отклонить, будь то отложенный запрос или существующее соединение, которое было утверждено ранее, выберите соединение конечных точек и нажмите кнопку **Отклонить.**

    ![Кнопка отклонения](./media/private-link-service/private-endpoint-reject.png)
2. На странице **соединения Reject** введите дополнительный комментарий и выберите **«Да».** Если вы выберете **Нет,** ничего не происходит. 

    ![Отклонить страницу соединения](./media/private-link-service/reject-connection-page.png)
3. Вы должны увидеть статус соединения в списке **изменено Отклонено**. 

    ![Конечная точка отклонена](./media/private-link-service/endpoint-rejected.png)


### <a name="remove-a-private-endpoint-connection"></a>Удалить приватное соединение конечных точек

1. Чтобы удалить приватное соединение конечных точек, выберите его в списке и **выберите Удалить** на панели инструментов. 

    ![Кнопка "Удалить"](./media/private-link-service/remove-endpoint.png)
2. На странице **подключения Delete** выберите **«Да»,** чтобы подтвердить удаление частной конечной точки. Если вы выберете **Нет,** ничего не происходит. 

    ![Удалить страницу соединения](./media/private-link-service/delete-connection-page.png)
3. Вы должны увидеть, что статус изменен на **Отключенный.** Затем вы увидите, что конечная точка исчезнет из списка. 

## <a name="validate-that-the-private-link-connection-works"></a>Проверка работоспособности подключения Приватного канала

Следует проверить, что ресурсы в одной подсети частного ресурса конечных точек подключаются к вашему пространству имен Service Bus через частный IP-адрес, и что они имеют правильную частную интеграцию зоны DNS.

Сначала создайте виртуальную машину, выполнив действия, описанные в статье [Краткое руководство. Создание виртуальной машины Windows на портале Azure](../virtual-machines/windows/quick-create-portal.md).

Во вкладке **Сеть:**

1. Укажите **виртуальную сеть** и **Subnet**. Можно создать виртуальную сеть или выбрать существующую. При выборе существующей сети убедитесь, что регион соответствует.
1. Укажите **общедоступный ресурс ИС.**
1. Для **группы безопасности сети NIC**, выберите **Нет**.
1. Для **балансировки нагрузки,** выберите **Нет**.

Откройте командную строку и выполните следующую команду:

```console
nslookup <your-service-bus-namespace-name>.servicebus.windows.net
```

Если вы запустите команду поиска ns для разрешения IP-адреса пространства имен Service Bus через общедоступную точку, вы увидите результат, который выглядит следующим образом:

```console
c:\ >nslookup <your-service-bus-namespace-name>.servicebus.windows.net

Non-authoritative answer:
Name:    
Address:  (public IP address)
Aliases:  <your-service-bus-namespace-name>.servicebus.windows.net
```

Если вы запустите команду поиска ns для разрешения IP-адреса пространства имен Service Bus через частную конечную точку, вы увидите результат, который выглядит следующим образом:

```console
c:\ >nslookup your_service-bus-namespace-name.servicebus.windows.net

Non-authoritative answer:
Name:    
Address:  10.1.0.5 (private IP address)
Aliases:  <your-service-bus-namespace-name>.servicebus.windows.net
```

## <a name="limitations-and-design-considerations"></a>Проблемы и ограничения разработки

**Ценообразование**: Для получения информации о ценах [на](https://azure.microsoft.com/pricing/details/private-link/)цены см.

**Ограничения**: Частная конечная точка для сервиса Azure находится в общедоступном предварительном просмотре. Эта возможность есть во всех общедоступных регионах Azure.

**Максимальное количество частных конечных точек на пространство имен Service Bus**: 120.

Для получения [Azure Private Link service: Limitations](../private-link/private-link-service-overview.md#limitations) дополнительной информации см.

## <a name="next-steps"></a>Next Steps

- Дополнительные сведения о службе [Приватный канал Azure](../private-link/private-link-service-overview.md)
- Узнайте больше о [автобусе службы Azure](service-bus-messaging-overview.md)
