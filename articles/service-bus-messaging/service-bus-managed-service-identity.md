---
title: Управляемые удостоверения для ресурсов Azure с помощью служебной шины Azure | Документация Майкрософт
description: Использование управляемых удостоверений для ресурсов Azure со Служебной шиной Azure
services: service-bus-messaging
documentationcenter: na
author: axisc
editor: spelluru
ms.assetid: ''
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/22/2019
ms.author: aschhab
ms.openlocfilehash: a35ad4f8d480b0f95f4dc782aa06734e33bc54f8
ms.sourcegitcommit: 2ed6e731ffc614f1691f1578ed26a67de46ed9c2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/19/2019
ms.locfileid: "71130309"
---
# <a name="authenticate-a-managed-identity-with-azure-active-directory-to-access-azure-service-bus-resources"></a>Проверка подлинности управляемого удостоверения с Azure Active Directory для доступа к ресурсам служебной шины Azure
[Управляемые удостоверения для ресурсов Azure](../active-directory/managed-identities-azure-resources/overview.md) — это функция Azure, которая позволяет создавать удостоверения безопасности, связанные с развертыванием, в рамках которого выполняется код приложения. Затем можно связать этот идентификатор с ролями управления доступом, предоставляющими настраиваемые разрешения для доступа к определенным ресурсам Azure, необходимым приложению.

С помощью управляемых удостоверений платформа Azure управляет этим идентификатором среды выполнения. Ключи доступа не нужно хранить и защищать в коде приложений или конфигурации ни для удостоверения, ни для ресурсов, к которым необходимо получить доступ. Клиентскому приложению "Служебная шина Azure", которое выполняется в приложении Службы приложений Azure или на виртуальной машине с включенной поддержкой управляемых удостоверений для ресурсов Azure, не нужно обрабатывать правила и ключи SAS или любые другие маркеры доступа. Клиентскому приложению достаточно только адреса конечной точки пространства имен служебной шины для обмена сообщениями. При подключении приложения служебная шина привязывает контекст управляемого удостоверения к клиенту в операции, показанной в примере далее в этой статье. Как только он будет связан с управляемым удостоверением, клиент Служебной шины Azure сможет выполнять все авторизованные операции. Авторизация выполняется путем привязывания управляемого удостоверения к ролям служебной шины. 

## <a name="overview"></a>Обзор
Когда участник безопасности (пользователь, группа или приложение) пытается получить доступ к сущности служебной шины, запрос должен быть полномочным. В Azure AD доступ к ресурсу состоит из двух этапов. 

 1. Во-первых, удостоверение субъекта безопасности проходит проверку подлинности и возвращается маркер OAuth 2,0. Имя ресурса для запроса маркера — `https://servicebus.azure.net`.
 1. Затем маркер передается как часть запроса службе служебной шины для авторизации доступа к указанному ресурсу.

Этап проверки подлинности требует, чтобы запрос приложения содержал маркер доступа OAuth 2,0 во время выполнения. Если приложение выполняется в сущности Azure, такой как виртуальная машина Azure, масштабируемый набор виртуальных машин или приложение-функция Azure, оно может использовать управляемое удостоверение для доступа к ресурсам. 

Для шага авторизации необходимо, чтобы один или несколько ролей RBAC были назначены субъекту безопасности. Служебная шина Azure предоставляет роли RBAC, охватывающие наборы разрешений для ресурсов служебной шины. Роли, назначенные субъекту безопасности, определяют разрешения, которые будут иметь субъекта. Дополнительные сведения о назначении ролей RBAC в служебной шине Azure см. в статье [встроенные роли RBAC для служебной шины Azure](#built-in-rbac-roles-for-azure-service-bus). 

Собственные приложения и веб-приложения, которые делают запросы к служебной шине, также могут авторизоваться в Azure AD. В этой статье показано, как запросить маркер доступа и использовать его для авторизации запросов к ресурсам служебной шины. 


## <a name="assigning-rbac-roles-for-access-rights"></a>Назначение ролей RBAC для прав доступа
Azure Active Directory (Azure AD) разрешает права доступа к защищенным ресурсам с помощью [управления доступом на основе ролей (RBAC)](../role-based-access-control/overview.md). Служебная шина Azure определяет набор встроенных ролей RBAC, охватывающих общие наборы разрешений, используемых для доступа к сущностям служебной шины. Кроме того, можно определить пользовательские роли для доступа к данным.

Когда роль RBAC назначается субъекту безопасности Azure AD, Azure предоставляет доступ к этим ресурсам для этого субъекта безопасности. Доступ может быть ограничен уровнем подписки, группой ресурсов или пространством имен служебной шины. Субъект безопасности Azure AD может быть пользователем, группой, субъектом-службой приложения или управляемым удостоверением для ресурсов Azure.

## <a name="built-in-rbac-roles-for-azure-service-bus"></a>Встроенные роли RBAC для служебной шины Azure
Для служебной шины Azure управление пространствами имен и всеми связанными ресурсами через портал Azure и API управления ресурсами Azure уже защищено с помощью модели *управления доступом на основе ролей* (RBAC). Azure предоставляет следующие встроенные роли RBAC для авторизации доступа к пространству имен служебной шины:

- [Владелец данных служебной шины Azure](../role-based-access-control/built-in-roles.md#azure-service-bus-data-owner): Включает доступ к данным для пространства имен служебной шины и его сущностей (очередей, разделов, подписок и фильтров).
- [Отправитель данных служебной шины Azure](../role-based-access-control/built-in-roles.md#azure-service-bus-data-sender): Используйте эту роль, чтобы предоставить отправку доступа к пространству имен служебной шины и ее сущностям.
- [Приемник данных служебной шины Azure](../role-based-access-control/built-in-roles.md#azure-service-bus-data-receiver): Используйте эту роль, чтобы предоставить доступ к пространству имен служебной шины и ее сущностям. 

## <a name="resource-scope"></a>Область действия ресурса 
Прежде чем назначить роль RBAC субъекту безопасности, определите область доступа, которую должен иметь субъект безопасности. Рекомендации определяют, что всегда рекомендуется предоставлять только самые узкие области.

В следующем списке описаны уровни, на которых можно ограничить доступ к ресурсам служебной шины, начиная с самой короткой области:

- **Очередь**, **раздел**или **Подписка**: Назначение ролей применяется к определенной сущности служебной шины. В настоящее время портал Azure не поддерживает назначение пользователей/групп/управляемых удостоверений для ролей RBAC служебной шины на уровне подписки. 
- **Пространство имен служебной шины**: Назначение ролей охватывает всю топологию служебной шины в пространстве имен и связанную с ней группу потребителей.
- **Группа ресурсов.** Назначение ролей применяется ко всем ресурсам служебной шины в группе ресурсов.
- **Подписка**: Назначение ролей применяется ко всем ресурсам служебной шины во всех группах ресурсов в подписке.

> [!NOTE]
> Помните, что для распространения назначений ролей RBAC может потребоваться до пяти минут. 

Дополнительные сведения о том, как определяются встроенные роли, см. в разделе [Знакомство с определениями ролей](../role-based-access-control/role-definitions.md#management-and-data-operations). Сведения о создании настраиваемых ролей RBAC см. в статье [Создание настраиваемых ролей для управления доступом на основе ролей в Azure](../role-based-access-control/custom-roles.md).

## <a name="enable-managed-identities-on-a-vm"></a>Включение управляемых удостоверений на виртуальной машине
Прежде чем использовать управляемые удостоверения для ресурсов Azure для авторизации ресурсов служебной шины из виртуальной машины, необходимо сначала включить управляемые удостоверения для ресурсов Azure на виртуальной машине. Сведения о включении управляемых удостоверений для ресурсов Azure см. в одной из следующих статей.

- [портал Azure](../active-directory/managed-service-identity/qs-configure-portal-windows-vm.md)
- [Azure PowerShell](../active-directory/managed-identities-azure-resources/qs-configure-powershell-windows-vm.md)
- [Интерфейс командной строки Azure](../active-directory/managed-identities-azure-resources/qs-configure-cli-windows-vm.md)
- [Шаблон Azure Resource Manager](../active-directory/managed-identities-azure-resources/qs-configure-template-windows-vm.md)
- [Клиентские библиотеки Azure Resource Manager](../active-directory/managed-identities-azure-resources/qs-configure-sdk-windows-vm.md)

## <a name="grant-permissions-to-a-managed-identity-in-azure-ad"></a>Предоставление разрешений управляемому удостоверению в Azure AD
Чтобы авторизовать запрос к службе служебной шины из управляемого удостоверения в приложении, сначала настройте параметры управления доступом на основе ролей (RBAC) для этого управляемого удостоверения. Служебная шина Azure определяет роли RBAC, охватывающие разрешения на отправку и чтение из служебной шины. Когда роль RBAC назначается управляемому удостоверению, управляемому удостоверению предоставляется доступ к сущностям служебной шины в соответствующей области.

Дополнительные сведения о назначении ролей RBAC см. [в статьях аутентификация и авторизация с помощью Azure Active Directory для доступа к ресурсам](authenticate-application.md#built-in-rbac-roles-for-azure-service-bus)служебной шины.

## <a name="use-service-bus-with-managed-identities-for-azure-resources"></a>Использование служебной шины с управляемыми удостоверениями для ресурсов Azure
Чтобы использовать служебную шину с управляемыми удостоверениями, необходимо назначить удостоверение роли и соответствующую область. Процедура в этом разделе использует простое приложение, которое выполняется под управляемым удостоверением и обращается к ресурсам служебной шины.

Здесь мы используем пример веб-приложения, размещенного в [службе приложений Azure](https://azure.microsoft.com/services/app-service/). Пошаговые инструкции по созданию веб-приложения см. [в статье создание ASP.NET Core веб-приложения в Azure](../app-service/app-service-web-get-started-dotnet.md) .

После создания приложения выполните следующие действия. 

1. Перейдите в раздел **Параметры** и выберите **удостоверение**. 
1. Выберите **состояние** **включено**. 
1. Нажмите кнопку **Сохранить**, чтобы сохранить параметры. 

    ![Управляемое удостоверение для веб-приложения](./media/service-bus-managed-service-identity/identity-web-app.png)

После включения этого параметра в Azure Active Directory (Azure AD) создается новое удостоверение службы, которое настраивается в узле службы приложений.

Теперь назначьте это удостоверение службы роли в требуемой области в ресурсах служебной шины.

### <a name="to-assign-rbac-roles-using-the-azure-portal"></a>Назначение ролей RBAC с помощью портал Azure
Чтобы назначить роль пространству имен служебной шины, перейдите к пространству имен в портал Azure. Отобразить параметры управления доступом (IAM) для ресурса и выполнить следующие инструкции для управления назначениями ролей:

> [!NOTE]
> Следующие шаги присваивают роль удостоверения службы пространствам имен служебной шины. Вы можете выполнить те же действия, чтобы назначить роль в других поддерживаемых областях (Группа ресурсов и подписка). 
> 
> [Создайте пространство имен для обмена сообщениями служебной шины](service-bus-create-namespace-portal.md) , если оно у вас нет. 

1. В портал Azure перейдите к пространству имен служебной шины и просмотрите **Общие сведения** о пространстве имен. 
1. Выберите **Управление доступом (IAM)** в меню слева, чтобы отобразить параметры контроля доступа для пространства имен служебной шины.
1.  Выберите вкладку **Назначения ролей**, чтобы просмотреть список назначений ролей.
3.  Нажмите кнопку **Добавить** , чтобы добавить новую роль.
4.  На странице **Добавление назначения ролей** выберите роли служебной шины Azure, которые требуется назначить. Затем найдите удостоверение службы, зарегистрированное для назначения роли.
    
    ![Страница добавления назначения ролей](./media/service-bus-managed-service-identity/add-role-assignment-page.png)
5.  Щелкните **Сохранить**. Удостоверение, которому назначена роль RBAC, будет отображаться в списке под этой ролью. Например, на следующем рисунке показано, что удостоверение службы имеет владельца данных служебной шины Azure.
    
    ![Удостоверение, назначенное роли](./media/service-bus-managed-service-identity/role-assigned.png)

После назначения роли веб-приложение будет иметь доступ к сущностям служебной шины в определенной области. 

### <a name="run-the-app"></a>Запуск приложения

Теперь можно изменить стандартную страницу созданного вами приложения ASP.NET. Вы можете использовать код веб-приложения из этого [репозитория GitHub](https://github.com/Azure-Samples/app-service-msi-servicebus-dotnet).  

Страница Default.aspx является целевой. Код можно найти в файле Default.aspx.cs. В результате вы получите самое простое веб-приложение с несколькими полями для ввода и кнопками **отправки** и **получения**, которые позволяют отправить сообщения в служебную шину или получить их оттуда.

Обратите внимание, как инициализируется объект [MessagingFactory](/dotnet/api/microsoft.servicebus.messaging.messagingfactory). Вместо того чтобы использовать поставщик общих маркеров доступа (SAS), код создает поставщик маркеров для управляемого удостоверения с помощью вызова `var msiTokenProvider = TokenProvider.CreateManagedIdentityTokenProvider();`. Таким образом, нет никаких секретов для хранения и использования. Поток контекста управляемого удостоверения службы в служебную шину и подтверждение авторизации автоматически обрабатываются поставщиком маркеров. Это является более простой моделью, чем использование SAS.

После внесения этих изменений опубликуйте и запустите приложение. Чтобы получить правильные данные публикации, скачайте их, а затем импортируйте профиль публикации в Visual Studio.

![Скачать профиль публикации](./media/service-bus-managed-service-identity/msi3.png)
 
Чтобы отправлять или получать сообщения, введите имя пространства имен и имя созданной сущности. Затем нажмите кнопки **Отправить** или **Получить**.


> [!NOTE]
> - Управляемое удостоверение работает только в среде Azure, в службах приложений, на виртуальных машинах Azure и масштабируемых наборах. Для приложений .NET библиотека Microsoft.Azure.Services.AppAuthentication, которая используется пакетом NuGet служебной шины, предоставляет абстракцию этого протокола и поддерживает локальную разработку. Эта библиотека также позволяет локально тестировать код на компьютере разработки с использованием учетной записи пользователя из Visual Studio, Azure CLI 2.0 или встроенной проверки подлинности Active Directory. Дополнительные сведения о параметрах локальной разработки с помощью этой библиотеки см. в руководстве по [аутентификации между службами в Azure Key Vault с использованием .NET](../key-vault/service-to-service-authentication.md).  
> 
> - Сейчас эти удостоверения не работают со слотами развертывания Службы приложений Azure.

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения об обмене сообщениями через служебную шину см. в следующих статьях:

* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)
