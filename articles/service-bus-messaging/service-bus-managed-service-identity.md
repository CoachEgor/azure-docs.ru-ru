---
title: Управляемые удостоверения для ресурсов Azure со служебной шиной
description: В этой статье описывается, как использовать управляемые идентификаторы для доступа к объектам Azure Service Bus (очереди, темы и подписки).
services: service-bus-messaging
documentationcenter: na
author: axisc
editor: spelluru
ms.assetid: ''
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 01/24/2020
ms.author: aschhab
ms.openlocfilehash: 46a1db94d576174b837a40c646fcf9e082e339c8
ms.sourcegitcommit: b55d7c87dc645d8e5eb1e8f05f5afa38d7574846
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81461622"
---
# <a name="authenticate-a-managed-identity-with-azure-active-directory-to-access-azure-service-bus-resources"></a>Проверка управляемого итогового данных с помощью Active Directory Azure для доступа к ресурсам Azure Service Bus
[Управляемые удостоверения для ресурсов Azure](../active-directory/managed-identities-azure-resources/overview.md) — это функция Azure, которая позволяет создавать удостоверения безопасности, связанные с развертыванием, в рамках которого выполняется код приложения. Затем можно связать этот идентификатор с ролями управления доступом, предоставляющими настраиваемые разрешения для доступа к определенным ресурсам Azure, необходимым приложению.

С помощью управляемых удостоверений платформа Azure управляет этим идентификатором среды выполнения. Ключи доступа не нужно хранить и защищать в коде приложений или конфигурации ни для удостоверения, ни для ресурсов, к которым необходимо получить доступ. Клиентскому приложению "Служебная шина Azure", которое выполняется в приложении Службы приложений Azure или на виртуальной машине с включенной поддержкой управляемых удостоверений для ресурсов Azure, не нужно обрабатывать правила и ключи SAS или любые другие маркеры доступа. Клиентскому приложению достаточно только адреса конечной точки пространства имен служебной шины для обмена сообщениями. При подключении приложения служебная шина привязывает контекст управляемого удостоверения к клиенту в операции, показанной в примере далее в этой статье. Как только он будет связан с управляемым удостоверением, клиент Служебной шины Azure сможет выполнять все авторизованные операции. Авторизация выполняется путем привязывания управляемого удостоверения к ролям служебной шины. 

## <a name="overview"></a>Обзор
Когда директор службы безопасности (пользователь, группа или приложение) пытается получить доступ к объекту Service Bus, запрос должен быть авторизован. С Azure AD доступ к ресурсу является двухэтапным процессом. 

 1. Во-первых, личность директора службы безопасности проверяется, и возвращается токен OAuth 2.0. Имя ресурса для запроса `https://servicebus.azure.net`маркера находится под названием .
 1. Далее токен передается в рамках запроса в службу обслуживания автобусов для авторизации доступа к указанному ресурсу.

Шаг проверки подлинности требует, чтобы запрос приложения содержит токен доступа OAuth 2.0 во время выполнения. Если приложение работает в рамках сущности Azure, такой как Azure VM, набор виртуальной шкалы машин или приложение Azure Function, оно может использовать управляемое удостоверение для доступа к ресурсам. 

Шаг авторизации требует, чтобы одна или несколько ролей RBAC были назначены директору безопасности. Azure Service Bus предоставляет роли RBAC, охватывающие наборы разрешений для ресурсов Service Bus. Роли, назначенные директору безопасности, определяют разрешения, которые будет иметь принцип. Подробнее о назначении ролей RBAC в Azure Service Bus можно узнать, [встроенные роли RBAC для Azure Service Bus.](#built-in-rbac-roles-for-azure-service-bus) 

Родные приложения и веб-приложения, которые делают запросы в Service Bus, также могут авторизоваться с Azure AD. В этой статье показано, как запросить токен доступа и использовать его для авторизации запросов на ресурсы Service Bus. 


## <a name="assigning-rbac-roles-for-access-rights"></a>Назначение ролей RBAC для прав доступа
Azure Active Directory (Azure AD) разрешает права доступа к защищенным ресурсам с помощью [управления доступом на основе ролей (RBAC)](../role-based-access-control/overview.md). Шины службы Azure определяют набор встроенных ролей RBAC, которые охватывают общие наборы разрешений, используемых для доступа к объектам Service Bus, и можно также определить пользовательские роли для доступа к данным.

Когда роль RBAC назначается директору безопасности Azure AD, Azure предоставляет доступ к этим ресурсам для этого принципа безопасности. Доступ может быть доступен на уровне подписки, группы ресурсов или пространства имен Service Bus. Директором безопасности Azure AD может быть пользователь, группа, директор службы приложений или управляемый интимент для ресурсов Azure.

## <a name="built-in-rbac-roles-for-azure-service-bus"></a>Встроенные роли RBAC для сервисного автобуса Azure
Для служебной шины Azure управление пространствами имен и всеми связанными ресурсами через портал Azure и API управления ресурсами Azure уже защищено с помощью модели *управления доступом на основе ролей* (RBAC). Azure предоставляет ниже встроенные роли RBAC для авторизации доступа к пространству имен Service Bus:

- [Владелец данных службы Azure:](../role-based-access-control/built-in-roles.md#azure-service-bus-data-owner)обеспечивает доступ к данным в пространстве имен Service Bus и его сущностях (очереди, темы, подписки и фильтры)
- [Отправитель данных службы Azure:](../role-based-access-control/built-in-roles.md#azure-service-bus-data-sender)Используйте эту роль, чтобы предоставить доступ к пространству имен Service Bus и его сущностям.
- [Приемник данных службы Azure:](../role-based-access-control/built-in-roles.md#azure-service-bus-data-receiver)Используйте эту роль, чтобы предоставить доступ к ночню пространства имен Service Bus и его сущностям. 

## <a name="resource-scope"></a>Область ресурсов 
Прежде чем назначить роль RBAC директору безопасности, определите область доступа, которую должен иметь директор службы безопасности. Рекомендации по практике диктуют, что всегда лучше предоставить только максимально узкую область.

В следующем списке описаны уровни, на которых можно получить доступ к ресурсам Service Bus, начиная с самого узкого объема:

- **Очередь,** **тема**, или **подписка**: Назначение ролей применяется к конкретной сущности шины обслуживания. В настоящее время портал Azure не поддерживает присвоение пользователям/группам/управляемым идентификаторам ролей Service Bus RBAC на уровне подписки. Вот пример использования команды Azure CLI: [аз-роль-назначение-создание](/cli/azure/role/assignment?view=azure-cli-latest#az-role-assignment-create) для присвоения итома роли Service Bus RBAC: 

    ```azurecli
    az role assignment create \
        --role $service_bus_role \
        --assignee $assignee_id \
        --scope /subscriptions/$subscription_id/resourceGroups/$resource_group/providers/Microsoft.ServiceBus/namespaces/$service_bus_namespace/topics/$service_bus_topic/subscriptions/$service_bus_subscription
    ```
- **Пространство имен sass:** Назначение ролей охватывает всю топологию Сервисного автобуса под пространством имен и группу потребителей, связанную с ним.
- **Группа ресурсов**: Назначение ролей применяется ко всем ресурсам Service Bus, находиваемым в группе ресурсов.
- **Подписка**: Назначение ролей распространяется на все ресурсы Service Bus во всех группах ресурсов в подписке.

> [!NOTE]
> Имейте в виду, что распространение заданий ролей RBAC может занять до пяти минут. 

Для получения дополнительной [информации](../role-based-access-control/role-definitions.md#management-and-data-operations)о том, как определяются встроенные роли, см. Для получения информации о создании пользовательских ролей RBAC [см.](../role-based-access-control/custom-roles.md)

## <a name="enable-managed-identities-on-a-vm"></a>Включение управляемых удостоверений на виртуальной машине
Прежде чем использовать управляемые идентификаторы ресурсов Azure для авторизации ресурсов службы bus из вашего VM, необходимо сначала включить управляемые идентификаторы для ресурсов Azure на VM. Сведения о включении управляемых удостоверений для ресурсов Azure см. в одной из следующих статей.

- [Портал Azure](../active-directory/managed-service-identity/qs-configure-portal-windows-vm.md)
- [Azure PowerShell](../active-directory/managed-identities-azure-resources/qs-configure-powershell-windows-vm.md)
- [Azure CLI](../active-directory/managed-identities-azure-resources/qs-configure-cli-windows-vm.md)
- [Шаблон Azure Resource Manager](../active-directory/managed-identities-azure-resources/qs-configure-template-windows-vm.md)
- [Клиентские библиотеки менеджера ресурсов Azure](../active-directory/managed-identities-azure-resources/qs-configure-sdk-windows-vm.md)

## <a name="grant-permissions-to-a-managed-identity-in-azure-ad"></a>Разрешение на получение управляемой идентификации в Azure AD
Чтобы авторизовать запрос службы обслуживания автобусов с управляемой идентификацией в приложении, сначала настройте настройки управления доступом на основе ролей (RBAC) для этого управляемого удостоверения. Автобус службы Azure определяет роли RBAC, которые охватывают разрешения на отправку и чтение из service Bus. При присвоении роли RBAC управляемому удостоверению управляемому удостоверению управляемому удостоверению предоставляется доступ к объектам Service Bus в соответствующем объеме.

Для получения дополнительной информации о назначении ролей RBAC см. [Authenticate и авторизуйте с помощью Active Directory Azure для доступа к ресурсам Service Bus.](authenticate-application.md#built-in-rbac-roles-for-azure-service-bus)

## <a name="use-service-bus-with-managed-identities-for-azure-resources"></a>Использование служебной шины с управляемыми удостоверениями для ресурсов Azure
Чтобы использовать Служебный автобус с управляемыми удостоверениями, необходимо назначить идентификационную роль и соответствующий объем. Процедура в этом разделе использует простое приложение, которое работает под управляемым удостоверением личности и получает доступ к ресурсам Service Bus.

Здесь мы используем пример веб-приложения, размещенного в [Azure App Service](https://azure.microsoft.com/services/app-service/). Для пошаговых инструкций по созданию веб-приложения смотрите [создание веб-приложения ASP.NET Core в Azure](../app-service/app-service-web-get-started-dotnet.md)

Как только приложение создано, выполните следующие действия: 

1. Перейдите к **настройкам** и выберите **Identity.** 
1. Выберите **статус,** который будет **на**. 
1. Нажмите кнопку **Сохранить**, чтобы сохранить параметры. 

    ![Управляемая идентификация для веб-приложения](./media/service-bus-managed-service-identity/identity-web-app.png)

После включения этой настройки в каталоге Active Directory (Azure AD) создается новая идентификаторная система службы и настраивается в хост службы поддержки приложений.

Теперь назначьте эту идентификацию службы роли в требуемой области ресурсов в вашем сервисном автобусе.

### <a name="to-assign-rbac-roles-using-the-azure-portal"></a>Назначать роли RBAC с помощью портала Azure
Чтобы назначить роль в пространстве имен Service Bus, перейдите к пространству имен на портале Azure. Отобразите настройки управления доступом (IAM) для ресурса и следуйте этим инструкциям для управления назначениями ролей:

> [!NOTE]
> Следующие шаги присваивает именованию идентификаторов службы в пространстве имен Service Bus. Вы можете следовать тем же шагам, чтобы назначить роль в других поддерживаемых областях (группа ресурсов и подписка). 
> 
> [Создайте пространство имен обмена сообщениями с автобусом службы,](service-bus-create-namespace-portal.md) если его у вас его нет. 

1. На портале Azure перейдите в пространство имен Service Bus и **отобразите обзор** пространства имен. 
1. Выберите **элемент управления доступом (IAM)** в левом меню для отображения параметров управления доступом для пространства имен Service Bus.
1.  Выберите вкладку **Назначения ролей**, чтобы просмотреть список назначений ролей.
3.  Выберите **Добавить,** чтобы добавить новую роль.
4.  На странице **назначения ролей добавить** выберите роли шины службы Azure, которые необходимо назначить. Затем поиск, чтобы найти службу идентификации вы зарегистрировали назначить роль.
    
    ![Добавление страницы назначения ролей](./media/service-bus-managed-service-identity/add-role-assignment-page.png)
5.  Щелкните **Сохранить**. Удостоверение, которому назначена роль RBAC, будет отображаться в списке под этой ролью. Например, на следующем изображении показано, что иная личность службы имеет владельца данных шины Azure.
    
    ![Идентификация, присвоенная роли](./media/service-bus-managed-service-identity/role-assigned.png)

После того, как вы назначили роль, веб-приложение будет иметь доступ к объектам Service Bus в определенной области. 

### <a name="run-the-app"></a>Запустите приложение

Теперь можно изменить стандартную страницу созданного вами приложения ASP.NET. Вы можете использовать код веб-приложения из этого [репозитория GitHub](https://github.com/Azure-Samples/app-service-msi-servicebus-dotnet).  

Страница Default.aspx является целевой. Код можно найти в файле Default.aspx.cs. В результате вы получите самое простое веб-приложение с несколькими полями для ввода и кнопками **отправки** и **получения**, которые позволяют отправить сообщения в служебную шину или получить их оттуда.

Обратите внимание, как инициализируется объект [MessagingFactory](/dotnet/api/microsoft.servicebus.messaging.messagingfactory). Вместо того чтобы использовать поставщик общих маркеров доступа (SAS), код создает поставщик маркеров для управляемого удостоверения с помощью вызова `var msiTokenProvider = TokenProvider.CreateManagedIdentityTokenProvider();`. Таким образом, нет никаких секретов для хранения и использования. Поток контекста управляемого удостоверения службы в служебную шину и подтверждение авторизации автоматически обрабатываются поставщиком маркеров. Это является более простой моделью, чем использование SAS.

После внесения этих изменений опубликуйте и запустите приложение. Чтобы получить правильные данные публикации, скачайте их, а затем импортируйте профиль публикации в Visual Studio.

![Получить профиль публикации](./media/service-bus-managed-service-identity/msi3.png)
 
Чтобы отправлять или получать сообщения, введите имя пространства имен и имя созданной сущности. Затем нажмите кнопки **Отправить** или **Получить**.


> [!NOTE]
> - Управляемое удостоверение работает только в среде Azure, в службах приложений, на виртуальных машинах Azure и масштабируемых наборах. Для приложений .NET библиотека Microsoft.Azure.Services.AppAuthentication, которая используется пакетом NuGet служебной шины, предоставляет абстракцию этого протокола и поддерживает локальную разработку. Эта библиотека также позволяет локально тестировать код на компьютере разработки с использованием учетной записи пользователя из Visual Studio, Azure CLI 2.0 или встроенной проверки подлинности Active Directory. Дополнительные сведения о параметрах локальной разработки с помощью этой библиотеки см. в руководстве по [аутентификации между службами в Azure Key Vault с использованием .NET](../key-vault/general/service-to-service-authentication.md).  
> 
> - Сейчас эти удостоверения не работают со слотами развертывания Службы приложений Azure.

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения об обмене сообщениями через служебную шину см. в следующих статьях:

* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)
