---
title: Authenticate приложение для доступа к объектам Azure Service Bus
description: В этой статье содержится информация о проверке подлинности приложения с помощью Azure Active Directory для доступа к объектам Azure Service Bus (очереди, темы и т.д.)
services: service-bus-messaging
ms.service: event-hubs
documentationcenter: ''
author: axisc
ms.topic: conceptual
ms.date: 08/22/2019
ms.author: aschhab
ms.openlocfilehash: 6a78e4d81921fae8dcb325e9d72df1eee7b99a3b
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79259296"
---
# <a name="authenticate-and-authorize-an-application-with-azure-active-directory-to-access-azure-service-bus-entities"></a>Authenticate и авторизут приложение с помощью Active Directory Azure для доступа к объектам Azure Service Bus
Служба azure поддерживает использование Active Directory Azure (Azure AD) для авторизации запросов для объектов службы (очередей, тем, подписок или фильтров). С Помощью Azure AD можно использовать элементуправления доступа на основе ролей (RBAC) для предоставления разрешений директору службы безопасности, который может быть директором службы безопасности пользователя, группы или приложения. Чтобы узнать больше о ролях и назначениях ролей, [см.](../role-based-access-control/overview.md)

## <a name="overview"></a>Обзор
Когда директор службы безопасности (пользователь, группа или приложение) пытается получить доступ к объекту Service Bus, запрос должен быть авторизован. С Azure AD доступ к ресурсу является двухэтапным процессом. 

 1. Во-первых, личность директора службы безопасности проверяется, и возвращается токен OAuth 2.0. Имя ресурса для запроса `https://servicebus.azure.net`маркера находится под названием .
 1. Далее токен передается в рамках запроса в службу обслуживания автобусов для авторизации доступа к указанному ресурсу.

Шаг проверки подлинности требует, чтобы запрос приложения содержит токен доступа OAuth 2.0 во время выполнения. Если приложение работает в рамках сущности Azure, такой как Azure VM, набор виртуальной шкалы машин или приложение Azure Function, оно может использовать управляемое удостоверение для доступа к ресурсам. Чтобы узнать, как проверить подлинность запросов, сделанных управляемым удостоверением личности в службу service Bus, см. [Аутентификации доступа к ресурсам Azure Service Bus с помощью Active Directory Azure и управляемых идентификаторов для ресурсов Azure.](service-bus-managed-service-identity.md) 

Шаг авторизации требует, чтобы одна или несколько ролей RBAC были назначены директору безопасности. Azure Service Bus предоставляет роли RBAC, охватывающие наборы разрешений для ресурсов Service Bus. Роли, назначенные директору безопасности, определяют разрешения, которые будет иметь принцип. Подробнее о назначении ролей RBAC в Azure Service Bus можно узнать, [встроенные роли RBAC для Azure Service Bus.](#built-in-rbac-roles-for-azure-service-bus) 

Родные приложения и веб-приложения, которые делают запросы в Service Bus, также могут авторизоваться с Azure AD. В этой статье показано, как запросить токен доступа и использовать его для авторизации запросов на ресурсы Service Bus. 


## <a name="assigning-rbac-roles-for-access-rights"></a>Назначение ролей RBAC для прав доступа
Azure Active Directory (Azure AD) разрешает права доступа к защищенным ресурсам с помощью [управления доступом на основе ролей (RBAC)](../role-based-access-control/overview.md). Шины службы Azure определяют набор встроенных ролей RBAC, которые охватывают общие наборы разрешений, используемых для доступа к объектам Service Bus, и можно также определить пользовательские роли для доступа к данным.

Когда роль RBAC назначается директору безопасности Azure AD, Azure предоставляет доступ к этим ресурсам для этого принципа безопасности. Доступ может быть доступен на уровне подписки, группы ресурсов или пространства имен Service Bus. Директором безопасности Azure AD может быть пользователь, группа, директор службы приложений или [управляемый интимент для ресурсов Azure.](../active-directory/managed-identities-azure-resources/overview.md)

## <a name="built-in-rbac-roles-for-azure-service-bus"></a>Встроенные роли RBAC для сервисного автобуса Azure
Для служебной шины Azure управление пространствами имен и всеми связанными ресурсами через портал Azure и API управления ресурсами Azure уже защищено с помощью модели *управления доступом на основе ролей* (RBAC). Azure предоставляет ниже встроенные роли RBAC для авторизации доступа к пространству имен Service Bus:

- [Владелец данных службы Azure:](../role-based-access-control/built-in-roles.md#azure-service-bus-data-owner)обеспечивает доступ к данным в пространстве имен Service Bus и его сущностях (очереди, темы, подписки и фильтры)
- [Отправитель данных службы Azure:](../role-based-access-control/built-in-roles.md#azure-service-bus-data-sender)Используйте эту роль, чтобы предоставить доступ к пространству имен Service Bus и его сущностям.
- [Приемник данных службы Azure:](../role-based-access-control/built-in-roles.md#azure-service-bus-data-receiver)Используйте эту роль, чтобы предоставить доступ к ночню пространства имен Service Bus и его сущностям. 

## <a name="resource-scope"></a>Область ресурсов 
Прежде чем назначить роль RBAC директору безопасности, определите область доступа, которую должен иметь директор службы безопасности. Рекомендации по практике диктуют, что всегда лучше предоставить только максимально узкую область.

В следующем списке описаны уровни, на которых можно получить доступ к ресурсам Service Bus, начиная с самого узкого объема:

- **Очередь,** **тема**, или **подписка**: Назначение ролей применяется к конкретной сущности шины обслуживания. В настоящее время портал Azure не поддерживает присвоение пользователям/группам/управляемым идентификаторам ролей Service Bus RBAC на уровне подписки. 
- **Пространство имен sass:** Назначение ролей охватывает всю топологию Сервисного автобуса под пространством имен и группу потребителей, связанную с ним.
- **Группа ресурсов**: Назначение ролей применяется ко всем ресурсам Service Bus, находиваемым в группе ресурсов.
- **Подписка**: Назначение ролей распространяется на все ресурсы Service Bus во всех группах ресурсов в подписке.

> [!NOTE]
> Имейте в виду, что распространение заданий ролей RBAC может занять до пяти минут. 

Для получения дополнительной [информации](../role-based-access-control/role-definitions.md#management-and-data-operations)о том, как определяются встроенные роли, см. Для получения информации о создании пользовательских ролей RBAC [см.](../role-based-access-control/custom-roles.md)


## <a name="assign-rbac-roles-using-the-azure-portal"></a>Назначить роли RBAC с помощью портала Azure  
Подробнее об управлении ресурсами Azure с помощью RBAC и портала Azure можно узнать в [этой статье.](..//role-based-access-control/role-assignments-portal.md) 

После определения подходящей области для назначения ролей перейдите на этот ресурс на портале Azure. Отобразите настройки управления доступом (IAM) для ресурса и следуйте этим инструкциям для управления назначениями ролей:

> [!NOTE]
> Описанные ниже шаги присваивает роль в пространстве имен Service Bus. Вы можете следовать тем же шагам, чтобы назначить роль другим поддерживаемым областям (группа ресурсов, подписка и т.д.).

1. На [портале Azure](https://portal.azure.com/)перейдите в пространство имен Service Bus. Выберите **элемент управления доступом (IAM)** в левом меню для отображения параметров управления доступом для пространства имен. Если вам нужно создать пространство имен Service Bus, следуйте инструкциям из этой статьи: [Создайте пространство имен обмена сообщениями с автобусом](service-bus-create-namespace-portal.md)службы.

    ![Выберите элемент доступа в левом меню](./media/authenticate-application/select-access-control-menu.png)
1. Выберите вкладку **Назначения ролей**, чтобы просмотреть список назначений ролей. Выберите кнопку **Добавить** на панели инструментов, а затем выберите **Добавить назначение ролей.** 

    ![Добавить кнопку на панели инструментов](./media/authenticate-application/role-assignments-add-button.png)
1. На странице **назначения ролей Добавить** сделайте следующие шаги:
    1. Выберите **роль автобуса обслуживания, которую** вы хотите назначить. 
    1. Поиск, чтобы найти **основную безопасность** (пользователь, группа, директор службы), которому вы хотите назначить роль.
    1. Выберите **Сохранить,** чтобы сохранить назначение ролей. 

        ![Назначить роль пользователю](./media/authenticate-application/assign-role-to-user.png)
    4. Удостоверение, которому назначена роль RBAC, будет отображаться в списке под этой ролью. Например, следующее изображение показывает, что пользователи Azure в роли владельца данных шины Azure. 
        
        ![Пользователь в списке](./media/authenticate-application/user-in-list.png)

Можно выполнить аналогичные действия, чтобы назначить роль, область действия— группу ресурсов или подписку. После определения роли и сферы действия можно проверить это поведение с [помощью примеров на GitHub.](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/RoleBasedAccessControl)


## <a name="authenticate-from-an-application"></a>Аутентификация из приложения
Ключевым преимуществом использования Azure AD с Service Bus является то, что учетные данные больше не должны храниться в коде. Вместо этого вы можете запросить токен доступа OAuth 2.0 от платформы идентификации Майкрософт. Azure AD проверяет подлинность принципаслужбы безопасности (пользователя, группы или директора службы), работая с приложением. Если аутентификация удается, Azure AD возвращает токен доступа в приложение, и приложение может использовать маркер доступа для авторизации запросов в Azure Service Bus.

Ниже приведены разделы, как настроить нативное приложение или веб-приложение для проверки подлинности с помощью платформы идентификации Microsoft 2.0. Для получения дополнительной информации о платформе [Microsoft identity platform (v2.0) overview](../active-directory/develop/v2-overview.md)идентификации Microsoft 2.0 см.

Общие сведения о процессе предоставления кода OAuth 2.0 представлены в разделе [Авторизация доступа к веб-приложениям Azure Active Directory с помощью потока предоставления кода OAuth 2.0](../active-directory/develop/v2-oauth2-auth-code-flow.md).

### <a name="register-your-application-with-an-azure-ad-tenant"></a>Регистрация приложения в клиенте Azure AD
Первым шагом в использовании Azure AD для авторизации объектов Service Bus является регистрация клиентского приложения с помощью клиента Azure AD с [портала Azure.](https://portal.azure.com/) При регистрации клиентского приложения вы предоставляете информацию о приложении aD. Затем Azure AD предоставляет идентификатор клиента (также называемый идентификатор приложения), который можно использовать для ассоциировать приложение с временем выполнения Azure AD. Дополнительные сведения об идентификаторе клиента см. в статье [Объекты приложения и субъекта-службы в Azure Active Directory](../active-directory/develop/app-objects-and-service-principals.md). 

Следующие изображения показывают шаги для регистрации веб-приложения:

![Регистрация приложения](./media/authenticate-application/app-registrations-register.png)

> [!Note]
> Если вы регистрируете свое заявление в качестве нативного приложения, вы можете указать любой действительный URI для Redirect URI. Для натимного приложения это значение не должно быть реальным URL- Для веб-приложений перенаправление URI должно быть действительным URI, поскольку он определяет URL,к которому предоставляются токены.

После регистрации приложения вы увидите **идентификатор приложения (клиента)** в **настройках:**

![Идентификатор приложения зарегистрированного приложения](./media/authenticate-application/application-id.png)

Дополнительные сведения о регистрации приложения в Azure AD см. в разделе [Интеграция приложений с Azure Active Directory](../active-directory/develop/quickstart-v2-register-an-app.md).

> [!IMPORTANT]
> Обратите внимание на **TenantId** и **ApplicationId**. Для запуска приложения потребуются эти значения.

### <a name="create-a-client-secret"></a>Создание секрета клиента   
Приложению нужна секрет клиента, чтобы доказать свою личность при запросе токена. Чтобы добавить секрет клиента, выполните следующие шаги.

1. Перейдите к регистрации приложения на портале Azure, если вы еще не на странице.
1. Выберите **Сертификаты & секреты** в левом меню.
1. Под **секретами клиента,** выберите **новый секрет клиента,** чтобы создать новую тайну.

    ![Новый секрет клиента - кнопка](./media/authenticate-application/new-client-secret-button.png)
1. Предоставьте описание секрета и выберите требуемый интервал истечения срока действия, а затем выберите **Добавить**.

    ![Добавление секретной страницы клиента](./media/authenticate-application/add-client-secret-page.png)
1. Немедленно скопируйте значение нового секрета в безопасное место. Значение заполнения отображается вам только один раз.

    ![Секрет клиента](./media/authenticate-application/client-secret.png)

### <a name="permissions-for-the-service-bus-api"></a>Разрешения на API сервисного автобуса
Если приложение является консольным приложением, необходимо зарегистрировать нативное приложение и добавить разрешения API для **Microsoft.ServiceBus** к **набору необходимых разрешений.** Родные приложения также нуждаются в **перенаправлении** URI в Azure AD, который служит идентификатором; URI не обязательно должна быть сетевой целью. В этом примере используйте `https://servicebus.microsoft.com`, так как в образце кода уже используется этот URI.

### <a name="client-libraries-for-token-acquisition"></a>Библиотеки клиентов для приобретения токенов  
После регистрации приложения и предоставления ему разрешений на отправку/получение данных в azure Service Bus можно добавить код в приложение для проверки подлинности принципаслужбы безопасности и приобретения токена OAuth 2.0. Для проверки подлинности и приобретения токена можно использовать одну из [библиотек аутентификации платформы майкрософт](../active-directory/develop/reference-v2-libraries.md) или другую библиотеку с открытым исходным кодом, поддерживающую OpenID или Connect 1.0. Затем приложение может использовать маркер доступа для авторизации запроса в отношении шины службы Azure.

Список сценариев, для которых поддерживается приобретение токенов, смотрите раздел [Сценарии](https://aka.ms/msal-net-scenarios) [Библиотеки подлинности Майкрософт (MSAL) для](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet) репозитория .NET GitHub.

## <a name="sample-on-github"></a>Пример на GitHub
Смотрите следующий пример на GitHub: Управление доступом к [базе ролей для Service Bus.](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/RoleBasedAccessControl) 

Используйте опцию **Client Secret Login,** а не опцию **Interactive User Login.** При использовании секретного варианта клиента вы не видите всплывающее окно. Приложение использует идентификатор клиента и идентификатор приложения для проверки подлинности. 

### <a name="run-the-sample"></a>Запуск примера

Прежде чем вы сможете запустить образец, отредкройте файл **app.config** и, в зависимости от сценария, установите следующие значения:

- `tenantId`. Задайте значение **TenantId**.
- `clientId`. Задайте значение **ApplicationId**.
- `clientSecret`. Если необходимо войти в систему с помощью секрета клиента, создайте его в Azure AD. Кроме того, используйте веб-приложение или API вместо собственного приложения. Добавьте приложение на страницу **Управление доступом (IAM)** в созданном ранее пространстве имен.
- `serviceBusNamespaceFQDN`. Укажите полное DNS-имя созданного пространства имен служебной шины (например, `example.servicebus.windows.net`).
- `queueName`. Укажите имя созданной очереди.
- URI перенаправления, указанный в приложении на предыдущих шагах.

При запуске консольного приложения вам предлагается выбрать сценарий. Выберите **Интерактивный Логин Пользователя,** введя его номер и нажав ENTER. В приложении отображается окно входа в систему, оно запрашивает ваше согласие на доступ к служебной шине, а затем использует службу для запуска сценария отправки или получения с помощью удостоверения для входа.


## <a name="next-steps"></a>Дальнейшие действия
- Чтобы узнать больше о RBAC, [см.](../role-based-access-control/overview.md)
- Чтобы узнать, как назначать роли RBAC и управлять назначениями ролей с помощью Azure PowerShell, Azure CLI или REST API, см. сведения в статьях ниже:
    - [Управление доступом на основе ролей с помощью Azure PowerShell](../role-based-access-control/role-assignments-powershell.md)  
    - [Управление доступом на основе ролей с помощью интерфейса командной строки Azure](../role-based-access-control/role-assignments-cli.md)
    - [Управление доступом на основе ролей с помощью REST API](../role-based-access-control/role-assignments-rest.md)
    - [Управление управлением элементом управления доступом на основе ролей (RBAC) с помощью шаблонов менеджера ресурсов Azure](../role-based-access-control/role-assignments-template.md)

Дополнительную информацию об обмене сообщениями через служебную шину см. в следующих разделах.

- [Образцы сервисного автобуса RBAC](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/RoleBasedAccessControl)
- [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
- [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
- [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)
