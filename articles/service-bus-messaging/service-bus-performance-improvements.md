---
title: Рекомендации по повышению производительности с помощью служебной шины Azure
description: В этой статье описывается использование служебной шины Azure для оптимизации производительности при обмене сообщениями в брокере.
ms.topic: article
ms.date: 06/23/2020
ms.openlocfilehash: a81e6fa1c6097f46bbfa3016beb1b7780ad3c351
ms.sourcegitcommit: d8b8768d62672e9c287a04f2578383d0eb857950
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2020
ms.locfileid: "88065307"
---
# <a name="best-practices-for-performance-improvements-using-service-bus-messaging"></a>Рекомендации по повышению производительности с помощью обмена сообщениями через служебную шину

В этой статье описано использование служебной шины Azure для оптимизации производительности при обмене сообщениями через брокер. В первой части статьи рассматриваются различные механизмы, которые можно использовать для повышения производительности. Во второй части приведены инструкции по эффективному использованию служебной шины для достижения максимальной производительности при определенных условиях.

В этой статье термин "клиент" означает любую сущность, которая обращается к служебной шине. Клиент может быть как отправителем, так и получателем. Термин "отправитель" используется для клиента очереди или раздела служебной шины, который отправляет сообщения в очередь или подписку на раздел. Термин "получатель" используется в отношении клиента очереди или подписки служебной шины, который получает сообщения из очереди или подписки.

В разделах ниже описывается ряд способов, которые используются служебной шиной для повышения производительности.

## <a name="protocols"></a>Протоколы

Служебная шина позволяет клиентам отправлять и получать сообщения с помощью трех протоколов.

1. Протокол AMQP
2. Протокол SBMP
3. Протокол HTTP

AMQP является наиболее эффективным, так как поддерживает подключение к служебной шине. Он также реализует функции пакетной обработки и предварительной выборки. Если явно не указано иное, в этой статье предполагается использование протокола AMQP или SBMP.

> [!IMPORTANT]
> SBMP доступен только для .NET Framework. AMQP используется по умолчанию для .NET Standard.

## <a name="choosing-the-appropriate-service-bus-net-sdk"></a>Выбор соответствующего пакета SDK для .NET служебной шины

Существует два поддерживаемых пакета SDK для .NET служебной шины Azure. Их API-интерфейсы очень похожи, и его можно использовать для выбора. Сведения о принятии решений см. в следующей таблице. Мы рекомендуем использовать пакет SDK Microsoft. Azure. ServiceBus, так как он является более современным, производительным и совместимым с несколькими платформами. Кроме того, он поддерживает AMQP через WebSockets и является частью коллекции SDK Azure .NET для проектов с открытым кодом.

| Пакет NuGet | Основные пространства имен | Минимальная платформа (-ы) | Протокол(-ы) |
|---------------|----------------------|---------------------|-------------|
| <a href="https://www.nuget.org/packages/Microsoft.Azure.ServiceBus" target="_blank">Microsoft. Azure. ServiceBus<span class="docon docon-navigate-external x-hidden-focus"></span></a> | `Microsoft.Azure.ServiceBus`<br>`Microsoft.Azure.ServiceBus.Management` | .NET Core 2.0;<br>.NET Framework 4.6.1<br>Mono 5.4<br>Xamarin.iOS 10.14<br>Xamarin.Mac 3.8<br>Xamarin.Android 8.0;<br>универсальная платформа Windows 10.0.16299. | AMQP<br>HTTP |
| <a href="https://www.nuget.org/packages/WindowsAzure.ServiceBus" target="_blank">WindowsAzure. ServiceBus<span class="docon docon-navigate-external x-hidden-focus"></span></a> | `Microsoft.ServiceBus`<br>`Microsoft.ServiceBus.Messaging` | .NET Framework 4.6.1 | AMQP<br>SBMP<br>HTTP |

Дополнительные сведения о минимальной .NET Standard поддержки платформ см. в разделе [Поддержка реализации .NET](/dotnet/standard/net-standard#net-implementation-support).

## <a name="reusing-factories-and-clients"></a>Повторное использование фабрик и клиентов

# <a name="microsoftazureservicebus-sdk"></a>[Пакет SDK Microsoft. Azure. ServiceBus](#tab/net-standard-sdk)

Клиентские объекты служебной шины, такие как реализации [`IQueueClient`][QueueClient] или [`IMessageSender`][MessageSender] , должны быть зарегистрированы для внедрения зависимостей в виде Singleton-элементов (или создается один раз и совместно используются). Закрывать фабрики обмена сообщениями или клиенты очередей, разделов и подписок после отправки сообщения, а затем повторно создавать их при отправке следующего сообщения не рекомендуется. При закрытии фабрики обмена сообщениями удаляется подключение к службе служебной шины, а при повторном создании фабрики устанавливается новое подключение. Установка подключения является ресурсоемкой операцией, которую можно исключить, если повторно использовать одну и ту же фабрику и клиентские объекты для нескольких операций. Вы можете безопасно использовать объекты клиента для параллельных асинхронных операций из нескольких потоков.

# <a name="windowsazureservicebus-sdk"></a>[Пакет SDK для WindowsAzure. ServiceBus](#tab/net-framework-sdk)

Клиентские объекты служебной шины, такие как `QueueClient` или `MessageSender` , создаются с помощью объекта [MessagingFactory][MessagingFactory] , который также обеспечивает внутреннее управление соединениями. Закрывать фабрики обмена сообщениями или клиенты очередей, разделов и подписок после отправки сообщения, а затем повторно создавать их при отправке следующего сообщения не рекомендуется. При закрытии фабрики обмена сообщениями удаляется подключение к службе служебной шины, а при повторном создании фабрики устанавливается новое подключение. Установка подключения является ресурсоемкой операцией, которую можно исключить, если повторно использовать одну и ту же фабрику и клиентские объекты для нескольких операций. Вы можете безопасно использовать объекты клиента для параллельных асинхронных операций из нескольких потоков.

---

## <a name="concurrent-operations"></a>Параллельные операции

Выполнение любой операции (отправка, получение, удаление и т. д.) занимает определенное время. Это время включает обработку операции службой служебной шины в дополнение к задержке запроса и ответа. Чтобы увеличить количество операций в единицу времени, необходимо выполнять их параллельно.

Клиент планирует параллельные операции за счет асинхронных операций. Следующий запрос запускается до завершения предыдущего запроса. Вот пример фрагмента кода асинхронной операции отправки:

# <a name="microsoftazureservicebus-sdk"></a>[Пакет SDK Microsoft. Azure. ServiceBus](#tab/net-standard-sdk)

```csharp
var messageOne = new Message(body);
var messageTwo = new Message(body);

var sendFirstMessageTask =
    queueClient.SendAsync(messageOne).ContinueWith(_ =>
    {
        Console.WriteLine("Sent message #1");
    });
var sendSecondMessageTask =
    queueClient.SendAsync(messageTwo).ContinueWith(_ =>
    {
        Console.WriteLine("Sent message #2");
    });

await Task.WhenAll(sendFirstMessageTask, sendSecondMessageTask);
Console.WriteLine("All messages sent");
```

# <a name="windowsazureservicebus-sdk"></a>[Пакет SDK для WindowsAzure. ServiceBus](#tab/net-framework-sdk)

```csharp
var messageOne = new BrokeredMessage(body);
var messageTwo = new BrokeredMessage(body);

var sendFirstMessageTask =
    queueClient.SendAsync(messageOne).ContinueWith(_ =>
    {
        Console.WriteLine("Sent message #1");
    });
var sendSecondMessageTask =
    queueClient.SendAsync(messageTwo).ContinueWith(_ =>
    {
        Console.WriteLine("Sent message #2");
    });

await Task.WhenAll(sendFirstMessageTask, sendSecondMessageTask);
Console.WriteLine("All messages sent");
```

---

Вот пример асинхронной операции получения.

# <a name="microsoftazureservicebus-sdk"></a>[Пакет SDK Microsoft. Azure. ServiceBus](#tab/net-standard-sdk)

Полные <a href="https://github.com/Azure/azure-service-bus/blob/master/samples/DotNet/Microsoft.Azure.ServiceBus/SendersReceiversWithQueues" target="_blank"> <span class="docon docon-navigate-external x-hidden-focus"></span> примеры исходного кода </a>см. в репозитории GitHub:

```csharp
var receiver = new MessageReceiver(connectionString, queueName, ReceiveMode.PeekLock);

static Task LogErrorAsync(Exception exception)
{
    Console.WriteLine(exception);
    return Task.CompletedTask;
};

receiver.RegisterMessageHandler(
    async (message, cancellationToken) =>
    {
        Console.WriteLine("Handle message");
        await receiver.CompleteAsync(message.SystemProperties.LockToken);
    },
    new MessageHandlerOptions(e => LogErrorAsync(e.Exception))
    {
        AutoComplete = false,
        MaxConcurrentCalls = 20
    });
```

`MessageReceiver`Экземпляр объекта создается с помощью строки подключения, имени очереди и режима получения просмотра. Затем `receiver` экземпляр используется для регистрации обработчика сообщений.

# <a name="windowsazureservicebus-sdk"></a>[Пакет SDK для WindowsAzure. ServiceBus](#tab/net-framework-sdk)

Полные <a href="https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/SendersReceiversWithQueues" target="_blank"> <span class="docon docon-navigate-external x-hidden-focus"></span> примеры исходного кода </a>см. в репозитории GitHub:

```csharp
var factory = MessagingFactory.CreateFromConnectionString(connectionString);
var receiver = await factory.CreateMessageReceiverAsync(queueName, ReceiveMode.PeekLock);

// Register the handler to receive messages asynchronously
receiver.OnMessageAsync(
    async message =>
    {
        Console.WriteLine("Handle message");
        await message.CompleteAsync();
    },
    new OnMessageOptions
    {
        AutoComplete = false,
        MaxConcurrentCalls = 20
    });
```

`MessagingFactory`Создает `factory` объект из строки подключения. Экземпляр создает экземпляр `factory` `MessageReceiver` . Затем `receiver` экземпляр используется для регистрации обработчика сообщений.

---

## <a name="receive-mode"></a>Режим получения

При создании клиента очереди или подписки вы можете выбрать режим получения: *блокировка для просмотра* или *получение и удаление*. Режим получения по умолчанию — `PeekLock`. При работе в режиме по умолчанию клиент отправляет запрос на получение сообщения из служебной шины. После получения сообщения клиент отправляет запрос на завершение сообщения.

При установке режима получения `ReceiveAndDelete` оба действия объединяются в одном запросе. В результате этих шагов уменьшается общее количество операций, что может повысить общую пропускную способность для сообщений. Однако такое повышение производительности сопряжено с риском потери сообщений.

Служебная шина не поддерживает транзакции для операций получения и удаления. Кроме того, иногда требуется семантика блокировки для просмотра (например, если клиенту необходимо отложить сообщение или [пометить его как недоставленное](service-bus-dead-letter-queues.md)).

## <a name="client-side-batching"></a>Пакетная обработка на стороне клиента

Пакетная обработка на стороне клиента позволяет клиенту очереди или раздела задержать отправку сообщения на определенный период времени. Если в течение этого времени клиент будет отправлять дополнительные сообщения, они будут переданы в одном пакете. Кроме того, пакетная обработка на стороне клиента очереди или подписки позволяет объединить несколько запросов на **завершение** в один. Пакетная обработка может использоваться только для асинхронных операций **отправки** и **завершения**. Синхронные операции отправляются в службу служебной шины незамедлительно. Пакетная обработка недоступна для операций просмотра или получения. Также пакетную обработку нельзя использовать для объединения операций нескольких клиентов.

# <a name="microsoftazureservicebus-sdk"></a>[Пакет SDK Microsoft. Azure. ServiceBus](#tab/net-standard-sdk)

Функция пакетной обработки для пакета SDK для .NET Standard пока не предоставляет свойство для управления.

# <a name="windowsazureservicebus-sdk"></a>[Пакет SDK для WindowsAzure. ServiceBus](#tab/net-framework-sdk)

По умолчанию интервал пакетной обработки в клиенте составляет 20 мс. Интервал пакетной обработки можно изменить с помощью свойства [BatchFlushInterval][BatchFlushInterval], которое задается перед созданием фабрики обмена сообщениями. Этот параметр влияет на все клиенты, создаваемые этой фабрикой.

Чтобы отключить пакетную обработку, задайте для свойства [BatchFlushInterval][BatchFlushInterval] значение **TimeSpan.Zero**. Пример.

```csharp
var settings = new MessagingFactorySettings
{
    NetMessagingTransportSettings =
    {
        BatchFlushInterval = TimeSpan.Zero
    }
};
var factory = MessagingFactory.Create(namespaceUri, settings);
```

Пакетная обработка не влияет на количество оплачиваемых операций обмена сообщениями и доступна только для протокола клиента служебной шины с использованием библиотеки [Microsoft.ServiceBus.Messaging](https://www.nuget.org/packages/WindowsAzure.ServiceBus/). Протокол HTTP не поддерживает пакетную обработку.

> [!NOTE]
> Параметр `BatchFlushInterval` гарантирует, что Пакетная обработка будет неявной с точки зрения приложения. т. е. приложение создает `SendAsync` и `CompleteAsync` вызывает и не выполняет определенные вызовы пакетной службы.
>
> Явную пакетную обработку на стороне клиента можно реализовать, используя следующий вызов метода:
> ```csharp
> Task SendBatchAsync(IEnumerable<BrokeredMessage> messages);
> ```
> Здесь общий размер сообщений должен быть меньше, чем максимальный размер, поддерживаемый ценовой категорией.

---

## <a name="batching-store-access"></a>Пакетный доступ к хранилищу

Чтобы увеличить пропускную способность очереди, раздела или подписки, служебная шина объединяет несколько сообщений в пакеты, когда записывает их в свое внутреннее хранилище. Если эта функция включена для очереди или раздела, сообщения записываются в хранилище в пакетном режиме. Если эта функция включена для очереди или подписки, сообщения будут удаляться из хранилища в пакетном режиме. Если пакетный доступ к хранилищу включен для сущности, служебная шина будет задерживать операцию записи для этой сущности на период до 20 мс.

> [!NOTE]
> При пакетной обработке нет опасности потерять сообщения, даже если по истечении 20 мс такой обработки происходит сбой службы "Служебная шина".

Последующие операции с хранилищем, выполняемые в течение этого периода, добавляются в пакет. Доступ к хранилищу в пакетном режиме влияет только на операции **отправки** и **завершения**. Операции получения этот режим не затрагивает. Пакетный доступ к хранилищу является свойством сущности. Пакетная обработка применяется ко всем сущностям, для которых включен пакетный доступ к хранилищу.

При создании новой очереди, раздела или подписки пакетный доступ к хранилищу включен по умолчанию.

# <a name="microsoftazureservicebus-sdk"></a>[Пакет SDK Microsoft. Azure. ServiceBus](#tab/net-standard-sdk)

Для отключения пакетного доступа к хранилищу необходим экземпляр `ManagementClient` . Создайте очередь из описания очереди, которая задает `EnableBatchedOperations` для свойства значение `false` .

```csharp
var queueDescription = new QueueDescription(path)
{
    EnableBatchedOperations = false
};
var queue = await managementClient.CreateQueueAsync(queueDescription);
```

Дополнительные сведения см. в следующих разделах:
* <a href="https://docs.microsoft.com/dotnet/api/microsoft.azure.servicebus.management.queuedescription.enablebatchedoperations?view=azure-dotnet" target="_blank">`Microsoft.Azure.ServiceBus.Management.QueueDescription.EnableBatchedOperations` <span class="docon docon-navigate-external x-hidden-focus"></span></a>.
* <a href="https://docs.microsoft.com/dotnet/api/microsoft.azure.servicebus.management.subscriptiondescription.enablebatchedoperations?view=azure-dotnet" target="_blank">`Microsoft.Azure.ServiceBus.Management.SubscriptionDescription.EnableBatchedOperations` <span class="docon docon-navigate-external x-hidden-focus"></span></a>.
* <a href="https://docs.microsoft.com/dotnet/api/microsoft.azure.servicebus.management.topicdescription.enablebatchedoperations?view=azure-dotnet" target="_blank">`Microsoft.Azure.ServiceBus.Management.TopicDescription.EnableBatchedOperations` <span class="docon docon-navigate-external x-hidden-focus"></span></a>.

# <a name="windowsazureservicebus-sdk"></a>[Пакет SDK для WindowsAzure. ServiceBus](#tab/net-framework-sdk)

Для отключения пакетного доступа к хранилищу необходим экземпляр `NamespaceManager` . Создайте очередь из описания очереди, которая задает `EnableBatchedOperations` для свойства значение `false` .

```csharp
var queueDescription = new QueueDescription(path)
{
    EnableBatchedOperations = false
};
var queue = namespaceManager.CreateQueue(queueDescription);
```

Дополнительные сведения см. в следующих разделах:
* <a href="https://docs.microsoft.com/dotnet/api/microsoft.servicebus.messaging.queuedescription.enablebatchedoperations?view=azure-dotnet" target="_blank">`Microsoft.ServiceBus.Messaging.QueueDescription.EnableBatchedOperations` <span class="docon docon-navigate-external x-hidden-focus"></span></a>.
* <a href="https://docs.microsoft.com/dotnet/api/microsoft.servicebus.messaging.subscriptiondescription.enablebatchedoperations?view=azure-dotnet" target="_blank">`Microsoft.ServiceBus.Messaging.SubscriptionDescription.EnableBatchedOperations` <span class="docon docon-navigate-external x-hidden-focus"></span></a>.
* <a href="https://docs.microsoft.com/dotnet/api/microsoft.servicebus.messaging.topicdescription.enablebatchedoperations?view=azure-dotnet" target="_blank">`Microsoft.ServiceBus.Messaging.TopicDescription.EnableBatchedOperations` <span class="docon docon-navigate-external x-hidden-focus"></span></a>.

---

Пакетный доступ к хранилищу не влияет на количество оплачиваемых операций обмена сообщениями и является свойством очереди, раздела или подписки. Он не зависит от режима получения и протокола, используемого для подключения между клиентом и службой служебной шины.

## <a name="prefetching"></a>Предварительная выборка

[Предварительная выборка](service-bus-prefetch.md) позволяет клиенту очереди или подписки загружать дополнительные сообщения из службы при выполнении операции получения. Клиент сохраняет эти сообщения в локальном кэше. Размер кэша определяется `QueueClient.PrefetchCount` `SubscriptionClient.PrefetchCount` свойствами или. В каждом клиенте с включенной предварительной выборкой создается собственный кэш. Кэш не может использоваться одновременно несколькими клиентами. Если клиент инициирует операцию получения и его кэш пуст, служба передает пакет сообщений. Размер пакета равен размеру кэша или 256 КБ (в зависимости от того, какое значение меньше). Если клиент инициирует операцию получения и в кэше имеется сообщение, это сообщение извлекается из кэша.

При использовании предварительной выборки сообщений служба блокирует выбранное сообщение. В результате блокировки это сообщение не может быть получено другим получателем. Если получатель не может завершить сообщение до истечения периода блокировки, сообщение станет доступным другим получателям. Копия предварительно выбранного сообщения остается в кэше. Если получатель обратится к кэшированной копии, срок действия которой истек, то при попытке завершить это сообщение будет создано исключение. По умолчанию период блокировки сообщения составляет 60 секунд. Это значение можно увеличить до 5 минут. Во избежание использования сообщений с истекшим сроком действия размер кэша всегда должен быть меньше, чем количество сообщений, которые могут быть использованы клиентом в течение периода блокировки.

При использовании срока блокировки по умолчанию в 60 секунд для `PrefetchCount` хорошо подходит значение, в 20 раз превышающее максимальную скорость обработки для всех получателей фабрики. Например, фабрика создает трех получателей, каждый из которых может обработать до 10 сообщений в секунду. Число объектов предварительной выборки не должно превышать 20 х 3 х 10 = 600. По умолчанию `PrefetchCount` имеет значение 0, что означает, что никакие дополнительные сообщения из службы не извлекаться.

Предварительная выборка сообщений увеличивает совокупную пропускную способность очереди или подписки, так как уменьшает общее количество операций с сообщениями (так называемых круговых путей). Тем не менее предварительная выборка первого сообщения займет больше времени (из-за увеличенного размера сообщения). Получение предварительно выбранных сообщений будет выполняться быстрее, так как эти сообщения уже загружены клиентом.

Свойство срока жизни сообщения проверяется сервером в момент отправки сообщения клиенту. Клиент не проверяет свойство TTL сообщения при получении сообщения. Вместо этого сообщение может быть получено, даже если срок жизни сообщения истек, пока сообщение было кэшировано клиентом.

Предварительная выборка не влияет на количество оплачиваемых операций обмена сообщениями и доступна только для протокола клиента служебной шины. Протокол HTTP не поддерживает предварительную выборку. Предварительная выборка доступна как для синхронных, так и для асинхронных операций получения.

# <a name="microsoftazureservicebus-sdk"></a>[Пакет SDK Microsoft. Azure. ServiceBus](#tab/net-standard-sdk)

Дополнительные сведения см. в следующих `PrefetchCount` свойствах:

* <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.servicebus.queueclient.prefetchcount?view=azure-dotnet" target="_blank">`Microsoft.Azure.ServiceBus.QueueClient.PrefetchCount` <span class="docon docon-navigate-external x-hidden-focus"></span></a>.
* <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.servicebus.subscriptionclient.prefetchcount?view=azure-dotnet" target="_blank">`Microsoft.Azure.ServiceBus.SubscriptionClient.PrefetchCount` <span class="docon docon-navigate-external x-hidden-focus"></span></a>.

# <a name="windowsazureservicebus-sdk"></a>[Пакет SDK для WindowsAzure. ServiceBus](#tab/net-framework-sdk)

Дополнительные сведения см. в следующих `PrefetchCount` свойствах:

* <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.servicebus.messaging.queueclient.prefetchcount?view=azure-dotnet" target="_blank">`Microsoft.ServiceBus.Messaging.QueueClient.PrefetchCount` <span class="docon docon-navigate-external x-hidden-focus"></span></a>.
* <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.servicebus.messaging.subscriptionclient.prefetchcount?view=azure-dotnet" target="_blank">`Microsoft.ServiceBus.Messaging.SubscriptionClient.PrefetchCount` <span class="docon docon-navigate-external x-hidden-focus"></span></a>.

---

## <a name="prefetching-and-receivebatch"></a>Упреждающая выборка и Рецеивебатч

> [!NOTE]
> Этот раздел применим только к пакету SDK для WindowsAzure. ServiceBus, так как пакет SDK Microsoft. Azure. ServiceBus не предоставляет функции пакетной службы.

Хотя основные понятия, связанные с выборке нескольких сообщений, имеют схожую семантику для обработки сообщений в пакете ( `ReceiveBatch` ), существуют некоторые небольшие отличия, которые следует помнить при использовании этих компонентов вместе.

Предварительная выборка — это конфигурация (или режим) на клиенте ( `QueueClient` и `SubscriptionClient` ), `ReceiveBatch` которая является операцией (с семантикой запросов и ответов).

При совместном использовании следует учитывать следующие случаи.

* Предвыборка должна быть больше или равна количеству сообщений, из которых ожидается получение `ReceiveBatch` .
* При выборке может быть не более n/3 раз больше количества сообщений, обрабатываемых в секунду, где n — продолжительность блокировки по умолчанию.

Существуют некоторые трудности с беспроблемным подходом (т. е. поддержание счетчика предварительной выборки очень высоким), так как это означает, что сообщение заблокировано определенным получателем. Рекомендуется испробовать значения предварительного выборки между пороговыми значениями, упомянутыми выше, и определить, что помещается.

## <a name="multiple-queues"></a>Несколько очередей

Если ожидаемая нагрузка не может обрабатываться одной очередью или разделом, необходимо использовать несколько сущностей обмена сообщениями. При использовании нескольких сущностей создайте выделенный клиент для каждой сущности. Не используйте один клиент для всех сущностей.

## <a name="development-and-testing-features"></a>Возможности для разработки и тестирования

> [!NOTE]
> Этот раздел применим только к пакету SDK для WindowsAzure. ServiceBus, так как пакет SDK Microsoft. Azure. ServiceBus не предоставляет эти функции.

В служебной шине есть один компонент, используемый специально для разработки, который **никогда не должен использоваться в рабочих конфигурациях**: [`TopicDescription.EnableFilteringMessagesBeforePublishing`][TopicDescription.EnableFiltering] .

При добавлении к разделу новых правил или фильтров можно использовать [`TopicDescription.EnableFilteringMessagesBeforePublishing`][TopicDescription.EnableFiltering] для проверки правильности работы нового критерия фильтра.

## <a name="scenarios"></a>Сценарии

Далее описываются стандартные сценарии обмена сообщениями и приводятся рекомендации по настройкам служебной шины. Пропускная способность бывает небольшой (менее 1 сообщения в секунду), средней (1 сообщение в секунду или больше, но не более 100 сообщений в секунду) и высокой (100 сообщений в секунду или больше). Количество клиентов бывает небольшим (5 и меньше), средним (более 5, но не более 20) и большим (более 20).

### <a name="high-throughput-queue"></a>Очередь с высокой пропускной способностью

Цель: максимально повысить пропускную способность одной очереди. Количество отправителей и получателей: небольшое.

* Чтобы увеличить общую скорость отправки сообщений в очередь, используйте несколько фабрик обмена сообщениями для создания отправителей. Для каждого отправителя используйте асинхронные операции или разделение на потоки.
* Чтобы увеличить общую скорость получения сообщений из очереди, используйте несколько фабрик обмена сообщениями для создания получателей.
* Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.
* Установите интервал пакетной обработки на 50 мс, чтобы уменьшить число передач по протоколу клиента служебной шины. Если используется несколько отправителей, увеличьте интервал пакетной обработки до 100 мс.
* Не отключайте пакетный доступ к хранилищу. Этот доступ повысит общую скорость записи сообщений в очередь.
* Для количества элементов предварительной выборки установите значение, в 20 раз превышающее максимальную скорость обработки всех получателей фабрики. Это снизит число передач по протоколу клиента служебной шины.

### <a name="multiple-high-throughput-queues"></a>Несколько очередей с высокой пропускной способностью

Цель: максимально повысить общую пропускную способность нескольких очередей. Пропускная способность одной очереди: средняя или высокая.

Чтобы максимально повысить пропускную способность нескольких очередей, примените настройки, максимально повышающие пропускную способность одной очереди. Кроме того, используйте несколько фабрик для создания клиентов, которые отправляют или получают сообщения из разных очередей.

### <a name="low-latency-queue"></a>Очередь с небольшой задержкой

Цель: минимизировать совокупное время задержки в очереди или разделе. Количество отправителей и получателей: небольшое. Пропускная способность очереди: низкая или средняя.

* Отключите пакетную обработку на стороне клиента. Клиент будет немедленно отправлять сообщения.
* Отключите пакетный доступ к хранилищу. Служба будет немедленно записывать сообщения в хранилище.
* При использовании одного клиента измените количество элементов предварительной выборки на значение, в 20 раз превышающее скорость обработки получателя. Если в очередь одновременно поступает несколько сообщений, протокол клиента служебной шины передаст их все одновременно. Когда клиент получит следующее сообщение, оно уже будет в локальном кэше. Размер кэша должен быть небольшим.
* При использовании нескольких клиентов установите количество элементов предварительной выборки на 0. В результате этого второй клиент сможет получить второе сообщение, пока первый клиент будет обрабатывать первое сообщение.

### <a name="queue-with-a-large-number-of-senders"></a>Очередь с большим числом отправителей

Цель: максимально повысить пропускную способность очереди или раздела с большим количеством отправителей. Каждый отправитель отправляет сообщения со средней скоростью. Количество получателей: небольшое.

Служебная шина позволяет до 1000 одновременных подключений к сущности обмена сообщениями. Это ограничение установлено на уровне пространства имен. Очереди, разделы и подписки ограничены максимальным числом параллельных подключений для соответствующего пространства имен. В случае очередей это значение распределяется между отправителями и получателями. Если отправителям требуются все 1000 подключений, замените очередь одним разделом и одной подпиской. Раздел допускает до 1000 параллельных подключений от отправителей, тогда как подписка допускает 1000 дополнительных параллельных подключений от получателей. Если количество параллельных отправителей превышает 1000, то они должны отправлять сообщения на протокол служебной шины по протоколу HTTP.

Чтобы максимально повысить пропускную способность, выполните следующие шаги:

* Если каждый отправитель размещается в отдельном процессе, используйте одну фабрику для этого процесса.
* Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.
* Установите интервал пакетной обработки на 20 мс, чтобы уменьшить число передач по протоколу клиента служебной шины.
* Не отключайте пакетный доступ к хранилищу. Этот доступ повысит общую скорость записи сообщений в очередь или раздел.
* Для количества элементов предварительной выборки установите значение, в 20 раз превышающее максимальную скорость обработки всех получателей фабрики. Это снизит число передач по протоколу клиента служебной шины.

### <a name="queue-with-a-large-number-of-receivers"></a>Очередь с большим числом получателей

Цель: максимально повысить скорость получения в очереди или подписке с большим количеством получателей. Каждый получатель получает сообщения со средней скоростью. Количество отправителей: небольшое.

В служебной шине можно открыть до 1000 параллельных подключений к сущности. Если для очереди требуется более 1000 получателей, замените очередь одним разделом и несколькими подписками. Каждая подписка поддерживает до 1000 параллельных подключений. Кроме того, получатели могут обращаться к очереди через протокол HTTP.

Чтобы максимально повысить пропускную способность, выполните следующие действия.

* Если каждый получатель размещается в отдельном процессе, используйте одну фабрику для этого процесса.
* Получатели могут использовать синхронные и асинхронные операции. Учитывая среднюю скорость получения отдельного получателя, пакетная обработка на стороне клиента в отношении запросов на завершение не повлияет на пропускную способность получателя.
* Не отключайте пакетный доступ к хранилищу. Это снизит общую нагрузку на сущность. Кроме того, это понизит общую скорость записи сообщений в очередь или раздел.
* Для количества элементов предварительной выборки установите небольшое значение (например, PrefetchCount = 10). Это позволит избежать ситуации, когда одни получатели простаивают, а другие получают множество кэшированных сообщений.

### <a name="topic-with-a-small-number-of-subscriptions"></a>Раздел с небольшим количеством подписок

Цель: максимально повысить пропускную способность раздела с небольшим количеством подписок. Сообщение получается несколькими подписками. Это означает, что общая скорость получения во всех подписках будет больше, чем скорость отправки. Количество отправителей: небольшое. Получателей в каждой подписке так же немного.

Чтобы максимально повысить пропускную способность, выполните следующие действия.

* Чтобы увеличить общую скорость отправки сообщений в раздел, используйте несколько фабрик обмена сообщениями для создания отправителей. Для каждого отправителя используйте асинхронные операции или разделение на потоки.
* Чтобы увеличить общую скорость получения сообщений из подписки, используйте несколько фабрик обмена сообщениями для создания получателей. Для каждого получателя используйте асинхронные операции или разделение на потоки.
* Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.
* Установите интервал пакетной обработки на 20 мс, чтобы уменьшить число передач по протоколу клиента служебной шины.
* Не отключайте пакетный доступ к хранилищу. Это повысит общую скорость записи сообщений в раздел.
* Для количества элементов предварительной выборки установите значение, в 20 раз превышающее максимальную скорость обработки всех получателей фабрики. Это снизит число передач по протоколу клиента служебной шины.

### <a name="topic-with-a-large-number-of-subscriptions"></a>Раздел с большим количеством подписок

Цель: максимально повысить пропускную способность раздела с большим количеством подписок. Сообщение направляется нескольким подпискам. Это означает, что общая скорость получения во всех подписках будет значительно больше, чем скорость отправки. Количество отправителей: небольшое. Получателей в каждой подписке так же немного.

Разделы с большим количеством подписок обычно обеспечивают низкую общую пропускную способность, если все сообщения направляются во все подписки. Низкая пропускная способность связана с тем, что получение каждого сообщения выполняется много раз, а все содержащиеся в разделе сообщения и все подписки раздела хранятся в одном хранилище. Предполагается, что количество отправителей и получателей в каждой подписке небольшое. Служебная шина поддерживает до 2000 подписок на раздел.

Чтобы максимально повысить пропускную способность, попробуйте выполнить следующие шаги:

* Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.
* Установите интервал пакетной обработки на 20 мс, чтобы уменьшить число передач по протоколу клиента служебной шины.
* Не отключайте пакетный доступ к хранилищу. Это повысит общую скорость записи сообщений в раздел.
* Для количества элементов предварительной выборки установите значение, в 20 раз превышающее ожидаемую скорость получения в секундах. Это снизит число передач по протоколу клиента служебной шины.

<!-- .NET Standard SDK, Microsoft.Azure.ServiceBus -->
[QueueClient]: /dotnet/api/microsoft.azure.servicebus.queueclient
[MessageSender]: /dotnet/api/microsoft.azure.servicebus.core.messagesender

<!-- .NET Framework SDK, Microsoft.Azure.ServiceBus -->
[MessagingFactory]: /dotnet/api/microsoft.servicebus.messaging.messagingfactory
[BatchFlushInterval]: /dotnet/api/microsoft.servicebus.messaging.messagesender.batchflushinterval
[ForcePersistence]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage.forcepersistence
[EnablePartitioning]: /dotnet/api/microsoft.servicebus.messaging.queuedescription.enablepartitioning
[TopicDescription.EnableFiltering]: /dotnet/api/microsoft.servicebus.messaging.topicdescription.enablefilteringmessagesbeforepublishing

<!-- Local links -->
[Partitioned messaging entities]: service-bus-partitioning.md