---
title: Обмен сообщениями служебной шины Azure — очереди, разделы и подписки
description: В этой статье представлен обзор сущностей обмена сообщениями служебной шины Azure (очередей, разделов и подписок).
ms.topic: article
ms.date: 11/04/2020
ms.openlocfilehash: 54b6a1fd2d4e8e5ef5bb6522374646257213e4b4
ms.sourcegitcommit: 6a770fc07237f02bea8cc463f3d8cc5c246d7c65
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/24/2020
ms.locfileid: "95791608"
---
# <a name="service-bus-queues-topics-and-subscriptions"></a>Очереди, разделы и подписки служебной шины
Служебная шина Azure поддерживает набор облачных технологий промежуточного уровня, ориентированных на обработку сообщений. Эти технологии представлены надежными очередями сообщений, а также возможностями публикации и подписки в рамках обмена сообщениями. Эти возможности обмена сообщениями через брокер можно рассматривать как несвязанные функции обмена сообщениями, поддерживающие публикацию, подписывание, временное разделение и сценарии балансировки нагрузки с помощью рабочей нагрузки обмена сообщениями служебной шины. Несвязанное взаимодействие имеет много преимуществ. Например, клиенты и серверы могут подключаться по мере необходимости и выполнять операции асинхронно.

Сущности обмена сообщениями, которые формируют ядро возможностей обмена сообщениями в служебной шине, — это **очереди**, **разделы и подписки**, а также правила и действия.

## <a name="queues"></a>Очереди
Очереди предлагают доставку сообщений конкурирующим потребителям по типу **FIFO** (первым пришел, первым вышел). То есть получатели обычно получают и обрабатывают сообщения в том порядке, в котором они были добавлены в очередь. И только один потребитель сообщений получает и обрабатывает каждое сообщение. Основное преимущество использования очередей заключается в достижении **временного разделения компонентов приложения**. Другими словами, производители (отправители) и потребители (получатели) не должны отправлять и получать сообщения одновременно. Это обусловлено тем, что сообщения хранятся надежно в очереди. Более того, производитель не должен ждать ответа от потребителя, чтобы продолжить обработку и отправку сообщений.

Связанное преимущество — это **Выравнивание нагрузки**, которое позволяет производителям и потребителям отправлять и получать сообщения по различным тарифам. Во многих приложениях нагрузка на систему зависит от времени. Однако время обработки, необходимое для каждой единицы работы, обычно является константой. Интермедиатинг сообщений и потребители с очередью означает, что работающие приложения должны иметь возможность обрабатывать среднюю нагрузку, а не пиковую нагрузку. При колебаниях входящей нагрузки просто изменяется глубина очереди. Эта возможность позволяет существенно сократить расходы на инфраструктуру, необходимую для обработки нагрузки приложения. По мере возрастания нагрузки могут потребоваться дополнительные рабочие процессы для чтения из очереди. Каждое сообщение обрабатывается одним рабочим процессом. Кроме того, эта балансировка нагрузки на основе запроса позволяет лучше использовать рабочие компьютеры, даже если рабочие компьютеры, на которых обрабатываются сообщения Power Pull, имеют свою максимальную скорость. данный шаблон часто называется **конкурирующий потребитель**

Использование очередей в качестве посредника между производителями и потребителями сообщений уменьшает зависимость между компонентами. Так как производители и потребители не знают друг о друга, потребитель может быть обновлен без каких-либо последствий с производителем.

### <a name="create-queues"></a>Создание очередей
Вы можете создавать очереди с помощью шаблонов [портал Azure](service-bus-quickstart-portal.md), [PowerShell](service-bus-quickstart-powershell.md), [CLI](service-bus-quickstart-cli.md)или [Диспетчер ресурсов](service-bus-resource-manager-namespace-queue.md). Затем Отправка и получение сообщений с помощью клиентов, написанных на [языках C#](service-bus-dotnet-get-started-with-queues.md), [Java](service-bus-java-how-to-use-queues.md), [Python](service-bus-python-how-to-use-queues.md), [JavaScript](service-bus-nodejs-how-to-use-queues.md), [PHP](service-bus-php-how-to-use-queues.md)и [Ruby](service-bus-ruby-how-to-use-queues.md). 

### <a name="receive-modes"></a>Режимы приема
Вы можете указать два режима получения сообщений служебной шины: **ReceiveAndDelete** или **PeekLock**. В режиме [ReceiveAndDelete](/dotnet/api/microsoft.azure.servicebus.receivemode) , когда служебная шина получает запрос от потребителя, сообщение помечается как используемое и возвращается в приложение-потребитель. Этот режим является самой простой моделью. Лучше подходит для сценариев, в которых приложение может не обрабатывать сообщения в случае сбоя. Чтобы понять этот сценарий, рассмотрим сценарий, в котором объект-получатель выдает запрос на получение и выходит из строя до его обработки. Так как служебная шина помечает сообщение как использованное, приложение начинает потреблять сообщения после перезапуска. Он пропустит сообщение, которое оно использовало до сбоя.

В режиме [PeekLock](/dotnet/api/microsoft.azure.servicebus.receivemode) операция Receive преобразуется в два этапа, что позволяет поддерживать приложения, которые не допускают потери сообщений. Когда служебная шина получает запрос, она выполняет следующие операции:

1. Поиск следующего сообщения, которое необходимо использовать.
1. Блокирует его, чтобы другие потребители не получали его.
1. Затем верните сообщение в приложение. 

После того как приложение заканчивает обработку сообщения или надежно сохраняет его для будущей обработки, оно завершает второй этап процесса получения, вызывая [`CompleteAsync`](/dotnet/api/microsoft.azure.servicebus.queueclient.completeasync) для сообщения. Когда служебная шина получает запрос **комплетеасинк** , сообщение помечается как используемое.

Если приложение не может обработать сообщение по какой-либо причине, оно может вызвать [`AbandonAsync`](/dotnet/api/microsoft.azure.servicebus.queueclient.abandonasync) метод для сообщения (а не [`CompleteAsync`](/dotnet/api/microsoft.azure.servicebus.queueclient.completeasync) ). Благодаря этому методу служебная шина разблокирует сообщение в очереди, сделав его доступным для приема тем же или другим конкурирующим потребителем. Во-вторых, существует время ожидания, связанное с блокировкой. Если приложение не сможет обработать сообщение до истечения времени ожидания блокировки, служебная шина разблокирует сообщение и сделает его доступным для получения.

Если приложение аварийно завершает работу после обработки сообщения, но до его вызова [`CompleteAsync`](/dotnet/api/microsoft.azure.servicebus.queueclient.completeasync) , служебная шина повторно доставляет сообщение в приложение при его перезапуске. Этот процесс часто вызывается **по крайней мере после** обработки. То есть каждое сообщение обрабатывается по крайней мере один раз. Тем не менее в некоторых случаях это же сообщение может быть доставлено повторно. Если ваш сценарий не допускает обработки дубликатов, добавьте в приложение дополнительную логику для обнаружения дубликатов. Его можно получить с помощью свойства [MessageId](/dotnet/api/microsoft.azure.servicebus.message.messageid) сообщения, которое остается постоянным в рамках попыток доставки. Эта функция известна как **exactly once** Однократная обработка.

## <a name="topics-and-subscriptions"></a>Разделы и подписки
Очередь разрешает обработку сообщения одним потребителем. В отличие от очередей, разделы и подписки предоставляют форму связи «один ко многим» в шаблоне **публикации и подписки** . Это удобно при масштабировании до большого числа получателей. Каждое опубликованное сообщение предоставляется в каждой подписке, зарегистрированной в разделе. Издатель отправляет сообщение в раздел, а один или несколько подписчиков получают копию сообщения в зависимости от правил фильтрации, заданных для этих подписок. Подписки могут использовать дополнительные фильтры для ограничения получаемых сообщений. Издатели отправляют сообщения в раздел так же, как они отправляют сообщения в очередь. Но потребители не получают сообщения непосредственно из раздела. Вместо этого потребители получают сообщения из подписок раздела. Подписка раздела напоминает виртуальную очередь, которая получает копии сообщений, отправленных в раздел. Потребители получают сообщения из подписки идентично тому, как они получают сообщения из очереди.

Функции отправки сообщений в очереди сопоставлены непосредственно с темой, а ее функции получения сообщений сопоставлены с подпиской. Помимо прочего, эта возможность означает, что подписки также поддерживают схемы для очередей, описанные ранее в этом разделе, в том числе конкуренцию потребителей, временное разделение, а также выравнивание и балансировку нагрузки.

### <a name="create-topics-and-subscriptions"></a>Создание разделов и подписок
Создание раздела подобно созданию очереди, как показано в примере, приведенном в предыдущем разделе. Вы можете создавать разделы и подписки с помощью шаблонов [портал Azure](service-bus-quickstart-topics-subscriptions-portal.md), [PowerShell](service-bus-quickstart-powershell.md), [CLI](service-bus-tutorial-topics-subscriptions-cli.md)или [Диспетчер ресурсов](service-bus-resource-manager-namespace-topic.md). Затем отправьте сообщения в раздел и получите сообщения из подписок с помощью клиентов, написанных на [языках C#](service-bus-dotnet-how-to-use-topics-subscriptions.md), [Java](service-bus-java-how-to-use-topics-subscriptions.md), [Python](service-bus-python-how-to-use-topics-subscriptions.md), [JavaScript](service-bus-nodejs-how-to-use-topics-subscriptions.md), [PHP](service-bus-php-how-to-use-topics-subscriptions.md)и [Ruby](service-bus-ruby-how-to-use-topics-subscriptions.md). 

### <a name="rules-and-actions"></a>Правила и действия
Во многих ситуациях сообщения с определенными характеристиками должны обрабатываться разными способами. Для этого можно настроить подписки, обеспечивающие поиск сообщений с нужными свойствами, после чего можно определенным образом изменить эти свойства. Подписки служебной шины регистрируют все сообщения, отправленные в раздел, однако в виртуальную очередь подписки можно скопировать только подмножество этих сообщений. Это возможно благодаря использованию фильтров подписок. Такие изменения называются **действиями фильтров**. При создании подписки можно указать выражение фильтра, которое работает со свойствами сообщения. Свойства могут быть как свойствами системы (например, **меткой**), так и пользовательскими свойствами приложения (например, **StoreName**). В этом случае выражение фильтра SQL является необязательным. Без выражения фильтра SQL любое действие фильтра, определенное в подписке, будет выполняться для всех сообщений в этой подписке.

Полный рабочий пример см. в статье с [примером TopicSubscriptionWithRuleOperations](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/GettingStarted/Microsoft.Azure.ServiceBus/TopicSubscriptionWithRuleOperationsSample) на GitHub.

Дополнительные сведения о возможных значениях фильтров см. в документации по классам [SqlFilter](/dotnet/api/microsoft.azure.servicebus.sqlfilter) и [SqlRuleAction](/dotnet/api/microsoft.azure.servicebus.sqlruleaction).

## <a name="java-message-service-jms-20-entities-preview"></a>Сущности 2,0 (служба сообщений Java (JMS)) (Предварительная версия)
Следующие сущности доступны через API-интерфейс службы сообщений Java (JMS) 2,0.

  * Временные очереди
  * Временные разделы
  * Общие устойчивые подписки
  * Несовместное использование устойчивых подписок
  * Общие неустойчивые подписки
  * Неустойчивые подписки без общих ресурсов

Узнайте больше о [сущностях JMS 2,0](java-message-service-20-entities.md) и о том, как [их использовать](how-to-use-java-message-service-20.md).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения и примеры использования обмена сообщениями в служебной шине Microsoft Azure см. в следующих дополнительных статьях:

* [Основные сведения об обмене сообщениями через служебную шину](service-bus-messaging-overview.md)
* [Краткое руководство по отправке и получению сообщений Служебной шины Azure с помощью портала Azure и .NET](service-bus-quickstart-portal.md)
* [Руководство. Обновление информации о запасах с помощью портала Azure, разделов и подписок](service-bus-tutorial-topics-subscriptions-portal.md)


