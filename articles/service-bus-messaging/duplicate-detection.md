---
title: Поиск повторяющихся сообщений служебной шины Azure | Документация Майкрософт
description: В этой статье объясняется, как можно обнаружить дубликаты в сообщениях служебной шины Azure. Повторяющееся сообщение можно пропустить и удалить.
services: service-bus-messaging
documentationcenter: ''
author: axisc
manager: timlt
editor: spelluru
ms.service: service-bus-messaging
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/24/2020
ms.author: aschhab
ms.openlocfilehash: c109b9fd310a09e5eb4c6d18cc3536e4d8069c0b
ms.sourcegitcommit: b5d646969d7b665539beb18ed0dc6df87b7ba83d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/26/2020
ms.locfileid: "76760374"
---
# <a name="duplicate-detection"></a>Обнаружение дубликатов

Если в приложении возникает неустранимая ошибка сразу после отправки сообщения, из-за чего перезапущенный экземпляр приложения ошибочно полагает, что доставка предыдущего сообщения не выполнена, то последующая его отправка приводит к тому, что сообщение отображается в системе дважды.

Возможно также, что ошибка на уровне клиента или сети возникнет немного раньше, и отправленное сообщение будет зафиксировано в очереди, но подтверждение не будет успешно возвращено клиенту. В этом сценарии клиенту не известен однозначный результат операции отправки.

Поиск повторяющихся сообщений устраняет эту неизвестность, позволяя отправителю повторно отправить то же самое сообщение, после чего очередь или раздел отклонит его дубликаты.

Включение поиска повторяющихся сообщений помогает отслеживать управляемое приложением значение *MessageId* всех сообщений, отправленных в очередь или раздел в течение указанного интервала времени. Если отправляется какое-либо новое сообщение со значением *MessageId*, которое уже занесено в журнал за текущий период времени, то сообщается, что сообщение принято (операция отправки завершена успешно), а вновь отправленное сообщение мгновенно пропускается и удаляется. Другие части сообщения, кроме значения *MessageId*, не учитываются.

Управления приложением идентификатора очень важно, так как только это позволяет приложению связать *MessageId* с контекстом бизнес-процесса, из которого его можно прогнозируемым образом восстановить в случае сбоя.

Для бизнес-процесса, в котором сообщения отправляются при обработке какого-либо контекста приложения, значение *MessageId* может быть частью идентификатора контекста уровня приложения, например номера заказа на покупку, и темы сообщения, например **12345.2017/payment**.

Значение *MessageId* всегда может быть какого-либо рода идентификатором GUID, но привязка идентификатора к бизнес-процессу приводит к прогнозируемой повторяемости, что требуется для эффективного использования функции поиска повторяющихся сообщений.

> [!NOTE]
> Если обнаружение дубликатов включено и идентификатор сеанса или ключ секции не заданы, в качестве ключа секции используется идентификатор сообщения. Если идентификатор сообщения также не задан, библиотеки .NET и AMQP автоматически создают идентификатор сообщения для сообщения. Дополнительные сведения см. в разделе [Использование ключей секций](service-bus-partitioning.md#use-of-partition-keys).

## <a name="enable-duplicate-detection"></a>Включение поиска повторяющихся сообщений

На портале эта функция включается во время создания сущности с помощью флажка **Включить обнаружение повторений**, который снят по умолчанию. Аналогичный параметр доступен при создании разделов.

![][1]

> [!IMPORTANT]
> Вы не можете включить и отключить обнаружение дубликатов после создания очереди. Вы можете сделать это только во время создания очереди. 

Можно программно установить флаг с помощью свойства [QueueDescription.requiresDuplicateDetection](/dotnet/api/microsoft.servicebus.messaging.queuedescription.requiresduplicatedetection#Microsoft_ServiceBus_Messaging_QueueDescription_RequiresDuplicateDetection), воспользовавшись API полнофункциональной платформы .NET Framework. При использовании API Azure Resource Manager это значение задается с помощью свойства [queueProperties.requiresDuplicateDetection](/azure/templates/microsoft.servicebus/namespaces/queues#property-values).

По умолчанию интервал, в течение которого осуществляется поиск повторяющихся сообщений для очередей и разделов, составляет 30 секунд. Максимальное значение составляет 7 дней. Можно изменить этот параметр в окне свойств очереди или раздела на портале Azure.

![][2]

Можно программно настроить размер интервала поиска повторяющихся сообщений, в течение которого сохраняются идентификаторы сообщений, задав свойство [QueueDescription.DuplicateDetectionHistoryTimeWindow](/dotnet/api/microsoft.servicebus.messaging.queuedescription.duplicatedetectionhistorytimewindow#Microsoft_ServiceBus_Messaging_QueueDescription_DuplicateDetectionHistoryTimeWindow) с помощью API полнофункциональной платформы .NET Framework. При использовании API Azure Resource Manager это значение задается с помощью свойства [queueProperties.duplicateDetectionHistoryTimeWindow](/azure/templates/microsoft.servicebus/namespaces/queues#property-values).

Обратите внимание на то, что включение поиска повторяющихся сообщений и размер интервала непосредственно повлияют на пропускную способность очереди (и раздела), так как все записанные идентификаторы сообщений должны сопоставляться с идентификатором каждого нового отправленного сообщения.

Чем меньше этот интервал, тем меньше идентификаторов сообщений нужно хранить и сопоставлять, и тем меньше используется пропускной способности. Для сущностей с высоким потреблением пропускной способности, для которых требуется поиск повторяющихся сообщений, следует задавать как можно меньшее значение этого интервала.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об обмене сообщениями через служебную шину см. в следующих статьях:

* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)

В сценариях, где код клиента не может повторно отправить сообщение с тем же идентификатором *MessageId* , что и раньше, важно разработать сообщения, которые можно безопасно повторно обработать. В этой записи [блога о Идемпотентность](https://particular.net/blog/what-does-idempotent-mean) описаны различные методы их выполнения.

[1]: ./media/duplicate-detection/create-queue.png
[2]: ./media/duplicate-detection/queue-prop.png
