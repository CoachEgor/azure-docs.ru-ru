---
title: Настройка виртуальных конечных точек сетевого обслуживания для сервиса Azure Bus
description: В этой статье содержится информация о том, как добавить конечную точку службы Microsoft.ServiceBus в виртуальную сеть.
services: service-bus
documentationcenter: ''
author: axisc
editor: spelluru
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.date: 12/20/2019
ms.author: aschhab
ms.openlocfilehash: 9dbf65522d5c85e1054ed3f1f6ca9f86180e7f7d
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79454987"
---
# <a name="configure-virtual-network-service-endpoints-for-azure-service-bus"></a>Настройка виртуальных конечных точек сетевого обслуживания для сервиса Azure Bus

Интеграция сервисных конечных точек Service Bus с [виртуальной сетью (VNet)][vnet-sep] обеспечивает безопасный доступ к возможностям обмена сообщениями с рабочих нагрузок, таких как виртуальные машины, которые привязаны к виртуальным сетям, при этом путь сетевого трафика обеспечивается на обоих концах.

Если настроена привязка по крайней мере к одной конечной точке службы подсети виртуальной сети, пространство имен соответствующей Служебной шины принимает трафик только из авторизованных виртуальных сетей. С точки зрения виртуальной сети привязка пространства имен Служебной шины к конечной точке службы настраивает изолированный сетевой туннель от подсети виртуальной сети к службе обмена сообщениями.

Результатом является частная и изолированная взаимосвязь между рабочими нагрузками, связанными с подсетью, и соответствующим пространством имен Служебной шины, несмотря на то что наблюдаемый сетевой адрес конечной точки службы обмена сообщениями находится в общедоступном диапазоне IP-адресов.

> [!IMPORTANT]
> Виртуальные сети поддерживаются только в пространствах имен службы "Служебная шина" [ценовой категории "Премиум"](service-bus-premium-messaging.md).
> 
> При использовании конечных точек службы VNet с помощью Service Bus не следует включать эти конечные точки в приложениях, которые смешивают области имен стандартного и премиум-уровня Service Bus. Потому что стандартный уровень не поддерживает VNets. Конечная точка ограничена только пространствами имен уровня Premium.

## <a name="advanced-security-scenarios-enabled-by-vnet-integration"></a>Расширенные сценарии обеспечения безопасности, доступные при интеграции с виртуальной сетью 

Решения, требующие жесткой и раздельной защиты, где подсети виртуальной сети обеспечивают сегментирование между разделенными службами, обычно все же нуждаются в путях взаимодействия между службами, находящимися в этих секциях.

Любой прямой IP-маршрут между секциями, включая передачу трафика HTTPS через TCP/IP, несет риск использования уязвимостей на сетевом уровне. Службы обмена сообщениями обеспечивают полностью изолированные пути взаимодействия, где сообщения даже записываются на диск при передаче между сторонами. Рабочие нагрузки в двух разных виртуальных сетях, которые связаны с одним и тем же экземпляром Служебной шины, могут эффективно и надежно связываться с использованием сообщений, в то время как целостность границ изолированной сети сохраняется.
 
Это означает, что ваши конфиденциальные облачные решения, влияющие на безопасность, не только получают доступ к ведущим в отрасли надежным, масштабируемым и асинхронным службам обмена сообщениями Azure, но теперь могут использовать обмен сообщениями, чтобы создавать пути передачи данных между защищенными секциями решений. По своей сути такие пути обеспечивают больше безопасности, чем при любом режиме одноранговой связи, включая HTTPS и другие протоколы сокетов TLS.

## <a name="binding-service-bus-to-virtual-networks"></a>Привязка Служебной шины к виртуальным сетям

*Правила виртуальной сети* — это функция безопасности брандмауэра, которая позволяет контролировать, принимает ли сервер Служебной шины Azure соединения из определенной подсети виртуальной сети.

Привязка пространства имен Служебной шины к виртуальной сети состоит из двух этапов. Сначала необходимо создать **конечную точку службы Виртуальной сети** в подсети Virtual Network и включить ее для **Microsoft.ServiceBus,** как это объясняется в [обзоре конечных точек службы.][vnet-sep] Добавив конечную точку службы, вы привязываете к ней пространство имен Служебной шины с помощью **правила виртуальной сети**.

Правило виртуальной сети — это связь пространства имен Служебной шины с подсетью виртуальной сети. Пока правило существует, всем рабочим нагрузкам, привязанным к подсети, предоставляется доступ к пространству имен Служебной шины. Служебная шина никогда не устанавливает исходящие подключения и не нуждается в доступе, и поэтому это правило не предоставляет ей доступ к вашей подсети.

## <a name="use-azure-portal"></a>Использование портала Azure
В этом разделе показано, как использовать портал Azure для добавления виртуальной точки обслуживания сети. Чтобы ограничить доступ, необходимо интегрировать конечную точку виртуального сетевого сервиса для этого пространства имен Event Hubs.

1. Перейдите к **месту вашего пространства имен Сервисного автобуса** на [портале Azure.](https://portal.azure.com)
2. В левом меню выберите **опцию Networking.** По умолчанию выбирается параметр **«Все сети».** Ваше пространство имен принимает соединения с любого IP-адреса. То есть, такое значение параметра по умолчанию равноценно правилу, которое принимает диапазон IP-адресов 0.0.0.0/0. 

    ![Брандмауэр - Выбран авоты всех сетей](./media/service-endpoints/firewall-all-networks-selected.png)
1. Выберите опцию **«Выбранные сети»** в верхней части страницы.
2. В разделе **Виртуальная сеть** страницы выберите **существующую виртуальную сеть .** 

    ![добавить существующую виртуальную сеть](./media/service-endpoints/add-vnet-menu.png)
3. Выберите виртуальную сеть из списка виртуальных сетей, а затем выберите **подсеть.** Перед добавлением виртуальной сети в список необходимо включить конечную точку службы. Если конечная точка службы не включена, портал подскажет вам включить ее.
   
   ![выбрать подсеть](./media/service-endpoints/select-subnet.png)

4. Следующее успешное сообщение следует увидеть после включения конечной точки службы для подсети для **Microsoft.ServiceBus.** Выберите **Добавить** в нижней части страницы, чтобы добавить сеть. 

    ![выбор подсети и включение конечной точки](./media/service-endpoints/subnet-service-endpoint-enabled.png)

    > [!NOTE]
    > Если вы не можете включить конечную точку службы, вы можете проигнорировать отсутствующие виртуальные конечные точки сетевого обслуживания с помощью шаблона Resource Manager. Эта функция недоступна на портале.
6. Выберите **Сохранить** на панели инструментов, чтобы сохранить настройки. Подождите несколько минут, пока подтверждение появится в уведомлениях портала. Кнопка **«Сохранить»** должна быть отключена. 

    ![Сохранить сеть](./media/service-endpoints/save-vnet.png)

## <a name="use-resource-manager-template"></a>Использование шаблона Resource Manager
Следующий шаблон Resource Manager позволяет добавить правило виртуальной сети в пространство имен существующей Служебной шины.

Параметры шаблона:

* **namespaceName**: пространство имен служебной шины;
* **virtualNetworkingSubnetId**: полный путь Resource Manager для подсети виртуальной сети, например `/subscriptions/{id}/resourceGroups/{rg}/providers/Microsoft.Network/virtualNetworks/{vnet}/subnets/default` для подсети виртуальной сети по умолчанию.

> [!NOTE]
> Хотя запрещающие правила отсутствуют, в шаблоне Azure Resource Manager для действия по умолчанию установлено значение **Разрешить**, которое не ограничивает подключения.
> При создании правил виртуальной сети или брандмауэров необходимо изменить значение параметра ***defaultAction***.
> 
> из
> ```json
> "defaultAction": "Allow"
> ```
> значение
> ```json
> "defaultAction": "Deny"
> ```
>

Шаблон:

```json
{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "servicebusNamespaceName": {
        "type": "string",
        "metadata": {
          "description": "Name of the Service Bus namespace"
        }
      },
      "virtualNetworkName": {
        "type": "string",
        "metadata": {
          "description": "Name of the Virtual Network Rule"
        }
      },
      "subnetName": {
        "type": "string",
        "metadata": {
          "description": "Name of the Virtual Network Sub Net"
        }
      },
      "location": {
        "type": "string",
        "metadata": {
          "description": "Location for Namespace"
        }
      }
    },
    "variables": {
      "namespaceNetworkRuleSetName": "[concat(parameters('servicebusNamespaceName'), concat('/', 'default'))]",
      "subNetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', parameters('virtualNetworkName'), parameters('subnetName'))]"
    },
    "resources": [
      {
        "apiVersion": "2018-01-01-preview",
        "name": "[parameters('servicebusNamespaceName')]",
        "type": "Microsoft.ServiceBus/namespaces",
        "location": "[parameters('location')]",
        "sku": {
          "name": "Premium",
          "tier": "Premium"
        },
        "properties": { }
      },
      {
        "apiVersion": "2017-09-01",
        "name": "[parameters('virtualNetworkName')]",
        "location": "[parameters('location')]",
        "type": "Microsoft.Network/virtualNetworks",
        "properties": {
          "addressSpace": {
            "addressPrefixes": [
              "10.0.0.0/23"
            ]
          },
          "subnets": [
            {
              "name": "[parameters('subnetName')]",
              "properties": {
                "addressPrefix": "10.0.0.0/23",
                "serviceEndpoints": [
                  {
                    "service": "Microsoft.ServiceBus"
                  }
                ]
              }
            }
          ]
        }
      },
      {
        "apiVersion": "2018-01-01-preview",
        "name": "[variables('namespaceNetworkRuleSetName')]",
        "type": "Microsoft.ServiceBus/namespaces/networkruleset",
        "dependsOn": [
          "[concat('Microsoft.ServiceBus/namespaces/', parameters('servicebusNamespaceName'))]"
        ],
        "properties": {
          "virtualNetworkRules": 
          [
            {
              "subnet": {
                "id": "[variables('subNetId')]"
              },
              "ignoreMissingVnetServiceEndpoint": false
            }
          ],
          "ipRules":[<YOUR EXISTING IP RULES>],
          "trustedServiceAccessEnabled": false,          
          "defaultAction": "Deny"
        }
      }
    ],
    "outputs": { }
  }
```

Инструкции по развертыванию шаблона см. в статье [Развертывание ресурсов с использованием шаблонов Resource Manager и Azure PowerShell][lnk-deploy].

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о виртуальных сетях см. по следующим ссылкам:

- [Конечные точки виртуального сетевого обслуживания Azure][vnet-sep]
- [Use IP filters][ip-filtering] (Использование IP-фильтров)

[vnet-sep]: ../virtual-network/virtual-network-service-endpoints-overview.md
[lnk-deploy]: ../azure-resource-manager/templates/deploy-powershell.md
[ip-filtering]: service-bus-ip-filtering.md
