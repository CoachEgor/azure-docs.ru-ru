---
title: Настройка собственного ключа для шифрования неактивных данных служебной шины Azure
description: В этой статье содержатся сведения о том, как настроить собственный ключ для шифрования оставшейся работы данных служебной шины Azure.
services: service-bus-messaging
ms.service: service-bus
documentationcenter: ''
author: axisc
ms.topic: conceptual
ms.date: 11/15/2019
ms.author: aschhab
ms.openlocfilehash: 356f825524192c3b6cf7df7f0460975f23ea4f7c
ms.sourcegitcommit: c38a1f55bed721aea4355a6d9289897a4ac769d2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/05/2019
ms.locfileid: "74852293"
---
# <a name="configure-customer-managed-keys-for-encrypting-azure-service-bus-data-at-rest-by-using-the-azure-portal-preview"></a>Настройка управляемых клиентом ключей для шифрования неактивных данных служебной шины Azure с помощью портал Azure (Предварительная версия)
Служебная шина Azure Premium обеспечивает шифрование неактивных данных с помощью Azure Шифрование службы хранилища (Azure SSE). Расширенная служебная шина использует хранилище Azure для хранения данных. по умолчанию все данные, хранящиеся в службе хранилища Azure, шифруются с помощью ключей, управляемых корпорацией Майкрософт. 

## <a name="overview"></a>Краткое описание
Служебная шина Azure теперь поддерживает возможность шифрования неактивных данных с помощью ключей, управляемых корпорацией Майкрософт, или ключей, управляемых клиентом (создание собственных ключей-BYOK). Эта функция позволяет создавать, поворачивать, отключать и отменять доступ к управляемым клиентом ключам, которые используются для шифрования неактивных служебных шин Azure.

Включение функции BYOK — это процесс установки в пространстве имен.

> [!NOTE]
> Существует ряд предостережений, которыми управляет ключ клиента для шифрования на стороне службы. 
>   * Эта функция поддерживается уровнем [Premium служебной шины Azure](service-bus-premium-messaging.md) . Его нельзя включить для пространств имен служебной шины уровня "Стандартный".
>   * Шифрование можно включить только для новых или пустых пространств имен. Если пространство имен содержит данные, операция шифрования завершится ошибкой.
>   * Если для пространства имен служебной шины Azure Key Vault настроены [конечные точки службы виртуальной сети (VNet)](service-bus-service-endpoints.md) , BYOK не будет поддерживаться. 

Вы можете использовать Azure Key Vault для управления ключами и аудита использования ключа. Можно либо создать собственные ключи и сохранить их в хранилище ключей, либо использовать Azure Key Vault API для создания ключей. Дополнительные сведения о хранилище ключей Azure см. в статье [Что такое хранилище ключей Azure?](../key-vault/key-vault-overview.md)

В этой статье показано, как настроить хранилище ключей с ключами, управляемыми клиентом, с помощью портал Azure. Сведения о создании хранилища ключей с помощью портал Azure см. в разделе [Краткое руководство. Установка и извлечение секрета из Azure Key Vault с помощью портал Azure](../key-vault/quick-create-portal.md).

> [!IMPORTANT]
> Для использования управляемых клиентом ключей с помощью служебной шины Azure необходимо, чтобы в хранилище ключей было настроено два обязательных свойства. Это: **обратимое удаление** и **не очищается**. Эти свойства включены по умолчанию при создании нового хранилища ключей в портал Azure. Однако если необходимо включить эти свойства в существующем хранилище ключей, необходимо использовать PowerShell или Azure CLI.

## <a name="enable-customer-managed-keys"></a>Включить управляемые клиентом ключи
Чтобы включить управляемые клиентом ключи в портал Azure, выполните следующие действия.

1. Перейдите к пространству имен уровня "Премиум" служебной шины.
2. На странице **Параметры** пространства имен служебной шины выберите **Шифрование (Предварительная версия)** .
3. Выберите **управляемое клиентом шифрование ключа неактивных** , как показано на следующем рисунке.

    ![Включить управляемый ключ клиента](./media/configure-customer-managed-key/enable-customer-managed-key.png)


## <a name="set-up-a-key-vault-with-keys"></a>Настройка хранилища ключей с ключами

После включения ключей, управляемых клиентом, необходимо связать ключ, управляемый клиентом, с пространством имен служебной шины Azure. Служебная шина поддерживает только Azure Key Vault. Если включить **Шифрование с помощью ключа, управляемого клиентом** , в предыдущем разделе, необходимо импортировать ключ в Azure Key Vault. Кроме того, ключи должны иметь **обратимое удаление** и **не следует очищать** ключ. Эти параметры можно настроить с помощью [PowerShell](../key-vault/key-vault-soft-delete-powershell.md) или [CLI](../key-vault/key-vault-soft-delete-cli.md#enabling-purge-protection).

1. Чтобы создать новое хранилище ключей, следуйте инструкциям в [кратком руководстве](../key-vault/key-vault-overview.md)по Azure Key Vault. Дополнительные сведения об импорте существующих ключей см. в разделе [о ключах, секретах и сертификатах](../key-vault/about-keys-secrets-and-certificates.md).
1. Чтобы включить защиту с обратимым удалением и очисткой при создании хранилища, используйте команду [AZ keyvault Create](/cli/azure/keyvault?view=azure-cli-latest#az-keyvault-create) .

    ```azurecli-interactive
    az keyvault create --name contoso-SB-BYOK-keyvault --resource-group ContosoRG --location westus --enable-soft-delete true --enable-purge-protection true
    ```    
1. Чтобы добавить защиту от очистки в существующем хранилище (для которого уже включено обратимое удаление), используйте команду [AZ keyvault Update](/cli/azure/keyvault?view=azure-cli-latest#az-keyvault-update) .

    ```azurecli-interactive
    az keyvault update --name contoso-SB-BYOK-keyvault --resource-group ContosoRG --enable-purge-protection true
    ```
1. Создайте ключи, выполнив следующие действия.
    1. Чтобы создать новый ключ, выберите **Создать или импортировать** из меню **Ключи** в разделе **Параметры**.
        
        ![Кнопка "создать/импортировать"](./media/configure-customer-managed-key/select-generate-import.png)

    1. Задайте **Параметры**, чтобы **Создать** и присвоить имя для ключа.

        ![Создание ключа](./media/configure-customer-managed-key/create-key.png) 

    1. Теперь можно выбрать этот ключ, чтобы связать с пространством имен служебной шины для шифрования из раскрывающегося списка. 

        ![Выбор ключа из хранилища ключей](./media/configure-customer-managed-key/select-key-from-key-vault.png)
        > [!NOTE]
        > Для обеспечения избыточности можно добавить до 3 ключей. В случае, если срок действия одного из ключей истек или недоступен, для шифрования будут использоваться другие ключи.
        
    1. Введите сведения о ключе и нажмите кнопку **выбрать**. Это обеспечивает шифрование неактивных данных в пространстве имен с помощью управляемого клиентом ключа. 


> [!IMPORTANT]
> Если вы хотите использовать управляемый клиентом ключ вместе с географическим аварийным восстановлением, ознакомьтесь с приведенными ниже разделами. 
>
> Чтобы включить шифрование неактивных данных с помощью управляемого клиентом ключа, [Политика доступа](../key-vault/key-vault-secure-your-key-vault.md) настраивается для управляемого удостоверения служебной шины на указанном KeyVault Azure. Это обеспечит контролируемый доступ к KeyVault Azure из пространства имен служебной шины Azure.
>
> Из-за этого:
> 
>   * Если [географическое аварийное восстановление](service-bus-geo-dr.md) уже включено для пространства имен служебной шины и вы хотите включить управляемый клиентом ключ, то 
>     * Разорвать связывание
>     * [Настройте политику доступа](../key-vault/managed-identity.md) для управляемого удостоверения как для основного, так и для дополнительного пространств имен в хранилище ключей.
>     * Настройте шифрование для основного пространства имен.
>     * Повторно свяжите первичные и вторичные пространства имен.
> 
>   * Если вы хотите включить геоаварийное восстановление в пространстве имен служебной шины, где уже настроен управляемый ключ клиента, то-
>     * [Настройте политику доступа](../key-vault/managed-identity.md) для управляемого удостоверения для дополнительного пространства имен в хранилище ключей.
>     * Свяжите первичные и вторичные пространства имен.


## <a name="rotate-your-encryption-keys"></a>Смена ключей шифрования

Вы можете повернуть ключ в хранилище ключей, используя механизм смены хранилища ключей Azure. Дополнительные сведения см. в разделе [Настройка смены ключей и аудита](../key-vault/key-vault-key-rotation-log-monitoring.md). Для автоматизации смены ключей можно также задать даты активации и истечения срока действия. Служба служебной шины обнаружит новые ключевые версии и начнет использовать их автоматически.

## <a name="revoke-access-to-keys"></a>Отозвать доступ к ключам

Отмена доступа к ключам шифрования не приводит к очистке данных из служебной шины. Однако доступ к данным из пространства имен служебной шины невозможен. Вы можете отозвать ключ шифрования с помощью политики доступа или путем удаления ключа. Узнайте больше о политиках доступа и защите хранилища ключей от [безопасного доступа к хранилищу ключей](../key-vault/key-vault-secure-your-key-vault.md).

После отзыва ключа шифрования служба служебной шины в зашифрованном пространстве имен станет неработоспособной. Если доступ к ключу включен или восстановлен удаленный ключ, служба служебной шины выберет ключ, чтобы получить доступ к данным из зашифрованного пространства имен служебной шины.

> [!NOTE]
> Если удалить существующий ключ шифрования из хранилища ключей и заменить его новым ключом в пространстве имен служебной шины, так как ключ удаления все еще действителен (при кэшировании) в течение часа, старые данные (которые были зашифрованы с помощью старого ключа) могут по-прежнему быть доступны Алон g с новыми данными, которые теперь доступны только с помощью нового ключа. Это поведение реализовано в предварительной версии функции. 

## <a name="next-steps"></a>Дальнейшие действия
Ознакомьтесь со следующими статьями:
- [Обзор служебной шины](service-bus-messaging-overview.md)
- [Обзор Key Vault](../key-vault/key-vault-overview.md)


