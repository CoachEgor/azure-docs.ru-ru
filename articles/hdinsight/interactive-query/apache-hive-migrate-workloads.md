---
title: Перенос рабочих нагрузок Azure HDInsight 3.6 Hive в HDInsight 4.0
description: Сведения о переносе рабочих нагрузок на Apache Hive в HDInsight 3.6 4.0 HDInsight.
ms.service: hdinsight
author: msft-tacox
ms.author: tacox
ms.reviewer: jasonh
ms.topic: conceptual
ms.date: 04/24/2019
ms.openlocfilehash: c1809885c930c4d22dff3f30d6e874aacf0b540e
ms.sourcegitcommit: 2e4b99023ecaf2ea3d6d3604da068d04682a8c2d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2019
ms.locfileid: "67672558"
---
# <a name="migrate-azure-hdinsight-36-hive-workloads-to-hdinsight-40"></a>Перенос рабочих нагрузок Azure HDInsight 3.6 Hive в HDInsight 4.0

В этом документе показано, как перенести рабочие нагрузки Apache Hive и LLAP в HDInsight 3.6 на HDInsight 4.0. HDInsight 4.0 предоставляет новые функции например материализованные представления и кэширования результатов запроса Hive и LLAP. При переносе рабочих нагрузок в HDInsight 4.0, можно использовать множество новых функций Hive 3, которые недоступны в HDInsight 3.6.

В этой статье рассматриваются следующие темы:

* Перенос метаданных Hive HDInsight 4.0
* Безопасный перенос ACID и таблиц не ACID
* Сохранение политики безопасности Hive в разных версиях HDInsight
* Выполнение запросов и отладку HDInsight 3.6 с 4.0 по HDInsight

## <a name="migrate-apache-hive-metadata-to-hdinsight-40"></a>Перенос метаданных Apache Hive в HDInsight 4.0

Одно из преимуществ Hive — это возможность экспорта метаданных для внешней базы данных (которые называют хранилища метаданных Hive). **Hive Metastore** отвечает за хранение статистики таблиц, включая место хранения таблицы, имена столбцов и сведений об индексе таблицы. Схема хранилища метаданных базы данных отличается от версии Hive. Выполните следующую команду, чтобы обновить хранилище метаданных Hive HDInsight 3.6, чтобы она стала совместима с HDInsight 4.0.

1. Создайте новую копию вашего внешнего хранилища метаданных. HDInsight 3.6 и HDInsight 4.0 требуют наличия схемы различные хранилища метаданных, а не могут совместно использовать одно хранилище метаданных. См. в разделе [использование внешних хранилищ метаданных в Azure HDInsight](../hdinsight-use-external-metadata-stores.md) Дополнительные сведения о присоединении к кластеру HDInsight внешнего хранилища метаданных. 
2. Действие сценария в кластере HDI 3.6, с «Головных узла» запустите от имени типа узла для выполнения. Вставьте следующий URI в текстовое поле помечены «URI Bash-скрипта»: https://hdiconfigactions.blob.core.windows.net/hivemetastoreschemaupgrade/launch-schema-upgrade.sh. В текстовом поле, помеченных «Аргументы», введите имя сервера, базы данных, имя пользователя и пароль для **копируются** Hive metastore, разделяя их пробелами. Не используйте «. database.windows.net» при указании servername.

> [!Warning]
> Обновления, который преобразует схеме метаданных HDInsight 3.6 схемы HDInsight 4.0, нельзя будет отменить.

## <a name="migrate-hive-tables-to-hdinsight-40"></a>Перенос таблицы Hive в HDInsight 4.0

После завершения предыдущих шагов для миграции хранилища метаданных Hive HDInsight 4.0, таблиц и баз данных, записанных в хранилище метаданных будет отображаться в кластере HDInsight 4.0, выполнив `show tables` или `show databases` из кластера . См. в разделе [выполнения запроса в разных версиях HDInsight](#query-execution-across-hdinsight-versions) сведения о выполнении запроса в кластерах HDInsight 4.0.

Фактические данные из таблиц, однако нет доступа, пока кластер имеет доступ к учетным записям необходимости хранения. Чтобы убедиться, что ваш кластер HDInsight 4.0 может получать доступ те же данные, что и старый кластер HDInsight 3.6, выполните следующие действия:

1. Определите учетную запись хранения Azure, таблицы или базы данных с помощью описания в формате.
2. Если кластер HDInsight 4.0 уже работает, подключите учетную запись хранения Azure в кластер с помощью Ambari. Если вы еще не создали кластер HDInsight 4.0, убедитесь, что учетной записи хранения Azure задан в качестве первичного или вторичного кластера учетной записи хранения. Дополнительные сведения о добавлении учетных записей хранения к кластерам HDInsight, см. в разделе [добавить дополнительные учетные записи хранения HDInsight](../hdinsight-hadoop-add-storage.md).

> [!Note]
> Таблицы обрабатываются по-разному в HDInsight 3.6 и HDInsight 4.0. По этой причине не могут совместно использовать одинаковые таблицы для кластеров разных версий. Если вы хотите использовать HDInsight 3.6 в то же время, как HDInsight 4.0, необходимо иметь отдельные копии данных для каждой версии.

Рабочей нагрузки Hive может включать сочетание ACID, так и таблицы не ACID. Ключевое различие между Hive в HDInsight 3.6 (Hive 2) и Hive в HDInsight 4.0 (Hive 3) — ACID соответствия для таблиц. В HDInsight 3.6 Включение Hive ACID-соответствия требуется дополнительная настройка, но в HDInsight 4.0 таблицы соответствуют ACID-по умолчанию. Единственное действие, необходимое для выполнения основных сжатие к таблице ACID в кластере 3,6 до миграции. В представлении Hive или из Beeline выполните следующий запрос:

```bash
alter table myacidtable compact 'major';
```

Это сжатие не требуется, поскольку таблицы HDInsight 3.6 и HDInsight 4.0 ACID понять ACID «дельты», по-разному. Сжатие обеспечивает нуля, гарантирует согласованность. Раздел 4 [Hive документации по миграции](https://docs.hortonworks.com/HDPDocuments/Ambari-2.7.3.0/bk_ambari-upgrade-major/content/prepare_hive_for_upgrade.html) содержатся рекомендации по массовой сжатие таблиц HDInsight 3.6 ACID.

После завершения действия миграции и сжатие хранилища метаданных, вы можете перенести фактическое хранилище. После завершения миграции хранилища Hive, в хранилище HDInsight 4.0 будет иметь следующие свойства:

* Внешние таблицы в HDInsight 3.6 будет внешних таблиц в HDInsight 4.0
* Нетранзакционный управляемых таблицы в HDInsight 3.6 будет внешних таблиц в HDInsight 4.0
* Транзакций управляемых таблицы в HDInsight 3.6 будет управляемых таблиц в HDInsight 4.0

Может потребоваться настроить свойства хранилища перед выполнением миграции. Например, если предполагается, что некоторые таблицы будут доступны для третьих лиц (включая кластер HDInsight 3.6), что таблица должна быть внешних после завершения миграции. В HDInsight 4.0 все управляемые таблицы являются транзакционными. Таким образом управляемый таблиц в HDInsight 4.0 должны быть доступны только с кластерами HDInsight 4.0.

Когда свойства таблицы заданы правильно, запустите средство переноса хранилища Hive один из головных узлов кластера с помощью оболочки SSH:

1. Подключиться к головному узлу кластера по протоколу SSH. Инструкции см. в разделе [подключение к HDInsight с помощью SSH](../hdinsight-hadoop-linux-use-ssh-unix.md)
1. Откройте оболочка входа от имени пользователя Hive, выполнив `sudo su - hive`
1. Определение версии стека Hortonworks Data Platform, выполнив `ls /usr/hdp`. При этом отобразится строка версии, следует использовать в следующей команде.
1. Выполните следующую команду из оболочки. Замените `${{STACK_VERSION}}` со строкой версии из предыдущего шага:

```bash
/usr/hdp/${{STACK_VERSION}}/hive/bin/hive --config /etc/hive/conf --service  strictmanagedmigration --hiveconf hive.strict.managed.tables=true  -m automatic  automatic  --modifyManagedTables --oldWarehouseRoot /apps/hive/warehouse
```

После завершения работы средства миграции на складе Hive будет готова для HDInsight 4.0. 

> [!Important]
> Управляемые таблиц в HDInsight 4.0 (включая таблиц перенесено из 3.6) не должен осуществляться с другими службами или приложениями, включая кластеры HDInsight 3.6.

## <a name="secure-hive-across-hdinsight-versions"></a>Защитите Hive в HDInsight версий

С момента HDInsight 3.6 HDInsight интегрируется с Azure Active Directory с помощью пакета безопасности предприятия HDInsight (ESP). ESP использует Kerberos и Apache Ranger для управления разрешениями определенным ресурсам в пределах кластера. Политики ranger, развертываемом для Hive в HDInsight 3.6 могут быть перенесены в HDInsight 4.0, выполнив следующие действия:

1. Перейдите к панели Ranger Service Manager в кластере HDInsight 3.6.
2. Перейдите к политике с именем **HIVE** и экспортировать политику в json-файл.
3. Убедитесь, что всем пользователям в json экспортированную политику существуют в новом кластере. Если пользователю упоминается в политики в формате json, но не существует в новом кластере, добавьте пользователя в новый кластер, или удалите ссылку из политики.
4. Перейдите к **Ranger Service Manager** панели в кластере HDInsight 4.0.
5. Перейдите к политике с именем **HIVE** и импортируйте политики ranger в формате json из шага 2.

## <a name="query-execution-across-hdinsight-versions"></a>Выполнение запросов во всех версиях HDInsight

Существует два способа выполнения и отладки запросов Hive и LLAP в кластере HDInsight 3.6. HiveCLI предоставляет интерфейс командной строки и в представлении и Hive представлении Tez содержатся рабочего процесса на основе графического пользовательского интерфейса.

В HDInsight 4.0 HiveCLI был заменен Beeline. Beeline — клиент JDBC, который предоставляет доступ к Hiveserver 2 HiveCLI является клиента thrift для Hiveserver 1 Beeline также может использоваться для подключения к любой другой конечной точки базы данных JDBC-совместимой. Beeline — доступные out-of-box на HDInsight 4.0 без какой-либо установки требуется.

В HDInsight 3.6 клиентское приложение для взаимодействия с сервером Hive является представление Hive Ambari. HDInsight 4.0 заменяет представления Hive с Hortonworks Data Analytics Studio (DAS). DAS не поставляются с HDInsight кластеров out-of-box и не является официально поддерживаемых пакетом. Тем не менее DAS может устанавливаться в кластере следующим образом:

Действие сценария в кластере, с «Головных узла» запустите от имени типа узла для выполнения. Вставьте следующий URI в текстовое поле, помеченные «URI Bash-скрипта»: https://hdiconfigactions.blob.core.windows.net/dasinstaller/LaunchDASInstaller.sh

Studio для аналитики данных, которые могут запускаться с URL-адрес: https://<clustername>.azurehdinsight.net/das/



После установки DAS, если вы не видите запросов, которые вы запустили в средстве просмотра запросов, выполните следующие действия:

1. Значение конфигурации для Hive и Tez, DAS, как описано в разделе [в этом руководстве по устранению неполадок установки DAS](https://docs.hortonworks.com/HDPDocuments/DAS/DAS-1.2.0/troubleshooting/content/das_queries_not_appearing.html).
2. Убедитесь, что следующие конфигурации каталога хранилища Azure есть страничных BLOB-объектов, и они перечислены в разделе `fs.azure.page.blob.dirs`:
    * `hive.hook.proto.base-directory`
    * `tez.history.logging.proto-base-dir`
3. Перезапустите HDFS, Hive, Tez и DAS на обоих головных узлах.

## <a name="next-steps"></a>Следующие шаги

* [Объявление HDInsight 4.0](../hdinsight-version-release.md)
* [Подробный обзор HDInsight 4.0](https://azure.microsoft.com/blog/deep-dive-into-azure-hdinsight-4-0/)
* [3 ACID таблицы Hive](https://docs.hortonworks.com/HDPDocuments/HDP3/HDP-3.1.0/using-hiveql/content/hive_3_internals.html)
