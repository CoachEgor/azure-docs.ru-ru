---
title: Шлюз глубокое погружение и лучшие практики для Apache Hive в Azure HDInsight
description: Узнайте, как ориентироваться в рекомендациях для выполнения запросов Hive через шлюз Azure HDInsight
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.date: 04/01/2020
ms.openlocfilehash: 924b1132efeb3ee4211593da190f5b7251029ae3
ms.sourcegitcommit: 3c318f6c2a46e0d062a725d88cc8eb2d3fa2f96a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2020
ms.locfileid: "80586981"
---
# <a name="gateway-deep-dive-and-best-practices-for-apache-hive-in-azure-hdinsight"></a>Шлюз глубокое погружение и лучшие практики для Apache Hive в Azure HDInsight

Шлюз Azure HDInsight (шлюз) — фронтэнд HTTPS для кластеров HDInsight. Шлюз отвечает за: аутентификацию, разрешение хоста, обнаружение службы и другие полезные функции, необходимые для современной распределенной системы. Функции, предоставляемые шлюзом, приводят к некоторым накладным расходам, для которых в этом документе будут описаны рекомендации для навигации. Также обсуждаются методы устранения неполадок шлюза.

## <a name="the-hdinsight-gateway"></a>Шлюз HDInsight

Шлюз HDInsight является единственной частью кластера HDInsight, который является общедоступным через Интернет. Услуга шлюза может быть доступна без перехода `clustername-int.azurehdinsight.net` через общественный интернет с помощью внутренней конечной точки шлюза. Внутренняя конечная точка шлюза позволяет устанавливать соединения в службу шлюза без выхода из виртуальной сети кластера. Шлюз обрабатывает все запросы, отправляемые в кластер, и перенаправляет такие запросы на правильные компоненты и узлы кластера.

Следующая диаграмма дает приблизительную иллюстрацию того, как шлюз обеспечивает абстракцию перед всеми различными возможностями разрешения хоста в HDInsight.

![Диаграмма разрешения хоста](./media/gateway-best-practices/host-resolution-diagram.png "Диаграмма разрешения хоста")

## <a name="motivation"></a>Причины для использования

Мотивация для размещения шлюза перед кластерами HDInsight заключается в предоставлении интерфейса для обнаружения услуг и проверки подлинности пользователей. Механизмы аутентификации, предоставляемые шлюзом, особенно актуальны для кластеров с поддержкой ESP.

Для обнаружения службы преимущество шлюза заключается в том, что к каждому компоненту в кластере можно получить доступ в качестве другой конечной точки под веб-сайтом Gateway ( в `clustername.azurehdinsight.net/hive2`отличие от множества `host:port` пар.

Для проверки подлинности шлюз позволяет `username:password` пользователям аутентифицировать с помощью пары учетных данных. Для кластеров с поддержкой ESP этот учетный учетный данный будет называться именем пользователя и паролем домена пользователя. Аутентификация кластеров HDInsight через шлюз не требует от клиента приобретения билета kerberos. Поскольку Gateway `username:password` принимает учетные данные и приобретает пользовательский билет Kerberos от имени пользователя, безопасные соединения могут быть сделаны к шлюзу от любого клиента-хоста, включая клиентов, присоединившихся к различным доменам AA-DDS, чем кластер ESP.

## <a name="best-practices"></a>Рекомендации

Шлюз — это единая служба (загрузка, сбалансированная между двумя узлами), ответственная за пересылку запросов и аутентификацию. Шлюз может стать узким местом пропускной связи для запросов Hive, превышающих определенный размер. Ухудшение производительности запросов может наблюдаться, когда очень большие запросы **SELECT** выполняются на шлюзе через ODBC или JDBC. "Очень большой" означает запросы, которые составляют более 5 ГБ данных между строками или столбцов. Этот запрос может включать длинный список строк и количество широких столбцов.

Ухудшение производительности Шлюза вокруг запросов большого размера происходит потому, что данные должны передаваться из базового хранилища данных (ADLS Gen2) в: HDInsight Hive Server, шлюз, и, наконец, через драйверы JDBC или ODBC к клиенту-хозяину.

Следующая диаграмма иллюстрирует шаги, связанные с запросом SELECT.

![Диаграмма результата](./media/gateway-best-practices/result-retrieval-diagram.png "Диаграмма результата")

Apache Hive — реляционная абстракция поверх файлов, совместимой с HDFS. Эта абстракция означает, что операторы **SELECT** в Hive соответствуют операциям **READ** в файловой системе. Операции **READ** переведены в соответствующую схему, прежде чем сообщать пользователю. Задержка этого процесса увеличивается с размером данных и общим объемом хмеля, необходимымдля для достижения конечного пользователя.

Подобное поведение может произойти при выполнения create **или** **INSERT-инструкций** больших данных, так как эти команды будут соответствовать операциям **WRITE** в базовой файловой системе. Рассмотрим написание данных, таких как необработанные ORC, в файловую систему/datalake вместо того, чтобы загружать их с помощью **INSERT** или **LOAD.**

В кластерах с поддержкой пакетов Enterprise Security достаточно сложные политики Apache Ranger могут привести к замедлению времени компиляции запросов, что может привести к тайм-ауту шлюза. Если тайм-аут шлюза замечен в кластере ESP, подумайте о сокращении или объединении числа политик рейнджеров.

## <a name="troubleshooting-techniques"></a>Методы устранения неполадок

Существует несколько площадок для смягчения и понимания проблем производительности, встречающихся в рамках вышеуказанного поведения. Используйте следующий контрольный список при снижении производительности запроса через шлюз HDInsight:

* Используйте оговорку **LIMIT** при выполнения больших запросов **SELECT.** Положение **LIMIT** уменьшит общие строки, доведенные до сведения узла клиента. Положение **LIMIT** влияет только на генерацию результатов и не изменяет план запроса. Чтобы применить положение **LIMIT** к плану запроса, используйте конфигурацию. `hive.limit.optimize.enable` **LIMIT** можно комбинировать с компенсацией с помощью аргумента форме **LIMIT x,y**.

* Назовите столбцы, представляющие интерес при запуске запросов **SELECT,** вместо того, чтобы использовать **SELECT. \* ** Выбор меньшего количества столбцов снизит объем считывания данных.

* Попробуйте запустить запрос интереса через Apache Beeline. Если поиск результата через Apache Beeline занимает длительный период времени, ожидайте задержки при получении тех же результатов с помощью внешних инструментов.

* Проверьте базовый запрос Hive, чтобы убедиться, что подключение к шлюзу HDInsight может быть установлено. Попробуйте запустить базовый запрос из двух или более внешних инструментов, чтобы убедиться, что ни один отдельный инструмент не работает в проблемах.

* Просмотрите все оповещения Apache Ambari, чтобы убедиться, что службы HDInsight являются полезными. Ambari Alerts может быть интегрированс с Azure Monitor для отчетности и анализа.

* Если вы используете внешний Магазин Hive Metastore, убедитесь, что Azure S'L DB DTU для Hive Metastore не достиг своего предела. Если DTU приближается к своему пределу, необходимо увеличить размер базы данных.

* Убедитесь, что любые сторонние инструменты, такие как PBI или Tableau, используют pagination для просмотра таблиц или баз данных. Проконсультируйтесь с партнерами по поддержке этих инструментов для оказания помощи в pagination. Основным инструментом, используемым для pagination является параметр JDBC. `fetchSize` Небольшой размер извлечения может привести к деградации производительности шлюза, но слишком большой размер извлечения может привести к тайм-ауту шлюза. Настройка размера должна осуществляться на основе рабочей нагрузки.

* Если конвейер данных включает в себя чтение большого объема данных из базового хранилища кластера HDInsight, рассмотрите возможность использования инструмента, который непосредственно взаимодействует с хранилищем Azure, например, Azure Data Factory

* Рассмотрите возможность использования Apache Hive LLAP при запуске интерактивных рабочих нагрузок, так как LLAP может обеспечить более плавный опыт для быстрого возвращения результатов запроса

* Рассмотрите возможность увеличения количества потоков, доступных для `hive.server2.thrift.max.worker.threads`службы Hive Metastore. Эта настройка особенно актуальна, когда большое число одновременных пользователей отправляют запросы в кластер

* Уменьшите количество повторов, используемых для достижения шлюза с любыми внешними инструментами. Если используются несколько повторов, рассмотрите следующие экспоненциальные назад от политики повтора

* Рассмотрим включение сжатия Hive с `hive.exec.compress.output` `hive.exec.compress.intermediate`помощью конфигураций и .

## <a name="next-steps"></a>Следующие шаги

* [Apache Билайн на HDInsight](https://docs.microsoft.com/azure/hdinsight/hadoop/apache-hadoop-use-hive-beeline)
* [HDInsight Шлюз Таймаут Устранение неполадок Шаги](https://docs.microsoft.com/azure/hdinsight/interactive-query/troubleshoot-gateway-timeout)
* [Виртуальные сети для HDInsight](https://docs.microsoft.com/azure/hdinsight/hdinsight-plan-virtual-network-deployment)
* [HDInsight с экспресс-маршрутом](https://docs.microsoft.com/azure/hdinsight/connect-on-premises-network)