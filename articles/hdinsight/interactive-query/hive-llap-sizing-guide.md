---
title: Руководство по настройке размера кластера HDInsight Interactive Query (LLAP)
description: Руководство по настройке размера LLAP
ms.service: hdinsight
ms.topic: troubleshooting
author: aniket-ms
ms.author: aadnaik
ms.reviewer: HDI HiveLLAP Team
ms.date: 05/05/2020
ms.openlocfilehash: a9b86f09ade0d437436779ef3e4a17fcdede2cf0
ms.sourcegitcommit: fdec8e8bdbddcce5b7a0c4ffc6842154220c8b90
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2020
ms.locfileid: "83663692"
---
# <a name="azure-hdinsight-interactive-query-cluster-hive-llap-sizing-guide"></a>Руководство по настройке размера кластера Azure HDInsight Interactive Query (Hive LLAP)

В этом документе описывается настройка размера кластера Interactive Query HDInsight (Hive LLAP) для типичной рабочей нагрузки с целью достижения разумной производительности. Обратите внимание, что в этом документе приведены общие рекомендации и для конкретных рабочих нагрузок может потребоваться  специфичная тонкая настройка.

### <a name="azure-default-vm-types-for-hdinsight-interactive-query-clusterllap"></a>**Типы виртуальных машин Azure по умолчанию для кластера HDInsight Interactive Query (LLAP)**

| Тип узла      | Экземпляр | Размер     |
| :---        |    :----:   | :---     |
| Head      | D13 v2       | 8 виртуальных ЦП, 56 ГБ ОЗУ, диск SSD 400 ГБ   |
| Рабочий узел   | **D14 v2**        | **16 виртуальных ЦП, 112 ГБ ОЗУ, диск SSD 800 ГБ**       |
| ZooKeeper   | A4 v2        | 4 виртуальных ЦП, 8 ГБ ОЗУ, диск SSD 40 ГБ       |

***Примечание. Все рекомендуемые значения конфигурации приведены из расчета на рабочий узел типа D14 v2.***  

### <a name="configuration"></a>**Конфигурация:**    
| Ключ конфигурации      | Рекомендуемое значение  | Описание |
| :---        |    :----:   | :---     |
| yarn.nodemanager.resource.memory-mb | 102400 (MБ) | Общий объем памяти в МБ, выделенный для всех контейнеров YARN на узле. | 
| yarn.scheduler.maximum-allocation-mb | 102400 (MБ) | Максимальное выделение памяти в МБ для каждого запроса контейнера в Resource Manager. Запросы на память выше этого значения не будут выполнены. |
| yarn.scheduler.maximum-allocation-vcores | 12 |Максимальное количество ядер ЦП для каждого запроса контейнера в Resource Manager. Запросы на получение больших значений не будут выполнены. |
| yarn.nodemanager.resource.cpu-vcores | 12 | Количество ядер ЦП на каждый диспетчер узлов, которые могут быть выделены для контейнеров. |
| yarn.scheduler.capacity.root.llap.capacity | 80 (%) | Распределение емкости YARN в очереди LLAP.  |
| tez.am.resource.memory.mb | 4096 (МБ) | Объем памяти в МБ, используемый Tez AppMaster. |
| hive.server2.tez.sessions.per.default.queue | <number_of_worker_nodes> |Число сеансов для каждой очереди, заданной в hive.server2.tez.default.queues. Это число соответствует числу координаторов запросов (мастер-приложений Tez). |
| hive.tez.container.size | 4096 (МБ) | Заданный размер контейнера Tez в МБ. |
| hive.llap.daemon.num.executors | 12 | Число исполнителей на одну управляющую программу LLAP. | 
| hive.llap.io.threadpool.size | 12 | Размер пула потоков для исполнителей. |
| hive.llap.daemon.yarn.container.mb | 77824 (МБ) | Общий объем памяти в МБ, используемый отдельными управляющими программами LLAP (памяти на одну управляющую программу).
| hive.llap.io.memory.size | 235520 (МБ) | Размер кэша в МБ на одну управляющую программу LLAP при условии, что кэш SSD включен. |
| hive.auto.convert.join.noconditionaltask.size | 2048 (МБ) | Объем памяти в МБ для соединения с сопоставлением. |

### <a name="llap-daemon-size-estimations"></a>**Оценка размеров управляющей программы LLAP**  

#### <a name="1-determining-total-yarn-memory-allocation-for-all-containers-on-a-node"></a>**1. Определение общего выделения памяти YARN для всех контейнеров на узле**    
Конфигурация: ***yarn.nodemanager.resource.memory-mb***  

Это значение указывает максимальный общий объем памяти в МБ, которая может использоваться контейнерами YARN на каждом узле. Указанное значение должно быть меньше, чем общий объем физической памяти на этом узле.   
Общий объем памяти для всех контейнеров YARN на узле = [ Общий объем физической памяти ] – [ память для ОС + другие службы ]  
Присвойте этому параметру значение около 90 % от всей доступной оперативной памяти.  
Для D14 v2 рекомендуется значение  **102400 МБ**. 

#### <a name="2-determining-maximum-amount-of-memory-per-yarn-container-request"></a>**2. Определение максимального объема памяти для запроса контейнера YARN**  
Конфигурация: ***yarn.scheduler.maximum-allocation-mb***

Это значение указывает максимальное выделение памяти в МБ для каждого запроса контейнера в Resource Manager. Запросы на память выше указанного значения не будут выполнены. Resource Manager может предоставлять память контейнерам с шагом приращения *yarn.scheduler.minimum-allocation-mb* и не может превышать размер, заданный ключом *yarn.scheduler.maximum-allocation-mb*. Указанное значение не должно превышать общую память для всех контейнеров на узле, заданную ключом *yarn.nodemanager.resource.memory-mb*.    
Для рабочих узлов D14 v2 рекомендуется значение **102400 МБ**

#### <a name="3-determining-maximum-amount-of-vcores-per-yarn-container-request"></a>**3. Определение максимального количества виртуальных ядер для запроса контейнера YARN**  
Конфигурация: ***yarn.scheduler.maximum-allocation-vcores***  

Это значение конфигурации указывает максимальное количество ядер виртуального ЦП для каждого запроса контейнера в Resource Manager. Запрос большего количества виртуальных ядер, чем требуется, не выполняется. Это является глобальным свойством планировщика YARN. Для контейнера управляющей программы LLAP это значение можно задать равным 75 % от общего числа доступных виртуальных ядер. Оставшиеся 25 % должны быть зарезервированы для диспетчера узлов, диспетчера данных и других служб, работающих на рабочих узлах.  
Всего на виртуальных машинах D14 v2 существует 16 виртуальных ядер, и 75 % из этих 16 можно использовать для контейнера управляющей программы LLAP.  
Для D14 v2 рекомендуется значение **12**.  

#### <a name="4-number-of-concurrent-queries"></a>**4. Число параллельных запросов**  
Конфигурация: ***hive.server2.tez.sessions.per.default.queue***

Это значение конфигурации определяет количество сеансов Tez, которые должны быть запущены параллельно. Такие сеансы Tez будут запущены для каждой очереди, заданной параметром "hive.server2.tez.default.queues". Данное значение соответствует числу мастер-приложений Tez (координаторов запросов). Рекомендуется, чтобы это значение совпадало с количеством рабочих узлов. Число мастер-приложений Tez может быть больше, чем число узлов управляющей программы LLAP. Основная задача мастер-приложений Tez заключается в координации выполнения запроса и назначении фрагментов плана запроса соответствующим управляющим программам LLAP для выполнения. Для достижения более высокой пропускной способности этот параметр должен быть кратен числу узлов управляющей программы LLAP.  

Кластер HDInsight по умолчанию имеет четыре управляющие программы LLAP, выполняющиеся на четырех рабочих узлах, поэтому рекомендуемое значение равно **4**.  

#### <a name="5-tez-container-and-tez-application-master-size"></a>**5. Размер контейнера Tez и мастер-приложения Tez**    
Конфигурация: ***tez.am.resource.memory.mb, hive.tez.container.size***  

*tez.am.resource.memory.mb* определяет размер мастер-приложения Tez.  
Рекомендуется использовать значение **4096 МБ**.
   
*hive.tez.container.size* определяет объем памяти, выделяемый контейнеру Tez. Это значение должно быть задано в диапазоне от минимального (*yarn.scheduler.minimum-allocation-mb*) до максимального (*yarn.scheduler.maximum-allocation-mb*) размера контейнера YARN. Исполнители управляющей программы LLAP используют это значение для ограничения использования памяти каждым исполнителем.  
Рекомендуется использовать значение **4096 МБ**.  

#### <a name="6-llap-queue-capacity-allocation"></a>**6. Выделение емкости для очереди LLAP**   
Конфигурация: ***yarn.scheduler.capacity.root.llap.capacity***  

Это значение указывает процент емкости, выделенной для очереди LLAP. Выделенная емкость может отличаться для разных рабочих нагрузок в зависимости от настройки очередей YARN. Если рабочая нагрузка — это только операции чтения, задайте для нее значение 90 % емкости. Однако если рабочая нагрузка объединяет в себе операции обновления, удаления или слияния с помощью управляемых таблиц, рекомендуется предоставить для очереди LLAP 80 % емкости. Оставшиеся 20 % емкости могут использоваться другими задачами, такими как сжатие и т. п., для выделения контейнеров из очереди по умолчанию. Таким образом ресурсы YARN не будут расходоваться на задачи в очереди по умолчанию.    
В рабочем узле D14 v2 для очереди LLAP рекомендуется значение **80**.   
(Для рабочих нагрузок только чтения, его при необходимости можно увеличить до 90.)  

#### <a name="7-llap-daemon-container-size"></a>**7. Размер контейнера управляющей программы LLAP**    
Конфигурация: ***hive.llap.daemon.yarn.container.mb***  
   
Управляющая программа LLAP запускается как контейнер YARN на каждом рабочем узле. Общий объем памяти для контейнера управляющей программы LLAP зависит от следующих факторов:    
*  конфигурации для размера контейнера YARN (yarn.scheduler.minimum-allocation-mb, yarn.scheduler.maximum-allocation-mb, yarn.nodemanager.resource.memory-mb);
*  числа мастер-приложений Tez на узле;
*  общего объема памяти, настроенного для всех контейнеров на узле, и емкости очереди LLAP.  

Память, необходимая для мастер-приложений Tez (Tez AM), может быть рассчитана следующим образом.  
Для интерактивного кластера HDInsight по умолчанию существует одно мастер-приложение Tez для каждого рабочего узла, которое выступает в роли координатора запросов. Количество мастер-приложений Tez можно настроить, исходя из числа запросов, которые должны обслуживаться параллельно.
Для каждого мастер-приложения Tez рекомендуется выделить 4 ГБ памяти.

Память для мастер-приложения Tez на узел = [ округление до большего (Количество Tez AM / Количество узлов управляющей программы LLAP) ] x [ Размер контейнера Tez AM ].  
Для D14 v2 конфигурация по умолчанию имеет четыре мастер-приложения Tez и четыре узла управляющей программы LLAP.  
Память мастер-приложения на узел = (округление до большего (4/4) x 4 ГБ) = 4 ГБ

Общий объем доступной памяти для очереди LLAP на каждый рабочий узел можно вычислить следующим образом. Это значение зависит от общего объема памяти, доступного для всех контейнеров YARN на узле (*yarn.nodemanager.resource.memory-mb*), и процента емкости, настроенной для очереди LLAP (*yarn.scheduler.capacity.root.llap.capacity*).  
Общий объем памяти для очереди LLAP на рабочем узле = Общий объем доступной памяти для всех контейнеров YARN на узле x Процент емкости для очереди LLAP.  
Для D14 v2 это значение составляет 100 ГБ x 0,80 = 80 ГБ.

Размер контейнера управляющей программы LLAP вычисляется следующим образом.

**Размер контейнера управляющей программы LLAP = [ Общий объем доступной памяти для очереди LLAP ] – [ Объем памяти для мастер-приложения Tez на узел ]**  
    
Для рабочего узла D14 v2 с HDI 4.0 рекомендуется значение (80 ГБ – 4 ГБ) = **76 ГБ** .  
(Для HDI 3.6 рекомендуется значение **74 ГБ**, так как необходимо дополнительно зарезервировать примерно 2 ГБ для мастер-приложения Slider.)  

#### <a name="8-determining-number-of-executors-per-llap-daemon"></a>**8. Определение числа исполнителей на одну управляющую программу LLAP**  
Конфигурация: ***hive.llap.daemon.num.executors***, ***hive.llap.io.threadpool.size***

***hive.llap.daemon.num.executors***   
Этот ключ конфигурации позволяет управлять количеством исполнителей, которые могут выполнять задачи параллельно, для каждой управляющей программы LLAP. Это значение зависит от числа виртуальных ядер, объема памяти, выделенного для каждого исполнителя, и общего объема памяти, доступного для управляющей программы LLAP. Как правило, это значение должно быть максимально близко к количеству ядер.
На виртуальных машинах D14 v2 имеется 16 виртуальных ядер. Однако использовать можно не все виртуальные ядра, так как часть из них необходима для других служб, таких как диспетчер узлов, диспетчер данных, монитор метрики и т. п. 

Если необходимо изменить количество исполнителей, рекомендуется использовать 4 ГБ памяти на каждый из них в соответствии со значением *hive.tez.container.size*. При этом общий объем памяти, необходимый для всех исполнителей, не должен превышать общий объем памяти, доступной для контейнера управляющей программы LLAP.  
Это значение можно настроить до 75 % от общего числа виртуальных ядер, доступных на этом узле.  
Для D14 v2 рекомендуется значение (0,75 x 16) = **12**

***hive.llap.io.threadpool.size***   
Это значение задает размер пула потоков для исполнителей. Так как количество исполнителей зафиксировано в соответствии с заданным параметром, значение будет совпадать с количеством исполнителей на управляющую программу LLAP.   
Для D14 v2 рекомендуется значение **12**.

#### <a name="9-determining-llap-daemon-cache-size"></a>**9. Определение размера кэша управляющей программы LLAP**  
Конфигурация: ***hive.llap.io.memory.size***

Память контейнера управляющей программы LLAP состоит из следующих компонентов:
*  запас;
*  память кучи, используемая исполнителями (Xmx);
*  кэш в памяти на каждую управляющую программу (емкость вне кучи; неприменимо, если включен кэш SSD);
*  пространство для метаданных кэша в памяти (применяется, только если включен кэш SSD).

**Размер запаса**. Это значение определяет часть памяти вне кучи, используемой для служебных данных на виртуальной машине Java (метапространства, стека потоков, структуры данных gc и т. д.). Как правило, на эти служебные данные приходится около 6 % от размера кучи (Xmx). Для большей уверенности это значение можно принять равным 6 % от общего объема памяти управляющей программы LLAP.  
Для D14 v2 рекомендуемым значением является ceil(76 ГБ x 0,06) ~= **5 ГБ**.  

**Размер кучи (Xmx)** . Это объем памяти кучи, доступной для всех исполнителей.
Общий объем памяти кучи = Количество исполнителей x 4 ГБ  
Для D14 v2 это значение составляет 12 x 4 ГБ = **48 ГБ**.  

Если кэш SSD отключен, для кэша в памяти будет выделен объем памяти, оставшийся после вычитания размеров запаса и кучи из размера контейнера управляющей программы LLAP.

При включенном кэше SSD размер кэша вычисляется иначе.
Кэширование SSD включено, если значение *hive.llap.io.allocator.mmap* равно true.
Если кэш SSD включен, часть памяти будет использоваться для хранения его метаданных. Метаданные хранятся в памяти, а их объем должен составлять около 10 % от размера кэша SSD.   
Размер метаданных кэша SSD в памяти = [ Размер контейнера управляющей программы LLAP ] – [ Запас + Размер кучи ]  
Для D14 v2 с HDI 4.0 размер метаданных кэша SSD в памяти = [ 76 ГБ ] – [ 5 ГБ + 48 ГБ ] = **23 ГБ**  
Для D14 v2 с HDI 3.6 размер метаданных кэша SSD в памяти = [ 76 ГБ ] – [ 5 ГБ + 48 ГБ + 2 ГБ для Slider ] = **21 ГБ**

Исходя из размера доступной памяти для хранения метаданных кэша SSD, можно вычислить поддерживаемый размер кэша SSD.  
Размер метаданных в памяти для кэша SSD равен 10 % от размера кэша SSD       
Размер кэша SSD = Размер метаданных в памяти для кэша SSD x 10  

Для D14 v2 с HDI 4.0 рекомендуемый размер кэша SSD = 23 ГБ x 10 = **230 ГБ**.  
Для D14 v2 и HDI 3.6 рекомендуемый размер кэша SSD = 21 ГБ x 10 = **210 ГБ**.

#### <a name="10-adjusting-map-join-memory"></a>**10. Настройка памяти для соединения с сопоставлением**   
Конфигурация: ***hive.auto.convert.join.noconditionaltask.size***

Чтобы этот параметр имел силу, необходимо активировать параметр *hive.auto.convert.join.noconditionaltask*.
Этот параметр позволяет пользователю указать размер таблиц, которые могут уместиться в памяти, для соединения с сопоставлением. Если сумма размеров n – 1 таблиц или разделов для n-уровневого соединения меньше заданного значения, будет выбрано соединение с сопоставлением. Для вычисления порогового значения для автопреобразования в соединение с сопоставлением следует использовать размер памяти исполнителя LLAP.
Предполагается, что размер кучи каждого исполнителя равен 4 ГБ, но не весь этот объем будет доступен для соединения с сопоставлением. Часть памяти кучи будет использоваться другими операциями для буферов сортировки и смешивания, хэш-таблиц и т. п. Таким образом, для соединения с сопоставлением можно выделить 50 % памяти кучи размером 4 ГБ.  
Примечание. Возможно, это значение потребуется скорректировать под вашу рабочую нагрузку. При слишком низком значении функцию автопреобразования использовать невозможно. Если же значение слишком велико, это может привести к исключениям из-за нехватки памяти или приостановке сборки мусора, что может вызвать снижение производительности.  
Для D14 v2 с 4 ГБ памяти на исполнитель рекомендуется установить для этого параметра значение **2048 МБ**.


#### <a name="next-steps"></a>**Следующие шаги**
Если проблему не удалось устранить путем настройки этих значений, воспользуйтесь следующими ресурсами.

* Получите ответы специалистов Azure на [сайте поддержки сообщества пользователей Azure](https://azure.microsoft.com/support/community/).

* Подключитесь к [@AzureSupport](https://twitter.com/azuresupport) — официальной учетной записи Microsoft Azure. Она помогает оптимизировать работу пользователей благодаря возможности доступа к ресурсам сообщества Azure (ответы на вопросы, поддержка и консультации специалистов).

* Если вам нужна дополнительная помощь, отправьте запрос в службу поддержки на [портале Azure](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade/). Выберите **Поддержка** в строке меню или откройте центр **Справка и поддержка**. Дополнительные сведения см. в статье [Создание запроса на поддержку Azure](https://docs.microsoft.com/azure/azure-portal/supportability/how-to-create-azure-support-request). Доступ к средствам управления подписками и поддержка выставления счетов уже включены в вашу подписку Microsoft Azure, а техническая поддержка предоставляется в рамках одного из [планов Службы поддержки Azure](https://azure.microsoft.com/support/plans/).  

* ##### <a name="other-references"></a>**Прочие ссылки**
  * [Настройка других свойств LLAP](https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.5/performance-tuning/content/hive_setup_llap.html)  
  * [Настройка размера кучи сервера Hive](https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.5/performance-tuning/content/hive_hiveserver_heap_sizing.html)  
  * [Определение размера памяти для соединения с сопоставлением для LLAP](https://community.cloudera.com/t5/Community-Articles/Map-Join-Memory-Sizing-For-LLAP/ta-p/247462)  
  * [Свойства подсистемы выполнения Tez](https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.5/performance-tuning/content/hive_tez_engine_properties.html)  
  * [Подробное описание возможностей Hive LLAP](https://community.cloudera.com/t5/Community-Articles/Hive-LLAP-deep-dive/ta-p/248893)  
