---
title: Зеркальное отображение разделов Apache Kafka в Azure HDInsight
description: Узнайте, как использовать функцию зеркального отображения Apache Kafka, чтобы сохранить реплику Kafka в кластере HDInsight, создав зеркальную копию разделов во вторичном кластере.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.custom: hdinsightactive
ms.topic: conceptual
ms.date: 05/24/2019
ms.openlocfilehash: bdc393d041bd40fd27493ccc8f3c4f39adfa35b2
ms.sourcegitcommit: cf438e4b4e351b64fd0320bf17cc02489e61406a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/08/2019
ms.locfileid: "67657141"
---
# <a name="use-mirrormaker-to-replicate-apache-kafka-topics-with-kafka-on-hdinsight"></a>Репликация разделов Apache Kafka с помощью Kafka в HDInsight и MirrorMaker

Узнайте, как реплицировать разделы во вторичный кластер с помощью функции зеркального отображения Apache Kafka. Зеркальное отображение можно запустить как непрерывный процесс или периодически использовать для переноса данных из одного кластера в другой.

В этом примере зеркальное отображение используется для репликации разделов между двумя кластерами HDInsight. Оба кластера расположены в разных виртуальных сетях в разных центрах обработки данных.

> [!WARNING]  
> Зеркальное отображение нельзя рассматривать как средство обеспечения отказоустойчивости. Смещение для элементов в разделах различаются между кластерами основного и дополнительного, поэтому клиенты не могут использовать два являются взаимозаменяемыми.
>
> Если вас интересует отказоустойчивость, настройте репликацию для разделов в пределах кластера. Дополнительные сведения см. в статье по [началу работы с Apache Kafka в HDInsight](apache-kafka-get-started.md).

## <a name="how-apache-kafka-mirroring-works"></a>Как работает зеркальное отображение Apache Kafka

Зеркальное отображение выполняется с помощью [MirrorMaker](https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27846330) средство (часть Apache Kafka) для записи из разделов в основном кластере и затем создать локальную копию на во вторичном кластере. MirrorMaker использует один (или более) *потребителей* с основным кластером и *производитель* , осуществляющий запись в локальный кластер (Дополнительно).

Наиболее полезные настройки зеркального отображения для аварийного восстановления используется кластеры Kafka в разных регионах Azure. Чтобы добиться этого, виртуальные сети, где находятся кластеры установлена пиринговая связь друг с другом.

В процессе зеркального отображения и каким образом происходит обмен данными между кластерами на следующей схеме:

![Схема процесса зеркального отображения](./media/apache-kafka-mirroring/kafka-mirroring-vnets2.png)

Первичном и вторичном кластерах могут содержать Разное количество узлов и разделов, а смещение в разделах также отличаются. Зеркальное отображение сохраняет значение ключа, который используется для секционирования, поэтому порядок записей сохраняется вместе с этими значениями.

### <a name="mirroring-across-network-boundaries"></a>Зеркальное отображение в пределах сети

Чтобы реализовать зеркальное отображение между кластерами Kafka в разных сетях, следует учитывать следующее.

* **Шлюзы**: Сети должны иметь возможность взаимодействовать на уровне TCP/IP.

* **Адресация сервера**: Вы можете решить, с помощью IP-адреса или полные доменные имена узлов кластера.

    * **IP-адреса**. Если вы настраиваете кластеров Kafka для использования объявления адрес IP-адресов, можно продолжить зеркального отображения установку с помощью IP-адреса узлов брокера и zookeeper.
    
    * **Доменные имена**: Если вы не настраиваете кластеров Kafka для объявления IP-адрес адресов, кластеры необходимо подключиться друг к другу, используя полные доменные имена (FQDN). Для этого сервер доменных имен (DNS) в каждой сети, который настроен для пересылки запросов к другим сетям. При создании виртуальной сети Azure вместо использования автоматического DNS, предоставленного сетью, необходимо указать пользовательские DNS-сервер и IP-адрес для сервера. Когда виртуальная сеть будет готова, создайте виртуальную машину Azure, использующую этот IP-адрес, а затем установите и настройте на ней программное обеспечение DNS.

    > [!WARNING]  
    > Создайте и настройте пользовательский DNS-сервер, прежде чем устанавливать HDInsight в виртуальной сети. HDInsight не нужно дополнительно настраивать для использования DNS-сервера, настроенного для виртуальной сети.

Дополнительные сведения о подключении двух виртуальных сетей Azure см. в статье [Настройка подключения между виртуальными сетями в развертывании Resource Manager с помощью PowerShell](../../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md).

## <a name="mirroring-architecture"></a>Реализовать архитектуру зеркального отображения

Эта архитектура компонентов два кластера в разных группах ресурсов и виртуальных сетей: **основной** и **вторичного**.

### <a name="creation-steps"></a>Действия по созданию

1. Создайте две новых группы ресурсов:

    |Группа ресурсов | Местоположение |
    |---|---|
    | kafka основной rg | Центральный регион США |
    | kafka получатель rg | Центрально-северная часть США |

1. Создайте новую виртуальную сеть **kafka первичной виртуальной сети** в **kafka основной rg**. Оставьте настройки по умолчанию.
1. Создайте новую виртуальную сеть **kafka получатель vnet** в **kafka получатель rg**, также с параметрами по умолчанию.

1. Создайте два новых кластеров Kafka:

    | Имя кластера | Группа ресурсов | Виртуальная сеть | Учетная запись хранения |
    |---|---|---|---|
    | основной кластера kafka | kafka основной rg | kafka первичной виртуальной сети. | kafkaprimarystorage |
    | кластера kafka получатель | kafka получатель rg | kafka получателя виртуальной сети. | kafkasecondarystorage |

1. Создайте пиринги виртуальных сетей. Этот шаг будет создать две пиринговые подключения: один из **kafka первичной виртуальной сети** для **kafka получателя виртуальной сети** и один из **kafka получатель vnet** для  **kafka первичной виртуальной сети**.
    1. Выберите **kafka первичной виртуальной сети** виртуальной сети.
    1. Нажмите кнопку **Пиринги** под **параметры**.
    1. Нажмите кнопку **Добавить**.
    1. На **добавить пиринг** экране, введите сведения, как показано на следующем снимке экрана.

        ![добавить пиринг виртуальной сети](./media/apache-kafka-mirroring/add-vnet-peering.png)

1. Настройка объявления IP-адресов:
    1. Перейдите к панели мониторинга Ambari для основного кластера: `https://PRIMARYCLUSTERNAME.azurehdinsight.net`.
    1. Нажмите кнопку **служб** > **Kafka**. Выберите вкладку **Configs** (Конфигурации).
    1. Добавьте следующие строки конфигурации вниз **шаблон kafka-env** раздел. Нажмите кнопку **Сохранить**.
    
        ```
        # Configure Kafka to advertise IP addresses instead of FQDN
        IP_ADDRESS=$(hostname -i)
        echo advertised.listeners=$IP_ADDRESS
        sed -i.bak -e '/advertised/{/advertised@/!d;}' /usr/hdp/current/kafka-broker/conf/server.properties
        echo "advertised.listeners=PLAINTEXT://$IP_ADDRESS:9092" >> /usr/hdp/current/kafka-broker/conf/server.properties
        ```

    1. Введите Примечание **сохранить конфигурацию** экрана и нажмите кнопку **Сохранить**.
    1. Если появится предупреждение настройки, нажмите кнопку **продолжить в любом случае**.
    1. Нажмите кнопку **ОК** на **сохранить изменения конфигурации**.
    1. Нажмите кнопку **перезапустите** > **перезапустить все затронутые** в **требуется перезапуск** уведомлений. Нажмите кнопку **подтвердить перезагрузку всех**.

        ![Перезапустите узлы kafka](./media/apache-kafka-mirroring/ambari-restart-notification.png)

1. Настройка Kafka для ожидания передачи данных через все сетевые интерфейсы.
    1. Остаться на **Configs** открыть, выбрав вкладку **служб** > **Kafka**. В **брокер Kafka** разделе набора **прослушиватели** свойства `PLAINTEXT://0.0.0.0:9092`.
    1. Нажмите кнопку **Сохранить**.
    1. Нажмите кнопку **перезапустите**, и **подтвердить перезагрузку всех**.

1. Запишите IP-адресов брокеров и адреса Zookeeper для основного кластера.
    1. Нажмите кнопку **узлы** на панели мониторинга Ambari.
    1. Запомните или запишите IP-адреса для брокеров и Zookeepers. У узлов брокера **wn** как две первые буквы имени узла и zookeeper узлы имеют **zk** как две первые буквы имени узла.

        ![Показать IP-адреса](./media/apache-kafka-mirroring/view-node-ip-addresses2.png)

1. Повторите предыдущие три шага для второй кластер **кластера kafka получатель**: Настройка объявления IP-адресов, задать прослушивателей и запомните или запишите брокера и Zookeeper IP-адреса.

## <a name="create-topics"></a>Создание разделов

1. Подключение к **основной** кластеру с помощью SSH:

    ```bash
    ssh sshuser@PRIMARYCLUSTER-ssh.azurehdinsight.net
    ```

    Замените **sshuser** именем пользователя SSH, которое использовалось при создании кластера. Замените **BASENAME** базовым именем, которое использовалось при создании кластера.

    См. дополнительные сведения об [использовании SSH в HDInsight](../hdinsight-hadoop-linux-use-ssh-unix.md).

2. Используйте следующую команду, чтобы создать переменную с узлов Apache Zookeeper для основного кластера. Строки, такие как `ZOOKEEPER_IP_ADDRESS1` необходимо заменить фактические IP-адреса, записанным ранее, такие как `10.23.0.11` и `10.23.0.7`. Если вы используете разрешение полного доменного ИМЕНИ с помощью пользовательского DNS-сервера, выполните [эти действия](apache-kafka-get-started.md#getkafkainfo) для получения имен брокера и zookeeper.:

    ```bash
    # get the zookeeper hosts for the primary cluster
    export PRIMARY_ZKHOSTS='ZOOKEEPER_IP_ADDRESS1:2181, ZOOKEEPER_IP_ADDRESS2:2181, ZOOKEEPER_IP_ADDRESS3:2181'
    ```

3. Создайте раздел с именем `testtopic` с помощью следующей команды:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-topics.sh --create --replication-factor 2 --partitions 8 --topic testtopic --zookeeper $PRIMARY_ZKHOSTS
    ```

3. С помощью этой команды проверьте, создан ли раздел:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-topics.sh --list --zookeeper $PRIMARY_ZKHOSTS
    ```

    Ответ содержит `testtopic`.

4. Чтобы просмотреть сведения об узле Zookeeper для этого используйте следующий ( **основной**) кластера:

    ```bash
    echo $PRIMARY_ZKHOSTS
    ```

    Эта команда возвращает следующую информацию:

    `10.23.0.11:2181,10.23.0.7:2181,10.23.0.9:2181`

    Сохраните эти сведения. Они будут использоваться в следующем разделе.

## <a name="configure-mirroring"></a>Настройка зеркального отображения

1. Подключение к **вторичной** кластера с помощью другого сеанса SSH:

    ```bash
    ssh sshuser@SECONDARYCLUSTER-ssh.azurehdinsight.net
    ```

    Замените **sshuser** именем пользователя SSH, которое использовалось при создании кластера. Замените **SECONDARYCLUSTER** с имя, используемое при создании кластера.

    См. дополнительные сведения об [использовании SSH в HDInsight](../hdinsight-hadoop-linux-use-ssh-unix.md).

2. Объект `consumer.properties` файл используется для настройки обмена данными с **основной** кластера. Чтобы создать файл, используйте следующую команду:

    ```bash
    nano consumer.properties
    ```

    Добавьте в файл `consumer.properties` следующее содержимое:

    ```yaml
    zookeeper.connect=PRIMARY_ZKHOSTS
    group.id=mirrorgroup
    ```

    Замените **PRIMARY_ZKHOSTS** Zookeeper IP-адреса из **основной** кластера.

    Этот файл включает сведения о получателе для использования при чтении из основного кластера Kafka. Дополнительные сведения о конфигурации получателя см. в [этом разделе](https://kafka.apache.org/documentation#consumerconfigs) на сайте kafka.apache.org.

    Чтобы сохранить файл, нажмите клавиши **CTRL+X**, затем — **Y** и **ВВОД**.

3. Прежде чем настраивать производитель, который взаимодействует с вторичного кластера, настроить переменную для IP-адреса broker **вторичной** кластера. Используйте следующие команды для создания этой переменной:

    ```bash
    export SECONDARY_BROKERHOSTS='BROKER_IP_ADDRESS1:9092,BROKER_IP_ADDRESS2:9092,BROKER_IP_ADDRESS2:9092'
    ```

    Команда `echo $SECONDARY_BROKERHOSTS` должен возвращать сведения, аналогичные следующим:

    `10.23.0.14:9092,10.23.0.4:9092,10.23.0.12:9092`

4. Объект `producer.properties` файл используется для обмена данными **вторичной** кластера. Чтобы создать файл, используйте следующую команду:

    ```bash
    nano producer.properties
    ```

    Добавьте в файл `producer.properties` следующее содержимое:

    ```yaml
    bootstrap.servers=SECONDARY_BROKERHOSTS
    compression.type=none
    ```

    Замените **SECONDARY_BROKERHOSTS** с IP-адреса брокера на предыдущем шаге.

    Дополнительные сведения о конфигурации производителя см. в [этом разделе](https://kafka.apache.org/documentation#producerconfigs) на сайте kafka.apache.org.

5. Используйте следующие команды для создания переменной среды с IP-адресов узлов Zookeeper для вторичного кластера:

    ```bash
    # get the zookeeper hosts for the secondary cluster
    export SECONDARY_ZKHOSTS='ZOOKEEPER_IP_ADDRESS1:2181,ZOOKEEPER_IP_ADDRESS2:2181,ZOOKEEPER_IP_ADDRESS3:2181'
    ```

7. В конфигурации по умолчанию для Kafka в HDInsight не предусматривается автоматическое создание разделов. Прежде чем начать процесс зеркального отображения, используйте один из следующих параметров:

    * **Создание разделов на во вторичном кластере**: Этот параметр также позволяет задать число секций и коэффициент репликации.

        Вы можете создать разделы заранее, выполнив следующую команду:

        ```bash
        /usr/hdp/current/kafka-broker/bin/kafka-topics.sh --create --replication-factor 2 --partitions 8 --topic testtopic --zookeeper $SECONDARY_ZKHOSTS
        ```

        Замените `testtopic` именем создаваемого раздела.

    * **Configure the cluster for automatic topic creation** (Настройка кластера для автоматического создания разделов). Этот параметр позволяет средству MirrorMaker автоматически создавать разделы, однако он может создать разделы с различное количество секций и коэффициентом основная статья в репликации.

        Чтобы настроить автоматическое создание разделов во вторичном кластере, выполните следующие действия:

        1. Перейдите к панели мониторинга Ambari для вторичного кластера: `https://SECONDARYCLUSTERNAME.azurehdinsight.net`.
        1. Нажмите кнопку **служб** > **Kafka**. Выберите вкладку **Configs** (Конфигурации).
        5. В поле __Фильтр__ введите значение параметра `auto.create`. Будет отфильтрован список свойств и отобразится параметр `auto.create.topics.enable`.
        6. Измените значение параметра `auto.create.topics.enable` на true и выберите __Сохранить__. Добавьте заметку и выберите __Сохранить__ еще раз.
        7. Выберите службу __Kafka__ и щелкните __Перезапустить__, а затем выберите __Restart all affected__ (Перезапустить все затронутые). Когда появится запрос, выберите __Conform Restart All__ (Подтвердить перезапуск всех).

        ![настроить автоматическое создание раздела](./media/apache-kafka-mirroring/kafka-enable-auto-create-topics.png)

## <a name="start-mirrormaker"></a>Запуск MirrorMaker

1. Из SSH-подключения к **вторичной** кластера, используйте следующую команду, чтобы начать процесс MirrorMaker:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-run-class.sh kafka.tools.MirrorMaker --consumer.config consumer.properties --producer.config producer.properties --whitelist testtopic --num.streams 4
    ```

    В этом примере используются следующие параметры.

    * **--consumer.config**: указывает файл, который содержит свойства получателя. Эти свойства используются для создания получателя, который считывает данные из *основной* кластера Kafka.

    * **--producer.config**: указывает файл, который содержит свойства производителя. Эти свойства используются для создания производителя, который записывает *вторичной* кластера Kafka.

    * **--whitelist**: Список разделов, которые MirrorMaker реплицирует в составе основного кластера на сервер-получатель.

    * **--num.streams**: число создаваемых потоков получателя.

    Потребитель во вторичном узле ожидает получения сообщений.

2. Из SSH-подключения к **основной** кластера, используйте следующую команду, чтобы запустить производитель и отправки сообщений в раздел:

    ```bash
    export PRIMARY_BROKERHOSTS=BROKER_IP_ADDRESS1:9092,BROKER_IP_ADDRESS2:9092,BROKER_IP_ADDRESS2:9092
    /usr/hdp/current/kafka-broker/bin/kafka-console-producer.sh --broker-list $SOURCE_BROKERHOSTS --topic testtopic
    ```

     При переходе в пустую строку с курсором введите несколько текстовых сообщений. Сообщения отправляются в раздел **основной** кластера. По завершении нажмите клавиши **Ctrl+C**, чтобы завершить процесс производителя.

3. Из SSH-подключения к **вторичной** кластера, используйте **Ctrl + C** чтобы завершить процесс MirrorMaker. Завершение этого процесса может занять несколько секунд. Чтобы убедиться, что состояние репликации сообщений на сервер-получатель, используйте следующую команду:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-console-consumer.sh --bootstrap-server $SECONDARY_ZKHOSTS --topic testtopic --from-beginning
    ```

    Теперь включает список разделов `testtopic`, который создается, когда MirrorMaster зеркально отражает раздел из основного кластера на сервер-получатель. Сообщения, полученные из раздела являются так же, как те, которые вы ввели в основном кластере.

## <a name="delete-the-cluster"></a>Удаление кластера

[!INCLUDE [delete-cluster-warning](../../../includes/hdinsight-delete-cluster-warning.md)]

Действия, описанные в этом документе созданы кластеры в группах различных ресурсов Azure. Чтобы удалить все созданные ресурсы, можно удалить двумя ресурсов группы, созданные: **kafka основной rg** и **kafka secondary_rg**. При удалении группы ресурсов удаляются все ресурсы, созданные по инструкциям в этом документе, включая кластеры, виртуальные сети и учетные записи хранения.

## <a name="next-steps"></a>Следующие шаги

Из этого документа вы узнали, как создать реплику кластера [Apache Kafka](https://kafka.apache.org/) с помощью [MirrorMaker](https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27846330). Другие материалы, посвященные работе с Kafka, доступны по следующим ссылкам:

* [Документация по Apache Kafka MirrorMaker](https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27846330) на сайте cwiki.apache.org.
* [Get started with Apache Kafka on HDInsight (preview)](apache-kafka-get-started.md) (Приступая к работе с Apache Kafka в HDInsight (предварительная версия))
* [Использование Apache Spark с Apache Kafka в HDInsight](../hdinsight-apache-spark-with-kafka.md)
* [Краткое руководство. Использование Apache Storm с Apache Kafka в HDInsight](../hdinsight-apache-storm-with-kafka.md)
* [Подключение к Kafka в HDInsight с помощью виртуальной сети Azure](apache-kafka-connect-vpn-gateway.md)
