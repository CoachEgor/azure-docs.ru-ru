---
title: Зеркальное отображение разделов Apache Kafka в Azure HDInsight
description: Узнайте, как использовать функцию зеркального отображения Apache Kafka, чтобы сохранить реплику Kafka в кластере HDInsight, создав зеркальную копию разделов во вторичном кластере.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.custom: hdinsightactive
ms.date: 11/29/2019
ms.openlocfilehash: 45977f52226fac0a3e23455ce9457a721947a8cc
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77425890"
---
# <a name="use-mirrormaker-to-replicate-apache-kafka-topics-with-kafka-on-hdinsight"></a>Репликация разделов Apache Kafka с помощью Kafka в HDInsight и MirrorMaker

Узнайте, как реплицировать разделы во вторичный кластер с помощью функции зеркального отображения Apache Kafka. Зеркальное отображение можно запустить как непрерывный процесс или периодически использовать для переноса данных из одного кластера в другой.

В этом примере зеркальное отображение используется для репликации разделов между двумя кластерами HDInsight. Оба кластера находятся в разных виртуальных сетях в разных центрах обработки данных.

> [!WARNING]  
> Зеркальное отображение нельзя рассматривать как средство обеспечения отказоустойчивости. Смещение элементов в теме отличается между первичным и вторичным кластерами, поэтому клиенты не могут использовать два взаимозаменяемых.
>
> Если вас интересует отказоустойчивость, настройте репликацию для разделов в пределах кластера. Дополнительные сведения см. в статье по [началу работы с Apache Kafka в HDInsight](apache-kafka-get-started.md).

## <a name="how-apache-kafka-mirroring-works"></a>Как работает зеркальное отображение Apache Kafka

Зеркало работает с помощью инструмента [MirrorMaker](https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27846330) (часть Apache Kafka) для потребления записей из тем основного кластера, а затем создания локальной копии на вторичном кластере. MirrorMaker использует одного (или более) *потребителей,* которые читают из первичного кластера, и *производителя,* который записывает в локальный (вторичный) кластер.

Самая полезная настройка отражения для аварийного восстановления использует кластеры Kafka в различных регионах Azure. Для достижения этой цели виртуальные сети, в которых находятся кластеры, спираются вместе.

Следующая диаграмма иллюстрирует процесс зеркального отражения и то, как связь течет между кластерами:

![Схема процесса зеркального отображения](./media/apache-kafka-mirroring/kafka-mirroring-vnets2.png)

Первичные и вторичные кластеры могут отличаться по количеству узлов и разделов, а смещения в темах также различны. Зеркальное отображение сохраняет значение ключа, который используется для секционирования, поэтому порядок записей сохраняется вместе с этими значениями.

### <a name="mirroring-across-network-boundaries"></a>Зеркальное отображение в пределах сети

Чтобы реализовать зеркальное отображение между кластерами Kafka в разных сетях, следует учитывать следующее.

* **Шлюзы**: Сети должны быть в состоянии общаться на уровне TCP/IP.

* **Адресинг сервера:** Вы можете выбрать адрес кластерных узлов, используя их IP-адреса или полностью квалифицированные доменные имена.

    * **IP-адреса**: Если настроить кластеры Kafka для использования рекламы IP-адресов, вы можете приступить к настройке зеркального отражения, используя IP-адреса узлов брокера и узлов зоозащитника.
    
    * **Имена доменов**: Если вы не настраиваете кластеры Kafka для рекламы IP-адресов, кластеры должны быть в состоянии подключаться друг к другу с помощью полностью квалифицированных доменных имен (F-DNs). Для этого требуется сервер Domain Name System (DNS) в каждой сети, настроенный на переадресации запросов в другие сети. При создании виртуальной сети Azure вместо использования автоматического DNS, предоставленного сетью, необходимо указать пользовательские DNS-сервер и IP-адрес для сервера. Когда виртуальная сеть будет готова, создайте виртуальную машину Azure, использующую этот IP-адрес, а затем установите и настройте на ней программное обеспечение DNS.

    > [!WARNING]  
    > Создайте и настройте пользовательский DNS-сервер, прежде чем устанавливать HDInsight в виртуальной сети. HDInsight не нужно дополнительно настраивать для использования DNS-сервера, настроенного для виртуальной сети.

Дополнительные сведения о подключении двух виртуальных сетей Azure см. в статье [Настройка подключения между виртуальными сетями в развертывании Resource Manager с помощью PowerShell](../../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md).

## <a name="mirroring-architecture"></a>Зеркальная архитектура

Эта архитектура имеет два кластера в различных группах ресурсов и виртуальных сетях: **основной** и **вторичный.**

### <a name="creation-steps"></a>Шаги создания

1. Создание двух новых групп ресурсов:

    |Группа ресурсов | Расположение |
    |---|---|
    | кафка-первичная рг | Центральная часть США |
    | кафка-вторичный-rg | Центрально-северная часть США |

1. Создайте новую виртуальную сеть **kafka-primary-vnet** в **kafka-primary-rg.** Оставьте настройки по умолчанию.
1. Создайте новую виртуальную сеть **kafka-secondary-vnet** в **kafka-secondary-rg**, также с настройками по умолчанию.

1. Создайте два новых кластера Кафки:

    | Имя кластера | Группа ресурсов | Виртуальная сеть | Учетная запись хранения |
    |---|---|---|---|
    | кафка-первичный кластер | кафка-первичная рг | кафка-первичный-внет | kafkaprimarystorage |
    | кафка-вторичный кластер | кафка-вторичный-rg | кафка-вторичный-vnet | kafkasecondarystorage |

1. Создание виртуальных сетевых пирингов. Этот шаг создаст два peerings: один из **кафки-первичных-Vnet** **кафки-вторичной-Vnet** и один обратно из **кафки-вторичной-vnet** **кафки-первичного-vnet**.
    1. Выберите виртуальную сеть **kafka-primary vnet.**
    1. Выберите **Пиринги** в **настройках.**
    1. Нажмите кнопку **Добавить**.
    1. На экране **вглядывания Добавить** введите детали, как показано на скриншоте ниже.

        ![HDInsight Кафка добавить vnet пиринг](./media/apache-kafka-mirroring/hdi-add-vnet-peering.png)

### <a name="configure-ip-advertising"></a>Настройка РЕКЛАМы IP

Нанастройка IP-рекламы, позволяющая клиенту подключаться с помощью IP-адресов брокера вместо доменных имен.

1. Перейдите на панель мониторинга Ambari `https://PRIMARYCLUSTERNAME.azurehdinsight.net`для основного кластера: .
1. Выберите **Услуги** > **Кафка**. CliSelectck **вкладка Configs.**
1. Добавьте следующие линии конфигурации в нижний раздел **шаблона kafka-env.** Нажмите кнопку **Сохранить**.

    ```
    # Configure Kafka to advertise IP addresses instead of FQDN
    IP_ADDRESS=$(hostname -i)
    echo advertised.listeners=$IP_ADDRESS
    sed -i.bak -e '/advertised/{/advertised@/!d;}' /usr/hdp/current/kafka-broker/conf/server.properties
    echo "advertised.listeners=PLAINTEXT://$IP_ADDRESS:9092" >> /usr/hdp/current/kafka-broker/conf/server.properties
    ```

1. Введите заметку на экране **Конфигурации Сохранить** и нажмите **Сохранить**.
1. Если вы подсказали с предупреждением конфигурации, нажмите **Proceed Anyway**.
1. Выберите **Ok** на **изменения конфигурации Сохранить**.
1. Выберите **перезагрузку** > **Перезагрузки всех затронутых** в **требуемом** уведомлении перезагрузки. Выберите **Подтвердить Перезагрузить все**.

    ![Apache Ambari перезагрузить все пострадавших](./media/apache-kafka-mirroring/ambari-restart-notification.png)

### <a name="configure-kafka-to-listen-on-all-network-interfaces"></a>Назначай Kafka для прослушивания всех сетевых интерфейсов.
    
1. Оставайтесь на вкладке **Configs** под **услугами** > **Kafka**. В разделе **Кафка Брокер** установить `PLAINTEXT://0.0.0.0:9092`свойства **слушателей** .
1. Нажмите кнопку **Сохранить**.
1. Выберите **перезагрузку**и **подтвердите перезагрузку всех.**

### <a name="record-broker-ip-addresses-and-zookeeper-addresses-for-primary-cluster"></a>Запись IP-адресов брокера и адресов зоохранителей для первичного кластера.

1. Выберите **хосты** на панели мониторинга Ambari.
1. Запишите IP-адреса для брокеров и зоозащитников. Узлы брокера **имеют в** качестве первых двух букв имени хозяина, а узлы зоозащитника имеют **zk** как первые две буквы имени хозяина.

    ![Apache Ambari просматривает IP-адреса узлов](./media/apache-kafka-mirroring/view-node-ip-addresses2.png)

1. Повторите предыдущие три шага для второго кластера **kafka-вторичного кластера**: настроить IP-рекламы, установить слушателей и сделать к сведению брокера и зоозащитника IP-адресов.

## <a name="create-topics"></a>Создание разделов

1. Подключение к **основному** кластеру с помощью SSH:

    ```bash
    ssh sshuser@PRIMARYCLUSTER-ssh.azurehdinsight.net
    ```

    Замените **sshuser** именем пользователя SSH, которое использовалось при создании кластера. Замените **PRIMARYCLUSTER** базовым названием, используемым при создании кластера.

    См. дополнительные сведения об [использовании SSH в HDInsight](../hdinsight-hadoop-linux-use-ssh-unix.md).

1. Используйте следующую команду для создания переменной с хостами зоопарка Apache для основного кластера. Строки, `ZOOKEEPER_IP_ADDRESS1` как должны быть заменены на фактические `10.23.0.11` `10.23.0.7`IP-адреса, записанные ранее, такие как и . Если вы используете разрешение F'DN с пользовательским DNS-сервером, выполните [следующие действия,](apache-kafka-get-started.md#getkafkainfo) чтобы получить имена брокеров и зоозащитников.:

    ```bash
    # get the zookeeper hosts for the primary cluster
    export PRIMARY_ZKHOSTS='ZOOKEEPER_IP_ADDRESS1:2181, ZOOKEEPER_IP_ADDRESS2:2181, ZOOKEEPER_IP_ADDRESS3:2181'
    ```

1. Создайте раздел с именем `testtopic` с помощью следующей команды:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-topics.sh --create --replication-factor 2 --partitions 8 --topic testtopic --zookeeper $PRIMARY_ZKHOSTS
    ```

1. С помощью этой команды проверьте, создан ли раздел:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-topics.sh --list --zookeeper $PRIMARY_ZKHOSTS
    ```

    Ответ содержит `testtopic`.

1. Используйте следующее для просмотра информации о хостене зоозащитника для этого **(основного)** кластера:

    ```bash
    echo $PRIMARY_ZKHOSTS
    ```

    Эта команда возвращает следующую информацию:

    `10.23.0.11:2181,10.23.0.7:2181,10.23.0.9:2181`

    Сохраните эти сведения. Используется в следующем разделе.

## <a name="configure-mirroring"></a>Настройка зеркального отображения

1. Подключение к **вторичному** кластеру с помощью другого сеанса SSH:

    ```bash
    ssh sshuser@SECONDARYCLUSTER-ssh.azurehdinsight.net
    ```

    Замените **sshuser** именем пользователя SSH, которое использовалось при создании кластера. Замените **SECONDARYCLUSTER** на имя, используемое при создании кластера.

    См. дополнительные сведения об [использовании SSH в HDInsight](../hdinsight-hadoop-linux-use-ssh-unix.md).

1. Файл `consumer.properties` используется для настройки связи с **первичным** кластером. Чтобы создать файл, используйте следующую команду:

    ```bash
    nano consumer.properties
    ```

    Добавьте в файл `consumer.properties` следующее содержимое:

    ```yaml
    zookeeper.connect=PRIMARY_ZKHOSTS
    group.id=mirrorgroup
    ```

    Замените **PRIMARY_ZKHOSTS** IP-адресами зоозащитника из **основного** кластера.

    Этот файл описывает информацию о потребителе для использования при чтении из основного кластера Kafka. Дополнительные сведения о конфигурации получателя см. в [этом разделе](https://kafka.apache.org/documentation#consumerconfigs) на сайте kafka.apache.org.

    Чтобы сохранить файл, нажмите клавиши **CTRL+X**, затем — **Y** и **ВВОД**.

1. Перед настройкой производителя, который общается со вторичным кластером, навязайте переменную для IP-адресов брокера **вторичного** кластера. Используйте следующие команды для создания этой переменной:

    ```bash
    export SECONDARY_BROKERHOSTS='BROKER_IP_ADDRESS1:9092,BROKER_IP_ADDRESS2:9092,BROKER_IP_ADDRESS2:9092'
    ```

    Команда `echo $SECONDARY_BROKERHOSTS` должна вернуть информацию, похожую на следующий текст:

    `10.23.0.14:9092,10.23.0.4:9092,10.23.0.12:9092`

1. Файл `producer.properties` используется для передачи **вторичного** кластера. Чтобы создать файл, используйте следующую команду:

    ```bash
    nano producer.properties
    ```

    Добавьте в файл `producer.properties` следующее содержимое:

    ```yaml
    bootstrap.servers=SECONDARY_BROKERHOSTS
    compression.type=none
    ```

    Замените **SECONDARY_BROKERHOSTS** IP-адресами брокера, используемыми на предыдущем этапе.

    Дополнительные сведения о конфигурации производителя см. в [этом разделе](https://kafka.apache.org/documentation#producerconfigs) на сайте kafka.apache.org.

1. Используйте следующие команды для создания переменной среды с IP-адресами узлов зоозащитника для вторичного кластера:

    ```bash
    # get the zookeeper hosts for the secondary cluster
    export SECONDARY_ZKHOSTS='ZOOKEEPER_IP_ADDRESS1:2181,ZOOKEEPER_IP_ADDRESS2:2181,ZOOKEEPER_IP_ADDRESS3:2181'
    ```

1. Конфигурация по умолчанию для Kafka на HDInsight не позволяет автоматически создавать темы. Прежде чем начать процесс зеркального отображения, используйте один из следующих параметров:

    * **Создайте темы на вторичном кластере**: Эта опция также позволяет установить количество разделов и фактор репликации.

        Вы можете создать разделы заранее, выполнив следующую команду:

        ```bash
        /usr/hdp/current/kafka-broker/bin/kafka-topics.sh --create --replication-factor 2 --partitions 8 --topic testtopic --zookeeper $SECONDARY_ZKHOSTS
        ```

        Замените `testtopic` именем создаваемого раздела.

    * **Наверсальная настройка кластера для автоматического создания темы:** Эта опция позволяет MirrorMaker автоматически создавать темы, однако она может создавать их с разным количеством разделов или фактором репликации, чем основная тема.

        Для настройки вторичного кластера для автоматического создания тем выполните следующие действия:

        1. Перейдите на панель мониторинга Ambari `https://SECONDARYCLUSTERNAME.azurehdinsight.net`для вторичного кластера: .
        1. Нажмите **Услуги** > **Кафка**. Выберите вкладку **Configs** (Конфигурации).
        1. В поле __фильтра__ введите значение `auto.create`. Будет отфильтрован список свойств и отобразится параметр `auto.create.topics.enable`.
        1. Измените значение параметра `auto.create.topics.enable` на true и выберите __Сохранить__. Добавить заметку, а затем выберите __Сохранить__ снова.
        1. Выберите службу __Kafka,__ выберите __Перезагрузку,__ а затем выберите __Перезагрузить все затронутые.__ При запросе выберите __Подтвердите перезапуск всех__.

        ![kafka включить авто создавать темы](./media/apache-kafka-mirroring/kafka-enable-auto-create-topics.png)

## <a name="start-mirrormaker"></a>Запуск MirrorMaker

1. От подключения SSH к **вторичному** кластеру используйте следующую команду для запуска процесса MirrorMaker:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-run-class.sh kafka.tools.MirrorMaker --consumer.config consumer.properties --producer.config producer.properties --whitelist testtopic --num.streams 4
    ```

    В этом примере используются следующие параметры.

    |Параметр |Описание |
    |---|---|
    |--consumer.config|указывает файл, который содержит свойства получателя. Эти свойства используются для создания потребителя, который считывает из *основного* кластера Kafka.|
    |--производитель.config|указывает файл, который содержит свойства производителя. Эти свойства используются для создания производителя, который записывает *на вторичный* кластер Kafka.|
    |--белый список|Список тем, которые MirrorMaker реплицирует из основного кластера в вторичный.|
    |--num.streams|число создаваемых потоков получателя.|

    Потребитель на вторичном узлах теперь ждет получения сообщений.

2. От подключения SSH к **основному** кластеру используйте следующую команду, чтобы запустить производителя и отправить сообщения на тему:

    ```bash
    export PRIMARY_BROKERHOSTS=BROKER_IP_ADDRESS1:9092,BROKER_IP_ADDRESS2:9092,BROKER_IP_ADDRESS2:9092
    /usr/hdp/current/kafka-broker/bin/kafka-console-producer.sh --broker-list $SOURCE_BROKERHOSTS --topic testtopic
    ```

     При переходе в пустую строку с курсором введите несколько текстовых сообщений. Сообщения отправляются на тему **в первичном** кластере. По завершении нажмите клавиши **Ctrl+C**, чтобы завершить процесс производителя.

3. От подключения SSH к **вторичному** кластеру используйте **Ctrl и C,** чтобы закончить процесс MirrorMaker. Завершение этого процесса может занять несколько секунд. Чтобы убедиться, что сообщения были воспроизведены на вторичное, используйте следующую команду:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-console-consumer.sh --bootstrap-server $SECONDARY_ZKHOSTS --topic testtopic --from-beginning
    ```

    Список тем теперь `testtopic`включает в себя, который создается, когда MirrorMaster отражает тему от первичного кластера к вторичному. Сообщения, извлеченные из темы, такие же, как и те, которые вы ввели в основной кластер.

## <a name="delete-the-cluster"></a>Удаление кластера

[!INCLUDE [delete-cluster-warning](../../../includes/hdinsight-delete-cluster-warning.md)]

Шаги в этом документе создавали кластеры в различных группах ресурсов Azure. Чтобы удалить все созданные ресурсы, можно удалить две созданные группы ресурсов: **kafka-primary-rg** и **kafka-secondary_rg.** Удаление групп ресурсов удаляет все ресурсы, созданные после этого документа, включая кластеры, виртуальные сети и учетные записи хранения.

## <a name="next-steps"></a>Дальнейшие действия

Из этого документа вы узнали, как создать реплику кластера [Apache Kafka](https://kafka.apache.org/) с помощью [MirrorMaker](https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27846330). Другие материалы, посвященные работе с Kafka, доступны по следующим ссылкам:

* [Документация по Apache Kafka MirrorMaker](https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27846330) на сайте cwiki.apache.org.
* [Кафка Зеркало Maker Лучшие практики](https://community.cloudera.com/t5/Community-Articles/Kafka-Mirror-Maker-Best-Practices/ta-p/249269)
* [Get started with Apache Kafka on HDInsight (preview)](apache-kafka-get-started.md) (Приступая к работе с Apache Kafka в HDInsight (предварительная версия))
* [Используйте Apache Spark с Apache Kafka на HDInsight](../hdinsight-apache-spark-with-kafka.md)
* [Подключение к Apache Kafka с помощью виртуальной сети Azure](apache-kafka-connect-vpn-gateway.md)
