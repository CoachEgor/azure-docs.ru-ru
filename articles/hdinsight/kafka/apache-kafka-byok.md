---
title: Создание собственного ключа для Apache Kafka в Azure HDInsight
description: В этой статье описывается использование собственных ключей из Azure Key Vault для шифрования данных, хранимых в Apache Kafka в Azure HDInsight.
ms.service: hdinsight
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: hrasheed
ms.topic: conceptual
ms.date: 05/06/2019
ms.openlocfilehash: f619a0179849e2ca17a0528d97ef13f0788a4838
ms.sourcegitcommit: fa4852cca8644b14ce935674861363613cf4bfdf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/09/2019
ms.locfileid: "70811546"
---
# <a name="bring-your-own-key-for-apache-kafka-on-azure-hdinsight"></a>Создание собственного ключа для Apache Kafka в Azure HDInsight

Azure HDInsight включает поддержку создания собственных ключей (BYOK) для Apache Kafka. Эта функция позволяет вам владеть ключами, используемыми для шифрования неактивных данных, и управлять ими.

Все управляемые диски в HDInsight защищены с помощью шифрования службы хранилища Azure (SSE). По умолчанию данные на этих дисках зашифрованы с помощью ключей, управляемых корпорацией Майкрософт. При включении BYOK необходимо указать ключ шифрования для HDInsight и управлять им с помощью Azure Key Vault.

Шифрование BYOK — это процедура из одного этапа, выполняемая во время создания кластера без дополнительных затрат. Вам нужно всего лишь зарегистрировать HDInsight в качестве управляемого удостоверения в Azure Key Vault и добавить ключ шифрования при создании кластера.

Все сообщения к кластеру Kafka (включая реплики, обслуживаемые Kafka) шифруются с помощью симметричного ключа шифрования данных (DEK). Ключ DEK защищен с помощью ключа шифрования ключей (KEK) из вашего хранилища ключей. Процессы шифрования и расшифровки полностью обрабатываются Azure HDInsight. 

Для безопасной смены ключей в хранилище ключей можно использовать портал Azure или Azure CLI. При смене ключа кластер Kafka HDInsight начинает использовать новый ключ в течение нескольких минут. Включите функции защиты ключа "обратимого" удаления для защиты от сценариев и случайного удаления. Хранилища ключей без этой функции защиты не поддерживаются.

## <a name="get-started-with-byok"></a>Начало работы с BYOK
Чтобы создать кластер Kafka с поддержкой BYOK, выполните следующие действия.
1. Создание управляемых удостоверений для ресурсов Azure
2. Настройка Azure Key Vault и ключей
3. Создание кластера HDInsight Kafka с включенным BYOK
4. Вращение ключа шифрования

## <a name="create-managed-identities-for-azure-resources"></a>Создание управляемых удостоверений для ресурсов Azure

   Для проверки подлинности в Key Vault создайте управляемое пользователем удостоверение с помощью [портал Azure](../../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal.md), [Azure PowerShell](../../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-powershell.md), [Azure Resource Manager](../../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-arm.md)или [Azure CLI](../../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-cli.md). Дополнительные сведения о работе управляемых удостоверений в Azure HDInsight см. [в статье управляемые удостоверения в Azure hdinsight](../hdinsight-managed-identities.md). Хотя Azure Active Directory требуется для использования управляемых удостоверений и BYOK в Kafka, корпоративный пакет безопасности (ESP) не является обязательным требованием. Не забудьте сохранить идентификатор ресурса управляемого удостоверения для его добавления в политику доступа Key Vault.

   ![Создание назначаемого пользователем управляемого удостоверения на портале Azure](./media/apache-kafka-byok/user-managed-identity-portal.png)

## <a name="setup-the-key-vault-and-keys"></a>Настройка Key Vault и ключей

   HDInsight поддерживает только Azure Key Vault. Если у вас есть собственное хранилище ключей, вы можете импортировать ключи в Azure Key Vault. Помните, что ключи должны иметь обратимое удаление. Функция обратимого удаления доступна через интерфейсы RESTFUL, .NETC#, PowerShell и Azure CLI.

   1. Чтобы создать новое хранилище ключей, выполните краткое руководство по [Azure Key Vault](../../key-vault/key-vault-overview.md). Дополнительные сведения об импорте существующих ключей см. в статье [Сведения о ключах, секретах и сертификатах](../../key-vault/about-keys-secrets-and-certificates.md).

   2. Включите обратимое удаление в хранилище ключей с помощью команды [AZ keyvault Update](/cli/azure/keyvault?view=azure-cli-latest#az-keyvault-update) CLI.
        ```Azure CLI
        az keyvault update --name <Key Vault Name> --enable-soft-delete
        ```

   3. Создание ключей

        1\. Чтобы создать новый ключ, выберите **Создать или импортировать** из меню **Ключи** в разделе **Параметры**.

        ![Создание нового ключа в Azure Key Vault](./media/apache-kafka-byok/kafka-create-new-key.png "Создание нового ключа в Azure Key Vault")

        2\. Задайте **Параметры**, чтобы **Создать** и присвоить имя для ключа.

        ![Создать имя ключа](./media/apache-kafka-byok/kafka-create-a-key.png "Создать имя ключа")

        В. Выберите ключ, созданный из списка ключей.

        ![Список ключей в Azure Key Vault](./media/apache-kafka-byok/kafka-key-vault-key-list.png)

        Г. Используя собственный ключ для шифрования кластера Kafka, необходимо предоставить ключ URI. Скопируйте **идентификатор ключа** и сохраните его, пока не будете готовы к созданию кластера.

        ![Копирование идентификатор ключа](./media/apache-kafka-byok/kafka-get-key-identifier.png)
   
    4. Добавьте управляемое удостоверение в политику доступа хранилища ключей.

        1\. Создайте политику доступа Azure Key Vault.

        ![Создание политики доступа Azure Key Vault.](./media/apache-kafka-byok/add-key-vault-access-policy.png)

        2\. В поле **Выбор субъекта** выберите назначаемое пользователем управляемое удостоверение, которое вы создали.

        ![Задание выбранного субъекта для политики доступа Azure Key Vault](./media/apache-kafka-byok/add-key-vault-access-policy-select-principal.png)

        В. Задайте **разрешения ключей** **Получение**, **Распаковка ключа** и **Упаковка ключа**.

        ![Установка разрешений ключа для Azure Key Vault доступа Policy1](./media/apache-kafka-byok/add-key-vault-access-policy-keys.png "Установка разрешений ключа для Azure Key Vault доступа Policy1")

        Г. Задайте **разрешения секретов** **Получение**, **Задание** и **Удаление**.

        ![Установка разрешений ключа для Azure Key Vault доступа policy2](./media/apache-kafka-byok/add-key-vault-access-policy-secrets.png "Установка разрешений ключа для Azure Key Vault доступа policy2")

        Д. Щелкните **Save**(Сохранить). 

        ![Сохранить политику доступа Azure Key Vault](./media/apache-kafka-byok/add-key-vault-access-policy-save.png)

## <a name="create-hdinsight-cluster"></a>Создание кластера HDInsight

   Теперь можно создать кластер HDInsight. BYOK может применяться только к новым кластерам во время создания кластера. Шифрование невозможно удалить из кластеров BYOK, кроме того, BYOK нельзя добавить в имеющиеся кластеры.

   ![Шифрование дисков Kafka на портале Azure](./media/apache-kafka-byok/apache-kafka-byok-portal.png)

   Во время создания кластера укажите полный URL-адрес ключа, включая версию ключа. Например, `https://contoso-kv.vault.azure.net/keys/kafkaClusterKey/46ab702136bc4b229f8b10e8c2997fa4`. Кроме того, необходимо назначить кластеру управляемое удостоверение и указать URI ключа.

## <a name="rotating-the-encryption-key"></a>Вращение ключа шифрования
   В некоторых случаях может потребоваться изменить ключи шифрования, используемые кластером Kafka после его создания. Это может быть легко с помощью портала. Для этой операции кластер должен иметь доступ как к текущему ключу, так и к новому ключу, в противном случае операция вращения ключа завершится ошибкой.

   Чтобы повернуть ключ, необходимо иметь полный URL-адрес нового ключа (см. шаг 3 [в разделе настройка Key Vault и ключей](#setup-the-key-vault-and-keys)). После этого перейдите в раздел свойств кластера Kafka на портале и нажмите кнопку **изменить ключ** в разделе **URL-адрес ключа шифрования диска**. Введите новый URL-адрес ключа и отправьте его, чтобы повернуть ключ.

   ![Kafka поворачивать ключ шифрования диска](./media/apache-kafka-byok/kafka-change-key.png)

## <a name="faq-for-byok-to-apache-kafka"></a>Часто задаваемые вопросы о BYOK в Apache Kafka

**Как кластер Kafka получает доступ к хранилищу ключей?**

   Свяжите управляемое удостоверение с кластером Kafka HDInsight во время создания кластера. Это управляемое удостоверение можно создать до или во время создания кластера. Вам также потребуется предоставить управляемому удостоверению доступ к хранилищу ключей, где хранится ключ.

**Эта функция доступна для всех кластеров Kafka в HDInsight?**

   Шифрование BYOK поддерживается только для кластеров Kafka 1.1 и более поздних версий.

**Можно ли использовать разные ключи для разных разделов и секций?**

   Нет, все управляемые диски в кластере шифруются с помощью одного ключа.

**Что произойдет, если кластер теряет доступ к хранилищу ключей или ключу?**
Если кластер теряет доступ к ключу, на портале Apache Ambari отображаются предупреждения. В этом состоянии операция **изменения ключа** завершится ошибкой. После восстановления доступа к ключам Ambari предупреждения отправляются, а такие операции, как смена ключа, могут быть успешно выполнены.

   ![Оповещение о Ambari доступа к ключу Kafka](./media/apache-kafka-byok/kafka-byok-ambari-alert.png)

**Как восстановить кластер, если ключи удалены?**

   Так как поддерживаются только ключи с поддержкой обратимого удаления, если ключи восстановлены в хранилище ключей, кластер должен восстановить доступ к ключам. Чтобы восстановить ключ Azure Key Vault, см. раздел [Undo-азкэйваулткэйремовал](/powershell/module/az.keyvault/Undo-AzKeyVaultKeyRemoval) или [AZ-keyvault-Key-Recover](/cli/azure/keyvault/key?view=azure-cli-latest#az-keyvault-key-recover).

**Могут ли приложения-производители и потребители одновременно работать с кластером BYOK и кластером без BYOK?**

   Да. Использование BYOK является прозрачным для приложений-производителей и потребителей. Шифрование выполняется на уровне операционной системы. В существующие приложения-производители и потребители Kafka никакие изменения вносить не требуется.

**Диски операционной системы диски и диски ресурсов тоже шифруются?**

   Нет. Диски ОС и диски ресурсов не шифруются.

**В случае масштабирования кластера будут ли новые брокеры поддерживать BYOK?**

   Да. Кластеру требуется доступ к ключу в хранилище ключей во время масштабирования. Один ключ используется для шифрования всех управляемых дисков в кластере.

**Доступна ли функция BYOK в моем расположении?**

   Функция создания собственных ключей для Kafka доступна во всех общедоступных облаках.

## <a name="next-steps"></a>Следующие шаги

* Дополнительные сведения об Azure Key Vault см. в статье [Что такое Azure Key Vault?](../../key-vault/key-vault-whatis.md)
* Чтобы приступить к работе с Azure Key Vault, см. инструкции по [началу работы с Azure Key Vault](../../key-vault/key-vault-overview.md).
