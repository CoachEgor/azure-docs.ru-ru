---
title: Шифрование ключей с управлением клиентов для Azure HDInsight
description: В этой статье описывается, как использовать собственный ключ шифрования из Azure Key Vault для шифрования данных, хранящихся на управляемых дисках в кластерах Azure HDInsight.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: hrasheed
ms.service: hdinsight
ms.topic: conceptual
ms.date: 02/20/2020
ms.openlocfilehash: fd5308574e84ab6d2e30b9352254683b2d1d6fdd
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78403562"
---
# <a name="customer-managed-key-disk-encryption"></a>Шифрование управляемых клиентом ключей

Azure HDInsight поддерживает шифрование ключей, управляемых клиентами, для данных на управляемых дисках и ресурсных дисках, прикрепленных к виртуальным машинам кластера HDInsight. Эта функция позволяет использовать Azure Key Vault для управления ключами шифрования, которые обеспечивают безопасность данных в состоянии покоя на кластерах HDInsight. 

Все управляемые диски в HDInsight защищены с помощью шифрования службы хранилища Azure (SSE). По умолчанию данные на этих дисках зашифрованы с помощью ключей, управляемых корпорацией Майкрософт. Если вы включите управляемые клиентом ключи для HDInsight, вы предоставляете ключи шифрования для HDInsight для использования и управления этими ключами с помощью Azure Key Vault.

Этот документ не учитывает данные, хранящиеся в учетной записи хранения Azure. Для получения дополнительной информации о [Azure Storage encryption for data at rest](../storage/common/storage-service-encryption.md)шифровании хранилища Azure см. Ваши кластеры могут иметь одну или несколько присоединенных учетных записей Хранилища Azure, где ключи шифрования также могут управляться microsoft или управляться клиентами, но служба шифрования отличается.

## <a name="introduction"></a>Вступление

Шифрование ключей, управляемое клиентом, — это одношаговский процесс, обрабатываемый при создании кластера без каких-либо дополнительных затрат. Вам нужно всего лишь зарегистрировать HDInsight в качестве управляемого удостоверения в Azure Key Vault и добавить ключ шифрования при создании кластера.

Как диск ресурса, так и управляемые диски на каждом узлах кластера шифруются симметричным ключом шифрования данных (DEK). Ключ DEK защищен с помощью ключа шифрования ключей (KEK) из вашего хранилища ключей. Процессы шифрования и расшифровки полностью обрабатываются Azure HDInsight.

Если брандмауэр хранилища ключей включен в хранилище ключей, где хранится ключ шифрования диска, IP-адреса регионального поставщика ресурсов HDInsight для региона, где будет развернут кластер, должны быть добавлены к конфигурации брандмауэра хранилища ключей. Это необходимо, поскольку HDInsight не является надежной службой хранилища ключей Azure.

Для безопасной смены ключей в хранилище ключей можно использовать портал Azure или Azure CLI. При повороте ключа кластер HDInsight начинает использовать новый ключ в течение нескольких минут. Включите функции защиты ключей [Soft Delete](../key-vault/key-vault-ovw-soft-delete.md) для защиты от сценариев вымогателей и случайного удаления. Ключевые хранилища без этой функции защиты не поддерживаются.

|Тип кластера |OS Disk (управляемый диск) |Диск данных (управляемый диск) |Диск данных Temp (локальный SSD) |
|---|---|---|---|
|Кафка, HBase с ускоренной пишет|[Шифрование SSE](https://docs.microsoft.com/azure/virtual-machines/windows/managed-disks-overview#encryption)|Шифрование SSE - Дополнительное шифрование CMK|Дополнительное шифрование CMK|
|Все остальные кластеры (Spark, Interactive, Hadoop, HBase без ускоренного пишет)|Шифрование SSE|Недоступно|Дополнительное шифрование CMK|

## <a name="get-started-with-customer-managed-keys"></a>Начало работы с ключами, управляемыми клиентом

Для создания кластера HDInsight с поддержкой клиента мы пройдем следующие шаги:

1. Создание управляемых идентификаторов для ресурсов Azure
1. Создание хранилища Azure Key Vault
1. Создание ключа
1. Создание политики доступа
1. Создание кластера HDInsight с включенным ключом с управлением клиента
1. Вращение ключа шифрования

## <a name="create-managed-identities-for-azure-resources"></a>Создание управляемых идентификаторов для ресурсов Azure

Создайте назначенную пользователем управляемую идентификацию для проверки подлинности в Key Vault.

Просчитайте [создать назначенную пользователем управляемую идентификацию](../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal.md) для определенных шагов. Более подробную информацию о том, как работают управляемые идентификаторы в Azure HDInsight, можно узнать [в Azure HDInsight.](hdinsight-managed-identities.md) Не забудьте сохранить идентификатор ресурса управляемого удостоверения для его добавления в политику доступа Key Vault.

## <a name="create-azure-key-vault"></a>Создание хранилища Azure Key Vault

Создать хранилище ключей. Для конкретных шагов смотрите [создание хранилища ключей Azure.](../key-vault/quick-create-portal.md)

HDInsight поддерживает только Azure Key Vault. Если у вас есть собственное хранилище ключей, вы можете импортировать ключи в Azure Key Vault. Помните, что хранилище ключей должно иметь **возможность удалить Soft.** Дополнительные сведения об импорте существующих ключей см. в статье [Сведения о ключах, секретах и сертификатах](../key-vault/about-keys-secrets-and-certificates.md).

## <a name="create-key"></a>Создание ключа

1. Из нового хранилища ключей перейдите к **settings** > **Keys** > **и Generate/Import**.

    ![Создание нового ключа в хранилище ключей Azure](./media/disk-encryption/create-new-key.png "Создание нового ключа в хранилище ключей Azure")

1. Укажите имя, а затем выберите **Создать**. Поддержание **ключевого типа** **RSA**по умолчанию.

    ![генерирует ключевое имя](./media/disk-encryption/create-key.png "Создание ключевого имени")

1. Когда вы вернетесь на страницу **Ключей,** выберите созданный ключ.

    ![список ключей хранилища](./media/disk-encryption/key-vault-key-list.png)

1. Выберите версию, чтобы открыть страницу **Key Version.** При использовании собственного ключа для шифрования кластера HDInsight необходимо предоставить ключ URI. Скопируйте **идентификатор ключа** и сохраните его, пока не будете готовы к созданию кластера.

    ![получить идентификатор ключа](./media/disk-encryption/get-key-identifier.png)

## <a name="create-access-policy"></a>Создание политики доступа

1. Из нового хранилища ключей перейдите к**политикам доступа** > к >  **параметрам****и добавите политику доступа.**

    ![Создание политики доступа Azure Key Vault.](./media/disk-encryption/key-vault-access-policy.png)

1. На странице **политики добавления** укажите следующую информацию:

    |Свойство |Описание|
    |---|---|
    |Ключевые разрешения|Выберите **Получить,** **Развернуть ключ**, и **оберните ключ**.|
    |Секретные разрешения|Выберите **Получить,** **Установить,** и **удалить**.|
    |Выберите основной|Выберите созданную ранее управляемую изначаную идентификацию, назначенную пользователем.|

    ![Задание выбранного субъекта для политики доступа Azure Key Vault](./media/disk-encryption/azure-portal-add-access-policy.png)

1. Нажмите кнопку **Добавить**.

1. Нажмите кнопку **Сохранить**.

    ![Сохранение политики доступа к ключу Azure Vault](./media/disk-encryption/add-key-vault-access-policy-save.png)

## <a name="create-cluster-with-customer-managed-key-disk-encryption"></a>Создание кластера с помощью шифрования ключей-диска, управляемого клиентом

Теперь можно создать кластер HDInsight. Ключ, управляемый заказчиком, может быть применен только к новым кластерам при создании кластеров. Шифрование не может быть удалено из ключевых кластеров, управляемых клиентами, а ключ, управляемый клиентом, не может быть добавлен к существующим кластерам.

### <a name="using-the-azure-portal"></a>Использование портала Azure

Во время создания кластера предоставьте полный **идентификатор Key,** включая ключевую версию. Например, `https://contoso-kv.vault.azure.net/keys/myClusterKey/46ab702136bc4b229f8b10e8c2997fa4`. Кроме того, необходимо назначить кластеру управляемое удостоверение и указать URI ключа.

![Создание нового кластера](./media/disk-encryption/create-cluster-portal.png)

### <a name="using-azure-cli"></a>Использование Azure CLI

В следующем примере показано, как использовать Azure CLI для создания нового кластера Apache Spark с включенным шифрованием диска. Для получения дополнительной информации, [см Azure CLI az hdinsight создать](https://docs.microsoft.com/cli/azure/hdinsight?view=azure-cli-latest#az-hdinsight-create).

```azurecli
az hdinsight create -t spark -g MyResourceGroup -n MyCluster \
-p "HttpPassword1234!" --workernode-data-disks-per-node 2 \
--storage-account MyStorageAccount \
--encryption-key-name SparkClusterKey \
--encryption-key-version 00000000000000000000000000000000 \
--encryption-vault-uri https://MyKeyVault.vault.azure.net \
--assign-identity MyMSI
```

## <a name="rotating-the-encryption-key"></a>Вращение ключа шифрования

Могут быть сценарии, в которых можно изменить ключи шифрования, используемые кластером HDInsight после его создания. Это можно легко через портал. Для этой операции кластер должен иметь доступ как к текущему ключу, так и к предполагаемому новому ключу, в противном случае операция поворота ключа выйдет из строя.

### <a name="using-the-azure-portal"></a>Использование портала Azure

Чтобы повернуть ключ, вам нужно хранилище базового ключа URI. После того как вы сделали это, перейдите в раздел свойств кластера HDInsight на портале и нажмите на **ключ изменения** под **URL-адресом ключа шифрования диска.** Введите новый ключ URL и представить для поворота ключа.

![вращать ключ шифрования диска](./media/disk-encryption/change-key.png)

### <a name="using-azure-cli"></a>Использование Azure CLI

Ниже приводится следующий пример, как повернуть ключ шифрования диска для существующего кластера HDInsight. Для получения дополнительной [Azure CLI az hdinsight rotate-disk-encryption-key](https://docs.microsoft.com/cli/azure/hdinsight?view=azure-cli-latest#az-hdinsight-rotate-disk-encryption-key)информации см.

```azurecli
az hdinsight rotate-disk-encryption-key \
--encryption-key-name SparkClusterKey \
--encryption-key-version 00000000000000000000000000000000 \
--encryption-vault-uri https://MyKeyVault.vault.azure.net \
--name MyCluster \
--resource-group MyResourceGroup
```

## <a name="faq-for-customer-managed-key-encryption"></a>Часто задаваемые вопросы для шифрования ключей, управляемых клиентами

**Как кластер HDInsight получает доступ к моему хранилищу ключей?**

HDInsight получает доступ к экземпляру Azure Key Vault, используя управляемый итог, который вы связываете с кластером HDInsight. Это управляемое удостоверение можно создать до или во время создания кластера. Вам также потребуется предоставить управляемому удостоверению доступ к хранилищу ключей, где хранится ключ.

**Доступна ли эта функция для всех кластеров HDInsight?**

Шифрование ключей, управляемое клиентами, доступно для всех типов кластеров, кроме Spark 2.1 и 2.2.

**Могу ли я использовать несколько ключей для шифрования различных дисков или папок?**

Нет, все управляемые диски и ресурсные диски шифруются тем же ключом.

**Что произойдет, если кластер потеряет доступ к хранилищу ключа или ключу?**

Если кластер теряет доступ к ключу, предупреждения будут отображаться на портале Apache Ambari. В этом состоянии операция **«Ключ изменения»** выйдет из строя. Как только доступ к ключу будет восстановлен, предупреждения Ambari исчезнут и операции, такие как вращение ключей, могут быть успешно выполнены.

![ключевой доступ Конбдокса Амбари](./media/disk-encryption/ambari-alert.png)

**Как восстановить кластер, если ключи удалены?**

Поскольку поддерживаются только клавиши с включенными "Soft Delete", если ключи восстановлены в хранилище ключей, кластер должен восстановить доступ к ключам. Чтобы восстановить ключ Убежища Azure, [az-keyvault-key-recover](/cli/azure/keyvault/key?view=azure-cli-latest#az-keyvault-key-recover)см. [Undo-AzKeyVaultKeyRemoval](/powershell/module/az.keyvault/Undo-AzKeyVaultKeyRemoval)

**Какие типы дисков зашифрованы? Зашифрованы ли также диски/ресурсные диски ОС?**

Ресурсные диски и диски данных/управляемых данных шифруются. Диски ОС не шифруются.

**Если кластер масштабируется, будут ли новые узлы поддерживать клавиши, управляемые клиентами, бесшовно?**

Да. Кластеру требуется доступ к ключу в хранилище ключей во время масштабирования. Один и тот же ключ используется для шифрования управляемых дисков и ресурсных дисков в кластере.

**Доступны ли ключи, управляемые клиентом, в моем местоположении?**

Ключи, управляемые клиентами HDInsight, доступны во всех общедоступных облаках и национальных облаках.

## <a name="next-steps"></a>Дальнейшие действия

* Для получения дополнительной информации о Убежище ключей Azure [смотрите, что такое Убежище ключей Azure](../key-vault/key-vault-overview.md).
* [Обзор корпоративной безопасности в Azure HDInsight](./domain-joined/hdinsight-security-overview.md).
