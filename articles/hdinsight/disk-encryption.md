---
title: Шифрование дисков с управляемым клиентом для Azure HDInsight
description: В этой статье описывается, как использовать собственный ключ шифрования из Azure Key Vault для шифрования данных, хранящихся на управляемых дисках в кластерах Azure HDInsight.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: hrasheed
ms.service: hdinsight
ms.topic: conceptual
ms.date: 01/06/2019
ms.openlocfilehash: 2c015db828bcbfa8b26f519b3a4707b5ec69b8f3
ms.sourcegitcommit: 3dc1a23a7570552f0d1cc2ffdfb915ea871e257c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/15/2020
ms.locfileid: "75982498"
---
# <a name="customer-managed-key-disk-encryption"></a>Шифрование диска с управляемым клиентом ключом

Azure HDInsight поддерживает управляемые клиентом ключи, также известные как шифрование создание собственных ключей (BYOK) для данных на управляемых дисках и дисках ресурсов, подключенных к виртуальным машинам кластера HDInsight. Эта функция позволяет использовать Azure Key Vault для управления ключами шифрования, обеспечивающими безопасность неактивных данных в кластерах HDInsight. Кластеры могут иметь одну или несколько подключенных учетных записей хранения Azure, где ключи шифрования также могут управляться корпорацией Майкрософт или управляемыми клиентом, но служба шифрования отличается.

Этот документ не содержит данных, хранящихся в вашей учетной записи хранения Azure. Дополнительные сведения о ASE см. в статье [Шифрование службы хранилища Azure для неактивных данных](../storage/common/storage-service-encryption.md).

Все управляемые диски в HDInsight защищены с помощью шифрования службы хранилища Azure (SSE). По умолчанию данные на этих дисках зашифрованы с помощью ключей, управляемых корпорацией Майкрософт. Если вы включили ключи, управляемые клиентом для HDInsight, вы предоставляете ключи шифрования для HDInsight для использования этих ключей и управления ими с помощью Azure Key Vault.

Шифрование с помощью управляемого клиентом ключа — это одноэтапный процесс, который обрабатывается при создании кластера без дополнительных затрат. Вам нужно всего лишь зарегистрировать HDInsight в качестве управляемого удостоверения в Azure Key Vault и добавить ключ шифрования при создании кластера.

Диск ресурсов и управляемые диски на каждом узле кластера шифруются с помощью симметричного ключа шифрования данных (DEK). Ключ DEK защищен с помощью ключа шифрования ключей (KEK) из вашего хранилища ключей. Процессы шифрования и расшифровки полностью обрабатываются Azure HDInsight.

Для безопасной смены ключей в хранилище ключей можно использовать портал Azure или Azure CLI. При повороте ключа кластер HDInsight начинает использовать новый ключ в течение нескольких минут. Включите функции защиты ключа "обратимого" удаления для защиты от сценариев и случайного удаления. Хранилища ключей без этой функции защиты не поддерживаются.

## <a name="get-started-with-customer-managed-keys"></a>Начало работы с ключами, управляемыми клиентом

Чтобы создать кластер HDInsight с управляемым клиентом ключом, выполните следующие действия.

1. Создание управляемых удостоверений для ресурсов Azure
2. Настройка Azure Key Vault и ключей
3. Создание кластера HDInsight с включенным ключом "Управление клиентами"
4. Вращение ключа шифрования

## <a name="create-managed-identities-for-azure-resources"></a>Создание управляемых удостоверений для ресурсов Azure

Для проверки подлинности в Key Vault создайте управляемое пользователем удостоверение с помощью [портал Azure](../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal.md), [Azure PowerShell](../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-powershell.md), [Azure Resource Manager](../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-arm.md)или [Azure CLI](../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-cli.md). Дополнительные сведения о работе управляемых удостоверений в Azure HDInsight см. [в статье управляемые удостоверения в Azure hdinsight](hdinsight-managed-identities.md). Не забудьте сохранить идентификатор ресурса управляемого удостоверения для его добавления в политику доступа Key Vault.

## <a name="set-up-the-key-vault-and-keys"></a>Настройка Key Vault и ключей

HDInsight поддерживает только Azure Key Vault. Если у вас есть собственное хранилище ключей, вы можете импортировать ключи в Azure Key Vault. Помните, что ключи должны иметь обратимое удаление. Функция обратимого удаления доступна через интерфейсы RESTFUL, .NETC#, PowerShell и Azure CLI.

1. Чтобы создать новое хранилище ключей, выполните краткое руководство по [Azure Key Vault](../key-vault/key-vault-overview.md). Дополнительные сведения об импорте существующих ключей см. в статье [Сведения о ключах, секретах и сертификатах](../key-vault/about-keys-secrets-and-certificates.md).

1. Включите обратимое удаление в хранилище ключей с помощью команды [AZ keyvault Update](/cli/azure/keyvault?view=azure-cli-latest#az-keyvault-update) CLI.

    ```azurecli
    az keyvault update --name <Key Vault Name> --enable-soft-delete
    ```

1. Создайте ключи.

    а. Чтобы создать новый ключ, выберите **Создать или импортировать** из меню **Ключи** в разделе **Параметры**.

    ![Создание нового ключа в Azure Key Vault](./media/disk-encryption/create-new-key.png "Создание нового ключа в хранилище ключей Azure")

    b. Задайте **Параметры**, чтобы **Создать** и присвоить имя для ключа.

    ![создает имя ключа](./media/disk-encryption/create-key.png "Создать имя ключа")

    c. Выберите ключ, созданный из списка ключей.

    ![список ключей хранилища ключей](./media/disk-encryption/key-vault-key-list.png)

    d. При использовании собственного ключа для шифрования кластера HDInsight необходимо указать URI ключа. Скопируйте **идентификатор ключа** и сохраните его, пока не будете готовы к созданию кластера.

    ![получение идентификатора ключа](./media/disk-encryption/get-key-identifier.png)

1. Добавьте управляемое удостоверение в политику доступа хранилища ключей.

    а. Создайте политику доступа Azure Key Vault.

    ![Создание политики доступа Azure Key Vault.](./media/disk-encryption/add-key-vault-access-policy.png)

    b. В поле **Выбор субъекта** выберите назначаемое пользователем управляемое удостоверение, которое вы создали.

    ![Задание выбранного субъекта для политики доступа Azure Key Vault](./media/disk-encryption/add-key-vault-access-policy-select-principal.png)

    c. Задайте **разрешения ключей** **Получение**, **Распаковка ключа** и **Упаковка ключа**.

    ![Установка разрешений ключа для Azure Key Vault доступа Policy1](./media/disk-encryption/add-key-vault-access-policy-keys.png "Установка разрешений ключа для Azure Key Vault доступа Policy1")

    d. Задайте **разрешения секретов** **Получение**, **Задание** и **Удаление**.

    ![Установка разрешений ключа для Azure Key Vault доступа policy2](./media/disk-encryption/add-key-vault-access-policy-secrets.png "Установка разрешений ключа для Azure Key Vault доступа policy2")

    д) Щелкните **Сохранить**.

    ![Сохранить политику доступа Azure Key Vault](./media/disk-encryption/add-key-vault-access-policy-save.png)

## <a name="create-cluster-with-customer-managed-key-disk-encryption"></a>Создание кластера с ключом шифрования диска, управляемым клиентом

Теперь можно создать кластер HDInsight. Ключ, управляемый клиентом, может применяться только к новым кластерам во время создания кластера. Не удается удалить шифрование из управляемых клиентом ключей, и ключ, управляемый клиентом, нельзя добавить в существующие кластеры.

### <a name="using-the-azure-portal"></a>Использование портала Azure

Во время создания кластера укажите полный URL-адрес ключа, включая версию ключа. Например, `https://contoso-kv.vault.azure.net/keys/myClusterKey/46ab702136bc4b229f8b10e8c2997fa4`. Кроме того, необходимо назначить кластеру управляемое удостоверение и указать URI ключа.

### <a name="using-azure-cli"></a>Использование Azure CLI

В следующем примере показано, как использовать Azure CLI для создания нового кластера Apache Spark с включенным шифрованием дисков. Дополнительные сведения см. в документации по [Azure CLI AZ hdinsight Create](https://docs.microsoft.com/cli/azure/hdinsight?view=azure-cli-latest#az-hdinsight-create) .

```azurecli
az hdinsight create -t spark -g MyResourceGroup -n MyCluster \
-p "HttpPassword1234!" --workernode-data-disks-per-node 2 \
--storage-account MyStorageAccount \
--encryption-key-name SparkClusterKey \
--encryption-key-version 00000000000000000000000000000000 \
--encryption-vault-uri https://MyKeyVault.vault.azure.net \
--assign-identity MyMSI
```

## <a name="rotating-the-encryption-key"></a>Вращение ключа шифрования

В некоторых сценариях может потребоваться изменить ключи шифрования, используемые кластером HDInsight после его создания. Это может быть легко с помощью портала. Для этой операции кластер должен иметь доступ как к текущему ключу, так и к новому ключу, в противном случае операция вращения ключа завершится ошибкой.

### <a name="using-the-azure-portal"></a>Использование портала Azure

Чтобы повернуть ключ, необходимо иметь полный URL-адрес нового ключа (см. шаг 3 [в разделе настройка Key Vault и ключей](#set-up-the-key-vault-and-keys)). После этого перейдите в раздел свойств кластера HDInsight на портале и нажмите кнопку **изменить ключ** в разделе **URL-адрес ключа шифрования диска**. Введите новый URL-адрес ключа и отправьте его, чтобы повернуть ключ.

![повернуть ключ шифрования диска](./media/disk-encryption/change-key.png)

### <a name="using-azure-cli"></a>Использование Azure CLI

В следующем примере показано, как поворачивать ключ шифрования диска для существующего кластера HDInsight. Дополнительные сведения см. в разделе [Azure CLI AZ hdinsight ротации диска-шифрования-ключ](https://docs.microsoft.com/cli/azure/hdinsight?view=azure-cli-latest#az-hdinsight-rotate-disk-encryption-key) .

```azurecli
az hdinsight rotate-disk-encryption-key \
--encryption-key-name SparkClusterKey \
--encryption-key-version 00000000000000000000000000000000 \
--encryption-vault-uri https://MyKeyVault.vault.azure.net \
--name MyCluster \
--resource-group MyResourceGroup
```

## <a name="faq-for-customer-managed-key-encryption"></a>Часто задаваемые вопросы о шифровании ключей, управляемых клиентом

**Как кластер HDInsight обращается к моему хранилищу ключей?**

HDInsight обращается к вашему экземпляру Azure Key Vault, используя управляемое удостоверение, которое вы связываете с кластером HDInsight. Это управляемое удостоверение можно создать до или во время создания кластера. Вам также потребуется предоставить управляемому удостоверению доступ к хранилищу ключей, где хранится ключ.

**Эта функция доступна для всех кластеров в HDInsight?**

Шифрование с управляемым клиентом ключом доступно для всех типов кластеров, кроме Spark 2,1 и 2,2.

**Можно ли использовать несколько ключей для шифрования разных дисков или папок?**

Нет, все управляемые диски и диски ресурсов шифруются с помощью одного и того же ключа.

**Что произойдет, если кластер теряет доступ к хранилищу ключей или ключу?**

Если кластер теряет доступ к ключу, на портале Apache Ambari отображаются предупреждения. В этом состоянии операция **изменения ключа** завершится ошибкой. После восстановления доступа к ключам Ambari предупреждения отправляются, а такие операции, как смена ключа, могут быть успешно выполнены.

![оповещение о доступе к Key Ambari](./media/disk-encryption/ambari-alert.png)

**Как восстановить кластер, если ключи удалены?**

Так как поддерживаются только ключи с поддержкой обратимого удаления, если ключи восстановлены в хранилище ключей, кластер должен восстановить доступ к ключам. Чтобы восстановить ключ Azure Key Vault, см. раздел [Undo-азкэйваулткэйремовал](/powershell/module/az.keyvault/Undo-AzKeyVaultKeyRemoval) или [AZ-keyvault-Key-Recover](/cli/azure/keyvault/key?view=azure-cli-latest#az-keyvault-key-recover).

**Какие типы дисков зашифрованы? Зашифрованы ли диски ОС и диски ресурсов?**

Диски ресурсов и данные и управляемые диски шифруются. Диски ОС не шифруются.

**Если кластер масштабируется, будут ли новые узлы поддерживать ключи, управляемые клиентом, без проблем?**

Да. Кластеру требуется доступ к ключу в хранилище ключей во время масштабирования. Один и тот же ключ используется для шифрования управляемых дисков и дисков ресурсов в кластере.

**Являются ли ключи, управляемые клиентом, доступными в моем расположении?**

Ключи, управляемые клиентом HDInsight, доступны во всех общедоступных облаках и национальных облаках.

## <a name="next-steps"></a>Дальнейшие действия

* [Обзор корпоративной безопасности в Azure HDInsight](./domain-joined/hdinsight-security-overview.md)
