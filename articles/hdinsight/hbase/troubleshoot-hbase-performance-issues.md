---
title: Устранение проблем с производительностью Apache HBase в Azure HDInsight
description: Различные рекомендации по настройке производительности Apache HBase и советы по обеспечению оптимальной производительности в Azure HDInsight.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: troubleshooting
ms.date: 09/24/2019
ms.openlocfilehash: c67f21a6ed8a7697977bb7737f0e46348efb2530
ms.sourcegitcommit: 3f22ae300425fb30be47992c7e46f0abc2e68478
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2019
ms.locfileid: "71266657"
---
# <a name="troubleshoot-apache-hbase-performance-issues-on-azure-hdinsight"></a>Устранение проблем с производительностью Apache HBase в Azure HDInsight

В этом документе описаны различные рекомендации по настройке производительности Apache HBase и советы по обеспечению оптимальной производительности в Azure HDInsight. Многие из этих советов зависят от конкретной рабочей нагрузки и шаблона чтения, записи и проверки. Тщательное тестирование изменений конфигурации перед применением в рабочей среде.

## <a name="hdinsight-hbase-performance-insights"></a>Аналитика производительности HDInsight HBase

Основной узким местом в большинстве рабочих нагрузок HBase является журнал упреждающего записи (WAL). Это серьезно влияет на производительность записи. HDInsight HBase имеет разделенную модель вычислений с хранилищем, т. е. данные хранятся удаленно в службе хранилища Azure, но серверы регионов размещаются на виртуальных машинах. До последнего времени журнал упреждающего ввода также записывается в службу хранилища Azure, поэтому повысив эту узкие места в случае HDInsight. Функция [ускоренной записи](./apache-hbase-accelerated-writes.md) предназначена для решения этой проблемы путем записи журнала упреждающего ввода в управляемые диски Azure класса Premium. Это позволяет невероятно производительность, а также помогает решать многие проблемы, с которыми сталкиваются некоторые рабочие нагрузки с интенсивным использованием операций записи.

Используйте [учетную запись хранения блочных BLOB-объектов](https://azure.microsoft.com/blog/azure-premium-block-blob-storage-is-now-generally-available/) уровня "Премиум" в качестве удаленного хранилища, чтобы получить значительное улучшение операций чтения. Этот параметр возможен только в том случае, если включена функция записи впереди журналов.

## <a name="compaction"></a>Сжатия

Сжатие является еще одним потенциальным узким местом в сообществе.  По умолчанию крупное сжатие отключено в кластерах HDInsight HBase. Это обусловлено тем, что это ресурсоемкий процесс, поэтому мы хотим предоставить клиентам полную гибкость, чтобы запланировать его в соответствии с характеристиками рабочей нагрузки, то есть в часы пиковой загрузки. Кроме того, для хранилища используется удаленное хранилище (поддерживается службой хранилища Azure), а не локальная система HDFS, которая обычно используется в большинстве локальных экземпляров. это не является проблемой, которая является одной из основных целей основного сжатия.

Предполагается, что клиент позаботится о планировании основного сжатия в соответствии с их удобством. Если это обслуживание не выполняется, сжатие существенно повлияет на производительность чтения в долгосрочном запуске.

Для операций сканирования в частности, средние задержки значительно выше 100 мс. Проверьте, правильно ли было запланировано значительное сжатие.

## <a name="know-your-apache-phoenix-workload"></a>Сведения о рабочей нагрузке Apache Phoenix

Ответы на следующие вопросы помогут лучше понять вашу рабочую нагрузку Apache Phoenix.

* Будут ли все операции чтения преобразованы для просмотра?
    * Если да, каковы характеристики этих проверок?
    * Оптимизирована ли схема таблицы Phoenix для таких проверок, включая соответствующую индексацию?
* Вы использовали `EXPLAIN` инструкцию, чтобы понять планы запросов, создаваемые при чтении.
* Вы пишете "Upsert-Selects"?
    * Если да, то они также будут выполнять проверки. Ожидаемая задержка для проверок — это порядок 100 мс в среднем, а не 10 мс для точки в HBase.  

## <a name="test-methodology-and-metrics-monitoring"></a>Проверка методологии и мониторинга метрик

Если вы используете тесты производительности, такие как ИКСБ, JMeter или Ферф, для тестирования и настройки производительности, убедитесь в следующем:

1. Клиентские компьютеры не становятся узким местом (проверьте загрузку ЦП на клиентских компьютерах).

1. Конфигурации на стороне клиента, такие как количество потоков и т. д., настраиваются соответствующим образом для обеспечения насыщенности пропускной способности клиента.

1. Результаты тестов записываются точно и систематически.

Если ваши запросы внезапно начали намного хуже, чем раньше, — проверьте наличие потенциальных ошибок в коде приложения — неожиданное создание больших объемов недопустимых данных, что естественным образом увеличит задержку чтения?

## <a name="migration-issues"></a>Проблемы с миграцией

При переходе на Azure HDInsight убедитесь, что миграция выполняется систематически и точно, желательно с помощью автоматизации. Избегайте ручной миграции. Убедитесь в следующем:

1. Атрибуты таблицы, такие как сжатие, фильтры раскрытия и т. д., должны быть правильно перенесены.

1. Для таблиц Phoenix параметры Salt должны быть соответствующим образом сопоставлены с новым размером кластера. Например, число сегментов Salt рекомендуется для нескольких рабочих узлов в кластере. в некоторых случаях их количество зависит от объема наблюдаемых оперативных заработок.  

## <a name="server-side-config-tunings"></a>Настройки конфигурации на стороне сервера

В HDInsight HBase файлах hFile хранятся в удаленном хранилище. Таким образом, при промахах кэша стоимость операций чтения будет определенно выше, чем в локальных системах, которые содержат данные, которые поддерживаются локальными службами HDFS благодаря затронутой задержке сети. В большинстве сценариев Интеллектуальное использование кэшей HBase (кэш блоков и кэш контейнеров) предназначено для обхода этой проблемы. Тем не менее в некоторых случаях это может быть проблемой для клиента. Использование учетной записи блочного BLOB-объекта уровня "Премиум" позволило это немного. Однако, если большой двоичный объект WASB (драйвер хранилища Windows Azure) полагается на `fs.azure.read.request.size` определенные свойства, например для получения данных в блоках на основе того, что он определяет как режим чтения (последовательная и случайная), мы можем по-прежнему видеть экземпляры с большими задержками при чтении. Мы обнаружили эксперименты, которые задают размер блока запроса чтения (`fs.azure.read.request.size`) равным 512 КБ и соответствуют размеру блока таблиц HBase таким же образом, что обеспечивает наилучший результат на практике.

HDInsight HBase для большинства кластеров узлов крупного размера представляет `bucketcache` собой файл на локальном SSD, подключенном к виртуальной машине, где `regionservers`выполняется. В некоторых случаях использование кэша без кучи может дать некоторое улучшение. Это имеет ограничение на использование доступной памяти и потенциально меньшего размера, чем файловый кэш, поэтому это может быть не всегда лучшим выбором.

Некоторые из других параметров, которые мы настроили, были разработаны с учетом особенностей работы с некоторыми обоснованиями.

1. Увеличение `memstore` размера с 128 по умолчанию на 256 МБ — этот параметр обычно рекомендуется для интенсивного сценария записи.

1. Увеличение числа потоков, выделенных для сжатия, по умолчанию — от 1 до 4. Этот параметр важен, если мы наблюдаем частые небольшие сжатия.

1. Старайтесь не `memstore` блокировать очистку из-за ограничения хранилища. `Hbase.hstore.blockingStoreFiles`можно увеличить до 100, чтобы предоставить этот буфер.

1. Для контроля очистки значения по умолчанию можно устранить следующим образом:

    1. `Hbase.regionserver.maxlogs`может быть увеличила до 140 из 32 (избегая очистки из-за ограничений WAL).

    1. `Hbase.regionserver.global.memstore.lowerLimit`= 0,55.

    1. `Hbase.regionserver.global.memstore.upperLimit`= 0,60.

1. Конфигурации для настройки пула потоков, специфичные для Phoenix:

    1. `Phoenix.query.queuesize`можно увеличить до 10000.

    1. `Phoenix.query.threadpoolsize`можно увеличить до 512.

1. Другие конфигурации, относящиеся к Phoenix:

    1. `Phoenix.rpc.index.handler.count`При наличии большого или большого количества уточняющих запросов индекса можно задать значение 50.

    1. `Phoenix.stats.updateFrequency`— может иметь значение от увеличила до 1 часа со времени по умолчанию (15 минут).

    1. `Phoenix.coprocessor.maxmetadatacachetimetolivems`— может быть увеличила до 1 часа с 30 минут.

    1. `Phoenix.coprocessor.maxmetadatacachesize`— может быть увеличила до 50 МБ от 20 МБ.

1. Истечение времени ожидания RPC — время ожидания RPC для HBase, время ожидания для клиентского сканера HBase и время ожидания запроса в Финиксе могут быть увеличены до 3 минут. Важно отметить, что `hbase.client.scanner.caching` для параметра задано значение, совпадающее со стороны сервера и клиентской стороны. В противном случае этот параметр приводит к `OutOfOrderScannerException` ошибкам, связанным с клиентской стороны. Для этого параметра следует задать низкое значение для больших просмотров. Это значение устанавливается равным 100.

## <a name="other-considerations"></a>Дополнительные рекомендации

Некоторые другие параметры, которые следует учитывать при настройке:

1. `Hbase.rs.cacheblocksonwrite`— для этого параметра по умолчанию задано значение true в HDI.

1. Параметры, позволяющие отложить незначительное сжатие для последующего использования.

1. Экспериментальные параметры, такие как изменение процентных долей очередей, зарезервированных для запросов на чтение и запись.

## <a name="next-steps"></a>Следующие шаги

Если вы не видите своего варианта проблемы или вам не удается ее устранить, дополнительные сведения можно получить, посетив один из следующих каналов.

- Получите ответы от экспертов Azure через [службу поддержки сообщества Azure](https://azure.microsoft.com/support/community/).

- Подключение с [@AzureSupport](https://twitter.com/azuresupport) — официальная учетная запись Microsoft Azure для улучшения качества обслуживания клиентов. Подключение сообщества Azure к нужным ресурсам: ответы, поддержка и эксперты.

- Если вам нужна дополнительная помощь, можно отправить запрос в службу поддержки из [портал Azure](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade/). Выберите пункт **Поддержка** в строке меню или откройте центр **справки и поддержки** . Для получения более подробных сведений см. статью [о создании запроса на поддержку Azure](https://docs.microsoft.com/azure/azure-supportability/how-to-create-azure-support-request). Доступ к управлению подписками и поддержкой выставления счетов включен в вашу подписку Microsoft Azure, а техническая поддержка предоставляется через один из [планов поддержки Azure](https://azure.microsoft.com/support/plans/).
