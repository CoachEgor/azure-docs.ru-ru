---
title: Устранение проблем с производительностью Apache HBase в Azure HDInsight
description: Различные рекомендации по настройке производительности Apache HBase и советы по получению оптимальной производительности на Azure HDInsight.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: troubleshooting
ms.date: 09/24/2019
ms.openlocfilehash: 93698fadcecf190dd8bbc24a9d03978899d3c5e9
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75887161"
---
# <a name="troubleshoot-apache-hbase-performance-issues-on-azure-hdinsight"></a>Устранение проблем с производительностью Apache HBase в Azure HDInsight

В этой статье описаны различные рекомендации по настройке производительности Apache HBase и советы по получению оптимальной производительности на Azure HDInsight. Многие из этих советов зависят от конкретной рабочей нагрузки и шаблона чтения/записи/сканирования. Прежде чем применять изменения конфигурации в производственной среде, тщательно проверяйте их.

## <a name="hbase-performance-insights"></a>Производительность HBase

Главным узким местом в большинстве рабочих нагрузок HBase является журнал Write Ahead Log (WAL). Это серьезно влияет на производительность написания. HDInsight HBase имеет отдельную модель хранения данных. Данные хранятся удаленно в Хранилище Azure, даже если виртуальные машины размещаются в регионе серверов. До недавнего времени WAL также писался в Azure Storage. В HDInsight такое поведение усилило это узкое место. Функция [Ускоренная записи](./apache-hbase-accelerated-writes.md) предназначена для решения этой проблемы. Он записывает WAL на диски, управляемые SSD Премиум-класса Azure. Это чрезвычайно помогает писать производительность, и это помогает многим проблемам, с которыми сталкиваются некоторые из записи интенсивных рабочих нагрузок.

Чтобы значительно улучшить работу чтения, используйте [учетную запись хранения Premium Block Blob](https://azure.microsoft.com/blog/azure-premium-block-blob-storage-is-now-generally-available/) в качестве удаленного хранилища. Эта опция возможна только при включении функции WAL.

## <a name="compaction"></a>Уплотнения

Компишн является еще одним потенциальным узким местом, которое принципиально согласовано в обществе. По умолчанию основное уплотнение отключено в кластерах HDInsight HBase. Компишн отключен, потому что, несмотря на то, что это ресурсоемкий процесс, клиенты имеют полную гибкость, чтобы запланировать его в соответствии с их рабочими нагрузками. Например, они могут запланировать его в непиковые часы. Кроме того, локализация данных не является проблемой, поскольку наше хранилище удалено (поддерживается Хранилищем Azure) вместо локальной распределенной файловой системы Hadoop (HDFS).

Клиенты должны планировать основные уплотнения в удобное для них время. Если они не делают это обслуживание, уплотнение отрицательно скажется на производительности чтения в долгосрочной перспективе.

Для операций сканирования причиной для беспокойства должны быть средние проскании, которые намного превышают 100 миллисекунд. Проверьте, было ли точно запланировано основное уплотнение.

## <a name="apache-phoenix-workload"></a>Нагрузка Apache Phoenix

Ответы на следующие вопросы помогут вам лучше понять вашу рабочую нагрузку Apache Phoenix:

* Все ли ваши "читает" перевод на сканирование?
    * Если да, то каковы характеристики этих сканирований?
    * Вы оптимизировали схему таблицы Phoenix для этих сканирований, включая соответствующую индексацию?
* Использовали ли `EXPLAIN` вы это заявление для понимания планов запроса, которые вы генерируете «читает»?
* Ваши записи "upsert-выбирает"?
    * Если это так, они также будут делать сканирование. Ожидаемая задержка для сканирования составляет в среднем около 100 миллисекунд, по сравнению с 10 миллисекундами для точки попадает в HBase.  

## <a name="test-methodology-and-metrics-monitoring"></a>Мониторинг методологии тестирования и метрик

Если вы используете такие тесты, как Yahoo! Облако Обслуживание Benchmark, JMeter, или Pherf для тестирования и настройки производительности, убедитесь, что:

- Клиентские машины не становятся узким местом. Для этого проверьте использование процессора на клиентских машинах.

- Конфигурации на стороне клиента, такие как количество потоков, настроены соответствующим образом, чтобы насытить пропускную способность клиента.

- Результаты испытаний регистрируются точно и систематически.

Если ваши запросы вдруг начали делать гораздо хуже, чем раньше, проверьте потенциальные ошибки в коде приложения. Это внезапно генерации больших объемов недействительных данных? Если это так, он может увеличить просчитывать опоздания.

## <a name="migration-issues"></a>Вопросы миграции

Если вы переигрываете в Azure HDInsight, убедитесь, что миграция осуществляется систематически и точно, предпочтительно с помощью автоматизации. Избегайте ручной миграции. Убедитесь, что выполнены следующие условия:

- Атрибуты таблицы точно переносятся. Атрибуты могут включать в себя как сжатие, цветение фильтры, и так далее.

- Настройки засолки в таблицах Phoenix соотносятся соответствующим образом с новым размером кластера. Например, количество соляных ведер должно быть кратным числу рабочих узлов в кластере. И вы должны использовать несколько, что является фактором количества горячего пятнистости.

## <a name="server-side-configuration-tunings"></a>Настройки конфигурации на стороне сервера

В HDInsight HBase HFiles хранятся на удаленном хранении. При промахе кэша стоимость считывательских систем выше, чем в локальных системах, поскольку данные о локальных системах подкрепляемы локальными HDFS. Для большинства сценариев интеллектуальное использование кэшов HBase (кэш блоков и кэша ведра) предназначено для обхода этой проблемы. В тех случаях, когда проблема не обходится, использование премиум-аккаунта blob может помочь в этой проблеме. Драйвер Windows Azure Storage Blob полагается `fs.azure.read.request.size` на определенные свойства, такие как получение данных в блоках на основе того, что он определяет для чтения режиме (последовательный по сравнению со случайным), так что могут продолжать быть случаи более высоких опозданий с считыванием. С помощью эмпирических экспериментов, мы обнаружили,`fs.azure.read.request.size`что установка размера блока чтения запроса ( ) до 512 КБ и соответствие размерблока таблиц HBase, чтобы быть того же размера дает лучший результат на практике.

Для большинства кластеров узлов большого размера HDInsight HBase предоставляет `bucketcache` в качестве файла на локальном Premium SSD, который присоединен к виртуальной машине, которая работает. `regionservers` Вместо этого использование кэша вне кучи может обеспечить некоторое улучшение. Этот обходной путь имеет ограничение использования доступной памяти и потенциально меньше, чем кэш на основе файлов, поэтому он не всегда может быть лучшим выбором.

Ниже приведены некоторые из других конкретных параметров, которые мы настроили, и что, казалось, помогло в той или иной степени:

- Увеличьте `memstore` размер с 128 МБ до 256 МБ. Как правило, этот параметр рекомендуется для тяжелых сценариев записи.

- Увеличьте количество потоков, предназначенных для уплотнения, с параметра по умолчанию **от 1** до **4.** Эта настройка актуальна, если мы наблюдаем частые незначительные уплотнения.

- Избегайте `memstore` блокировки флеша из-за лимита магазина. Чтобы обеспечить этот `Hbase.hstore.blockingStoreFiles` буфер, увеличьте настройку до **100**.

- Для управления флешами используйте следующие настройки:

    - `Hbase.regionserver.maxlogs`: **140** (избегает смывов из-за ограничений WAL)

    - `Hbase.regionserver.global.memstore.lowerLimit`: **0,55**

    - `Hbase.regionserver.global.memstore.upperLimit`: **0,60**

- Конфигурации для настройки пула потоков для финикса:

    - `Phoenix.query.queuesize`: **10000**

    - `Phoenix.query.threadpoolsize`: **512**

- Другие конфигурации, специфичные для Phoenix:

    - `Phoenix.rpc.index.handler.count`: **50** (если есть большие или многие индексные поиски)

    - `Phoenix.stats.updateFrequency`: **1 час**

    - `Phoenix.coprocessor.maxmetadatacachetimetolivems`: **1 час**

    - `Phoenix.coprocessor.maxmetadatacachesize`: **50 Мб**

- Время ожидания RPC: **3 минуты**

   - Время ожидания RPC включает тайм-аут HBase RPC, тайм-аут клиентского сканера HBase и тайм-аут запроса Phoenix. 
   - Убедитесь, `hbase.client.scanner.caching` что параметр установлен на одинаковое значение как на конце сервера, так и в конце клиента. Если они не одинаковы, эта настройка приводит к ошибкам `OutOfOrderScannerException`клиента, которые связаны с . Этот параметр должен быть установлен на низкое значение для больших сканирований. Мы устанавливаем это значение до **100**.

## <a name="other-considerations"></a>Другие замечания

Ниже приведены дополнительные параметры для рассмотрения настройки:

- `Hbase.rs.cacheblocksonwrite`- по умолчанию по ИРЧП, эта настройка установлена на **истину.**

- Настройки, позволяющие отложить незначительное уплотнение на более поздний срок.

- Экспериментальные настройки, такие как корректировка процентных ставок очередей, зарезервированных для чтения и записи запросов.

## <a name="next-steps"></a>Дальнейшие действия

Если ваша проблема остается нерешенной, посетите один из следующих каналов для получения дополнительной поддержки:

- Получите ответы от экспертов Azure через [поддержку сообщества Azure.](https://azure.microsoft.com/support/community/)

- Связь [@AzureSupport](https://twitter.com/azuresupport)с . Это официальная учетная запись Microsoft Azure для улучшения обслуживания клиентов. Он соединяет сообщество Azure с нужными ресурсами: ответами, поддержкой и экспертами.

- Если вам нужна дополнительная помощь, вы можете отправить запрос на поддержку с [портала Azure](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade/). Выберите **поддержку** из бара меню или откройте концентратор **поддержки Справка и.** Для получения более подробной информации просмотрите [Как создать запрос поддержки Azure.](https://docs.microsoft.com/azure/azure-portal/supportability/how-to-create-azure-support-request) Подписка Microsoft Azure включает доступ к управлению подпиской и поддержке выставления счетов, а техническая поддержка предоставляется через один из [планов поддержки Azure.](https://azure.microsoft.com/support/plans/)
