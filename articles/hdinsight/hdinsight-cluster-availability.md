---
title: 'Мониторинг: журналы Azure Monitor для Apache Ambari & — Azure HDInsight'
description: Узнайте, как использовать журналы Ambari и Azure Monitor для мониторинга работоспособности и доступности кластера.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.custom: hdinsightactive
ms.date: 02/06/2020
ms.openlocfilehash: 383366fa3e436c79bed28a7c47f1e9daa5f0d9de
ms.sourcegitcommit: db2d402883035150f4f89d94ef79219b1604c5ba
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/07/2020
ms.locfileid: "77060186"
---
# <a name="how-to-monitor-cluster-availability-with-apache-ambari-and-azure-monitor-logs"></a>Как отслеживать доступность кластера с помощью Apache Ambari и журналов Azure Monitor

Кластеры HDInsight включают как Apache Ambari, который предоставляет сведения о работоспособности, так и стандартные оповещения, а также интеграцию журналов Azure Monitor, которая обеспечивает запрашиваемые метрики и журналы, а также настраиваемые оповещения.

В этом документе показано, как использовать эти средства для мониторинга кластера и пошаговые инструкции по настройке оповещений Ambari, наблюдению за доступностью узлов и созданию оповещения Azure Monitor, которое срабатывает при отсутствии получения пульса от одного или нескольких узлов. через пять часов.

## <a name="ambari"></a>Ambari

### <a name="dashboard"></a>Панель мониторинга

Доступ к панели мониторинга Ambari можно получить, перейдя по ссылке **Ambari** в разделе **панели мониторинга кластера** в обзоре HDInsight в портал Azure, как показано ниже. Кроме того, доступ к нему можно получить, перейдя к `https://CLUSTERNAME.azurehdinsight.net` в браузере, где ИМЯ_КЛАСТЕРА — это имя кластера.

![Представление портала ресурсов HDInsight](media/hdinsight-cluster-availability/azure-portal-dashboard-ambari.png)

Затем вам будет предложено ввести имя пользователя и пароль для входа в кластер. Введите учетные данные, выбранные при создании кластера.

Затем вы перейдете на панель мониторинга Ambari, которая содержит мини-приложения, отображающие несколько метрик, чтобы получить краткий обзор работоспособности кластера HDInsight. Эти мини-приложения показывают метрики, такие как количество динамических узлов данных (рабочих узлов) и Жаурналнодес (узел Zookeeper), время бесперебойной работы Наменодес (головные узлы), а также метрики, относящиеся к определенным типам кластеров, такие как YARN время работы ResourceManager для кластеров Spark и Hadoop.

![Отображение панели мониторинга с помощью Apache Ambari](media/hdinsight-cluster-availability/apache-ambari-dashboard.png)

### <a name="hosts--view-individual-node-status"></a>Узлы — Просмотр состояния отдельного узла

Также можно просмотреть сведения о состоянии отдельных узлов. Перейдите на вкладку **узлы** , чтобы просмотреть список всех узлов в кластере, и ознакомьтесь с основными сведениями о каждом узле. Зеленая галочка слева от имени каждого узла указывает на то, что все компоненты находятся на узле. Если компонент не работает на узле, вместо зеленой проверки отображается красный предупреждающий треугольник.

![Представление узлов HDInsight Apache Ambari](media/hdinsight-cluster-availability/apache-ambari-hosts1.png)

Затем можно выбрать **имя** узла, чтобы просмотреть более подробные метрики узла для этого конкретного узла. В этом представлении отображается состояние и доступность каждого отдельного компонента.

![Apache Ambari размещает представление одного узла](media/hdinsight-cluster-availability/apache-ambari-hosts-node.png)

### <a name="ambari-alerts"></a>Ambari оповещения

Ambari также предлагает несколько настраиваемых оповещений, которые могут предоставлять уведомления о определенных событиях. Когда оповещения запускаются, они отображаются в левом верхнем углу Ambari в красном значке, содержащем количество оповещений. При выборе этого значка отображается список текущих оповещений.

![Число текущих предупреждений Apache Ambari](media/hdinsight-cluster-availability/apache-ambari-alerts.png)

Чтобы просмотреть список определений предупреждений и их состояний, перейдите на вкладку **оповещения** , как показано ниже.

![Представление определений предупреждений Ambari](media/hdinsight-cluster-availability/ambari-alerts-definitions.png)

Ambari предлагает множество стандартных предупреждений, относящихся к доступности, в том числе:

| Имя предупреждения                        | Description   |
|---|---|
| Сводка по работоспособности узла           | Это предупреждение уровня обслуживания активируется при наличии неработоспособных узлов с данным|
| Работоспособность высокой доступности NameNode | Это предупреждение уровня обслуживания активируется, если не запущены активные NameNode или резервные NameNode.|
| Процент доступных Жаурналнодес    | Это оповещение активируется, если количество Жаурналнодес вниз в кластере превышает заданное критическое пороговое значение. Он объединяет результаты проверок процесса Жаурналноде. |
| Доступно узлов в процентах       | Это оповещение активируется, если число отключенных узлов данных в кластере превышает заданное критическое пороговое значение. В нем суммируются результаты проверок в процессе обработки узлов данных.|

Полный список оповещений Ambari, помогающих отслеживать доступность кластера, можно найти [здесь](https://docs.microsoft.com/azure/hdinsight/hdinsight-high-availability-linux#ambari-web-ui).

Чтобы просмотреть сведения о предупреждении или изменить критерии, выберите **имя** оповещения. В качестве примера следует использовать **сводку по работоспособности узлов** . Вы можете просмотреть описание предупреждения, а также конкретные критерии, которые активируют предупреждение или критическое оповещение и интервал проверки для критерия. Чтобы изменить конфигурацию, нажмите кнопку **изменить** в правом верхнем углу окна конфигурации.

![Настройка оповещений Apache Ambari](media/hdinsight-cluster-availability/ambari-alert-configuration.png)

Здесь можно изменить описание и, что более важно, интервал проверки и пороговые значения для предупреждений или критических оповещений.

![Представление для изменения конфигураций оповещений Ambari](media/hdinsight-cluster-availability/ambari-alert-configuration-edit.png)

В этом примере можно создать два неработоспособных узла, которые активируют критическое оповещение, и 1 неработоспособный узел только запустит предупреждение. По завершении редактирования нажмите кнопку **сохранить** .

### <a name="email-notifications"></a>Уведомления по электронной почте

При необходимости можно также настроить уведомления по электронной почте для оповещений Ambari. Для этого на вкладке **оповещения** нажмите кнопку **действия** в левом верхнем углу, а затем **Управление уведомлениями.**

![Действие "Управление уведомлениями" Ambari](media/hdinsight-cluster-availability/ambari-manage-notifications.png)

Откроется диалоговое окно для управления уведомлениями об оповещениях. Выберите **+** в нижней части диалогового окна и заполните обязательные поля, чтобы предоставить Ambari с данными о сервере электронной почты, с которых будет отправляться электронная почта.

> [!TIP]
> Настройка уведомлений по электронной почте Ambari может быть хорошим способом получения оповещений в одном месте при управлении множеством кластеров HDInsight.

## <a name="azure-monitor-logs-integration"></a>Интеграция журналов Azure Monitor

Журналы Azure Monitor позволяют собирать и объединять данные, созданные несколькими ресурсами, например кластеры HDInsight, в одном месте для обеспечения единого мониторинга.

В качестве необходимого компонента для хранения собранных данных потребуется Log Analytics рабочей области. Если вы еще не создали его, выполните инструкции здесь: [создание log Analytics рабочей области](https://docs.microsoft.com/azure/azure-monitor/learn/quick-create-workspace).

### <a name="enable-hdinsight-azure-monitor-logs-integration"></a>Включение интеграции журналов Azure Monitor HDInsight

На портале на странице ресурсов кластера HDInsight выберите **Azure Monitor**. Затем выберите **включить** и выберите рабочую область log Analytics в раскрывающемся списке.

![HDInsight Operations Management Suite](media/hdinsight-cluster-availability/azure-portal-monitoring.png)

### <a name="query-metrics-and-logs-tables"></a>Таблицы метрик и журналов запросов

После включения интеграции журналов Azure Monitor (это может занять несколько минут) перейдите к ресурсу **рабочей области log Analytics** и выберите **журналы**.

![Журналы рабочей области Log Analytics](media/hdinsight-cluster-availability/hdinsight-portal-logs.png)

В журнале перечислены некоторые примеры запросов, например:

| Имя запроса                      | Description                                                               |
|---------------------------------|---------------------------------------------------------------------------|
| Доступность компьютеров сегодня    | Диаграмма количество компьютеров, отправляющих журналы, каждый час                     |
| Вывод списка пульсов                 | Перечислить все пакеты пульса компьютера за последний час                           |
| Последний пульс каждого компьютера | Отображение последнего пакета пульса, отправленного каждым компьютером                             |
| Недоступные компьютеры           | Список всех известных компьютеров, которые не отправляли пульс за последние 5 часов |
| Уровень доступности               | Вычисление частоты доступности для каждого подключенного компьютера                |

В качестве примера запустите запрос образца " **Частота доступности** ", выбрав **выполнить** в этом запросе, как показано на снимке экрана выше. В результате будет показана частота доступности каждого узла в кластере в процентах. Если вы включили несколько кластеров HDInsight для отправки метрик в ту же рабочую область Log Analytics, вы увидите частоту доступности для всех узлов в этих кластерах.

![Образец запроса "частота доступности журналов Log Analytics рабочей области"](media/hdinsight-cluster-availability/portal-availability-rate.png)

> [!NOTE]  
> Частота доступности измеряется в течение 24-часового периода, поэтому кластер должен работать в течение как минимум 24 часов, прежде чем будут отображены точные показатели доступности.

Вы можете закрепить эту таблицу на общей информационной панели, щелкнув **закрепить** в правом верхнем углу. Если у вас нет доступных для записи общих панелей мониторинга, вы можете увидеть, как ее создать: [Создание и общий доступ к панелям мониторинга в портал Azure](https://docs.microsoft.com/azure/azure-portal/azure-portal-dashboards#publish-and-share-a-dashboard).

### <a name="azure-monitor-alerts"></a>Оповещения Azure Monitor

Можно также настроить Azure Monitor оповещения, которые будут запускаться, когда значение метрики или результаты запроса соответствуют определенным условиям. Например, создадим оповещение для отправки сообщения электронной почты, когда один или несколько узлов не отправляли пульс в течение 5 часов (т. е. Предполагается, что он недоступен).

В **журналах**запустите образец запроса **недоступные компьютеры** , выбрав **выполнить** в этом запросе, как показано ниже.

![Пример недоступных компьютеров в журналах рабочей области Log Analytics](media/hdinsight-cluster-availability/portal-unavailable-computers.png)

Если все узлы доступны, этот запрос должен вернуть нулевые результаты. Щелкните **новое правило генерации оповещений** , чтобы начать настройку оповещения для этого запроса.

![Новое правило генерации оповещений для рабочей области Log Analytics](media/hdinsight-cluster-availability/portal-logs-new-alert-rule.png)

Существует три компонента оповещения: *ресурс* , для которого создается правило (в данном случае это рабочая область log Analytics), *условие* для запуска оповещения и *группы действий* , которые определяют, что произойдет при срабатывании оповещения.
Щелкните **заголовок условия**, как показано ниже, чтобы завершить настройку логики сигнала.

![Условие правила создания предупреждения на портале](media/hdinsight-cluster-availability/portal-condition-title.png)

Откроется окно **Настройка логики сигнала**.

Задайте раздел **логики оповещения** следующим образом:

*На основе: количество результатов, условие: больше, пороговое значение: 0.*

Поскольку этот запрос возвращает недоступные узлы только в качестве результатов, если число результатов больше 0, предупреждение должно сработать.

В разделе **оценено на основе** задайте **период** и **частоту** в зависимости от частоты проверки на наличие недоступных узлов.

В целях этого оповещения необходимо проверить **период = Frequency.** Дополнительные сведения о периоде, частоте и других параметрах оповещений можно найти [здесь](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-unified-log#log-search-alert-rule---definition-and-types).

По завершении настройки логики сигнала нажмите кнопку **Готово** .

![Правило генерации оповещений настраивает логику сигнала](media/hdinsight-cluster-availability/portal-configure-signal-logic.png)

Если у вас еще нет группы действий, щелкните **создать** в разделе **группы действий** .

![Правило генерации оповещений создает новую группу действий](media/hdinsight-cluster-availability/portal-create-new-action-group.png)

Откроется **Группа добавить действие**. Выберите **имя группы действий**, **Краткое имя**, **подписку**и **группу ресурсов.** В разделе **действия** выберите **имя действия** и выберите **адрес электронной почты, SMS/Push/Voice** в качестве **типа действия.**

> [!NOTE]
> Существует несколько других действий, которые можно активировать с помощью предупреждения, помимо электронной почты, SMS/Push/Voice, например функции Azure, LogicApp, веб-перехватчика, ITSM и модуля Runbook службы автоматизации. [Подробнее.](https://docs.microsoft.com/azure/azure-monitor/platform/action-groups#action-specific-information)

Откроется **Электронная почта, SMS, Push/Voice**. Выберите **имя** получателя, **Проверьте** поле адреса **электронной** почты и введите адрес электронной почты, по которому должно быть отправлено оповещение. Нажмите кнопку **ОК** в окне **Электронная почта, SMS/Push/Voice**, а затем в **группе Добавить действие** , чтобы завершить настройку группы действий.

![Правило генерации оповещений создает группу действий](media/hdinsight-cluster-availability/portal-add-action-group.png)

После того, как эти колонки будут закрыты, вы увидите группу действий, указанную в разделе **группы действий** . Наконец, заполните раздел **сведения о предупреждении** , введя имя и **Описание** **правила генерации оповещений** и выбрав **серьезность**. Щелкните **создать правило генерации оповещений** , чтобы завершить работу.

![Портал создает окончание правила генерации оповещений](media/hdinsight-cluster-availability/portal-create-alert-rule-finish.png)

> [!TIP]
> Возможность указывать **серьезность** — это мощный инструмент, который можно использовать при создании нескольких предупреждений. Например, можно создать одно оповещение для вызова предупреждения (уровень серьезности 1), если один головной узел выходит из строя, и другое оповещение, которое вызывает критическое (уровень серьезности 0) в маловероятном случае, если оба головных узла выходят из строя.

При выполнении условия для этого предупреждения будет срабатывать предупреждение, и вы получите сообщение электронной почты со сведениями о предупреждении следующего вида:

![Пример оповещения по электронной почте Azure Monitor](media/hdinsight-cluster-availability/portal-oms-alert-email.png)

Вы также можете просмотреть все оповещения, которые были запущены, сгруппированные по серьезности, перейдя к **оповещениям** в **рабочей области log Analytics**.

![Оповещения рабочей области Log Analytics](media/hdinsight-cluster-availability/hdi-portal-oms-alerts.png)

При выборе группирования с уровнем серьезности ( **уровень серьезности 1,** как показано выше) будут показаны записи для всех предупреждений этой серьезности, которые были запущены, как показано ниже:

![Log Analytics рабочей области уровень серьезности одно оповещение](media/hdinsight-cluster-availability/portal-oms-alerts-sev1.png)

## <a name="next-steps"></a>Дальнейшие действия

- [Доступность и надежность кластеров Apache Hadoop в HDInsight](hdinsight-high-availability-linux.md)
