---
title: 'Мониторинг: журналы Apache Ambari & Azure Monitor - Azure HDInsight'
description: Узнайте, как использовать журналы Ambari и Azure Monitor для мониторинга работоспособности и доступности кластеров.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.custom: hdinsightactive
ms.date: 02/06/2020
ms.openlocfilehash: 383366fa3e436c79bed28a7c47f1e9daa5f0d9de
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77060186"
---
# <a name="how-to-monitor-cluster-availability-with-apache-ambari-and-azure-monitor-logs"></a>Как контролировать доступность кластеров с помощью журналов Apache Ambari и Azure Monitor

Кластеры HDInsight включают как Apache Ambari, который предоставляет информацию о работоспособности с первого взгляда и предопределенные оповещения, а также интеграцию журналов Azure Monitor, которая обеспечивает запросные метрики и журналы, а также настраиваемые оповещения.

Этот документ показывает, как использовать эти инструменты для мониторинга кластера и просматривает несколько примеров для настройки оповещения Ambari, мониторинга скорости доступности узлов и создания оповещения Azure Monitor, которое срабатывает, когда сердцебиение не было получено из одного или нескольких узлов через пять часов.

## <a name="ambari"></a>Ambari

### <a name="dashboard"></a>Панель мониторинга

К панели мониторинга Ambari можно получить доступ, выбрав домашнюю ссылку **Ambari** в разделе **панелей мониторинга кластера** на портале Azinsight, как показано ниже. Кроме того, к нему можно получить доступ, передвигаясь `https://CLUSTERNAME.azurehdinsight.net` в браузере, где CLUSTERNAME — это название вашего кластера.

![Представление ресурсного портала HDInsight](media/hdinsight-cluster-availability/azure-portal-dashboard-ambari.png)

Затем вам будет предложено для кластера логин имя пользователя и пароль. Введите выбранные учетные данные при создании кластера.

Затем вы будете доставлены в панель мониторинга Ambari, которая содержит виджеты, которые показывают несколько метрик, чтобы дать вам краткий обзор работы вашего кластера HDInsight. Эти виджеты показывают такие показатели, как количество живых DataNodes (рабочие узлы) и JournalNodes (узлы зоозащитника), NameNodes (головные узлы) время простоя, а также метрики, характерные для определенных типов кластеров, такие как yARN ResourceManager время простоя для кластеров Spark и Hadoop.

![Apache Ambari использовать дисплей приборной панели](media/hdinsight-cluster-availability/apache-ambari-dashboard.png)

### <a name="hosts--view-individual-node-status"></a>Хосты — просмотр индивидуального статуса узлов

Вы также можете просмотреть информацию о статусе для отдельных узлов. Выберите вкладку **Хостов,** чтобы просмотреть список всех узлов в кластере и увидеть основную информацию о каждом узлах. Зеленая проверка слева от имени каждого узла указывает на то, что все компоненты находятся на узле. Если компонент не работает на узле, вместо зеленого чека увидится красный треугольник оповещения.

![HDInsight Apache Ambari хостов зрения](media/hdinsight-cluster-availability/apache-ambari-hosts1.png)

Затем можно выбрать **имя** узла для просмотра более подробных метрик узлов для этого конкретного узла. Это представление показывает статус/доступность каждого отдельного компонента.

![Apache Ambari хостов одного узла зрения](media/hdinsight-cluster-availability/apache-ambari-hosts-node.png)

### <a name="ambari-alerts"></a>Оповещения Амбари

Ambari также предлагает несколько настраиваемых оповещений, которые могут обеспечить уведомление о некоторых событиях. При срабатывании оповещений они отображаются в верхнем левом углу Амбари в красном значке, содержащем количество оповещений. При выборе этого значка отображается список текущих оповещений.

![Apache Ambari текущих предупреждений кол](media/hdinsight-cluster-availability/apache-ambari-alerts.png)

Чтобы просмотреть список определений оповещения и их статусы, выберите вкладку **Alerts,** как показано ниже.

![Ambari предупреждает о представлении определений](media/hdinsight-cluster-availability/ambari-alerts-definitions.png)

Ambari предлагает много предопределенных предупреждений, связанных с доступностью, в том числе:

| Имя предупреждения                        | Описание   |
|---|---|
| Резюме состояния DataNode           | Это оповещение на уровне службы срабатывает при наличии неработоспособных DataNodes|
| Здоровье высокой доступности NameNode | Это оповещение на уровне службы срабатывает, если нет ни Active NameNode, ни Standby NameNode.|
| Процент доступных удосов журнала    | Это предупреждение срабатывает, если число внизжурналов в кластере превышает настроенный критический порог. Он агрегирует результаты проверки процесса JournalNode. |
| Процент доступных dataNoд       | Это предупреждение срабатывает, если число снижаемых dataNodes в кластере превышает настроенный критический порог. Он агрегирует результаты проверки процесса DataNode.|

Полный список предупреждений Ambari, которые помогают контролировать наличие кластера, можно найти [здесь,](https://docs.microsoft.com/azure/hdinsight/hdinsight-high-availability-linux#ambari-web-ui)

Чтобы просмотреть сведения для предупреждения или изменить критерии, выберите **имя** оповещения. В качестве примера возьмем в качестве **примера резюме dataNode Health Summary.** Вы можете увидеть описание оповещения, а также конкретные критерии, которые вызовут "предупреждение" или "критическое" предупреждение и интервал проверки для критериев. Чтобы отсеивать конфигурацию, выберите кнопку **«Отображевая»** в правом верхнем углу окна Configuration.

![Конфигурация оповещения Apache Ambari](media/hdinsight-cluster-availability/ambari-alert-configuration.png)

Здесь можно отсеять описание и, что более важно, интервал проверки и пороги для предупреждения или критических оповещений.

![Конфигурации оповещения Ambari отсеивайте представление](media/hdinsight-cluster-availability/ambari-alert-configuration-edit.png)

В этом примере можно заставить 2 неработоспособных Data Nodes вызвать критическое оповещение, а 1 неработоспособный DataNode только вызвать предупреждение. Выберите **Сохранить,** когда вы закончите редактирование.

### <a name="email-notifications"></a>Уведомления по электронной почте

Вы также можете дополнительно настроить уведомления по электронной почте для предупреждений Ambari. Для этого, когда на вкладке **оповещения,** нажмите кнопку **Действия** в верхнем левом углу, а затем **управлять уведомлениями.**

![Ambari управляет действиями по уведомлению](media/hdinsight-cluster-availability/ambari-manage-notifications.png)

Откроется диалог для управления уведомлениями о помечке. Выберите **+** в нижней части диалога и заполнить необходимые поля, чтобы предоставить Ambari с сервера электронной почты детали, из которых для отправки писем.

> [!TIP]
> Настройка уведомлений ambari по электронной почте может быть хорошим способом получения оповещений в одном месте при управлении многими кластерами HDInsight.

## <a name="azure-monitor-logs-integration"></a>Интеграция журналов Azure Monitor

Журналы Azure Monitor позволяют собирать и агрегировать данные, генерируемые несколькими ресурсами, такими как кластеры HDInsight, в одном месте для достижения единого мониторинга.

В качестве предварительного условия для хранения собранных данных потребуется рабочее пространство для анализа журналов. Если вы еще не создали один, вы можете следовать инструкциям здесь: [Создание журнала Analytics Workspace](https://docs.microsoft.com/azure/azure-monitor/learn/quick-create-workspace).

### <a name="enable-hdinsight-azure-monitor-logs-integration"></a>Включить интеграцию журналов HDInsight Azure Monitor

На странице кластера HDInsight на портале выберите **Azure Monitor.** Затем выберите **включить** и выберите рабочее пространство Log Analytics из выпадающих.

![Пакет управления операциями HDInsight](media/hdinsight-cluster-availability/azure-portal-monitoring.png)

### <a name="query-metrics-and-logs-tables"></a>Таблицы запросов и таблицы журналов

После включения интеграции журналов Azure Monitor (это может занять несколько минут), перейдите на ресурс **Рабочего пространства аналитики журнала** и выберите **журналы.**

![Логи рабочего пространства анализа журналов журналов журналов журналов журналов журналов журналов журнал](media/hdinsight-cluster-availability/hdinsight-portal-logs.png)

В журналах перечисляется ряд выборочных запросов, таких как:

| Имя запроса                      | Описание                                                               |
|---------------------------------|---------------------------------------------------------------------------|
| Доступность компьютеров на сегодняшний день    | Диаграмма количество компьютеров, отправляющих журналы, каждый час                     |
| Список сердцебиений                 | Перечислите все биения сердца компьютера за последний час                           |
| Последнее сердцебиение каждого компьютера | Показать последнее сердцебиение, отправленное каждым компьютером                             |
| Недоступные компьютеры           | Перечислите все известные компьютеры, которые не посылали сердцебиение за последние 5 часов |
| Коэффициент доступности               | Рассчитать скорость доступности каждого подключенного компьютера                |

В качестве примера выполнить пример оценивания **доступности,** выбрав **выполнить** этот запрос, как показано на скриншоте выше. Это покажет скорость доступности каждого узла в кластере в процентах. Если вы включили несколько кластеров HDInsight для отправки метрик в одно и то же рабочее пространство Log Analytics, вы увидите скорость доступности для всех узлов в этих кластерах, отображаемых.

![Логи аналитики рабочего пространства журналы 'скорость доступности' образец запроса](media/hdinsight-cluster-availability/portal-availability-rate.png)

> [!NOTE]  
> Скорость доступности измеряется в течение 24-часового периода, поэтому кластеру необходимо будет работать не менее 24 часов, прежде чем вы увидите точные показатели доступности.

Эту таблицу можно прикрепить к общей панели мониторинга, нажав **Pin** в правом верхнем углу. Если у вас нет общих панелей мониторинга, вы можете посмотреть, как создать ее здесь: [Создайте и поделитесь панелей мониторинга на портале Azure.](https://docs.microsoft.com/azure/azure-portal/azure-portal-dashboards#publish-and-share-a-dashboard)

### <a name="azure-monitor-alerts"></a>Оповещения Azure Monitor

Можно также настроить оповещения Azure Monitor, которые срабатывают, когда значение метрики или результаты запроса соответствуют определенным условиям. В качестве примера давайте создадим оповещение для отправки электронной почты, когда один или несколько узлов не отправили сердцебиение в течение 5 часов (т.е. предполагается, что они недоступны).

Из **журналов**выполнить **недоступный** запрос на запрос компьютерах, выбрав **Выполнить** этот запрос, как показано ниже.

![Рабочее пространство журнала Analytics журналирует образец «недоступных компьютеров»](media/hdinsight-cluster-availability/portal-unavailable-computers.png)

Если все узлы доступны, этот запрос должен вернуть нулевые результаты на данный момент. Нажмите **новое правило оповещения,** чтобы начать настройку оповещения для этого запроса.

![Новое правило оповещения «Аналитика журналов»](media/hdinsight-cluster-availability/portal-logs-new-alert-rule.png)

Есть три компонента оповещения: *ресурс* для создания правила (рабочее пространство Log Analytics в данном случае), *условие* для запуска оповещения и *группы действий,* определяющие, что произойдет при срабатывании оповещения.
Нажмите **на заголовок состояния,** как показано ниже, чтобы закончить настройку логики сигнала.

![Оповещение портала создает условие правила](media/hdinsight-cluster-availability/portal-condition-title.png)

Это откроет **логику сигнала настройки.**

Установите **раздел логики оповещения** следующим образом:

*На основе: Количество результатов, Состояние: Больше, чем, Порог: 0.*

Поскольку этот запрос возвращает недоступные узлы только в качестве результатов, если количество результатов всегда больше 0, оповещение должно срастать.

В **разделе Оценка на основе** раздела установите **период** и **частоту** на основе частоты, как часто требуется проверить наличие недоступных узлов.

Для целей этого оповещения, вы хотите, чтобы **убедиться, период частоты.** Более подробную информацию о периоде, частоте и других параметрах оповещения можно найти [здесь](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-unified-log#log-search-alert-rule---definition-and-types).

Выберите **Done,** когда вы закончите настройку логики сигнала.

![Правило оповещения настраивает логику сигнала](media/hdinsight-cluster-availability/portal-configure-signal-logic.png)

Если у вас еще нет существующей группы действий, нажмите **«Создайте новое»** в разделе **«Группы действий».**

![Правило оповещения создает новую группу действий](media/hdinsight-cluster-availability/portal-create-new-action-group.png)

Это откроет **группу действий Добавить**. Выберите **имя группы действий,** **короткое имя,** **подписка**и **группа ресурсов.** В разделе **Действия** выберите **имя действия** и выберите **Email/SMS/Push/Voice** в качестве **типа действий.**

> [!NOTE]
> Есть несколько других действий, которые может вызвать оповещение, кроме электронной почты/SMS/Push/Voice, таких как функция Azure, LogicApp, Webhook, ITSM и Automation Runbook. [Подробнее.](https://docs.microsoft.com/azure/azure-monitor/platform/action-groups#action-specific-information)

Это откроет **электронную почту / SMS / Push / Голос**. Выберите **имя** получателя, **проверьте** поле **электронной почты** и введите адрес электронной почты, на который вы хотите отправить оповещение. Выберите **OK** в **электронной почте / SMS / Push / Голос**, затем в **добавить группу действий,** чтобы закончить настройку вашей группы действий.

![Правило оповещения создает группу действий добавления](media/hdinsight-cluster-availability/portal-add-action-group.png)

После закрытия этих лезвий вы должны увидеть свою группу действий, перечисленные в разделе **Группы действий.** Наконец, заполните раздел **«Подробности оповещения»,** введя название и **описание** **правила оповещения** и выбрав **степень серьезности.** Нажмите **Создать правило оповещения,** чтобы закончить.

![Портал создает отделку правила оповещения](media/hdinsight-cluster-availability/portal-create-alert-rule-finish.png)

> [!TIP]
> Возможность указать **степень серьезности** является мощным инструментом, который может быть использован при создании нескольких предупреждений. Например, можно создать одно оповещение для поднятия Предупреждения (Sev 1), если один узлы головы выходит из-под конъюнта, а другое - предупреждение, которое повышает критический (Sev 0) в маловероятном случае, если оба узла головы сходят на нет.

Когда условие для этого предупреждения будет выполнено, оповещение будет стрелять, и вы получите по электронной почте с такими сведениями о помехе:

![Пример электронной почты Azure Monitor](media/hdinsight-cluster-availability/portal-oms-alert-email.png)

Вы также можете просмотреть все оповещения, которые были уволены, сгруппированы по степени серьезности, перейдя на оповещения в вашем рабочем пространстве **аналитики** **журнала.**

![Оповещения рабочего пространства анализа журналов](media/hdinsight-cluster-availability/hdi-portal-oms-alerts.png)

Выбор группы тяжести (т.е. **Sev 1,** как указано выше) покажет записи для всех предупреждений той степени тяжести, которые стреляли, как ниже:

![Лог Аналитика рабочее пространство sev одно предупреждение](media/hdinsight-cluster-availability/portal-oms-alerts-sev1.png)

## <a name="next-steps"></a>Дальнейшие действия

- [Доступность и надежность кластеров Apache Hadoop в HDInsight](hdinsight-high-availability-linux.md)
