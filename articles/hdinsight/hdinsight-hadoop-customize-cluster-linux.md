---
title: Настройка кластеров Azure HDInsight с помощью действий сценария
description: Добавление настраиваемых компонентов в кластеры HDInsight на основе Linux с помощью действий сценариев. Действия сценариев — это сценарии Bash, которые можно использовать для настройки конфигурации кластера или добавления дополнительных служб и служебных программ, таких как Hue, Solr или R.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.date: 04/02/2019
ms.openlocfilehash: 7885b03e9f92fc8e8c5b2c78049760cbed8d4dc7
ms.sourcegitcommit: c105ccb7cfae6ee87f50f099a1c035623a2e239b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2019
ms.locfileid: "67703964"
---
# <a name="customize-azure-hdinsight-clusters-by-using-script-actions"></a>Настройка кластеров Azure HDInsight с помощью действий сценария

В Azure HDInsight поддерживается метод конфигурации с использованием **действий сценариев**, который вызывает пользовательские сценарии для настройки кластера. Эти скрипты используются для установки дополнительных компонентов и изменения параметров конфигурации. Действия скрипта можно использовать во время или после создания кластера.

Действия сценариев можно опубликовать в Azure Marketplace как приложение HDInsight. Дополнительные сведения о приложениях HDInsight см. в статье [Публикация приложения HDInsight в Azure Marketplace](hdinsight-apps-publish-applications.md).

## <a name="permissions"></a>Разрешения

Для присоединенного к домену кластера HDInsight для выполнения действий сценариев необходимо задать два следующих разрешения Apache Ambari:

* **AMBARI.RUN\_CUSTOM\_COMMAND**. Это разрешение по умолчанию назначено для роли администратора Ambari.
* **CLUSTER.RUN\_CUSTOM\_COMMAND**. Это разрешение по умолчанию назначено для администратора кластера HDInsight и администратора Ambari.

Дополнительные сведения о работе с разрешениями в присоединенном к домену кластере HDInsight см. в статье [Управление кластерами HDInsight с помощью корпоративного пакета безопасности](./domain-joined/apache-domain-joined-manage.md).

## <a name="access-control"></a>Управление доступом

Если вы не администратор или владелец подписки Azure, ваша учетная запись должна иметь доступ к группе ресурсов, содержащей кластер HDInsight, по крайней мере с правами участника.

При создании кластера HDInsight другой пользователь, которому назначена по крайней мере роль участника в рамках подписки Azure, должен заранее зарегистрировать поставщика ресурсов для HDInsight. Поставщик регистрируется тогда, когда пользователь с правами участника подписки впервые создает ресурс в подписке. Вы можете выполнить [регистрацию поставщика с помощью REST](https://msdn.microsoft.com/library/azure/dn790548.aspx) без создания ресурса.

Дополнительные сведения об управлении доступом:

* [Начало работы с управлением доступом на портале Azure](../role-based-access-control/overview.md)
* [Использование назначений ролей для управления доступом к ресурсам в подписке Azure](../role-based-access-control/role-assignments-portal.md)

## <a name="understand-script-actions"></a>Общие сведения о действиях сценариев

Действие сценария — это сценарий Bash, который выполняется на узлах в кластере HDInsight. Характеристики и возможности действий сценариев приведены ниже.

* Они должны храниться в универсальном коде ресурса (URI), доступном из кластера HDInsight. Возможные места хранения:
    
    * Для регулярного кластеров:
    
      * Поколение 1 ADLS: Кластер HDInsight субъекта-службы с доступом к Data Lake Storage должен иметь доступ к сценарию с правами на чтение. URI для скриптов, находящихся в Data Lake Storage 1-го поколения, имеет формат `adl://DATALAKESTOREACCOUNTNAME.azuredatalakestore.net/path_to_file`.
      
      * Большой двоичный объект в учетной записи хранения Azure, которая служит основной или дополнительной учетной записью хранения для кластера HDInsight. При создании кластера HDInsight получает доступ к обоим типам учетных записей хранения.

        > [!IMPORTANT]  
        > Не вращаются ключ хранилища для этой учетной записи хранения Azure, так как это вызовет действия последующих скриптов с помощью скриптов, хранящихся на нем переход на другой.

      * Открытый общий доступ к файлам служба, доступная через пути http://. Примерами являются BLOB-объектов Azure, GitHub, OneDrive.

        Примеры URI см. в разделе [Пример сценариев действий сценария](#example-script-action-scripts).

     * Для кластеров с помощью ESP:
         
         * Wasb: / / или wasbs: / / или http [s] :// поддерживаются идентификаторы URI.
            
* Действия можно ограничить выполнением только на определенных типах узлов, например головных или рабочих.

* Действия сценария могут быть сохраняемыми или специализированными.

    Сохраняемые сценарии применяются при настройке новых рабочих узлов, добавленных в кластер при операциях масштабирования. Сохраняемый сценарий может также применять изменения к узлу другого типа при операциях масштабирования. Примером является головной узел.

  > [!IMPORTANT]  
  > Действия сохраняемых скриптов должны иметь уникальные имена.

    Специализированные сценарии не сохраняются. Они не применяются на рабочих узлах, добавленных в кластер после выполнения сценария. Затем вы можете повысить уровень специализированного сценария до сохраняемого (и наоборот).

  > [!IMPORTANT]  
  > Действия скриптов, используемые при создании кластера, автоматически сохраняются.
  >
  > Сценарии, в которых произошла ошибка, не сохраняются, даже если вы отдельно указали, что они должны быть сохранены.

* Действия сценария могут принимать параметры, используемые в процессе выполнения сценария.

* Они выполняются с помощью прав привилегированного пользователя на узлах кластера.

* Действия сценария могут выполняться с помощью портала Azure, Azure PowerShell, классического интерфейса командной строки Azure или пакета SDK HDInsight для .NET.

В кластере ведется журнал всех сценариев, которые в нем выполнялись. Это позволяет определить идентификатор сценария для операций повышения или понижения уровня сценария.

> [!IMPORTANT]  
> Не существует способа автоматического отката изменений, внесенных действием сценария. Отмените изменения вручную или предоставьте скрипт для их отмены.

### <a name="script-action-in-the-cluster-creation-process"></a>Действие сценария в процессе создания кластера

Действия сценариев, используемые в процессе создания кластера и выполняющиеся в имеющемся кластере, немного отличаются:

* Сценарий сохраняется автоматически.

* Ошибка в сценарии может вызвать сбой создания кластера.

На следующей схеме показано, когда выполняется действие сценария в процессе создания:

![Настройка кластера HDInsight и этапы создания кластера][img-hdi-cluster-states]

Скрипт выполняется во время настройки HDInsight. Сценарий выполняется параллельно на всех указанных узлах кластера. Он выполняется с правами привилегированного пользователя на узлах.

> [!NOTE]  
> Вы можете выполнять такие операции, как остановка и запуск служб, включая службы, связанные с Apache Hadoop. Если вы останавливаете службы, перед завершением работы сценария необходимо запустить и настроить службу Ambari и другие службы, связанные с Hadoop. Эти службы нужны для определения работоспособности и состояния кластера при его создании.


При создании кластера можно использовать множество действий сценариев одновременно. Они будут вызываться в том порядке, в котором были указаны.

> [!IMPORTANT]  
> Действия сценариев должны завершиться в пределах 60 минут, либо время ожидания истечет. В процессе подготовки кластера скрипт запускается одновременно с другими процессами установки и настройки. Конкуренция за ресурсы, такие как ЦП или пропускная способность сети, может привести к затягиванию выполнения сценария по сравнению со временем его выполнения в среде разработки.
>
> Чтобы свести время выполнения сценария к минимуму, избегайте таких задач, как скачивание и компиляция приложений из источника. Выполните предварительную компиляцию приложения и сохраните двоичный файл в службе хранилища Azure.


### <a name="script-action-on-a-running-cluster"></a>Действие скрипта в работающем кластере

Ошибка в выполняющемся сценарии в работающем кластере не приводит автоматически к сбою в работе кластера. После завершения сценария кластер должен вернуться в рабочее состояние.

> [!IMPORTANT]  
> Даже если кластер запущен, ошибка сценария может привести к проблемам. К примеру, сценарий может удалить необходимые для работы кластера файлы.
>
> Действия сценариев выполняются с использованием привилегий суперпользователя. Вы должны понимать, что делает сценарий, прежде чем применять его в кластере.

Когда сценарий применяется в кластере, состояние кластера изменяется с **Выполняется** на **Принято**. Затем оно изменится на **Конфигурация HDInsight** и, наконец, обратно на **Выполняется** для успешного завершения сценария. Состояние сценария регистрируется в журнале действий сценариев. Эти сведения сообщают о том, успешно ли выполнен сценарий. Например, командлет PowerShell `Get-AzHDInsightScriptActionHistory` отображает состояние сценария. Эта команда возвращает следующую информацию:

    ScriptExecutionId : 635918532516474303
    StartTime         : 8/14/2017 7:40:55 PM
    EndTime           : 8/14/2017 7:41:05 PM
    Status            : Succeeded

> [!IMPORTANT]  
> При изменении пользователя кластера, администратора, пароля после создания кластера может происходить сбой при выполнении действий сценариев для этого кластера. Если у вас есть сохраненные действия сценариев, нацеленные на рабочие узлы, они могут завершиться ошибкой при масштабировании кластера.

## <a name="example-script-action-scripts"></a>Пример сценариев действий сценария

Сценарии действия сценария можно использовать с помощью следующих служебных программ:

* Портал Azure
* Azure PowerShell
* Классический интерфейс командной строки Azure.
* Пакет SDK для HDInsight .NET.

В HDInsight доступны скрипты для установки следующих компонентов в кластерах HDInsight.

| Имя | Скрипт |
| --- | --- |
| добавление учетной записи хранения Azure; |`https://hdiconfigactions.blob.core.windows.net/linuxaddstorageaccountv01/add-storage-account-v01.sh`. Ознакомьтесь со статьей [Добавление дополнительных учетных записей хранения в HDInsight](hdinsight-hadoop-add-storage.md). |
| установка Hue; |`https://hdiconfigactions.blob.core.windows.net/linuxhueconfigactionv02/install-hue-uber-v02.sh`. Ознакомьтесь со статьей [Установка и использование Hue на кластерах HDInsight Hadoop](hdinsight-hadoop-hue-linux.md). |
| установка Giraph; |`https://hdiconfigactions.blob.core.windows.net/linuxgiraphconfigactionv01/giraph-installer-v01.sh`. Ознакомьтесь со статьей [Установка Apache Giraph в кластерах HDInsight Hadoop и использование Giraph для обработки диаграмм больших объемов](hdinsight-hadoop-giraph-install-linux.md). |
| Предварительная загрузка библиотек Hive |`https://hdiconfigactions.blob.core.windows.net/linuxsetupcustomhivelibsv01/setup-customhivelibs-v01.sh`. Ознакомьтесь со статьей [Добавление пользовательских библиотек Apache Hive при создании кластера HDInsight](hdinsight-hadoop-add-hive-libraries.md). |

## <a name="use-a-script-action-during-cluster-creation"></a>Использование действия сценария при создании кластера

В этом разделе объясняются различные способы использования действий сценариев при создании кластера HDInsight.

### <a name="use-a-script-action-during-cluster-creation-from-the-azure-portal"></a>Использование действия сценария при создании кластера с портала Azure

1. Начните создавать кластер, как описано в статье [Установка кластеров в HDInsight с использованием Apache Hadoop, Apache Spark, Apache Kafka и других технологий](hdinsight-hadoop-provision-linux-clusters.md). При создании кластера отобразится страница __Сводка кластера__. На странице __Сводка кластера__ щелкните ссылку __Изменить__ для элемента __Дополнительные параметры__.

    ![Ссылка "Дополнительные параметры"](./media/hdinsight-hadoop-customize-cluster-linux/advanced-settings-link.png)

3. В колонке __Дополнительные параметры__ выберите __Действия скрипта__. В колонке __Действия сценария__ выберите __+ Submit new__ (+Отправить новое).

    ![Отправка нового действия скрипта](./media/hdinsight-hadoop-customize-cluster-linux/add-script-action.png)

4. Используйте запись __Выберите сценарий__, чтобы выбрать готовый сценарий. Чтобы использовать настраиваемый сценарий, выберите __Настраиваемый__. Затем укажите __имя__ и __универсальный код ресурса (URI) Bash-сценария__ своего сценария.

    ![Добавление скрипта в форме выбора скрипта](./media/hdinsight-hadoop-customize-cluster-linux/select-script.png)

    В приведенной ниже таблице описываются элементы формы.

    | Свойство | Значение |
    | --- | --- |
    | Выберите скрипт | Чтобы использовать собственный скрипт, выберите __Настраиваемый__. В противном случае выберите один из предоставленных скриптов. |
    | Имя |Укажите имя для действия сценария. |
    | URI bash-скрипта |Укажите URI сценария. |
    | HEAD/рабочих/ZooKeeper |Укажите узлы, на которых выполняется сценарий: **Head**, **Worker** или **ZooKeeper** |
    | Параметры |Укажите параметры, если они требуются для сценария. |

    Используйте запись __Сохранить это действие сценария__, чтобы сценарий применялся при масштабировании.

5. Чтобы сохранить скрипт, нажмите кнопку __Создать__. Чтобы добавить еще один сценарий, вы можете использовать элемент __+ Submit new__ (+ Отправить новый).

    ![Несколько действий скриптов](./media/hdinsight-hadoop-customize-cluster-linux/multiple-scripts.png)

    Завершив добавление сценариев, нажмите кнопку __Выбрать__, а затем — кнопку __Далее__, чтобы вернуться в раздел __Сводка по кластерам__.

3. Чтобы создать кластер, в разделе __Сводка по кластерам__ нажмите __Создать__.

### <a name="use-a-script-action-from-azure-resource-manager-templates"></a>Использование действия сценария на основе шаблонов Azure Resource Manager

Действия сценария можно использовать с шаблонами Azure Resource Manager. С примером ознакомьтесь в статье [Create HDInsight Linux Cluster and run a script action](https://azure.microsoft.com/resources/templates/hdinsight-linux-run-script-action/) (Создание кластера HDInsight на платформе Linux и выполнение действия сценария).

В этом примере добавляется действие сценария с помощью следующего кода:

```json
"scriptActions": [
    {
        "name": "setenvironmentvariable",
        "uri": "[parameters('scriptActionUri')]",
        "parameters": "headnode"
    }
]
```

Получите дополнительные сведения о развертывании шаблона:

* [Развертывание ресурсов с использованием шаблонов Resource Manager и Azure PowerShell](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-template-deploy)

* [Развертывание ресурсов с использованием шаблонов Resource Manager и Azure CLI](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-template-deploy-cli)

### <a name="use-a-script-action-during-cluster-creation-from-azure-powershell"></a>Использование действия сценария при создании кластера с помощью Azure PowerShell

В этом разделе используется [AzHDInsightScriptAction добавить](https://docs.microsoft.com/powershell/module/az.hdinsight/add-azhdinsightscriptaction) командлет будет вызывать скрипты для настройки кластера. Перед началом работы убедитесь, что установили и настроили Azure PowerShell. Чтобы использовать эти команды PowerShell, вам потребуется [AZ модуля](https://docs.microsoft.com/powershell/azure/overview).

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Следующий сценарий демонстрирует применение действия сценария при создании кластера с помощью PowerShell:

[!code-powershell[main](../../powershell_scripts/hdinsight/use-script-action/use-script-action.ps1?range=5-90)]

Создание кластера может занять несколько минут.

### <a name="use-a-script-action-during-cluster-creation-from-the-hdinsight-net-sdk"></a>Использование действия сценария при создании кластера с помощью пакета SDK HDInsight для .NET

Пакет SDK HDInsight для .NET предоставляет клиентские библиотеки, которые упрощают работу с кластерами HDInsight из приложения .NET. Пример кода см. в статье [Создание кластеров под управлением Linux в HDInsight с помощью пакета SDK для .NET](hdinsight-hadoop-create-linux-clusters-dotnet-sdk.md#use-script-action).

## <a name="apply-a-script-action-to-a-running-cluster"></a>Применение действия сценария в работающем кластере

В этом разделе объясняется, как применять действия сценариев к работающему кластеру.

### <a name="apply-a-script-action-to-a-running-cluster-from-the-azure-portal"></a>Применение действия сценария в работающем кластере с портала Azure

Перейдите на [портал Azure](https://portal.azure.com).

1. В меню слева выберите **Все службы**.

1. В разделе **АНАЛИТИКА** выберите **Кластеры HDInsight**.

1. Выберите свой кластер в списке. Откроется представление по умолчанию.

1. В представлении по умолчанию в разделе **Параметры** выберите **Действия скрипта**.

1. В верхней части страницы **Действия скрипта** выберите **+ Отправить новое**.

    ![Добавление скрипта в работающий кластер](./media/hdinsight-hadoop-customize-cluster-linux/add-script-running-cluster.png)

4. Используйте запись __Выберите сценарий__, чтобы выбрать готовый сценарий. Чтобы использовать настраиваемый сценарий, выберите __Настраиваемый__. Затем укажите __имя__ и __универсальный код ресурса (URI) Bash-сценария__ своего сценария.

    ![Добавление скрипта в форме выбора скрипта](./media/hdinsight-hadoop-customize-cluster-linux/select-script.png)

    В приведенной ниже таблице описываются элементы формы.

    | Свойство | Значение |
    | --- | --- |
    | Выберите скрипт | Чтобы использовать собственный скрипт, выберите __Настраиваемый__. В противном случае выберите предоставленный скрипт. |
    | Имя |Укажите имя для действия сценария. |
    | URI bash-скрипта |Укажите URI сценария. |
    | Head, Worker или ZooKeeper |Укажите узлы, на которых выполняется сценарий: **Head**, **Worker** или **ZooKeeper** |
    | Параметры |Укажите параметры, если они требуются для сценария. |

    Используйте запись __Сохранить это действие скрипта__, чтобы скрипт применялся при масштабировании.

5. Наконец, нажмите кнопку **Создать**, чтобы применить сценарий к кластеру.

### <a name="apply-a-script-action-to-a-running-cluster-from-azure-powershell"></a>Применение действия сценария в работающем кластере с помощью Azure PowerShell

Чтобы использовать эти команды PowerShell, вам потребуется [AZ модуля](https://docs.microsoft.com/powershell/azure/overview).

Следующий пример демонстрирует применение действия сценария к работающему кластеру:

[!code-powershell[main](../../powershell_scripts/hdinsight/use-script-action/use-script-action.ps1?range=105-117)]

После завершения операции вы получите приблизительно такой текст:

    OperationState  : Succeeded
    ErrorMessage    :
    Name            : Giraph
    Uri             : https://hdiconfigactions.blob.core.windows.net/linuxgiraphconfigactionv01/giraph-installer-v01.sh
    Parameters      :
    NodeTypes       : {HeadNode, WorkerNode}

### <a name="apply-a-script-action-to-a-running-cluster-from-the-azure-cli"></a>Применение действия сценария в работающем кластере с помощью Azure CLI

Перед началом работы убедитесь, что установили и настроили Azure CLI. Дополнительные сведения см. в статье [Установка классического интерфейса командной строки Azure (Azure Classic CLI)](https://docs.microsoft.com/cli/azure/install-classic-cli?view=azure-cli-latest).

[!INCLUDE [classic-cli-warning](../../includes/requires-classic-cli.md)]

1. Переключитесь в режим Azure Resource Manager.

    ```bash
    azure config mode arm
    ```

2. Пройдите аутентификацию в подписке Azure.

    ```bash
    azure login
    ```

3. Примените действие сценария в работающем кластере.

    ```bash
    azure hdinsight script-action create <clustername> -g <resourcegroupname> -n <scriptname> -u <scriptURI> -t <nodetypes>
    ```

    Если параметры для этой команды не заданы, вам будет предложено сделать это. Если сценарий, указанный с помощью `-u`, принимает параметры, их можно задать с помощью параметра `-p`.

    Допустимые типы узлов: `headnode`, `workernode` и `zookeeper`. Если сценарий должен быть применен к нескольким типам узлов, укажите типы, разделив их точкой с запятой `;`. Например, `-n headnode;workernode`.

    Чтобы сохранить сценарий, добавьте `--persistOnSuccess`. Чтобы сохранить скрипт позднее, используйте `azure hdinsight script-action persisted set`.

    После завершения задания вы получите выходные данные следующего вида:

        info:    Executing command hdinsight script-action create
        + Executing Script Action on HDInsight cluster
        data:    Operation Info
        data:    ---------------
        data:    Operation status:
        data:    Operation ID:  b707b10e-e633-45c0-baa9-8aed3d348c13
        info:    hdinsight script-action create command OK

### <a name="apply-a-script-action-to-a-running-cluster-by-using-rest-api"></a>Применение действия сценария в работающем кластере с помощью REST API

Ознакомьтесь со статьей [Cluster REST API in Azure HDInsight](https://msdn.microsoft.com/library/azure/mt668441.aspx) (REST API кластера в Azure HDInsight).

### <a name="apply-a-script-action-to-a-running-cluster-from-the-hdinsight-net-sdk"></a>Применение действия сценария в работающем кластере с помощью пакета SDK HDInsight для .NET

Пример использования пакета SDK для .NET для применения сценариев к кластеру см. в статье [Apply a Script Action against a running Linux-based HDInsight cluster](https://github.com/Azure-Samples/hdinsight-dotnet-script-action) (Применение действия сценариев к работающему кластеру HDInsight на основе Linux).

## <a name="view-history-and-promote-and-demote-script-actions"></a>Представление журнала, повышение уровня и изменение типа действий сценариев

### <a name="the-azure-portal"></a>Портал Azure

1. Войдите на [портале Azure](https://portal.azure.com).

1. В меню слева выберите **Все службы**.

1. В разделе **АНАЛИТИКА** выберите **Кластеры HDInsight**.

1. Выберите свой кластер в списке. Откроется представление по умолчанию.

1. В представлении по умолчанию в разделе **Параметры** выберите **Действия скрипта**.

4. Журнал сценариев для этого кластера отображается в разделе "Действия сценария". Эти сведения включают в себя список сохраняемых скриптов. На следующем снимке экрана показано, что в этом кластере был выполнен сценарий Solr. Сохраняемых сценариев на нем не видно.

    ![Действия сценария](./media/hdinsight-hadoop-customize-cluster-linux/script-action-history.png)

5. При выборе сценария в журнале отображается соответствующий раздел **Панель свойств**. В верхней части экрана можно повторно запустить скрипт или изменить его тип.

    ![Действия сценариев, свойства](./media/hdinsight-hadoop-customize-cluster-linux/promote-script-actions.png)

6. Вы также можете использовать многоточие **…** справа от записей в разделе "Действия сценария" для выполнения действий.

    ![Действия сценариев, многоточие](./media/hdinsight-hadoop-customize-cluster-linux/deletepromoted.png)

### <a name="azure-powershell"></a>Azure PowerShell

| Командлет | Функция |
| --- | --- |
| `Get-AzHDInsightPersistedScriptAction` |Получение сведений о действиях сохраняемого сценария |
| `Get-AzHDInsightScriptActionHistory` |Получение журнала действий сценариев, применяемых в кластере, или сведений о конкретном сценарии. |
| `Set-AzHDInsightPersistedScriptAction` |Повышение уровня специального сценария до сохраняемого. |
| `Remove-AzHDInsightPersistedScriptAction` |Понижение уровня сохраняемого сценария до специального. |

> [!IMPORTANT]  
> При использовании `Remove-AzHDInsightPersistedScriptAction` действия, выполненные сценарием, не отменяются. Этот командлет только удаляет флаг сохранения.

В приведенном ниже примере сценария показано использование командлетов для повышения уровня типа сценария (и наоборот).

[!code-powershell[main](../../powershell_scripts/hdinsight/use-script-action/use-script-action.ps1?range=123-140)]

### <a name="the-azure-classic-cli"></a>Классический интерфейс командной строки Azure

| Командлет | Функция |
| --- | --- |
| `azure hdinsight script-action persisted list <clustername>` |Получение списка сохраняемых действий сценария. |
| `azure hdinsight script-action persisted show <clustername> <scriptname>` |Получение сведений о конкретном сохраняемом действии сценария. |
| `azure hdinsight script-action history list <clustername>` |Получение журнала действий сценария, применяемых в кластере. |
| `azure hdinsight script-action history show <clustername> <scriptname>` |Получение сведений о конкретном действии сценария. |
| `azure hdinsight script action persisted set <clustername> <scriptexecutionid>` |Повышение уровня специального сценария до сохраняемого. |
| `azure hdinsight script-action persisted delete <clustername> <scriptname>` |Понижение уровня сохраняемого сценария до специального. |

> [!IMPORTANT]  
> При использовании `azure hdinsight script-action persisted delete` действия, выполненные сценарием, не отменяются. Этот командлет только удаляет флаг сохранения.

### <a name="the-hdinsight-net-sdk"></a>Пакет SDK для HDInsight .NET

Пример использования пакета SDK для .NET для получения журнала сценариев из кластера, повышения или понижения уровня сценариев см. в статье [Apply a Script Action against a running Linux-based HDInsight cluster](https://github.com/Azure-Samples/hdinsight-dotnet-script-action) (Применение действия сценариев к работающему кластеру HDInsight на основе Linux).

> [!NOTE]  
> В этом примере также показано, как установить приложение HDInsight с помощью пакета SDK для .NET.

## <a name="support-for-open-source-software-used-on-hdinsight-clusters"></a>Поддержка программного обеспечения с открытым исходным кодом, используемого в кластере HDInsight

Служба Microsoft Azure HDInsight использует сформированную вокруг Apache Hadoop экосистему технологий с открытым кодом. Microsoft Azure предоставляет общий уровень поддержки для технологий с открытым исходным кодом. Дополнительные сведения см. в разделе, посвященном **области действия поддержки**, на [веб-сайте с часто задаваемыми вопросами о поддержке Azure](https://azure.microsoft.com/support/faq/). Служба HDInsight предоставляет дополнительный уровень поддержки для встроенных компонентов.

В службе HDInsight доступно два типа компонентов с открытым кодом.

* **Встроенные компоненты**. Эти компоненты предварительно установлены в кластерах HDInsight и предоставляют его базовые функциональные возможности. К этой категории относятся следующие компоненты:

  * Диспетчер ресурсов [Apache Hadoop YARN](https://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/YARN.html).
  * Язык запросов Hive [HiveQL](https://cwiki.apache.org/confluence/display/Hive/LanguageManual).
  * [Apache Mahout](https://mahout.apache.org/). 
    
    Полный список компонентов кластера доступен в статье [Что представляют собой компоненты и версии Apache Hadoop, доступные в HDInsight?](hdinsight-component-versioning.md).

* **Настраиваемые компоненты.** Как пользователь кластера вы можете установить или использовать в рабочей нагрузке любой компонент, полученный из сообщества или созданный самостоятельно.

> [!WARNING]  
> Компоненты, поставляемые с кластером HDInsight, полностью поддерживаются. Служба поддержки Майкрософт помогает выявлять и устранять проблемы, связанные с этими компонентами.
>
> Настраиваемые компоненты получают ограниченную, коммерчески оправданную поддержку, способствующую дальнейшему устранению неполадок. Эту проблему может решить служба поддержки Майкрософт. Вас могут попросить воспользоваться доступными каналами по технологиям с открытым кодом, чтобы связаться с экспертами в данной области. Вы можете использовать ряд сайтов сообществ, например [форум MSDN по HDInsight](https://social.msdn.microsoft.com/Forums/azure/home?forum=hdinsight) и [Stack Overflow](https://stackoverflow.com). 
>
> Для проектов Apache также имеются соответствующие сайты, указанные на [веб-сайте Apache](https://apache.org). Например, [Hadoop](https://hadoop.apache.org/).

Служба HDInsight позволяет использовать настраиваемые компоненты несколькими разными способами. Уровень поддержки не зависит от того, как компонент используется или устанавливается в кластере. Ниже приведен список самых распространенных способов использования настраиваемых компонентов в кластерах HDInsight.

1. **Отправка задания.** В кластере можно отправлять задания Hadoop или другие типы заданий, выполняющие или использующие настраиваемые компоненты.

2. **Настройка кластера.** Во время создания кластера можно указать дополнительные параметры и настраиваемые компоненты, устанавливаемые на узлах кластера.

3. **Примеры.** Корпорация Майкрософт и другие компании могут предоставлять примеры использования популярных настраиваемых компонентов в кластерах HDInsight. Эти примеры представляются без поддержки.

## <a name="troubleshooting"></a>Устранение неполадок

Вы можете использовать веб-интерфейс Ambari для просмотра сведений, регистрируемых действиями сценариев. Если при создании кластера произошел сбой скрипта, вы можете просмотреть журналы в учетной записи хранения по умолчанию, связанной с кластером. Этот раздел содержит сведения о том, как получить журналы обоими этими способами.

### <a name="the-apache-ambari-web-ui"></a>Веб-интерфейс Apache Ambari

1. В браузере перейдите по адресу https://CLUSTERNAME.azurehdinsight.net. Замените **CLUSTERNAME** именем кластера HDInsight.

    При появлении запроса введите имя, **admin**, и пароль учетной записи администратора кластера. Возможно, вам потребуется повторно ввести учетные данные администратора в веб-форме.

2. В панели вверху страницы выберите запись **ops**. Появится список текущих и предыдущих операций, выполняемых в кластере с помощью Ambari.

    ![Веб-панель Ambari с выбранной записью ops](./media/hdinsight-hadoop-customize-cluster-linux/ambari-nav.png)

3. Найдите записи, для которых в столбце **Операции** указано **run\_customscriptaction**. Такие записи создаются при выполнении действий сценариев.

    ![Снимок экрана операций](./media/hdinsight-hadoop-customize-cluster-linux/ambariscriptaction.png)

    Для просмотра выходных данных **STDOUT** и **STDERR** выберите запись **run\customscriptaction** и перейдите по ссылкам. Эти выходные данные формируются при запуске сценария и могут содержать полезные сведения.

### <a name="access-logs-from-the-default-storage-account"></a>Доступ к журналам из учетной записи хранения по умолчанию

Если из-за ошибки сценария при создании кластера происходит сбой, журналы сохраняются в учетной записи хранения кластера.

* Журналы хранилища находятся в `\STORAGE_ACCOUNT_NAME\DEFAULT_CONTAINER_NAME\custom-scriptaction-logs\CLUSTER_NAME\DATE`.

    ![Снимок экрана операций](./media/hdinsight-hadoop-customize-cluster-linux/script_action_logs_in_storage.png)

    В этом каталоге журналы упорядочены по **головному узлу**, **рабочему узлу** и **узлу zookeeper**. Рассмотрим следующие примеры:

    * **Головной узел**: `<uniqueidentifier>AmbariDb-hn0-<generated_value>.cloudapp.net`

    * **Рабочий узел**: `<uniqueidentifier>AmbariDb-wn0-<generated_value>.cloudapp.net`

    * **Узел Zookeeper**: `<uniqueidentifier>AmbariDb-zk0-<generated_value>.cloudapp.net`

* Все **stdout** и **stderr** соответствующего узла передаются в учетную запись хранения. Для каждого действия сценария создается файл **output-\*.txt** и файл **errors-\*.txt**. Файл **output-*.txt** содержит сведения об URI сценария, запущенном на узле. Ниже приведен пример таких сведений:

        'Start downloading script locally: ', u'https://hdiconfigactions.blob.core.windows.net/linuxrconfigactionv01/r-installer-v01.sh'

* Возможно, повторно создан кластер действия сценария с тем же именем. В этом случае соответствующие журналы можно отличить по имени папки **DATE**. Например, структура папок для кластера **mycluster**, созданного в другие дни, будет похожа на следующие записи журнала:

    `\STORAGE_ACCOUNT_NAME\DEFAULT_CONTAINER_NAME\custom-scriptaction-logs\mycluster\2015-10-04` `\STORAGE_ACCOUNT_NAME\DEFAULT_CONTAINER_NAME\custom-scriptaction-logs\mycluster\2015-10-05`

* При создании кластера действие сценария с таким же именем в тот же день можно использовать уникальный префикс для идентификации соответствующих файлов журнала.

* При создании кластера около полуночи (00:00) файлы журналов могут включать сведения за два дня. В таких случаях для одного кластера будут отображаться две разные папки даты.

* Передача файлов журнала в контейнер по умолчанию может занять до пяти минут, особенно для больших кластеров. Таким образом, если вы хотите получить доступ к журналам, не следует немедленно удалять кластер при сбое действия сценария.

### <a name="ambari-watchdog"></a>Модуль наблюдения Ambari

> [!WARNING]  
> Не изменяйте пароль модуля наблюдения Ambari (hdinsightwatchdog) в кластере HDInsight под управлением Linux. Это не позволит выполнять новые действия сценария в кластере HDInsight.

### <a name="cant-import-name-blobservice"></a>Не удается импортировать BlobService имени

__Симптомы.__ Сбой действия скрипта. При просмотре операции в Ambari выводится следующее сообщение об ошибке:

```
Traceback (most recent call list):
  File "/var/lib/ambari-agent/cache/custom_actions/scripts/run_customscriptaction.py", line 21, in <module>
    from azure.storage.blob import BlobService
ImportError: cannot import name BlobService
```

__Причина__. Эта ошибка возникает при обновлении клиента Python службы хранилища Azure, который входит в состав кластера HDInsight. HDInsight требуется клиент службы хранилища Azure версии 0.20.0.

__Способы устранения__. Чтобы устранить эту ошибку, вручную подключитесь к каждому узлу кластера с помощью `ssh`. Выполните следующую команду, чтобы повторно установить требуемую версию клиента хранилища:

```bash
sudo pip install azure-storage==0.20.0
```

Сведения о подключении к кластеру по протоколу SSH см. в статье [Подключение к HDInsight (Apache Hadoop) с помощью SSH](hdinsight-hadoop-linux-use-ssh-unix.md).

### <a name="history-doesnt-show-the-scripts-used-during-cluster-creation"></a>Журнал не отображает сценарии, используемые во время создания кластера

Если кластер создан до 15 марта 2016 г., в журнале действий сценариев могут отсутствовать записи. При изменении размера кластера сценарии фиксируются в журнале действий сценариев.

Есть два исключения.

* Кластер создан до 1 сентября 2015 г. Это дата добавления действий сценариев. Если кластер был создан раньше, действия сценариев не могли использоваться при его создании.

* При создании кластера использовано несколько действий сценариев одновременно. Вы использовали или одно и то же имя для разных сценариев, или одно и то же имя и URI, но разные параметры для разных сценариев. В таких случаях происходит следующая ошибка:

    Из-за конфликта имен имеющихся сценариев в этом кластере не будут выполняться новые действия сценариев. Имена сценариев, указанные при создании кластера, должны быть уникальными. Имеющиеся сценарии выполняются при изменении размера.

## <a name="next-steps"></a>Следующие шаги

* [Разработка действий сценариев с помощью HDInsight](hdinsight-hadoop-script-actions-linux.md)
* [Установка и использование Apache Giraph в кластерах HDInsight](hdinsight-hadoop-giraph-install-linux.md)
* [Добавление дополнительных учетных записей хранения Azure в HDInsight](hdinsight-hadoop-add-storage.md)

[img-hdi-cluster-states]: ./media/hdinsight-hadoop-customize-cluster-linux/HDI-Cluster-state.png "Этапы создания кластера"
