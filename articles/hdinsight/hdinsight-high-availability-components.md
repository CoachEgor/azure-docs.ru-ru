---
title: Компоненты высокой доступности в Azure HDInsight
description: Обзор различных компонентов высокой доступности, используемых кластерами HDInsight.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.date: 11/11/2019
ms.openlocfilehash: 38fb45fd339b5e2c7cab6f66a1ed6c0df73fb29e
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74069629"
---
# <a name="high-availability-services-supported-by-azure-hdinsight"></a>Услуги высокой доступности, поддерживаемые Azure HDInsight

 Для того, чтобы обеспечить оптимальный уровень доступности компонентов аналитики, HDInsight был разработан с уникальной архитектурой для обеспечения высокой доступности (HA) критически важных услуг. Некоторые компоненты этой архитектуры были разработаны корпорацией Майкрософт для автоматического сбоя. Другими компонентами являются стандартные компоненты Apache, которые развертываются для поддержки конкретных служб. В этой статье объясняется архитектура модели службы HA в HDInsight, как HDInsight поддерживает отказ для служб HA, а также рекомендации по восстановлению после других перерывов служб.

## <a name="high-availability-infrastructure"></a>Инфраструктура высокой доступности

HDInsight предоставляет персонализированную инфраструктуру, чтобы гарантировать, что четыре основные службы имеют высокую доступность с автоматическими возможностями сбоя:

- Сервер Apache Ambari
- Сервер времени приложения для Apache YARN
- Сервер истории работы для Hadoop MapReduce
- Apache Livy

Эта инфраструктура состоит из ряда служб и компонентов программного обеспечения, некоторые из которых разработаны корпорацией Майкрософт. Следующие компоненты уникальны для платформы HDInsight:

- Контроллер невольничьего сбоя
- Мастер контроллер аксовера
- Услуги по предоставлению услуг с высокой доступностью рабов
- Мастер высокой доступности службы

![инфраструктура высокой доступности](./media/hdinsight-high-availability-components/high-availability-architecture.png)

Существуют также другие службы высокой доступности, которые поддерживаются компонентами надежности Apache с открытым исходным кодом. Эти компоненты также присутствуют на кластерах HDInsight:

- Hadoop файловой системы (HDFS) NameNode
- YARN ResourceManager
- HBase Мастер

В следующих разделах будет приведена более подробная информация о том, как эти службы работают вместе.

## <a name="hdinsight-high-availability-services"></a>Услуги высокой доступности HDInsight

Корпорация Майкрософт предоставляет поддержку четырем службам Apache в следующей таблице кластеров HDInsight. Чтобы отличить их от служб высокой доступности, поддерживаемых компонентами из Apache, они называются *службами HDInsight HA.*

| Служба | Узлы кластера | Типы кластера | Назначение |
|---|---|---|---|
| Сервер Apache Ambari| Активный головной нод | All | Контролирует и управляет кластером.|
| Сервер времени приложения для Apache YARN | Активный головной нод | Все, кроме Кафки | Поддерживает отладку информации о заданиях YARN, работающих в кластере.|
| Сервер истории работы для Hadoop MapReduce | Активный головной нод | Все, кроме Кафки | Поддерживает отладку данных для задания MapReduce.|
| Apache Livy | Активный головной нод | Spark | Обеспечивает легкое взаимодействие с кластером Spark через интерфейс REST |

>[!Note]
> Кластеры HDInsight Enterprise Security Package (ESP) в настоящее время обеспечивают только высокую доступность сервера Ambari.

### <a name="architecture"></a>Architecture

Каждый кластер HDInsight имеет два headnodes в активном и резервном режимах, соответственно. Службы HDInsight HA работают только на headnodes. Эти службы всегда должны работать на активном головном ноде, а также останавливаться и внедравливать в режим обслуживания на резервном головном уходе.

Для поддержания правильного состояния услуг HA и обеспечения быстрого сбоя, HDInsight использует Apache зоопарк, который является координационным сервисом для распределенных приложений, для проведения активных выборов headnode. HDInsight также предусматривает несколько фоновых Java-процессов, которые координируют процедуру отказа для служб HDInsight HA. Эти услуги являются следующими: мастер failover контроллер, раб failover контроллер, *мастер-ха-сервис*, и *раб-ха-сервис*.

### <a name="apache-zookeeper"></a>Апач Зоозащитник

Apache зооkeeper является высокопроизводительной координационной службой для распределенных приложений. В производственном составе, как правило, работает в реплицируемом режиме, где реплицированная группа серверов зоозащитника образует кворум. Каждый кластер HDInsight имеет три узла зоопарка, которые позволяют трем серверам зоозащитника образовывать кворум. HDInsight имеет два кворума зоозащитника, работающих параллельно друг с другом. Один кворум определяет активный головной ноздобой в кластере, на котором должны работать службы HDInsight HA. Другой кворум используется для координации услуг HA, предоставляемых Apache, как описано в более поздних разделах.

### <a name="slave-failover-controller"></a>Контроллер невольничьего сбоя

Контроллер сбоя раба работает на каждом узлах в кластере HDInsight. Этот контроллер отвечает за запуск агента Ambari и *раб-ха-сервис* на каждом узлах. Он периодически запрашивает первый кворум ЗооKeeper об активном головном ноде. При изменении активных и резервных headnodes, контроллер сбоя раба выполняет следующее:

1. Обновляет файл конфигурации хоста.
1. Перезапускает агента Амбари.

*Служба работорговли* несет ответственность за остановку служб HDInsight HA (кроме сервера Ambari) на резервном головном уходе.

### <a name="master-failover-controller"></a>Мастер контроллер аксовера

Контроллер мастер-неудачи работает на обоих головных узлах. Оба контроллера-мастера общаются с первым кворумом Зооkeeper, чтобы назначить головной нод, на который они работают в качестве активного головного нода.

Например, если мастер-контроллер failover на headnode 0 выигрывает выборы, происходят следующие изменения:

1. Headnode 0 становится активным.
1. Контроллер master failover запускает сервер Ambari и *мастер-ха-сервис* на headnode 0.
1. Другой контроллер сотказа останавливает сервер Ambari и *мастер-ха-сервис* на headnode 1.

Мастер-ха-сервис работает только на активном headnode, он останавливает услуги HDInsight HA (кроме сервера Ambari) на резервном головном уде и запускает их на активном headnode.

### <a name="the-failover-process"></a>Процесс сбоя

![Процесс отработки отказа](./media/hdinsight-high-availability-components/failover-steps.png)

Монитор работоспособности работает на каждом головном ноде вместе с контроллером сотказа мастером для отправки уведомлений о слухах в кворум зоозащитника. Головной ноздоль рассматривается как услуга HA в этом сценарии. Монитор работоспособности проверяет, является ли каждая служба доступности работоспособной и готова ли она принять участие в выборах руководства. Если да, то этот головной нод будет участвовать в выборах. В противном случае она покинет выборы до тех пор, пока не будет готова снова.

Если резервный headnode когда-либо достигает лидерства и становится активным (например, в случае сбоя с предыдущим активным узлом), его контроллер master failover запустит все службы HDInsight HA на нем. Контроллер master failover также остановит эти службы на другом headnode.

При сбоях службы HDInsight HA, таких как отказ службы или неработоспособный, контроллер сбоя master должен автоматически перезапускать или останавливать службы в соответствии со статусом headnode. Пользователи не должны вручную запускать службы HDInsight HA на обоих головных узлах. Вместо этого, позвольте автоматическому или ручному отказу, чтобы помочь службе восстановиться.

### <a name="inadvertent-manual-intervention"></a>Непреднамеренное ручное вмешательство

Службы HDInsight HA должны работать только на активном головном уде, и при необходимости автоматически перезапускаться. Поскольку отдельные службы HA не имеют собственного монитора работоспособности, сбой не может быть запущен на уровне индивидуальной службы. Failover обеспечивается на уровне узла, а не на уровне обслуживания.

### <a name="some-known-issues"></a>Некоторые известные проблемы

- При ручном запуске службы HA на резервном головном уходе он не остановится до тех пор, пока не произойдет следующий сбой. Когда услуги HA работают на обоих headnodes, некоторые потенциальные проблемы включают в себя: Ambari UI недоступен, Ambari бросает ошибки, YARN, Spark, и Oozie рабочих мест может застрять.

- Когда служба HA на активном headnode останавливается, она не будет перезапускаться до следующего сбоя или перезапуска контроллера сбоя/мастера-ха-сервиса. Когда одна или несколько служб HA останавливаются на активном головном уде, особенно когда сервер Ambari останавливается, интерфейс Ambari недоступен, другие потенциальные проблемы включают сбои в работе YARN, Spark и Oozie.

## <a name="apache-high-availability-services"></a>Услуги высокой доступности Apache

Apache обеспечивает высокую доступность для HDFS NameNode, YARN ResourceManager и HBase Master, которые также доступны в кластерах HDInsight. В отличие от служб HDInsight HA, они поддерживаются в кластерах ESP. Службы Apache HA взаимодействуют со вторым кворумом Зоотера (описанным в вышеуказанном разделе) для избрания активных/резервных состояний и автоматического сбоя. В следующих разделах подробно описывается, как работают эти службы.

### <a name="hadoop-distributed-file-system-hdfs-namenode"></a>Hadoop Распределенная файловая система (HDFS) NameNode

Кластеры HDInsight на основе Apache Hadoop 2.0 или выше обеспечивают высокую доступность NameNode. На headnodes работают два NameNodes, которые настроены для автоматического сбоя. NameNodes используют *«KFailoverController»* для связи с зоозащитником, чтобы избрать активный/резервный статус. *«KFailoverController»* работает на обоих headnodes и работает так же, как и контроллер сотказа выше.

Второй кворум зоозащитника не зависит от первого кворума, поэтому активный NameNode не может работать на активном головном ноде. Когда активный NameNode мертв или нездоров, резервный NameNode выигрывает выборы и становится активным.

### <a name="yarn-resourcemanager"></a>YARN ResourceManager

Кластеры HDInsight на основе Apache Hadoop 2.4 или выше поддерживают высокую доступность YARN ResourceManager. Есть два ResourceManagers, rm1 и rm2, работает на headnode 0 и headnode 1, соответственно. Как и NameNode, YARN ResourceManager также настроен для автоматического сбоя. Другой Менеджер ресурсов автоматически выбирается для активной работы, когда текущий активный Менеджер ресурсов выходит из оборота или не отвечает.

YARN ResourceManager использует встроенный *ActiveStandbyElector* в качестве детектора отказов и лидера. В отличие от HDFS NameNode, YARN ResourceManager не нуждается в отдельном daemon. Активный ResourceManager записывает свои состояния в зоозащиту Apache.

Высокая доступность YARN ResourceManager не зависит от NameNode и других услуг HDInsight HA. Активный Менеджер ресурсов не может работать на активном головном ноде или головном ноде, где работает активный NameNode. Для получения дополнительной информации о высокой [доступности YARN](https://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/ResourceManagerHA.html)ResourceManager см.

### <a name="hbase-master"></a>HBase Мастер

Кластеры HDInsight HBase поддерживают высокую доступность HBase Master. В отличие от других сервисов HA, которые работают на headnodes, HBase Masters работает на трех узлах зоозащитника, где один из них является активным мастером, а два других находятся в режиме ожидания. Как nameNode, HBase Master координирует с Apache Зоозащитник для избрания лидера и делает автоматический отказ, когда текущий активный мастер имеет проблемы. Существует только один активный HBase Master в любое время.

## <a name="next-steps"></a>Дальнейшие действия

- [Доступность и надежность кластеров Apache Hadoop в HDInsight](hdinsight-high-availability-linux.md)
- [Виртуальная сетевая архитектура Azure HDInsight](hdinsight-virtual-network-architecture.md)
