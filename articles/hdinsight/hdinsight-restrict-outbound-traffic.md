---
title: Настройка ограничения исходящего сетевого трафика в Azure HDInsight
description: Узнайте, как настроить ограничение исходящего сетевого трафика для кластеров Azure HDInsight.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.custom: seoapr2020
ms.date: 04/17/2020
ms.openlocfilehash: eaf51f6778d38d236808c3fd809082bc3b2d54b2
ms.sourcegitcommit: 602e6db62069d568a91981a1117244ffd757f1c2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2020
ms.locfileid: "82863439"
---
# <a name="configure-outbound-network-traffic-for-azure-hdinsight-clusters-using-firewall"></a>Настройка исходящего сетевого трафика для кластеров Azure HDInsight с помощью брандмауэра

В этой статье приведены инструкции по защите исходящего трафика из кластера HDInsight с помощью брандмауэра Azure. В описанных ниже действиях предполагается, что вы настраиваете брандмауэр Azure для существующего кластера. При развертывании нового кластера за брандмауэром сначала создайте кластер HDInsight и подсеть. Затем выполните действия, описанные в этом руководстве.

## <a name="background"></a>Историческая справка

Кластеры HDInsight обычно развертываются в виртуальной сети. Кластер имеет зависимости от служб, находящихся за пределами этой виртуальной сети.

Существует несколько зависимостей, требующих входящего трафика. Входящий трафик управления не может быть отправлен через устройство брандмауэра. Исходные адреса для этого трафика известны и публикуются [здесь](hdinsight-management-ip-addresses.md). Вы также можете создать правила группы безопасности сети (NSG) с этими сведениями для защиты входящего трафика к кластерам.

Зависимости исходящего трафика HDInsight практически полностью определяются с помощью полных доменных имен. Которые не имеют статических IP-адресов. Отсутствие статических адресов означает, что группы безопасности сети (группы безопасности сети) не могут блокировать исходящий трафик из кластера. Часто изменение адресов достаточно для того, чтобы настроить правила на основе текущего разрешения имен и использования.

Обеспечьте безопасность исходящих адресов с помощью брандмауэра, который может управлять исходящим трафиком на основе доменных имен. Брандмауэр Azure запрещает исходящий трафик на основе полного доменного имени в тегах назначения или [полного доменного имени](../firewall/fqdn-tags.md).

## <a name="configuring-azure-firewall-with-hdinsight"></a>Настройка брандмауэра Azure с помощью HDInsight

Ниже приведена сводка действий по блокировке исходящих данных из существующего HDInsight с помощью брандмауэра Azure.

1. Создайте подсеть.
1. Создайте брандмауэр.
1. Добавление правил приложения в брандмауэр
1. Добавьте сетевые правила в брандмауэр.
1. Создайте таблицу маршрутизации.

### <a name="create-new-subnet"></a>Создание новой подсети

Создайте подсеть с именем **азурефиреваллсубнет** в виртуальной сети, где существует кластер.

### <a name="create-a-new-firewall-for-your-cluster"></a>Создание нового брандмауэра для кластера

Создайте брандмауэр с именем **Test-FW01** , выполнив действия, описанные в руководстве по **развертыванию брандмауэра** [. Развертывание и настройка брандмауэра Azure с помощью портал Azure](../firewall/tutorial-firewall-deploy-portal.md#deploy-the-firewall).

### <a name="configure-the-firewall-with-application-rules"></a>Настройка брандмауэра с помощью правил приложения

Создайте коллекцию правил приложений, которая позволяет кластеру отправлять и получать важные коммуникации.

1. Выберите новый брандмауэр **Test-FW01** из портал Azure.

1. Последовательно выберите **Параметры** > **правила** > **Приложение коллекция** > правил приложения **+ Добавить коллекцию правил приложения**.

    ![Title: Добавление коллекции правил приложения](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-app-rule-collection.png)

1. На экране **Добавление коллекции правил приложений** укажите следующие сведения.

    **Верхний раздел**

    | Свойство.|  Значение|
    |---|---|
    |Имя| фваппруле|
    |Приоритет|200|
    |Действие|Allow|

    **Раздел "Теги полного доменного имени"**

    | Имя | Исходный адрес | Тег FQDN | Примечания |
    | --- | --- | --- | --- |
    | Rule_1 | * | WindowsUpdate и HDInsight | Требуется для HDI Services |

    **Раздел полных доменных имен**

    | Имя | Исходные адреса | `Protocol:Port` | Целевые полные доменные имена | Примечания |
    | --- | --- | --- | --- | --- |
    | Rule_2 | * | HTTPS: 443 | login.windows.net | Разрешает действие входа Windows |
    | Rule_3 | * | HTTPS: 443 | login.microsoftonline.com | Разрешает действие входа Windows |
    | Rule_4 | * | HTTPS: 443, http: 80 | storage_account_name. BLOB. Core. Windows. NET | Замените `storage_account_name` фактическим именем учетной записи хранения. Если кластер создается с помощью WASB, добавьте правило для WASB. Чтобы использовать только HTTPS-подключения, убедитесь, что в учетной записи хранения включено ["требуется безопасное перемещение"](../storage/common/storage-require-secure-transfer.md) . |

   ![Title: введите сведения о коллекции правил приложения](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-app-rule-collection-details.png)

1. Выберите **Добавить**.

### <a name="configure-the-firewall-with-network-rules"></a>Настройка брандмауэра с помощью сетевых правил

Создайте сетевые правила для правильной настройки кластера HDInsight.

1. Продолжая с предыдущих шагов, перейдите > к **коллекции правил сети****и добавьте коллекцию правил сети**.

1. На экране **Добавить коллекцию правил сети** укажите следующие сведения.

    **Верхний раздел**

    | Свойство.|  Значение|
    |---|---|
    |Имя| фвнетруле|
    |Приоритет|200|
    |Действие|Allow|

    **Раздел IP-адресов**

    | Имя | Протокол | Исходные адреса | Адреса назначения | Конечные порты | Примечания |
    | --- | --- | --- | --- | --- | --- |
    | Rule_1 | UDP | * | * | 123 | Служба времени |
    | Rule_2 | Любой | * | DC_IP_Address_1, DC_IP_Address_2 | * | Если вы используете Корпоративный пакет безопасности (ESP), добавьте сетевое правило в раздел IP-адресов, который позволяет обмениваться данными с кластерами AAD-DS для ESP. IP-адреса контроллеров домена можно найти в разделе AAD-DS на портале. |
    | Rule_3 | TCP | * | IP-адрес учетной записи Data Lake Storage | * | Если вы используете Azure Data Lake Storage, можно добавить сетевое правило в раздел IP-адресов, чтобы устранить проблемы SNI с ADLS 1-го поколения и Gen2. Этот параметр направит трафик в брандмауэр. Это может привести к увеличению затрат на загрузку больших данных, но в журнале брандмауэра будет регистрироваться и подвергаться аудиту трафик. Определите IP-адрес для учетной записи Data Lake Storage. Вы можете использовать команду PowerShell, например, `[System.Net.DNS]::GetHostAddresses("STORAGEACCOUNTNAME.blob.core.windows.net")` чтобы разрешить полное доменное имя в IP-адрес.|
    | Rule_4 | TCP | * | * | 12000 | Используемых Если вы используете Log Analytics, создайте сетевое правило в разделе IP-адреса, чтобы обеспечить взаимодействие с рабочей областью Log Analytics. |

    **Раздел "Теги служб"**

    | Имя | Протокол | Исходные адреса | Теги служб | Порты назначения | Примечания |
    | --- | --- | --- | --- | --- | --- |
    | Rule_7 | TCP | * | SQL | 1433 | Настройте правило сети в разделе "Теги служб" для SQL, который позволит вести журнал и выполнять аудит трафика SQL. Если вы не настроили конечные точки службы для SQL Server в подсети HDInsight, что приведет к обходу брандмауэра. |

   ![Title: введите коллекцию правил приложения.](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-network-rule-collection.png)

1. Выберите **Добавить**.

### <a name="create-and-configure-a-route-table"></a>Создание и настройка таблицы маршрутов

Создайте таблицу маршрутов со следующими записями:

* Все IP-адреса из [служб работоспособности и управления: все регионы](../hdinsight/hdinsight-management-ip-addresses.md#health-and-management-services-all-regions) с типом " **Интернет**" следующего прыжка.

* Два IP-адреса для региона, в котором кластер создается из [служб работоспособности и управления: в конкретных регионах](../hdinsight/hdinsight-management-ip-addresses.md#health-and-management-services-specific-regions) , имеющих тип " **Интернет**" следующего прыжка.

* Один виртуальный маршрут виртуального устройства для IP-адреса 0.0.0.0/0 со следующим прыжком к частному IP-адресу брандмауэра Azure.

Например, чтобы настроить таблицу маршрутов для кластера, созданного в регионе US (Восточная часть США), выполните следующие действия.

1. Выберите свой брандмауэр Azure **Test-FW01**. Скопируйте **частный IP-адрес** , указанный на странице **Обзор** . В этом примере мы будем использовать **Пример адреса 10.0.2.4**.

1. Затем перейдите к разделу **все службы** > **Сетевые подключения** > **таблицы маршрутов** и **Создайте таблицу маршрутов**.

1. В новом маршруте последовательно выберите **Параметры** > **маршруты** > **+ Добавить**. Добавьте следующие маршруты:

| Имя маршрута | Префикс адреса | Тип следующего прыжка | Адрес следующего прыжка |
|---|---|---|---|
| 168.61.49.99 | 168.61.49.99/32 | Internet | Н/Д |
| 23.99.5.239 | 23.99.5.239/32 | Internet | Н/Д |
| 168.61.48.131 | 168.61.48.131/32 | Internet | Н/Д |
| 138.91.141.162 | 138.91.141.162/32 | Internet | Н/Д |
| 13.82.225.233 | 13.82.225.233/32 | Internet | Н/Д |
| 40.71.175.99 | 40.71.175.99/32 | Internet | Н/Д |
| 0.0.0.0 | 0.0.0.0/0 | Виртуальный модуль | 10.0.2.4 |

Завершите настройку таблицы маршрутов:

1. Назначьте созданную таблицу маршрутов в подсети HDInsight, выбрав **подсети** в разделе **Параметры**.

1. Выберите **+ сопоставить**.

1. На экране **связать подсеть** выберите виртуальную сеть, в которую был создан кластер. И **подсеть** , которая использовалась для кластера HDInsight.

1. Нажмите кнопку **ОК**.

## <a name="edge-node-or-custom-application-traffic"></a>Трафик краевого узла или пользовательского приложения

Описанные выше действия позволят кластеру действовать без проблем. По-прежнему необходимо настроить зависимости для размещения пользовательских приложений, работающих на граничных узлах (если применимо).

Зависимости приложений должны быть идентифицированы и добавлены в брандмауэр Azure или таблицу маршрутов.

Необходимо создать маршруты для трафика приложения, чтобы избежать проблем с маршрутизацией.

Если у ваших приложений есть другие зависимости, их необходимо добавить в брандмауэр Azure. Создайте правила приложения, чтобы разрешать трафик протокола HTTP/HTTPS, и правила сети для всего остального.

## <a name="logging-and-scale"></a>Ведение журнала и масштабирование

Брандмауэр Azure может отправить журналы в несколько различных систем хранения. Инструкции по настройке ведения журнала для брандмауэра см. в разделе Учебник. [мониторинг журналов и метрик брандмауэра Azure](../firewall/tutorial-diagnostics.md).

После завершения настройки ведения журнала, если вы используете Log Analytics, можно просмотреть заблокированный трафик с помощью запроса, например:

```Kusto
AzureDiagnostics | where msg_s contains "Deny" | where TimeGenerated >= ago(1h)
```

Интеграция брандмауэра Azure с журналами Azure Monitor полезна при первом получении приложения. Особенно если вы не знаете обо всех зависимостях приложения. См. дополнительные сведения о журналах Azure Monitor в статье [Анализ данных журнала в Azure Monitor](../azure-monitor/log-query/log-query-overview.md)

Дополнительные сведения об ограничениях масштабирования в брандмауэре Azure и увеличении запросов см. в [этом](../azure-resource-manager/management/azure-subscription-service-limits.md#azure-firewall-limits) документе или на [часто задаваемые вопросы](../firewall/firewall-faq.md).

## <a name="access-to-the-cluster"></a>Доступ к кластеру

После успешной настройки брандмауэра можно использовать внутреннюю конечную точку (`https://CLUSTERNAME-int.azurehdinsight.net`) для доступа к Ambari из виртуальной сети.

Чтобы использовать общедоступную конечную точку (`https://CLUSTERNAME.azurehdinsight.net`) или`CLUSTERNAME-ssh.azurehdinsight.net`конечную точку SSH (), убедитесь в наличии правильных маршрутов в таблице маршрутов и правилах NSG, чтобы избежать описанных [здесь](../firewall/integrate-lb.md)проблем с асимметричной маршрутизацией. В частности, в этом случае необходимо разрешить IP-адрес клиента в правилах входящего NSG, а также добавить его в определяемую пользователем таблицу маршрутов со следующим прыжком, равным `internet`. Если маршрутизация настроена неправильно, вы увидите ошибку времени ожидания.

## <a name="next-steps"></a>Дальнейшие действия

* [Архитектура виртуальной сети Azure HDInsight](hdinsight-virtual-network-architecture.md)
* [Настройка сетевого виртуального устройства](./network-virtual-appliance.md)