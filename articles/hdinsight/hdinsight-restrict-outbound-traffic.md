---
title: Настройка ограничения исходящего сетевого трафика — Azure HDInsight
description: Узнайте, как настроить ограничения исходящего сетевого трафика для кластеров Azure HDInsight.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: how-to
ms.custom: seoapr2020
ms.date: 04/17/2020
ms.openlocfilehash: f87c3665f558b3185e95b0ad0aa18a883439a221
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "87006523"
---
# <a name="configure-outbound-network-traffic-for-azure-hdinsight-clusters-using-firewall"></a>Настройка исходящего сетевого трафика для кластеров Azure HDInsight с помощью брандмауэра

В этой статье приведены инструкции по защите исходящего трафика из кластера HDInsight с помощью Брандмауэра Azure. В описанных ниже действиях предполагается, что вы настраиваете Брандмауэр Azure для существующего кластера. При развертывании нового кластера за брандмауэром сначала создайте кластер HDInsight и подсеть. Затем выполните шаги, приведенные в этом руководстве.

## <a name="background"></a>Историческая справка

Кластеры HDInsight обычно развертываются в виртуальной сети. Кластер имеет зависимости от служб, находящихся за пределами этой виртуальной сети.

Существует несколько зависимостей, требующих входящего трафика. Входящий трафик управления невозможно отправлять через устройство брандмауэра. Исходные адреса для этого трафика известны и опубликованы [здесь](hdinsight-management-ip-addresses.md). Используя эту информацию, также можно создать группу безопасности сети, которая защитит входящий трафик в кластеры.

Зависимости исходящего трафика HDInsight практически полностью определяются с помощью полных доменных имен. Они не связаны со статическими IP-адресами. Отсутствие статических адресов означает, что для блокировки исходящего из кластера трафика нельзя использовать группу безопасности сети. Адреса часто меняются, поэтому создать правила, основанные на текущем разрешении, и использовать их невозможно.

Обеспечьте безопасность исходящих адресов с помощью брандмауэра, который может управлять исходящим трафиком на основе доменных имен. Брандмауэр Azure может ограничить исходящий трафик на основе полного доменного имени назначения или [тегов FQDN](../firewall/fqdn-tags.md).

## <a name="configuring-azure-firewall-with-hdinsight"></a>Настройка Брандмауэра Azure с помощью HDInsight

Шаги по блокировке исходящего трафика существующего HDInsight с помощью Брандмауэра Azure:

1. Создайте подсеть.
1. Создайте брандмауэр.
1. Добавьте правила приложения в брандмауэр.
1. Добавьте правила сети в брандмауэр.
1. Создайте таблицу маршрутизации.

### <a name="create-new-subnet"></a>Создание подсети

Создайте подсеть с именем **AzureFirewallSubnet** в виртуальной сети, в которой находится кластер.

### <a name="create-a-new-firewall-for-your-cluster"></a>Создание нового брандмауэра для кластера

Создайте брандмауэр с именем **Test-FW01**, выполнив действия, описанные в разделе **Развертывание брандмауэра** в статье [Учебник. Развертывание и настройка службы "Брандмауэр Azure" с помощью портала Azure](../firewall/tutorial-firewall-deploy-portal.md#deploy-the-firewall).

### <a name="configure-the-firewall-with-application-rules"></a>Настройка брандмауэра с помощью правил приложения

Создайте коллекцию правил приложений, которые позволяют кластеру отправлять и получать важные данные.

1. Выберите новый брандмауэр **Test-FW01** на портале Azure.

1. Перейдите в раздел **Параметры** > **Правила** > **Коллекция правил приложений** >  **+ Добавить коллекцию правил приложений**.

    ![Заголовок. Добавление коллекции правил приложений](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-app-rule-collection.png)

1. На экране **Добавить коллекцию правил приложений** укажите следующие сведения.

    **Верхний раздел**

    | Свойство|  Значение|
    |---|---|
    |Имя| FwAppRule|
    |Приоритет|200|
    |Действие|Allow|

    **Раздел тегов FQDN**

    | Имя | Исходные адреса | Тег FQDN | Примечания |
    | --- | --- | --- | --- |
    | Rule_1 | * | WindowsUpdate и HDInsight | Требуется для служб HDI |

    **Раздел целевых FQDN**

    | Имя | Исходные адреса | Протокол: порт | Целевые FQDN | Примечания |
    | --- | --- | --- | --- | --- |
    | Rule_2 | * | https:443 | login.windows.net | Разрешает действие входа Windows |
    | Rule_3 | * | https:443 | login.microsoftonline.com | Разрешает действие входа Windows |
    | Rule_4 | * | https:443,http:80 | storage_account_name.blob.core.windows.net | Замените `storage_account_name` на имя вашей учетной записи хранения. Если кластер создается с помощью WASB, добавьте правило для WASB. Чтобы использовать ТОЛЬКО HTTPS-подключения, убедитесь, что в учетной записи хранения включен параметр ["требуется безопасная передача"](../storage/common/storage-require-secure-transfer.md). |

   ![Заголовок. Укажите сведения о коллекции правил приложения](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-app-rule-collection-details.png)

1. Выберите **Добавить**.

### <a name="configure-the-firewall-with-network-rules"></a>Настройка брандмауэра с помощью правил сети

Создайте правила сети для правильной настройки кластера HDInsight.

1. Продолжив с предыдущего шага, перейдите к разделу **Коллекция правил сети** >  **+ Добавить коллекцию правил сети**.

1. На экране **Добавить коллекцию правил сети** укажите следующие сведения.

    **Верхний раздел**

    | Свойство|  Значение|
    |---|---|
    |Имя| FwNetRule|
    |Приоритет|200|
    |Действие|Allow|

    **Раздел IP-адресов**

    | Имя | Протокол | Исходные адреса | Адреса назначения | Конечные порты | Примечания |
    | --- | --- | --- | --- | --- | --- |
    | Rule_1 | UDP | * | * | 123 | Служба времени |
    | Rule_2 | Любой | * | DC_IP_Address_1, DC_IP_Address_2 | * | Если вы используете Корпоративный пакет безопасности (ESP), добавьте правило сети в раздел IP-адресов, которые позволяют обмениваться данными с AAD-DS для кластеров ESP. IP-адреса контроллеров домена можно найти в разделе AAD-DS на портале. |
    | Rule_3 | TCP | * | IP-адрес учетной записи Data Lake Storage | * | Если вы используете Azure Data Lake Storage, можно добавить правило сети в раздел IP-адресов, чтобы устранить проблемы SNI с ADLS 1-го и 2-го поколения. Этот параметр направит трафик в брандмауэр. Это может привести к увеличению затрат на загрузку больших данных, но трафик будет регистрироваться в журнале брандмауэра и по нему можно будет провести аудит. Определите IP-адрес для учетной записи Data Lake Storage. Вы можете использовать команду PowerShell, например `[System.Net.DNS]::GetHostAddresses("STORAGEACCOUNTNAME.blob.core.windows.net")`, чтобы разрешить полное доменное имя в IP-адрес.|
    | Rule_4 | TCP | * | * | 12000 | (Необязательно.) Если вы используете Log Analytics, создайте правило сети в разделе IP-адресов, чтобы обеспечить обмен данными с рабочей областью Log Analytics. |

    **Раздел тегов служб**

    | Имя | Протокол | Исходные адреса | Теги служб | Конечные порты | Примечания |
    | --- | --- | --- | --- | --- | --- |
    | Rule_7 | TCP | * | SQL | 1433 | Настройте правило сети в разделе "Теги служб" для SQL, чтобы вести журнал и выполнять аудит трафика SQL, если вы не настроили конечные точки службы для SQL Server в подсети HDInsight, что приведет к обходу брандмауэра. |
    | Rule_8 | TCP | * | Azure Monitor | * | (Необязательно.) Пользователи, которые планируют использовать функцию автоматического масштабирования, должны добавить это правило. |
    
   ![Заголовок. Ввод коллекции правил приложений](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-network-rule-collection.png)

1. Выберите **Добавить**.

### <a name="create-and-configure-a-route-table"></a>Создание и настройка таблицы маршрутизации

Создайте таблицу маршрутизации со следующими записями:

* Все IP-адреса из раздела [Службы работоспособности и управления: все регионы](../hdinsight/hdinsight-management-ip-addresses.md#health-and-management-services-all-regions) с типом следующего прыжка **Интернет**.

* Два IP-адреса для региона, в котором создается кластер, в разделе [Службы работоспособности и управления: конкретные регионы](../hdinsight/hdinsight-management-ip-addresses.md#health-and-management-services-specific-regions) с типом следующего прыжка **Интернет**.

* Один маршрут виртуального модуля для IP-адреса 0.0.0.0/0, при этом следующий прыжок должен представлять частный IP-адрес вашего Брандмауэра Azure.

Например, чтобы настроить таблицу маршрутизации для кластера, созданного в регионе США "Восточная часть США", выполните следующие действия.

1. Выберите брандмауэр Azure **Test-FW01**. Скопируйте **Частный IP-адрес** на странице **Обзор**. В этом примере мы используем **пример адреса 10.0.2.4**.

1. Затем перейдите в раздел **Все службы** > **Сеть** > **Таблицы маршрутизации** и **Создать таблицу маршрутизации**.

1. В новом маршруте выберите **Параметры** > **Маршруты** > **Добавить**. Добавьте следующие маршруты:

| Имя маршрута | Префикс адреса | Тип следующего прыжка | Адрес следующего прыжка |
|---|---|---|---|
| 168.61.49.99 | 168.61.49.99/32 | Интернет | Н/Д |
| 23.99.5.239 | 23.99.5.239/32 | Интернет | Н/Д |
| 168.61.48.131 | 168.61.48.131/32 | Интернет | Н/Д |
| 138.91.141.162 | 138.91.141.162/32 | Интернет | Н/Д |
| 13.82.225.233 | 13.82.225.233/32 | Интернет | Н/Д |
| 40.71.175.99 | 40.71.175.99/32 | Интернет | Н/Д |
| 0.0.0.0 | 0.0.0.0/0 | Виртуальный модуль | 10.0.2.4 |

Завершите настройку таблицы маршрутизации:

1. Назначьте таблицу маршрутизации, созданную в подсети HDInsight, выбрав **Подсети** в разделе **Параметры**.

1. Выберите **+ Связать**.

1. На экране **Связать подсеть** выберите виртуальную сеть, в которой был создан кластер. И **Подсеть**, которую вы использовали для кластера HDInsight.

1. Щелкните **ОК**.

## <a name="edge-node-or-custom-application-traffic"></a>Трафик пограничного узла или пользовательского приложения

Вышеупомянутые шаги позволят кластеру работать без проблем. Вам по-прежнему необходимо настроить зависимости для размещения пользовательских приложений, работающих на пограничных узлах (если применимо).

Зависимости приложения необходимо определить и добавить в Брандмауэр Azure или таблицу маршрутизации.

Маршруты должны создаваться для трафика приложения, чтобы избежать проблемы с асимметричной маршрутизацией.

Если ваше приложение имеет другие зависимости, то их необходимо добавить в брандмауэр Azure. Создайте правила приложения, чтобы разрешать трафик протокола HTTP/HTTPS, и правила сети для всего остального.

## <a name="logging-and-scale"></a>Ведение журнала и масштабирование

Брандмауэр Azure может отправлять журналы в несколько различных систем хранения. Чтобы получить инструкции по настройке ведения журнала для брандмауэра, выполните действия, описанные в статье [Учебник. Мониторинг журналов и метрик Брандмауэра Azure](../firewall/tutorial-diagnostics.md).

Если вы используете Log Analytics, после настройки ведения журнала можно просмотреть заблокированный трафик с помощью запроса, например:

```Kusto
AzureDiagnostics | where msg_s contains "Deny" | where TimeGenerated >= ago(1h)
```

Интеграция Брандмауэра Azure с журналами Azure Monitor полезна при первом запуске приложения. Особенно если вы не знаете обо всех зависимостях приложения. См. дополнительные сведения о журналах Azure Monitor в статье [Анализ данных журнала в Azure Monitor](../azure-monitor/log-query/log-query-overview.md)

Дополнительные сведения об ограничениях масштабирования Брандмауэра Azure и увеличении запросов см. в [этом](../azure-resource-manager/management/azure-subscription-service-limits.md#azure-firewall-limits) документе или на странице [Вопросы и ответы](../firewall/firewall-faq.md).

## <a name="access-to-the-cluster"></a>Доступ к кластеру

После успешной настройки брандмауэра можно использовать внутреннюю конечную точку (`https://CLUSTERNAME-int.azurehdinsight.net`) для доступа к Ambari из виртуальной сети.

Чтобы использовать общедоступную конечную точку (`https://CLUSTERNAME.azurehdinsight.net`) или конечную точку SSH (`CLUSTERNAME-ssh.azurehdinsight.net`), убедитесь, что у вас указаны правильные маршруты в таблице маршрутизации и правила NSG. Это позволит избежать проблем с асимметричной маршрутизацией, описанных [здесь](../firewall/integrate-lb.md). В частности, в этом случае необходимо разрешить IP-адрес клиента в правилах входящего трафика NSG, а также добавить его в определяемую пользователем таблицу маршрутизации со следующим прыжком `internet`. Если маршрутизация настроена неправильно, возникнет ошибка времени ожидания.

## <a name="next-steps"></a>Дальнейшие действия

* [Архитектура виртуальной сети Azure HDInsight](hdinsight-virtual-network-architecture.md)
* [Настройка сетевого виртуального устройства](./network-virtual-appliance.md)
