---
title: Накончать исходящие ограничения сетевого трафика - Azure HDInsight
description: Узнайте, как настроить ограничение исходящего сетевого трафика для кластеров Azure HDInsight.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.date: 03/11/2020
ms.openlocfilehash: 3432f981df3f666d6276eee4564ef33000faa6b1
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81410891"
---
# <a name="configure-outbound-network-traffic-for-azure-hdinsight-clusters-using-firewall"></a>Накончать исходящий сетевой трафик для кластеров Azure HDInsight с помощью брандмауэра

В этой статье приведены шаги для защиты исходящего трафика из кластера HDInsight с помощью Azure Firewall. Приведенные ниже шаги предполагают, что вы настраиваете брандмауэр Azure для существующего кластера. Если вы развертываете новый кластер и за брандмауэром, создайте кластер и подсеть HDInsight, а затем выполните последующие шаги в этом руководстве.

## <a name="background"></a>Историческая справка

Кластеры Azure HDInsight обычно развертываются в собственной виртуальной сети. Кластер имеет зависимость от служб за пределами этой виртуальной сети, которые требуют доступа к сети, чтобы функционировать должным образом.

Есть несколько зависимостей, которые требуют входящего трафика. Входящий трафик управления не может быть отправлен через брандмауэр. Исходные адреса для этого трафика известны и публикуются [здесь](hdinsight-management-ip-addresses.md). Можно также создать правила Network Security Group (NSG) с этой информацией для защиты входящего трафика в кластеры.

Зависимость от исходящих трафика HDInsight почти полностью определена с помощью F-DN, которые не имеют за ними статических IP-адресов. Отсутствие статических адресов означает, что группы сетевой безопасности (НСГ) не могут использоваться для блокировки исходящего трафика из кластера. Адреса меняются достаточно часто, что нельзя настроить правила, основанные на текущем разрешении имен, и использовать их для настройки правил NSG.

Решением для обеспечения безопасности исходящих адресов является использование брандмауэра, которое может управлять исходящим трафиком на основе доменных имен. Azure Firewall может ограничивать исходящий трафик HTTP и HTTPS на основе тегов F-DN назначения или [тегов ФЗДН.](../firewall/fqdn-tags.md)

## <a name="configuring-azure-firewall-with-hdinsight"></a>Настройка брандмауэра Azure с помощью HDInsight

Резюме шагов по блокировке выхода из существующего HDInsight с Azure Firewall:

1. Создайте подсеть.
1. Создайте брандмауэр.
1. Добавление правил приложения в брандмауэр
1. Добавьте сетевые правила в брандмауэр.
1. Создайте таблицу маршрутизации.

### <a name="create-new-subnet"></a>Создание новой подсети

Создайте подсеть под названием **AzureFirewallSubnet** в виртуальной сети, где существует кластер.

### <a name="create-a-new-firewall-for-your-cluster"></a>Создание нового брандмауэра для кластера

Создайте брандмауэр под названием **Test-FW01** с помощью шагов в **развертывании брандмауэра** из [учебника: Развертывание и настройка Azure Firewall с помощью портала Azure.](../firewall/tutorial-firewall-deploy-portal.md#deploy-the-firewall)

### <a name="configure-the-firewall-with-application-rules"></a>Настройка брандмауэра с помощью правил приложения

Создайте набор правил приложений, который позволяет кластеру отправлять и получать важные сообщения.

1. Выберите новый брандмауэр **Test-FW01** с портала Azure.

1. Перейдите к**сбору** > правил приложения **«Правила** >  **настроек»** > **и добавить сбор правил приложения.**

    ![Название: Добавить сбор правил приложения](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-app-rule-collection.png)

1. На экране **сбора правил приложения Add** укажите следующую информацию:

    **Верхняя секция**

    | Свойство|  Значение|
    |---|---|
    |Имя| FwAppRule|
    |Приоритет|200|
    |Действие|Allow|

    **Раздел тегов ФЗДН**

    | Имя | Адрес источника | Тег FQDN | Примечания |
    | --- | --- | --- | --- |
    | Rule_1 | * | WindowsUpdate и HDInsight | Требуется для услуг ИРЧП |

    **Целевой раздел ФЗН**

    | Имя | Адреса исходных источников | Протокол:Порт | Целевая ПЗДНС | Примечания |
    | --- | --- | --- | --- | --- |
    | Rule_2 | * | https:443 | login.windows.net | Позволяет активность входа в Windows |
    | Rule_3 | * | https:443 | login.microsoftonline.com | Позволяет активность входа в Windows |
    | Rule_4 | * | https:443,http:80 | storage_account_name.blob.core.windows.net | Замените `storage_account_name` свое имя учетной записи хранилища. Если ваш кластер поддерживается WASB, добавьте правило для WASB. Чтобы использовать только https соединения, убедитесь, что ["безопасный перевод требуется"](../storage/common/storage-require-secure-transfer.md) включен на учетную запись хранения. |

   ![Название: Введите сведения о сборе правил приложения](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-app-rule-collection-details.png)

1. Выберите **Добавить**.

### <a name="configure-the-firewall-with-network-rules"></a>Настройка брандмауэра с помощью сетевых правил

Создайте сетевые правила для правильной настройки кластера HDInsight.

1. Продолжая свой предыдущий шаг, перейдите в **сбор** > правил сети**и добавьте сбор сетевых правил.**

1. На экране **сбора правил сети Add** укажите следующую информацию:

    **Верхняя секция**

    | Свойство|  Значение|
    |---|---|
    |Имя| FwNetRule|
    |Приоритет|200|
    |Действие|Allow|

    **Раздел IP-адресов**

    | Имя | Протокол | Адреса исходных источников | Адреса назначения | Конечные порты | Примечания |
    | --- | --- | --- | --- | --- | --- |
    | Rule_1 | UDP | * | * | 123 | Обслуживание времени |
    | Rule_2 | Любой | * | DC_IP_Address_1, DC_IP_Address_2 | * | Если вы используете пакет корпоративной безопасности (ESP), затем добавьте сетевое правило в раздел IP-адресов, которое позволяет общаться с AAD-DS для кластеров ESP. На портале можно найти IP-адреса контроллеров доменов в разделе AAD-DS |
    | Rule_3 | TCP | * | IP-адрес учетной записи хранилища data Lake | * | Если вы используете хранилище озер данных Azure, то можно добавить сетевое правило в раздел IP-адресов для решения проблемы SNI с ADLS Gen1 и Gen2. Эта опция будет направлять трафик в брандмауэр, что может привести к более высоким затратам для больших нагрузок данных, но трафик будет зарегистрирован и проверен в журналах брандмауэра. Определите IP-адрес учетной записи Data Lake Storage. Вы можете использовать команду Powershell, `[System.Net.DNS]::GetHostAddresses("STORAGEACCOUNTNAME.blob.core.windows.net")` например, для решения F-DN с IP-адресом.|
    | Rule_4 | TCP | * | * | 12000 | (Необязательно) Если вы используете Log Analytics, создайте сетевое правило в разделе IP-адресов, чтобы обеспечить связь с рабочим пространством Log Analytics. |

    **Раздел "Теги обслуживания"**

    | Имя | Протокол | Исходные адреса | Теги служб | Порты назначения | Примечания |
    | --- | --- | --- | --- | --- | --- |
    | Rule_7 | TCP | * | SQL | 1433 | Настройте сетевое правило в разделе «Теги обслуживания» для S'L, которое позволит вам регистрировать и проверять трафик S'L, если только вы не настроили конечные точки обслуживания для сервера S'L в подсети HDInsight, которая обойдет брандмауэр. |

   ![Название: Введите сбор правил приложения](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-network-rule-collection.png)

1. Выберите **Добавить**.

### <a name="create-and-configure-a-route-table"></a>Создание и настройка таблицы маршрутов

Создайте таблицу маршрутов со следующими записями:

* Все IP-адреса служб [здравоохранения и управления: Все регионы](../hdinsight/hdinsight-management-ip-addresses.md#health-and-management-services-all-regions) со следующим типом перехода **в Интернете.**

* Два IP-адреса для региона, где кластер создается из [служб здравоохранения и управления: специфические регионы](../hdinsight/hdinsight-management-ip-addresses.md#health-and-management-services-specific-regions) со следующим типом **перехода Интернета.**

* Один маршрут виртуального прибора для IP-адреса 0.0.0.0/0 с следующим переходом является вашим личным IP-адресом Azure Firewall.

Например, для настройки таблицы маршрутов для кластера, созданного в американском регионе "Восток США", используйте следующие шаги:

1. Выберите тест брандмауэра Azure **Test-FW01.** Копируйте **частный IP-адрес,** указанный на странице **Обзор.** В этом примере мы будем использовать **пример адреса 10.0.2.4**.

1. Затем перейдите на **все службы** > **Сети** > **Маршрут таблицы** и создать **таблицу маршрута**.

1. С нового маршрута перейдите к**маршрутам** >  **настроек** > **и добавьте.** Добавьте следующие маршруты:

| Имя маршрута | Префикс адреса | Тип следующего прыжка | Адрес следующего прыжка |
|---|---|---|---|
| 168.61.49.99 | 168.61.49.99/32 | Интернет | Н/Д |
| 23.99.5.239 | 23.99.5.239/32 | Интернет | Н/Д |
| 168.61.48.131 | 168.61.48.131/32 | Интернет | Н/Д |
| 138.91.141.162 | 138.91.141.162/32 | Интернет | Н/Д |
| 13.82.225.233 | 13.82.225.233/32 | Интернет | Н/Д |
| 40.71.175.99 | 40.71.175.99/32 | Интернет | Н/Д |
| 0.0.0.0 | 0.0.0.0/0 | Виртуальный модуль | 10.0.2.4 |

Заполните конфигурацию таблицы маршрутов:

1. Назначьте созданную таблицу маршрутов в поднетhd. **Settings** **Subnets**

1. Выберите **ассоциированное**.

1. На экране **подсети Associate** выберите виртуальную сеть, в которую был создан кластер, и **подсеть, которую** вы использовали для кластера HDInsight.

1. Щелкните **ОК**.

## <a name="edge-node-or-custom-application-traffic"></a>Трафик узлов оговора или пользовательского приложения

Вышеуказанные шаги позволят кластеру работать без проблем. Вам все еще нужно настроить зависимости для размещения пользовательских приложений, работающих на краях узлов, если это применимо.

Зависимости приложений должны быть идентифицированы и добавлены в брандмауэр Azure или таблицу маршрутов.

Маршруты должны быть созданы для движения приложений, чтобы избежать проблем с асимметричной маршрутизацией.

Если в приложениях есть другие зависимости, они должны быть добавлены в брандмауэр Azure Firewall. Создайте правила приложения, чтобы разрешать трафик протокола HTTP/HTTPS, и правила сети для всего остального.

## <a name="logging-and-scale"></a>Регистрация и масштабирование

Azure Firewall может отправлять журналы в несколько различных систем хранения данных. Для получения инструкций по настройке журналов для брандмауэра выполните инструкции в [учебном центре: Monitor Azure Firewall, журналы и метрики.](../firewall/tutorial-diagnostics.md)

После завершения настройки журналов, если вы регистрируете данные в журналAnalytics, можно просмотреть заблокированный трафик с помощью такого запроса, как:

```Kusto
AzureDiagnostics | where msg_s contains "Deny" | where TimeGenerated >= ago(1h)
```

Интеграция брандмауэра Azure с журналами Azure Monitor полезна при первом заработке приложения, когда вы не знаете обо всех зависимостях приложений. См. дополнительные сведения о журналах Azure Monitor в статье [Анализ данных журнала в Azure Monitor](../azure-monitor/log-query/log-query-overview.md)

Чтобы узнать о масштабах брандмауэра Azure firewall и увеличить запрос, [см. этот](../azure-resource-manager/management/azure-subscription-service-limits.md#azure-firewall-limits) документ или обратитесь к [часто задаваемым катаклям](../firewall/firewall-faq.md).

## <a name="access-to-the-cluster"></a>Доступ к кластеру

После успешного настройки брандмауэра можно использовать`https://CLUSTERNAME-int.azurehdinsight.net`внутреннюю конечную точку () для доступа к Ambari из виртуальной сети.

Чтобы использовать публичную`https://CLUSTERNAME.azurehdinsight.net`конечную точку (`CLUSTERNAME-ssh.azurehdinsight.net`) или ssh конечную точку ( ), убедитесь, что у вас есть правильные маршруты в таблице маршрутов и правила NSG, чтобы избежать асимметричной проблемы маршрутизации объяснил [здесь](../firewall/integrate-lb.md). В частности, в этом случае необходимо разрешить IP-адрес клиента в правилах Inbound NSG, а также `internet`добавить его в таблицу маршрутов, определяемую пользователем, со следующим набором hop как. Если это неправильно настроено, вы увидите ошибку тайм-аута.

## <a name="configure-another-network-virtual-appliance"></a>Настройка другого сетевого виртуального устройства

> [!Important]
> Следующая информация требуется **только** в том случае, если вы хотите настроить сетевой виртуальный прибор (NVA), кроме Azure Firewall.

Предыдущие инструкции помогают настроить Azure Firewall для ограничения исходящего трафика из кластера HDInsight. Брандмауэр Azure настроен автоматически, чтобы обеспечить трафик для многих общих важных сценариев. Если вы хотите использовать другой сетевой виртуальный прибор, вам нужно вручную настроить ряд дополнительных функций. Имейте в виду следующее при настройке виртуального устройства сети:

* В разделе "Конечные точки" должны быть указаны конечные точки для включенных служб.
* Зависимости IP-адреса для трафика, не относящемся к HTTP/S (как TCP, так и udP-трафику).
* Конечные точки ФЗДН HTTP/HTTPS могут быть размещены на вашем устройстве NVA.
* Конечные точки Wildcard HTTP/HTTPS представляют собой зависимости, которые могут варьироваться в зависимости от ряда квалификаторов.
* Назначьте таблицу маршрутов, которую вы создаете, в подсеть HDInsight.

### <a name="service-endpoint-capable-dependencies"></a>Зависимость от конечных точек обслуживания

| **Конечная точка** |
|---|
| Azure SQL |
| Хранилище Azure |
| Azure Active Directory |

#### <a name="ip-address-dependencies"></a>Зависимости IP-адреса

| **Конечная точка** | **Сведения** |
|---|---|
| \*:123 | Проверка часов NTP. Трафик проверяется в нескольких конечных точках на порте 123. |
| IPs, [опубликованные здесь](hdinsight-management-ip-addresses.md) | Это сервис HDInsight |
| Частные ИС AAD-DS для кластеров ESP |
| \*:16800 для активации Windows KMS |
| \*12000 для аналитики журналов |

#### <a name="fqdn-httphttps-dependencies"></a>Зависимости FQDN протокола HTTP/HTTPS

> [!Important]
> В приведенном ниже списке приводятся лишь некоторые из наиболее важных ФЗН. Вы можете получить дополнительные F-DNs (в основном Azure Storage и Azure Service Bus) для настройки NVA [в этом файле.](https://github.com/Azure-Samples/hdinsight-fqdn-lists/blob/master/HDInsightFQDNTags.json)

| **Конечная точка**                                                          |
|---|
| azure.archive.ubuntu.com:80                                           |
| security.ubuntu.com:80                                                |
| ocsp.msocsp.com:80                                                    |
| ocsp.digicert.com:80                                                  |
| wawsinfraprodbay063.blob.core.windows.net:443                         |
| registry-1.docker.io:443                                              |
| auth.docker.io:443                                                    |
| production.cloudflare.docker.com:443                                  |
| download.docker.com:443                                               |
| us.archive.ubuntu.com:80                                              |
| download.mono-project.com:80                                          |
| packages.treasuredata.com:80                                          |
| security.ubuntu.com:80                                                |
| azure.archive.ubuntu.com:80                                           |
| ocsp.msocsp.com:80                                                    |
| ocsp.digicert.com:80                                                  |

## <a name="next-steps"></a>Дальнейшие действия

* [Виртуальная сетевая архитектура Azure HDInsight](hdinsight-virtual-network-architecture.md)
