---
title: Настройка ограничения исходящего сетевого трафика для кластеров Azure HDInsight
description: Узнайте, как настроить ограничения исходящего сетевого трафика для кластеров Azure HDInsight.
services: hdinsight
ms.service: hdinsight
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.topic: howto
ms.date: 05/30/2019
ms.openlocfilehash: af5ddd50556b493cddf27d1ebb766d9bf6105107
ms.sourcegitcommit: f56b267b11f23ac8f6284bb662b38c7a8336e99b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/28/2019
ms.locfileid: "67433428"
---
# <a name="configure-outbound-network-traffic-for-azure-hdinsight-clusters-using-firewall-preview"></a>Настройка исходящего сетевого трафика для кластеров Azure HDInsight, с помощью брандмауэра (Предварительная версия)

В этой статье описаны действия по защите исходящий трафик из кластера HDInsight с помощью брандмауэра Azure. Ниже предполагается, что вы настраиваете брандмауэр подключения к Azure для существующего кластера. При развертывании нового кластера и за брандмауэром, сначала создайте кластер HDInsight и подсеть, а затем выполните действия, описанные в этом руководстве.

## <a name="background"></a>Фоновый

Кластеры Azure HDInsight обычно развертываются в виртуальной сети. Кластера зависит от службы за пределами этой виртуальной сети, которым требуется доступ к правильной сети.

Существует несколько зависимостей, которые требуют входящий трафик. Входящий трафик управления невозможно отправлять через устройство брандмауэра. Исходные адреса для этого трафика известны и публикуются [здесь](hdinsight-extend-hadoop-virtual-network.md#hdinsight-ip). Можно также создать правила группы безопасности сети (NSG) с эти сведения для защиты входящего трафика на кластеры.

Исходящий трафик зависимости HDInsight почти полностью определяются с помощью полных доменных имен, которые не имеют статических IP-адресов за ними. Отсутствие статических адресов означает, что группы безопасности сети (Nsg), не может использоваться для блокировки исходящего трафика из кластера. Адреса изменить достаточно часто, что один нельзя задать правила на основе текущего разрешения имени и использовать, чтобы настроить правила группы безопасности сети.

Решение для защиты исходящих адресов является использование устройства брандмауэра, можно контролировать исходящего трафика на основе имен домена. Брандмауэр Azure можно ограничить исходящий трафик HTTP и HTTPS на полное ДОМЕННОЕ имя назначения основе или [теги полное доменное имя](https://docs.microsoft.com/azure/firewall/fqdn-tags).

## <a name="configuring-azure-firewall-with-hdinsight"></a>Настройка брандмауэра Azure с помощью HDInsight

Сводка шагов для блокировки исходящего трафика из вашей существующей HDInsight с помощью брандмауэра Azure являются:
1. Создание брандмауэра.
1. Добавление правила приложения на брандмауэр
1. Добавьте правила сетевого брандмауэра.
1. Создайте таблицу маршрутизации.

### <a name="create-a-new-firewall-for-your-cluster"></a>Создание брандмауэра для кластера

1. Создайте подсеть с именем **AzureFirewallSubnet** в виртуальной сети, где существует кластер. 
1. Создание брандмауэра **теста FW01** , следуя указаниям в [руководства: Развертывание и настройка службы "Брандмауэр Azure" с помощью портала Azure](../firewall/tutorial-firewall-deploy-portal.md#deploy-the-firewall).

### <a name="configure-the-firewall-with-application-rules"></a>Настройка брандмауэра с помощью правил приложения

Создание коллекции правил приложения, которое может отправлять и получать важные сведения.

Выберите новый брандмауэр **FW01 теста** на портале Azure. Нажмите кнопку **правила** под **параметры** > **коллекции правил приложения** > **Добавление коллекции правил приложения**.

![Заголовок. Добавление коллекции правил приложения](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-app-rule-collection.png)

На **Добавление коллекции правил приложения** экрана, выполните следующие действия:

1. Введите **имя**, **приоритет**и нажмите кнопку **Разрешить** из **действие** в раскрывающемся меню и введите следующие правила в **Полное доменное имя теги разделе** :

   | **Имя** | **Адрес источника** | **Полное доменное имя тега** | **Примечания** |
   | --- | --- | --- | --- |
   | Rule_1 | * | HDInsight и WindowsUpdate | Необходимые для службы HDI |

1. Добавьте следующие правила для **раздел Target полные доменные имена** :

   | **Имя** | **Адрес источника** | **Протокол: порт** | **Целевой полные доменные ИМЕНА** | **Примечания** |
   | --- | --- | --- | --- | --- |
   | Rule_2 | * | https:443 | login.windows.net | Разрешает вход в систему Windows |
   | Rule_3 | * | https:443,http:80 | <storage_account_name.blob.core.windows.net> | Если WASB для кластера, затем добавьте правило для WASB. Для использования только протокола https подключений убедитесь, что [«требуется безопасное перемещение»](https://docs.microsoft.com/azure/storage/common/storage-require-secure-transfer) с включенной учетной записи хранения. |

1. Щелкните **Добавить**.

   ![Заголовок. Введите сведения о коллекции правил приложения](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-app-rule-collection-details.png)

### <a name="configure-the-firewall-with-network-rules"></a>Настройка брандмауэра с помощью правил сети

Создайте правила сети для правильной настройки кластера HDInsight.

1. Выберите новый брандмауэр **FW01 теста** на портале Azure.
1. Нажмите кнопку **правила** под **параметры** > **коллекции правил сети** > **Добавление коллекции правил сети**.
1. На **Добавление коллекции правил сети** введите **имя**, **приоритет**и нажмите кнопку **Разрешить** из **действие** раскрывающееся меню.
1. Создайте следующие правила в **IP-адреса** раздел:

   | **Имя** | **Протокол** | **Адрес источника** | **Конечный адрес** | **Конечный порт** | **Примечания** |
   | --- | --- | --- | --- | --- | --- |
   | Rule_1 | UDP | * | * | `123` | Служба времени |
   | Rule_2 | Любой | * | DC_IP_Address_1 DC_IP_Address_2 | `*` | Если вы используете пакет безопасности предприятия (ESP), затем добавьте правило сети в разделе IP-адресов, позволяющем связываться с доменных Служб AAD для кластеров ESP. IP-адреса контроллеров домена в разделе доменных Служб AAD можно найти на портале | 
   | Rule_3 | TCP | * | IP-адрес вашей учетной записи хранения Озера данных | `*` | Если вы используете хранилище Azure Data Lake, можно добавить правило сети в разделе IP-адресов для решения проблемы SNI с ADLS Gen1 и Gen2. Этот параметр будет направлять трафик к брандмауэру, что может привести к более высокими затратами для больших объемов данных, но и будет журнал и доступны для аудита в журналах брандмауэра. Определите IP-адрес для своей учетной записи хранения Озера данных. Можно использовать команду powershell, такие как `[System.Net.DNS]::GetHostAddresses("STORAGEACCOUNTNAME.blob.core.windows.net")` разрешить полное доменное имя в IP-адрес.|
   | Rule_4 | TCP | * | * | `12000` | (Необязательно) Если вы используете Log Analytics, создайте правило сети в разделе IP-адресов для обеспечения взаимодействия с рабочей областью Log Analytics. |

1. Создайте следующие правила в **теги служб** раздел:

   | **Имя** | **Протокол** | **Адрес источника** | **Теги служб** | **Конечный порт** | **Примечания** |
   | --- | --- | --- | --- | --- | --- |
   | Rule_7 | TCP | * | SQL | `1433` | Настройка правила сети в разделе "теги службы" для SQL, который позволит вам регистрирование и аудит трафик SQL, если вы не настроили конечные точки службы для SQL Server в HDInsight подсети, в которой будут обходить брандмауэр. |

1. Нажмите кнопку **добавить** чтобы завершить создание вашей коллекции правил сети.

   ![Заголовок. Введите сведения о коллекции правил приложения](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-network-rule-collection.png)

### <a name="create-and-configure-a-route-table"></a>Создание и настройка таблицы маршрутов

Создание таблицы маршрутов со следующими элементами:

1. Шесть адресов из [этот список IP-адресов HDInsight управления](../hdinsight/hdinsight-extend-hadoop-virtual-network.md#hdinsight-ip) с типом следующего прыжка **Internet**:
    1. Четыре IP-адреса для всех кластеров во всех регионах
    1. Два IP-адреса, характерные для региона, где создается кластер
1. Один маршрут виртуального устройства для IP-адрес адрес 0.0.0.0/0 со следующим прыжком, что ваш брандмауэр Azure частный IP-адрес.

Например чтобы настроить таблицу маршрутов для кластера, созданного в регионе США «Центральная часть США», используйте следующие действия:

1. Войдите на портал Azure.
1. Выберите Azure брандмауэр **FW01 теста**. Копировать **частный IP-адрес** на **Обзор** страницы. В этом примере мы будем использовать **пример адрес 10.1.1.4**
1. Создайте новую таблицу маршрутов.
1. Нажмите кнопку **маршруты** под **параметры**.
1. Нажмите кнопку **добавить** создать маршруты для IP-адресов в таблице ниже.

| Имя маршрута | Префикс адреса | Тип следующего прыжка | Адрес следующего прыжка |
|---|---|---|---|
| 168.61.49.99 | 168.61.49.99/32 | Интернет | Нет данных |
| 23.99.5.239 | 23.99.5.239/32 | Интернет | Нет данных |
| 168.61.48.131 | 168.61.48.131/32 | Интернет | Нет данных |
| 138.91.141.162 | 138.91.141.162/32 | Интернет | Нет данных |
| 13.67.223.215 | 13.67.223.215/32 | Интернет | Нет данных |
| 40.86.83.253 | 40.86.83.253/32 | Интернет | Нет данных |
| 0.0.0.0 | 0.0.0.0/0 | Виртуальное устройство | 10.1.1.4 |

Завершение настройки таблицы маршрутов:

1. Свяжите эту таблицу маршрутов, созданной в подсети HDInsight с помощью кнопки **подсетей** под **параметры** и затем **связать**.
1. На **связать подсеть** выберите виртуальную сеть, которую кластер был создан в и **подсети HDInsight** вы использовали для кластера HDInsight.
1. Последовательно выберите **ОК**.

## <a name="edge-node-or-custom-application-traffic"></a>Граничный узел или пользовательское приложение трафика

Описанные выше действия будет Разрешить кластеру работать без проблем. По-прежнему необходимо настроить зависимости для размещения ваших пользовательских приложений, работающих на пограничных узлах, если применимо.

Зависимости приложения необходимо определить и добавить брандмауэр Azure или в таблице маршрутов.

Необходимо создать маршруты для трафика приложений избежать проблемы асимметричной маршрутизации.

Если ваше приложение имеет другие зависимости, они должны быть добавлены в брандмауэр Azure. Создайте правила приложения, чтобы разрешать трафик протокола HTTP/HTTPS, и правила сети для всего остального.

## <a name="logging"></a>Ведение журналов

Брандмауэр Azure можно отправлять журналы в несколько разных системах хранения. Инструкции по настройке ведения журнала для брандмауэра, выполните действия, описанные в [руководства: Отслеживать метрики и журналы брандмауэра Azure](../firewall/tutorial-diagnostics.md).

После завершения настройки ведения журнала, если вы являетесь ведения журнала данных в Log Analytics, вы можете просмотреть заблокированного трафика с помощью следующего запроса:

```
AzureDiagnostics | where msg_s contains "Deny" | where TimeGenerated >= ago(1h)
```

Интеграция брандмауэра Azure с помощью журналов Azure Monitor полезно в том случае, при первом получении приложения работать, когда вы не знаете все зависимости приложения. См. дополнительные сведения о журналах Azure Monitor в статье [Анализ данных журнала в Azure Monitor](../azure-monitor/log-query/log-query-overview.md)

## <a name="access-to-the-cluster"></a>Доступ к кластеру
После того, настройки брандмауэра успешно, можно использовать внутреннюю конечную точку (`https://<clustername>-int.azurehdinsight.net`) для доступа к Ambari из виртуальной сети. Чтобы использовать общедоступную конечную точку (`https://<clustername>.azurehdinsight.net`) или ssh конечной точки (`<clustername>-ssh.azurehdinsight.net`), убедитесь, что у вас есть правой маршруты в таблицу маршрутов и настройка правил группы безопасности сети для устранения проблемы маршрутизации асимметричный описано [здесь](https://docs.microsoft.com/azure/firewall/integrate-lb).

## <a name="configure-another-network-virtual-appliance"></a>Настройте другой виртуальный сетевой модуль

>[!Important]
> Следующие сведения являются **только** требуется, если вы хотите настроить виртуальный сетевой модуль (NVA), отличный от брандмауэра Azure.

Предыдущие инструкции помогут настроить брандмауэр Azure для ограничения исходящего трафика из кластера HDInsight. Брандмауэр Azure настраивается автоматически, чтобы разрешить трафик для многих распространенных сценариях важным. Если вы хотите использовать другой виртуальный сетевой модуль, необходимо будет вручную настроить ряд дополнительных функций. Имейте в виду, что следующее вашей настроить виртуальное сетевое устройство:

* В разделе "Конечные точки" должны быть указаны конечные точки для включенных служб.
* Зависимости IP-адрес — это для не HTTP/S трафик (TCP и UDP).
* Полное доменное имя HTTP/HTTPS конечных точек может размещаться в устройство NVA.
* Конечные точки подстановочный знак HTTP/HTTPS являются зависимости, которые могут различаться на основе номера квалификаторов.
* Назначьте таблице, созданной для подсети HDInsight.

### <a name="service-endpoint-capable-dependencies"></a>Зависимости конечной точки службы

| **Конечная точка** |
|---|
| Azure SQL |
| Хранилище Azure |
| Azure Active Directory |

#### <a name="ip-address-dependencies"></a>Зависимости IP-адреса

| **Конечная точка** | **Сведения** |
|---|---|
| \*:123 | Проверка часов NTP. Трафик проверяется в нескольких конечных точках на порте 123. |
| IP-адреса публикации [здесь](hdinsight-extend-hadoop-virtual-network.md#hdinsight-ip) | Это службы HDInsight |
| Частные IP-адреса доменных Служб AAD, для ESP кластеров |
| \*: 16800 для KMS-активации Windows |
| \*12000 для Log Analytics |

#### <a name="fqdn-httphttps-dependencies"></a>Зависимости FQDN протокола HTTP/HTTPS

>[!Important]
> В списке ниже дает только некоторые из наиболее важных полных доменных имен. Можно получить полный список полных доменных имен для настройки виртуальным сетевым Устройством [в этом файле](https://github.com/Azure-Samples/hdinsight-fqdn-lists/blob/master/HDInsightFQDNTags.json).

| **Конечная точка**                                                          |
|---|
| azure.archive.ubuntu.com:80                                           |
| security.ubuntu.com:80                                                |
| ocsp.msocsp.com:80                                                    |
| ocsp.digicert.com:80                                                  |
| wawsinfraprodbay063.blob.core.windows.net:443                         |
| registry-1.docker.io:443                                              |
| auth.docker.io:443                                                    |
| production.cloudflare.docker.com:443                                  |
| download.docker.com:443                                               |
| us.archive.ubuntu.com:80                                              |
| download.mono-project.com:80                                          |
| packages.treasuredata.com:80                                          |
| security.ubuntu.com:80                                                |
| azure.archive.ubuntu.com:80                                                |
| ocsp.msocsp.com:80                                                |
| ocsp.digicert.com:80                                                |

## <a name="next-steps"></a>Дальнейшие действия

* [Архитектура виртуальной сети Azure HDInsight](hdinsight-virtual-network-architecture.md)
