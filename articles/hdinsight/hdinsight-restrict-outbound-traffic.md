---
title: Настройка ограничения исходящего сетевого трафика для кластеров Azure HDInsight
description: Узнайте, как настроить ограничение исходящего сетевого трафика для кластеров Azure HDInsight.
services: hdinsight
ms.service: hdinsight
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.topic: conceptual
ms.date: 05/30/2019
ms.openlocfilehash: 829f3e730b4993a6a7f32a9224d3c6c38bd4c06e
ms.sourcegitcommit: fa4852cca8644b14ce935674861363613cf4bfdf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/09/2019
ms.locfileid: "70811959"
---
# <a name="configure-outbound-network-traffic-for-azure-hdinsight-clusters-using-firewall-preview"></a>Настройка исходящего сетевого трафика для кластеров Azure HDInsight с помощью брандмауэра (Предварительная версия)

В этой статье приведены инструкции по защите исходящего трафика из кластера HDInsight с помощью брандмауэра Azure. В описанных ниже действиях предполагается, что вы настраиваете брандмауэр Azure для существующего кластера. При развертывании нового кластера и за брандмауэром сначала создайте кластер HDInsight и подсеть, а затем выполните действия, описанные в этом руководстве.

## <a name="background"></a>Фоновый

Кластеры Azure HDInsight обычно развертываются в собственной виртуальной сети. Кластер имеет зависимости от служб за пределами этой виртуальной сети, для правильной работы которых требуется сетевой доступ.

Существует несколько зависимостей, требующих входящего трафика. Входящий трафик управления невозможно отправлять через устройство брандмауэра. Исходные адреса для этого трафика известны и публикуются [здесь](hdinsight-management-ip-addresses.md). Вы также можете создать правила группы безопасности сети (NSG) с этими сведениями для защиты входящего трафика к кластерам.

Зависимости исходящего трафика HDInsight почти полностью определяются с помощью полных доменных имен, которым не назначены статические IP-адреса. Отсутствие статических адресов означает, что группы безопасности сети (группы безопасности сети) не могут использоваться для блокировки исходящего трафика из кластера. Адреса часто меняются, что один из них не может настроить правила на основе текущего разрешения имен и использовать его для настройки правил NSG.

Решением для защиты исходящих адресов является использование устройства брандмауэра, которое может управлять исходящим трафиком на основе доменных имен. Брандмауэр Azure может ограничивать исходящий трафик HTTP и HTTPS на основе полного доменного имени в [тегах назначения или полного доменного имени](https://docs.microsoft.com/azure/firewall/fqdn-tags).

## <a name="configuring-azure-firewall-with-hdinsight"></a>Настройка брандмауэра Azure с помощью HDInsight

Ниже приведена сводка действий по блокировке исходящих данных из существующего HDInsight с помощью брандмауэра Azure.
1. Создайте брандмауэр.
1. Добавление правил приложения в брандмауэр
1. Добавьте сетевые правила в брандмауэр.
1. Создайте таблицу маршрутизации.

### <a name="create-a-new-firewall-for-your-cluster"></a>Создание нового брандмауэра для кластера

1. Создайте подсеть с именем **азурефиреваллсубнет** в виртуальной сети, где существует кластер. 
1. Создание нового брандмауэра **Test-FW01** с помощью действий, описанных в [руководстве. Развертывание и настройка службы "Брандмауэр Azure" с помощью портала Azure](../firewall/tutorial-firewall-deploy-portal.md#deploy-the-firewall).

### <a name="configure-the-firewall-with-application-rules"></a>Настройка брандмауэра с помощью правил приложения

Создайте коллекцию правил приложений, которая позволяет кластеру отправлять и получать важные коммуникации.

Выберите новый брандмауэр **Test-FW01** из портал Azure. Щелкните **правила** в разделе **Параметры** > **коллекция** > правил приложения**Добавить коллекцию правил приложения**.

![Заголовок. Добавление коллекции правил приложений](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-app-rule-collection.png)

На экране **Добавление коллекции правил приложений** выполните следующие действия.

1. Введите **имя**, **приоритет**и выберите пункт **Разрешить** в раскрывающемся меню **действия** и введите следующие правила в **разделе Теги полного доменного имени** :

   | **Name** | **Исходный адрес** | **Тег полного доменного имени** | **Примечания** |
   | --- | --- | --- | --- |
   | Rule_1 | * | HDInsight и WindowsUpdate | Требуется для HDI Services |

1. Добавьте следующие правила в **раздел FQDN targets** :

   | **Name** | **Исходный адрес** | **Протокол: порт** | **Целевые полные доменные имена** | **Примечания** |
   | --- | --- | --- | --- | --- |
   | Rule_2 | * | HTTPS: 443 | login.windows.net | Разрешает действие входа Windows |
   | Rule_3 | * | HTTPS: 443, http: 80 | < storage_account_name. BLOB. Core. Windows. NET > | Если кластер создается с помощью WASB, добавьте правило для WASB. Чтобы использовать только HTTPS-подключения, убедитесь, что в учетной записи хранения включено ["требуется безопасное перемещение"](https://docs.microsoft.com/azure/storage/common/storage-require-secure-transfer) . |

1. Нажмите кнопку **Добавить**.

   ![Заголовок. Введите сведения о коллекции правил приложения](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-app-rule-collection-details.png)

### <a name="configure-the-firewall-with-network-rules"></a>Настройка брандмауэра с помощью сетевых правил

Создайте сетевые правила для правильной настройки кластера HDInsight.

1. Выберите новый брандмауэр **Test-FW01** из портал Azure.
1. Щелкните **правила** в разделе **Параметры** > **коллекция** > сетевых правил**Добавить коллекцию правил сети**.
1. На экране **Добавить коллекцию правил сети** введите **имя**, **приоритет**и щелкните **Разрешить** в раскрывающемся меню **действие** .
1. В разделе **IP-адреса** создайте следующие правила.

   | **Name** | **Протокол** | **Исходный адрес** | **Адрес назначения** | **Конечный порт** | **Примечания** |
   | --- | --- | --- | --- | --- | --- |
   | Rule_1 | UDP | * | * | `123` | Служба времени |
   | Rule_2 | Any | * | DC_IP_Address_1, DC_IP_Address_2 | `*` | Если вы используете Корпоративный пакет безопасности (ESP), добавьте сетевое правило в раздел IP-адресов, который позволяет обмениваться данными с кластерами AAD-DS для ESP. IP-адреса контроллеров домена можно найти в разделе AAD-DS на портале. | 
   | Rule_3 | TCP | * | IP-адрес учетной записи Data Lake Storage | `*` | Если вы используете Azure Data Lake Storage, можно добавить сетевое правило в раздел IP-адресов, чтобы устранить проблемы SNI с ADLS 1-го поколения и Gen2. Этот параметр направляет трафик в брандмауэр, что может привести к увеличению затрат на загрузку больших данных, но этот трафик будет записываться в журнал и отслеживаться в журналах брандмауэра. Определите IP-адрес для учетной записи Data Lake Storage. Вы можете использовать команду PowerShell, например `[System.Net.DNS]::GetHostAddresses("STORAGEACCOUNTNAME.blob.core.windows.net")` , чтобы разрешить полное доменное имя в IP-адрес.|
   | Rule_4 | TCP | * | * | `12000` | Используемых Если вы используете Log Analytics, создайте сетевое правило в разделе IP-адреса, чтобы обеспечить взаимодействие с рабочей областью Log Analytics. |

1. Создайте следующие правила в разделе " **теги служб** ":

   | **Name** | **Протокол** | **Исходный адрес** | **Теги служб** | **Конечный порт** | **Примечания** |
   | --- | --- | --- | --- | --- | --- |
   | Rule_7 | TCP | * | SQL | `1433` | Настройте сетевое правило в разделе "Теги служб" для SQL, который позволит регистрировать и проверять трафик SQL, если конечные точки службы не настроены для SQL Server в подсети HDInsight, которая будет обходить брандмауэр. |

1. Нажмите кнопку **Добавить** , чтобы завершить создание коллекции правил сети.

   ![Заголовок. Введите коллекцию правил приложения](./media/hdinsight-restrict-outbound-traffic/hdinsight-restrict-outbound-traffic-add-network-rule-collection.png)

### <a name="create-and-configure-a-route-table"></a>Создание и настройка таблицы маршрутов

Создайте таблицу маршрутов со следующими записями:

1. Шесть адресов из [этого списка требуемых IP-адресов управления HDInsight](../hdinsight/hdinsight-management-ip-addresses.md) со следующим прыжком к **Интернету**:
    1. Четыре IP-адреса для всех кластеров во всех регионах
    1. Два IP-адреса, которые относятся к региону, в котором создается кластер
1. Один виртуальный маршрут виртуального устройства для IP-адреса 0.0.0.0/0 со следующим прыжком к частному IP-адресу брандмауэра Azure.

Например, чтобы настроить таблицу маршрутов для кластера, созданного в регионе США "Центральная часть США", выполните следующие действия.

1. Войдите на портал Azure.
1. Выберите свой брандмауэр Azure **Test-FW01**. Скопируйте **частный IP-адрес** , указанный на странице **Обзор** . В этом примере мы будем использовать **Пример адреса 10.1.1.4**
1. Создайте новую таблицу маршрутов.
1. В разделе **Параметры**щелкните **маршруты** .
1. Нажмите кнопку **Добавить** , чтобы создать маршруты для IP-адресов в таблице ниже.

| Имя маршрута | Префикс адреса | Тип следующего прыжка | Адрес следующего прыжка |
|---|---|---|---|
| 168.61.49.99 | 168.61.49.99/32 | Интернет | Н/Д |
| 23.99.5.239 | 23.99.5.239/32 | Интернет | Н/Д |
| 168.61.48.131 | 168.61.48.131/32 | Интернет | Н/Д |
| 138.91.141.162 | 138.91.141.162/32 | Интернет | Н/Д |
| 13.67.223.215 | 13.67.223.215/32 | Интернет | Н/Д |
| 40.86.83.253 | 40.86.83.253/32 | Интернет | Н/Д |
| 0.0.0.0 | 0.0.0.0/0 | Виртуальное устройство | 10.1.1.4 |

Завершите настройку таблицы маршрутов:

1. Назначьте созданную таблицу маршрутов в подсети HDInsight, щелкнув **подсети** в разделе **Параметры** , а затем **связав**.
1. На экране **связать подсеть** выберите виртуальную сеть, в которой был создан кластер, и **подсеть hdinsight** , которая использовалась для кластера hdinsight.
1. Нажмите кнопку **ОК**.

## <a name="edge-node-or-custom-application-traffic"></a>Трафик краевого узла или пользовательского приложения

Описанные выше действия позволят кластеру действовать без проблем. По-прежнему необходимо настроить зависимости для размещения пользовательских приложений, работающих на граничных узлах (если применимо).

Зависимости приложений должны быть идентифицированы и добавлены в брандмауэр Azure или таблицу маршрутов.

Необходимо создать маршруты для трафика приложения, чтобы избежать проблем с маршрутизацией.

Если у ваших приложений есть другие зависимости, их необходимо добавить в брандмауэр Azure. Создайте правила приложения, чтобы разрешать трафик протокола HTTP/HTTPS, и правила сети для всего остального.

## <a name="logging"></a>Ведение журнала

Брандмауэр Azure может отправить журналы в несколько различных систем хранения. Чтобы получить инструкции по настройке ведения журнала для брандмауэра, выполните действия, [описанные в учебнике. Мониторинг журналов и метрик](../firewall/tutorial-diagnostics.md)брандмауэра Azure.

После завершения настройки ведения журнала, если данные записываются в Log Analytics, можно просмотреть заблокированный трафик с помощью следующего запроса:

```
AzureDiagnostics | where msg_s contains "Deny" | where TimeGenerated >= ago(1h)
```

Интеграция брандмауэра Azure с журналами Azure Monitor полезна при первом получении приложения, работающего, если не известно о всех зависимостях приложения. См. дополнительные сведения о журналах Azure Monitor в статье [Анализ данных журнала в Azure Monitor](../azure-monitor/log-query/log-query-overview.md)

## <a name="access-to-the-cluster"></a>Доступ к кластеру
После успешной установки брандмауэра можно использовать внутреннюю конечную точку (`https://<clustername>-int.azurehdinsight.net`) для доступа к Ambari из виртуальной сети. Чтобы использовать общедоступную конечную точку (`https://<clustername>.azurehdinsight.net`) или конечную точку SSH (`<clustername>-ssh.azurehdinsight.net`), убедитесь в наличии правильных маршрутов в таблице маршрутов и настройке правил NSG, чтобы избежать проблем маршрутизации асимметричный, описанных [здесь](https://docs.microsoft.com/azure/firewall/integrate-lb).

## <a name="configure-another-network-virtual-appliance"></a>Настройка другого сетевого виртуального устройства

>[!Important]
> Следующие сведения требуются **только** в том случае, если требуется настроить сетевой виртуальный модуль (NVA), отличный от брандмауэра Azure.

Приведенные выше инструкции помогут настроить брандмауэр Azure, чтобы ограничивать исходящий трафик из кластера HDInsight. Брандмауэр Azure автоматически настраивается на разрешение трафика для многих распространенных важных сценариев. Если вы хотите использовать другой сетевой виртуальный модуль, необходимо вручную настроить ряд дополнительных функций. При настройке сетевого виртуального устройства учитывайте следующее:

* В разделе "Конечные точки" должны быть указаны конечные точки для включенных служб.
* Зависимости IP-адресов предназначены для трафика, отличного от HTTP и S (трафик TCP и UDP).
* Полные доменные конечные точки HTTP и HTTPS можно разместить на устройстве NVA.
* Конечные точки HTTP и HTTPS с подстановочными знаками — это зависимости, которые могут различаться в зависимости от количества квалификаторов.
* Назначьте таблицу маршрутов, созданную в подсети HDInsight.

### <a name="service-endpoint-capable-dependencies"></a>Зависимости конечной точки службы

| **Конечная точка** |
|---|
| Azure SQL |
| Служба хранилища Azure |
| Azure Active Directory |

#### <a name="ip-address-dependencies"></a>Зависимости IP-адреса

| **Конечная точка** | **Сведения** |
|---|---|
| \*:123 | Проверка часов NTP. Трафик проверяется в нескольких конечных точках на порте 123. |
| IP-адреса, опубликованные [здесь](hdinsight-management-ip-addresses.md) | Это служба HDInsight |
| Частные IP-адреса AAD DS для кластеров ESP |
| \*: 16800 для активации KMS Windows |
| \*12000 для Log Analytics |

#### <a name="fqdn-httphttps-dependencies"></a>Зависимости FQDN протокола HTTP/HTTPS

>[!Important]
> Приведенный ниже список содержит лишь несколько наиболее важных полных доменных имен. Полный список полных доменных имен для настройки NVA можно найти [в этом файле](https://github.com/Azure-Samples/hdinsight-fqdn-lists/blob/master/HDInsightFQDNTags.json).

| **Конечная точка**                                                          |
|---|
| azure.archive.ubuntu.com:80                                           |
| security.ubuntu.com:80                                                |
| ocsp.msocsp.com:80                                                    |
| ocsp.digicert.com:80                                                  |
| wawsinfraprodbay063.blob.core.windows.net:443                         |
| registry-1.docker.io:443                                              |
| auth.docker.io:443                                                    |
| production.cloudflare.docker.com:443                                  |
| download.docker.com:443                                               |
| us.archive.ubuntu.com:80                                              |
| download.mono-project.com:80                                          |
| packages.treasuredata.com:80                                          |
| security.ubuntu.com:80                                                |
| azure.archive.ubuntu.com:80                                                |
| ocsp.msocsp.com:80                                                |
| ocsp.digicert.com:80                                                |

## <a name="next-steps"></a>Следующие шаги

* [Архитектура виртуальной сети Azure HDInsight](hdinsight-virtual-network-architecture.md)
