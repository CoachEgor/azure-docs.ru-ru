---
title: Масштабирование размеров кластера в Azure HDInsight
description: Масштабирование кластера Azure HDInsight гибко, в соответствии с вашей рабочей нагрузки.
author: ashishthaps
ms.author: ashish
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.date: 06/10/2019
ms.openlocfilehash: b85277a4238351b6448c2cf29676ae3d8c118385
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67077205"
---
# <a name="scale-hdinsight-clusters"></a>Масштабирование кластеров HDInsight

HDInsight обеспечивает гибкость, предоставляя возможность увеличивать и уменьшать масштаб определенного количества рабочих узлов в кластерах. Это гибкость позволяет сжимать кластер в нерабочие часы или в выходные дни и разворачивать его при пиковых бизнес-требованиях.

При наличии периодических пакетной обработки, кластер HDInsight можно увеличить масштаб за несколько минут до этой операции, чтобы кластер имеет достаточный объем памяти и ресурсов процессора.  Позже после обработки, когда кластер HDInsight не требует интенсивного использования, можно уменьшить его масштаб для меньшего количества рабочих узлов.

Масштабирование кластера вручную с помощью одного из методов, описанных ниже, также можно использовать [автомасштабирования](hdinsight-autoscale-clusters.md) параметры, чтобы система могла автоматически увеличивать или уменьшать в ответ на ЦП, памяти и других метрик.

> [!NOTE]  
> Поддерживаются только кластеры HDInsight версии 3.1.3 или более поздней. Если вы не знаете версию кластера, см. страницу «Свойства».

## <a name="utilities-to-scale-clusters"></a>Служебные программы, масштабирование кластеров

Корпорация Майкрософт предоставляет следующие служебные программы для масштабирования кластеров:

|Служебная программа | Описание|
|---|---|
|[PowerShell Az](https://docs.microsoft.com/powershell/azure)|[SET-AzHDInsightClusterSize](https://docs.microsoft.com/powershell/module/az.hdinsight/set-azhdinsightclustersize) - ClusterName \<имя кластера > - TargetInstanceCount \<NewSize >|
|[PowerShell AzureRM](https://docs.microsoft.com/powershell/azure/azurerm) |[SET-AzureRmHDInsightClusterSize](https://docs.microsoft.com/powershell/module/azurerm.hdinsight/set-azurermhdinsightclustersize) - ClusterName \<имя кластера > - TargetInstanceCount \<NewSize >|
|[Интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/?view=azure-cli-latest)| [Изменение размера AZ hdinsight](https://docs.microsoft.com/cli/azure/hdinsight?view=azure-cli-latest#az-hdinsight-resize) --группы ресурсов \<группы ресурсов >--имя \<имя кластера >--счетчик целевых экземпляров \<NewSize >|
|[Интерфейс командной строки Azure](hdinsight-administer-use-command-line.md)|Изменение размера кластера Azure hdinsight \<Имя_кластера > \<счетчик целевых экземпляров > |
|[портал Azure](https://portal.azure.com)|Откройте панель кластера HDInsight, выберите **размер кластера** в меню слева, а затем на панели размер кластера, введите количество рабочих узлов и выберите Save.|  

![Изменение масштаба кластера](./media/hdinsight-scaling-best-practices/scale-cluster-blade.png)

С помощью любого из этих методов можно увеличивать или уменьшать масштаб кластера HDInsight за считанные минуты.

> [!IMPORTANT]  
> * Классический интерфейс командной строки Aure устарел и должен использоваться только с помощью классической модели развертывания. Все другие развертывания используйте [Azure CLI](https://docs.microsoft.com/cli/azure/?view=azure-cli-latest).  
> * Модуль PowerShell AzureRM является устаревшим.  Используйте [модуль Az](https://docs.microsoft.com/powershell/azure/new-azureps-module-az?view=azps-1.4.0) по возможности.

## <a name="impact-of-scaling-operations"></a>Влияние операций масштабирования

Когда вы **добавить** узлов в работающий кластер HDInsight (вертикальное масштабирование), все ожидающие или выполняемые задания не будут затронуты. Во время масштабирования можно безопасно передать новые задания. Если какой-либо причине произошел сбой операции масштабирования, чтобы оставить в нерабочем состоянии кластера будет обрабатываться сбоя.

Если вы **удалить** узлов (вниз), любые ожидающие или выполняемые задания будет ошибкой после завершения операции масштабирования. Это происходит из-за некоторые службы, перезапуск во время масштабирования. Кроме того, есть риск, кластер можно получить заблокированной в безопасном режиме во время операции масштабирования вручную.

Ниже представлены возможности, связанные с изменением количества узлов данных в кластере каждого типа, поддерживаемого в HDInsight:

* Apache Hadoop

    Вы можете легко увеличить количество рабочих узлов в работающем кластере Hadoop. Это не помешает обработке заданий в состоянии ожидания и выполнения. В ходе выполнения операции можно также отправлять новые задания. Сбои операции масштабирования обрабатываются корректно, поэтому кластер всегда пребывает в функциональном состоянии.

    Если уменьшить масштаб кластера Hadoop, сократив количество узлов данных, некоторые службы в нем будут перезапущены. Это приведет к сбою всех выполняющихся и ожидающих заданий при завершении операции масштабирования. Однако после завершения операции вы можете повторно отправить задания.

* Apache HBase

    Вы можете с легкостью добавлять и удалять узлы данных в работающем кластере HBase. Балансировка региональных серверов выполняется автоматически в течение нескольких минут после завершения операции масштабирования. Но их также можно сбалансировать вручную, выполнив вход в головной узел кластера и выполнив следующие команды в окне командной строки:

    ```bash
    pushd %HBASE_HOME%\bin
    hbase shell
    balancer
    ```

    Дополнительные сведения об использовании оболочки HBase см. в статье [Начало работы с примером Apache HBase в HDInsight](hbase/apache-hbase-tutorial-get-started-linux.md).

* Apache Storm

    Вы можете с легкостью добавлять и удалять узлы данных в работающем кластере Storm. Но после успешного завершения операции масштабирования потребуется повторная балансировка топологии.

    Повторную балансировку можно выполнить двумя способами:

  * с помощью веб-интерфейса Storm;
  * с помощью программы командной строки.

    Дополнительные сведения см. в [документации по Apache Storm](https://storm.apache.org/documentation/Understanding-the-parallelism-of-a-Storm-topology.html).

    В кластере HDInsight доступен веб-интерфейс Storm.

    ![HDInsight, Storm, масштабирование, перераспределение](./media/hdinsight-scaling-best-practices/hdinsight-portal-scale-cluster-storm-rebalance.png)

    Ниже приведен пример команды CLI для повторной балансировки топологии Storm:

    ```cli
    ## Reconfigure the topology "mytopology" to use 5 worker processes,
    ## the spout "blue-spout" to use 3 executors, and
    ## the bolt "yellow-bolt" to use 10 executors
    $ storm rebalance mytopology -n 5 -e blue-spout=3 -e yellow-bolt=10
    ```

## <a name="how-to-safely-scale-down-a-cluster"></a>Как безопасно увеличение или уменьшение масштаба кластера

### <a name="scale-down-a-cluster-with-running-jobs"></a>Масштаб кластера с процедурой запуска заданий

Чтобы избежать необходимости выполняющиеся задания завершаться ошибкой во время предусматривает уменьшение масштаба, попробуйте выполнить три действия:

1. Дождитесь заданий для выполнения перед уменьшением масштаба кластера.
1. Вручную завершите заданий.
1. После завершения операции масштабирования, повторно отправьте задания.

Чтобы просмотреть список ожидающих и выполняет задания, можно использовать YARN **пользовательского интерфейса диспетчера ресурсов**, сделав следующее:

1. Из [портала Azure](https://portal.azure.com/), выберите свой кластер.  Инструкции см. в разделе [Отображение кластеров](./hdinsight-administer-use-portal-linux.md#showClusters). Кластер откроется на новой странице портала.
2. В главном представлении откройте **панели мониторинга кластера** > **Ambari домашней**. Введите свои учетные данные кластера.
3. В пользовательском Интерфейсе Ambari выберите **YARN** в списке служб в меню слева.  
4. На странице YARN выберите **быстрые ссылки** и наведите указатель мыши на активный головной узел, а затем выберите **пользовательский Интерфейс ResourceManager**.

    ![Пользовательский интерфейс ResourceManager](./media/hdinsight-scaling-best-practices/resourcemanager-ui.png)

Прямой доступ к пользовательскому интерфейсу ResourceManager можно получить, щелкнув ссылку `https://<HDInsightClusterName>.azurehdinsight.net/yarnui/hn/cluster`.

Вы увидите список заданий и их текущее состояние. На снимке экрана есть одно задание в настоящее время:

![Приложения пользовательского интерфейса ResourceManager](./media/hdinsight-scaling-best-practices/resourcemanager-ui-applications.png)

Чтобы вручную завершить работу запущенного приложения, из оболочки SSH выполните команду ниже:

```bash
yarn application -kill <application_id>
```

Пример:

```bash
yarn application -kill "application_1499348398273_0003"
```

### <a name="getting-stuck-in-safe-mode"></a>Зависание в безопасном режиме

При уменьшении масштаба кластера, HDInsight использует интерфейсы управления Apache Ambari для вывода из эксплуатации дополнительных рабочих узлов, которые репликации их блоков HDFS на другие интерактивные рабочие узлы. После этого HDInsight безопасно масштабирует кластера. HDFS переходит в безопасный режим во время операции масштабирования и должно быть получено, после завершения масштабирования. В некоторых случаях Однако HDFS зависает в безопасном режиме во время операции масштабирования из-за репликации заниженных блока файла.

По умолчанию, HDFS настраивается с помощью `dfs.replication` параметр 3, которое определяет, сколько копий каждого блока файла доступны. Каждая копия блока файла хранится на другом узле кластера.

Когда HDFS обнаруживает, что ожидаемое количество копий блок недоступны, HDFS переходит в безопасный режим и создает предупреждения, Ambari. Если HDFS переходит в безопасный режим для операции масштабирования, но затем невозможно выйти из безопасного режима, так как необходимое количество узлов не обнаруживаются для репликации, кластер может зависнуть в безопасном режиме.

### <a name="example-errors-when-safe-mode-is-turned-on"></a>Примеры ошибок, когда включен безопасный режим

```
org.apache.hadoop.hdfs.server.namenode.SafeModeException: Cannot create directory /tmp/hive/hive/819c215c-6d87-4311-97c8-4f0b9d2adcf0. Name node is in safe mode.
```

```
org.apache.http.conn.HttpHostConnectException: Connect to hn0-clustername.servername.internal.cloudapp.net:10001 [hn0-clustername.servername. internal.cloudapp.net/1.1.1.1] failed: Connection refused
```

Вы можете изучить журналы узла имени в папке `/var/log/hadoop/hdfs/` примерно в то же время, когда было выполнено масштабирование кластера, чтобы проследить, когда был активирован безопасный режим. Файлам журнала присвоено имя `Hadoop-hdfs-namenode-hn0-clustername.*`.

Основной причиной ошибок выше является зависимость Hive от временных файлов в HDFS во время выполнения запросов. Когда HDFS переходит в безопасный режим, Hive не может выполнять запросы, так как не удается произвести запись в HDFS. Временные файлы в HDFS расположены на локальном диске, подключенном к виртуальным машинам с отдельным рабочим узлом, и реплицируются на другие рабочие узлы с минимальным количеством реплик — три.

### <a name="how-to-prevent-hdinsight-from-getting-stuck-in-safe-mode"></a>Как предотвратить зависание в безопасном режиме HDInsight

Есть несколько способов предотвратить зависание HDInsight в безопасном режиме.

* Остановите все задания Hive перед уменьшением масштаба HDInsight. Кроме того, можно запланировать операцию уменьшения масштаба, чтобы избежать конфликта с запущенными заданиями Hive.
* Вручную очистите пустые файлы в каталоге `tmp` Hive в HDFS, а затем приступите к уменьшению масштаба.
* Выполните уменьшение масштаба HDInsight как минимум до трех рабочих узлов. Старайтесь избежать масштабирования до одного рабочего узла.
* При необходимости выполните команду, чтобы отключить безопасный режим.

В разделах ниже описываются эти параметры.

#### <a name="stop-all-hive-jobs"></a>Остановка всех заданий Hive

Остановите все задания Hive перед уменьшением масштаба до одного рабочего узла. Если запланирована рабочая нагрузка, выполните уменьшение масштаба после завершения работы Hive.

Остановка задания Hive перед масштабированием, помогает свести к минимуму количество пустых файлов в папке tmp (если таковые имеются).

#### <a name="manually-clean-up-hives-scratch-files"></a>Очистка пустых файлов Hive вручную

Если при работе Hive остались временные файлы, их можно вручную очистить, а затем выполнить уменьшение масштаба, чтобы избежать активации безопасного режима.

1. Проверить расположение, где используется для хранения временных файлов Hive, просмотрев `hive.exec.scratchdir` свойство конфигурации. Этот параметр имеет значение в пределах `/etc/hive/conf/hive-site.xml`:

    ```xml
    <property>
        <name>hive.exec.scratchdir</name>
        <value>hdfs://mycluster/tmp/hive</value>
    </property>
    ```

1. Остановите службы Hive и убедитесь, что выполнены все задания и запросы.
2. Список содержимого каталога рабочей зоны, определенный выше, `hdfs://mycluster/tmp/hive/` для просмотра, если он содержит все файлы:

    ```bash
    hadoop fs -ls -R hdfs://mycluster/tmp/hive/hive
    ```

    Ниже приведен пример выходных данных при наличии файлов:

    ```output
    sshuser@hn0-scalin:~$ hadoop fs -ls -R hdfs://mycluster/tmp/hive/hive
    drwx------   - hive hdfs          0 2017-07-06 13:40 hdfs://mycluster/tmp/hive/hive/4f3f4253-e6d0-42ac-88bc-90f0ea03602c
    drwx------   - hive hdfs          0 2017-07-06 13:40 hdfs://mycluster/tmp/hive/hive/4f3f4253-e6d0-42ac-88bc-90f0ea03602c/_tmp_space.db
    -rw-r--r--   3 hive hdfs         27 2017-07-06 13:40 hdfs://mycluster/tmp/hive/hive/4f3f4253-e6d0-42ac-88bc-90f0ea03602c/inuse.info
    -rw-r--r--   3 hive hdfs          0 2017-07-06 13:40 hdfs://mycluster/tmp/hive/hive/4f3f4253-e6d0-42ac-88bc-90f0ea03602c/inuse.lck
    drwx------   - hive hdfs          0 2017-07-06 20:30 hdfs://mycluster/tmp/hive/hive/c108f1c2-453e-400f-ac3e-e3a9b0d22699
    -rw-r--r--   3 hive hdfs         26 2017-07-06 20:30 hdfs://mycluster/tmp/hive/hive/c108f1c2-453e-400f-ac3e-e3a9b0d22699/inuse.info
    ```

3. Если эти файлы обработаны Hive, их можно удалить. Просмотрите страницу пользовательского интерфейса Yarn ResourceManager, чтобы убедиться в отсутствии любых запущенных запросов Hive.

    Пример командной строки для удаления файлов из HDFS:

    ```bash
    hadoop fs -rm -r -skipTrash hdfs://mycluster/tmp/hive/
    ```

#### <a name="scale-hdinsight-to-three-or-more-worker-nodes"></a>Масштабирование HDInsight к менее трех рабочих узлов

Если предыдущие действия неэффективны кластеров задержаться в безопасном режиме, часто в том случае, при масштабировании до менее трех рабочих узлов, можно избежать поступающие в безопасном режиме можно не выполнять, оставив по крайней мере трех рабочих узлов кластера.

Сохраняя три рабочих узла является более затратным, чем уменьшение масштаба только одного рабочего узла, но он не позволит кластера задерживаются в безопасном режиме.

#### <a name="run-the-command-to-leave-safe-mode"></a>Выполнение команды для отключения безопасного режима

Последний вариант — выполнить команду оставьте безопасный режим. Если вы знаете, что причина безопасный режим HDFS заключается в том, из-за недостаточного репликации файлов Hive, можно выполнить следующую команду, чтобы отключить безопасный режим:

```bash
hdfs dfsadmin -D 'fs.default.name=hdfs://mycluster/' -safemode leave
```

### <a name="scale-down-an-apache-hbase-cluster"></a>Масштаб кластера Apache HBase

Региональные серверы автоматически выполняется балансировка нагрузки в течение нескольких минут после завершения операции масштабирования. Чтобы вручную распределить нагрузку между региональными серверами, выполните следующие действия:

1. Подключитесь к кластеру HDInsight по протоколу SSH. Дополнительные сведения см. в статье [Использование SSH с Hadoop на основе Linux в HDInsight из Linux, Unix или OS X](hdinsight-hadoop-linux-use-ssh-unix.md).

2. Запустите оболочку HBase:

    ```bash
    hbase shell
    ```

3. Используйте команду ниже, чтобы вручную распределить нагрузку между региональными серверами:

    ```bash
    balancer
    ```

## <a name="next-steps"></a>Дальнейшие действия

* [Автоматическое масштабирование кластеров Azure HDInsight](hdinsight-autoscale-clusters.md)
* [Введение в Azure HDInsight](hadoop/apache-hadoop-introduction.md)
