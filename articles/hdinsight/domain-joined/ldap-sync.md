---
title: Синхронизация LDAP в Ranger и Apache Ambari в Azure HDInsight
description: Устраните синхронизацию LDAP в Ranger и Ambari и предоставьте общие рекомендации.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.date: 02/14/2020
ms.openlocfilehash: 99bd1ac156b12a5be7b8c5c17eb5b568b7070a25
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "77463223"
---
# <a name="ldap-sync-in-ranger-and-apache-ambari-in-azure-hdinsight"></a>Синхронизация LDAP в Ranger и Apache Ambari в Azure HDInsight

Кластеры HDInsight Корпоративный пакет безопасности (ESP) используют Ranger для авторизации. Apache Ambari и Ranger синхронизируют пользователей и группы независимо друг от друга и работают немного иначе. Эта статья предназначена для решения синхронизации LDAP в Ranger и Ambari.

## <a name="general-guidelines"></a>Общие рекомендации

* Всегда развертывайте кластеры с группами.
* Вместо того чтобы изменять фильтры групп в Ambari и Ranger, попробуйте управлять всеми этими параметрами в Azure AD и использовать вложенные группы для переноса необходимых пользователей.
* После синхронизации пользователь не удаляется, даже если он не входит в группы.
* Если необходимо изменить фильтры LDAP напрямую, сначала используйте пользовательский интерфейс, так как он содержит некоторые проверки.

## <a name="users-are-synced-separately"></a>Пользователи синхронизируются отдельно

Ambari и Ranger не имеют общего доступа к пользовательской базе данных, так как они служат двум различным целям. Если пользователь должен использовать пользовательский интерфейс Ambari, необходимо синхронизировать пользователя с Ambari. Если пользователь не синхронизирован с Ambari, Пользовательский интерфейс или API-интерфейс Ambari отклонит его, но другие части системы будут работать (они защищены Ranger или диспетчер ресурсов и не Ambari). Если вы хотите включить пользователя в политику Ranger, выполните синхронизацию пользователя с Ranger.

При развертывании безопасного кластера участники группы синхронизируются транзитно (все подгруппы и их члены) как в Ambari, так и в Ranger. 

## <a name="ambari-user-sync-and-configuration"></a>Синхронизация и Настройка пользователей Ambari

С головных узлов задание cron выполняется `/opt/startup_scripts/start_ambari_ldap_sync.py` каждый час, чтобы запланировать синхронизацию пользователей. Задание cron вызывает API-интерфейсы Ambari для выполнения синхронизации. Сценарий отправляет список пользователей и групп для синхронизации (так как пользователи могут не принадлежать к указанным группам, оба указываются по отдельности). Ambari синхронизирует sAMAccountName как имя пользователя и всех членов группы, транзитно.

Журналы должны быть в `/var/log/ambari-server/ambari-server.log` . Дополнительные сведения см. в статье [Настройка уровня ведения журнала Ambari](https://docs.cloudera.com/HDPDocuments/Ambari-latest/administering-ambari/content/amb_configure_ambari_logging_level.html).

В кластерах Data Lake для создания домашних папок для синхронизированных пользователей и их настройки в качестве владельцев домашних папок используется обработчик записи после создания пользователя. Если пользователь не синхронизирован с Ambari правильным образом, пользователь может столкнуться со сбоями при доступе к промежуточным и временным папкам.

### <a name="update-groups-to-be-synced-to-ambari"></a>Обновление групп для синхронизации с Ambari

Если вы не можете управлять членством в группах в Azure AD, у вас есть два варианта:

* Выполните синхронизацию однократно, как описано выше, в разделе [синхронизация пользователей и групп LDAP](https://docs.cloudera.com/HDPDocuments/HDP3/latest/ambari-authentication-ldap-ad/content/authe_ldapad_synchronizing_ldap_users_and_groups.html). При каждом изменении членства в группе потребуется повторить синхронизацию.

* Напишите задание cron, периодически вызывайте [API Ambari](https://community.cloudera.com/t5/Support-Questions/How-do-I-automate-the-Ambari-LDAP-sync/m-p/96634) с новыми группами.

## <a name="ranger-user-sync-and-configuration"></a>Синхронизация и Настройка пользователей Ranger

Ranger имеет встроенный модуль синхронизации, который выполняется каждый час для синхронизации пользователей. Она не предоставляет доступ к пользовательской базе данных с помощью Ambari. HDInsight настраивает фильтр поиска для синхронизации пользователя с правами администратора, пользователя наблюдения и членов группы, указанной во время создания кластера. Элементы группы будут синхронизированы транзитным образом:

* Отключить добавочную синхронизацию.
* Включите карту синхронизации группы пользователей.
* Укажите фильтр поиска для включения транзитивных членов группы.
* Синхронизирует sAMAccountName для пользователей и атрибут Name для групп.

### <a name="group-or-incremental-sync"></a>Группа или Добавочная синхронизация

Ranger поддерживает параметр синхронизации группы, но он работает как пересечение с фильтром пользователей. Не объединение членства в группах и фильтра пользователей. Типичный вариант использования фильтра синхронизации групп в Ranger — фильтр группы: (DN = клустерадминграуп), Пользовательский фильтр: (City = Сиэтл).

Добавочная синхронизация работает только для пользователей, которые уже синхронизированы (в первый раз). Добавочная синхронизация не будет синхронизировать новых пользователей, добавленных в группы после начальной синхронизации.

### <a name="update-ranger-sync-filter"></a>Обновление фильтра синхронизации Ranger

Фильтр LDAP можно найти в пользовательском интерфейсе Ambari в разделе конфигурации Ranger User-Sync. Существующий фильтр будет иметь вид `(|(userPrincipalName=bob@contoso.com)(userPrincipalName=hdiwatchdog-core01@CONTOSO.ONMICROSOFT.COM)(memberOf:1.2.840.113556.1.4.1941:=CN=hadoopgroup,OU=AADDC Users,DC=contoso,DC=onmicrosoft,DC=com))` . Убедитесь, что в конце добавлен предикат, и проверьте фильтр, используя `net ads` команду поиска или ldp.exe или что-то подобное.

## <a name="ranger-user-sync-logs"></a>Журналы синхронизации пользователей Ranger

Синхронизация пользователей Ranger может происходить из любой из головных узлах. Журналы находятся в `/var/log/ranger/usersync/usersync.log` . Чтобы увеличить уровень детализации журналов, выполните следующие действия.

1. Войдите в Ambari.
1. Перейдите к разделу конфигурации Ranger.
1. Перейдите к разделу Advanced **усерсинк-log4j** .
1. Измените `log4j.rootLogger` уровень на на `DEBUG` (после изменения он должен выглядеть как `log4j.rootLogger = DEBUG,logFile,FilterLog` ).
1. Сохраните конфигурацию и перезапустите Ranger.

## <a name="next-steps"></a>Дальнейшие шаги

* [Проблемы проверки подлинности в Azure HDInsight](./domain-joined-authentication-issues.md)
* [Синхронизация пользователей Microsoft Azure AD с кластером HDInsight](../hdinsight-sync-aad-users-to-cluster.md)
