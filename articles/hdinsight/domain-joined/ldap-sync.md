---
title: LDAP синхронизируется в Ranger и Apache Ambari в Azure HDInsight
description: Адрес LDAP синхронизации в Ranger и Ambari и представить общие руководящие принципы.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.date: 02/14/2020
ms.openlocfilehash: 99bd1ac156b12a5be7b8c5c17eb5b568b7070a25
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77463223"
---
# <a name="ldap-sync-in-ranger-and-apache-ambari-in-azure-hdinsight"></a>LDAP синхронизируется в Ranger и Apache Ambari в Azure HDInsight

Кластеры HDInsight Enterprise Security Package (ESP) используют Ranger для авторизации. Apache Ambari и Ranger синхронизируют пользователей и группы независимо друг от друга и работают немного по-другому. Эта статья предназначена для решения ldAP синхронизации в Ranger и Ambari.

## <a name="general-guidelines"></a>Общие рекомендации

* Всегда развертывайте кластеры с группами.
* Вместо того, чтобы менять групповые фильтры в Ambari и Ranger, попробуйте управлять всеми этими в Azure AD и использовать вложенные группы для привлечения необходимых пользователей.
* После синхронизации пользователя он не удаляется, даже если пользователь не является частью группы.
* Если вам нужно изменить фильтры LDAP напрямую, сначала используйте uI, поскольку он содержит некоторые проверки.

## <a name="users-are-synced-separately"></a>Пользователи синхронизируются отдельно

Ambari и Ranger не разделяют базу данных пользователей, поскольку они служат двум различным целям. Если пользователю необходимо использовать пользовательский интерфейс Ambari, то пользователь должен быть синхронизирован с Ambari. Если пользователь не синхронизирован с Ambari, Ambari UI / API откажется от него, но другие части системы будут работать (они охраняются Ranger или менеджером ресурсов, а не Ambari). Если вы хотите включить пользователя в политику Ranger, синхронизируйте пользователя с Ranger.

При развертывании безопасного кластера члены группы синхронизируются транзитно (все подгруппы и их члены) как для Ambari, так и для Ranger. 

## <a name="ambari-user-sync-and-configuration"></a>Синхронизация и конфигурация пользователя Ambari

От головных узлов, задания `/opt/startup_scripts/start_ambari_ldap_sync.py`cron, работает каждый час, чтобы запланировать синхронизацию пользователя. Задание cron вызывает AI-аДО для отдыха Ambari для выполнения синхронизации. Скрипт отправляет список пользователей и групп для синхронизации (так как пользователи не могут принадлежать к указанным группам, обе указаны индивидуально). Ambari синхронизирует sAMAccountName как имя пользователя и всех членов группы, транзитно.

Бревна должны `/var/log/ambari-server/ambari-server.log`быть в . Для получения дополнительной информации [см.](https://docs.cloudera.com/HDPDocuments/Ambari-latest/administering-ambari/content/amb_configure_ambari_logging_level.html)

В кластерах Data Lake крючок создания пользователя используется для создания домашних папок для синхронизированных пользователей, и они устанавливаются в качестве владельцев домашних папок. Если пользователь не синхронизирован с Ambari правильно, то пользователь может столкнуться с сбоями в доступе к постановке и другим временным папкам.

### <a name="update-groups-to-be-synced-to-ambari"></a>Обновление групп, которые будут синхронизированы с Ambari

Если вы не можете управлять членством групп в Azure AD, у вас есть два варианта:

* Выполните один раз синхронизации, как описано более полно на [синхронизации LDAP пользователей и групп.](https://docs.cloudera.com/HDPDocuments/HDP3/latest/ambari-authentication-ldap-ad/content/authe_ldapad_synchronizing_ldap_users_and_groups.html) Всякий раз, когда членство в группе изменяется, вам придется сделать это синхронизации снова.

* Напишите задание, периодически звоните [в API Ambari](https://community.cloudera.com/t5/Support-Questions/How-do-I-automate-the-Ambari-LDAP-sync/m-p/96634) с новыми группами.

## <a name="ranger-user-sync-and-configuration"></a>Синхронизация и конфигурация пользователя Ranger

Ranger имеет встроенный механизм синхронизации, который работает каждый час для синхронизации пользователей. Он не делится базой данных пользователей с Ambari. HDInsight настраивает фильтр поиска для синхронизации пользователя-админ, пользователя сторожевой собаки и членов группы, указанных в ходе создания кластера. Члены группы будут синхронизированы транзитно:

* Отключить инкрементную синхронизацию.
* Включить карту синхронизации группы пользователей.
* Укажите фильтр поиска, чтобы включить членов транзитной группы.
* Синхронизация sAMAccountName для пользователей и атрибут имени для групп.

### <a name="group-or-incremental-sync"></a>Групповая или инкрементная синхронизация

Ranger поддерживает опцию синхронизации группы, но он работает как пересечение с пользовательским фильтром. Не является союзом между членством в группе и пользовательским фильтром. Типичным случаем использования для фильтра групповой синхронизации в Ranger является - групповой фильтр: (dn'clusteradmingroup), пользовательский фильтр: (город- seattle).

Инкрементная синхронизация работает только для пользователей, которые уже синхронизированы (в первый раз). Incremental не будет синхронизировать новых пользователей, добавленных в группы после первоначальной синхронизации.

### <a name="update-ranger-sync-filter"></a>Обновление фильтра синхронизации Ranger

Фильтр LDAP можно найти в пользовательском интерфейсе Ambari в разделе конфигурации синхронизации пользователя Ranger. Существующий фильтр будет в `(|(userPrincipalName=bob@contoso.com)(userPrincipalName=hdiwatchdog-core01@CONTOSO.ONMICROSOFT.COM)(memberOf:1.2.840.113556.1.4.1941:=CN=hadoopgroup,OU=AADDC Users,DC=contoso,DC=onmicrosoft,DC=com))`форме. Убедитесь, что вы добавляете предикат в `net ads` конце и тестируете фильтр с помощью команды поиска или ldp.exe или что-то подобное.

## <a name="ranger-user-sync-logs"></a>Журналы синхронизации пользователей Ranger

Синхронизация пользователя Ranger может произойти из любого из headnodes. Бревна находятся в `/var/log/ranger/usersync/usersync.log`. Чтобы повысить многословность журналов, сделайте следующие шаги:

1. Зайдите в Амбари.
1. Перейдите в раздел конфигурации Ranger.
1. Перейдите в раздел Расширенный **usersync-log4j.**
1. Изменение `log4j.rootLogger` уровня `DEBUG` (После изменения это `log4j.rootLogger = DEBUG,logFile,FilterLog`должно выглядеть).
1. Сохранить конфигурацию и перезапустить рейнджера.

## <a name="next-steps"></a>Дальнейшие действия

* [Проблемы аутентификации в Azure HDInsight](./domain-joined-authentication-issues.md)
* [Синхронизация пользователей Microsoft Azure AD с кластером HDInsight](../hdinsight-sync-aad-users-to-cluster.md)
