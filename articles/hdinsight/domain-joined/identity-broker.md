---
title: Использование брокера ИДЕНТИФИКАТОРов (Предварительная версия) для управления учетными данными — Azure HDInsight
description: Дополнительные сведения о брокере ИДЕНТИФИКАТОРов HDInsight для упрощения проверки подлинности присоединенных к домену кластеров Apache Hadoop.
ms.service: hdinsight
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.topic: how-to
ms.date: 09/23/2020
ms.openlocfilehash: 24f15b8a4d5a5afd3a2794fe686d3acb0036cdd8
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91565332"
---
# <a name="azure-hdinsight-id-broker-preview"></a>Брокер ИДЕНТИФИКАТОРов Azure HDInsight (Предварительная версия)

В этой статье описывается, как настроить и использовать функцию брокера ИДЕНТИФИКАТОРов HDInsight (ХИБ) в Azure HDInsight. Эту функцию можно использовать для получения современной проверки подлинности OAuth в Apache Ambari с применением поддержки многофакторной проверки подлинности (MFA) без необходимости использовать устаревшие хэши паролей в Azure Active Directory доменных служб (AAD-DS).

## <a name="overview"></a>Обзор

ХИБ упрощает настройку сложных проверок подлинности в следующих сценариях:

* Ваша организация полагается на Федерацию для проверки подлинности пользователей при доступе к облачным ресурсам. Ранее для использования кластеров HDInsight Корпоративный пакет безопасности (ESP) необходимо включить синхронизацию хэша паролей из локальной среды для Azure Active Directory (Azure AD). Это требование может быть затруднительным или нежелательным для некоторых организаций.

* Ваша организация хочет применить MFA для доступа через Интернет или HTTP к Apache Ambari и другим ресурсам кластера.

ХИБ предоставляет инфраструктуру проверки подлинности, которая позволяет переводить протокол с OAuth (современный) на Kerberos (устаревший) без необходимости синхронизации хэшей паролей с AAD-DS. Эта инфраструктура состоит из компонентов, работающих на виртуальной машине Windows Server (узел брокера ИДЕНТИФИКАТОРов), а также на узлах шлюза кластера.

Используйте следующую таблицу, чтобы определить оптимальный вариант проверки подлинности в зависимости от потребностей Организации.

|Параметры проверки подлинности |Конфигурация HDInsight | Факторы, которые следует учитывать |
|---|---|---|
| Полное OAuth | ESP + ХИБ | 1. наиболее безопасный вариант (поддерживается MFA) 2.    Передача хэш-синхронизации не требуется. 3.  Нет доступа SSH/kinit/keytab для локальных учетных записей, у которых нет хэша пароля в AAD-DS. 4.   Только облачные учетные записи по-прежнему могут SSH/kinit/keytab. 5. Доступ через веб-интерфейс к Ambari через OAuth 6.  Требуется обновление устаревших приложений (JDBC/ODBC и т. д.) для поддержки OAuth.|
| Аутентификация OAuth + обычная проверка подлинности | ESP + ХИБ | 1. веб-доступ к Ambari через OAuth 2. Устаревшие приложения продолжают использовать обычную проверку подлинности. 3. Для базового доступа к проверке подлинности необходимо отключить MFA. 4. Передача хэш-синхронизации не требуется. 5. Нет доступа SSH/kinit/keytab для локальных учетных записей, у которых нет хэша пароля в AAD-DS. 6. Только облачные учетные записи по-прежнему могут быть SSH/kinit. |
| Полностью базовая проверка подлинности | ESP | 1. Аналогично локальным настройкам. 2. Требуется синхронизация хэша паролей с AAD-DS. 3. Локальные учетные записи могут использовать SSH/kinit или keytab. 4. Если резервное хранилище имеет ADLS 2-го поколения, MFA необходимо отключить. |

На следующей схеме показан современный поток проверки подлинности на основе OAuth для всех пользователей, включая федеративных пользователей, после включения компонента ID Broker:

:::image type="content" source="media/identity-broker/identity-broker-architecture.png" alt-text="Поток проверки подлинности с брокером ИДЕНТИФИКАТОРов":::

На этой схеме клиент (например, браузер или приложения) должен сначала получить маркер OAuth, а затем предоставить маркер шлюзу в HTTP-запросе. Если вы уже вошли в другие службы Azure, например портал Azure, вы можете войти в кластер HDInsight с помощью единого входа.

По-прежнему может быть несколько устаревших приложений, поддерживающих только обычную проверку подлинности (например, имя пользователя и пароль). Для этих сценариев по-прежнему можно использовать обычную проверку подлинности HTTP для подключения к шлюзам кластера. В этой настройке необходимо обеспечить сетевое подключение между узлами шлюза и конечной точкой Федерации (AD FS конечной точкой), чтобы обеспечить прямую отправку информации из узлов шлюза. 

На следующей схеме показана обычная последовательность проверки подлинности для федеративных пользователей. Во-первых, шлюз пытается выполнить проверку подлинности с помощью [потока ропк](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth-ropc) и в случае, если хэши паролей не синхронизированы с Azure AD, он возвращается для обнаружения конечной точки AD FS и выполнения проверки подлинности путем доступа к конечной точке AD FS.

:::image type="content" source="media/identity-broker/basic-authentication.png" alt-text="Поток проверки подлинности с брокером ИДЕНТИФИКАТОРов":::


## <a name="enable-hdinsight-id-broker"></a>Включение брокера ИДЕНТИФИКАТОРов HDInsight

Чтобы создать кластер ESP с включенным компонентом ID Broker, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com).
1. Выполните базовые действия по созданию кластера ESP. Дополнительные сведения см. в статье [Создание кластера HDInsight с помощью ESP](apache-domain-joined-configure-using-azure-adds.md#create-an-hdinsight-cluster-with-esp).
1. Выберите **включить брокер идентификаторов HDInsight**.

Компонент брокера ID добавит в кластер одну лишнюю виртуальную машину. Эта виртуальная машина является узлом брокера ИДЕНТИФИКАТОРов и включает серверные компоненты для поддержки проверки подлинности. Узел брокера ИДЕНТИФИКАТОРов присоединен к домену Azure AD DS.

![Параметр для включения брокера ИДЕНТИФИКАТОРов](./media/identity-broker/identity-broker-enable.png)

### <a name="using-azure-resource-manager-templates"></a>Использование шаблонов Azure Resource Manager
При добавлении новой роли `idbrokernode` с именем со следующими атрибутами в профиль вычислений шаблона будет создан кластер с включенным УЗЛОМ ID Broker:

```json
.
.
.
"computeProfile": {
    "roles": [
        {
            "autoscale": null,
            "name": "headnode",
           ....
        },
        {
            "autoscale": null,
            "name": "workernode",
            ....
        },
        {
            "autoscale": null,
            "name": "idbrokernode",
            "targetInstanceCount": 1,
            "hardwareProfile": {
                "vmSize": "Standard_A2_V2"
            },
            "virtualNetworkProfile": {
                "id": "string",
                "subnet": "string"
            },
            "scriptActions": [],
            "dataDisksGroups": null
        }
    ]
}
.
.
.
```

## <a name="tool-integration"></a>Интеграция средств

Средства Хдиснгис обновлены для встроенной поддержки OAuth. Мы настоятельно рекомендуем использовать эти средства для современного доступа к кластерам на основе OAuth. [Подключаемый модуль HDInsight IntelliJ](https://docs.microsoft.com/azure/hdinsight/spark/apache-spark-intellij-tool-plugin#integrate-with-hdinsight-identity-broker-hib) можно использовать для приложений на основе Java, таких как Scala. Для заданий PySpark и Hive можно использовать [инструменты Hive для VS Code Spark &](https://docs.microsoft.com/azure/hdinsight/hdinsight-for-vscode) . Они поддерживают как пакетные, так и Интерактивные задания.

## <a name="ssh-access-without-a-password-hash-in-azure-ad-ds"></a>Доступ по протоколу SSH без хэша пароля в Azure AD DS

|Параметры SSH |Факторы, которые следует учитывать |
|---|---|
| Локальная учетная запись виртуальной машины (например, sshuser) | 1. Вы указали эту учетную запись во время создания кластера. 2.  Для этой учетной записи нет аусикатион Kerberos |
| Учетная запись только в облаке (например, alice@contoso.onmicrosoft.com ) | 1. хэш пароля доступен в AAD-DS 2. Проверка подлинности Kerberos возможна через SSH Kerberos |
| Локальная учетная запись (например, alice@contoso.com ) | 1. Проверка подлинности SSH Kerberos возможна только в том случае, если хэш пароля доступен в AAD-DS, иначе этот пользователь не может получить доступ к кластеру по протоколу SSH |

Для подключения SSH к виртуальной машине, присоединенной к домену, или для выполнения `kinit` команды необходимо указать пароль. Для аутентификации SSH Kerberos требуется, чтобы хэш был доступен в AAD-DS. Если вы хотите использовать SSH только в административных сценариях, можно создать одну облачную учетную запись и использовать ее для подключения к кластеру по протоколу SSH. Другие локальные пользователи по-прежнему могут использовать средства Ambari или HDInsight или обычную проверку подлинности HTTP без использования хэша паролей в AAD-DS.

Если ваша организация не синхронизирует хэши паролей с AAD-DS, рекомендуется создать одного облачного пользователя в Azure AD и назначить его администратором кластера при создании кластера и использовать его для административных целей, включая получение корневого доступа к виртуальным машинам по протоколу SSH.

Чтобы устранить проблемы с проверкой подлинности, ознакомьтесь с этим [руководством](https://docs.microsoft.com/azure/hdinsight/domain-joined/domain-joined-authentication-issues).

## <a name="clients-using-oauth-to-connect-to-hdinsight-gateway-with-hib"></a>Клиенты, использующие OAuth для подключения к шлюзу HDInsight с помощью ХИБ

В программе установки ХИБ можно обновить пользовательские приложения и клиенты, подключающиеся к шлюзу, чтобы сначала получить требуемый маркер OAuth. Вы можете выполнить действия, описанные в этом [документе](https://docs.microsoft.com/azure/storage/common/storage-auth-aad-app) , чтобы получить маркер со следующими сведениями:

*   URI ресурса OAuth: `https://hib.azurehdinsight.net` 
*   AppId: 7865c1d2-F040-46cc-875f-831a1ef6a28a
*   Разрешение: (имя: Cluster. ReadWrite, идентификатор: 8f89faa0-ffef-4007-974d-4989b39ad77d)

После получения маркера OAuth его можно использовать в заголовке авторизации HTTP-запроса к шлюзу кластера (например, https:// <clustername> -int.azurehdinsight.NET). Например, пример команды с фигурой на API Apache Livy может выглядеть следующим образом:
    
```bash
curl -k -v -H "Authorization: Bearer Access_TOKEN" -H "Content-Type: application/json" -X POST -d '{ "file":"wasbs://mycontainer@mystorageaccount.blob.core.windows.net/data/SparkSimpleTest.jar", "className":"com.microsoft.spark.test.SimpleFile" }' "https://<clustername>-int.azurehdinsight.net/livy/batches" -H "X-Requested-By:<username@domain.com>"
``` 

## <a name="next-steps"></a>Дальнейшие шаги

* [Настройка кластера HDInsight с Корпоративный пакет безопасности с помощью доменных служб Azure Active Directory](apache-domain-joined-configure-using-azure-adds.md)
* [Синхронизация пользователей Azure Active Directory с кластером HDInsight](../hdinsight-sync-aad-users-to-cluster.md)
* [Мониторинг производительности кластера](../hdinsight-key-scenarios-to-monitor.md)
