---
title: Корпоративная безопасность с помощью Azure AD DS — Azure HDInsight
description: Узнайте, как настроить и настроить кластер HDInsight Корпоративный пакет безопасности с помощью доменных служб Azure Active Directory.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.custom: seodec18
ms.date: 10/02/2019
ms.openlocfilehash: 01de2173ee5d55f24f97e1d057e96d93a56c2af0
ms.sourcegitcommit: f4f626d6e92174086c530ed9bf3ccbe058639081
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/25/2019
ms.locfileid: "75435973"
---
# <a name="enterprise-security-package-configurations-with-azure-active-directory-domain-services-in-hdinsight"></a>Корпоративный пакет безопасности конфигураций с помощью доменных служб Azure Active Directory в HDInsight

Кластеры Azure HDInsight обеспечивают многопользовательский доступ к кластерам Корпоративный пакет безопасности (ESP). Кластеры HDInsight с корпоративным пакетом безопасности подключаются к доменам. Таким образом, пользователи домена могут использовать свои учетные данные домена для проверки подлинности в кластерах и выполнения заданий по обработке больших объемов данных.

Из этой статьи вы узнаете, как настроить кластер HDInsight с использованием протокола ESP с помощью Azure Active Directory доменных служб (Azure AD DS).

> [!NOTE]  
> Протокол ESP общедоступен в HDInsight 3,6 и 4,0 для следующих типов кластера: Apache Spark, Interactive, Hadoop и HBase. ESP для типа кластера Apache Kafka находится в режиме предварительной версии с поддержкой наилучшей поддержки. Кластеры ESP, созданные до даты протокола ESP (1 октября 2018), не поддерживаются.

## <a name="enable-azure-ad-ds"></a>Включение Azure AD DS

> [!NOTE]  
> Только администраторы клиента имеют права на включение AD DS Azure. Если хранилище кластера имеет Azure Data Lake Storage 1-го поколения или Gen2, необходимо отключить многофакторную идентификацию Azure только для тех пользователей, которым требуется доступ к кластеру с использованием обычной проверки подлинности Kerberos. 
>
> Вы можете использовать [Надежные IP-адреса](../../active-directory/authentication/howto-mfa-mfasettings.md#trusted-ips) или [Условный доступ](../../active-directory/conditional-access/overview.md) , чтобы отключить многофакторную проверку подлинности для конкретных пользователей, *только* если они обращаются к диапазону IP для виртуальной сети кластера HDInsight. Если вы используете условный доступ, убедитесь, что конечная точка службы Active Directory включена в виртуальной сети HDInsight.
>
> Если хранилище кластера является хранилищем BLOB-объектов Azure, не отключайте многофакторную проверку подлинности.

Для создания кластера HDInsight с помощью ESP необходимо включить AD DS Azure. Дополнительные сведения см. [в статье включение Azure Active Directory доменных служб с помощью портал Azure](../../active-directory-domain-services/tutorial-create-instance.md). 

Когда AD DS Azure включен, все пользователи и объекты начинают синхронизацию из Azure Active Directory (Azure AD) с AD DS Azure по умолчанию. Продолжительность операции синхронизации зависит от числа объектов в Azure AD. Синхронизация может занять несколько дней для сотен тысяч объектов. 

Для работы с HDInsight имя домена, используемое в AD DS Azure, не должно содержать 39 символов или меньше.

Можно выбрать синхронизацию только тех групп, которым требуется доступ к кластерам HDInsight. Этот вариант синхронизации только определенных групп называется *синхронизацией определенных объектов*. Инструкции см. в статье [Настройка синхронизации с заданной областью из Azure AD в управляемый домен](../../active-directory-domain-services/scoped-synchronization.md).

При включении защищенного протокола LDAP укажите имя домена в имени субъекта и альтернативное имя субъекта в сертификате. Например, если ваше доменное имя — *contoso100.onmicrosoft.com*, убедитесь, что в сертификате существует такое же имя субъекта или альтернативное имя субъекта. Дополнительные сведения см. в разделе [Настройка защищенного протокола LDAP (LDAPS) для управляемого домена доменных служб Azure AD](../../active-directory-domain-services/tutorial-configure-ldaps.md). 

В следующем примере создается самозаверяющий сертификат. Доменное имя *contoso100.onmicrosoft.com* находится в `Subject` (имя субъекта) и `DnsName` (альтернативное имя субъекта).

```powershell
$lifetime=Get-Date
New-SelfSignedCertificate -Subject contoso100.onmicrosoft.com `
  -NotAfter $lifetime.AddDays(365) -KeyUsage DigitalSignature, KeyEncipherment `
  -Type SSLServerAuthentication -DnsName *.contoso100.onmicrosoft.com, contoso100.onmicrosoft.com
```

## <a name="check-azure-ad-ds-health-status"></a>Проверка состояния работоспособности AD DS Azure
Просмотрите состояние работоспособности Azure Active Directory доменных служб, выбрав **работоспособность** в категории **Управление** . Убедитесь, что AD DS Azure имеет значение зеленый (работает) и синхронизация завершена.

![Работоспособность AD DS Azure](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-aadds-health.png)

## <a name="create-and-authorize-a-managed-identity"></a>Создание и авторизация управляемого удостоверения

Вы можете использовать *управляемое пользователем удостоверение* для упрощения и защиты операций доменных служб. При назначении управляемому удостоверению роли **участника доменных служб HDInsight** она может читать, создавать, изменять и удалять операции доменных служб. 

Некоторые операции доменных служб, такие как создание подразделений и субъектов-служб, необходимы для Корпоративный пакет безопасности HDInsight. Вы можете создавать управляемые удостоверения в любой подписке. Дополнительные сведения об управляемых удостоверениях см. в статье [управляемые удостоверения для ресурсов Azure](../../active-directory/managed-identities-azure-resources/overview.md). Дополнительные сведения о работе управляемых удостоверений в Azure HDInsight см. [в статье управляемые удостоверения в Azure hdinsight](../hdinsight-managed-identities.md).

Чтобы настроить кластеры ESP, создайте управляемое пользователем удостоверение, если оно еще не установлено. Инструкции см. в разделе [Создание, перечисление, удаление или назначение роли назначенному пользователем управляемому удостоверению с помощью портал Azure](../../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal.md). 

Затем назначьте роль **участника доменных служб HDInsight** управляемому удостоверению в службе **контроля доступа** для Azure AD DS. Чтобы назначить эту роль, необходимы права администратора AD DS Azure.

![Служба контроля доступа доменных служб Azure Active Directory](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-configure-managed-identity.png)

Назначение роли **участника доменных служб HDInsight** гарантирует, что это удостоверение имеет правильный (от имени) доступ для выполнения операций доменных служб в домене AD DS Azure. Эти операции включают создание и удаление подразделений.

После создания управляемого удостоверения и присвоения ему правильной роли администратор AD DS Azure может настроить, кто может использовать это управляемое удостоверение. Сначала администратор выбирает управляемое удостоверение на портале, а затем выбирает **Управление доступом (IAM)** в разделе **Обзор**. Затем, в правой части, администратор назначает роль **управляемого оператора идентификации** пользователям или группам, которым требуется создавать кластеры HDInsight ESP. 

Например, администратор AD DS Azure может назначить эту роль группе **маркетингтеам** для управляемого удостоверения **сжмси** , как показано на следующем рисунке. Это назначение гарантирует, что нужные сотрудники Организации смогут использовать управляемое удостоверение для создания кластеров ESP.

![Назначение роли оператора управляемого удостоверения HDInsight](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-managed-identity-operator-role-assignment.png)

## <a name="network-considerations"></a>Рекомендации относительно сети

> [!NOTE]  
> AD DS Azure необходимо развернуть в виртуальной сети на основе Azure Resource Manager. Классические виртуальные сети не поддерживаются для Azure AD DS. Дополнительные сведения см. [в статье включение Azure Active Directory доменных служб с помощью портал Azure](../../active-directory-domain-services/tutorial-create-instance-advanced.md#create-and-configure-the-virtual-network).

После включения AD DS Azure локальный сервер службы доменных имен (DNS) будет работать на виртуальных машинах Active Directory. Настройте виртуальную сеть Azure AD DS для использования этих пользовательских DNS-серверов. Чтобы найти нужные IP-адреса, выберите **Свойства** в категории **Управление** и просмотрите раздел **IP-адрес в виртуальной сети**.

![Поиск IP-адресов для локальных DNS-серверов](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-aadds-dns1.png)

Измените конфигурацию DNS-серверов в виртуальной сети Azure AD DS, чтобы использовать эти настраиваемые IP-адреса, выбрав **серверы DNS** в категории **Параметры** . Затем выберите параметр **Custom (пользовательский** ), введите первый IP-адрес в текстовом поле и нажмите кнопку **сохранить**. Добавьте дополнительные IP-адреса, выполнив те же действия.

![Обновление конфигурации DNS виртуальной сети](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-aadds-vnet-configuration.png)

Проще разместить экземпляр Azure AD DS и кластер HDInsight в одной и той же виртуальной сети Azure. Если вы планируете использовать разные виртуальные сети, необходимо выполнить одноранговую связь между виртуальными сетями, чтобы контроллер домена был виден виртуальным машинам HDInsight. Дополнительные сведения см. в статье [Пиринг между виртуальными сетями](../../virtual-network/virtual-network-peering-overview.md). 

После пиринга между виртуальными сетями настройте виртуальную сеть HDInsight для использования пользовательского DNS-сервера и введите в качестве адресов DNS-серверов в качестве адреса сервера Azure Private IP AD DS. Если обе виртуальные сети используют одни и те же DNS-серверы, имя личного домена будет разрешаться в правильный IP-адрес и будет доступен из HDInsight. Например, если доменное имя — `contoso.com`, после выполнения этого шага `ping contoso.com` должен разрешаться в правильный IP-адрес AD DS Azure.

![Настройка пользовательских DNS-серверов для одноранговой виртуальной сети](./media/apache-domain-joined-configure-using-azure-adds/hdinsight-aadds-peered-vnet-configuration.png)

Если вы используете правила группы безопасности сети (NSG) в подсети HDInsight, необходимо разрешить [необходимые IP-адреса](../hdinsight-management-ip-addresses.md) для входящего и исходящего трафика.

Чтобы проверить, правильно ли настроена сеть, присоедините виртуальную машину Windows к виртуальной сети или подсети HDInsight и проверьте связь с доменным именем. (Он должен разрешаться в IP-адрес.) Запустите **LDP. exe** для доступа к домену Azure AD DS. Затем присоедините эту виртуальную машину Windows к домену, чтобы убедиться в успешности всех необходимых вызовов RPC между клиентом и сервером. 

Можно также использовать **nslookup** для подтверждения сетевого доступа к вашей учетной записи хранения или любой внешней базе данных, которую можно использовать (например, External хранилище метаданных Hive или Ranger DB). Убедитесь, что все [необходимые порты](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd772723(v=ws.10)#communication-to-domain-controllers) разрешены в ПРАВИЛАх NSG подсети Azure AD DS, если NSG помогает защитить AD DS Azure. Если домен присоединяется к этой виртуальной машине Windows успешно, можно перейти к следующему шагу и создать кластеры ESP.

## <a name="create-an-hdinsight-cluster-with-esp"></a>Создание кластера HDInsight с помощью ESP

После правильной настройки предыдущих шагов необходимо создать кластер HDInsight с включенным протоколом ESP. При создании кластера HDInsight можно включить Корпоративный пакет безопасности на вкладке **безопасность и сеть** . Если вы предпочитаете использовать шаблон Azure Resource Manager для развертывания, воспользуйтесь порталом один раз и скачайте готовый шаблон на странице "Проверка и **Создание** " для дальнейшего повторного использования. 

Вы также можете включить компонент [брокера идентификаторов HDInsight](identity-broker.md) во время создания кластера. Компонент Service Broker позволяет войти в Ambari с помощью многофакторной проверки подлинности и получить необходимые билеты Kerberos, не требуя хэширования паролей в Azure AD DS.

> [!NOTE]  
> Первые шесть символов имени кластера ESP должно быть уникальными в вашей среде. Например, если в разных виртуальных сетях имеется несколько кластеров ESP, выберите соглашение об именовании, которое гарантирует уникальность первых шести символов в именах кластеров.

![Проверка домена для Корпоративный пакет безопасности Azure HDInsight](./media/apache-domain-joined-configure-using-azure-adds/azure-portal-cluster-security-networking-esp.png)

После включения ESP стандартные неправильности конфигурации, связанные с Azure AD DS, автоматически обнаруживаются и проверяются. После устранения этих ошибок можно перейти к следующему шагу.

![Сбой проверки домена Корпоративный пакет безопасности Azure HDInsight](./media/apache-domain-joined-configure-using-azure-adds/azure-portal-cluster-security-networking-esp-error.png)

При создании кластера HDInsight с помощью ESP необходимо указать следующие параметры:

- **Администратор кластера**: выберите администратора кластера из синхронизированного экземпляра AD DS Azure. Эта учетная запись домена должна быть уже синхронизирована и доступна в Azure AD DS.

- **Группы доступа к кластеру**: группы безопасности, чьи пользователи должны синхронизироваться и иметь доступ к кластеру, должны быть доступны в AD DS Azure. Примером является группа HiveUsers. Дополнительные сведения см. в статье [Создание группы и добавление в нее пользователей в Azure Active Directory](../../active-directory/fundamentals/active-directory-groups-create-azure-portal.md).

- **URL-адрес LDAPS**. пример `ldaps://contoso.com:636`.

Созданное управляемое удостоверение можно выбрать из раскрывающегося списка **управляемое удостоверение, назначаемое пользователем** при создании нового кластера.

![Управляемое удостоверение Azure HDInsight ESP домен Active Directory Services](./media/apache-domain-joined-configure-using-azure-adds/azure-portal-cluster-security-networking-identity.png).

## <a name="next-steps"></a>Дальнейшие действия

* Сведения о настройке политик Hive и выполнении запросов Hive см. в статье [Настройка политик Apache Hive в HDInsight с Корпоративным пакетом безопасности](apache-domain-joined-run-hive.md).
* Сведения о подключении к кластерам HDInsight с корпоративным пакетом безопасности с использованием SSH см. в разделе [Проверка подлинности при использовании присоединенного к домену кластера HDInsight](../hdinsight-hadoop-linux-use-ssh-unix.md#domainjoined).
