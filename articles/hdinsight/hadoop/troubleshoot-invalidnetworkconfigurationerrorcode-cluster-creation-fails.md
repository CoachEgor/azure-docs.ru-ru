---
title: Ошибка InvalidNetworkConfigurationErrorCodeCodeCode - Azure HDInsight
description: Различные причины неудачных творений кластера с InvalidNetworkConfigurationErrorCode в Azure HDInsight
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: troubleshooting
ms.date: 01/22/2020
ms.openlocfilehash: 6dd4db999cb130c9816ad023888a4333e968c224
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76720390"
---
# <a name="cluster-creation-fails-with-invalidnetworkconfigurationerrorcode-in-azure-hdinsight"></a>Создание кластера не справляется с InvalidNetworkConfigurationErrorCode в Azure HDInsight

В этой статье описаны шаги устранения неполадок и возможные решения проблем при взаимодействии с кластерами Azure HDInsight.

Если вы видите код `InvalidNetworkConfigurationErrorCode` ошибки с описанием "Конфигурация виртуальной сети не совместима с требованиями HDInsight", это обычно указывает на проблему с [конфигурацией виртуальной сети](../hdinsight-plan-virtual-network-deployment.md) для кластера. Основываясь на остальной части описания ошибки, следуйте ниже разделы, чтобы решить вашу проблему.

## <a name="hostname-resolution-failed"></a>"Разрешение HostName не удалось"

### <a name="issue"></a>Проблема

Описание ошибки содержит "Разрешение HostName не удалось".

### <a name="cause"></a>Причина

Эта ошибка указывает на проблему с пользовательской конфигурацией DNS. DNS-серверы в виртуальной сети могут пересылать DNS-запросы рекурсивным решателям Azure для решения имен хоста в этой виртуальной сети (подробнее см. [Разрешение имен в виртуальных сетях).](../../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md) Доступ к рекурсивным разрешителям Azure предоставляется через виртуальный IP-адрес 168.63.129.16. Этот IP доступен только с Помощью VMs Azure. Так что он не будет работать, если вы используете сервер OnPrem DNS, или ваш DNS-сервер является Azure VM, который не является частью виртуальной сети кластера.

### <a name="resolution"></a>Решение

1. Ssh в VM, который является частью кластера, и запустить команду `hostname -f`. Это вернет полностью квалифицированное доменное `<host_fqdn>` имя хозяина (называемое в приведенных ниже инструкциях).

1. Затем запустите `nslookup <host_fqdn>` команду (например, `nslookup hn1-hditest.5h6lujo4xvoe1kprq3azvzmwsd.hx.internal.cloudapp.net`). Если эта команда разрешает имя с IP-адресом, это означает, что ваш DNS-сервер работает правильно. В этом случае поднимите дело о поддержке с помощью HDInsight, и мы изучим вашу проблему. В случае поддержки включите выполненные по устранению неполадок шаги по устранению неполадок. Это поможет нам решить проблему быстрее.

1. Если вышеупомянутая команда не возвращает IP-адрес, то запустите `nslookup <host_fqdn> 168.63.129.16` (например,). `nslookup hn1-hditest.5h6lujo4xvoe1kprq3azvzmwsd.hx.internal.cloudapp.net 168.63.129.16` Если эта команда способна решить ПРОБЛЕМУ IP, это означает, что либо ваш DNS-сервер не пересылает запрос в DNS Azure, либо это не VM, который является частью той же виртуальной сети, что и кластер.

1. Если у вас нет VM Azure, который может выступать в качестве пользовательского DNS-сервера в виртуальной сети кластера, то сначала необходимо добавить его. Создайте VM в виртуальной сети, которая будет настроена как DNS-нападающий.

1. Если у вас есть VM развернуты в вашей виртуальной сети, настроить правила переадресования DNS на этом VM. Переадресованные все запросы разрешения имен iDNS до 168.63.129.16, а остальные на ваш DNS-сервер. [Вот](../hdinsight-plan-virtual-network-deployment.md) пример этой настройки для пользовательского DNS-сервера.

1. Добавьте IP-адрес этого VM в качестве первого dNS-входа для конфигурации Виртуальной сети DNS.

---

## <a name="failed-to-connect-to-azure-storage-account"></a>"Не удалось подключиться к учетной записи хранения Azure"

### <a name="issue"></a>Проблема

Описание ошибки содержит "Не удалось подключиться к учетной записи хранения Azure" или "Не удалось подключиться к Azure S'L".

### <a name="cause"></a>Причина

У Azure Storage и S'L нет фиксированных IP-адресов, поэтому нам необходимо разрешить исходящие подключения ко всем IP-адресам, чтобы обеспечить доступ к этим службам. Точные шаги разрешения зависят от того, создали ли вы группу сетевой безопасности (NSG) или правила, определяемые пользователем (UDR). Для получения подробной информации об этих конфигурациях обратитесь к разделу [о контроле сетевого трафика с помощью HDInsight с группами сетевой безопасности и маршрутами, определяемыми пользователями.](../hdinsight-plan-virtual-network-deployment.md#hdinsight-ip)

### <a name="resolution"></a>Решение

* Если в кластере используется [группа сетевой безопасности (NSG).](../../virtual-network/virtual-network-vnet-plan-design-arm.md)

    Перейдите на портал Azure и определите NSG, которая связана с подсетью, в которой развертывается кластер. В разделе **Правила исходящего обеспечения безопасности** разрешить исходящий доступ к интернету без ограничений (обратите внимание, что меньшее **число приоритетов** здесь означает более высокий приоритет). Кроме того, в разделе **подсетей,** подтвердить, если это NSG применяется к кластерной подсети.

* Если кластер использует [маршруты, определяемые пользователем (UDR).](../../virtual-network/virtual-networks-udr-overview.md)

    Перейдите на портал Azure и определите таблицу маршрутов, связанную с подсетью, в которой развертывается кластер. Как только вы найдете таблицу маршрутов для подсети, проинспектировать раздел **маршрутов** в нем.

    Если определены маршруты, убедитесь, что существуют маршруты для IP-адресов для региона, где кластер был развернут, и **NextHopType** для каждого маршрута — **Интернет.** В вышеупомянутой статье должен быть определен маршрут для каждого требуемого IP-адреса.

---

## <a name="virtual-network-configuration-is-not-compatible-with-hdinsight-requirement"></a>"Виртуальная конфигурация сети не совместима с требованиями HDInsight"

### <a name="issue"></a>Проблема

Описания ошибок содержат сообщения, похожие следующим образом:

```
ErrorCode: InvalidNetworkConfigurationErrorCode
ErrorDescription: Virtual Network configuration is not compatible with HDInsight Requirement. Error: 'Failed to connect to Azure Storage Account; Failed to connect to Azure SQL; HostName Resolution failed', Please follow https://go.microsoft.com/fwlink/?linkid=853974 to fix it.
```

### <a name="cause"></a>Причина

Скорее всего, проблема с пользовательской установкой DNS.

### <a name="resolution"></a>Решение

Проверка, что 168.63.129.16 находится в пользовательской цепи DNS. DNS-серверы в виртуальной сети могут перенаправлять запросы DNS рекурсивным разрешителям Azure для разрешения имен узлов в этой виртуальной сети. Для получения дополнительной информации смотрите [разрешение имен в виртуальных сетях](../../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server). Доступ к рекурсивным разрешителям Azure предоставляется через виртуальный IP-адрес 168.63.129.16.

1. Используйте [команду ssh](../hdinsight-hadoop-linux-use-ssh-unix.md) для подключения к кластеру. Отоверьте приведенную ниже команду, заменив CLUSTERNAME на имя кластера, а затем введите команду:

    ```cmd
    ssh sshuser@CLUSTERNAME-ssh.azurehdinsight.net
    ```

1. Выполните следующую команду:

    ```bash
    cat /etc/resolv.conf | grep nameserver*
    ```

    Вы увидите нечто вроде этого:

    ```output
    nameserver 168.63.129.16
    nameserver 10.21.34.43
    nameserver 10.21.34.44
    ```

    Основываясь на результате - выберите один из следующих шагов для подражания:

#### <a name="1686312916-is-not-in-this-list"></a>168.63.129.16 нет в этом списке

**Вариант 1**  
Добавьте 168.63.129.16 в качестве первого пользовательского DNS для виртуальной сети, используя шаги, описанные в [Плане виртуальной сети для Azure HDInsight.](../hdinsight-plan-virtual-network-deployment.md) Эти действия применимы только в том случае, если пользовательский DNS-сервер работает на Linux.

**Вариант 2**  
Развертывание DNS-сервера VM для виртуальной сети. Для этого необходимо выполнить следующие шаги.

* Создайте VM в виртуальной сети, которая будет настроена как DNS-форвард (это может быть Linux или Windows VM).
* Назначьте правила переадресосения DNS на этом VM (перенаправить все запросы на разрешение имен iDNS до 168.63.129.16, а остальное на ваш DNS-сервер).
* Добавьте IP-адрес этого VM в качестве первого входа DNS для конфигурации Виртуальной сети DNS.

#### <a name="1686312916-is-in-the-list"></a>168.63.129.16 в списке

В этом случае, пожалуйста, создайте дело поддержки с HDInsight, и мы изучим вашу проблему. Включите результат нижекоманд в случае поддержки. Это поможет нам исследовать и решить проблему быстрее.

От сеанса ssh на головном узлах, отодеть, а затем запустить следующее:

```bash
hostname -f
nslookup <headnode_fqdn> (e.g.nslookup hn1-hditest.5h6lujo4xvoe1kprq3azvzmwsd.hx.internal.cloudapp.net)
dig @168.63.129.16 <headnode_fqdn> (e.g. dig @168.63.129.16 hn0-hditest.5h6lujo4xvoe1kprq3azvzmwsd.hx.internal.cloudapp.net)
```

---

### <a name="next-steps"></a>Дальнейшие действия

Если вы не видите своего варианта проблемы или вам не удается ее устранить, дополнительные сведения можно получить, посетив один из следующих каналов.

* Получите ответы от экспертов Azure через [поддержку сообщества Azure.](https://azure.microsoft.com/support/community/)

* Связаться [@AzureSupport](https://twitter.com/azuresupport) с официальным аккаунтом Microsoft Azure для улучшения обслуживания клиентов, подключив сообщество Azure к нужным ресурсам: ответам, поддержке и экспертам.

* Если вам нужна дополнительная помощь, вы можете отправить запрос на поддержку с [портала Azure](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade/). Выберите **поддержку** из бара меню или откройте концентратор **поддержки Справка и.** Для получения более подробной информации просмотрите [Как создать запрос поддержки Azure.](https://docs.microsoft.com/azure/azure-portal/supportability/how-to-create-azure-support-request) Доступ к управлению подпиской и поддержке выставления счетов включен в подписку Microsoft Azure, а техническая поддержка обеспечивается через один из [планов поддержки Azure.](https://azure.microsoft.com/support/plans/)
