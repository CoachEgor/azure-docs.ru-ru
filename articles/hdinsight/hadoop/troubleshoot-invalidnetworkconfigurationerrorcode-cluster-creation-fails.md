---
title: Ошибка InvalidNetworkConfigurationErrorCode — Azure HDInsight
description: Различные причины неудачного создания кластера с помощью InvalidNetworkConfigurationErrorCode в Azure HDInsight
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: troubleshooting
ms.date: 01/22/2020
ms.openlocfilehash: 6dd4db999cb130c9816ad023888a4333e968c224
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "76720390"
---
# <a name="cluster-creation-fails-with-invalidnetworkconfigurationerrorcode-in-azure-hdinsight"></a>Сбой создания кластера с InvalidNetworkConfigurationErrorCode в Azure HDInsight

В этой статье описываются действия по устранению неполадок и возможные способы решения проблем при взаимодействии с кластерами Azure HDInsight.

Если вы видите код `InvalidNetworkConfigurationErrorCode` ошибки с описанием "Конфигурация виртуальной сети несовместима с требованием HDInsight", обычно это указывает на проблему с [конфигурацией виртуальной сети](../hdinsight-plan-virtual-network-deployment.md) для кластера. В зависимости от оставшейся части описания ошибки следуйте приведенным ниже разделам, чтобы устранить проблему.

## <a name="hostname-resolution-failed"></a>"Сбой разрешения имени узла"

### <a name="issue"></a>Проблема

Описание ошибки содержит "сбой разрешения имени узла".

### <a name="cause"></a>Причина

Эта ошибка указывает на проблему с пользовательской конфигурацией DNS. DNS-серверы в виртуальной сети могут пересылать запросы DNS в рекурсивные арбитры конфликтов Azure для разрешения имен узлов в этой виртуальной сети (Дополнительные сведения см. [в разделе разрешение имен в виртуальных сетях](../../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md) ). Доступ к рекурсивным разрешителям Azure предоставляется через виртуальный IP-адрес 168.63.129.16. Этот IP-адрес доступен только на виртуальных машинах Azure. Поэтому он не будет работать, если вы используете локальный DNS-сервер или если ваш DNS-сервер является виртуальной машиной Azure, которая не является частью виртуальной сети кластера.

### <a name="resolution"></a>Решение

1. Подключитесь по протоколу SSH к виртуальной машине, входящей в состав кластера, `hostname -f`и выполните команду. Это приведет к возврату полного доменного имени узла (которое называется `<host_fqdn>` приведенными ниже инструкциями).

1. Затем выполните команду `nslookup <host_fqdn>` (например, `nslookup hn1-hditest.5h6lujo4xvoe1kprq3azvzmwsd.hx.internal.cloudapp.net`). Если эта команда разрешает имя в IP-адрес, это означает, что DNS-сервер работает правильно. В этом случае создайте обращение в службу поддержки HDInsight, и мы обсудим проблему. В ваш вариант поддержки включите действия по устранению неполадок, которые вы выполнили. Это поможет нам быстрее устранить проблему.

1. Если приведенная выше команда не возвращает IP-адрес, выполните `nslookup <host_fqdn> 168.63.129.16` команду (например, `nslookup hn1-hditest.5h6lujo4xvoe1kprq3azvzmwsd.hx.internal.cloudapp.net 168.63.129.16`). Если эта команда может разрешить IP-адрес, это означает, что DNS-сервер не перенаправляет запрос в DNS Azure или не является виртуальной машиной, которая является частью той же виртуальной сети, что и кластер.

1. Если у вас нет виртуальной машины Azure, которая может работать в качестве пользовательского DNS-сервера в виртуальной сети кластера, необходимо сначала добавить это. Создайте виртуальную машину в виртуальной сети, которая будет настроена в качестве DNS-сервера пересылки.

1. После развертывания виртуальной машины в виртуальной сети настройте правила пересылки DNS на этой виртуальной машине. Перешлите все запросы на разрешение имени iDNS в 168.63.129.16, а остальные — на ваш DNS-сервер. [Ниже](../hdinsight-plan-virtual-network-deployment.md) приведен пример такой настройки для пользовательского DNS-сервера.

1. Добавьте IP-адрес этой виртуальной машины в качестве первой записи DNS для конфигурации DNS виртуальной сети.

---

## <a name="failed-to-connect-to-azure-storage-account"></a>"Не удалось подключиться к учетной записи хранения Azure"

### <a name="issue"></a>Проблема

Описание ошибки содержит сообщение "не удалось подключиться к учетной записи хранения Azure" или "не удалось подключиться к Azure SQL".

### <a name="cause"></a>Причина

Служба хранилища Azure и SQL не имеют фиксированных IP-адресов, поэтому для доступа к этим службам необходимо разрешить исходящие подключения ко всем IP-адресам. Точные действия по устранению зависят от того, настроена ли группа безопасности сети (NSG) или определяемые пользователем правила (UDR). Дополнительные сведения об этих конфигурациях см. в разделе [Управление сетевым трафиком с помощью HDInsight с группами безопасности сети и определяемыми пользователем маршрутами](../hdinsight-plan-virtual-network-deployment.md#hdinsight-ip) .

### <a name="resolution"></a>Решение

* Если кластер использует [группу безопасности сети (NSG)](../../virtual-network/virtual-network-vnet-plan-design-arm.md).

    Перейдите в портал Azure и найдите NSG, связанный с подсетью, в которой развертывается кластер. В разделе **правила безопасности для исходящего трафика** разрешите исходящий доступ к Интернету без ограничений (Обратите внимание, что номер меньшего **приоритета** здесь означает более высокий приоритет). Кроме того, в разделе **подсети** подтвердите, применен ли этот NSG к подсети кластера.

* Если кластер использует [определяемые пользователем маршруты (UDR)](../../virtual-network/virtual-networks-udr-overview.md).

    Перейдите к портал Azure и найдите таблицу маршрутов, связанную с подсетью, в которой развертывается кластер. Найдя таблицу маршрутов для подсети, просмотрите раздел **Routes (маршруты** ).

    Если определены маршруты, убедитесь, что существуют маршруты для IP-адресов для региона, в котором развернут кластер, а **NextHopType** для каждого маршрута — в **Интернете**. Для каждого обязательного IP-адреса, описанного в упомянутой выше статье, должен быть определен маршрут.

---

## <a name="virtual-network-configuration-is-not-compatible-with-hdinsight-requirement"></a>"Конфигурация виртуальной сети несовместима с требованиями к HDInsight"

### <a name="issue"></a>Проблема

Описания ошибок содержат сообщения, аналогичные приведенным ниже.

```
ErrorCode: InvalidNetworkConfigurationErrorCode
ErrorDescription: Virtual Network configuration is not compatible with HDInsight Requirement. Error: 'Failed to connect to Azure Storage Account; Failed to connect to Azure SQL; HostName Resolution failed', Please follow https://go.microsoft.com/fwlink/?linkid=853974 to fix it.
```

### <a name="cause"></a>Причина

Скорее всего, возникла ошибка в пользовательской установке DNS.

### <a name="resolution"></a>Решение

Проверьте, что 168.63.129.16 находится в пользовательской цепочке DNS. DNS-серверы в виртуальной сети могут перенаправлять запросы DNS рекурсивным разрешителям Azure для разрешения имен узлов в этой виртуальной сети. Дополнительные сведения см. [в разделе разрешение имен в виртуальных сетях](../../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server). Доступ к рекурсивным разрешителям Azure предоставляется через виртуальный IP-адрес 168.63.129.16.

1. Используйте [команду SSH](../hdinsight-hadoop-linux-use-ssh-unix.md) для подключения к кластеру. Измените приведенную ниже команду, заменив ИМЯ_КЛАСТЕРА именем кластера, а затем введите следующую команду:

    ```cmd
    ssh sshuser@CLUSTERNAME-ssh.azurehdinsight.net
    ```

1. Выполните следующую команду:

    ```bash
    cat /etc/resolv.conf | grep nameserver*
    ```

    Вы увидите нечто вроде этого:

    ```output
    nameserver 168.63.129.16
    nameserver 10.21.34.43
    nameserver 10.21.34.44
    ```

    На основе результата выберите один из следующих шагов, чтобы выполнить следующие действия.

#### <a name="1686312916-is-not-in-this-list"></a>168.63.129.16 отсутствует в этом списке

**Вариант 1**  
Добавьте 168.63.129.16 в качестве первой настраиваемой службы DNS для виртуальной сети, выполнив действия, описанные в статье [планирование виртуальной сети для Azure HDInsight](../hdinsight-plan-virtual-network-deployment.md). Эти действия применимы только в том случае, если пользовательский DNS-сервер работает под управлением Linux.

**Вариант 2**  
Разверните виртуальную машину DNS-сервера для виртуальной сети. Для этого необходимо выполнить следующие шаги.

* Создайте виртуальную машину в виртуальной сети, которая будет настроена как DNS-сервер пересылки (это может быть виртуальная машина Linux или Windows).
* Настройте правила пересылки DNS на этой виртуальной машине (перенаправить все запросы на разрешение имен iDNS в 168.63.129.16, а остальные — на ваш DNS-сервер).
* Добавьте IP-адрес этой виртуальной машины в качестве первой записи DNS для конфигурации DNS виртуальной сети.

#### <a name="1686312916-is-in-the-list"></a>168.63.129.16 находится в списке

В этом случае создайте обращение в службу поддержки HDInsight, и мы обсудим проблему. Включите результат выполнения приведенных ниже команд в ваш вариант поддержки. Это поможет нам быстрее исследовать и устранять проблему.

В сеансе SSH на головном узле измените, а затем выполните следующую команду:

```bash
hostname -f
nslookup <headnode_fqdn> (e.g.nslookup hn1-hditest.5h6lujo4xvoe1kprq3azvzmwsd.hx.internal.cloudapp.net)
dig @168.63.129.16 <headnode_fqdn> (e.g. dig @168.63.129.16 hn0-hditest.5h6lujo4xvoe1kprq3azvzmwsd.hx.internal.cloudapp.net)
```

---

### <a name="next-steps"></a>Дальнейшие шаги

Если вы не видите своего варианта проблемы или вам не удается ее устранить, дополнительные сведения можно получить, посетив один из следующих каналов.

* Получите ответы от экспертов Azure через [службу поддержки сообщества Azure](https://azure.microsoft.com/support/community/).

* Подключайтесь с помощью [@AzureSupport](https://twitter.com/azuresupport) официальной учетной записи Microsoft Azure для улучшения качества работы клиентов, подключив сообщество Azure к нужным ресурсам: ответы, поддержка и эксперты.

* Если вам нужна дополнительная помощь, можно отправить запрос в службу поддержки из [портал Azure](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade/). Выберите пункт **Поддержка** в строке меню или откройте центр **справки и поддержки** . Для получения более подробных сведений см. статью [о создании запроса на поддержку Azure](https://docs.microsoft.com/azure/azure-portal/supportability/how-to-create-azure-support-request). Доступ к управлению подписками и поддержкой выставления счетов включен в вашу подписку Microsoft Azure, а техническая поддержка предоставляется через один из [планов поддержки Azure](https://azure.microsoft.com/support/plans/).
