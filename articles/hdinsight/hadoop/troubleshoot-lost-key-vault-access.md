---
title: Кластеры Azure HDInsight с шифрованием диска теряют доступ к Key Vault
description: Устранение неполадок и возможные решения проблем при взаимодействии с кластерами Azure HDInsight.
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: troubleshooting
ms.date: 01/30/2020
ms.openlocfilehash: 2ae389be25cd8633a53a49cf000796c1510733a1
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76965168"
---
# <a name="scenario-azure-hdinsight-clusters-with-disk-encryption-lose-key-vault-access"></a>Сценарий: кластеры Azure HDInsight с шифрованием дисков теряют доступ к Key Vault

В этой статье описаны шаги устранения неполадок и возможные решения проблем при взаимодействии с кластерами Azure HDInsight.

## <a name="issue"></a>Проблема

Предупреждение Центра здоровья `The HDInsight cluster is unable to access the key for BYOK encryption at rest`ресурсов (RHC) отображается для кластеров Bring Your Own Key (BYOK), где кластерные узлы потеряли доступ к клиентам Key Vault (KV). Аналогичные предупреждения также можно увидеть на uI Apache Ambari.

## <a name="cause"></a>Причина

Предупреждение гарантирует доступность KV из кластерных узлов, обеспечивая тем самым сетевое соединение, работоспособность KV и политику доступа для пользователя, назначенного Управляемой идентификацией. Это предупреждение является лишь предупреждением о предстоящем закрытии брокера на последующих перезагрузках узлов, кластер продолжает функционировать до тех пор, пока узлы не перезагрузятся.

Перейдите на uI Apache Ambari, чтобы найти более подробную информацию о предупреждении от **состояния убежища ключей шифрования диска.** Это оповещение будет иметь подробную информацию о причине сбоя проверки.

## <a name="resolution"></a>Решение

### <a name="kvaad-outage"></a>Сбой KV/AAD

Для более подробной информации о [доступности и избыточности](../../key-vault/key-vault-disaster-recovery-guidance.md) и статусе Azure и странице состояния Azurehttps://status.azure.com/

### <a name="kv-accidental-deletion"></a>Случайное удаление КВ

* Восстановить удаленный ключ на KV для автоматического восстановления. Для получения дополнительной информации [см.](https://docs.microsoft.com/rest/api/keyvault/recoverdeletedkey)
* Опрокинись к команде KV, чтобы оправиться от случайных убываний.

### <a name="kv-access-policy-changed"></a>Изменена политика доступа kv

Восстановление политик доступа для пользователя, назначенного Управляемой идентификацией, которая назначена кластеру ИРЧП для доступа к KV.

### <a name="key-permitted-operations"></a>Ключевые разрешенные операции

Для каждого ключа в КВ можно выбрать набор разрешенных операций. Убедитесь, что у вас есть операции обертывания и разворачивания для ключа BYOK

### <a name="expired-key"></a>Ключ с истекшим сроком действия

Если срок действия истек и ключ не вращается, восстановите ключ от резервного копирования HSM или свяжитесь с командой KV, чтобы очистить срок годности.

### <a name="kv-firewall-blocking-access"></a>KV брандмауэр блокирования доступа

Исправьте настройки брандмауэра KV, чтобы позволить кластерным узлам BYOK получить доступ к KV.

### <a name="nsg-rules-on-virtual-network-blocking-access"></a>Правила NSG о виртуальной сети, блокирующей доступ

Проверьте правила NSG, связанные с виртуальной сетью, прикрепленной к кластеру.

## <a name="mitigation-and-prevention-steps"></a>Меры по смягчению последствий и профилактике

### <a name="kv-accidental-deletion"></a>Случайное удаление КВ

* Настроили Key Vault с [набором блокировки ресурсов.](../../azure-resource-manager/management/lock-resources.md)
* Резервное копирование ключей к модулю безопасности оборудования.

### <a name="key-deletion"></a>Удаление ключей

Кластер должен быть удален до удаления ключа.

### <a name="kv-access-policy-changed"></a>Изменена политика доступа kv

Регулярно проверяйте и тестируют политики доступа.

### <a name="expired-key"></a>Ключ с истекшим сроком действия

* Резервное копирование ключей к HSM.
* Используйте ключ без набора истечения срока действия.
* Если срок действия должен быть установлен, поверните клавиши до истечения срока действия.

## <a name="next-steps"></a>Дальнейшие действия

Если вы не видите своего варианта проблемы или вам не удается ее устранить, дополнительные сведения можно получить, посетив один из следующих каналов.

* Получите ответы от экспертов Azure через [поддержку сообщества Azure.](https://azure.microsoft.com/support/community/)

* Связаться [@AzureSupport](https://twitter.com/azuresupport) с - официальная учетная запись Microsoft Azure для улучшения обслуживания клиентов. Подключение сообщества Azure к нужным ресурсам: ответы, поддержка и эксперты.

* Если вам нужна дополнительная помощь, вы можете отправить запрос на поддержку с [портала Azure](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade/). Выберите **поддержку** из бара меню или откройте концентратор **поддержки Справка и.** Для получения более подробной информации просмотрите [Как создать запрос поддержки Azure.](https://docs.microsoft.com/azure/azure-supportability/how-to-create-azure-support-request) Доступ к управлению подпиской и поддержке выставления счетов включен в подписку Microsoft Azure, а техническая поддержка обеспечивается через один из [планов поддержки Azure.](https://azure.microsoft.com/support/plans/)
