---
title: Автоматическое масштабирование кластеров Azure HDInsight
description: Используйте функцию Autoscale Azure HDInsight для автоматического кластера масштабов Apache Hadoop
author: hrasheed-msft
ms.author: hrasheed
ms.reviewer: jasonh
ms.service: hdinsight
ms.topic: conceptual
ms.custom: hdinsightactive
ms.date: 04/07/2020
ms.openlocfilehash: 4f9b43b6f800bb47942ccc00fee0fac4536d2ec0
ms.sourcegitcommit: d791f8f3261f7019220dd4c2dbd3e9b5a5f0ceaf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2020
ms.locfileid: "81640576"
---
# <a name="automatically-scale-azure-hdinsight-clusters"></a>Автоматическое масштабирование кластеров Azure HDInsight

> [!Important]
> Функция Autoscale Azure HDInsight была выпущена для общего доступа 7 ноября 2019 года для кластеров Spark и Hadoop и включала улучшения, недоступные в предварительной версии функции. Если вы создали кластер Spark до 7 ноября 2019 года и хотите использовать функцию Autoscale в кластере, рекомендуемый путь заключается в создании нового кластера и включании Autoscale в новый кластер.
>
> Автопрограмма для интерактивных запросов (LLAP) и кластеров HBase все еще находится в предварительном просмотре. Autoscale доступен только на кластерах Spark, Hadoop, Interactive Query и HBase.

Функция кластера Autoscale azure HDInsight автоматически масштабирует количество рабочих узлов в кластере вверх и вниз. Другие типы узлов в кластере не могут быть масштабированы в настоящее время.  Во время создания кластера HDInsight можно задать минимальное и максимальное количество рабочих узлов. Затем Autoscale отслеживает потребности в ресурсах аналитической нагрузки и масштабирует количество узлов рабочего уровня вверх или вниз. Дополнительная плата за эту функцию не взимается.

## <a name="cluster-compatibility"></a>Кластерная совместимость

В следующей таблице описаны типы кластеров и версии, совместимые с функцией Autoscale.

| Версия | Spark | Hive | LLAP | HBase | Kafka | Storm | ML |
|---|---|---|---|---|---|---|---|
| HDInsight 3.6 без ESP | Да | Да | Да | Да* | нет | нет | нет |
| HDInsight 4.0 без ESP | Да | Да | Да | Да* | нет | нет | нет |
| HDInsight 3.6 с ESP | Да | Да | Да | Да* | нет | нет | нет |
| HDInsight 4.0 с ESP | Да | Да | Да | Да* | нет | нет | нет |

\*Кластеры HBase могут быть настроены только для масштабирования на основе графика, а не для загрузки.

## <a name="how-it-works"></a>Принцип работы

Для кластера HDInsight можно выбрать масштабирование на основе нагрузки или расписание. Масштабирование на основе нагрузки изменяет количество узлов в кластере в пределах установленного диапазона, чтобы обеспечить оптимальное использование процессора и минимизировать эксплуатационные расходы.

Масштабирование на основе расписания изменяет количество узлов в кластере в зависимости от условий, которые вступают в силу в определенное время. Эти условия масштабируют кластер до предполагаемого количества узлов.

### <a name="metrics-monitoring"></a>Мониторинг метрик

Автомасштабирование постоянно выполняет мониторинг кластера и собирает следующие метрики:

|Метрика|Описание|
|---|---|
|Всего в ожидании процессора|Общее число ядер, необходимое для запуска выполнения всех ожидающих контейнеров.|
|Всего ожидающих памяти|Общий объем памяти (в МБ), необходимый для запуска выполнения всех отложенных контейнеров.|
|Всего бесплатный процессор|Сумма всех неиспользуемых ядер на активных рабочих узлах.|
|Полная бесплатная память|Сумма неиспользуемой памяти (в МБ) на активных рабочих узлах.|
|Используемая память на узла|Нагрузка на рабочем узле. Рабочий узел, на котором используется 10 ГБ памяти, пребывает под большей нагрузкой, чем рабочий узел с 2 ГБ используемой памяти.|
|Количество мастеров приложений на узла|Число основных контейнеров приложений, работающих на рабочем узле. Рабочий узла, вмещающего два контейнера AM, считается более важным, чем рабочий узла, вмещающего нулевые контейнеры AM.|

Эти метрики проверяются каждые 60 секунд. Autoscale принимает решения на основе этих показателей.

### <a name="load-based-scale-conditions"></a>Условия масштаба нагрузки

При обнаружении следующих условий Autoscale выдаст запрос на масштабирование:

|Вертикальное масштабирование|Масштабирование|
|---|---|
|Общее количество ожидающих процессора больше, чем общий бесплатный процессор в течение более 3 минут.|Общее число ожидающих ЦП меньше, чем общее число свободных ЦП в течение более чем 10 минут.|
|Общая ожидаев памяти больше, чем общая свободная память в течение более 3 минут.|Общий объем ожидающей памяти меньше, чем общее количество свободной памяти в течение более чем 10 минут.|

Для масштабирования Autoscale выдает запрос на масштабирование для добавления необходимого количества узлов. Масштабирование основано на том, сколько новых узлов рабочего времени необходимо для удовлетворения текущих требований к процессору и памяти.

Для снижения масштабов Autoscale выдает запрос на удаление определенного количества узлов. Масштабирование основано на количестве контейнеров AM на узла. И текущие требования к процессору и памяти. Служба также определяет, какие узлы являются кандидатами на удаление на основе текущего выполнения задания. Операция снижаемого масштаба сначала выводит из эксплуатации узлы, а затем удаляет их из кластера.

## <a name="get-started"></a>Начало работы

### <a name="create-a-cluster-with-load-based-autoscaling"></a>Создание кластера с помощью автоматического масштабирования на основе нагрузки

Для включения функции Autoscale с масштабированием на основе нагрузки выполните следующие шаги в рамках обычного процесса создания кластера:

1. На вкладке **«Конфигурация и цены»** выберите **флажок автоматического масштаба Enable.**
1. Выберите **нагрузку на основе** **типа Autoscale.**
1. Введите предполагаемые значения для следующих свойств:  

    * Начальное **количество узлов** для **узлов рабочего.**
    * **Мин** номер рабочих узлов.
    * **Максимальное** количество рабочих узлов.

    ![Включить автомасштабирование на основе нагрузок рабочего узла](./media/hdinsight-autoscale-clusters/azure-portal-cluster-configuration-pricing-autoscale.png)

Начальное количество рабочих узлов должно быть в диапазоне между максимальным и минимальным количеством. Это значение определяет начальный размер кластера при его создании. Минимальное количество рабочих узлов должно быть установлено на три или более. Масштабирование кластера до менее чем трех узлов может привести к тому, что он застрянет в безопасном режиме из-за недостаточной репликации файлов.  Для получения дополнительной информации [см. Застрять в безопасном режиме](./hdinsight-scaling-best-practices.md#getting-stuck-in-safe-mode).

### <a name="create-a-cluster-with-schedule-based-autoscaling"></a>Создание кластера с помощью автоматического масштабирования на основе графика

Чтобы включить функцию Autoscale с помощью масштабирования на основе графика, выполните следующие шаги в рамках обычного процесса создания кластера:

1. На вкладке **Configuration и ценообразования** проверьте **флажок автоматического масштаба Enable.**
1. Введите **число узлов** для **рабочего узла,** которое контролирует ограничение для масштабирования кластера.
1. Выберите опцию **Расписание на основе** **типа Autoscale.**
1. Выберите **настройку,** чтобы открыть окно **конфигурации Autoscale.**
1. Выберите свой часовой пояс, а затем нажмите **кнопку и добавить условие**
1. Выберите дни недели, к которым должно применяться новое условие.
1. Отспособите время вхедоподобности условие и количество узлов, к которым кластер должен быть масштабирован.
1. При необходимости добавьте больше условий.

    ![Включить создание рабочего узла на основе рабочего узла](./media/hdinsight-autoscale-clusters/hdinsight-autoscale-clusters-schedule-creation.png)

Количество узлов должно быть от 3 до максимального количества рабочих узлов, которые вы ввели перед добавлением условий.

### <a name="final-creation-steps"></a>Заключительные этапы создания

Выберите тип VM для рабочих узлов, выбрав VM из списка выпадающих под **размером узла.** После выбора типа VM для каждого типа узлов можно увидеть диапазон оценочных затрат для всего кластера. Отрегулируйте типы VM в соответствии с вашим бюджетом.

![Включить формат автоматического узла на основе рабочего узла](./media/hdinsight-autoscale-clusters/azure-portal-cluster-configuration-pricing-vmsize.png)

Ваша подписка имеет квоту емкости для каждого региона. Общее количество ядер головных узлов и максимальных рабочих узлов не может превышать квоту емкости. Тем не менее эта квота — нестрогое ограничение. Вы всегда можете создать запрос в службу поддержки, чтобы легко ее повысить.

> [!Note]  
> Если вы превысите общий лимит основной квоты, Вы получите сообщение об ошибке, в котором говорится: «Максимальный узла превысил доступные ядра в этом регионе, пожалуйста, выберите другой регион или обратитесь в службу поддержки для увеличения квоты».

Дополнительные сведения о создании кластера HDInsight с помощью портала Azure см. в статье [Создание кластеров под управлением Linux в HDInsight с помощью портала Azure](hdinsight-hadoop-create-linux-clusters-portal.md).  

### <a name="create-a-cluster-with-a-resource-manager-template"></a>Создание кластера с помощью шаблона Resource Manager

#### <a name="load-based-autoscaling"></a>Автомасштабирование на основе нагрузки

Вы можете создать кластер HDInsight с помощью шаблона Autoscaling Azure Resource `computeProfile`  >  `workernode` Manager, добавив `minInstanceCount` `maxInstanceCount` `autoscale` узел в раздел со свойствами и, как показано на фрагменте json ниже.

```json
{
  "name": "workernode",
  "targetInstanceCount": 4,
  "autoscale": {
      "capacity": {
          "minInstanceCount": 3,
          "maxInstanceCount": 10
      }
  },
  "hardwareProfile": {
      "vmSize": "Standard_D13_V2"
  },
  "osProfile": {
      "linuxOperatingSystemProfile": {
          "username": "[parameters('sshUserName')]",
          "password": "[parameters('sshPassword')]"
      }
  },
  "virtualNetworkProfile": null,
  "scriptActions": []
}
```

#### <a name="schedule-based-autoscaling"></a>Автоматическое расписание

Кластер HDInsight можно создать с помощью шаблона Autoscaling a Manager `autoscale` Azure, `computeProfile`  >  `workernode` добавив в раздел узел. Узла `autoscale` содержится, `recurrence` который `timezone` `schedule` имеет и который описывает, когда изменения будут происходить.

```json
{
  "autoscale": {
    "recurrence": {
      "timeZone": "Pacific Standard Time",
      "schedule": [
        {
          "days": [
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday"
          ],
          "timeAndCapacity": {
            "time": "11:00",
            "minInstanceCount": 10,
            "maxInstanceCount": 10
          }
        },
      ]
    }
  },
  "name": "workernode",
  "targetInstanceCount": 4,
}
```

### <a name="enable-and-disable-autoscale-for-a-running-cluster"></a>Включение и отключение автомасштабирования для работающего кластера

#### <a name="using-the-azure-portal"></a>Использование портала Azure

Для включения Autoscale в запущенном кластере выберите **размер кластера** в **настройках.** Затем выберите **Автомасштабирование.** Выберите тип автомасштабирования, который вы хотите, и введите параметры для масштабирования на основе нагрузки или графика. Наконец, щелкните **Сохранить**.

![Включить автоматический кластер рабочего узла на основе автоматического масштаба](./media/hdinsight-autoscale-clusters/azure-portal-settings-autoscale.png)

#### <a name="using-the-rest-api"></a>Использование REST API

Чтобы включить или отключить Autoscale в запущенном кластере с помощью REST API, сделайте запрос POST в конечную точку Autoscale:

```
https://management.azure.com/subscriptions/{subscription Id}/resourceGroups/{resourceGroup Name}/providers/Microsoft.HDInsight/clusters/{CLUSTERNAME}/roles/workernode/autoscale?api-version=2018-06-01-preview
```

Используйте соответствующие параметры в полезной нагрузке запроса. Полезная нагрузка Json ниже может быть использована для включения Autoscale. Используйте полезную нагрузку `{autoscale: null}` для отсравлить Autoscale.

```json
{ autoscale: { capacity: { minInstanceCount: 3, maxInstanceCount: 2 } } }
```

Ознакомьтесь с предыдущим разделом о [включении автошкалы на основе нагрузки](#load-based-autoscaling) для полного описания всех параметров полезной нагрузки.

## <a name="guidelines"></a>Рекомендации

### <a name="choosing-load-based-or-schedule-based-scaling"></a>Выбор масштабирования на основе нагрузки или графика

Перед принятием решения о том, какой режим выбрать, рассмотрим следующие факторы:

* Включить Autoscale во время создания кластера.
* Минимальное количество узлов должно быть не менее трех.
* Разница в нагрузках: выполняет ли нагрузка кластера по последовательному шаблону в определенное время, в определенные дни. Если нет, планирование на основе нагрузки является лучшим вариантом.
* Требования SLA: Автоматическое масштабирование является реактивным, а не прогностическим. Будет ли достаточная задержка между тем, когда нагрузка начинает увеличиваться, и когда кластер должен быть в целевом размере? Если есть строгие требования SLA и нагрузка является фиксированной известной схеме, "расписание на основе" является лучшим вариантом.

### <a name="consider-the-latency-of-scale-up-or-scale-down-operations"></a>Рассмотрим задержку масштабирования или масштабирования операций

Для завершения операции масштабирования может уйти от 10 до 20 минут. При настройке настраиваемого расписания планируйте эту задержку. Например, если в 9:00 утра размер кластера должен быть 20, установите триггер графика на более раннее время, например, 8:30, чтобы операция масштабирования была завершена к 9:00 утра.

### <a name="preparation-for-scaling-down"></a>Подготовка к масштабированию

Во время процесса масштабирования кластера Autoscale выводит из эксплуатации узлы для достижения целевого размера. Если задачи выполняются на этих узлах, Autoscale будет ждать, пока задачи не будут завершены. Так как каждый рабочий узлы также выполняет роль в HDFS, временные данные будут перенесены на оставшиеся узлы. Таким образом, вы должны убедиться, что на оставшихся узлах достаточно места для размещения всех временных данных.

Работа будет продолжена. Ожидающие задания будут ждать планирования с меньшим количеством доступных узлов.

### <a name="minimum-cluster-size"></a>Минимальный размер кластера

Не масштабируйте кластер до менее чем трех узлов. Масштабирование кластера до менее чем трех узлов может привести к тому, что он застрянет в безопасном режиме из-за недостаточной репликации файлов.  Для получения дополнительной информации [см. Застрять в безопасном режиме](./hdinsight-scaling-best-practices.md#getting-stuck-in-safe-mode).

## <a name="monitoring"></a>Наблюдение

### <a name="cluster-status"></a>Состояние кластера

Статус кластера, указанный на портале Azure, может помочь вам отслеживать деятельность Autoscale.

![Включить статус автоматического кластера на основе нагрузок рабочего узла](./media/hdinsight-autoscale-clusters/hdinsight-autoscale-clusters-cluster-status.png)

Все сообщения о статусе кластера, которые можно увидеть, объясняются в списке ниже.

| Состояние кластера | Описание |
|---|---|
| Запущен | Кластер работает в штатном режиме. Все предыдущие мероприятия Autoscale успешно завершены. |
| Updating  | Обновляется конфигурация кластера Autoscale.  |
| Конфигурация HDInsight  | Выполняется операция кластерного масштабирования или масштабирования.  |
| Ошибка обновления  | HDInsight встретил проблемы во время обновления конфигурации Autoscale. Клиенты могут выбрать либо повторить обновление или отключить автомасштаб.  |
| Ошибка  | Что-то не так с кластером, и это не может быть полезно. Удалите этот кластер и создайте новый.  |

Чтобы просмотреть текущее число узлов в кластере, перейдите на диаграмму **размера кластера** на странице **«Обзор»** для кластера. Или выберите **размер кластера** в **настройках.**

### <a name="operation-history"></a>История операции

Можно просмотреть историю кластерного масштабирования и масштабирования как часть метрик кластера. Вы также можете перечислить все действия масштабирования за прошедший день, неделю или другой период времени.

Выберите **метрики** под **мониторингом**. Затем выберите **«Добавить метрику»** и **«Количество активных работников»** из окна **«Метрика».** Выберите кнопку в правом верхнем углу, чтобы изменить временной диапазон.

![Включить автоматическое смету на основе графика рабочих узлов](./media/hdinsight-autoscale-clusters/hdinsight-autoscale-clusters-chart-metric.png)

## <a name="next-steps"></a>Дальнейшие действия

Читайте о рекомендациях по масштабированию кластеров вручную в [руководящих принципах масштабирования](hdinsight-scaling-best-practices.md)
