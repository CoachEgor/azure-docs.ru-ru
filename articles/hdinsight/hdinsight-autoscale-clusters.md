---
title: Автоматическое масштабирование кластеров Azure HDInsight (Предварительная версия)
description: Автоматическое масштабирование кластеров с помощью функции автомасштабирования HDInsight
author: hrasheed-msft
ms.reviewer: jasonh
ms.service: hdinsight
ms.custom: hdinsightactive
ms.topic: conceptual
ms.date: 05/02/2019
ms.author: hrasheed
ms.openlocfilehash: f8803a498e62958a5488f2ac8830137c37533e54
ms.sourcegitcommit: 300cd05584101affac1060c2863200f1ebda76b7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2019
ms.locfileid: "65413695"
---
# <a name="automatically-scale-azure-hdinsight-clusters-preview"></a>Автоматическое масштабирование кластеров Azure HDInsight (Предварительная версия)

Функция автоматического масштабирования кластера Azure HDInsight автоматически масштабирует количество рабочих узлов в кластере вверх и вниз. В настоящее время не может быть масштабирована других типов узлов в кластере.  Во время создания кластера HDInsight можно задать минимальное и максимальное количество рабочих узлов. Затем автомасштабирования отслеживает требования к ресурсам нагрузки аналитики и масштабирует количество рабочих узлов вверх или вниз. Нет без дополнительной оплаты для этой функции.

## <a name="cluster-compatibility"></a>Совместимость кластера

> [!Important]
> Функция автоматического масштабирования работает только для кластеров, созданных после общей доступности функции в мая 2019 г. Она не будет работать для существующих кластеров.

Ниже перечислены типы кластера и версий, совместимых с функцией автоматического масштабирования.

| Version | Spark | Hive | LLAP | Hbase | Kafka | Storm | ML |
|---|---|---|---|---|---|---|---|
| HDInsight 3.6 без ESP | Да | Да | Нет  | Нет | Нет | Нет | Нет |
| HDInsight 4.0 без ESP | Да | Да | Нет  | Нет | Нет | Нет | Нет |
| HDInsight 3.6 с ESP | Да | Да | Нет  | Нет | Нет | Нет | Нет |
| HDInsight 3.6 с ESP | Да | Да | Нет  | Нет | Нет | Нет | Нет |

## <a name="how-it-works"></a>Принцип работы

Вы можете на основе нагрузки масштабирование или расписанию масштабирование для кластера HDInsight. Масштабирование на основе нагрузки изменяется количество узлов в кластере, в диапазоне, который можно задать, для обеспечения оптимального использования ЦП и минимизировать затраты на выполнение.

Изменения масштабирования на основе расписания количество узлов в кластере на основе условий, которые будут действовать в определенное время. Эти условия масштабировать кластер для требуемого числа узлов.

### <a name="metrics-monitoring"></a>Мониторинг метрик

Автомасштабирование постоянно выполняет мониторинг кластера и собирает следующие метрики:

* **Total Pending CPU** (Общее число ожидающих ЦП). Общее число ядер, необходимое для запуска выполнения всех ожидающих контейнеров.
* **Total Pending Memory** (Общий объем ожидающей памяти). Общий объем памяти (в МБ), необходимый для запуска выполнения всех отложенных контейнеров.
* **Total Free CPU** (Общее число свободных ЦП). Сумма всех неиспользуемых ядер на активных рабочих узлах.
* **Total Free Memory** (Общий объем свободной памяти). Сумма неиспользуемой памяти (в МБ) на активных рабочих узлах.
* **Used Memory per Node** (Объем используемой памяти на каждом узле). Нагрузка на рабочем узле. Рабочий узел, на котором используется 10 ГБ памяти, пребывает под большей нагрузкой, чем рабочий узел с 2 ГБ используемой памяти.
* **Number of Application Masters per Node** (Количество основных контейнеров приложений на каждом узле). Число основных контейнеров приложений, работающих на рабочем узле. Рабочего узла, на котором размещается два контейнера AM, считается более важным, чем к рабочему узлу, на котором размещается ноль контейнеры по.

Эти метрики проверяются каждые 60 секунд. Автомасштабирование позволяет увеличивать и уменьшать решения на основе этих метрик.

### <a name="load-based-cluster-scale-up"></a>Масштабирование кластера на основе нагрузки

При обнаружении следующих условий автомасштабирования будет выдавать запрос вертикального масштабирования:

* Общее число ожидающих ЦП больше, чем общее свободное время ЦП более 3 минут.
* Общее число ожидающих памяти больше, чем общего объема свободной памяти более 3 минут.

Служба HDInsight вычисляет, сколько новых рабочих узлах необходимых для удовлетворения требований к памяти и текущая загрузка ЦП, а затем выдает запрос вертикального масштабирования, чтобы добавить необходимое количество узлов.

### <a name="load-based-cluster-scale-down"></a>Кластера на основе нагрузки уменьшение масштаба

При обнаружении следующих условий автомасштабирования будет выдавать запрос уменьшения масштаба:

* Общее число ожидающих ЦП меньше, чем общее число свободных ЦП в течение более чем 10 минут.
* Общий объем ожидающей памяти меньше, чем общее количество свободной памяти в течение более чем 10 минут.

Исходя из числа контейнеров AM каждого узла и текущая загрузка ЦП и требования к памяти, автоматического масштабирования выдает запрос на удаление определенное количество узлов. Служба также определяет, какие узлы являются кандидатами для удаления, на основе текущего выполнения задания. Операция уменьшения масштаба сначала выводит из эксплуатации узлы и затем удаляет их из кластера.

## <a name="get-started"></a>Начало работы

### <a name="create-a-cluster-with-load-based-autoscaling"></a>Создание кластера с автоматическим масштабированием на основе нагрузки

Чтобы включить функцию автомасштабирования на основе нагрузки масштабирования, выполните следующие действия, как часть обычного при создании кластера:

1. Выберите **Настраиваемое (размер, параметры, приложения)** вместо **Быстрое создание**.
1. На **Custom** шаг 5 (**размер кластера**), проверьте **Автомасштабирование узла рабочей роли** флажок.
1. Выберите параметр **на основе нагрузки** под **автомасштабирования тип**.
1. Введите нужные значения для следующих свойств:  

    * начального **количества рабочих узлов**;  
    * **минимального** количества рабочих узлов;  
    * **максимального** количества рабочих узлов.  

    ![Включить параметр автомасштабирования на основе нагрузки узла рабочей роли](./media/hdinsight-autoscale-clusters/usingAutoscale.png)

Начальное количество рабочих узлов должно быть в диапазоне между максимальным и минимальным количеством. Это значение определяет начальный размер кластера при его создании. Минимальное количество рабочих узлов должно быть больше нуля.

### <a name="create-a-cluster-with-schedule-based-autoscaling"></a>Создание кластера с автоматическим масштабированием на основе расписания

Чтобы включить функцию автомасштабирования расписанию масштабирования, выполните следующие действия, как часть обычного при создании кластера:

1. Выберите **Настраиваемое (размер, параметры, приложения)** вместо **Быстрое создание**.
1. На **Custom** шаг 5 (**размер кластера**), проверьте **Автомасштабирование узла рабочей роли** флажок.
1. Введите **число рабочих узлов**, который управляет предел для масштабирования кластера.
1. Выберите параметр **расписанию** под **автомасштабирования тип**.
1. Нажмите кнопку **Настройка** открыть **конфигурацию автомасштабирования** окна.
1. Выберите вашего часового пояса и нажмите кнопку **+ добавить условие**
1. Выберите дни недели, которое применяется к нового условия.
1. Измените время, которое должна выполнить условие, расписания и количество узлов, которые необходимо изменить масштаб кластера для.
1. Добавьте дополнительные условия, при необходимости.

    ![Включить параметр автоматического масштабирования на основе расписания узла рабочей роли](./media/hdinsight-autoscale-clusters/hdinsight-autoscale-clusters-schedule-creation.png)

Число узлов должно быть от 1 до числа рабочих узлов, которые вы ввели, прежде чем добавлять условия.

### <a name="final-creation-steps"></a>Действия по созданию окончательного

Для масштабирования на основе нагрузки и расписание, выберите тип виртуальной Машины для рабочих узлов, щелкнув **размер узла рабочей роли** и **размер головного узла**. После выбора типа виртуальной Машины для каждого типа узла, можно увидеть диапазон Расчетная стоимость для всего кластера. Настройка типов виртуальных Машин для любого бюджета.

![Включить параметр автоматического масштабирования на основе расписания узла рабочей роли](./media/hdinsight-autoscale-clusters/hdinsight-autoscale-clusters-node-size-selection.png)

Ваша подписка имеет квоту емкости для каждого региона. Общее число ядер на головных узлах в сочетании с максимальным числом рабочих узлов не может превышать квоту емкости. Тем не менее эта квота — нестрогое ограничение. Вы всегда можете создать запрос в службу поддержки, чтобы легко ее повысить.

> [!Note]  
> Если будет превышено общее основной квоты, вы получите сообщение об ошибке «максимальное узел превышено доступных ядер в этом регионе, выберите другой регион или обратитесь в службу поддержки для увеличения квоты.»

Дополнительные сведения о создании кластера HDInsight с помощью портала Azure см. в статье [Создание кластеров под управлением Linux в HDInsight с помощью портала Azure](hdinsight-hadoop-create-linux-clusters-portal.md).  

### <a name="create-a-cluster-with-a-resource-manager-template"></a>Создание кластера с помощью шаблона Resource Manager

#### <a name="load-based-autoscaling"></a>Автоматическое масштабирование на основе нагрузки

Вы можно создать кластер HDInsight с автоматическим масштабированием на основе нагрузки шаблона Azure Resource Manager, добавив `autoscale` узел `computeProfile`  >  `workernode` раздел со свойствами `minInstanceCount` и `maxInstanceCount` как показано в приведенном ниже фрагменте кода json.

```json
{
  "name": "workernode",
  "targetInstanceCount": 4,
  "autoscale": {
      "capacity": {
          "minInstanceCount": 2,
          "maxInstanceCount": 10
      }
  },
  "hardwareProfile": {
      "vmSize": "Standard_D13_V2"
  },
  "osProfile": {
      "linuxOperatingSystemProfile": {
          "username": "[parameters('sshUserName')]",
          "password": "[parameters('sshPassword')]"
      }
  },
  "virtualNetworkProfile": null,
  "scriptActions": []
}
```

Дополнительные сведения о создании кластеров с помощью шаблонов Resource Manager см. в статье [Создание кластеров Apache Hadoop в HDInsight с помощью шаблонов Resource Manager](hdinsight-hadoop-create-linux-clusters-arm-templates.md).  

#### <a name="schedule-based-autoscaling"></a>Автоматическое масштабирование на основе расписания

Вы можно создать кластер HDInsight с автоматическим масштабированием на основе расписания шаблона Azure Resource Manager, добавив `autoscale` узел `computeProfile`  >  `workernode` раздел. `autoscale` Узел содержит `recurrence` с `timezone` и `schedule` , описывающий, когда изменение будет иметь место.

```json
{
  "autoscale": {
    "recurrence": {
      "timeZone": "Pacific Standard Time",
      "schedule": [
        {
          "days": [
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday"
          ],
          "timeAndCapacity": {
            "time": "11:00",
            "minInstanceCount": 10,
            "maxInstanceCount": 10
          }
        },
      ]
    }
  },
  "name": "workernode",
  "targetInstanceCount": 4,
}
```

### <a name="enable-and-disable-autoscale-for-a-running-cluster"></a>Включение и отключение автомасштабирования для работающего кластера

Чтобы включить автоматическое масштабирование в работающем кластере, выберите **размер кластера** под **параметры**. Нажмите кнопку **включить Автомасштабирование**. Выберите тип автоматического масштабирования, необходимо и введите параметры масштабирования на основе нагрузки или расписанию. Наконец, нажмите кнопку **Сохранить**.

![Включить параметр автоматического масштабирования на основе расписания узла рабочей роли](./media/hdinsight-autoscale-clusters/hdinsight-autoscale-clusters-enable-running-cluster.png)

## <a name="monitoring"></a>Мониторинг

### <a name="cluster-status"></a>Состояние кластера

Состояние кластера, указанное на портале Azure может помочь отслеживать действия автомасштабирования.

![Включить параметр автомасштабирования на основе нагрузки узла рабочей роли](./media/hdinsight-autoscale-clusters/hdinsight-autoscale-clusters-cluster-status.png)

Все сообщения о состоянии кластера, которые можно встретить см. в списке ниже.

| Состояние кластера | Объяснение |
|---|---|
| Работает | Кластер работает нормально. Все предыдущие действия автомасштабирования успешно завершена. |
| Обновление  | Выполняется обновление конфигурации автоматического масштабирования кластера.  |
| Конфигурация HDInsight  | Масштабирование кластера или выполняется операция уменьшения масштаба.  |
| Ошибка обновления  | HDInsight обнаружены проблемы во время обновления конфигурации автомасштабирования. Клиенты могут выбрать повторите обновление или отключение автомасштабирования.  |
| Ошибка  | Возникла ли ошибка с кластером, и он не может использоваться. Удалить этот кластер и создать новую.  |

Чтобы просмотреть текущее число узлов в кластере, перейдите к **размер кластера** диаграммы на **Обзор** странице для кластера, или нажмите кнопку **размер кластера** под  **Параметры**.

### <a name="operation-history"></a>Журнал операций

Можно просматривать журнал увеличение и уменьшение масштаба кластера как часть метрик кластера. Также можно вывести список всех действий масштабирования за прошедший день, неделю или другой период времени.

Выберите **метрики** под **мониторинга**. Нажмите кнопку **добавить метрику** и **количество активных рабочих потоков** из **метрика** раскрывающемся списке. Нажмите кнопку в правом верхнем углу, чтобы изменить диапазон времени.

![Включить параметр автоматического масштабирования на основе расписания узла рабочей роли](./media/hdinsight-autoscale-clusters/hdinsight-autoscale-clusters-chart-metric.png)


## <a name="next-steps"></a>Дальнейшие действия

* Прочитайте рекомендации по масштабированию кластеров вручную [здесь](hdinsight-scaling-best-practices.md).
