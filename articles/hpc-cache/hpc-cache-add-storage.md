---
title: Добавление хранилища в кэш HPC Azure
description: Определение целевых объектов хранилища, чтобы кэш Azure HPC мог использовать локальную систему NFS или контейнеры больших двоичных объектов Azure для долгосрочного хранения файлов.
author: ekpgh
ms.service: hpc-cache
ms.topic: how-to
ms.date: 07/08/2020
ms.author: v-erkel
ms.openlocfilehash: 7ad910823c4dd2430aeae085dd8e510fcd42c80f
ms.sourcegitcommit: 3d56d25d9cf9d3d42600db3e9364a5730e80fa4a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2020
ms.locfileid: "87532600"
---
# <a name="add-storage-targets"></a>Добавление целевых объектов хранилища

*Целевые объекты хранилища* — это серверное хранилище для файлов, доступ к которым осуществляется через кэш HPC Azure. Вы можете добавить хранилище NFS (например, локальную аппаратную систему) или сохранить данные в большом двоичном объекте Azure.

Можно определить до десяти различных целевых объектов хранилища для одного кэша. Кэш представляет все целевые объекты хранилища в одном объединенном пространстве имен.

Помните, что экспорты хранилища должны быть доступны из виртуальной сети кэша. Для локального хранилища оборудования может потребоваться настроить DNS-сервер, который может разрешать имена узлов для доступа к хранилищу NFS. Дополнительные сведения см. в статье [доступ к DNS](hpc-cache-prerequisites.md#dns-access).

Добавьте целевые объекты хранилища после создания кэша. Процедура немного отличается в зависимости от того, добавляется ли хранилище BLOB-объектов Azure или экспорт NFS. Сведения для каждого из них приведены ниже.

Щелкните изображение ниже, чтобы просмотреть [видео демонстрацию](https://azure.microsoft.com/resources/videos/set-up-hpc-cache/) создания кэша и добавления целевого объекта хранилища из портал Azure.

[![Эскиз видео: кэш Azure HPC: Настройка (щелкните, чтобы посетить страницу видео)](media/video-4-setup.png)](https://azure.microsoft.com/resources/videos/set-up-hpc-cache/)

## <a name="view-storage-targets"></a>Просмотр целевых объектов хранилища

### <a name="portal"></a>[Портал](#tab/azure-portal)

В портал Azure откройте экземпляр кэша и щелкните **целевые объекты хранилища** на левой боковой панели. На странице целевые объекты хранилища перечисляются все существующие целевые объекты и добавляется ссылка для добавления новой.

![снимок экрана: ссылка на целевые объекты хранилища на боковой панели под заголовком Настройка, между параметрами заголовков категорий и мониторингом](media/hpc-cache-storage-targets-sidebar.png)

### <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

[!INCLUDE [cli-reminder.md](includes/cli-reminder.md)]

Чтобы отобразить существующие целевые объекты хранилища для кэша, воспользуйтесь параметром [AZ HPC-Cache Storage-Target List](/cli/azure/ext/hpc-cache/hpc-cache/storage-target#ext-hpc-cache-az-hpc-cache-storage-target-list) . Укажите имя кэша и группу ресурсов (если вы не настроили ее глобально).

```azurecli
az hpc-cache storage-target list --resource-group "scgroup" --cache-name "sc1"
```

Чтобы просмотреть сведения о конкретном целевом объекте хранилища, используйте команду [AZ HPC — хранилище кэша — целевое отображение](/cli/azure/ext/hpc-cache/hpc-cache/storage-target#ext-hpc-cache-az-hpc-cache-storage-target-list) . (Укажите целевой объект хранилища по имени.)

Пример

```azurecli
$ az hpc-cache storage-target show --cache-name doc-cache0629 --name nfsd1

{
  "clfs": null,
  "id": "/subscriptions/<subscription_ID>/resourceGroups/scgroup/providers/Microsoft.StorageCache/caches/doc-cache0629/storageTargets/nfsd1",
  "junctions": [
    {
      "namespacePath": "/nfs1/data1",
      "nfsExport": "/datadisk1",
      "targetPath": ""
    }
  ],
  "location": "eastus",
  "name": "nfsd1",
  "nfs3": {
    "target": "10.0.0.4",
    "usageModel": "WRITE_WORKLOAD_15"
  },
  "provisioningState": "Succeeded",
  "resourceGroup": "scgroup",
  "targetType": "nfs3",
  "type": "Microsoft.StorageCache/caches/storageTargets",
  "unknown": null
}
$
```

---

## <a name="add-a-new-azure-blob-storage-target"></a>Добавление нового целевого объекта хранилища BLOB-объектов Azure

Для нового целевого объекта хранилища BLOB-объектов требуется пустой контейнер больших двоичных объектов или контейнер, заполненный данными в формате облачной файловой системы Azure HPC. Дополнительные сведения о предварительной загрузке контейнера больших двоичных объектов см. в статье [Перемещение данных в хранилище BLOB-объектов Azure](hpc-cache-ingest.md).

На странице портал Azure **Добавление целевого объекта хранилища** имеется возможность создать новый контейнер больших двоичных объектов непосредственно перед добавлением.

### <a name="portal"></a>[Портал](#tab/azure-portal)

![снимок экрана: страница "Добавление целевого объекта хранилища", заполненная данными для нового целевого объекта хранилища BLOB-объектов Azure](media/hpc-cache-add-blob.png)

Чтобы определить контейнер больших двоичных объектов Azure, введите эти сведения.

* **Имя целевого объекта хранилища** — задайте имя, идентифицирующее этот целевой объект хранилища в кэше HPC Azure.
* **Тип целевого объекта** — выберите **BLOB-объект**.
* **Учетная запись хранения** . Выберите учетную запись, которую вы хотите использовать.

  Необходимо авторизовать экземпляр кэша для доступа к учетной записи хранения, как описано в разделе [Добавление ролей доступа](#add-the-access-control-roles-to-your-account).

  Сведения о типе учетной записи хранения, которую можно использовать, см. в статье [требования к хранилищу BLOB-объектов](hpc-cache-prerequisites.md#blob-storage-requirements).

* **Контейнер хранилища** . Выберите контейнер больших двоичных объектов для этого целевого объекта или нажмите кнопку **создать**.

  ![снимок экрана диалогового окна для указания имени и уровня доступа (частный) для нового контейнера](media/add-blob-new-container.png)

* **Путь к виртуальному пространству имен** — задает путь к файлу для клиента для этого целевого объекта хранилища. Дополнительные сведения о функции виртуального пространства имен см. в статье [Настройка агрегированного пространства имен](hpc-cache-namespace.md) .

По завершении нажмите кнопку **ОК** , чтобы добавить целевой объект хранилища.

> [!NOTE]
> Если брандмауэр учетной записи хранения настроен для ограничения доступа только к выбранным сетям, используйте временное решение, описанное в статье обход [параметров брандмауэра для учетной записи хранения BLOB-объектов](hpc-cache-blob-firewall-fix.md).

### <a name="add-the-access-control-roles-to-your-account"></a>Добавление ролей контроля доступа в учетную запись

Кэш Azure HPC использует [Управление доступом на основе ролей (RBAC)](https://docs.microsoft.com/azure/role-based-access-control/index) для авторизации службы кэша на доступ к учетной записи хранения для целевых объектов хранилища BLOB-объектов Azure.

Владелец учетной записи хранения должен явно добавить роли [участника учетной записи хранения](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-account-contributor) ролей и [участника данных большого двоичного объекта хранилища](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor) для пользователя "поставщик ресурсов кэша HPC".

Это можно сделать заранее или щелкнув ссылку на странице, где вы добавите целевой объект хранилища BLOB-объектов. Помните, что для распространения параметров роли в среде Azure может потребоваться до пяти минут, поэтому необходимо подождать несколько минут после добавления ролей перед созданием целевого объекта хранилища.

Шаги для добавления ролей Azure:

1. Откройте страницу **управления доступом (IAM)** для учетной записи хранения. (Ссылка на странице **Добавление целевого объекта хранилища** автоматически открывает эту страницу для выбранной учетной записи.)

1. Щелкните в **+** верхней части страницы и выберите **добавить назначение роли**.

1. Выберите роль "участник учетной записи хранения" из списка.

1. В поле **назначить доступ к** оставьте значение по умолчанию ("пользователь Azure AD, группа или субъект-служба").  

1. В поле **выбора** выполните поиск по запросу "HPC".  Эта строка должна соответствовать одному субъекту-службе с именем "поставщик ресурсов кэша HPC". Щелкните этот субъект, чтобы выбрать его.

   > [!NOTE]
   > Если Поиск "HPC" не работает, попробуйте использовать строку "сторажекаче". Пользователям, получившим участие в предварительных версиях (до общедоступной версии), может потребоваться использовать старое имя субъекта-службы.

1. Нажмите кнопку **сохранить** внизу.

1. Повторите эту процедуру, чтобы назначить роль "участник данных BLOB-объекта хранилища".  

![снимок экрана: Добавление графического пользовательского интерфейса назначения ролей](media/hpc-cache-add-role.png)

### <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

[!INCLUDE [cli-reminder.md](includes/cli-reminder.md)]

### <a name="prerequisite-storage-account-access"></a>Необходимое условие: доступ к учетной записи хранения

Перед добавлением целевого объекта хранилища BLOB-объектов убедитесь, что кэш имеет нужные роли для доступа к учетной записи хранения, и что параметры брандмауэра допускают создание целевого объекта хранилища.

Кэш Azure HPC использует [Управление доступом на основе ролей (RBAC)](../role-based-access-control/index.yml) для авторизации службы кэша на доступ к учетной записи хранения для целевых объектов хранилища BLOB-объектов Azure.

Владелец учетной записи хранения должен явно добавить роли [участника учетной записи хранения](../role-based-access-control/built-in-roles.md#storage-account-contributor) ролей и [участника данных большого двоичного объекта хранилища](../role-based-access-control/built-in-roles.md#storage-blob-data-contributor) для пользователя "поставщик ресурсов кэша HPC".

Создание целевого объекта хранилища завершится ошибкой, если в кэше отсутствуют эти роли.

Для распространения параметров роли в среде Azure может потребоваться до пяти минут, поэтому необходимо подождать несколько минут после добавления ролей перед созданием целевого объекта хранилища.

Подробные инструкции [см. в статье Добавление и удаление назначений ролей Azure с помощью Azure CLI](../role-based-access-control/role-assignments-cli.md) .

Также проверьте параметры брандмауэра учетной записи хранения. Если брандмауэр настроен для ограничения доступа только к выбранным сетям, создание целевого объекта хранилища может завершиться ошибкой. Используйте обходное решение, описанное в статье [Работа с параметрами брандмауэра для учетной записи хранения BLOB-объектов](hpc-cache-blob-firewall-fix.md).

### <a name="add-a-blob-storage-target-with-azure-cli"></a>Добавление целевого объекта хранилища BLOB-объектов с Azure CLI

Чтобы определить целевой объект хранилища BLOB-объектов Azure, используйте интерфейс [Add HPC-Cache Blob — Storage-Target](/cli/azure/ext/hpc-cache/hpc-cache/blob-storage-target#ext-hpc-cache-az-hpc-cache-blob-storage-target-add) .

Помимо стандартных параметров группы ресурсов и имени кэша, необходимо указать следующие параметры для целевого объекта хранилища:

* ``--name``— Укажите имя, идентифицирующее этот целевой объект хранилища в кэше HPC Azure.

* ``--storage-account``— Идентификатор учетной записи в следующем формате:/Subscriptions/*<subscription_id>*/resourceGroups/*<storage_resource_group>*/провидерс/Микрософт.стораже/сторажеаккаунтс/*<account_name>*

  Сведения о типе учетной записи хранения, которую можно использовать, см. в статье [требования к хранилищу BLOB-объектов](hpc-cache-prerequisites.md#blob-storage-requirements).

* ``--container-name``— Укажите имя контейнера, который будет использоваться для этого целевого объекта хранилища.

* ``--virtual-namespace-path``— Укажите путь к файлу для этого целевого объекта хранилища. Заключите пути в кавычки. Дополнительные сведения о функции виртуального пространства имен см. в статье [планирование обобщенного пространства имен](hpc-cache-namespace.md) .

Пример команды:

```azurecli
az hpc-cache blob-storage-target add --resource-group "hpc-cache-group" \
    --cache-name "cache1" --name "blob-target1" \
    --storage-account "/subscriptions/<subscriptionID>/resourceGroups/myrgname/providers/Microsoft.Storage/storageAccounts/myaccountname" \
    --container-name "container1" --virtual-namespace-path "/blob1"
```

---

## <a name="add-a-new-nfs-storage-target"></a>Добавление нового целевого объекта хранилища NFS

В целевом объекте хранилища NFS больше полей, чем у целевого объекта хранилища BLOB-объектов. Эти поля указывают, как достичь экспорта хранилища и как эффективно кэшировать данные. Кроме того, целевой объект хранилища NFS позволяет создать несколько путей к пространству имен, если на узле NFS доступно несколько экспортов.

![Снимок экрана: страница добавления целевого объекта хранилища с определенным целевым объектом NFS](media/add-nfs-target.png)

> [!NOTE]
> Перед созданием целевого объекта хранилища NFS убедитесь, что ваша система хранения доступна из кэша HPC Azure и соответствует требованиям к разрешениям. Создание целевого объекта хранилища завершится ошибкой, если кэш не может получить доступ к системе хранения. Дополнительные сведения см. в статье [требования к хранилищу NFS](hpc-cache-prerequisites.md#nfs-storage-requirements) и [Устранение неполадок конфигурации NAS и целевого сервера хранилища NFS](troubleshoot-nas.md) .

### <a name="choose-a-usage-model"></a>Выбор модели использования
<!-- referenced from GUI - update aka.ms link if you change this heading -->

При создании целевого объекта хранилища, указывающего на систему хранения NFS, необходимо выбрать модель использования для этого целевого объекта. Эта модель определяет, как кэшируются данные.

Доступны три параметра:

* **Частое чтение, редкие операции записи** . Используйте этот параметр, если требуется ускорить доступ на чтение к файлам, которые являются статическими или редко изменяемыми.

  Этот параметр кэширует файлы, которые считываются клиентами, но немедленно передает записи в хранилище серверной части. Файлы, хранящиеся в кэше, никогда не сравниваются с файлами на томе хранилища NFS.

  Не используйте этот параметр, если существует риск, что файл может быть изменен непосредственно в системе хранения без предварительной записи в кэш. В этом случае кэшированная версия файла никогда не будет обновлена с учетом изменений из серверной части, а набор данных может стать несогласованным.

* Более **15% операций записи** . Этот параметр ускоряет скорость чтения и записи. При использовании этого параметра все клиенты должны получить доступ к файлам через кэш HPC Azure, а не подключать серверное хранилище напрямую. В кэшированных файлах будут внесены последние изменения, которые не хранятся в серверной части.

  В этой модели использования файлы в кэше не проверяются по файлам на внутреннем хранилище. Предполагается, что кэшированная версия файла является более актуальной. Измененный файл в кэше записывается в систему хранения серверной части после того, как она найдет в кэше в течение часа без дополнительных изменений.

* **Клиенты записывают данные в целевой объект NFS, минуя кэш** . Выберите этот параметр, если какие-либо клиенты в рабочем процессе записывают данных непосредственно в систему хранения без предварительной записи в кэш. Файлы, запрашиваемые клиентами, кэшируются, но любые изменения этих файлов, передаваемые из клиента, немедленно передаются обратно в систему хранения в серверной части.

  В этой модели использования файлы в кэше часто проверяются относительно серверных версий для обновлений. Эта проверка позволяет изменять файлы вне кэша, сохраняя согласованность данных.

В этой таблице перечислены различия в модели использования.

| Модель использования                   | Режим кэширования | Проверка серверной части | Максимальная задержка записи на сервер |
|-------------------------------|--------------|-----------------------|--------------------------|
| Частое чтение, редкие операции записи | Чтение         | Никогда                 | None                     |
| Более 15% операций записи       | Чтение/запись   | Никогда                 | 1 час                   |
| Клиенты обходят кэш      | Чтение         | 30 секунд            | None                     |

### <a name="create-an-nfs-storage-target"></a>Создание целевого объекта хранилища NFS

### <a name="portal"></a>[Портал](#tab/azure-portal)

![Снимок экрана: страница добавления целевого объекта хранилища с определенным целевым объектом NFS](media/add-nfs-target.png)

Укажите эти сведения для целевого объекта хранилища с поддержкой NFS:

* **Имя целевого объекта хранилища** — задайте имя, идентифицирующее этот целевой объект хранилища в кэше HPC Azure.

* **Тип целевого объекта** — выберите **NFS**.

* **Имя узла** — введите IP-адрес или полное доменное имя для системы хранения NFS. (Используйте доменное имя, только если ваш кэш имеет доступ к DNS-серверу, который может разрешить это имя.)

* **Модель использования** — выберите один из профилей кэширования данных на основе рабочего процесса, описанный в разделе [Выбор модели использования](#choose-a-usage-model) выше.

### <a name="nfs-namespace-paths"></a>Пути к пространству имен NFS

Целевой объект хранилища NFS может иметь несколько виртуальных путей, если каждый путь представляет отдельный экспорт или подкаталог в одной системе хранения.

Создайте все пути из одного целевого объекта хранилища.

Пути к [пространству имен](hpc-cache-edit-storage.md) в целевом хранилище можно добавлять и изменять в любое время.

Заполните эти значения для каждого пути к пространству имен:

* **Путь к виртуальному пространству имен** — задает путь к файлу для клиента для этого целевого объекта хранилища. Дополнительные сведения о функции виртуального пространства имен см. в статье [Настройка агрегированного пространства имен](hpc-cache-namespace.md) .

* **Путь экспорта NFS** — введите путь к экспорту NFS.

* **Путь к подкаталогу** . Если вы хотите подключить конкретный подкаталог экспорта, введите его здесь. Если нет, оставьте это поле пустым.

По завершении нажмите кнопку **ОК** , чтобы добавить целевой объект хранилища.

### <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

[!INCLUDE [cli-reminder.md](includes/cli-reminder.md)]

Чтобы создать целевой объект хранилища, используйте команду Azure CLI [AZ HPC-Cache NFS-Storage-Target Add](/cli/azure/ext/hpc-cache/hpc-cache/nfs-storage-target#ext-hpc-cache-az-hpc-cache-nfs-storage-target-add) . Укажите эти значения в дополнение к имени кэша и группе ресурсов кэша:

* ``--name``— Укажите имя, идентифицирующее этот целевой объект хранилища в кэше HPC Azure.
* ``--nfs3-target``— IP-адрес системы хранения NFS. (Полное доменное имя можно использовать здесь, если ваш кэш имеет доступ к DNS-серверу, который может разрешить это имя).
* ``--nfs3-usage-model``— Один из профилей кэширования данных, описанный в разделе [Выбор модели использования](#choose-a-usage-model)выше.

  Проверьте имена моделей использования с помощью команды [AZ HPC-Cache Usage-Model List](/cli/azure/ext/hpc-cache/hpc-cache/usage-model#ext-hpc-cache-az-hpc-cache-usage-model-list).

* ``--junction``— Параметр соединения связывает путь к виртуальному файлу клиента с путем экспорта в системе хранения.

  Целевой объект хранилища NFS может иметь несколько виртуальных путей, если каждый путь представляет отдельный экспорт или подкаталог в одной системе хранения. Создайте все пути для одной системы хранения на одном целевом объекте хранилища.

  Пути к [пространству имен](hpc-cache-edit-storage.md) в целевом хранилище можно добавлять и изменять в любое время.

  ``--junction``Параметр использует следующие значения:

  * ``namespace-path``— Путь к виртуальному файлу клиента.
  * ``nfs-export``— Экспорт системы хранения, связываемый с путем, ориентированным на клиента
  * ``target-path``(необязательно) — подкаталог экспорта (при необходимости).

  Например, ``--junction namespace-path="/nas-1" nfs-export="/datadisk1" target-path="/test"``.

  Дополнительные сведения о функции виртуального пространства имен см. в статье [Настройка агрегированного пространства имен](hpc-cache-namespace.md) .

Пример команды:

```azurecli

az hpc-cache nfs-storage-target add --resource-group "hpc-cache-group" --cache-name "doc-cache0629" \
    --name nfsd1 --nfs3-target 10.0.0.4 --nfs3-usage-model WRITE_WORKLOAD_15 \
    --junction namespace-path="/nfs1/data1" nfs-export="/datadisk1" target-path=""
```

Выходные данные:
```azurecli

{- Finished ..
  "clfs": null,
  "id": "/subscriptions/<subscriptionID>/resourceGroups/hpc-cache-group/providers/Microsoft.StorageCache/caches/doc-cache0629/storageTargets/nfsd1",
  "junctions": [
    {
      "namespacePath": "/nfs1/data1",
      "nfsExport": "/datadisk1",
      "targetPath": ""
    }
  ],
  "location": "eastus",
  "name": "nfsd1",
  "nfs3": {
    "target": "10.0.0.4",
    "usageModel": "WRITE_WORKLOAD_15"
  },
  "provisioningState": "Succeeded",
  "resourceGroup": "hpc-cache-group",
  "targetType": "nfs3",
  "type": "Microsoft.StorageCache/caches/storageTargets",
  "unknown": null
}

```

---

## <a name="next-steps"></a>Дальнейшие действия

После создания целевых объектов хранилища рассмотрите одну из следующих задач.

* [Mount the Azure HPC Cache](hpc-cache-mount.md) (Подключение Azure HPC Cache)
* [Перемещение данных в хранилище BLOB-объектов Azure](hpc-cache-ingest.md)

Если необходимо обновить какие-либо параметры, можно [изменить целевой объект хранилища](hpc-cache-edit-storage.md).
