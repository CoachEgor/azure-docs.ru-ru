---
title: Настройка размещенной в Azure виртуальной Машины Майкрософт для Azure Marketplace
description: Информация об оценке размера, обновлении и обобщении для размещенной в Azure виртуальной машины.
services: Azure, Marketplace, Cloud Partner Portal,
author: v-miclar
ms.service: marketplace
ms.topic: conceptual
ms.date: 10/19/2018
ms.author: pabutler
ms.openlocfilehash: 3d38efadfb8ad13d072056ef851be99d9540ad4b
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "64938433"
---
# <a name="configure-the-azure-hosted-vm"></a>Настройка размещенной в Azure виртуальной машины

Эта статья содержит сведения об оценке размера, обновлении и обобщении для размещенной в Azure виртуальной машины.  Эти шаги нужны для того, чтобы подготовить виртуальную машину к развертыванию из Azure Marketplace.


## <a name="sizing-the-vhds"></a>Определение размера виртуальных жестких дисков

<!--TD: Check if the following assertion is true. I didn't understand the original content. -->
Если вы выбрали одну из виртуальных машин, предварительно настроены для операционной системы (и при необходимости дополнительные службы), то уже выбрано стандартного размера виртуальной Машины Azure, как описано в разделе [номера SKU виртуальных машин вкладку](./cpp-skus-tab.md).  Рекомендуется запускать решение в предварительно настроенных ОС.  Но если вы устанавливаете операционную систему вручную, необходимо выбрать размер основного виртуального жесткого диска для образа виртуальной машины.

- Для Windows виртуальный жесткий диск для операционной системы должен иметь фиксированный формат и размер 127-128 ГБ. 
- Для Linux этот виртуальный жесткий диск должен иметь фиксированный формат и размер 30–50 ГБ.

Если физический размер меньше 127-128 ГБ, виртуальный жесткий диск должен быть разреженным. Предоставляемые базовые образы Windows и SQL Server уже соответствуют этим требованиям. Не меняйте формат и размер полученного виртуального жесткого диска. 

Размер дисков данных может достигать 1 ТБ. Выбирая размер их диска, помните, что конечные пользователи не смогут изменить размер виртуальных жестких дисков в образе во время развертывания. Виртуальные жесткие диски для данных следует создавать с фиксированным форматом. Тем не менее их также следует разбивать на части. Диски данных могут быть пустыми или сразу содержать данные.


## <a name="install-the-most-current-updates"></a>Установка самых свежих обновлений

Базовые образы виртуальных машин с операционной системой содержат все последние обновления вплоть до даты публикации образа. Перед публикацией созданного вручную виртуального жесткого диска обязательно применить все обновления безопасности и обслуживания для операционной системы и всех установленных служб.

В ОС Windows Server 2016 для этого следует запустить команду **Проверить наличие обновлений**.  Для более старых версий Windows изучите статью[о получении обновлений через Центр обновления Windows](https://support.microsoft.com/help/3067639/how-to-get-an-update-through-windows-update).  Центр обновлений Windows автоматически установит все свежие обновления критического уровня и важные для безопасности.

Для дистрибутивов Linux обновления обычно скачиваются и устанавливаются с помощью средства командной строки или графической программы.  Например, в Ubuntu Linux для обновления операционной системы есть команда [apt-get](https://manpages.ubuntu.com/manpages/cosmic/man8/apt-get.8.html) и средство [Менеджер обновления](https://manpages.ubuntu.com/manpages/cosmic/man8/update-manager.8.html).


## <a name="perform-additional-security-checks"></a>Выполнение дополнительных проверок безопасности

Вы обязаны обеспечить высокий уровень безопасности для образов решений, размещаемых в Azure Marketplace.  В статье ниже представлены контрольный список конфигураций и процедур безопасности, которые помогут в достижении этой цели. [Рекомендации по обеспечению безопасности для образов Azure Marketplace](https://docs.microsoft.com/azure/security/security-recommendations-azure-marketplace-images)  Некоторые из этих рекомендаций относятся только к образам на основе Linux, но большинство из них универсальны для любой виртуальной машины. 


## <a name="perform-custom-configuration-and-scheduled-tasks"></a>Выполнение пользовательской настройки и запланированные задачи

Если необходима дополнительная настройка, мы рекомендуем использовать запланированную задачу, которая сработает при запуске и внесет окончательные изменения в виртуальную машину сразу после ее развертывания.  Учтите также следующие рекомендации.
- Если это задача однократного запуска, она должна удалять себя после успешного завершения.
- Конфигурации не должны полагаться на другие диски, кроме C или D, так как наличие гарантируется только для этих двух дисков. Диск C служит для размещения операционной системы, а диск D является временным локальным диском.

Дополнительные сведения о настройке Linux см. в обзоре [расширений и компонентов виртуальной машины для Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/features-linux).


## <a name="generalize-the-image"></a>Обобщение образа

Все образы в Azure Marketplace должны быть доступны для повторного использования в первоначальном виде. Чтобы достичь этой возможности повторного использования, виртуальный жесткий диск для операционной системы необходимо *обобщить*. Эта операция удаляет с виртуальной машины все идентификаторы, относящиеся к определенному экземпляру, и программные драйверы.

### <a name="windows"></a>Windows

Диски операционной системы Windows обобщаются с помощью [средства sysprep](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview). Если вы позднее обновите операционную систему или измените ее конфигурацию, снова запустите sysprep. 

> [!WARNING]
>  Поскольку обновления могут применяться автоматически, после запуска sysprep следует отключить виртуальную машину и не включать до завершения развертывания.  Завершение работы не позволит неожиданным обновлениям внести на виртуальный жесткий диск или в установленные службы изменения, относящиеся к конкретному экземпляру.

Дополнительные сведения о запуске sysprep см. в разделе [шаги по подготовке виртуального жесткого диска](https://docs.microsoft.com/azure/virtual-machines/windows/prepare-for-upload-vhd-image#steps-to-generalize-a-vhd)

### <a name="linux"></a>Linux

Следующий двухэтапный процесс обобщает виртуальную машину Linux и повторно развертывает ее в качестве отдельной виртуальной машины.  Дополнительные сведения см. в статье о [создании образа виртуальной машины или виртуального жесткого диска](../../../virtual-machines/linux/capture-image.md). 

#### <a name="remove-the-azure-linux-agent"></a>Удаление агента Linux для Azure
1.  Подключитесь к виртуальной машине Linux c помощью клиента SSH.
2.  В окне сеанса SSH введите следующую команду. <br/>
    `sudo waagent -deprovision+user`
3.  Введите `y`, чтобы продолжить (Чтобы предотвратить появление запроса на подтверждение, добавьте к предыдущей команде параметр `-force`.)
4.  После выполнения команды введите `exit`, чтобы закрыть SSH-клиент.

<!-- TD: I need to add meat and/or references to the following steps -->
#### <a name="capture-the-image"></a>Запись образа
1.  Перейдите на портал Azure, выберите нужную группу ресурсов и отмените распределение виртуальной машины.
2.  Это действие обобщает виртуальный жесткий диск, и теперь вы можете создать новую виртуальную машину на основе этого виртуального жесткого диска.


## <a name="create-one-or-more-copies"></a>Создание одной или нескольких копий

Создание копий виртуальной машины часто полезно для резервного копирования, тестирования, особых сценариев отработки отказа или балансировки нагрузки, а также для создания разных конфигураций решения и т. д. Сведения о том, как дублировать и скачать виртуальный жесткий диск, чтобы создать неуправляемый клон, представлены в следующих статьях.

- Виртуальная машина Linux. [Загрузить виртуальный жесткий диск Linux из Azure](../../../virtual-machines/linux/download-vhd.md)
- Виртуальная машина Windows. [Загрузить виртуальный жесткий диск Windows из Azure](../../../virtual-machines/windows/download-vhd.md)


## <a name="next-steps"></a>Дальнейшие действия

Завершив настройку виртуальной машины, можно переходить к [развертыванию виртуальной машины из виртуального жесткого диска](./cpp-deploy-vm-vhd.md).
