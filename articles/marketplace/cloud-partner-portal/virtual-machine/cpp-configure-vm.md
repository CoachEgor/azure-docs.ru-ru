---
title: Настройка размещенной Microsoft Azure виртуальной машины для Azure Marketplace
description: Информация об оценке размера, обновлении и обобщении для размещенной в Azure виртуальной машины.
author: dsindona
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: conceptual
ms.date: 10/19/2018
ms.author: dsindona
ms.openlocfilehash: 4cb247a3e64f8d44cc64010dde40963f4e9a1993
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82146094"
---
# <a name="configure-the-azure-hosted-vm"></a>Настройка размещенной в Azure виртуальной машины

> [!IMPORTANT]
> Начиная с 13 апреля 2020 г. мы начнем Управление виртуальными машинами Azure, предлагаемыми в центре партнеров. После миграции вы создадите предложения в центре партнеров и будете управлять ими. Следуйте инструкциям в статье [Создание технических ресурсов виртуальной машины Azure](https://docs.microsoft.com/azure/marketplace/partner-center-portal/azure-vm-create-offer) для управления перенесенными предложениями.

Эта статья содержит сведения об оценке размера, обновлении и обобщении для размещенной в Azure виртуальной машины.  Эти шаги нужны для того, чтобы подготовить виртуальную машину к развертыванию из Azure Marketplace.

## <a name="sizing-the-vhds"></a>Определение размера виртуальных жестких дисков

<!--TD: Check if the following assertion is true. I didn't understand the original content. -->
Если вы выбрали одну из виртуальных машин, предварительно настроенных с помощью операционной системы (и при необходимости дополнительных служб), вы уже выбрали Стандартный размер виртуальной машины Azure, как описано на [вкладке номера SKU виртуальных машин](./cpp-skus-tab.md).  Рекомендуемым подходом является запуск решения с предварительно настроенной ОС.  Но если вы устанавливаете операционную систему вручную, необходимо выбрать размер основного виртуального жесткого диска для образа виртуальной машины.

- Для Windows виртуальный жесткий диск для операционной системы должен иметь фиксированный формат и размер 127-128 ГБ. 
- Для Linux этот виртуальный жесткий диск должен иметь фиксированный формат и размер 30–50 ГБ.

Если физический размер меньше 127-128 ГБ, виртуальный жесткий диск должен быть разреженным. Предоставляемые базовые образы Windows и SQL Server уже соответствуют этим требованиям. Не меняйте формат и размер полученного виртуального жесткого диска. 

Размер дисков данных может достигать 1 ТБ. Выбирая размер их диска, помните, что конечные пользователи не смогут изменить размер виртуальных жестких дисков в образе во время развертывания. Виртуальные жесткие диски для данных следует создавать с фиксированным форматом. Тем не менее их также следует разбивать на части. Диски данных могут быть пустыми или сразу содержать данные.


## <a name="install-the-most-current-updates"></a>Установка самых свежих обновлений

Базовые образы виртуальных машин с операционной системой содержат все последние обновления вплоть до даты публикации образа. Перед публикацией созданного вручную виртуального жесткого диска обязательно применить все обновления безопасности и обслуживания для операционной системы и всех установленных служб.

В ОС Windows Server 2016 для этого следует запустить команду **Проверить наличие обновлений**.  Для более старых версий Windows изучите статью[о получении обновлений через Центр обновления Windows](https://support.microsoft.com/help/3067639/how-to-get-an-update-through-windows-update).  Центр обновлений Windows автоматически установит все свежие обновления критического уровня и важные для безопасности.

Для дистрибутивов Linux обновления обычно скачиваются и устанавливаются с помощью средства командной строки или графической программы.  Например, в Ubuntu Linux для обновления операционной системы есть команда [apt-get](https://manpages.ubuntu.com/manpages/cosmic/man8/apt-get.8.html) и средство [Менеджер обновления](https://manpages.ubuntu.com/manpages/cosmic/man8/update-manager.8.html).


## <a name="perform-additional-security-checks"></a>Выполнение дополнительных проверок безопасности

Вы обязаны обеспечить высокий уровень безопасности для образов решений, размещаемых в Azure Marketplace.  В следующей статье представлен контрольный список настройки безопасности и процедур проверки, которые помогут вам достичь этой цели: [Рекомендации по обеспечению безопасности для образов Azure Marketplace](https://docs.microsoft.com/azure/security/security-recommendations-azure-marketplace-images).  Некоторые из этих рекомендаций относятся только к образам на основе Linux, но большинство из них универсальны для любой виртуальной машины. 


## <a name="perform-custom-configuration-and-scheduled-tasks"></a>Выполнение пользовательской настройки и запланированные задачи

Если необходима дополнительная настройка, мы рекомендуем использовать запланированную задачу, которая сработает при запуске и внесет окончательные изменения в виртуальную машину сразу после ее развертывания.  Учтите также следующие рекомендации.
- Если это задача однократного запуска, она должна удалять себя после успешного завершения.
- Конфигурации не должны полагаться на другие диски, кроме C или D, так как наличие гарантируется только для этих двух дисков. Диск C служит для размещения операционной системы, а диск D является временным локальным диском.

Дополнительные сведения о настройке Linux см. в обзоре [расширений и компонентов виртуальной машины для Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/features-linux).


## <a name="generalize-the-image"></a>Обобщение образа

Все образы в Azure Marketplace должны быть доступны для повторного использования в первоначальном виде. Чтобы достичь этой возможности повторного использования, виртуальный жесткий диск для операционной системы необходимо *обобщить*. Эта операция удаляет с виртуальной машины все идентификаторы, относящиеся к определенному экземпляру, и программные драйверы.

### <a name="windows"></a>Windows

Диски операционной системы Windows обобщаются с помощью [средства sysprep](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview). Если вы позднее обновите операционную систему или измените ее конфигурацию, снова запустите sysprep. 

> [!WARNING]
>  Поскольку обновления могут применяться автоматически, после запуска sysprep следует отключить виртуальную машину и не включать до завершения развертывания.  Завершение работы не позволит неожиданным обновлениям внести на виртуальный жесткий диск или в установленные службы изменения, относящиеся к конкретному экземпляру.

Дополнительные сведения о запуске Sysprep см. [в разделе действия по подготовке виртуального жесткого диска к использованию](https://docs.microsoft.com/azure/virtual-machines/windows/capture-image-resource#generalize-the-windows-vm-using-sysprep) .

### <a name="linux"></a>Linux

Следующий двухэтапный процесс обобщает виртуальную машину Linux и повторно развертывает ее как отдельную виртуальную машину. Эти два действия являются лишь основными сведениями о процессе. Дополнительные сведения об этих двух действиях и способах их выполнения см. [в статье Создание образа виртуальной машины или виртуального жесткого диска](../../../virtual-machines/linux/capture-image.md). В целях создания виртуального жесткого диска для предложения Azure Marketplace можно приступать к работе с разделом "Создание виртуальной машины из образа записи".

#### <a name="remove-the-azure-linux-agent"></a>Удаление агента Linux для Azure
1.  Подключитесь к виртуальной машине Linux c помощью клиента SSH.
2.  В окне сеанса SSH введите следующую команду. <br/>
    `sudo waagent -deprovision+user`
3.  Введите `y`, чтобы продолжить (Чтобы предотвратить появление запроса на подтверждение, добавьте к предыдущей команде параметр `-force`.)
4.  После выполнения команды введите `exit`, чтобы закрыть SSH-клиент.

<!-- TD: I need to add meat and/or references to the following steps -->
#### <a name="capture-the-image"></a>Запись образа
1.  Перейдите на портал Azure, выберите нужную группу ресурсов и отмените распределение виртуальной машины.
2.  Это действие обобщает виртуальный жесткий диск, и теперь вы можете создать новую виртуальную машину на основе этого виртуального жесткого диска.


## <a name="create-one-or-more-copies"></a>Создание одной или нескольких копий

Создание копий виртуальной машины часто полезно для резервного копирования, тестирования, особых сценариев отработки отказа или балансировки нагрузки, а также для создания разных конфигураций решения и т. д. Сведения о том, как дублировать и скачать виртуальный жесткий диск, чтобы создать неуправляемый клон, представлены в следующих статьях.

- Для виртуальных машин Linux: [Скачивание виртуального жесткого диска Linux из Azure](../../../virtual-machines/linux/download-vhd.md).
- Для виртуальных машин Windows: [Скачивание виртуального жесткого диска Windows из Azure](../../../virtual-machines/windows/download-vhd.md).


## <a name="next-steps"></a>Дальнейшие шаги

После того как виртуальная машина будет подготовлена к работе, была освобождена и вы создали образ ВИРТУАЛЬНОЙ машины, вы можете [развернуть виртуальную машину с виртуального жесткого диска](./cpp-deploy-vm-vhd.md).
