---
title: Получите общую подпись доступа URI для вашего VM-изображения на основе Microsoft Azure Лазурный рынок
description: Сведения о получении универсального кода ресурса (URI) подписанного URL-адреса (SAS) для образа виртуальной машины.
author: dsindona
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: conceptual
ms.date: 10/19/2018
ms.author: dsindona
ms.openlocfilehash: 2fdbc2a11bd963057b465a629757f2be51ae4061
ms.sourcegitcommit: 530e2d56fc3b91c520d3714a7fe4e8e0b75480c8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81273857"
---
# <a name="get-shared-access-signature-uri-for-your-vm-image"></a>Получение универсального кода ресурса (URI) подписанного URL-адреса для образа виртуальной машины

> [!IMPORTANT]
> С 13 апреля 2020 года мы начнем перемещение управления вашими предложениями Azure Virtual Machine в Партнерский центр. После миграции вы будете создавать и управлять своими предложениями в Partner Center. Следуйте инструкциям в [Get shared access signature URI для вашего изображения VM](https://aka.ms/GetSASURI) для управления мигрированными предложениями.

При публикации вы предоставляете универсальный код ресурса (URI) для каждого виртуального жесткого диска, связанного с вашими номерами SKU. Майкрософт понадобится доступ к этим дискам во время сертификации. В этой статье объясняется, как создать URI подписанного URL-адреса (SAS) для каждого виртуального жесткого диска. Этот URI нужно ввести на вкладке с **номерами SKU** на Портале Cloud Partner.

Создавая URI SAS для виртуальных жестких дисков, придерживайтесь следующих требований:

- поддерживаются только неуправляемые виртуальные жесткие диски;
- достаточно разрешений `List` и `Read`; *не* предоставляйте доступ `Write` или `Delete`;
- длительность предоставления доступа (до *даты окончания срока действия*) должна составлять не менее трех недель с момента создания URI SAS;
- чтобы не зависеть от формата времени UTC, укажите дату начала на один день раньше текущей даты. Например, если сегодня 6 октября 2014 г., выберите 05.10.2014.

## <a name="generate-the-sas-url"></a>Создание URL-адреса SAS

URL-адрес SAS можно создать двумя способами с помощью следующих средств:

- Обозреватель службы хранилища Microsoft Azure — графическое средство для Windows, macOS и Linux;
- интерфейс командной строки Microsoft Azure — рекомендуется для ОС, отличных от Windows, а также для сред автоматической или непрерывной интеграции.

### <a name="azure-cli"></a>Azure CLI

Создайте URL-адрес SAS с помощью Azure CLI, выполнив следующие действия:

1. Скачайте и установите [Microsoft Azure CLI](https://azure.microsoft.com/documentation/articles/xplat-cli-install/). Доступны версии для macOS, Windows и различных дистрибутивов Linux.
2. Создайте файл PowerShell (с расширением `.ps1`), скопируйте в него следующий код и сохраните его в локальной файловой системе.

   ```azurecli-interactive
   az storage container generate-sas --connection-string 'DefaultEndpointsProtocol=https;AccountName=<account-name>;AccountKey=<account-key>;EndpointSuffix=core.windows.net' --name <vhd-name> --permissions rl --start '<start-date>' --expiry '<expiry-date>'
   ```

3. Измените текст файла, добавив следующие значения параметров.  Даты и время следует указывать в формате UTC, например: `2016-10-25T00:00:00Z`.
   - `<account-name>` — имя учетной записи хранения Azure.
   - `<account-key>` — ключ учетной записи хранения Azure.
   - `<vhd-name>` — имя виртуального жесткого диска.
   - `<start-date>` — дата начала срока действия разрешений на доступ к виртуальному жесткому диску. Укажите дату на день раньше текущей даты.
   - `<expiry-date>` — дата окончания срока действия разрешений на доступ к виртуальному жесткому диску.  Укажите дату по меньшей мере через три недели после текущей даты.

   Следующий пример демонстрирует правильное (на момент написания этой статьи) использование значений всех параметров.

   ```azurecli-interactive
   az storage container generate-sas --connection-string 'DefaultEndpointsProtocol=https;AccountName=st00009;AccountKey=6L7OWFrlabs7Jn23OaR3rvY5RykpLCNHJhxsbn9ONc+bkCq9z/VNUPNYZRKoEV1FXSrvhqq3aMIDI7N3bSSvPg==;EndpointSuffix=core.windows.net' --name vhds --permissions rl --start '2017-11-06T00:00:00Z' --expiry '2018-08-20T00:00:00Z'
   ```

4. Сохраните изменения, внесенные в скрипт PowerShell.
5. Запустите этот скрипт с правами администратора, чтобы создать *строку подключения SAS* для доступа на уровне контейнера.  Вы можете использовать два способа:
   - Запуск скрипта из консоли.  Например, в Windows щелкните скрипт правой кнопкой мыши и выберите **Запуск от имени администратора**.
   - Запуск скрипта с правами администратора из редактора скриптов PowerShell, например из [интегрированной среды сценариев Windows PowerShell](https://docs.microsoft.com/powershell/scripting/components/ise/introducing-the-windows-powershell-ise).
     Ниже показано создание строки подключения SAS в этом редакторе.

     ![Создание URI SAS в интегрированной среде сценариев PowerShell](./media/publishvm_032.png)

6. Скопируйте полученную строку подключения SAS и сохраните ее в текстовом файле в надежном расположении.  Чтобы завершить создание URI SAS, в эту строку нужно добавить сведения о расположении подключенного виртуального жесткого диска.
7. На портале Azure перейдите к хранилищу BLOB-объектов, которое содержит виртуальный жесткий диск, связанный с созданным URI.
8. Скопируйте значение URL-адреса **конечной точки службы BLOB-объектов**, как показано ниже.

    ![Конечная точка службы BLOB-объектов на портале Azure](./media/publishvm_033.png)

9. Измените текстовый файл, добавив строку подключения SAS, полученную на шаге 6.  Создайте полный URI SAS, используя следующий формат:

    `<blob-service-endpoint-url>` + `/vhds/` + `<vhd-name>?` + `<sas-connection-string>`

    Например, если виртуальный жесткий диск имеет имя `TestRGVM2.vhd`, URI SAS будет выглядеть так:

    `https://catech123.blob.core.windows.net/vhds/TestRGVM2.vhd?st=2018-05-06T07%3A00%3A00Z&se=2019-08-02T07%3A00%3A00Z&sp=rl&sv=2017-04-17&sr=c&sig=wnEw9RfVKeSmVgqDfsDvC9IHhis4x0fc9Hu%2FW4yvBxk%3D`

Повторите эти шаги для каждого виртуального жесткого диска в публикуемом номере SKU.

### <a name="microsoft-storage-explorer"></a>Обозреватель хранилищ Microsoft Azure

Ниже описано, как создать URI SAS с помощью Обозревателя службы хранилища Microsoft Azure.

1. Скачайте и установите [обозреватель хранилищ Microsoft Azure](https://azure.microsoft.com/features/storage-explorer/).
2. Откройте Обозреватель и щелкните значок **Добавление учетной записи** в строке меню слева.  Откроется диалоговое окно **Подключение к службе хранилища Azure**.
3. Выберите **Add an Azure Account** (Добавить учетную запись Azure) и нажмите кнопку **Войти**.  Войдите в учетную запись Azure.
4. На панели **Explorer** слева перейдите к узлу **Учетные записи хранения** и разверните его.
5. Щелкните правой кнопкой мыши виртуальный жесткий диск и выберите в контекстном меню **Получить подписанный URL-адрес**.

    ![Получение элемента SAS в Azure Explorer](./media/publishvm_034.png)

6. Откроется диалоговое окно **Подписанный URL-адрес**. Введите значения для следующих полей:
   - **Время начала** — дата начала срока действия разрешений на доступ к виртуальному жесткому диску. Укажите дату на день раньше текущей даты.
   - **Время окончания срока действия** — дата окончания срока действия разрешений на доступ к виртуальному жесткому диску.  Укажите дату по меньшей мере через три недели после текущей даты.
   - **Разрешения** — выберите разрешения `Read` и `List`.

     ![Диалоговое окно SAS в обозревателе Azure](./media/publishvm_035.png)

7. Щелкните **Создать**, чтобы создать URI SAS для этого виртуального жесткого диска.  В диалоговом окне появятся сведения об этой операции.
8. Скопируйте значение **URL-адрес** и сохраните его в текстовом файле в надежном расположении.

    ![Создание URI SAS в Azure Explorer](./media/publishvm_036.png)

    Этот URL-адрес SAS предоставляет доступ на уровне контейнера.  Чтобы сделать доступ избирательным, к адресу нужно добавить имя соответствующего виртуального жесткого диска.

9. Измените текстовый файл. Вставьте имя виртуального жесткого диска в URL-адрес SAS после строки `vhds` (добавьте символ косой черты).  Окончательный вид URI SAS будет таким:

    `<blob-service-endpoint-url>` + `/vhds/` + `<vhd-name>?` + `<sas-connection-string>`

    Например, если виртуальный жесткий диск имеет имя `TestRGVM2.vhd`, URI SAS будет выглядеть так:

    `https://catech123.blob.core.windows.net/vhds/TestRGVM2.vhd?st=2018-05-06T07%3A00%3A00Z&se=2019-08-02T07%3A00%3A00Z&sp=rl&sv=2017-04-17&sr=c&sig=wnEw9RfVKeSmVgqDfsDvC9IHhis4x0fc9Hu%2FW4yvBxk%3D`

Повторите эти шаги для каждого виртуального жесткого диска в публикуемом номере SKU.

## <a name="verify-the-sas-uri"></a>Проверка URI SAS

Проверьте каждый созданный URI SAS, используя следующий контрольный список.  Проверьте следующее:

- URI имеет форму: `<blob-service-endpoint-url>` + `/vhds/` + `<vhd-name>?` +`<sas-connection-string>`
- URI содержит имя файла образа виртуального жесткого диска, включая расширение .vhd.
- Примерно в середине URI отображается строка `sp=rl`. Она обозначает разрешения на доступ `Read` и `List`.
- После этого фрагмента отображается `sr=c`. Эта строка обозначает разрешения на уровне контейнера.
- Скопируйте созданный URI и вставьте его в браузер, чтобы начать скачивание связанного большого двоичного объекта.  (Эту операцию можно отменить до завершения скачивания.)

## <a name="next-steps"></a>Дальнейшие действия

Если у вас возникли трудности при создании URI SAS, см. [описание распространенных проблем с URL-адресом SAS](./cpp-common-sas-url-issues.md).  В противном случае сохраните URI SAS в надежном расположении для последующего использования. Он потребуется для [публикации предложения виртуальной машины](./cpp-publish-offer.md) на Портале Cloud Partner.
