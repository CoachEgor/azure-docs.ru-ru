---
title: URI подписанного URL-адреса для образов виртуальных машин — Azure Marketplace
description: Создание универсального кода ресурса (URI) подписанного URL-адреса (SAS) для виртуальных жестких дисков (VHD) в Azure Marketplace.
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: article
author: iqshahmicrosoft
ms.author: iqshah
ms.date: 07/14/2020
ms.openlocfilehash: f3589fb9ae176e04f727f516cca7c18c87dad9e0
ms.sourcegitcommit: a76ff927bd57d2fcc122fa36f7cb21eb22154cfa
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/28/2020
ms.locfileid: "87317507"
---
# <a name="get-shared-access-signature-uri-for-your-vm-image"></a>Получение универсального кода ресурса (URI) подписанного URL-адреса для образа виртуальной машины

В этой статье описывается, как создать универсальный код ресурса (URI) для подписи общего доступа (SAS) для каждого виртуального жесткого диска.

Во время процесса публикации необходимо предоставить универсальный код ресурса (URI) для каждого виртуального жесткого диска, связанного с планами (ранее именуемыми SKU). Майкрософт понадобится доступ к этим дискам во время сертификации. Этот URI вводится на вкладке **Планы** в Центре партнеров.

Создавая URI SAS для виртуальных жестких дисков, соблюдайте следующие требования:

* поддерживаются только неуправляемые виртуальные жесткие диски;
* требуются только разрешения `List` и `Read`; не предоставляйте разрешения на запись или удаление;
* длительность предоставления доступа (до даты окончания срока действия) должна составлять не менее трех недель с момента создания URI SAS;
* чтобы не зависеть от формата времени UTC, укажите дату начала на один день раньше текущей даты; например, если сегодня 6 октября 2019 г., выберите 05.10.2019.

## <a name="generate-the-sas-address"></a>Создание адреса SAS

Существует два стандартных средства, которые используются для создания адреса SAS (URL-адреса):

* **обозреватель службы хранилища Microsoft Azure** — графическое средство для Windows, macOS и Linux;
* **интерфейс командной строки Microsoft Azure** — рекомендуется для ОС, отличных от Windows, а также для сред автоматической или непрерывной интеграции.

### <a name="use-microsoft-storage-explorer"></a>Использование обозревателя службы хранилища Microsoft Azure

1. Скачайте и установите [обозреватель хранилищ Microsoft Azure](https://azure.microsoft.com/features/storage-explorer/).
2. Откройте обозреватель и в меню слева выберите **Добавить учетную запись**. Откроется диалоговое окно **Подключение к службе хранилища Azure**.
3. Выберите **Добавить учетную запись Azure**, а затем нажмите кнопку **Войти**. Войдите в учетную запись Azure.
4. На панели **Explorer** слева перейдите к узлу **Учетные записи хранения** и разверните его.
5. Щелкните правой кнопкой мыши VHD и выберите **Получить подписанный URL-адрес**.
6. Откроется диалоговое окно **Подписанный URL-адрес**. Заполните следующие поля.

    * **Время начала** — дата начала срока действия разрешений на доступ к виртуальному жесткому диску. Укажите дату на день раньше текущей даты.
    * **Время окончания срока действия** — дата окончания срока действия разрешений на доступ к виртуальному жесткому диску. Укажите дату по меньшей мере через три недели после текущей даты.
    * **Разрешения**. Выберите разрешения на создание списков и чтение.
    * **Уровень контейнера**. Установите флажок **Создать URI подписанного URL-адреса на уровне контейнера**.

        :::image type="content" source="media/create-sas-uri-storage-explorer.png" alt-text="Диалоговое окно Подписанный URL-адрес":::

7. Нажмите **Создать**, чтобы создать URI SAS для этого виртуального жесткого диска. Диалоговое окно обновится, и в нем отобразятся сведения об этой операции.
8. Скопируйте **URI** и сохраните его в текстовом файле в надежном расположении.

    :::image type="content" source="media/create-sas-uri-shared-access-signature-details.png" alt-text="Диалоговое Подписанный URL-адрес с подробными сведениями":::

    Этот URI SAS предоставляет доступ на уровне контейнера. Чтобы сделать его определенным, измените текстовый файл, добавив в него имя виртуального жесткого диска (следующий шаг).

9. Вставьте имя виртуального жесткого диска в URI SAS после строки vhds (добавьте символ косой черты). В окончательном виде URI SAS должен выглядеть следующим образом:

    `<blob-service-endpoint-url> + /vhds/ + <vhd-name>? + <sas-connection-string>` Например, если виртуальный жесткий диск имеет имя `TestRGVM2.vhd`, URI SAS будет выглядеть так:

    `https://catech123.blob.core.windows.net/vhds/TestRGVM2.vhd?st=2018-05-06T07%3A00%3A00Z&se=2019-08-02T07%3A00%3A00Z&sp=rl&sv=2017-04-17&sr=c&sig=wnEw9RfVKeSmVgqDfsDvC9IHhis4x0fc9Hu%2FW4yvBxk%3D`

10. Повторите эти шаги для каждого виртуального жесткого диска в публикуемом плане.

### <a name="using-azure-cli"></a>Использование Azure CLI

1. Скачайте и установите [Microsoft Azure CLI](https://azure.microsoft.com/documentation/articles/xplat-cli-install/). Доступны версии для macOS, Windows и различных дистрибутивов Linux.
2. Создайте файл PowerShell (с расширением PS1), скопируйте в него следующий код и сохраните его в локальной файловой системе.

    ```PowerShell
    az storage container generate-sas --connection-string 'DefaultEndpointsProtocol=https;AccountName=<account-name>;AccountKey=<account-key>;EndpointSuffix=core.windows.net' --name <vhd-name> --permissions rl --start '<start-date>' --expiry '<expiry-date>'
    ```

3. Измените текст файла, добавив следующие значения параметров. Укажите даты в формате UTC, например `2020-04-01T00:00:00Z`.

    * `<account-name>` — имя учетной записи хранения Azure.
    * `<account-key>` — ключ учетной записи хранения Azure.
    * `<vhd-name>` — имя виртуального жесткого диска.
    * `<start-date>` — дата начала срока действия разрешений на доступ к виртуальному жесткому диску. Укажите дату на день раньше текущей даты.
    * `<expiry-date>` — дата окончания срока действия разрешений на доступ к виртуальному жесткому диску. Укажите дату по меньшей мере через три недели после текущей даты.

    Следующий пример демонстрирует правильное (на момент написания этой статьи) использование значений всех параметров.

    ```PowerShell
    az storage container generate-sas --connection-string 'DefaultEndpointsProtocol=https;AccountName=st00009;AccountKey=6L7OWFrlabs7Jn23OaR3rvY5RykpLCNHJhxsbn9ONc+bkCq9z/VNUPNYZRKoEV1FXSrvhqq3aMIDI7N3bSSvPg==;EndpointSuffix=core.windows.net' --name vhds --permissions rl --start '2020-04-01T00:00:00Z' --expiry '2021-04-01T00:00:00Z'
    ```

4. Сохраните изменения.
5. Запустите этот скрипт с правами администратора одним из следующих способов, чтобы создать **строку подключения SAS** для доступа на уровне контейнера.

    * Запуск скрипта из консоли. В Windows щелкните скрипт правой кнопкой мыши и выберите пункт **Запустить от имени администратора**.
    * Запуск скрипта из редактора скриптов PowerShell, например из [интегрированной среды сценариев Windows PowerShell](https://docs.microsoft.com/powershell/scripting/components/ise/introducing-the-windows-powershell-ise). На этом экране показано создание строки подключения SAS в этом редакторе:

     :::image type="content" source="media/create-sas-uri-power-shell-ise.png" alt-text="Создание строки подключения SAS с помощью интегрированной среды сценариев Windows PowerShell":::

6. Скопируйте строку подключения SAS и сохраните ее в текстовом файле в надежном расположении. Чтобы завершить создание URI SAS, в эту строку нужно добавить сведения о расположении виртуального жесткого диска.
7. На портале Azure перейдите к хранилищу BLOB-объектов, которое содержит виртуальный жесткий диск, связанный с новым URI.
8. Скопируйте URL-адрес **конечной точки службы BLOB-объектов**, как показано на снимке экрана ниже.

    :::image type="content" source="media/create-sas-uri-blob-endpoint.png" alt-text="Конечная точка службы BLOB-объектов":::

9. Измените текстовый файл, добавив строку подключения SAS, полученную на шаге 6. Создайте полный URI SAS в следующем формате:

    `<blob-service-endpoint-url> + /vhds/ + <vhd-name>? + <sas-connection-string>`

    Например, если имя виртуального жесткого диска `TestRGVM2.vhd`, URI SAS будет следующим:

    `https://catech123.blob.core.windows.net/vhds/TestRGVM2.vhd?st=2018-05-06T07%3A00%3A00Z&se=2019-08-02T07%3A00%3A00Z&sp=rl&sv=2017-04-17&sr=c&sig=wnEw9RfVKeSmVgqDfsDvC9IHhis4x0fc9Hu%2FW4yvBxk%3D`

Повторите эти шаги для каждого виртуального жесткого диска в публикуемом плане.

## <a name="verify-the-sas-uri"></a>Проверка URI SAS

Проверьте каждый созданный URI SAS, используя следующий контрольный список.

* URI выглядит следующим образом: `<blob-service-endpoint-url>` + `/vhds/` + `<vhd-name>?` + `<sas-connection-string>`
* URI содержит имя файла образа виртуального жесткого диска, включая расширение VHD.
* `sp=rl` отображается около середины URI. Она обозначает разрешения на доступ `Read` и `List`.
* Если отображается `sr=c`, эта строка обозначает разрешения на уровне контейнера.
* Скопируйте и вставьте URI в браузер, чтобы проверить скачивание большого двоичного объекта (операцию можно отменить до завершения скачивания).

## <a name="next-step"></a>Следующий шаг

Если у вас возникли трудности при создании URI SAS, обратитесь к статье [Распространенные проблемы с URL-адресом SAS](common-sas-uri-issues.md). В противном случае сохраните URI SAS в надежном расположении для последующего использования. Он потребуется вам для публикации предложения виртуальной машины в Центре партнеров.

* [Создание предложения виртуальной машины Azure](azure-vm-create-offer.md)
