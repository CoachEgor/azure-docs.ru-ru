---
title: Получение URI SAS для образа виртуальной машины в Azure Marketplace
description: Создание универсального кода ресурса (URI) подписанного URL-адреса (SAS) для виртуальных жестких дисков (VHD) в Azure Marketplace.
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: article
author: iqshahmicrosoft
ms.author: iqshah
ms.date: 08/14/2020
ms.openlocfilehash: a84f287c6303e093d68dd462ccc5cecc34b463cd
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "89144540"
---
# <a name="get-a-sas-uri-for-your-vm-image"></a>Получение URI SAS для образа виртуальной машины

Во время процесса публикации необходимо предоставить URI SAS (подписанный URL-адрес) для каждого виртуального жесткого диска, связанного с планами (ранее именуемыми SKU). Майкрософт понадобится доступ к этим дискам во время сертификации. Этот универсальный код ресурса (URI) вводится на вкладке **планы** в центре партнеров.

Создание URI SAS для виртуальных жестких дисков имеет следующие требования:

- Они поддерживают только неуправляемые виртуальные жесткие диски.
- Требуются только разрешения List и Read. Не предоставлять доступ на запись или удаление.
- длительность предоставления доступа (до даты окончания срока действия) должна составлять не менее трех недель с момента создания URI SAS;
- чтобы не зависеть от формата времени UTC, укажите дату начала на один день раньше текущей даты; Например, если текущая дата — 16 июня 2020, то выберите 6/15/2020.

## <a name="generate-the-sas-address"></a>Создание адреса SAS

Существует два стандартных средства, которые используются для создания адреса SAS (URL-адреса):

1. **обозреватель службы хранилища Microsoft Azure** — графическое средство для Windows, macOS и Linux;
2. **интерфейс командной строки Microsoft Azure** — рекомендуется для ОС, отличных от Windows, а также для сред автоматической или непрерывной интеграции.

### <a name="using-tool-1-microsoft-storage-explorer"></a>Использование средства 1: Microsoft Обозреватель службы хранилища

1. Скачайте и установите [обозреватель хранилищ Microsoft Azure](https://azure.microsoft.com/features/storage-explorer/).
2. Откройте обозреватель и в меню слева выберите **Добавить учетную запись**.
3. В диалоговом окне **Подключение к службе хранилища Azure** выберите **Добавить учетную запись Azure** и войдите в учетную запись Azure.
4. В левой области обозревателя разверните узел **учетные записи хранения** .
5. Щелкните правой кнопкой мыши виртуальный жесткий диск и выберите **получить подпись общего доступа**.
6. В диалоговом окне **подпись общего доступа** заполните следующие поля:

    1. Время начала — дата начала срока действия разрешений на доступ к виртуальному жесткому диску. Укажите дату на день раньше текущей даты.
    2. Время окончания срока действия — дата окончания срока действия разрешений на доступ к виртуальному жесткому диску. Укажите дату по меньшей мере через три недели после текущей даты.
    3. Разрешения. Выберите разрешения на создание списков и чтение.
    4. Уровень контейнера. Установите флажок Создать URI подписанного URL-адреса на уровне контейнера.

    ![Диалоговое окно подпись общего доступа.](media/vm/create-sas-uri-storage-explorer.png)

7. Нажмите **Создать**, чтобы создать URI SAS для этого виртуального жесткого диска. Диалоговое окно обновится, и в нем отобразятся сведения об этой операции.

8. Скопируйте URI и сохраните его в текстовом файле в надежном расположении.

    ![Копирование URI.](media/vm/create-sas-uri-shared-access-signature-details.png)

    Этот URI SAS предоставляет доступ на уровне контейнера. Чтобы сделать его специфическим, измените текстовый файл, добавив имя виртуального жесткого диска.

9. Вставьте имя виртуального жесткого диска в URI SAS после строки vhds (добавьте символ косой черты). В окончательном виде URI SAS должен выглядеть следующим образом:

    `<blob-service-endpoint-url> + /vhds/ + <vhd-name>? + <sas-connection-string>`

1. Повторите эти шаги для каждого виртуального жесткого диска в публикуемом плане.

### <a name="using-tool-2-azure-cli"></a>Использование средства 2: Azure CLI

1. Скачайте и установите [Microsoft Azure CL](https://azure.microsoft.com/documentation/articles/xplat-cli-install/)I. Доступны версии для macOS, Windows и различных дистрибутивов Linux.
2. Создайте файл PowerShell (с расширением PS1), скопируйте в него следующий код и сохраните его в локальной файловой системе.

    ```JSON
    az storage container generate-sas --connection-string ‘DefaultEndpointsProtocol=https;AccountName=<account-name>;AccountKey=<account-key>;EndpointSuffix=core.windows.net’ --name <vhd-name> --permissions rl --start ‘<start-date>’ --expiry ‘<expiry-date>’
    ```

3. Измените текст файла, добавив следующие значения параметров. Укажите даты в формате UTC DateTime, например 2020-04-01T00:00:00Z.

    - Account-Name — имя учетной записи хранения Azure.
    - ключ учетной записи — ключ учетной записи хранения Azure.
    - VHD-Name — имя виртуального жесткого диска.
    - Начальная дата — дата начала разрешения для доступа к виртуальному жесткому диску. Укажите дату на день раньше текущей даты.
    - Дата окончания срока действия — срок действия разрешения для доступа к виртуальному жесткому диску. Укажите дату по меньшей мере через три недели после текущей даты.

    Ниже приведен пример правильных значений параметров (на момент написания статьи):

    `az storage container generate-sas --connection-string ‘DefaultEndpointsProtocol=https;AccountName=st00009;AccountKey=6L7OWFrlabs7Jn23OaR3rvY5RykpLCNHJhxsbn9ON c+bkCq9z/VNUPNYZRKoEV1FXSrvhqq3aMIDI7N3bSSvPg==;EndpointSuffix=core.windows.net’ --name vhds -- permissions rl --start ‘2020-04-01T00:00:00Z’ --expiry ‘2021-04-01T00:00:00Z’`

1. Сохраните изменения.
2. Запустите этот скрипт с правами администратора одним из следующих способов, чтобы создать строку подключения SAS для доступа на уровне контейнера.

    - Запуск скрипта из консоли. В Windows щелкните скрипт правой кнопкой мыши и выберите пункт **Запустить от имени администратора**.
    - Запуск скрипта из редактора скриптов PowerShell, например из [интегрированной среды сценариев Windows PowerShell](https://docs.microsoft.com/powershell/scripting/components/ise/introducing-the-windows-powershell-ise). На этом экране показано создание строки подключения SAS в этом редакторе:

    [![Создание строки подключения SAS в редакторе PowerShell](media/vm/create-sas-uri-power-shell-ise.png)](media/vm/create-sas-uri-power-shell-ise.png#lightbox)

6. Скопируйте строку подключения SAS и сохраните ее в текстовом файле в надежном расположении. Чтобы завершить создание URI SAS, в эту строку нужно добавить сведения о расположении виртуального жесткого диска.
7. На портале Azure перейдите к хранилищу BLOB-объектов, которое содержит виртуальный жесткий диск, связанный с новым URI.
8. Скопируйте URL-адрес конечной точки службы Себблоб:

    ![Копирование URL-адреса конечной точки службы больших двоичных объектов.](media/vm/create-sas-uri-blob-endpoint.png)

9. Измените текстовый файл, добавив строку подключения SAS, полученную на шаге 6. Создайте полный URI SAS в следующем формате:

    `<blob-service-endpoint-url> + /vhds/ + <vhd-name>? + <sas-connection-string>`

## <a name="verify-the-sas-uri"></a>Проверка URI SAS

Проверьте URI SAS перед публикацией в центре партнеров, чтобы избежать проблем, связанных с URI SAS после отправки запроса. Этот процесс является необязательным, но рекомендуется.

- URI включает имя файла образа VHD, включая расширение имени файла `.vhd` .
- `Sp=rl` отображается около середины URI. В этой строке указывается доступ на чтение и список.
- Если отображается `sr=c`, эта строка обозначает разрешения на уровне контейнера.
- Скопируйте и вставьте URI в браузер, чтобы проверить скачивание большого двоичного объекта (операцию можно отменить до завершения скачивания).

## <a name="next-step"></a>Следующий шаг

- Прочитайте статью [Создание предложения виртуальной машины Azure](azure-vm-create-offer.md).
