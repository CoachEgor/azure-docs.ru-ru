---
title: Сертификация виртуальных машин — проблемы и решения
description: В этой статье описаны распространенные сообщения об ошибках для образов виртуальных машин. Здесь также обсуждаются связанные решения.
author: v-miegge
ms.author: v-krmall
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: troubleshooting
ms.date: 06/16/2020
ms.openlocfilehash: 7bd3f1a5b242ee5196e92456cb3fc8c97f8f5b27
ms.sourcegitcommit: 845a55e6c391c79d2c1585ac1625ea7dc953ea89
ms.contentlocale: ru-RU
ms.lasthandoff: 07/05/2020
ms.locfileid: "85958537"
---
# <a name="virtual-machine-certification---issues-and-solutions"></a>Сертификация виртуальных машин — проблемы и решения

При публикации образов виртуальных машин в Azure Marketplace команда Azure проверяет образ ВИРТУАЛЬНОЙ машины, чтобы обеспечить его загрузку, безопасность и совместимость с Azure. Если какое-либо из высококачественных тестов завершится сбоем, публикация завершится ошибкой с сообщением, содержащим ошибку.

В этой статье описаны распространенные сообщения об ошибках для образов виртуальных машин. Здесь также обсуждаются связанные решения.

> [!NOTE]
> Если у вас есть вопросы или отзывы для улучшения, обратитесь в [службу поддержки центра партнеров](https://partner.microsoft.com/support/v2/?stage=1).

## <a name="approved-base-image"></a>Утвержденный базовый образ

При отправке запроса на повторную публикацию образа с обновлениями тестовый случай проверки числа частей может завершиться ошибкой. В этом случае ваш образ не будет утвержден.

Эта ошибка произойдет при использовании базового образа, принадлежащего другому издателю, и обновления образа. В этом случае вам запрещено публиковать образ.

Чтобы устранить эту проблему, получите последнюю версию образа из Azure Marketplace и внесите изменения в этот образ. См. следующие сведения, чтобы просмотреть утвержденные базовые образы, в которых можно найти изображение:

- [Образы Linux](../../virtual-machines/linux/endorsed-distros.md?toc=/azure/virtual-machines/linux/toc.json)
- [Образы Windows](create-azure-vm-technical-asset.md#create-a-vm-image-using-an-approved-base))

## <a name="vm-extension-failure"></a>Сбой расширения виртуальной машины

Чтобы проверить, поддерживает ли ваше изображение расширение VM, выполните следующие действия.

Включить расширения виртуальной машины:

1. Выберите виртуальную машину Linux.
2. Перейдите в раздел **параметры диагностики**.
3. Включите базовые матрицы, обновив **учетную запись хранения**.
4. Нажмите кнопку **Сохранить**.

   ![Включение мониторинга на гостевом уровне](./media/vm-certification-issues-solutions-1.png)

Проверьте, правильно ли активированы расширения виртуальной машины:

5. Перейдите на вкладку " **расширения ВМ** " виртуальной машины и проверьте **расширение системы диагностики Linux**.
6. Если состояние — **Подготовка выполнена успешно** , тестовый случай был пройден.
7. Если состояние — **Ошибка подготовки** , тестовый случай не был пройден, и необходимо установить флаг зафиксированного состояния.

   ![Подготовка завершена](./media/vm-certification-issues-solutions-2.png)

   Если расширение виртуальной машины завершается сбоем, перейдите к разделу [Использование диагностического расширения Linux для мониторинга метрик и журналов](../../virtual-machines/extensions/diagnostics-linux.md) , чтобы включить его. Если вы не хотите, чтобы расширение виртуальной машины было включено, обратитесь в службу поддержки и попросите его отключить расширение.

## <a name="virtual-machine-provisioning-issue"></a>Ошибка подготовки виртуальной машины

Перед отправкой предложения убедитесь в том, что процесс подготовки тщательно исследуется для виртуальной машины. Чтобы просмотреть формат JSON для подготовки ВИРТУАЛЬНОЙ машины, перейдите к [сертификации образа виртуальной машины Azure](azure-vm-image-certification.md).

Проблемы подготовки могут включать в себя следующие сценарии сбоя:

|S.NO|Ошибка|reason|Решение|
|---|---|---|---|
|1|Недопустимый виртуальный жесткий диск (VHD)|Если указанное значение файла cookie в нижнем колонтитуле VHD не является правильным, то VHD будет считаться недопустимым.|Повторно создайте образ и отправьте запрос.|
|2|Недопустимый тип BLOB-объекта|Не удалось подготовить виртуальную машину, так как используемый блок является типом большого двоичного объекта, а не типом страницы.|Повторно создайте образ и отправьте запрос.|
|3|Время ожидания подготовки или неправильное обобщенное|Возникла ошибка при обходе обобщения виртуальной машины.|Повторно создайте образ с обобщением и отправьте запрос.|

> [!NOTE]
> Перейдите по следующим ссылкам, чтобы получить документацию, связанную с обобщением виртуальных машин:
> - [Linux](create-azure-vm-technical-asset.md#generalize-the-image))
> - [Windows](../../virtual-machines/windows/capture-image-resource.md#generalize-the-windows-vm-using-sysprep))

## <a name="software-compliance-for-windows"></a>Соответствие программного обеспечения требованиям для Windows

Если ваш запрос на использование образа Windows отклонен из-за соответствия программному обеспечению, то вы могли создать образ Windows с установленным SQL Server вместо получения соответствующего базового образа версии SQL из Azure Marketplace.

Не создавайте собственный образ Windows с установленным SQL Server. Вместо этого используйте утвержденные базовые образы SQL (Enterprise/Standard/Web) из Azure Marketplace.

Если вы пытаетесь установить Visual Studio или любой лицензированный продукт Office, обратитесь в службу поддержки для получения предварительного утверждения.

Дополнительные сведения см. в [подсистеме "создание технических ресурсов виртуальной машины Azure](create-azure-vm-technical-asset.md#create-a-vm-image-using-an-approved-base)" для выбора утвержденной базы.

## <a name="tool-kit-test-case-execution-failed"></a>Сбой при выполнении тестового случая для набора инструментов

Набор средств сертификации Майкрософт поможет вам выполнить тестовые случаи, чтобы убедиться, что VHD/образ совместим с средой Azure.

Загрузите [Microsoft Certification Toolkit](azure-vm-image-certification.md).

## <a name="linux-test-cases"></a>Тестовые случаи Linux

Ниже приведены тестовые случаи Linux, которые будет выполнять набор средств. Проверка теста указывается в описании.

|Серийный номер|тестовые случаи|description|
|---|---|---|
|1|Журнал bash|Перед созданием образа виртуальной машины необходимо очистить файлы журнала bash.|
|2|Версия агента Linux|Необходимо установить агент Linux для Azure 2.2.41 и более поздней версии.|
|3|Обязательные параметры ядра|Проверяет, установлены ли следующие параметры ядра: <br>Console = ttyS0<br>еарлипринтк = ttyS0<br>рутделай = 300|
|4|Переключение раздела на диск ОС|Проверяет, что разделы подкачки не создаются на диске операционной системы.|
|5|Корневой раздел на диске ОС|Создайте один корневой раздел для диска ОС.|
|6|Версия OpenSSL|Версия OpenSSL должна быть больше или равна v 0.9.8.|
|7|Версия Python|Настоятельно рекомендуется использовать Python версии 2.6 +.|
|8|Интервал активности клиента|Задайте для ClientAliveInterval значение 180. Для приложения его можно установить в диапазоне от 30 до 235. Если вы включаете SSH для конечных пользователей, это значение должно быть задано в соответствии с описанием.|
|9|Архитектура ОС|Поддерживаются только 64-разрядные операционные системы.|
|10|Автоматическое обновление|Указывает, включено ли автоматическое обновление агента Linux.|

### <a name="common-errors-found-while-executing-the-previous-test-cases"></a>Распространенные ошибки, обнаруженные при выполнении предыдущих тестовых случаев

При выполнении предыдущих тестовых случаев обнаружены распространенные ошибки.
 
|S.NO|тестовый случай|Ошибка|Решение|
|---|---|---|---|
|1|Тестовый случай версии агента Linux|Минимальная версия агента Linux — 2,241 или более поздняя. Это требование было обязательным с 1 мая 2020 г.|Для [отправки запроса](https://support.microsoft.com/help/4049215/extensions-and-virtual-machine-agent-minimum-version-support)образ должен быть обновлен до требуемой версии.|
|2|Тестовый случай истории bash|Если размер журнала Bash в отправленном изображении превышает 1 КБ, появится сообщение об ошибке. Размер ограничен 1 КБ, чтобы все потенциально конфиденциальные сведения не захватываются в файле журнала bash.|Чтобы устранить эту проблему, подключите виртуальный жесткий диск к любой другой рабочей виртуальной машине и внесите изменения (например, удалите `.bash` файлы журнала), размер которых должен быть меньше или равен 1 КБ.|
|3|Обязательный параметр ядра тестовый случай|Эта ошибка возникает, когда для параметра **Console** не задано значение **ttyS0**. Проверьте, выполнив команду:<br>`cat /proc/cmdline`|Задайте для параметра **Console** значение **ttyS0** и повторно отправьте запрос.|
|4|Тестовый случай интервала Клиенталиве|Если в результате набора средств вы получите неудачный результат для этого тестового случая, для **ClientAliveInterval**будет указано неверное значение.|Задайте для параметра **ClientAliveInterval** значение меньше или равное 235, а затем повторно отправьте запрос.|

### <a name="windows-test-cases"></a>Тестовые случаи для Windows

Ниже приведены тестовые случаи Windows, которые будет выполнять набор средств. Проверка теста указывается в описании.

|Серийный номер|тестовые случаи|description|
|---|---|---|---|
|1|Архитектура ОС|Azure поддерживает только 64 разрядных операционных систем.|
|2|Зависимость учетной записи пользователя|Выполнение приложения не должно быть зависимым от учетной записи администратора.|
|3|Отказоустойчивый кластер|Компонент отказоустойчивой кластеризации Windows Server пока не поддерживается. приложение не должно зависеть от этой функции.|
|4|IPV6|Протокол IPv6 пока не поддерживается в среде Azure. Приложение не должно зависеть от этой функции.|
|5|DHCP|Роль сервера протокола динамической настройки узла пока не поддерживается. Приложение не должно зависеть от этой функции.|
|6|Hyper-V|Роль сервера Hyper-V пока не поддерживается. Приложение не должно зависеть от этой функции.|
|7|Удаленный доступ|Роль сервера "удаленный доступ (прямой доступ)" пока не поддерживается. Приложение не должно зависеть от этой функции.|
|8|службы Rights Management Services|Службы Rights Management. Роль сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|9|Windows Deployment Services|Службы развертывания Windows. Роль сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|10|Шифрование диска BitLocker|Шифрование диска BitLocker не поддерживается на жестком диске операционной системы, но может использоваться на дисках данных.|
|11|Сервер имен интернет-хранилища|Компонент сервера службы "имя хранилища Интернета" пока не поддерживается. Приложение не должно зависеть от этой функции.|
|12|Multipath I/O;|Multipath I/O. Эта функция сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|13|Network Load Balancing|Балансировка сетевой нагрузки. Эта функция сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|14|Протокол PNRP|Протокол разрешения имен одноранговых узлов. Эта функция сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|15|Службы SNMP|Компонент служб SNMP пока не поддерживается. Приложение не должно зависеть от этой функции.|
|16|Служба WINS|Служба Windows Internet Name Service. Эта функция сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|17|Служба беспроводной локальной сети|Служба беспроводной локальной сети. Эта функция сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|

Если вы пойдете за любые сбои в описанных выше тестовых случаях, ознакомьтесь со столбцом **Description** в предыдущей таблице для решения. Если вам нужны дополнительные сведения, обратитесь в службу поддержки. 

## <a name="data-disk-size-verification"></a>Проверка размера диска данных

Если размер любого запроса, отправленного с диска данных, превышает 1023 ГБ, этот запрос не будет утвержден. Это правило применяется к Windows & Linux.

повторно отправьте запрос, размер которого меньше или равен 1023 ГБ.

## <a name="os-disk-size-validation"></a>Проверка размера диска ОС

Сведения об ограничениях размера диска ОС см. в следующих правилах. При отправке любого запроса убедитесь, что размер диска ОС находится в пределах ограничений для Linux или Windows.

|Операционная система|Рекомендуемый размер VHD|
|---|---|
|Linux|от 30 ГБ до 1023 ГБ|
|Windows|от 30 ГБ до 250 ГБ|

Так как виртуальные машины разрешают доступ к базовой операционной системе, убедитесь, что размер виртуального жесткого диска достаточно велик для виртуального жесткого диска. Так как диски не расширяются без простоя, используйте размер диска от 30 до 50 ГБ.

|Размер виртуального жесткого диска|фактический объем занятого объема|Решение|
|---|---|---|
|>500 тиб|н/д|обратитесь в службу поддержки за исключением утверждения.|
|250-500 тиб|>200 гиб отличается от размера большого двоичного объекта|обратитесь в службу поддержки за исключением утверждения.|

> [!NOTE]
> Увеличение размера диска приводит к более высокой стоимости и приведет к задержке во время подготовки и репликации. Из-за этой задержки и стоимости Группа поддержки может найти обоснование для утверждения исключения.

## <a name="wannacry-patch-verification-test-for-windows"></a>Проверка исправления WannaCry для Windows

Чтобы предотвратить потенциальную атаку, связанную с WannaCry вирусом, убедитесь, что все запросы образа Windows обновлены с использованием последнего исправления.

Чтобы проверить исправленную версию Windows Server, ознакомьтесь со следующей таблицей сведений о ОС и минимальной поддерживаемой версией. 

Версию файла изображения можно проверить с `C:\windows\system32\drivers\srv.sys` или `srv2.sys` .

> [!NOTE]
> WindowsServer2019 не имеет обязательных требований к версии.

|Операционная система|version|
|---|---|
|WindowsServer2008R2|6.1.7601.23689|
|WindowsServer2012|6.2.9200.22099|
|WindowsServer2012R2|6.3.9600.18604|
|WindowsServer2016|10.0.14393.953|
|WindowsServer2019|Н/Д|

## <a name="sack-vulnerability-patch-verification"></a>Проверка исправления с уязвимостью SACK

При отправке образа Linux запрос может быть отклонен из-за проблем с версией ядра.

Обновите ядро, используя утвержденную версию, и отправьте запрос повторно. Утвержденную версию ядра можно найти в следующей таблице. Номер версии должен быть больше или равен указанному ниже.

Если образ не установлен с одной из следующих версий ядра, обновите образ с помощью правильных исправлений. Дополнительные сведения можно найти по следующим ссылкам. Запросите необходимое утверждение у группы поддержки после обновления образа с помощью этих необходимых исправлений:

- CVE-2019-11477 
- CVE-2019-11478 
- CVE-2019-11479

|Семейство ОС|version|ядро|
|---|---|---|
|Ubuntu|14.04 LTS|4.4.0 — 151| 
||14.04 LTS|4.15.0-1049-* — Azure|
||16.04 LTS|4.15.0 — 1049|
||18.04 LTS|4.18.0-1023|
||18.04 LTS|5.0.0-1025|
||18,10|4.18.0-1023|
||19.04|5.0.0-1010|
||19.04|5.3.0-1004|
|ОС RHEL и цент|6.10|2.6.32 — 754.15.3|
||7.2|3.10.0 — 327.79.2|
||7.3|3.10.0 — 514.66.2|
||7.4|3.10.0 — 693.50.3|
||7,5 %|3.10.0 — 862.34.2|
||7.6|3.10.0 — 957.21.3|
||7.7|3.10.0 — 1062.1.1|
||8.0|4.18.0 — 80.4.2|
||8.1|4.18.0-147|
||"7-RAW" (7,6)||
||"7-LVM" (7,6)|3.10.0 — 957.21.3|
||RHEL — SAP 7,4|TBD|
||RHEL — SAP 7,5|TBD|
|SLES|SLES11SP4 (включая SAP)|3.0.101 — 108.95.2|
||SLES12SP1 для SAP|3.12.74 — 60.64.115.1|
||SLES12SP2 для SAP|4.4.121 — 92.114.1|
||SLES12SP3|4.4180-4.31.1 (ядро — Azure)|
||SLES12SP3 для SAP|4.4.180 — 94.97.1|
||SLES12SP4|4.12.14-6.15.2 (ядро — Azure)|
||SLES12SP4 для SAP|4.12.14 — 95.19.1|
||SLES15|4.12.14-5.30.1 (ядро — Azure)|
||SLES15 для SAP|4.12.14-5.30.1 (ядро — Azure)|
||SLES15SP1|4.12.14-5.30.1 (ядро — Azure)|
|Oracle;|6.10|UEK2 2.6.39 — 400.312.2<br>UEK3 3.8.13 — 118.35.2<br>RHCK 2.6.32 — 754.15.3 
||7.0 — 7,5|UEK3 3.8.13 — 118.35.2<br>UEK4 4.1.12 — 124.28.3<br>RHCK соответствует RHEL выше|
||7.6|RHCK 3.10.0 — 957.21.3<br>UEK5 4.14.35 — 1902.2.0|
|CoreOS стабильный 2079.6.0|4.19.43 *|
||Бета-версия 2135.3.1|4.19.50 *|
||Альфа-2163.2.1|4.19.50 *|
|Debian|Jessie (безопасность)|3.16.68-2|
||неjessieные порты|4.9.168-1 + deb9u3|
||Stretch (безопасность)|4.9.168-1 + deb9u3|
||Debian GNU/Linux 10 (бустер)|Debian 6.3.0-18 + deb9u1|
||бустер, ИД безопасности (непереносимые порты Stretch)|4.19.37-5|

## <a name="image-size-should-be-in-multiples-of-megabytes"></a>Размер изображения должен быть кратен мегабайтам

Виртуальным жестким дискам в Azure должен быть назначен виртуальный размер, равный нескольким 1 МБ. Если виртуальный жесткий диск не соответствует рекомендуемому виртуальному размеру, запрос может быть отклонен.

При преобразовании с необработанного диска на виртуальный жесткий диск следуйте рекомендациям, поэтому размер необработанного диска должен быть кратен 1 МБ. Дополнительные сведения см. в разделе сведения о нерекомендуемых [дистрибутивах](../../virtual-machines/linux/create-upload-generic.md) .

## <a name="vm-access-denied"></a>Доступ к виртуальной машине запрещен

Если при выполнении тестовых случаев на виртуальной машине возникает проблема отказа в доступе, это может быть вызвано недостаточными привилегиями для выполнения тестовых случаев.

Проверьте, включен ли правильный доступ к учетной записи, в которой выполняются автоматические варианты. Если это не так, включите доступ для выполнения тестовых случаев. Если вы не хотите разрешать доступ, вы можете поделиться результатами самотестирования с группой поддержки.

## <a name="download-failure"></a>Сбой скачивания
    
Сведения о проблемах при скачивании образа виртуальной машины с помощью URL-адреса SAS см. в следующей таблице.

|S.NO|Ошибка|reason|Решение|
|---|---|---|---|
|1|BLOB-объект не найден|Виртуальный жесткий диск может быть удален или перемещен из указанного расположения|| 
|2|Используемый BLOB-объект|Виртуальный жесткий диск используется другим внутренним процессом|Виртуальный жесткий диск должен быть в используемом состоянии при скачивании с использованием URL-адреса SAS.|
|3|Недопустимый URL-адрес SAS|Соответствующий URL-адрес SAS для этого виртуального жесткого диска неверен.|Получите правильный URL-адрес SAS.|
|4|Неверная цифровая подпись|Соответствующий URL-адрес SAS для этого виртуального жесткого диска неверен.|Получите правильный URL-адрес SAS.|
|6|Условный заголовок HTTP|Недопустимый URL-адрес SAS.|Получите правильный URL-адрес SAS.|
|7|Недопустимое имя виртуального жесткого диска|Проверьте **%** , существуют ли в имени виртуального жесткого диска какие-либо специальные символы, например или **""** .|Переименуйте VHD-файл, удалив специальные символы|

## <a name="first-1-mb-partition"></a>Первый раздел размером 1 МБ

При отправке виртуального жесткого диска убедитесь, что первый раздел виртуального жесткого диска с 1 МБ пуст. В противном случае запрос завершится ошибкой.

## <a name="default-credentials"></a>Учетные данные по умолчанию

Всегда обеспечьте, чтобы учетные данные по умолчанию не отправлялись с помощью отправленного виртуального жесткого диска. Добавление учетных данных по умолчанию делает виртуальный жесткий диск более уязвимым для угроз безопасности. Вместо этого создайте собственные учетные данные при отправке виртуального жесткого диска.
  
## <a name="datadisk-mapped-incorrectly"></a>Неверно сопоставленный диск с подсистемами

Если запрос отправляется с несколькими дисками данных, но их порядок не является последовательным, это считается проблемой сопоставления. Например, если имеется три диска данных, порядок нумерации должен быть **равен 0, 1, 2**. Любой другой заказ будет рассматриваться как вопрос о сопоставлении.

повторно отправьте запрос с соответствующей последовательностью дисков данных.

## <a name="incorrect-os-mapping"></a>Неправильное сопоставление ОС

Созданное изображение может быть сопоставлено или назначено неверной метке ОС. Например, при выборе **Windows** в качестве части имени ОС при создании образа диск операционной системы следует устанавливать только вместе с Windows. Это относится и к Linux.

## <a name="vm-not-generalized"></a>Виртуальная машина не обобщена

Если все образы, созданные в Azure Marketplace, используются повторно, виртуальный жесткий диск операционной системы должен быть обобщенным.

Linux:

Следующий процесс обобщает виртуальную машину Linux и повторно развертывает ее как отдельную виртуальную машину.

В окне SSH введите следующую команду:`sudo waagent -deprovision+user`

Windows:

Образы Windows обобщены с помощью `sysreptool` .

Дополнительные сведения об этом средстве можно найти в [обзоре Sysprep (подготовка системы)]( https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview)

## <a name="datadisk-error"></a>Ошибка на диске

В следующей таблице приведены решения для ошибок, связанных с диском данных.

|Ошибка|reason|Решение|
|---|---|---|
|`DataDisk- InvalidUrl:`|Эта ошибка может быть вызвана недопустимым числом, указанным для LUN при отправке предложения.|Убедитесь, что последовательность номеров LUN для диска данных находится в центре партнеров.|
|`DataDisk- NotFound:`|Эта ошибка может быть вызвана тем, что диск данных не находится по указанному URL-адресу SAS|Убедитесь, что диск данных расположен по URL-адресу SAS, указанному в запросе.|

## <a name="remote-access-issue"></a>Проблемы с удаленным доступом

Если параметр RDP не включен для образа Windows, вы получите эту ошибку. 

Включите доступ по протоколу RDP для образов Windows перед отправкой.

## <a name="next-steps"></a>Следующие шаги

Если у вас есть вопросы или отзывы для улучшения, обратитесь в [службу поддержки центра партнеров](https://partner.microsoft.com/support/v2/?stage=1).
