---
title: Создание технических ресурсов виртуальной машины Azure
description: Узнайте, как создать и настроить технические активы для предложения виртуальной машины (ВМ) в Azure Marketplace.
author: dannyevers
ms.author: mingshen
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: conceptual
ms.date: 04/13/2020
ms.openlocfilehash: 4d2d33f9d83132147b5b257ffcd6d659f272b8ec
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81730720"
---
# <a name="create-your-azure-virtual-machine-technical-assets"></a>Создание технических ресурсов виртуальной машины Azure

> [!IMPORTANT]
> Мы переносим Управление предложениями виртуальной машины Azure из Портал Cloud Partner в центр партнеров. Пока ваши предложения не будут перенесены, следуйте инструкциям в разделе [Создание технических ресурсов для предложения виртуальных машин](https://docs.microsoft.com/azure/marketplace/cloud-partner-portal/virtual-machine/cpp-create-technical-assets) , чтобы портал Cloud Partner для управления вашими предложениями.

В этой статье описывается создание и настройка технических ресурсов для предложения виртуальной машины в Azure Marketplace. Виртуальная машина содержит два компонента: виртуальный жесткий диск (VHD) операционной системы и виртуальные жесткие диски с дополнительными связанными дисками данных:

* **VHD операционной системы** — содержит операционную систему и решение, которое развертывается вместе с вашим предложением. Процесс подготовки виртуального жесткого диска зависит от того, является ли виртуальная машина на основе Linux или на основе Windows.
* **Диски данных** — выделенное, постоянное хранилище для виртуальной машины. Не используйте виртуальный жесткий диск операционной системы (например, диск C:) для хранения постоянных данных.

Образ виртуальной машины содержит один диск операционной системы и до 16 дисков данных. Используйте один виртуальный жесткий диск для каждого диска данных, даже если диск пуст.

> [!NOTE]
> Независимо от используемой операционной системы добавьте только минимальное количество дисков данных, необходимых для решения. Клиенты не могут удалять диски, которые являются частью образа во время развертывания, но они всегда могут добавлять диски во время или после развертывания.

> [!IMPORTANT]
> Каждый образ виртуальной машины в плане должен иметь одинаковое количество дисков данных.

## <a name="fundamental-technical-knowledge"></a>Основные технические знания

Проектирование, сборка и тестирование этих ресурсов занимает время и требует технических знаний о платформе Azure и технологиях, используемых для создания предложения. Помимо домена решения, группа разработчиков должна иметь знания о следующих технологиях Майкрософт:

* базовое представление о [службах Azure](https://azure.microsoft.com/services/);
* умение [разработать приложения Azure](https://azure.microsoft.com/solutions/architecture/);
* опыт работы с [виртуальными машинами Azure](https://azure.microsoft.com/services/virtual-machines/), [службой хранилища Azure](https://azure.microsoft.com/services/?filter=storage) и [сетями Azure](https://azure.microsoft.com/services/?filter=networking);
* опыт работы с [Azure Resource Manager](https://azure.microsoft.com/features/resource-manager/);
* опыт работы с [JSON](https://www.json.org/).

## <a name="suggested-tools--optional"></a>Предлагаемые средства — необязательно

Для управления виртуальными машинами и виртуальными жесткими дисками рекомендуется использовать одну из следующих сред сценариев:

* [Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview)
* [Azure CLI](https://code.visualstudio.com/)

Кроме того, рассмотрите возможность добавления следующих средств в среду разработки:

* [Обозреватель службы хранилища Azure](https://docs.microsoft.com/azure/vs-azure-tools-storage-manage-with-storage-explorer)
* [Visual Studio Code](https://code.visualstudio.com/)
  * Расширение: [Инструменты Azure Resource Manager](https://marketplace.visualstudio.com/items?itemName=msazurermtools.azurerm-vscode-tools).
  * Расширение: [Beautify](https://marketplace.visualstudio.com/items?itemName=HookyQR.beautify).
  * Расширение: [Prettify JSON](https://marketplace.visualstudio.com/items?itemName=mohsen1.prettify-json).

Ознакомьтесь с доступными инструментами на странице [средства для разработчиков Azure](https://azure.microsoft.com/product-categories/developer-tools/) и, если вы используете Visual Studio, [Visual Studio Marketplace](https://marketplace.visualstudio.com/).

## <a name="create-a-vm-image-using-an-approved-base"></a>Создание образа виртуальной машины с помощью утвержденной базы

> [!NOTE]
> Чтобы создать технические активы виртуальной машины с помощью образа, созданного в локальной среде, перейдите к разделу [Создание виртуальной машины с помощью собственного образа](#create-a-vm-using-your-own-image).

В этом разделе описываются различные аспекты использования утвержденной базы, например использование протокол удаленного рабочего стола (RDP), выбор размера виртуальной машины, установка последних обновлений Windows и подготовка образа VHD.

В следующих разделах основное внимание уделяется виртуальным жестким дискам на базе Windows. Дополнительные сведения о создании виртуальных жестких дисков под управлением Linux см. [в статье Linux по дистрибутивам, которые были предоставлены Azure](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros).

> [!WARNING]
> Следуйте указаниям в этом разделе, чтобы использовать Azure для создания виртуальной машины, содержащей предварительно настроенную операционную систему. Если это не совместимо с вашим решением, можно создать и настроить локальную виртуальную машину с помощью утвержденной операционной системы. Затем ее можно настроить и подготовить к отправке, как описано в статье [Подготовка диска VHD или VHDX для Windows к отправке в Azure](https://docs.microsoft.com/azure/virtual-machines/windows/prepare-for-upload-vhd-image).

### <a name="select-an-approved-base"></a>Выбор утвержденной базы

В качестве основы выберите операционную систему Windows или Linux.

#### <a name="windows"></a>Windows

Виртуальный жесткий диск операционной системы для образа виртуальной машины под управлением Windows должен основываться на базовом образе, утвержденном Azure, который содержит Windows Server или SQL Server. Для начала создайте виртуальную машину из одного из следующих образов из портал Azure:

* Windows Server ([2016](https://www.microsoft.com/evalcenter/evaluate-windows-server-2016), [2012 R2 Datacenter](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview), [2012 Datacenter](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview), [2008 R2 SP1](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview));
* [SQL Server 2014](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance) (Enterprise, Standard, Web)
* [SQL Server 2012 SP2](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance) (Enterprise, Standard, Web)

> [!NOTE]
> Если вы используете текущий портал Azure или Azure PowerShell, то все образы Windows Server, опубликованные 8 сентября 2014 и более поздних версий, будут утверждены.

#### <a name="linux"></a>Linux

Azure предлагает диапазон утвержденных дистрибутивов Linux. Текущий список см. в статье [Дистрибутивы Linux, рекомендованные для использования в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros).

### <a name="create-vm-in-the-azure-portal"></a>Создание виртуальной машины с помощью портала Azure

Выполните следующие действия, чтобы создать базовый образ виртуальной машины на [портал Azure](https://ms.portal.azure.com/).

1. Войдите в [портал Azure](https://ms.portal.azure.com/) с учетная запись Майкрософт, связанным с подпиской Azure, которую вы хотите использовать для публикации предложения виртуальной машины.
2. Создайте группу ресурсов и укажите **имя**, **расположение группы ресурсов** и **подписку**. Дополнительные сведения см. в разделе [Управление ресурсами](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-portal).
3. Выберите **виртуальные машины** слева, чтобы отобразить страницу сведений о виртуальных машинах.
4. Выберите **+ Добавить** , чтобы открыть окно " **Создание виртуальной машины**".
5. Выберите изображение из раскрывающегося списка или щелкните **Обзор все общедоступные и частные образы** , чтобы найти или просмотреть все доступные образы виртуальных машин.
6. Выберите размер развертываемой виртуальной машины, используя следующие рекомендации:
    * Если планируется разрабатывать виртуальные жесткие диски локально, размер не имеет значения. Мы рекомендуем использовать виртуальные машины небольшого размера.
    * Если вы планируете разработку образа в среде Azure, лучше использовать один из рекомендуемых размеров виртуальной машины для выбранного образа.

7. В разделе **диски** разверните раздел **Дополнительно** и задайте для параметра **использовать управляемые диски** значение **нет**.
8. Укажите другие необходимые сведения для создания виртуальной машины.
9. Выберите **проверить и создать** , чтобы проверить выбранные параметры. При появлении сообщения **Проверка пройдена** нажмите кнопку **Создать**.

Azure начинает подготовку указанной виртуальной машины. Ход выполнения можно отслеживать, выбрав вкладку **виртуальные машины** слева. После создания состояние изменится на **выполняется**.

Если вы столкнулись с трудностями при создании нового виртуального жесткого диска на основе Azure, см. статью [распространенные проблемы при создании виртуального жесткого диска (FAQ)](https://docs.microsoft.com/azure/marketplace/partner-center-portal/common-issues-during-vhd-creation).

### <a name="connect-to-your-azure-vm"></a>Подключение к виртуальной машине Azure

В этом разделе объясняется, как подключиться к виртуальной машине, созданной в Azure, и войти в нее. После успешного подключения можно работать с виртуальной машиной, как если бы вы локально выполнили вход на сервер узла.

#### <a name="connect-to-a-windows-based-vm"></a>Подключение к виртуальной машине под управлением Windows

Используйте клиент удаленного рабочего стола для подключения к виртуальной машине под управлением Windows, размещенной в Azure. Большинство версий Windows изначально поддерживают протокол удаленного рабочего стола (RDP). Для других операционных систем дополнительные сведения о клиентах можно найти в [Удаленный рабочий стол клиентах](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/clients/remote-desktop-clients).

В этой статье подробно описано, как использовать встроенную поддержку Windows RDP для подключения к виртуальной машине: [как подключиться к виртуальной машине Azure под управлением Windows и войти в нее](https://docs.microsoft.com/azure/virtual-machines/windows/connect-logon).

> [!TIP]
> Во время процесса могут появиться предупреждения системы безопасности. Например, предупреждения, например "RDP-файл от неизвестного издателя" или "не удается проверить ваши учетные данные пользователя". Эти предупреждения можно игнорировать.

#### <a name="connect-to-a-linux-based-vm"></a>Подключение к виртуальной машине под управлением Linux

Для подключения к виртуальной машине под управлением Linux необходим клиент протокола Secure Shell (SSH). В следующих шагах [используется бесплатный терминал](https://www.ssh.com/ssh/putty/) закрытого SHH.

1. Перейдите на [портал Azure](https://ms.portal.azure.com/).
2. Найдите и щелкните **Виртуальные машины**.
3. Выберите виртуальную машину, к которой необходимо подключиться.
4. Запустите виртуальную машину, если она еще не запущена.
5. Выберите имя виртуальной машины, чтобы открыть ее **обзорную** страницу.
6. Запишите общедоступный IP-адрес и DNS-имя виртуальной машины (если эти значения не заданы, необходимо [создать сетевой интерфейс](https://docs.microsoft.com/azure/virtual-network/virtual-network-network-interface#create-a-network-interface)).
7. Откройте приложение PuTTY.
8. В диалоговом окне конфигурации PuTTY введите IP-адрес или DNS-имя своей виртуальной машины.

    :::image type="content" source="media/avm-putty.png" alt-text="Показывает параметры терминала с выводимыми параметрами. поля имя узла или IP-адрес и порт выделены.":::

9. Нажмите кнопку **Открыть** , чтобы открыть терминал с выводимыми символами.
10. При появлении запроса введите имя и пароль учетной записи виртуальной машины Linux.

При наличии проблем с подключением обратитесь к документации по SSH-клиенту. Например, [глава 10: распространенные сообщения об ошибках](https://www.ssh.com/ssh/putty/putty-manuals).

Дополнительные сведения, включая добавление рабочего стола на подготовленную виртуальную машину Linux, см. в [статье Установка и настройка удаленный рабочий стол для подключения к виртуальной машине Linux в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/use-remote-desktop).

## <a name="create-a-vm-using-your-own-image"></a>Создание виртуальной машины с помощью собственного образа

В этом разделе описывается создание и развертывание образа виртуальной машины, предоставленной пользователем. Это можно сделать, предоставив образы VHD операционной системы и диска данных из развернутого в Azure виртуального жесткого диска (VHD).

> [!NOTE]
> Чтобы при необходимости использовать утвержденный базовый образ, следуйте инструкциям в разделе [Создание образа виртуальной машины с помощью утвержденной базы](#create-a-vm-image-using-an-approved-base).

1. Отправка образов в учетную запись хранения Azure.
2. Разверните образ виртуальной машины.
3. Запишите образ виртуальной машины.

### <a name="upload-your-images-to-an-azure-storage-account"></a>Отправка образов в учетную запись хранения Azure

1. Войдите на [портал Azure](https://portal.azure.com/).
2. Передайте обобщенные виртуальные жесткие диски с операционной системой и VHD-диски данных в учетную запись хранения Azure.

### <a name="deploy-your-image"></a>Развертывание образа

Создайте образ, используя портал Azure или Azure PowerShell.

#### <a name="deploy-using-the-azure-portal"></a>Развертывание с помощью портала Azure

1. На домашней странице выберите **создать ресурс**, выполните поиск по запросу "развертывание шаблона" и выберите **создать**.
2. Выберите **создать собственный шаблон в редакторе**.

    :::image type="content" source="media/avm-custom-deployment.png" alt-text="Иллюстрирует страницу настраиваемого развертывания.":::

3. Вставьте этот [шаблон JSON](https://docs.microsoft.com/azure/marketplace/cloud-partner-portal/virtual-machine/cpp-deploy-json-template) в редактор и нажмите кнопку **сохранить**.
4. Укажите значения параметров на страницах свойств **Настраиваемое развертывание**.

    | Параметр | Описание |
    | ------------ | ------------- |
    | User Storage Account Name (Имя учетной записи хранения) | Содержимое из ячейки 2 |
    | User Storage Container Name (Имя контейнера хранилища пользователя) | Имя учетной записи хранения, в которой находится обобщенный виртуальный жесткий диск |
    | DNS Name for Public IP (DNS-имя для общедоступного IP-адреса) | DNS-имя общедоступного IP-адреса. Укажите DNS-имя для общедоступного IP-адреса в портал Azure после развертывания предложения. |
    | Admin User Name (Имя администратора) | Имя пользователя учетной записи администратора для новой виртуальной машины |
    | Пароль администратора | Пароль учетной записи администратора для новой виртуальной машины |
    | Тип ОС | Операционная система виртуальной машины: Windows или Linux |
    | Идентификатор подписки | Идентификатор выбранной подписки |
    | Расположение | Географическое расположение развертывания |
    | Размер виртуальной машины | [Размер виртуальной машины Azure](https://docs.microsoft.com/azure/virtual-machines/windows/sizes), например Standard_A2 |
    | Имя общедоступного IP-адреса | Имя общедоступного IP-адреса |
    | Имя виртуальной машины | Имя новой виртуальной машины |
    | имя виртуальной сети; | Имя виртуальной сети, используемой виртуальной машиной |
    | NIC Name (Имя сетевой карты) | Имя сетевой карты, используемой для виртуальной сети |
    | URL-адрес VHD | Полный URL-адрес виртуального жесткого диска с операционной системой |
    |  |  |

5. После ввода этих значений выберите **приобрести**.

Azure начнет развертывание. Она создает новую виртуальную машину с указанным неуправляемым виртуальным жестким диском в указанном пути учетной записи хранения. Ход выполнения можно отслеживать в портал Azure, выбрав **виртуальные машины** в левой части портала. После создания виртуальной машины состояние изменится с Start на запущена.

#### <a name="deploy-using-azure-powershell"></a>Развертывание с помощью Azure PowerShell

```powershell
    $img = Get-AzureVMImage -ImageName "myVMImage"
    $user = "user123"
    $pass = "adminPassword123"
    $myVM = New-AzureVMConfig -Name "VMImageVM" -InstanceSize "Large" -ImageName $img.ImageName | Add-AzureProvisioningConfig -Windows -AdminUsername $user -Password $pass
    New-AzureVM -ServiceName "VMImageCloudService" -VMs $myVM -Location "West US" -WaitForBoot
```

### <a name="capture-the-vm-image"></a>Запись образа виртуальной машины

Используйте следующие инструкции, соответствующие вашему подходу:

* Azure PowerShell: [как создать неуправляемый образ виртуальной машины на основе виртуальной машины Azure](https://docs.microsoft.com/azure/virtual-machines/windows/capture-image-resource)
* Azure CLI: [Создание образа виртуальной машины или виртуального жесткого диска](https://docs.microsoft.com/azure/virtual-machines/linux/capture-image).
* API: [Virtual Machines - Capture](https://docs.microsoft.com/rest/api/compute/virtualmachines/capture) (Виртуальные машины. Запись).

## <a name="configure-the-virtual-machine"></a>Настройка виртуальной машины

В этом разделе описывается, как изменять размер, обновлять и обобщить виртуальную машину Azure. Эти действия необходимы для подготовки виртуальной машины к развертыванию в Azure Marketplace.

### <a name="sizing-the-vhds"></a>Определение размера виртуальных жестких дисков

Если вы выбрали одну из виртуальных машин, предварительно настроенных с операционной системой (и при необходимости дополнительными службами), вы уже выбрали Стандартный размер виртуальной машины Azure. Рекомендуется запускать решение в предварительно настроенных ОС. Однако при установке ОС вручную необходимо изменить размер основного виртуального жесткого диска в образе виртуальной машины:

* Для Windows виртуальный жесткий диск операционной системы должен быть создан в виде VHD с фиксированным форматом в 127 – 128 ГБ.
* Для Linux этот виртуальный жесткий диск должен быть создан в формате VHD с фиксированным форматом в 30 – 50 ГБ.

Если физический размер меньше 127 – 128 ГБ, VHD должен быть расширяемым (разреженным или динамическим). Базовые образы Windows и SQL Server, которые предоставлены, уже соответствуют этим требованиям, поэтому не меняйте формат или размер виртуального жесткого диска.

Размер дисков данных может достигать 1 ТБ. При принятии решения о размере следует помнить, что клиенты не могут изменять размер виртуальных жестких дисков в образе во время развертывания. Виртуальные жесткие диски для данных следует создавать с фиксированным форматом. Они также должны быть расширяемыми (разреженными или динамическими). Диски данных могут быть пустыми или сразу содержать данные.

### <a name="install-the-most-current-updates"></a>Установка самых свежих обновлений

Базовые образы виртуальных машин операционной системы должны содержать последние обновления до опубликованной даты. Перед публикацией созданного виртуального жесткого диска операционной системы необходимо обновить операционную систему и все установленные службы со всеми последними исправлениями безопасности и обслуживания.

Для Windows Server выполните команду **проверки на наличие обновлений** .

Для дистрибутивов Linux обновления обычно скачиваются и устанавливаются с помощью средства командной строки или графической программы. Например, в Ubuntu Linux для обновления операционной системы есть команда [apt-get](https://manpages.ubuntu.com/manpages/cosmic/man8/apt-get.8.html) и средство [Менеджер обновления](https://manpages.ubuntu.com/manpages/cosmic/man8/update-manager.8.html).

### <a name="perform-additional-security-checks"></a>Выполнение дополнительных проверок безопасности

Обеспечьте высокий уровень безопасности для образов решений в Azure Marketplace. В следующей статье приведен контрольный список конфигураций и процедур безопасности, которые помогут вам: [рекомендации по безопасности для образов Azure Marketplace](https://docs.microsoft.com/azure/security/security-recommendations-azure-marketplace-images). Некоторые из этих рекомендаций относятся только к образам на основе Linux, но большинство из них универсальны для любой виртуальной машины.

### <a name="perform-custom-configuration-and-scheduled-tasks"></a>Выполнение пользовательской настройки и запланированные задачи

Если требуется дополнительная настройка, используйте запланированную задачу, запускаемую при запуске, чтобы внести окончательные изменения в виртуальную машину после ее развертывания. Учтите также следующие рекомендации.

* Если это задача однократного выполнения, задача должна удалить себя после успешного завершения.
* Конфигурации не должны полагаться на диски, отличные от C или D, так как всегда гарантируется наличие только этих двух дисков (диск C является диском операционной системы, а диск D — временным локальным диском).

Дополнительные сведения о настройке Linux см. в обзоре [расширений и компонентов виртуальной машины для Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/features-linux).

## <a name="generalize-the-image"></a>Обобщение образа

Все образы в Azure Marketplace должны быть доступны для повторного использования в первоначальном виде. Для этого виртуальный жесткий диск операционной системы должен быть обобщенным — операцией, которая удаляет из виртуальной машины все идентификаторы, зависящие от экземпляра, и драйверы программного обеспечения.

### <a name="windows"></a>Windows

Диски операционной системы Windows обобщаются с помощью [средства sysprep](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview). Если вы позднее обновите операционную систему или измените ее конфигурацию, снова запустите sysprep.

> [!WARNING]
> Поскольку обновления могут запускаться автоматически, после запуска Sysprep отключите виртуальную машину до ее развертывания. Это завершение работы не позволит последующим обновлениям вносить в операционную систему или установленные службы изменения, относящиеся к конкретному экземпляру. Дополнительные сведения о запуске Sysprep см. [в разделе действия по подготовке виртуального жесткого диска к использованию](https://docs.microsoft.com/azure/virtual-machines/windows/capture-image-resource#generalize-the-windows-vm-using-sysprep).

### <a name="linux"></a>Linux

Следующий процесс обобщает виртуальную машину Linux и повторно развертывает ее как отдельную виртуальную машину. Дополнительные сведения см. [в разделе Создание образа виртуальной машины или виртуального жесткого диска](https://docs.microsoft.com/azure/virtual-machines/linux/capture-image). При достижении раздела «Создание виртуальной машины из образа для записи» можно прерывать работу.

1. **Удаление агента Linux для Azure**

    1. Подключитесь к виртуальной машине Linux c помощью клиента SSH.
    2. В окне SSH введите следующую команду: `sudo waagent -deprovision+user`.
    3. Введите **Y** , чтобы продолжить (можно добавить параметр **-Force** к предыдущей команде, чтобы избежать шага подтверждения).
    d. После выполнения команды введите **Exit** , чтобы закрыть SSH-клиент.

2. **Прекращение работы виртуальной машины**

    1. В портал Azure выберите группу ресурсов (RG) и отмените выделение виртуальной машины.
    2. Теперь виртуальный жесткий диск подготовлен и вы можете создать новую виртуальную машину с помощью этого виртуального жесткого диска.

## <a name="next-steps"></a>Дальнейшие шаги

Если во время создания нового VHD на платформе Azure возникли сложности, обратитесь к статье [Common issues during VHD creation (FAQ)](https://docs.microsoft.com/azure/marketplace/cloud-partner-portal/virtual-machine/cpp-common-vhd-creation-issues). (Вопросы и ответы о распространенных проблемах во время создания VHD).

В противном случае:

* [Сертификация образа виртуальной машины](https://docs.microsoft.com/azure/marketplace/partner-center-portal/get-sas-uri) объясняет, как протестировать и отправить образ виртуальной машины для сертификации Azure Marketplace, включая сведения о том, где можно получить *средство проверки сертификации для средства сертифицирования Azure* и как использовать его для сертификации образа виртуальной машины.
