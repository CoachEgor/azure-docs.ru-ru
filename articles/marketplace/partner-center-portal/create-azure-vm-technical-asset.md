---
title: Создание технических ресурсов виртуальной машины Azure
description: Сведения о создании и настройке технических ресурсов для предложения виртуальной машины (VM) в Azure Marketplace.
author: dannyevers
ms.author: mingshen
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: conceptual
ms.date: 04/13/2020
ms.openlocfilehash: e126ee2bd4133281195d4a86c5cb6f1c47bbd6ac
ms.sourcegitcommit: 309cf6876d906425a0d6f72deceb9ecd231d387c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2020
ms.locfileid: "84266922"
---
# <a name="create-your-azure-virtual-machine-technical-assets"></a>Создание технических ресурсов виртуальной машины Azure

В этой статье описаны создание и настройка технических ресурсов для предложения виртуальной машины (VM) в Azure Marketplace. Виртуальная машина содержит два компонента: виртуальный жесткий диск (VHD) операционной системы и дополнительные связанные виртуальные жесткие диски дисков данных:

* **Виртуальный жесткий диск операционной системы** — содержит операционную систему и решение, которое развертывается вместе с вашим предложением. Процесс подготовки VHD отличается в зависимости от типа виртуальной машины: Linux, Windows или пользовательская.
* **Виртуальные жесткие диски дисков данных** — выделенное, постоянное хранилище для виртуальной машины. Не используйте виртуальный жесткий диск операционной системы (например, диск C:) для хранения постоянных данных.

Образ виртуальной машины содержит один диск операционной системы и до 16 дисков данных. Используйте один виртуальный жесткий диск для каждого диска данных, даже если диск пуст.

> [!NOTE]
> Вне зависимости от используемой операционной системы добавляйте минимальное количество дисков данных, необходимое для решения. Ваши клиенты не смогут удалить диски, которые являются частью образа, на стадии развертывания, однако всегда смогут добавить новые диски во время или после развертывания.

> [!IMPORTANT]
> Каждый образ виртуальной машины в плане должен содержать одинаковое количество дисков данных.

## <a name="fundamental-technical-knowledge"></a>Основные технические знания

Проектирование, сборка и тестирование используемых ресурсов занимают время и требуют технических знаний не только о платформе Azure, но и о технологиях, используемых для создания предложения. Помимо знаний о предметной области решения команда разработчиков также должна располагать знаниями о технологиях Майкрософт, в частности требуется:

* базовое представление о [службах Azure](https://azure.microsoft.com/services/);
* умение [разработать приложения Azure](https://azure.microsoft.com/solutions/architecture/);
* опыт работы с [виртуальными машинами Azure](https://azure.microsoft.com/services/virtual-machines/), [службой хранилища Azure](https://azure.microsoft.com/services/?filter=storage) и [сетями Azure](https://azure.microsoft.com/services/?filter=networking);
* опыт работы с [Azure Resource Manager](https://azure.microsoft.com/features/resource-manager/);
* опыт работы с [JSON](https://www.json.org/).

## <a name="suggested-tools--optional"></a>Рекомендуемые инструменты (необязательно)

Для управления виртуальными машинами и виртуальными жесткими дисками рекомендуется использовать одну из следующих сред сценариев:

* [Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview)
* [Azure CLI](https://code.visualstudio.com/)

Кроме того, мы рекомендуем добавить следующие инструменты в среду разработки:

* [Обозреватель службы хранилища Azure](https://docs.microsoft.com/azure/vs-azure-tools-storage-manage-with-storage-explorer)
* [Visual Studio Code](https://code.visualstudio.com/)
  * Расширение: [Средства Azure Resource Manager](https://marketplace.visualstudio.com/items?itemName=msazurermtools.azurerm-vscode-tools)
  * Расширение: [Beautify](https://marketplace.visualstudio.com/items?itemName=HookyQR.beautify)
  * Расширение: [Prettify JSON](https://marketplace.visualstudio.com/items?itemName=mohsen1.prettify-json)

Проверьте доступные средства на странице [Средства для разработчиков Azure](https://azure.microsoft.com/product-categories/developer-tools/) и, если вы используете Visual Studio, на странице [Visual Studio Marketplace](https://marketplace.visualstudio.com/).

## <a name="create-a-vm-image-using-an-approved-base"></a>Создание образа виртуальной машины с помощью утвержденной базы

> [!NOTE]
> Чтобы создать технические ресурсы виртуальной машины с помощью образа, созданного в локальной среде, перейдите к разделу о [создании виртуальной машины с помощью собственного образа](#create-a-vm-using-your-own-image).

В этом разделе описываются различные аспекты использования утвержденной базы, например использование протокола удаленного рабочего стола (RDP), выбор размера виртуальной машины, установка последних обновлений Windows и подготовка образа VHD.

В следующих разделах основное внимание уделяется виртуальным жестким дискам под управлением Windows. Дополнительные сведения о создании виртуального жесткого диска Linux см. на странице [Дистрибутивы Linux, рекомендованные для использования в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros).

> [!WARNING]
> Следуйте инструкциям в этом разделе, чтобы с помощью Azure создать виртуальную машину, содержащую предварительно настроенную рекомендуемую операционную систему. Если это не совместимо с вашим решением, тогда можно создать и настроить локальную виртуальную машину, использующую утвержденную операционную систему. Затем ее можно настроить и подготовить к отправке, как описано в статье [Подготовка диска VHD или VHDX для Windows к отправке в Azure](https://docs.microsoft.com/azure/virtual-machines/windows/prepare-for-upload-vhd-image).

### <a name="select-an-approved-base"></a>Выбор утвержденной базы

В качестве базы выберите операционную систему Windows или Linux.

#### <a name="windows"></a>Windows

Виртуальный жесткий диск с ОС для вашего образа виртуальной машины под управлением Windows должен быть основан на базовом образе, одобренном для Azure и содержащем Windows Server или SQL Server. Для начала создайте виртуальную машину из одного из следующих образов на портале Azure:

* Windows Server ([2016](https://www.microsoft.com/evalcenter/evaluate-windows-server-2016), [2012 R2 Datacenter](https://www.microsoft.com/cloud-platform/windows-server-pricing), [2012 Datacenter](https://www.microsoft.com/cloud-platform/windows-server-pricing), [2008 R2 SP1](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview));
* [SQL Server 2014](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance) (Enterprise, Standard, Web);
* [SQL Server 2012 SP2](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance) (Enterprise, Standard, Web).

> [!NOTE]
> Если вы используете текущую версию портала Azure или PowerShell, используйте образы Windows Server, опубликованные 8 сентября 2014 г. или позднее, одобренные для Azure.

#### <a name="linux"></a>Linux

Azure предлагает широкий диапазон утвержденных дистрибутивов Linux. Текущий список см. в статье [Дистрибутивы Linux, рекомендованные для использования в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros).

### <a name="create-vm-in-the-azure-portal"></a>Создание виртуальной машины с помощью портала Azure

Выполните следующие действия, чтобы создать базовый образ виртуальной машины на [портале Azure](https://ms.portal.azure.com/):

1. Войдите на [портал Azure](https://ms.portal.azure.com/) с помощью учетной записи Майкрософт, связанной с подпиской Azure, которую вы планируете использовать для публикации предложения виртуальной машины.
2. Создайте группу ресурсов и укажите **имя**, **расположение группы ресурсов** и **подписку**. Дополнительные сведения см. на странице [Управление ресурсами](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-portal).
3. Выберите **Виртуальные машины** в строке меню слева для отображения страницы сведений о виртуальных машинах.
4. Выберите **+ Добавить**, чтобы открыть страницу **Create a virtual machine experience** (Создание интерфейса виртуальной машины).
5. Выберите образ из раскрывающегося списка или щелкните **Просмотр всех общедоступных и частных образов** для поиска или просмотра всех доступных образов виртуальных машин.
6. Выберите размер развертываемой виртуальной машины, используя следующие рекомендации:
    * Если вы планируете локальную разработку VHD, размер не имеет значения. Мы рекомендуем использовать виртуальные машины небольшого размера.
    * Если вы планируете разработку образа в среде Azure, лучше использовать один из рекомендуемых размеров виртуальной машины для выбранного образа.

7. В разделе **Диски** разверните раздел **Расширенный** и установите для параметра **Использовать управляемые диски** значение **Нет**.
8. Укажите другие необходимые сведения для создания виртуальной машины.
9. Выберите **Просмотр и создание**, чтобы проверить выбранные параметры. При появлении сообщения **Проверка пройдена** нажмите кнопку **Создать**.

Azure начнет подготовку указанной вами виртуальной машины. Ход выполнения можно отслеживать, щелкнув вкладку **Виртуальные машины** слева. После создания виртуальной машины ее состояние изменится на **Выполняется**.

Если во время создания нового VHD на платформе Azure возникли сложности, см. страницу с [вопросами и ответами о распространенных проблемах во время создания VHD](https://docs.microsoft.com/azure/marketplace/partner-center-portal/common-issues-during-vhd-creation).

### <a name="connect-to-your-azure-vm"></a>Подключение к виртуальной машине Azure

В этом разделе объясняется, как подключиться к виртуальной машине, созданной в Azure, и войти в ее систему. После успешного подключения к виртуальной машине вы можете работать на ней, как если бы вы локально выполнили вход на ее сервер узла.

#### <a name="connect-to-a-windows-based-vm"></a>Подключение к виртуальной машине под управлением Windows

Для подключения к виртуальной машине Windows, расположенной в Azure, используйте клиент удаленного рабочего стола. Большинство версий Windows изначально поддерживают протокол удаленного рабочего стола (RDP). Для других операционных систем дополнительные сведения о клиентах можно найти на странице [Клиенты удаленного рабочего стола](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/clients/remote-desktop-clients).

В следующей статье подробно описано, как использовать встроенную поддержку RDP Windows для подключения к виртуальной машине: [Как подключиться к виртуальной машине Azure под управлением Windows и войти в ее систему](https://docs.microsoft.com/azure/virtual-machines/windows/connect-logon).

> [!TIP]
> Во время процесса могут появиться предупреждения системы безопасности. Например, предупреждение The .rdp file is from an unknown publisher (RDP-файл от неизвестного издателя) или Your user credentials cannot be verified (Не удается проверить ваши учетные данные пользователя). Эти предупреждения можно игнорировать.

#### <a name="connect-to-a-linux-based-vm"></a>Подключение к виртуальной машине под управлением Linux

Чтобы подключить виртуальную машину под управлением Linux, вам нужен клиент протокола Secure Shell (SSH). В следующих шагах используется бесплатный терминал SHH [PuTTY](https://www.ssh.com/ssh/putty/).

1. Перейдите на [портал Azure](https://ms.portal.azure.com/).
2. Найдите и щелкните **Виртуальные машины**.
3. Выберите виртуальную машину, к которой необходимо подключиться.
4. Запустите виртуальную машину, если она еще не запущена.
5. Щелкните имя виртуальной машины, чтобы открыть ее страницу **Обзор**.
6. Запишите общедоступный IP-адрес и DNS-имя виртуальной машины (если эти значения не заданы, необходимо [создать сетевой интерфейс](https://docs.microsoft.com/azure/virtual-network/virtual-network-network-interface#create-a-network-interface)).
7. Откройте приложение PuTTY.
8. В диалоговом окне конфигурации PuTTY введите IP-адрес или DNS-имя своей виртуальной машины.

    :::image type="content" source="media/avm-putty.png" alt-text="Снимок экрана с параметрами терминала PuTTY. Поля "Имя узла" или "IP-адрес" и "Порт" выделены.":::

9. Щелкните **Открыть**, чтобы открыть окно терминала PuTTY.
10. При появлении запроса введите имя и пароль учетной записи виртуальной машины Linux.

При наличии проблем с подключением обратитесь к документации для SSH-клиента. Например, к [главе 10: Распространенные сообщения об ошибках](https://www.ssh.com/ssh/putty/putty-manuals).

Дополнительные сведения, в частности о том, как добавить рабочий стол в подготовленную виртуальную машину Linux, см. на странице [Установка и настройка удаленного рабочего стола для подключения к виртуальной машине Linux в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/use-remote-desktop).

## <a name="create-a-vm-using-your-own-image"></a>Создание виртуальной машины с помощью собственного образа

В этом разделе описано создание и развертывание образа виртуальной машины (VM) пользователя. Это можно сделать, предоставив образы VHD операционной системы и дисков данных из развернутого в Azure виртуального жесткого диска (VHD).

> [!NOTE]
> Чтобы при необходимости использовать утвержденный базовый образ, следуйте инструкциям в разделе о [создании образа виртуальной машины с помощью утвержденной базы](#create-a-vm-image-using-an-approved-base).

1. Отправьте образы в учетную запись службы хранилища Azure.
2. Разверните образ виртуальной машины.
3. Запишите образ виртуальной машины.

### <a name="upload-your-images-to-an-azure-storage-account"></a>Отправка образов в учетную запись хранения Azure

1. Войдите на [портал Azure](https://portal.azure.com/).
2. Передайте обобщенные виртуальные жесткие диски с операционной системой и VHD-диски данных в учетную запись хранения Azure.

### <a name="deploy-your-image"></a>Развертывание образа

Создайте образ, используя портал Azure или Azure PowerShell.

#### <a name="deploy-using-the-azure-portal"></a>Развертывание с помощью портала Azure

1. На домашней странице выберите **Создать ресурс**, выполните поиск по запросу "Template Deployment" (Развертывание шаблона) и выберите **Создать**.
2. Выберите **Создать собственный шаблон в редакторе**.

    :::image type="content" source="media/avm-custom-deployment.png" alt-text="Снимок экрана страницы настраиваемого развертывания.":::

3. Скопируйте этот [шаблон JSON](https://docs.microsoft.com/azure/marketplace/cloud-partner-portal/virtual-machine/cpp-deploy-json-template) и вставьте его в редактор, а затем щелкните **Сохранить**.
4. Укажите значения параметров на страницах свойств **Настраиваемое развертывание**.

    | Параметр | Описание |
    | ------------ | ------------- |
    | User Storage Account Name (Имя учетной записи хранения) | Содержимое из ячейки 2. |
    | User Storage Container Name (Имя контейнера хранилища пользователя) | Имя учетной записи хранения, в которой находится обобщенный виртуальный жесткий диск |
    | DNS Name for Public IP (DNS-имя для общедоступного IP-адреса) | DNS-имя общедоступного IP-адреса. Укажите DNS-имя для общедоступного IP-адреса на портале Azure после развертывания предложения. |
    | Admin User Name (Имя администратора) | Имя пользователя учетной записи администратора для новой виртуальной машины |
    | Пароль администратора | Пароль учетной записи администратора для новой виртуальной машины |
    | Тип ОС | Операционная система виртуальной машины: Windows или Linux |
    | Идентификатор подписки | Идентификатор выбранной подписки |
    | Расположение | Географическое расположение развертывания |
    | Размер виртуальной машины | [Размер виртуальной машины Azure](https://docs.microsoft.com/azure/virtual-machines/windows/sizes), например Standard_A2. |
    | Имя общедоступного IP-адреса | Имя общедоступного IP-адреса |
    | Имя виртуальной машины | Имя новой виртуальной машины |
    | имя виртуальной сети; | Имя виртуальной сети, используемой виртуальной машиной |
    | NIC Name (Имя сетевой карты) | Имя сетевой карты, используемой для виртуальной сети |
    | URL-адрес VHD | Полный URL-адрес виртуального жесткого диска с операционной системой |
    |  |  |

5. После ввода этих значений выберите **Покупка**.

Azure начнет развертывание. Будет создана виртуальная машина с указанным неуправляемым VHD в определенном пути к учетной записи хранения. На портале Azure можно отслеживать ход выполнения, щелкнув **Виртуальные машины** в левой части. При создании виртуальной машины состояние "Запускается" изменится на "Выполняется".

#### <a name="deploy-using-azure-powershell"></a>Развертывание с помощью Azure PowerShell

```powershell
    $img = Get-AzureVMImage -ImageName "myVMImage"
    $user = "user123"
    $pass = "adminPassword123"
    $myVM = New-AzureVMConfig -Name "VMImageVM" -InstanceSize "Large" -ImageName $img.ImageName | Add-AzureProvisioningConfig -Windows -AdminUsername $user -Password $pass
    New-AzureVM -ServiceName "VMImageCloudService" -VMs $myVM -Location "West US" -WaitForBoot
```

### <a name="capture-the-vm-image"></a>Запись образа виртуальной машины

Используйте следующие инструкции, соответствующие вашему подходу:

* Azure PowerShell: [Создание неуправляемого образа виртуальной машины на основе виртуальной машины Azure](https://docs.microsoft.com/azure/virtual-machines/windows/capture-image-resource)
* Azure CLI: [Создание образа виртуальной машины или виртуального жесткого диска](https://docs.microsoft.com/azure/virtual-machines/linux/capture-image)
* API: [Virtual Machines — Capture](https://docs.microsoft.com/rest/api/compute/virtualmachines/capture) (Виртуальные машины. Запись)

## <a name="configure-the-virtual-machine"></a>Настройка виртуальной машины

В этом разделе описано обновление и подготовка виртуальной машины Azure, а также определение ее размера. Эти шаги нужны для того, чтобы подготовить виртуальную машину к развертыванию в Azure Marketplace.

### <a name="sizing-the-vhds"></a>Определение размера виртуальных жестких дисков

Если вы выбрали предварительно настроенную виртуальную машину с операционной системой (с дополнительными службами или без них), значит вы уже выбрали один из стандартных размеров виртуальной машины Azure. Рекомендуется запускать решение в предварительно настроенных ОС. Но если вы устанавливаете операционную систему вручную, необходимо выбрать размер основного виртуального жесткого диска для образа виртуальной машины.

* Для Windows виртуальный жесткий диск для операционной системы должен иметь фиксированный формат и размер 127–128 ГБ.
* Для Linux этот виртуальный жесткий диск должен иметь фиксированный формат и размер 30–50 ГБ.

Если физический размер меньше 127–128 ГБ, VHD должен быть расширяемым (разреженным или динамическим). Предоставляемые базовые образы Windows и SQL Server уже соответствуют этим требованиям. Не меняйте формат и размер виртуального жесткого диска.

Размер дисков данных может достигать 1 ТБ. Выбирая размер, помните, что пользователи не смогут изменить размер виртуальных жестких дисков в образе во время развертывания. Виртуальные жесткие диски для данных следует создавать с фиксированным форматом. Они также должны быть расширяемыми (разреженными или динамическими). Диски данных могут быть пустыми или сразу содержать данные.

### <a name="install-the-most-current-updates"></a>Установка самых свежих обновлений

Базовые образы виртуальных машин с операционной системой должны содержать все последние обновления до даты публикации образа. Перед публикацией созданного виртуального жесткого диска операционной системы обязательно примените все обновления безопасности и обслуживания для операционной системы и всех установленных служб.

В ОС Windows Server для этого следует запустить команду **Проверить наличие обновлений**.

Для дистрибутивов Linux обновления обычно скачиваются и устанавливаются с помощью средства командной строки или графической программы. Например, в Ubuntu Linux для обновления операционной системы есть команда [apt-get](https://manpages.ubuntu.com/manpages/cosmic/man8/apt-get.8.html) и средство [Менеджер обновления](https://manpages.ubuntu.com/manpages/cosmic/man8/update-manager.8.html).

### <a name="perform-additional-security-checks"></a>Выполнение дополнительных проверок безопасности

Обеспечьте высокий уровень безопасности для образов решений, размещаемых в Azure Marketplace. В следующей статье представлен контрольный список конфигураций и процедур безопасности, которые будут вам полезны: [Рекомендации по обеспечению безопасности для образов Azure Marketplace](https://docs.microsoft.com/azure/security/security-recommendations-azure-marketplace-images) Некоторые из этих рекомендаций относятся только к образам на основе Linux, но большинство из них универсальны для любой виртуальной машины.

### <a name="perform-custom-configuration-and-scheduled-tasks"></a>Выполнение пользовательской настройки и запланированные задачи

Если необходима дополнительная настройка, используйте запланированную задачу, которая сработает при запуске и внесет последние изменения в виртуальную машину сразу после ее развертывания. Учтите также следующие рекомендации.

* Если это задача однократного запуска, она должна удалять себя после успешного завершения.
* Конфигурации должны базироваться лишь на дисках C или D, так как всегда гарантируется наличие только этих двух дисков (диск C является диском операционной системы, а диск D — временным локальным диском).

Дополнительные сведения о настройке Linux см. в обзоре [расширений и компонентов виртуальной машины для Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/features-linux).

## <a name="generalize-the-image"></a>Обобщение образа

Все образы в Azure Marketplace должны быть доступны для повторного использования в первоначальном виде. Для этой цели виртуальный жесткий диск операционной системы необходимо подготовить (обобщить). Эта операция удаляет с виртуальной машины все идентификаторы, относящиеся к определенному экземпляру, и программные драйверы.

### <a name="windows"></a>Windows

Диски операционной системы Windows обобщаются с помощью [средства sysprep](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview). Если вы позднее обновите операционную систему или измените ее конфигурацию, снова запустите sysprep.

> [!WARNING]
> Поскольку обновления могут применяться автоматически, после запуска sysprep отключите виртуальную машину и не включайте ее до завершения развертывания. Это завершение работы не позволит последующим обновлениям вносить в операционную систему или установленные службы изменения, относящиеся к конкретному экземпляру. Дополнительные сведения о запуске sysprep см. в разделе о [действиях по обобщению VHD](https://docs.microsoft.com/azure/virtual-machines/windows/capture-image-resource#generalize-the-windows-vm-using-sysprep).

### <a name="linux"></a>Linux

Следующий процесс обобщает виртуальную машину Linux и повторно развертывает ее как отдельную виртуальную машину. Дополнительные сведения см. на странице [Создание управляемого образа виртуальной машины или виртуального жесткого диска](https://docs.microsoft.com/azure/virtual-machines/linux/capture-image). Изучите сведения до раздела о создании виртуальной машины из записанного образа.

1. **Удаление агента Linux для Azure**

    1. Подключитесь к виртуальной машине Linux c помощью клиента SSH.
    2. В окне SSH введите следующую команду: `sudo waagent -deprovision+user`.
    3. Для продолжения введите **Y** (можно добавить параметр **-force** в предыдущую команду, чтобы предотвратить появление запроса на подтверждение).
    d. После выполнения команды введите **Exit**, чтобы закрыть SSH-клиент.

2. **Прекращение работы виртуальной машины**

    1. На портале Azure выберите нужную группу ресурсов (RG) и отмените распределение виртуальной машины.
    2. Это действие обобщает виртуальный жесткий диск, и теперь вы можете создать новую виртуальную машину на основе этого виртуального жесткого диска.

## <a name="next-steps"></a>Дальнейшие действия

Если во время создания нового VHD на платформе Azure возникли сложности, обратитесь к статье [Common issues during VHD creation (FAQ)](https://docs.microsoft.com/azure/marketplace/cloud-partner-portal/virtual-machine/cpp-common-vhd-creation-issues). (Вопросы и ответы о распространенных проблемах во время создания VHD).

В противном случае:

* Ознакомьтесь со сведениями о том, как тестировать и отправлять образ виртуальной машины для сертификации в Azure Marketplace и где можно получить средство *Certification Test Tool for Azure Certified* (средство проверки сертификации для Azure), а также как его использовать для сертификации образа виртуальной машины, на странице [Сертификация образа виртуальной машины](https://docs.microsoft.com/azure/marketplace/partner-center-portal/get-sas-uri).
