---
title: Создание технических средств Azure Virtual Machine
description: Узнайте, как создать и настроить технические ресурсы для предложения виртуальной машины (VM) для Azure Marketplace.
author: dannyevers
ms.author: mingshen
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: conceptual
ms.date: 04/13/2020
ms.openlocfilehash: 4d2d33f9d83132147b5b257ffcd6d659f272b8ec
ms.sourcegitcommit: ffc6e4f37233a82fcb14deca0c47f67a7d79ce5c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81730720"
---
# <a name="create-your-azure-virtual-machine-technical-assets"></a>Создание технических средств Azure Virtual Machine

> [!IMPORTANT]
> Мы перемещаем управление вашими предложениями azure Virtual Machine с облачного партнерского портала в партнерский центр. До тех пор, пока ваши предложения не будут перенесены, пожалуйста, следуйте инструкциям в [Create технических активов для виртуального предложения машины для Cloud Partner Portal](https://docs.microsoft.com/azure/marketplace/cloud-partner-portal/virtual-machine/cpp-create-technical-assets) для управления вашими предложениями.

В этой статье описывается, как создавать и настраивать технические ресурсы для предложения виртуальной машины (VM) для Azure Marketplace. VM содержит два компонента: операционную систему виртуального жесткого диска (VHD) и дополнительные связанные диски данных VHDs:

* **Операционная система VHD** - содержит операционную систему и решение, которое развертывается с вашим предложением. Процесс подготовки VHD отличается в зависимости от того, является ли это Linux на основе Windows, или на основе пользовательских VM.
* **Диски данных VHD** - Выделенные, постоянное хранилище для VM. Не используйте операционную систему VHD (например, диск C: для хранения постоянной информации.

Изображение VM содержит один диск операционной системы и до 16 дисков данных. Используйте один VHD на диск данных, даже если диск пуст.

> [!NOTE]
> Независимо от того, какую операционную систему вы используете, добавьте только минимальное количество дисков данных, необходимое для решения. Клиенты не могут удалить диски, которые являются частью изображения во время развертывания, но они всегда могут добавлять диски во время или после развертывания.

> [!IMPORTANT]
> Каждое Изображение VM в плане должно иметь одинаковое количество дисков данных.

## <a name="fundamental-technical-knowledge"></a>Основные технические знания

Проектирование, создание и тестирование этих ресурсов требует времени и технических знаний как платформы Azure, так и технологий, используемых для создания предложения. В дополнение к домену решения, ваша команда инженеров должна иметь знания о следующих технологиях Майкрософт:

* базовое представление о [службах Azure](https://azure.microsoft.com/services/);
* умение [разработать приложения Azure](https://azure.microsoft.com/solutions/architecture/);
* опыт работы с [виртуальными машинами Azure](https://azure.microsoft.com/services/virtual-machines/), [службой хранилища Azure](https://azure.microsoft.com/services/?filter=storage) и [сетями Azure](https://azure.microsoft.com/services/?filter=networking);
* опыт работы с [Azure Resource Manager](https://azure.microsoft.com/features/resource-manager/);
* опыт работы с [JSON](https://www.json.org/).

## <a name="suggested-tools--optional"></a>Предлагаемые инструменты - необязательные

Рассмотрите возможность использования одной из следующих сред сценариев для управления vMs и VHD:

* [Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview)
* [Azure CLI](https://code.visualstudio.com/)

Кроме того, рассмотрите возможность добавления следующих инструментов в среду разработки:

* [Обозреватель службы хранилища Azure](https://docs.microsoft.com/azure/vs-azure-tools-storage-manage-with-storage-explorer)
* [Visual Studio Code](https://code.visualstudio.com/)
  * Расширение: [Инструменты Azure Resource Manager](https://marketplace.visualstudio.com/items?itemName=msazurermtools.azurerm-vscode-tools).
  * Расширение: [Beautify](https://marketplace.visualstudio.com/items?itemName=HookyQR.beautify).
  * Расширение: [Prettify JSON](https://marketplace.visualstudio.com/items?itemName=mohsen1.prettify-json).

Просмотрите доступные инструменты на странице [Azure Developer Tools](https://azure.microsoft.com/product-categories/developer-tools/) и, если вы используете Visual Studio, [Visual Studio Marketplace.](https://marketplace.visualstudio.com/)

## <a name="create-a-vm-image-using-an-approved-base"></a>Создание изображения VM с использованием утвержденной базы

> [!NOTE]
> Чтобы создать ваши виртуальные машины технических средств с помощью изображения вы построили на ваших собственных помещений, перейдите к [созданию VM с помощью собственного изображения.](#create-a-vm-using-your-own-image)

В этом разделе описаны различные аспекты использования утвержденной базы, такие как использование протокола удаленного рабочего стола (RDP), выбор размера для VM, установка последних обновлений Windows и обобщение изображения VHD.

Следующие разделы сосредоточены главным образом на окнах на основе VHDs. Для получения дополнительной информации о создании VHD на базе Linux [см.](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros)

> [!WARNING]
> Следуйте рекомендациям в этой теме, чтобы использовать Azure для создания VM, содержащего предварительно настроенную, одобренную операционную систему. Если это не совместимо с вашим решением, можно создать и настроить предприимчивый VM с помощью утвержденной операционной системы. Затем ее можно настроить и подготовить к отправке, как описано в статье [Подготовка диска VHD или VHDX для Windows к отправке в Azure](https://docs.microsoft.com/azure/virtual-machines/windows/prepare-for-upload-vhd-image).

### <a name="select-an-approved-base"></a>Выбор утвержденной базы

Выберите в качестве базы либо систему работы Windows, либо Linux.

#### <a name="windows"></a>Windows

Операционная система VHD для вашего изображения VM на базе Windows должна основываться на утвержденном Azure базовом изображении, содержащем Windows Server или S'L Server. Для начала создайте VM из одного из следующих изображений с портала Azure:

* Windows Server ([2016](https://www.microsoft.com/evalcenter/evaluate-windows-server-2016), [2012 R2 Datacenter](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview), [2012 Datacenter](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview), [2008 R2 SP1](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview));
* [Сервер S'L 2014](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance) (Предприятие, Стандарт, Веб)
* [Сервер S'L 2012 SP2](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance) (Предприятие, Стандарт, Веб)

> [!NOTE]
> Если вы используете текущий портал Azure или Azure PowerShell, то изображения Windows Server, опубликованные 8 сентября 2014 года и позже, утверждаются.

#### <a name="linux"></a>Linux

Azure предлагает широкий спектр одобренных дистрибутивов Linux. Текущий список см. в статье [Дистрибутивы Linux, рекомендованные для использования в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros).

### <a name="create-vm-in-the-azure-portal"></a>Создание виртуальной машины с помощью портала Azure

Выполните следующие действия, чтобы создать базовое изображение VM на [портале Azure:](https://ms.portal.azure.com/)

1. Вопийте на [порталaz](https://ms.portal.azure.com/) с учетной записью Майкрософт, связанной с подпиской Azure, которая требуется использовать для публикации предложения VM.
2. Создайте группу ресурсов и укажите **имя**, **расположение группы ресурсов** и **подписку**. Для получения подробной информации [см.](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-portal)
3. Выберите **виртуальные машины** слева для отображения страницы данных о виртуальных машинах.
4. Выберите **и добавьте,** чтобы открыть **Создать виртуальную машину опыт**.
5. Выберите изображение из списка выпадающих или нажмите **Просмотрите все публичные и частные изображения** для поиска или просмотра всех доступных изображений виртуальной машины.
6. Выберите размер развертываемой виртуальной машины, используя следующие рекомендации:
    * Если вы планируете развивать VHD на месте, размер не имеет значения. Мы рекомендуем использовать виртуальные машины небольшого размера.
    * Если вы планируете разработку образа в среде Azure, лучше использовать один из рекомендуемых размеров виртуальной машины для выбранного образа.

7. В разделе **Диски** расширьте раздел **Advanced** и установите опцию **управляемых дисков Use** **в No.**
8. Предоставьте другие необходимые детали для создания VM.
9. Выберите **Обзор и создайте** для просмотра ваших вариантов. При появлении сообщения **Проверка пройдена** нажмите кнопку **Создать**.

Azure начинает подготовку указанной виртуальной машины. Вы можете отслеживать его прогресс, выбрав вкладку **Virtual Machines** слева. После его создания статус будет меняться на **Запуск.**

Если вы столкнулись с трудностями в создании нового VHD на основе Azure, см. [Общие проблемы во время создания VHD (часто задаваемые вопросы)](https://docs.microsoft.com/azure/marketplace/partner-center-portal/common-issues-during-vhd-creation).

### <a name="connect-to-your-azure-vm"></a>Подключение к виртуальной машине Azure

В этом разделе объясняется, как подключиться к VM, созданную на Azure, и войти в его регистрацию. После успешного подключения вы можете работать с VM так, как если бы вы были локально зарегистрированы на его сервер-хост.

#### <a name="connect-to-a-windows-based-vm"></a>Подключение к виртуальной машине под управлением Windows

Используйте удаленный настольный клиент для подключения к VM на базе Windows, размещенному на Azure. Большинство версий Windows изначально поддерживают протокол удаленного рабочего стола (RDP). Для других операционных систем вы можете найти более подробную информацию о клиентах в [удаленных настольных клиентов.](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/clients/remote-desktop-clients)

В этой статье подробно описано, как использовать встроенную поддержку Windows RDP для подключения к VM: [Как подключиться и войти в виртуальную машину Azure под управлением Windows.](https://docs.microsoft.com/azure/virtual-machines/windows/connect-logon)

> [!TIP]
> Во время процесса вы можете получать предупреждения о безопасности. Например, предупреждения, такие как "Файл .rdp от неизвестного издателя" или "Ваши учетные данные пользователей не могут быть проверены". Эти предупреждения можно игнорировать.

#### <a name="connect-to-a-linux-based-vm"></a>Подключение к виртуальной машине под управлением Linux

Чтобы подключиться к VM на базе Linux, вам нужен клиент защищенного протокола оболочки (SSH). Следующие шаги используют бесплатный терминал [PuTTY](https://www.ssh.com/ssh/putty/) SHH.

1. Перейдите на [портал Azure](https://ms.portal.azure.com/).
2. Найдите и щелкните **Виртуальные машины**.
3. Выберите VM, к который вы хотите подключиться.
4. Запустите VM, если он еще не запущен.
5. Выберите имя VM, чтобы открыть свою страницу **Обзор.**
6. Обратите внимание на общественный IP-адрес и имя DNS вашего VM (если эти значения не установлены, необходимо [создать сетевой интерфейс).](https://docs.microsoft.com/azure/virtual-network/virtual-network-network-interface#create-a-network-interface)
7. Откройте приложение PuTTY.
8. В диалоговом окне конфигурации PuTTY введите IP-адрес или DNS-имя своей виртуальной машины.

    :::image type="content" source="media/avm-putty.png" alt-text="Иллюстрирует настройки терминала PuTTY. выделены имя хоста или IP-адрес и коробки порта.":::

9. Выберите **Открытый** для открытия терминала PuTTY.
10. По запросу введите имя учетной записи и пароль своей учетной записи Linux VM.

Если у вас возникли проблемы с подключением, обратитесь к документации для вашего клиента SSH. Например, [глава 10: Общие сообщения об ошибках](https://www.ssh.com/ssh/putty/putty-manuals).

Для получения подробной информации, в том числе о том, как добавить рабочий стол в подготовленный Linux VM, [см. Установить и настроить удаленный рабочий стол для подключения к Linux VM в Azure.](https://docs.microsoft.com/azure/virtual-machines/linux/use-remote-desktop)

## <a name="create-a-vm-using-your-own-image"></a>Создание VM с помощью собственного изображения

В этом разделе описывается, как создать и развернуть изображение виртуальной машины (VM), предоставленное пользователями. Это можно сделать, предоставив операционную систему и диск данных VHD-изображения с виртуального жесткого диска (VHD), развернутого ВГТРК.

> [!NOTE]
> Чтобы дополнительно использовать утвержденное базовое изображение, следуйте инструкциям в [создании изображения VM с использованием утвержденной базы.](#create-a-vm-image-using-an-approved-base)

1. Загрузите изображения в учетную запись хранения azure.
2. Развертывание изображения VM.
3. Захват изображения VM.

### <a name="upload-your-images-to-an-azure-storage-account"></a>Загрузите изображения в учетную запись хранения Azure

1. Войдите на [портал Azure](https://portal.azure.com/).
2. Загрузите обобщенную операционную систему VHD и VHD-дисков передачи данных на учетную запись хранения Azure.

### <a name="deploy-your-image"></a>Развертывание изображения

Создайте изображение с помощью портала Azure или Azure PowerShell.

#### <a name="deploy-using-the-azure-portal"></a>Развертывание с помощью портала Azure

1. На главной странице выберите **Создать ресурс,** поиск "Шаблон развертывания", и выберите **Создать**.
2. Выберите **создать свой собственный шаблон в редакторе.**

    :::image type="content" source="media/avm-custom-deployment.png" alt-text="Иллюстрирует страницу пользовательского развертывания.":::

3. Вставьте этот [шаблон JSON](https://docs.microsoft.com/azure/marketplace/cloud-partner-portal/virtual-machine/cpp-deploy-json-template) в редактор и выберите **Сохранить**.
4. Укажите значения параметров на страницах свойств **Настраиваемое развертывание**.

    | Параметр | Описание |
    | ------------ | ------------- |
    | User Storage Account Name (Имя учетной записи хранения) | Содержимое из ячейки 2 |
    | User Storage Container Name (Имя контейнера хранилища пользователя) | Имя учетной записи хранения, в которой находится обобщенный виртуальный жесткий диск |
    | DNS Name for Public IP (DNS-имя для общедоступного IP-адреса) | Публичное имя IP DNS. Определите имя DNS для общедоступного IP-адреса на портале Azure после развертывания предложения. |
    | Admin User Name (Имя администратора) | Имя пользователя учетной записи администратора для новой виртуальной машины |
    | Пароль администратора | Пароль учетной записи администратора для новой виртуальной машины |
    | Тип ОС | Операционная система VM: Windows или Linux |
    | Идентификатор подписки | Идентификатор выбранной подписки |
    | Расположение | Географическое расположение развертывания |
    | Размер виртуальной машины | [Размер Azure VM,](https://docs.microsoft.com/azure/virtual-machines/windows/sizes)например, Standard_A2 |
    | Имя общедоступного IP-адреса | Имя общедоступного IP-адреса |
    | Имя виртуальной машины | Имя новой виртуальной машины |
    | имя виртуальной сети; | Имя виртуальной сети, используемой виртуальной машиной |
    | NIC Name (Имя сетевой карты) | Имя сетевой карты, используемой для виртуальной сети |
    | URL-адрес VHD | Полный URL-адрес виртуального жесткого диска с операционной системой |
    |  |  |

5. После предоставления этих значений выберите **Покупка**.

Развертывание Azure начнется. Он создает новый VM с указанным неуправляемым VHD в указанном пути учетной записи хранилища. Вы можете отслеживать ход работ на портале Azure, выбирая **виртуальные машины** на левой стороне портала. При создании VM статус будет меняться от запуска к запуску.

#### <a name="deploy-using-azure-powershell"></a>Развертывание с помощью Azure PowerShell

```powershell
    $img = Get-AzureVMImage -ImageName "myVMImage"
    $user = "user123"
    $pass = "adminPassword123"
    $myVM = New-AzureVMConfig -Name "VMImageVM" -InstanceSize "Large" -ImageName $img.ImageName | Add-AzureProvisioningConfig -Windows -AdminUsername $user -Password $pass
    New-AzureVM -ServiceName "VMImageCloudService" -VMs $myVM -Location "West US" -WaitForBoot
```

### <a name="capture-the-vm-image"></a>Запись образа виртуальной машины

Используйте следующие инструкции, которые соответствуют вашему подходу:

* Azure PowerShell: [Как создать неуправляемое изображение VM из VM Azure](https://docs.microsoft.com/azure/virtual-machines/windows/capture-image-resource)
* Azure CLI: [Создание образа виртуальной машины или виртуального жесткого диска](https://docs.microsoft.com/azure/virtual-machines/linux/capture-image).
* API: [Virtual Machines - Capture](https://docs.microsoft.com/rest/api/compute/virtualmachines/capture) (Виртуальные машины. Запись).

## <a name="configure-the-virtual-machine"></a>Настройка виртуальной машины

В этом разделе описывается, как размер, обновление и обобщение VM Azure. Эти шаги необходимы для подготовки ВМ для развертывания на Azure Marketplace.

### <a name="sizing-the-vhds"></a>Определение размера виртуальных жестких дисков

Если вы выбрали один из vMs, предварительно настроенный с операционной системой (и дополнительно дополнительные услуги), вы уже выбрали стандартный размер Azure VM. Рекомендуется запускать решение в предварительно настроенных ОС. Однако, если вы устанавливаете ОС вручную, вы должны размер основного VHD в вашем изображении VM:

* Для Windows операционная система VHD должна быть создана как VHD с фиксированным форматом 127-128 ГБ.
* Для Linux, это VHD должен быть создан как 30-50 ГБ фиксированного формата VHD.

Если физический размер меньше 127-128 ГБ, VHD должен быть расширяемым (разреженным/динамическим). Предоставляемые базовые изображения Windows и Сервера S'L уже отвечают этим требованиям, поэтому не меняйте формат или размер VHD.

Размер дисков данных может достигать 1 ТБ. При принятии решения о размере помните, что клиенты не могут изменять размер VHD в изображении во время развертывания. Виртуальные жесткие диски для данных следует создавать с фиксированным форматом. Они также должны быть расширяемыми (спаронными/динамическими). Диски данных могут быть пустыми или сразу содержать данные.

### <a name="install-the-most-current-updates"></a>Установка самых свежих обновлений

Базовые изображения вспредь операционной системы должны содержать последние обновления до даты их опубликования. Перед публикацией созданной вами операционной системы VHD убедитесь, что вы обновите ОС и все установленные сервисы со всеми последними исправлением безопасности и технического обслуживания.

Для Windows Server запустите команду **«Проверка обновлений».**

Для дистрибутивов Linux обновления обычно скачиваются и устанавливаются с помощью средства командной строки или графической программы. Например, в Ubuntu Linux для обновления операционной системы есть команда [apt-get](https://manpages.ubuntu.com/manpages/cosmic/man8/apt-get.8.html) и средство [Менеджер обновления](https://manpages.ubuntu.com/manpages/cosmic/man8/update-manager.8.html).

### <a name="perform-additional-security-checks"></a>Выполнение дополнительных проверок безопасности

Поддержание высокого уровня безопасности изображений решений в Azure Marketplace. В следующей статье приводится контрольный список конфигураций и процедур безопасности, которые помогут вам: [Рекомендации по безопасности для изображений Azure Marketplace.](https://docs.microsoft.com/azure/security/security-recommendations-azure-marketplace-images) Некоторые из этих рекомендаций относятся только к образам на основе Linux, но большинство из них универсальны для любой виртуальной машины.

### <a name="perform-custom-configuration-and-scheduled-tasks"></a>Выполнение пользовательской настройки и запланированные задачи

Если необходима дополнительная конфигурация, используйте запланированную задачу, которая выполняется при запуске, чтобы внести окончательные изменения в VM после его развертывания. Учтите также следующие рекомендации.

* Если это задача запуска, задача должна удалить себя после успешного завершения.
* Конфигурации не должны полагаться на диски, кроме C или D, потому что только эти два диска всегда гарантированно существуют (диск C является дископерационной системы и диск D является временным локальным диском).

Дополнительные сведения о настройке Linux см. в обзоре [расширений и компонентов виртуальной машины для Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/features-linux).

## <a name="generalize-the-image"></a>Обобщение образа

Все образы в Azure Marketplace должны быть доступны для повторного использования в первоначальном виде. Для достижения этой цели, операционная система VHD должна быть обобщена, операция, которая удаляет все экземпляр конкретных идентификаторов и драйверов программного обеспечения из VM.

### <a name="windows"></a>Windows

Диски операционной системы Windows обобщаются с помощью [средства sysprep](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview). Если вы позднее обновите операционную систему или измените ее конфигурацию, снова запустите sysprep.

> [!WARNING]
> Поскольку обновления могут работать автоматически, после запуска sysprep, выключите VM до его развертывания. Это отключение позволит избежать последующих обновлений от внесения конкретных изменений в операционную систему или установленные службы. Для получения дополнительной информации о запуске sysprep [см.](https://docs.microsoft.com/azure/virtual-machines/windows/capture-image-resource#generalize-the-windows-vm-using-sysprep)

### <a name="linux"></a>Linux

Следующий процесс обобщает Linux VM и передислоцирует его в отдельный VM. Для получения подробной информации смотрите [Как создать образ виртуальной машины или VHD](https://docs.microsoft.com/azure/virtual-machines/linux/capture-image). Вы можете остановиться, когда вы достигнете раздела "Создайте VM из захваченного изображения".

1. **Удаление агента Linux для Azure**

    1. Подключитесь к виртуальной машине Linux c помощью клиента SSH.
    2. В окне SSH введите `sudo waagent -deprovision+user`следующую команду: .
    3. Тип **Y** для продолжения (можно добавить параметр **силы** к предыдущей команде, чтобы избежать шага подтверждения).
    d. После завершения команды введите **Exit,** чтобы закрыть клиент SSH.

2. **Прекращение работы виртуальной машины**

    1. На портале Azure выберите группу ресурсов (RG) и разделите VM.
    2. Ваш VHD теперь обобщен, и вы можете создать новый VM с помощью этого VHD.

## <a name="next-steps"></a>Следующие шаги

Если во время создания нового VHD на платформе Azure возникли сложности, обратитесь к статье [Common issues during VHD creation (FAQ)](https://docs.microsoft.com/azure/marketplace/cloud-partner-portal/virtual-machine/cpp-common-vhd-creation-issues). (Вопросы и ответы о распространенных проблемах во время создания VHD).

В противном случае:

* [Сертификация изображения VM](https://docs.microsoft.com/azure/marketplace/partner-center-portal/get-sas-uri) объясняет, как протестировать и отправить изображение VM для сертификации Azure Marketplace, в том числе где получить *инструмент сертификации для сертифицированного* инструмента Azure и как использовать его для сертификации изображения VM.
