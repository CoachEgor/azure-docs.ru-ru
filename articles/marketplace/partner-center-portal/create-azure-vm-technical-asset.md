---
title: Создание технических ресурсов для предложения виртуальных машин Azure Marketplace
description: Сведения о создании и настройке технических ресурсов для предложения виртуальной машины (VM) в Azure Marketplace.
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: how-to
author: iqshahmicrosoft
ms.author: iqshah
ms.date: 08/14/2020
ms.openlocfilehash: a83532e2dd6fc8e83206a3b4a055170b40d131fd
ms.sourcegitcommit: 23aa0cf152b8f04a294c3fca56f7ae3ba562d272
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/07/2020
ms.locfileid: "91803523"
---
# <a name="create-technical-assets-for-an-azure-marketplace-virtual-machine-offer"></a>Создание технических ресурсов для предложения виртуальных машин Azure Marketplace

При публикации образов виртуальных машин в Azure Marketplace команда Azure проверяет образ ВИРТУАЛЬНОЙ машины, чтобы обеспечить его загрузку, безопасность и совместимость с Azure. Если какое-либо из высококачественных тестов завершится сбоем, публикация завершится с сообщением, содержащим ошибку, и возможными [корректировки шагами](https://docs.microsoft.com/azure/marketplace/partner-center-portal/vm-certification-issues-solutions).

В этой статье описаны создание и настройка технических ресурсов для предложения виртуальной машины (VM) в Azure Marketplace. Виртуальная машина содержит два компонента: виртуальный жесткий диск (VHD) операционной системы и дополнительные связанные виртуальные жесткие диски дисков данных:

- **VHD операционной системы**: содержит операционную систему и решение, которое развертывается вместе с вашим предложением. Процесс подготовки виртуального жесткого диска зависит от того, является ли виртуальная машина на основе Linux или на основе Windows.

- **Виртуальные жесткие диски данных**: выделенное постоянное хранилище для виртуальной машины. Не используйте виртуальный жесткий диск операционной системы (например, диск C:) для хранения постоянных данных.

Образ виртуальной машины содержит один диск операционной системы и до 16 дисков данных. Используйте один виртуальный жесткий диск для каждого диска данных, даже если диск пуст.

> [!NOTE]
> Вне зависимости от используемой операционной системы добавляйте минимальное количество дисков данных, необходимое для решения. Ваши клиенты не смогут удалить диски, которые являются частью образа, на стадии развертывания, однако всегда смогут добавить новые диски во время или после развертывания.

> [!IMPORTANT]
> Каждый образ виртуальной машины в плане должен содержать одинаковое количество дисков данных.

## <a name="fundamental-technical-knowledge"></a>Основные технические знания

Проектирование, сборка и тестирование используемых ресурсов занимают время и требуют технических знаний не только о платформе Azure, но и о технологиях, используемых для создания предложения. Помимо знаний о предметной области решения команда разработчиков также должна располагать знаниями о технологиях Майкрософт, в частности требуется:

- базовое представление о [службах Azure](https://azure.microsoft.com/services/);
- умение [разработать приложения Azure](https://azure.microsoft.com/solutions/architecture/);
- практические знания о [Виртуальных машинах Azure](https://azure.microsoft.com/services/virtual-machines/), [Службе хранилища Azure](https://azure.microsoft.com/services/?filter=storage) и [Сетях Azure](https://azure.microsoft.com/services/?filter=networking);
- опыт работы с [Azure Resource Manager](https://azure.microsoft.com/features/resource-manager/);
- опыт работы с [JSON](https://www.json.org/).

### <a name="optional-suggested-tools"></a>Необязательные Рекомендуемые инструменты

Для управления виртуальными машинами и виртуальными жесткими дисками рекомендуется использовать одну из следующих сред сценариев:

- [Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview)
- [Azure CLI](https://code.visualstudio.com/)

Кроме того, мы рекомендуем добавить следующие инструменты в среду разработки:

- [Обозреватель службы хранилища Azure](https://docs.microsoft.com/azure/vs-azure-tools-storage-manage-with-storage-explorer)
- [Visual Studio Code](https://code.visualstudio.com/)

## <a name="create-a-vm-image-using-an-approved-base"></a>Создание образа виртуальной машины с помощью утвержденной базы

Сведения о создании технических ресурсов виртуальных машин с помощью образа, созданного на локальном компьютере, см. в разделе [Создание образа виртуальной машины с помощью утвержденной ниже базы](#create-a-vm-image-using-an-approved-base) .

В этом разделе описываются различные аспекты использования утвержденной базы, например использование протокола удаленного рабочего стола (RDP), выбор размера виртуальной машины, установка последних обновлений Windows и подготовка образа VHD.

Следуйте указаниям в этой статье, чтобы создать виртуальную машину, содержащую предварительно настроенную операционную систему, с помощью Azure. Если это не совместимо с вашим решением, тогда можно создать и настроить локальную виртуальную машину, использующую утвержденную операционную систему. Затем ее можно настроить и подготовить к отправке, как описано в статье [Подготовка диска VHD или VHDX для Windows к отправке в Azure](https://docs.microsoft.com/azure/virtual-machines/windows/prepare-for-upload-vhd-image).

### <a name="select-an-approved-base-image"></a>Выберите утвержденный базовый образ

В качестве базы выберите операционную систему Windows или Linux.

Виртуальный жесткий диск с ОС для вашего образа виртуальной машины должен быть основан на базовом образе, одобренном для Azure и содержащем Windows Server или SQL Server.

При отправке запроса на повторную публикацию образа с обновлениями тестовый случай проверки числа частей может завершиться ошибкой. В этом случае ваш образ не будет утвержден.

Эта ошибка произойдет при использовании базового образа, принадлежащего другому издателю, и обновления образа. В этом случае вам запрещено публиковать образ.

Чтобы устранить эту проблему, получите последнюю версию образа из Azure Marketplace и внесите изменения в этот образ. См. следующие сведения, чтобы просмотреть утвержденные базовые образы, в которых можно найти изображение:

#### <a name="windows"></a>Windows

- Windows Server ([2019](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview), [2016](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview), [2012 R2 datacenter](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview), [2012 Datacenter](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview), [2008 R2 SP1](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftwindowsserver.windowsserver?tab=Overview))
- SQL Server 2019 ([Enterprise](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftsqlserver.sql2019-ws2019?tab=Overview), [Standard](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftsqlserver.sql2019-ws2019?tab=Overview), [Web](https://azuremarketplace.microsoft.com/marketplace/apps/microsoftsqlserver.sql2019-ws2019?tab=Overview))
- SQL Server 2014 ([Enterprise](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance), [Standard](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance), [Web](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance))
- SQL Server 2012 SP2 ([Enterprise](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance), [Standard](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance), [Web](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-pricing-guidance))

#### <a name="linux"></a>Linux

Azure предлагает широкий диапазон утвержденных дистрибутивов Linux. Текущий список см. в статье [Дистрибутивы Linux, рекомендованные для использования в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros).

### <a name="create-vm-on-the-azure-portal"></a>Создание виртуальной машины на портал Azure

Выполните следующие действия, чтобы создать базовый образ виртуальной машины на [портал Azure](https://ms.portal.azure.com/).

1. Войдите на [портал Azure](https://ms.portal.azure.com/) с помощью учетной записи Майкрософт, связанной с подпиской Azure, которую вы планируете использовать для публикации предложения виртуальной машины.
2. Создайте группу ресурсов и укажите **имя**, **расположение группы ресурсов** и **подписку**. Дополнительные сведения см. на странице [Управление ресурсами](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-portal).

    :::image type="content" source="media/vm/create-resource-group.png" alt-text="Показывает начало создания группы ресурсов.":::

3. Выберите **виртуальные машины** на левой панели навигации, чтобы отобразить страницу сведений о виртуальных машинах.
4. Выберите **+ Добавить**, чтобы открыть страницу **Create a virtual machine experience** (Создание интерфейса виртуальной машины).
5. Выберите изображение из раскрывающегося списка или выберите **Обзор все общедоступные и частные образы** для поиска или просмотра всех доступных образов виртуальных машин. Пример.

    :::image type="content" source="media/vm/create-resource-group-example.png" alt-text="Показывает начало создания группы ресурсов.":::

6. Выберите размер развертываемой виртуальной машины, используя следующие рекомендации:
    1. Если вы планируете локальную разработку VHD, размер не имеет значения. Мы рекомендуем использовать виртуальные машины небольшого размера.
    2. Если вы планируете разработку образа в среде Azure, лучше использовать один из рекомендуемых размеров виртуальной машины для выбранного образа.

    :::image type="content" source="media/vm/create-virtual-machine.png" alt-text="Показывает начало создания группы ресурсов.":::

7. В разделе **Диски** разверните раздел **Расширенный** и установите для параметра **Использовать управляемые диски** значение **Нет**.

    :::image type="content" source="media/vm/use-managed-disks.png" alt-text="Показывает начало создания группы ресурсов.":::

8. Укажите другие необходимые сведения для создания виртуальной машины.
9. Выберите **Просмотр и создание**, чтобы проверить выбранные параметры. При появлении сообщения **Проверка пройдена** нажмите кнопку **Создать**.

Azure начнет подготовку указанной вами виртуальной машины. Ход выполнения можно отслеживать, щелкнув вкладку **Виртуальные машины** слева. После создания виртуальной машины ее состояние изменится на **Выполняется**.

### <a name="create-a-generation-2-vm-on-the-azure-portal"></a>Создание виртуальной машины поколения 2 на портал Azure

Создайте виртуальную машину поколения 2 (Gen2) в портал Azure.

1. Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com/).
2. Выберите **Создать ресурс**.
3. Выберите **Просмотреть все** в Azure Marketplace слева.
4. Выберите образ, который поддерживает Gen2.
5. Нажмите кнопку **создания**.
6. На вкладке **Дополнительно** в разделе **VM generation** (Поколение виртуальной машины) выберите параметр **Gen 2** (2-е поколение).
7. На вкладке **Базовые** в разделе **Сведения об экземпляре** выберите **Размер** и откройте колонку **Выбор размера виртуальной машины**.
8. Выберите рекомендуемый размер виртуальной машины и размера, [поддерживаемых в Gen 2](https://docs.microsoft.com/azure/virtual-machines/windows/generation-2#generation-2-vm-sizes) .
9. Чтобы завершить создание виртуальной машины, выполните [процедуру создания на портале Azure](https://docs.microsoft.com/azure/virtual-machines/windows/quick-create-portal).

    :::image type="content" source="media/vm/vm-generation.png" alt-text="Показывает начало создания группы ресурсов.":::

## <a name="connect-to-your-azure-vm"></a>Подключение к виртуальной машине Azure

В этом разделе объясняется, как подключиться к виртуальной машине, созданной в Azure, и войти в нее. После успешного подключения к виртуальной машине вы можете работать на ней, как если бы вы локально выполнили вход на ее сервер узла.

### <a name="connect-to-a-windows-based-vm"></a>Подключение к виртуальной машине под управлением Windows

Для подключения к виртуальной машине Windows, расположенной в Azure, используйте клиент удаленного рабочего стола. Большинство версий Windows изначально поддерживают протокол удаленного рабочего стола (RDP). Для других операционных систем дополнительные сведения о клиентах можно найти на странице [Клиенты удаленного рабочего стола](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/clients/remote-desktop-clients).

В этой статье подробно описано, как использовать встроенную поддержку Windows RDP для подключения к виртуальной машине: [как подключиться к виртуальной машине Azure под управлением Windows и войти](https://docs.microsoft.com/azure/virtual-machines/windows/connect-logon)в нее.

> [!TIP]
> Во время процесса могут появиться предупреждения системы безопасности. Например, предупреждение The .rdp file is from an unknown publisher (RDP-файл от неизвестного издателя) или Your user credentials cannot be verified (Не удается проверить ваши учетные данные пользователя). Эти предупреждения можно игнорировать.

### <a name="connect-to-a-linux-based-vm"></a>Подключение к виртуальной машине под управлением Linux

Чтобы подключить виртуальную машину под управлением Linux, вам нужен клиент протокола Secure Shell (SSH). В следующих шагах используется бесплатный терминал SHH [PuTTY](https://www.ssh.com/ssh/putty/).

1. Перейдите на [портал Azure](https://ms.portal.azure.com/).
2. Найдите и щелкните Виртуальные машины.
3. Выберите виртуальную машину, к которой необходимо подключиться.
4. Запустите виртуальную машину, если она еще не запущена.
5. Щелкните имя виртуальной машины, чтобы открыть ее страницу Обзор.
6. Запишите общедоступный IP-адрес и DNS-имя виртуальной машины (если эти значения не заданы, необходимо [создать сетевой интерфейс](https://docs.microsoft.com/azure/virtual-network/virtual-network-network-interface#create-a-network-interface).
7. Откройте приложение PuTTY.
8. В диалоговом окне конфигурации PuTTY введите IP-адрес или DNS-имя своей виртуальной машины.

    :::image type="content" source="media/vm/putty-configuration.png" alt-text="Показывает начало создания группы ресурсов.":::

9. Щелкните **Открыть**, чтобы открыть окно терминала PuTTY.
10. При появлении запроса введите имя и пароль учетной записи виртуальной машины Linux.

## <a name="configure-the-virtual-machine"></a>Настройка виртуальной машины

В этом разделе описано обновление и подготовка виртуальной машины Azure, а также определение ее размера. Эти шаги нужны для того, чтобы подготовить виртуальную машину к развертыванию в Azure Marketplace.

### <a name="sizing-the-vhds"></a>Определение размера виртуальных жестких дисков

Следующие правила предназначены для ограничения размера диска ОС. При отправке любого запроса убедитесь, что размер диска ОС находится в пределах ограничений для Linux или Windows.

| OS | Рекомендуемый размер VHD |
| --- | --- |
| Linux | от 30 до 1023 ГБ |
| Windows | от 30 до 250 ГБ |

Так как виртуальные машины разрешают доступ к базовой операционной системе, убедитесь, что размер VHD достаточно велик для виртуального жесткого диска. Так как диски не расширяются без простоя, используйте размер диска от 30 до 50 &nbsp; ГБ.

| Размер виртуального жесткого диска | Фактический объем занятого объема | Решение |
| --- | --- | --- |
| >500 ТБ | Недоступно | Обратитесь в службу поддержки за исключением утверждения. |
| 250-500 ТБ | >200 ГБ, отличающиеся от размера большого двоичного объекта | Обратитесь в службу поддержки за исключением утверждения. |

### <a name="install-the-most-current-updates"></a>Установка самых свежих обновлений

Базовые образы виртуальных машин с операционной системой должны содержать все последние обновления до даты публикации образа. Перед публикацией созданного виртуального жесткого диска операционной системы обязательно примените все обновления безопасности и обслуживания для операционной системы и всех установленных служб.

- В ОС Windows Server для этого следует запустить команду Проверить наличие обновлений.
- Для дистрибутивов Linux обновления обычно скачиваются и устанавливаются с помощью средства командной строки или графической программы. Например, в Ubuntu Linux для обновления операционной системы есть команда [apt-get](https://manpages.ubuntu.com/manpages/cosmic/man8/apt-get.8.html) и средство [Менеджер обновления](https://manpages.ubuntu.com/manpages/cosmic/man8/update-manager.8.html).

#### <a name="perform-additional-security-checks"></a>Выполнение дополнительных проверок безопасности

Обеспечьте высокий уровень безопасности для образов решений, размещаемых в Azure Marketplace. Контрольный список конфигураций и процедур безопасности см. в статье [рекомендации по безопасности для образов Azure Marketplace](https://docs.microsoft.com/azure/security/security-recommendations-azure-marketplace-images). Некоторые из этих рекомендаций относятся только к образам на основе Linux, но большинство из них универсальны для любой виртуальной машины.

#### <a name="perform-custom-configuration-and-scheduled-tasks"></a>Выполнение пользовательской настройки и запланированные задачи

Если требуется дополнительная настройка, используйте запланированную задачу, запускаемую при запуске, чтобы внести окончательные изменения в виртуальную машину после ее развертывания. Учтите также следующие рекомендации:

- Если это задача однократного запуска, она должна удалять себя после успешного завершения.
- Конфигурации должны базироваться лишь на дисках C или D, так как всегда гарантируется наличие только этих двух дисков (диск C является диском операционной системы, а диск D — временным локальным диском).

Дополнительные сведения о настройке Linux см. в обзоре [расширений и компонентов виртуальной машины для Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/features-linux).

## <a name="generalize-the-image"></a>Обобщение образа

Все образы в Azure Marketplace должны быть доступны для повторного использования в первоначальном виде. Для этой цели виртуальный жесткий диск операционной системы необходимо подготовить (обобщить). Эта операция удаляет с виртуальной машины все идентификаторы, относящиеся к определенному экземпляру, и программные драйверы.

### <a name="for-windows"></a>Для Windows

Диски ОС Windows обобщены с помощью средства [Sysprep](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview) . Если позже вы обновите или перенастройте ОС, необходимо снова запустить Sysprep.

> [!WARNING]
> После запуска программы Sysprep выключите виртуальную машину, пока она не будет развернута, так как обновления могут запускаться автоматически. Это завершение работы не позволит последующим обновлениям вносить в операционную систему или установленные службы изменения, относящиеся к конкретному экземпляру. Дополнительные сведения о запуске sysprep см. в разделе о [действиях по обобщению VHD](https://docs.microsoft.com/azure/virtual-machines/windows/capture-image-resource#generalize-the-windows-vm-using-sysprep).

### <a name="for-linux"></a>Для Linux

Следующий процесс обобщает виртуальную машину Linux и повторно развертывает ее как отдельную виртуальную машину. Дополнительные сведения см. на странице [Создание управляемого образа виртуальной машины или виртуального жесткого диска](https://docs.microsoft.com/azure/virtual-machines/linux/capture-image). При достижении раздела «Создание виртуальной машины из образа для записи» можно прерывать работу.

1. Удаление агента Linux для Azure

    1. Подключение к виртуальной машине Linux с помощью клиента SSH
    2. В окне SSH введите следующую команду: `sudo waagent –deprovision+user`.
    3. Для продолжения введите Y (можно добавить параметр -force в предыдущую команду, чтобы предотвратить появление запроса на подтверждение).
    4. После выполнения команды введите Exit, чтобы закрыть SSH-клиент.

2. Прекращение работы виртуальной машины

    1. На портале Azure выберите нужную группу ресурсов (RG) и отмените распределение виртуальной машины.
    2. Это действие обобщает виртуальный жесткий диск, и теперь вы можете создать новую виртуальную машину на основе этого виртуального жесткого диска.

## <a name="next-steps"></a>Дальнейшие действия

- Если во время создания нового VHD на платформе Azure возникли сложности, обратитесь к статье [Common issues during VHD creation (FAQ)](common-issues-during-vhd-creation.md). (Вопросы и ответы о распространенных проблемах во время создания VHD).
- Если нет, [Тестовая виртуальная машина (ВМ), развернутая из VHD](azure-vm-image-certification.md) , объясняет, как тестировать и отправлять образ виртуальной машины для сертификации Azure Marketplace, включая сведения о том, где можно получить средство проверки сертификации для средства сертифицирования Azure и как использовать его для сертификации образа виртуальной машины.
