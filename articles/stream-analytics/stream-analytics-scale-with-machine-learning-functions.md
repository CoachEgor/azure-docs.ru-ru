---
title: Масштабирование функций службы "Машинное обучение" в Azure Stream Analytics
description: Из этой статьи вы узнаете, как масштабировать задания Stream Analytics, для которых используются функции службы "Машинное обучение", настроив секционирование и единицы потоковой передачи.
services: stream-analytics
author: jseb225
ms.author: jeanb
ms.reviewer: jasonh
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 06/21/2019
ms.openlocfilehash: 5da09d705246ffd5002a1a21daab2266525f579e
ms.sourcegitcommit: a7ea412ca4411fc28431cbe7d2cc399900267585
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/25/2019
ms.locfileid: "67357510"
---
# <a name="scale-your-stream-analytics-job-with-azure-machine-learning-studio-functions"></a>Масштабирование заданий Stream Analytics с помощью функций студии машинного обучения Azure

В этой статье описывается эффективного масштабирования задания Azure Stream Analytics, использующие функции машинного обучения Azure. Общие сведения о масштабировании заданий Stream Analytics см. в статье [Масштабирование заданий](stream-analytics-scale-jobs.md).

## <a name="what-is-an-azure-machine-learning-function-in-stream-analytics"></a>Что такое функция машинного обучения Azure в Stream Analytics?

Функция машинного обучения в Stream Analytics может использоваться как обычный вызов функции в языке запросов Stream Analytics. По сути тем не менее, эти вызовы функций не разрешены фактически запросы веб-службы машинного обучения Azure.

Можно повысить пропускную способность запросов веб-службы машинного обучения, «пакетно обрабатывая» несколько строк, в том же вызов API для веб-службы. Такой способ группировки, называется мини-пакетом. Дополнительные сведения см. в разделе [веб-служб Azure Machine Learning Studio](../machine-learning/studio/consume-web-services.md). Для студии машинного обучения в Stream Analytics поддерживается в предварительной версии.

## <a name="configure-a-stream-analytics-job-with-machine-learning-functions"></a>Настройка задания Stream Analytics с помощью функций машинного обучения

Существует два параметра для настройки функции машинного обучения, используемое заданием Stream Analytics:

* Размер пакета, вызов функции машинного обучения.
* Число единиц потоковой передачи (su) подготовленных для задания Stream Analytics.

Чтобы определить соответствующие значения для единиц потоковой передачи, решите, следует ли оптимизировать задержка задания Stream Analytics или пропускная способность каждой единицы потоковой Передачи. Всегда можно добавить su для увеличения пропускной способности хорошо секционированного запроса Stream Analytics в задание. Дополнительные единицы su увеличивают стоимость выполнения задания.

Определите задержку *допуска* для задания Stream Analytics. Увеличение размера пакета увеличит задержку запросов службы машинного обучения Azure и задержка задания Stream Analytics.

Увеличение размера пакета позволяет заданиям Stream Analytics для обработки **больше событий** с **столько же** машинного обучения запросов веб-службы. Увеличение задержки веб-службы машинного обучения обычно сублинейное на увеличение размера пакета. 

Очень важно определить наиболее экономичный размер пакета для веб-службы машинного обучения в той или иной ситуации. Размер пакета по умолчанию для запросов веб-службы равен 1000. Можно изменить этот размер по умолчанию с помощью [Stream Analytics REST API](https://docs.microsoft.com/previous-versions/azure/mt653706(v=azure.100) "Stream Analytics REST API") или [клиент PowerShell для Stream Analytics](stream-analytics-monitor-and-manage-jobs-use-powershell.md).

Если вы решили на размер пакета, можно задать количество единиц потоковой передачи (SUs), на основе числа событий, которые функция должна обрабатывать в секунду. Дополнительные сведения о единицах потоковой передачи см. в статье [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности базы данных](stream-analytics-scale-jobs.md).

Каждые 6 su получат 20 одновременных подключений к веб-службе машинного обучения. Тем не менее задание 1 SU и 3 su получат 20 одновременных подключений.  

Если приложение создает 200 000 событий в секунду, а размер пакета равен 1000, полученный задержка веб-службы составляет 200 мс. Такая скорость означает, что каждое подключение может отправлять пять запросов в веб-службу машинного обучения в секунду. С 20 соединениями задание Stream Analytics может обрабатывать 20 000 событий за 200 мс и 100 000 событий в секунду.

Чтобы обрабатывать 200 000 событий в секунду, и задание Stream Analytics требуется 40 одновременных подключений, что соответствует 12 su. На следующей схеме показан запрос из задания Stream Analytics к конечной точке веб-службы машинного обучения. На каждые 6 SU приходится не более 20 одновременных подключений к веб-службе машинного обучения.

![Пример: масштабирование двух заданий Stream Analytics с помощью функций машинного обучения](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-00.png "Пример: масштабирование двух заданий Stream Analytics с помощью функций машинного обучения")

В общем случае, если ***B*** — размер пакета, а ***L*** — задержка веб-службы при размере пакета B в миллисекундах, то пропускная способность задания Stream Analytics с ***N*** SU будет составлять:

![Формула масштабирования Stream Analytics с использованием функций машинного обучения](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-02.png "Формула масштабирования Stream Analytics с использованием функций машинного обучения")

«Максимальное количество одновременных вызовов» можно также настроить веб-службу машинного обучения. Рекомендуется для этого параметра до максимального значения (в настоящее время 200).

Дополнительные сведения об этом параметре см. в статье [Масштабирование веб-службы машинного обучения](../machine-learning/studio/scaling-webservice.md).

## <a name="example--sentiment-analysis"></a>Пример: анализ мнений
В следующем примере показано задание Stream Analytics с функцией машинного обучения для анализа мнений, как описано в руководстве [Общие сведения о Stream Analytics и интеграции машинного обучения](stream-analytics-machine-learning-integration-tutorial.md).

Запрос представляет собой простой полностью секционированный запрос, за которым следует функция **sentiment**, как показано в следующем примере:

```SQL
    WITH subquery AS (
        SELECT text, sentiment(text) as result from input
    )

    Select text, result.[Score]
    Into output
    From subquery
```

Давайте рассмотрим настройки, необходимой для создания задания Stream Analytics, какие выполняет анализ тональности твитов со скоростью 10 000 твитов в секунду.

С помощью 1 SU, удалось это задание Stream Analytics обрабатывать трафик? Задание сможет справиться с входными данными, используя размер пакета по умолчанию 1000. Задержка по умолчанию веб-службы машинного обучения по анализу мнений (с размером пакета по умолчанию 1000) создает не более чем одной секунды задержка.

**Общая** (сквозная) задержка задания Stream Analytics обычно составляет несколько секунд. Изучите это задание Stream Analytics более подробно, *особенно* вызовы функций машинного обучения. С размером пакета 1000 пропускной способности 10 000 событий занимает около 10 запросов в веб-службу. Даже при одной единице хранения количество одновременных подключений будет достаточным для обработки этого входящего трафика.

Но что делать, если частота входящих событий увеличится в 100 раз, а задание Stream Analytics должно обрабатывать 1 000 000 твитов в секунду? Выполнить увеличения масштаба можно двумя способами.

1. Увеличьте размер пакета.
2. Секционировать входной поток для обработки событий в параллельном режиме.

Если выбрать первый вариант, то увеличится **задержка** задания.

Второй вариант необходимо подготовить дополнительные единицы потоковой передачи требуется большее количество параллельных запросов веб-службы машинного обучения. Это большее количество единиц потоковой передачи, увеличивает задания **стоимость**.

Давайте взглянем на масштабирования с помощью следующих измерений задержки для каждого размера пакета:

| Задержка | Размер пакета |
| --- | --- |
| 200 мс | пакетов на 1000 событий или ниже |
| 250 мс | пакетов на 5000 событий |
| 300 мс | 10 000 событий пакетов |
| 500 мс | 25 000 событий пакетов |

1. Использование первого варианта (**без** подготовки дополнительных единиц SU). Размер пакета можно увеличить до **25 000**. Увеличение размера пакета, таким образом, позволит заданию обрабатывать 1 000 000 событий при 20 одновременных подключениях к веб-службы машинного обучения (с задержкой 500 мс на один вызов). Поэтому дополнительная задержка задания Stream Analytics (из-за того, что функция анализа мнений выполняет запросы к веб-службе машинного обучения) увеличится с **200** до **500 мс**. Тем не менее, размер пакета **нельзя** увеличиваться бесконечно, как в веб-службах машинного обучения требует, размер полезных данных запроса быть 4 МБ или меньше и веб-тайм-аут запросов службы после 100 секунд работы.
1. Если используется второй вариант, то размер пакета остается неизменным (1000) и при задержке веб-службы в 200 мс каждые 20 одновременных подключений к веб-службе смогут обрабатывать 1000 * 20 * 5 событий, то есть 100 000 событий в секунду. Таким образом, для обработки 1 000 000 событий в секунду заданию потребуется 60 SU. По сравнению с первым вариантом задание Stream Analytics будет создавать больше пакетных запросов к веб-службе, что приведет к увеличению затрат.

Ниже приведена таблица пропускной способности (количества событий в секунду) задания Stream Analytics для разного количества SU и размеров пакета.

| Размер пакета (задержка службы машинного обучения) | 500 (200 мс) | 1000 (200 мс) | 5000 (250 мс) | 10 000 (300 мс) | 25 000 (500 мс) |
| --- | --- | --- | --- | --- | --- |
| **1 единица хранения** |2500 |5 000 |20 000 |30 000 |50 000 |
| **3 единицы хранения** |2500 |5 000 |20 000 |30 000 |50 000 |
| **6 единиц хранения** |2500 |5 000 |20 000 |30 000 |50 000 |
| **12 единиц хранения** |5 000 |10 000 |40 000 |60 000 |100 000 |
| **18 единиц хранения** |7500 |15 000 |60 000 |90 000 |150 000 |
| **24 единицы хранения** |10 000 |20 000 |80 000 |120 000 |200 000 |
| **…** |… |… |… |… |… |
| **60 единиц хранения** |25 000 |50 000 |200,000 |300 000 |500,000 |

Теперь у вас есть четкое представление о том, как работают функции машинного обучения в Stream Analytics. Скорее всего, вы также знаете, что задания Stream Analytics извлекают данные из источников данных и каждая операция извлечения возвращает пакет событий, которые обрабатывает задание Stream Analytics. Каким образом эта модель извлечения данных влияет на запросы к веб-службе машинного обучения?

Как правило, размер пакета, заданный для функций машинного обучения, не делится точно на количество событий, возвращаемых каждой операцией извлечения, которую выполняет задание Stream Analytics. Когда это происходит, веб-служба машинного обучения вызывается с помощью "частичных" пакетов. С помощью частичных пакетов вы не будете нести затраты на задержку дополнительные задания в событиях объединения со значением от извлечения.

## <a name="new-function-related-monitoring-metrics"></a>Новые метрики мониторинга, связанные с функциями
В области мониторинга задания Stream Analytics добавлены три дополнительные метрики, связанные с функциями. Они являются **запросы ФУНКЦИЙ**, **СОБЫТИЯ функции** и **запросы ФУНКЦИЙ со СБОЕМ**, как показано на следующем рисунке.

![Метрики масштабирования Stream Analytics с использованием функций машинного обучения](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-01.png "Метрики масштабирования Stream Analytics с использованием функций машинного обучения")

Вот их определения:

**ЗАПРОСЫ ФУНКЦИЙ**: количество запросов функций.

**СОБЫТИЯ ФУНКЦИЙ**: количество событий в запросах функций.

**НЕУДАЧНЫЕ ЗАПРОСЫ ФУНКЦИЙ**: количество неудачных запросов функций.

## <a name="key-takeaways"></a>Общие выводы

Чтобы масштабировать задание Stream Analytics с помощью функций машинного обучения, учитывайте следующие факторы:

1. Частота входящих событий.
2. Допустимая задержка для выполняющегося задания Stream Analytics (и, таким образом, размер пакета для запросов веб-службы машинного обучения).
3. Подготовленных единиц потоковой передачи Stream Analytics и количество запросов веб-службы машинного обучения (Дополнительные функции затрат, связанных с).

В качестве примера был использован полностью секционированный запрос Stream Analytics. Если требуется более сложный запрос, посетите [форум Azure Stream Analytics](https://social.msdn.microsoft.com/Forums/azure/home?forum=AzureStreamAnalytics). Это превосходный ресурс, на котором можно получить дополнительные сведения от разработчиков Stream Analytics.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о службе Stream Analytics см. в следующих статьях:

* [Приступая к работе с Azure Stream Analytics](stream-analytics-real-time-fraud-detection.md)
* [Масштабирование заданий в службе Azure Stream Analytics](stream-analytics-scale-jobs.md)
* [Справочник по языку запросов Azure Stream Analytics](https://msdn.microsoft.com/library/azure/dn834998.aspx)
* [Справочник по API-интерфейсу REST управления Stream Analytics](https://msdn.microsoft.com/library/azure/dn835031.aspx)
