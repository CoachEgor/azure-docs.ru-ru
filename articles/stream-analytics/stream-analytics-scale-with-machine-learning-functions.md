---
title: Масштабирование функций службы "Машинное обучение" в Azure Stream Analytics
description: Из этой статьи вы узнаете, как масштабировать задания Stream Analytics, для которых используются функции службы "Машинное обучение", настроив секционирование и единицы потоковой передачи.
author: jseb225
ms.author: jeanb
ms.reviewer: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 06/21/2019
ms.openlocfilehash: dedffab0b17515cedc54569d5debf6d29b273644
ms.sourcegitcommit: f4f626d6e92174086c530ed9bf3ccbe058639081
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/25/2019
ms.locfileid: "75458748"
---
# <a name="scale-your-stream-analytics-job-with-azure-machine-learning-studio-classic-functions"></a>Масштабирование задания Stream Analytics с помощью функций Машинное обучение Azure Studio (классическая модель)

В этой статье описывается эффективное масштабирование Azure Stream Analytics заданий, использующих функции Машинное обучение Azure. Общие сведения о масштабировании заданий Stream Analytics см. в статье [Масштабирование заданий](stream-analytics-scale-jobs.md).

## <a name="what-is-an-azure-machine-learning-function-in-stream-analytics"></a>Что такое функция машинного обучения Azure в Stream Analytics?

Функция машинного обучения в Stream Analytics может использоваться как обычный вызов функции в языке запросов Stream Analytics. Однако в фоновом режиме эти вызовы функций фактически Машинное обучение Azure запросы веб-службы.

Можно повысить пропускную способность Машинное обучение запросов веб-службы, выполнив пакетную обработку нескольких строк вместе в одном вызове API веб-службы. Эта группировка называется мини-пакетом. Дополнительные сведения см. в разделе [веб-службы машинное обучение Azure Studio (классическая модель)](../machine-learning/studio/consume-web-services.md). Поддержка Машинное обучение Azure Studio (классическая модель) в Stream Analytics доступна в предварительной версии.

## <a name="configure-a-stream-analytics-job-with-machine-learning-functions"></a>Настройка задания Stream Analytics с помощью функций машинного обучения

Существует два параметра для настройки функции Машинное обучение, используемой заданием Stream Analytics.

* Размер пакета для вызовов функции Машинное обучение.
* Количество единиц потоковой передачи (SUs), подготовленных для задания Stream Analytics.

Чтобы определить соответствующие значения для службы SUs, решите, нужно ли оптимизировать задержку Stream Analytics задания или пропускную способность каждой SU. Для повышения пропускной способности хорошо секционированного Stream Analytics запроса службы SUs всегда могут быть добавлены в задание. Дополнительные службы SUs увеличивают стоимость выполнения задания.

Определите *допуск* задержки для задания Stream Analytics. Увеличение размера пакета увеличит задержку запросов Машинное обучение Azure и задержку задания Stream Analytics.

Увеличение размера пакета позволяет Stream Analyticsному заданию обрабатывать **больше событий** с тем **же количеством** машинное обучение запросов веб-служб. Увеличение задержки Машинное обучение веб-службы обычно является линейным по отношению к увеличению размера пакета. 

Важно учитывать наиболее экономичный размер пакета для Машинное обучение веб-службы в любой конкретной ситуации. Размер пакета по умолчанию для запросов веб-служб — 1000. Этот размер по умолчанию можно изменить с помощью [Stream Analytics REST API](https://docs.microsoft.com/previous-versions/azure/mt653706(v=azure.100) "REST API Stream Analytics") или [клиента PowerShell для Stream Analytics](stream-analytics-monitor-and-manage-jobs-use-powershell.md).

После выбора размера пакета можно задать количество единиц потоковой передачи (SUs) в зависимости от числа событий, которые функция должна обработать в секунду. Дополнительные сведения о единицах потоковой передачи см. в статье [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности базы данных](stream-analytics-scale-jobs.md).

Каждые 6 служб SUs получают 20 одновременных подключений к веб-службе Машинное обучение. Однако одно задание "SU" и 3 задания SU получают 20 одновременных подключений.  

Если приложение создает события 200 000 в секунду и размер пакета равен 1000, то в результате задержка веб-службы составляет 200 мс. Это означает, что каждое подключение может выполнять пять запросов к Машинное обучение веб-службе каждую секунду. При 20 соединениях задание Stream Analytics может обрабатывать 20 000 событий в 200 мс и 100 000 событий в секунду.

Для обработки 200 000 событий в секунду для задания Stream Analytics требуется 40 одновременных подключений, которые выступают на 12 SUs. На следующей схеме показан запрос из задания Stream Analytics к конечной точке веб-службы машинного обучения. На каждые 6 SU приходится не более 20 одновременных подключений к веб-службе машинного обучения.

![Масштабирование Stream Analytics с помощью Машинное обучениеных функций два примера задания](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-00.png "Масштабирование Stream Analytics с помощью Машинное обучениеных функций два примера задания")

В общем случае, если ***B*** — размер пакета, а ***L*** — задержка веб-службы при размере пакета B в миллисекундах, то пропускная способность задания Stream Analytics с ***N*** SU будет составлять:

![Масштабирование Stream Analytics с помощью формулы функций Машинное обучение](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-02.png "Формула масштабирования Stream Analytics с помощью функций машинного обучения")

Можно также настроить параметр "максимальное число одновременных вызовов" в Машинное обучение веб-службе. Рекомендуется присвоить этому параметру максимальное значение (в настоящее время 200).

Дополнительные сведения об этом параметре см. в статье [Масштабирование веб-службы машинного обучения](../machine-learning/studio/scaling-webservice.md).

## <a name="example--sentiment-analysis"></a>Пример: анализ мнений
В следующем примере показано задание Stream Analytics с функцией машинного обучения для анализа мнений, как описано в руководстве [Общие сведения о Stream Analytics и интеграции машинного обучения](stream-analytics-machine-learning-integration-tutorial.md).

Запрос представляет собой простой полностью секционированный запрос, за которым следует функция **sentiment**, как показано в следующем примере:

```SQL
    WITH subquery AS (
        SELECT text, sentiment(text) as result from input
    )

    Select text, result.[Score]
    Into output
    From subquery
```

Рассмотрим конфигурацию, необходимую для создания Stream Analytics задания, которое тональности анализ твитов с частотой 10 000 твитов в секунду.

При использовании 1 SU это Stream Analytics может обработать трафик? Задание может учитывать входные данные, используя размер пакета по умолчанию 1000. По умолчанию задержка анализа тональности Машинное обучение веб-службы (с размером пакета по умолчанию 1000) создает не более секунды задержки.

**Общая** (сквозная) задержка задания Stream Analytics обычно составляет несколько секунд. Изучите это задание Stream Analytics более подробно, *особенно* вызовы функций машинного обучения. Если размер пакета составляет 1000, пропускная способность 10 000 событий занимает около 10 запросов к веб-службе. Даже при одной единице хранения количество одновременных подключений будет достаточным для обработки этого входящего трафика.

Но что делать, если частота входящих событий увеличится в 100 раз, а задание Stream Analytics должно обрабатывать 1 000 000 твитов в секунду? Выполнить увеличения масштаба можно двумя способами.

1. Увеличьте размер пакета.
2. Разбейте входной поток для параллельной обработки событий.

Если выбрать первый вариант, то увеличится **задержка** задания.

Во втором варианте потребуется подготавливать дополнительные службы SUs, чтобы обеспечить более параллельное Машинное обучение запросов к веб-службе. Это большее количество служб SUs увеличивает **стоимость**работы.

Рассмотрим масштабирование, используя следующие измерения задержки для каждого размера пакета:

| Задержка | Размер пакета |
| --- | --- |
| 200 мс | 1000 — пакеты событий или ниже |
| 250 мс | 5 000 — пакеты событий |
| 300 мс | 10 000 — пакеты событий |
| 500 мс | 25 000 — пакеты событий |

1. Использование первого варианта (**без** подготовки дополнительных единиц SU). Размер пакета можно увеличить до **25 000**. Если увеличить размер пакета таким образом, задание будет обрабатывать 1 000 000 событий с 20 одновременными подключениями к Машинное обучение веб-службе (с задержкой 500 мс на вызов). Поэтому дополнительная задержка задания Stream Analytics (из-за того, что функция анализа мнений выполняет запросы к веб-службе машинного обучения) увеличится с **200** до **500 мс**. Однако размер пакета **не может** быть увеличен бесконечно, так как веб-службы машинное обучение требуют, чтобы размер полезных данных запроса был не менее 4 МБ, а время ожидания запросов веб-службы после 100 секунд операции истекло.
1. Если используется второй вариант, то размер пакета остается неизменным (1000) и при задержке веб-службы в 200 мс каждые 20 одновременных подключений к веб-службе смогут обрабатывать 1000 * 20 * 5 событий, то есть 100 000 событий в секунду. Таким образом, для обработки 1 000 000 событий в секунду заданию потребуется 60 SU. По сравнению с первым вариантом задание Stream Analytics будет создавать больше пакетных запросов к веб-службе, что приведет к увеличению затрат.

Ниже приведена таблица пропускной способности (количества событий в секунду) задания Stream Analytics для разного количества SU и размеров пакета.

| Размер пакета (задержка службы машинного обучения) | 500 (200 мс) | 1000 (200 мс) | 5000 (250 мс) | 10 000 (300 мс) | 25 000 (500 мс) |
| --- | --- | --- | --- | --- | --- |
| **1 единица хранения** |2500 |5 000 |20 000 |30 000 |50 000 |
| **3 единицы хранения** |2500 |5 000 |20 000 |30 000 |50 000 |
| **6 единиц хранения** |2500 |5 000 |20 000 |30 000 |50 000 |
| **12 единиц хранения** |5 000 |10 000 |40 000 |60 000 |100 000 |
| **18 единиц хранения** |7500 |15 000 |60 000 |90 000 |150 000 |
| **24 единицы хранения** |10 000 |20 000 |80 000 |120 000 |200 000 |
| **…** |… |… |… |… |… |
| **60 единиц хранения** |25 000 |50 000 |200 000 |300 000 |500 000 |

Теперь у вас есть четкое представление о том, как работают функции машинного обучения в Stream Analytics. Скорее всего, вы также знаете, что задания Stream Analytics извлекают данные из источников данных и каждая операция извлечения возвращает пакет событий, которые обрабатывает задание Stream Analytics. Каким образом эта модель извлечения данных влияет на запросы к веб-службе машинного обучения?

Как правило, размер пакета, заданный для функций машинного обучения, не делится точно на количество событий, возвращаемых каждой операцией извлечения, которую выполняет задание Stream Analytics. Когда это происходит, веб-служба машинного обучения вызывается с помощью "частичных" пакетов. Использование частичных пакетов позволяет избежать дополнительных затрат на задержку заданий в процессе объединения событий из Pull в Pull.

## <a name="new-function-related-monitoring-metrics"></a>Новые метрики мониторинга, связанные с функциями
В области мониторинга задания Stream Analytics добавлены три дополнительные метрики, связанные с функциями. Они представляют собой **запросы функций**, **события функций** и **запросы функций, завершившиеся сбоем**, как показано на рисунке ниже.

![Масштабирование Stream Analytics с помощью метрик Машинное обучениеных функций](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-01.png "Метрики масштабирования Stream Analytics с помощью функций машинного обучения")

Вот их определения:

**Запросы функций**— количество запросов функций.

**События функций**— количество событий в запросах функций.

**Запросы функций со сбоем**— количество запросов функций, завершившихся сбоем.

## <a name="key-takeaways"></a>Общие выводы

Чтобы масштабировать задание Stream Analytics с помощью Машинное обучениеных функций, учитывайте следующие факторы.

1. Частота входных событий.
2. Допустимая задержка для выполняемого задания Stream Analytics (и, таким же, размер пакета для запросов веб-службы Машинное обучение).
3. Подготовленный Stream Analytics службы SUs и количество запросов Машинное обучение веб-служб (дополнительные затраты, связанные с функциями).

В качестве примера был использован полностью секционированный запрос Stream Analytics. Если требуется более сложный запрос, посетите [форум Azure Stream Analytics](https://social.msdn.microsoft.com/Forums/azure/home?forum=AzureStreamAnalytics). Это превосходный ресурс, на котором можно получить дополнительные сведения от разработчиков Stream Analytics.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о службе Stream Analytics см. в следующих статьях:

* [Приступая к работе с Azure Stream Analytics](stream-analytics-real-time-fraud-detection.md)
* [Масштабирование заданий в службе Azure Stream Analytics](stream-analytics-scale-jobs.md)
* [Справочник по языку запросов Azure Stream Analytics](https://docs.microsoft.com/stream-analytics-query/stream-analytics-query-language-reference)
* [Справочник по API-интерфейсу REST управления Stream Analytics](https://msdn.microsoft.com/library/azure/dn835031.aspx)
