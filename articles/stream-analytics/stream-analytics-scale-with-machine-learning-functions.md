---
title: Масштабирование функций службы "Машинное обучение" в Azure Stream Analytics
description: Из этой статьи вы узнаете, как масштабировать задания Stream Analytics, для которых используются функции службы "Машинное обучение", настроив секционирование и единицы потоковой передачи.
author: jseb225
ms.author: jeanb
ms.reviewer: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 03/16/2020
ms.openlocfilehash: 5b08625d055063b3804a35a3344ff01c7edb79de
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80067003"
---
# <a name="scale-your-stream-analytics-job-with-azure-machine-learning-studio-classic-functions"></a>Масштабируйте работу Stream Analytics с помощью функций Azure Machine Learning Studio (классические)

> [!TIP]
> Настоятельно рекомендуется использовать [UDF-аппараты Azure Machine Learning](machine-learning-udf.md) вместо Azure Machine Learning Studio (классический) UDF для повышения производительности и надежности.

В этой статье рассказывается о том, как эффективно масштабировать рабочие места Azure Stream Analytics, в использовании функций машинного обучения Azure. Общие сведения о масштабировании заданий Stream Analytics см. в статье [Масштабирование заданий](stream-analytics-scale-jobs.md).

## <a name="what-is-an-azure-machine-learning-function-in-stream-analytics"></a>Что такое функция машинного обучения Azure в Stream Analytics?

Функция машинного обучения в Stream Analytics может использоваться как обычный вызов функции в языке запросов Stream Analytics. За кулисами, однако, эти вызовы функции на самом деле Azure машинного обучения веб-службы запросов.

Вы можете улучшить пропускную стоимость запросов веб-службы машинного обучения, "смешав" несколько строк вместе в одном и том же вызове API веб-службы. Эта группировка называется мини-пакет. Для получения дополнительной [Azure Machine Learning Studio (classic) Web Services](../machine-learning/studio/consume-web-services.md)информации см. Поддержка студии машинного обучения Azure (классическая) в Stream Analytics находится в предварительном просмотре.

## <a name="configure-a-stream-analytics-job-with-machine-learning-functions"></a>Настройка задания Stream Analytics с помощью функций машинного обучения

Существует два параметра для настройки функции машинного обучения, используемой задачей Stream Analytics:

* Размер пакета функции машинного обучения вызывает.
* Количество потоковых единиц (SUs), подготовленных для работы Stream Analytics.

Чтобы определить соответствующие значения для SUs, решите, хотите ли вы оптимизировать задержку задания Stream Analytics или пропускную стоимость каждого SU. SUs всегда могут быть добавлены к заданиям для увеличения пропускной всей пропускной выдавливания хорошо разделенного запроса Stream Analytics. Дополнительные SUs увеличивают стоимость выполнения задания.

Определите *допуск* задержки для работы Stream Analytics. Увеличение размера партии увеличит задержку запросов на машинное обучение Azure и задержку задания Stream Analytics.

Увеличение размера пакета позволяет работе Stream Analytics обрабатывать **больше событий** с тем же количеством запросов веб-службы машинного **обучения.** Увеличение задержки веб-службы машинного обучения обычно подлинейно к увеличению размера партии. 

Важно учитывать наиболее экономичный размер партии для веб-сервиса машинного обучения в любой ситуации. Размер пакета по умолчанию для запросов веб-службы составляет 1000. Вы можете изменить этот размер по умолчанию с помощью [Stream Analytics REST API](https://docs.microsoft.com/previous-versions/azure/mt653706(v=azure.100) "REST API Stream Analytics") или [клиента PowerShell для Stream Analytics.](stream-analytics-monitor-and-manage-jobs-use-powershell.md)

После того как вы определились с размером пакета, можно установить количество потоковых единиц (SUs), основываясь на количестве событий, которые функция должна обрабатывать в секунду. Дополнительные сведения о единицах потоковой передачи см. в статье [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности базы данных](stream-analytics-scale-jobs.md).

Каждые 6 SUs получают 20 одновременных подключений к веб-сервису Machine Learning. Тем не менее, 1 SU рабочих мест и 3 SU рабочих мест получить 20 одновременных соединений.  

Если ваше приложение генерирует 200 000 событий в секунду, а размер партии составляет 1000, то задержка веб-службы составляет 200 мс. Эта ставка означает, что каждое соединение может делать пять запросов в веб-сервис Машинного обучения каждую секунду. С 20 соединениями задание Stream Analytics может обрабатывать 20 000 событий в 200 мс и 100 000 событий в секунду.

Для обработки 200 000 событий в секунду задания Stream Analytics требуется 40 одновременных подключений, которые выходят на 12 SUs. На следующей схеме показан запрос из задания Stream Analytics к конечной точке веб-службы машинного обучения. На каждые 6 SU приходится не более 20 одновременных подключений к веб-службе машинного обучения.

![Масштабная аналитика потока с функциями машинного обучения два примера задания](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-00.png "Масштабная аналитика потока с функциями машинного обучения два примера задания")

В общем случае, если ***B*** — размер пакета, а ***L*** — задержка веб-службы при размере пакета B в миллисекундах, то пропускная способность задания Stream Analytics с ***N*** SU будет составлять:

![Формула масштабирования Stream Analytics с помощью функций машинного обучения](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-02.png "Формула масштабирования Stream Analytics с помощью функций машинного обучения")

Вы также можете настроить "максимальные параллельные вызовы" на веб-сервисе Машинного обучения. Этот параметр рекомендуется установить до максимального значения (200 в настоящее время).

Дополнительные сведения об этом параметре см. в статье [Масштабирование веб-службы машинного обучения](../machine-learning/studio/scaling-webservice.md).

## <a name="example--sentiment-analysis"></a>Пример: анализ мнений
В следующем примере показано задание Stream Analytics с функцией машинного обучения для анализа мнений, как описано в руководстве [Общие сведения о Stream Analytics и интеграции машинного обучения](stream-analytics-machine-learning-integration-tutorial.md).

Запрос представляет собой простой полностью секционированный запрос, за которым следует функция **sentiment**, как показано в следующем примере:

```SQL
    WITH subquery AS (
        SELECT text, sentiment(text) as result from input
    )

    Select text, result.[Score]
    Into output
    From subquery
```

Рассмотрим конфигурацию, необходимую для создания задания Stream Analytics, которое делает анализ настроений твитов со скоростью 10 000 твитов в секунду.

Используя 1 SU, может ли эта работа Stream Analytics обрабатывать трафик? Задание может идти в ногу с входной, используя размер партии по умолчанию 1000. Задержка анализа настроений веб-сервиса Machine Learning (с размером партии по умолчанию 1000) создает не более секунды задержки.

Общая или **сквозная** задержка задания Stream Analytics обычно составит несколько секунд. Изучите это задание Stream Analytics более подробно, *особенно* вызовы функций машинного обучения. С размером партии 1000, пропускная часть 10000 событий занимает около 10 запросов на веб-службу. Даже при одной единице хранения количество одновременных подключений будет достаточным для обработки этого входящего трафика.

Но что делать, если частота входящих событий увеличится в 100 раз, а задание Stream Analytics должно обрабатывать 1 000 000 твитов в секунду? Выполнить увеличения масштаба можно двумя способами.

1. Увеличьте размер партии.
2. Раздел потока ввода для параллельной обработки событий.

Если выбрать первый вариант, то увеличится **задержка** задания.

Со вторым вариантом, вам придется предоставить больше SUs, чтобы иметь более одновременные запросы веб-службы машинного обучения. Это большее количество SUs, увеличивает **стоимость**работы.

Давайте посмотрим на масштабирование, используя следующие измерения задержки для каждого размера партии:

| Задержка | Размер пакета |
| --- | --- |
| 200 мс | 1000-событие пакетов или ниже |
| 250 мс | 5000-событийных пакетов |
| 300 мс | 10 000-событийных пакетов |
| 500 мс | 25 000 пакетов событий |

1. Использование первого варианта (**без** подготовки дополнительных единиц SU). Размер пакета можно увеличить до **25 000**. Увеличение размера партии таким образом позволит заданиям обрабатывать 1 000 000 событий с 20 одновременнымподключением подключением к веб-сервису Machine Learning (с задержкой 500 мс за звонок). Поэтому дополнительная задержка задания Stream Analytics (из-за того, что функция анализа мнений выполняет запросы к веб-службе машинного обучения) увеличится с **200** до **500 мс**. Тем не менее, размер партии **не может** быть увеличен бесконечно, так как веб-службы Machine Learning требуют, чтобы размер полезной нагрузки запроса был 4 МБ или меньше, а веб-служба запрашивает тайм-аут после 100 секунд работы.
1. Если используется второй вариант, то размер пакета остается неизменным (1000) и при задержке веб-службы в 200 мс каждые 20 одновременных подключений к веб-службе смогут обрабатывать 1000 * 20 * 5 событий, то есть 100 000 событий в секунду. Таким образом, для обработки 1 000 000 событий в секунду заданию потребуется 60 SU. По сравнению с первым вариантом задание Stream Analytics будет создавать больше пакетных запросов к веб-службе, что приведет к увеличению затрат.

Ниже приведена таблица пропускной способности (количества событий в секунду) задания Stream Analytics для разного количества SU и размеров пакета.

| Размер пакета (задержка службы машинного обучения) | 500 (200 мс) | 1000 (200 мс) | 5000 (250 мс) | 10 000 (300 мс) | 25 000 (500 мс) |
| --- | --- | --- | --- | --- | --- |
| **1 ЕП** |2500 |5 000 |20 000 |30 000 |50 000 |
| **3 SU** |2500 |5 000 |20 000 |30 000 |50 000 |
| **6 SU** |2500 |5 000 |20 000 |30 000 |50 000 |
| **12 SU** |5 000 |10 000 |40 000 |60 000 |100 000 |
| **18 SU** |7500 |15 000 |60 000 |90 000 |150 000 |
| **24 SU** |10 000 |20 000 |80 000 |120 000 |200 000 |
| **…** |… |… |… |… |… |
| **60 SU** |25 000 |50 000 |200 000 |300 000 |500 000 |

Теперь у вас есть четкое представление о том, как работают функции машинного обучения в Stream Analytics. Скорее всего, вы также знаете, что задания Stream Analytics извлекают данные из источников данных и каждая операция извлечения возвращает пакет событий, которые обрабатывает задание Stream Analytics. Каким образом эта модель извлечения данных влияет на запросы к веб-службе машинного обучения?

Как правило, размер пакета, который мы устанавливаем для функций машинного обучения, точно не будет разденам по количеству событий, возвращенных каждой работой Stream Analytics, "тянуть". Когда это происходит, веб-служба машинного обучения вызывается с помощью "частичных" пакетов. Использование частичных пакетов позволяет избежать дополнительных накладных расходов на задержку в объединении событий от тянуть к тянуть.

## <a name="new-function-related-monitoring-metrics"></a>Новые метрики мониторинга, связанные с функциями
В области мониторинга задания Stream Analytics добавлены три дополнительные метрики, связанные с функциями. Они **ФУНКЦИЯ ЗАПРОС,** **ФУНКЦИЯ EVENTS** и **FAILED ФУНКЦИЯ ЗАПРОСЫ**, как показано на рисунке ниже.

![Метрики масштабирования Stream Analytics с помощью функций машинного обучения](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-01.png "Метрики масштабирования Stream Analytics с помощью функций машинного обучения")

Вот их определения:

**Запросы функций**— количество запросов функций.

**События функций**— количество событий в запросах функций.

**Запросы функций со сбоем**— количество запросов функций, завершившихся сбоем.

## <a name="key-takeaways"></a>Общие выводы

Для масштабирования работы Stream Analytics с функциями машинного обучения рассмотрим следующие факторы:

1. Скорость ввода событий.
2. Допустимая задержка для выполнения работы Stream Analytics (и, таким образом, размер пакета запросов веб-сервиса Machine Learning).
3. Подготовленные SUs Stream Analytics и количество запросов веб-сервиса машинного обучения (дополнительные затраты, связанные с функциями).

В качестве примера был использован полностью секционированный запрос Stream Analytics. Если требуется более сложный запрос, посетите [форум Azure Stream Analytics](https://social.msdn.microsoft.com/Forums/azure/home?forum=AzureStreamAnalytics). Это превосходный ресурс, на котором можно получить дополнительные сведения от разработчиков Stream Analytics.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о службе Stream Analytics см. в следующих статьях:

* [Начало использования аналитики потоков Azure](stream-analytics-real-time-fraud-detection.md)
* [Масштабирование заданий в службе Azure Stream Analytics](stream-analytics-scale-jobs.md)
* [Справочник по языку запросов Azure Stream Analytics](https://docs.microsoft.com/stream-analytics-query/stream-analytics-query-language-reference)
* [Справочник по API-интерфейсу REST управления Stream Analytics](https://msdn.microsoft.com/library/azure/dn835031.aspx)
