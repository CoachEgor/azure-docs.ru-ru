---
title: Настройка политик и заказов событий для аналитики потоков Azure
description: В этой статье описывается, как настроить даже настройки заказа в Stream Analytics
author: sidram
ms.author: sidram
ms.reviewer: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 03/12/2019
ms.openlocfilehash: c0a108565a6a0f62c6252113f984e8b10967c5db
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75461194"
---
# <a name="configuring-event-ordering-policies-for-azure-stream-analytics"></a>Настройка политик и заказов событий для аналитики потоков Azure

В этой статье описывается, как настроить и использовать политики событий с поздним поперечное и неупорядоченное в Azure Stream Analytics. Эти политики применяются только при использовании положения [TIMESTAMP BY](https://docs.microsoft.com/stream-analytics-query/timestamp-by-azure-stream-analytics) в запросе.

## <a name="event-time-and-arrival-time"></a>Время событий и время прибытия

Задание Stream Analytics может обрабатывать события на основе *времени события* или *времени прибытия.* **Время события/приложения** — это метка времени, присутствуюая в полезной нагрузке события (когда событие было сгенерировано). **Время прибытия** — это метка времени, когда событие было получено в источнике ввода (Концентратор ы событий/хранилище IoT Hub/Blob). 

По умолчанию Stream Analytics обрабатывает события по *времени прибытия,* но вы можете обрабатывать события по *времени событий,* используя в запросе пункт [TIMESTAMP BY.](https://docs.microsoft.com/stream-analytics-query/timestamp-by-azure-stream-analytics) Политики позднего прибытия и вне порядка применимы только в том случае, если вы обрабатываете события по времени событий. Настраивать эти параметры следует в соответствии с требованиями к задержке и правильности для вашего сценария. 

## <a name="what-is-late-arrival-policy"></a>What is late arrival policy? (Что собой представляет политика для событий, сведения о которых поступают с задержкой?)

Иногда события приходят поздно из-за различных причин. Например, событие, которое прибывает на 40 секунд позже, будет иметь время события - 00:10:00 и время прибытия - 00:10:40. Если вы установите политику позднего прибытия до 15 секунд, любое событие, которое прибудет позже 15 секунд, либо будет удалено (не обработано Stream Analytics), либо скорректировано их время событий. В приведенном выше примере, когда событие прибыло на 40 секунд позже (больше, чем установлено политики), время его события будет скорректировано до максимального срока политики позднего прибытия 00:10:25 (время прибытия - значение полиса позднего прибытия). По умолчанию политика позднего прибытия составляет 5 секунд.

## <a name="what-is-out-of-order-policy"></a>Что такое политика вне заказа? 

Событие также может выйти из строя. После корректировки времени события в зависимости от политики позднего прибытия можно автоматически отбросить или настроить события, которые не заказываются. Если вы установите эту политику до 8 секунд, любые события, которые приходят из строя, но в течение 8-секундного окна, переупорядочены по времени события. События, которые поступят позже, будут либо удалены, либо скорректированы с максимальной оценкой политики, не показываюй. Политика неупорядоченного исполнения по умолчанию составляет 0 секунд. 

## <a name="adjust-or-drop-events"></a>Настройка или удаление событий

Если события приходят с опозданием или не запорядком на основе настроенных политик, можно либо отказаться от таких событий (не обработанных Stream Analytics), либо скорректировать время событий.

Давайте посмотрим пример такой политики в действии.
<br> **Политика позднего прибытия:** 15 секунд
<br> **Политика вне порядка:** 8 секунд

| Номер события | Время события | Время получения | System.Timestamp | Объяснение |
| --- | --- | --- | --- | --- |
| **1** | 00:10:00  | 00:10:40  | 00:10:25  | Событие прибыло поздно и за пределами уровня толерантности. Таким образом, время событий корректируется с максимальной допуском позднего прибытия.  |
| **2** | 00:10:30 | 00:10:41  | 00:10:30  | Событие прибыло поздно, но в пределах уровня толерантности. Таким образом, время событий не налажаться.  |
| **3** | 00:10:42 | 00:10:42 | 00:10:42 | Событие прибыло вовремя. Корректировка не требуется.  |
| **4** | 00:10:38  | 00:10:43  | 00:10:38 | Событие произошло не по порядку, но в пределах 8 секунд. Таким образом, время событий не корректируется. Для целей аналитики это событие будет рассматриваться как предыдущее событие номер 4.  |
| **5** | 00:10:35 | 00:10:45  | 00:10:37 | Событие произошло не по порядку и за пределами допуска 8 секунд. Таким образом, время событий корректируется с максимальной допуском вне порядка. |

## <a name="can-these-settings-delay-output-of-my-job"></a>Могут ли эти параметры задерживать выход моей работы? 

Да. По умолчанию политика из-за порядка установлена до нуля (00 минут и 00 секунд). При изменении значения по умолчанию первый вывод вашей задания задерживается на это значение (или больше). 

Если один из разделов входных данных не получает событий, следует ожидать, что ваш вывод будет отложен из-за значения политики позднего прибытия. Чтобы узнать, почему, прочитайте раздел ошибки Ввода ниже. 

## <a name="i-see-lateinputevents-messages-in-my-activity-log"></a>Я вижу сообщения LateInputEvents в журнале действий

Эти сообщения, как показано, сообщают вам, что события прибыли с опозданием и либо отброшены, либо скорректированы в соответствии с вашей конфигурацией. Вы можете проигнорировать эти сообщения, если вы соответствующим образом настроили политику позднего прибытия. 

Примером этого сообщения является: <br>
<code>
{"message Time":"2019-02-04 17:11:52Z","error":null,
"message":"First Occurred: 02/04/2019 17:11:48 | Resource Name: ASAjob | Message: Source 'ASAjob' had 24 data errors of kind 'LateInputEvent' between processing times '2019-02-04T17:10:49.7250696Z' and '2019-02-04T17:11:48.7563961Z'. Input event with application timestamp '2019-02-04T17:05:51.6050000' and arrival time '2019-02-04T17:10:44.3090000' was sent later than configured tolerance.","type":"DiagnosticMessage","correlation ID":"49efa148-4asd-4fe0-869d-a40ba4d7ef3b"} 
</code>

## <a name="i-see-inputpartitionnotprogressing-in-my-activity-log"></a>Я вижу InputPartitionNotProgressing в моем журнале активности

Ваш источник ввода (Event Hub/IoT Hub), вероятно, имеет несколько разделов. Azure Stream Analytics производит выход для штампа времени t1 только после того, как все разделы, которые объединены, по крайней мере, в то время t1. Например, предположим, что запрос выполняет чтение из секции концентратора событий с двумя разделами. В одном из разделов, P1, есть события до времени t1. В одном из разделов, P2, есть события до времени t1 + x. В таком случае выходные данные выводятся до времени t1. Однако, если явно указано предложение разделения по PartitionId, оба раздела работают независимо друг от друга. 

Когда объединяются несколько разделов из одного и того же входного потока, допуск позднего прибытия — это максимальное количество времени, которое каждый раздел ждет новых данных. Если в концентраторе событий есть одна часть или если Концентратор IoT не получает входных данных, то шкала времени для этого раздела не выполняется до тех пор, пока не достигнет порога допуска к концу прибытия. Это задерживает выход порога допуска к позднему прибытию. В таких случаях вы можете увидеть следующее сообщение:
<br><code>
{"message Time":"2/3/2019 8:54:16 PM UTC","message":"Input Partition [2] does not have additional data for more than [5] minute(s). Partition will not progress until either events arrive or late arrival threshold is met.","type":"InputPartitionNotProgressing","correlation ID":"2328d411-52c7-4100-ba01-1e860c757fc2"} 
</code><br><br>
Это сообщение, чтобы сообщить вам, что по крайней мере один раздел в входе пуст и задержит выход на пороге позднего прибытия. Чтобы преодолеть это, рекомендуется либо:  
1. Убедитесь, что все разделы вашего концентратора событий/IoT получают входные устройства. 
2. Используйте раздел по положению Разделитив идентификатора в запросе. 

## <a name="next-steps"></a>Дальнейшие действия
* [Рекомендации по распределению времени](stream-analytics-time-handling.md)
* [Метрики, доступные в Stream Analytics](https://docs.microsoft.com/azure/stream-analytics/stream-analytics-monitoring#metrics-available-for-stream-analytics)
