---
title: Интеграция аналитики потоков Azure с помощью машинного обучения Azure
description: В этой статье описывается, как интегрировать работу Azure Stream Analytics с моделями машинного обучения Azure.
author: sidram
ms.author: sidram
ms.reviewer: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 03/19/2020
ms.openlocfilehash: 07fa72f086b676723279ee4b8efd927beb2692f0
ms.sourcegitcommit: b55d7c87dc645d8e5eb1e8f05f5afa38d7574846
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81481969"
---
# <a name="integrate-azure-stream-analytics-with-azure-machine-learning-preview"></a>Интеграция аналитики потоков Azure с помощью машинного обучения Azure (Предварительный просмотр)

Модели машинного обучения можно реализовать в качестве функции, определяемой пользователями (UDF) в заданиях Azure Stream Analytics, для выполнения подсчетов и прогнозов в режиме реального времени на ваших потоковых входных данных. [Azure Machine Learning](../machine-learning/overview-what-is-azure-ml.md) позволяет использовать любой популярный инструмент с открытым исходным кодом, такой как Tensorflow, scikit-learn или PyTorch, для подготовки, обучения и развертывания моделей.

> [!NOTE]
> Эта функциональность находится в открытом предварительном просмотре. Вы можете получить доступ к этой функции на портале Azure только с помощью [ссылки предварительного просмотра портала Stream Analytics.](https://aka.ms/asaportalpreview) Эта функциональность также доступна в последней версии [инструментов Stream Analytics для Visual Studio.](https://docs.microsoft.com/azure/stream-analytics/stream-analytics-tools-for-visual-studio-install)

## <a name="prerequisites"></a>Предварительные требования

Выполните следующие шаги перед добавлением модели машинного обучения в качестве функции для выполнения задания Stream Analytics:

1. Используйте Машинное обучение Azure для [развертывания модели в качестве веб-службы.](https://docs.microsoft.com/azure/machine-learning/how-to-deploy-and-where)

2. Ваш скоринговый скрипт должен иметь [пример входов и выходов,](../machine-learning/how-to-deploy-and-where.md#example-entry-script) который используется Azure Machine Learning для создания спецификации схемы. Stream Analytics использует схему, чтобы понять подпись функции вашего веб-сервиса.

3. Убедитесь, что веб-сервис принимает и возвращает серийные данные JSON.

4. Развертывание модели в [службе Azure Kubernetes](../machine-learning/how-to-deploy-and-where.md#choose-a-compute-target) для крупномасштабных производственных развертываний. Если веб-служба не в состоянии обрабатывать количество запросов, поступающих от вашей работы, производительность вашей работы Stream Analytics будет ухудшаться, что влияет на задержку. Модели, развернутые в контейнерных инстанциях Azure, сегодня не поддерживаются, но станут доступны в ближайшие месяцы.

## <a name="add-a-machine-learning-model-to-your-job"></a>Добавление модели машинного обучения в работу

Функции машинного обучения Azure можно добавить в работу Stream Analytics непосредственно с портала Azure.

1. Перейдите к работе Stream Analytics на портале Azure и выберите **функции** в **топологии вакансий.** Затем выберите **службу Azure ML** из меню **«Добавить** выпадающие средства».

   ![Добавить Azure ML UDF](./media/machine-learning-udf/add-azureml-udf.png)

2. Заполните **форму функции службы машинного обучения Azure** со следующими значениями свойств:

   ![Настройка Azure ML UDF](./media/machine-learning-udf/configure-azureml-udf.png)

В следующей таблице описано каждое свойство функций службы Azure ML в Stream Analytics.

|Свойство|Описание|
|--------|-----------|
|Псевдоним функции|Введите имя для ввода функции в запросе.|
|Подписка|Ваша подписка На Azure.|
|Рабочее пространство Azure ML|Рабочее пространство Azure Machine Learning, используемое для развертывания модели в качестве веб-службы.|
|Развернутые приложения|Веб-сервис, худающая вашей моделью.|
|Сигнатура функции|Подпись вашего веб-сервиса, выведенная из спецификации схемы API. Если ваша подпись не загружается, проверьте, что вы предоставили вход ный образец и вывод в скрипте скоринга, чтобы автоматически генерировать схему.|
|Количество параллельных запросов на раздел|Это передовая конфигурация для оптимизации высокомасштабной пропускной связи. Это число представляет собой одновременные запросы, отправленные с каждого раздела вашей работы в веб-службу. Вакансии с шестью потоковыми единицами (SU) и более низкими имеют одну раздел. Вакансии с 12 SUs имеют два перегородки, 18 SUs имеют три перегородки и так далее.<br><br> Например, если ваша работа состоит из двух разделов и вы установите этот параметр до четырех, будет восемь одновременных запросов от вашей работы к веб-службе. На данный момент публичного предварительного просмотра это значение по умолчанию до 20 и не может быть обновлено.|
|Максимальное количество пакетов|Это передовая конфигурация для оптимизации высокомасштабной пропускной связи. Это число представляет собой максимальное количество событий, упакованных вместе в одном запросе, отправленном на веб-службу.|

## <a name="supported-input-parameters"></a>Поддерживаемые параметры ввода

Когда ваш запрос Stream Analytics вызывает UDF для машинного обучения Azure, задания создает серийный запрос JSON на веб-службу. Запрос основан на схеме, ориентированной на конкретную модель. Для [автоматического создания схемы](../machine-learning/how-to-deploy-and-where.md)необходимо обеспечить вход и выход образца в скрипте скоринга. Схема позволяет Stream Analytics построить серийный запрос JSON для любого из поддерживаемых типов данных, таких как numpy, панды и PySpark. Несколько событий ввода могут быть упакованы вместе в одном запросе.

Следующий запрос Stream Analytics является примером того, как вызвать UDF машинного обучения Azure:

```SQL
SELECT udf.score(<model-specific-data-structure>)
INTO output
FROM input
```

Stream Analytics поддерживает только прохождение одного параметра для функций машинного обучения Azure. Возможно, вам придется подготовить свои данные, прежде чем передать их в качестве ввода в машинное обучение UDF.

## <a name="pass-multiple-input-parameters-to-the-udf"></a>Передайте несколько параметров ввода в UDF

Наиболее распространенными примерами входных данных в модели машинного обучения являются numpy массивы и DataFrames. Вы можете создать массив с помощью JavaScript UDF и создать серийный DataFrame с помощью `WITH` этого положения.

### <a name="create-an-input-array"></a>Создание массива ввода

Можно создать JavaScript UDF, который принимает *N* количество входов и создает массив, который может быть использован в качестве ввода в ашего UDF azure Machine Learning.

```javascript
function createArray(vendorid, weekday, pickuphour, passenger, distance) {
    'use strict';
    var array = [vendorid, weekday, pickuphour, passenger, distance]
    return array;
}
```

После добавления UdF JavaScript в работу можно вызвать UDF машинного обучения Azure, используя следующий запрос:

```SQL
SELECT udf.score(
udf.createArray(vendorid, weekday, pickuphour, passenger, distance)
)
INTO output
FROM input
```

Следующий JSON является примером запроса:

```JSON
{
    "data": [
        ["1","Mon","12","1","5.8"],
        ["2","Wed","10","2","10"]
    ]
}
```

### <a name="create-a-pandas-or-pyspark-dataframe"></a>Создание панд или PySpark DataFrame

Это `WITH` положение можно использовать для создания сериального DataFrame, который можно передавать в качестве ввода в UDF для машинного обучения Azure, как показано ниже.

Следующий запрос создает DataFrame, выбирая необходимые поля, и использует DataFrame в качестве ввода в UDF машинного обучения Azure.

```SQL
WITH 
Dataframe AS (
SELECT vendorid, weekday, pickuphour, passenger, distance
FROM input
)

SELECT udf.score(Dataframe)
INTO output
FROM input
```

Следующий запрос JSON — это пример запроса из предыдущего запроса:

```JSON
{
    "data": [{
            "vendorid": "1",
            "weekday": "Mon",
            "pickuphour": "12",
            "passenger": "1",
            "distance": "5.8"
        }, {
            "vendorid": "2",
            "weekday": "Tue",
            "pickuphour": "10",
            "passenger": "2",
            "distance": "10"
        }
    ]
}
```

## <a name="optimize-the-performance-for-azure-machine-learning-udfs"></a>Оптимизация производительности для UDF-систем ы машинного обучения Azure

При развертывании модели в службе Azure Kubernetes можно [профилировать модель для определения использования ресурсов.](../machine-learning/how-to-deploy-and-where.md#profilemodel) Вы также [можете включить App Insights для развертывания,](../machine-learning/how-to-enable-app-insights.md) чтобы понять скорость запросов, время отклика и коэффициенты сбоев.

Если у вас есть сценарий с высокой пропускной способностью событий, возможно, потребуется изменить следующие параметры в Stream Analytics для достижения оптимальной производительности с низкимсквозь концем запаздываний:

1. Количество макс-пакетов.
2. Количество параллельных запросов на раздел.

### <a name="determine-the-right-batch-size"></a>Определение правильного размера партии

После развертывания веб-службы вы отправляете запрос на образец с различными размерами партий, начиная с 50 и увеличивая его в сотни. Например, 200, 500, 1000, 2000 и так далее. Вы заметите, что после определенного размера партии задержка ответа увеличивается. Точка, после которой задержка ответа увеличивается должно быть максимальное количество пакетов для вашей работы.

### <a name="determine-the-number-of-parallel-requests-per-partition"></a>Определить количество параллельных запросов на раздел

При оптимальном масштабировании работа Stream Analytics должна быть в состоянии отправлять несколько параллельных запросов на веб-службу и получать ответ в течение нескольких миллисекунд. Задержка в ответе веб-службы может непосредственно повлиять на задержку и производительность работы Stream Analytics. Если звонок с работы в веб-службу занимает много времени, вы, скорее всего, увидите увеличение задержки водяного знака, а также может привести к увеличению числа невыполненных событий ввода.

Чтобы предотвратить такую задержку, убедитесь, что кластер Azure Kubernetes Service (AKS) был подготовлен с [нужным числом узлов и реплик.](../machine-learning/how-to-deploy-azure-kubernetes-service.md#using-the-cli) Очень важно, чтобы ваш веб-сервис был очень доступен и возвращал успешные ответы. Если ваша работа получает недоступный ответ службы (503) от вашего веб-сервиса, она будет постоянно try with exponential back off. Любой ответ, кроме успеха (200) и недоступного сервиса (503), приведет к тому, что ваша работа передастся в несостоявшееся состояние.

## <a name="next-steps"></a>Следующие шаги

* [Руководство. Пользовательские функции JavaScript Azure Stream Analytics](stream-analytics-javascript-user-defined-functions.md)
* [Масштабируйте работу Stream Analytics с помощью функции Azure Machine Learning Studio (классическая)](stream-analytics-scale-with-machine-learning-functions.md)

