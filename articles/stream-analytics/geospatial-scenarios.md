---
title: Геофенсирование и геопространственная агрегация с Azure Stream Analytics
description: В этой статье описывается, как использовать Аналитику потоков Azure для геофенцирования и геопространственной агрегации.
author: mamccrea
ms.author: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 04/02/2019
ms.openlocfilehash: 5a3aa3786469c3df37b53cb82bdd396871689297
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75443640"
---
# <a name="geofencing-and-geospatial-aggregation-scenarios-with-azure-stream-analytics"></a>Сценарии геопространственного и геопространственного агрегирования с Azure Stream Analytics

Благодаря встроенным геопространственным функциям можно использовать Azure Stream Analytics для создания приложений для таких сценариев, как управление автопарком, совместное использование аттракционов, подключенные автомобили и отслеживание активов.

## <a name="geofencing"></a>Геозоны

Azure Stream Analytics поддерживает вычисления с низкой задержкой в режиме реального времени в области geofencing в облаке и в режиме выполнения IoT Edge.

### <a name="geofencing-scenario"></a>Сценарий geofencing

Производственная компания должна отслеживать активы на своих зданиях. Они оснастили каждое устройство GPS и хотят получать уведомления, если устройство покидает определенную область.

Справочные данные, используемые в этом примере, имеют геозаборную информацию для зданий и устройств, разрешенных в каждом из зданий. Помните, что справочные данные могут быть либо статичными, либо медленными. Для этого сценария используются статические справочные данные. Поток данных непрерывно излучает идентификатор устройства и его текущее положение.

### <a name="define-geofences-in-reference-data"></a>Определение геоограждений в справочных данных

Геоограждение можно определить с помощью объекта GeoJSON. Для заданий с версией совместимости 1.2 и выше, геоограждения также `NVARCHAR(MAX)`могут быть определены с помощью хорошо известного текста (WKT) как . WKT является стандартом Открытого геопространственного консорциума (OGC), который используется для представления пространственных данных в текстовом формате.

Встроенные геопространственные функции могут использовать определенные геоограждения, чтобы узнать, находится ли элемент в или из конкретного полигона геозабора.

Следующая таблица является примером справочных данных geofence, которые могут храниться в хранилище Azure blob или таблице Azure S'L. Каждый сайт представлен геопространственным полигоном, и каждое устройство связано с разрешенным идентификатором сайта.

|SiteID|SiteName|Геозоны|AllowedDeviceID|
|------|--------|--------|---------------|
|1|"Редмонд Строительство 41"|"ПОЛИГОН(-122.1337357922017 47.6378298329432,-122.13333427783669 47.637347937777305,-122.13347 2022530954,-122.133880288735 47.6375886,-122.13361777500506 47.637808288888888888,-133388888788887 47.63732393354484,-122.13265754417773 47.63730947490855,-122.13266290859576 47.637519124743164,-122.13302232460376 47.637515510097955,-122.13301696018573 47.63764925180358,-122.13272728161212 47.63764925180358,-122.13274873928424 47.63784082716388,-122.13373579220172 47.63782998329432))"|"B"|
|2|"Редмонд Строительство 40"|"ПОЛИГОН(-122.1336154507967 47.636674947009,-122.1336108637 47.63683015064455,122.13342009,-122.1981114 9400347675,-122.13349743360004 47.636363372773,-122.133728810357532 47.633337227777777777,-133333333 47.63617576323771,-122.13263912671528 47.63616491902258,-122.13264985555134 47.63635649982525,-122.13304682248554 47.636367344000604,-122.13305218690357 47.63650831807564,-122.13276250832996 47.636497473929516,-122.13277323716602 47.63668543881025,-122.1336154507967 47.6366745947009))"|"А"|
|3|"Редмонд Строительство 22"|"ПОЛИГОН(-122.1361166024823 47.63758544688554,-122.13635266888888884 47.63740832933018,-122.13622388834 33603619712,-122.1362888493 47.63717699101473,-122.1358161950726 47.6369782668766829977977,-13553333333 47.637046862778135,-122.13569281345798 47.637144458985965,-122.13570890671207 47.637314348246214,-122.13611660248233 47.63758544698554))"|"C"|

### <a name="generate-alerts-with-geofence"></a>Создание оповещений с помощью геозабора

Устройства могут излучать свой идентификатор и местоположение каждую минуту через поток под названием. `DeviceStreamInput` Следующая таблица представляет собой поток входных.

|DeviceID|Геопозиция|
|--------|-----------|
|"А"|"ТОЧКА(-122.13292341559497 47.636318374032726)"|
|"B"|"ТОЧКА(-122.1333847554553 47.63743531308874)"|
|"C"|"ТОЧКА(-122.13354001095752 47.63627622505007)"|

Вы можете написать запрос, который соединяет поток устройства с данными ссылки geofence и генерирует оповещение каждый раз, когда устройство находится за пределами разрешенного здания.

```SQL
SELECT DeviceStreamInput.DeviceID, SiteReferenceInput.SiteID, SiteReferenceInput.SiteName 
INTO Output
FROM DeviceStreamInput 
JOIN SiteReferenceInput
ON st_within(DeviceStreamInput.GeoPosition, SiteReferenceInput.Geofence) = 0
WHERE DeviceStreamInput.DeviceID = SiteReferenceInput.AllowedDeviceID
```

Следующее изображение представляет геоограждения. Вы можете увидеть, где устройства находятся в соответствии с потоком данных ввода.

![Строительство геоограждений](./media/geospatial-scenarios/building-geofences.png)

Устройство "C" находится внутри здания ID 2, что не допускается по справочным данным. Это устройство должно быть расположено внутри здания ID 3. Запуск этого задания будет генерировать оповещение об этом конкретном нарушении.

### <a name="site-with-multiple-allowed-devices"></a>Сайт с несколькими разрешенными устройствами

Если сайт позволяет несколько устройств, массив идентификаторов устройств может быть определен `AllowedDeviceID` `WHERE` в и пользователь-определенные функции могут быть использованы на оговорку, чтобы проверить, если идентификатор устройства потока совпадает с любым идентификатором устройства в этом списке. Для получения дополнительной информации просмотрите учебник [Javascript UDF](stream-analytics-javascript-user-defined-functions.md) для облачных заданий и учебник [по работе](stream-analytics-edge-csharp-udf.md) с краями.

## <a name="geospatial-aggregation"></a>Геопространственная агрегация

Azure Stream Analytics поддерживает геопространственную агрегацию в реальном времени в режиме реального времени в облаке и в режиме выполнения IoT Edge.

### <a name="geospatial-aggregation-scenario"></a>Сценарий геопространственной агрегации

Такси компания хочет построить приложение в режиме реального времени для руководства их таксистов ищет ездить в сторону районов городов в настоящее время испытывают более высокий спрос.

Компания хранит логические районы города в качестве справочных данных. Каждый регион определяется RegionID, RegionName и Geofence.

### <a name="define-the-geofences"></a>Определите геозаборы

Следующая таблица является примером справочных данных geofence, которые могут храниться в хранилище Azure blob или таблице Azure S'L. Каждый регион представлен геопространственным полигоном, который используется для соотношения с запросами, поступающими от потоковых данных.

Эти полигоны только для справки и не представляют фактического города логическиили или физические разделения.

|RegionID|RegionName|Геозоны|
|--------|----------|--------|
|1|"Сохо"|"ПОЛИГОН(-74.00279525078275 40.72833625216264,-74.0054774597 99765 40.721929158663244,-74.00125029839018 40.71893680218 9994,-73.9957785919998 40.72521409075776,-73.9972377137039 40.72557184584898,-74.00279525078275 40.72833625216264) )"|
|2|"Китайский квартал"|"ПОЛИГОН(-73.997123671111876 40.7128157133,-73.9901070123658 40.7133881907936,-73.9902357888383838383888007936,-73.99023578888 35908833-73.989763686189 40.7155482307894,-73,9955144573982 40.71733724688333556888335,-7385,795888888335,-7385,-78585 40.718491949759304,-73.99652285632942 40.719109951574,-73.99776740131233 40.7168005470334,-73.99903340396736 40.71727219249899,-74.00193018970344 40.71938642421256,-74.00409741458748 40.71688186545551,-74.00051398334358 40.71517415773184,-74.0004281526551 40.714377212470005,-73.99849696216438 40.713450141693166,-73.99748845157478 40.71405192594819,-73.99712367114876 40.71281582267133))"|
|3|"Трибека"|"ПОЛИГОН(-74.01091641815208 40.72583120006787,-74.0133840544578 40.714365863666662705,-74.0137059155557777 117702123415,-74.00862044733333 40.711308107235,-74.001947111120628 40.7194286540181818181 40.72583120006787))"|

### <a name="aggregate-data-over-a-window-of-time"></a>Агрегировать данные за окно времени

Следующая таблица содержит потоковые данные "поездок".

|UserID|FromLocation|ToLocation|TripRequestedTime|
|------|------------|----------|-----------------|
|"А"|"ТОЧКА(-74.00726861389182 40.71610611981975)"|"ТОЧКА(-73.98615095917779 40.703107386025835)"|"2019-03-12T07:00:00"|
|"B"|"ТОЧКА(-74.00249841021645 40.723827238895666)"|"ТОЧКА(-74.01160699942085 40.7137884930115)"|"2019-03-12T07:01:00"|
|"C"|"ТОЧКА(-73.99680120565864 40.716439888624024)"|"ТОЧКА(-73.98289663412544 40.72582343969828)"|"2019-03-12T07:02:00"|
|"D"|"ТОЧКА(-74.00741090068288 40.71615626755086)"|"ТОЧКА(-73.97999843120539 40.73477895807408)"|"2019-03-12T07:03:00"|

Следующий запрос соединяет поток устройств с справочными данными geofence и вычисляет количество запросов на регион в течение 15 минут каждую минуту.

```SQL
SELECT count(*) as NumberOfRequests, RegionsRefDataInput.RegionName 
FROM UserRequestStreamDataInput
JOIN RegionsRefDataInput 
ON st_within(UserRequestStreamDataInput.FromLocation, RegionsRefDataInput.Geofence) = 1
GROUP BY RegionsRefDataInput.RegionName, hoppingwindow(minute, 1, 15)
```

Этот запрос выводит количество запросов каждую минуту за последние 15 минут в каждом регионе города. Эта информация может быть легко отображаться на панели мониторинга Power BI или передаваться всем водителям в виде SMS-сообщений через интеграцию с такими службами, как Функции Azure.

На рисунке ниже показан выход запроса на панель мониторинга Power BI. 

![Результат вывода на приборной панели Power BI](./media/geospatial-scenarios/power-bi-output.png)


## <a name="next-steps"></a>Дальнейшие действия

* [Сведения о геопространственных функциях Azure Stream Analytics](stream-analytics-geospatial-functions.md)
* [Геопространственные функции (аналитика потоков Azure)](https://docs.microsoft.com/stream-analytics-query/geospatial-functions)
