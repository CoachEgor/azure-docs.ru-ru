---
title: Учебник по созданию задания Stream Analytics и управление им с помощью портала Azure
description: В этом руководстве содержится комплексное описание использования Azure Stream Analytics для анализа мошеннических вызовов в потоке телефонных звонков.
author: mamccrea
ms.author: mamccrea
ms.service: stream-analytics
ms.topic: tutorial
ms.custom: mvc
ms.date: 06/03/2019
ms.openlocfilehash: 577a80f04ad186ab1575fa78db3fa59402d6058f
ms.sourcegitcommit: 595cde417684e3672e36f09fd4691fb6aa739733
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2020
ms.locfileid: "83697397"
---
# <a name="tutorial-analyze-phone-call-data-with-stream-analytics-and-visualize-results-in-power-bi-dashboard"></a>Руководство по Анализа данных телефонных звонков с помощью Stream Analytics и визуализация результатов на панели мониторинга Power BI

Это руководство о том, как анализировать данные телефонных звонков с помощью Azure Stream Analytics. Данные телефонных звонков, поступившие от клиентского приложение, содержат сведения о мошеннических вызовах, которые будут отфильтрованы с помощью задания Stream Analytics.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * создание примера данных телефонных звонков и их отправка в Центры событий Azure;
> * Создание задания Stream Analytics
> * настройка входных и выходных данных для задания;
> * определение запроса для фильтрации мошеннических вызовов;
> * тестирование и запуск задания;
> * визуализация результатов в Power BI.

## <a name="prerequisites"></a>Предварительные требования

Прежде чем начать, сделайте следующее:

* Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/free/).
* Войдите на [портал Azure](https://portal.azure.com/).
* Загрузите приложение генератора событий телефонных вызовов [TelcoGenerator.zip](https://download.microsoft.com/download/8/B/D/8BD50991-8D54-4F59-AB83-3354B69C8A7E/TelcoGenerator.zip) из Центра загрузки Майкрософт или получите исходный код на сайте [GitHub](https://aka.ms/azure-stream-analytics-telcogenerator).
* Вам потребуется учетная запись Power BI.

## <a name="create-an-azure-event-hub"></a>Создание концентратора событий Azure

Чтобы Stream Analytics смогла проанализировать поток данных мошеннических вызовов, необходимо отправить данные в Azure. В этом руководстве данные будут отправлены в Azure с помощью [Центров событий Azure](https://docs.microsoft.com/azure/event-hubs/event-hubs-what-is-event-hubs).

Следуйте инструкциям ниже, чтобы создать концентратор событий и отправить в него данные вызовов:

1. Войдите на [портал Azure](https://portal.azure.com/).
2. Выберите **Создать ресурс** > **Интернет вещей** > **Центры событий**.

   ![Создание концентратора событий на портале Azure](media/stream-analytics-manage-job/find-event-hub-resource.png)
3. Заполните область **Создание пространства имен** следующими значениями:

   |**Параметр**  |**Рекомендуемое значение** |**Описание**  |
   |---------|---------|---------|
   |Имя     | myEventHubsNS        |  Уникальное имя для идентификации пространства имен концентратора событий.       |
   |Подписка     |   \<Ваша подписка\>      |   Выберите подписку Azure, в которой нужно создать концентратор событий.      |
   |Группа ресурсов     |   MyASADemoRG      |  Выберите **Создать** и введите новое имя группы ресурсов для учетной записи.       |
   |Расположение     |   Западная часть США 2      |    Расположение, в которое можно развернуть пространство имен концентратора событий.     |

4. Используйте значения по умолчанию для оставшихся параметров и нажмите кнопку **Создать**.

   ![Создание пространства имен концентратора событий на портале Azure](media/stream-analytics-manage-job/create-event-hub-namespace.png)

5. При завершении развертывания пространства имен перейдите в колонку **Все ресурсы** и найдите пространство имен *myEventHubsNS* в списке ресурсов Azure. Выберите пространство имен *myEventHubsNS*, чтобы открыть его.
6. Далее выберите **+ Концентратор событий** и в поле **Имя** введите *MyEventHub* или другое имя по своему усмотрению. Используйте значения по умолчанию для оставшихся параметров и нажмите кнопку **Создать**. Дождитесь успешного завершения развертывания.

   ![Настройка концентратора событий на портале Azure](media/stream-analytics-manage-job/create-event-hub-portal.png)

### <a name="grant-access-to-the-event-hub-and-get-a-connection-string"></a>Предоставление доступа к концентратору событий и получение строки подключения

Чтобы приложение смогло отправлять данные в Центры событий Azure, в концентраторе событий должна быть политика, обеспечивающая соответствующий доступ. Политика доступа создает строку подключения, которая включает сведения об авторизации.

1. Перейдите к концентратору событий MyEventHub*, созданному на предыдущем шаге. Выберите **Политика общего доступа** в разделе **Параметры**, а затем — **+ Добавить**.

2. Назовите политику **MyPolicy** и убедитесь, что флажок **Управление** установлен. Щелкните **Создать**.

   ![Создание политики общего доступа к концентратору событий](media/stream-analytics-manage-job/create-event-hub-access-policy.png)

3. После создания политики откройте ее и найдите **Строка подключения — первичный ключ**. Нажмите синюю кнопку **копирования** рядом со строкой подключения.

   ![Сохранение строки подключения политики общего доступа](media/stream-analytics-manage-job/save-connection-string.png)

4. Вставьте строку подключения в текстовый редактор. Эта строка подключения вам понадобится в следующем разделе.

   Строка подключения выглядит следующим образом:

   `Endpoint=sb://<Your event hub namespace>.servicebus.windows.net/;SharedAccessKeyName=<Your shared access policy name>;SharedAccessKey=<generated key>;EntityPath=<Your event hub name>`

   Обратите внимание, что строка подключения содержит несколько пар "ключ — значение", которые разделены точкой с запятой: **Endpoint**, **SharedAccessKeyName**, **SharedAccessKey** и **EntityPath**.

## <a name="start-the-event-generator-application"></a>Запуск приложения генератора событий

Перед запуском приложения TelcoGenerator необходимо настроить его для отправки данных в созданный ранее концентратор событий Azure.

1. Извлеките содержимое файла [TelcoGenerator.zip](https://download.microsoft.com/download/8/B/D/8BD50991-8D54-4F59-AB83-3354B69C8A7E/TelcoGenerator.zip).
2. Откройте файл `TelcoGenerator\TelcoGenerator\telcodatagen.exe.config` в текстовом редакторе по своему выбору (если имеется более одного CONFIG-файла, убедитесь, что вы открываете нужный).

3. Обновите элемент `<appSettings>` в файле конфигурации, указав следующие сведения:

   * Задайте для ключа *EventHubName* значение EntityPath в строке подключения.
   * Задайте для ключа *Microsoft.ServiceBus.ConnectionString* строку подключения без значения EntityPath (не забудьте удалить точку с запятой после нее).

4. Сохраните файл.
5. Далее откройте командное окно и перейдите в папку, в которой распаковано приложение TelcoGenerator. Затем введите следующую команду:

   ```cmd
   telcodatagen.exe 1000 0.2 2
   ```

   Эта команда принимает следующие параметры:
   * Число записей данных звонков в час.
   * Вероятность мошенничества, которая представляет частоту моделирования приложением мошеннических вызовов. Значение 0,2 означает, что около 20 % записей вызовов будут мошенническими.
   * Продолжительность в часах, которая соответствует количеству часов, на протяжении которых должно выполняться приложение. Вы также можете в любое время остановить выполнение приложения, завершив процесс (**CTRL+C**) в командной строке.

   Через несколько секунд приложение запустит отображение записей вызовов на экране, так как будет отправлять их в концентратор событий. Данные телефонных звонков содержат следующие поля:

   |**Запись**  |**Определение**  |
   |---------|---------|
   |CallrecTime    |  Метка времени начала вызова.       |
   |SwitchNum     |  Телефонный переключатель, используемый для совершения вызова. В этом примере переключатели выражены строками, представляющими страну или регион происхождения (США, Китай, Соединенное Королевство, Германия или Австралия).       |
   |CallingNum     |  Номер телефона звонящего.       |
   |CallingIMSI     |  Идентификатор абонента международной мобильной связи (IMSI). Это уникальный идентификатор звонящего.       |
   |CalledNum     |   Номер телефона получателя.      |
   |CalledIMSI     |  Идентификатор IMSI. Это уникальный идентификатор получателя звонка.       |

## <a name="create-a-stream-analytics-job"></a>Создание задания Stream Analytics

Теперь, когда у вас есть поток событий звонков, можно создать задание Stream Analytics, которое считывает данные из концентратора событий.

1. Чтобы создать задание Stream Analytics, перейдите на [портал Azure](https://portal.azure.com/).

2. Выберите **Создать ресурс** > **Интернет вещей** > **Задание Stream Analytics**.

3. Заполните область **Новое задание Stream Analytics** такими значениями:

   |**Параметр**  |**Рекомендуемое значение**  |**Описание**  |
   |---------|---------|---------|
   |Имя задания     |  ASATutorial       |   Уникальное имя для идентификации пространства имен концентратора событий.      |
   |Подписка    |  \<Ваша подписка\>   |   Выберите подписку Azure, в которой нужно создать задание.       |
   |Группа ресурсов   |   MyASADemoRG      |   Выберите **Use existing** (Использовать существующую) и введите новое имя группы ресурсов для учетной записи.      |
   |Расположение   |    Западная часть США 2     |      Расположение, в котором можно развернуть задание. Рекомендуется поместить задание и концентратор событий в одном регионе, чтобы достичь оптимальной производительности и не оплачивать передачу данных между регионами.      |
   |Среда размещения    | Cloud        |     Задания Stream Analytics можно развернуть в облаке или на граничных устройствах. Значение "Облако" позволяет выполнять развертывание в облаке Azure, а "Edge" — на устройстве IoT Edge.    |
   |Единицы потоковой передачи     |    1       |      Единица потоковой передачи предоставляет вычислительные ресурсы, которые необходимы для выполнения задания. По умолчанию установлено значение 1. Чтобы узнать о масштабировании единиц потоковой передачи, ознакомьтесь со статьей [Обзор и настройка единиц потоковой передачи](stream-analytics-streaming-unit-consumption.md).      |

4. Используйте значения по умолчанию для оставшихся параметров и нажмите кнопку **Создать**, а затем ожидайте, пока развертывание не будет завершено.

   ![Создание задания Azure Stream Analytics](media/stream-analytics-manage-job/create-stream-analytics-job.png)

## <a name="configure-job-input"></a>Настройка входных данных для задания

Следующий шаг — определить источник входных данных, откуда задание будет считывать данные с помощью концентратора событий, созданного в предыдущем разделе.

1. На портале Azure откройте область **Все ресурсы** и найдите задание Stream Analytics *ASATutorial*.

2. В разделе **Топология задания** области задания Stream Analytics выберите вариант **Входные данные**.

3. Выберите **+ Добавить потоковый вход** и **Концентратор событий**. Заполните область следующими значениями:

   |**Параметр**  |**Рекомендуемое значение**  |**Описание**  |
   |---------|---------|---------|
   |Псевдоним входных данных     |  CallStream       |  Введите понятное имя для идентификации входных данных. Входной псевдоним может содержать только буквенно-цифровые символы, дефисы и знаки подчеркивания. Длина должна составлять от 3 до 63 символов.       |
   |Подписка    |   \<Ваша подписка\>      |   Выберите подписку Azure, в которой вы создали концентратор событий. Концентратор событий может находиться в той же подписке, что и задание Stream Analytics, или в другой.       |
   |Пространство имен концентратора событий    |  myEventHubsNS       |  Выберите пространство имен концентратора событий, созданного в предыдущем разделе. Все пространства имен концентраторов событий, доступные в текущей подписке, перечислены в раскрывающемся меню.       |
   |имя концентратора событий;    |   MyEventHub      |  Выберите концентратор событий, который был создан в предыдущем разделе. Все концентраторы событий, доступные в текущей подписке, перечислены в раскрывающемся меню.       |
   |Имя политики концентратора событий   |  MyPolicy       |  Выберите политику общего доступа концентратора событий, созданную в предыдущем разделе. Все политики концентраторов событий, доступные в текущей подписке, перечислены в раскрывающемся меню.       |

4. Используйте значения по умолчанию для оставшихся параметров и нажмите кнопку **Сохранить**.

   ![Настройка входных данных Azure Stream Analytics](media/stream-analytics-manage-job/configure-stream-analytics-input.png)

## <a name="configure-job-output"></a>Настройка выходных данных для задания

Осталось определить приемник выходных данных для задания, т. е. место для записи преобразованных данных. В этом руководстве данные выводятся и визуализируются с помощью Power BI.

1. На портале Azure откройте область **Все ресурсы** и найдите задание Stream Analytics *ASATutorial*.

2. В разделе **Топология задания** области задания Stream Analytics выберите вариант **Выходные данные**.

3. Выберите **+ Добавить** > **Power BI**. Затем заполните форму следующими сведениями и нажмите кнопку **Авторизовать**:

   |**Параметр**  |**Рекомендуемое значение**  |
   |---------|---------|
   |Псевдоним выходных данных  |  MyPBIoutput  |
   |Имя набора данных  |   ASAdataset  |
   |Имя таблицы |  ASATable  |

   ![Настройка выходных данных Stream Analytics](media/stream-analytics-manage-job/configure-stream-analytics-output.png)

4. Когда вы нажмете кнопку **Авторизовать**, откроется всплывающее окно и вам будет предложено ввести учетные данные для проверки подлинности учетной записи Power BI. Когда авторизация будет выполнена успешно, **сохраните** параметры.

## <a name="define-a-query-to-analyze-input-data"></a>Определение запроса для анализа входных данных

Далее необходимо создать преобразование, анализирующее данные в режиме реального времени. Определите запрос преобразования с помощью [языка запросов Stream Analytics](https://docs.microsoft.com/stream-analytics-query/stream-analytics-query-language-reference). Запрос, используемый в этом руководстве, обнаруживает мошеннические вызовы в данных телефона.

В этом примере мошеннические вызовы выполняются от одного и того же пользователя в течение пяти секунд, но из разных мест. Например, один и тот же пользователь не может законным путем сделать звонок из США и Австралии одновременно. Чтобы определить запрос преобразования для задания Stream Analytics:

1. На портале Azure откройте область **Все ресурсы** и перейдите к заданию Stream Analytics **ASATutorial**, созданному ранее.

2. В разделе **Топология задания** области задания Stream Analytics выберите вариант **Запрос**. В окне запроса перечислены входные и выходные данные, настроенные для задания, и можно создать запрос, преобразовывающий входной поток.

3. Замените имеющийся запрос в редакторе следующим запросом, который выполняет самосоединение с данными вызова за 5-секундный интервал:

   ```sql
   SELECT System.Timestamp AS WindowEnd, COUNT(*) AS FraudulentCalls
   INTO "MyPBIoutput"
   FROM "CallStream" CS1 TIMESTAMP BY CallRecTime
   JOIN "CallStream" CS2 TIMESTAMP BY CallRecTime
   ON CS1.CallingIMSI = CS2.CallingIMSI
   AND DATEDIFF(ss, CS1, CS2) BETWEEN 1 AND 5
   WHERE CS1.SwitchNum != CS2.SwitchNum
   GROUP BY TumblingWindow(Duration(second, 1))
   ```

   Чтобы проверить наличие мошеннических вызовов, вы можете выполнить самосоединение потоковых данных на основе значения `CallRecTime`. Затем вы можете найти записи вызовов, в которых значение `CallingIMSI` (исходящий номер) остается неизменным, а значение `SwitchNum` (страна или регион происхождения) изменяется. При использовании операции JOIN с потоковой передачей данных соединение должно предоставить некоторые ограничения в отношении того, насколько совпадающие строки могут быть разделены по времени. Так как поток данных бесконечен, укажите ограничения по времени для связи в предложении **ON** операции соединения с помощью функции [DATEDIFF](https://docs.microsoft.com/stream-analytics-query/datediff-azure-stream-analytics).

   Этот запрос не отличается от обычного соединения SQL, за исключением функции **DATEDIFF**. Функция **DATEDIFF**, используемая в этом запросе, относится к Stream Analytics и должна находиться внутри предложения `ON...BETWEEN`.

4. **Сохраните** запрос.

   ![Определение запроса Stream Analytics на портале](media/stream-analytics-manage-job/define-stream-analytics-query.png)

## <a name="test-your-query"></a>Тестирование запроса

Запрос можно протестировать из редактора запросов с помощью примера данных. Выполните следующие действия, чтобы проверить запрос:

1. Проверьте, чтобы приложение TelcoGenerator работало и создавало записи телефонных звонков.

2. В области **Запрос** выберите точки рядом с входными данными *CallStream*, а затем выберите **Образец данных со входа**.

3. Задайте для параметра **Минуты** значение "3" и нажмите кнопку **ОК**. Данные за три минуты будут созданы из входного потока, а вы получите уведомление, когда они будут готовы. Состояние выборки можно просмотреть на панели уведомлений.

   Образец данных хранится временно и доступен, пока открыто окно запроса. Если закрыть окно запроса, образец данных будет удален и придется создать новый набор образцов данных, если вы хотите протестировать. Кроме того, можно использовать JSON-файл с примером данных из [GitHub](https://github.com/Azure/azure-stream-analytics/blob/master/Sample%20Data/telco.json), а затем отправить этот файл для использования в качестве образца данных для псевдонима входных данных *CallStream*.

   ![Схема получения входных данных для Stream Analytics](media/stream-analytics-manage-job/sample-input-data-asa.png)

4. Выберите **Test** (Тестировать) для проверки запроса. Вы увидите следующие результаты:

   ![Выходные данные теста запроса Stream Analytics](media/stream-analytics-manage-job/sample-test-output-restuls.png)

## <a name="start-the-job-and-visualize-output"></a>Запуск задания и визуализация выходных данных

1. Перейдите к панели задания **Обзор** и выберите **Запуск**, чтобы запустить задание.

2. Выберите время начала создания выходных данных задания **Сейчас**, а затем — **Запуск**. Вы можете просматривать состояние задания на панели уведомлений.

3. После успешного выполнения задания перейдите на сайт [Power BI](https://powerbi.com/) и войдите с помощью рабочей или учебной учетной записи. Если запрос задания Stream Analytics выдает результаты, то созданный набор данных *ASAdataset* находится на вкладке **Наборы данных**.

4. В рабочей области Power BI выберите **+ Создать**, чтобы создать панель мониторинга с именем *Мошеннические вызовы*.

5. В верхней части окна щелкните **Добавить плитку**. Затем выберите **Пользовательские данные потоковой передачи** и нажмите кнопку **Далее**. Выберите **ASAdataset** в разделе **Ваши наборы данных**. Выберите **Карточка** из раскрывающегося списка **Тип визуализации** и добавьте **fraudulent calls** в **Поля**. Нажмите кнопку **Далее**, чтобы ввести имя для плитки, а затем выберите **Применить** для создания плитки.

   ![Создание плитки панели мониторинга Power BI](media/stream-analytics-manage-job/create-power-bi-dashboard-tiles.png)

6. Выполните шаг 5 снова, выбрав следующие параметры:
   * В поле "Тип визуализации" выберите "График".
   * Добавьте ось и выберите **windowend**.
   * Добавьте значение и выберите **fraudulentcalls**.
   * В списке **Отображаемый интервал времени** укажите последние 10 минут.

7. После добавления обеих плиток панель мониторинга должна выглядеть как в приведенном ниже примере. Обратите внимание, что если приложение отправки концентратора событий и приложение Streaming Analytics запущены, панель мониторинга Power BI будет периодически обновляться по мере поступления новых данных.

   ![Просмотр результатов на панели мониторинга Power BI](media/stream-analytics-manage-job/power-bi-results-dashboard.png)

## <a name="embedding-your-power-bi-dashboard-in-a-web-application"></a>Внедрение панели мониторинга Power BI в веб-приложение

В этой части руководства для внедрения панели мониторинга используется пример веб-приложения [ASP.NET](https://asp.net/), созданный командой Power BI. Дополнительные сведения о внедрении панелей мониторинга см. в [этой статье](https://docs.microsoft.com/power-bi/developer/embedding).

Чтобы настроить приложение, перейдите к репозиторию GitHub [PowerBI-Developer-Samples](https://github.com/Microsoft/PowerBI-Developer-Samples) и следуйте инструкциям из раздела о **владении данными** (используйте URL-адреса переадресации и домашней страницы в подразделе **integrate-web-app**). Так как мы используем пример панели мониторинга, используйте пример кода **integrate-web-app**, который находится в [репозитории GitHub](https://github.com/microsoft/PowerBI-Developer-Samples/tree/master/.NET%20Framework/Embed%20for%20your%20organization/integrate-web-app).
Когда приложение будет запущено в браузере, выполните следующие действия, чтобы вставить созданную ранее панель инструментов на веб-страницу:

1. Выберите **Sign in to Power BI** (Вход в Power BI), что предоставит приложению доступ к панелям мониторинга в учетной записи Power BI.

2. Нажмите кнопку **Get Dashboards** (Получить панели мониторинга), после чего панели мониторинга учетной записи отобразятся в таблице. Найдите имя панели мониторинга, которая была создана ранее **powerbi-embedded-dashboard**, и скопируйте соответствующий **EmbedUrl**.

3. Наконец, вставьте **EmbedUrl** в соответствующее текстовое поле и выберите **Embed Dashboard** (Внедрение панели мониторинга). Теперь та же панель мониторинга будет внедрена в веб-приложение.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве был создан пример задания Stream Analytics, проанализированы входные данные и представлены результаты на панели мониторинга Power BI. Чтобы узнать больше о заданиях Stream Analytics, перейдите к следующему руководству:

> [!div class="nextstepaction"]
> [Запуск решения "Функции Azure" из заданий Azure Stream Analytics](stream-analytics-with-azure-functions.md)
