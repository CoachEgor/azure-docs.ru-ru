---
title: Выявление мошенничества в режиме реального времени с помощью Azure Stream Analytics
description: Информация о том, как с помощью службы Stream Analytics создать решение для выявления мошенничества в режиме реального времени. Используйте концентратор событий для обработки событий в реальном времени.
author: mamccrea
ms.author: mamccrea
ms.reviewer: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 03/24/2020
ms.custom: seodec18
ms.openlocfilehash: 5e2ba749b64a6d44c9aa6b03352910ab24771084
ms.sourcegitcommit: 0b80a5802343ea769a91f91a8cdbdf1b67a932d3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2020
ms.locfileid: "83835654"
---
# <a name="get-started-using-azure-stream-analytics-real-time-fraud-detection"></a>Приступая к работе с Azure Stream Analytics. Выявление мошенничества в реальном времени

В этом руководстве содержится комплексное описание использования Azure Stream Analytics. Вы узнаете, как выполнять следующие задачи: 

* Перенести события потоковой передачи в экземпляр Центров событий Azure. В рамках этого руководства вы будете использовать приложение, имитирующее поток записей метаданных от мобильного устройства.

* Написать запросы Stream Analytics, похожие на SQL, чтобы преобразовать данные, которые агрегируют сведения или выполняют поиск шаблонов. Вы узнаете, как использовать запрос для проверки входящего потока, а также как выполнить поиск вызовов, которые могут оказаться мошенническими.

* Отправить результаты в приемник выходных данных (хранилище), где можно анализировать дополнительные сведения. В этом случае вы отправите подозрительные данные вызова в хранилище BLOB-объектов Azure.

В рамках этого руководства используется пример выявления мошенничества в реальном времени на основе данных телефонных вызовов. Способ, с которым вы ознакомитесь, также подходит для других типов обнаружения мошенничества, например для обнаружения мошеннического использования кредитной карты или кражи личных данных. 

## <a name="scenario-telecommunications-and-sim-fraud-detection-in-real-time"></a>Сценарий: Выявление мошенничества в отношении телекоммуникаций и SIM-карт в режиме реального времени

У поставщика телекоммуникационных услуг есть большой объем данных для входящих вызовов. Компания хочет определить мошеннические вызовы в режиме реального времени, чтобы уведомить клиентов или завершить обслуживание для определенного номера. Один тип мошенничества в отношении SIM-карт включает несколько вызовов из одного удостоверения приблизительно в одно время, но из различных географических расположений. Чтобы обнаружить этот тип мошенничества, компания должна проверить входящие записи телефона и выполнить поиск специальных шаблонов — в этом случае для вызовов, сделанных в одно время из разных стран/регионов. Любые записи телефона, соответствующие этой категории, записываются в хранилище для последующего анализа.

## <a name="prerequisites"></a>Предварительные требования

В рамках этого руководства вы смоделируете данные вызовов с помощью клиентского приложения, которое создает пример метаданных вызова. Некоторые из записей, которые создает приложение, выглядят, как мошеннические вызовы. 

Чтобы начать, у вас должны быть следующие компоненты:

* Учетная запись Azure.
* Приложение генератора событий вызовов [TelcoGenerator.zip](https://download.microsoft.com/download/8/B/D/8BD50991-8D54-4F59-AB83-3354B69C8A7E/TelcoGenerator.zip), которое можно скачать из центра загрузки Майкрософт. Распакуйте этот пакет в папку на компьютере. Если нужно просмотреть исходный код и запустить приложение в отладчике, можно получить исходный код на [GitHub](https://aka.ms/azure-stream-analytics-telcogenerator). 

    >[!NOTE]
    >Windows может заблокировать загруженный ZIP-файл. Если вам не удается распаковать его, щелкните файл правой кнопкой мыши и выберите **Свойства**. Если появляется сообщение "Этот файл получен с другого компьютера и, возможно, был заблокирован с целью защиты компьютера", выберите параметр **Разблокировать**, а затем щелкните **Применить**.

Если вы хотите проанализировать результаты задания Streaming Analytics, вам также необходимо средство просмотра содержимого контейнера хранилища BLOB-объектов Azure. Если вы используете Visual Studio, можно использовать [инструменты Azure для Visual Studio](https://docs.microsoft.com/azure/vs-azure-tools-storage-resources-server-explorer-browse-manage) или [Visual Studio Cloud Explorer](https://docs.microsoft.com/azure/vs-azure-tools-resources-managing-with-cloud-explorer). Кроме того, можно установить автономные средства, например [обозреватель хранилищ Azure](https://storageexplorer.com/) или [Cerulean](https://www.cerebrata.com/products/cerulean/features/azure-storage). 

## <a name="create-an-azure-event-hubs-to-ingest-events"></a>Создание концентраторов событий Azure для приема событий

Чтобы проанализировать поток данных, необходимо *принять* его в Azure. Стандартный способ принять данные — использовать [Центры событий Azure](../event-hubs/event-hubs-what-is-event-hubs.md). Они позволяют принимать миллионы событий в секунду, а затем обрабатывают и сохраняют сведения о событиях. В рамках этого руководства вы создадите концентратор событий, а затем из приложения генератора событий вызовов отправите данные вызовов в этот концентратор событий. Дополнительные сведения о концентраторах событий см. в [документации по Служебной шине Azure](https://docs.microsoft.com/azure/service-bus/).

>[!NOTE]
>Ознакомьтесь со статьей [Создание пространства имен Центров событий и концентратора событий с помощью портала Azure](../event-hubs/event-hubs-create.md), чтобы получить более подробные сведения об этой процедуре. 

### <a name="create-a-namespace-and-event-hub"></a>Создание пространства имен и концентратора событий
В этой процедуре сначала создается пространство имен концентратора событий, а затем в это пространство имен добавляется концентратор событий. Пространства имен концентратора событий используются для логической группировки связанных экземпляров шины событий. 

1. Войдите на портал Azure и нажмите **Создать ресурс** в левой верхней части экрана.

2. Выберите **Все службы** в меню слева и щелкните **звездочку (`*`)** рядом с пунктом **Центры событий** в категории **Аналитика**. Убедитесь, что **Центры событий** были добавлены в раздел **Избранное** в меню навигации слева. 

   ![Поиск Центров событий](./media/stream-analytics-real-time-fraud-detection/select-event-hubs-menu.png)

3. Выберите **Центры событий** в разделе **Избранное** в меню навигации слева и щелкните **Добавить** на панели инструментов.

   ![Кнопка "Добавить"](./media/stream-analytics-real-time-fraud-detection/event-hubs-add-toolbar.png)

4. В области **Создать пространство имен** укажите имя пространства имен, например `<yourname>-eh-ns-demo`. Для пространства имен можно использовать любое уникальное в Azure имя с допустимым URL-адресом. 
    
5. Выберите подписку, создайте или выберите группу ресурсов, а затем щелкните **Создать**.

    <br/><img src="./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-eventhub-namespace-new-portal.png" alt="Create event hub namespace in Azure portal" width="300px"/>

6. После завершения развертывания пространства имен найдите пространство имен концентратора событий в списке ресурсов Azure. 

7. Щелкните новое пространство имен, а затем в открывшейся области щелкните **Концентратор событий**.

   ![Кнопка "Добавить концентратор событий" для создания нового концентратора событий](./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-eventhub-button-new-portal.png)    
 
8. Назовите новый концентратор событий `asa-eh-frauddetection-demo`. Вы можете использовать другое имя. В таком случае запишите его, так как это имя понадобится вам позже. На этом этапе этих параметров концентратора событий достаточно.

    <br/><img src="./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-eventhub-new-portal.png" alt="Name event hub in Azure portal" width="400px"/>
    
9. Нажмите кнопку **Создать**.

### <a name="grant-access-to-the-event-hub-and-get-a-connection-string"></a>Предоставление доступа к концентратору событий и получение строки подключения

Для того чтобы процесс смог отправлять данные в концентратор событий, концентратор должен иметь политику, разрешающую соответствующий доступ. Политика доступа создает строку подключения, которая включает сведения об авторизации.

1. В области пространства имен событий щелкните **Центры событий**, а затем щелкните имя нового концентратора событий.

2. В области концентратора событий щелкните **Политики общего доступа**, а затем выберите **+&nbsp;Добавить**.

    > [!NOTE]
    > Вы должны работать с концентратором событий, а не пространством имен концентратора.

3. Добавьте политику с именем `asa-policy-manage-demo`, а для параметра **Утверждение** выберите **Управление**.

    <br/><img src="./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-shared-access-policy-manage-new-portal.png" alt="Create shared access policy for Stream Analytics" width="300px"/>
 
4. Нажмите кнопку **Создать**.

5. После развертывания политики щелкните ее в списке политик общего доступа.

6. Найдите текстовое поле с пометкой **Строка подключения — первичный ключ** и нажмите кнопку копирования рядом со строкой подключения. 

    <br/><img src="./media/stream-analytics-real-time-fraud-detection/stream-analytics-shared-access-policy-copy-connection-string-new-portal.png" alt="Stream Analytics shared access policy" width="300px"/>
 
7. Вставьте строку подключения в текстовый редактор. Эта строка подключения понадобится в следующем разделе после внесения в нее небольших изменений.

    Строка подключения выглядит следующим образом:

    `Endpoint=sb://YOURNAME-eh-ns-demo.servicebus.windows.net/;SharedAccessKeyName=asa-policy-manage-demo;SharedAccessKey=Gw2NFZwU1Di+rxA2T+6hJYAtFExKRXaC2oSQa0ZsPkI=;EntityPath=asa-eh-frauddetection-demo`

    Обратите внимание, что строка подключения содержит несколько пар "ключ — значение", которые разделены точкой с запятой: `Endpoint`, `SharedAccessKeyName`, `SharedAccessKey` и `EntityPath`.  


## <a name="configure-and-start-the-event-generator-application"></a>Настройка и запуск приложения генератора событий

Прежде чем запускать приложение TelcoGenerator, его следует настроить, чтобы оно могло отправлять записи вызовов в созданный концентратор событий.

### <a name="configure-the-telcogenerator-app"></a>Настройка приложения TelcoGenerator

1. В редакторе, куда вы скопировали строку подключения, запишите значение `EntityPath`, а затем удалите пару `EntityPath` (не забудьте удалить точку с запятой, предшествующую ей). 

2. В папке, где вы распаковали файл TelcoGenerator.zip, откройте в редакторе файл telcodatagen.exe.config. (Если имеется более одного CONFIG-файла, проверьте, что вы открыли нужный.)

3. В элементе `<appSettings>` сделайте следующее:

   * Задайте для ключа `EventHubName` значение имени концентратора событий (то есть значение пути к сущности).
   * Задайте для ключа `Microsoft.ServiceBus.ConnectionString` значение строки подключения. 

   Раздел `<appSettings>` будет выглядеть, как показано в примере ниже.

    ```xml
    <appSettings>
     <!-- Service Bus specific app setings for messaging connections -->
     <add key="EventHubName" value="asa-eh-ns-demo"/>
     <add key="Microsoft.ServiceBus.ConnectionString" value="Endpoint=sb://asa-eh-ns-demo.servicebus.windows.net/;SharedAccessKeyName=asa-policy-manage-demo;SharedAccessKey=GEcnTKf2//1MRn6SN1A2u0O76MP9pj3v0Ccyf1su4Zo="/>
   </appSettings>
    ```
 
4. Сохраните файл. 

### <a name="start-the-app"></a>Запуск приложения

1. Откройте окно командной строки и перейдите в папку, в которой было распаковано приложение TelcoGenerator.

2. Введите следующую команду:

    ```console
    telcodatagen.exe 1000 0.2 2
    ```

   Используются следующие параметры: 

   * Число записей подробных сведений о звонках за час. 
   * Вероятность мошенничества с SIM картами: частота моделирования приложением мошеннических вызовов, выраженная в процентном соотношении ко всем вызовам. Значение 0,2 означает, что около 20 % записей вызовов будут мошенническими.
   * Продолжительность в часах. Количество часов, на протяжении которых должно выполняться приложение. Вы также можете остановить выполнение приложения, использовав Ctrl+C в командной строке.

   Через несколько секунд приложение запустит отображение записей вызовов на экране, так как будет отправлять их в концентратор событий.

Ниже определены некоторые ключевые поля, которые будут использоваться в этом приложении для выявления мошенничества в реальном времени:

|**Запись**|**Определение**|
|----------|--------------|
|`CallrecTime`|Метка времени начала вызова. |
|`SwitchNum`|Телефонный переключатель, используемый для совершения вызова. В этом примере переключатели выражены строками, представляющими страну или регион происхождения (США, Китай, Соединенное Королевство, Германия или Австралия). |
|`CallingNum`|Номер телефона звонящего. |
|`CallingIMSI`|Идентификатор абонента международной мобильной связи (IMSI). Это уникальный идентификатор звонящего. |
|`CalledNum`|Номер телефона получателя. |
|`CalledIMSI`|Идентификатор IMSI. Это уникальный идентификатор получателя. |


## <a name="create-a-stream-analytics-job-to-manage-streaming-data"></a>Создание задания Stream Analytics для управления потоковой передачей данных

Теперь, когда у вас есть поток событий вызовов, вы можете настроить задание Stream Analytics. Задание будет считывать данные из настроенного концентратора событий. 

### <a name="create-the-job"></a>Создание задания 

1. На портале Azure щелкните **Создать ресурс** >  **"Интернет вещей"**  > **Задание Stream Analytics**.

2. Назовите задание `asa_frauddetection_job_demo` и укажите подписку, группу ресурсов и расположение.

    Мы рекомендуем поместить задание и концентратор событий в одном регионе, чтобы достичь оптимальной производительности и не оплачивать передачу данных между регионами.

    <br/><img src="./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-sa-job-new-portal.png" alt="Create Stream Analytics job in portal" width="300px"/>

3. Нажмите кнопку **Создать**.

    Будет создано задание, и на портале отобразятся сведения о нем. Теперь, чтобы запустить задание, необходимо его настроить.

### <a name="configure-job-input"></a>Настройка входных данных для задания

1. На панели мониторинга или в области **Все ресурсы** найдите и выберите задание Stream Analytics `asa_frauddetection_job_demo`. 
2. В разделе **Обзор** на панели заданий Stream Analytics щелкните область **Входные данные**.

   ![Поле входных данных в разделе топологии задания в области задания Streaming Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-input-box-new-portal.png)
 
3. Щелкните **Добавить потоковый вход** и выберите **Концентратор событий**. Затем укажите на странице "Новые входные данные" следующие сведения:

   |**Параметр**  |**Рекомендуемое значение**  |**Описание**  |
   |---------|---------|---------|
   |Псевдоним входных данных  |  CallStream   |  Введите имя для этого источника входных данных для задания.   |
   |Подписка   |  \<Ваша подписка\> |  Выберите подписку Azure, в которой размещен созданный концентратор событий.   |
   |пространство имен концентратора событий;  |  asa-eh-ns-demo |  Введите имя пространства имен для концентратора событий.   |
   |имя концентратора событий;  | asa-eh-frauddetection-demo | Выберите имя концентратора событий.   |
   |Имя политики концентратора событий  | asa-policy-manage-demo | Выберите созданную ранее политику доступа.   |

    </br>
    <img src="./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-sa-input-new-portal.png" alt="Create Stream Analytics input in portal" width="300px"/>


4. Нажмите кнопку **Создать**.

## <a name="create-queries-to-transform-real-time-data"></a>Создание запросов для преобразования данных в режиме реального времени

На этом этапе задание Stream Analytics настроено на считывание входящего потока данных. Далее необходимо создать запрос для анализа данных в режиме реального времени. Stream Analytics поддерживает простую декларативную модель запроса для описания преобразований для обработки в режиме реального времени. В запросах используется язык на основе SQL, который содержит некоторые расширения, характерные для Stream Analytics. 

Простой запрос считывает все входящие данные. Тем не менее часто создаются запросы, которые выполняют поиск конкретных данных или связей в данных. В этом разделе руководства вы создадите и проверите несколько запросов, чтобы ознакомиться с несколькими способами преобразования входного потока для анализа. 

Запросы, созданные в рамках этого руководства, выведут преобразованные данные на экран. В следующем разделе вы настроите приемник выходных данных и запрос, записывающий преобразованные данные в этот приемник.

Дополнительные сведения о языке см. в разделе [Справочник по языку запросов Azure Stream Analytics](https://docs.microsoft.com/stream-analytics-query/stream-analytics-query-language-reference).

### <a name="get-sample-data-for-testing-queries"></a>Получение образца данных для запросов для тестирования

Приложение TelcoGenerator отправляет записи вызовов в концентратор событий, а задание Stream Analytics настроено на считывание записей из концентратора событий. Вы можете использовать запрос для проверки задания, чтобы убедиться, что считывание выполняется соответствующим образом. Чтобы проверить запрос в консоли Azure, вам необходим образец данных. В рамках этого пошагового руководства вы извлечете образец данных из потока, поступающего в концентратор событий.

1. Проверьте, чтобы приложение TelcoGenerator работало и создавало записи вызовов.
2. Вернитесь в область задания Streaming Analytics на портале. (Если вы закрыли область, найдите `asa_frauddetection_job_demo` в области **Все ресурсы**.)
3. Щелкните поле **Запрос**. Azure перечислит входные и выходные данные, настроенные для задания, и позволит создать запрос, с помощью которого можно преобразовать входной поток, отправляемый на выход.
4. В области **Запрос** щелкните точки рядом с входными данными `CallStream`, а затем выберите **Образец данных со входа**.

   ![Параметры меню для использования примера данных для записи задания Streaming Analytics с выбранным параметром "Образец данных со входа"](./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-sample-data-from-input.png)


5. Для параметра **Минуты** задайте значение 3 и нажмите кнопку **ОК**. 
    
   ![Параметры выборки входного потока с выбранным значением "3 минуты"](./media/stream-analytics-real-time-fraud-detection/stream-analytics-input-create-sample-data.png)

    Azure обработает данные из входного потока, накопленные за 3 минуты, и сообщит о готовности образца данных. (Это займет некоторое время.) 

Образец данных хранится временно и доступен, пока открыто окно запроса. Если закрыть окно запроса, образец данных будет удален и придется создать новый набор образцов данных. 

В качестве альтернативы можно получить JSON-файл, содержащий образец данных, с помощью [GitHub](https://github.com/Azure/azure-stream-analytics/blob/master/Sample%20Data/telco.json), а затем отправить этот файл для использования в качестве образца данных для входного псевдонима `CallStream`. 

### <a name="test-using-a-pass-through-query"></a>Проверка с помощью запроса к серверу

Чтобы архивировать все события, вы можете использовать запрос к серверу для считывания всех полей в полезных данных события.

1. В окне запроса введите следующий запрос:
        
   ```SQL
   SELECT 
       *
   FROM 
       CallStream
   ```

    >[!NOTE]
    >Как и при использовании SQL, регистр ключевых слов не учитывается, пробел не имеет значения.

    В этом запросе `CallStream` — это входной псевдоним, указанный при создании входных данных для задания. Если вы использовали другой псевдоним, используйте его, соответственно.

2. Нажмите **Проверить**.

    Задание Stream Analytics выполняет запрос образцов данных и отображает выходные данные в нижней области окна. Такой результат означает, что концентратор событий и задание Stream Analytics настроены правильно. (Как уже отмечалось выше, позже вы создадите приемник выходных данных, в который запрос может записывать данные.)

   ![Выходные данные задания Stream Analytics, отображающие 73 созданные записи.](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-sample-output.png)

    Точное число отображаемых записей будет зависеть от числа записей, собранных за 3 минуты.
 
### <a name="reduce-the-number-of-fields-using-a-column-projection"></a>Уменьшение числа полей с помощью заполнения столбцов

Во многих случаях анализу не требуются все столбцы из входного потока. Вы можете использовать запрос, чтобы создать меньший набор возвращаемых полей по сравнению с набором в запросе к серверу.

1. Измените запрос в редакторе кода, используя следующие значения:

    ```SQL
    SELECT CallRecTime, SwitchNum, CallingIMSI, CallingNum, CalledNum 
    FROM 
        CallStream
    ```

2. Снова щелкните **Проверка**. 

   ![Выходные данные задания Stream Analytics для заполнения столбцов, которые включают 25 записей](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-sample-output-projection.png)
 
### <a name="count-incoming-calls-by-region-tumbling-window-with-aggregation"></a>Количество входящих вызовов по региону: "переворачивающееся" окно с агрегированием

Предположим, вам нужно посчитать число входящих вызовов на регион. В потоковой передаче данных, если вы хотите использовать статистические функции, например подсчет, вам нужно сегментировать поток на временные единицы (так как сам поток данных является цельным). Это можно сделать с помощью [функции окна](stream-analytics-window-functions.md) Streaming Analytics. Затем вы сможете работать с данными в этом окне как с отдельными единицами.

Для такого преобразования нужна последовательность временных окон, которые не перекрываются. У каждого окна будет дискретный набор данных, которые можно группировать и статистически обрабатывать. Такой тип окна называется *"переворачивающимся" окном*. В "переворачивающемся" окне вы можете получить число входящих вызовов, сгруппированных `SwitchNum` — переключателем, который представляет страну/регион (расположение) вызова. 

1. Измените запрос в редакторе кода, используя следующие значения:

    ```SQL
    SELECT 
        System.Timestamp as WindowEnd, SwitchNum, COUNT(*) as CallCount 
    FROM
        CallStream TIMESTAMP BY CallRecTime 
    GROUP BY TUMBLINGWINDOW(s, 5), SwitchNum
    ```

    Этот запрос использует ключевое слово `Timestamp By` в предложении `FROM`, чтобы указать, какое поле метки времени использовать во входном потоке для определения "переворачивающегося" окна. В этом случае окно делит данные на сегменты по полю `CallRecTime` в каждой записи. Если поле не указано, при выполнении операций с окнами будет использоваться время поступления каждого события в концентратор событий. Дополнительные сведения см. в разделе о времени поступления и времени приложения в [справочнике по языку запросов Stream Analytics](https://docs.microsoft.com/stream-analytics-query/stream-analytics-query-language-reference). 

    Проектирование включает запрос `System.Timestamp`, возвращающий метку времени конца каждого окна. 

    Чтобы указать, что вы хотите использовать "переворачивающееся" окно, используйте функцию [TUMBLINGWINDOW](https://docs.microsoft.com/stream-analytics-query/tumbling-window-azure-stream-analytics) в предложении `GROUP BY`. В функции укажите единицу времени (от микросекунд до 24 часов) и размер окна (количество единиц). В этом примере "переворачивающееся" окно состоит из пятисекундных интервалов, поэтому вы получите количество вызовов по странам/регионам за 5 секунд.

2. Снова щелкните **Проверка**. В результатах обратите внимание на то, что метки времени в **WindowEnd** формируются с шагом приращения в 5 секунд.

   ![Выходные данные задания Stream Analytics для статистической обработки, которые включают 13 записей](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-sample-output-aggregation.png)
 
### <a name="detect-sim-fraud-using-a-self-join"></a>Выявление мошенничества в отношении SIM-карт с помощью самосоединения

В этом примере мы рассмотрим мошеннические вызовы, выполненные одним пользователем из различных регионов с интервалом в 5 секунд. Например, один и тот же пользователь не может законным путем сделать звонок из США и Австралии одновременно. 

Чтобы проверить такие случаи, вы можете использовать самосоединение потоковой передачи данных, чтобы выполнить самосоединение потока на основе значения `CallRecTime`. Затем вы можете найти записи вызовов, в которых значение `CallingIMSI` (исходящий номер) остается неизменным, а значение `SwitchNum` (страна/регион происхождения) изменяется.

При использовании соединения с потоковой передачей данных соединение должно предоставить некоторые ограничения в отношении того, насколько совпадающие строки могут быть разделены по времени. (Как уже отмечалось выше, потоковая передача данных является цельной.) Пределы времени для такой связи задаются в предложении соединения `ON` с помощью функции `DATEDIFF`. В этом случае соединение основано на 5-секундном интервале данных вызова.

1. Измените запрос в редакторе кода, используя следующие значения: 

    ```SQL
    SELECT  System.Timestamp as Time, 
        CS1.CallingIMSI, 
        CS1.CallingNum as CallingNum1, 
        CS2.CallingNum as CallingNum2, 
        CS1.SwitchNum as Switch1, 
        CS2.SwitchNum as Switch2 
    FROM CallStream CS1 TIMESTAMP BY CallRecTime 
        JOIN CallStream CS2 TIMESTAMP BY CallRecTime 
        ON CS1.CallingIMSI = CS2.CallingIMSI 
        AND DATEDIFF(ss, CS1, CS2) BETWEEN 1 AND 5 
    WHERE CS1.SwitchNum != CS2.SwitchNum
    ```

    Этот запрос напоминает любое другое соединение SQL за исключением функции в соединении `DATEDIFF`. Эта версия функции `DATEDIFF` предназначена для Stream Analytics и должна присутствовать в предложении `ON...BETWEEN`. Параметры представлены единицей времени (в этом примере — секундами) и псевдонимами двух источников для соединения. В этом она отличается от стандартной функции SQL `DATEDIFF`.

    Предложение `WHERE` содержит условие, которое помечает мошеннический вызов — исходящие переключатели не совпадают. 

2. Снова щелкните **Проверка**. 

   ![Выходные данные задания Stream Analytics для самосоединения, которые включают 6 созданных записей](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-sample-output-self-join.png)

3. Щелкните **Сохранить**, и запрос на самосоединение сохранится как часть задания Stream Analytics. (Образец данных не сохраняется.)

    <br/><img src="./media/stream-analytics-real-time-fraud-detection/stream-analytics-query-editor-save-button-new-portal.png" alt="Save Stream Analytics query in portal" width="300px"/>

## <a name="create-an-output-sink-to-store-transformed-data"></a>Создание приемника выходных данных для хранения преобразованных данных

Вы определили поток событий, входные данные концентратора событий для приема событий и запрос для выполнения преобразования потока. Осталось определить приемник выходных данных для задания, т. е. место для записи преобразованного потока. 

Вы можете использовать многие ресурсы в качестве приемников выходных данных — базу данных SQL Server, хранилище таблиц, хранилище озера данных, Power BI и даже другой концентратор событий. В рамках этого руководства вы запишете поток в хранилище BLOB-объектов Azure. Это стандартный вариант для сбора сведений о событиях для последующего анализа, позволяющий использовать неструктурированные данные.

Если у вас есть учетная запись хранения BLOB-объектов, вы можете ее использовать. Из этого руководства вы узнаете, как создать учетную запись хранения.

### <a name="create-an-azure-blob-storage-account"></a>Создание учетной записи хранения BLOB-объектов Azure

1. В верхнем левом углу окна портала Azure выберите **Создать ресурс** > **Хранилище** > **Учетная запись хранения**. На странице заданий учетной записи хранения для параметра **Имя** введите значение asaehstorage, для параметра **Расположение** — "восточная часть США 2", для параметра **Группа ресурсов** — asa-eh-ns-rg (для повышения производительности разместите учетную запись хранения в той же группе ресурсов, что и задание потоковой передачи). Для остальных параметров можно оставить значения по умолчанию.  

   ![Создание учетной записи хранения на портале Azure](./media/stream-analytics-real-time-fraud-detection/stream-analytics-storage-account-create.png)

2. Вернитесь в область задания Streaming Analytics на портале Azure. (Если вы закрыли область, найдите `asa_frauddetection_job_demo` в области **Все ресурсы**.)

3. В разделе **Топологии задания** щелкните поле **Выходные данные**.

4. На панели **Выходные данные** щелкните **Добавить** и выберите **Хранилище BLOB-объектов**. Затем укажите на странице "Новые выходные данные" следующие сведения:

   |**Параметр**  |**Рекомендуемое значение**  |**Описание**  |
   |---------|---------|---------|
   |Псевдоним выходных данных  |  CallStream-FraudulentCalls   |  Введите имя, которое будет обозначать выходные данные задания.   |
   |Подписка   |  \<Ваша подписка\> |  Выберите подписку Azure, в которой создана учетная запись хранения. Учетная запись хранения может находиться в той же или в другой подписке. В этом примере предполагается, что вы создали учетную запись хранения в одной и той же подписке. |
   |Учетная запись хранения  |  asaehstorage |  Введите имя созданной учетной записи хранения. |
   |Контейнер  | asa-fraudulentcalls-demo | Выберите "Создать новый" и введите имя контейнера. |

    <br/>
    <img src="./media/stream-analytics-real-time-fraud-detection/stream-analytics-create-output-blob-storage-new-console.png" alt="Create blob output for Stream Analytics job" width="300px"/>
    
5. Выберите команду **Сохранить**. 


## <a name="start-the-streaming-analytics-job"></a>Запуск задания Streaming Analytics

Вы настроили задание. Вы указали входные данные (концентратор событий), преобразование (запрос для поиска мошеннических вызовов) и выходные данные (хранилище BLOB-объектов). Теперь вы можете запустить задание. 

1. Проверьте, чтобы приложение TelcoGenerator работало.

2. В области задания щелкните **Запуск**. В области **Запуск задания** для параметра "Время запуска создания выходных данных задания" выберите **Сейчас**. 

   ![Запуск задания Stream Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-start.png)



## <a name="examine-the-transformed-data"></a>Проверка преобразованных данных

Теперь у вас есть готовое задание Streaming Analytics. Задание проверяет поток метаданных телефонных вызовов, выполняет поиск мошеннических вызовов в режиме реального времени, а также записывает сведения об этих мошеннических вызовах в хранилище. 

Чтобы завершить работу с этим руководством, просмотрите данные, собранные заданием Streaming Analytics. Данные записываются в хранилище BLOB-объектов Azure в блоки (файлы). Вы можете использовать любое средство, считывающее хранилище BLOB-объектов Azure. Как упоминалось в разделе предварительных требований, вы можете использовать расширения Azure в Visual Studio или средства [обозреватель хранилищ Azure](https://storageexplorer.com/) или [Cerulean](https://www.cerebrata.com/products/cerulean/features/azure-storage). 

При проверке содержимого файла в хранилище BLOB-объектов должны отобразиться примерно такие данные:

   ![Хранилище BLOB-объектов Azure с выходными данными Streaming Analytics](./media/stream-analytics-real-time-fraud-detection/stream-analytics-sa-job-blob-storage-view.png)
 

## <a name="clean-up-resources"></a>Очистка ресурсов

Есть еще несколько статей, в рамках которых рассматриваются сценарии обнаружения мошенничества и используются ресурсы, созданные при работе с этим руководством. Если вы хотите ознакомиться с этими статьями, перейдите к разделу **Дополнительная информация**.

Если же этого руководства вам достаточно и созданные ресурсы вам больше не нужны, вы можете их удалить, чтобы за их использование не взималась плата. Чтобы удалить ресурсы, сделайте следующее:

1. Завершите задание Streaming Analytics. В области **Задания** в верхней области щелкните **Остановить**.
2. Завершите работу приложения TelcoGenerator. В командной строке, где вы запустили приложение, нажмите Ctrl+C.
3. Если вы создали новую учетную запись хранения BLOB-объектов только для работы с этим руководством, удалите ее. 
4. Удалите задание Streaming Analytics.
5. Удалите концентратор событий.
6. Удалите пространство имен концентратора событий.

## <a name="get-support"></a>Получение поддержки

Для получения дополнительной помощи воспользуйтесь [страницей вопросов и ответов о Microsoft Azure Stream Analytics](https://docs.microsoft.com/answers/topics/azure-stream-analytics.html).

## <a name="next-steps"></a>Дальнейшие действия

Вы можете ознакомиться со следующей статьей, связанной с этим руководством:

* [Stream Analytics и Power BI: панель мониторинга аналитики для потоковой передачи данных в режиме реального времени](stream-analytics-power-bi-dashboard.md). В этой статье описывается, как отправить выходные данные TelCo задания Stream Analytics в Power BI для визуализации и анализа в режиме реального времени.

Узнать больше о Stream Analytics в целом вы можете с помощью следующих ресурсов:

* [Введение в Azure Stream Analytics](stream-analytics-introduction.md)
* [Масштабирование заданий в службе Azure Stream Analytics](stream-analytics-scale-jobs.md)
* [Справочник по языку запросов Azure Stream Analytics](https://docs.microsoft.com/stream-analytics-query/stream-analytics-query-language-reference)
* [Справочник по API-интерфейсу REST управления Stream Analytics](https://msdn.microsoft.com/library/azure/dn835031.aspx)
