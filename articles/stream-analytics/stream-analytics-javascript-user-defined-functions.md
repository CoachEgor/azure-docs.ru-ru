---
title: Определяемые пользователем функции JavaScript в Azure Stream Analytics
description: С помощью этого руководства вы научитесь выполнять расширенные запросы с помощью определяемых пользователем функций JavaScript
services: stream-analytics
author: rodrigoamicrosoft
ms.author: rodrigoa
ms.service: stream-analytics
ms.topic: tutorial
ms.reviewer: mamccrea
ms.custom: mvc
ms.date: 04/01/2018
ms.openlocfilehash: 9ddf8a2a11cb863a0016726074c5279bfde96959
ms.sourcegitcommit: 92d42c04e0585a353668067910b1a6afaf07c709
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/28/2019
ms.locfileid: "72990224"
---
# <a name="tutorial-azure-stream-analytics-javascript-user-defined-functions"></a>Руководство по Определяемые пользователем функции JavaScript в Azure Stream Analytics
 
Azure Stream Analytics поддерживает определяемые пользователем функции, написанные на языке JavaScript. Благодаря обширному набору методов, которые предоставляют объекты JavaScript **String**, **RegExp**, **Math**, **Array** и **Date**, в заданиях Stream Analytics стало проще создавать сложные преобразования данных.

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * задавать определяемые пользователем функции JavaScript;
> * добавлять функцию на портал;
> * определять запрос для выполнения функции.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="javascript-user-defined-functions"></a>Определяемые пользователем функции JavaScript
Определяемые пользователем функции JavaScript поддерживают скалярные вычислительные функции без отслеживания состояния, не требующие внешнего подключения. Возвращаемое значение функции может быть только скалярным (одиночным). Добавив в задание определяемую пользователем функцию JavaScript, вы сможете использовать ее в любом месте запроса, например во встроенной скалярной функции.

Ниже приведены некоторые сценарии, в которых могут пригодиться определяемые пользователем функции JavaScript.
* Анализ и обработка строки с использованием функций регулярных выражений, например **Regexp_Replace()** или **Regexp_Extract()** .
* Декодирование и кодирование данных, например преобразование двоичных данных в шестнадцатеричные.
* Математические вычисления с помощью объекта JavaScript **Math**.
* Операции с массивами, такие как сортировка, присоединение, поиск и заполнение.

Вот некоторые действия, которые невозможно выполнить в Stream Analytics с помощью определяемой пользователем функции JavaScript.
* Вызов внешних конечных точек REST, например выполнение обратного разрешения IP-адресов или извлечение ссылочных данных из внешнего источника.
* Сериализация или десериализация входных и выходных данных в пользовательский формат сообщения.
* Создание пользовательских статистических функций.

Следует избегать использования таких функций, как **Date.GetDate()** или **Math.random()** , хотя они не запрещены в определении функции. Эти функции возвращают **разные** результаты при каждом вызове, а служба Azure Stream Analytics не ведет журнал вызовов и возвращаемых результатов для функций. Если функция возвращает разные результаты для одних и тех же событий, невозможно гарантировать повторяемость при перезапуске задания пользователем или службой Stream Analytics.

## <a name="add-a-javascript-user-defined-function-in-the-azure-portal"></a>Добавление определяемой пользователем функции JavaScript на портале Azure
Чтобы создать простую определяемую пользователем функцию JavaScript в существующем задании Stream Analytics, выполните следующие действия.

> [!NOTE]
> Эти действия подходят для заданий Stream Analytics, настроенных для работы в облаке. Если задание Stream Analytics настроено для работы в Azure IoT Edge, используйте вместо этого Visual Studio и [напишите определяемую пользователем функцию, используя C#](stream-analytics-edge-csharp-udf.md).

1.  Найдите нужное задание Stream Analytics на портале Azure.

2. В разделе заголовка **Топология задания** выберите **Функции**. Откроется пустой список функций.

3.  Чтобы создать определяемую пользователем функцию, выберите **+ Добавить**.

4.  В колонке **Новая функция** для параметра **Тип функции** выберите значение **JavaScript**. В редакторе отобразится стандартный шаблон функции.

5.  В качестве значения для параметра **UDF alias**, введите **hex2Int**, затем измените реализацию функции, как показано ниже.

    ```javascript
    // Convert Hex value to integer.
    function hex2Int(hexValue) {
        return parseInt(hexValue, 16);
    }
    ```

6.  Щелкните **Сохранить**. Функция отобразится в списке функций.
7.  Выберите новую функцию **hex2Int** и проверьте определение функции. Для всех пользовательских функций к псевдониму добавляется префикс **UDF**. Этот *префикс нужно использовать* при вызове функции из запроса Stream Analytics. В нашем примере нужно вызывать функцию **UDF.hex2Int**.

## <a name="testing-javascript-udfs"></a>Тестирование определяемых пользователем функций JavaScript 
Вы можете тестировать и отлаживать логику UDF JavaScript в любом браузере. Отладка и тестирование логики этих определяемых пользователем функций сейчас не поддерживается на портале Stream Analytics. Когда функция заработает правильно, ее можно будет добавить в задание Stream Analytics, как упоминалось выше, а затем вызвать ее непосредственно из запроса.

## <a name="call-a-javascript-user-defined-function-in-a-query"></a>Вызов определяемой пользователем функции из запроса

1. В редакторе запросов в разделе заголовка **Топология задания** выберите **Запрос**.
2.  Откройте режим редактирования запроса и добавьте вызов определяемой пользователем функции, как показано здесь:

    ```SQL
    SELECT
        time,
        UDF.hex2Int(offset) AS IntOffset
    INTO
        output
    FROM
        InputStream
    ```

3.  Чтобы передать пример файла данных, щелкните правой кнопкой мыши входные данные задания.
4.  Чтобы проверить запрос, выберите **Тестирование**.


## <a name="supported-javascript-objects"></a>Поддерживаемые объекты JavaScript
Определяемые пользователем функции JavaScript в Azure Stream Analytics могут использовать все стандартные встроенные объекты JavaScript. Список этих объектов вы найдете [здесь](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects).

### <a name="stream-analytics-and-javascript-type-conversion"></a>Преобразование типов Stream Analytics и JavaScript

Существуют различия между типами, которые поддерживаются в языке запросов Stream Analytics и в JavaScript. В следующей таблице перечислены сопоставления преобразования между этими типами.

Stream Analytics | JavaScript
--- | ---
bigint | Число (JavaScript может представлять целые числа только до значения 2^53).
Дата и время | Дата (JavaScript поддерживает только миллисекунды)
Double | Number
nvarchar(MAX) | Строка,
Record | Объект.
Массив, | Массив,
NULL | Null


Ниже описаны преобразования из типов JavaScript в типы Stream Analytics.


JavaScript | Stream Analytics
--- | ---
Number | Значение типа bigint, если это целое число в диапазоне от long.MinValue до long.MaxValue. Иначе используется тип double.
Дата | Дата и время
Строка, | nvarchar(MAX)
Объект. | Record
Массив, | Массив,
NULL, не определено | NULL
Любой другой тип (например, функция или ошибка) | Не поддерживается (возникает ошибка времени выполнения)

Язык JavaScript учитывает регистр, поэтому регистр полей объекта в коде JavaScript должен совпадать с регистром полей во входных данных. Обратите внимание, что в заданиях с уровнем совместимости 1.0 в полях из инструкции SQL SELECT текст преобразуется в нижний регистр. При уровне совместимости 1.1 и выше поля из инструкции SELECT будут иметь тот же регистр, что и в запросе SQL.

## <a name="troubleshooting"></a>Устранение неполадок
Ошибки времени выполнения JavaScript считаются неустранимыми и регистрируются в журнале действий. Чтобы получить этот журнал, перейдите на портале Azure к нужному заданию и щелкните **Журнал действий**.

## <a name="other-javascript-user-defined-function-patterns"></a>Другие методы использования определяемой пользователем функции

### <a name="write-nested-json-to-output"></a>Вывод вложенных значений JSON
Если вы используете этап обработки результатов, на котором входными данными являются выходные данные в формате JSON задания Stream Analytics, вам нужно записать строку JSON в выходные данные. Приведенный ниже пример вызывает функцию **JSON.stringify()** , которая упаковывает все полученные пары "имя — значение" и передает их единой строкой в качестве выходных данных.

**Определение определяемой пользователем функции JavaScript:**

```javascript
function main(x) {
return JSON.stringify(x);
}
```

**Пример запроса**
```SQL
SELECT
    DataString,
    DataValue,
    HexValue,
    UDF.json_stringify(input) As InputEvent
INTO
    output
FROM
    input PARTITION BY PARTITIONID
```

## <a name="clean-up-resources"></a>Очистка ресурсов

Ставшие ненужными группу ресурсов, задание потоковой передачи и все связанные ресурсы можно удалить. При удалении задания будет прекращена тарификация за единицы потоковой передачи, потребляемые заданием. Если вы планируете использовать это задание в будущем, вы можете остановить и перезапустить его позже при необходимости. Если вы не собираетесь использовать это задание дальше, удалите все ресурсы, созданные в ходе работы с этим руководством, выполнив следующие шаги:

1. В меню слева на портале Azure щелкните **Группы ресурсов**, а затем выберите имя созданного ресурса.  
2. На странице группы ресурсов щелкните **Удалить**, в текстовом поле введите имя ресурса для удаления и щелкните **Удалить**.

## <a name="get-help"></a>Получение справки
Дополнительную помощь и поддержку вы можете получить на нашем [форуме Azure Stream Analytics](https://social.msdn.microsoft.com/Forums/azure/home?forum=AzureStreamAnalytics).

## <a name="next-steps"></a>Дополнительная информация

С помощью этого руководства вы создали задание Stream Analytics, в котором выполняется простая определяемая пользователем функция JavaScript. Дополнительные сведения о Stream Analytics см в последующих статьях, посвященных сценариям в режиме реального времени:

> [!div class="nextstepaction"]
> [Анализ тональности в Twitter в режиме реального времени в Azure Stream Analytics](stream-analytics-twitter-sentiment-analysis-trends.md)
