---
title: Устранение неполадок Azure Stream Analytics с использованием журналов диагностики
description: В этой статье объясняется, как анализировать журналы диагностики в Azure Stream Analytics.
services: stream-analytics
author: jseb225
ms.author: jeanb
ms.reviewer: jasonh
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 06/21/2019
ms.openlocfilehash: 68c40cf893bf150756f0a03056473e82cff5754f
ms.sourcegitcommit: 6a42dd4b746f3e6de69f7ad0107cc7ad654e39ae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/07/2019
ms.locfileid: "67620961"
---
# <a name="troubleshoot-azure-stream-analytics-by-using-diagnostics-logs"></a>Устранение неполадок Azure Stream Analytics с помощью журналов диагностики

В некоторых случаях обработка задания Azure Stream Analytics неожиданно прекращается. Очень важно иметь возможность устранения подобных проблем. Сбои могут случиться из-за непредвиденного результата запроса, подключения к устройствам или неожиданного сбоя службы. Журналы диагностики в Stream Analytics могут помочь определить причину проблемы и ускорить восстановление.

Настоятельно рекомендуется включить журналы диагностики для всех производственных заданий.

## <a name="log-types"></a>Типы журналов

Stream Analytics предоставляет журналы двух типов:

* [журналы действий](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-overview-activity-logs) (всегда включены), содержащие ценные сведения об операциях, выполняемых в заданиях;

* [журналы диагностики](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs) (настраиваемые) с подробными сведениями обо всех событиях в задании. Журналы диагностики начинают регистрировать данные при создании задания и прекращают при его удалении. Они фиксируют события при обновлении и выполнении задания.

> [!NOTE]
> Можно использовать службу хранилища Azure, концентраторов событий и журналы Azure Monitor для анализа несоответствующих данных. Плата за использование служб взимается с учетом модели ценообразования.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

## <a name="debugging-using-activity-logs"></a>Отладка с помощью журналов действий

Журналы действий включены по умолчанию и содержат аналитические сведения высокого уровня об операциях, выполняемых заданием Stream Analytics. Данные, находящиеся в журналах действий, могут помочь найти причину проблемы, влияющей на ваше задание. Выполните следующие действия, чтобы использовать журналы действий в Stream Analytics.

1. Войдите на портал Azure в разделе **Обзор** и выберите **Журнал действий**.

   ![Журнал действий Stream Analytics](./media/stream-analytics-job-diagnostic-logs/stream-analytics-menu.png)

2. Отобразится список выполненных операций. Рядом с любой операцией, которая вызвала сбой вашего задания, есть красный информационный пузырек.

3. Выберите операцию, чтобы увидеть представление сводки. Здесь информация часто ограничена. Чтобы получить дополнительные сведения об операции, выберите **JSON**.

   ![Сводка операции журнала действий Stream Analytics](./media/stream-analytics-job-diagnostic-logs/operation-summary.png)

4. Прокрутите вниз до раздела **Свойства** в JSON, который предоставляет сведения об ошибке, вызвавшей неудавшуюся операцию. В этом примере ошибка произошла из-за ошибки времени выполнения и превышения значений широты. Несоответствие в данных, обрабатываемых в задание Stream Analytics вызывает ошибку данных. Вы можете узнать о разных [входные и выходные данные ошибок и причинах их возникновения](https://docs.microsoft.com/azure/stream-analytics/data-errors).

   ![Сведения об ошибке JSON](./media/stream-analytics-job-diagnostic-logs/error-details.png)

5. Вы можете предпринять корректирующие действия, основываясь на сообщении ошибки в JSON. В этом примере в запрос необходимо добавить проверку значения широты в диапазоне от –90 до 90 градусов.

6. Если сообщение об ошибке в журналах действий не слишком полезна при определении основной причины, включить журналы диагностики и использовать журналы Azure Monitor.

## <a name="send-diagnostics-to-azure-monitor-logs"></a>Отправка данных диагностики в Azure Monitor журналы

Включение журналов диагностики и отправки их в Azure Monitor журналов настоятельно рекомендуется. По умолчанию журналы диагностики **отключены**. Чтобы включить журналы диагностики, сделайте следующее:

1.  Войдите на портал Azure и перейдите к заданию Stream Analytics. В разделе **Мониторинг**выберите **Журналы диагностики**. Затем выберите **Turn on diagnostics** (Включить диагностику).

    ![Перемещение к колонке журналов диагностики](./media/stream-analytics-job-diagnostic-logs/diagnostic-logs-monitoring.png)  

2.  Создайте **имя** в **параметрах диагностики** и установите флажок рядом с пунктом **Отправить в Log Analytics**. Затем добавьте имеющуюся рабочую область Log Analytics **или создайте новую**. Установите флажки **выполнения** и **разработки** в разделе **журнала**, а в разделе **метрики** — **AllMetrics**. Нажмите кнопку **Сохранить**. Рекомендуется использовать рабочую область Log Analytics в том же регионе Azure с заданием Stream Analytics, чтобы предотвратить дополнительные затраты.

    ![Параметры журналов диагностики](./media/stream-analytics-job-diagnostic-logs/diagnostic-settings.png)

3. При запуске задания Stream Analytics журналы диагностики направляются в рабочую область Log Analytics. Перейдите к рабочей области Log Analytics и в разделе **Общее** выберите **Журналы**.

   ![Журналы Azure Monitor, в разделе "Общие"](./media/stream-analytics-job-diagnostic-logs/log-analytics-logs.png)

4. Вы можете [писать собственные запросы](../azure-monitor/log-query/get-started-portal.md), чтобы искать термины, определять тенденции, анализировать шаблоны и предоставлять аналитические сведения на основе данных. Например, вы можете написать запрос, чтобы фильтровать только журналы диагностики с сообщением "Задание потоковой передачи завершилось со сбоем". Журналы диагностики из Azure Stream Analytics хранятся в таблице **AzureDiagnostics**.

   ![Запрос и результаты диагностики](./media/stream-analytics-job-diagnostic-logs/diagnostic-logs-query.png)

5. При запросе, выполняющем поиск соответствующих журналов, сохраните его, выбрав **Сохранить**, и укажите имя и категорию. Затем можно создать оповещение, выбрав **новое правило генерации оповещений**. Затем укажите условие оповещения. Выберите **Условие** и введите пороговое значение и частоту, с которой этот пользовательский поиск по журналам вычисляется.  

   ![Запрос поиска по журналам диагностики](./media/stream-analytics-job-diagnostic-logs/search-query.png)

6. Выберите группу действий и укажите сведения об оповещении, такие как имя и описание, прежде чем вы сможете создать правило генерации оповещений. Журналы диагностики из различных заданий можно направлять в одну и ту же рабочую область Log Analytics. Благодаря этому можно настроить оповещения, работающие по всем заданиям.  

## <a name="diagnostics-log-categories"></a>Категории журналов диагностики

Azure Stream Analytics записывает две категории журналов диагностики:

* **Разработка**. Позволяет записывать события в журналы, связанные с операциями разработки заданий: создание, добавление и удаление входных и выходных данных, добавление и обновление запроса, запуск и остановка задания.

* **Выполнение**. Позволяет записывать в журнал все события, происходящие во время выполнения задания:
    * Ошибки подключения.
    * Ошибки обработки данных:
        * события, которые не соответствуют определению запроса (несовпадение типов полей и значений, отсутствие полей и т. п.);
        * ошибки оценки выражений.
    * Другие события и ошибки.

## <a name="diagnostics-logs-schema"></a>Схема журналов диагностики

Все журналы хранятся в формате JSON. Каждая запись содержит следующие общие строковые поля.

ИМЯ | Описание
------- | -------
time | Метка времени журнала (в формате UTC).
resourceId | Идентификатор ресурса (прописными буквами), с которым была выполнена операция. Содержит идентификатор подписки, группу ресурсов и имя задания. Например, **/SUBSCRIPTIONS/6503D296-DAC1-4449-9B03-609A1F4A1C87/RESOURCEGROUPS/MY-RESOURCE-GROUP/PROVIDERS/MICROSOFT.STREAMANALYTICS/STREAMINGJOBS/MYSTREAMINGJOB**.
category | Категория журнала, **Выполнение** или **Разработка**.
operationName | Имя операции, добавленной в журнал. Например, **Send Events: SQL Output write failure to mysqloutput** (События отправки: ошибка записи выходных данных SQL в mysqloutput).
status | Состояние операции. Например, **Сбой** или **Успешно выполнено**.
уровень | Уровень ведения журнала. Например, **Ошибка**, **Предупреждение** или **Информация**.
properties | Сведения о записи журнала, сериализованные в строку JSON. Дополнительные сведения приведены в следующем разделе этой статьи.

### <a name="execution-log-properties-schema"></a>Схема свойств журнала выполнения

Журналы выполнения содержат сведения о событиях, произошедших при выполнении задания Stream Analytics. Схема свойств зависит от того, является ли событие ошибки данных или общих событий.

### <a name="data-errors"></a>Ошибки данных

Любая ошибка, возникающая при обработке данных в задании, находится в этой категории журналов. Чаще всего эти журналы создаются во время операций чтения, сериализации и записи. Эти журналы не содержат ошибок подключения, которые обрабатываются как универсальные события. Дополнительные сведения о причине различных разных [входные и выходные данные ошибок](https://docs.microsoft.com/azure/stream-analytics/data-errors).

ИМЯ | Описание
------- | -------
Source | Имя входных или выходных данных задания, в которых произошла ошибка.
Сообщение | Сообщение, связанное с ошибкой.
Тип | Тип ошибки. Например **DataConversionError**, **CsvParserError** или **ServiceBusPropertyColumnMissingError**.
Data | Содержит данные, полезные для точного поиска источника ошибки. Значение может быть усечено в зависимости от размера.

В зависимости от значения **operationName** ошибки данных имеют следующую схему:

* **Сериализация событий** произойти во время операций чтения. если входные данные не соответствуют схеме запроса по одной из следующих причин:

   * *несоответствие типов при десериализации или сериализации события*: определяет поле, вызывающее ошибку.

   * *Не удается прочитать события, недопустимая сериализация*: содержит сведения о том, где во входных данных произошла ошибка. (имя входного большого двоичного объекта, смещение и примеры данных).

* **Отправка событий** произойти во время операций записи. Они определяют событие потоковой передачи, вызвавшее ошибку.

### <a name="generic-events"></a>Универсальные события

Остальные типы ошибок считаются универсальными событиями.

ИМЯ | Описание
-------- | --------
Error | (Необязательно.) Сведения об ошибке. Как правило, это сведения об исключении (если они доступны).
Сообщение| Сообщение журнала.
Тип | Тип сообщения. Сопоставляется с внутренней классификацией ошибок. Например **JobValidationError** или **BlobOutputAdapterInitializationFailure**.
Идентификатор корреляции | Идентификатор [GUID](https://en.wikipedia.org/wiki/Universally_unique_identifier), однозначно определяющий выполнение задания. Все записи журнала, зафиксированные с начала до завершения задания, имеют одинаковое значение **идентификатора корреляции**.

## <a name="next-steps"></a>Следующие шаги

* [Что такое Stream Analytics?](stream-analytics-introduction.md)
* [Приступая к работе с Azure Stream Analytics: выявление мошенничества в режиме реального времени](stream-analytics-real-time-fraud-detection.md)
* [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности базы данных](stream-analytics-scale-jobs.md)
* [Stream Analytics Query Language Reference](https://docs.microsoft.com/stream-analytics-query/stream-analytics-query-language-reference) (Справочник по языку запросов Stream Analytics)
* [Ошибки данных Stream Analytics](https://docs.microsoft.com/azure/stream-analytics/data-errors)
