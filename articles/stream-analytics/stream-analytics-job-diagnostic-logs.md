---
title: Устранение неполадок Azure Stream Analytics с использованием журналов диагностики
description: В этой статье объясняется, как анализировать журналы диагностики в Azure Stream Analytics.
author: jseb225
ms.author: jeanb
ms.reviewer: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 03/27/2020
ms.openlocfilehash: cdb6629441becd0a8356debe3360830ff11a7a9d
ms.sourcegitcommit: 632e7ed5449f85ca502ad216be8ec5dd7cd093cb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2020
ms.locfileid: "80398426"
---
# <a name="troubleshoot-azure-stream-analytics-by-using-diagnostics-logs"></a>Устранение неполадок Azure Stream Analytics с помощью журналов диагностики

В некоторых случаях обработка задания Azure Stream Analytics неожиданно прекращается. Очень важно иметь возможность устранения подобных проблем. Сбои могут случиться из-за непредвиденного результата запроса, подключения к устройствам или неожиданного сбоя службы. Журналы диагностики в Stream Analytics могут помочь определить причину проблемы и ускорить восстановление.

Настоятельно рекомендуется включить диагностические журналы для всех заданий, так как это в значительной степени поможет с отладкой и мониторингом.

## <a name="log-types"></a>Типы журналов

Stream Analytics предоставляет журналы двух типов:

* [журналы действий](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-overview-activity-logs) (всегда включены), содержащие ценные сведения об операциях, выполняемых в заданиях;

* [журналы диагностики](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs) (настраиваемые) с подробными сведениями обо всех событиях в задании. Журналы диагностики начинают регистрировать данные при создании задания и прекращают при его удалении. Они фиксируют события при обновлении и выполнении задания.

> [!NOTE]
> Для анализа несоответствующих данных можно использовать такие службы, как журналы Azure Storage, Azure Event Hubs и Azure Monitor. Плата за использование служб взимается с учетом модели ценообразования.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

## <a name="debugging-using-activity-logs"></a>Отладка с помощью журналов действий

Журналы действий включены по умолчанию и содержат аналитические сведения высокого уровня об операциях, выполняемых заданием Stream Analytics. Данные, находящиеся в журналах действий, могут помочь найти причину проблемы, влияющей на ваше задание. Выполните следующие действия, чтобы использовать журналы действий в Stream Analytics.

1. Войдите на портал Azure в разделе **Обзор** и выберите **Журнал действий**.

   ![Журнал действий Stream Analytics](./media/stream-analytics-job-diagnostic-logs/stream-analytics-menu.png)

2. Отобразится список выполненных операций. Рядом с любой операцией, которая вызвала сбой вашего задания, есть красный информационный пузырек.

3. Выберите операцию, чтобы увидеть представление сводки. Здесь информация часто ограничена. Чтобы получить дополнительные сведения об операции, выберите **JSON**.

   ![Сводка операции журнала действий Stream Analytics](./media/stream-analytics-job-diagnostic-logs/operation-summary.png)

4. Прокрутите вниз до раздела **Свойства** в JSON, который предоставляет сведения об ошибке, вызвавшей неудавшуюся операцию. В этом примере ошибка произошла из-за ошибки времени выполнения и превышения значений широты. Несоответствие данных, обрабатываемых заданием Stream Analytics, приводит к ошибке данных. Вы можете узнать о различных [ошибках ввода и вывода данных и о](https://docs.microsoft.com/azure/stream-analytics/data-errors)том, почему они возникают.

   ![Сведения об ошибке JSON](./media/stream-analytics-job-diagnostic-logs/error-details.png)

5. Вы можете предпринять корректирующие действия, основываясь на сообщении ошибки в JSON. В этом примере в запрос необходимо добавить проверку значения широты в диапазоне от –90 до 90 градусов.

6. Если сообщение об ошибке в журналах activity не помогает в определении основной причины, включите диагностические журналы и используйте журналы Azure Monitor.

## <a name="send-diagnostics-to-azure-monitor-logs"></a>Отправка диагностики в журналы Azure Monitor

Рекомендуется включить диагностические журналы и отправить их в журналы Azure Monitor. По умолчанию журналы диагностики **отключены**. Чтобы включить журналы диагностики, сделайте следующее:

1.  Войдите на портал Azure и перейдите к заданию Stream Analytics. В разделе **Мониторинг**выберите **Журналы диагностики**. Затем выберите **Turn on diagnostics** (Включить диагностику).

    ![Перемещение к колонке журналов диагностики](./media/stream-analytics-job-diagnostic-logs/diagnostic-logs-monitoring.png)  

2.  Создайте **имя** в **параметрах диагностики** и установите флажок рядом с пунктом **Отправить в Log Analytics**. Затем добавьте имеющуюся рабочую область Log Analytics **или создайте новую**. Установите флажки **выполнения** и **разработки** в разделе **журнала**, а в разделе **метрики** — **AllMetrics**. Нажмите **Сохранить**. Рекомендуется использовать рабочее пространство журнала Analytics в том же регионе Azure, что и задание Stream Analytics, чтобы предотвратить дополнительные расходы.

    ![Параметры журналов диагностики](./media/stream-analytics-job-diagnostic-logs/diagnostic-settings.png)

3. При запуске задания Stream Analytics журналы диагностики направляются в рабочую область Log Analytics. Для просмотра диагностических журналов для вашей работы выберите **журналы** в разделе **Мониторинг.**

   ![Диагностические журналы под мониторингом](./media/stream-analytics-job-diagnostic-logs/diagnostic-logs.png)

4. Stream Analytics предоставляет заранее определенные запросы, которые позволяют легко искать интересующие вас журналы. 3 категории: **Общие,** **Ошибки входных данных** и **ошибки данных вывода.** Например, чтобы просмотреть резюме всех ошибок вашей работы за последние 7 дней, можно выбрать **Запуск** соответствующего заранее определенного запроса. 

   ![Диагностические журналы под мониторингом](./media/stream-analytics-job-diagnostic-logs/logs-categories.png)

   ![Результаты журналов](./media/stream-analytics-job-diagnostic-logs/logs-result.png)

## <a name="diagnostics-log-categories"></a>Категории журналов диагностики

Azure Stream Analytics фиксирует две категории журналов диагностики:

* **Авторство**: Захваты событий журнала, связанных с операциями авторства рабочих мест, таких как создание рабочих мест, добавление и удаливание входов и выходных данных, добавление и обновление запроса, а также запуск или остановка задания.

* **Выполнение**: Захват событий, которые происходят во время выполнения задания.
    * Ошибки подключения.
    * Ошибки обработки данных:
        * события, которые не соответствуют определению запроса (несовпадение типов полей и значений, отсутствие полей и т. п.);
        * ошибки оценки выражений.
    * Другие события и ошибки.

## <a name="diagnostics-logs-schema"></a>Схема журналов диагностики

Все журналы хранятся в формате JSON. Каждая запись содержит следующие общие строковые поля.

Имя | Описание
------- | -------
time | Метка времени журнала (в формате UTC).
resourceId | Идентификатор ресурса (прописными буквами), с которым была выполнена операция. Содержит идентификатор подписки, группу ресурсов и имя задания. Например, **/SUBSCRIPTIONS/6503D296-DAC1-4449-9B03-609A1F4A1C87/RESOURCEGROUPS/MY-RESOURCE-GROUP/PROVIDERS/MICROSOFT.STREAMANALYTICS/STREAMINGJOBS/MYSTREAMINGJOB**.
категория | Категория журнала, **Выполнение** или **Разработка**.
operationName | Имя операции, добавленной в журнал. Например, **«Отправить события: Выход s'L написать сбой mysqloutput.**
status | Состояние операции. Например, **Сбой** или **Успешно выполнено**.
level | Уровень ведения журнала. Например, **Ошибка**, **Предупреждение** или **Информация**.
properties | Сведения о записи журнала, сериализованные в строку JSON. Дополнительные сведения приведены в следующем разделе этой статьи.

### <a name="execution-log-properties-schema"></a>Схема свойств журнала выполнения

Журналы выполнения содержат сведения о событиях, произошедших при выполнении задания Stream Analytics. Схема свойств варьируется в зависимости от того, является ли событие ошибкой данных или общим событием.

### <a name="data-errors"></a>Ошибки данных

Любая ошибка, возникающая при обработке данных в задании, находится в этой категории журналов. Чаще всего эти журналы создаются во время операций чтения, сериализации и записи. Эти журналы не содержат ошибок подключения, которые обрабатываются как универсальные события. Вы можете узнать больше о причинах различных [ошибок ввода и вывода данных.](https://docs.microsoft.com/azure/stream-analytics/data-errors)

Имя | Описание
------- | -------
Источник | Имя входных или выходных данных задания, в которых произошла ошибка.
Сообщение | Сообщение, связанное с ошибкой.
Тип | Тип ошибки. Например **DataConversionError**, **CsvParserError** или **ServiceBusPropertyColumnMissingError**.
Данные | Содержит данные, полезные для точного поиска источника ошибки. Значение может быть усечено в зависимости от размера.

В зависимости от значения **operationName** ошибки данных имеют следующую схему:

* **Сериализация событий** происходит во время операций чтения событий. если входные данные не соответствуют схеме запроса по одной из следующих причин:

   * *Несоответствие типов во время десериализации или сериализации события*: определяет поле, вызывающее ошибку.

   * *Не удается прочитать события, недопустимая сериализация*: содержит сведения о месте во входных данных, где произошла ошибка (имя входного большого двоичного объекта, смещение и примеры данных).

* **Отправка событий, происходящих** во время операций записи. Они определяют событие потоковой передачи, вызвавшее ошибку.

### <a name="generic-events"></a>Универсальные события

Остальные типы ошибок считаются универсальными событиями.

Имя | Описание
-------- | --------
Error | (Необязательно.) Сведения об ошибке. Как правило, это сведения об исключении (если они доступны).
Сообщение| Сообщение журнала.
Тип | Тип сообщения. Сопоставляется с внутренней классификацией ошибок. Например **JobValidationError** или **BlobOutputAdapterInitializationFailure**.
Идентификатор корреляции | Идентификатор [GUID](https://en.wikipedia.org/wiki/Universally_unique_identifier), однозначно определяющий выполнение задания. Все записи журнала, зафиксированные с начала до завершения задания, имеют одинаковое значение **идентификатора корреляции**.

## <a name="next-steps"></a>Следующие шаги

* [Что такое Stream Analytics?](stream-analytics-introduction.md)
* [Начало работы со Stream Analytics](stream-analytics-real-time-fraud-detection.md)
* [Масштабирование заданий Stream Analytics](stream-analytics-scale-jobs.md)
* [Ссылка на язык запроса Stream Analytics](https://docs.microsoft.com/stream-analytics-query/stream-analytics-query-language-reference)
* [Ошибки данных Stream Analytics](https://docs.microsoft.com/azure/stream-analytics/data-errors)
