---
title: Использование управляемых удостоверений для доступа к Базе данных SQL Azure — Azure Stream Analytics
description: В этой статье объясняется, как использовать управляемые удостоверения для проверки подлинности заданий Azure Stream Analytics для вывода данных в Базе данных SQL Azure.
author: mamccrea
ms.author: mamccrea
ms.service: stream-analytics
ms.topic: how-to
ms.date: 05/08/2020
ms.openlocfilehash: 26644d42e0e51d59c6c28daaba5447a65a43b6a5
ms.sourcegitcommit: a0c4499034c405ebc576e5e9ebd65084176e51e4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/29/2020
ms.locfileid: "91460647"
---
# <a name="use-managed-identities-to-access-azure-sql-database-from-an-azure-stream-analytics-job-preview"></a>Использование управляемых удостоверений для доступа к Базе данных SQL Azure из задания Azure Stream Analytics (предварительная версия)

Azure Stream Analytics поддерживает [проверку подлинности управляемого удостоверения](../active-directory/managed-identities-azure-resources/overview.md) для приемников выходных данных Базы данных SQL Azure. Управляемые удостоверения устраняют ограничения методов проверки подлинности на основе пользователя, например, необходимость повторной проверки подлинности в связи с изменением пароля или истечением срока действия пользовательского токена, которое происходит каждые 90 дней. При устранении необходимости в ручной проверке подлинности ваши развертывания Stream Analytics можно полностью автоматизировать.

Управляемое удостоверение — это зарегистрированное в Azure Active Directory управляемое приложение, представляющее данное задание Stream Analytics. Управляемое приложение используется для проверки подлинности в целевом ресурсе. В этой статье показано, как включить управляемое удостоверение для выходных данных SQL Azure для задания Stream Analytics с помощью портала Azure.

## <a name="prerequisites"></a>Предварительные требования

Ниже перечислены обязательные компоненты:

- Задание Azure Stream Analytics.

- Ресурс для Базы данных SQL Azure.

## <a name="create-a-managed-identity"></a>Создание управляемого удостоверения

Сначала вы создадите управляемое удостоверение для задания Azure Stream Analytics.

1. На [портале Azure](https://portal.azure.com) откройте задание Stream Analytics.

1. В меню навигации слева в разделе **Настройка** щелкните **Управляемое удостоверение**. Затем установите флажок **Использовать управляемое удостоверение, назначаемое системой** и нажмите кнопку **Сохранить**.

   ![Выбор управляемого удостоверения, назначаемого системой](./media/sql-db-output-managed-identity/system-assigned-managed-identity.png)


   Субъект-служба для удостоверения задания Stream Analytics создается в Azure Active Directory. Жизненным циклом нового удостоверения будет управлять Azure. При удалении задания Stream Analytics Azure автоматически удаляет связанное удостоверение (то есть субъект-службу). 

1. Если конфигурация сохраняется, идентификатор объекта (OID) субъекта-службы отображается в качестве идентификатора субъекта, как показано ниже: 

   ![Идентификатор объекта, отображаемый в качестве идентификатора субъекта](./media/sql-db-output-managed-identity/principal-id.png)

   Субъект-служба имеет то же имя, что и задание Stream Analytics. Например, если имя задания — *MyASAJob*, имя созданного субъекта-службы будет также *MyASAJob*.

## <a name="select-an-active-directory-admin"></a>Выбор администратора Active Directory

После создания управляемого удостоверения необходимо выбрать администратора Active Directory.

1. Перейдите к ресурсу базы данных SQL Azure и выберите SQL Server, где расположена база данных. Имя SQL Server можно найти рядом с разделом *Имя сервера* на странице обзора ресурсов. 

1. Выберите **Администратор Active Directory** в разделе **Параметры**. Затем выберите **Задать администратора**. 

   ![Страница администрирования Active Directory](./media/sql-db-output-managed-identity/active-directory-admin-page.png)
 
1. На странице администрирования Active Directory выберите пользователя (или группу), чтобы назначить его администратором SQL Server, и нажмите кнопку **Выбрать**.

   ![Добавление администратора Active Directory](./media/sql-db-output-managed-identity/add-admin.png)

   На странице "Администратор Active Directory" отобразятся все участники и группы Active Directory. Пользователи или группы, которые недоступны, не могут быть выбраны, так как они не поддерживаются как администраторы Azure Active Directory. Список поддерживаемых администраторов см. в разделе **Azure Active Directory функции и ограничения**   статьи [использование проверки подлинности Azure Active Directory для проверки подлинности с помощью базы данных SQL или Azure синапсе](../sql-database/sql-database-aad-authentication.md#azure-ad-features-and-limitations). Управление доступом на основе ролей (RBAC) применяется только к порталу и не распространяется на SQL Server. Кроме того, выбранный пользователь или выбранная группа могут создать **пользователя автономной базы данных** в следующем разделе.

1. На странице **Администратор Active Directory** нажмите кнопку **Сохранить**. Процесс смены администратора занимает несколько минут.

   При настройке администратора Azure Active Directory новое имя администратора (пользователя или группы) не может присутствовать в виртуальной базе данных-источнике в качестве пользователя проверки подлинности SQL Server. Если этот параметр присутствует, то Установка администратора Azure Active Directory завершится сбоем и будет выполнена откат, что означает, что администратор (имя) уже существует. Так как пользователь SQL Server проверки подлинности не является частью Azure Active Directory, все усилия по подключению к серверу с использованием проверки подлинности Azure Active Directory в случае сбоя этого пользователя. 

## <a name="create-a-contained-database-user"></a>Создание пользователя автономной базы данных

Затем создайте в Базе данных SQL пользователя автономной базы данных, сопоставленного с удостоверением Azure Active Directory. У пользователя автономной базы данных нет имени входа для базы данных-источника, но оно сопоставляется с удостоверением в каталоге, связанном с базой данных. Удостоверением Azure AD может быть учетная запись отдельного пользователя или группы. В этом случае необходимо создать пользователя автономной базы данных для задания Stream Analytics. 

1. Подключитесь к базе данных SQL с помощью SQL Server Management Studio. В качестве**имени пользователя** укажите пользователь Azure Active Directory с разрешением **ALTER ANY USER**. Примером может быть администратор, заданный в SQL Server. Используйте универсальную проверку подлинности **Azure Active Directory с MFA**. 

   ![Подключение к SQL Server](./media/sql-db-output-managed-identity/connect-sql-server.png)

   Имя сервера `<SQL Server name>.database.windows.net` может отличаться в разных регионах. Например, в регионе Китая используйте `<SQL Server name>.database.chinacloudapi.cn`.
 
   Вы можете указать конкретную Базу данных SQL, выбрав **Параметры > Свойства подключения > Подключиться к базе данных**.  

   ![Свойства подключения SQL Server](./media/sql-db-output-managed-identity/sql-server-connection-properties.png)

1. При первом подключении может появиться следующее окно:

   ![Окно нового правила брандмауэра](./media/sql-db-output-managed-identity/new-firewall-rule.png)

   1. В этом случае перейдите к ресурсу SQL Server на портале Azure. В разделе **Безопасность** откройте страницу **Брандмауэры и виртуальная сеть**. 
   1. Добавьте новое правило с любым именем.
   1. Используйте IP-адрес *Из* в окне **Новое правило брандмауэра** для параметра *Начальный IP-адрес*.
   1. Используйте IP-адрес *К* в окне **Новое правило брандмауэра** для параметра *Конечный IP-адрес*. 
   1. Нажмите кнопку **Сохранить** и повторите попытку подключения из SQL Server Management Studio. 

1. После подключения создайте пользователя автономной базы данных. Следующая команда SQL создает пользователя автономной базы данных с тем же именем, что и у задания Stream Analytics. Не забудьте добавить квадратные скобки вокруг *ASA_JOB_NAME*. Используйте следующий синтаксис T-SQL и выполните запрос. 

   ```sql
   CREATE USER [ASA_JOB_NAME] FROM EXTERNAL PROVIDER; 
   ```

1. Чтобы с помощью Microsoft Azure Active Directory можно было проверить, имеет ли задание Stream Analytics доступ к базе данных SQL, необходимо предоставить Azure Active Directory разрешение на взаимодействие с базой данных. Для этого перейдите на страницу "брандмауэры и виртуальная сеть" в портал Azure снова и включите "разрешить службам Azure и ресурсам доступ к серверу". 

   ![Брандмауэр и виртуальная сеть](./media/sql-db-output-managed-identity/allow-access.png)

## <a name="grant-stream-analytics-job-permissions"></a>Предоставление разрешений заданию Stream Analytics

После того как вы создали пользователя автономной базы данных и предоставили доступ к службам Azure на портале, как было описано в предыдущем разделе, задание Stream Analytics получит разрешение от управляемого удостоверения на **ПОДКЛЮЧЕНИЕ** к ресурсу базы данных SQL через управляемое удостоверение. Рекомендуется предоставить заданию Stream Analytics разрешения SELECT и INSERT, так как они понадобятся позже в рабочем процессе Stream Analytics. Разрешение **SELECT** позволяет заданию проверять подключение к таблице в базе данных SQL. Разрешение **INSERT** позволяет проверять сквозные запросы Stream Analytics, если вы настроили входные и выходные данные базы данных SQL. Эти разрешения можно предоставить заданию Stream Analytics с помощью SQL Server Management Studio. Дополнительные сведения см. в справочнике по ПРЕДОСТАВЛЕНию (Transact-SQL).

Чтобы предоставить разрешение только для определенной таблицы или объекта в базе данных, используйте следующий синтаксис T-SQL и выполните запрос. 

```sql
GRANT SELECT, INSERT ON OBJECT::TABLE_NAME TO ASA_JOB_NAME; 
```

Кроме того, можно щелкнуть правой кнопкой мыши Базу данных SQL в SQL Server Management Studio и выбрать **Свойства > Разрешения**. В меню разрешения можно просмотреть задание Stream Analytics, добавленное ранее, а затем по своему усмотрению вручную предоставить или отменить разрешения.

## <a name="create-an-azure-sql-database-output"></a>Создание выходных данных Базы данных SQL Azure

Теперь, когда вы настроили управляемое удостоверение, можно добавить Базу данных SQL Azure в качестве выходных данных в задание Stream Analytics.

Таблицу в базе данных SQL необходимо создавать с соответствующей выходной схемой. Имя этой таблицы — одно из обязательных свойств, которые должны быть заполнены при добавлении выходных данных базы данных SQL в задание Stream Analytics. Кроме того, для проверки подключения и выполнения запросов Stream Analytics заданию необходимо предоставить разрешения **SELECT** и **INSERT**. Если вы еще не сделали этого, ознакомьтесь с разделом [Предоставление разрешений заданию Stream Analytics](#grant-stream-analytics-job-permissions). 

1. Вернитесь к заданию Stream Analytics и перейдите на страницу **Выходные данные** в разделе **Топология задания**. 

1. Щелкните **Добавить > База данных SQL**. В окне свойств выходных данных приемника Базы данных SQL выберите **Управляемое удостоверение** из раскрывающегося списка режима проверки подлинности.

1. Укажите остальные свойства. Дополнительные сведения о создании выходных данных для Базы данных SQL см. в разделе [База данных SQL](sql-database-output.md). По завершении нажмите кнопку **Сохранить**. 

## <a name="next-steps"></a>Дальнейшие действия

* [Описание выходных данных из Azure Stream Analytics](stream-analytics-define-outputs.md)
* [Вывод данных Azure Stream Analytics в базу данных SQL Azure](stream-analytics-sql-output-perf.md)
