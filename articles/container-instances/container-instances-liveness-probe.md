---
title: Настройка зонда живости на экземпляре контейнера
description: Подробные сведения о настройке проб активности для перезагрузки неработоспособных контейнеров в службе "Экземпляры контейнеров Azure"
ms.topic: article
ms.date: 01/30/2020
ms.openlocfilehash: 11c6c9d39067c536bf4325f74eb24b2ab64ef515
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76934165"
---
# <a name="configure-liveness-probes"></a>Настройка проб активности

Контейнерные приложения могут работать в течение длительных периодов времени, в результате чего нарушенные состояния, которые могут потребоваться для ремонта путем перезапуска контейнера. Azure Container Instances поддерживает зонды живости, чтобы можно настроить контейнеры в группе контейнеров для перезапуска, если критическая функциональность не работает. Зонд живости ведет себя как [зонд живости Kubernetes.](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/)

В этой статье описывается развертывание группы контейнеров, содержащей пробу активности. В рамках этого примера демонстрируется автоматический перезапуск имитированного неработоспособного контейнера.

Azure Container Instances также поддерживает [зонды готовности,](container-instances-readiness-probe.md)которые можно настроить, чтобы гарантировать, что трафик достигает контейнера только тогда, когда он готов к нему.

> [!NOTE]
> В настоящее время вы не можете использовать зонд живости в группе контейнеров, развернутой в виртуальной сети.

## <a name="yaml-deployment"></a>Развертывание файла YAML

Создайте файл `liveness-probe.yaml` со следующим фрагментом кода. Этот файл определяет группу контейнера, содержащую контейнер NGNIX, который в конечном итоге становится неработоспособным.

```yaml
apiVersion: 2018-10-01
location: eastus
name: livenesstest
properties:
  containers:
  - name: mycontainer
    properties:
      image: nginx
      command:
        - "/bin/sh"
        - "-c"
        - "touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"
      ports: []
      resources:
        requests:
          cpu: 1.0
          memoryInGB: 1.5
      livenessProbe:
        exec:
            command:
                - "cat"
                - "/tmp/healthy"
        periodSeconds: 5
  osType: Linux
  restartPolicy: Always
tags: null
type: Microsoft.ContainerInstance/containerGroups
```

Выполните следующую команду, чтобы развернуть эту группу контейнеров с представленной выше конфигурацией YAML:

```azurecli-interactive
az container create --resource-group myResourceGroup --name livenesstest -f liveness-probe.yaml
```

### <a name="start-command"></a>Команда "Запуск"

Развертывание включает `command` свойство, определяющее начальную команду, которая выполняется при первом запуске контейнера. Это свойство принимает массив строк. Эта команда имитирует контейнер, входящий в неработоспособное состояние.

Во-первых, он запускает сеанс bash `healthy` и `/tmp` создает файл, называемый в каталоге. Затем он спит в течение 30 секунд, прежде чем удалять файл, а затем входит 10-минутный сон:

```bash
/bin/sh -c "touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"
```

### <a name="liveness-command"></a>Команда активности

Это развертывание определяет `livenessProbe` `exec` команду, поддерживающую команду живости, которая действует как проверка живости. Если эта команда выходит с ненулевым значением, контейнер будет убит `healthy` и перезапущен, сигнализация файла не может быть найдена. Если эта команда успешно выходит с кодом выхода 0, никаких действий не предпринимается.

Свойство `periodSeconds` определяет команду активности, которая должна выполняться каждые 5 секунд.

## <a name="verify-liveness-output"></a>Проверка выходных данных активности

В течение первых 30 секунд завершается работа файла `healthy`, созданного с помощью команды запуска. Когда команда живости проверяет `healthy` наличие файла, код состояния возвращает 0, сигнализируя об успехе, поэтому перезапуск не происходит.

Через 30 секунд `cat /tmp/healthy` команда начинает сбой, вызывая нездоровые и убийствеющие события.

Эти события можно просмотреть на портале Azure или в Azure CLI.

![Неработоспособные события на портале][portal-unhealthy]

При просмотре событий на портале Azure события типа `Unhealthy` срабатывают при сбойе команды живости. Последующее событие типа, `Killing`означающего удаление контейнера, так что может начаться перезагрузка. Количество перезапуска для приращений контейнера каждый раз, когда происходит это событие.

Перезагрузки завершаются на месте, чтобы ресурсы, такие как общедоступные IP-адреса и содержимое, специфичное для узлов, сохранились.

![Счетчик перезагрузки на портале][portal-restart]

Если зонд живости непрерывно выходит из строя и запускает слишком много перезагрузок, ваш контейнер входит в экспоненциальную задержку обратного отработки.

## <a name="liveness-probes-and-restart-policies"></a>Пробы активности и политики перезагрузки

Политики перезагрузки заменяют поведение перезагрузки, активируемое пробами активности. Например, если вы `restartPolicy = Never` *установите* зонд живости, группа контейнеров не будет перезагружаться из-за неудачной проверки на живость. Вместо этого группа контейнеров придерживается политики перезапуска контейнерной `Never`группы.

## <a name="next-steps"></a>Дальнейшие действия

Для выполнения сценариев на основе задачи может понадобиться, чтобы пробы активности включали функцию автоматической перезагрузки в случае, если необходимая функция не работает должным образом. Дополнительные сведения о запуске контейнеров на основе задач см. статье [Выполнение задачи-контейнера в службе "Экземпляры контейнеров Azure"](container-instances-restart-policy.md).

<!-- IMAGES -->
[portal-unhealthy]: ./media/container-instances-liveness-probe/unhealthy-killing.png
[portal-restart]: ./media/container-instances-liveness-probe/portal-restart.png
