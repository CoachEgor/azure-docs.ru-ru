---
title: Настройка проверки готовности в экземпляре контейнера
description: Узнайте, как настроить проверку, чтобы контейнеры в службе "экземпляры контейнеров Azure" получали запросы только после их подготовки.
ms.topic: article
ms.date: 10/17/2019
ms.openlocfilehash: 5ebbcdeee231e3e67abd6758485a12984137997e
ms.sourcegitcommit: 85e7fccf814269c9816b540e4539645ddc153e6e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/26/2019
ms.locfileid: "74533560"
---
# <a name="configure-readiness-probes"></a>Настройка проб готовности

Для контейнерных приложений, обслуживающих трафик, может потребоваться проверить готовность контейнера к обработке входящих запросов. Служба "экземпляры контейнеров Azure" поддерживает проверки готовности к включению конфигураций, поэтому доступ к контейнеру при определенных условиях невозможен. Проба готовности ведет себя как проверка [готовности к Kubernetes](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/). Например, приложению-контейнеру может потребоваться загрузить большой набор данных во время запуска, и вы не хотите, чтобы он получал запросы в течение этого времени.

В этой статье объясняется, как развернуть группу контейнеров, включающую проверку готовности, чтобы контейнер получал трафик только после завершения пробы.

Служба "экземпляры контейнеров Azure" также поддерживает [проверки в реальном времени](container-instances-liveness-probe.md), которые можно настроить так, чтобы неработоспособный контейнер мог автоматически перезапуститься.

## <a name="yaml-configuration"></a>Конфигурация YAML

В качестве примера создайте файл `readiness-probe.yaml` со следующим фрагментом кода, который включает проверку готовности. Этот файл определяет группу контейнеров, состоящую из контейнера, в котором работает небольшое веб-приложение. Приложение развертывается из образа общедоступной `mcr.microsoft.com/azuredocs/aci-helloworld`. Это приложение-контейнер также демонстрируется в таких кратких руководствах, как [развертывание экземпляра контейнера в Azure с помощью Azure CLI](container-instances-quickstart.md).

```yaml
apiVersion: 2018-10-01
location: eastus
name: readinesstest
properties:
  containers:
  - name: mycontainer
    properties:
      image: mcr.microsoft.com/azuredocs/aci-helloworld
      command:
        - "/bin/sh"
        - "-c"
        - "node /usr/src/app/index.js & (sleep 240; touch /tmp/ready); wait"
      ports:
      - port: 80
      resources:
        requests:
          cpu: 1.0
          memoryInGB: 1.5
      readinessProbe:
        exec:
          command:
          - "cat"
          - "/tmp/ready"
        periodSeconds: 5
  osType: Linux
  restartPolicy: Always
  ipAddress:
    type: Public
    ports:
    - protocol: tcp
      port: '80'
tags: null
type: Microsoft.ContainerInstance/containerGroups
```

### <a name="start-command"></a>Команда "Запуск"

Файл YAML включает команду запуска при запуске контейнера, определяемую свойством `command`, которое принимает массив строк. Эта команда имитирует время, когда веб-приложение выполняется, но контейнер не готов. Сначала запускается сеанс оболочки и запускается команда `node` для запуска веб-приложения. Он также запускает команду в спящий режим в течение 240 секунд, после чего он создает файл с именем `ready` в каталоге `/tmp`:

```console
node /usr/src/app/index.js & (sleep 240; touch /tmp/ready); wait
```

### <a name="readiness-command"></a>Готовность, команда

Этот файл YAML определяет `readinessProbe`, который поддерживает команду `exec` Readiness, которая выступает в качестве проверки готовности. В этом примере команда готовности проверяет наличие файла `ready` в каталоге `/tmp`.

Если файл `ready` не существует, команда Readiness завершается с ненулевым значением. контейнер продолжит работу, но к нему нельзя получить доступ. Когда команда завершается успешно с кодом выхода 0, контейнер готов к доступу. 

Свойство `periodSeconds` указывает, что команда готовности должна выполняться каждые 5 секунд. Проба готовности выполняется в течение времени существования группы контейнеров.

## <a name="example-deployment"></a>Пример развертывания

Выполните следующую команду, чтобы развернуть группу контейнеров с предыдущей конфигурацией YAML:

```azurecli-interactive
az container create --resource-group myResourceGroup --file readiness-probe.yaml
```

## <a name="view-readiness-checks"></a>Просмотр проверок готовности

В этом примере в течение первых 240 секунд команда Readiness завершается ошибкой при проверке существования файла `ready`. Код состояния вернул сигнал о том, что контейнер не готов.

Эти события можно просмотреть на портале Azure или в Azure CLI. Например, на портале отображаются события типа `Unhealthy` запускаются при сбое команды готовности. 

![Неработоспособные события на портале][portal-unhealthy]

## <a name="verify-container-readiness"></a>Проверка готовности контейнера

После запуска контейнера можно проверить, что он недоступен изначально. После подготовки получите IP-адрес группы контейнеров:

```azurecli
az container show --resource-group myResourceGroup --name readinesstest --query "ipAddress.ip" --out tsv
```

Попробуйте получить доступ к сайту во время проверки готовности:

```bash
wget <ipAddress>
```

Выходные данные показывают, что сайт недоступен изначально:
```
$ wget 192.0.2.1
--2019-10-15 16:46:02--  http://192.0.2.1/
Connecting to 192.0.2.1... connected.
HTTP request sent, awaiting response... 
```

По истечении 240 секунд команда готовности подает сигнал о готовности контейнера. Теперь при выполнении команды `wget` она будет выполнена следующим образом:

```
$ wget 192.0.2.1
--2019-10-15 16:46:02--  http://192.0.2.1/
Connecting to 192.0.2.1... connected.
HTTP request sent, awaiting response...200 OK
Length: 1663 (1.6K) [text/html]
Saving to: ‘index.html.1’

index.html.1                       100%[===============================================================>]   1.62K  --.-KB/s    in 0s      

2019-10-15 16:49:38 (113 MB/s) - ‘index.html.1’ saved [1663/1663] 
```

Когда контейнер будет готов, вы также можете получить доступ к веб-приложению, перейдя по IP-адресу с помощью веб-браузера.

> [!NOTE]
> Проба готовности продолжит выполняться в течение времени существования группы контейнеров. Если выполнить команду готовности позже, контейнер снова станет недоступным. 
> 

## <a name="next-steps"></a>Следующие шаги

Проверка готовности может быть полезной в сценариях, включающих группы из нескольких контейнеров, состоящие из зависимых контейнеров. Дополнительные сведения о сценариях с несколькими контейнерами см. [в статье группы контейнеров в службе "экземпляры контейнеров Azure](container-instances-container-groups.md)".

<!-- IMAGES -->
[portal-unhealthy]: ./media/container-instances-readiness-probe/readiness-probe-failed.png
