---
title: Настройка зонда готовности на экземпляре контейнера
description: Узнайте, как настроить зонд для обеспечения приема запросов в контейнерах Azure
ms.topic: article
ms.date: 01/30/2020
ms.openlocfilehash: 64bb4a3e429ce820835abbf8e235600e592f7868
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76935675"
---
# <a name="configure-readiness-probes"></a>Настройка проб готовности

Для контейнерных приложений, обслуживающих трафик, может потребоваться убедиться, что контейнер готов обрабатывать входящие запросы. Azure Container Instances поддерживает зонды готовности, чтобы включить конфигурации, так что ваш контейнер не может быть доступен при определенных условиях. Зонд готовности ведет себя как [зонд готовности Kubernetes.](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/) Например, приложению контейнера может потребоваться загрузить большой набор данных во время запуска, и вы не хотите, чтобы он получал запросы в течение этого времени.

В этой статье объясняется, как развернуть группу контейнеров, которая включает зонд готовности, так что контейнер получает трафик только тогда, когда зонд успешно.

Azure Container Instances также поддерживает [зонды живости,](container-instances-liveness-probe.md)которые можно настроить, чтобы автоматически перезапустить неработоспособный контейнер.

> [!NOTE]
> В настоящее время нельзя использовать зонд готовности в контейнерной группе, развернутой в виртуальной сети.

## <a name="yaml-configuration"></a>Конфигурация YAML

В качестве примера `readiness-probe.yaml` создайте файл со следующим фрагментом, который включает зонд готовности. Этот файл определяет группу контейнеров, которая состоит из контейнера, работая с небольшим веб-приложением. Приложение развертывается из публичного `mcr.microsoft.com/azuredocs/aci-helloworld` изображения. Это контейнерное приложение также демонстрируется в [развертывании экземпляра контейнеров в Azure с использованием Azure CLI](container-instances-quickstart.md) и других быстрых запусков.

```yaml
apiVersion: 2018-10-01
location: eastus
name: readinesstest
properties:
  containers:
  - name: mycontainer
    properties:
      image: mcr.microsoft.com/azuredocs/aci-helloworld
      command:
        - "/bin/sh"
        - "-c"
        - "node /usr/src/app/index.js & (sleep 240; touch /tmp/ready); wait"
      ports:
      - port: 80
      resources:
        requests:
          cpu: 1.0
          memoryInGB: 1.5
      readinessProbe:
        exec:
          command:
          - "cat"
          - "/tmp/ready"
        periodSeconds: 5
  osType: Linux
  restartPolicy: Always
  ipAddress:
    type: Public
    ports:
    - protocol: tcp
      port: '80'
tags: null
type: Microsoft.ContainerInstance/containerGroups
```

### <a name="start-command"></a>Команда "Запуск"

Развертывание включает `command` свойство, определяющее начальную команду, которая выполняется при первом запуске контейнера. Это свойство принимает массив строк. Эта команда имитирует время, когда веб-приложение работает, но контейнер не готов. 

Во-первых, он запускает сеанс `node` оболочки и запускает команду для запуска веб-приложения. Он также запускает команду для сна в течение 240 `ready` секунд, после чего он создает файл, называемый в каталоге: `/tmp`

```console
node /usr/src/app/index.js & (sleep 240; touch /tmp/ready); wait
```

### <a name="readiness-command"></a>Команда готовности

Этот файл YAML `readinessProbe` определяет, `exec` который поддерживает команду готовности, которая действует как проверка готовности. Команда команды готовности этого примера проверяет наличие файла `ready` в каталоге. `/tmp`

Когда `ready` файл не существует, команда готовности выходит с ненулевым значением; контейнер продолжает работать, но не может быть доступен. Когда команда успешно выходит с кодом выхода 0, контейнер готов к доступу. 

Свойство `periodSeconds` обозначает команду готовности, которая должна выполняться каждые 5 секунд. Зонд готовности работает в течение всего срока службы контейнерной группы.

## <a name="example-deployment"></a>Пример развертывания

Запустите следующую команду для развертывания контейнерной группы с предыдущей конфигурацией YAML:

```azurecli-interactive
az container create --resource-group myResourceGroup --file readiness-probe.yaml
```

## <a name="view-readiness-checks"></a>Просмотр проверок готовности

В этом примере в течение первых 240 секунд команда `ready` готовности завершается сбой при проверке существования файла. Код состояния возвращает сигналы о том, что контейнер не готов.

Эти события можно просмотреть на портале Azure или в Azure CLI. Например, портал показывает, `Unhealthy` что события типа срабатывают при сбое команды готовности. 

![Неработоспособные события на портале][portal-unhealthy]

## <a name="verify-container-readiness"></a>Проверка готовности контейнера

После запуска контейнера, вы можете убедиться, что он не доступен на начальном этапе. После подготовки получите IP-адрес контейнерной группы:

```azurecli
az container show --resource-group myResourceGroup --name readinesstest --query "ipAddress.ip" --out tsv
```

Попробуйте получить доступ к сайту в то время как проверка готовности зонда не удается:

```bash
wget <ipAddress>
```

Выход показывает, что сайт недоступен изначально:
```
$ wget 192.0.2.1
--2019-10-15 16:46:02--  http://192.0.2.1/
Connecting to 192.0.2.1... connected.
HTTP request sent, awaiting response... 
```

Через 240 секунд команда готовности преуспевает, сигнализируя, что контейнер готов. Теперь, когда `wget` вы запустите команду, она преуспевает:

```
$ wget 192.0.2.1
--2019-10-15 16:46:02--  http://192.0.2.1/
Connecting to 192.0.2.1... connected.
HTTP request sent, awaiting response...200 OK
Length: 1663 (1.6K) [text/html]
Saving to: ‘index.html.1’

index.html.1                       100%[===============================================================>]   1.62K  --.-KB/s    in 0s      

2019-10-15 16:49:38 (113 MB/s) - ‘index.html.1’ saved [1663/1663] 
```

Когда контейнер будет готов, вы также можете получить доступ к веб-приложению, просматривая IP-адрес с помощью веб-браузера.

> [!NOTE]
> Зонд готовности продолжает работать в течение всего срока службы контейнерной группы. Если команда готовности выходит из строя в более позднее время, контейнер снова становится недоступным. 
> 

## <a name="next-steps"></a>Дальнейшие действия

Зонд готовности может быть полезен в сценариях, связанных с многоконтейнерных групп, которые состоят из зависимых контейнеров. Для получения дополнительной информации о [Container groups in Azure Container Instances](container-instances-container-groups.md)сценариях с несколькими контейнерами см.

<!-- IMAGES -->
[portal-unhealthy]: ./media/container-instances-readiness-probe/readiness-probe-failed.png
