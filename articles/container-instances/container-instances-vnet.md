---
title: Развертывание экземпляров контейнеров в виртуальной сети Azure
description: Сведения о том, как развернуть группы контейнеров в новой или существующей виртуальной сети Azure.
services: container-instances
author: dlepow
ms.service: container-instances
ms.topic: article
ms.date: 03/26/2019
ms.author: danlep
ms.openlocfilehash: ba7eca6286a7de6a930819d89470fa9e069b8361
ms.sourcegitcommit: 64798b4f722623ea2bb53b374fb95e8d2b679318
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2019
ms.locfileid: "67839695"
---
# <a name="deploy-container-instances-into-an-azure-virtual-network"></a>Развертывание экземпляров контейнеров в виртуальной сети Azure

[Виртуальная сеть Azure](../virtual-network/virtual-networks-overview.md) обеспечивает безопасное и частных сетей для Azure и локальным ресурсам. Развертывание групп контейнеров в виртуальной сети Azure позволяет контейнерам безопасно обмениваться данными с другими ресурсами в виртуальной сети.

Группы контейнеров, развернутых в виртуальной сети Azure, позволяют реализовать такие сценарии:

* прямой обмен данными между группами контейнеров в одной и той же подсети;
* отправка выходных данных рабочей нагрузки [на основе задач](container-instances-restart-policy.md) из экземпляров контейнеров в базу данных в виртуальной сети;
* получение содержимого для экземпляров контейнеров из [конечной точки службы](../virtual-network/virtual-network-service-endpoints-overview.md) в виртуальной сети;
* обмен данными контейнеров с виртуальными машинами в виртуальной сети;
* обмен данными контейнеров с локальными ресурсами через [VPN-шлюз](../vpn-gateway/vpn-gateway-about-vpngateways.md) или [ExpressRoute](../expressroute/expressroute-introduction.md).

> [!IMPORTANT]
> Сейчас эта функция доступна в предварительной версии, и применяются [некоторые ограничения](#preview-limitations). Предварительные версии предоставляются при условии, что вы принимаете [дополнительные условия использования][terms-of-use]. Некоторые аспекты этой функции могут быть изменены до выхода общедоступной версии.

## <a name="virtual-network-deployment-limitations"></a>Ограничение развертывания в виртуальной сети

При развертывании групп контейнеров в виртуальной сети действуют определенные ограничения.

* Для развертывания группы контейнеров в подсети эта подсеть не должна содержать другие типы ресурсов. Удалите все существующие ресурсы из существующей подсети, прежде чем развернуть в ней группы контейнеров, или создайте новую подсеть.
* Нельзя использовать [управляемое удостоверение](container-instances-managed-identity.md) в группе контейнеров, развернутой в виртуальной сети.
* Из-за того, что задействуются дополнительные сетевые ресурсы, развертывание группы контейнеров в виртуальной сети обычно выполняется медленнее, чем развертывание стандартного экземпляра контейнера.

## <a name="preview-limitations"></a>Ограничения предварительной версии

Пока эта функция находится на этапе предварительной версии, при развертывании групп контейнеров к виртуальной сети, применяются следующие ограничения. 

[!INCLUDE [container-instances-vnet-limits](../../includes/container-instances-vnet-limits.md)]

Ограничения ресурсов контейнера могут отличаться от ограничений для экземпляров несетевых контейнеров в этих регионах. Сейчас эта возможность поддерживает только контейнеры Linux. Запланирована поддержка Windows.

### <a name="unsupported-networking-scenarios"></a>Неподдерживаемый сетевые сценарии 

* **Azure Load Balancer** -размещение подсистемы балансировки нагрузки Azure перед экземплярами контейнеров в группе сетевых контейнеров не поддерживается
* **Пиринг виртуальных сетей** -не удается установить пиринг виртуальной сети, содержащей подсеть, делегировать экземпляры контейнеров Azure к другой виртуальной сети
* **Таблицы маршрутов** -не удается настроить определяемые пользователем маршруты в подсеть, делегировать экземпляры контейнеров Azure
* **Группы безопасности сети** -в настоящее время не применяются правила безопасности для исходящего трафика в группы безопасности сети применяется к подсети, делегировать экземпляры контейнеров Azure 
* **Общедоступный IP-адрес или DNS-метки** -группы контейнеров, развернутых в виртуальной сети в настоящее время не поддерживают предоставление контейнеры прямо в Интернете по общедоступный IP-адрес или полное доменное имя
* **Разрешение внутренних имен** -разрешение имен для ресурсов Azure в виртуальной сети с помощью внутренней службы DNS Azure не поддерживается.

Чтобы **удалить сетевые ресурсы**, вам потребуется выполнить [дополнительные действия](#delete-network-resources), если группы контейнеров развернуты в виртуальной сети.

## <a name="required-network-resources"></a>Необходимые сетевые ресурсы

Для развертывания групп контейнеров в виртуальной сети требуется три ресурса виртуальной сети Azure: сама [виртуальная сеть](#virtual-network), [делегированная подсеть](#subnet-delegated) в пределах этой виртуальной сети и [сетевой профиль](#network-profile). 

### <a name="virtual-network"></a>Виртуальная сеть

Виртуальная сеть определяет адресное пространство, в котором можно создать одну или несколько подсетей. Затем следует развернуть ресурсы Azure (например, группы контейнеров) в подсетях виртуальной сети.

### <a name="subnet-delegated"></a>Подсеть (делегированная)

Подсети сегментируют виртуальную сеть на отдельные адресные пространства, которые применяются для размещения ресурсов Azure. В виртуальной сети следует создать одну или несколько подсетей.

Подсеть, используемая для групп контейнеров, может содержать только группы контейнеров. При первом развертывании группы контейнеров в подсети Azure делегирует эту подсеть службе "Экземпляры контейнеров Azure". После делегирования подсеть можно использовать только для групп контейнеров. Если попытаться развернуть в делегированной подсети ресурсы, отличные от групп контейнеров, операция завершится ошибкой.

### <a name="network-profile"></a>сетевой профиль.

Сетевой профиль — это шаблон конфигурации сети для ресурсов Azure. Он задает определенные свойства сети для ресурса, например подсеть, в который его следует развернуть. При первом использовании [создать контейнер az][az-container-create] команду, чтобы развернуть группу контейнеров с подсетью (и, таким образом, виртуальную сеть), Azure создает сетевой профиль для вас. Затем этот сетевой профиль можно использовать для будущих развертываний в подсети. 

Чтобы использовать шаблон Resource Manager, файл YAML или программный метод для развертывания группы контейнеров в подсеть, необходимо указать полный идентификатор ресурса Resource Manager сетевого профиля. Можно использовать профиль создан ранее с помощью [создать контейнер az][az-container-create], или создайте профиль с помощью шаблона Resource Manager (см. в разделе [пример шаблона](https://github.com/Azure/azure-quickstart-templates/tree/master/101-aci-vnet) и [ссылку](https://docs.microsoft.com/azure/templates/microsoft.network/networkprofiles)). Чтобы получить идентификатор ранее созданный профиль, используйте [список профилей az сети][az-network-profile-list] команды. 

На следующей схеме несколько групп контейнеров развернуты в подсети, делегированной службе "Экземпляры контейнеров Azure". Развернув одну группу контейнеров в подсети, можно развернуть в ней дополнительные группы контейнеров, указав тот же сетевой профиль.

![Группы контейнеров в виртуальной сети][aci-vnet-01]

## <a name="deployment-scenarios"></a>Сценарии развертывания

Можно использовать [создать контейнер az][az-container-create] для развертывания групп контейнеров на новой виртуальной сети и разрешить Azure для создания необходимых сетевых ресурсов для вас или развертывание в существующей виртуальной сети. 

### <a name="new-virtual-network"></a>Новая виртуальная сеть

Чтобы развернуть новую виртуальную сеть и создать сетевые ресурсы автоматически Azure, укажите следующее, при выполнении [создать контейнер az][az-container-create]:

* Имя виртуальной сети
* Префикс адреса виртуальной сети в формате CIDR.
* Имя подсети
* Префикс адреса подсети в формате CIDR.

Префиксы адресов виртуальной сети и подсети определяют адресное пространство соответственно для виртуальной сети и подсети. Эти значения представлены в нотации бесклассовой междоменной маршрутизации (CIDR), например `10.0.0.0/16`. Дополнительные сведения о работе с подсетями см. в статье [Создание, изменение или удаление виртуальной сети](../virtual-network/virtual-network-manage-subnet.md).

Развернув первую группу контейнеров с помощью этого метода, можно выполнить развертывание в той же подсети, указав имена виртуальной сети и подсети, или же сетевой профиль, автоматически созданный в Azure. Так как Azure делегирует подсети службе "Экземпляры контейнеров Azure", в этой подсети можно развернуть *только* группы контейнеров.

### <a name="existing-virtual-network"></a>Существующая виртуальная сеть

Чтобы развернуть группу контейнеров в существующей виртуальной сети, сделайте следующее:

1. Создайте подсеть в существующей виртуальной сети или удалите в существующей подсети *все* другие ресурсы.
1. Развертывание контейнера с использованием [создать контейнер az][az-container-create] и укажите одно из следующих:
   * имя виртуальной сети и имя подсети;
   * идентификатор ресурса виртуальной сети и идентификатор ресурса подсети, которые позволяют использовать виртуальную сеть из другой группы ресурсов;
   * Сетевое имя профиля или идентификатор, который можно получить с помощью [список профилей az сети][az-network-profile-list]

Когда вы развернете первую группу контейнеров в существующей подсети, Azure делегирует эту подсеть службе "Экземпляры контейнеров Azure". В этой подсети больше нельзя развернуть ресурсы, отличные от групп контейнеров.

## <a name="deployment-examples"></a>Примеры развертывания

В следующих разделах описывается, как развертывать группы контейнеров в виртуальной сети с помощью Azure CLI. Примеры команд форматированы для оболочки **Bash**. Если вы предпочитаете использовать другую оболочку, например PowerShell или командную строку, измените соответствующим образом символы продолжения строки.

### <a name="deploy-to-a-new-virtual-network"></a>Развертывание в новую виртуальную сеть

Сначала разверните группу контейнеров и укажите параметры для новой виртуальной сети и подсети. Когда вы укажите эти параметры, Azure создаст виртуальную сеть и подсеть, делегирует подсеть службе "Экземпляры контейнеров Azure", а также создаст сетевой профиль. Когда эти ресурсы будут созданы, группа контейнеров будет развернута в подсети.

Выполните следующую команду, [создать контейнер az][az-container-create] команду, которая задает параметры для новой виртуальной сети и подсети. Необходимо указать имя группы ресурсов, которое было создано в регионе, [поддерживающем](#preview-limitations) группы контейнеров в виртуальной сети. Эта команда выполняет развертывание общедоступной Microsoft [aci-helloworld][aci-helloworld] контейнер, который выполняет небольшой Node.js веб-сервер обслуживает статические веб-страницы. В следующем разделе вы развернете вторую группу контейнеров в той же подсети и протестируете связь между двумя экземплярами контейнеров.

```azurecli
az container create \
    --name appcontainer \
    --resource-group myResourceGroup \
    --image mcr.microsoft.com/azuredocs/aci-helloworld \
    --vnet aci-vnet \
    --vnet-address-prefix 10.0.0.0/16 \
    --subnet aci-subnet \
    --subnet-address-prefix 10.0.0.0/24
```

Развертывание в новой виртуальной сети с помощью этого метода может занять несколько минут, пока создаются сетевые ресурсы. После развертывания первых групп контейнеров дополнительные группы будут развертываться быстрее.

### <a name="deploy-to-existing-virtual-network"></a>Развертывание в существующей виртуальной сети

Теперь, когда вы развернули группу контейнеров в новой виртуальной сети, разверните вторую группу контейнеров в той же подсети и проверьте связь между двумя экземплярами контейнеров.

Сначала получите IP-адрес первой развернутой группы контейнеров — *appcontainer*:

```azurecli
az container show --resource-group myResourceGroup --name appcontainer --query ipAddress.ip --output tsv
```

В выходных данных должен отображаться IP-адрес группы контейнеров в частной подсети:

```console
$ az container show --resource-group myResourceGroup --name appcontainer --query ipAddress.ip --output tsv
10.0.0.4
```

Теперь в качестве значения параметра `CONTAINER_GROUP_IP` укажите IP-адрес, полученный командой `az container show`, и выполните следующую команду `az container create`. Этот второй контейнер, *commchecker*, запускает образ на базе Alpine Linux и выполняет `wget` в отношении IP-адреса частной подсети первой группы контейнеров.

```azurecli
CONTAINER_GROUP_IP=<container-group-IP-here>

az container create \
    --resource-group myResourceGroup \
    --name commchecker \
    --image alpine:3.5 \
    --command-line "wget $CONTAINER_GROUP_IP" \
    --restart-policy never \
    --vnet aci-vnet \
    --subnet aci-subnet
```

Когда завершится развертывание второго контейнера, извлеките его журналы, чтобы просмотреть выходные данные выполненной им команды `wget`:

```azurecli
az container logs --resource-group myResourceGroup --name commchecker
```

Если второй контейнер успешно обменялся данными с первым, выходные данные должны выглядеть следующим образом:

```console
$ az container logs --resource-group myResourceGroup --name commchecker
Connecting to 10.0.0.4 (10.0.0.4:80)
index.html           100% |*******************************|  1663   0:00:00 ETA
```

Выходные данные журнала должны показывать, что программе `wget` удалось подключиться и скачать файл индекса из первого контейнера, используя его частный IP-адрес в локальной подсети. Сетевой трафик между двумя группами контейнеров оставался в пределах виртуальной сети.

### <a name="deploy-to-existing-virtual-network---yaml"></a>Развертывание в существующей виртуальной сети — YAML

Группу контейнеров можно также развернуть в существующей виртуальной сети с помощью YAML-файла. Для развертывания в подсети виртуальной сети следует указать несколько дополнительных свойств в YAML:

* `ipAddress`. параметры IP-адреса для группы контейнеров.
  * `ports`. открываемые порты, если таковые имеются.
  * `protocol`. протокол (TCP или UDP) для открытого порта.
* `networkProfile`. позволяет задать параметры сети, например, виртуальную сеть и подсеть для ресурса Azure.
  * `id`. полный идентификатор ресурса Resource Manager для `networkProfile`.

Чтобы развернуть группу контейнеров в виртуальной сети с помощью файла YAML, сначала необходимо получить идентификатор сетевого профиля. Выполнение [список профилей az сети][az-network-profile-list] команду, указав имя группы ресурсов, содержащий виртуальную сеть и делегированного подсети.

``` azurecli
az network profile list --resource-group myResourceGroup --query [0].id --output tsv
```

В выходных данных команды будет показан полный идентификатор ресурса для сетевого профиля.

```console
$ az network profile list --resource-group myResourceGroup --query [0].id --output tsv
/subscriptions/<Subscription ID>/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkProfiles/aci-network-profile-aci-vnet-aci-subnet
```

Получив идентификатор сетевого профиля, скопируйте следующий код YAML в новый файл с именем *vnet-deploy-aci.yaml*. В разделе `networkProfile` замените значение `id` только что полученным идентификатором, затем сохраните файл. Этот код YAML создает группу контейнеров с именем *appcontaineryaml* в виртуальной сети.

```YAML
apiVersion: '2018-09-01'
location: westus
name: appcontaineryaml
properties:
  containers:
  - name: appcontaineryaml
    properties:
      image: mcr.microsoft.com/azuredocs/aci-helloworld
      ports:
      - port: 80
        protocol: TCP
      resources:
        requests:
          cpu: 1.0
          memoryInGB: 1.5
  ipAddress:
    type: Private
    ports:
    - protocol: tcp
      port: '80'
  networkProfile:
    id: /subscriptions/<Subscription ID>/resourceGroups/container/providers/Microsoft.Network/networkProfiles/aci-network-profile-aci-vnet-subnet
  osType: Linux
  restartPolicy: Always
tags: null
type: Microsoft.ContainerInstance/containerGroups
```

Развертывание группы контейнеров с [создать контейнер az][az-container-create] команду, указав имя файла YAML для `--file` параметр:

```azurecli
az container create --resource-group myResourceGroup --file vnet-deploy-aci.yaml
```

После завершения развертывания, выполните [az контейнера show][az-container-show] команду, чтобы отобразить его состояние:

```console
$ az container show --resource-group myResourceGroup --name appcontaineryaml --output table
Name              ResourceGroup    Status    Image                                       IP:ports     Network    CPU/Memory       OsType    Location
----------------  ---------------  --------  ------------------------------------------  -----------  ---------  ---------------  --------  ----------
appcontaineryaml  myResourceGroup  Running   mcr.microsoft.com/azuredocs/aci-helloworld  10.0.0.5:80  Private    1.0 core/1.5 gb  Linux     westus
```

## <a name="clean-up-resources"></a>Очистка ресурсов

### <a name="delete-container-instances"></a>Удаление экземпляров контейнеров

Когда завершите работу с созданными экземплярами контейнеров, удалите их с помощью следующих команд:

```azurecli
az container delete --resource-group myResourceGroup --name appcontainer -y
az container delete --resource-group myResourceGroup --name commchecker -y
az container delete --resource-group myResourceGroup --name appcontaineryaml -y
```

### <a name="delete-network-resources"></a>Удаление сетевых ресурсов

В первоначальной предварительной версии этой функции требуется несколько дополнительных команд для удаления сетевых ресурсов, созданных ранее. Если вы использовали примеры команд из предыдущих разделов этой статьи для создания виртуальной сети и подсети, можно удалить эти сетевые ресурсы с помощью следующего скрипта.

Перед выполнением скрипта задайте в качестве переменной `RES_GROUP` имя группы ресурсов, содержащей виртуальную сеть и подсеть, которые следует удалить. Обновить имена виртуальной сети и подсети, в том случае, если вы не использовали `aci-vnet` и `aci-subnet` имена приведенным выше. Скрипт отформатирован для оболочки Bash. Если вы предпочитаете использовать другую оболочку, например PowerShell или командную строку, измените методы доступа и присваивание значения переменной соответствующим образом.

> [!WARNING]
> Этот скрипт удаляет ресурсы! Он удаляет виртуальную сеть и все подсети, которые в ней содержатся. Убедитесь, что вам больше *не* требуются ресурсы в этой виртуальной сети, включая все содержащиеся в ней подсети, прежде чем запускать этот скрипт. После удаления **эти ресурсы восстановить невозможно**.

```azurecli
# Replace <my-resource-group> with the name of your resource group
RES_GROUP=<my-resource-group>

# Get network profile ID
NETWORK_PROFILE_ID=$(az network profile list --resource-group $RES_GROUP --query [0].id --output tsv)

# Delete the network profile
az network profile delete --id $NETWORK_PROFILE_ID -y

# Delete virtual network
az network vnet delete --resource-group $RES_GROUP --name aci-vnet
```

## <a name="next-steps"></a>Следующие шаги

Чтобы развернуть новую виртуальную сеть, подсеть, сетевой профиль и группу контейнеров с помощью шаблона Resource Manager, см. страницу [создания группы контейнеров Azure с виртуальной сетью](https://github.com/Azure/azure-quickstart-templates/tree/master/101-aci-vnet
).

В этой статье были кратко описаны несколько ресурсов и функций виртуальной сети. Более подробно эти темы рассматриваются в следующей документации по виртуальным сетям Azure:

* [Виртуальная сеть](../virtual-network/manage-virtual-network.md)
* [Подсеть](../virtual-network/virtual-network-manage-subnet.md)
* [Конечные точки службы](../virtual-network/virtual-network-service-endpoints-overview.md)
* [VPN-шлюз](../vpn-gateway/vpn-gateway-about-vpngateways.md)
* [ExpressRoute](../expressroute/expressroute-introduction.md)

<!-- IMAGES -->
[aci-vnet-01]: ./media/container-instances-vnet/aci-vnet-01.png

<!-- LINKS - External -->
[aci-helloworld]: https://hub.docker.com/_/microsoft-azuredocs-aci-helloworld
[terms-of-use]: https://azure.microsoft.com/support/legal/preview-supplemental-terms/

<!-- LINKS - Internal -->
[az-container-create]: /cli/azure/container#az-container-create
[az-container-show]: /cli/azure/container#az-container-show
[az-network-vnet-create]: /cli/azure/network/vnet#az-network-vnet-create
[az-network-profile-list]: /cli/azure/network/profile#az-network-profile-list
