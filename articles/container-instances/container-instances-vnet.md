---
title: Развертывание группы контейнеров в виртуальной сети Azure
description: Сведения о том, как развернуть группы контейнеров в новой или существующей виртуальной сети Azure.
ms.topic: article
ms.date: 01/06/2020
ms.author: danlep
ms.openlocfilehash: 40f312ce8bc08c9b59e7c47f05b6a5d3dc94a994
ms.sourcegitcommit: 67e9f4cc16f2cc6d8de99239b56cb87f3e9bff41
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/31/2020
ms.locfileid: "76901867"
---
# <a name="deploy-container-instances-into-an-azure-virtual-network"></a>Развертывание экземпляров контейнеров в виртуальной сети Azure

[Виртуальная сеть Azure](../virtual-network/virtual-networks-overview.md) предоставляет защищенные частные сети для Azure и локальных ресурсов. Развертывание групп контейнеров в виртуальной сети Azure позволяет контейнерам безопасно обмениваться данными с другими ресурсами в виртуальной сети.

Группы контейнеров, развернутых в виртуальной сети Azure, позволяют реализовать такие сценарии:

* прямой обмен данными между группами контейнеров в одной и той же подсети;
* отправка выходных данных рабочей нагрузки [на основе задач](container-instances-restart-policy.md) из экземпляров контейнеров в базу данных в виртуальной сети;
* получение содержимого для экземпляров контейнеров из [конечной точки службы](../virtual-network/virtual-network-service-endpoints-overview.md) в виртуальной сети;
* обмен данными контейнеров с виртуальными машинами в виртуальной сети;
* обмен данными контейнеров с локальными ресурсами через [VPN-шлюз](../vpn-gateway/vpn-gateway-about-vpngateways.md) или [ExpressRoute](../expressroute/expressroute-introduction.md).

> [!IMPORTANT]
> Развертывания групп контейнеров в виртуальной сети общедоступны для рабочих нагрузок только в следующих регионах: **Восточная часть США, Юго-Центральный регион США и Западная часть США 2**. В других регионах, где доступна эта функция, развертывания виртуальных сетей сейчас доступны в предварительной версии. в ближайшем будущем планируется общая доступность. Предварительные версии предоставляются при условии, что вы принимаете [дополнительные условия использования][terms-of-use]. 


## <a name="virtual-network-deployment-limitations"></a>Ограничение развертывания в виртуальной сети

При развертывании групп контейнеров в виртуальной сети действуют определенные ограничения.

* Для развертывания группы контейнеров в подсети эта подсеть не должна содержать другие типы ресурсов. Удалите все существующие ресурсы из существующей подсети, прежде чем развернуть в ней группы контейнеров, или создайте новую подсеть.
* [Управляемое удостоверение](container-instances-managed-identity.md) нельзя использовать в группе контейнеров, развернутой в виртуальной сети.
* Вы не можете включить [проверку актуальности](container-instances-liveness-probe.md) или [проверку готовности](container-instances-readiness-probe.md) в группе контейнеров, развернутой в виртуальной сети.
* В связи с дополнительными сетевыми ресурсами развертывание группы контейнеров в виртуальной сети обычно выполняется медленнее, чем развертывание стандартного экземпляра контейнера.

[!INCLUDE [container-instances-vnet-limits](../../includes/container-instances-vnet-limits.md)]

Ограничения ресурсов контейнера могут отличаться от ограничений для экземпляров несетевых контейнеров в этих регионах. Сейчас эта возможность поддерживает только контейнеры Linux. Запланирована поддержка Windows.

### <a name="unsupported-networking-scenarios"></a>Неподдерживаемые сценарии сети 

* **Azure Load Balancer** -размещение Azure Load Balancer перед экземплярами контейнера в сетевой группе контейнеров не поддерживается
* **Пиринг между виртуальными сетями**
  * Пиринг виртуальной сети не будет работать для ACI, если сеть, в которой находится виртуальная сеть ACI, использует пространство общедоступного IP-адреса. Для работы пиринга между виртуальными сетями требуется пространство частных IP-адресов RFC 1918. 
  * Вы можете выполнить одноранговую подсеть только для одной виртуальной сети.
* **Маршрутизация трафика виртуальной сети** . настраиваемые маршруты не могут быть настроены вокруг общедоступных IP-адресов. Маршруты можно настроить в частном IP-пространстве в делегированной подсети, в которой развернуты ресурсы ACI 
* **Группы безопасности сети** — правила безопасности для исходящего трафика в группы безопасности сети, применяемые к подсети, делегированной в службу "экземпляры контейнеров Azure", в настоящее время не применяются 
* **Общедоступные IP-адреса или метки DNS** . группы контейнеров, развернутые в виртуальной сети, сейчас не поддерживают предоставление контейнеров непосредственно в Интернете с общедоступным IP-адресом или полным доменным именем.
* **Внутреннее разрешение** имен. разрешение имен для ресурсов Azure в виртуальной сети с помощью внутренней Azure DNS не поддерживается.

Чтобы **удалить сетевые ресурсы**, вам потребуется выполнить [дополнительные действия](#delete-network-resources), если группы контейнеров развернуты в виртуальной сети.

## <a name="required-network-resources"></a>Необходимые сетевые ресурсы

Для развертывания групп контейнеров в виртуальной сети требуется три ресурса виртуальной сети Azure: сама [виртуальная сеть](#virtual-network), [делегированная подсеть](#subnet-delegated) в пределах этой виртуальной сети и [сетевой профиль](#network-profile). 

### <a name="virtual-network"></a>Виртуальная сеть

Виртуальная сеть определяет адресное пространство, в котором можно создать одну или несколько подсетей. Затем следует развернуть ресурсы Azure (например, группы контейнеров) в подсетях виртуальной сети.

### <a name="subnet-delegated"></a>Подсеть (делегированная)

Подсети сегментируют виртуальную сеть на отдельные адресные пространства, которые применяются для размещения ресурсов Azure. В виртуальной сети следует создать одну или несколько подсетей.

Подсеть, используемая для групп контейнеров, может содержать только группы контейнеров. При первом развертывании группы контейнеров в подсети Azure делегирует эту подсеть службе "Экземпляры контейнеров Azure". После делегирования подсеть можно использовать только для групп контейнеров. Если попытаться развернуть в делегированной подсети ресурсы, отличные от групп контейнеров, операция завершится ошибкой.

### <a name="network-profile"></a>сетевой профиль.

Сетевой профиль — это шаблон конфигурации сети для ресурсов Azure. Он задает определенные свойства сети для ресурса, например подсеть, в который его следует развернуть. При первом использовании команды [AZ Container Create][az-container-create] для развертывания группы контейнеров в подсети (и, таким как виртуальная сеть) Azure создает профиль сети. Затем этот сетевой профиль можно использовать для будущих развертываний в подсети. 

Чтобы использовать шаблон Resource Manager, файл YAML или программный метод для развертывания группы контейнеров в подсеть, необходимо указать полный идентификатор ресурса Resource Manager сетевого профиля. Вы можете использовать профиль, созданный ранее с помощью команды [AZ Container Create][az-container-create], или создать профиль с помощью шаблона диспетчер ресурсов (см. пример и [ссылку на](https://docs.microsoft.com/azure/templates/microsoft.network/networkprofiles) [шаблон](https://github.com/Azure/azure-quickstart-templates/tree/master/101-aci-vnet) ). Чтобы получить идентификатор ранее созданного профиля, используйте команду [AZ Network Profile List][az-network-profile-list] . 

На следующей схеме несколько групп контейнеров развернуты в подсети, делегированной службе "Экземпляры контейнеров Azure". Развернув одну группу контейнеров в подсети, можно развернуть в ней дополнительные группы контейнеров, указав тот же сетевой профиль.

![Группы контейнеров в виртуальной сети][aci-vnet-01]

## <a name="deployment-scenarios"></a>Сценарии развертывания

Чтобы развернуть группы контейнеров в новой виртуальной сети и разрешить Azure создавать необходимые сетевые ресурсы или выполнить развертывание в существующей виртуальной сети, можно использовать команду [AZ Container Create][az-container-create] . 

### <a name="new-virtual-network"></a>Новая виртуальная сеть

Чтобы выполнить развертывание в новой виртуальной сети и создать сетевые ресурсы Azure автоматически, укажите следующие сведения при выполнении команды [AZ Container Create][az-container-create]:

* Имя виртуальной сети
* Префикс адреса виртуальной сети в формате CIDR.
* Имя подсети
* Префикс адреса подсети в формате CIDR.

Префиксы адресов виртуальной сети и подсети определяют адресное пространство соответственно для виртуальной сети и подсети. Эти значения представлены в нотации бесклассовой междоменной маршрутизации (CIDR), например `10.0.0.0/16`. Дополнительные сведения о работе с подсетями см. в статье [Создание, изменение или удаление виртуальной сети](../virtual-network/virtual-network-manage-subnet.md).

Развернув первую группу контейнеров с помощью этого метода, можно выполнить развертывание в той же подсети, указав имена виртуальной сети и подсети, или же сетевой профиль, автоматически созданный в Azure. Так как Azure делегирует подсети службе "Экземпляры контейнеров Azure", в этой подсети можно развернуть *только* группы контейнеров.

### <a name="existing-virtual-network"></a>Существующая виртуальная сеть

Чтобы развернуть группу контейнеров в существующей виртуальной сети, сделайте следующее:

1. Создайте подсеть в существующей виртуальной сети, используйте существующую подсеть, в которой уже развернута группа контейнеров, или используйте существующую подсеть, очищенную от *всех* остальных ресурсов.
1. Разверните группу контейнеров с помощью команды [AZ Container Create][az-container-create] и укажите одно из следующих:
   * имя виртуальной сети и имя подсети;
   * идентификатор ресурса виртуальной сети и идентификатор ресурса подсети, которые позволяют использовать виртуальную сеть из другой группы ресурсов;
   * Имя или идентификатор сетевого профиля, который можно получить с помощью команды [AZ Network Profile List][az-network-profile-list]

Когда вы развернете первую группу контейнеров в существующей подсети, Azure делегирует эту подсеть службе "Экземпляры контейнеров Azure". В этой подсети больше нельзя развернуть ресурсы, отличные от групп контейнеров.

## <a name="deployment-examples"></a>Примеры развертывания

В следующих разделах описывается, как развертывать группы контейнеров в виртуальной сети с помощью Azure CLI. Примеры команд форматированы для оболочки **Bash**. Если вы предпочитаете использовать другую оболочку, например PowerShell или командную строку, измените соответствующим образом символы продолжения строки.

### <a name="deploy-to-a-new-virtual-network"></a>Развертывание в новую виртуальную сеть

Сначала разверните группу контейнеров и укажите параметры для новой виртуальной сети и подсети. Когда вы укажите эти параметры, Azure создаст виртуальную сеть и подсеть, делегирует подсеть службе "Экземпляры контейнеров Azure", а также создаст сетевой профиль. Когда эти ресурсы будут созданы, группа контейнеров будет развернута в подсети.

Выполните следующую команду [AZ Container Create][az-container-create] , которая указывает параметры для новой виртуальной сети и подсети. Необходимо указать имя группы ресурсов, созданной в регионе, где [доступны](#virtual-network-deployment-limitations)развертывания группы контейнеров в виртуальной сети. Эта команда развертывает общедоступный контейнер Microsoft [ACI-HelloWorld][aci-helloworld] , в котором выполняется небольшой веб-сервер Node. js, обслуживающий статичную страницу. В следующем разделе вы развернете вторую группу контейнеров в той же подсети и протестируете связь между двумя экземплярами контейнеров.

```azurecli
az container create \
    --name appcontainer \
    --resource-group myResourceGroup \
    --image mcr.microsoft.com/azuredocs/aci-helloworld \
    --vnet aci-vnet \
    --vnet-address-prefix 10.0.0.0/16 \
    --subnet aci-subnet \
    --subnet-address-prefix 10.0.0.0/24
```

Развертывание в новой виртуальной сети с помощью этого метода может занять несколько минут, пока создаются сетевые ресурсы. После развертывания первых групп контейнеров дополнительные группы будут развертываться быстрее.

### <a name="deploy-to-existing-virtual-network"></a>Развертывание в существующей виртуальной сети

Теперь, когда вы развернули группу контейнеров в новой виртуальной сети, разверните вторую группу контейнеров в той же подсети и проверьте связь между двумя экземплярами контейнеров.

Сначала получите IP-адрес первой развернутой группы контейнеров — *appcontainer*:

```azurecli
az container show --resource-group myResourceGroup --name appcontainer --query ipAddress.ip --output tsv
```

В выходных данных должен отображаться IP-адрес группы контейнеров в частной подсети:

```console
$ az container show --resource-group myResourceGroup --name appcontainer --query ipAddress.ip --output tsv
10.0.0.4
```

Теперь в качестве значения параметра `CONTAINER_GROUP_IP` укажите IP-адрес, полученный командой `az container show`, и выполните следующую команду `az container create`. Этот второй контейнер, *commchecker*, запускает образ на базе Alpine Linux и выполняет `wget` в отношении IP-адреса частной подсети первой группы контейнеров.

```azurecli
CONTAINER_GROUP_IP=<container-group-IP-here>

az container create \
    --resource-group myResourceGroup \
    --name commchecker \
    --image alpine:3.5 \
    --command-line "wget $CONTAINER_GROUP_IP" \
    --restart-policy never \
    --vnet aci-vnet \
    --subnet aci-subnet
```

Когда завершится развертывание второго контейнера, извлеките его журналы, чтобы просмотреть выходные данные выполненной им команды `wget`:

```azurecli
az container logs --resource-group myResourceGroup --name commchecker
```

Если второй контейнер успешно обменялся данными с первым, выходные данные должны выглядеть следующим образом:

```console
$ az container logs --resource-group myResourceGroup --name commchecker
Connecting to 10.0.0.4 (10.0.0.4:80)
index.html           100% |*******************************|  1663   0:00:00 ETA
```

Выходные данные журнала должны показывать, что программе `wget` удалось подключиться и скачать файл индекса из первого контейнера, используя его частный IP-адрес в локальной подсети. Сетевой трафик между двумя группами контейнеров оставался в пределах виртуальной сети.

### <a name="deploy-to-existing-virtual-network---yaml"></a>Развертывание в существующей виртуальной сети — YAML

Вы также можете развернуть группу контейнеров в существующей виртуальной сети с помощью файла YAML, шаблона диспетчер ресурсов или другого программного метода, например, с помощью пакета SDK для Python. Для развертывания в подсети виртуальной сети следует указать несколько дополнительных свойств в YAML:

* `ipAddress` — параметры IP-адреса для группы контейнеров.
  * `ports` — открываемые порты, если таковые имеются.
  * `protocol` — протокол (TCP или UDP) для открытого порта.
* `networkProfile` — позволяет задать параметры сети, такие как виртуальная сеть и подсеть для ресурса Azure.
  * `id` — полный идентификатор ресурса Resource Manager для `networkProfile`.

Чтобы развернуть группу контейнеров в виртуальной сети с помощью файла YAML, сначала необходимо получить идентификатор сетевого профиля. Выполните команду [AZ Network Profile List][az-network-profile-list] , указав имя группы ресурсов, которая содержит виртуальную сеть и делегированную подсеть.

``` azurecli
az network profile list --resource-group myResourceGroup --query [0].id --output tsv
```

В выходных данных команды будет показан полный идентификатор ресурса для сетевого профиля.

```console
$ az network profile list --resource-group myResourceGroup --query [0].id --output tsv
/subscriptions/<Subscription ID>/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkProfiles/aci-network-profile-aci-vnet-aci-subnet
```

Получив идентификатор сетевого профиля, скопируйте следующий код YAML в новый файл с именем *vnet-deploy-aci.yaml*. В разделе `networkProfile` замените значение `id` только что полученным идентификатором, затем сохраните файл. Этот код YAML создает группу контейнеров с именем *appcontaineryaml* в виртуальной сети.

```YAML
apiVersion: '2018-09-01'
location: westus
name: appcontaineryaml
properties:
  containers:
  - name: appcontaineryaml
    properties:
      image: mcr.microsoft.com/azuredocs/aci-helloworld
      ports:
      - port: 80
        protocol: TCP
      resources:
        requests:
          cpu: 1.0
          memoryInGB: 1.5
  ipAddress:
    type: Private
    ports:
    - protocol: tcp
      port: '80'
  networkProfile:
    id: /subscriptions/<Subscription ID>/resourceGroups/myResourceGroup/providers/Microsoft.Network/networkProfiles/aci-network-profile-aci-vnet-subnet
  osType: Linux
  restartPolicy: Always
tags: null
type: Microsoft.ContainerInstance/containerGroups
```

Разверните группу контейнеров с помощью команды [AZ Container Create][az-container-create] , указав имя файла YAML для параметра `--file`:

```azurecli
az container create --resource-group myResourceGroup --file vnet-deploy-aci.yaml
```

После завершения развертывания выполните команду [AZ Container Показать][az-container-show] , чтобы отобразить ее состояние:

```console
$ az container show --resource-group myResourceGroup --name appcontaineryaml --output table
Name              ResourceGroup    Status    Image                                       IP:ports     Network    CPU/Memory       OsType    Location
----------------  ---------------  --------  ------------------------------------------  -----------  ---------  ---------------  --------  ----------
appcontaineryaml  myResourceGroup  Running   mcr.microsoft.com/azuredocs/aci-helloworld  10.0.0.5:80  Private    1.0 core/1.5 gb  Linux     westus
```

## <a name="clean-up-resources"></a>Очистка ресурсов

### <a name="delete-container-instances"></a>Удаление экземпляров контейнеров

Когда завершите работу с созданными экземплярами контейнеров, удалите их с помощью следующих команд:

```azurecli
az container delete --resource-group myResourceGroup --name appcontainer -y
az container delete --resource-group myResourceGroup --name commchecker -y
az container delete --resource-group myResourceGroup --name appcontaineryaml -y
```

### <a name="delete-network-resources"></a>Удаление сетевых ресурсов

В настоящее время эта функция требует нескольких дополнительных команд для удаления созданных ранее сетевых ресурсов. Если вы использовали примеры команд из предыдущих разделов этой статьи для создания виртуальной сети и подсети, можно удалить эти сетевые ресурсы с помощью следующего скрипта.

Перед выполнением скрипта задайте в качестве переменной `RES_GROUP` имя группы ресурсов, содержащей виртуальную сеть и подсеть, которые следует удалить. Обновите имя виртуальной сети, если вы не использовали имя `aci-vnet`, предложенное ранее. Скрипт отформатирован для оболочки Bash. Если вы предпочитаете использовать другую оболочку, например PowerShell или командную строку, измените методы доступа и присваивание значения переменной соответствующим образом.

> [!WARNING]
> Этот скрипт удаляет ресурсы! Он удаляет виртуальную сеть и все подсети, которые в ней содержатся. Убедитесь, что вам больше *не* требуются ресурсы в этой виртуальной сети, включая все содержащиеся в ней подсети, прежде чем запускать этот скрипт. После удаления **эти ресурсы восстановить невозможно**.

```azurecli
# Replace <my-resource-group> with the name of your resource group
RES_GROUP=<my-resource-group>

# Get network profile ID
NETWORK_PROFILE_ID=$(az network profile list --resource-group $RES_GROUP --query [0].id --output tsv)

# Delete the network profile
az network profile delete --id $NETWORK_PROFILE_ID -y

# Delete virtual network
az network vnet delete --resource-group $RES_GROUP --name aci-vnet
```

## <a name="next-steps"></a>Дальнейшие действия

Чтобы развернуть новую виртуальную сеть, подсеть, сетевой профиль и группу контейнеров с помощью шаблона Resource Manager, см. страницу [создания группы контейнеров Azure с виртуальной сетью](https://github.com/Azure/azure-quickstart-templates/tree/master/101-aci-vnet
).

В этой статье были кратко описаны несколько ресурсов и функций виртуальной сети. Более подробно эти темы рассматриваются в следующей документации по виртуальным сетям Azure:

* [Виртуальная сеть](../virtual-network/manage-virtual-network.md)
* [Подсеть](../virtual-network/virtual-network-manage-subnet.md)
* [Конечные точки службы](../virtual-network/virtual-network-service-endpoints-overview.md)
* [VPN-шлюз](../vpn-gateway/vpn-gateway-about-vpngateways.md)
* [ExpressRoute](../expressroute/expressroute-introduction.md)

<!-- IMAGES -->
[aci-vnet-01]: ./media/container-instances-vnet/aci-vnet-01.png

<!-- LINKS - External -->
[aci-helloworld]: https://hub.docker.com/_/microsoft-azuredocs-aci-helloworld
[terms-of-use]: https://azure.microsoft.com/support/legal/preview-supplemental-terms/

<!-- LINKS - Internal -->
[az-container-create]: /cli/azure/container#az-container-create
[az-container-show]: /cli/azure/container#az-container-show
[az-network-vnet-create]: /cli/azure/network/vnet#az-network-vnet-create
[az-network-profile-list]: /cli/azure/network/profile#az-network-profile-list
