---
title: Начало работы с настраиваемыми политиками — Azure Active Directory B2C | Документация Майкрософт
description: Узнайте, как приступить к работе с настраиваемыми политиками в Azure Active Directory B2C.
services: active-directory-b2c
author: davidmu1
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 04/03/2019
ms.author: davidmu
ms.subservice: B2C
ms.openlocfilehash: 6a66d45028b9fbf9c421b10ffb7863fcb9be5bec
ms.sourcegitcommit: 36c50860e75d86f0d0e2be9e3213ffa9a06f4150
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2019
ms.locfileid: "65779847"
---
# <a name="get-started-with-custom-policies-in-azure-active-directory-b2c"></a>Начало работы с настраиваемыми политиками в Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

[Настраиваемые политики](active-directory-b2c-overview-custom.md) — это файлы конфигурации, определяющие поведение вашего клиента Azure Active Directory (Azure AD) B2C. В рамках этой статьи вы создадите настраиваемую политику, которая будет поддерживать регистрацию и вход с помощью локальной учетной записи с использованием адреса электронной почты и пароля. Вы также можете подготовить среду для добавления поставщиков удостоверений.

## <a name="prerequisites"></a>Технические условия

- Если у вас еще нет клиента Azure AD B2C, его необходимо [создать](tutorial-create-tenant.md). Он должен быть связан с вашей подпиской Azure.
- [Регистрация приложения](tutorial-register-applications.md) в клиенте, который вы создали, он мог обмениваться данными с Azure AD B2C.

## <a name="add-signing-and-encryption-keys"></a>Добавление ключей подписи и шифрования

1. Войдите на [портал Azure](https://portal.azure.com/) с правами глобального администратора клиента Azure AD B2C.
2. Убедитесь, что вы используете каталог, содержащий клиент Azure AD B2C. Нажмите кнопку **фильтр каталога и подписки** в верхнем меню и выберите каталог, содержащий вашего клиента. 
3. Выберите **Все службы** в левом верхнем углу окна портала Azure, найдите службу **Azure AD B2C** и выберите ее.
4. На странице "Обзор" выберите **Identity Experience Framework**.

### <a name="create-the-signing-key"></a>Создание ключа подписи

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
2. Для пункта **Параметры** выберите `Generate`.
3. В разделе **Имя** введите `TokenSigningKeyContainer`. Префикс `B2C_1A_` может быть добавлен автоматически.
4. Для параметра **Тип ключа** выберите **RSA**.
5. Для параметра **Использование ключа** выберите **Подпись**.
6. Нажмите кнопку **Создать**.

### <a name="create-the-encryption-key"></a>Создание ключа шифрования

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
2. Для пункта **Параметры** выберите `Generate`.
3. В разделе **Имя** введите `TokenEncryptionKeyContainer`. Префикс `B2C_1A`_ может быть добавлен автоматически.
4. Для параметра **Тип ключа** выберите **RSA**.
5. Для параметра **Использование ключа** задайте значение **Шифрование**.
6. Нажмите кнопку **Создать**.

### <a name="create-the-facebook-key"></a>Создание ключа Facebook

При наличии [секрета приложения Facebook](active-directory-b2c-setup-fb-app.md) добавьте его как ключ политики в клиенте. В противном случае создайте ключ со значением-заполнителем. Это позволит политикам проходить проверку.

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
2. Для пункта **Параметры** выберите `Manual`.
3. Для параметра **Имя** введите `FacebookSecret`. Префикс `B2C_1A_` может быть добавлен автоматически.
4. Выберите **Секрет**, введите секрет Facebook, указанный на сайте developers.facebook.com, или задайте значение `0` в качестве заполнителя. Это значение является секрет, а не идентификатор приложения.
5. Для параметра **Использование ключа** выберите **Подпись**.
6. Нажмите кнопку **Создать**.

## <a name="register-identity-experience-framework-applications"></a>Регистрация приложений инфраструктуры процедур идентификации

Для Azure AD B2C необходимо зарегистрировать два приложения, которые используются для регистрации и входа пользователей: IdentityExperienceFramework (веб-приложение) и ProxyIdentityExperienceFramework (собственное приложение) с делегированным разрешением IdentityExperienceFramework. Локальные учетные записи хранятся только в клиенте. Пользователи регистрируются в системе, используя уникальное сочетание адреса электронной почты и пароля, чтобы получить доступ к зарегистрированным в клиенте приложениям.

### <a name="register-the-identityexperienceframework-application"></a>Регистрация приложения IdentityExperienceFramework

1. Выберите **Все службы** в левом верхнем углу окна портала Azure, а затем найдите и выберите **Регистрация приложений**.
2. Выберите **Регистрация нового приложения**.
3. Для параметра **Имя** введите `IdentityExperienceFramework`.
4. Для параметра **Тип приложения** выберите **Веб-приложение или API**.
5. Для параметра **URL-адрес для входа** введите `https://your-tenant-name.b2clogin.com/your-tenant-name.onmicrosoft.com`, где `your-tenant-name` — это доменное имя клиента Azure AD B2C.
6. Нажмите кнопку **Создать**. 
7. По завершении операции создания скопируйте идентификатор приложения и сохраните его для последующего использования.

### <a name="register-the-proxyidentityexperienceframework-application"></a>Регистрация приложения ProxyIdentityExperienceFramework

1. Щелкните **Регистрация приложений** и выберите **Регистрация нового приложения**.
2. Для параметра **Имя** введите `ProxyIdentityExperienceFramework`.
3. Для параметра **Тип приложения** выберите **Собственный**.
4. Для параметра **URI перенаправления** введите `https://your-tenant-name.b2clogin.com/your-tenant-name.onmicrosoft.com`, где `yourtenant` — это ваш клиент Azure AD B2C.
5. Нажмите кнопку **Создать**. По завершении операции создания скопируйте идентификатор приложения и сохраните его для последующего использования.
6. На странице параметров выберите **Необходимые разрешения** и щелкните **Добавить**.
7. Выберите **Выбор API**, найдите и выберите **IdentityExperienceFramework**, а затем нажмите кнопку **выберите**.
9. Установите флажок рядом с элементом **Access IdentityExperienceFramework** (Доступ к IdentityExperienceFramework), щелкните **Выбрать**, а затем — **Готово**.
10. Выберите **Предоставление разрешений**, затем **Да** для подтверждения.

## <a name="download-starter-pack-and-modify-policies"></a>Скачивание начального пакета и изменение политик

Настраиваемые политики — это набор XML-файлов, которые нужно отправить в клиент Azure AD B2C. Предоставляются начальные пакеты, которые позволяют быстро приступить к работе. Каждый начальный пакет из следующего списка содержит минимальное количество технических профилей и путей взаимодействия пользователей, необходимых для достижения описанных сценариев:

- LocalAccounts. Позволяет использовать только локальные учетные записи.
- SocialAccounts. Позволяет использовать только учетные записи социальных сетей (или федеративные).
- SocialAndLocalAccounts. Позволяет использовать и локальные учетные записи, и учетные записи социальных сетей.
- SocialAndLocalAccountsWithMFA. Позволяет использовать локальные учетные записи и учетные записи социальных сетей с Многофакторной идентификацией.

Каждый начальный пакет содержит:

- Базовый файл. Для базового файла требуется несколько изменений.
- Файл расширения.  В этот файл вносится большинство изменений конфигурации.
- Файлы проверяющей стороны. Файлы, запрашиваемые приложением для выполнения определенных задач.

>[!NOTE]
>Если в редакторе XML поддерживается проверка, проверьте файлы с помощью XML-файла схемы TrustFrameworkPolicy_0.3.0.0.xsd, который расположен в корневом каталоге начального пакета. При проверке по схеме XML определяются ошибки перед отправкой.

1. [Скачайте ZIP-файл](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/archive/master.zip) или выполните команду:

    ```console
    git clone https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack
    ```

2. В папке SocialAndLocalAccounts измените все файлы, заменив `yourtenant` именем вашего клиента. Например, `contosoTenant.onmicrosoft.com`. Если вам нужен редактор XML, [попробуйте Visual Studio Code](https://code.visualstudio.com/download) — упрощенный кроссплатформенный редактор.

### <a name="add-application-ids-to-the-custom-policy"></a>Добавление идентификаторов приложений в настраиваемую политику

В файл расширений *TrustFrameworkExtensions* добавьте идентификаторы приложений.

1. Откройте файл *TrustFrameworkExtensions* и найдите элемент `<TechnicalProfile Id="login-NonInteractive">`.
2. Замените оба экземпляра `IdentityExperienceFrameworkAppId` идентификатором созданного ранее приложения инфраструктуры процедур идентификации. Замените оба экземпляра `ProxyIdentityExperienceFrameworkAppId` идентификатором созданного ранее приложения прокси инфраструктуры процедур идентификации.
3. Сохраните файл расширений.

## <a name="upload-the-policies"></a>Отправка политик

1. На странице "Настраиваемые политики" инфраструктуры процедур идентификации щелкните **Отправить политику**.
1. Отправьте файлы в следующем порядке: *TrustFrameworkBase.xml*, *TrustFrameworkExtensions.xml*, *SignUpOrSignin.xml*, *ProfileEdit.xml* и *PasswordReset.xml*. При отправке к имени файла политики добавляется префикс `B2C_1A_`.

## <a name="test-the-custom-policy"></a>Проверка пользовательской политики

1. На странице "Настраиваемые политики" выберите **B2C_1A_signup_signin**.
2. Для **выберите приложение** на странице "Обзор" пользовательской политики, выберите веб-приложение с именем *webapp1* , которую вы ранее зарегистрировали. Убедитесь, что **URL-адрес ответа** является `https://jwt.ms`.
3. Выберите **Запустить сейчас**.
4. Вы сможете зарегистрироваться, используя адрес электронной почты.
5. Войдите в систему с помощью той же учетной записи, чтобы подтвердить правильность конфигурации.

## <a name="add-facebook-as-an-identity-provider"></a>Добавление Facebook в качестве поставщика удостоверений

1. Настройте [приложение Facebook](active-directory-b2c-setup-fb-app.md).
2. В файле *TrustFrameworkExtensions.xml* замените значение `client_id` идентификатором приложения Facebook.

   ```xml
   <TechnicalProfile Id="Facebook-OAUTH">
     <Metadata>
     <!--Replace the value of client_id in this technical profile with the Facebook app ID"-->
       <Item Key="client_id">00000000000000</Item>
   ```
3. Отправьте файл *TrustFrameworkExtensions.xml* в клиент.
4. Выполните проверку с помощью команды **Запустить сейчас** или вызовите политику непосредственно из зарегистрированного приложения.

## <a name="next-steps"></a>Дальнейшие действия

- Добавьте Azure Active Directory в качестве поставщика удостоверений. В базовом файле, который использовался в этом руководстве по началу работы, уже имеется некоторое содержимое, необходимое для добавления других поставщиков удостоверений. Сведения о настройке входа в систему см. в статье [Azure Active Directory B2C. Выполнение входа с помощью учетных записей Azure AD](active-directory-b2c-setup-aad-custom.md).
