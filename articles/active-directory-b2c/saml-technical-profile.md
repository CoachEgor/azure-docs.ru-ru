---
title: Определение технического профиля SAML в пользовательской политике
titleSuffix: Azure AD B2C
description: Определение технического профиля SAML в настраиваемой политике в Azure Active Directory B2C.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: reference
ms.date: 02/13/2020
ms.author: mimart
ms.subservice: B2C
ms.openlocfilehash: 8c81d2bc499c3d9cae262ef62be2dac2d7280be7
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78183845"
---
# <a name="define-a-saml-technical-profile-in-an-azure-active-directory-b2c-custom-policy"></a>Определение технического профиля SAML в настраиваемой политике Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

Активный каталог Azure B2C (Azure AD B2C) предоставляет поддержку поставщику идентификационных данных SAML 2.0. В этой статье описаны особенности технического профиля для взаимодействия с поставщиком утверждений, который поддерживает этот стандартизированный протокол. С помощью технического профиля SAML можно создавать федерацию с поставщиком удостоверений на основе SAML, например [ADFS](identity-provider-adfs2016-custom.md) и [Salesforce](identity-provider-salesforce-custom.md). Она позволяет пользователям выполнять вход с использованием их удостоверений для социальных сетей или корпоративных удостоверений.

## <a name="metadata-exchange"></a>Обмен метаданными

Метаданные — это сведения, используемые в протоколе SAML для предоставления конфигурации стороны SAML, например поставщика услуг или поставщика удостоверений. Метаданные определяют расположение служб, например вход и выход, сертификаты, метод входа и многое другое. Поставщик удостоверений использует метаданные, чтобы узнать, как взаимодействовать с Azure AD B2C. Метаданные настраиваются в формате XML и могут быть подписаны с помощью цифровой подписи, чтобы другая сторона могла проверить их целостность. Когда служба Azure AD B2C создает федерацию с поставщиком удостоверений SAML, она выступает в качестве поставщика услуг, инициируя запрос SAML и ожидая ответ SAML. Кроме того, в некоторых случаях она принимает незапрашиваемую аутентификацию SAML, которая также называется инициированной поставщиком удостоверений.

Метаданные можно настроить у обеих сторон как "Статические метаданные" или "Динамические метаданные". В статическом режиме все метаданные копируются у одной стороны и настраиваются у другой. В динамическом режиме для метаданных задается URL-адрес, в то время как другая сторона считывает конфигурацию динамически. Принципы те же: вы задаете метаданные технического профиля Azure AD B2C у поставщика удостоверений и задаете метаданные поставщика удостоверений в Azure AD B2C.

В каждом поставщике удостоверений SAML предусмотрены разные действия для предоставления и настройки поставщика услуг (в данном случае Azure AD B2C), а также настройки метаданных Azure AD B2C в поставщике удостоверений. Рекомендации о том, как это сделать, см. в документации поставщика удостоверений.

В указанном ниже примере показан URL-адрес метаданных SAML, связанных с техническим профилем Azure AD B2C.

```
https://your-tenant-name.b2clogin.com/your-tenant-name/your-policy/samlp/metadata?idptp=your-technical-profile
```

Измените следующие значения:

- **your-tenant-name** — именем клиента, например fabrikam.b2clogin.com.
- **your-policy** — именем собственной политики. Используйте политику с настроенным техническим профилем поставщика SAML или политику, которая от нее наследуется.
- **ваш технический профиль** с техническим профилем поставщика SAML.

## <a name="digital-signing-certificates-exchange"></a>Обмен сертификатами для цифровой подписи

Чтобы создать отношение доверия между Azure AD B2C и поставщиком удостоверений SAML, необходимо указать допустимый сертификат X509 с закрытым ключом. Отправьте сертификат с закрытым ключом (PFX-файл) в хранилище ключей политики Azure AD B2C. Azure AD B2C подписывает запрос на вход SAML с использованием предоставленного вами сертификата.

Сертификат используется в следующих случаях.

- Azure AD B2C создает и подписывает запрос SAML, используя закрытый ключ Azure AD B2C сертификата. Запрос SAML отправляется поставщику удостоверений, который проверяет запрос с помощью открытого ключа Azure AD B2C сертификата. Получить доступ к открытому сертификату Azure AD B2C можно с помощью метаданных технического профиля. Кроме того, можно вручную отправить CER-файл поставщику удостоверений SAML.
- Поставщик удостоверений подписывает данные, отправляемые в Azure AD B2C, с помощью закрытого ключа поставщика удостоверений сертификата. Azure AD B2C проверяет данные, используя открытый сертификат поставщика удостоверений. В каждом поставщике удостоверений предусмотрены разные действия по настройке. Рекомендации о том, как это сделать, см. в документации к поставщикам удостоверений. В Azure AD B2C политике требуется доступ к открытому ключу сертификата с использованием метаданных поставщика удостоверений.

Самозаверяющий сертификат приемлем для большинства сценариев. В рабочей среде рекомендуется использовать сертификат X509, выданный центром сертификации. Кроме того, как описано далее в этом документе, для нерабочей среды можно отключить подписывание SAML на обеих сторонах.

На следующей схеме показан обмен метаданными и сертификатами:

![обмен метаданными и сертификатами](media/saml-technical-profile/technical-profile-idp-saml-metadata.png)

## <a name="digital-encryption"></a>Цифровое шифрование

Чтобы зашифровать утверждение ответа SAML, поставщик удостоверений всегда использует открытый ключ сертификата шифрования в техническом профиле Azure AD B2C. Когда службе Azure AD B2C необходимо расшифровать данные, она использует закрытую часть сертификата шифрования.

Шифрование утверждения ответа SAML:

1. Отправьте допустимый сертификат X509 с закрытым ключом (PFX-файл) в хранилище ключей политики Azure AD B2C.
2. Добавьте элемент **CryptographicKey** с идентификатором `SamlAssertionDecryption` в коллекцию **CryptographicKeys** технического профиля. Задайте для **StorageReferenceId** имя ключа политики, созданного на шаге 1.
3. Задайте для метаданных технического профиля **WantsEncryptedAssertions** значение `true`.
4. Добавьте в поставщик удостоверений новые метаданные технического профиля Azure AD B2C. В параметре **KeyDescriptor** свойству **use** должно быть присвоено значение `encryption`, содержащее открытый ключ сертификата.

В следующем примере показан раздел шифрования метаданных технического профиля Azure AD B2C:

```XML
<KeyDescriptor use="encryption">
  <KeyInfo xmlns="https://www.w3.org/2000/09/xmldsig#">
    <X509Data>
      <X509Certificate>valid certificate</X509Certificate>
    </X509Data>
  </KeyInfo>
</KeyDescriptor>
```

## <a name="protocol"></a>Протокол

Атрибуту **Name** элемента Protocol необходимо присвоить значение `SAML2`.

## <a name="output-claims"></a>Исходящие утверждения

Элемент **OutputClaims** содержит список утверждений, возвращаемых поставщиком удостоверений SAML, в разделе `AttributeStatement`. Возможно, потребуется сопоставить имя утверждения, определенное в вашей политике, с именем, определенным у поставщика удостоверений. Вы также можете добавить утверждения, которые не возвращаются поставщиком удостоверений, установив атрибут `DefaultValue`.

Для считывания утверждения SAML **NamedId** в **Subject** в виде нормализованного утверждения задайте элементу **PartnerClaimType** утверждения значение `assertionSubjectName`. Убедитесь, что **NameId** является первым значением в XML утверждения. При определении нескольких утверждений Azure AD B2C выбирает значения субъекта из последнего утверждения.

Элемент **OutputClaimsTransformations** может содержать коллекцию элементов **OutputClaimsTransformation**, которые используются для изменения исходящих утверждений или создания новых.

В этом примере показаны утверждения, возвращаемые поставщиком удостоверений Facebook:

- Претензия **issuerUserId** отображается в претензии **assertionSubjectName.**
- Утверждение **first_name** сопоставляется с утверждением **givenName**.
- Утверждение **last_name** сопоставляется с утверждением **surname**.
- Претензия **displayName** без отображения имени.
- Утверждение **email** не сопоставляется с именем.

Технический профиль также возвращает утверждения, которые не возвращаются поставщиком удостоверений:

- Утверждение **IdentityProvider**, содержащее имя поставщика удостоверений.
- утверждение **AuthenticationSource** со значением по умолчанию **socialIdpAuthentication**.

```xml
<OutputClaims>
  <OutputClaim ClaimTypeReferenceId="issuerUserId" PartnerClaimType="assertionSubjectName" />
  <OutputClaim ClaimTypeReferenceId="givenName" PartnerClaimType="first_name" />
  <OutputClaim ClaimTypeReferenceId="surname" PartnerClaimType="last_name" />
  <OutputClaim ClaimTypeReferenceId="displayName" PartnerClaimType="name" />
  <OutputClaim ClaimTypeReferenceId="email"  />
  <OutputClaim ClaimTypeReferenceId="identityProvider" DefaultValue="contoso.com" />
  <OutputClaim ClaimTypeReferenceId="authenticationSource" DefaultValue="socialIdpAuthentication" />
</OutputClaims>
```

## <a name="metadata"></a>Метаданные

| Атрибут | Обязательно | Описание |
| --------- | -------- | ----------- |
| PartnerEntity | Да | URL-адрес метаданных поставщика удостоверений SAML. Скопируйте метаданные поставщика удостоверений и добавьте их в элемент CDATA `<![CDATA[Your IDP metadata]]>` |
| WantsSignedRequests | нет | Указывает, требуется ли для технического профиля, чтобы все исходящие запросы аутентификации были подписаны. Возможные значения: `true` или `false`. Значение по умолчанию — `true`. Если присвоено значение `true`, криптографический ключ **SamlMessageSigning** должен быть указан и все исходящие запросы аутентификации должны быть подписаны. Если присвоено значение `false`, параметры **SigAlg** и **Signature** (строка запроса или параметр отправки) не включаются в запрос. Эти метаданные также определяют атрибут **AuthnRequestsSigned** метаданных, который представляет собой выходные данные в метаданных технического профиля Azure AD B2C, совместно используемого с поставщиком удостоверений. Azure AD B2C не подписывает запрос, если значение **WantSignedRequests** в метаданных технического профиля установлено `false` и метаданные поставщика идентификационных данных **WantAuthnRequestsSigned** установлены `false` или не указаны. |
| XmlSignatureAlgorithm | нет | Метод, который Azure AD B2C использует для подписывания запроса SAML. Эти метаданные определяют значение параметра **SigAlg** (строка запроса или параметр отправки) в запросе SAML. Возможные значения: `Sha256`, `Sha384`, `Sha512` или `Sha1`. Настройте алгоритм подписи на обеих сторонах, используя одно и то же значение. Используйте только тот алгоритм, который поддерживается вашим сертификатом. |
| WantsSignedAssertions | нет | Указывает, требуется ли для технического профиля, чтобы все входящие утверждения были подписаны. Возможные значения: `true` или `false`. Значение по умолчанию — `true`. Если присвоено значение `true`, весь раздел утверждений `saml:Assertion`, отправленный поставщиком удостоверений в Azure AD B2C, должен быть подписан. Если присвоено значение `false`, поставщик удостоверений не должен подписывать утверждения, но даже если он подпишет, Azure AD B2C не проверит его подпись. Эти метаданные также определяют флаг **WantsAssertionsSigned** метаданных, который представляет собой выходные данные в метаданных технического профиля Azure AD B2C, совместно используемого с поставщиком удостоверений. Если отключить проверку утверждений, также может понадобиться отключить проверку подписи ответа (дополнительные сведения см. в разделе **ResponsesSigned**). |
| ResponsesSigned | нет | Возможные значения: `true` или `false`. Значение по умолчанию — `true`. Если присвоено значение `false`, поставщик удостоверений не должен подписывать ответ SAML, но даже если он подпишет, Azure AD B2C не проверит его подпись. Если присвоено значение `true`, ответ SAML, отправляемый поставщиком удостоверений в Azure AD B2C, подписан и должен быть проверен. Если отключить проверку ответов SAML, также может понадобиться отключить проверку подписи утверждений (дополнительные сведения см. в разделе **WantsSignedAssertions**). |
| WantsEncryptedAssertions | нет | Указывает, требуется ли для технического профиля, чтобы все входящие утверждения были зашифрованы. Возможные значения: `true` или `false`. Значение по умолчанию — `false`. Если присвоено значение `true`, утверждения, отправляемые поставщиком удостоверений в Azure AD B2C, должны быть подписаны, а также необходимо указать криптографический ключ **SamlAssertionDecryption**. Если присвоено значение `true`, метаданные технического профиля Azure AD B2C включают в себя раздел **encryption**. Поставщик удостоверений считывает метаданные и шифрует утверждение ответа SAML с помощью открытого ключа, указанного в метаданных технического профиля Azure AD B2C. Если включить шифрование утверждений, также может понадобиться отключить проверку подписи ответа (дополнительные сведения см. в разделе **ResponsesSigned**). |
| IdpInitiatedProfileEnabled | нет | Указывает, включен ли профиль сеанса единого входа, инициированный профилем поставщика удостоверений SAML. Возможные значения: `true` или `false`. Значение по умолчанию — `false`. В потоке, инициированном поставщиком удостоверений, пользователь проходит аутентификацию извне, а незапрашиваемый ответ отправляется в Azure AD B2C. Эта служба затем использует токен, выполняет шаги оркестрации и отправляет ответ в приложение проверяющей стороны. |
| NameIdPolicyFormat | нет | Задает ограничения для идентификатора имени, который будет использоваться для представления запрашиваемого субъекта. Если не указан, для запрашиваемого субъекта можно использовать любой тип идентификатора, поддерживаемый поставщиком удостоверений. Например, `urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified`. **NameIdPolicyFormat** можно использовать с **NameIdPolicyAllowCreate**. Сведения о поддерживаемых политиках идентификаторов имен см. в документации к поставщику удостоверений. |
| NameIdPolicyAllowCreate | нет | При использовании **NameIdPolicyFormat** можно также указать свойство `AllowCreate` атрибута **NameIDPolicy**. Значение этих метаданных (`true` или `false`) указывает, разрешено ли поставщику удостоверений создавать учетную запись в процессе входа. Рекомендации о том, как это сделать, см. в документации поставщика удостоверений. |
| AuthenticationRequestExtensions | нет | Необязательные элементы расширения сообщений протокола, согласованные между Azure AD BC и поставщиком удостоверений. Расширение представлено в формате XML. Данные XML добавляются внутри `<![CDATA[Your IDP metadata]]>` элемента CDATA. Сведения о поддержке элемента расширений см. в документации к поставщику удостоверений. |
| IncludeAuthnContextClassReferences | нет | Указывает одну ссылку URI или несколько, определяющих классы контекста проверки подлинности. Например, чтобы разрешить пользователю выполнять вход с использованием только имени пользователя и пароля, задайте значение `urn:oasis:names:tc:SAML:2.0:ac:classes:Password`. Чтобы разрешить вход с использованием имени пользователя и пароля через защищенный сеанс (SSL/TLS), укажите `PasswordProtectedTransport`. Сведения о поддерживаемых URI **AuthnContextClassRef** см. в документации к поставщику удостоверений. Укажите несколько URI в виде списка разграничения запятой. |
| IncludeKeyInfo | нет | Указывает, содержит ли запрос на проверку подлинности SAML открытый ключ сертификата, если привязка имеет значение `HTTP-POST`. Возможные значения: `true` или `false`. |
| IncludeclaimРазрешениеОбработкапретензий  | нет | Для претензий на ввод и вывод ы указывается, включено ли [разрешение претензий](claim-resolver-overview.md) в технический профиль. Возможные значения: `true` `false`  или (по умолчанию). Если вы хотите использовать решатели претензий в `true`техническом профиле, установите это на . |

## <a name="cryptographic-keys"></a>Криптографические ключи

Элемент **CryptographicKeys** содержит следующие атрибуты.

| Атрибут |Обязательно | Описание |
| --------- | ----------- | ----------- |
| SamlMessageSigning |Да | Сертификат X509 (набор ключей RSA), используемый для подписывания сообщений SAML. Azure AD B2C использует этот ключ для подписывания запросов и отправки их поставщику удостоверений. |
| SamlAssertionDecryption |Да | Сертификат X509 (набор ключей RSA), используемый для расшифровки сообщений SAML. Этот сертификат необходимо указать с помощью поставщика удостоверений. Azure AD B2C использует этот сертификат для расшифровки данных, отправленных поставщиком удостоверений. |
| MetadataSigning |нет | Сертификат X509 (набор ключей RSA), используемый для подписывания метаданных SAML. Azure AD B2C использует этот ключ для подписывания метаданных.  |

## <a name="next-steps"></a>Дальнейшие действия

Смотрите следующие статьи для примеров работы с поставщиками идентификационных данных SAML в Azure AD B2C:

- [Добавление ADFS в качестве поставщика удостоверений SAML с помощью пользовательских политик в Azure Active Directory B2C](identity-provider-adfs2016-custom.md)
- [Azure Active Directory B2C. Выполнение входа с помощью учетных записей Salesforce через SAML](identity-provider-salesforce-custom.md)
