---
title: Устранение неполадок пользовательских политик в Azure Active Directory B2C
description: Узнайте о способах решения проблем при работе с пользовательскими политиками в Azure Active Directory B2C.
services: active-directory-b2c
author: mmacy
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 08/13/2019
ms.author: marsma
ms.subservice: B2C
ms.openlocfilehash: 4893025b7d54dad1f1da6c5967d3c1dec99b499b
ms.sourcegitcommit: 7c2dba9bd9ef700b1ea4799260f0ad7ee919ff3b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/02/2019
ms.locfileid: "71826898"
---
# <a name="troubleshoot-azure-ad-b2c-custom-policies-and-identity-experience-framework"></a>Устранение неполадок в пользовательских политиках Azure AD B2C и инфраструктуре процедур идентификации

Если вы используете пользовательские политики Azure Active Directory B2C (Azure AD B2C), вы можете столкнуться с некоторыми трудностями при настройке инфраструктуры процедур идентификации на языке политики в формате XML. Обучение написанию пользовательских политик подобно изучению нового языка. В этой статье описаны некоторые средства и советы, которые могут помочь в обнаружении и устранении проблем.

Мы рассмотрим устранение неполадок, связанных с настройками пользовательских политик Azure AD B2C. В этой статье не рассматривается приложение проверяющей стороны или его библиотека удостоверений.

## <a name="xml-editing"></a>Редактирование кода XML

Самой распространенной ошибкой при настройке пользовательских политик является неправильный формат XML. Вам нужен хороший редактор XML. Он отображает XML-код в собственном виде, содержимое цветовых кодов, предварительно заполняет общие термины, поддерживает индексирование XML-элементов и может проверить схему XML.

Два предпочтительных редактора — [Visual Studio Code](https://code.visualstudio.com/) и [Notepad + +](https://notepad-plus-plus.org/).

При проверке по схеме XML определяются ошибки перед отправкой XML-файла. В корневой папке [начального пакета](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack)получите файл определения схемы XML *trustframeworkpolicy_ 0.3.0.0. xsd*. Чтобы узнать, как использовать файл схемы XSD для проверки в редакторе, найдите *средства XML* и *проверку XML* или аналогичную документацию редактора.

Не будет лишним также ознакомиться с правилами XML. Azure AD B2C отклоняет любые обнаруженные ошибки форматирования. Иногда, если используется XML неправильного формата, могут появляться сообщения об ошибках, вводящие в заблуждение.

## <a name="upload-policies-and-policy-validation"></a>Передача политик и их проверка

Проверка файла политики XML выполняется автоматически при передаче. Большинство ошибок приводят к сбою отправки. Проверка включает файл политики, который вы отправляете. Она также включает цепочку файлов, с которыми связан файл для отправки (файл политики проверяющей стороны, файл расширения и базовый файл).

Ниже перечислены распространенные ошибки проверки.

> Фрагмент кода ошибки: `...makes a reference to ClaimType with id "displayName" but neither the policy nor any of its base policies contain such an element`

* Значение ClaimType может быть введено неверно или не существовать в схеме.
* Значения ClaimType нужно определить по крайней мере в одном из файлов политики.
    Например: `<ClaimType Id="issuerUserId">`
* Если параметр ClaimType определен в файле расширения, но также используется в значении TechnicalProfile в базовом файле, передача базового файла приведет к ошибке.

> Фрагмент кода ошибки: `...makes a reference to a ClaimsTransformation with id...`

* Причины этой ошибки могут быть такими же, как и в случае ошибки с параметром "сбой".

> Фрагмент кода ошибки: `Reason: User is currently logged as a user of 'yourtenant.onmicrosoft.com' tenant. In order to manage 'yourtenant.onmicrosoft.com', please login as a user of 'yourtenant.onmicrosoft.com' tenant`

* Убедитесь, что значение TenantId в элементах `<TrustFrameworkPolicy\>` и `<BasePolicy\>` соответствует целевому клиенту Azure AD B2C.

## <a name="troubleshoot-the-runtime"></a>Устранение неполадок среды выполнения

* Используйте **команду Запустить сейчас** и `https://jwt.ms`, чтобы протестировать политики независимо от веб-или мобильного приложения. Этот веб-сайт работает как приложение проверяющей стороны. Он отображает содержимое JSON Web Token (JWT), созданного политикой Azure AD B2C.

    Чтобы создать тестовое приложение, которое может перенаправляться в `https://jwt.ms` для проверки маркера:

    [!INCLUDE [active-directory-b2c-appreg-idp](../../includes/active-directory-b2c-appreg-idp.md)]

* Чтобы отследить обмен сообщениями между клиентским браузером и Azure AD B2C, используйте [Fiddler](https://www.telerik.com/fiddler). Это позволит узнать, где в шагах оркестрации случился сбой пути взаимодействия пользователя.

* Используйте [Application Insights](active-directory-b2c-troubleshoot-custom.md) в **режиме разработки**, чтобы отслеживать поведение в рамках пути взаимодействия пользователя в инфраструктуре процедур идентификации. В **режиме разработки**можно наблюдать за обменом утверждениями между инфраструктурой процедур идентификации и различными поставщиками утверждений, определенными техническими профилями, такими как поставщики удостоверений, службы на основе API, Azure AD B2C пользователя. Каталог и другие службы, такие как многофакторная идентификация Azure.

## <a name="recommended-practices"></a>Рекомендации

**Храните нескольких версий своих сценариев. Группируйте их в проект со своим приложением.** Базовые файлы, файлы расширения и файлы проверяющей стороны напрямую зависят друг от друга. Сохраните их как группу. Используйте отдельные рабочие версии по мере реализации новых функций в политиках. Поместите рабочие версии в свою собственную файловую систему с кодом приложения, с которым они взаимодействуют. Приложения могут вызывать многие различные политики проверяющей стороны в клиенте. Они могут стать зависимыми от утверждений, ожидаемых на основе политик Azure AD B2C.

**Разрабатывайте и тестируйте технические профили с известными путями взаимодействия пользователя.** Используйте проверенные политики начального пакета, чтобы настроить технические профили. Прежде чем встраивать их в собственные пути взаимодействия пользователя, проверьте их по отдельности.

**Разрабатывайте и тестируйте пути взаимодействия пользователя с проверенными техническими профилями.** Поэтапно измените шаги оркестрации пути взаимодействия пользователя. Прогрессивно создавайте целевые сценарии.

## <a name="next-steps"></a>Следующие шаги

Доступно на сайте GitHub, скачайте архив [Active-Directory-B2C-Custom-Policy-starterpack](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/archive/master.zip) . zip. Кроме того, можно клонировать репозиторий:

```
git clone https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack
```
