---
title: Вход в веб-приложения с помощью OpenID Connect в Azure Active Directory B2C | Документация Майкрософт
description: Создание веб-приложений с помощью протокола аутентификации OpenID Connect в Azure Active Directory B2C.
services: active-directory-b2c
author: davidmu1
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 04/16/2019
ms.author: davidmu
ms.subservice: B2C
ms.openlocfilehash: 4137360fadab0206c6569b58d6a9a0519ce74450
ms.sourcegitcommit: 44a85a2ed288f484cc3cdf71d9b51bc0be64cc33
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64703947"
---
# <a name="web-sign-in-with-openid-connect-in-azure-active-directory-b2c"></a>Вход в веб-приложения с помощью OpenID Connect в Azure Active Directory B2C

OpenID Connect — это протокол проверки подлинности на основе OAuth 2.0, который может использоваться для безопасного входа пользователей в веб-приложения. Используя реализацию OpenID Connect в Azure Active Directory B2C (Azure AD B2C), можно передать Azure Active Directory (Azure AD) регистрацию, вход в систему и другие действия по управлению пользователями в веб-приложениях. В этом руководстве показано, как это сделать (независимо от языка программирования). и описывает, как отправлять и получать сообщения HTTP, не используя ни одну из наших библиотек с открытым исходным кодом.

[OpenID Connect](https://openid.net/specs/openid-connect-core-1_0.html) расширяет возможности протокола *авторизации* OAuth 2.0 и позволяет использовать его в качестве протокола *проверки подлинности*, Этот протокол проверки подлинности позволяет вам выполнять единый вход. Он вводится понятие *маркера Идентификации*, который позволяет клиенту проверять подлинность пользователя и получить базовые данные профиля о пользователе.

Так как это расширение OAuth 2.0, он также позволяет приложениям безопасно получать *маркеры доступа*. обеспечивая возможность доступа к ресурсам, защищенным [сервером авторизации](active-directory-b2c-reference-protocols.md). Рекомендуется использовать OpenID Connect вы создаете веб-приложение размещаются на сервере и доступны через браузер. Если вы хотите добавить управление идентификацией мобильных или настольных приложений, использующих Azure AD B2C, следует использовать [OAuth 2.0](active-directory-b2c-reference-oauth-code.md) вместо OpenID Connect. Дополнительные сведения о маркерах см. в разделе [Обзор маркеров в Azure Active Directory B2C](active-directory-b2c-reference-tokens.md)

В Azure AD B2C стандартный протокол OpenID Connect выходит за рамки простой проверки подлинности и авторизации. В нем представлена [параметр потока пользователя](active-directory-b2c-reference-policies.md), что позволяет использовать OpenID Connect для добавления возможностей по работе с приложения, такие как регистрация, вход и управление профилями.

## <a name="send-authentication-requests"></a>Отправка запросов проверки подлинности

Если веб-приложения требуется проверить подлинность пользователя и запуска потока пользователя, оно может направить пользователю `/authorize` конечной точки. Пользователь выполняет действие в зависимости от потока пользователя.

В этом запросе клиент указывает разрешения, которые ему требуется получить от пользователя в `scope` параметр и поток пользователя для запуска в `p` параметра. В следующих разделах приведены три примера для разных потоков пользователей (переносы строк добавлены для удобства чтения). Чтобы понять, как работает каждый запрос, попробуйте вставить его в браузер и запустить. Вы можете заменить `fabrikamb2c` с именем вашего клиента, если у вас один и создания потока пользователя.

#### <a name="use-a-sign-in-user-flow"></a>Использование потока пользователя для входа
```
GET https://fabrikamb2c.b2clogin.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code+id_token
&redirect_uri=https%3A%2F%2Faadb2cplayground.azurewebsites.net%2F
&response_mode=form_post
&scope=openid%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&nonce=12345
&p=b2c_1_sign_in
```

#### <a name="use-a-sign-up-user-flow"></a>Использование потока пользователя для регистрации
```
GET https://fabrikamb2c.b2clogin.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code+id_token
&redirect_uri=https%3A%2F%2Faadb2cplayground.azurewebsites.net%2F
&response_mode=form_post
&scope=openid%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&nonce=12345
&p=b2c_1_sign_up
```

#### <a name="use-an-edit-profile-user-flow"></a>Использование потока пользователя для изменения профиля
```
GET https://fabrikamb2c.b2clogin.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code+id_token
&redirect_uri=https%3A%2F%2Faadb2cplayground.azurewebsites.net%2F
&response_mode=form_post
&scope=openid%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&nonce=12345
&p=b2c_1_edit_profile
```

| Параметр | Обязательно для заполнения | ОПИСАНИЕ |
| --------- | -------- | ----------- |
| client_id | Yes | Идентификатор приложения, [портала Azure](https://portal.azure.com/) назначенный приложению. |
| response_type | Yes | Должен включать маркер Идентификации для OpenID Connect. Если веб-приложения также потребуются токены для вызова веб-API, можно использовать `code+id_token`. |
| redirect_uri | Нет  | `redirect_uri` Параметр приложения, где запросы проверки подлинности можно отправленных и полученных приложения. Он должен точно соответствовать одному из `redirect_uri` параметры, которые зарегистрированы на портале Azure, за исключением того, что он должен быть в кодировке URL-адрес. |
| scope | Yes | Список областей с разделителями-пробелами. Область `openid` определяет разрешение на вход пользователя и получение данных о пользователе в форме маркеров идентификации. `offline_access` Область является необязательным для веб-приложений. Указывает, что приложение должно *маркер обновления* для расширенного доступа к ресурсам. |
| response_mode | Нет  | Метод, который используется для отправки полученного кода авторизации приложению. Это может быть `query`, `form_post` или `fragment`.  Для максимальной безопасности рекомендуется использовать режим ответа `form_post`. |
| state | Нет  | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Состояние также используется для кодирования сведений о состоянии пользователя в приложении, перед созданием запроса на аутентификацию, например страницы, открытой в тот момент. |
| nonce | Yes | Значение, включенное в запрос (созданный с помощью приложения), включенный в полученного маркера Идентификации в качестве утверждения. Приложение затем может проверить это значение во избежание атак с повторением токенов. Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. |
| p | Yes | Поток пользователя, который выполняется. Это имя пользователя последовательность, которая создается в клиенте Azure AD B2C. Имя потока пользователя должно начинаться с `b2c\_1\_`. |
| prompt | Нет  | Требуемый тип взаимодействия с пользователем. Сейчас единственное допустимое значение — `login`, при котором пользователю приходится вводить учетные данные по запросу. |

На этом этапе пользователю предлагается выполнить рабочий процесс. Пользователь может потребоваться введите свои имя пользователя и пароль, войдите в систему удостоверений в социальных сетях или входа для каталога. Может существовать любое другое число шагов в зависимости от того, как определяется поток пользователя.

Как только пользователь завершит поток пользователя, ответ возвращается в приложение на указанный `redirect_uri` параметр, с помощью метода, который указан в `response_mode` параметра. Ответ — то же самое для каждого из перечисленных выше случаях независимо от потока пользователя.

Успешный ответ с использованием метода `response_mode=fragment` выглядит следующим образом:

```
GET https://aadb2cplayground.azurewebsites.net/#
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...
&state=arbitrary_data_you_can_receive_in_the_response
```

| Параметр | ОПИСАНИЕ |
| --------- | ----------- |
| id_token | Запрашиваемый приложением маркера Идентификации. Вы можете использовать маркер идентификации для проверки личности пользователя и запуска сеанса пользователя. |
| Код | Код авторизации, запрашиваемый приложением, если вы использовали `response_type=code+id_token`. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Коды авторизации обычно действительны в течение около 10 минут. |
| state | Если запрос содержит параметр `state`, то в ответе должно отображаться то же значение. Приложение необходимо убедиться, что `state` значения в запросе и ответе идентичны. |

Сообщения об ошибках может быть отправлена `redirect_uri` параметр, чтобы приложение обрабатывало их должным образом:

```
GET https://aadb2cplayground.azurewebsites.net/#
error=access_denied
&error_description=the+user+canceled+the+authentication
&state=arbitrary_data_you_can_receive_in_the_response
```

| Параметр | ОПИСАНИЕ |
| --------- | ----------- |
| error | Код, который может использоваться для классификации типов возникающих ошибок. |
| error_description | Сообщение об ошибке, которые могут помочь определить причину возникновения ошибки проверки подлинности. |
| state | Если запрос содержит параметр `state`, то в ответе должно отображаться то же значение. Приложение необходимо убедиться, что `state` значения в запросе и ответе идентичны. |

## <a name="validate-the-id-token"></a>Проверка маркера идентификации

Получение маркера идентификации не является достаточным для прохождения пользователем проверки подлинности. Проверить подпись маркера Идентификации и сопоставить утверждения в маркере с требованиями вашего приложения. В Azure AD B2C для подписи маркеров и проверки их правильности используются [веб-маркеры JSON Web Token (JWT)](https://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) и шифрование с открытым ключом. Для проверки JWT доступны многие библиотеки с открытым исходным кодом в зависимости от выбранного языка программирования. Мы рекомендуем изучить различные библиотеки, а не реализовывать логику проверки самостоятельно. 

Azure AD B2C имеет конечную метаданных OpenID Connect, которая позволяет приложению для получения сведений об Azure AD B2C во время выполнения. Эти сведения включают конечные точки, содержимое маркеров и ключи подписи маркеров. Для каждого потока пользователя в клиенте B2C есть собственный документ метаданных JSON. Например, документ метаданных для потока пользователя `b2c_1_sign_in` в `fabrikamb2c.onmicrosoft.com` находится в каталоге:

`https://fabrikamb2c.b2clogin.com/fabrikamb2c.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=b2c_1_sign_in`

Одно из свойств этого документа конфигурации — `jwks_uri`, значение которого для точно такого же потока пользователя будет следующим:

`https://fabrikamb2c.b2clogin.com/fabrikamb2c.onmicrosoft.com/discovery/v2.0/keys?p=b2c_1_sign_in`.

Чтобы определить, какой поток пользователя был использован идентификатор подписи маркера (и с которого следует получить метаданные), можно двумя способами. Во-первых, имя потока пользователя включено в утверждение `acr` маркера идентификации. Другой вариант — закодировать поток пользователя в значении параметра `state` при отправке запроса, а затем декодировать его, чтобы определить используемый поток. Каждый из этих методов является допустимым.

После получения документа метаданных из конечной точки метаданных OpenID Connect, можно использовать открытые ключи RSA 256 для проверки подписи маркера Идентификации. Может находиться множество ключей в этой конечной точке, каждый из которых идентифицируется по `kid` утверждения. Заголовок маркера идентификации также содержит утверждение `kid`, указывающее на ключ, который был использован для подписывания маркера идентификации.

После проверки подписи маркера идентификации вам потребуется проверить несколько утверждений. например

- Проверьте утверждение `nonce` во избежание атак с использованием воспроизведения маркеров. Его значение должно совпадать с указанным вами в запросе на вход.
- Проверка `aud` утверждения, чтобы убедиться, что для вашего приложения был выдан маркер Идентификации. Его значение должно быть идентификатор приложения вашего приложения.
- Проверка `iat` и `exp` утверждений, чтобы убедиться в том, что маркер Идентификации еще не истек.

Также существуют некоторые дополнительные проверки, которые необходимо выполнить. Подробно описаны проверок [спецификации OpenID Connect Core](https://openid.net/specs/openid-connect-core-1_0.html). Вам также может потребоваться проверить дополнительные утверждения в зависимости от сценария. Ниже приведены некоторые из стандартных проверок:

- Обеспечение пользователя или организации регистрации для приложения.
- Предоставление пользователю необходимого уровня авторизации и привилегий.
- Обеспечение определенного уровня проверки подлинности, например с помощью службы Многофакторной идентификации Azure.

После проверки маркера Идентификации можно запустить сеанс с пользователем. Утверждения в маркере Идентификации можно использовать для получения сведений о пользователе в вашем приложении. Эти сведения используются для отображения, получения записей и проверки подлинности.

## <a name="get-a-token"></a>Получение маркера

Если вам требуется только запускать потоки пользователя веб-приложения, можно пропустить следующие несколько разделов. Эти разделы применяются только к веб-приложений, которым необходимо выполнять проверку подлинности вызовы веб-API и также защищены с помощью Azure AD B2C.

Чтобы воспользоваться кодом авторизации маркера для необходимого ресурса (полученным с помощью `response_type=code+id_token`), отправьте запрос `POST` на конечную точку `/token`. В настоящее время единственным ресурсом, который можно запросить маркер для является серверной части приложения собственных веб-API. Чтобы использовать идентификатор клиента приложения в качестве области является соглашению при запросе маркера для себя:

```
POST fabrikamb2c.onmicrosoft.com/oauth2/v2.0/token?p=b2c_1_sign_in HTTP/1.1
Host: https://fabrikamb2c.b2clogin.com
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&redirect_uri=urn:ietf:wg:oauth:2.0:oob&client_secret=<your-application-secret>
```

| Параметр | Обязательно для заполнения | ОПИСАНИЕ |
| --------- | -------- | ----------- |
| p | Yes | Поток пользователя, который использовался для получения кода авторизации. Поток другого пользователя нельзя использовать в этом запросе. Этот параметр добавляется к строке запроса, а не к тело запроса POST. |
| client_id | Yes | Идентификатор приложения, [портала Azure](https://portal.azure.com/) назначенный приложению. |
| grant_type | Yes | Тип предоставления. Для потока кода авторизации это должен быть тип `authorization_code`. |
| scope | Нет  | Список областей с разделителями-пробелами. Область `openid` определяет разрешение на вход пользователя и получение данных о пользователе в форме маркеров идентификации. Его можно использовать для получения маркеров для приложения серверной части веб-API, который представляется тем же Идентификатором приложения, что и клиент. `offline_access` Области означает, что приложению потребуется маркер обновления для расширенного доступа к ресурсам. |
| Код | Yes | Код авторизации, полученный в начале потока пользователя. |
| redirect_uri | Yes | Параметр `redirect_uri` приложения, в котором вы получили код авторизации. |
| client_secret | Yes | Секрет приложения, который был создан в [портала Azure](https://portal.azure.com/). Это важный артефакт безопасности, и он должен безопасно храниться на сервере. Измените этот секрет клиента на периодической основе. |

Успешный ответ маркера выглядит следующим образом:

```
{
    "not_before": "1442340812",
    "token_type": "Bearer",
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "scope": "90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access",
    "expires_in": "3600",
    "refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
}
```
| Параметр | ОПИСАНИЕ |
| --------- | ----------- |
| not_before | Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token_type | Значение типа маркера. `Bearer` является единственным типом, который поддерживается. |
| access_token | Подписанный маркер JWT, который вы запрашивали. |
| scope | Области, для которых действителен маркер. |
| expires_in | Срок действия маркера доступа (в секундах). |
| refresh_token | Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров после истечения срока действия текущего маркера. Обновление маркеров можно использовать для сохранения доступа к ресурсам в течение продолжительного времени. Область `offline_access` должен использоваться в авторизации и в запросе маркера для получения маркера обновления. |

Сообщения об ошибках выглядят следующим образом:

```
{
    "error": "access_denied",
    "error_description": "The user revoked access to the app.",
}
```

| Параметр | ОПИСАНИЕ |
| --------- | ----------- |
| error | Код, который может использоваться для классификации типов возникающих ошибок. |
| error_description | Сообщение, которое может помочь определить причину возникновения ошибки проверки подлинности. |

## <a name="use-the-token"></a>Использование маркера

После успешного получения маркера доступа маркер можно использовать в запросах к веб-API серверной части приложения путем включения маркера в заголовок `Authorization`:

```
GET /tasks
Host: https://mytaskwebapi.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

## <a name="refresh-the-token"></a>Обновление маркера

Срок действия маркеров Идентификации за короткий период времени. Обновление маркеров после истечения, чтобы продолжить, не сможет получить доступ к ресурсам. Вы можете обновить токен с отправить еще один `POST` запросить `/token` конечной точки. На этот раз укажите параметр `refresh_token` вместо параметра `code`:

```
POST fabrikamb2c.onmicrosoft.com/oauth2/v2.0/token?p=b2c_1_sign_in HTTP/1.1
Host: https://fabrikamb2c.b2clogin.com
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6&scope=openid offline_access&refresh_token=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&redirect_uri=urn:ietf:wg:oauth:2.0:oob&client_secret=<your-application-secret>
```

| Параметр | Обязательно для заполнения | ОПИСАНИЕ |
| --------- | -------- | ----------- |
| p | Yes | Поток пользователя, который использовался для получения исходного маркера обновления. Поток другого пользователя нельзя использовать в этом запросе. Этот параметр добавляется к строке запроса, а не к тело запроса POST. |
| client_id | Yes | Идентификатор приложения, [портала Azure](https://portal.azure.com/) назначенный приложению. |
| grant_type | Yes | Тип используемого предоставления прав, который должен быть маркер обновления для этой части потока кода авторизации. |
| scope | Нет  | Список областей с разделителями-пробелами. Область `openid` определяет разрешение на вход пользователя и получение данных о пользователе в форме маркеров идентификации. Его можно использовать для отправки маркеры приложения серверной части веб-API, который представляется тем же Идентификатором приложения, что и клиент. `offline_access` Области означает, что приложению потребуется маркер обновления для расширенного доступа к ресурсам. |
| redirect_uri | Нет  | Параметр `redirect_uri` приложения, в котором вы получили код авторизации. |
| refresh_token | Yes | Исходный маркер обновления, приобретенной во второй части потока. `offline_access` Области необходимо использовать в авторизации и в запросе маркера для получения маркера обновления. |
| client_secret | Yes | Секрет приложения, который был создан в [портала Azure](https://portal.azure.com/). Это важный артефакт безопасности, и он должен безопасно храниться на сервере. Измените этот секрет клиента на периодической основе. |

Успешный ответ маркера выглядит следующим образом:

```
{
    "not_before": "1442340812",
    "token_type": "Bearer",
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "scope": "90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access",
    "expires_in": "3600",
    "refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
}
```
| Параметр | ОПИСАНИЕ |
| --------- | ----------- |
| not_before | Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token_type | Значение типа маркера. `Bearer` является единственным типом, который поддерживается. |
| access_token | Подписанный маркер JWT, который был запрошен. |
| scope | Область, для которого маркер является допустимым. |
| expires_in | Срок действия маркера доступа (в секундах). |
| refresh_token | Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров после истечения срока действия текущего маркера. Обновление маркеров можно использовать для сохранения доступа к ресурсам в течение продолжительного времени. |

Сообщения об ошибках выглядят следующим образом:

```
{
    "error": "access_denied",
    "error_description": "The user revoked access to the app.",
}
```

| Параметр | ОПИСАНИЕ |
| --------- | ----------- |
| error | Код, который может использоваться для классификации типов возникающих ошибок. |
| error_description | Сообщение, которое может помочь определить причину возникновения ошибки проверки подлинности. |

## <a name="send-a-sign-out-request"></a>Отправка запроса на выход

Если вы хотите выхода пользователя из приложения, недостаточно просто очистите файлы cookie для приложения или в противном случае прекратить сеанс с пользователем. Перенаправляет пользователя в Azure AD B2C, чтобы выйти из системы. Если этого не сделать, пользователю можно пройти проверку подлинности в приложении без ввода учетных данных.

Можно просто перенаправить пользователя на `end_session` конечную точку, которая указана в документе метаданных OpenID Connect, описанные ранее:

```
GET https://fabrikamb2c.b2clogin.com/fabrikamb2c.onmicrosoft.com/oauth2/v2.0/logout?
p=b2c_1_sign_in
&post_logout_redirect_uri=https%3A%2F%2Faadb2cplayground.azurewebsites.net%2F
```

| Параметр | Обязательно для заполнения | ОПИСАНИЕ |
| --------- | -------- | ----------- |
| p | Yes | Поток пользователя, который вы хотите использовать для выхода пользователя из приложения. |
| post_logout_redirect_uri | Нет  | URL-адрес, который пользователя следует перенаправить после успешного выхода. Если он не будет включен, Azure AD B2C покажет пользователю универсальное сообщение. |

Перенаправлении пользователя `end_session` удаляет конечную точку, некоторые из одного состояние единого входа с Azure AD B2C пользователя, но он не выхода пользователя из сеанса поставщика удостоверений в социальных сетях. Если пользователь выберет тот же IDP во время последующего входа, они будут повторно аутентифицирован без ввода учетных данных. Если пользователь хочет выйти из приложения, его не обязательно означает, что они хотят выйти из учетной записи Facebook. Тем не менее если используются локальные учетные записи, правильно завершает сеанс пользователя.

