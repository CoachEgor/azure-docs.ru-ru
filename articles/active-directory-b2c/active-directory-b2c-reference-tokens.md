---
title: Общие сведения о маркеров — Azure Active Directory B2C | Документация Майкрософт
description: Дополнительные сведения о токенов, используемых в Azure Active Directory B2C.
services: active-directory-b2c
author: mmacy
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 04/16/2019
ms.author: marsma
ms.subservice: B2C
ms.openlocfilehash: b0a5eca4823bd6ec7d1197adb205f7fb98f8d67e
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "66509075"
---
# <a name="overview-of-tokens-in-azure-active-directory-b2c"></a>Общие сведения о маркеров в Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

Azure Active Directory B2C (Azure AD) B2C создает маркеры безопасности различных типов, при обработке каждого [поток проверки подлинности](active-directory-b2c-apps.md). В этом документе описывается формат, характеристики безопасности и содержимое каждого типа маркера.

## <a name="token-types"></a>Типы маркеров

Azure AD B2C поддерживает [протоколы OAuth 2.0 и OpenID Connect](active-directory-b2c-reference-protocols.md), который использует токены для проверки подлинности и безопасный доступ к ресурсам. Все токены, используемые в Azure AD B2C, [маркеры JSON web Token (JWT)](https://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) , содержащий утверждения со сведениями о своем предъявителе и субъект токена.

В связи с Azure AD B2C используются следующие токены:

- *Маркер Идентификации* -JWT, который содержит утверждения, можно использовать для идентификации пользователей в приложении. Этот маркер безопасно передается в HTTP-запросы для обмена данными между двумя компонентами одного приложения или службы. Утверждения, которые содержит маркер идентификации, вы можете использовать по своему усмотрению. Они часто используются для отображения сведений учетной записи или принятия решений по управлению доступом в приложении. Маркеры Идентификации подписываются, но не шифруются. Когда ваше приложение или API получает маркер Идентификации, его необходимо проверить подпись, чтобы подтвердить подлинность маркера. Ваше приложение или API также необходимо проверить несколько утверждений в маркере, чтобы подтвердить его действительность. В зависимости от требований сценария можно изменять утверждения, которые проверяет приложение, но приложения необходимо выполнить некоторые стандартные проверки утверждений в каждом сценарии.
- *Маркер доступа* -JWT, который содержит утверждения, можно использовать для идентификации предоставленных разрешений для API-интерфейсов. Маркеры доступа подписываются, но они не зашифрованы. Маркеры доступа используются для предоставления доступа к API и серверам ресурсов.  Когда API получает маркер доступа, оно должно проверить подпись, чтобы подтвердить подлинность маркера. API должен также проверить несколько утверждений в маркере, чтобы подтвердить его действительность. В зависимости от требований сценария можно изменять утверждения, которые проверяет приложение, но приложения необходимо выполнить некоторые стандартные проверки утверждений в каждом сценарии.
- *Токен обновления* -маркеры обновления используются для получения новых маркеров Идентификации и маркеров доступа в потоке OAuth 2.0. Они предоставляют приложения длительный доступ к ресурсам от лица пользователей без необходимости взаимодействия с пользователями. Маркеры обновления, непрозрачны для приложения. Они выдаются Azure AD B2C и можно проверять и интерпретировать только с помощью Azure AD B2C. Они действуют продолжительное время, но приложения не должны записываться в предположении, что маркер обновления будет действителен в течение определенного периода времени. Маркеры обновления могут стать недействительными в любое время по разным причинам. Чтобы попытаться использовать его путем отправки запроса маркера в Azure AD B2C является единственным способом для вашего приложения узнать, является ли допустимым токен обновления. При обмене маркера обновления на новый маркер, вы получите новый маркер обновления в ответе маркера. Сохраните новый маркер обновления. Он заменяет токен обновления, которая использовалась ранее в запросе. Это действие гарантирует, что маркеров обновления остаются действительными для как можно дольше. 

## <a name="endpoints"></a>Конечные точки

Объект [регистрации приложения](tutorial-register-applications.md) получает маркеры и взаимодействует с Azure AD B2C, отправляя запросы к этим конечным точкам:

- `https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/oauth2/v2.0/authorize`
- `https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/oauth2/v2.0/token`

Маркеры безопасности, которые приложение получает из Azure AD B2C могут поступать из `/authorize` или `/token` конечные точки. Когда маркеры Идентификации поступают из `/authorize` конечной точки, они выполняются с помощью [неявный поток](active-directory-b2c-reference-spa.md), которая часто используется для пользователей при входе в javascript веб-приложения. Когда маркеры идентификации поступают из конечной точки `/token`, это происходит с помощью [потока кода конфиденциальной информации](active-directory-b2c-reference-oidc.md), который предотвращает доступ браузера к маркеру.

## <a name="claims"></a>Claims

Используя Azure AD B2C, вы можете точно контролировать содержимое маркеров. Можно настроить [маршруты пользователей](active-directory-b2c-reference-policies.md) и [пользовательских политик](active-directory-b2c-overview-custom.md) для отправки определенных наборов пользовательских данных в утверждения, которые необходимы для вашего приложения. Эти утверждения могут включать стандартные свойства, например **displayName** и **emailAddress**. С помощью этих утверждений ваши приложения могут безопасно проверять подлинность пользователей и запросов. 

Утверждения в маркерах Идентификации не возвращаются в определенном порядке. Новые утверждения могут появиться в маркерах Идентификации в любое время. Приложение должно нарушать работу, добавляются новые утверждения. Можно также включить [пользовательские атрибуты](active-directory-b2c-reference-custom-attr.md) в утверждений.

Ниже перечислены утверждения, что можно ожидать, что в маркерах Идентификации и доступа к токенам в Azure AD B2C.

| ИМЯ | Утверждение | Пример значения | Описание |
| ---- | ----- | ------------- | ----------- |
| Аудитория | `aud` | `90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6` | Определяет целевого получателя маркера. Для Azure AD B2C аудитория — идентификатор приложения. Приложение должно проверить это значение и отклонить маркер, если он не соответствует. Аудитория ассоциируется с ресурсом. |
| Издатель | `iss` |`https://{tenant}.b2clogin.com/775527ff-9a37-4307-8b3d-cc311f58d925/v2.0/` | Обозначает службу токенов безопасности (STS), которая создает и возвращает токен. Она также определяет каталог, в котором пользователь прошел проверку. Приложение должно проверить утверждение издателя и убедитесь, что маркер пришел от соответствующей конечной точке. |
| Время выдачи | `iat` | `1438535543` | Время выдачи маркера в виде времени эпохи. |
| Время окончания срока действия | `exp` | `1438539443` | Время окончания срока действия маркера в виде времени эпохи. В приложении следует использовать это утверждение для проверки допустимости время существования маркера. |
| Не ранее | `nbf` | `1438535543` | Время начала срока действия маркера в виде времени эпохи. Это время обычно является таким же, как время выдачи токена. В приложении следует использовать это утверждение для проверки допустимости время существования маркера. |
| Version | `ver` | `1.0` | Версия маркера Идентификации, как определено с помощью Azure AD B2C. |
| Хэш-код | `c_hash` | `SGCPtt01wxwfgnYZy2VJtQ` | Хэш-код, включенных в маркер Идентификации, только если маркер выдается вместе с кодом авторизации OAuth 2.0. Хэш-код можно использовать для проверки подлинности кода авторизации. Дополнительные сведения о выполнении этой проверки см. в разделе [спецификации OpenID Connect](https://openid.net/specs/openid-connect-core-1_0.html).  |
| Хэш маркера доступа | `at_hash` | `SGCPtt01wxwfgnYZy2VJtQ` | Хэш маркера доступа включены в маркер Идентификации, только если маркер выдается вместе с маркером доступа OAuth 2.0. Его можно использовать для проверки подлинности маркера доступа. Дополнительные сведения о выполнении этой проверки см. в разделе [спецификации OpenID Connect](https://openid.net/specs/openid-connect-core-1_0.html)  |
| Специальное утверждение | `nonce` | `12345` | Nonce — это стратегия, которая используется для предотвращения атак повторного воспроизведения маркера. Приложения можно указать специальное утверждение в запросе авторизации с помощью `nonce` параметр запроса. Значения, указываемые в запросе создается без изменений в `nonce` утверждение с правом только маркер идентификатора. Это утверждение позволяет вашему приложению проверить значение со значением, указанным в запросе. Приложение должно выполнять эту проверку во время проверки маркера Идентификации. |
| Subject | `sub` | `884408e1-2918-4cz0-b12d-3aa027d7563b` | Субъект, в отношении которого маркер подтверждает сведения, например пользователь приложения. Это значение является неизменяемым и не может быть переназначено или повторно использовано. Это значение можно использовать для безопасных проверок авторизации, например, когда маркер используется для доступа к ресурсу. По умолчанию утверждение субъекта заполняется идентификатором объекта пользователя в каталоге. |
| Ссылка на класс контекста проверки подлинности | `acr` | Неприменимо | Используется только с старой политики. |
| Политика инфраструктуры доверия | `tfp` | `b2c_1_signupsignin1` | Имя политики, который был использован для получения маркера Идентификации. |
| Время проверки подлинности | `auth_time` | `1438535543` | Время, по которому пользователь последние введенные учетные данные, представленный в виде времени эпохи. |
| `Scope` | `scp` | `Read`| Разрешения, предоставленные ресурс для маркера доступа. Несколько предоставленных разрешений разделяются пробелом. |
| Авторизованная сторона | `azp` | `975251ed-e4f5-4efd-abcb-5f1a8f566ab7` | **Идентификатор приложения** клиентского приложения, инициировавшего запрос. |

## <a name="configuration"></a>Параметр Configuration

Следующие свойства используются для [управление временем существования маркеров безопасности](configure-tokens.md) выдаваемых Azure AD B2C:

- **Время существования маркера доступа и маркера идентификатора (в минутах)** . Время существования маркера носителя OAuth 2.0, используемого для получения доступа к защищенному ресурсу. Значение по умолчанию — 60 минут. Минимум (включительно) — 5 минут. Максимум (включительно) — 1440 минут.

- **Время существования токена обновления (в днях)** — максимальный период времени до наступления которого маркер обновления может использоваться для получения нового доступа или маркера идентификатора. Период времени также рассматривается получение новый маркер обновления, если приложение было предоставлено `offline_access` области. По умолчанию — 14 дней. Минимум (включительно) — один день. Максимум (включительно) — 90 дней.

- **Обновить скользящее время существования маркера (в днях)** — после этого периода промежутка времени, пользователь вынужден повторную проверку подлинности, независимо от срока действия последнего токена обновления, полученного приложением. Он предоставляется, только если установлен переключатель **Ограничено**. Значение должно быть больше или равно значению **времени существования маркера обновления (в днях)** . Если установлен переключатель **Не ограничено**, указать конкретное значение нельзя. По умолчанию — 90 дней. Минимум (включительно) — один день. Максимум (включительно) — 365 дней.

Если использовать свойства, которые приведены ниже, будут включены следующие варианты использования.

- Предоставление пользователю возможности находиться в мобильном приложении сколь угодно долго до тех пор, пока он активно его использует. Можно установить переключатель **Скользящее время существования маркера обновления (в днях)** в положение **Не ограничено** в свойствах потока пользователя для входа.
- Обеспечение соответствия нормам и требованиям безопасности путем задания соответствующих значений времени существования маркера доступа.

Эти параметры недоступны в потоке пользователя для сброса пароля. 

## <a name="compatibility"></a>Совместимость

Следующие свойства используются для [управление совместимости токенов](configure-tokens.md):

- **Утверждение издателя (iss)** . Это свойство определяет клиента Azure AD B2C, выдавшего маркер. По умолчанию используется значение `https://<domain>/{B2C tenant GUID}/v2.0/`. Значение `https://<domain>/tfp/{B2C tenant GUID}/{Policy ID}/v2.0/` включает идентификаторы для клиента Azure AD B2C и поток пользователя, который был использован в запросе токена. Если ваше приложение или библиотека требуется Azure AD B2C для соответствия [спецификации OpenID Connect Discovery 1.0](https://openid.net/specs/openid-connect-discovery-1_0.html), используйте это значение.

- **Утверждение субъекта (sub)** . Это свойство определяет сущность, для которой маркер подтверждает информацию. Значение по умолчанию — **ObjectID**, который заполняет `sub` утверждения в маркере с ИД объекта пользователя. Значение **не поддерживается** предоставляется только для обеспечения обратной совместимости. Рекомендуется перейти на **ObjectID** вы сможете сразу же.

- **Утверждение, представляющее идентификатор политики** -это свойство определяет тип утверждения, в котором заполняется имя политики, используемый в запросе токена. По умолчанию используется значение `tfp`. Значение `acr` предоставляется только для обеспечения обратной совместимости.

## <a name="pass-through"></a>Сквозной режим

В начале пути взаимодействия пользователя Azure AD B2C получает маркер доступа от поставщика удостоверений. Azure AD B2C использует этот маркер для извлечения сведений о пользователе. Вы [Включение утверждений в потоке пользователя](idp-pass-through-user-flow.md) или [определение утверждения в настраиваемой политике](idp-pass-through-custom.md) для передачи маркера через приложения, которые вы регистрируете в Azure AD B2C. Приложения должны использовать [поток пользователя v2](user-flow-versions.md) преимуществами передав токен в качестве утверждения.

Azure AD B2C в настоящее время поддерживает только передав маркер доступа поставщиков удостоверений OAuth 2.0, включая Facebook и Google. Для остальных поставщиков удостоверений утверждение возвращается пустым. 

## <a name="validation"></a>Проверка

Для проверки маркера приложение должно проверить подпись и утверждения маркера. Многие библиотеки с открытым кодом доступны для проверки маркеров JWT, в зависимости от выбранного языка. Рекомендуется, что можно изучить различные, а не реализовывать логику проверки самостоятельно.

### <a name="validate-signature"></a>Проверить подпись

Маркер JWT содержит три сегмента, *заголовок*, *текст*и *подпись*. Сегмент подписи можно использовать для проверки подлинности маркера, чтобы доверяет приложение. Маркеры Azure AD B2C подписываются при помощи стандартных отраслевых алгоритмов асимметричного шифрования, таких как RSA 256. 

Заголовок маркера содержит сведения о ключе и методе шифрования, используемых для подписания маркера:

```
{
        "typ": "JWT",
        "alg": "RS256",
        "kid": "GvnPApfWMdLRi8PDmisFn7bprKg"
}
```

Значение **alg** утверждения — это алгоритм, который использовался для подписи маркера. Значение **kid** утверждения — это открытый ключ, который использовался для подписи маркера. В любой момент времени Azure AD B2C можно подписать маркер с помощью любого из набора пар открытого и закрытого ключей. Azure AD B2C периодически изменяет возможный набор ключей. Приложения должны быть написаны автоматическую обработку подобных изменений ключей. Разумный частоту, чтобы проверить наличие обновлений открытых ключей, используемые Azure AD B2C выполняется каждые 24 часа.

Служба Azure AD B2C имеет конечную точку метаданных OpenID Connect. С помощью этой конечной точки, приложения могут запросить сведения об Azure AD B2C во время выполнения. Эти сведения включают конечные точки, содержимое маркеров и ключи подписи маркеров. Клиент Azure AD B2C содержит документ метаданных JSON для каждой политики. Документ метаданных является объектом JSON, содержащим важные сведения. Метаданные содержат **jwks_uri**, который указывает расположение набора открытых ключей, использованных для подписания маркеров. Что расположение представлено ниже, но лучше получить его динамически с помощью документа метаданных и анализа **jwks_uri**:

```
https://contoso.b2clogin.com/contoso.onmicrosoft.com/discovery/v2.0/keys?p=b2c_1_signupsignin1
```
Документ JSON, расположенный по этому URL-адресу, содержит все сведения об открытых ключах, используемые в конкретный момент времени. Приложение может использовать утверждение `kid` в заголовке маркера JWT, чтобы выбрать открытый ключ в этом документе JSON, использованный для подписания определенного маркера. Затем оно может проверить подпись с использованием правильного открытого ключа и указанного алгоритма.

Документ метаданных для `B2C_1_signupsignin1` политики в `contoso.onmicrosoft.com` клиента находится в каталоге:

```
https://contoso.b2clogin.com/contoso.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=b2c_1_signupsignin1
```

Чтобы определить, какая политика была использована для подписи маркера (и куда обратиться, чтобы запросить метаданные), можно двумя способами. Сначала имя политики включается в утверждение `acr` маркера. Утверждения из тела маркера JWT можно проанализировать, декодировав тело маркера с помощью кодировки base-64 и десериализации полученной строки JSON. `acr` Утверждения — это имя политики, который был использован для получения маркера. Другой вариант — закодировать политику в значении параметра `state` параметр при отправке запроса, а затем декодировать ее, чтобы определить, какая политика была использована. Каждый из этих методов является допустимым.

Описание выполнения проверки выходит за рамки этого документа. Чтобы проверить токен доступны многие библиотеки с открытым исходным кодом.

### <a name="validate-claims"></a>Проверка утверждений

Когда приложения или API получает маркер Идентификации, ему также требуется выполнить несколько проверок утверждений в маркере идентификатора. Следует проверить следующие утверждения:

- **аудитория** -проверяет, что маркера Идентификации действительно должен был быть выдан приложение.
- **не ранее** и **время истечения срока действия** -проверяет, что маркер Идентификации еще не истек.
- **издатель** -проверяет, что маркер был выдан приложению Azure AD B2C.
- **специальное слово** -стратегию для предотвращения атак с использованием воспроизведения маркеров.

Полный список проверок, которые должно выполнять приложение, см. в разделе [спецификации OpenID Connect](https://openid.net).  

## <a name="next-steps"></a>Дальнейшие действия

Узнайте больше о том, как [использовать маркеры доступа](active-directory-b2c-access-tokens.md).

