---
title: Общие сведения о токенах — Azure Active Directory B2C
description: Сведения о токенах, используемых в Azure Active Directory B2C.
services: active-directory-b2c
author: mmacy
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 08/23/2019
ms.author: marsma
ms.subservice: B2C
ms.openlocfilehash: c347a5740a13d071d4bb06daf43463f974198e5d
ms.sourcegitcommit: 6d2a147a7e729f05d65ea4735b880c005f62530f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/22/2019
ms.locfileid: "69980799"
---
# <a name="overview-of-tokens-in-azure-active-directory-b2c"></a>Общие сведения о токенах в Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

Azure Active Directory B2C (Azure AD) B2C выдает несколько типов маркеров безопасности при обработке каждого [потока проверки](active-directory-b2c-apps.md)подлинности. В этом документе описывается формат, характеристики безопасности и содержимое каждого типа маркера.

## <a name="token-types"></a>Типы маркеров

Azure AD B2C поддерживает [протоколы OAuth 2,0 и OpenID Connect Connect](active-directory-b2c-reference-protocols.md), которые используют маркеры для проверки подлинности и безопасного доступа к ресурсам. Все токены, используемые в Azure AD B2C, — это [веб-маркеры JSON (JWT)](https://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) , которые содержат утверждения сведений о носителе и теме маркера.

При обмене данными с Azure AD B2C используются следующие токены:

- *Маркер идентификации* — JWT, содержащий утверждения, которые можно использовать для идентификации пользователей в приложении. Этот маркер безопасно отправляется в HTTP-запросах для обмена данными между двумя компонентами одного приложения или службы. Утверждения, которые содержит маркер идентификации, вы можете использовать по своему усмотрению. Они обычно используются для вывода сведений об учетной записи или для принятия решений по управлению доступом в приложении. Маркеры идентификации подписываются, но не шифруются. Когда приложение или API получает маркер идентификации, он должен проверить подпись, чтобы подтвердить подлинность маркера. Приложение или API также должны проверить несколько утверждений в токене, чтобы подтвердить его допустимость. В зависимости от требований к сценарию утверждения, проверенные приложением, могут быть разными, но приложение должно выполнить некоторые распространенные проверки утверждения в каждом сценарии.
- *Маркер доступа* — JWT, содержащий утверждения, которые можно использовать для распознавания предоставленных разрешений интерфейсам API. Маркеры доступа подписываются, но не шифруются. Маркеры доступа используются для предоставления доступа к API-интерфейсам и серверам ресурсов.  Когда API получает маркер доступа, он должен проверить подпись, чтобы подтвердить подлинность маркера. API должен также проверить несколько утверждений в маркере, чтобы подтвердить его действительность. В зависимости от требований к сценарию утверждения, проверенные приложением, могут быть разными, но приложение должно выполнить некоторые распространенные проверки утверждения в каждом сценарии.
- *Токен обновления* — токены обновления используются для получения новых токенов идентификации и маркеров доступа в потоке OAuth 2,0. Они предоставляют приложению долгосрочный доступ к ресурсам от имени пользователей без необходимости взаимодействия с этими пользователями. Маркеры обновления непрозрачны для приложения. Они выдаются Azure AD B2C и могут быть проверены и интерпретированы только Azure AD B2C. Они имеют долгосрочный характер, но приложение не должно быть написано с ожиданием, что маркер обновления будет последним в течение определенного периода времени. Маркеры обновления могут стать недействительными в любое время по разным причинам. Единственный способ, которым приложение может понять, является ли маркер обновления допустимым, — попытаться активировать его, выполнив запрос маркера для Azure AD B2C. При активации маркера обновления для нового маркера в ответе маркера появляется новый маркер обновления. Сохраните новый маркер обновления. Он заменяет маркер обновления, который использовался ранее в запросе. Это действие помогает гарантировать, что маркеры обновления остаются действительными в течение максимально допустимого срока.

## <a name="endpoints"></a>Конечные точки

[Зарегистрированное приложение](tutorial-register-applications.md) получает маркеры и взаимодействует с Azure AD B2C, отправляя запросы к этим конечным точкам:

- `https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/oauth2/v2.0/authorize`
- `https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/oauth2/v2.0/token`

Маркеры безопасности, получаемые приложением от Azure AD B2C могут поступать из `/authorize` конечных точек или `/token` . При получении маркеров идентификации от `/authorize` конечной точки они выполняются с помощью неявного [потока](active-directory-b2c-reference-spa.md), который часто используется для входа пользователей в веб-приложения на основе JavaScript. Когда маркеры идентификации поступают из конечной точки `/token`, это происходит с помощью [потока кода конфиденциальной информации](active-directory-b2c-reference-oidc.md), который предотвращает доступ браузера к маркеру.

## <a name="claims"></a>Претензии

Используя Azure AD B2C, вы можете точно контролировать содержимое маркеров. Можно настроить [потоки пользователей](active-directory-b2c-reference-policies.md) и [пользовательские политики](active-directory-b2c-overview-custom.md) для отправки определенных наборов пользовательских данных в утверждениях, необходимых для приложения. Эти утверждения могут включать стандартные свойства, такие как **DisplayName** и **EmailAddress**. С помощью этих утверждений ваши приложения могут безопасно проверять подлинность пользователей и запросов.

Утверждения в маркерах идентификации не возвращаются в каком бы то ни было определенном порядке. Новые утверждения могут быть введены в токены идентификации в любое время. Приложение не должно прерываться, так как появились новые утверждения. В утверждения также можно включить [настраиваемые атрибуты пользователя](active-directory-b2c-reference-custom-attr.md) .

В следующей таблице перечислены утверждения, которые можно использовать в маркерах идентификации и маркерах доступа, выдаваемых Azure AD B2C.

| Название | Утверждение | Пример значения | Описание |
| ---- | ----- | ------------- | ----------- |
| Аудитория | `aud` | `90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6` | Определяет целевого получателя маркера. Для Azure AD B2C аудиторией является идентификатор приложения. Приложение должно проверить это значение и отклонить маркер, если оно не соответствует. Аудитория ассоциируется с ресурсом. |
| Издатель | `iss` |`https://{tenant}.b2clogin.com/775527ff-9a37-4307-8b3d-cc311f58d925/v2.0/` | Обозначает службу токенов безопасности (STS), которая создает и возвращает токен. Он также определяет каталог, в котором пользователь прошел проверку подлинности. Приложение должно проверить утверждение издателя, чтобы убедиться, что маркер поступил из соответствующей конечной точки. |
| Время выдачи | `iat` | `1438535543` | Время выдачи маркера в виде времени эпохи. |
| Срок действия | `exp` | `1438539443` | Время окончания срока действия маркера в виде времени эпохи. Приложение должно использовать это утверждение для проверки допустимости срока действия маркера. |
| Не ранее | `nbf` | `1438535543` | Время начала срока действия маркера в виде времени эпохи. Это время обычно совпадает с временем выдачи маркера. Приложение должно использовать это утверждение для проверки допустимости срока действия маркера. |
| Version | `ver` | `1.0` | Версия маркера идентификации, определенная Azure AD B2C. |
| Хэш-код | `c_hash` | `SGCPtt01wxwfgnYZy2VJtQ` | Хэш кода, включенный в маркер идентификации, только если маркер выдается вместе с кодом авторизации OAuth 2,0. Хэш-код можно использовать для проверки подлинности кода авторизации. Дополнительные сведения о том, как выполнить эту проверку, см. в [спецификации OpenID Connect Connect](https://openid.net/specs/openid-connect-core-1_0.html).  |
| Хэш маркера доступа | `at_hash` | `SGCPtt01wxwfgnYZy2VJtQ` | Хэш маркера доступа, включенный в маркер идентификации, только если маркер выдается вместе с маркером доступа OAuth 2,0. Его можно использовать для проверки подлинности маркера доступа. Дополнительные сведения о том, как выполнить эту проверку, см. в [спецификации OpenID Connect Connect](https://openid.net/specs/openid-connect-core-1_0.html) .  |
| Специальное утверждение | `nonce` | `12345` | Nonce — это стратегия, которая используется для предотвращения атак повторного воспроизведения маркера. Приложение может указать nonce в запросе авторизации с помощью `nonce` параметра запроса. Значение, которое вы задаете в запросе, создается неизмененным `nonce` в утверждении только маркера идентификации. Это утверждение позволяет приложению проверить значение в соответствии со значением, указанным в запросе. Приложение должно выполнить эту проверку во время процесса проверки маркера идентификации. |
| Subject | `sub` | `884408e1-2918-4cz0-b12d-3aa027d7563b` | Участник, для которого маркер утверждает информацию, например пользователя приложения. Это значение является неизменяемым и не может быть переназначено или повторно использовано. Это значение можно использовать для безопасных проверок авторизации, например, когда маркер используется для доступа к ресурсу. По умолчанию утверждение субъекта заполняется идентификатором объекта пользователя в каталоге. |
| Ссылка на класс контекста проверки подлинности | `acr` | Неприменимо | Используется только со старыми политиками. |
| Политика инфраструктуры доверия | `tfp` | `b2c_1_signupsignin1` | Имя политики, которая использовалась для получения маркера идентификации. |
| Время проверки подлинности | `auth_time` | `1438535543` | Время последнего ввода учетных данных пользователем, представленное в поле время эпохи. Между этой проверкой подлинности нет никаких сравнений, пока выполняется новый вход, сеанс единого входа (SSO) или другой тип входа. `auth_time` — Это последнее время, когда приложение (или пользователь) инициировало проверку подлинности при Azure AD B2C. Метод, используемый для проверки подлинности, не различается. |
| `Scope` | `scp` | `Read`| Разрешения, предоставленные ресурсу для маркера доступа. Несколько предоставленных разрешений разделяются пробелом. |
| Авторизованная сторона | `azp` | `975251ed-e4f5-4efd-abcb-5f1a8f566ab7` | **Идентификатор приложения** клиентского приложения, инициировавшего запрос. |

## <a name="configuration"></a>Конфигурация

Следующие свойства используются для [управления временем существования маркеров безопасности](configure-tokens.md) , созданных Azure AD B2C:

- **Время существования маркера доступа и маркера идентификатора (в минутах)** . Время существования маркера носителя OAuth 2.0, используемого для получения доступа к защищенному ресурсу. Значение по умолчанию — 60 минут. Минимальное значение (включительно) — 5 минут. Максимальное значение (включительно) — 1440 минут.

- **Время существования маркера обновления (в днях)** — максимальный период времени, до которого маркер обновления может быть использован для получения нового маркера доступа или идентификатора. Кроме того, период времени покрывает получение нового маркера обновления, `offline_access` если приложению предоставлена область. По умолчанию — 14 дней. Минимальное значение (включительно) — один день. Максимальное значение (включительно) — 90 дней.

- **Время существования скользящего окна маркера обновления (в днях)** . по истечении этого периода времени пользователь вынужден выполнить повторную проверку подлинности независимо от срока действия последнего маркера обновления, полученного приложением. Он предоставляется, только если установлен переключатель **Ограничено**. Значение должно быть больше или равно значению **времени существования маркера обновления (в днях)** . Если установлен переключатель **Не ограничено**, указать конкретное значение нельзя. Значение по умолчанию — 90 дней. Минимальное значение (включительно) — один день. Максимальное значение (включительно) — 365 дней.

Если использовать свойства, которые приведены ниже, будут включены следующие варианты использования.

- Предоставление пользователю возможности находиться в мобильном приложении сколь угодно долго до тех пор, пока он активно его использует. Можно установить переключатель **Скользящее время существования маркера обновления (в днях)** в положение **Не ограничено** в свойствах потока пользователя для входа.
- Обеспечение соответствия нормам и требованиям безопасности путем задания соответствующих значений времени существования маркера доступа.

Эти параметры недоступны в потоке пользователя для сброса пароля.

## <a name="compatibility"></a>Совместимость

Для [управления совместимостью маркеров](configure-tokens.md)используются следующие свойства.

- **Утверждение издателя (iss)** . Это свойство определяет клиента Azure AD B2C, выдавшего маркер. Значение по умолчанию — `https://<domain>/{B2C tenant GUID}/v2.0/`. Значение `https://<domain>/tfp/{B2C tenant GUID}/{Policy ID}/v2.0/` включает идентификаторы как для клиента Azure AD B2C, так и для пользовательского потока, который использовался в запросе маркера. Если приложению или библиотеке требуется Azure AD B2C для соответствия [спецификации OpenID Connect Connect Discovery 1,0](https://openid.net/specs/openid-connect-discovery-1_0.html), используйте это значение.

- **Утверждение субъекта (sub)** . Это свойство определяет сущность, для которой маркер подтверждает информацию. Значение по умолчанию — **ObjectID**, которое заполняет `sub` утверждение в токене идентификатором объекта пользователя. Значение **not supported** предоставляется только для обеспечения обратной совместимости. Рекомендуется переключиться на **ObjectID** , как только вы сможете.

- **Заявка, представляющая идентификатор политики** . это свойство определяет тип утверждения, в который заполняются имена политик, используемые в запросе маркера. Значение по умолчанию — `tfp`. Значение `acr` предоставляется только для обеспечения обратной совместимости.

## <a name="pass-through"></a>Сквозной режим

Когда пользователь начинает путешествие, Azure AD B2C получает маркер доступа от поставщика удостоверений. Azure AD B2C использует этот маркер для извлечения сведений о пользователе. Вы [включаете утверждение в](idp-pass-through-user-flow.md) пользовательском потоке или [определяете утверждение в пользовательской политике](idp-pass-through-custom.md) для передачи маркера в приложения, регистрируемые в Azure AD B2C. Чтобы воспользоваться преимуществами передачи маркера в качестве утверждения, приложение должно использовать [поток пользователя V2](user-flow-versions.md) .

В настоящее время Azure AD B2C поддерживает только передачу маркера доступа для поставщиков удостоверений OAuth 2,0, включая Facebook и Google. Для остальных поставщиков удостоверений утверждение возвращается пустым.

## <a name="validation"></a>Проверка

Чтобы проверить маркер, приложение должно проверить подпись и утверждения маркера. Многие библиотеки с открытым исходным кодом доступны для проверки JWT в зависимости от предпочитаемого языка. Рекомендуется исследовать эти параметры, а не реализовывать собственную логику проверки.

### <a name="validate-signature"></a>Проверить подпись

JWT содержит три сегмента: *заголовок*, *тело*и *подпись*. Сегмент подписи можно использовать для проверки подлинности маркера, чтобы он мог быть доверенным для приложения. Маркеры Azure AD B2C подписываются при помощи стандартных отраслевых алгоритмов асимметричного шифрования, таких как RSA 256.

Заголовок маркера содержит сведения о ключе и методе шифрования, используемых для подписания маркера:

```
{
        "typ": "JWT",
        "alg": "RS256",
        "kid": "GvnPApfWMdLRi8PDmisFn7bprKg"
}
```

Значение утверждения алгоритма **ALG** — это алгоритм, который использовался для подписания маркера. Значение заявки для **детей** — это открытый ключ, который использовался для подписания маркера. В любой момент времени Azure AD B2C может подписать маркер с помощью любого набора пар открытого и закрытого ключей. Azure AD B2C периодически поворачивает возможный набор ключей. Приложение должно автоматически обрабатывать эти изменения ключа. Разумная частота проверки наличия обновлений для открытых ключей, используемых Azure AD B2C, составляет каждые 24 часа.

Служба Azure AD B2C имеет конечную точку метаданных OpenID Connect. С помощью этой конечной точки приложения могут запрашивать сведения о Azure AD B2C во время выполнения. Эти сведения включают конечные точки, содержимое маркеров и ключи подписи маркеров. Клиент Azure AD B2C содержит документ метаданных JSON для каждой политики. Документ метаданных является объектом JSON, содержащим важные сведения. Метаданные содержат **jwks_uri**, который задает расположение набора открытых ключей, используемых для подписи маркеров. Это расположение предоставляется здесь, но лучше получить расположение динамически с помощью документа метаданных и синтаксического анализа **jwks_uri**:

```
https://contoso.b2clogin.com/contoso.onmicrosoft.com/discovery/v2.0/keys?p=b2c_1_signupsignin1
```
Документ JSON, расположенный по этому URL-адресу, содержит все сведения об открытых ключах, используемые в конкретный момент времени. Приложение может использовать утверждение `kid` в заголовке маркера JWT, чтобы выбрать открытый ключ в этом документе JSON, использованный для подписания определенного маркера. Затем оно может проверить подпись с использованием правильного открытого ключа и указанного алгоритма.

Документ метаданных для `B2C_1_signupsignin1` политики `contoso.onmicrosoft.com` в клиенте расположен по адресу:

```
https://contoso.b2clogin.com/contoso.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=b2c_1_signupsignin1
```

Чтобы определить, какая политика использовалась для подписания маркера (и где можно найти запрос метаданных), у вас есть два варианта. Сначала имя политики включается в утверждение `acr` маркера. Утверждения из тела маркера JWT можно проанализировать, декодировав тело маркера с помощью кодировки base-64 и десериализации полученной строки JSON. `acr` Утверждение — это имя политики, которая использовалась для выдаче маркера. Другой вариант — закодировать политику в значении `state` параметра при выполнении запроса, а затем декодировать ее, чтобы определить, какая политика использовалась. Каждый из этих методов является допустимым.

Описание выполнения проверки выходит за рамки этого документа. Для проверки маркера доступны многие библиотеки с открытым исходным кодом.

### <a name="validate-claims"></a>Проверка утверждений

Когда приложения или API получают маркер идентификации, он также должен выполнить несколько проверок на соответствие утверждениям в маркере идентификации. Необходимо проверить следующие утверждения:

- **аудитория** — проверяет, что маркер идентификатора предназначен для приложения.
- **не ранее** и **время истечения срока действия** — проверяет, не истек ли срок действия маркера идентификатора.
- **Издатель** — проверяет, был ли маркер выдан приложению с Azure AD B2C.
- **nonce** — стратегия защиты от атак с целью воспроизведения маркеров.

Полный список проверок, которые должен выполнить приложение, см. в [спецификации OpenID Connect Connect](https://openid.net).

## <a name="next-steps"></a>Следующие шаги

Узнайте больше о том, как [использовать маркеры доступа](active-directory-b2c-access-tokens.md).

