---
title: Пользовательские политики устранения неполадок в Azure Active Directory B2C
description: Узнайте о способах решения проблем при работе с пользовательскими политиками в Azure Active Directory B2C.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 08/13/2019
ms.author: mimart
ms.subservice: B2C
ms.openlocfilehash: 2f65e98cec04991fe9edef1b81bcb3ecc3d93d76
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78186372"
---
# <a name="troubleshoot-azure-ad-b2c-custom-policies-and-identity-experience-framework"></a>Устранение неполадок в пользовательских политиках Azure AD B2C и инфраструктуре процедур идентификации

Если вы используете пользовательские политики Azure Active Directory B2C (Azure AD B2C), вы можете столкнуться с некоторыми трудностями при настройке инфраструктуры процедур идентификации на языке политики в формате XML. Обучение написанию пользовательских политик подобно изучению нового языка. В этой статье мы описываем некоторые инструменты и советы, которые помогут вам обнаружить и решить проблемы.

Мы рассмотрим устранение неполадок, связанных с настройками пользовательских политик Azure AD B2C. В этой статье не рассматривается приложение проверяющей стороны или его библиотека удостоверений.

## <a name="xml-editing"></a>Редактирование кода XML

Самой распространенной ошибкой при настройке пользовательских политик является неправильный формат XML. Вам нужен хороший редактор XML. Он отображает содержимое XML, цветовые коды, предварительно заполняет общие термины, сохраняет индексирование элементов XML и может провериться на основе схемы XML.

Два из наших любимых редакторов являются [Visual Studio Code](https://code.visualstudio.com/) и [Блокнот .](https://notepad-plus-plus.org/)

При проверке по схеме XML определяются ошибки перед отправкой XML-файла. В корневой папке [стартового пакета](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack)получите файл определения схемы XML *TrustFrameworkPolicy_0.3.0.0.xd.* Чтобы узнать, как использовать файл схемы XSD для проверки в редакторе, ищите *инструменты XML* и *проверку XML* или аналогичные в документации редактора.

Не будет лишним также ознакомиться с правилами XML. Azure AD B2C отклоняет любые обнаруженные ошибки форматирования. Иногда, если используется XML неправильного формата, могут появляться сообщения об ошибках, вводящие в заблуждение.

## <a name="upload-policies-and-policy-validation"></a>Передача политик и их проверка

Проверка файла полиса XML выполняется автоматически при загрузке. Большинство ошибок приводят к сбою отправки. Проверка включает файл политики, который вы отправляете. Она также включает цепочку файлов, с которыми связан файл для отправки (файл политики проверяющей стороны, файл расширения и базовый файл).

Общие ошибки проверки включают в себя следующее:

> Фрагмент кода ошибки: `...makes a reference to ClaimType with id "displayName" but neither the policy nor any of its base policies contain such an element`

* Значение ClaimType может быть введено неверно или не существовать в схеме.
* Значения ClaimType нужно определить по крайней мере в одном из файлов политики.
    Например: `<ClaimType Id="issuerUserId">`
* Если параметр ClaimType определен в файле расширения, но также используется в значении TechnicalProfile в базовом файле, передача базового файла приведет к ошибке.

> Фрагмент кода ошибки: `...makes a reference to a ClaimsTransformation with id...`

* Причины этой ошибки могут быть такими же, как и для ошибки ClaimType.

> Фрагмент кода ошибки: `Reason: User is currently logged as a user of 'yourtenant.onmicrosoft.com' tenant. In order to manage 'yourtenant.onmicrosoft.com', please login as a user of 'yourtenant.onmicrosoft.com' tenant`

* Убедитесь, что значение `<TrustFrameworkPolicy\>` TenantId в `<BasePolicy\>` и элементы совпадают с целевым клиентом Azure AD B2C.

## <a name="troubleshoot-the-runtime"></a>Устранение неполадок среды выполнения

* Используйте Run `https://jwt.ms` **сейчас** и тестируйте свои политики независимо от веб-приложений или мобильного приложения. Этот веб-сайт работает как приложение проверяющей стороны. Отображается содержимое веб-токена JSON (JWT), генерируемого политикой Azure AD B2C.

    Для создания тестового приложения, `https://jwt.ms` которое может быть перенаправёно для проверки токенов:

    [!INCLUDE [active-directory-b2c-appreg-idp](../../includes/active-directory-b2c-appreg-idp.md)]

* Чтобы отследить обмен сообщениями между клиентским браузером и Azure AD B2C, используйте [Fiddler](https://www.telerik.com/fiddler). Это позволит узнать, где в шагах оркестрации случился сбой пути взаимодействия пользователя.

* Используйте [Application Insights](troubleshoot-with-application-insights.md) в **режиме разработки**, чтобы отслеживать поведение в рамках пути взаимодействия пользователя в инфраструктуре процедур идентификации. В **режиме разработки**можно наблюдать обмен претензиями между системой identity Experience и различными поставщиками требований, которые определяются техническими профилями, такими как поставщики идентификационных данных, службы на основе API, каталог пользователей Azure AD B2C и другие службы, такие как Azure Multi-Factor Authentication.

## <a name="recommended-practices"></a>Рекомендации

**Храните несколько версий сценариев. Группируйте их в проекте с вашим приложением.** Базовые файлы, файлы расширения и файлы проверяющей стороны напрямую зависят друг от друга. Сохраните их как группу. Используйте отдельные рабочие версии по мере реализации новых функций в политиках. Поместите рабочие версии в свою собственную файловую систему с кодом приложения, с которым они взаимодействуют. Приложения могут вызывать многие различные политики проверяющей стороны в клиенте. Они могут стать зависимыми от утверждений, ожидаемых на основе политик Azure AD B2C.

**Разработка и тестирование технических профилей с известными пользовательскими путешествиями.** Используйте проверенные политики начального пакета, чтобы настроить технические профили. Прежде чем встраивать их в собственные пути взаимодействия пользователя, проверьте их по отдельности.

**Разрабатывайте и тестируйте пути взаимодействия пользователя с проверенными техническими профилями.** Поэтапно измените шаги оркестрации пути взаимодействия пользователя. Прогрессивно создавайте целевые сценарии.

## <a name="next-steps"></a>Дальнейшие действия

Доступные на GitHub, скачать [активный каталог-b2c-пользователь-политика-starterpack](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/archive/master.zip) .zip архив. Вы также можете клонировать репозиторий:

```
git clone https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack
```
