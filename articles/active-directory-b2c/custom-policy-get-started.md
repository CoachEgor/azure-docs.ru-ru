---
title: Начало работы с настраиваемыми политиками
titleSuffix: Azure AD B2C
description: Узнайте, как начать работу с пользовательскими политиками в Azure Active Directory B2C.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 02/28/2020
ms.author: mimart
ms.subservice: B2C
ms.openlocfilehash: 856bd6c2a3546a438293e89a0b576e1392d9c6a5
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81407293"
---
# <a name="get-started-with-custom-policies-in-azure-active-directory-b2c"></a>Начало работы с настраиваемыми политиками в Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

[Пользовательские политики](custom-policy-overview.md) — это файлы конфигурации, определяющие поведение вашего клиента Azure Active Directory B2C (Azure AD B2C). В рамках этой статьи вы создадите настраиваемую политику, которая будет поддерживать регистрацию и вход с помощью локальной учетной записи с использованием адреса электронной почты и пароля. Вы также можете подготовить среду для добавления поставщиков удостоверений.

## <a name="prerequisites"></a>Предварительные требования

- Если его у вас еще нет, [создайте арендатора Azure AD B2C,](tutorial-create-tenant.md) который связан с подпиской Azure.
- [Зарегистрируйте приложение](tutorial-register-applications.md) в созданном вами приложении, чтобы оно могли общаться с Azure AD B2C.
- Заполните шаги в [Регистрации и входе в учетную запись Facebook](identity-provider-facebook.md) для настройки приложения Facebook. Хотя приложение Facebook не требуется для использования пользовательских политик, оно используется в этом пошаговом шаге, чтобы продемонстрировать включение социального входа в пользовательскую политику.

## <a name="add-signing-and-encryption-keys"></a>Добавление ключей подписи и шифрования

1. Войдите на [портал Azure](https://portal.azure.com).
1. Выберите **значок каталога и подписки** в панели инструментов портала, а затем выберите каталог, содержащий ваш клиент Azure AD B2C.
1. На портале Azure ищите **Azure AD B2C.**
1. На странице обзора, в соответствии **с политиками,** выберите **рамки опыта идентификации.**

### <a name="create-the-signing-key"></a>Создание ключа подписи

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
1. Для пункта **Параметры** выберите `Generate`.
1. В разделе **Имя** введите `TokenSigningKeyContainer`. Префикс `B2C_1A_` может быть добавлен автоматически.
1. Для параметра **Тип ключа** выберите **RSA**.
1. Для параметра **Использование ключа** выберите **Подпись**.
1. Нажмите кнопку **создания**.

### <a name="create-the-encryption-key"></a>Создание ключа шифрования

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
1. Для пункта **Параметры** выберите `Generate`.
1. В разделе **Имя** введите `TokenEncryptionKeyContainer`. Префикс `B2C_1A`_ может быть добавлен автоматически.
1. Для параметра **Тип ключа** выберите **RSA**.
1. Для параметра **Использование ключа** задайте значение **Шифрование**.
1. Нажмите кнопку **создания**.

### <a name="create-the-facebook-key"></a>Создание ключа Facebook

Добавьте [App Secret](identity-provider-facebook.md) вашего приложения Facebook в качестве ключа политики. Вы можете использовать приложение Секрет приложения, которое вы создали в рамках предпосылок этой статьи.

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
1. Для пункта **Параметры** выберите `Manual`.
1. Для параметра **Имя** введите `FacebookSecret`. Префикс `B2C_1A_` может быть добавлен автоматически.
1. В **secret**введите *App Secret* вашего приложения Facebook с developers.facebook.com. Это значение является секретом, а не идентификатором приложения.
1. Для параметра **Использование ключа** выберите **Подпись**.
1. Нажмите кнопку **создания**.

## <a name="register-identity-experience-framework-applications"></a>Регистрация приложений инфраструктуры процедур идентификации

Azure AD B2C требует, чтобы вы зарегистрировали два приложения, которые он использует, чтобы зарегистрироваться и войти в пользователей с локальными учетными записями: *IdentityExperienceFramework*, веб-aPI, и *ProxyIdentityExperienceFramework*, родное приложение с делегированным разрешением на приложение IdentityExperienceFramework. Пользователи могут зарегистрироваться с адресом электронной почты или именем пользователя и паролем для доступа к зарегистрированным арендатором приложениям, что создает "местную учетную запись". Локальные учетные записи существуют только в вашем арендаторе Azure AD B2C.

Эти два приложения необходимо зарегистрировать в арендаторе Azure AD B2C только один раз.

### <a name="register-the-identityexperienceframework-application"></a>Регистрация приложения IdentityExperienceFramework

Чтобы зарегистрировать приложение в вашем арендаторе Azure AD B2C, вы можете использовать опыт **регистрации приложений (Наследие)** или наш новый унифицированный опыт **регистрации приложений (Preview).** [См. дополнительные сведения о новом интерфейсе](https://aka.ms/b2cappregintro).

#### <a name="applications"></a>[Приложения](#tab/applications/)

1. Войдите на [портал Azure](https://portal.azure.com).
1. На портале Azure найдите и выберите **Azure Active Directory**.
1. В меню обзора **Active Directory Azure** под **управлением**выберите **регистрацию приложений (Наследие).**
1. Выберите **Регистрация нового приложения**.
1. Для параметра **Имя** введите `IdentityExperienceFramework`.
1. Для параметра **Тип приложения** выберите **Веб-приложение или API**.
1. Для параметра **URL-адрес для входа** введите `https://your-tenant-name.b2clogin.com/your-tenant-name.onmicrosoft.com`, где `your-tenant-name` — это доменное имя клиента Azure AD B2C. Всем URL-адресам следует использовать [b2clogin.com](b2clogin.md).
1. Нажмите кнопку **создания**. По завершении операции создания скопируйте идентификатор приложения и сохраните его для последующего использования.

#### <a name="app-registrations-preview"></a>[Регистрация приложений (предварительная версия)](#tab/app-reg-preview/)

1. Щелкните **Регистрация приложений (предварительная версия)** и выберите **Новая регистрация**.
1. Для параметра **Имя** введите `IdentityExperienceFramework`.
1. Под **типами поддерживаемых учетных записей**выберите **учетные записи только в этом каталоге организации.**
1. Под **перенаправлениеuri**, выберите `https://your-tenant-name.b2clogin.com/your-tenant-name.onmicrosoft.com` **веб**, а затем введите , где `your-tenant-name` ваш Azure AD B2C арендатор доменное имя.
1. В разделе **Разрешения** установите флажок *Предоставьте согласие администратора для разрешений openid и offline_access*.
1. Выберите **Зарегистрировать**.
1. Запишите значение параметра **Идентификатор приложения (клиент)**. Оно вам потребуется в дальнейшем.

Далее, разоблачить API, добавив область:

1. В разделе **Управление** выберите **Предоставление API**.
1. Выберите **Добавить область,** затем выберите **Сохранить и продолжать** принимать id URI приложения по умолчанию.
1. Введите следующие значения, чтобы создать область, позволяющую выполнять пользовательские политики в вашем наемщике Azure AD B2C:
    * **Название области:**`user_impersonation`
    * **Имя отображения согласия админа:**`Access IdentityExperienceFramework`
    * **Описание согласия админа:**`Allow the application to access IdentityExperienceFramework on behalf of the signed-in user.`
1. Выберите **Добавить область**.

* * *

### <a name="register-the-proxyidentityexperienceframework-application"></a>Регистрация приложения ProxyIdentityExperienceFramework

#### <a name="applications"></a>[Приложения](#tab/applications/)

1. В **регистрации приложений (Наследие)** выберите **регистрацию новых приложений.**
1. Для параметра **Имя** введите `ProxyIdentityExperienceFramework`.
1. Для параметра **Тип приложения** выберите **Собственный**.
1. Для **перенаправления URI,** введите `myapp://auth`.
1. Нажмите кнопку **создания**. По завершении операции создания скопируйте идентификатор приложения и сохраните его для последующего использования.
1. Выберите **настройки,** затем выберите **Требуемые разрешения,** а затем выберите **Добавить.**
1. Выберите **API,** ищите и выберите **IdentityExperienceFramework,** а затем нажмите **Выберите.**
1. Установите флажок рядом с элементом **Access IdentityExperienceFramework** (Доступ к IdentityExperienceFramework), щелкните **Выбрать**, а затем — **Готово**.
1. Выберите **разрешения гранта,** а затем подтвердить, выбрав **Да**.

#### <a name="app-registrations-preview"></a>[Регистрация приложений (предварительная версия)](#tab/app-reg-preview/)

1. Щелкните **Регистрация приложений (предварительная версия)** и выберите **Новая регистрация**.
1. Для параметра **Имя** введите `ProxyIdentityExperienceFramework`.
1. Под **типами поддерживаемых учетных записей**выберите **учетные записи только в этом каталоге организации.**
1. В разделе **URI перенаправления** в раскрывающемся списке выберите **Общедоступный/собственный клиент (мобильный и классический)**.
1. Для **перенаправления URI,** введите `myapp://auth`.
1. В разделе **Разрешения** установите флажок *Предоставьте согласие администратора для разрешений openid и offline_access*.
1. Выберите **Зарегистрировать**.
1. Запишите значение параметра **Идентификатор приложения (клиент)**. Оно вам потребуется в дальнейшем.

Далее укажите, что приложение должно рассматриваться как публичный клиент:

1. В разделе **Управление** выберите **Проверка подлинности**.
1. Выберите **Попробовать новый пользовательский интерфейс** (если этот параметр показан).
1. В **расширенных настройках**включите **приложение Treat в качестве публичного клиента** (выберите **Yes).**
1. Щелкните **Сохранить**.

Теперь выдавайте разрешения на область API, выявленную ранее при регистрации *IdentityExperienceFramework:*

1. В разделе **Управление** выберите **Разрешения API**.
1. В разделе **Настроенные разрешения** выберите **Добавить разрешение**.
1. Выберите вкладку **My AA,** а затем выберите приложение **IdentityExperienceFramework.**
1. Под **разрешением**выберите **область user_impersonation,** которую вы определили ранее.
1. Выберите **Добавить разрешения**. В соответствии с инструкциями подождите несколько минут, прежде чем перейти к следующему шагу.
1. Выберите **Предоставить согласие администратора для (имя арендатора)** .
1. Выберите учетную запись администратора, с которой выполнен вход, или выполните вход с учетной записью в арендаторе Azure AD B2C, которой назначена по крайней мере роль *Администратор облачных приложений*.
1. Нажмите кнопку **Принять**.
1. Нажмите **Обновить** и убедитесь, что надпись "Предоставлено для..." отображается в разделе **Состояние** для обеих областей. Распространение разрешений может занять несколько минут.

* * *

## <a name="custom-policy-starter-pack"></a>Пользовательские политики стартовый пакет

Пользовательские политики представляют собой набор файлов XML, которые вы загружаете на арендаторaz AD B2C для определения технических профилей и поездок пользователей. Мы предоставляем стартовые пакеты с несколькими заранее построенными политиками, чтобы вы быстро. Каждый из этих стартовых пакетов содержит наименьшее количество технических профилей и пользовательских поездок, необходимых для достижения описанных сценариев:

- **Локальныесчета** - Позволяет использовать только локальные учетные записи.
- **Социальныесчета** - Позволяет использовать только социальные (или федеративные) счета.
- **SocialAndLocalAccounts** - Позволяет использовать как местные, так и социальные счета.
- **SocialAndLocalAccountsWithMFA** - Включает в себя параметры социальной, локальной и многофакторной аутентификации.

Каждый начальный пакет содержит:

- **Базовый файл** - Несколько изменений требуется для базы. Пример: *TrustFrameworkBase.xml*
- **Файл расширения** - Этот файл, где большинство изменений конфигурации вносятся. Пример: *TrustFrameworkExtensions.xml*
- **Опираясь на файлы участников** - файлы, связанные с конкретными задачами, вызываемые вашим приложением. Примеры: *SignUpOrSignin.xml*, *ProfileEdit.xml*, *PasswordReset.xml*

В этой статье вы отоденали файлы пользовательских политик XML в стартовом пакете **SocialAndLocalAccounts.** Если вам нужен редактор XML, попробуйте [Visual Studio Code](https://code.visualstudio.com/download), легкий кросс-платформенный редактор.

### <a name="get-the-starter-pack"></a>Получить стартовый пакет

Получите пакеты для запуска пользовательских политик от GitHub, а затем обновите файлы XML в стартовом пакете SocialAndLocalAccounts с вашим именем арендатора Azure AD B2C.

1. [Скачать файл .zip](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/archive/master.zip) или клонировать репозиторий:

    ```console
    git clone https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack
    ```

1. Во всех файлах в каталоге **SocialAndLocalAccounts** `yourtenant` замените строку именем вашего арендатора Azure AD B2C.

    Например, если имя вашего арендатора B2C является *contosotenant*, все экземпляры `yourtenant.onmicrosoft.com` стали `contosotenant.onmicrosoft.com`.

### <a name="add-application-ids-to-the-custom-policy"></a>Добавление идентификаторов приложений в настраиваемую политику

В файл расширений *TrustFrameworkExtensions* добавьте идентификаторы приложений.

1. Откройте `SocialAndLocalAccounts/` **`TrustFrameworkExtensions.xml`** и `<TechnicalProfile Id="login-NonInteractive">`найдите элемент.
1. Замените оба `IdentityExperienceFrameworkAppId` экземпляра идентификатором приложения приложения IdentityExperienceFramework, созданного ранее.
1. Замените оба `ProxyIdentityExperienceFrameworkAppId` экземпляра идентификатором приложения приложения ProxyIdentityExperienceFramework, созданного ранее.
1. Сохраните файл.

## <a name="upload-the-policies"></a>Отправка политик

1. Выберите элемент меню **«Интерфейс атнизм интерфейса идентичности»** в вашем арендаторе B2C на портале Azure.
1. Выберите **пользовательскую политику загрузки.**
1. В этом порядке загрузите файлы политики:
    1. *TrustFrameworkBase.xml*
    1. *TrustFrameworkExtensions.xml*
    1. *SignUpOrSignin.xml*
    1. *ProfileEdit.xml*
    1. *PasswordReset.xml*

При загрузке файлов Azure добавляет `B2C_1A_` префикс к каждому из них.

> [!TIP]
> Если ваш редактор XML поддерживает проверку, `TrustFrameworkPolicy_0.3.0.0.xsd` проверьте файлы на схеме XML, которая находится в корневом каталоге стартового пакета. При проверке по схеме XML определяются ошибки перед отправкой.

## <a name="test-the-custom-policy"></a>Проверка пользовательской политики

1. В соответствии с **пользовательскими политиками,** выберите **B2C_1A_signup_signin**.
1. Для **выбора приложения** на странице обзора пользовательской политики выберите веб-приложение под названием *webapp1,* которое вы зарегистрировали ранее.
1. Убедитесь, что **URL-адрес ответа** находится `https://jwt.ms`под ими.
1. Выберите **Запустить сейчас**.
1. Зарегистрируйтесь с помощью адреса электронной почты.
1. Выберите **Выполнить снова.**
1. Войдите в систему с помощью той же учетной записи, чтобы подтвердить правильность конфигурации.

## <a name="add-facebook-as-an-identity-provider"></a>Добавление Facebook в качестве поставщика удостоверений

Как уже упоминалось в [Prerequisites,](#prerequisites)Facebook *не* требуется для использования пользовательских политик, но используется здесь, чтобы продемонстрировать, как вы можете включить федеративный социальный логин в пользовательской политике.

1. В `SocialAndLocalAccounts/` **`TrustFrameworkExtensions.xml`** файле замените `client_id` значение идентификатора приложения Facebook:

   ```xml
   <TechnicalProfile Id="Facebook-OAUTH">
     <Metadata>
     <!--Replace the value of client_id in this technical profile with the Facebook app ID"-->
       <Item Key="client_id">00000000000000</Item>
   ```

1. Отправьте файл *TrustFrameworkExtensions.xml* в клиент.
1. В соответствии с **пользовательскими политиками,** выберите **B2C_1A_signup_signin**.
1. Выберите **Выполнить сейчас** и выбрать Facebook, чтобы войти в систему с Facebook и проверить пользовательскую политику.

## <a name="next-steps"></a>Дальнейшие действия

Затем попробуйте добавить Активный каталог Azure (Azure AD) в качестве поставщика идентификационных данных. Базовый файл, используемый в этом руководстве по началу работы, уже содержит некоторые материалы, необходимые для добавления других поставщиков идентификационных данных, таких как Azure AD.

Для получения информации о настройке Azure AD в качестве поставщика и идентификации можно ознакомиться на настройке [и всасывании с учетной записью Active Directory, используя пользовательские политики Active Directory B2C.](identity-provider-azure-ad-single-tenant-custom.md)
