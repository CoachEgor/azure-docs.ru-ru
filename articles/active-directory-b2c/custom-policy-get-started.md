---
title: Начало работы с настраиваемыми политиками
titleSuffix: Azure AD B2C
description: Узнайте, как начать работу с настраиваемыми политиками в Azure Active Directory B2C.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 02/28/2020
ms.author: mimart
ms.subservice: B2C
ms.openlocfilehash: 32ec55a2ed6e0158a05f81067dc834fdc1e6e765
ms.sourcegitcommit: 493b27fbfd7917c3823a1e4c313d07331d1b732f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/21/2020
ms.locfileid: "83738257"
---
# <a name="get-started-with-custom-policies-in-azure-active-directory-b2c"></a>Начало работы с настраиваемыми политиками в Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

[Настраиваемые политики](custom-policy-overview.md) — это файлы конфигурации, определяющие поведение вашего клиента Azure Active Directory B2C (Azure AD B2C). В рамках этой статьи вы создадите настраиваемую политику, которая будет поддерживать регистрацию и вход с помощью локальной учетной записи с использованием адреса электронной почты и пароля. Вы также можете подготовить среду для добавления поставщиков удостоверений.

## <a name="prerequisites"></a>Предварительные требования

- Если у вас еще нет клиента Azure AD B2C, [создайте](tutorial-create-tenant.md) его. Он должен быть связан с вашей подпиской Azure.
- [Зарегистрируйте свое приложение](tutorial-register-applications.md) в созданном клиенте, чтобы оно могло обмениваться данными с Azure AD B2C.
- Выполните действия, описанные в статье [Настройка регистрации и входа с помощью учетной записи Facebook](identity-provider-facebook.md), чтобы настроить приложение Facebook. Хотя приложение Facebook не обязательно для использования настраиваемых политик, оно используется в этом пошаговом руководстве для демонстрации возможности входа через социальную сеть в настраиваемой политике.

## <a name="add-signing-and-encryption-keys"></a>Добавление ключей подписи и шифрования

1. Войдите на [портал Azure](https://portal.azure.com).
1. Выберите значок **Каталог и подписка** в верхней панели инструментов портала, а затем выберите каталог, содержащий клиент Azure AD B2C.
1. На портале Azure найдите и выберите **Azure AD B2C**.
1. На странице "Обзор" в разделе **Политики** выберите **Identity Experience Framework**.

### <a name="create-the-signing-key"></a>Создание ключа подписи

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
1. Для пункта **Параметры** выберите `Generate`.
1. В разделе **Имя** введите `TokenSigningKeyContainer`. Префикс `B2C_1A_` может быть добавлен автоматически.
1. Для параметра **Тип ключа** выберите **RSA**.
1. Для параметра **Использование ключа** выберите **Подпись**.
1. Нажмите кнопку **создания**.

### <a name="create-the-encryption-key"></a>Создание ключа шифрования

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
1. Для пункта **Параметры** выберите `Generate`.
1. В разделе **Имя** введите `TokenEncryptionKeyContainer`. Префикс `B2C_1A`_ может быть добавлен автоматически.
1. Для параметра **Тип ключа** выберите **RSA**.
1. Для параметра **Использование ключа** задайте значение **Шифрование**.
1. Нажмите кнопку **создания**.

### <a name="create-the-facebook-key"></a>Создание ключа Facebook

Добавьте [секрет приложения](identity-provider-facebook.md) Facebook в качестве ключа политики. Вы можете использовать секрет созданного приложения, чтобы выполнить одно из предварительных требований, описанных в этой статье.

1. Выберите **Ключи политики**, а затем щелкните **Добавить**.
1. Для пункта **Параметры** выберите `Manual`.
1. Для параметра **Имя** введите `FacebookSecret`. Префикс `B2C_1A_` может быть добавлен автоматически.
1. В поле **Секрет** введите *секрет приложения* Facebook, указанный на сайте developers.facebook.com. Обратите внимание, что это секрет, а не идентификатор приложения.
1. Для параметра **Использование ключа** выберите **Подпись**.
1. Нажмите кнопку **создания**.

## <a name="register-identity-experience-framework-applications"></a>Регистрация приложений инфраструктуры процедур идентификации

Для Azure AD B2C необходимо зарегистрировать два приложения, которые используются для регистрации и входа пользователей с помощью локальных учетных записей: *IdentityExperienceFramework* (веб-API) и *ProxyIdentityExperienceFramework* (нативное приложение) с делегированным разрешением приложению IdentityExperienceFramework. Пользователи могут зарегистрироваться с помощью адреса электронной почты или имени пользователя и пароля для доступа к зарегистрированным в клиенте приложениям, в результате чего создается "локальная учетная запись". Локальные учетные записи хранятся только в клиенте Azure AD B2C.

Эти два приложения нужно зарегистрировать в клиенте Azure AD B2C только один раз.

### <a name="register-the-identityexperienceframework-application"></a>Регистрация приложения IdentityExperienceFramework

Чтобы зарегистрировать приложение в клиенте Azure AD B2C, можно использовать интерфейс **Регистрация приложений (прежняя версия)** или новый объединенный интерфейс **Регистрация приложений (предварительная версия)** . [См. дополнительные сведения о новом интерфейсе](https://aka.ms/b2cappregintro).

#### <a name="applications"></a>[Приложения](#tab/applications/)

1. Войдите на [портал Azure](https://portal.azure.com).
1. На портале Azure найдите и выберите **Azure Active Directory**.
1. В меню обзора **Azure Active Directory** в разделе **Управление** выберите **Регистрация приложений (прежняя версия)** .
1. Выберите **Регистрация нового приложения**.
1. Для параметра **Имя** введите `IdentityExperienceFramework`.
1. Для параметра **Тип приложения** выберите **Веб-приложение или API**.
1. Для параметра **URL-адрес для входа** введите `https://your-tenant-name.b2clogin.com/your-tenant-name.onmicrosoft.com`, где `your-tenant-name` — это доменное имя клиента Azure AD B2C. Всем URL-адресам следует использовать [b2clogin.com](b2clogin.md).
1. Нажмите кнопку **создания**. По завершении операции создания скопируйте идентификатор приложения и сохраните его для последующего использования.

#### <a name="app-registrations-preview"></a>[Регистрация приложений (предварительная версия)](#tab/app-reg-preview/)

1. Щелкните **Регистрация приложений (предварительная версия)** и выберите **Новая регистрация**.
1. Для параметра **Имя** введите `IdentityExperienceFramework`.
1. В разделе **Поддерживаемые типы учетных записей** выберите **Учетные записи только в этом каталоге организации**.
1. В разделе **URI перенаправления** выберите **Интернет** и введите `https://your-tenant-name.b2clogin.com/your-tenant-name.onmicrosoft.com`, где `your-tenant-name` — это доменное имя вашего клиента Azure AD B2C.
1. В разделе **Разрешения** установите флажок *Предоставьте согласие администратора для разрешений openid и offline_access*.
1. Выберите **Зарегистрировать**.
1. Запишите значение параметра **Идентификатор приложения (клиент)** . Оно вам потребуется в дальнейшем.

Затем задайте API, добавив область:

1. В разделе **Управление** выберите **Предоставление API**.
1. Выберите **Добавить область** и щелкните **Сохранить и продолжить**, чтобы принять URI идентификатора приложения по умолчанию.
1. Введите следующие значения, чтобы создать область, которая разрешает выполнение настраиваемых политик в клиенте Azure AD B2C:
    * **Имя области**: `user_impersonation`
    * **Отображаемое имя согласия администратора**: `Access IdentityExperienceFramework`
    * **Описание согласия администратора**: `Allow the application to access IdentityExperienceFramework on behalf of the signed-in user.`
1. Выберите **Добавить область**.

* * *

### <a name="register-the-proxyidentityexperienceframework-application"></a>Регистрация приложения ProxyIdentityExperienceFramework

#### <a name="applications"></a>[Приложения](#tab/applications/)

1. В разделе **Регистрация приложений (прежняя версия)** выберите **Регистрация нового приложения**.
1. Для параметра **Имя** введите `ProxyIdentityExperienceFramework`.
1. Для параметра **Тип приложения** выберите **Собственный**.
1. В поле **URI перенаправления** введите `myapp://auth`.
1. Нажмите кнопку **создания**. По завершении операции создания скопируйте идентификатор приложения и сохраните его для последующего использования.
1. Выберите **Параметры**, **Необходимые разрешения** и **Добавить**.
1. Щелкните **Выбор API**, найдите и выберите **IdentityExperienceFramework**, а затем щелкните **Выбрать**.
1. Установите флажок рядом с элементом **Access IdentityExperienceFramework** (Доступ к IdentityExperienceFramework), щелкните **Выбрать**, а затем — **Готово**.
1. Выберите **Предоставить разрешения**, а затем выберите **Да** для подтверждения.

#### <a name="app-registrations-preview"></a>[Регистрация приложений (предварительная версия)](#tab/app-reg-preview/)

1. Щелкните **Регистрация приложений (предварительная версия)** и выберите **Новая регистрация**.
1. Для параметра **Имя** введите `ProxyIdentityExperienceFramework`.
1. В разделе **Поддерживаемые типы учетных записей** выберите **Учетные записи только в этом каталоге организации**.
1. В разделе **URI перенаправления** в раскрывающемся списке выберите **Общедоступный/собственный клиент (мобильный и классический)** .
1. В поле **URI перенаправления** введите `myapp://auth`.
1. В разделе **Разрешения** установите флажок *Предоставьте согласие администратора для разрешений openid и offline_access*.
1. Выберите **Зарегистрировать**.
1. Запишите значение параметра **Идентификатор приложения (клиент)** . Оно вам потребуется в дальнейшем.

Затем укажите, что приложение должно считаться общедоступным клиентом:

1. В разделе **Управление** выберите **Проверка подлинности**.
1. Выберите **Попробовать новый пользовательский интерфейс** (если этот параметр показан).
1. В разделе **Дополнительные параметры** включите параметр **Считать приложение общедоступным клиентом** (выберите **Да**). Убедитесь, что в манифесте приложения указана строка **"allowPublicClient": true**. 
1. Щелкните **Сохранить**.

Теперь предоставьте разрешения для области API, которую вы указали ранее при регистрации *IdentityExperienceFramework*:

1. В разделе **Управление** выберите **Разрешения API**.
1. В разделе **Настроенные разрешения** выберите **Добавить разрешение**.
1. Перейдите на вкладку **Мои API** и выберите приложение **IdentityExperienceFramework**.
1. В разделе **Разрешение** выберите определенную ранее область **user_impersonation**.
1. Выберите **Добавить разрешения**. В соответствии с инструкциями подождите несколько минут, прежде чем перейти к следующему шагу.
1. Выберите **Предоставить согласие администратора для (имя арендатора)** .
1. Выберите учетную запись администратора, с которой выполнен вход, или выполните вход с учетной записью в арендаторе Azure AD B2C, которой назначена по крайней мере роль *Администратор облачных приложений*.
1. Нажмите кнопку **Принять**.
1. Нажмите **Обновить** и убедитесь, что надпись "Предоставлено для..." отображается в разделе **Состояние** для обеих областей. Распространение разрешений может занять несколько минут.

* * *

## <a name="custom-policy-starter-pack"></a>Начальный пакет настраиваемых политик

Настраиваемые политики представляют собой набор XML-файлов, которые вы отправляете в клиент Azure AD B2C для определения технических профилей и путей взаимодействия пользователей. Мы предоставляем начальные пакеты с несколькими готовыми политиками, чтобы вы могли сразу приступить к работе. Каждый начальный пакет содержит минимальное количество технических профилей и путей взаимодействия пользователей, необходимых для достижения описанных сценариев:

- **LocalAccounts** позволяет использовать только локальные учетные записи.
- **SocialAccounts** позволяет использовать только учетные записи социальных сетей (или федеративные).
- **SocialAndLocalAccounts** позволяет использовать и локальные учетные записи, и учетные записи социальных сетей.
- **SocialAndLocalAccountsWithMFA** позволяет использовать локальные учетные записи и учетные записи социальных сетей с многофакторной проверкой подлинности.

Каждый начальный пакет содержит:

- **Базовый файл**, в который нужно внести несколько изменений. Пример *TrustFrameworkBase.xml*
- **Файл расширения**, в который вносится большинство изменений конфигурации. Пример *TrustFrameworkExtensions.xml*
- **Файлы проверяющей стороны**, которые вызывает приложение для выполнения определенных задач. Примеры: *SignUpOrSignin.xml*, *ProfileEdit.xml*, *PasswordReset.xml*

Вы этой статье вы измените XML-файлы настраиваемой политики в начальном пакете **SocialAndLocalAccounts**. Если вам нужен редактор XML, [попробуйте Visual Studio Code](https://code.visualstudio.com/download) — упрощенный кроссплатформенный редактор.

### <a name="get-the-starter-pack"></a>Получение начального пакета

Скачайте начальные пакеты настраиваемых политик из GitHub, а затем обновите XML-файлы в начальном пакете SocialAndLocalAccounts, указав имя своего клиента Azure AD B2C.

1. [Скачайте ZIP-файл](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/archive/master.zip) или клонируйте репозиторий:

    ```console
    git clone https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack
    ```

1. Во всех файлах в каталоге **SocialAndLocalAccounts** замените строку `yourtenant` именем своего клиента Azure AD B2C.

    Например, если ваш клиент B2C имеет имя *contosotenant*, все экземпляры `yourtenant.onmicrosoft.com` должны иметь вид `contosotenant.onmicrosoft.com`.

### <a name="add-application-ids-to-the-custom-policy"></a>Добавление идентификаторов приложений в настраиваемую политику

В файл расширений *TrustFrameworkExtensions* добавьте идентификаторы приложений.

1. Откройте `SocialAndLocalAccounts/`**`TrustFrameworkExtensions.xml`** и найдите элемент `<TechnicalProfile Id="login-NonInteractive">`.
1. Замените оба экземпляра `IdentityExperienceFrameworkAppId` идентификатором созданного ранее приложения IdentityExperienceFramework.
1. Замените оба экземпляра `ProxyIdentityExperienceFrameworkAppId` идентификатором созданного ранее приложения ProxyIdentityExperienceFramework.
1. Сохраните файл.

## <a name="upload-the-policies"></a>Отправка политик

1. Выберите пункт меню **Identity Experience Framework** в своем клиенте B2C на портале Azure.
1. Выберите **Отправить настраиваемую политику**.
1. Отправьте файлы политики в следующем порядке:
    1. *TrustFrameworkBase.xml*
    1. *TrustFrameworkExtensions.xml*
    1. *SignUpOrSignin.xml*
    1. *ProfileEdit.xml*
    1. *PasswordReset.xml*

При отправке файлов в Azure к каждому из них добавляется префикс `B2C_1A_`.

> [!TIP]
> Если в редакторе XML поддерживается проверка, проверьте файлы с помощью XML-файла схемы `TrustFrameworkPolicy_0.3.0.0.xsd`, который расположен в корневом каталоге начального пакета. При проверке по схеме XML определяются ошибки перед отправкой.

## <a name="test-the-custom-policy"></a>Проверка пользовательской политики

1. В разделе **Настраиваемые политики** выберите **B2C_1A_signup_signin**.
1. Для параметра **Выбор приложения** на странице сведений о настраиваемой политике выберите зарегистрированное ранее веб-приложение с именем *webapp1*.
1. Убедитесь, что для параметра **URL-адрес ответа** выбрано значение `https://jwt.ms`.
1. Выберите **Запустить сейчас**.
1. Зарегистрируйтесь с помощью адреса электронной почты.
1. Снова выберите **Запустить сейчас**.
1. Войдите в систему с помощью той же учетной записи, чтобы подтвердить правильность конфигурации.

## <a name="add-facebook-as-an-identity-provider"></a>Добавление Facebook в качестве поставщика удостоверений

Как было сказано в разделе [Предварительные требования](#prerequisites), вам *не* нужен доступ к Facebook для использования настраиваемых политик. Здесь он используется для демонстрации возможности федеративного входа через социальные сети в настраиваемых политиках.

1. В файле `SocialAndLocalAccounts/`**`TrustFrameworkExtensions.xml`** замените значение `client_id` идентификатором приложения Facebook:

   ```xml
   <TechnicalProfile Id="Facebook-OAUTH">
     <Metadata>
     <!--Replace the value of client_id in this technical profile with the Facebook app ID"-->
       <Item Key="client_id">00000000000000</Item>
   ```

1. Отправьте файл *TrustFrameworkExtensions.xml* в клиент.
1. В разделе **Настраиваемые политики** выберите **B2C_1A_signup_signin**.
1. Щелкните **Запустить сейчас** и выберите Facebook, чтобы войти с учетной записью Facebook и проверить работу настраиваемой политики.

## <a name="next-steps"></a>Дальнейшие действия

Попытайтесь добавить Azure Active Directory (Azure AD) в качестве поставщика удостоверений. В базовом файле, который использовался в этом руководстве по началу работы, уже есть некоторое содержимое, необходимое для добавления других поставщиков удостоверений (например, Azure AD).

Сведения о настройке Azure AD в качестве поставщика удостоверений см. в статье [Настройка регистрации и входа с помощью учетной записи Azure Active Directory с использованием настраиваемых политик Active Directory B2C](identity-provider-azure-ad-single-tenant-custom.md).
