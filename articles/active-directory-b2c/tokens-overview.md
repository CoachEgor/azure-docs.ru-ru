---
title: Обзор токенов - Активный каталог Azure B2C
description: Узнайте о токенах, используемых в Azure Active Directory B2C.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 08/27/2019
ms.author: mimart
ms.subservice: B2C
ms.openlocfilehash: cbbd083a6b62733d71c316af95dffaa188b28955
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78186494"
---
# <a name="overview-of-tokens-in-azure-active-directory-b2c"></a>Обзор токенов в Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

При обработке каждого [потока аутентификации](application-types.md) Azure Active Directory B2C (Azure AD B2C) создает маркеры безопасности различных типов. В этом документе описывается формат, характеристики безопасности и содержимое каждого типа маркера.

## <a name="token-types"></a>Типы маркеров

Azure AD B2C поддерживает [протоколы OAuth 2.0 и OpenID Connect,](protocols-overview.md)которые используют токены для проверки подлинности и безопасного доступа к ресурсам. Все токены, используемые в Azure AD B2C, являются [веб-токенами JSON (JWT),](https://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) которые содержат утверждения информации о носителе и предмете токена.

Следующие токены используются в общении с Azure AD B2C:

- *Токен ID* - JWT, содержащий утверждения, которые можно использовать для идентификации пользователей в приложении. Этот маркер надежно отправляется в запросах HTTP для связи между двумя компонентами одного и того же приложения или службы. Утверждения, которые содержит маркер идентификации, вы можете использовать по своему усмотрению. Они обычно используются для отображения информации об учетной записи или для принятия решений по управлению доступом в приложении. Токены ID подписаны, но не зашифрованы. Когда ваше приложение или API получает токен ID, оно должно проверить подпись, чтобы доказать подлинность токена. Ваше приложение или API также должны проверить несколько претензий в маркере, чтобы доказать, что она действительна. В зависимости от требований сценария требования, подтвержденные приложением, могут варьироваться, но приложение должно выполнять некоторые общие проверки требований в каждом сценарии.
- *Токен доступа* - JWT, содержащий утверждения, которые можно использовать для идентификации предоставленных разрешений на AA. Токены доступа подписаны, но не зашифрованы. Токены доступа используются для обеспечения доступа к AA и серверам ресурсов.  Когда API получает маркер доступа, он проверяет его подпись , чтобы подтвердить подлинность маркера. API должен также проверить несколько утверждений в маркере, чтобы подтвердить его действительность. В зависимости от требований сценария требования, подтвержденные приложением, могут варьироваться, но приложение должно выполнять некоторые общие проверки требований в каждом сценарии.
- *Обновление токенов* - Токены обновления используются для приобретения новых токенов и токенов доступа к ним в потоке OAuth 2.0. Они предоставляют вашему приложению долгосрочный доступ к ресурсам от имени пользователей, не требуя взаимодействия с этими пользователями. Обновления токенов непрозрачны для приложения. Они выдаются Azure AD B2C и могут быть проверены и интерпретированы только Azure AD B2C. Они долговечны, но ваше приложение не должно быть написано в расчете на то, что токен обновления будет длиться в течение определенного периода времени. Маркеры обновления могут стать недействительными в любое время по разным причинам. Единственный способ узнать, является ли токен обновления действительным, это попытаться выкупить его, сделав символический запрос в Azure AD B2C. При искупке маркера обновления для нового маркера вы получаете новый маркер обновления в ответе маркера. Сохраните новый маркер обновления. Он заменяет маркер обновления, который ранее использовался в запросе. Это действие помогает гарантировать, что токены обновления остаются действительными как можно дольше.

## <a name="endpoints"></a>Конечные точки

[Зарегистрированное приложение](tutorial-register-applications.md) получает токены и общается с Azure AD B2C, отправляя запросы в следующие конечные точки:

- `https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/oauth2/v2.0/authorize`
- `https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/oauth2/v2.0/token`

Токены безопасности, получаемые приложением от Azure `/authorize` AD B2C, могут поступать из конечных точек или `/token` конечных точек. Когда токены ID приобретаются из `/authorize` конечных точек, это делается с помощью [неявного потока,](implicit-flow-single-page-application.md)который часто используется для пользователей, подключающихся к веб-приложениям на основе JavaScript. Когда токены ID приобретаются из `/token` конечных точек, это делается с помощью потока кода [авторизации,](openid-connect.md#get-a-token)который сохраняет маркер скрытым от браузера.

## <a name="claims"></a>Claims

Используя Azure AD B2C, вы можете точно контролировать содержимое маркеров. Можно настроить [потоки пользователей](user-flow-overview.md) и [пользовательские политики](custom-policy-overview.md) для отправки определенных наборов пользовательских данных в требованиях, необходимых для вашего приложения. Эти претензии могут включать стандартные свойства, такие как **displayName** и **emailAddress**. С помощью этих утверждений ваши приложения могут безопасно проверять подлинность пользователей и запросов.

Претензии в токенах ID не возвращаются в каком-либо конкретном порядке. Новые требования могут быть введены в токены ID в любое время. Ваше приложение не должно нарушаться по мере введения новых требований. Вы также можете включить [пользовательские атрибуты пользователя](user-flow-custom-attributes.md) в свои претензии.

В следующей таблице перечислены утверждения, которые можно ожидать в токенах ID и токенах доступа, выпущенных Azure AD B2C.

| name | Утверждение | Пример значения | Описание |
| ---- | ----- | ------------- | ----------- |
| Аудитория | `aud` | `90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6` | Определяет целевого получателя маркера. Для Azure AD B2C аудитория является идентификатором приложения. Приложение должно проверить это значение и отклонить маркер, если оно не совпадает. Аудитория ассоциируется с ресурсом. |
| Издатель | `iss` |`https://{tenant}.b2clogin.com/775527ff-9a37-4307-8b3d-cc311f58d925/v2.0/` | Обозначает службу токенов безопасности (STS), которая создает и возвращает токен. Он также определяет каталог, в котором пользователь был проверен. Приложение должно проверить претензию эмитента, чтобы убедиться, что токен пришел из соответствующей конечной точки. |
| Время выдачи | `iat` | `1438535543` | Время выдачи маркера в виде времени эпохи. |
| Время окончания срока действия | `exp` | `1438539443` | Время окончания срока действия маркера в виде времени эпохи. Приложение должно использовать это утверждение для проверки достоверности срока службы токенов. |
| Не ранее | `nbf` | `1438535543` | Время начала срока действия маркера в виде времени эпохи. Это время обычно совпадает с временем выпуска токена. Приложение должно использовать это утверждение для проверки достоверности срока службы токенов. |
| Версия | `ver` | `1.0` | Версия маркера ID, определенная Azure AD B2C. |
| Хэш-код | `c_hash` | `SGCPtt01wxwfgnYZy2VJtQ` | Хэш кода, включенный в токен ID, только тогда, когда токен выпущен вместе с кодом авторизации OAuth 2.0. Хэш-код можно использовать для проверки подлинности кода авторизации. Для получения дополнительной информации о том, [OpenID Connect specification](https://openid.net/specs/openid-connect-core-1_0.html)как выполнить эту проверку, см.  |
| Хэш маркера доступа | `at_hash` | `SGCPtt01wxwfgnYZy2VJtQ` | Хэш токен доступа, включенный в токен ID, только тогда, когда токен выпущен вместе с токеном доступа OAuth 2.0. Его можно использовать для проверки подлинности маркера доступа. Для получения дополнительной информации о том, [OpenID Connect specification](https://openid.net/specs/openid-connect-core-1_0.html) как выполнить эту проверку, см.  |
| Специальное утверждение | `nonce` | `12345` | Nonce — это стратегия, которая используется для предотвращения атак повторного воспроизведения маркера. Приложение может указать nonce в запросе `nonce` авторизации, используя параметр запроса. Значение, привеплёное в запросе, `nonce` испускается неизмененным только в претензии только на токен ID. Эта претензия позволяет вашему приложению проверить значение в отношении значения, указанного в запросе. Приложение должно выполнить эту проверку в процессе проверки маркеров ID. |
| Тема | `sub` | `884408e1-2918-4cz0-b12d-3aa027d7563b` | Основной принцип, о котором токен утверждает информацию, например, пользователь приложения. Это значение является неизменяемым и не может быть переназначено или повторно использовано. Это значение можно использовать для безопасных проверок авторизации, например, когда маркер используется для доступа к ресурсу. По умолчанию утверждение субъекта заполняется идентификатором объекта пользователя в каталоге. |
| Ссылка на класс контекста проверки подлинности | `acr` | Неприменимо | Используется только со старыми политиками. |
| Политика инфраструктуры доверия | `tfp` | `b2c_1_signupsignin1` | Название политики, которая использовалась для приобретения маркера ID. |
| Время проверки подлинности | `auth_time` | `1438535543` | Время, в которое пользователь в последний раз вводил учетные данные, представленное в эпоху времени. Нет никакой дискриминации между тем, что аутентификация является новым ввозам, одной сессией ввода (SSO) или другим типом ввода. Это `auth_time` последний раз, когда приложение (или пользователь) инициировало попытку проверки подлинности в отношении Azure AD B2C. Метод, используемый для проверки подлинности, не дифференцирован. |
| Область | `scp` | `Read`| Разрешения, предоставленные ресурсу для токена доступа. Несколько выданных разрешений разделены пространством. |
| Авторизованная сторона | `azp` | `975251ed-e4f5-4efd-abcb-5f1a8f566ab7` | **Идентификатор приложения** клиентского приложения, инициировавшего запрос. |

## <a name="configuration"></a>Параметр Configuration

Следующие свойства используются для [управления сроками службы токенов безопасности,](configure-tokens.md) испускаемых Azure AD B2C:

- **Время существования маркера доступа и маркера идентификатора (в минутах)**. Время существования маркера носителя OAuth 2.0, используемого для получения доступа к защищенному ресурсу. Значение по умолчанию — 60 минут. Минимальный (включительно) составляет 5 минут. Максимальная (включительно) составляет 1440 минут.

- **Обновление срока службы токенов (дней)** - Максимальный период времени, до которого маркер обновления может быть использован для приобретения нового токена доступа или ID. Период времени также охватывает приобретение нового токена обновления, если ваше приложение было предоставлено `offline_access` область применения. По умолчанию — 14 дней. Минимальный (включительно) составляет один день. Максимальная (включительно) составляет 90 дней.

- **Освежите срок службы раздвижных окон (дней)** - После этого периода времени пользователь вынужден повторно аутентифицировать, независимо от срока действия последнего маркера обновления, приобретенного приложением. Он предоставляется, только если установлен переключатель **Ограничено**. Значение должно быть больше или равно значению **времени существования маркера обновления (в днях)**. Если установлен переключатель **Не ограничено**, указать конкретное значение нельзя. По умолчанию 90 дней. Минимальный (включительно) составляет один день. Максимальный (включительно) составляет 365 дней.

Если использовать свойства, которые приведены ниже, будут включены следующие варианты использования.

- Предоставление пользователю возможности находиться в мобильном приложении сколь угодно долго до тех пор, пока он активно его использует. Можно установить переключатель **Скользящее время существования маркера обновления (в днях)** в положение **Не ограничено** в свойствах потока пользователя для входа.
- Обеспечение соответствия нормам и требованиям безопасности путем задания соответствующих значений времени существования маркера доступа.

Эти параметры недоступны в потоке пользователя для сброса пароля.

## <a name="compatibility"></a>Совместимость

Следующие свойства используются для [управления совместимостью токенов:](configure-tokens.md)

- **Утверждение издателя (iss)**. Это свойство определяет клиента Azure AD B2C, выдавшего маркер. Значение по умолчанию — `https://<domain>/{B2C tenant GUID}/v2.0/`. Значение `https://<domain>/tfp/{B2C tenant GUID}/{Policy ID}/v2.0/` включает идентионные данные как для арендатора Azure AD B2C, так и для потока пользователей, который использовался в запросе маркеров. Если ваше приложение или библиотека нуждаются в Azure AD B2C, чтобы соответствовать [спецификации OpenID Connect Discovery 1.0,](https://openid.net/specs/openid-connect-discovery-1_0.html)используйте это значение.

- **Утверждение субъекта (sub)**. Это свойство определяет сущность, для которой маркер подтверждает информацию. Значение по умолчанию — **ObjectID,** который заполняет `sub` требование в маркере идентификатором объекта пользователя. Значение **Не поддерживается** только для обратной совместимости. Рекомендуется переключиться на **ObjectID,** как только вы сможете.

- **Претензия, представляющая идентификатор политики** - Это свойство определяет тип претензии, в котором заполняется имя политики, используемое в запросе маркера. Значение по умолчанию — `tfp`. Значение предусмотрено `acr` только для обратной совместимости.

## <a name="pass-through"></a>Сквозной режим

Когда начинается путешествие пользователя, Azure AD B2C получает токен доступа от поставщика идентификационных данных. Azure AD B2C использует этот маркер для извлечения сведений о пользователе. Вы [позволяете врать претензию в потоке пользователей](idp-pass-through-user-flow.md) или [определяете претензию в пользовательской политике](idp-pass-through-custom.md) для передачи токена в приложения, зарегистрированные в Azure AD B2C. Ваше приложение должно использовать [поток пользователей v2,](user-flow-versions.md) чтобы воспользоваться передачей токена в качестве претензии.

В настоящее время Azure AD B2C поддерживает только передачу маркера доступа поставщиков удостоверений OAuth 2.0, в том числе Facebook и Google. Для остальных поставщиков удостоверений утверждение возвращается пустым.

## <a name="validation"></a>Проверка

Чтобы проверить токен, приложение должно проверить как подпись, так и требования токена. Многие библиотеки с открытым исходным кодом доступны для проверки JWT, в зависимости от предпочтительного языка. Рекомендуется исследовать эти параметры, а не реализовывать собственную логику проверки.

### <a name="validate-signature"></a>Проверка подписи

JWT содержит три сегмента: *заголовок,* *тело*и *подпись.* Сегмент подписи может быть использован для проверки подлинности токена, чтобы ему можно было доверять ваше приложение. Маркеры Azure AD B2C подписываются при помощи стандартных отраслевых алгоритмов асимметричного шифрования, таких как RSA 256.

Заголовок маркера содержит сведения о ключе и методе шифрования, используемых для подписания маркера:

```
{
        "typ": "JWT",
        "alg": "RS256",
        "kid": "GvnPApfWMdLRi8PDmisFn7bprKg"
}
```

Значение **претензии alg** — это алгоритм, который использовался для подписания токена. Значение **ребенка** претензии является публичным ключом, который был использован для подписания маркера. В любой момент времени Azure AD B2C может подписать токен, используя любой из набора открытых и частных ключевых пар. Azure AD B2C периодически меняет возможный набор ключей. Ваше приложение должно быть написано для автоматического обработки этих ключевых изменений. Разумная частота проверки обновлений общедоступных ключей, используемых Azure AD B2C, проводится каждые 24 часа.

Служба Azure AD B2C имеет конечную точку метаданных OpenID Connect. Используя эту конечную точку, приложения могут запрашивать информацию о Azure AD B2C во время выполнения. Эти сведения включают конечные точки, содержимое маркеров и ключи подписи маркеров. Ваш арендатор Azure AD B2C содержит документ метаданных JSON для каждой политики. Документ метаданных является объектом JSON, содержащим важные сведения. Метаданные содержат **jwks_uri,** что дает расположение набора общедоступных ключей, которые используются для подписания токенов. Это место предоставляется здесь, но лучше получить местоположение динамически с помощью документа метаданных и разбор **аутерирования jwks_uri:**

```
https://contoso.b2clogin.com/contoso.onmicrosoft.com/discovery/v2.0/keys?p=b2c_1_signupsignin1
```
Документ JSON, расположенный по этому URL-адресу, содержит все сведения об открытых ключах, используемые в конкретный момент времени. Приложение может использовать утверждение `kid` в заголовке маркера JWT, чтобы выбрать открытый ключ в этом документе JSON, использованный для подписания определенного маркера. Затем оно может проверить подпись с использованием правильного открытого ключа и указанного алгоритма.

Документ метаданных для `B2C_1_signupsignin1` политики `contoso.onmicrosoft.com` в арендаторе расположен по адресу:

```
https://contoso.b2clogin.com/contoso.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=b2c_1_signupsignin1
```

Чтобы определить, какая политика была использована для подписания маркера (и куда идти, чтобы запросить метаданные), у вас есть два варианта. Сначала имя политики включается в утверждение `acr` маркера. Утверждения из тела маркера JWT можно проанализировать, декодировав тело маркера с помощью кодировки base-64 и десериализации полученной строки JSON. Претензия `acr` — это название политики, которая использовалась для выпуска токена. Другой вариант заключается в кодировании `state` политики в значении параметра при выдаче запроса, а затем декодировать его, чтобы определить, какая политика была использована. Каждый из этих методов является допустимым.

Описание выполнения проверки выходит за рамки этого документа. Многие библиотеки с открытым исходным кодом доступны, чтобы помочь вам проверить маркер.

### <a name="validate-claims"></a>Проверка претензий

Когда ваши приложения или API получают токен ID, он также должен выполнить несколько проверок в отношении требований в токене ID. Следует проверить следующие претензии:

- **аудитория** - Проверяет, что токен ID должен был быть предоставлен вашему приложению.
- **не до** и **срок действия** - Проверяется, что маркер ID не истек.
- **эмитент** - Проверяет, что токен был выдан вашей заявке Azure AD B2C.
- **nonce** - Стратегия смягчения атаки токенов.

Для получения полного списка валидаторов, которые должно выполнять приложение, обратитесь к [спецификации OpenID Connect.](https://openid.net)

## <a name="next-steps"></a>Дальнейшие действия

Узнайте больше о том, как [использовать маркеры доступа](access-tokens.md).

