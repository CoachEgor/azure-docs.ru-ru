---
title: Поток кода авторизации — Azure Active Directory B2C | Документация Майкрософт
description: Узнайте, как создавать веб-приложения с использованием протокола аутентификации Azure AD B2C и OpenID Connect.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 02/19/2019
ms.author: mimart
ms.subservice: B2C
ms.custom: fasttrack-edit
ms.openlocfilehash: 8248ca0abb1d633786b09b894bcd6b1089ab2d8c
ms.sourcegitcommit: bc792d0525d83f00d2329bea054ac45b2495315d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78671813"
---
# <a name="oauth-20-authorization-code-flow-in-azure-active-directory-b2c"></a>Поток кода авторизации OAuth 2.0 в Azure Active Directory B2C

Код авторизации OAuth 2.0 может использоваться в приложениях, установленных на устройстве, для получения доступа к защищенным ресурсам, таким как веб-API. С помощью реализации OAuth 2.0 в Azure Active Directory B2C можно добавить регистрацию, вход и другие задачи по управлению пользователями в мобильные и настольные приложения. Эта статья не зависит от языка. В ней описывается, как отправлять и получать сообщения HTTP, не используя ни одну из библиотек с открытым исходным кодом.

Описание потока кода авторизации OAuth 2.0 см. в [разделе 4.1 спецификации OAuth 2.0](https://tools.ietf.org/html/rfc6749). Его можно использовать для аутентификации и авторизации в большинстве [типов приложений](application-types.md), в том числе в веб-приложениях и изначально установленных приложениях. Вы можете использовать поток кода авторизации OAuth 2.0, чтобы безопасно получать маркеры доступа и маркеры обновления для приложений, с помощью которых можно получить доступ к ресурсам, защищенным [сервером авторизации](protocols-overview.md).  Маркер обновления позволяет клиенту получать новые маркеры доступа (и обновления) после истечения их срока действия (как правило, через час).

В этой статье мы сосредоточимся на потоке кода авторизации OAuth 2.0 для **открытых клиентов**. Открытый клиент — это любое клиентское приложение, которому нельзя доверять в безопасном сохранении целостности секретного пароля. К ним относятся мобильные приложения, приложения для настольных компьютеров и практически любые приложения, которые, работая на устройстве, должны получать маркеры доступа.

> [!NOTE]
> Чтобы добавить управление идентификацией в веб-приложение с помощью Azure AD B2C, используйте [OpenID Connect](openid-connect.md), а не OAuth 2.0.

В Azure AD B2C стандартные потоки OAuth 2.0 выходят за рамки простой проверки подлинности и авторизации. Он представляет собой [поток пользователя](user-flow-overview.md). Потоки пользователей дают возможность использовать OAuth 2.0 для добавления в приложение различных действий пользователя, таких как регистрация, вход и управление профилями. Поставщики удостоверений, которые используют протокол OAuth 2.0: [Amazon](identity-provider-amazon.md), [Azure Active Directory](identity-provider-azure-ad-single-tenant.md), [Facebook](identity-provider-facebook.md), [GitHub](identity-provider-github.md), [Google](identity-provider-google.md) и [LinkedIn](identity-provider-linkedin.md).

Чтобы проверить HTTP-запросы, описанные в этой статье:

1. Замените `{tenant}` именем вашего клиента Azure AD B2C.
1. Замените `90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6` ИДЕНТИФИКАТОРом приложения, которое вы ранее зарегистрировали в клиенте Azure AD B2C.
1. Замените `{policy}` именем политики, созданной в клиенте, например `b2c_1_sign_in`.

## <a name="1-get-an-authorization-code"></a>1. получение кода авторизации
Поток кода авторизации начинается с того, что клиент направляет пользователя к конечной точке `/authorize` . Это интерактивная часть потока, в которой пользователь выполняет действие. В этом запросе клиент указывает в параметре `scope` разрешения, которые ему требуется получить от пользователя. Ниже приведены три примера (переносы строк добавлены для удобства чтения), в которых используются разные потоки пользователя.


```HTTP
GET https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/{policy}/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code
&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob
&response_mode=query
&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
```


| Параметр | Обязательно? | Описание |
| --- | --- | --- |
|клиентом| Обязательно | Имя клиента Azure AD B2C|
| политик | Обязательно | Выполняемый пользователем поток. Укажите имя потока пользователей, созданного в Azure AD B2C клиенте. Например: `b2c_1_sign_in`, `b2c_1_sign_up`или `b2c_1_edit_profile`. |
| client_id |Обязательно |Идентификатор приложения, назначенный вашему приложению на [портале Azure](https://portal.azure.com). |
| response_type |Обязательно |Тип ответа, который должен содержать `code` для потока кода авторизации. |
| redirect_uri |Обязательно |URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| Область |Обязательно |Список областей с разделителями-пробелами. При указании одной области в Azure Active Directory (Azure AD) также обозначаются запрашиваемые разрешения. Использование идентификатора клиента в качестве области указывает на то, что приложению нужен маркер доступа, который может использоваться в вашей службе или веб-API, представленных таким же идентификатором клиента.  Область `offline_access` означает, что вашему приложению потребуется маркер обновления для продолжительного доступа к ресурсам. Вы также можете использовать область `openid` для запроса идентификатора маркера из Azure AD B2C. |
| response_mode |Рекомендуемая |Метод, используемый для отправки полученного кода авторизации приложению. Он может иметь значение `query`, `form_post` или `fragment`. |
| state |Рекомендуемая |Значение, включенное в запрос, может содержать строку или любое содержимое на ваше усмотрение. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Этот параметр также включает информацию о состоянии пользователя в приложении перед созданием запроса на проверку подлинности. Например, об открытой пользователем в тот момент странице или выполняемом потоке пользователя. |
| prompt |Необязательно |Требуемый тип взаимодействия с пользователем. Сейчас единственное допустимое значение — это `login`, при котором пользователю приходится вводить учетные данные по запросу. Единый вход не сработает. |

На этом этапе пользователю предлагается выполнить рабочий процесс потока пользователя. Для этого могут потребоваться ввод имени пользователя и пароля, вход с помощью удостоверения социальной сети, регистрация в каталоге или любые другие шаги. Действия пользователя зависят от того, как определен его поток.

Когда пользователь завершит свой поток, служба Azure AD отправит в приложение ответ, используя указанное для `redirect_uri` значение. Она использует метод, указанный в параметре `response_mode`. Какие бы действия пользователь ни выполнял и каким бы ни был его поток, ответ всегда будет одинаковым.

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```HTTP
GET urn:ietf:wg:oauth:2.0:oob?
code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...        // the authorization_code, truncated
&state=arbitrary_data_you_can_receive_in_the_response                // the value provided in the request
```

| Параметр | Описание |
| --- | --- |
| код |Запрашиваемый приложением код авторизации. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Срок действия кодов авторизации крайне мал. и обычно истекает по прошествии порядка 10 минут. |
| state |Полное описание см. в таблице выше. Если запрос содержит параметр `state`, то в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра `state` в запросе и ответе. |

Сообщения об ошибках также можно отправлять на универсальный код ресурса (URI) перенаправления, чтобы приложение могло их правильно обработать:

```HTTP
GET urn:ietf:wg:oauth:2.0:oob?
error=access_denied
&error_description=The+user+has+cancelled+entering+self-asserted+information
&state=arbitrary_data_you_can_receive_in_the_response
```

| Параметр | Описание |
| --- | --- |
| ошибка |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |
| state |См. полное описание в предыдущей таблице. Если запрос содержит параметр `state`, то в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра `state` в запросе и ответе. |

## <a name="2-get-a-token"></a>2. получение маркера
После получения кода авторизации можно использовать `code`, чтобы получить маркер для целевого ресурса путем отправки запроса POST на конечную точку `/token`. В Azure AD B2C можно [запросить маркеры доступа для других API](access-tokens.md#request-a-token) как обычно, указав их области (в запросе).

Вы также можете запросить маркер доступа для собственного серверного веб-API в соответствии с соглашением об использовании идентификатора клиента приложения в качестве запрошенной области (что приведет к маркеру доступа с таким ИДЕНТИФИКАТОРом клиента, как "аудитория"):

```HTTP
POST https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/{policy}/oauth2/v2.0/token HTTP/1.1

Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&redirect_uri=urn:ietf:wg:oauth:2.0:oob

```

| Параметр | Обязательно? | Описание |
| --- | --- | --- |
|клиентом| Обязательно | Имя клиента Azure AD B2C|
|политик| Обязательно| Поток пользователя, который использовался для получения кода авторизации. Другой поток пользователя в этом запросе использовать нельзя. |
| client_id |Обязательно |Идентификатор приложения, назначенный вашему приложению на [портале Azure](https://portal.azure.com).|
| client_secret | Да, в веб-приложениях | Секрет приложения, созданный в [портал Azure](https://portal.azure.com/). Секреты клиента используются в этом потоке для сценариев веб-приложений, где клиент может безопасно хранить секрет клиента. Для сценариев собственного приложения (общедоступного клиента) секретность клиента не может быть безопасно сохранена и, следовательно, не используется в этом вызове. Если вы используете секрет клиента, измените его на периодической основе. |
| grant_type |Обязательно |Тип предоставления. Для потока кода авторизации это должен быть тип `authorization_code`. |
| Область |Рекомендуемая |Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Использование идентификатора клиента в качестве области указывает на то, что приложению нужен маркер доступа, который может использоваться в вашей службе или веб-API, представленных таким же идентификатором клиента.  Область `offline_access` означает, что вашему приложению потребуется маркер обновления для продолжительного доступа к ресурсам.  Вы также можете использовать область `openid` для запроса идентификатора маркера из Azure AD B2C. |
| код |Обязательно |Код авторизации, полученный на первом участке потока. |
| redirect_uri |Обязательно |URI перенаправления приложения, в котором вы получили код авторизации. |

Успешный ответ маркера выглядит следующим образом:

```JSON
{
    "not_before": "1442340812",
    "token_type": "Bearer",
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "scope": "90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access",
    "expires_in": "3600",
    "refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
}
```
| Параметр | Описание |
| --- | --- |
| not_before |Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token_type |Значение типа маркера. Единственный тип, поддерживаемый Azure AD — носитель. |
| access_token |Подписанный маркер JSON Web Token (JWT), который вы запрашивали. |
| Область |Области, для которых действителен маркер. Области также можно использовать, чтобы кэшировать маркеры для последующего использования. |
| expires_in |Срок действия маркера (в секундах). |
| refresh_token |Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров по истечении срока действия текущего маркера. Маркеры обновления имеют большой срок действия. Их можно использовать для длительного сохранения доступа к ресурсам. Дополнительные сведения см. в статье [Azure AD B2C: справочник по маркерам](tokens-overview.md). |

Сообщения об ошибках выглядят следующим образом:

```JSON
{
    "error": "access_denied",
    "error_description": "The user revoked access to the app.",
}
```

| Параметр | Описание |
| --- | --- |
| ошибка |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |

## <a name="3-use-the-token"></a>3. Использование токена
После успешного получения маркера доступа маркер можно использовать в запросах к веб-API серверной части приложения путем включения маркера в заголовок `Authorization`:

```HTTP
GET /tasks
Host: mytaskwebapi.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

## <a name="4-refresh-the-token"></a>4. Обновите токен
Срок действия маркеров доступа и маркеров идентификации крайне мал. Для сохранения доступа к ресурсам маркеры с истекшим сроком действия необходимо обновлять. Для этого нужно отправить еще один запрос POST в конечную точку `/token`, указав `refresh_token` вместо `code`:

```HTTP
POST https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/{policy}/oauth2/v2.0/token HTTP/1.1

Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access&refresh_token=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&redirect_uri=urn:ietf:wg:oauth:2.0:oob
```

| Параметр | Обязательно? | Описание |
| --- | --- | --- |
|клиентом| Обязательно | Имя клиента Azure AD B2C|
|политик |Обязательно |Поток пользователя, который использовался для получения исходного маркера обновления. Другой поток пользователя в этом запросе использовать нельзя. |
| client_id |Обязательно |Идентификатор приложения, назначенный вашему приложению на [портале Azure](https://portal.azure.com). |
| client_secret | Да, в веб-приложениях | Секрет приложения, созданный в [портал Azure](https://portal.azure.com/). Секреты клиента используются в этом потоке для сценариев веб-приложений, где клиент может безопасно хранить секрет клиента. Для сценариев собственного приложения (общедоступного клиента) секретность клиента не может быть безопасно сохранена и, следовательно, не используется в этом вызове. Если вы используете секрет клиента, измените его на периодической основе. |
| grant_type |Обязательно |Тип предоставления. Для этого участка потока кода авторизации это должен быть тип `refresh_token`. |
| Область |Рекомендуемая |Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Использование идентификатора клиента в качестве области указывает на то, что приложению нужен маркер доступа, который может использоваться в вашей службе или веб-API, представленных таким же идентификатором клиента.  Область `offline_access` означает, что вашему приложению потребуется маркер обновления для продолжительного доступа к ресурсам.  Вы также можете использовать область `openid` для запроса идентификатора маркера из Azure AD B2C. |
| redirect_uri |Необязательно |URI перенаправления приложения, в котором вы получили код авторизации. |
| refresh_token |Обязательно |Исходный маркер обновления, полученный на втором участке потока. |

Успешный ответ маркера выглядит следующим образом:

```JSON
{
    "not_before": "1442340812",
    "token_type": "Bearer",
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "scope": "90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access",
    "expires_in": "3600",
    "refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
}
```
| Параметр | Описание |
| --- | --- |
| not_before |Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token_type |Значение типа маркера. Единственный тип, поддерживаемый Azure AD — носитель. |
| access_token |Подписанный маркер JWT, который вы запрашивали. |
| Область |Области, для которых действителен маркер. Области также можно использовать, чтобы кэшировать маркеры для последующего использования. |
| expires_in |Срок действия маркера (в секундах). |
| refresh_token |Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров по истечении срока действия текущего маркера. У маркеров обновления длительный срок действия. Их можно использовать, чтобы надолго сохранять доступ к ресурсам. Дополнительные сведения см. в статье [Azure AD B2C: справочник по маркерам](tokens-overview.md). |

Сообщения об ошибках выглядят следующим образом:

```JSON
{
    "error": "access_denied",
    "error_description": "The user revoked access to the app.",
}
```

| Параметр | Описание |
| --- | --- |
| ошибка |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |

## <a name="use-your-own-azure-ad-b2c-directory"></a>Использование собственного каталога Azure AD B2C
Чтобы отправить эти запросы самостоятельно, выполните следующие действия. Замените значения, приведенные в этой статье в качестве примера, собственными.

1. [Создайте каталог Azure AD B2C](tutorial-create-tenant.md). Используйте имя своего каталога в запросах.
2. [Создайте приложение](tutorial-register-applications.md) для получения идентификатора приложения и URI перенаправления. Включите собственный клиент в приложение.
3. [Создайте собственные потоки пользователя](user-flow-overview.md) и получите их имена.
