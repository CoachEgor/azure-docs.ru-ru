---
title: Порядок использования автоподготовки в службе подготовки устройств к добавлению в Центр Интернета вещей для регистрации MXChip IoT DevKit в Центре Интернета вещей | Документация Майкрософт
description: Порядок использования автоподготовки в службе подготовки устройств к добавлению в Центр Интернета вещей для регистрации MXChip IoT DevKit в Центре Интернета вещей.
author: liydu
ms.author: liydu
ms.date: 06/25/2019
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
manager: jeffya
ms.openlocfilehash: b1aac19885e2b640063e4840f047916ad51e9656
ms.sourcegitcommit: 670c38d85ef97bf236b45850fd4750e3b98c8899
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/08/2019
ms.locfileid: "68855745"
---
# <a name="use-azure-iot-hub-device-provisioning-service-auto-provisioning-to-register-the-mxchip-iot-devkit-with-iot-hub"></a>Использование автоподготовки в службе подготовки устройств к добавлению в Центр Интернета вещей Azure для регистрации MXChip IoT DevKit в Центре Интернета вещей

В этой статье описывается порядок использования [автоподготовки](concepts-auto-provisioning.md) в службе подготовки устройств к добавлению в Центр Интернета вещей Azure для регистрации MXChip IoT DevKit в Центре Интернета вещей. Из этого руководства вы узнаете, как выполнять следующие задачи:

* настройка глобальной конечной точки службы подготовки устройств на устройстве;
* создание сертификата X.509 с помощью уникального секрета устройства (UDS);
* регистрация отдельного устройства;
* проверка устройства на наличие регистрации.

[MXChip IoT DevKit](https://aka.ms/iot-devkit) — это универсальная совместимая с Arduino плата со множеством периферийных устройств и датчиков. Решения для нее можно разрабатывать с помощью [Azure IoT Device Workbench](https://aka.ms/iot-workbench) или пакета расширений [Инструменты Azure IoT](https://aka.ms/azure-iot-tools) в Visual Studio Code. DevKit предоставляется с расширяющимся [каталогом проектов](https://microsoft.github.io/azure-iot-developer-kit/docs/projects/), чтобы помочь вам выполнить прототипирование решений Интернета вещей, использующих службы Azure.

## <a name="before-you-begin"></a>Перед началом работы

Для работы с этим руководством сначала следует выполнить следующие задачи:

* Настройте Wi-Fi для DevKit и подготовьте среду разработки, следуя указаниям в разделе "Подготовка среды разработки" статьи [Подключение к центру Интернета вещей Azure AZ3166](/azure/iot-hub/iot-hub-arduino-iot-devkit-az3166-get-started#prepare-the-development-environment)в облаке.
* Обновите новейшее встроенное ПО до версии 1.3.0 или более новой, воспользовавшись руководством по [обновлению встроенного ПО DevKit](https://microsoft.github.io/azure-iot-developer-kit/docs/firmware-upgrading/).
* Создайте и свяжите Центр Интернета вещей с экземпляром службы подготовки устройств, следуя шагам из руководства [Настройка службы подготовки устройств для Центра Интернета вещей на портале Azure](/azure/iot-dps/quick-setup-auto-provision).

## <a name="open-sample-project"></a>Открытие примера проекта

1. Убедитесь, что плата IoT DevKit **не подключена** к компьютеру. Сначала запустите VS Code, а затем подключите плату DevKit к компьютеру.

1. Щелкните `F1`, чтобы открыть палитру команд, затем введите и выберите **Azure IoT Device Workbench. Открыть примеры...** Затем выберите **IoT DevKit** в качестве платы.

1. На странице с примерами IoT Workbench найдите **Регистрация устройства в DPS** и щелкните **Открыть пример**. Затем выберите путь по умолчанию, чтобы загрузить пример кода.
    ![Открытие примера](media/how-to-connect-mxchip-iot-devkit/open-sample.png)

## <a name="save-a-unique-device-secret-on-device-security-storage"></a>Сохранение уникального секрета устройства в хранилище безопасности устройства

Автоматическая подготовка может быть настроена на устройстве с учетом предусмотренного на нем [механизма аттестации](concepts-security.md#attestation-mechanism). MXChip IoT DevKit использует [обработчик композиций для удостоверения устройств](https://trustedcomputinggroup.org/wp-content/uploads/Foundational-Trust-for-IOT-and-Resource-Constrained-Devices.pdf) от [организации TCG](https://trustedcomputinggroup.org). **Уникальный секрет устройства**, хранимый в микросхеме обеспечения безопасности STSAFE ([STSAFE-A100](https://microsoft.github.io/azure-iot-developer-kit/docs/understand-security-chip/)) в DevKit, используется для генерации уникального сертификата устройства [X.509](concepts-security.md#x509-certificates). Сертификат используется далее при регистрации в службе подготовки устройств, а также для регистрации в среде выполнения.

Как указано в следующем примере, типичным уникальным секретом устройства является 64-символьная строка.

```
19e25a259d0c2be03a02d416c05c48ccd0cc7d1743458aae1cb488b074993eae
```

Чтобы сохранить уникальный секрет устройства в DevKit

1. В VS Code щелкните строку состояния, чтобы выбрать COM-порт для DevKit.
  ![Выберите COM-порт](media/how-to-connect-mxchip-iot-devkit/select-com.png)

1. В DevKit удерживайте нажатой **кнопку A**, нажмите и отпустите кнопку **Reset** (Сброс), а затем отпустите **кнопку А**. DevKit переходит в режим настройки.

1. Щелкните `F1`, чтобы открыть палитру команд, затем введите и выберите **Azure IoT Device Workbench. Настройка параметров устройства… > Настройка уникальной строки устройства (UDS)** .
  ![Настройте UDS](media/how-to-connect-mxchip-iot-devkit/config-uds.png)

1. Запишите созданную строку уникального секрета устройства. Она понадобится для создания сертификата X.509. Затем нажмите `Enter`.
  ![Скопируйте UDS](media/how-to-connect-mxchip-iot-devkit/copy-uds.png)

1. Подтвердите в уведомлении, что UDS на STSAFE успешно настроен.
  ![Успех настройки UDS](media/how-to-connect-mxchip-iot-devkit/config-uds-success.png)

> [!NOTE]
> Кроме того, уникальный секрет устройства можно настроить через последовательный порт с помощью служебных программ, например Putty. Воспользуйтесь для этого разделом [Использование режима конфигурации](https://microsoft.github.io/azure-iot-developer-kit/docs/use-configuration-mode/).

## <a name="update-the-global-device-endpoint-and-id-scope"></a>Обновление глобальной конечной точки устройства и области идентификаторов

В коде устройства необходимо указать [конечную точку подготовки устройства](/azure/iot-dps/concepts-service#device-provisioning-endpoint) и область идентификаторов, чтобы обеспечить изоляцию клиента.

1. На портале Azure выберите панель **Обзор** службы подготовки устройств и запишите значения **глобальной конечной точки устройства** и **области идентификатора**.
  ![Глобальная конечная точка Службы подготовки устройств и область идентификатора](media/how-to-connect-mxchip-iot-devkit/dps-global-endpoint.png)

1. Откройте файл **DevKitDPS.ino**. Найдите и замените значения `[Global Device Endpoint]` и `[ID Scope]` значениями, которые вы только что записали.
  ![Конечная точка службы подготовки устройств](media/how-to-connect-mxchip-iot-devkit/endpoint.png)

1. Заполните переменную `registrationId` в коде. Допускаются только буквенно-цифровые символы, строчные буквы, и дефисы, не более 128 символов. Также запишите и это значение.
  ![Идентификатор регистрации](media/how-to-connect-mxchip-iot-devkit/registration-id.png).

1. Щелкните `F1`, введите и выберите **Azure IoT Device Workbench. Отправка кода устройства**. Система запускает компиляцию и отправку кода в DevKit.
  ![Отправка на устройство](media/how-to-connect-mxchip-iot-devkit/device-upload.png)

## <a name="generate-x509-certificate"></a>Создание сертификата X.509

[Механизма аттестации](/azure/iot-dps/concepts-device#attestation-mechanism), используемый в этом примере, — сертификат X.509. Необходимо использовать программу для его создания.

> [!NOTE]
> Генератор сертификатов X.509 сейчас поддерживает только Windows.

1. В VS Code щелкните `F1`, введите и выберите **Открыть новый терминал**, чтобы открыть окно терминала.

1. Запустите `dps_cert_gen.exe` в папке `tool`.

1. Укажите расположение скомпилированного двоичного файла как `..\.build\DevKitDPS`. Затем вставьте **UDS** и **registrationId**, которые вы только что записали. 
  ![Создание X.509](media/how-to-connect-mxchip-iot-devkit/gen-x509.png)

1. Сертификат X.509 `.pem` создается в той же папке.
  ![Файл X.509](media/how-to-connect-mxchip-iot-devkit/pem-file.png)

## <a name="create-a-device-enrollment-entry"></a>Создание записи о регистрации устройства

1. На портале Azure откройте службу подготовки устройств, перейдите к разделу управления регистрациями и нажмите кнопку **Добавить отдельную регистрацию**.
  ![Добавить индивидуальную регистрацию](media/how-to-connect-mxchip-iot-devkit/add-enrollment.png)

1. Щелкните значок рядом с полем **PEM-файл или CER-файл первичного сертификата** для отправки созданного файла `.pem`.
  ![Отправка PEM-файла](media/how-to-connect-mxchip-iot-devkit/upload-pem.png)

## <a name="verify-the-devkit-is-registered-with-azure-iot-hub"></a>Убедитесь, что DevKit зарегистрирован в центре Интернета вещей Azure

Нажмите кнопку **Reset** (Сброс) на DevKit. Вы должны увидеть запись **DPS подключен!** на экране устройства DevKit. После перезагрузки устройства выполняются следующие действия.

1. Устройство отправляет запрос на регистрацию в службу подготовки устройств.
1. Служба подготовки устройств отправляет обратный запрос регистрации, на который отвечает устройство.
1. При успешной регистрации служба подготовки устройств отправляет обратно к устройству универсальный код ресурса Центра Интернета вещей, идентификатор устройства и зашифрованный ключ.
1. Клиентское приложение Центра Интернета вещей на устройстве подключается к центру.
1. При успешном подключении к центру устройство отобразится в средстве Device Explorer Центра Интернета вещей.
  ![Устройство зарегистрировано](./media/how-to-connect-mxchip-iot-devkit/device-registered.png)

## <a name="problems-and-feedback"></a>Проблемы и обратная связь

Если вы столкнулись с проблемами, ознакомьтесь с [часто задаваемыми вопросами](https://microsoft.github.io/azure-iot-developer-kit/docs/faq/) об IoT DevKit или войдите в один из таких каналов, чтобы получить поддержку.

* [Gitter.im](https://gitter.im/Microsoft/azure-iot-developer-kit)
* [Stack Overflow](https://stackoverflow.com/questions/tagged/iot-devkit)

## <a name="next-steps"></a>Следующие шаги

Из этого руководства вы узнали, как безопасно зарегистрировать устройство в Службе подготовки устройств с помощью обработчика композиций для удостоверения устройств, после чего устройство может автоматически зарегистрироваться в Центре Интернета вещей Azure. 

Таким образом, вы научились выполнять такие задачи:

> [!div class="checklist"]
> * настройка глобальной конечной точки службы подготовки устройств на устройстве;
> * создание сертификата X.509 с помощью уникального секрета устройства;
> * регистрация отдельного устройства;
> * проверка устройства на наличие регистрации.

Дополнительные сведения см. в статье [Создание и подготовка имитированного устройства доверенного платформенного модуля (ТРМ) с помощью пакета SDK для устройства C для службы подготовки устройств Центра Интернета вещей](./quick-create-simulated-device.md).

