---
title: Использование различных механизмов аттестации с клиентским пакетом SDK службы подготовки устройств для центра Интернета вещей Azure
description: Использование различных механизмов аттестации с клиентским пакетом SDK для службы подготовки устройств (DPS) в Azure
author: wesmc7777
ms.author: wesmc
ms.date: 03/30/2018
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
ms.custom:
- mvc
- amqp
ms.openlocfilehash: 0a32e2f055b2914fa0008e043e80092ac2da0814
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "90531514"
---
# <a name="how-to-use-different-attestation-mechanisms-with-device-provisioning-service-client-sdk-for-c"></a>Использование разных механизмов аттестации с клиентским пакетом SDK для службы подготовки устройств в Azure для С

В этой статье объясняется, как использовать разные [механизмы аттестации](concepts-service.md#attestation-mechanism) с помощью клиентского пакета SDK для C для службы подготовки устройств. Вы можете использовать физическое устройство или симулятор. Служба подготовки поддерживает два режима аутентификации для механизмов аттестации двух типов: X.509 и доверенный платформенный модуль (TPM).

## <a name="prerequisites"></a>Предварительные требования

Подготовьте среду разработки в соответствии с инструкциями в разделе "Подготовка среды разработки" руководства по [созданию и подготовке имитированного устройства](./quick-create-simulated-device.md).

### <a name="choose-an-attestation-mechanism"></a>Выбор механизма аттестации

Производителю устройства прежде всего необходимо выбрать механизм аттестации с учетом одного из поддерживаемых типов. Сейчас [клиентский пакет SDK для C для службы подготовки устройств](https://github.com/Azure/azure-iot-sdk-c/tree/master/provisioning_client) поддерживает следующие механизмы аттестации: 

- [Доверенный платформенный модуль (TPM)](https://en.wikipedia.org/wiki/Trusted_Platform_Module) является установленным стандартом для большинства платформ устройств на базе Windows, а также некоторых устройств на базе Linux и Ubuntu. Изготовитель устройства может выбрать этот механизм аттестации, если на устройствах установлены какие-либо из этих операционных систем, и вы ищете установленную версию Standard. С микросхемами доверенного платформенного модуля (TPM) можно только регистрировать каждое устройство отдельно в службе подготовки устройств. В целях разработки можно использовать симулятор доверенного платформенного модуля на компьютере разработки Windows или Linux.

- [X.509](https://cryptography.io/en/latest/x509/): сертификаты X.509, могут храниться в относительно новых микросхемах, которые называются [аппаратными модулями безопасности (HSM)](concepts-service.md#hardware-security-module). Корпорация Майкрософт также работает над микросхемами RIoT и DICE, в которых реализуются сертификаты X.509. С помощью микросхем X.509 можно выполнять массовую регистрацию устройств на портале. Они также поддерживают некоторые операционные системы, отличные от Windows, такие как embedOS. В целях разработки клиентский пакет SDK службы подготовки устройств поддерживает симулятор устройств X.509. 

Дополнительные сведения см. в статье [механизмы аттестации](concepts-service.md#attestation-mechanism)службы подготовки устройств к добавлению в центр Интернета вещей.

## <a name="enable-authentication-for-supported-attestation-mechanisms"></a>Включение аутентификации для поддерживаемых механизмов аттестации

Перед регистрацией на портале Azure для физического устройства или симулятора нужно включить режим аутентификации пакета SDK (X.509 или TPM). Сначала перейдите в корневую папку для azure-iot-sdk-c. Затем выполните указанную команду в соответствии с выбранным режимом аутентификации.

### <a name="use-x509-with-simulator"></a>Использование X.509 с симулятором

Служба подготовки поставляется с эмулятором механизма композиции удостоверений устройств (КОСТей), который создает сертификат **X. 509** для проверки подлинности устройства. Чтобы включить проверку подлинности **X. 509** , выполните следующую команду: 

```
cmake -Ddps_auth_type=x509 ..
```

Сведения, касающиеся оборудования с DICE, можно найти [здесь](https://azure.microsoft.com/blog/azure-iot-supports-new-security-hardware-to-strengthen-iot-security/).

### <a name="use-x509-with-hardware"></a>Использование X.509 с оборудованием

Службу подготовки можно использовать с **X. 509** на другом оборудовании. Для обмена данными между оборудованием и пакетом SDK требуется интерфейс. Сведения об интерфейсе можно получить у производителя HSM.

### <a name="use-tpm"></a>Использование TPM

Служба подготовки может подключаться к микросхемам TPM оборудования Windows и Linux с использованием маркера SAS. Чтобы включить аутентификацию TPM, выполните следующую команду:

```
cmake -Ddps_auth_type=tpm ..
```

### <a name="use-tpm-with-simulator"></a>Использование TPM с симулятором

Если у вас нет устройства с микросхемами TPM, можно использовать симулятор для разработки в ОС Windows. Чтобы включить аутентификацию TPM и запустить симулятор TPM, выполните следующую команду:

```
cmake -Ddps_auth_type=tpm_simulator ..
```

## <a name="build-the-sdk"></a>Сборка пакета SDK
Перед регистрацией устройства выполните сборку пакета SDK.

### <a name="linux"></a>Linux
- Вот как выполнить сборку SDK в Linux:
    ```
    cd azure-iot-sdk-c
    mkdir cmake
    cd cmake
    cmake ..
    cmake --build .  # append '-- -j <n>' to run <n> jobs in parallel
    ```
- Чтобы создать двоичные файлы отладки, добавьте соответствующий параметр CMake в команду создания проекта, например:
    ```
    cmake -DCMAKE_BUILD_TYPE=Debug ..
    ```

- Существует множество [параметров конфигурации CMAK](https://cmake.org/cmake/help/v3.6/manual/cmake.1.html) , доступных для создания пакета SDK. Например, можно отключить один из доступных стеков протоколов, добавив аргумент в команду создания проекта CMake:
    ```
    cmake -Duse_amqp=OFF ..
    ```
- Кроме того, можно создать и запустить модульный тест:
    ```
    cmake -Drun_unittests=ON ..
    cmake --build .
    ctest -C "debug" -V
    ```

### <a name="windows"></a>Windows
- Чтобы выполнить сборку пакета SDK в Windows, следуйте инструкциям по созданию файлов проекта ниже:
  - Откройте командную строку разработчика для VS2015.
  - Выполните следующие команды CMake из корня репозитория:
    ```
    cd azure-iot-sdk-c
    mkdir cmake
    cd cmake
    cmake -G "Visual Studio 14 2015" ..
    ```
    Эта команда отвечает за создание библиотек x86. Для создания x64 измените аргумент генератора cmake: 
    ```
    cmake .. -G "Visual Studio 14 2015 Win64"
    ```

- После успешного создания проекта в папке `cmake` появится файл решения Visual Studio (.sln). Чтобы создать пакет SDK,
    - откройте **cmake\azure_iot_sdks.sln** в Visual Studio и выполните сборку **ИЛИ**
    - выполните следующую команду в командной строке, которая использовалась для создания файлов проекта:
      ```
      cmake --build . -- /m /p:Configuration=Release
      ```
- Чтобы выполнить сборку двоичных файлов отладки, используйте соответствующий аргумент MSBuild: 
    ```
    cmake --build . -- /m /p:Configuration=Debug`
    ```
- Для создания пакета SDK доступны разные варианты конфигурации CMake. Например, можно отключить один из доступных стеков протоколов, добавив аргумент в команду создания проекта CMake:
    ```
    cmake -G "Visual Studio 14 2015" -Duse_amqp=OFF ..
    ```
- Кроме того, можно создать и запустить модульные тесты:
    ```
    cmake -G "Visual Studio 14 2015" -Drun_unittests=ON ..
    cmake --build . -- /m /p:Configuration=Debug
    ctest -C "debug" -V
    ```
  
### <a name="libraries-to-include"></a>Библиотеки, которые необходимо включить
- В пакет SDK требуется включить следующие библиотеки:
    - служба подготовки — dps_http_transport dps_client, dps_security_client;
    - безопасность Центра Интернета вещей — iothub_security_client.

## <a name="create-a-device-enrollment-entry-in-device-provisioning-services"></a>Создание записи регистрации устройства в службе подготовки устройств

### <a name="tpm"></a>TPM (Доверенный платформенный модуль)
Если вы используете TPM, следуйте инструкциям из статьи [Создание и подготовка имитированного устройства доверенного платформенного модуля (ТРМ) с помощью пакета SDK для устройства C для службы подготовки устройств Центра Интернета вещей](./quick-create-simulated-device.md), чтобы создать запись регистрации устройств в службе подготовки устройств и смоделировать первую загрузку.

### <a name="x509"></a>X.509

1. Чтобы зарегистрировать устройство в службе подготовки, запишите ключ подтверждения и идентификатор регистрации для каждого устройства, которое отображается в средстве подготовки клиентского пакета SDK. Выполните следующую команду, чтобы распечатать сертификат корневого ЦС (для групп регистрации) и конечный сертификат подписавшего (для отдельной регистрации):
      ```
      ./azure-iot-sdk-c/dps_client/tools/x509_device_provision/x509_device_provision.exe
      ```
2. Войдите на портал Azure, нажмите кнопку **Все ресурсы** в меню слева и откройте службу подготовки устройств.
   - **Отдельная регистрация X. 509**. в колонке сводки службы подготовки выберите **Управление регистрациями**. Выберите вкладку **индивидуальные регистрации** и нажмите кнопку **Добавить** вверху. Выберите **X. 509** в качестве *механизма*аттестации удостоверений, отправьте конечный сертификат в соответствии с требованиями колонки. Затем нажмите кнопку **Сохранить**. 
   - **Регистрация группы X. 509**: в колонке сводки службы подготовки выберите **Управление регистрациями**. Выберите вкладку **Групповые регистрации** и нажмите кнопку **Добавить** вверху. Выберите в качестве *механизма*аттестации удостоверений **X. 509** , введите имя группы и имя сертификации, а затем отправьте сертификат или промежуточный ЦС в соответствии с требованиями колонки. Затем нажмите кнопку **Сохранить**. 

## <a name="enable-authentication-for-devices-using-a-custom-attestation-mechanism-optional"></a>Включение аутентификации для устройств с помощью пользовательских механизмов аттестации (необязательно)

> [!NOTE]
> Этот раздел применим только для устройств, которым требуется поддержка пользовательских платформ или механизмов аттестации, которая не предоставляется клиентским пакетом SDK для службы подготовки устройств для С. Кроме того, для пакета SDK в качестве замены термина "механизм аттестации" часто используется термин "HSM".

Сначала необходимо разработать репозиторий и библиотеку для пользовательского механизма аттестации:

1. Разработайте библиотеку для доступа к механизму аттестации. Для этого проекта необходимо создать статическую библиотеку пакета SDK для подготовки устройств.

2. Библиотека должна реализовывать функции, определенные в следующем файле заголовка: 

    - Для пользовательского доверенного платформенного модуля: реализуйте функции, определенные в разделе [HSM TPM API](https://github.com/Azure/azure-iot-sdk-c/blob/master/provisioning_client/devdoc/using_custom_hsm.md#hsm-tpm-api).  
    - Для пользовательского сертификата X.509: реализуйте функции, определенные в разделе [HSM X.509 API](https://github.com/Azure/azure-iot-sdk-c/blob/master/provisioning_client/devdoc/using_custom_hsm.md#hsm-x509-api). 

Созданную библиотеку нужно интегрировать (связать) с клиентским пакетом SDK для службы подготовки устройств. :

1. Укажите пользовательский репозиторий GitHub и библиотеку в команде `cmake`:
    ```cmd/sh
    cmake -Duse_prov_client:BOOL=ON -Dhsm_custom_lib=<path_and_name_of_library> <PATH_TO_AZURE_IOT_SDK>
    ```
   
2. Откройте файл решения Visual Studio, созданный с помощью CMake (`\azure-iot-sdk-c\cmake\azure_iot_sdks.sln`), и выполните его сборку. 

    - В ходе сборки будет скомпилирована библиотека пакета SDK.
    - Пакет SDK попытается связать пользовательскую библиотеку, определенную в команде `cmake`.

3. Чтобы проверить правильность реализации пользовательского механизма аттестации, запустите пример приложения prov_dev_client_ll_sample в папке Provision_Samples (`\azure-iot-sdk-c\cmake\provisioning_client\samples\prov_dev_client_ll_sample`).

## <a name="connecting-to-iot-hub-after-provisioning"></a>Подключение к Центру Интернета вещей после подготовки

После подготовки устройства с помощью службы подготовки этот API использует указанный режим проверки подлинности (**X. 509** или доверенный платформенный модуль) для подключения к центру Интернета вещей: 
  ```
  IOTHUB_CLIENT_LL_HANDLE handle = IoTHubClient_LL_CreateFromDeviceAuth(iothub_uri, device_id, iothub_transport);
  ```
