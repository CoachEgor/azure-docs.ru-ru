---
title: 'Azure AD Connect выполняет следующие функции: Перенос из федерации PHS для Azure AD | Документация Майкрософт'
description: В этой статье представлены сведения о переводе среды гибридных удостоверений с федеративной аутентификации на синхронизацию хэша паролей.
services: active-directory
author: billmath
manager: daveba
ms.reviewer: martincoetzer
ms.service: active-directory
ms.workload: identity
ms.topic: article
ms.date: 05/31/2019
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 9ce9c0c6d4f9002b061afd2ad09f02266d452979
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67109261"
---
# <a name="migrate-from-federation-to-password-hash-synchronization-for-azure-active-directory"></a>Переход с федеративной аутентификации на синхронизацию хэша паролей для Azure Active Directory

В этой статье описывается перевод доменов организации с использования служб федерации Active Directory (AD FS) на синхронизацию хэша паролей.

Вы можете [скачать эту статью](https://aka.ms/ADFSTOPHSDPDownload).

## <a name="prerequisites-for-migrating-to-password-hash-synchronization"></a>Предварительные требования для перехода на синхронизацию хэша паролей

Ниже описаны предварительные требования, необходимые для перехода с использования AD FS на синхронизацию хэша паролей.

### <a name="update-azure-ad-connect"></a>Обновление Azure AD Connect

Как минимум для успешного перехода на синхронизацию хэша паролей требуется [Azure AD Connect](https://www.microsoft.com/download/details.aspx?id=47594) 1.1.819.0. Эта версия содержит значительные изменения в способе преобразования процессов входа, что может сократить общее время перехода с федеративной на облачную аутентификацию с часов до минут.


> [!IMPORTANT]
> В устаревшей документации, инструментах и блогах может быть указано, что при преобразовании федеративных в управляемые необходимо преобразование пользователей обязательно. Сейчас *преобразование пользователей* больше не требуется. Корпорация Майкрософт работает над тем, чтобы отразить это изменение в документации и инструментах.

Чтобы обновить Azure AD Connect, выполните шаги, описанные в статье [Azure AD Connect: обновление до последней версии](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-upgrade-previous-version).

### <a name="password-hash-synchronization-required-permissions"></a>Необходимые разрешения для синхронизации хэша паролей

Вы можете настроить Azure AD Connect с помощью стандартных параметров или выборочной установки. Если вы использовали выборочную установку, то [необходимые разрешения](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-accounts-permissions) для синхронизации хэша паролей могут отсутствовать.

Учетной записи доменных служб Active Directory (AD DS) в Azure AD Connect требуются приведенные ниже разрешения, чтобы использовать синхронизацию хэша паролей:

* Репликация изменений каталога
* Репликация всех изменений каталога

Самое время проверить наличие этих разрешений для всех доменов в лесу.

### <a name="plan-the-migration-method"></a>Планирование метода переноса

Вы можете выбрать один из двух методов перехода с управления федеративными удостоверениями на синхронизацию хэша паролей и простой единый вход. Применяемый метод зависит от того, как ваш экземпляр AD FS был настроен изначально.

* **Azure AD Connect**. Если вы изначально настроили AD FS с помощью Azure AD Connect, вам *необходимо* перейти на синхронизацию хэша паролей с помощью мастера Azure AD Connect.

   ‎При изменении метода входа пользователей Azure AD Connect автоматически запускает командлет **Set-MsolDomainAuthentication**. Azure AD Connect автоматически отменяет федерацию всех проверенных федеративных доменов в вашем клиенте Azure AD.

   > [!NOTE]
   > В настоящее время невозможно избежать отмены федерации всех доменов в клиенте при переходе на синхронизацию хэша паролей, если изначально для настройки AD FS вы использовали Azure AD Connect. ‎
* **Azure AD Connect и PowerShell**. Этот метод можно использовать, только если службы AD FS не были изначально настроены с помощью Azure AD Connect. Вам все равно потребуется изменить метод входа пользователей с помощью мастера Azure AD Connect. Основное отличие этого варианта заключается в том, что мастер не запускает командлет **Set-MsolDomainAuthentication** автоматически. При использовании этого варианта вы сможете самостоятельно решать, какие домены будут преобразованы и в каком порядке.

Чтобы понять, какой метод следует использовать, выполните действия, описанные в следующих разделах.

#### <a name="verify-current-user-sign-in-settings"></a>Проверка текущих параметров входа пользователей

Проверьте текущие параметры входа пользователей, выполнив следующие действия:

1. Войдите на [портал Azure Active Directory](https://aad.portal.azure.com/), используя учетную запись глобального администратора.
2. В разделе **Вход пользователя** проверьте:
   * установлено ли для параметра **Федерация** значение **Включено**;
   * установлено ли для параметра **Эффективный единый вход** значение **Отключено**;
   * установлено ли для параметра**Сквозная проверка подлинности** значение **Отключено**.

   ![Снимок экрана параметров в разделе "Вход пользователей" в Azure AD Connect](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image1.png)

#### <a name="verify-the-azure-ad-connect-configuration"></a>Проверка конфигурации Azure AD Connect

1. На сервере Azure AD Connect откройте Azure AD Connect. Нажмите кнопку **Настроить**.
2. На странице **Дополнительные задачи** выберите **Просмотр текущей конфигурации**, а затем щелкните **Далее**.<br />

   ![Снимок экрана с выбранным параметром "Просмотр текущей конфигурации" на странице "Дополнительные задачи"](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image2.png)<br />
3. На странице **Ознакомьтесь с решением** обратите внимание на состояние **синхронизации хэша паролей**.<br /> 

   * Если для **синхронизации хэша паролей** установлено значение **Отключено**, включите ее, выполнив действия, описанные в этой статье.
   * Если **синхронизация хэша паролей** **включена**, вы можете пропустить раздел **Шаг 1. Включение синхронизации хэшированных паролей** в этой статье.
4. Прокрутите страницу **Ознакомьтесь с решением** до раздела **Службы федерации Active Directory (AD FS)** .<br />

   * ‎Если конфигурация AD FS указана в этом разделе, можно с уверенностью предположить, что службы AD FS были изначально настроены с помощью Azure AD Connect. Вы можете перевести домены с федеративных удостоверений на управляемые с помощью параметра **Смена имени пользователя для входа** в Azure AD Connect. Этот процесс подробно описан в разделе **Вариант A. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect**.
   * Если службы федерации Active Directory не указаны в текущих параметрах, необходимо вручную перевести домены с федеративных удостоверений на управляемые с помощью PowerShell. Дополнительные сведения об этом процессе см. в разделе **Вариант B. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect и PowerShell**.

### <a name="document-current-federation-settings"></a>Документирование текущих параметров федерации

Чтобы найти текущее значение параметра федерации, выполните командлет **Get-MsolDomainFederationSettings**:

``` PowerShell
Get-MsolDomainFederationSettings -DomainName YourDomain.extention | fl *
```

Пример:

``` PowerShell
Get-MsolDomainFederationSettings -DomainName Contoso.com | fl *
```

Проверьте все параметры, которые могли быть настроены в соответствии с документацией по проектированию и развертыванию федерации, в частности **PreferredAuthenticationProtocol**, **SupportsMfa** и **PromptLoginBehavior**.

Дополнительные сведения вы найдете в следующих статьях:

* [Active Directory Federation Services prompt=login parameter support](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/ad-fs-prompt-login) (Поддержка параметра prompt=login в службах федерации Active Directory (AD FS))
* [Set-MsolDomainAuthentication](https://docs.microsoft.com/powershell/module/msonline/set-msoldomainauthentication?view=azureadps-1.0)

> [!NOTE]
> Если параметр **SupportsMfa** имеет значение **True**, в качестве второго фактора в потоке проверки подлинности используется локальное решение многофакторной проверки подлинности. Эта конфигурация больше не работает для сценариев проверки подлинности Azure AD после преобразования этого домена в федерацию с управляемых проверки подлинности. После отключения федерации sever отношение к вашей локальной федерации, в том числе адаптеров локальной многофакторной проверки Подлинности. 
>
> Вместо этого для выполнения той же функции необходимо использовать службу Многофакторной идентификации Azure (на основе облака). Внимательно проанализируйте требования многофакторной проверки подлинности, прежде чем действовать дальше. Перед преобразованием доменов убедитесь, что вы понимаете принципы использования Многофакторной идентификации Azure, особенности лицензирования и процесс регистрации пользователей.

#### <a name="back-up-federation-settings"></a>Резервное копирование параметров федерации

В ходе процесса, описанного в этой статье, другие проверяющие стороны на ферме AD FS не подвергаются изменениям. Но мы в любом случае рекомендуем создать актуальную резервную копию фермы AD FS, чтобы обеспечить возможность восстановления. Это можно сделать с помощью бесплатного инструмента [AD FS Rapid Restore Tool](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/ad-fs-rapid-restore-tool) корпорации Майкрософт. Он позволяет выполнить резервное копирование AD FS, восстановить существующую ферму или создать новую.

Если вы решите не использовать AD FS Rapid Restore Tool, следует экспортировать отношения доверия проверяющей стороны "Платформа удостоверений Microsoft Office 365" и все добавленные для нее настраиваемые правила утверждений. Это можно сделать с помощью следующего примера PowerShell:

``` PowerShell
(Get-AdfsRelyingPartyTrust -Name "Microsoft Office 365 Identity Platform") | Export-CliXML "C:\temp\O365-RelyingPartyTrust.xml"
```

## <a name="deployment-considerations-and-using-ad-fs"></a>Рекомендации по развертыванию и использованию AD FS

В этом разделе приведены рекомендации по развертыванию и сведения об использовании AD FS.

### <a name="current-ad-fs-use"></a>Текущее использование AD FS

Перед преобразованием федеративных удостоверений в управляемые внимательно изучите сведения о текущем использовании служб AD FS для Azure AD, Office 365 и других приложений (отношения доверия проверяющих сторон). В частности, рассмотрите описанные в приведенной ниже таблице сценарии.

| Если | То |
|-|-|
| Вы планируете продолжить использование AD FS с другими приложениями (не считая Azure AD и Office 365). | После преобразования доменов вы будете использовать одновременно AD FS и Azure AD. Необходимо учитывать взаимодействие с пользователем. В некоторых случаях пользователям потребуется дважды пройти проверку подлинности: один раз — для входа в Azure AD (после чего они смогут использовать единый вход в другие приложения, такие как Office 365), а второй раз — для входа в приложение, которое сохраняет отношения доверия проверяющей стороны с AD FS. |
| Экземпляр AD FS поддерживает большое количество настроек и использует параметры из файла onload.js (возможно, вы изменяли в нем параметры входа в систему, чтобы пользователи могли ввести имя пользователя только в формате **SamAccountName** вместо формата имени участника-пользователя; или ваша организация использует на странице входа фирменную символику и оформление). Файл onload.js невозможно дублировать в Azure AD. | Прежде чем продолжать работу, проверьте, можно ли в Azure AD обеспечить соответствие вашим текущим требованиям к настройке. Дополнительные сведения и рекомендации см. в разделах о фирменной символике AD FS и настройке параметров AD FS.|
| Вы используете AD FS, чтобы заблокировать старые версии клиентов проверки подлинности.| Рассмотрите возможность замены элементов управления AD FS, которые блокируют более ранних версиях клиентов проверки подлинности с помощью сочетания [условного доступа управляет](https://docs.microsoft.com/azure/active-directory/conditional-access/conditions) и [правила доступа к Exchange Online клиента](https://aka.ms/EXOCAR). |
| Вы хотите, чтобы при проверке подлинности в AD FS пользователи проходили Многофакторную идентификацию (MFA) на локальном сервере MFA.| У вас нет возможности внедрить запрос MFA, выполняемый через локальное решение MFA, в поток проверки подлинности для управляемого домена. Но вы сможете использовать службу "Многофакторная идентификация Azure" для многофакторной проверки подлинности после преобразования домена.<br /><br /> Если сейчас пользователи не используют службу "Многофакторная идентификация Azure", им потребуется выполнить одноразовую регистрацию. Нужно будет подготовить этот дополнительный шаг и сообщить о нем пользователям. |
| Вы применяете политики управления доступом (правила AuthZ) в AD FS для управления доступом к Office 365.| Рассмотрите возможность замены политики на эквивалентное Azure AD [политики условного доступа](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-azure-portal) и [правила доступа к Exchange Online клиента](https://aka.ms/EXOCAR).|

### <a name="common-ad-fs-customizations"></a>Распространенные пользовательские настройки AD FS

В этом разделе описаны часто используемые варианты настройки AD FS.

#### <a name="insidecorporatenetwork-claim"></a>Утверждение InsideCorporateNetwork

В службах AD FS создается утверждение **InsideCorporateNetwork** при проверке подлинности пользователя, который находится в корпоративной сети. Это утверждение можно передать в Azure AD. Оно используется для обхода многофакторной проверки подлинности на основе расположения в сети пользователя. Сведения о том, как определить, включена ли сейчас эта функция в AD FS, см. в статье [Защита облачных ресурсов с помощью Многофакторной идентификации Azure и AD FS](https://docs.microsoft.com/azure/multi-factor-authentication/multi-factor-authentication-get-started-adfs-cloud).

Утверждение **InsideCorporateNetwork** недоступно после преобразования доменов для использования синхронизации хэша паролей. Вместо этой функции вы можете использовать [именованные расположения в Azure AD](https://docs.microsoft.com/azure/active-directory/active-directory-named-locations).

После настройки именованных расположений, необходимо обновить все политики условного доступа, которые были настроены для включения или исключения сети **все надежные расположения** или **надежные IP-адреса MFA** значения отражают новый именованные расположения.

Дополнительные сведения о **расположение** условия в условном доступе, см. в разделе [расположения в условном доступе в Active Directory](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-locations).

#### <a name="hybrid-azure-ad-joined-devices"></a>Устройства, использующие гибридное присоединение к Azure AD

После подключения устройства к Azure AD, можно создать правила условного доступа, которые определяют, что устройства соответствуют стандартам доступа для обеспечения безопасности и соответствия требованиям. Кроме того, пользователи могут входить на устройство с помощью рабочей или учебной учетной записи организации вместо личной. Использование гибридного присоединения к Azure AD позволяет присоединять к Azure Active Directory устройства, которые присоединены к домену Azure AD. Эта функция могла быть настроена в старой федеративной среде.

Чтобы гибридное присоединение использовалось для всех устройств, присоединяемых к домену после перевода доменов на синхронизацию хэша паролей, для клиентов Windows 10 необходимо использовать Azure AD Connect для синхронизации учетных записей компьютеров Active Directory с Azure AD. 

Для учетных записей компьютеров Windows 7 и Windows 8 гибридное присоединение использует простой единый вход для регистрации компьютера в Azure AD. Вам не потребуется синхронизировать их, как в случае с устройствами Windows 10. Но для клиентов Windows 8 и Windows 7 нужно развернуть обновленный файл workplacejoin.exe (с помощью MSI-файла), чтобы они могли зарегистрироваться с помощью эффективного единого входа. [Скачайте этот MSI-файл](https://www.microsoft.com/download/details.aspx?id=53554).

Дополнительные сведения см. в статье [Практическое руководство. Планирование реализации гибридного присоединения к Azure Active Directory](https://docs.microsoft.com/azure/active-directory/device-management-hybrid-azuread-joined-devices-setup).

#### <a name="branding"></a>Фирменная символика

Если в вашей организации [настроены страницы входа AD FS](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/ad-fs-user-sign-in-customization) для отображения соответствующих сведений, рекомендуем аналогичным образом [настроить страницы входа Azure AD](https://docs.microsoft.com/azure/active-directory/customize-branding).

Доступны все настройки, аналогичные прежним, но после преобразования возможны некоторые изменения в оформлении страниц входа. Возможно, следует предупредить пользователей об ожидаемых изменениях в оформлении.

> [!NOTE]
> Фирменная символика организации доступна только после приобретения лицензий Premium или Basic для службы Azure Active Directory, а также обладателям лицензий Office 365.

## <a name="plan-deployment-and-support"></a>Планирование развертывания и поддержки

Задачи, описанные в этом разделе, помогут вам спланировать развертывание и поддержку.

### <a name="plan-the-maintenance-window"></a>Планирование периода обслуживания

Хотя домены преобразуются относительно быстро, Azure AD может еще примерно четыре часа после этого отправлять запросы на проверку подлинности на серверы AD FS. В течение этих четырех часов, учитывая особенности работы кэшей на стороне служб, такие запросы на проверку подлинности могут не приниматься службой Azure AD. Возможно, пользователю будет отправлено сообщение об ошибке. Пользователь сможет успешно проходить проверку подлинности в AD FS, но Azure AD не будет принимать выданный пользователю маркер, так как отношения доверия федерации уже удалены.

Это затронет только пользователей, обращающихся к службам из веб-браузера в течение указанного периода после преобразования, пока не будет очищен кэш на стороне службы. Устаревшие клиенты (Exchange ActiveSync, Outlook 2010, Outlook 2013) не должны быть затронуты, так как Exchange Online сохраняет кэш учетных данных в течение определенного периода. Этот кэш позволяет автоматически возобновлять проверку подлинности пользователя без обращений к AD FS. Учетные данные, хранящиеся на устройстве для таких клиентов, позволяют автоматически повторно пройти проверку подлинности после очистки кэша. Пользователям не будут отправляться запросы на ввод пароля из-за преобразования доменов. 

Современные клиенты проверки подлинности (Office 2016 и Office 2013, приложения IOS и Android) применяют действительный маркер обновления для получения новых маркеров доступа, что обеспечит непрерывный доступ к ресурсам без перехода к службам AD FS. Этим клиентам не будут отправляться запросы на ввод пароля после преобразования доменов. Клиенты будут продолжать работу без дополнительных настроек.

> [!IMPORTANT]
> Не завершайте работу среды AD FS и не удаляйте отношение доверия проверяющей стороны с Office 365, пока не удостоверитесь, что все пользователи могут успешно пройти проверку подлинности в облаке.

### <a name="plan-for-rollback"></a>План отката

Если возникла серьезная проблема, которую нельзя быстро устранить, вы можете выполнить откат решения к федерации. Очень важно спланировать действия на случай, если развертывание не выполняется должным образом. Вы должны хорошо понимать, как сократить простой и уменьшить неудобства для пользователей, если во время развертывания произойдет сбой преобразования доменов или пользователей либо возникнет необходимость выполнить откат к федерации.

#### <a name="to-roll-back"></a>Выполнение отката

Чтобы спланировать откат, ознакомьтесь с документацией по проектированию и развертыванию федерации для конкретного развертывания. Этапы процесса:

* Переход управляемых доменов на федеративную аутентификацию с помощью командлета **Convert-MSOLDomainToFederated**.
* При необходимости — настройка дополнительных правил утверждений.

### <a name="plan-communications"></a>Планирование информирования

Важной частью планирования развертывания и поддержки является своевременное информирование пользователей о предстоящих изменениях. Пользователи должны заранее знать о возможных ситуациях и необходимых действиях. 

После развертывания синхронизации хэша паролей и простого единого входа изменится процедура входа пользователей при доступе к Office 365 и другим ресурсам, использующим аутентификацию в Azure AD. Пользователи за пределами вашей сети будут видеть только страницу входа в Azure AD. Они не будут перенаправляться на страницу на основе форм, предоставляемую интерфейсными прокси-серверами веб-приложения.

В стратегию информирования следует включить следующие элементы:

* Уведомление пользователей о планируемых и уже выпущенных функциональных возможностях с помощью:
   * электронной почты и других внутренних каналов связи;
   * наглядных пособий, например плакатов;
   * обычных средств делового и личного общения.
* Определение лиц, ответственных за настройку и отправку сообщений, а также расписания отправки сообщений.

## <a name="implement-your-solution"></a>Внедрение решения

Итак, вы подготовили новое решение. Теперь можно приступить к его внедрению. Внедрение включает в себя следующие этапы:

* Включение синхронизации хэша паролей.
* Подготовка к внедрению простого единого входа.
* Изменение метода входа на синхронизацию хэша паролей и включение простого единого входа.

### <a name="step-1-enable-password-hash-synchronization"></a>Шаг 1. Включение синхронизации хэшированных паролей

Первым шагом для внедрения этого решения является включение синхронизации хэша паролей с помощью мастера Azure AD Connect. Синхронизация хэша паролей — это дополнительная функция, которую можно включить для сред, использующих федерацию. Это никак не повлияет на поток процесса аутентификации. В этом случае Azure AD Connect начнет синхронизацию хэша паролей без нарушения процедуры входа пользователей, использующих федерацию.

По этой причине рекомендуется выполнять этот подготовительный шаг задолго до изменения способа входа в домены. У вас будет достаточно времени для проверки работы синхронизации хэша паролей.

Чтобы включить синхронизацию хэша паролей, сделайте следующее.

1. На сервере Azure AD Connect откройте мастер Azure AD Connect и выберите **Настройка**.
2. Выберите **Настроить параметры синхронизации** и щелкните **Далее**.
3. На странице **Подключение к Azure AD** введите имя пользователя и пароль глобального администратора.
4. На странице **Подключить каталоги** щелкните **Далее**.
5. На странице **Фильтрация доменов и подразделений** нажмите кнопку **Далее**.
6. На странице **Дополнительные возможности** выберите **Синхронизация паролей** и щелкните **Далее**.
 
   ![Снимок экрана с выбранным параметром "Синхронизация паролей" на странице дополнительных возможностей](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image6.png)<br />
7. Щелкните **Далее** на всех остальных страницах. На последней странице нажмите кнопку **Настроить**.
8. Azure AD Connect начнет синхронизацию хэша паролей во время следующей синхронизации.

После включения синхронизации хэша паролей будет выполнено повторное вычисление и запись в Azure AD хэша паролей всех пользователей, для которых настроена синхронизация Azure AD Connect. В зависимости от количества пользователей эта операция может занять от пары минут до нескольких часов.

В целях планирования следует учесть, что для обработки порядка 20 000 пользователей потребуется 1 час.

Чтобы проверить, правильно ли работает синхронизация хэша паролей, выполните задачу **устранения неполадок** в мастере Azure AD Connect:

1. Откройте новый сеанс Windows PowerShell на сервере Azure AD Connect и запустите его от имени администратора.
2. Запустите `Set-ExecutionPolicy RemoteSigned` или `Set-ExecutionPolicy Unrestricted`.
3. Откройте мастер Azure AD Connect.
4. Перейдите к странице **Дополнительные задачи**, выберите **Устранение неполадок** и щелкните **Далее**.
5. На странице **Устранение неполадок** выберите **Запуск**, чтобы открыть меню устранения неполадок в PowerShell.
6. В главном меню выберите **Устранение неполадок при синхронизации хэшей паролей**.
7. В подменю выберите **Password hash synchronization does not work at all** (Синхронизация хэша паролей не выполняется).

Дополнительные сведения см. в статье [Устранение неполадок синхронизации хэшированных паролей в службе синхронизации Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectsync-troubleshoot-password-hash-synchronization).

### <a name="step-2-prepare-for-seamless-sso"></a>Шаг 2. Подготовка к внедрению простого единого входа

Чтобы устройства использовали эффективный единый вход, необходимо добавить URL-адрес Azure AD в параметры зоны интрасети пользователей с помощью групповой политики Active Directory.

По умолчанию веб-браузеры автоматически вычисляют соответствующую зону (Интернет или интрасеть) по URL-адресу. Например, адрес **http:\/\/contoso/** сопоставляется с зоной интрасети, а **http:\/\/intranet.contoso.com** — с зоной Интернета (так как этот URL-адрес содержит точку). Браузеры отправляют билеты Kerberos в облачную конечную точку (например, на URL-адрес Azure AD), только если ее URL-адрес добавлен явным образом в зону интрасети в браузере.

Выполните соответствующие действия, чтобы [развернуть](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-sso-quick-start) необходимые изменения на устройствах.

> [!IMPORTANT]
> Эти изменения не повлияют на способ входа пользователей в Azure AD. Но очень важно применить эту конфигурацию ко всем устройствам, прежде чем продолжать работу. При входе с устройств, не получивших эту конфигурацию, пользователям просто придется вводить имя пользователя и пароль для входа в Azure AD.

### <a name="step-3-change-the-sign-in-method-to-password-hash-synchronization-and-enable-seamless-sso"></a>Шаг 3. Изменение метода входа на синхронизацию хэша паролей и включение простого единого входа

Доступны два варианта изменения метода входа на синхронизацию хэша паролей и включения простого единого входа.

#### <a name="option-a-switch-from-federation-to-password-hash-synchronization-by-using-azure-ad-connect"></a>Вариант 1. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect

Используйте этот метод, только если среда AD FS была изначально настроена с помощью Azure AD Connect. Этот метод не может использоваться в случае, если среда AD FS *не была* изначально настроена с помощью Azure AD Connect.

Сначала измените метод входа:

1. На сервере Azure AD Connect откройте мастер Azure AD Connect.
2. Выберите **Смена имени пользователя для входа**, а затем выберите **Далее**. 

   ![Снимок экрана с параметром "Смена имени пользователя для входа" на странице дополнительных задач](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image7.png)<br />
3. На странице **Подключение к Azure AD** введите имя пользователя и пароль глобального администратора.
4. На странице **входа пользователей** нажмите кнопку **Синхронизация хэша паролей**. Обязательно установите флажок **Не преобразовывать учетные записи пользователей**. Этот параметр является устаревшим. Выберите **Включить единый вход** и щелкните **Далее**.

   ![Снимок экрана со страницей "Включить единый вход"](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image8.png)<br />

   > [!NOTE]
   > Начиная с Azure AD Connect версии 1.1.880.0 флажок **Эффективный единый вход** установлен по умолчанию.

   > [!IMPORTANT]
   > Можно спокойно игнорировать предупреждения о том, что преобразование пользователей и полная синхронизация хэша паролей обязательны для перехода с федеративной аутентификации на облачную. Обратите внимание, что эти действия больше не являются обязательными. Если вы по-прежнему видите эти предупреждения, убедитесь, что используется последняя версия Azure AD Connect и вы следуете последней версии данного руководства. Дополнительные сведения см. в разделе [Обновление Azure AD Connect](#update-azure-ad-connect).

5. На странице **Включить единый вход** введите учетные данные администратора домена и щелкните **Далее**.

   ![Снимок экрана со страницей "Включить единый вход"](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image9.png)<br />

   > [!NOTE]
   > Учетные данные администратора домена нужны для включения простого единого входа. Этот процесс включает описанные ниже действия, требующие повышенных привилегий. Учетные данные администратора домена не хранятся в Azure AD Connect или в Azure AD. Они используются только для того, чтобы включить эту функцию, и отменяются после успешного выполнения процесса.
   >
   > 1. В локальном экземпляре Active Directory создается учетная запись компьютера с именем AZUREADSSOACC, которая представляет Azure AD.
   > 2. В Azure AD безопасным образом предоставляется ключ расшифровки Kerberos для учетной записи компьютера.
   > 3. Создаются два имени субъектов-служб (SPN) Kerberos, которые представляют URL-адреса для входа в Azure AD.

6. Убедитесь, что на странице **Готово к настройке** установлен флажок **Start the synchronization process when configuration completes** (Начать синхронизацию после завершения настройки). Затем выберите **Настроить**.

      ![Снимок экрана со страницей "Готово к настройке"](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image10.png)<br />

   > [!IMPORTANT]
   > На этом этапе все федеративные домены будут переведены на управляемую аутентификацию. В качестве метода аутентификации будет использоваться синхронизация хэша паролей.

7. Откройте портал Azure AD и выберите **Azure Active Directory** > **Azure AD Connect**.
8. Проверьте настройку параметров.
   * Для параметра **Федерация** должно быть установлено значение **Отключено**.
   * Для параметра **Эффективный единый вход** установите значение **Включено**.
   * Для параметра **Синхронизация паролей** установите значение **Включено**.<br /> 

   ![Снимок экрана с параметрами в разделе входа пользователей](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image11.png)<br />

Перейдите к разделу [Тестирование и дальнейшие действия](#testing-and-next-steps).

   > [!IMPORTANT]
   > Пропустите раздел **Вариант Б. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect и PowerShell**. Если вы выбрали вариант A для изменения метода входа на синхронизацию хэша паролей и включения простого единого входа, действия из этого раздела не применяются.

#### <a name="option-b-switch-from-federation-to-password-hash-synchronization-using-azure-ad-connect-and-powershell"></a>Вариант 2. Переход с федеративной аутентификации на синхронизацию хэша паролей с помощью Azure AD Connect и PowerShell.

Используйте этот вариант, если федеративные домены не были изначально настроены с помощью Azure AD Connect. В рамках этого процесса вы включаете простой единый вход и преобразовываете свои федеративные домены в управляемые.

1. На сервере Azure AD Connect откройте мастер Azure AD Connect.
2. Выберите **Смена имени пользователя для входа**, а затем выберите **Далее**.
3. На странице **Подключение к Azure AD** введите имя пользователя и пароль глобального администратора.
4. На странице **входа пользователей** нажмите кнопку **Синхронизация хэша паролей**. Выберите **Включить единый вход** и щелкните **Далее**.

   Перед включением синхронизации хэша паролей сделайте следующее: ![Снимок экрана с параметром "Не настраивать" на странице входа пользователей](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image12.png)<br />

   После включения синхронизации хэша паролей сделайте следующее: ![Снимок экрана, показывающий новые параметры на странице входа в систему пользователя](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image13.png)<br />
   
   > [!NOTE]
   > Начиная с Azure AD Connect версии 1.1.880.0 флажок **Эффективный единый вход** установлен по умолчанию.

5. На странице **Включить единый вход** введите учетные данные администратора домена и щелкните **Далее**.

   > [!NOTE]
   > Учетные данные администратора домена нужны для включения простого единого входа. Этот процесс включает описанные ниже действия, требующие повышенных привилегий. Учетные данные администратора домена не хранятся в Azure AD Connect или в Azure AD. Они используются только для того, чтобы включить эту функцию, и отменяются после успешного выполнения процесса.
   >
   > 1. В локальном экземпляре Active Directory создается учетная запись компьютера с именем AZUREADSSOACC, которая представляет Azure AD.
   > 2. В Azure AD безопасным образом предоставляется ключ расшифровки Kerberos для учетной записи компьютера.
   > 3. Создаются два имени субъектов-служб (SPN) Kerberos, которые представляют URL-адреса для входа в Azure AD.

6. Убедитесь, что на странице **Готово к настройке** установлен флажок **Start the synchronization process when configuration completes** (Начать синхронизацию после завершения настройки). Затем выберите **Настроить**.

   ![Снимок экрана с кнопкой "Настроить" на странице "Готово к настройке"](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image15.png)<br />
   После того как вы нажмете кнопку **Настроить**, будет настроен простой единый вход согласно параметрам, указанным на предыдущем шаге. Конфигурация синхронизации хэша паролей не будет изменена, так как она была включена ранее.

   > [!IMPORTANT]
   > На данном этапе процесс входа пользователей никак не изменен.

7. На портале Azure AD проверьте следующее:
   * Для параметра **Федерация** установлено значение **Включено**.
   * Для параметра **Эффективный единый вход** установите значение **Включено**.
   * Для параметра **Синхронизация паролей** установите значение **Включено**.

   ![Снимок экрана с параметрами в разделе входа пользователей](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image16.png)

#### <a name="convert-domains-from-federated-to-managed"></a>Преобразование федеративных доменов в управляемые

На этом этапе федерация для ваших доменов по-прежнему включена и работает. Чтобы продолжить развертывание, необходимо преобразовать все федеративные домены в управляемые, чтобы применить аутентификацию пользователей посредством синхронизации хэша паролей.

> [!IMPORTANT]
> Не все домены должны быть преобразованы одновременно. Вы можете начать с тестового домена на рабочем клиенте или с домена с наименьшим числом пользователей.

Для преобразования примените модуль PowerShell для Azure AD.

1. Войдите на портал Azure AD из PowerShell, используя учетную запись глобального администратора.
2. Для преобразования первого домена выполните приведенную ниже команду.

   ``` PowerShell
   Set-MsolDomainAuthentication -Authentication Managed -DomainName <domain name>
   ```

3. Откройте портал Azure AD и выберите **Azure Active Directory** > **Azure AD Connect**.
4. Убедитесь, что домен преобразован в управляемый, выполнив следующую команду:

   ``` PowerShell
   Get-MsolDomain -DomainName <domain name>
   ```

## <a name="testing-and-next-steps"></a>Тестирование и дальнейшие действия

Выполните следующие задачи, чтобы проверить синхронизацию хэша паролей и завершить процесс преобразования.

### <a name="test-authentication-by-using-password-hash-synchronization"></a>Тестирование аутентификации с помощью синхронизации хэша паролей 

Когда в клиенте использовалось федеративное удостоверение, пользователи перенаправлялись со страницы входа Azure AD в среду AD FS. Теперь, когда клиент настроен на использование синхронизации хэша паролей вместо федеративной аутентификации, пользователи не перенаправляются в AD FS. Вместо этого они будут выполнять вход непосредственно на странице входа в Azure AD.

Чтобы протестировать синхронизацию хэша паролей:

1. Откройте Internet Explorer в режиме InPrivate, чтобы служба простого единого входа не выполнила вход автоматически.
2. Перейдите на страницу входа Office 365 ([https://portal.office.com](https://portal.office.com/)).
3. Введите имя участника-пользователя и щелкните **Далее**. Это должно быть имя участника-пользователя того гибридного пользователя, который был синхронизирован с локального экземпляра Active Directory и ранее использовал федеративную проверку подлинности. Откроется страница для ввода имени пользователя и пароля:

   ![Снимок экрана со страницей входа для ввода имени пользователя](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image18.png)

   ![Снимок экрана со страницей входа для ввода пароля](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image19.png)

4. Когда вы введете пароль и нажмете кнопку **Войти**, откроется портал Office 365.

   ![Снимок экрана с порталом Office 365](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image20.png)


### <a name="test-seamless-sso"></a>Тестирование простого единого входа

1. Войдите на компьютер, присоединенный к домену, который подключен к корпоративной сети.
2. Откройте Internet Explorer или Chrome и перейдите по одному из следующих URL-адресов, заменив contoso именем своего домена:

   * https:\/\/myapps.microsoft.com/contoso.com;
   * https:\/\/myapps.microsoft.com/contoso.onmicrosoft.com.

   Пользователь на короткое время перенаправляется на страницу входа Azure AD, где отображается сообщение "Выполняется попытка входа". Пользователю не нужно вводить имя пользователя или пароль.<br />

   ![Снимок экрана со страницей входа в Azure AD и сообщением](media/plan-migrate-adfs-password-hash-sync/migrating-adfs-to-phs_image21.png)<br />
3. Затем пользователь будет перенаправлен на панель доступа и успешно войдет в нее.

   > [!NOTE]
   > Эффективный единый вход работает в службах Office 365, которые поддерживают указание домена (например, myapps.microsoft.com/contoso.com). На портале Office 365 (portal.office.com) сейчас указания домена не поддерживаются. Пользователю потребуется ввести имя участника-пользователя. После ввода имени участника-пользователя служба эффективного единого входа получает билет Kerberos от имени пользователя. Пользователь выполняет вход без ввода пароля.

   > [!TIP]
   > Рекомендуем развернуть [службы гибридного присоединения к Azure AD в Windows 10](https://docs.microsoft.com/azure/active-directory/device-management-introduction), чтобы расширить возможности единого входа.

### <a name="remove-the-relying-party-trust"></a>Удаление отношений доверия с проверяющей стороной

Убедившись в том, что все клиенты и пользователи успешно проходят проверку подлинности через Azure AD, вы можете удалить отношения доверия проверяющей стороны для Office 365.

Если компонент AD FS не используется для других целей (других отношений доверия проверяющей стороны), его теперь спокойно можно вывести из эксплуатации.

### <a name="rollback"></a>Откат

Если вы столкнетесь с серьезной проблемой, которую нельзя быстро устранить, можно выполнить откат решения к федерации.

Ознакомьтесь с документацией по проектированию и развертыванию федерации, в которой указаны сведения о конкретном развертывании. Этапы процесса:

* переход управляемых доменов на федеративную проверку подлинности с помощью командлета **Convert-MSOLDomainToFederated**;
* настройка дополнительных правил утверждений, если они нужны.

### <a name="sync-userprincipalname-updates"></a>Синхронизация обновлений атрибута userPrincipalName

Обновления атрибута **userPrincipalName**, использующего службу синхронизации из локальной среды, блокируются, за исключением тех случаев, когда выполняются два следующих условия:

* пользователь находится в управляемом домене (не федеративном);
* пользователю не назначена лицензия.

Инструкции о том, как проверить или включить эту функцию, см. в статье [Функции службы синхронизации Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectsyncservice-features).

### <a name="troubleshooting"></a>Устранение неполадок

Ваша группа поддержки должна знать, как устранить любые неполадки аутентификации, возникающие во время или после перехода с федеративных доменов на управляемые. Предоставьте приведенную документацию по устранению неполадок своей группе поддержки, чтобы она ознакомилась с общими инструкциями по устранению неполадок и соответствующими действиями, которые могут помочь выявить и устранить проблему.

[Устранение неполадок синхронизации хэшированных паролей в службе синхронизации Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectsync-troubleshoot-password-hash-synchronization)

[Устранение неполадок с простым единым входом Azure Active Directory](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-troubleshoot-sso)

## <a name="roll-over-the-seamless-sso-kerberos-decryption-key"></a>Смена ключа расшифровки Kerberos для простого единого входа

Очень важно часто сменять ключ расшифровки Kerberos для учетной записи компьютера AZUREADSSOACC, которая представляет Azure AD. Учетная запись компьютера AZUREADSSOACC создается в локальном лесу Active Directory. Мы настоятельно рекомендуем сменять ключ расшифровки Kerberos по крайней мере каждые 30 дней, в соответствии с периодом изменения паролей для членов домена Active Directory. К объекту учетной записи компьютера AZUREADSSOACC не подключено связанное устройство, поэтому смену необходимо выполнять вручную.

Инициируйте смену ключа расшифровки Kerberos эффективного единого входа на локальном сервере, на котором выполняется Azure AD Connect.

Дополнительные сведения см. в статье [Простой единый вход Azure Active Directory: часто задаваемые вопросы](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-sso-faq).

## <a name="next-steps"></a>Дальнейшие действия

* Изучите [принципы проектирования для Azure AD Connect](plan-connect-design-concepts.md).
* Узнайте, как выбрать [правильный метод проверки подлинности](https://docs.microsoft.com/azure/security/azure-ad-choose-authn).
* Ознакомьтесь со сведениями о [поддерживаемых топологиях](plan-connect-design-concepts.md).
