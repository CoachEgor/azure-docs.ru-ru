---
title: 'Azure AD Connect: облачная аутентификация — промежуточное развертывание | Документация Майкрософт'
description: Объясняется, как выполнить миграцию из федеративной проверки подлинности в Cloud auth с помощью промежуточного развертывания.
author: billmath
manager: daveba
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 11/07/2019
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 2596091324acde5c4fdc3f7c467849f90266fec9
ms.sourcegitcommit: 16c5374d7bcb086e417802b72d9383f8e65b24a7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2019
ms.locfileid: "73847228"
---
# <a name="cloud-authentication-staged-rollout-public-preview"></a>Облачная аутентификация: промежуточное развертывание (общедоступная Предварительная версия)

Эта функция позволяет переходить от федеративной проверки подлинности к облачной аутентификации с помощью промежуточного подхода.

Переход от федеративной проверки подлинности имеет последствия. Например, если имеется один из следующих элементов:
    
-  локальный сервер MFA 
-  используют смарт-карты для проверки подлинности 
-  другие функции Федерации

Перед переключением на облачную аутентификацию следует принять во внимание эти функции.  Прежде чем пытаться воспользоваться этой функцией, мы рекомендуем ознакомиться с нашим руководством по выбору правильного метода проверки подлинности. Дополнительные сведения см. в [этой таблице](https://docs.microsoft.com/azure/security/fundamentals/choose-ad-authn#comparing-methods) .

>[!VIDEO https://www.microsoft.com/videoplayer/embed/RE3inQJ]



## <a name="prerequisites"></a>Предварительные требования

-   У вас есть клиент Azure AD с федеративными доменами.

-   Вы решили перейти на синхронизацию хэша паролей + простой единый вход **(вариант а)** или сквозную проверку подлинности + простой единый вход **(вариант б).** Хотя простой единый вход не является обязательным, мы советуем включить простой единый вход для автоматического входа пользователей, использующих компьютеры, присоединенные к домену, из корпоративной сети.

-   Вы настроили все соответствующие политики для фирменной символики клиента и условного доступа, необходимые для пользователей, которые переносятся в облачную аутентификацию.

-   Если вы планируете использовать многофакторную идентификацию Azure, мы рекомендуем использовать [согласованную регистрацию для самостоятельного сброса пароля (SSPR) и Azure MFA](../authentication/concept-registration-mfa-sspr-combined.md) , чтобы пользователи могли регистрировать свои методы проверки подлинности один раз.

-   Чтобы использовать эту функцию, необходимо быть глобальным администратором вашего клиента.

-   Чтобы включить простой единый вход для конкретного леса AD, необходимо быть администратором домена.

## <a name="supported-scenarios"></a>Поддерживаемые сценарии использования.

Эти сценарии поддерживаются для промежуточного развертывания:

- Эта функция работает только для пользователей, которые подготавливается к работе с Azure AD с помощью Azure AD Connect и не применимы только для облачных пользователей.

- Эта функция работает только для трафика входа пользователей в браузерах и современных клиентов проверки подлинности. Приложения или облачные службы, использующие устаревшую проверку подлинности, будут возвращаться к федеративным потокам проверки подлинности. (Пример: Exchange Online с включенной современной проверкой подлинности или Outlook 2010, который не поддерживает современную проверку подлинности.)

## <a name="unsupported-scenarios"></a>Неподдерживаемые сценарии

Эти сценарии не поддерживаются для промежуточного развертывания:

- Некоторые приложения передают параметр запроса "указание\_домена" в Azure AD во время проверки подлинности. Эти последовательности будут продолжены, а пользователи, для которых включено поэтапное развертывание, будут продолжать использовать федерацию для проверки подлинности.

<!-- -->

- Администратор может развернуть проверку подлинности в облаке с помощью групп безопасности. (Рекомендуется использовать облачные группы безопасности, чтобы избежать задержки синхронизации при использовании локальных групп безопасности AD.)

    - Для каждого компонента можно использовать не **более 10 групп**. Например, для каждой синхронизации хэша паролей/сквозной проверки подлинности или простого единого входа.

    - Вложенные группы **не поддерживаются**. Кроме того, это область для общедоступной предварительной версии.

    - Динамические группы **не поддерживаются** для промежуточного развертывания.

    - Объекты контакта внутри группы будут блокировать Добавление формы группы.

- Последняя прямую миграцию из Федеративной в облачную аутентификацию по-прежнему должна выполняться с помощью Azure AD Connect или PowerShell. Эта функция не переключает домены из Федерации в управляемые.

- При первом добавлении группы безопасности для поэтапного развертывания ограничено 200 пользователей, чтобы избежать истечения времени ожидания от UX. После добавления группы в UX можно добавить дополнительных пользователей непосредственно в группу, если это необходимо.

## <a name="get-started-with-staged-rollout"></a>Приступая к работе с промежуточным развертыванием

Если вы хотите протестировать вход с использованием синхронизации хэшей паролей (PHS) с помощью промежуточного развертывания, выполните приведенную ниже предварительную работу, чтобы включить синхронизацию хэша паролей в промежуточном виде.

Дополнительные сведения об используемых командлетах PowerShell см. в разделе [AzureAD 2,0 Preview](https://docs.microsoft.com/powershell/module/azuread/?view=azureadps-2.0-preview#staged_rollout)

## <a name="pre-work-for-password-hash-sync"></a>Предварительная работа для синхронизации хэша паролей

1. Включите синхронизацию хэша паролей из [дополнительных компонентов](how-to-connect-install-custom.md#optional-features) странице в Azure AD Connect. 

   ![Снимок экрана со страницей дополнительных компонентов в Azure Active Directory Connect](media/how-to-connect-staged-rollout/sr1.png)

1. Убедитесь, что полный цикл синхронизации хэша паролей выполнен, чтобы все хэши паролей пользователей были синхронизированы с Azure AD. Вы можете использовать диагностику PowerShell [здесь](tshoot-connect-password-hash-synchronization.md) для проверки состояния синхронизации хэша паролей.

   ![Снимок экрана журнала устранения неполадок AADConnect](./media/how-to-connect-staged-rollout/sr2.png)

Если вы хотите протестировать сквозную проверку подлинности (PTA) с помощью промежуточного развертывания, выполните приведенную ниже предварительную работу, чтобы включить PTA для промежуточного развертывания.

## <a name="pre-work-for-pass-through-authentication"></a>Предварительная работа для сквозной проверки подлинности

1. Укажите сервер под управлением Windows Server 2012 R2 или более поздней версии, на котором должен выполняться агент проверки подлинности (**не выбирайте сервер Azure AD Connect**). Убедитесь, что сервер присоединен к домену, может проверять подлинность выбранных пользователей с Active Directory и может взаимодействовать с Azure AD по исходящим портам и URL-адресам (см. подробные [Предварительные требования](how-to-connect-sso-quick-start.md)).

1. [Скачайте](https://aka.ms/getauthagent) & установить Агент аутентификации Microsoft Azure AD Connect на сервере. 

1. Чтобы включить [высокий уровень доступности](how-to-connect-sso-quick-start.md), установите дополнительные агенты аутентификации на других серверах.

1. Убедитесь, что [Параметры смарт-блокировки](../authentication/howto-password-smart-lockout.md) настроены соответствующим образом. Это гарантирует, что локальные учетные записи пользователей Active Directory не блокируются недопустимыми субъектами.

Рекомендуется включить простой единый вход независимо от метода входа (PHS или PTA), выбранного для поэтапного развертывания. Выполните приведенную ниже предварительную работу, чтобы обеспечить простой единый вход для поэтапного развертывания.

## <a name="pre-work-for-seamless-sso"></a>Предварительная работа для простого единого входа

Включите простой единый вход в лесах AD с помощью PowerShell. Если у вас несколько лесов AD, включите одно и то же для каждого леса отдельно. Простой единый вход будет активирован только для пользователей, выбранных для поэтапного развертывания, и не повлияет на текущую настройку Федерации.

**Сводка шагов**

1. Сначала войдите на Azure AD Connect Server.

2. Перейдите в папку% ProgramFiles%\\Microsoft Azure Active Directory Connect.

3. Импортируйте модуль PowerShell для простого единого входа с помощью следующей команды: `Import-Module .\AzureADSSO.psd1`.

4. Откройте PowerShell от имени администратора. В PowerShell вызовите `New-AzureADSSOAuthenticationContext`. Эта команда должна предоставить диалоговое окно, в котором можно ввести учетные данные глобального администратора клиента.

5. Вызовите `Get-AzureADSSOStatus | ConvertFrom-Json`. Эта команда предоставляет список лесов AD (см. список доменов \"\"), на которых эта функция включена. По умолчанию для него задано значение false на уровне клиента.

   > **Пример.** 
   > ![пример выходных данных Windows PowerShell](./media/how-to-connect-staged-rollout/sr3.png)

6. Вызовите `$creds = Get-Credential`. При запросе введите свои учетные данные администратора домена для нужного леса AD.

7. Вызовите `Enable-AzureADSSOForest -OnPremCredentials $creds`. Эта команда создает учетную запись компьютера AZUREADSSOACC из локального контроллера домена для этого конкретного Active Directory леса, необходимого для простого единого входа.

8. Для простого единого входа необходимо, чтобы URL-адреса были в зоне интрасети. Для развертывания этих URL-адресов с помощью групповых политик обратитесь к [краткому руководству по эффективному единому входу](how-to-connect-sso-quick-start.md#step-3-roll-out-the-feature) .

9.  Вы также можете скачать [планы развертывания](https://aka.ms/SeamlessSSODPDownload) для простого единого входа в полном пошаговом руководстве.

## <a name="enable-staged-rollout"></a>Включить промежуточное развертывание

Выполните следующие действия, чтобы развернуть определенную функцию (сквозная проверка подлинности, синхронизация хэша паролей или простой единый вход) для выбранного набора пользователей в группе:

### <a name="enable-the-staged-rollout-of-a-specific-feature-on-your-tenant"></a>Включение поэтапного развертывания определенной функции в клиенте

Вы можете развернуть один из этих вариантов.

-   Синхронизация хэша паролей + простой единый вход **(вариант а)**

-   Сквозная проверка подлинности + простой единый вход **(вариант б)**

-   Синхронизация хэша паролей + сквозная проверка подлинности + простой единый вход **-\>** ***не поддерживается***

Выполните следующие действия.

1. Войдите на портал Azure AD, используя приведенный ниже URL-адрес для доступа к интерфейсу предварительной версии.

   > <https://aka.ms/stagedrolloutux>

2. Щелкните Включить промежуточное развертывание для входа управляемого пользователя (Предварительная версия)

   *Например* , (**вариант б**) Если вы хотите включить синхронизацию ХЭША паролей и простой единый вход, попросите пользователей синхронизировать хэшированные пароли и функции единого входа в **"on"** , как показано ниже.

   ![](./media/how-to-connect-staged-rollout/sr4.png)

   ![](./media/how-to-connect-staged-rollout/sr5.png)

3. Добавьте соответствующие группы к компоненту, чтобы включить сквозную аутентификацию и простой единый вход. Прежде чем допустить время ожидания UX, убедитесь, что в группах безопасности не более 200 членов.

   ![](./media/how-to-connect-staged-rollout/sr6.png)

   >[!NOTE]
   >Элементы в группе автоматически включаются для поэтапного развертывания. Вложенные и динамические группы не поддерживаются для промежуточного развертывания.

## <a name="auditing"></a>Аудит

Мы включили события аудита для различных действий, выполняемых для промежуточного развертывания.

- Событие аудита при включении поэтапного развертывания для синхронизации хэша паролей/сквозной проверки подлинности или простого единого входа.

  >[!NOTE]
  >Событие аудита, регистрируемое при включении Сеамлессссо **с помощью стажедроллаут** .

  ![](./media/how-to-connect-staged-rollout/sr7.png)

  ![](./media/how-to-connect-staged-rollout/sr8.png)

- Событие аудита при добавлении группы в синхронизацию хэша паролей/сквозную проверку подлинности или простой единый вход.

  >[!NOTE]
  >Событие аудита, регистрируемое при добавлении группы в синхронизацию хэша паролей для поэтапного развертывания

  ![](./media/how-to-connect-staged-rollout/sr9.png)

  ![](./media/how-to-connect-staged-rollout/sr10.png)

- Событие аудита, когда пользователь, который был добавлен в группу, включен для поэтапного развертывания

  ![](media/how-to-connect-staged-rollout/sr11.png)

  ![](./media/how-to-connect-staged-rollout/sr12.png)

## <a name="validation"></a>Проверка

Чтобы проверить вход с помощью синхронизации хэша паролей или сквозной проверки подлинности (вход пользователя или пароля), выполните следующие действия.

1. Перейдите в <https://myapps.microsoft.com> в частном сеансе браузера из экстрасети и введите UserPrincipalName (UPN) учетной записи пользователя, выбранной для промежуточного развертывания.

1. Если пользователь нацелен на промежуточное развертывание, он не будет перенаправлен на страницу федеративного входа, а вместо этого будет предложено войти на страницу входа с фирменным названием клиента Azure AD.

1. Убедитесь, что вход в [отчет о действиях входа в Azure AD](../reports-monitoring/concept-sign-ins.md) успешно выполнен с помощью фильтра userPrincipalName..

Чтобы проверить вход с помощью простого единого входа, выполните следующие действия.

1. Перейдите к <https://myapps.microsoft.com>/в частном сеансе браузера из интрасети и введите UserPrincipalName (UPN) учетной записи пользователя, выбранной для промежуточного развертывания.

1. Если пользователь нацелен на промежуточное развертывание простого единого входа, пользователь увидит «попытку входа в систему...». сообщение перед автоматическим входом в.

1. Убедитесь, что вход в [отчет о действиях входа в Azure AD](../reports-monitoring/concept-sign-ins.md) успешно выполнен, выполнив фильтрацию с userPrincipalName.

Чтобы проверить, все ли пользователи работают с поставщиками Федерации:

Ниже показано, как можно проконтролировать вход пользователей в AD FS для выбранных промежуточных пользователей с помощью [этих инструкций](https://docs.microsoft.com/windows-server/identity/ad-fs/troubleshooting/ad-fs-tshoot-logging#types-of-events). Проверьте документацию поставщика о том, как это проверить у сторонних поставщиков Федерации.

## <a name="roll-back"></a>Откат

### <a name="remove-a-user-from-staged-rollout"></a>Удаление пользователя из промежуточного развертывания

1.  Удаление пользователя из группы отключает промежуточное развертывание для пользователя.

2.  Если вы хотите отключить функцию промежуточного развертывания, перейдите в режим **"Выкл."** , чтобы отключить промежуточное развертывание.


## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

-   **Вопрос. может ли клиент использовать эту возможность в рабочей среде?**

-   Ответ. Да, эта функция может использоваться в рабочем клиенте, но рекомендуется сначала попробовать эту возможность в тестовом клиенте.

-   **Вопрос. можно ли использовать эту функцию для поддержания постоянного "сосуществования", где некоторые пользователи используют Федеративной проверку подлинности и другие облачные проверки подлинности?**

-   Ответ. нет, эта функция предназначена для перехода с Федеративной на облачную проверку подлинности на этапы, а затем для последующей перерезания в облачную аутентификацию. Не рекомендуется использовать постоянное смешанное состояние, так как это может привести к непредвиденным потокам проверки подлинности.

-   **Вопрос. можно ли использовать PowerShell для выполнения промежуточного развертывания?**

-   Ответ. Да, ознакомьтесь с документацией по использованию PowerShell для выполнения промежуточного [развертывания.](https://docs.microsoft.com/powershell/module/azuread/?view=azureadps-2.0-preview#staged_rollout)

## <a name="next-steps"></a>Дальнейшие действия
- [Предварительная версия AzureAD 2,0](https://docs.microsoft.com/powershell/module/azuread/?view=azureadps-2.0-preview#staged_rollout )
