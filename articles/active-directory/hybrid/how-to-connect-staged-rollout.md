---
title: 'Azure AD Connect: облачная аутентификация через промежуточное развертывание | Документация Майкрософт'
description: В этой статье объясняется, как выполнить миграцию из федеративной проверки подлинности в облачную аутентификацию с помощью промежуточного развертывания.
author: billmath
manager: daveba
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 11/07/2019
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: f3044ebdd716eb85dc63d3a77089912d0d51d8b6
ms.sourcegitcommit: a5ebf5026d9967c4c4f92432698cb1f8651c03bb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/08/2019
ms.locfileid: "74915231"
---
# <a name="migrate-to-cloud-authentication-by-using-staged-rollout-preview"></a>Миграция в облачную аутентификацию с помощью промежуточного развертывания (Предварительная версия)

С помощью подхода поэтапного развертывания можно выполнить миграцию из федеративной проверки подлинности в облачную аутентификацию. В этой статье описывается, как сделать этот параметр. Однако перед началом промежуточного развертывания следует принять во внимание последствия, если выполняется одно или несколько из следующих условий.
    
-  Сейчас вы используете локальный сервер многофакторной идентификации. 
-  Вы используете смарт-карты для проверки подлинности. 
-  Текущий сервер предлагает определенные функции, предназначенные только для Федерации.

Прежде чем использовать эту функцию, мы рекомендуем ознакомиться с нашим руководством по выбору правильного метода проверки подлинности. Дополнительные сведения см. в таблице "Сравнение методов" статьи [Выбор правильного метода проверки подлинности для Azure Active Directory гибридного решения для идентификации](https://docs.microsoft.com/azure/security/fundamentals/choose-ad-authn#comparing-methods).

Общие сведения о функции см. в разделе «Azure Active Directory: что такое промежуточное развертывание?». роли

>[!VIDEO https://www.microsoft.com/videoplayer/embed/RE3inQJ]



## <a name="prerequisites"></a>Технические условия

-   У вас есть клиент Azure Active Directory (Azure AD) с федеративными доменами.

-   Было принято решение перейти на один из двух вариантов:
    - **Параметр A** - *синхронизации хэшей паролей (синхронизация)*  + *простой единый вход (SSO)*
    - **Вариант б** - *сквозная проверка подлинности* + *простой единый вход*
    
    Несмотря на то, что *простой единый вход* не является обязательным, рекомендуется включить его для автоматического входа пользователей, работающих на компьютерах, присоединенных к домену, из корпоративной сети.

-   Вы настроили все необходимые политики условного доступа для клиентов, которые необходимы для пользователей, которые переносятся в облачную аутентификацию.

-   Если вы планируете использовать многофакторную идентификацию Azure, мы рекомендуем использовать [согласованную регистрацию для самостоятельного сброса пароля (SSPR) и многофакторной проверки подлинности](../authentication/concept-registration-mfa-sspr-combined.md) , чтобы пользователи зарегистрировали свои методы проверки подлинности один раз.

-   Чтобы использовать функцию промежуточного развертывания, необходимо быть глобальным администратором вашего клиента.

-   Чтобы обеспечить *простой единый вход* для конкретного Active Directory леса, необходимо быть администратором домена.

## <a name="supported-scenarios"></a>Поддерживаемые сценарии использования.

Для промежуточного развертывания поддерживаются следующие сценарии. Эта функция работает только для:

- Пользователи, подготовленные для Azure AD с помощью Azure AD Connect. Он не применяется к облачным пользователям.

- Трафик входа пользователя в браузерах и *современных клиентов проверки подлинности* . Приложения или облачные службы, использующие устаревшую проверку подлинности, будут возвращаться к федеративным потокам проверки подлинности. Примером может быть Exchange Online с отключенной современной проверкой подлинности или Outlook 2010, который не поддерживает современную проверку подлинности.

## <a name="unsupported-scenarios"></a>Неподдерживаемые сценарии

Следующие сценарии не поддерживаются для промежуточного развертывания:

- Некоторые приложения передают параметр запроса "domain_hint" в Azure AD во время проверки подлинности. Эти последовательности будут продолжены, а пользователи, для которых включено промежуточное развертывание, будут продолжать использовать федерацию для проверки подлинности.

<!-- -->

- Администраторы могут развернуть проверку подлинности в облаке с помощью групп безопасности. Чтобы избежать задержки синхронизации при использовании локальных Active Directory групп безопасности, рекомендуется использовать облачные группы безопасности. Применяются следующие условия.

    - Для каждого компонента можно использовать не более 10 групп. Это значит, что для *синхронизации хэша паролей*, *сквозной проверки подлинности*и *простого единого входа*можно использовать 10 групп.
    - Вложенные группы *не поддерживаются*. Эта область применима и к общедоступной версии.
    - Динамические группы *не поддерживаются* для промежуточного развертывания.
    - Объекты контакта внутри группы будут блокировать Добавление группы.

- Вам все равно нужно сделать окончательный прямую миграцию из Федеративной в облачную аутентификацию с помощью Azure AD Connect или PowerShell. Промежуточное развертывание не переключает домены с федеративного на управляемый.

- При первом добавлении группы безопасности для поэтапного развертывания вы можете ограничиться 200 пользователями, чтобы избежать истечения времени ожидания UX. После добавления группы к ней можно добавить дополнительных пользователей, если это необходимо.

## <a name="get-started-with-staged-rollout"></a>Приступая к работе с промежуточным развертыванием

Чтобы проверить вход с *синхронизацией хэшей паролей* с помощью промежуточного развертывания, выполните инструкции, приведенные в следующем разделе.

Сведения о том, какие командлеты PowerShell следует использовать, см. в [предварительной версии Azure AD 2,0](https://docs.microsoft.com/powershell/module/azuread/?view=azureadps-2.0-preview#staged_rollout).

## <a name="pre-work-for-password-hash-sync"></a>Предварительная работа для синхронизации хэша паролей

1. Включите  *синхронизации хэша паролей* из [дополнительных компонентов](how-to-connect-install-custom.md#optional-features) странице в Azure AD Connect. 

   ![Снимок экрана со страницей "дополнительные компоненты" в Azure Active Directory Connect](media/how-to-connect-staged-rollout/sr1.png)

1. Убедитесь, что выполнен полный цикл *синхронизации хэша паролей* , чтобы все хэши паролей пользователей были синхронизированы с Azure AD. Чтобы проверить состояние *синхронизации хэша паролей*, можно использовать диагностику PowerShell в статье [Устранение неполадок синхронизации хэшей паролей с Azure AD Connect синхронизацией](tshoot-connect-password-hash-synchronization.md).

   ![Снимок экрана журнала устранения неполадок AADConnect](./media/how-to-connect-staged-rollout/sr2.png)

Если вы хотите протестировать *сквозную проверку подлинности* с помощью промежуточного развертывания, включите ее, следуя инструкциям, приведенным в следующем разделе.

## <a name="pre-work-for-pass-through-authentication"></a>Предварительная работа для сквозной проверки подлинности

1. Укажите сервер под управлением Windows Server 2012 R2 или более поздней версии, на котором должен выполняться агент *сквозной аутентификации* . 

   *Не* выбирайте сервер Azure AD Connect. Убедитесь, что сервер присоединен к домену, может проверять подлинность выбранных пользователей с Active Directory и может взаимодействовать с Azure AD на исходящих портах и URL-адресах. Дополнительные сведения см. в разделе "шаг 1. Проверка предварительных требований" [краткого руководства: простой единый вход Azure AD](how-to-connect-sso-quick-start.md).

1. [Скачайте агент проверки подлинности Azure AD Connect](https://aka.ms/getauthagent)и установите его на сервере. 

1. Чтобы включить [высокий уровень доступности](how-to-connect-sso-quick-start.md), установите дополнительные агенты аутентификации на других серверах.

1. Убедитесь, что [Параметры смарт-блокировки](../authentication/howto-password-smart-lockout.md) настроены соответствующим образом. Это позволит гарантировать, что локальные учетные записи пользователей Active Directory не блокируются недопустимыми субъектами.

Рекомендуется включить *простой единый вход* независимо от метода входа (*Синхронизация хэша паролей* или *сквозная проверка подлинности*), выбранного для поэтапного развертывания. Чтобы включить *простой единый вход*, выполните инструкции, приведенные в следующем разделе.

## <a name="pre-work-for-seamless-sso"></a>Предварительная работа для простого единого входа

Включите *простой единый вход* в Active Directory лесах с помощью PowerShell. Если у вас несколько Active Directory леса, включите их для каждого леса отдельно.  *Простой единый вход* срабатывает только для пользователей, которые выбраны для поэтапного развертывания. Это не влияет на текущую настройку Федерации.

Включите *простой единый вход* , выполнив следующие действия.

1. Войдите на сервер Azure AD Connect.

2. Перейдите в папку *% ProgramFiles%\\Microsoft Azure Active Directory Connect* .

3. Импортируйте модуль PowerShell для *простого единого входа* , выполнив следующую команду: 

   `Import-Module .\AzureADSSO.psd1`

4. Откройте сеанс PowerShell от имени администратора. В PowerShell вызовите `New-AzureADSSOAuthenticationContext`. Эта команда открывает панель, в которой можно ввести учетные данные глобального администратора клиента.

5. Вызовите `Get-AzureADSSOStatus | ConvertFrom-Json`. Эта команда отображает список лесов Active Directory (см. список "домены"), в которых включена эта функция. По умолчанию для него задано значение false на уровне клиента.

   ![Пример выходных данных Windows PowerShell](./media/how-to-connect-staged-rollout/sr3.png)

6. Вызовите `$creds = Get-Credential`. В командной строке введите учетные данные администратора домена для предполагаемого Active Directory леса.

7. Вызовите `Enable-AzureADSSOForest -OnPremCredentials $creds`. Эта команда создает учетную запись компьютера AZUREADSSOACC из локального контроллера домена для Active Directory леса, необходимого для *простого единого входа*.

8. Для *простого единого входа* необходимо, чтобы URL-адреса были в зоне интрасети. Сведения о развертывании этих URL-адресов с помощью групповых политик см. в разделе [Краткое руководство. простой единый вход Azure AD](how-to-connect-sso-quick-start.md#step-3-roll-out-the-feature).

9. Для получения полного пошагового руководства можно также загрузить наши [планы развертывания](https://aka.ms/SeamlessSSODPDownload) для *простого единого входа*.

## <a name="enable-staged-rollout"></a>Включить промежуточное развертывание

Чтобы развернуть конкретный компонент (*сквозная проверка подлинности*, *Синхронизация хэша паролей*или *простой единый вход*) к выбранному набору пользователей в группе, следуйте инструкциям в следующих разделах.

### <a name="enable-a-staged-rollout-of-a-specific-feature-on-your-tenant"></a>Включение промежуточного развертывания определенной функции в клиенте

Вы можете развернуть один из следующих вариантов:

- **Параметр A** - *синхронизации хэша паролей* + *простой единый вход*
- **Вариант б** - *сквозная проверка подлинности* + *простой единый вход*
- **Не поддерживается** - *синхронизации хэша паролей* + *сквозной АУТЕНТИФИКАЦИи* + *простой единый вход*

Выполните следующее:

1. Чтобы получить доступ к службе предварительной версии, войдите на [портал Azure AD](https://aka.ms/stagedrolloutux).

2. Выберите ссылку **включить промежуточное развертывание для управляемого входа пользователя (Предварительная версия)** .

   Например, если вы хотите включить *параметр A*, подвиньте флажок **Синхронизация хэша паролей** и прозрачный элемент управления **единого входа** на **вкл**., как показано на следующих изображениях.

   ![Страница Azure AD Connect](./media/how-to-connect-staged-rollout/sr4.png)

   ![Страница "Включение компонентов с промежуточным развертыванием (Предварительная версия)"](./media/how-to-connect-staged-rollout/sr5.png)

3. Добавьте группы в компонент, чтобы включить *сквозную аутентификацию* и *простой единый вход*. Чтобы избежать истечения времени ожидания UX, убедитесь, что группы безопасности содержат не более 200 членов изначально.

   ![Страница "Управление группами для синхронизации хэшей паролей (Предварительная версия)"](./media/how-to-connect-staged-rollout/sr6.png)

   >[!NOTE]
   >Элементы в группе автоматически включаются для поэтапного развертывания. Вложенные и динамические группы не поддерживаются для промежуточного развертывания.

## <a name="auditing"></a>Аудит

Мы включили события аудита для различных действий, выполняемых для поэтапного развертывания:

- Событие аудита при включении поэтапного развертывания для *синхронизации хэша паролей*, *сквозной проверки подлинности*или *простого единого входа*.

  >[!NOTE]
  >Событие аудита регистрируется при включении *простого единого входа* с помощью промежуточного развертывания.

  ![Панель "Создание политики развертывания для компонента" — Вкладка "действия"](./media/how-to-connect-staged-rollout/sr7.png)

  ![Вкладка "Создание политики развертывания для компонента" — измененные свойства](./media/how-to-connect-staged-rollout/sr8.png)

- Событие аудита при добавлении группы в *синхронизацию хэша паролей*, *сквозную аутентификацию*или *простой единый вход*.

  >[!NOTE]
  >Событие аудита регистрируется при добавлении группы в *синхронизацию хэша паролей* для поэтапного развертывания.

  ![Панель "Добавление группы в развертывание компонента" — Вкладка "действия"](./media/how-to-connect-staged-rollout/sr9.png)

  ![Вкладка "Добавление группы в развертывание компонента" — измененные свойства](./media/how-to-connect-staged-rollout/sr10.png)

- Событие аудита, когда пользователь, который был добавлен в группу, включен для поэтапного развертывания.

  ![Панель "Добавление пользователя в развертывание компонента" — Вкладка "действия"](media/how-to-connect-staged-rollout/sr11.png)

  ![Панель "Добавление пользователя в развертывание компонента" — Вкладка "целевые объекты"](./media/how-to-connect-staged-rollout/sr12.png)

## <a name="validation"></a>Проверка

Чтобы проверить вход с помощью *синхронизации хэша паролей* или *сквозной проверки подлинности* (вход пользователя и пароля), выполните следующие действия.

1. В экстрасети перейдите на [страницу приложения](https://myapps.microsoft.com) в частном сеансе браузера и введите USERPRINCIPALNAME (UPN) учетной записи пользователя, выбранной для поэтапного развертывания.

   Пользователи, нацеленные на промежуточное развертывание, не перенаправляются на вашу страницу федеративного входа. Вместо этого им предлагается войти на страницу входа с фирменным названием клиента Azure AD.

1. Убедитесь, что вход в [отчет о действиях входа в Azure AD](../reports-monitoring/concept-sign-ins.md) успешно выполнен, выполнив фильтрацию с userPrincipalName.

Чтобы проверить вход с помощью *простого единого входа*, выполните следующие действия.

1. В интрасети перейдите на [страницу приложения](https://myapps.microsoft.com) в частном сеансе браузера и введите USERPRINCIPALNAME (UPN) учетной записи пользователя, выбранной для поэтапного развертывания.

   Пользователи, нацеленные на промежуточное развертывание *простого единого входа* , представляют собой "попытку входа..." сообщение перед тем, как они вошли в автоматическом режиме.

1. Убедитесь, что вход в [отчет о действиях входа в Azure AD](../reports-monitoring/concept-sign-ins.md) успешно выполнен, выполнив фильтрацию с userPrincipalName.

   Для отслеживания входов пользователей, которые по-прежнему возникают в службы федерации Active Directory (AD FS) (AD FS) для выбранных пользователей с промежуточным развертыванием, следуйте инструкциям в статье [AD FS устранение неполадок: события и ведение журнала](https://docs.microsoft.com/windows-server/identity/ad-fs/troubleshooting/ad-fs-tshoot-logging#types-of-events). Проверьте документацию поставщика о том, как это проверить на сторонних поставщиках Федерации.

## <a name="remove-a-user-from-staged-rollout"></a>Удаление пользователя из промежуточного развертывания

Удаление пользователя из группы отключает промежуточное развертывание для этого пользователя. Чтобы отключить функцию промежуточного развертывания, снова подвиньте элемент управления в **Off**.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

**Вопрос. можно ли использовать эту возможность в рабочей среде?**

Ответ. Да, вы можете использовать эту функцию в рабочем клиенте, но рекомендуется сначала попробовать ее в тестовом клиенте.

**Вопрос. можно ли использовать эту функцию для поддержания постоянного "сосуществования", где некоторые пользователи используют Федеративная аутентификация и другие используют облачную проверку подлинности?**

Ответ. нет, эта функция предназначена для перехода с Федеративной на облачную проверку подлинности на этапы, а затем для последующей перерезания в облачную аутентификацию. Не рекомендуется использовать постоянное смешанное состояние, так как этот подход может привести к непредвиденным потокам проверки подлинности.

**Вопрос. можно ли использовать PowerShell для выполнения промежуточного развертывания?**

Ответ. Да. Сведения об использовании PowerShell для выполнения промежуточного развертывания см. в статье [Предварительная версия Azure AD](https://docs.microsoft.com/powershell/module/azuread/?view=azureadps-2.0-preview#staged_rollout).

## <a name="next-steps"></a>Дальнейшие действия
- [Предварительная версия Azure AD 2,0](https://docs.microsoft.com/powershell/module/azuread/?view=azureadps-2.0-preview#staged_rollout )
