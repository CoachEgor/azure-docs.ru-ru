---
title: 'Azure AD Connect выполняет следующие функции: Выборочная установка | Документация Майкрософт'
description: В этом документе описаны параметры выборочной установки для Azure AD Connect. Используйте эти инструкции для установки Active Directory с помощью Azure AD Connect.
services: active-directory
keywords: что такое Azure AD Connect, установка Active Directory, необходимые компоненты для Azure AD
documentationcenter: ''
author: billmath
manager: daveba
ms.assetid: 6d42fb79-d9cf-48da-8445-f482c4c536af
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 09/10/2020
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: db10f53033e305aa2306bce230e7880140f35189
ms.sourcegitcommit: a422b86148cba668c7332e15480c5995ad72fa76
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/30/2020
ms.locfileid: "91578294"
---
# <a name="custom-installation-of-azure-ad-connect"></a>Выборочная установка Azure AD Connect
Azure AD Connect **пользовательские параметры** используются для установки дополнительных параметров.  Например, если у вас несколько лесов или вы хотите настроить дополнительные компоненты. Они также используются в тех случаях, когда [**экспресс-установка**](how-to-connect-install-express.md) не соответствует требованиям развертывания или топологии.

Перед установкой Azure AD Connect [скачайте Azure AD Connect](https://go.microsoft.com/fwlink/?LinkId=615771) и выполните предварительные шаги, перечисленные в перечне [требований к оборудованию и программному обеспечению](how-to-connect-install-prerequisites.md). Кроме того, убедитесь в наличии учетных записей, описанных в статье [Azure AD Connect: учетные записи и разрешения](reference-connect-accounts-permissions.md).

## <a name="custom-settings-installation-of-azure-ad-connect"></a>Выборочная установка Azure AD Connect с настраиваемыми параметрами

### <a name="express-settings"></a>Стандартные параметры
На этой странице щелкните **Настроить**, чтобы запустить установку с настраиваемыми параметрами.  Оставшаяся часть этого документа пошагова описывает различные экраны мастера для выборочной установки.  Приведенные ниже ссылки позволяют быстро переходить к сведениям о конкретном экране мастера.

- [Установка необходимых компонентов](#install-required-components)
- [Вход пользователя](#user-sign-in)
- [Подключение к Azure AD](#connect-to-azure-ad)
- [Страницы в разделе "Синхронизация"](#pages-under-the-sync-section)

### <a name="install-required-components"></a>Установка необходимых компонентов
При установке служб синхронизации вы можете пропустить раздел с дополнительными настройками, чтобы служба Azure AD Connect настроила все автоматически. Он настраивает экземпляр SQL Server 2012 Express LocalDB, создает соответствующие группы и назначает разрешения. Если вы хотите изменить значения по умолчанию, можно использовать это действие, установив соответствующие флажки.  В следующей таблице приведена сводка по этим параметрам и ссылки на дополнительные сведения. 

![Необходимые компоненты](./media/how-to-connect-install-custom/requiredcomponents2.png)

| Дополнительная настройка | Описание |
| --- | --- |
|Укажите пользовательское расположение установки| Позволяет изменить путь установки по умолчанию для Azure AD Connect.|
| Использование существующего SQL Server |Позволяет указать имя SQL Server и имя экземпляра. Выберите этот параметр, если у вас уже есть сервер базы данных AD, который вы хотите использовать. Если для SQL Server не разрешен просмотр, в поле **Имя экземпляра** следует ввести имя экземпляра и через запятую номер порта.  Затем укажите имя базы данных Azure AD Connect.  Ваши права SQL определяют, будет ли создана база данных или администратору SQL нужно создать ее заранее.  Если у вас есть разрешения SA SQL, см. раздел [Установка с использованием существующей базы данных](how-to-connect-install-existing-database.md).  Если у вас есть делегированные разрешения (DBO), см. раздел [Установка Azure AD Connect с делегированными разрешениями администратора SQL](how-to-connect-install-sql-delegation.md). |
| Использование существующей учетной записи службы |По умолчанию Azure AD Connect использует учетную запись виртуальной службы для служб синхронизации. Если вы используете удаленный экземпляр SQL Server или требующий аутентификации прокси-сервер, вам необходима **управляемая учетная запись службы** или учетная запись службы в домене и пароль. В этом случае укажите учетную запись для использования. Убедитесь, что пользователь, выполняющий установку, использует имя для входа SA в SQL, чтобы создать имя для входа в учетную запись службы.  См. статью [Azure AD Connect: учетные записи и разрешения](reference-connect-accounts-permissions.md#adsync-service-account). </br></br>В последней сборке внешнюю подготовку базы данных может выполнять администратор SQL, а установку — администратор Azure AD Connect с правами владельца базы данных.  Дополнительные сведения см. в статье [Install Azure AD Connect using SQL delegated administrator permissions](how-to-connect-install-sql-delegation.md) (Установка Azure AD Connect с использованием делегированных разрешений администратора SQL).|
| Указание пользовательских групп синхронизации |По умолчанию при установке служб синхронизации Azure AD Connect создает на сервере четыре локальные группы. Вот эти группы: "Администраторы", "Операторы", "Обзор", "Сброс пароля". Здесь также можно указать собственные группы. Группы должны размещаться локально на сервере и могут находиться в домене. |
|Импорт параметров синхронизации (Предварительная версия)|Позволяет импортировать параметры из других версий Azure AD Connect.  Дополнительные сведения см. в разделе [Импорт и экспорт параметров конфигурации Azure AD Connect](how-to-connect-import-export-config.md).|

### <a name="user-sign-in"></a>Вход пользователя
После установки необходимых компонентов вам будет предложено выбрать метод единого входа для пользователей. В таблице ниже содержится краткое описание доступных параметров. Полное описание способов входа см. в статье [Параметры входа в Azure AD Connect](plan-connect-user-signin.md).

![Снимок экрана, на котором показана страница "вход пользователя" с выбранным параметром "Синхронизация хэша паролей".](./media/how-to-connect-install-custom/usersignin4.png)

| Метод единого входа | Описание |
| --- | --- |
| Синхронизация хэша паролей |Пользователи могут входить в облачные службы Майкрософт, такие как Microsoft 365, используя тот же пароль, который они используют в локальной сети. Пароли пользователей синхронизируются в Azure путем хэширования, а аутентификация выполняется в облаке. Дополнительные сведения см. в статье [Реализация синхронизации паролей с помощью Azure AD Connect Sync](how-to-connect-password-hash-synchronization.md). |
|Сквозная проверка подлинности|Пользователи могут входить в облачные службы Майкрософт, такие как Microsoft 365, используя тот же пароль, который они используют в локальной сети.  Пароль пользователя передается локальному контроллеру домена Active Directory для проверки.
| Федерация с AD FS |Пользователи могут входить в облачные службы Майкрософт, такие как Microsoft 365, используя тот же пароль, который они используют в локальной сети.  Во время входа пользователи перенаправляются в локальный экземпляр AD FS, так как аутентификация выполняется локально. |
| Федерация с PingFederate|Пользователи могут входить в облачные службы Майкрософт, такие как Microsoft 365, используя тот же пароль, который они используют в локальной сети.  Во время входа пользователи перенаправляются в локальный экземпляр PingFederate и аутентификация выполняется локально. |
| Не настраивать |Ни один компонент для входа пользователя не устанавливается и не настраивается. Выберите этот параметр, если у вас уже есть сервер федерации стороннего производителя или другое локальное решение. |
|Включение единого входа|Этот параметр доступен для синхронизации хэша паролей и сквозной проверки подлинности. С его помощью пользователи настольных компьютеров могут воспользоваться единым входом в корпоративной сети. Дополнительные сведения см. в статье о [едином входе](how-to-connect-sso.md). </br>Примечание для пользователей служб федерации Active Directory. Этот параметр недоступен, так как службы федерации Active Directory обеспечивают те же возможности единого входа.</br>

### <a name="connect-to-azure-ad"></a>Подключение к Azure AD
В диалоговом окне "Подключение к Azure AD" введите учетную запись и пароль глобального администратора. Если на предыдущей странице вы выбрали параметр **Федерация с AD FS**, не используйте для входа учетную запись домена, который планируется включить в федерацию. Мы рекомендуем использовать учетную запись в домене по умолчанию ( **onmicrosoft.com** ), которая предоставляется вместе с клиентом Azure AD.

Эта учетная запись используется только для создания учетной записи службы в Azure AD и не используется после завершения работы мастера.  
![Вход пользователя](./media/how-to-connect-install-custom/connectaad.png)

Если для учетной записи глобального администратора включена MFA, необходимо еще раз ввести пароль во всплывающем окне на странице входа и завершить запрос MFA. Возможно, для запроса понадобится предоставить код проверки или выполнить телефонный звонок.  
![Вход пользователя в MFA](./media/how-to-connect-install-custom/connectaadmfa.png)

Для учетной записи глобального администратора также может быть включено [управление привилегированными пользователями](../privileged-identity-management/pim-getting-started.md).

Если вы получаете сообщение об ошибке и испытываете проблемы с подключением, см. сведения в статье [Устранение неполадок подключения в Azure AD Connect](tshoot-connect-connectivity.md).

## <a name="pages-under-the-sync-section"></a>Страницы в разделе "Синхронизация"

### <a name="connect-your-directories"></a>Подключение к каталогам
Чтобы подключиться к службе домена Active Directory, Azure AD Connect необходимо имя леса и учетные данные учетной записи с достаточными разрешениями.

![Снимок экрана, на котором показана страница "подключение каталогов".](./media/how-to-connect-install-custom/connectdir01.png)

После входа в лес щелкните **Добавить каталог**. Появится всплывающее диалоговое окно со следующими параметрами:

| Параметр | Описание |
| --- | --- |
| Создать учетную запись | Выберите этот параметр, если вы хотите, чтобы мастер Azure AD Connect создал учетную запись AD DS, необходимую для Azure AD Connect для подключения к лесу AD во время синхронизации каталогов. Выбрав его, введите имя пользователя и пароль для учетной записи администратора предприятия. Указанная учетная запись администратора предприятия будет использоваться мастером Azure AD Connect для создания необходимой учетной записи AD DS. Вы можете указать имя домена в формате NetBios, либо ввести полное доменное имя, т. е. FABRIKAM\administrator или fabrikam.com\administrator. |
| Использовать существующую учетную запись | Выберите этот параметр, если вы хотите предоставить имеющуюся учетную запись AD DS, которая будет использоваться Azure AD Connect для подключения к лесу AD во время синхронизации каталогов. Вы можете указать имя домена в формате NetBios либо ввести полное доменное имя, т. е. FABRIKAM\syncuser или fabrikam.com\syncuser. Эта учетная запись может принадлежать обычному пользователю, так как стандартных разрешений для чтения вполне достаточно. Однако для некоторых сценариев могут потребоваться дополнительные разрешения. Дополнительные сведения см. в разделе [Создание учетной записи AD DS](reference-connect-accounts-permissions.md#create-the-ad-ds-connector-account). |

![Подключение каталога](./media/how-to-connect-install-custom/connectdir02.png)

#### <a name="enterprise-admin-and-domain-admin-accounts-not-supported"></a>Учетные записи администратора предприятия и администратора домена не поддерживаются
Начиная со сборки 1.4.18.0, учетные записи администратора предприятия или администратора домена больше не поддерживаются как учетные записи соединителя AD DS.  При попытке ввести учетную запись администратора предприятия или администратора домена при задании параметра **Использовать существующую учетную запись** выводится следующая ошибка:

  **"Использование учетной записи администратора предприятия или домена в качестве учетной записи леса AD запрещено.  Разрешите Azure AD Connect создать учетную запись или укажите учетную запись синхронизации с правильными разрешениями.  &lt;Подробнее&gt;"**

### <a name="azure-ad-sign-in-configuration"></a>Конфигурация входа в Azure AD
На этой странице представлены сведения о доменах UPN, входящих в локальные доменные службы Active Directory и проверенных в Azure AD. Кроме того, здесь можно настроить атрибут для параметра userPrincipalName.

![Непроверенные домены](./media/how-to-connect-install-custom/aadsigninconfig2.png)  
Просмотрите каждый домен с отметкой **Не добавлено** и **Не проверено**. Убедитесь, что используемые домены прошли проверку в Azure AD. Проверив домены, щелкните значок обновления. Дополнительные сведения см. в статье о [добавлении и проверке домена](../fundamentals/add-custom-domain.md).

**UserPrincipalName** — атрибут userPrincipalName — это атрибут, который пользователи используют при входе в Azure AD и Microsoft 365. Используемые домены, которые также называются UPN-суффиксами, следует проверить в Azure AD до синхронизации пользователей. Мы рекомендуем оставить userPrincipalName как атрибут по умолчанию. Если этот атрибут не поддерживает маршрутизацию и его нельзя проверить, можно выбрать другой атрибут. Например, можно выбрать адрес электронной почты в качестве атрибута, содержащего идентификатор входа. Отличный от userPrincipalName атрибут называется **альтернативным идентификатором**. Значение альтернативного идентификатора должно соответствовать стандарту RFC822. Альтернативный идентификатор может использоваться для синхронизации хэша паролей, сквозной проверки подлинности и федерации. Атрибут не должен быть определен в Active Directory как многозначный, даже если он имеет только одно значение. Дополнительные сведения об альтернативном идентификаторе см. в разделе [Часто задаваемые вопросы](./how-to-connect-pta-faq.md#does-pass-through-authentication-support-alternate-id-as-the-username-instead-of-userprincipalname).

>[!NOTE]
> При включении сквозной проверки подлинности для продолжения работы с мастером у вас должен быть по крайней мере один проверенный домен.

> [!WARNING]
> Использование альтернативного идентификатора несовместимо со всеми Microsoft 365 рабочими нагрузками. Дополнительные сведения см. в статье [Настройка альтернативного идентификатора входа](/windows-server/identity/ad-fs/operations/configuring-alternate-login-id).
>
>

### <a name="domain-and-ou-filtering"></a>Фильтрация домена и подразделения
По умолчанию все домены и подразделения синхронизируются. Если вы не планируете синхронизировать с Azure AD некоторые домены или подразделения, их можно исключить.  
![Фильтрация домена и подразделения](./media/how-to-connect-install-custom/domainoufiltering.png)  
На этой странице мастера настраивается фильтрация по доменам и подразделениям. Если вы планируете внести изменения, сначала ознакомьтесь с [фильтрацией по домену](how-to-connect-sync-configure-filtering.md#domain-based-filtering) и [фильтрацией по подразделению](how-to-connect-sync-configure-filtering.md#organizational-unitbased-filtering). Некоторые подразделения важны для функциональных возможностей, и их выбор не следует отменять.

При использовании фильтрации по подразделениям с помощью Azure AD Connect версии 1.1.524.0 или более ранней новые подразделения, добавляемые позже, синхронизируются по умолчанию. Если требуется, чтобы новые подразделения не синхронизировались, такое поведение можно настроить после того, как мастер завершит работу с [фильтрацией по подразделениям](how-to-connect-sync-configure-filtering.md#organizational-unitbased-filtering). В Azure AD Connect версии 1.1.524.0 и более поздних вы можете указать, следует ли синхронизировать новые подразделения.

Если вы планируете использовать [фильтрацию по группам](#sync-filtering-based-on-groups), убедитесь, что подразделение с группой включено и не фильтруется с использованием фильтрации по подразделениям. Фильтрация по подразделениям выполняется до фильтрации по группам.

Некоторые домены могут быть недоступными из-за ограничений брандмауэра. Такие домены исключены по умолчанию, и для них будет отображаться предупреждение.  
![Недоступные домены](./media/how-to-connect-install-custom/unreachable.png)  
Если вы видите такое предупреждение, убедитесь, что эти домены действительно недоступны и это предупреждение не является ошибкой.

### <a name="uniquely-identifying-your-users"></a>Уникальная идентификация пользователей

#### <a name="select-how-users-should-be-identified-in-your-on-premises-directories"></a>Выбор способа идентификации пользователей в локальных каталогах
Функция согласования между лесами позволяет определить, как пользователи из лесов AD DS представлены в Azure AD. Пользователь может быть представлен во всех лесах только один раз или может иметь комбинацию включенных и отключенных учетных записей. В некоторых лесах пользователь также может быть представлен как контакт.

![Уникальная идентификация](./media/how-to-connect-install-custom/unique2.png)

| Параметр | Описание |
| --- | --- |
| [Пользователи представлены во всех лесах только один раз](plan-connect-topologies.md#multiple-forests-single-azure-ad-tenant) |В Azure AD все пользователи создаются как отдельные объекты. Объекты не соединены в метавселенной. |
| [Атрибут почты](plan-connect-topologies.md#multiple-forests-single-azure-ad-tenant) |Этот параметр соединяет пользователей и контакты, если атрибут почты имеет то же значение в разных лесах. Используйте этот параметр, если контакты созданы с помощью GALSync. Если выбран этот параметр, объекты-пользователи с незаполненным атрибутом Mail не будут синхронизироваться с Azure AD. |
| [ObjectSID и msExchangeMasterAccountSID/ msRTCSIP-OriginatorSid](plan-connect-topologies.md#multiple-forests-single-azure-ad-tenant) |Этот параметр соединяет включенного пользователя в лесу учетной записи с отключенным пользователем в лесу ресурсов. В Exchange такая конфигурация называется связанным почтовым ящиком. Этот параметр можно также применять при использовании только Lync и отсутствии Exchange в лесу ресурсов. |
| sAMAccountName и MailNickName |Это параметр соединяет атрибуты, в которых может быть указан идентификатор пользователя для входа. |
| Определенный атрибут |Этот параметр позволяет выбрать собственный атрибут. Если выбран этот параметр, объекты-пользователи с незаполненным атрибутом (selected) не будут синхронизироваться с Azure AD. **Ограничение:** Для этого параметра доступны только те атрибуты, которые уже могут быть найдены в метавселенной. ". |

#### <a name="select-how-users-should-be-identified-with-azure-ad---source-anchor"></a>Выбор способа идентификации пользователей в Azure AD: привязка к источнику
Атрибут sourceAnchor остается неизменным в течение всего времени существования объекта-пользователя. Это первичный ключ, который связывает локального пользователя с пользователем в Azure AD.

| Параметр | Описание |
| --- | --- |
| Параметр "Azure управляет привязкой к источнику" | Выберите этот параметр, если вы хотите, чтобы среда Azure AD выбирала этот атрибут автоматически. Если вы выберете этот параметр, мастер Azure AD Connect применит логику выбора атрибута sourceAnchor, описанную в [руководстве по проектированию Azure AD Connect использование ms-DS-ConsistencyGuid в качестве sourceAnchor](plan-connect-design-concepts.md#using-ms-ds-consistencyguid-as-sourceanchor) Мастер сообщит, какой атрибут был выбран в качестве атрибута привязки к источнику после завершения выборочной установки. |
| Определенный атрибут | Выберите этот параметр, если вы хотите указать имеющийся атрибут AD в качестве атрибута sourceAnchor. |

Так как атрибут нельзя изменить, внимательно выбирайте атрибут для использования. Хорошим кандидатом является objectGUID. Этот атрибут не меняется, если учетная запись пользователя не перемещается между лесами и доменами. Не рекомендуется использовать атрибуты, которые меняются, когда пользователь меняет семейный статус или переходит на другую должность. Нельзя использовать атрибуты со знаком @-sign, поэтому адрес электронной почты и атрибут userPrincipalName также не должны использоваться. В атрибуте также учитывается регистр, поэтому при перемещении объекта между лесами обязательно сохраняйте верхний и нижний регистр. Двоичные атрибуты находятся в кодировке base64, но другие типы атрибутов остаются в некодированном виде. В сценариях федерации и некоторых интерфейсах Azure AD этот атрибут также известен как immutableID. Дополнительные сведения о привязке к источнику можно найти в описании [принципов проектирования](plan-connect-design-concepts.md#sourceanchor).

### <a name="sync-filtering-based-on-groups"></a>Фильтрация синхронизации на основе групп
Функция фильтрации на основе групп позволяет синхронизировать только небольшое подмножество объектов для пилотного развертывания. Чтобы использовать эту функцию, создайте группу в локальной службе Active Directory. Затем добавьте пользователей и группы, которые должны синхронизироваться с Azure AD как прямые участники. Позднее вы сможете добавлять пользователей в эту группу и удалять их, чтобы сохранить список объектов, которые должны присутствовать в Azure AD. Все объекты, которые вы хотите синхронизировать, должны быть непосредственными членами группы. Пользователи, группы, контакты и компьютеры или устройства должны быть прямыми участниками. Членство во вложенных группах не разрешено. При добавлении группы в качестве участника она добавляется без участников.

![Фильтрация синхронизации](./media/how-to-connect-install-custom/filter2.png)

> [!WARNING]
> Эта функция предназначена только для использования в пилотном развертывании. Не используйте ее для полноценного рабочего развертывания.
>
>

В полноценной рабочей среде трудно поддерживать одну группу со всеми объектами для синхронизации. Вместо этого следует использовать один из методов, описанных в статье о [настройке фильтрации](how-to-connect-sync-configure-filtering.md).

### <a name="optional-features"></a>Дополнительные функции
В этом диалоговом окне вы можете выбрать дополнительные функции для конкретных сценариев.

>[!WARNING]
>Средство Azure AD Connect **1.0.8641.0** и более ранних версий связано со службой контроля доступа Azure для компонента обратной записи паролей.  Поддержка этой службы будет прекращена **7 ноября 2018 года**.  Если вы используете любую из этих версий Azure AD Connect и включили компонент обратной записи паролей, возможно, пользователи не смогут изменить или сбросить свои пароли после прекращения поддержки службы. Компонент обратной записи паролей не будет поддерживаться с этими версиями Azure AD Connect.
>
>Дополнительные сведения о службе контроля доступа Azure см в [руководстве по переносу из службы контроля доступа Azure](../azuread-dev/active-directory-acs-migration.md).
>
>Чтобы загрузить новейшую версию Azure AD Connect, щелкните [здесь](https://www.microsoft.com/download/details.aspx?id=47594).

 ![Дополнительные функции](./media/how-to-connect-install-custom/optional2a.png)

> [!WARNING]
> Если у вас запущено средство синхронизации DirSync или Azure AD Sync, не активируйте функции обратной записи в Azure AD Connect.



| Дополнительные функции | Описание |
| --- | --- |
| Гибридное развертывание Exchange |Гибридное развертывание Exchange обеспечивает совместное существование почтовых ящиков Exchange как локально, так и в Microsoft 365. Azure AD Connect синхронизирует определенный набор [атрибутов](reference-connect-sync-attributes-synchronized.md#exchange-hybrid-writeback) из Azure AD с локальным каталогом. |
| Общедоступные папки почты Exchange | Функция общедоступных папок почты Exchange позволяет вам синхронизировать общедоступную папку с поддержкой электронной почты из вашего локального Active Directory с Azure AD. |
| Фильтрации приложений и атрибутов Azure AD |Включив фильтрацию приложений и атрибутов Azure AD, можно адаптировать набор синхронизированных атрибутов. При установке этого параметра в мастер добавляется две дополнительные страницы конфигурации. Дополнительные сведения см. в разделе [Фильтрации приложений и атрибутов Azure AD](#azure-ad-app-and-attribute-filtering). |
| Синхронизация хэша паролей |Этот параметр можно включить, если вы выбрали федерацию в качестве решения входа. В этом случае синхронизацию хэша паролей можно использовать в качестве резервного варианта. Дополнительные сведения см. в статье о [синхронизации хэша паролей](how-to-connect-password-hash-synchronization.md). </br></br>При выборе сквозной аутентификации этот параметр можно включить дополнительно, чтобы обеспечить поддержку старых клиентов. Кроме того, этот параметр можно использовать для резервного копирования. Дополнительные сведения см. в статье о [синхронизации хэша паролей](how-to-connect-password-hash-synchronization.md).|
| Компонент обратной записи паролей |При включении компонента обратной записи паролей изменения, внесенные в пароли в Azure AD, записываются в локальный каталог. Дополнительные сведения см. в статье [Приступая к работе с компонентами управления паролями](../authentication/tutorial-enable-sspr.md). |
| Обратная запись групп |Если используется функция **групп Microsoft 365** , эти группы можно представить в локальном Active Directory. Эта возможность доступна только при наличии Exchange в вашей локальной службе Active Directory. Дополнительные сведения см. в разделе [Azure AD Connectная обратная запись группы](how-to-connect-group-writeback.md)|
| Обратная запись устройств |Позволяет осуществлять обратную запись объектов устройств в вашу локальную доменную службу Active Directory в Azure AD для сценариев условного доступа. Дополнительные сведения см. в статье [Azure AD Connect: включение обратной записи устройств](how-to-connect-device-writeback.md). |
| Синхронизация атрибутов расширения каталога |При включении синхронизации атрибутов расширения каталогов заданные атрибуты синхронизируются с Azure AD. Дополнительные сведения см. в статье о [расширениях каталогов](how-to-connect-sync-feature-directory-extensions.md). |

### <a name="azure-ad-app-and-attribute-filtering"></a>Фильтрации приложений и атрибутов Azure AD
Если вы хотите ограничить перечень атрибутов, синхронизируемых с Azure AD, начните с выбора используемых служб. При изменении настроек на этой странице новую службу необходимо выбрать явно путем повторного запуска мастера установки.

![Приложения с дополнительными возможностями](./media/how-to-connect-install-custom/azureadapps2.png)

С учетом службы, выбранной на предыдущем этапе, отображаются все атрибуты, которые будут синхронизированы. Этот список сочетает в себе все типы объектов, для которых выполняется синхронизация. Если какие-либо атрибуты не нужно синхронизировать, их можно исключить из выбранного набора.

![Атрибуты для дополнительных возможностей](./media/how-to-connect-install-custom/azureadattributes2.png)

> [!WARNING]
> Удаление атрибутов может повлиять на функциональность. Рекомендации см. в разделе об [атрибутах для синхронизации](reference-connect-sync-attributes-synchronized.md#attributes-to-synchronize).
>
>

### <a name="directory-extension-attribute-sync"></a>Синхронизация атрибутов расширения каталога
Вы можете расширить схему в Azure AD, используя настраиваемые атрибуты, добавленные в вашей организации, или другие атрибуты в Active Directory. Чтобы использовать эту функцию, на странице **Дополнительные возможности** щелкните **Directory Extension attribute sync** (Синхронизация атрибутов расширений каталога). На этой странице можно выбрать дополнительные атрибуты для синхронизации.

>[!NOTE]
>Значения в поле доступных атрибутов следует вводить с учетом регистра.

![Расширения каталогов](./media/how-to-connect-install-custom/extension2.png)

Дополнительные сведения см. в статье о [расширениях каталогов](how-to-connect-sync-feature-directory-extensions.md).

### <a name="enabling-single-sign-on-sso"></a>Включение единого входа (SSO)
Настройка единого входа для использования с синхронизацией паролей или сквозной проверкой подлинности — простой процесс, который необходимо выполнить один раз для каждого леса, синхронизируемого с Azure AD. Конфигурация состоит из двух этапов:

1.  Создание необходимой учетной записи компьютера в локальном каталоге Active Directory.
2.  Настройка зоны интрасети клиентских компьютеров для поддержки единого входа.

#### <a name="create-the-computer-account-in-active-directory"></a>Создание учетной записи компьютера в Active Directory
Для каждого леса, добавленного с помощью Azure AD Connect, необходимо указать учетные данные администратора домена. Таким образом в каждом из них будет создана учетная запись компьютера. Учетные данные используются только для создания учетной записи и не хранятся, а также не используются для выполнения любой другой операции. Просто добавьте учетные данные на странице **Enable Single sign on** (Включение единого входа) мастера Azure AD Connect, как показано ниже:

![Включение единого входа](./media/how-to-connect-install-custom/enablesso.png)

>[!NOTE]
>Вы можете пропустить конкретный лес, если не хотите использовать единый вход для него.

#### <a name="configure-the-intranet-zone-for-client-machines"></a>Настройка зоны интрасети для клиентских компьютеров
Чтобы убедиться, что клиент автоматически подключается к зоне интрасети, проверьте, входит ли в нее URL-адрес. Таким образом при подключении к корпоративной сети присоединенный к домену компьютер автоматически отправляет билет Kerberos в Azure AD.
На компьютере с инструментами управления групповой политикой сделайте следующее:

1.  Откройте средства управления групповыми политиками.
2.  Измените групповую политику, которая будет применяться ко всем пользователям. Например, политику домена по умолчанию.
3.  Перейдите в раздел **Конфигурация пользователя\Административные шаблоны\Компоненты Windows\Internet Explorer\Панель управления браузером\Вкладка безопасности** и выберите **Список назначений зоны для веб-сайтов**, как на рисунке ниже.
4.  Включите политику и `https://autologon.microsoftazuread-sso.com` в диалоговом окне введите имя значения и значение `1` .
5.  Экран будет выглядеть примерно так:  
![Зоны интрасети](./media/how-to-connect-install-custom/sitezone.png)

6.  Нажмите кнопку **ОК** дважды.

## <a name="configuring-federation-with-ad-fs"></a>Настройка федерации с AD FS
Вы можете легко настроить службы федерации Active Directory с Azure AD Connect. Для этого достаточно нескольких щелчков. Ниже приведены компоненты, требуемые для настройки.

* Сервер Windows Server 2012 R2 или более поздней версии с поддержкой удаленного управления для сервера федерации.
* Сервер Windows Server 2012 R2 или более поздней версии с поддержкой удаленного управления для прокси-сервера веб-приложения.
* Сертификат TLS/SSL для имени службы федерации, которое предполагается использовать (например, sts.contoso.com)

>[!NOTE]
>Вы можете обновить TLS/SSL-сертификат фермы AD FS с помощью службы Azure AD Connect, даже если вы не используете эту службу для управления доверием федерации.

### <a name="ad-fs-configuration-pre-requisites"></a>Предварительные требования для настройки AD FS
Чтобы настроить ферму AD FS с помощью Azure AD Connect, обязательно включите WinRM на удаленных серверах. Убедитесь, что вы выполнили другие пункты из списка [предварительных требований федерации](how-to-connect-install-prerequisites.md#prerequisites-for-federation-installation-and-configuration). Кроме того, ознакомьтесь с требованиями к портам, перечисленным в разделе [Таблица 3. Azure AD Connect и серверы федерации и WAP](reference-connect-ports.md#table-3---azure-ad-connect-and-ad-fs-federation-serverswap).

### <a name="create-a-new-ad-fs-farm-or-use-an-existing-ad-fs-farm"></a>Создание новой фермы AD FS или использование существующей фермы AD FS
Вы можете использовать существующую ферму AD FS или создать новую. Если вы решили создать новую, необходимо предоставить TLS/SSL-сертификат. Если TLS/SSL-сертификат защищен паролем, появится запрос на ввод пароля.

![Ферма AD FS](./media/how-to-connect-install-custom/adfs1.png)

Если будет использоваться существующая ферма AD FS, вы сразу перейдете к диалоговому окну настройки отношений доверия между AD FS и Azure AD.

>[!NOTE]
>Azure AD Connect можно использовать для управления только одной фермой AD FS. Если в выбранной ферме AD FS настроено доверие федерации с Azure AD, доверие будет повторно создано с нуля с помощью Azure AD Connect.

### <a name="specify-the-ad-fs-servers"></a>Указание серверов AD FS
Укажите серверы, на которых требуется установить AD FS. Можно добавить один или несколько серверов в зависимости от потребностей запланированной загрузки. Прежде чем выполнить эту настройку, присоедините все серверы AD FS (не требуется для серверов WAP) к Active Directory. Мы рекомендуем установить одиночный сервер AD FS для тестовых и пилотных развертываний. Добавьте и разверните дополнительные серверы в соответствии с потребностями масштабирования, повторно запустив Azure AD Connect после начальной настройки.

> [!NOTE]
> Прежде чем выполнить эту настройку, убедитесь, что все серверы присоединены к домену AD.
>
>

![Серверы AD FS](./media/how-to-connect-install-custom/adfs2.png)

### <a name="specify-the-web-application-proxy-servers"></a>Указание прокси-серверов веб-приложений
Укажите серверы, которые будут использоваться как прокси-серверы веб-приложений. Прокси-сервер веб-приложения развертывается в промежуточной подсети (экстрасети с выходом) и поддерживает запросы проверки подлинности из внешней сети. Можно добавить один или несколько серверов в зависимости от потребностей запланированной загрузки. Мы рекомендуем установить одиночный прокси-сервер веб-приложений для тестовых и пилотных развертываний. Добавьте и разверните дополнительные серверы в соответствии с потребностями масштабирования, повторно запустив Azure AD Connect после начальной настройки. Для аутентификации из интрасети рекомендуется использовать эквивалентное число прокси-серверов.

> [!NOTE]
> <li> Если используемая учетная запись не имеет прав локального администратора на серверах AD FS, вам будет предложено ввести учетные данные администратора.</li>
> <li> Перед этим этапом убедитесь в наличии HTTP/HTTPS-подключения между сервером Azure AD Connect и прокси-сервером веб-приложений.</li>
> <li> Убедитесь в наличии HTTP/HTTPS-подключения между сервером веб-приложений и сервером AD FS, иначе аутентификация работать не будет.</li>
>

![Веб-приложение](./media/how-to-connect-install-custom/adfs3.png)

Вам будет предложено ввести учетные данные, чтобы сервер веб-приложений мог установить безопасное подключение к серверу AD FS. Эти учетные данные должны иметь права локального администратора на сервере AD FS.

![Прокси-сервер](./media/how-to-connect-install-custom/adfs4.png)

### <a name="specify-the-service-account-for-the-ad-fs-service"></a>Укажите учетную запись службы для службы AD FS
Для службы AD FS требуется учетная запись службы домена для проверки подлинности пользователей и поиска информации о пользователях в Active Directory. Поддерживаются два типа учетных записей службы.

* **Групповая управляемая учетная запись службы**. Этот тип учетной записи представлен в доменных службах Active Directory в Windows Server 2012. Этот тип учетной записи позволяет таким службам, как AD FS, использовать единый вход без постоянного обновления пароля учетной записи. Используйте этот параметр, если у вас уже есть контроллеры домена Windows Server 2012 в домене, к которому принадлежат серверы AD FS.
* **Учетная запись пользователя домена**. Для этого типа учетной записи необходимо указать пароль, который нужно регулярно обновлять в случае изменения или истечения срока действия. Используйте этот тип, только если у вас нет контроллеров домена Windows Server 2012 в домене, к которому принадлежат серверы AD FS.

Если вы выбрали групповую управляемую учетную запись службы, а эта учетная запись никогда не использовалась в Active Directory, вам также будет предложено ввести учетные данные администратора предприятия. Эти учетные данные необходимы, чтобы инициировать хранилище ключей и включить эту учетную запись в Active Directory.

> [!NOTE]
> Azure AD Connect выполняет проверку, чтобы определить, зарегистрирована ли служба AD FS в качестве имени субъекта-службы в домене.  В AD DS запрещено одновременно регистрировать повторяющиеся имена субъектов-служб.  Если будет обнаружено повторяющееся имя субъекта-службы, вы не сможете продолжить, пока это имя не будет удалено.

![Учетная запись службы AD FS](./media/how-to-connect-install-custom/adfs5.png)

### <a name="select-the-azure-ad-domain-that-you-wish-to-federate"></a>Выбор домена Azure AD, который нужно включить в федерацию
Эта конфигурация используется для установки федеративных отношений между AD FS и Azure AD. Она настраивает службы федерации Active Directory для выдачи маркеров безопасности Azure AD и настраивает Azure AD для доверия маркерам из данного конкретного экземпляра AD FS. Во время первой установки на этой странице можно настроить только один домен. Позже можно настроить дополнительные домены, запустив Azure AD Connect еще раз.

![Снимок экрана, на котором показана страница "домен Azure AD".](./media/how-to-connect-install-custom/adfs6.png)

### <a name="verify-the-azure-ad-domain-selected-for-federation"></a>Проверка домена Azure AD, выбранного для включения в федерацию
При выборе домена, который необходимо включить в федерацию, Azure AD Connect предоставляет необходимые сведения для проверки непроверенного домена. Сведения о том, как использовать эти данные, см. в статье о [добавлении и проверке домена](../fundamentals/add-custom-domain.md).

![Домен Azure AD](./media/how-to-connect-install-custom/verifyfeddomain.png)

> [!NOTE]
> AD Connect пытается проверить домен на этапе настройки. Если вы продолжите настройку, не добавив необходимые записи DNS, мастер не сможет завершить настройку.
>
>

## <a name="configuring-federation-with-pingfederate"></a>Настройка федерации с PingFederate
Вы можете легко настроить PingFederate с Azure AD Connect. Для этого достаточно нескольких щелчков. Ниже перечислены обязательные компоненты.
- PingFederate 8.4 или более поздней версии.  Дополнительные сведения см. [в статье интеграция PingFederate с Azure Active Directory и Microsoft 365](https://docs.pingidentity.com/bundle/O365IG20_sm_integrationGuide/page/O365IG_c_integrationGuide.html)
- Сертификат TLS/SSL для имени службы федерации, которое предполагается использовать (например, sts.contoso.com)

### <a name="verify-the-domain"></a>Проверка домена
Когда вы выберете вариант федерации с PingFederate, появится предложение проверить домен, для которого вы хотите создать федерацию.  Выберите нужный домен из раскрывающегося списка.

![Снимок экрана, показывающий "домен Azure AD" с выбранным примером домена "contoso.com".](./media/how-to-connect-install-custom/ping1.png)

### <a name="export-the-pingfederate-settings"></a>Экспорт параметров PingFederate


Служба PingFederate должна быть назначена сервером федерации для каждого федеративного домена Azure.  Нажмите кнопку "Экспортировать параметры" и передайте полученные сведения администратору PingFederate.  Администратор сервера федерации обновит конфигурацию и предоставит вам URL-адрес сервера PingFederate и номер порта, по которым Azure AD Connect сможет проверить параметры настройки.  

![Проверка домена](./media/how-to-connect-install-custom/ping2.png)

Если при проверке возникнут проблемы, обратитесь к администратору PingFederate для их устранения.  Ниже приведен пример сервера PingFederate, который не имеет допустимых отношений доверия с Azure:

![Доверие](./media/how-to-connect-install-custom/ping5.png)




### <a name="verify-federation-connectivity"></a>Проверка подключения федерации
Azure AD Connect попробует проверить конечные точки аутентификации, полученные на предыдущем шаге из метаданных PingFederate.  Сначала Azure AD Connect пытается разрешить эти конечные точки через локальные DNS-серверы.  Затем проверка конечных точек продолжается через внешнего поставщика DNS.  Если при проверке возникнут проблемы, обратитесь к администратору PingFederate для их устранения.  

![Проверка подключения](./media/how-to-connect-install-custom/ping3.png)

### <a name="verify-federation-login"></a>Проверка федеративного входа
Теперь вы можете проверить процесс входа в настроенной федерации, выполнив вход в федеративный домен. Если он завершается успешно, значит федерация с PingFederate настроена правильно.
![Проверка входа](./media/how-to-connect-install-custom/ping4.png)

## <a name="configure-and-verify-pages"></a>Страницы настройки и проверки
Настройка выполняется на этой странице.

> [!NOTE]
> Прежде чем продолжить установку (при настроенной федерации), необходимо настроить [разрешение имен для серверов федерации](how-to-connect-install-prerequisites.md#name-resolution-for-federation-servers).
>
>


![Готово к настройке](./media/how-to-connect-install-custom/readytoconfigure2.png)

### <a name="staging-mode"></a>Промежуточный режим
Новый сервер синхронизации можно установить при промежуточном режиме. В этом режиме поддерживается только один сервер синхронизации, подключенный для экспорта к одному каталогу в облаке. Но если требуется переместить данные с другого сервера, на котором работает, например, DirSync, можно включить Azure Connect AD в промежуточном режиме. Если это средство включено, модуль синхронизации импортирует и синхронизирует данные в обычном режиме, но ничего не экспортирует в Azure AD или AD. В промежуточном режиме синхронизация паролей и компонент обратной записи паролей отключены.

![Промежуточный режим](./media/how-to-connect-install-custom/stagingmode.png)

В промежуточном режиме можно вносить необходимые изменения в модуль синхронизации и просматривать данные перед экспортом. Если вы довольны конфигурацией, снова запустите мастер установки и отключите промежуточный режим. Теперь данные экспортируются с этого сервера в Azure AD. Обязательно отключите другой сервер, чтобы только один сервер активно экспортировал данные.

Дополнительные сведения см. в разделе [Промежуточный режим](how-to-connect-sync-staging-server.md).

### <a name="verify-your-federation-configuration"></a>Проверьте конфигурации федерации
Если нажать кнопку "Проверить", Azure AD Connect проверит параметры DNS.

**Проверка подключения к интрасети**

* Разрешение полного доменного имени федерации. Azure AD Connect проверяет, можно ли разрешить полное доменное имя федерации с помощью DNS, чтобы обеспечить возможность подключения. Если Azure AD Connect не может разрешить полное доменное имя, произойдет сбой проверки. Для успешного выполнения проверки убедитесь, что запись DNS имеется для полного доменного имени службы федерации.
* Запись DNS типа A. Azure AD Connect проверяет наличие записи типа А для службы федерации. При отсутствии записи А проверка завершается ошибкой. Создайте запись А (а не запись CNAME) для полного доменного имени федерации, чтобы успешно завершить проверку.

**Проверка подключения к экстрасети**

* Разрешение полного доменного имени федерации. Azure AD Connect проверяет, можно ли разрешить полное доменное имя федерации с помощью DNS, чтобы обеспечить возможность подключения.

![Завершение](./media/how-to-connect-install-custom/completed.png)

![Проверка](./media/how-to-connect-install-custom/adfs7.png)

Чтобы проверить весь алгоритм аутентификации, вручную проведите один или несколько из следующих тестов.

* Когда завершится синхронизация, выполните дополнительную задачу Azure AD Connect "Проверка федеративного входа", чтобы проверить аутентификацию для любой локальной учетной записи.
* Проверьте возможность входа с помощью браузера, запущенного на подключенном к домену компьютере в интрасети. Для этого перейдите по адресу https://myapps.microsoft.com и попробуйте войти в систему, используя учетные данные, с которыми вы уже вошли. Встроенная учетная запись администратора в AD DS не синхронизируется и не может использоваться для проверки.
* Проверьте возможность входа с устройства из экстрасети. На домашнем компьютере или мобильном устройстве перейдите по адресу https://myapps.microsoft.com и укажите свои учетные данные.
* Проверьте возможность входа клиента с расширенными возможностями. Перейдите по адресу https://testconnectivity.microsoft.com, выберите вкладку **Office 365** и щелкните **Тест единого входа в Office 365**.

## <a name="troubleshooting"></a>Устранение неполадок
В следующем разделе приведены сведения об устранении неполадок, которые можно использовать, если у вас возникнет проблема с установкой Azure AD Connect.

### <a name="the-adsync-database-already-contains-data-and-cannot-be-overwritten"></a>База данных ADSync уже содержит данные и не может быть перезаписана
Когда вы выполняете выборочную установку Azure AD Connect и выбираете вариант **Use an existing SQL server** (Использовать существующий SQL Server) на странице **Установка обязательных компонентов**, вы можете столкнуться с ошибкой, в которой говорится **База данных ADSync уже содержит данные и не может быть перезаписана. Удалите существующую базу данных и повторите попытку.**

![Снимок экрана, на котором показана страница "Установка необходимых компонентов".](./media/how-to-connect-install-custom/error1.png)

Это связано с тем, что база данных с именем **ADSync** уже существует в экземпляре SQL Server, указанном в приведенных выше текстовых окнах.

Обычно это происходит после удаления Azure AD Connect.  База данных не удаляется с SQL Server при удалении этого компонента.

Чтобы устранить эту проблему, сначала убедитесь, что база данных **ADSync**, которая использовалась компонентом Azure AD Connect до его удаления, больше не используется.

Затем рекомендуется создать резервную копию базы данных до ее удаления.

Наконец, вам нужно удалить базу данных.  Для этого вам нужно использовать **Microsoft SQL Server Management Studio** и подключиться к экземпляру SQL. Найдите базу данных **ADSync**, щелкните ее правой кнопкой мыши и выберите **Удалить** в контекстном меню.  Затем нажмите кнопку **OК**, чтобы удалить базу данных.

![Error](./media/how-to-connect-install-custom/error2.png)

После удаления базы данных **ADSync** вы можете нажать кнопку **Установить**, чтобы повторить установку.

## <a name="next-steps"></a>Дальнейшие действия
После завершения установки выполните выход из Windows и снова войдите, прежде чем начинать использовать диспетчер службы синхронизации или редактор правил синхронизации.

После установки Azure AD Connect можно [проверить установку и назначить лицензии](how-to-connect-post-installation.md).

См. дополнительные сведения о [предотвращении случайного удаления](how-to-connect-sync-feature-prevent-accidental-deletes.md) и [Azure AD Connect Health](how-to-connect-health-sync.md).

Дополнительные сведения см. в статье [Синхронизация Azure AD Connect: планировщик](how-to-connect-sync-feature-scheduler.md).

Узнайте больше об [интеграции локальных удостоверений с Azure Active Directory](whatis-hybrid-identity.md).