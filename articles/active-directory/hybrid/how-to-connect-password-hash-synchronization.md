---
title: Реализация синхронизации хэшированных паролей в службе синхронизации Azure AD Connect | Документация Майкрософт
description: В этой статье объясняется, как работает синхронизация хэшированных паролей и как ее настроить.
services: active-directory
documentationcenter: ''
author: billmath
manager: daveba
ms.assetid: 05f16c3e-9d23-45dc-afca-3d0fa9dbf501
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 02/26/2020
ms.subservice: hybrid
ms.author: billmath
search.appverid:
- MET150
ms.collection: M365-identity-device-management
ms.openlocfilehash: c41b11ab65f5710d338ce0041579e1eb4678ec42
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80331368"
---
# <a name="implement-password-hash-synchronization-with-azure-ad-connect-sync"></a>Реализация синхронизации хэшированных паролей в службе синхронизации Azure AD Connect
В этой статье содержатся сведения о том, как синхронизировать пароли пользователей локального экземпляра службы Active Directory (AD) и облачного экземпляра службы Azure Active Directory (Azure AD).

## <a name="how-password-hash-synchronization-works"></a>Как работает синхронизация хэшированных паролей
Доменная служба Active Directory хранит пароли в виде хэш-значений, полученных на основе фактических паролей. Для получения хэш-значений используется необратимая математическая функция (*алгоритм хэширования*). Не существует метода для возврата результата односторонней функции в обычную текстовую версию пароля. 

Чтобы синхронизировать пароль, Azure AD Connect Sync извлекает хэш пароля из локального экземпляра Active Directory. Перед синхронизацией в службу проверки подлинности Azure Active Directory хэш пароля дополнительно обрабатывается системой безопасности. Пароли синхронизируются для каждого пользователя отдельно и в хронологическом порядке.

Процесс синхронизации хэша паролей использует такой же поток данных, как и синхронизация любых пользовательских данных. Но синхронизация паролей происходит чаще, чем это обычно делается для других атрибутов. Процесс синхронизации хэшированных паролей выполняется каждые 2 минуты. Нельзя изменять частоту выполнения этого процесса. При синхронизации пароль перезаписывает существующий в облачной службе.

Когда вы впервые включаете функцию синхронизации хэшированных паролей, выполняется первоначальная синхронизация паролей для всех пользователей в области действия функции. Вы не можете явно выделить подмножество пользователей, для которых нужно синхронизировать пароли. Однако, если есть несколько разъемов, можно отключить синхронизацию хэша паролей для некоторых разъемов, но не других с помощью [Set-ADSyncADPasswordSyncConfiguration](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-getting-started-password-sync-synced-tenant) cmdlet.

При изменении локального пароля новый пароль, как правило, синхронизируется в течение нескольких минут.
Функция синхронизации хэшированных паролей использует механизм повторных попыток при сбоях. Ошибки, возникающие во время синхронизации паролей, записываются в журнал событий.

Синхронизация пароля не влияет на пользователей Azure, находящихся в системе в момент ее выполнения.
Если изменение пароля синхронизируется во время вашего пребывания в облачной службе, оно не применяется в сеансе облачной службы немедленно. Однако, когда снова возникнет необходимость в проверке подлинности в облачной службе, потребуется указать новый пароль.

Для аутентификации в Azure AD пользователь должен вводить корпоративные учетные данные повторно, независимо от того, выполнен ли вход в корпоративную сеть. Но эту проблему можно свести к минимуму, если пользователь при входе в систему установит флажок "Оставаться в системе". Это действие создает для сеанса файл cookie, который в течение 180 дней позволяет обходить аутентификацию. Администратор Azure Active Directory может включить или отключить функцию "Оставаться в системе". Кроме того, можно сократить число запросов пароля, включив [простой единый вход](how-to-connect-sso.md). Он автоматически обеспечивает пользователям вход в систему, когда они работают на корпоративных устройствах, подключенных к корпоративной сети.

> [!NOTE]
> Синхронизация паролей поддерживается только для типа объектов user в Active Directory. Она не поддерживается для типа объектов iNetOrgPerson.

### <a name="detailed-description-of-how-password-hash-synchronization-works"></a>Подробное описание принципа действия синхронизации хэшированных паролей

В следующем разделе подробно описан принцип действия синхронизации хэша паролей между локальным экземпляром Active Directory и Azure Active Directory.

![Подробная схема использования паролей](./media/how-to-connect-password-hash-synchronization/arch3b.png)

1. Каждые две минуты агент синхронизации хэша паролей на сервере AD Connect запрашивает у контроллера домена сохраненные хэши паролей (атрибут unicodePwd).  Этот запрос выполняется по стандартному протоколу репликации [MS-DRSR](https://msdn.microsoft.com/library/cc228086.aspx), который используется для синхронизации данных между контроллерами домена. Для получения хэша паролей учетной записи службы требуются разрешения AD "Репликация изменений каталога" и "Репликация всех изменений каталога" (предоставляется по умолчанию при установке).
2. Перед отправкой контроллер домена шифрует MD4-хэш пароля с помощью ключа — комбинации [MD5](https://www.rfc-editor.org/rfc/rfc1321.txt)-хэша от ключа сеанса RPC и случайных данных. После этого он отправляет результат агенту синхронизации хэшированных паролей по протоколу RPC. Контроллер домена также передает агенту синхронизации случайные данные, используя протокол репликации контроллера домена, чтобы агент смог расшифровать конверт.
3. Когда агент синхронизации хэшированных паролей получает зашифрованный конверт, он создает ключ для расшифровки полученных данных в исходный формат MD4, используя [MD5CryptoServiceProvider](https://msdn.microsoft.com/library/System.Security.Cryptography.MD5CryptoServiceProvider.aspx) и значение соли. Агенту синхронизации хэша паролей не доступен пароль в виде открытого текста. Он применяет MD5 только для совместимости по протоколу репликации с контроллером домена и только в локальной среде для обмена данными между контроллером домена и агентом синхронизации хэшированных паролей.
4. Агент синхронизации хэшированных паролей увеличивает 16-байтовый двоичный хэш пароля до 64 байтов. Для этого он преобразует хэш в 32-байтовую шестнадцатеричную строку, а затем преобразует ее обратно в двоичный формат с кодировкой UTF-16.
5. Агент синхронизации паролей добавляет к 64-байтовому двоичному значению 10-байтовое значение соли для каждого пользователя, чтобы обеспечить дополнительную защиту исходного хэша.
6. Затем он передает строку, полученную при объединении хэша MD4 с солью каждого пользователя, в функцию [PBKDF2](https://www.ietf.org/rfc/rfc2898.txt). Выполняется 1000 итераций алгоритма хэширования с ключом [HMAC-SHA256](https://msdn.microsoft.com/library/system.security.cryptography.hmacsha256.aspx). 
7. Агент синхронизации хэша паролей принимает полученный хэш 32 байт, конкатирует как на одну соль пользователя, так и количество итераций SHA256 к нему (для использования Azure AD), а затем передает строку из Azure AD Connect в Azure AD через TLS.</br> 
8. Когда пользователь вводит пароль для входа в Azure AD, пароль обрабатывается точно так же (MD4, случайные данные, PBKDF2 и HMAC-SHA256). Если полученный хэш совпадает с хэшем, хранящимся в Azure AD, это означает, что пользователь ввел правильный пароль и он проходит аутентификацию.

> [!NOTE]
> Оригинальный MD4-хэш не передается в Azure AD. Вместо этого передается SHA256-хэш от оригинального MD4-хэша. Это означает, что хранимый в Azure AD хэш невозможно использовать для атаки Pass-the-Hash на локальную систему, даже если удастся его получить.

### <a name="security-considerations"></a>Замечания по безопасности

При синхронизации паролей их текстовое значение никогда не передается в службу синхронизации хэшированных паролей, в Azure AD или другие связанные службы.

Пользователь проходит аутентификацию в Azure AD, а не в корпоративном экземпляре Active Directory. Данные пароля SHA256, хранимые в Azure AD (хэш исходного хэша MD4), безопаснее, чем данные, хранимые в Active Directory. Кроме того, так как хэш SHA256 невозможно расшифровать, его невозможно вернуть в корпоративную среду Active Directory и представить в качестве действительного пароля пользователя в ходе атаки Pass-the-Hash.

### <a name="password-policy-considerations"></a>Рекомендации по политикам паролей

Есть два типа политик паролей, которые затрагивает синхронизация хэшированных паролей:

* Политика сложности паролей
* политика срока действия паролей.

#### <a name="password-complexity-policy"></a>Политика сложности паролей

Если используется синхронизация хэшированных паролей, настроенные в локальном экземпляре Active Directory политики сложности паролей переопределяют политики сложности, настроенные в облаке для синхронизированных пользователей. Все допустимые пароли из локального экземпляра Active Directory можно использовать для доступа к службам Azure AD.

> [!NOTE]
> Пароли пользователей, созданные непосредственно в облаке, и впредь регулируются политиками паролей, которые настроены в облаке.

#### <a name="password-expiration-policy"></a>политика срока действия паролей.

Если пользователь находится в сфере синхронизации хэш-пароля, по умолчанию пароль облачной учетной записи установлен на *never Expire.*

Даже если срок действия синхронизируемого пароля в локальной среде истек, его можно использовать для входа в облачные службы. Пароль для облачной учетной записи изменяется, когда вы изменяете пароль в локальной среде.

##### <a name="public-preview-of-the-enforcecloudpasswordpolicyforpasswordsyncedusers-feature"></a>Публичный предварительный просмотр функции *EnforceCloudPasswordPolicyForPasswordSyncedUsers*

Если есть синхронизированные пользователи, которые взаимодействуют только с интегрированными службами Azure AD и должны также соответствовать политике истечения срока действия пароля, вы можете заставить их соблюдать вашу политику истечения срока действия пароля Azure AD, включив функцию *EnforceCloudPasswordPolicyForPasswordSyncedUsers.*

Когда *EnforceCloudPasswordPolicyForPasswordSyncedUsers* отключен (что является параметром по умолчанию), Azure AD Connect устанавливает атрибут PasswordPolicies синхронизированных пользователей на "DisablePasswordExpiration". Это делается каждый раз, когда пароль пользователя синхронизируется и поручает Azure AD игнорировать политику истечения действия облачного пароля для этого пользователя. Вы можете проверить значение атрибута с помощью модуля Azure AD PowerShell со следующей командой:

`(Get-AzureADUser -objectID <User Object ID>).passwordpolicies`


Для включения функции EnforceCloudPasswordPolicyForPasswordSyncedUsers, запустите следующую команду с помощью модуля MSOnline PowerShell, как показано ниже. Вы должны были бы набрать да для параметра Enable, как показано ниже:

```
Set-MsolDirSyncFeature -Feature EnforceCloudPasswordPolicyForPasswordSyncedUsers
cmdlet Set-MsolDirSyncFeature at command pipeline position 1
Supply values for the following parameters:
Enable: yes
Confirm
Continue with this operation?
[Y] Yes [N] No [S] Suspend [?] Help (default is "Y"): y
```

После включения Azure AD не походит на каждого синхронизированного пользователя, чтобы удалить `DisablePasswordExpiration` значение из атрибута PasswordPolicies. Вместо этого значение устанавливается `None` во время следующей синхронизации пароля для каждого пользователя при следующем изменении пароля в предварительном AD.  

Рекомендуется включить EnforceCloudPasswordPolicyForPasswordSyncedUsers, до включения синхронизации хэша паролей, так что начальная `DisablePasswordExpiration` синхронизация хэша паролей не добавляет значение атрибуту PasswordPolicies для пользователей.

Политика паролей Azure AD по умолчанию требует от пользователей менять свои пароли каждые 90 дней. Если ваша политика в AD также составляет 90 дней, эти две политики должны соответствовать. Однако, если политика AD не составляет 90 дней, вы можете обновить политику паролей Azure AD, чтобы соответствовать с помощью команды Set-MsolPasswordPolicy PowerShell.

Azure AD поддерживает отдельную политику истечения срока действия пароля на зарегистрированный домен.

Caveat: Если есть синхронизированные учетные записи, которые должны иметь неисполнимые пароли в Azure AD, необходимо явно добавить `DisablePasswordExpiration` значение к атрибуту PasswordPolicies объекта пользователя в Azure AD.  Вы можете сделать это, запустив следующую команду.

`Set-AzureADUser -ObjectID <User Object ID> -PasswordPolicies "DisablePasswordExpiration"`

> [!NOTE]
> Эта функция находится в публичном предварительном просмотре прямо сейчас.
> Команда Set-MsolPasswordPolicy PowerShell не будет работать на федеративных доменах. 

#### <a name="public-preview-of-synchronizing-temporary-passwords-and-force-password-change-on-next-logon"></a>Публичный предварительный просмотр синхронизации временных паролей и "Принудительное изменение пароля на следующем логоне"

Это типично, чтобы заставить пользователя изменить свой пароль во время их первого входа, особенно после сбоя пароля админ происходит.  Он широко известен как установка "временного" пароля и завершается проверкой "Пользователь должен изменить пароль на следующем логон" флаг на объекте пользователя в Active Directory (AD).
  
Функция временного пароля помогает гарантировать, что передача права собственности на учетные данные завершена при первом использовании, чтобы свести к минимуму продолжительность времени, в течение которого более одного человека знает об этом учетных данных.

Для поддержки временных паролей в Azure AD для синхронизированных пользователей можно включить функцию *ForcePasswordChangeOnLogOn,* запустив следующую команду на сервере Azure AD Connect:

`Set-ADSyncAADCompanyFeature  -ForcePasswordChangeOnLogOn $true`

> [!NOTE]
> Принуждение пользователя изменить свой пароль на следующем логине требует изменения пароля в то же время.  Azure AD Connect не будет самостоятельно подбирать флаг изменения пароля; это дополняет обнаруженное изменение пароля, которое происходит во время синхронизации хэша паролей.

> [!CAUTION]
> Эту функцию следует использовать только при включении SSPR и списания паролей на арендаторе.  Это делается для того, чтобы, если пользователь изменил свой пароль через SSPR, он будет синхронизирован с Active Directory.

> [!NOTE]
> Эта функция находится в открытом предварительном просмотре прямо сейчас.

#### <a name="account-expiration"></a>Срок действия учетной записи

Если в вашей организация используется атрибут accountExpires для управления учетными записями пользователей, то этот атрибут не синхронизируется с Azure AD. В результате учетная запись Active Directory будет всегда активной в Azure AD, даже если срок ее действия истек в той среде, где настроена синхронизация хэшированных паролей. Мы рекомендуем внедрить рабочий процесс, который при истечении срока действия учетной записи будет активировать сценарий PowerShell, отключающий учетную запись пользователя Azure AD (используйте командлет [Set-AzureADUser](https://docs.microsoft.com/powershell/module/azuread/set-azureaduser?view=azureadps-2.0)). И наоборот, при включении учетной записи нужно отдельно включать ее в экземпляре Azure AD.

### <a name="overwrite-synchronized-passwords"></a>Перезапись синхронизированных паролей

Администратор может вручную сбросить пароль с помощью Windows PowerShell.

В таком случае новый пароль перезапишет синхронизированный пароль и к новому паролю будут применены все политики паролей, настроенные в облаке.

Если после этого вы измените локальный пароль, новый пароль синхронизируется в облако и перезапишет пароль, измененный вручную.

Синхронизация пароля не влияет на вошедших в систему пользователей Azure. Если изменение пароля синхронизируется, когда вы вошли в облачную службу, это не повлияет на открытый сеанс связи с облачной службой. Функция "Оставаться в системе" продлевает срок действия такого расхождения. Когда снова возникнет необходимость в аутентификации в облачной службе, потребуется указать новый пароль.

### <a name="additional-advantages"></a>Дополнительные преимущества

- Как правило, синхронизацию хэшированных паролей реализовать проще, чем службу федерации. Для этого не требуются дополнительные серверы и высокая доступность, которая важна при аутентификации пользователей в службе федерации.
- Кроме того, синхронизацию хэшированных паролей можно использовать параллельно с федерацией. Это будет хорошим резервным механизмом на случай сбоя службы федерации.

## <a name="password-hash-sync-process-for-azure-ad-domain-services"></a>Процесс синхронизации хэша паролей для служб домена Azure AD

Если вы используете службы домена Azure AD Domain Services для предоставления устаревшей аутентификации для приложений и служб, которым необходимо использовать Kerberos, LDAP или NTLM, некоторые дополнительные процессы являются частью потока синхронизации хэша паролей. Azure AD Connect использует дополнительный следующий процесс для синхронизации хэшей паролей с Azure AD для использования в службах домена Azure AD:

> [!IMPORTANT]
> Azure AD Connect следует устанавливать и настраивать только для синхронизации с локальными средами AD DS. Установка Azure AD Connect в управляемом домене Azure AD DS для синхронизации объектов обратно в Azure AD не поддерживается.
>
> Azure AD Connect синхронизирует устаревшие хэши паролей только при вхотворе DS Azure AD для вашего aure AD-нанимателя. Следующие шаги не используются только при использовании Azure AD Connect для синхронизации предварительной среды AD DS с Azure AD.
>
> Если ваши устаревшие приложения не используют ntLM аутентификацию или простые привязки LDAP, мы рекомендуем отключить синхронизацию хэша паролем NTLM для Azure AD DS. Для получения дополнительной [информации](../../active-directory-domain-services/secure-your-domain.md)см.

1. Azure AD Connect получает общедоступный ключ для экземпляра доменных служб Azure AD.
1. Когда пользователь меняет свой пароль, контроллер домена в помещении хранит результат изменения пароля (хэши) в двух атрибутах:
    * *unicodePwd* для хэша пароля NTLM.
    * *дополнительные полномочия* для хэша пароля Kerberos.
1. Azure AD Connect обнаруживает изменения паролей через канал репликации каталога (изменения атрибутов, необходимые для воспроизведения другим контроллерам домена).
1. Для каждого пользователя, чей пароль был изменен, Azure AD Connect выполняет следующие действия:
    * Генерирует случайный 256-битный симметричный ключ AES.
    * Генерирует случайный вектор инициализации, необходимый для первого раунда шифрования.
    * Извлекает хэши паролей Kerberos из дополнительных атрибутов *Credentials.*
    * Проверяет настройки конфигурации безопасности служб безопасности Azure AD Services *SyncNtlmPasswords.*
        * Если эта настройка отключена, генерирует случайный, высокоэнтропный хэш NTLM (отличается от пароля пользователя). Этот хэш затем в сочетании с взысканы Керберос пароль хэши из *дополнительныхCrendetials* атрибут в одну структуру данных.
        * Если включено, комбинирует значение *атрибута unicodePwd* с извлеченными хэшами паролей Kerberos из *атрибута дополнительных credentials* в одну структуру данных.
    * Шифрует единую структуру данных с помощью симметричного ключа AES.
    * Шифрование симметричного ключа AES с помощью общедоступного ключа доменных служб Azure AD.
1. Azure AD Connect передает зашифрованный симметрический ключ AES, зашифрованную структуру данных, содержащую хэши паролей, и вектор инициализации в Azure AD.
1. Azure AD хранит зашифрованный симметричный ключ AES, зашифрованную структуру данных и вектор инициализации для пользователя.
1. Azure AD толкает зашифрованный симметричный ключ AES, зашифрованную структуру данных и вектор инициализации с помощью механизма внутренней синхронизации по зашифрованной сессии HTTP в службы домена Azure AD.
1. Службы домена Azure AD извлекают закрытый ключ для экземпляра клиента из хранилища ключей Azure.
1. Для каждого зашифрованного набора данных (представляющих изменение пароля одного пользователя) службы домена Azure AD выполняют следующие действия:
    * Использует свой закрытый ключ для расшифровки симметричного ключа AES.
    * Использует симметричный ключ AES с вектором инициализации для расшифровки зашифрованной структуры данных, содержащей хэши паролей.
    * Записывает хэши пароля Kerberos, которые он получает, в контроллер домена Azure AD Domain Services. Хэши сохраняются в атрибуте *дополнительных учетных данных* объекта пользователя, который зашифрован на общедоступном ключе контроллера домена Azure AD Services.
    * Службы домена Azure AD запишут хэш пароля NTLM, полученный в контроллер домена Azure AD Services. Хэш сохраняется в *единообразном* атрибуте пользователя объекта, который зашифрован на общедоступном ключе контроллера домена Azure AD Services.

## <a name="enable-password-hash-synchronization"></a>Включение синхронизации хэшированных паролей

>[!IMPORTANT]
>Если выполняется переход с AD FS (или других технологий федерации) на синхронизацию хэшей паролей, мы настоятельно рекомендуем следовать нашему подробному руководству по развертыванию, опубликованному [здесь](https://aka.ms/adfstophsdpdownload).

Если для установки Azure AD Connect вы используете **стандартные параметры**, синхронизация хэшированных паролей включается по умолчанию. Дополнительные сведения см. в статье [Приступая к работе с Azure AD Connect с использованием стандартных параметров](how-to-connect-install-express.md).

Если для установки Azure AD Connect вы используете пользовательские параметры, синхронизацию хэшированных паролей можно настроить на странице входа в систему. Дополнительные сведения см. в статье [Выборочная установка Azure AD Connect](how-to-connect-install-custom.md).

![Включение синхронизации хэшированных паролей](./media/how-to-connect-password-hash-synchronization/usersignin2.png)

### <a name="password-hash-synchronization-and-fips"></a>Синхронизация хэшированных паролей и FIPS
Если сервер блокируется в соответствии с федеральным стандартом обработки информации (FIPS), схема MD5 отключается.

**Чтобы включить MD5 для синхронизации хэшированных паролей, выполните следующие действия.**

1. Перейдите к папке %programfiles%\Azure AD Sync\Bin.
2. Откройте файл miiserver.exe.config.
3. Перейдите к узлу конфигурации или среды выполнения (в конце файла конфигурации).
4. Добавьте следующий узел: `<enforceFIPSPolicy enabled="false"/>`
5. Сохраните изменения.

Этот фрагмент должен выглядеть примерно так:

```
    <configuration>
        <runtime>
            <enforceFIPSPolicy enabled="false"/>
        </runtime>
    </configuration>
```

Дополнительные сведения о безопасности и FIPS см. в записи блога [AAD Password Sync, Encryption and FIPS compliance](https://blogs.technet.microsoft.com/enterprisemobility/2014/06/28/aad-password-sync-encryption-and-fips-compliance/) (Синхронизация паролей, шифрование и соответствие FIPS в AAD).

## <a name="troubleshoot-password-hash-synchronization"></a>Устранение неполадок при синхронизации хэшированных паролей
Если вы столкнетесь с проблемами при синхронизации хэшированных паролей, воспользуйтесь рекомендациями из статьи [Устранение неполадок синхронизации хэшированных паролей в службе синхронизации Azure AD Connect](tshoot-connect-password-hash-synchronization.md).

## <a name="next-steps"></a>Дальнейшие действия
* [Синхронизация Azure AD Connect: Настройка вариантов синхронизации](how-to-connect-sync-whatis.md)
* [Интеграция локальных удостоверений с Azure Active Directory.](whatis-hybrid-identity.md)
* [Получить поэтапный план развертывания для перехода с ADFS на синхронизацию хэша паролей](https://aka.ms/authenticationDeploymentPlan)
