---
title: 'Подключение Azure AD: Настройка предпочтительного местоположения данных для ресурсов Office 365'
description: Из этой статьи вы узнаете, как разместить ресурсы Office 365 в удобном для пользователей расположении при помощи синхронизации Azure Active Directory Connect.
services: active-directory
documentationcenter: ''
author: billmath
manager: daveba
editor: ''
ms.assetid: ''
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 11/11/2019
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 2a71c5328c6fa85f85db4bd7e6103f6470b86d99
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80258334"
---
# <a name="azure-active-directory-connect-sync-configure-preferred-data-location-for-office-365-resources"></a>Синхронизация Azure Active Directory Connect. Настройка предпочтительного расположения данных для ресурсов Office 365
Цель этой темы состоит в том, чтобы провести с помощью настройки атрибута для предпочтительного местоположения данных в синхронизации Azure Active Directory (Azure AD). Когда кто-то использует возможности Multi-Geo в Office 365, этот атрибут используется для обозначения геолокации данных Office 365 пользователя. (Термины *регион* и *геообъект* являются взаимозаменяемыми.)

## <a name="enable-synchronization-of-preferred-data-location"></a>Включение синхронизации предпочтительного расположения данных
По умолчанию ресурсы Office 365 для пользователей находятся в том же геообъекте, что и ваш клиент Azure AD. Например, если клиент находится в Северной Америке, то почтовые ящики Exchange пользователей также расположены в Северной Америке. Для международной организации это может быть не самым оптимальным решением.

Установив атрибут **preferredDataLocation**, можно задать геообъект пользователя. Вы сможете работать с ресурсами пользователя Office 365, например с почтовым ящиком и OneDrive, в том же геообъекте, что и пользователь, а также использовать один клиент для всей организации.

> [!IMPORTANT]
> Multi-Geo в настоящее время доступна для клиентов с активным корпоративным соглашением и как минимум 500 подписок Office 365 Services. Обратитесь к представителю корпорации Майкрософт, чтобы получить дополнительные сведения.
>
>

Список всех геосов для Office 365 можно найти в [Где находятся ваши данные?](https://aka.ms/datamaps).

Доступные геообъекты для поддержки нескольких регионов в Office 365:

| Географические | Значение preferredDataLocation |
| --- | --- |
| Азиатско-Тихоокеанский регион | APC |
| Австралия | AUS |
| Canada | CAN |
| Европейский союз | EUR |
| Франция | FRA |
| Индия | IND |
| Япония | JPN |
| Корея | KOR |
| ЮАР | ZAF |
| ОАЭ | ARE |
| United Kingdom | GBR |
| США | NAM |

* Если геообъект отсутствует в этой таблице, как, например, Южная Америка, значит он не используется для поддержки нескольких регионов.

* Не все рабочие нагрузки Office 365 поддерживают настройку геообъекта пользователя.

### <a name="azure-ad-connect-support-for-synchronization"></a>Поддержка Azure AD Connect для синхронизации

Azure AD Connect поддерживает синхронизацию атрибута **preferredDataLocation** для объектов **User** в версии 1.1.524.0 и более поздних версиях. В частности:

* Схема типа объекта **User** в соединителе Azure AD расширена для включения атрибута **preferredDataLocation**. Этот атрибут является строкой с одним значением.
* Схема типа объекта **Person** в метавселенной расширена для включения атрибута **preferredDataLocation**. Этот атрибут является строкой с одним значением.

По умолчанию **preferredDataLocation** не включен для синхронизации. Эта функция предназначена для более крупных организаций. Схема Active Directory в Windows Server 2019 имеет атрибут **msDS-предпочтительныйDataLocation,** который вы должны использовать для этой цели. Если вы не обновили схему Active Directory и не можете этого сделать, необходимо определить атрибут, чтобы удерживать гео Office 365 для пользователей. Этот атрибут будет индивидуальным для каждой организации.

> [!IMPORTANT]
> Azure AD позволяет непосредственно настроить атрибут **preferredDataLocation** для облачных объектов **User** с помощью Azure AD PowerShell. Чтобы настроить этот атрибут для **синхронизированных объектов User**, необходимо использовать Azure AD Connect.

Перед включением синхронизации выполните следующее:

* Если вы не обновили схему Active Directory до 2019 года, то решите, какой атрибут Active Directory будет использоваться в качестве исходного атрибута. Он должен быть **строкой с одним значением**.
* Если ранее с помощью Azure AD PowerShell в Azure AD вы настроили атрибут **preferredDataLocation** для имеющихся **синхронизированных объектов User**, необходимо перенести значения атрибутов для соответствующих объектов **User** в локальном каталоге Active Directory.

    > [!IMPORTANT]
    > В противном случае после включения синхронизации атрибута **preferredDataLocation** Azure AD Connect удалит существующие значения атрибутов в Azure AD.

* Настройте исходный атрибут по меньшей мере на двух локальных объектах User Active Directory. Позже его можно использовать для проверки.

В следующих разделах описаны шаги по включению синхронизации атрибута **preferredDataLocation**.

> [!NOTE]
> Они описаны в контексте развертывания Azure AD в топологии с отдельным лесом и без пользовательских правил синхронизации. Если используется топология с несколькими лесами, которые настроены при помощи пользовательских правил синхронизации или промежуточного сервера, необходимо соответствующим образом изменить действия.

## <a name="step-1-disable-sync-scheduler-and-verify-there-is-no-synchronization-in-progress"></a>Шаг 1. Отключение планировщика синхронизации и остановка синхронизации
Изменяя правила синхронизации, убедитесь, что синхронизация не выполняется, во избежание экспорта непреднамеренных изменений в Azure AD. Чтобы отключить встроенный планировщик синхронизации, сделайте следующее:

1. Запустите сеанс PowerShell на сервере Azure AD Connect.
2. Отключите плановую синхронизацию, выполнив командлет `Set-ADSyncScheduler -SyncCycleEnabled $false`.
3. Запустите **Synchronization Service Manager**, выбрав **Пуск** > **Служба синхронизации**.
4. Перейдите на вкладку **Операции** и убедитесь, что на ней не отображаются операции в состоянии *Выполняется*.

![Снимок экрана Synchronization Service Manager](./media/how-to-connect-sync-feature-preferreddatalocation/preferreddatalocation-step1.png)

## <a name="step-2-refresh-the-schema-for-active-directory"></a>Шаг 2: Обновить схему для активного каталога
Если вы обновили схему Active Directory до 2019 года и Connect был установлен до расширения схемы, то кэш схемы Connect не имеет обновленной схемы. Затем необходимо обновить схему от мастера, чтобы она появилась в ui.

1. Запустите мастер-измастерие Azure AD Connect с рабочего стола.
2. Выберите **схему** каталога обновления опции и нажмите **далее.**
3. Введите учетные данные Azure AD и нажмите **далее.**
4. На странице **«Обновить каталог схемы»** убедитесь, что все леса выбраны, и нажмите **кнопку «Следующий».**
5. После завершения работы закройте мастера.

![Скриншот схемы обновления каталога в мастере Connect](./media/how-to-connect-sync-feature-preferreddatalocation/preferreddatalocation-refreshschema.png)

## <a name="step-3-add-the-source-attribute-to-the-on-premises-active-directory-connector-schema"></a>Шаг 3: Добавьте исходный атрибут в схему «Активный соединитель» Active Directory
**Этот шаг необходим только при запуске версии Connect 1.3.21 или старше. Если вы находитесь на 1.4.18 или новее, то перейдите к шагу 5.**  
Не все атрибуты Azure AD импортируются в пространство разъема Active Directory. Если вы решили использовать атрибут, не синхронизируемый по умолчанию, то его необходимо импортировать. Чтобы добавить исходный атрибут в список импортируемых атрибутов, сделайте следующее.

1. Откройте вкладку **Соединители** в Synchronization Service Manager.
2. Щелкните правой кнопкой мыши локальный соединитель Active Directory и выберите **Свойства**.
3. Во всплывающем диалоговом окне перейдите на вкладку **Выбор атрибутов**.
4. Убедитесь, что нужный исходный атрибут выбран из списка атрибутов. Если атрибут не отображается, щелкните флажок **Show All** (Показать все).
5. Чтобы сохранить, нажмите кнопку **ОК**.

![Снимок экрана Synchronization Service Manager и диалоговое окно свойств](./media/how-to-connect-sync-feature-preferreddatalocation/preferreddatalocation-step2.png)

## <a name="step-4-add-preferreddatalocation-to-the-azure-ad-connector-schema"></a>Шаг 4: Добавление **предпочтительногоДата в** схему подключения AD Azure
**Этот шаг необходим только при запуске версии Connect 1.3.21 или старше. Если вы находитесь на 1.4.18 или новее, то перейдите к шагу 5.**  
По умолчанию **атрибут предпочитаемого ДатаЛокации** не импортируется в пространство разъема Azure AD. Чтобы добавить его в список импортированных атрибутов, выполните следующее:

1. Откройте вкладку **Соединители** в Synchronization Service Manager.
2. Нажмите правой кнопкой мыши на разъем Azure AD и выберите **Свойства**.
3. Во всплывающем диалоговом окне перейдите на вкладку **Выбор атрибутов**.
4. Выберите атрибут **preferredDataLocation** в списке.
5. Чтобы сохранить, нажмите кнопку **ОК**.

![Снимок экрана Synchronization Service Manager и диалоговое окно свойств](./media/how-to-connect-sync-feature-preferreddatalocation/preferreddatalocation-step3.png)

## <a name="step-5-create-an-inbound-synchronization-rule"></a>Шаг 5: Создание правила синхронизации входящих
Правило входящей синхронизации позволяет передавать значение исходного атрибута из локального каталога Active Directory в метавселенную.

1. Запустите **редактор правил синхронизации**, выбрав **Пуск** > **Synchronization Rules Editor** (Редактор правил синхронизации).
2. В фильтре поиска для параметра **Направление** задайте значение **Входящие**.
3. Чтобы создать правило входящей синхронизации, нажмите кнопку **Добавить правило**.
4. Под вкладкой **«Описание»** укажите следующую конфигурацию:

    | Атрибут | Значение | Сведения |
    | --- | --- | --- |
    | name | *Укажите имя* | Например, In from AD – User PreferredDataLocation. |
    | Описание | *Введите пользовательское описание* |  |
    | Подключенная система | *Выберите локальный соединитель Active Directory* |  |
    | Тип объекта подключенной системы | **Пользователь** |  |
    | Тип объекта метавселенной | **Человек** |  |
    | Тип связи | **Присоединение** |  |
    | Приоритет | *Выберите число от 1 до 99* | Значения 1–99 зарезервированы для настраиваемых правил синхронизации. Не выбирайте значение, которое используется в другом правиле синхронизации. |

5. Держите **фильтр Scoping** пустым, чтобы включить все объекты. Возможно, вам необходимо настроить фильтр области в соответствии с развертыванием Azure AD Connect.
6. Перейдите на **вкладку «Трансформация»** и реализуйте следующее правило преобразования:

    | Flow type (Тип потока) | Целевой атрибут | Источник | Применить однократно | Merge Type (Тип объединения) |
    | --- | --- | --- | --- | --- |
    |Прямой доступ | preferredDataLocation | Выберите исходный атрибут. | Флажок снят. | Update |

7. Чтобы создать правило входящей синхронизации, нажмите кнопку **Добавить**.

![Снимок экрана Create inbound synchronization rule (Создание правила входящей синхронизации)](./media/how-to-connect-sync-feature-preferreddatalocation/preferreddatalocation-step4.png)

## <a name="step-6-create-an-outbound-synchronization-rule"></a>Шаг 6: Создание правила синхронизации исходящих
Правило исходящего синхронизации позволяет значение атрибута перетекать из метавселенного в **предпочтительный атрибутDataLocation** в Azure AD:

1. Перейдите к **редактору правил синхронизации.**
2. В фильтре поиска для параметра **Направление** задайте значение **Исходящие**.
3. Нажмите кнопку **Добавить правило**.
4. Под вкладкой **«Описание»** укажите следующую конфигурацию:

    | Атрибут | Значение | Сведения |
    | ----- | ------ | --- |
    | name | *Укажите имя* | Например, Out to AAD – User PreferredDataLocation. |
    | Описание | *Предоставить описание* ||
    | Подключенная система | *Выберите соединитель Azure AD* ||
    | Тип объекта подключенной системы | **Пользователь** ||
    | Тип объекта метавселенной | **Человек** ||
    | Тип связи | **Присоединение** ||
    | Приоритет | *Выберите число от 1 до 99* | Значения 1–99 зарезервированы для настраиваемых правил синхронизации. Не выбирайте значение, которое используется в другом правиле синхронизации. |

5. Перейдите на вкладку **фильтра Scoping** и добавьте одну группу фильтров с двумя оговорками:

    | Атрибут | Оператор | Значение |
    | --- | --- | --- |
    | sourceObjectType | EQUAL | Пользователь |
    | cloudMastered | NOTEQUAL | True |

    Фильтр области определяет объекты Azure AD, к которым применяется данное правило исходящей синхронизации. В этом примере мы используем тот же фильтр для проверки из правила синхронизации OOB «Out to Azure AD — Identity пользователя» (из коробки). Это предотвращает применение правила синхронизации к объектам **пользователя,** которые не синхронизированы с предприимчивым Active Directory. Возможно, вам необходимо настроить фильтр области в соответствии с развертыванием Azure AD Connect.

6. Перейдите на вкладку **«Трансформация»** и реализуйте следующее правило преобразования:

    | Flow type (Тип потока) | Целевой атрибут | Источник | Применить однократно | Merge Type (Тип объединения) |
    | --- | --- | --- | --- | --- |
    | Прямой доступ | preferredDataLocation | preferredDataLocation | Флажок снят. | Update |

7. Щелкните **Добавить**, чтобы создать правило исходящей синхронизации.

![Снимок экрана Create outbound synchronization rule (Создание правила исходящей синхронизации)](./media/how-to-connect-sync-feature-preferreddatalocation/preferreddatalocation-step5.png)

## <a name="step-7-run-full-synchronization-cycle"></a>Шаг 7: Запуск полного цикла синхронизации
Как правило, полный цикл синхронизации обязателен, так как вы добавили новые атрибуты в схемы Active Directory и соединителя Azure AD, а также ввели настраиваемые правила синхронизации. Проверьте изменения перед их экспортом в Azure AD. Проверить изменения во время ручного выполнения действий, составляющих полный цикл синхронизации, можно с помощью следующих инструкций.

1. Выполните **полный импорт** для локального соединителя Active Directory.

   1. Откройте вкладку **Operations** (Операции) в Synchronization Service Manager.
   2. Щелкните правой кнопкой мыши **локальный соединитель Active Directory** и выберите **Запустить**.
   3. В диалоговом окне выберите **Full Import** (Полный импорт), а затем нажмите кнопку **ОК**.
   4. Дождитесь завершения операции.

      > [!NOTE]
      > Полный импорт локального соединителя Active Directory можно пропустить, если исходный атрибут уже включен в список импортируемых атрибутов. Другими словами, можно было не вносить изменения во время выполнения шага 2 в этой статье.

2. Выполните **полный импорт** для соединителя Azure AD.

   1. Нажмите правой кнопкой мыши **на разъем Azure AD**и выберите **Run**.
   2. В диалоговом окне выберите **Full Import** (Полный импорт), а затем нажмите кнопку **ОК**.
   3. Дождитесь завершения операции.

3. Проверка изменений правила синхронизации на существующем объекте **пользователя.**

   Исходный атрибут из локального каталога Active Directory и атрибут **preferredDataLocation** из Azure AD были импортированы в каждое соответствующее пространство соединителя. Перед выполнением шага полной синхронизации выполните предварительный просмотр имеющегося объекта **User** в пространстве локального соединителя Active Directory. У выбранного объекта должен быть заполнен исходный атрибут. Если при предварительном просмотре атрибут **preferredDataLocation** успешно заполнен в метавселенной, то это хороший показатель того, что вы верно настроили правила синхронизации. Сведения о том, как выполнить предварительный просмотр, см. в разделе [Проверка изменений](how-to-connect-sync-change-the-configuration.md#verify-the-change).

4. Выполните **полную синхронизацию** для локального соединителя Active Directory.

   1. Щелкните правой кнопкой мыши **локальный соединитель Active Directory** и выберите **Запустить**.
   2. В диалоговом окне выберите **Full Synchronization** (Полная синхронизация), а затем нажмите кнопку **ОК**.
   3. Дождитесь завершения операции.

5. Проверьте **ожидающие операции экспорта** в Azure AD.

   1. Нажмите на **разъем Azure AD**и выберите **пространство поиска.**
   2. В диалоговом окне **Search Connector Space** (Поиск пространства соединителя) сделайте следующее.

        а. Для параметра **Scope** (Область) укажите значение **Pending Export** (Ожидающая операция экспорта).<br>
        b. Установите все три флажка: **"Добавить", "Изменить" и "Удалить"**.<br>
        c. Чтобы получить список объектов с изменениями для экспорта, нажмите кнопку **Поиск**. Чтобы проверить изменения указанного объекта, дважды щелкните его.<br>
        d. Убедитесь, что изменения являются ожидаемыми.

6. Выполнить **экспорт** на **разъеме Azure AD**

   1. Нажмите правой кнопкой мыши **на разъем Azure AD**и выберите **Run**.
   2. В диалоговом окне **Run Connector** (Запуск соединителя) выберите **Экспорт**, а затем нажмите кнопку **ОК**.
   3. Дождитесь завершения операции.

> [!NOTE]
> Вы можете заметить, что инструкции для соединителя Azure AD не содержат шагов полной синхронизации и экспорта для соединителя Azure AD. Они и не требуются, так как значения атрибутов передаются только из локального каталога Active Directory в Azure AD.

## <a name="step-8-re-enable-sync-scheduler"></a>Шаг 8: Перевключение планировщик синхронизации
Повторно включите встроенный планировщик синхронизации.

1. Запустите сеанс PowerShell.
2. Повторно включите плановую синхронизацию, выполнив командлет `Set-ADSyncScheduler -SyncCycleEnabled $true`.

## <a name="step-9-verify-the-result"></a>Шаг 9: Проверить результат
Теперь можно проверить конфигурацию и активировать ее для пользователей.

1. Добавьте геообъект в выбранный атрибут для пользователя. Список доступных геообъектов можно найти в этой таблице.  
![Снимок экрана с атрибутом AD, добавленным для пользователя](./media/how-to-connect-sync-feature-preferreddatalocation/preferreddatalocation-adattribute.png)
2. Дождитесь, пока атрибут будет синхронизирован с Azure AD.
3. При помощи Exchange Online PowerShell проверьте, правильно ли установлен регион почтового ящика.  
![Снимок экрана Exchange Online PowerShell](./media/how-to-connect-sync-feature-preferreddatalocation/preferreddatalocation-mailboxregion.png)  
Учитывая, что клиент отмечен для использования этой функции, почтовый ящик перемещен в правильный геообъект. В этом можно убедиться, просмотрев имя сервера, на котором размещен почтовый ящик.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о поддержке нескольких регионов в Office 365:

* [Сеансы с несколькими регионами в Ignite](https://aka.ms/MultiGeoIgnite)
* [Сеансы с несколькими регионами в OneDrive](https://aka.ms/OneDriveMultiGeo)
* [Сеансы с несколькими регионами в SharePoint Online](https://aka.ms/SharePointMultiGeo)

Дополнительные сведения о модели конфигурации в модуле синхронизации:

* Дополнительные сведения о модели конфигурации, см. в статье о [принципах декларативной подготовки](concept-azure-ad-connect-sync-declarative-provisioning.md).
* Дополнительные сведения о языке выражений см. в статье [Служба синхронизации Azure AD Connect: общие сведения о выражениях декларативной подготовки](concept-azure-ad-connect-sync-declarative-provisioning-expressions.md).

Обзорные статьи:

* [Службы синхронизации Azure AD Connect: общие сведений о синхронизации и ее настройка](how-to-connect-sync-whatis.md)
* [Интеграция локальных удостоверений с Azure Active Directory.](whatis-hybrid-identity.md)
