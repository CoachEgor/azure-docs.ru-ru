---
title: Поток кода устройства OAuth 2,0 | Службы
titleSuffix: Microsoft identity platform
description: Войдите в систему пользователей без браузера. Создавайте встроенные потоки проверки подлинности и без браузера, используя предоставление авторизации устройства.
services: active-directory
documentationcenter: ''
author: rwike77
manager: CelesteDG
editor: ''
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 11/19/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.openlocfilehash: b45ba0c0b417be9cf308fedbb7fad2f6ad5fceaf
ms.sourcegitcommit: 76bc196464334a99510e33d836669d95d7f57643
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/12/2020
ms.locfileid: "77159737"
---
# <a name="microsoft-identity-platform-and-the-oauth-20-device-authorization-grant-flow"></a>Платформа удостоверений Майкрософт и поток предоставления авторизации устройства OAuth 2,0

Платформа удостоверений Майкрософт поддерживает [предоставление авторизации устройства](https://tools.ietf.org/html/rfc8628), что позволяет пользователям входить на устройства с ограниченным вводом, такие как интеллектуальный телевизор, устройство IOT или принтер.  Чтобы включить этот поток на устройстве, пользователь должен выполнить вход, посетив веб-страницу в браузере на другом устройстве.  Когда пользователь выполнит вход, устройство сможет получить необходимые маркеры доступа и маркеры обновления.  

В этой статье описывается, как программировать непосредственно по протоколу в приложении.  По возможности рекомендуется использовать поддерживаемые библиотеки проверки подлинности Майкрософт (MSAL) вместо [получения маркеров и вызова защищенных веб-API](authentication-flows-app-scenarios.md#scenarios-and-supported-authentication-flows).  Также ознакомьтесь с [примерами приложений, которые используют MSAL](sample-v2-code.md).

> [!NOTE]
> Конечная точка платформы Microsoft Identity не поддерживает все сценарии и функции Azure Active Directory. Чтобы определить, следует ли использовать конечную точку платформы идентификации Майкрософт, ознакомьтесь с [ограничениями платформы удостоверений Майкрософт](active-directory-v2-limitations.md).

## <a name="protocol-diagram"></a>Схема протокола

Весь поток кода устройства аналогичен приведенному на следующей схеме. Описание каждого шага приведено далее в этой статье.

![Поток кода устройства](./media/v2-oauth2-device-code/v2-oauth-device-flow.svg)

## <a name="device-authorization-request"></a>Запрос авторизации устройства

Клиент должен сначала проверить сервер проверки подлинности для устройства и пользовательского кода, который используется для инициации проверки подлинности. Клиент собирает этот запрос из конечной точки `/devicecode`. В этом запросе клиент также должен добавить разрешения, которые ему требуется получить от пользователя. С момента отправки запроса у пользователя есть только 15 минут для входа (обычное значение для `expires_in`), поэтому выполняйте этот запрос, только когда пользователь указал, что готов выполнить вход.

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman.
> [![попытаться выполнить этот запрос в POST](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

```
// Line breaks are for legibility only.

POST https://login.microsoftonline.com/{tenant}/oauth2/v2.0/devicecode
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
scope=user.read%20openid%20profile

```

| Параметр | Условие | Description |
| --- | --- | --- |
| `tenant` | Обязательно | Может быть "/Common",/консумерс или/организатионс.  Он также может быть клиентом каталога, для которого требуется запросить разрешение, в формате GUID или понятном имени.  |
| `client_id` | Обязательно | **Идентификатор приложения (клиента)** , который [портал Azure — регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) , назначенный приложению. |
| `scope` | Рекомендуемая | Разделенный пробелами список [областей](v2-permissions-and-consent.md) , для которого необходимо согласие пользователя.  |

### <a name="device-authorization-response"></a>Ответ авторизации устройства

При успешном ответе возвращается объект JSON, содержащий необходимые сведения, чтобы разрешить пользователю войти в систему.  

| Параметр | Формат | Description |
| ---              | --- | --- |
|`device_code`     | String | Длинная строка, используемая для проверки сеанса между клиентом и сервером авторизации. Клиент использует этот параметр для запроса маркера доступа с сервера авторизации. |
|`user_code`       | String | Короткая строка, отображаемая для пользователя, который используется для задания сеанса на вторичном устройстве.|
|`verification_uri`| URI | URI, по которому пользователь должен перейти с помощью `user_code` для входа. |
|`expires_in`      | INT | Количество секунд до окончания срока действия `device_code` и `user_code`. |
|`interval`        | INT | Число секунд ожидания клиентом между опрашивающими запросами. |
| `message`        | String | Понятная пользователю строка с инструкциями. Ее можно локализовать, включив **параметр запроса** в запросе формы `?mkt=xx-XX`, заменив соответствующий код языка и региональных параметров. |

> [!NOTE]
> Поле ответа `verification_uri_complete` не включено или не поддерживается в настоящее время.  Мы упомянули это, поскольку если вы прочитали [стандарт](https://tools.ietf.org/html/rfc8628) , вы увидите, что `verification_uri_complete` указана как необязательная часть стандарта потока кода устройства.

## <a name="authenticating-the-user"></a>Проверка подлинности пользователя

После получения `user_code` и `verification_uri`клиент отображает их пользователю, указывая, что вход выполняется с помощью мобильного телефона или браузера ПК.

Если пользователь проходит проверку подлинности с помощью личной учетной записи (в "/Common" или/консумерс), ему будет предложено войти еще раз, чтобы перевести состояние проверки подлинности на устройство.  Они также получат запрос на предоставление согласия, чтобы убедиться, что они знают о предоставляемых разрешениях.  Это не относится к рабочим или учебным учетным записям, используемым для проверки подлинности. 

Хотя пользователь проходит проверку подлинности в `verification_uri`, клиент должен опросить конечную точку `/token` на наличие запрошенного токена с помощью `device_code`.

``` 
POST https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token
Content-Type: application/x-www-form-urlencoded

grant_type: urn:ietf:params:oauth:grant-type:device_code
client_id: 6731de76-14a6-49ae-97bc-6eba6914391e
device_code: GMMhmHCXhWEzkobqIHGG_EnNYYsAkukHspeYUk9E8...
```

| Параметр | Обязательно | Description|
| -------- | -------- | ---------- |
| `tenant`  | Обязательно | Один и тот же псевдоним клиента или клиента, используемый в первоначальном запросе. | 
| `grant_type` | Обязательно | Должен содержать значение `urn:ietf:params:oauth:grant-type:device_code`.|
| `client_id`  | Обязательно | Должен соответствовать `client_id`, используемому в первоначальном запросе. |
| `device_code`| Обязательно | `device_code`, возвращаемый в запросе авторизации устройства.  |

### <a name="expected-errors"></a>Ожидаемые ошибки

Поток кода устройства — это протокол опроса, поэтому клиент должен ждать получения ошибок до того, как пользователь завершит проверку подлинности.  

| Ошибка | Description | Действие клиента |
| ------ | ----------- | -------------|
| `authorization_pending` | Пользователь не завершил проверку подлинности, но не отменил поток. | Повторите запрос не менее чем через `interval` с. |
| `authorization_declined` | Пользователь отклонил запрос авторизации.| Остановка опроса и возврат в состояние без проверки подлинности.  |
| `bad_verification_code`| `device_code`, отправленный в конечную точку `/token`, не распознан. | Убедитесь, что клиент отправляет правильный `device_code` в запросе. |
| `expired_token` | Прошло не менее `expires_in` секунд, и проверка подлинности больше невозможна с помощью этого `device_code`. | Прерывать опрос и возвращаться к состоянию без проверки подлинности. |   

### <a name="successful-authentication-response"></a>Успешный ответ аутентификации

Успешный ответ маркера выглядит следующим образом:

```json
{
    "token_type": "Bearer",
    "scope": "User.Read profile openid email",
    "expires_in": 3599,
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```

| Параметр | Формат | Description |
| --------- | ------ | ----------- |
| `token_type` | String| Всегда "Bearer". |
| `scope` | Строки, разделенные пробелами | Если маркер доступа возвращен, этот параметр приводит список областей, в которых маркер доступа является допустимым. |
| `expires_in`| INT | Количество секунд, в течение которых маркер доступа является допустимым. |
| `access_token`| Непрозрачная строка | Выдается для запрошенных [областей](v2-permissions-and-consent.md).  |
| `id_token`   | JWT | Выдается, если исходный параметр `scope` содержит область `openid`.  |
| `refresh_token` | Непрозрачная строка | Выдается, если исходный параметр `scope` содержит `offline_access`.  |

Маркер обновления можно использовать для получения новых маркеров доступа и обновления маркеров с помощью того же потока, который описан в [документации по потоку кода OAuth](v2-oauth2-auth-code-flow.md#refresh-the-access-token).  
