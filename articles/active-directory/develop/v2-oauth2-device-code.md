---
title: Использование платформы удостоверений для входа пользователей на устройства без браузера | Azure
description: Создание внедренного потока проверки подлинности и потока проверки подлинности без браузера с использованием предоставления кода устройства.
services: active-directory
documentationcenter: ''
author: rwike77
manager: CelesteDG
editor: ''
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 06/12/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: e92e4d0e296e83b413cfd2a67041a5749c16699e
ms.sourcegitcommit: 9b80d1e560b02f74d2237489fa1c6eb7eca5ee10
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/01/2019
ms.locfileid: "67482235"
---
# <a name="microsoft-identity-platform-and-the-oauth-20-device-code-flow"></a>Поток кода платформы удостоверений и устройств OAuth 2.0

[!INCLUDE [active-directory-develop-applies-v2](../../../includes/active-directory-develop-applies-v2.md)]

Поддерживает платформа Microsoft identity [предоставление кода устройства](https://tools.ietf.org/html/draft-ietf-oauth-device-flow-12), который позволяет пользователям входить ограниченное ввода устройств, таких как смарт-ТВ, устройства Интернета вещей или принтера.  Чтобы включить этот поток на устройстве, пользователь должен выполнить вход, посетив веб-страницу в браузере на другом устройстве.  Когда пользователь выполнит вход, устройство сможет получить необходимые маркеры доступа и маркеры обновления.  

> [!IMPORTANT]
> В настоящее время конечная точка платформы удостоверений Microsoft поддерживает только поток устройств для клиентов Azure AD, но не личными учетными записями.  Это означает, что необходимо использовать конечную точку как клиента, или `organizations` конечной точки.  Эта поддержка будет включена в ближайшее время. 
>
> Личные учетные записи, приглашенные в клиент Azure AD, будут иметь возможность использовать предоставление потока устройства, но только в контексте клиента.
>
> Как дополнительное Примечание `verification_uri_complete` поля ответа не включены или не поддерживается в настоящее время.  

> [!NOTE]
> Конечная точка платформы удостоверений Microsoft не поддерживает все сценарии Azure Active Directory и компоненты. Чтобы определить, следует ли использовать конечную точку платформы Microsoft identity, ознакомьтесь [ограничения платформы удостоверений Microsoft](active-directory-v2-limitations.md).

## <a name="protocol-diagram"></a>Схема протокола

Весь поток кода устройства аналогичен приведенному на следующей схеме. Описание каждого шага приведено далее в этой статье.

![Поток кода устройства](./media/v2-oauth2-device-code/v2-oauth-device-flow.svg)

## <a name="device-authorization-request"></a>Запрос авторизации устройства

Клиент сначала должен проверять на сервере проверки подлинности для пользователей и устройств код, который используется для запуска проверки подлинности. Клиент собирает этот запрос из конечной точки `/devicecode`. В этом запросе клиент также должен добавить разрешения, которые ему требуется получить от пользователя. С момента отправки запроса у пользователя есть только 15 минут для входа (обычное значение для `expires_in`), поэтому выполняйте этот запрос, только когда пользователь указал, что готов выполнить вход.

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman.
> [![Попробуйте выполнить этот запрос в Postman](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

```
// Line breaks are for legibility only.

POST https://login.microsoftonline.com/{tenant}/devicecode
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
scope=user.read%20openid%20profile

```

| Параметр | Условие | Описание |
| --- | --- | --- |
| `tenant` | Обязательно для заполнения |Клиент каталога, из которого необходимо запросить разрешение. Его можно указать в виде GUID или понятного имени.  |
| `client_id` | Обязательно для заполнения | **Идентификатор приложения (клиент)** , [портал Azure — регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) опыт, полученный вашим приложением. |
| `scope` | Рекомендуется | Разделенный пробелами список [областей](v2-permissions-and-consent.md) , для которого необходимо согласие пользователя.  |

### <a name="device-authorization-response"></a>Ответ авторизации устройства

При успешном ответе возвращается объект JSON, содержащий необходимые сведения, чтобы разрешить пользователю войти в систему.  

| Параметр | Формат | Описание |
| ---              | --- | --- |
|`device_code`     | String | Длинная строка, используемая для проверки сеанса между клиентом и сервером авторизации. Клиент использует этот параметр для запроса маркера доступа из сервера авторизации. |
|`user_code`       | String | Короткой строки, показываемое пользователю, который используется для идентификации сеанса на дополнительное устройство.|
|`verification_uri`| URI | URI, по которому пользователь должен перейти с помощью `user_code` для входа. |
|`expires_in`      | int | Количество секунд до окончания срока действия `device_code` и `user_code`. |
|`interval`        | int | Число секунд ожидания клиентом между опрашивающими запросами. |
| `message`        | String | Понятная пользователю строка с инструкциями. Ее можно локализовать, включив **параметр запроса** в запросе формы `?mkt=xx-XX`, заменив соответствующий код языка и региональных параметров. |

## <a name="authenticating-the-user"></a>Проверка подлинности пользователя

После получения `user_code` и `verification_uri`, клиент отображает для пользователя, им выполнять вход с помощью их мобильный телефон или ПК браузера.  Кроме того, клиент может использовать QR-код или похожий механизм, чтобы отобразить `verfication_uri_complete`, при этом пользователю понадобится ввести `user_code`.

Хотя пользователь проходит проверку подлинности в `verification_uri`, клиент должен опросить конечную точку `/token` на наличие запрошенного токена с помощью `device_code`.

``` 
POST https://login.microsoftonline.com/tenant/oauth2/v2.0/token
Content-Type: application/x-www-form-urlencoded

grant_type: urn:ietf:params:oauth:grant-type:device_code
client_id: 6731de76-14a6-49ae-97bc-6eba6914391e
device_code: GMMhmHCXhWEzkobqIHGG_EnNYYsAkukHspeYUk9E8
```

| Параметр | Обязательно для заполнения | Описание|
| -------- | -------- | ---------- |
| `grant_type` | Обязательно для заполнения | Должен содержать значение `urn:ietf:params:oauth:grant-type:device_code`.|
| `client_id`  | Обязательно для заполнения | Должен соответствовать `client_id`, используемому в первоначальном запросе. |
| `device_code`| Обязательно для заполнения | `device_code`, возвращаемый в запросе авторизации устройства.  |

### <a name="expected-errors"></a>Ожидаемые ошибки

Поток кода устройства — это протокол опроса, поэтому клиент должен ожидать, что для приема ошибок до завершения проверки подлинности.  

| Ошибка | Описание | Действие клиента |
| ------ | ----------- | -------------|
| `authorization_pending` | Пользователь не завершена проверку подлинности, но еще не отменено поток. | Повторите запрос не менее чем через `interval` с. |
| `authorization_declined` | Пользователь отклонил запрос авторизации.| Остановка опроса и возврат в состояние без проверки подлинности.  |
| `bad_verification_code`| `device_code` Отправляемые `/token` конечной точки не распознан. | Убедитесь, что клиент отправляет правильный `device_code` в запросе. |
| `expired_token` | Прошло не менее `expires_in` секунд, и проверка подлинности больше невозможна с помощью этого `device_code`. | Остановка опроса и вернуться в состояние без проверки подлинности. |

### <a name="successful-authentication-response"></a>Успешный ответ аутентификации

Успешный ответ маркера выглядит следующим образом:

```json
{
    "token_type": "Bearer",
    "scope": "User.Read profile openid email",
    "expires_in": 3599,
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```

| Параметр | Формат | Описание |
| --------- | ------ | ----------- |
| `token_type` | String| Всегда "Bearer". |
| `scope` | Строки, разделенные пробелами | Если маркер доступа возвращен, этот параметр приводит список областей, в которых маркер доступа является допустимым. |
| `expires_in`| int | Количество секунд, в течение которых маркер доступа является допустимым. |
| `access_token`| Непрозрачная строка | Выдается для запрошенных [областей](v2-permissions-and-consent.md).  |
| `id_token`   | JWT | Выдается, если исходный параметр `scope` содержит область `openid`.  |
| `refresh_token` | Непрозрачная строка | Выдается, если исходный параметр `scope` содержит `offline_access`.  |

Можно использовать токен обновления для получения новых маркеров доступа и обновления маркеры с помощью одного потока в [документации потока кода OAuth](v2-oauth2-auth-code-flow.md#refresh-the-access-token).  
