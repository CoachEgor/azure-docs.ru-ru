---
title: Поток кода устройства OAuth 2.0 Azure
titleSuffix: Microsoft identity platform
description: Войти в пользователей без браузера. Создавайте встроенные и менее просматриваемые потоки аутентификации с помощью гранта авторизации устройства.
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 11/19/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.openlocfilehash: 8b2489a5e6a4481ffa2bd9df0ccf6b082e3f6956
ms.sourcegitcommit: d187fe0143d7dbaf8d775150453bd3c188087411
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80886285"
---
# <a name="microsoft-identity-platform-and-the-oauth-20-device-authorization-grant-flow"></a>Платформа идентификации Майкрософт и поток разрешений на авторизацию устройств OAuth 2.0

Платформа майкрософт поддерживает [грант на авторизацию устройств,](https://tools.ietf.org/html/rfc8628)который позволяет пользователям входить в систему с ограничениями на вводимые устройства, такие как смарт-телевизор, IoT устройство или принтер.  Чтобы включить этот поток на устройстве, пользователь должен выполнить вход, посетив веб-страницу в браузере на другом устройстве.  Когда пользователь выполнит вход, устройство сможет получить необходимые маркеры доступа и маркеры обновления.  

В этой статье описывается, как запрограммировать непосредственно против протокола в приложении.  Когда это возможно, мы рекомендуем вам использовать поддерживаемые библиотеки подлинности Майкрософт (MSAL) вместо того, чтобы [приобретать токены и вызывать защищенные web-aIS.](authentication-flows-app-scenarios.md#scenarios-and-supported-authentication-flows)  Также взгляните на [образец приложений, которые используют MSAL](sample-v2-code.md).

> [!NOTE]
> Конечная точка платформы майкрософт не поддерживает все сценарии и функции Active Directory Azure. Чтобы определить, следует ли использовать конечную точку платформы идентификации Майкрософт, прочитайте об [ограничениях платформы идентификации Майкрософт.](active-directory-v2-limitations.md)

## <a name="protocol-diagram"></a>Схема протокола

Весь поток кода устройства аналогичен приведенному на следующей схеме. Описание каждого шага приведено далее в этой статье.

![Поток кода устройства](./media/v2-oauth2-device-code/v2-oauth-device-flow.svg)

## <a name="device-authorization-request"></a>Запрос авторизации устройства

Клиент должен сначала проверить с сервером аутентификации для устройства и кода пользователя, который используется для инициирования проверки подлинности. Клиент собирает этот запрос из конечной точки `/devicecode`. В этом запросе клиент также должен добавить разрешения, которые ему требуется получить от пользователя. С момента отправки запроса у пользователя есть только 15 минут для входа (обычное значение для `expires_in`), поэтому выполняйте этот запрос, только когда пользователь указал, что готов выполнить вход.

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman.
> [![Попробуйте запустить этот запрос в Postman](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

```
// Line breaks are for legibility only.

POST https://login.microsoftonline.com/{tenant}/oauth2/v2.0/devicecode
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
scope=user.read%20openid%20profile

```

| Параметр | Условие | Описание |
| --- | --- | --- |
| `tenant` | Обязательно | Может быть /общие, /потребители, или /организации.  Это также может быть арендатор каталога, который вы хотите запросить разрешение в GUID или дружественном формате имени.  |
| `client_id` | Обязательно | **Идентификатор приложения (клиента),** который имеется на [портале Azure - Регистрация приложений,](https://go.microsoft.com/fwlink/?linkid=2083908) назначенная вашему приложению. |
| `scope` | Рекомендуемая | Разделенный пробелами список [областей](v2-permissions-and-consent.md) , для которого необходимо согласие пользователя.  |

### <a name="device-authorization-response"></a>Ответ авторизации устройства

При успешном ответе возвращается объект JSON, содержащий необходимые сведения, чтобы разрешить пользователю войти в систему.  

| Параметр | Формат | Описание |
| ---              | --- | --- |
|`device_code`     | Строка | Длинная строка, используемая для проверки сеанса между клиентом и сервером авторизации. Клиент использует этот параметр для запроса токен доступа с сервера авторизации. |
|`user_code`       | Строка | Короткая строка, показанная пользователю, которая используется для идентификации сеанса на вторичном устройстве.|
|`verification_uri`| URI | URI, по которому пользователь должен перейти с помощью `user_code` для входа. |
|`expires_in`      | INT | Количество секунд до окончания срока действия `device_code` и `user_code`. |
|`interval`        | INT | Число секунд ожидания клиентом между опрашивающими запросами. |
| `message`        | Строка | Понятная пользователю строка с инструкциями. Ее можно локализовать, включив **параметр запроса** в запросе формы `?mkt=xx-XX`, заменив соответствующий код языка и региональных параметров. |

> [!NOTE]
> В `verification_uri_complete` настоящее время поле реагирования не включено и не поддерживается.  Мы упоминаем об этом, потому `verification_uri_complete` что если вы читаете [стандарт,](https://tools.ietf.org/html/rfc8628) который вы видите, что перечислены в качестве дополнительной части стандарта потока кода устройства.

## <a name="authenticating-the-user"></a>Проверка подлинности пользователя

После получения `user_code` `verification_uri`и , клиент отображает их для пользователя, поручив им войти в свой мобильный телефон или браузер ПК.

Если пользователь проверяет подлинность с помощью личного аккаунта (на /общий или /потребителей), им будет предложено войти снова для того, чтобы передать состояние аутентификации на устройство.  Им также будет предложено дать согласие, чтобы убедиться, что они знают о разрешениях, выдаваемых.  Это не относится к рабочим или школьным учетным записям, используемым для проверки подлинности. 

Хотя пользователь проходит проверку подлинности в `verification_uri`, клиент должен опросить конечную точку `/token` на наличие запрошенного токена с помощью `device_code`.

``` 
POST https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token
Content-Type: application/x-www-form-urlencoded

grant_type: urn:ietf:params:oauth:grant-type:device_code
client_id: 6731de76-14a6-49ae-97bc-6eba6914391e
device_code: GMMhmHCXhWEzkobqIHGG_EnNYYsAkukHspeYUk9E8...
```

| Параметр | Обязательно | Описание|
| -------- | -------- | ---------- |
| `tenant`  | Обязательно | Один и тот же псевдоним арендатора или арендатора, используемый в первоначальном запросе. | 
| `grant_type` | Обязательно | Должен содержать значение `urn:ietf:params:oauth:grant-type:device_code`.|
| `client_id`  | Обязательно | Должен соответствовать `client_id`, используемому в первоначальном запросе. |
| `device_code`| Обязательно | `device_code`, возвращаемый в запросе авторизации устройства.  |

### <a name="expected-errors"></a>Ожидаемые ошибки

Поток кода устройства является протоколом опроса, поэтому клиент должен ожидать получения ошибок до того, как пользователь закончит проверку подлинности.  

| Error | Описание | Действие клиента |
| ------ | ----------- | -------------|
| `authorization_pending` | Пользователь не закончил проверку подлинности, но не отменил поток. | Повторите запрос не менее чем через `interval` с. |
| `authorization_declined` | Пользователь отклонил запрос авторизации.| Остановка опроса и возврат в состояние без проверки подлинности.  |
| `bad_verification_code`| Отправлено `device_code` в `/token` конечную точку не было признано. | Убедитесь, что клиент отправляет правильный `device_code` в запросе. |
| `expired_token` | Прошло не менее `expires_in` секунд, и проверка подлинности больше невозможна с помощью этого `device_code`. | Остановить опрос и вернуться к недостоверному состоянию. |   

### <a name="successful-authentication-response"></a>Успешный ответ аутентификации

Успешный ответ маркера выглядит следующим образом:

```json
{
    "token_type": "Bearer",
    "scope": "User.Read profile openid email",
    "expires_in": 3599,
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```

| Параметр | Формат | Описание |
| --------- | ------ | ----------- |
| `token_type` | Строка| Всегда "Bearer". |
| `scope` | Строки, разделенные пробелами | Если маркер доступа возвращен, этот параметр приводит список областей, в которых маркер доступа является допустимым. |
| `expires_in`| INT | Количество секунд, в течение которых маркер доступа является допустимым. |
| `access_token`| Непрозрачная строка | Выдается для запрошенных [областей](v2-permissions-and-consent.md).  |
| `id_token`   | JWT | Выдается, если исходный параметр `scope` содержит область `openid`.  |
| `refresh_token` | Непрозрачная строка | Выдается, если исходный параметр `scope` содержит `offline_access`.  |

Токен обновления можно использовать для приобретения новых токенов доступа и обновления токенов, используя тот же поток, задокументированный в [документации потока Кода OAuth.](v2-oauth2-auth-code-flow.md#refresh-the-access-token)  
