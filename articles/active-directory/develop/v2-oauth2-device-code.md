---
title: Использование платформы Microsoft Identity для входа пользователей на устройства, не использующие браузер | Службы
description: Создание внедренного потока проверки подлинности и потока проверки подлинности без браузера с использованием предоставления кода устройства.
services: active-directory
documentationcenter: ''
author: rwike77
manager: CelesteDG
editor: ''
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 06/12/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: 274c4e89ff3f996cc71cdacdfb7b5b72e813ae4b
ms.sourcegitcommit: a8b638322d494739f7463db4f0ea465496c689c6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/17/2019
ms.locfileid: "68297659"
---
# <a name="microsoft-identity-platform-and-the-oauth-20-device-code-flow"></a>Платформа удостоверений Майкрософт и поток кода устройства OAuth 2,0

[!INCLUDE [active-directory-develop-applies-v2](../../../includes/active-directory-develop-applies-v2.md)]

Платформа удостоверений Майкрософт поддерживает [предоставление кода устройства](https://tools.ietf.org/html/draft-ietf-oauth-device-flow-12), позволяющее пользователям входить на устройства с ограниченным вводом, такие как интеллектуальное телевидение, устройство IOT или принтер.  Чтобы включить этот поток на устройстве, пользователь должен выполнить вход, посетив веб-страницу в браузере на другом устройстве.  Когда пользователь выполнит вход, устройство сможет получить необходимые маркеры доступа и маркеры обновления.  

> [!IMPORTANT]
> В настоящее время конечная точка платформы Microsoft Identity поддерживает только поток устройств для клиентов Azure AD, но не личные учетные записи.  Это означает, что необходимо использовать конечную точку, настроенную как клиент или `organizations` конечную точку.  Эта поддержка будет включена в ближайшее время. 
>
> Личные учетные записи, приглашенные в клиент Azure AD, будут иметь возможность использовать предоставление потока устройства, но только в контексте клиента.
>
> В качестве дополнительного примечания `verification_uri_complete` поле ответа в настоящее время не включено или не поддерживается.  

> [!NOTE]
> Конечная точка платформы Microsoft Identity не поддерживает все сценарии и функции Azure Active Directory. Чтобы определить, следует ли использовать конечную точку платформы идентификации Майкрософт, ознакомьтесь с [ограничениями платформы удостоверений Майкрософт](active-directory-v2-limitations.md).

## <a name="protocol-diagram"></a>Схема протокола

Весь поток кода устройства аналогичен приведенному на следующей схеме. Описание каждого шага приведено далее в этой статье.

![Поток кода устройства](./media/v2-oauth2-device-code/v2-oauth-device-flow.svg)

## <a name="device-authorization-request"></a>Запрос авторизации устройства

Клиент должен сначала проверить сервер проверки подлинности для устройства и пользовательского кода, который используется для инициации проверки подлинности. Клиент собирает этот запрос из конечной точки `/devicecode`. В этом запросе клиент также должен добавить разрешения, которые ему требуется получить от пользователя. С момента отправки запроса у пользователя есть только 15 минут для входа (обычное значение для `expires_in`), поэтому выполняйте этот запрос, только когда пользователь указал, что готов выполнить вход.

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman.
> [![Попробуйте выполнить этот запрос в POST](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

```
// Line breaks are for legibility only.

POST https://login.microsoftonline.com/{tenant}/oauth2/v2.0/devicecode
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
scope=user.read%20openid%20profile

```

| Параметр | Условие | Описание |
| --- | --- | --- |
| `tenant` | Обязательно для заполнения |Клиент каталога, из которого необходимо запросить разрешение. Его можно указать в виде GUID или понятного имени.  |
| `client_id` | Обязательно для заполнения | **Идентификатор приложения (клиента)** , который [портал Azure — регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) , назначенный приложению. |
| `scope` | Рекомендуется | Разделенный пробелами список [областей](v2-permissions-and-consent.md) , для которого необходимо согласие пользователя.  |

### <a name="device-authorization-response"></a>Ответ авторизации устройства

При успешном ответе возвращается объект JSON, содержащий необходимые сведения, чтобы разрешить пользователю войти в систему.  

| Параметр | Формат | Описание |
| ---              | --- | --- |
|`device_code`     | Строка, | Длинная строка, используемая для проверки сеанса между клиентом и сервером авторизации. Клиент использует этот параметр для запроса маркера доступа с сервера авторизации. |
|`user_code`       | Строка, | Короткая строка, отображаемая для пользователя, который используется для задания сеанса на вторичном устройстве.|
|`verification_uri`| URI | URI, по которому пользователь должен перейти с помощью `user_code` для входа. |
|`expires_in`      | ssNoversion | Количество секунд до окончания срока действия `device_code` и `user_code`. |
|`interval`        | ssNoversion | Число секунд ожидания клиентом между опрашивающими запросами. |
| `message`        | Строка, | Понятная пользователю строка с инструкциями. Ее можно локализовать, включив **параметр запроса** в запросе формы `?mkt=xx-XX`, заменив соответствующий код языка и региональных параметров. |

## <a name="authenticating-the-user"></a>Проверка подлинности пользователя

После получения `user_code` и `verification_uri`клиент отображает их пользователю, указывая, что вход выполняется с помощью мобильного телефона или браузера ПК.  Кроме того, клиент может использовать QR-код или похожий механизм, чтобы отобразить `verfication_uri_complete`, при этом пользователю понадобится ввести `user_code`.

Хотя пользователь проходит проверку подлинности в `verification_uri`, клиент должен опросить конечную точку `/token` на наличие запрошенного токена с помощью `device_code`.

``` 
POST https://login.microsoftonline.com/tenant/oauth2/v2.0/token
Content-Type: application/x-www-form-urlencoded

grant_type: urn:ietf:params:oauth:grant-type:device_code
client_id: 6731de76-14a6-49ae-97bc-6eba6914391e
device_code: GMMhmHCXhWEzkobqIHGG_EnNYYsAkukHspeYUk9E8
```

| Параметр | Обязательно для заполнения | Описание|
| -------- | -------- | ---------- |
| `grant_type` | Обязательно для заполнения | Должен содержать значение `urn:ietf:params:oauth:grant-type:device_code`.|
| `client_id`  | Обязательно для заполнения | Должен соответствовать `client_id`, используемому в первоначальном запросе. |
| `device_code`| Обязательно для заполнения | `device_code`, возвращаемый в запросе авторизации устройства.  |

### <a name="expected-errors"></a>Ожидаемые ошибки

Поток кода устройства — это протокол опроса, поэтому клиент должен ждать получения ошибок до того, как пользователь завершит проверку подлинности.  

| Error | Описание | Действие клиента |
| ------ | ----------- | -------------|
| `authorization_pending` | Пользователь не завершил проверку подлинности, но не отменил поток. | Повторите запрос не менее чем через `interval` с. |
| `authorization_declined` | Пользователь отклонил запрос авторизации.| Остановка опроса и возврат в состояние без проверки подлинности.  |
| `bad_verification_code`| Объект `device_code` , отправленный `/token` в конечную точку, не распознан. | Убедитесь, что клиент отправляет правильный `device_code` в запросе. |
| `expired_token` | Прошло не менее `expires_in` секунд, и проверка подлинности больше невозможна с помощью этого `device_code`. | Прерывать опрос и возвращаться к состоянию без проверки подлинности. |

### <a name="successful-authentication-response"></a>Успешный ответ аутентификации

Успешный ответ маркера выглядит следующим образом:

```json
{
    "token_type": "Bearer",
    "scope": "User.Read profile openid email",
    "expires_in": 3599,
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```

| Параметр | Формат | Описание |
| --------- | ------ | ----------- |
| `token_type` | Строка,| Всегда "Bearer". |
| `scope` | Строки, разделенные пробелами | Если маркер доступа возвращен, этот параметр приводит список областей, в которых маркер доступа является допустимым. |
| `expires_in`| ssNoversion | Количество секунд, в течение которых маркер доступа является допустимым. |
| `access_token`| Непрозрачная строка | Выдается для запрошенных [областей](v2-permissions-and-consent.md).  |
| `id_token`   | JWT | Выдается, если исходный параметр `scope` содержит область `openid`.  |
| `refresh_token` | Непрозрачная строка | Выдается, если исходный параметр `scope` содержит `offline_access`.  |

Маркер обновления можно использовать для получения новых маркеров доступа и обновления маркеров с помощью того же потока, который описан в [документации по потоку кода OAuth](v2-oauth2-auth-code-flow.md#refresh-the-access-token).  
