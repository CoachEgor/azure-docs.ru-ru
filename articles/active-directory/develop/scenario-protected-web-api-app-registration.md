---
title: Защищенный веб-API — регистрация приложения | Службы
description: Узнайте, как создать защищенный веб-API и сведения, необходимые для регистрации приложения.
services: active-directory
documentationcenter: dev-center-name
author: jmprieur
manager: CelesteDG
editor: ''
ms.service: active-directory
ms.subservice: develop
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 05/07/2019
ms.author: jmprieur
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: bbccfc38a4e5e4b31cb625c614e838a3c92e7429
ms.sourcegitcommit: 7c4de3e22b8e9d71c579f31cbfcea9f22d43721a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/26/2019
ms.locfileid: "68562309"
---
# <a name="protected-web-api-app-registration"></a>Защищенный веб-API: Регистрация приложения

В этой статье объясняются особенности регистрации приложений для защищенного веб-API.

См. [Краткое руководство. Зарегистрируйте приложение на платформе](quickstart-register-app.md) удостоверений Майкрософт, чтобы выполнить общие действия по регистрации приложения.

## <a name="accepted-token-version"></a>Принятая версия токена

Конечная точка платформы Microsoft Identity может выдавать два типа токенов: маркеры v 1.0 и маркеры версии 2.0. Дополнительные сведения об этих токенах см. в разделе [маркеры доступа](access-tokens.md). Принятая версия токена зависит от **поддерживаемых типов учетных записей** , выбранных при создании приложения.

- Если значения **поддерживаемых типов учетных записей** являются **учетными записями в любом каталоге Организации и личных учетных записях Майкрософт (например, Skype, Xbox, Outlook.com)** , принятая версия токена будет версии 2.0.
- В противном случае принятая версия токена будет иметь версию 1.0.

После создания приложения можно определить или изменить принятую версию токена, выполнив следующие действия.

1. В портал Azure выберите свое приложение, а затем выберите **Манифест** для своего приложения.
2. В манифесте выполните поиск по запросу **"акцесстокенакцептедверсион"** . Обратите внимание, что его значение равно **2**. Это свойство указывает Azure Active Directory (Azure AD), что веб-API принимает токены версии 2.0. Если значение равно **null**, принятая версия токена — v 1.0.
3. Если вы изменили версию токена, нажмите кнопку **сохранить**.

> [!NOTE]
> Веб-API указывает, какая версия токена (v 1.0 или v 2.0) она принимает. Когда клиенты запрашивают маркер для веб-API из конечной точки Microsoft Identity Platform (v 2.0), он получает маркер, указывающий, какая версия принимает веб-API.

## <a name="no-redirect-uri"></a>Без URI перенаправления

Веб-API не нужно регистрировать URI перенаправления, так как пользователь не вошел в интерактивном режиме.

## <a name="expose-an-api"></a>Предоставление API

Другим параметром, относящимся к веб-API, является предоставляемый API и предоставленные области.

### <a name="resource-uri-and-scopes"></a>URI ресурса и области

Области обычно находятся в форме `resourceURI/scopeName`. Для Microsoft Graph области имеют такие ярлыки, как `User.Read`. Эта строка является ярлыком для `https://graph.microsoft.com/user.read`.

Во время регистрации приложения необходимо определить следующие параметры:

- URI ресурса. По умолчанию портал регистрации приложений рекомендует использовать `api://{clientId}`. Этот URI ресурса уникален, но он не читается человеком. Его можно изменить, но убедитесь, что новое значение уникально.
- Одна или несколько *областей*. (Для клиентских приложений они будут отображаться как делегированные *разрешения* для веб-API.)
- Одна или несколько *ролей приложения*. (Для клиентских приложений они будут отображаться как *разрешения приложений* для веб-API.)

Области также отображаются на экране согласия, который предоставляется конечным пользователям приложения. Поэтому необходимо предоставить соответствующие строки, описывающие область:

- Как видно для конечного пользователя.
- Как видно администратором клиента, который может предоставить согласие администратора.

### <a name="exposing-delegated-permissions-scopes"></a>Предоставление делегированных разрешений (области)

1. Выберите раздел **предоставление API** в регистрации приложения.
1. Нажмите **Добавить группу**.
1. При появлении запроса примите предложенный URI идентификатора приложения`api://{clientId}`(), выбрав **сохранить и продолжить**.
1. Введите следующие параметры:
      - В качестве **имени области**используйте **access_as_user**.
      - Для **пользователей, которым разрешено согласие**, убедитесь, что выбраны **Администраторы и пользователи** .
      - В окне **"отображаемое имя согласия администратора"** введите **Access TodoListService в качестве пользователя**.
      - В поле **Описание согласия администратора**введите **доступ к веб-API TodoListService в качестве пользователя**.
      - В окне **Отображаемое имя согласия пользователя**введите **Access TodoListService в качестве пользователя**.
      - В поле **Описание согласия пользователя**введите **доступ к веб-API TodoListService в качестве пользователя**.
      - Установите для параметра **состояние** значение **включено**.
      - Выберите **Добавить область**.

### <a name="if-your-web-api-is-called-by-a-daemon-app"></a>Если веб-API вызывается приложением управляющей программы

В этом разделе вы узнаете, как зарегистрировать защищенный веб-API, чтобы его можно было безопасно вызывать с помощью управляющих приложений.

- Необходимо предоставить *разрешения приложения*. Вы объявите только разрешения приложения, так как управляющие приложения не взаимодействуют с пользователями, поэтому делегированные разрешения не имеют смысла.
- Администраторы клиента могут требовать от Azure Active Directory (Azure AD) выдавать маркеры для веб-API только для приложений, зарегистрированных для доступа к одному из разрешений приложения веб-API.

#### <a name="exposing-application-permissions-app-roles"></a>Предоставление разрешений приложению (роли приложений)

Чтобы предоставить разрешения приложения, необходимо изменить манифест.

1. В приложении регистрация приложения выберите **Манифест**.
1. Измените манифест, определив `appRoles` параметр и добавив одну или несколько ролей приложения. Определение роли представлено в следующем образце блока JSON. Оставьте для `allowedMemberTypes` `"Application"` параметра значение только. Убедитесь `id` , что является уникальным идентификатором GUID `displayName` и `value` не содержит пробелов.
1. Сохраните манифест.

В следующем примере показано содержимое `appRoles`. `id` (Может быть любым уникальным идентификатором GUID.)

```JSon
"appRoles": [
    {
    "allowedMemberTypes": [ "Application" ],
    "description": "Accesses the TodoListService-Cert as an application.",
    "displayName": "access_as_application",
    "id": "ccf784a6-fd0c-45f2-9c08-2f9d162a0628",
    "isEnabled": true,
    "lang": null,
    "origin": "Application",
    "value": "access_as_application"
    }
],
```

#### <a name="ensuring-that-azure-ad-issues-tokens-for-your-web-api-to-only-allowed-clients"></a>Обеспечение того, что Azure AD выдает токены для веб-API только разрешенным клиентам

Веб-API проверяет роль приложения. (Это способ предоставить разработчикам доступ к приложениям.) Но вы также можете настроить Azure AD, чтобы выдать маркер для веб-API только для приложений, утвержденных администратором клиента для доступа к API. Чтобы добавить эту повышенную безопасность:

1. На странице **Обзор** приложения для регистрации приложения выберите ссылку с именем приложения в разделе **управляемое приложение в локальном каталоге**. Заголовок для этого поля может быть усечен. Например, вы можете увидеть в разделе **управляемое приложение в...**

   > [!NOTE]
   >
   > При выборе этой ссылки вы переходите на страницу **Обзор корпоративных приложений** , связанную с субъектом-службой для вашего приложения в клиенте, где он был создан. Вы можете вернуться на страницу регистрации приложения, нажав кнопку "назад" в браузере.

1. Выберите страницу **Свойства** в разделе **Управление** страниц корпоративных приложений.
1. Если вы хотите, чтобы Azure AD разрешит доступ к веб-API только определенным клиентам, задайте для параметра **Назначение пользователей** значение **Да**.

   > [!IMPORTANT]
   >
   > Если вы настроили **Назначение пользователя?** **для этого**в Azure AD будут проверяться назначения ролей приложений клиентов при запросе маркера доступа для веб-API. Если клиент не назначен ни одной роли приложения, Azure AD возвратит ошибку `invalid_client: AADSTS501051: Application <application name> is not assigned to a role for the <web API>`.
   >
   > Если требуется указать **Назначение пользователя?** *служба Azure AD не будет проверять назначения ролей приложения, когда клиент запрашивает маркер доступа для веб-API*. Любой клиент управляющей программы (то есть любой клиент, использующий поток учетных данных клиента) сможет получить маркер доступа для API, просто указав его аудиторию. Любое приложение сможет получить доступ к API без необходимости запрашивать разрешения для него. Но веб-API всегда может, как описано в предыдущем разделе, убедитесь, что приложение имеет правильную роль (которая является полномочным администратором клиента). API выполняет эту проверку, проверяя наличие у маркера доступа утверждения ролей и правильность значения для этого утверждения. (В нашем случае это `access_as_application`значение.)

1. Щелкните **Сохранить**.

## <a name="next-steps"></a>Следующие шаги

> [!div class="nextstepaction"]
> [Конфигурация кода приложения](scenario-protected-web-api-app-configuration.md)
