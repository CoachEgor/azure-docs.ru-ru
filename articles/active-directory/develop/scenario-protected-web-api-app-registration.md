---
title: Защищенная регистрация веб-приложений API Azure
titleSuffix: Microsoft identity platform
description: Узнайте, как создать защищенный веб-aPI и информацию, необходимую для регистрации приложения.
services: active-directory
author: jmprieur
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 05/07/2019
ms.author: jmprieur
ms.custom: aaddev
ms.openlocfilehash: 214d379525f2ee534415d713aa298ec858a84c92
ms.sourcegitcommit: af1cbaaa4f0faa53f91fbde4d6009ffb7662f7eb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2020
ms.locfileid: "81868842"
---
# <a name="protected-web-api-app-registration"></a>Защищенный веб-aPI: Регистрация приложений

В этой статье разъясняются особенности регистрации приложений для защищенного веб-API.

Для общих шагов по регистрации приложения [см.](quickstart-register-app.md)

## <a name="accepted-token-version"></a>Принятая версия токенов

Конечная точка платформы идентификации Майкрософт может выдавать токены v1.0 и токены v2.0. Для получения дополнительной информации об [Access tokens](access-tokens.md)этих токенах см.

Принятая версия токенов зависит от значения **типов поддерживаемых учетных записей,** которое вы выбираете при создании приложения.

- Если значение **поддерживаемых типов учетных записей** — это **учетные записи в любом каталоге организаций и личных учетных записей Майкрософт (например, Skype, Xbox, Outlook.com),** то принятая версия токенов является v2.0.
- В противном случае, принятая версия токенов v1.0.

После создания приложения можно определить или изменить принятую версию маркеров следующим образом:

1. На портале Azure выберите приложение, а затем выберите **Manifest**.
1. Найти **свойство accessTokenAcceptedVersion** в манифесте. Значение значения по умолчанию объекта составляет 2.
1. Значение указывает на Active Directory Azure (Azure AD), который токен версия Веб-API принимает.
    - Если значение 2, веб-API принимает токены v2.0.
    - Если значение **является нулевым,** веб-API принимает токены v1.0.
1. Если вы изменили версию маркера, выберите **Сохранить**.

> [!NOTE]
> Веб-API определяет, какую версию токенов он принимает. Когда клиент запрашивает токен для вашего веб-API с точки зрения идентификации Майкрософт (v2.0), клиент получает маркер, указывающий, какую токенную версию принимает веб-aPI.

## <a name="no-redirect-uri"></a>Нет перенаправления URI

Веб-AIS не нужно регистрировать перенаправление URI, потому что ни один пользователь не вписывается в интерактивно.

## <a name="exposed-api"></a>Разоблаченный API

Другими параметрами, специфичными для веб-API, являются открытый API и открытые области.

### <a name="application-id-uri-and-scopes"></a>Приложение ID URI и области

Сферы обычно имеют `resourceURI/scopeName`форму . Для Microsoft Graph области имеют ярлыки. Например, `User.Read` это ярлык `https://graph.microsoft.com/user.read`для .

При регистрации приложения необходимо определить следующие параметры:

- Ресурс URI
- Один или несколько областей
- Одна или несколько ролей приложений

По умолчанию портал регистрации приложений рекомендует `api://{clientId}`использовать ресурс URI. Этот URI уникален, но не читаем человеком. Если вы измените URI, убедитесь, что новое значение является уникальным.

Для клиентских приложений области отображаются как *делегированные разрешения,* а роли приложений отображаются в виде *разрешений приложений* для вашего web-API.

Области также отображаются в окне согласия, представленном пользователям приложения. Таким образом, необходимо предоставить соответствующие строки, описывающие область действия:

- Как увиденный пользователем.
- По словам админата, который может дать согласие на участие в этом вопросе.

### <a name="exposing-delegated-permissions-scopes"></a>Разоблачение делегированных разрешений (сферы)

1. Выберите **Expose API** при регистрации приложения.
1. Выберите **Добавить область**.
1. Если это вызвано, примите`api://{clientId}`предлагаемое приложение ID URI () выбрав **Сохранить и продолжить**.
1. Укажите эти значения:
    - Выберите **имя области** и введите **access_as_user**.
    - **Выберите, кто может дать согласие,** и убедитесь, что **выбраны админы и пользователи.**
    - Выберите **имя отображения согласия админа** и введите **Access TodoListService в качестве пользователя.**
    - Выберите **описание согласия админа** и введите **доступ к веб-API TodoListService в качестве пользователя.**
    - Выберите **имя отображения согласия пользователя** и введите Access **TodoListService в качестве пользователя.**
    - Выберите **описание согласия пользователя** и введите доступ к **веб-API TodoListService в качестве пользователя.**
    - Держите **значение состояния** для **включено.**
 1. Выберите **область добавления.**

### <a name="if-your-web-api-is-called-by-a-daemon-app"></a>Если ваш веб-API вызывается приложением daemon

В этом разделе вы узнаете, как зарегистрировать защищенный веб-aPI, чтобы приложения daemon могли безопасно называть его.

- Вы декларируете и разоблачаете только *разрешения приложений,* потому что приложения daemon не взаимодействуют с пользователями. Делегированные разрешения не имеют смысла.
- Админы-наниматели могут потребовать от Azure AD выпускать токены Web API только приложениям, которые зарегистрировались для доступа к одному из разрешений приложения API.

#### <a name="exposing-application-permissions-app-roles"></a>Разоблачение разрешений приложений (роли приложений)

Чтобы разоблачить разрешения приложений, необходимо отсеить манифест.

1. При регистрации заявки на подачу заявления выберите **Manifest**.
1. Чтобы отсеять `appRoles` манифест, найдите настройку и добавьте роли приложения. Определения роли приведены в следующем примере блока JSON.
1. Оставьте `allowedMemberTypes` `"Application"` только на.
1. Убедитесь, что `id` это уникальный GUID.
1. Убедитесь, что `displayName` и `value` не содержат пробелов.
1. Сохраните манифест.

Следующий пример показывает `appRoles`содержание , где `id` значение может быть любой уникальный GUID.

```json
"appRoles": [
    {
    "allowedMemberTypes": [ "Application" ],
    "description": "Accesses the TodoListService-Cert as an application.",
    "displayName": "access_as_application",
    "id": "ccf784a6-fd0c-45f2-9c08-2f9d162a0628",
    "isEnabled": true,
    "lang": null,
    "origin": "Application",
    "value": "access_as_application"
    }
],
```

#### <a name="ensuring-that-azure-ad-issues-tokens-for-your-web-api-to-only-allowed-clients"></a>Обеспечение того, чтобы AD Azure выдает токены для вашего веб-API только для разрешенных клиентов

Веб-API проверяет роль приложения. Эта роль — это способ разработчика программного обеспечения выявить разрешения приложений. Можно также настроить Azure AD для выпуска токенов API только для приложений, одобренных админом-клиентом для доступа к API.

Чтобы добавить это повышенная безопасность:

1. Перейдите на **страницу** обзора приложения для регистрации приложения.
1. В **управляемом приложении в локальном каталоге**выберите ссылку с именем приложения. Метка для этого выбора может быть усечена. Например, вы можете увидеть **Управляемое приложение в ...**

   > [!NOTE]
   >
   > При выборе этой ссылки вы перейдите на страницу **«Обзор корпоративных приложений».** Эта страница связана с принципом службы для приложения в арендаторе, где вы его создали. Вы можете перейти на страницу регистрации приложения, используя кнопку «Назад» вашего браузера.

1. Выберите страницу **«Свойства»** в разделе **«Управление»** на страницах приложения «Предприятие».
1. Если вы хотите, чтобы Azure AD разрешал доступ к веб-aPI **Yes**только определенным клиентам, **необходимо установить назначение пользователя?**

   > [!IMPORTANT]
   >
   > Если вы установите **требуемое назначение пользователя?** для того, чтобы **Да,** Azure AD проверяет назначения роли приложения клиента, когда он запрашивает ктокен доступа Web API. Если клиент не назначен каким-либо ролям приложений, Azure AD вернет сообщение об ошибке "invalid_client: AADSTS501051: \<имя\> приложения не присваивается роли для \<Web API\>".
   >
   > Если вы сохраняете **требуемое назначение пользователя?** установить **нет,** Azure AD не будет проверять назначения ролей приложения, когда клиент запрашивает токен доступа для вашего веб-API. Любой клиент daemon, то есть любой клиент, использующий поток учетных данных клиента, может получить токен доступа для API, просто указав свою аудиторию. Любое приложение может получить доступ к API без необходимости запрашивать разрешения на него.
   >
   > Но, как было уличено в предыдущем разделе, ваш веб-API всегда может убедиться, что приложение имеет правильную роль, которая санкционирована админом-арендатором. API выполняет эту проверку, подтверждая, что маркер доступа имеет претензию ролей и что значение для этой претензии является правильным. В предыдущем образце JSON `access_as_application`значение .

1. Щелкните **Сохранить**.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Конфигурация кода приложения](scenario-protected-web-api-app-configuration.md)
