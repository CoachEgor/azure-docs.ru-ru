---
title: Управление токенами (библиотека аутентификации Майкрософт) | Azure
description: Сведения о получении и кэшировании токенов с помощью библиотеки аутентификации Майкрософт (MSAL).
services: active-directory
documentationcenter: dev-center-name
author: rwike77
manager: CelesteDG
editor: ''
ms.service: active-directory
ms.subservice: develop
ms.devlang: na
ms.topic: overview
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 04/24/2019
ms.author: ryanwi
ms.reviewer: saeeda
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: 7ca011ec7185b084de6d1d346556c1c270c7aee3
ms.sourcegitcommit: f6c85922b9e70bb83879e52c2aec6307c99a0cac
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/11/2019
ms.locfileid: "65546088"
---
# <a name="acquiring-and-caching-tokens-using-msal"></a>Получение и кэширование токенов с помощью MSAL
[Маркеры доступа](access-tokens.md) позволяют клиентам безопасно вызывать веб-API, защищенные платформой Azure. Получить токен с использованием библиотеки аутентификации Майкрософт (MSAL) можно многими способами. Для некоторых способов пользователю требуется выполнить действия в веб-браузере, а для других участие пользователя не требуется. Как правило, способ получения токена зависит от того, является ли клиентское приложение общедоступным (классическим или мобильным приложением) или конфиденциальным (веб-приложением, веб-API или управляющей программой, например службой Windows).

MSAL кэширует токен после его получения.  Сначала код приложения предпринимает попытку получить токен автоматически (из кэша), прежде чем использовать для этого другие средства.

Вы также можете очистить кэш токенов, удалив из него учетные записи. Файл cookie сеанса, находящийся в браузере, не будет удален.

## <a name="scopes-when-acquiring-tokens"></a>Области при получении токенов
[Области](v2-permissions-and-consent.md) — это разрешения, предоставляемые веб-API для запроса доступа к клиентским приложениям. Клиентские приложения запрашивают согласие пользователя на эти области при отправке запросов на аутентификацию для получения токенов, предоставляющих доступ к веб-API. MSAL позволяет получить токены для доступа к Azure AD для разработчиков (версии 1.0) и API-интерфейсов платформы удостоверений Майкрософт (версии 2.0). В запросах протокола версии 2.0 вместо ресурсов используются области. Дополнительные сведения о сравнении версий 1.0 и 2.0 см. [здесь](active-directory-v2-compare.md). В зависимости от того, какую версию токенов принимает веб-API, конечная точка версии 2.0 возвращает соответствующий маркер доступа в MSAL.

Для некоторых методов получения токенов MSAL требуется параметр *scopes*. Этот параметр представляет собой простой список строк, которые объявляют нужные разрешения и запрашиваемые ресурсы. Например, в качестве областей часто используются [разрешения Microsoft Graph](/graph/permissions-reference).

В MSAL также можно получить доступ к ресурсам версии 1.0. Дополнительные сведения об областях для приложения версии 1.0 см. [здесь](msal-v1-app-scopes.md).

### <a name="request-specific-scopes-for-a-web-api"></a>Запрос конкретных областей для веб-API
Когда приложению необходимо запросить токены с определенными разрешениями для API ресурса, вам следует передать области, содержащие URI идентификатора приложения API-интерфейса, в следующем формате: *&lt;URI идентификатора приложения&gt;/&lt;область&gt;*.

Например, области для API Microsoft Graph будут выглядеть как `https://graph.microsoft.com/User.Read`,

а области для пользовательского веб-API — как `api://abscdefgh-1234-abcd-efgh-1234567890/api.read`.

Только для API Microsoft Graph значение области `user.read` соответствует формату `https://graph.microsoft.com/User.Read` и может использоваться вместо него и наоборот.

> [!NOTE]
> Некоторые веб-API, такие как API Azure Resource Manager (https://management.core.windows.net/), ожидают знак "/" в конце утверждения "Аудитория" (aud) маркера доступа. В этом случае очень важно передать область как https://management.core.windows.net//user_impersonation (обратите внимание на двойную косую черту), чтобы токен был допустимым в API.

### <a name="request-dynamic-scopes-for-incremental-consent"></a>Запрос динамических областей для добавочного согласия
При создании приложений с использованием версии 1.0 нужно было регистрировать полный набор необходимых приложению разрешений (статические области), чтобы пользователь подтвердил согласие во время входа. В версии 2.0 вы можете запрашивать дополнительные разрешения по мере необходимости, используя параметр области. Этот механизм динамических областей позволяет пользователю предоставлять добавочное согласие для областей.

Например, вы можете при входе пользователя не предоставлять ему никаких прав доступа. Позже вы сможете предоставить ему возможность чтения календаря другого пользователя, запросив область календаря через метод получения токенов, и получить согласие пользователя.

Например, `https://graph.microsoft.com/User.Read` и `https://graph.microsoft.com/Calendar.Read`.

## <a name="acquiring-tokens-silently-from-the-cache"></a>Получение токенов в автоматическом режиме (из кэша)
MSAL хранит кэш токенов (или два кэша для конфиденциальных клиентских приложений), в котором сохраняет все полученные токены.  Во многих случаях при попытке получить токен автоматически будет получен еще один токен с дополнительными областями в зависимости от токена в кэше. Также токен может автоматически обновляться, когда приближается завершение срока действия (так как кэш токенов содержит и токен обновления).

### <a name="recommended-call-pattern-for-public-client-applications"></a>Рекомендуемый шаблон вызова для общедоступных клиентских приложений
Сначала код приложения предпринимает попытку получить токен автоматически (из кэша).  Если вызов метода возвращает ошибку или исключение UI required (Требуется пользовательский интерфейс), попробуйте получить токен с помощью других средств. 

Но есть два потока, перед которыми **не следует** предпринимать попытку автоматически получить токен:

- [Поток с использованием учетных данных клиента](msal-authentication-flows.md#client-credentials), в котором используется не кэш токенов пользователей, а кэш токенов приложения. Этот метод отвечает за проверку этого кэша токенов приложения перед отправкой запроса в службу токенов безопасности.
- [Поток с использованием кода авторизации](msal-authentication-flows.md#authorization-code) в веб-приложениях, так как он активирует код, получаемый приложением при входе пользователя в систему, и содержит его согласие на дополнительные области. Так как код передается в качестве параметра, а не учетной записи, метод не может выполнять поиск в кэше до активации кода, для которой в любом случае требуется вызов к службе.

### <a name="recommended-call-pattern-in-web-apps-using-the-authorization-code-flow"></a>Рекомендуемый шаблон вызова в веб-приложениях с использованием потока кода авторизации 
Для веб-приложений, использующих [поток кода авторизации OpenID Connect](v2-protocols-oidc.md), рекомендуется следующий шаблон действий в контроллерах:

- создание экземпляра конфиденциального клиентского приложения с помощью кэша токенов с использованием настраиваемой сериализации; 
- получение токена с помощью потока кода авторизации.

## <a name="acquiring-tokens"></a>Получение токенов
Как правило, метод получения токена зависит от типа клиентского приложения (общедоступное или конфиденциальное).

### <a name="public-client-applications"></a>Общедоступные клиентские приложения
Для общедоступных клиентских приложений (классическое или мобильное приложение) справедливо следующее.
- Вы часто получаете токены в интерактивном режиме, выполняя вход пользователей с помощью пользовательского интерфейса или всплывающего окна.
- Вы можете [автоматически получить токен для вошедшего в систему пользователя](msal-authentication-flows.md#integrated-windows-authentication), используя встроенную проверку подлинности Windows (IWA/Kerberos), если классическое приложение выполняется на компьютере Windows, присоединенном к домену или Azure.
- Вы можете [получить токен с помощью имени пользователя и пароля](msal-authentication-flows.md#usernamepassword) в классических клиентских приложениях .NET Framework, но это не рекомендуется. Не используйте имя пользователя и пароль в конфиденциальных клиентских приложениях.
- Вы можете получить токен через [поток кода устройства](msal-authentication-flows.md#device-code) в приложениях, выполняемых на устройствах без веб-браузера. Пользователю предоставляется URL-адрес и код, которые он вводит в веб-браузере на другом устройстве для входа в систему.  После этого Azure AD отправляет токен обратно на устройство без браузера.

### <a name="confidential-client-applications"></a>Конфиденциальные клиентские приложения 
Для конфиденциальных клиентских приложений (веб-приложение, веб-API или управляющая программа, такая как служба Windows) вы выполняете следующее.
- Получаете токены **для самого приложения**, а не для пользователя, с использованием [потока учетных данных клиента](msal-authentication-flows.md#client-credentials). Это может использоваться для средств синхронизации или средств, которые обрабатывают пользователей в целом, а не отдельного пользователя. 
- Используете [поток On-Behalf-Of](msal-authentication-flows.md#on-behalf-of), чтобы веб-API мог вызвать API от имени пользователя. Приложение определяется с помощью учетных данных клиента для получения токена в зависимости от утверждения пользователя (например, токен SAML или JWT). Этот поток используется приложениями, которым требуется доступ к ресурсам определенного пользователя в вызовах между службами.
- Получаете токены с помощью [потока кода авторизации](msal-authentication-flows.md#authorization-code) в веб-приложениях после входа пользователя через URL-адрес запроса авторизации. Этот механизм обычно используется в приложении OpenID Connect, что позволяет пользователю входить в систему с помощью OpenID Connect, а затем получать доступ к веб-API от имени пользователя.


## <a name="authentication-results"></a>Результаты аутентификации 
Когда клиент запрашивает маркер доступа, Azure AD также возвращает результат аутентификации с метаданными о маркере доступа. Эти сведения включают срок действия маркера доступа и области, для которых он действителен. Благодаря этим данным приложение может выполнять интеллектуальное кэширование маркеров доступа, не анализируя сам маркер.  В результате аутентификации содержится следующая информация.

- [Маркер доступа](access-tokens.md) для доступа веб-API к ресурсам. Это строка, обычно JWT в кодировке Base64, но клиенту ни в каких ситуациях не нужно просматривать содержимое маркера доступа. Стабильность формата не гарантируется, и маркер может быть зашифрован для конкретного ресурса. Люди, код которых зависит от содержимого маркера доступа на стороне клиента, являются одним из основных источников ошибок и разрывов логики клиента.
- [Токен идентификации](id-tokens.md) для пользователя (это JWT).
- Срок действия токена, то есть дата и время завершения его применимости.
- Идентификатор клиента содержит сведения о клиенте, в котором был найден пользователь. Для гостевых пользователей (сценарии Azure AD B2B) используется гостевой идентификатор клиента, а не уникальный клиент. Когда токен предоставляется в имени пользователя, результат аутентификации также содержит сведения об этом пользователе. Для потоков конфиденциальных клиентов, где токены запрашиваются без пользователя (для приложения), эта информация пользователя имеет значение NULL.
- Области, для которых выдан токен.
- Уникальный идентификатор пользователя.

## <a name="next-steps"></a>Дополнительная информация
Узнайте об [обработке ошибок и исключений](msal-handling-exceptions.md). 
