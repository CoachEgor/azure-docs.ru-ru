---
title: Поток утверждений носителя SAML для платформы Microsoft Identity & | Службы
description: Узнайте, как извлечь данные из Microsoft Graph без запроса учетных данных пользователя с помощью потока утверждения носителя SAML.
services: active-directory
author: umeshbarapatre
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 08/05/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.openlocfilehash: 1cd79b1f9e4cd3afadee250da0c184c0c5b8ac07
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "80886183"
---
# <a name="microsoft-identity-platform-and-oauth-20-saml-bearer-assertion-flow"></a>Поток утверждения для платформы Microsoft Identity и OAuth 2,0 SAML
Поток утверждений носителя OAuth 2,0 SAML позволяет запросить маркер доступа OAuth с помощью утверждения SAML, когда клиенту необходимо использовать существующее отношение доверия. Подпись, применяемая к утверждению SAML, обеспечивает проверку подлинности полномочного приложения. Утверждение SAML — это маркер безопасности XML, выданный поставщиком удостоверений и используемый поставщиком услуг. Поставщик услуг использует его содержимое для идентификации субъекта утверждения в целях безопасности.

Утверждение SAML публикуется в конечной точке токена OAuth.  Конечная точка обрабатывает утверждение и выдает маркер доступа, основанный на предыдущем утверждении приложения. Клиенту не обязательно иметь или хранить маркер обновления, а также не требуется передавать секрет клиента в конечную точку маркера.

Поток утверждения носителя SAML полезен при выборке данных из Microsoft Graphных API-интерфейсов (которые поддерживают делегированные разрешения) без запроса учетных данных пользователя. В этом сценарии предоставление учетных данных клиента, предпочитаемое для фоновых процессов, не работает.

Для приложений, выполняющих интерактивный вход на основе браузера для получения утверждения SAML и последующего добавления доступа к защищенному API OAuth (например, Microsoft Graph), можно создать запрос OAuth, чтобы получить маркер доступа для API. Когда браузер перенаправляется в Azure AD для проверки подлинности пользователя, браузер выберет сеанс из входа SAML, и пользователю не нужно вводить свои учетные данные.

Поток утверждения носителя OAuth SAML также поддерживается для пользователей, проверяющих подлинность с помощью поставщиков удостоверений, например службы федерации Active Directory (AD FS) (ADFS), Федеративных для Azure Active Directory.  Утверждение SAML, полученное из ADFS, можно использовать в потоке OAuth для проверки подлинности пользователя.

![Поток OAuth](./media/v2-saml-bearer-assertion/1.png)

## <a name="call-graph-using-saml-bearer-assertion"></a>Граф вызовов, использующий утверждение носителя SAML
Теперь давайте посмотрим, как можно реально получить утверждение SAML программным способом. Этот подход тестируется с помощью ADFS. Однако это работает с любым поставщиком удостоверений, который поддерживает возврат утверждения SAML программным путем. Базовый процесс: получение утверждения SAML, получение маркера доступа и доступ к Microsoft Graph.

### <a name="prerequisites"></a>Предварительные требования

Установите отношение доверия между сервером авторизации/средой (Microsoft 365) и поставщиком удостоверений или издателем утверждения носителя SAML 2,0 (ADFS). Чтобы настроить ADFS для единого входа и как поставщика удостоверений, обратитесь к [этой статье](https://blogs.technet.microsoft.com/canitpro/2015/09/11/step-by-step-setting-up-ad-fs-and-enabling-single-sign-on-to-office-365/).

Зарегистрируйте приложение на [портале](https://ms.portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade):
1. Войдите в [колонку регистрации приложения на портале](https://ms.portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade) (Обратите внимание, что мы используем конечные точки версии 2.0 для API Graph и, следовательно, должны зарегистрировать приложение на этом портале. В противном случае мы могли бы использовать регистрации в Azure Active Directory. 
1. Выберите **Новая регистрация**.
1. После появления страницы **Регистрация приложения** введите сведения о регистрации приложения: 
    1. **Имя** — введите информативное имя приложения, которое будет отображаться пользователям приложения.
    1. **Поддерживаемые типы учетных записей** — выберите учетные записи, которые должно поддерживать приложение.
    1. **URI перенаправления (необязательно)** . Выберите тип приложения, которое вы создаете, веб-клиент или общедоступного клиента (мобильный & Desktop), а затем введите URI перенаправления (или URL-адрес ответа) для приложения.
    1. По завершении щелкните **Зарегистрировать**.
1. Запишите идентификатор приложения (клиента).
1. В левой области выберите **сертификаты & секреты**. Щелкните **новый секрет клиента** в разделе **секреты клиента** . Скопируйте новый секрет клиента, и вы не сможете получить его после выхода из колонки.
1. В левой области выберите **разрешения API** , а затем **добавьте разрешение**. Выберите **Microsoft Graph**, а затем **делегированные разрешения**, а затем выберите **tasks. Read** , так как мы планируем использовать API Graph Outlook. 

Установите программу [POST](https://www.getpostman.com/), необходимую для тестирования примеров запросов.  Позже можно преобразовать запросы в код.

### <a name="get-the-saml-assertion-from-adfs"></a>Получение утверждения SAML из ADFS
Создайте запрос POST к конечной точке ADFS с помощью конверта SOAP, чтобы получить утверждение SAML:

![Получение утверждения SAML](./media/v2-saml-bearer-assertion/2.png)

Значения заголовка:

![Значения заголовка](./media/v2-saml-bearer-assertion/3.png)

Текст запроса ADFS:

![Текст запроса ADFS](./media/v2-saml-bearer-assertion/4.png)

После успешной отправки запроса вы должны получить утверждение SAML из ADFS. Требуются только данные тега **SAML: assertion** , преобразуйте их в кодировку Base64, чтобы использовать их в дальнейших запросах.

### <a name="get-the-oauth2-token-using-the-saml-assertion"></a>Получение токена OAuth2 с помощью утверждения SAML 
На этом шаге вы получите токен OAuth2 с помощью ответа на утверждение ADFS.

1. Создайте запрос POST, как показано ниже, со значениями заголовка:

    ![запрос POST](./media/v2-saml-bearer-assertion/5.png)
1. В тексте запроса замените **client_id**, **client_secret**и **Assert** (утверждение SAML в кодировке Base64, полученное на предыдущем шаге):

    ![Тело запроса](./media/v2-saml-bearer-assertion/6.png)
1. После успешного выполнения запроса вы получите маркер доступа из Azure Active Directory.

### <a name="get-the-data-with-the-oauth-token"></a>Получение данных с помощью токена OAuth

После получения маркера доступа вызовите API Graph (задачи Outlook в этом примере). 

1. Создайте запрос GET с маркером доступа, полученным на предыдущем шаге:

    ![Запрос GET](./media/v2-saml-bearer-assertion/7.png)

1. После успешного выполнения запроса вы получите ответ JSON.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте о различных [потоках проверки подлинности и сценариях приложений](authentication-flows-app-scenarios.md).