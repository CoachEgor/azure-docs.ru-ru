---
title: Платформа удостоверений Майкрософт и поток утверждения носителя SAML | Azure
description: Узнайте, как извлечь данные из Microsoft Graph без запроса учетных данных у пользователя с помощью потока утверждения носителя SAML.
services: active-directory
author: kenwith
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 08/05/2019
ms.author: kenwith
ms.reviewer: paulgarn
ms.openlocfilehash: 6e7e4dd6383b1f264ff2da7893d9f86a3708217d
ms.sourcegitcommit: d68c72e120bdd610bb6304dad503d3ea89a1f0f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/01/2020
ms.locfileid: "89227922"
---
# <a name="microsoft-identity-platform-and-oauth-20-saml-bearer-assertion-flow"></a>Платформа удостоверений Майкрософт и поток утверждения носителя OAuth 2.0 SAML
Поток утверждения носителя OAuth 2.0 SAML позволяет запросить маркер доступа OAuth с помощью утверждения SAML, когда клиенту необходимо использовать существующее отношение доверия. Подпись, применяемая к утверждению SAML, обеспечивает проверку подлинности авторизованного приложения. Утверждение SAML — это маркер безопасности XML, выданный поставщиком удостоверений и используемый поставщиком услуг. Поставщик услуг использует его содержимое для идентификации субъекта утверждения в целях безопасности.

Утверждение SAML публикуется в конечной точке токена OAuth.  Конечная точка обрабатывает утверждение и выдает маркер доступа, основанный на предыдущем утверждении приложения. Клиенту необязательно иметь или хранить маркер обновления, а также не требуется передавать секрет клиента в конечную точку маркера.

Поток утверждения носителя SAML удобно использовать при получении данных из API Microsoft Graph (которые поддерживают только делегированные разрешения) без запроса учетных данных пользователя. В этом сценарии предоставление учетных данных клиента, предпочитаемое для фоновых процессов, не работает.

Для приложений, выполняющих интерактивный вход на основе браузера для получения утверждения SAML и последующего добавления доступа к защищенному API OAuth (например, Microsoft Graph), можно создать запрос OAuth, чтобы получить маркер доступа для API. Когда браузер перенаправляется в Azure AD для проверки подлинности пользователя, браузер принимает сеанс из входа SAML, и пользователю не нужно вводить свои учетные данные.

Поток утверждений носителя OAuth SAML поддерживается только для пользователей, прошедших проверку подлинности с помощью поставщиков удостоверений, например службы федерации Active Directory (AD FS) (ADFS), Федеративных для Azure Active Directory.  Утверждение SAML, полученное от ADFS, можно использовать в потоке OAuth для проверки подлинности пользователя.

![Поток OAuth](./media/v2-saml-bearer-assertion/1.png)

## <a name="call-graph-using-saml-bearer-assertion"></a>Граф вызовов, использующий утверждение носителя SAML
Теперь давайте узнаем, как можно получить утверждение SAML программным способом. Этот подход тестируется с помощью ADFS. Однако он работает с любым поставщиком удостоверений, который поддерживает возврат утверждения SAML программным путем. В общих чертах процесс выглядит следующим образом: получение утверждения SAML, получение маркера доступа и доступ к Microsoft Graph.

### <a name="prerequisites"></a>Предварительные требования

Установите отношение доверия между сервером авторизации/средой (Microsoft 365) и поставщиком удостоверений или издателем утверждения носителя SAML 2.0 (ADFS). Чтобы настроить ADFS для единого входа и в качестве поставщика удостоверений, см. [эту статью](/archive/blogs/canitpro/step-by-step-setting-up-ad-fs-and-enabling-single-sign-on-to-office-365).

Зарегистрируйте приложение на [портале](https://ms.portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade):
1. Войдите в [колонку регистрации приложения на портале](https://ms.portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade) (обратите внимание, что для API Graph используются конечные точки версии 2.0 и, следовательно, необходимо зарегистрировать приложение на портале. В противном случае мы могли бы использовать регистрации в Azure Active Directory). 
1. Выберите **Новая регистрация**.
1. После появления страницы **Регистрация приложения** введите сведения о регистрации приложения: 
    1. **Имя** — введите информативное имя приложения, которое будет отображаться пользователям приложения.
    1. **Поддерживаемые типы учетных записей** — выберите учетные записи, которые должно поддерживать приложение.
    1. **URI перенаправления (необязательно)** — выберите тип приложения, которое вы создаете — веб или общедоступный клиент (для мобильных и классических приложений), а затем введите URI перенаправления (или URL-адрес ответа) приложения.
    1. По завершении щелкните **Зарегистрировать**.
1. Запишите значение идентификатора приложения (клиента).
1. В области слева щелкните **Сертификаты и секреты**. В разделе **Секреты клиента** выберите **Новый секрет клиента**. Скопируйте новый секрет клиента — вы не сможете получить его после выхода из колонки.
1. В области слева выберите **Разрешения API**, а затем — **Добавить разрешение**. Нажмите **Microsoft Graph** и **Делегированные разрешения**, а затем выберите **Tasks.read**, так как мы планируем использовать API Graph Outlook. 

Установите [Postman](https://www.getpostman.com/) — средство, необходимое для тестирования примеров запросов.  Позже можно преобразовать запросы в код.

### <a name="get-the-saml-assertion-from-adfs"></a>Получение утверждения SAML из ADFS
Создайте запрос POST к конечной точке ADFS с помощью конверта SOAP, чтобы получить утверждение SAML:

![Получение утверждения SAML](./media/v2-saml-bearer-assertion/2.png)

Значения заголовка:

![Значения заголовка](./media/v2-saml-bearer-assertion/3.png)

Текст запроса ADFS:

![Текст запроса ADFS](./media/v2-saml-bearer-assertion/4.png)

После успешной отправки запроса вы должны получить утверждение SAML из ADFS. Требуются только данные тега **SAML:Assertion**. Преобразуйте их в кодировку Base64, чтобы использовать в дальнейших запросах.

### <a name="get-the-oauth2-token-using-the-saml-assertion"></a>Получение токена OAuth2 с помощью утверждения SAML 
На этом шаге вы получите токен OAuth2 с помощью ответа на утверждение ADFS.

1. Создайте запрос POST, как показано ниже, со значениями заголовка:

    ![Запрос POST](./media/v2-saml-bearer-assertion/5.png)
1. В тексте запроса замените **client_id**, **client_secret** и **assertion** (утверждение SAML в кодировке Base64, полученное на предыдущем шаге):

    ![Тело запроса](./media/v2-saml-bearer-assertion/6.png)
1. После успешного выполнения запроса вы получите маркер доступа из Azure Active Directory.

### <a name="get-the-data-with-the-oauth-token"></a>Получение данных с помощью маркера OAuth

После получения маркера доступа вызовите API Graph (задачи Outlook в этом примере). 

1. Создайте запрос GET с маркером доступа, полученным на предыдущем шаге:

    ![Запрос GET](./media/v2-saml-bearer-assertion/7.png)

1. После успешного выполнения запроса вы получите ответ JSON.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте больше о разных [потоках проверки подлинности и сценариях приложений](authentication-flows-app-scenarios.md).
