---
title: Почему обновления к платформе Microsoft identity (версии 2.0) | Azure
description: Понимать различия между конечной точкой платформы (версии 2.0) удостоверений Майкрософт и конечная точка Azure Active Directory (Azure AD) версии 1.0 и узнайте о преимуществах обновления до версии 2.0.
services: active-directory
documentationcenter: ''
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 05/07/2019
ms.author: ryanwi
ms.reviewer: saeeda, hirsin, jmprieur, sureshja, jesakowi, lenalepa, kkrishna, negoe
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: 1ccac719c78ce2844a8dd37a80445e11baa4a488
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "65962879"
---
# <a name="why-update-to-microsoft-identity-platform-v20"></a>Почему обновления к платформе Microsoft identity (версии 2.0)?

При разработке нового приложения, важно понимать различия между платформой удостоверений Microsoft (версии 2.0) и конечные точки Azure Active Directory (версия 1.0). В этой статье рассматриваются основные различия между конечными точками и некоторые существующие ограничения для платформы Microsoft identity.

> [!NOTE]
> Конечная точка платформы удостоверений Microsoft не поддерживает все сценарии Azure AD и компоненты. Чтобы определить, если необходимо использовать конечную точку платформы Microsoft identity, ознакомьтесь [ограничения платформы удостоверений Microsoft](#limitations).

## <a name="who-can-sign-in"></a>Каким учетным записям разрешен вход

![Кто может входить в систему с помощью конечных точек версии 1.0 и версии 2.0](media/azure-ad-endpoint-comparison/who-can-sign-in.svg)

* Конечная точка версии 1.0 позволяет входить в приложение (Azure AD) только с рабочими и учебными учетными записями.
* Конечная точка платформы удостоверений Microsoft позволяет рабочих и учебных учетных записей из Azure AD и личных учетных записей Майкрософт (MSA), например hotmail.com, outlook.com и msn.com, выполнить вход.
* Обе конечные точки также принимать операции входа из *[гостевых пользователей](https://docs.microsoft.com/azure/active-directory/b2b/what-is-b2b)* каталога Azure AD для приложения, настроенные как *[одним клиентом](single-and-multi-tenant-apps.md)* или для *мультитенантной* приложения, настроенные для конкретного клиента конечную точку (`https://login.microsoftonline.com/{TenantId_or_Name}`).

Конечная точка платформы удостоверений Microsoft позволяет создавать приложения, поддерживающие вход с личной учетной записи Майкрософт, а также рабочих и учебных учетных записей. Это дает возможность создавать приложения, абсолютно не зависящие от типа учетной записи. Например, если приложение вызывает [Microsoft Graph](https://graph.microsoft.io), пользователям с рабочими учетными записями будут доступны некоторые дополнительные функции и данные, такие как сайты SharePoint или данные каталога. Но для многих действий, таких как [чтение почты пользователя](https://developer.microsoft.com/graph/docs/api-reference/v1.0/api/user_list_messages), тот же код сможет получить доступ к электронной почте как для личных, так и для рабочих и учебных учетных записей.

Для конечной точки платформы удостоверений Microsoft можно использовать библиотеки аутентификации Майкрософт (MSAL) для получения доступа к объекту-получателю, образовательных и enterprise миров. Конечная точка Azure AD версии 1.0 принимает вход только с рабочими и учебными учетными записями.

## <a name="incremental-and-dynamic-consent"></a>Добавочное и динамическое согласие

В приложениях, где используется конечная точка Azure AD версии 1.0, необходимо указывать необходимые разрешения OAuth 2.0 заранее, например:

![Пользовательский интерфейс регистрации разрешений](./media/azure-ad-endpoint-comparison/app_reg_permissions.png)

Разрешения, задаваемые непосредственно при регистрации приложения, являются **статическими**. Статические разрешения для приложения, заданные на портале Azure, позволяют упростить код, но при этом представляют определенные потенциальные сложности для разработчиков:

* Приложение должно запрашивать все разрешения, которые когда-либо могут потребоваться, при первом входе пользователя в систему. В результате список разрешений может получиться таким длинным, что это отобьет у пользователей желание разрешить приложению доступ при первом входе.

* Приложению заранее должны быть известны все ресурсы, к которым оно когда-либо обратится. Было трудно создавать приложения, использующие произвольное количество ресурсов.

С конечной точкой платформы удостоверений Microsoft можно игнорировать статический разрешения, определенные в сведениях о регистрации приложения в Azure портала и запрос разрешения постепенно вместо этого это означает, запрашиваются только минимальный набор заранее разрешения и растет дополнительные по мере того как клиент использует функции дополнительных приложений. Для этого можно указать области, необходимые приложению в любое время, включив новые области в параметр `scope` при запросе маркера доступа — без необходимости предварительно определять их в регистрационных данных приложения. Если пользователь еще не предоставил согласие на новые области, добавленные в запрос, ему будет предложено принять только новые разрешения. Дополнительные сведения об областях, разрешениях и предоставлении согласия см. [здесь](v2-permissions-and-consent.md).

Возможность приложения динамически запрашивать разрешения с помощью параметра `scope` дает разработчикам полный контроль над взаимодействием с пользователями. Вы также можете предварительно загрузить страницу согласия и запросить все разрешения в едином первоначальном запросе авторизации. Если приложению требуется множество разрешений, вы можете запрашивать их у пользователей постепенно, по мере применения определенных функций приложения.

Для согласия администратора от имени организации по-прежнему используются статические разрешения, зарегистрированные для приложения. Поэтому следует задавать такие разрешения для приложений на портале регистрации приложения, если нужно, чтобы администратор давал согласие от имени всей организации. Это позволяет сократить циклические действия, необходимые администратору организации для настройки приложения.

## <a name="scopes-not-resources"></a>Области, а не ресурсы

Приложение, в котором используется конечная точка версии 1.0, может вести себя как **ресурс** или получатель маркеров. Ресурс может определить несколько **областей** или **разрешений oAuth2**, которые он распознает, позволяя клиентским приложениям запрашивать маркеры у этого ресурса для определенного набора областей. Рассмотрим API Azure AD Graph в качестве примера ресурса.

* Идентификатор ресурса или `AppID URI`: `https://graph.windows.net/`
* Области или `oAuth2Permissions`: `Directory.Read`, `Directory.Write` и т. д.

Это справедливо и для конечной точки платформы Microsoft identity. Приложение по-прежнему может вести себя как ресурс, определять области и идентифицироваться по универсальному коду ресурса (URI). Клиентские приложения по-прежнему могут запрашивать доступ к этим областям. Тем не менее были изменены так, что клиент запрашивает эти разрешения.

Для конечной точки версии 1.0 запрос авторизации OAuth 2.0 в Azure AD выглядел так:

```text
GET https://login.microsoftonline.com/common/oauth2/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e
&resource=https://graph.windows.net/
...
```

Здесь параметр **resource** указывает, к какому ресурсу запрашивает авторизацию клиентское приложение. Служба Azure AD определяла разрешения, необходимые приложению, на основе статической конфигурации на портале Azure и выдавала маркеры соответствующим образом.

Для приложений, использующих endpoint платформы удостоверений Microsoft в том же OAuth 2.0 авторизовать запрос выглядит:

```text
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e
&scope=https://graph.windows.net/directory.read%20https://graph.windows.net/directory.write
...
```

Здесь параметр **scope** указывает, для каких ресурсов и разрешений приложение запрашивает авторизацию. Нужный ресурс по-прежнему присутствует в запросе — он указан в каждом значении параметра области. Используя параметр области таким образом позволяет конечной точке платформы Microsoft identity и большего соответствия спецификации OAuth 2.0 и более точно соответствует отраслевых стандартов. Он также позволяет приложениям выполнять [добавочное согласие](#incremental-and-dynamic-consent) — только запрашивать разрешения, когда приложению требуется их отличие от поставлены во главу угла.

## <a name="well-known-scopes"></a>Хорошо известные области

### <a name="offline-access"></a>Автономный доступ

Приложения с помощью конечной точки платформы удостоверений Microsoft могут потребоваться новые хорошо известные разрешения для приложений - `offline_access` области. Всем приложения требуется запросить это разрешение, если им необходимо доступ к ресурсам от имени пользователя в течение длительного времени, даже если пользователь не работает с приложением активно. Область `offline_access` отображается в диалоговых окнах запроса согласия как разрешение **Доступ к вашим данным в любое время**, которое пользователь должен принять. Запрос `offline_access` разрешение позволит веб-приложения получать маркеры обновления OAuth 2.0 от конечной точки платформы удостоверений Microsoft. У маркеров обновления длительный срок действия, и их можно заменить на новые маркеры доступа OAuth 2.0 на значительные периоды доступа.

Если приложение не запрашивает `offline_access` области, он не получит маркеры обновления. Это значит, что при использовании кода авторизации в потоке кода авторизации OAuth 2.0 вы получите только маркер доступа из конечной точки `/token`. Этот маркер доступа будет действителен в течение короткого времени (обычно одного часа), но в конечном итоге срок его действия истечет. В этот момент приложению будет необходимо перенаправить пользователя обратно в конечную точку `/authorize`, чтобы получить новый код авторизации. При этом пользователю может потребоваться повторно ввести учетные данные или повторно предоставить разрешения в зависимости от типа приложения.

Дополнительные сведения об OAuth 2.0, `refresh_tokens`, и `access_tokens`, ознакомьтесь с [по протоколу платформы удостоверений Microsoft](active-directory-v2-protocols.md).

### <a name="openid-profile-and-email"></a>OpenID, профиль и электронная почта

Исторически сложилось так, что наиболее простой OpenID Connect входа в поток с платформой Microsoft identity содержит массу информации о пользователе в результирующем *id_token*. Утверждения в id_token могут содержать имя пользователя, предпочтительное имя пользователя, адрес электронной почты, идентификатор объекта и другие сведения.

Сейчас сведения, доступные вашему приложению с помощью области `openid`, ограничены. Теперь область `openid` позволит пользователю только войти в приложение и получить соответствующий идентификатор. Чтобы получить личные сведения о пользователе в приложении, приложение должно запросить у пользователя дополнительные разрешения. Чтобы запросить дополнительные разрешения, используйте две новые области — `email` и `profile`.

* С помощью области `email` приложение получает доступ к основному адресу электронной почты пользователя через утверждение `email` в маркере id_token, при условии что у пользователя есть адресуемый адрес электронной почты.
* `profile` Область позволяет вашему приложению доступ к другие основные сведения о пользователе, например свое имя, предпочтительное имя пользователя объекта, идентификатор и т. д., в id_token.

Эти области позволяют создать код приложения с минимальным разглашением сведений, поэтому вы можете запросить у пользователя только те сведения, которые нужны приложению для выполнения задания. Дополнительные сведения об этих областях см. в разделе [ссылки область платформы удостоверений Microsoft](v2-permissions-and-consent.md).

## <a name="token-claims"></a>Утверждения маркера

Конечная точка платформы удостоверений Microsoft выдает меньший набор утверждений в маркеры, по умолчанию, чтобы сохранить небольшой полезных данных. Если у вас есть приложения и службы, которые зависят от конкретного утверждения в маркер версии 1.0, который больше не предоставляется по умолчанию в токене платформы Microsoft identity, рассмотрите возможность использования [необязательные утверждения](active-directory-optional-claims.md) функция для включения этого утверждения.

## <a name="limitations"></a>Ограничения

Существует несколько ограничений, которые следует учитывать при использовании платформы Microsoft identity.

При создании приложений, которые интегрируются с платформой Microsoft identity, необходимо решить, соответствуют ли Microsoft identity платформы конечной точки и протоколы проверки подлинности вашим потребностям. Конечная точка версии 1.0 и платформа по-прежнему полностью поддерживается и в некоторых отношениях является более функциональной, чем платформой Microsoft identity. Тем не менее платформой Microsoft identity [представляет значительные преимущества](azure-ad-endpoint-comparison.md) для разработчиков.

Ниже приведен упрощенный рекомендации для разработчиков теперь.

* Если вы желаете или вам требуется поддержка личных учетных записей Майкрософт в приложении, или вы создаете новое приложение, используйте платформой Microsoft identity. Но перед этим убедитесь, что вы понимаете ограничения, описанные в этой статье.
* Если миграция или обновление приложения, использующие SAML, нельзя использовать платформой Microsoft identity. Вместо этого обратитесь к [руководство по Azure AD версии 1.0](v1-overview.md).

Чтобы устранить эти ограничения, таким образом, чтобы только необходимый для использования конечной точки платформы удостоверений Microsoft будет развиваться конечной точкой платформа удостоверений Майкрософт. В то же время воспользуйтесь этой статьей, чтобы определить, подходит ли вам конечная точка платформы Microsoft identity. Мы продолжим обновлять эту статью, чтобы отразить текущее состояние конечной точки платформы Microsoft identity. Проверьте, чтобы повторно оценить свои требования и версии возможности платформы Microsoft identity.

### <a name="restrictions-on-app-registrations"></a>Ограничения регистрации приложений

Для каждого приложения, которое вы хотите интегрировать с конечной точкой платформы Microsoft identity, можно создать регистрацию приложения в новом [ **регистрация приложений** возникнуть](https://aka.ms/appregistrations) на портале Azure. Существующие приложения учетной записи Майкрософт не совместимы с помощью портала, но они все приложения Azure AD, независимо от того, где и когда они были зарегистрированы.

Регистрация приложений, поддерживающих рабочие, учебные и личные учетные записи, имеет такие особенности:

* Для идентификатора приложения можно использовать только два секрета приложения.
* Приложением, не зарегистрированным в клиенте, можно управлять только через учетную запись, в которой оно зарегистрировано. Невозможно предоставить совместный доступ к нему другим разработчикам. Это справедливо для большинства приложений, зарегистрированных с личной учетной записью Майкрософт на портале регистрации приложений. Если вы хотите совместно использовать регистрацию приложения с несколькими разработчиками, зарегистрировать приложение в клиенте с помощью нового **регистрация приложений** раздела на портале Azure.
* К формату URL-адреса перенаправления применяется несколько ограничений. Дополнительные сведения об URL-адресе перенаправления см. в следующем разделе.

### <a name="restrictions-on-redirect-urls"></a>Ограничения для URL-адресов перенаправления

Приложения, зарегистрированные для платформы Microsoft identity, ограничены определенным набором значений URL-адрес перенаправления. URL-адрес перенаправления для веб-приложений и служб должен начинаться со схемы `https`, и во всех его значениях должен использоваться один домен DNS.  Система регистрации сравнивает полное DNS-имя существующего URL-адреса перенаправления и DNS-имя добавляемого URL-адреса перенаправления. `http://localhost` также поддерживается в качестве URL-адреса перенаправления.  

Запрос на добавление DNS-имени завершится ошибкой при выполнении любого из следующих условий.  

* Если полное DNS-имя нового URL-адреса перенаправления не соответствует DNS-имени существующего URL-адреса перенаправления.
* Если полное DNS-имя нового URL-адреса перенаправления не является поддоменом существующего URL-адреса перенаправления.

#### <a name="example-1"></a>Пример 1

Если в приложении используется URL-адрес перенаправления `https://login.contoso.com`, можно добавить URL-адрес перенаправления с полностью совпадающим DNS-именем, как показано в примере ниже.

`https://login.contoso.com/new`

Или же можно использовать ссылку на поддомен DNS login.contoso.com, как показано в примере ниже.

`https://new.login.contoso.com`

#### <a name="example-2"></a>Пример 2

Если вы хотите, чтобы в приложении использовались URL-адреса перенаправления `login-east.contoso.com` и `login-west.contoso.com`, добавьте их в таком порядке:

`https://contoso.com`  
`https://login-east.contoso.com`  
`https://login-west.contoso.com`  

Так как они являются поддоменами первого URL-адрес перенаправления, можно добавить два contoso.com.

У вас есть только 20 URL-адреса ответа для конкретного приложения — это ограничение применяется для всех типов приложений, что регистрация поддерживает (одностраничное приложение (SPA), собственный клиент, веб-приложения и службы).  

Чтобы узнать, как зарегистрировать приложение для использования с платформой Microsoft identity, см. в разделе [зарегистрировать приложение с помощью нового интерфейса регистрации приложения](quickstart-register-app.md).

### <a name="restrictions-on-libraries-and-sdks"></a>Ограничения для библиотек и пакетов SDK

В настоящее время поддержка библиотек для конечной точки платформы Microsoft identity ограничено. Если вы хотите использовать конечную точку платформы Microsoft identity в рабочем приложении, доступны следующие варианты:

* Если вы создаете веб-приложения, можно безопасно использовать общедоступную по промежуточного слоя на стороне сервера для входа в систему и проверки маркеров. В нее входит ПО промежуточного слоя OWIN OpenID Connect для ASP.NET и подключаемый модуль NodeJS Passport. Примеры кода с использованием по промежуточного слоя Майкрософт, см. в разделе [платформы удостоверений Microsoft Приступая к работе](v2-overview.md#getting-started) раздел.
* При создании классического или мобильного приложения, можно использовать один из библиотеки аутентификации Майкрософт (MSAL). Эти библиотеки являются общедоступными или в предварительной версии с поддержкой рабочей среды это безопасно использовать их в рабочих приложениях. Дополнительные сведения об условиях предварительной версии и доступных библиотеках см. в статье [Библиотеки проверки подлинности Azure Active Directory версии 2.0](reference-v2-libraries.md).
* Для платформ, не поддерживаемых библиотеками Майкрософт можно интегрировать с конечной точкой платформы Microsoft identity, непосредственно отправляя и принимая сообщения протокола в коде приложения. Протоколы OpenID Connect и OAuth [мы добавили детальную](active-directory-v2-protocols.md) помогут вам выполнить такую интеграцию.
* И, наконец можно использовать библиотеки с открытым исходным кодом OpenID Connect и OAuth для интеграции с конечной точкой платформы Microsoft identity. Конечная точка платформы удостоверений Microsoft должен быть совместим со многими другими библиотеками протоколов открытым исходным кодом без изменений. Наличие этих библиотек зависит от языка и платформы. На веб-сайтах [OpenID Connect](https://openid.net/connect/) и [OAuth 2.0](https://oauth.net/2/) можно ознакомиться со списком популярных реализаций. Дополнительные сведения см. в разделе [Microsoft identity платформы и библиотеки аутентификации](reference-v2-libraries.md)и список клиентские библиотеки с открытым кодом и примеры, проверенные с конечной точкой платформы Microsoft identity.
* Справочник по `.well-known` конечной точкой для Microsoft identity платформы общая конечная точка является `https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration`. Замените `common` идентификатором вашего клиента, чтобы получить данные, относящиеся к вашему клиенту.  

### <a name="protocol-changes"></a>Изменения протокола

Конечная точка платформы удостоверений Microsoft не поддерживает SAML или WS-Federation; он поддерживает только OpenID Connect и OAuth 2.0.  К существенным отличиям протоколов OAuth 2.0 по сравнению с конечной точкой версии 1.0 относятся: 

* Утверждение `email` возвращается, если настроено необязательное утверждение **или** в запросе указано scope=email. 
* Вместо параметра `resource` теперь поддерживается параметр `scope`.  
* Многие отклики изменены для большего соответствия спецификации OAuth 2.0, например, `expires_in` возвращается в виде целого числа, а не строки.  

Чтобы лучше понять область действия функций протоколов, поддерживаемых в конечной платформы удостоверений Microsoft, см. в разделе [по протоколу OpenID Connect и OAuth 2.0](active-directory-v2-protocols.md).

#### <a name="saml-restrictions"></a>Ограничения SAML

Если вы использовали библиотеки аутентификации Active Directory (ADAL) в приложениях Windows, вы может воспользоваться преимуществом Windows встроенной проверки подлинности, которая использует предоставление утверждения Security Assertion Markup Language (SAML). С его помощью пользователи федеративных клиентов Azure AD могут проходить аутентификацию в локальном экземпляре Active Directory автоматически, без необходимости ввода учетных данных. Предоставление утверждения SAML не поддерживается в конечной точке платформы Microsoft identity.
