---
title: Причины обновления платформы Microsoft Identity Platform (версия 2.0) | Службы
description: Сведения о различиях между конечной точкой платформы Microsoft Identity Platform (v 2.0) и конечной точкой Azure Active Directory (Azure AD) версии 1.0 и преимуществами обновления до версии 2.0.
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 11/26/2019
ms.author: ryanwi
ms.reviewer: saeeda, hirsin, jmprieur, sureshja, jesakowi, lenalepa, kkrishna, negoe
ms.custom: aaddev
ms.openlocfilehash: ed48625e4654ac6b8bdaeed713b476ab23d29f97
ms.sourcegitcommit: af6847f555841e838f245ff92c38ae512261426a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2020
ms.locfileid: "76697988"
---
# <a name="why-update-to-microsoft-identity-platform-v20"></a>Зачем обновлять платформу Microsoft Identity Platform (v 2.0)?

При разработке нового приложения важно помнить о различиях между конечными точками платформы Microsoft Identity Platform (v 2.0) и Azure Active Directory (v 1.0). В этой статье рассматриваются основные различия между конечными точками и некоторыми существующими ограничениями для платформы Microsoft Identity.

> [!NOTE]
> Конечная точка платформы Microsoft Identity не поддерживает все сценарии и функции Azure AD. Чтобы определить, следует ли использовать конечную точку платформы идентификации Майкрософт, ознакомьтесь с [ограничениями платформы удостоверений Майкрософт](#limitations).

## <a name="who-can-sign-in"></a>Каким учетным записям разрешен вход

![Кто может входить в систему с помощью конечных точек версии 1.0 и версии 2.0](media/azure-ad-endpoint-comparison/who-can-sign-in.svg)

* Конечная точка версии 1.0 позволяет входить в приложение (Azure AD) только с рабочими и учебными учетными записями.
* Конечная точка платформы Microsoft Identity позволяет выполнять вход с помощью рабочих и учебных учетных записей Azure AD и персональных учетных записей Майкрософт (MSA), таких как hotmail.com, outlook.com и msn.com.
* Обе конечные точки также принимают вход *[гостевых пользователей](https://docs.microsoft.com/azure/active-directory/b2b/what-is-b2b)* каталога Azure AD для приложений, настроенных в качестве *[одного клиента](single-and-multi-tenant-apps.md)* , или для приложений с *несколькими клиентами* , настроенных для указания на конечную точку конкретного клиента (`https://login.microsoftonline.com/{TenantId_or_Name}`).

Конечная точка платформы Microsoft Identity позволяет создавать приложения, принимающие операции входа из личных учетных записей Майкрософт, а также рабочие и учебные учетные записи. Это дает возможность создавать приложения, абсолютно не зависящие от типа учетной записи. Например, если приложение вызывает [Microsoft Graph](https://graph.microsoft.io), пользователям с рабочими учетными записями будут доступны некоторые дополнительные функции и данные, такие как сайты SharePoint или данные каталога. Но для многих действий, таких как [чтение почты пользователя](https://developer.microsoft.com/graph/docs/api-reference/v1.0/api/user_list_messages), тот же код сможет получить доступ к электронной почте как для личных, так и для рабочих и учебных учетных записей.

Для конечных точек платформы идентификации Майкрософт можно использовать библиотеку проверки подлинности Майкрософт (MSAL), чтобы получить доступ к потребителям, образовательных и корпоративным мировым уровням. Конечная точка Azure AD версии 1.0 принимает вход только с рабочими и учебными учетными записями.

## <a name="incremental-and-dynamic-consent"></a>Добавочное и динамическое согласие

В приложениях, где используется конечная точка Azure AD версии 1.0, необходимо указывать необходимые разрешения OAuth 2.0 заранее, например:

![Пример, демонстрирующий пользовательский интерфейс регистрации разрешений](./media/azure-ad-endpoint-comparison/app_reg_permissions.png)

Разрешения, задаваемые непосредственно при регистрации приложения, являются **статическими**. Статические разрешения для приложения, заданные на портале Azure, позволяют упростить код, но при этом представляют определенные потенциальные сложности для разработчиков:

* Приложение должно запрашивать все разрешения, которые когда-либо могут потребоваться, при первом входе пользователя в систему. В результате список разрешений может получиться таким длинным, что это отобьет у пользователей желание разрешить приложению доступ при первом входе.

* Приложению заранее должны быть известны все ресурсы, к которым оно когда-либо обратится. Было трудно создавать приложения, использующие произвольное количество ресурсов.

С помощью конечной точки платформы идентификации Майкрософт можно игнорировать статические разрешения, определенные в сведениях о регистрации приложения, в портал Azure и потребовать добавочного запроса разрешений. Это означает, что заранее запрашивается минимальный набор разрешений. и по мере роста времени, когда клиент использует дополнительные функции приложения. Для этого можно указать области, необходимые приложению в любое время, включив новые области в параметр `scope` при запросе маркера доступа — без необходимости предварительно определять их в регистрационных данных приложения. Если пользователь еще не предоставил согласие на новые области, добавленные в запрос, ему будет предложено принять только новые разрешения. Дополнительные сведения об областях, разрешениях и предоставлении согласия см. [здесь](v2-permissions-and-consent.md).

Возможность приложения динамически запрашивать разрешения с помощью параметра `scope` дает разработчикам полный контроль над взаимодействием с пользователями. Вы также можете предварительно загрузить страницу согласия и запросить все разрешения в едином первоначальном запросе авторизации. Если приложению требуется множество разрешений, вы можете запрашивать их у пользователей постепенно, по мере применения определенных функций приложения.

Для согласия администратора от имени организации по-прежнему используются статические разрешения, зарегистрированные для приложения. Поэтому следует задавать такие разрешения для приложений на портале регистрации приложения, если нужно, чтобы администратор давал согласие от имени всей организации. Это позволяет сократить циклические действия, необходимые администратору организации для настройки приложения.

## <a name="scopes-not-resources"></a>Области, а не ресурсы

Приложение, в котором используется конечная точка версии 1.0, может вести себя как **ресурс** или получатель маркеров. Ресурс может определить несколько **областей** или **разрешений oAuth2**, которые он распознает, позволяя клиентским приложениям запрашивать маркеры у этого ресурса для определенного набора областей. Рассмотрим Microsoft Graph API в качестве примера ресурса:

* Идентификатор ресурса или `AppID URI`: `https://graph.microsoft.com/`
* Области или `oAuth2Permissions`: `Directory.Read`, `Directory.Write` и т. д.

Это справедливо для конечной точки платформы Microsoft Identity. Приложение по-прежнему может вести себя как ресурс, определять области и идентифицироваться по универсальному коду ресурса (URI). Клиентские приложения по-прежнему могут запрашивать доступ к этим областям. Однако способ, которым клиент запрашивает эти разрешения, изменился.

Для конечной точки версии 1.0 запрос авторизации OAuth 2.0 в Azure AD выглядел так:

```text
GET https://login.microsoftonline.com/common/oauth2/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e
&resource=https://graph.windows.net/
...
```

Здесь параметр **resource** указывает, к какому ресурсу запрашивает авторизацию клиентское приложение. Служба Azure AD определяла разрешения, необходимые приложению, на основе статической конфигурации на портале Azure и выдавала маркеры соответствующим образом.

Для приложений, использующих конечную точку платформы идентификации Майкрософт, один и тот же запрос авторизации OAuth 2,0 выглядит следующим образом:

```text
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e
&scope=https://graph.windows.net/directory.read%20https://graph.windows.net/directory.write
...
```

Здесь параметр **scope** указывает, для каких ресурсов и разрешений приложение запрашивает авторизацию. Нужный ресурс по-прежнему присутствует в запросе — он указан в каждом значении параметра области. Использование параметра scope позволяет обеспечить более точное соответствие конечной точки платформы Microsoft Identity с спецификацией OAuth 2,0 и более тесное согласование с общими отраслевыми методиками. Он также позволяет приложениям выполнять [добавочное согласие](#incremental-and-dynamic-consent) — запрашивать разрешения только тогда, когда приложение требует их, а не заранее.

## <a name="well-known-scopes"></a>Хорошо известные области

### <a name="offline-access"></a>Автономный доступ

Для приложений, использующих конечную точку платформы идентификации Майкрософт, может потребоваться использовать новое хорошо известное разрешение для приложений — область `offline_access`. Всем приложения требуется запросить это разрешение, если им необходимо доступ к ресурсам от имени пользователя в течение длительного времени, даже если пользователь не работает с приложением активно. Область `offline_access` отображается в диалоговых окнах запроса согласия как разрешение **Доступ к вашим данным в любое время**, которое пользователь должен принять. Запрос разрешения `offline_access` позволит веб-приложению получить refresh_tokens OAuth 2,0 с конечной точки платформы идентификации Майкрософт. У маркеров обновления длительный срок действия, и их можно заменить на новые маркеры доступа OAuth 2.0 на значительные периоды доступа.

Если приложение не запрашивает область `offline_access`, оно не получит маркеры обновления. Это значит, что при использовании кода авторизации в потоке кода авторизации OAuth 2.0 вы получите только маркер доступа из конечной точки `/token`. Этот маркер доступа будет действителен в течение короткого времени (обычно одного часа), но в конечном итоге срок его действия истечет. В этот момент приложению будет необходимо перенаправить пользователя обратно в конечную точку `/authorize`, чтобы получить новый код авторизации. При этом пользователю может потребоваться повторно ввести учетные данные или повторно предоставить разрешения в зависимости от типа приложения.

Дополнительные сведения о OAuth 2,0, `refresh_tokens`и `access_tokens`см. в [справочнике по протоколу платформы идентификации Майкрософт](active-directory-v2-protocols.md).

### <a name="openid-profile-and-email"></a>OpenID, профиль и электронная почта

Исторически, самый простой поток входа OpenID Connect Connect с платформой Microsoft Identity предоставляет множество сведений о пользователе в полученном *id_token*. Утверждения в id_token могут содержать имя пользователя, предпочтительное имя пользователя, адрес электронной почты, идентификатор объекта и другие сведения.

Сейчас сведения, доступные вашему приложению с помощью области `openid`, ограничены. Теперь область `openid` позволит пользователю только войти в приложение и получить соответствующий идентификатор. Чтобы получить личные сведения о пользователе в приложении, приложение должно запросить у пользователя дополнительные разрешения. Чтобы запросить дополнительные разрешения, используйте две новые области — `email` и `profile`.

* С помощью области `email` приложение получает доступ к основному адресу электронной почты пользователя через утверждение `email` в маркере id_token, при условии что у пользователя есть адресуемый адрес электронной почты.
* Область `profile` предоставляет приложению доступ ко всем остальным основным сведениям о пользователе, таким как имя, предпочитаемое имя пользователя, идентификатор объекта и т. д. в id_token.

Эти области позволяют создать код приложения с минимальным разглашением сведений, поэтому вы можете запросить у пользователя только те сведения, которые нужны приложению для выполнения задания. Дополнительные сведения об этих областях см. [в справочнике по области платформы идентификации Майкрософт](v2-permissions-and-consent.md).

## <a name="token-claims"></a>Утверждения маркера

Конечная точка платформы идентификации Майкрософт по умолчанию выдает меньший набор утверждений в токенах, чтобы уменьшить объем полезных данных. Если у вас есть приложения и службы, зависящие от конкретного утверждения в токене v 1.0, который больше не предоставляется по умолчанию в токене платформы удостоверений Майкрософт, рассмотрите возможность использования [дополнительного утверждения](active-directory-optional-claims.md) для включения этого утверждения.

> [!IMPORTANT]
> маркеры v 1.0 и v 2.0 могут выдаваться конечными точками версии 1.0 и v 2.0! id_tokens *всегда* соответствует конечной точке, из которой они запрашиваются, и маркеры доступа *всегда* соответствуют формату, ОЖИДАЕМому веб-API, который клиент будет вызывать с помощью этого маркера.  Таким образом, если приложение использует конечную точку версии 2.0 для получения маркера для вызова Microsoft Graph, в котором требуется использовать маркеры доступа формата версии 1.0, приложение получит маркер в формате версии 1.0.  

## <a name="limitations"></a>Ограничения

Существует несколько ограничений, которые следует учитывать при использовании платформы Microsoft Identity.

При создании приложений, которые интегрируются с платформой Microsoft Identity, необходимо решить, соответствуют ли конечные точки платформы Microsoft Identity и протоколы проверки подлинности вашим потребностям. Конечная точка и платформа версии 1.0 все еще полностью поддерживаются и, в некоторых отношениях, является более функциональной, чем платформа Microsoft Identity. Однако платформа Microsoft Identity предоставляет разработчикам [значительные преимущества](azure-ad-endpoint-comparison.md) .

Ниже приведена упрощенная рекомендация для разработчиков.

* Если вам требуется поддержка личных учетных записей Майкрософт в приложении или вы создаете новое приложение, используйте платформу Майкрософт для идентификации. Но перед этим убедитесь, что вы понимаете ограничения, описанные в этой статье.
* Если вы выполняете миграцию или обновление приложения, использующего SAML, вы не можете использовать платформу Microsoft Identity. Вместо этого обратитесь к [руководству по Azure AD v 1.0](v1-overview.md).

Конечная точка платформы Microsoft Identity будет развиваться для устранения перечисленных здесь ограничений, поэтому вам потребуется только использовать конечную точку платформы Microsoft Identity. В то же время используйте эту статью, чтобы определить, подходит ли вам конечная точка платформы Microsoft Identity. Мы будем продолжать обновлять эту статью, чтобы отразить текущее состояние конечной точки платформы идентификации Майкрософт. Вернитесь назад, чтобы повторно оценить требования к возможностям платформы удостоверений Майкрософт.

### <a name="restrictions-on-app-registrations"></a>Ограничения регистрации приложений

Для каждого приложения, которое требуется интегрировать с конечной точкой платформы идентификации Майкрософт, можно создать регистрацию приложения в новом [ **Регистрация приложений** интерфейсе](https://aka.ms/appregistrations) портал Azure. Существующие учетная запись Майкрософт приложения несовместимы с порталом, но все приложения Azure AD находятся вне зависимости от того, где или когда они были зарегистрированы.

Регистрация приложений, поддерживающих рабочие, учебные и личные учетные записи, имеет такие особенности:

* Для идентификатора приложения можно использовать только два секрета приложения.
* Приложением, не зарегистрированным в клиенте, можно управлять только через учетную запись, в которой оно зарегистрировано. Невозможно предоставить совместный доступ к нему другим разработчикам. Это справедливо для большинства приложений, зарегистрированных с личной учетной записью Майкрософт на портале регистрации приложений. Если вы хотите поделиться регистрацией приложения с несколькими разработчиками, зарегистрируйте приложение в клиенте, используя новый раздел **Регистрация приложений** портал Azure.
* К формату URL-адреса перенаправления применяется несколько ограничений. Дополнительные сведения об URL-адресе перенаправления см. в следующем разделе.

### <a name="restrictions-on-redirect-urls"></a>Ограничения для URL-адресов перенаправления

Приложения, зарегистрированные для платформы Microsoft Identity, ограничены ограниченным набором значений URL-адресов перенаправления. URL-адрес перенаправления для веб-приложений и служб должен начинаться со схемы `https`, и во всех его значениях должен использоваться один домен DNS.  Система регистрации сравнивает полное DNS-имя существующего URL-адреса перенаправления и DNS-имя добавляемого URL-адреса перенаправления. `http://localhost` также поддерживается в качестве URL-адреса перенаправления.  

Запрос на добавление DNS-имени завершится ошибкой при выполнении любого из следующих условий.  

* Если полное DNS-имя нового URL-адреса перенаправления не соответствует DNS-имени существующего URL-адреса перенаправления.
* Если полное DNS-имя нового URL-адреса перенаправления не является поддоменом существующего URL-адреса перенаправления.

#### <a name="example-1"></a>Пример 1

Если в приложении используется URL-адрес перенаправления `https://login.contoso.com`, можно добавить URL-адрес перенаправления с полностью совпадающим DNS-именем, как показано в примере ниже.

`https://login.contoso.com/new`

Или же можно использовать ссылку на поддомен DNS login.contoso.com, как показано в примере ниже.

`https://new.login.contoso.com`

#### <a name="example-2"></a>Пример 2

Если вы хотите, чтобы в приложении использовались URL-адреса перенаправления `login-east.contoso.com` и `login-west.contoso.com`, добавьте их в таком порядке:

`https://contoso.com`  
`https://login-east.contoso.com`  
`https://login-west.contoso.com`  

Можно добавить два последних, так как они являются поддоменами первого URL-адреса перенаправления, contoso.com.

Для конкретного приложения можно использовать только 20 URL-адресов ответа. это ограничение применяется ко всем типам приложений, поддерживаемым регистрацией (одностраничное приложение (SPA), собственный клиент, веб-приложение и служба).  

Чтобы узнать, как зарегистрировать приложение для использования с платформой идентификации Майкрософт, см. статью [Регистрация приложения с помощью нового интерфейса Регистрация приложений](quickstart-register-app.md).

### <a name="restrictions-on-libraries-and-sdks"></a>Ограничения для библиотек и пакетов SDK

В настоящее время поддержка библиотек для конечной точки платформы идентификации Майкрософт ограничена. Если вы хотите использовать конечную точку платформы Microsoft Identity в рабочем приложении, у вас есть следующие варианты:

* Если вы создаете веб-приложение, вы можете безопасно использовать общедоступное серверное по по промежуточного слоя для входа и проверки маркеров. В нее входит ПО промежуточного слоя OWIN OpenID Connect для ASP.NET и подключаемый модуль NodeJS Passport. Примеры кода, использующие по промежуточного слоя Майкрософт, см. в разделе [Приступая к работе с платформой Microsoft Identity](v2-overview.md#getting-started) .
* Если вы создаете настольное или мобильное приложение, вы можете использовать одну из библиотек проверки подлинности Майкрософт (MSAL). Эти библиотеки общедоступны или находятся в предварительной версии, поддерживаемой в рабочей среде, поэтому их можно использовать в рабочих приложениях. Дополнительные сведения об условиях предварительной версии и доступных библиотеках см. в статье [Библиотеки проверки подлинности Azure Active Directory версии 2.0](reference-v2-libraries.md).
* Для платформ, не охваченных библиотеками Майкрософт, можно интегрироваться с конечной точкой платформы идентификации Майкрософт, напрямую отправляя и получая сообщения протокола в коде приложения. Протоколы OpenID Connect Connect и OAuth [задокументированы явным образом](active-directory-v2-protocols.md) , чтобы помочь в такой интеграции.
* Наконец, вы можете использовать библиотеки OpenID Connect Connect и OAuth с открытым исходным кодом для интеграции с конечной точкой платформы Microsoft Identity. Конечная точка платформы идентификации Майкрософт должна быть совместима со многими библиотеками протоколов с открытым исходным кодом без изменений. Наличие этих библиотек зависит от языка и платформы. На веб-сайтах [OpenID Connect](https://openid.net/connect/) и [OAuth 2.0](https://oauth.net/2/) можно ознакомиться со списком популярных реализаций. Дополнительные сведения см. в статьях [платформа Microsoft Identity и библиотеки проверки подлинности](reference-v2-libraries.md)и список клиентских библиотек с открытым кодом и примеры, которые были протестированы с конечной точкой платформы идентификации Майкрософт.
* Для справки `.well-known` конечная точка для общей конечной точки платформы идентификации Майкрософт — `https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration`. Замените `common` идентификатором вашего клиента, чтобы получить данные, относящиеся к вашему клиенту.  

### <a name="protocol-changes"></a>Изменения протокола

Конечная точка платформы идентификации Майкрософт не поддерживает SAML или WS-Federation; Он поддерживает только OpenID Connect Connect и OAuth 2,0.  К существенным отличиям протоколов OAuth 2.0 по сравнению с конечной точкой версии 1.0 относятся: 

* Утверждение `email` возвращается, если настроено необязательное утверждение **или** в запросе указано scope=email. 
* Вместо параметра `resource` теперь поддерживается параметр `scope`.  
* Многие отклики изменены для большего соответствия спецификации OAuth 2.0, например, `expires_in` возвращается в виде целого числа, а не строки.  

Чтобы лучше понять область действия протокола, поддерживаемого в конечной точке платформы Microsoft Identity, см. раздел [Справочник по протоколу OpenID Connect Connect и OAuth 2,0](active-directory-v2-protocols.md).

#### <a name="saml-restrictions"></a>Ограничения SAML

Если вы использовали Библиотека проверки подлинности Active Directory (ADAL) в приложениях Windows, вы могли воспользоваться преимуществами встроенной проверки подлинности Windows, которая использует утверждение язык разметки зявлений системы безопасности (SAML) (SAML). С его помощью пользователи федеративных клиентов Azure AD могут проходить аутентификацию в локальном экземпляре Active Directory автоматически, без необходимости ввода учетных данных. Предоставление утверждения SAML не поддерживается в конечной точке платформы Microsoft Identity.
