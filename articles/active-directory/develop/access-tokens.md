---
title: Ссылка на токены доступа к токенам платформы Майкрософт (ru) Azure
description: Узнайте о токенах доступа, испускаемых конечными точками Azure AD v1.0 и платформой идентификации Майкрософт (v2.0).
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 3/27/2020
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev, identityplatformtop40, fasttrack-edit
ms.openlocfilehash: 417829389a4b3a6bb55dcff9bfe59c2bc8693ca0
ms.sourcegitcommit: e040ab443f10e975954d41def759b1e9d96cdade
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2020
ms.locfileid: "80383214"
---
# <a name="microsoft-identity-platform-access-tokens"></a>Токены доступа к платформе идентификации Майкрософт

Маркеры доступа позволяют клиентам безопасно вызывать API-интерфейсы, защищенные платформой Azure. Токены доступа платформы идентификации Майкрософт — это [JWTs,](https://tools.ietf.org/html/rfc7519)закодированные объектами JSON, подписанными Azure. Клиентам следует обрабатывать маркеры как непрозрачные строки, так как их содержимое предназначено только для ресурса. Для проверки и отладки разработчики могут декодировать JWT через [jwt.ms](https://jwt.ms) или другой аналогичный сайт. Ваш клиент может получить токен доступа либо из конечной точки v1.0, либо из конечной точки v2.0, используя различные протоколы.

Когда клиент запрашивает токен доступа, Azure AD также возвращает некоторые метаданные о токене доступа для потребления приложения. Эти сведения включают срок действия маркера доступа и области, для которых он действителен. Благодаря этим данным приложение может выполнять интеллектуальное кэширование маркеров доступа, не анализируя сам маркер.

Если приложение является ресурсом, к которому могут обращаться клиенты (веб-API), маркеры доступа предоставляют полезные сведения для аутентификации и авторизации, в том числе идентификаторы пользователя, клиента и издателя, разрешения и многое другое.

В следующих разделах показано, как ресурс может проверять и использовать утверждения в маркере доступа.

> [!IMPORTANT]
> Токены доступа создаются на основе *аудитории* токена, то есть приложения, владеющего областями в токене.  Таким образом, настройка `accessTokenAcceptedVersion` ресурса в [манифесте приложения](reference-app-manifest.md#manifest-reference) `2` позволяет клиенту, вызывая конечную точку v1.0, получить токен доступа v2.0.  Аналогичным образом, именно поэтому изменение [дополнительных требований](active-directory-optional-claims.md) к токену доступа для вашего клиента `user.read`не изменяет токен доступа, полученный при запросе токена, который принадлежит ресурсу.
> По той же причине при тестировании клиентского приложения с помощью личного счета (например, hotmail.com или outlook.com) можно обнаружить, что токен доступа, полученный клиентом, является непрозрачной строкой. Это связано с тем, что доступ к ресурсу запросил устаревшие билеты MSA (учетная запись Microsoft), которые зашифрованы и не могут быть поняты клиентом.

## <a name="sample-tokens"></a>Примеры маркеров

Токены версий 1.0 и 2.0 похожи друг на друга и содержат много одинаковых утверждений. Ниже представлены примеры каждого из них.

### <a name="v10"></a>Версия 1.0

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSIsImtpZCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSJ9.eyJhdWQiOiJlZjFkYTlkNC1mZjc3LTRjM2UtYTAwNS04NDBjM2Y4MzA3NDUiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC9mYTE1ZDY5Mi1lOWM3LTQ0NjAtYTc0My0yOWYyOTUyMjIyOS8iLCJpYXQiOjE1MzcyMzMxMDYsIm5iZiI6MTUzNzIzMzEwNiwiZXhwIjoxNTM3MjM3MDA2LCJhY3IiOiIxIiwiYWlvIjoiQVhRQWkvOElBQUFBRm0rRS9RVEcrZ0ZuVnhMaldkdzhLKzYxQUdyU091TU1GNmViYU1qN1hPM0libUQzZkdtck95RCtOdlp5R24yVmFUL2tES1h3NE1JaHJnR1ZxNkJuOHdMWG9UMUxrSVorRnpRVmtKUFBMUU9WNEtjWHFTbENWUERTL0RpQ0RnRTIyMlRJbU12V05hRU1hVU9Uc0lHdlRRPT0iLCJhbXIiOlsid2lhIl0sImFwcGlkIjoiNzVkYmU3N2YtMTBhMy00ZTU5LTg1ZmQtOGMxMjc1NDRmMTdjIiwiYXBwaWRhY3IiOiIwIiwiZW1haWwiOiJBYmVMaUBtaWNyb3NvZnQuY29tIiwiZmFtaWx5X25hbWUiOiJMaW5jb2xuIiwiZ2l2ZW5fbmFtZSI6IkFiZSAoTVNGVCkiLCJpZHAiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC83MmY5ODhiZi04NmYxLTQxYWYtOTFhYi0yZDdjZDAxMjIyNDcvIiwiaXBhZGRyIjoiMjIyLjIyMi4yMjIuMjIiLCJuYW1lIjoiYWJlbGkiLCJvaWQiOiIwMjIyM2I2Yi1hYTFkLTQyZDQtOWVjMC0xYjJiYjkxOTQ0MzgiLCJyaCI6IkkiLCJzY3AiOiJ1c2VyX2ltcGVyc29uYXRpb24iLCJzdWIiOiJsM19yb0lTUVUyMjJiVUxTOXlpMmswWHBxcE9pTXo1SDNaQUNvMUdlWEEiLCJ0aWQiOiJmYTE1ZDY5Mi1lOWM3LTQ0NjAtYTc0My0yOWYyOTU2ZmQ0MjkiLCJ1bmlxdWVfbmFtZSI6ImFiZWxpQG1pY3Jvc29mdC5jb20iLCJ1dGkiOiJGVnNHeFlYSTMwLVR1aWt1dVVvRkFBIiwidmVyIjoiMS4wIn0.D3H6pMUtQnoJAGq6AHd
```

Изучите этот маркер версии 1.0 на сайте [jwt.ms](https://jwt.ms/#access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSIsImtpZCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSJ9.eyJhdWQiOiJlZjFkYTlkNC1mZjc3LTRjM2UtYTAwNS04NDBjM2Y4MzA3NDUiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC9mYTE1ZDY5Mi1lOWM3LTQ0NjAtYTc0My0yOWYyOTUyMjIyOS8iLCJpYXQiOjE1MzcyMzMxMDYsIm5iZiI6MTUzNzIzMzEwNiwiZXhwIjoxNTM3MjM3MDA2LCJhY3IiOiIxIiwiYWlvIjoiQVhRQWkvOElBQUFBRm0rRS9RVEcrZ0ZuVnhMaldkdzhLKzYxQUdyU091TU1GNmViYU1qN1hPM0libUQzZkdtck95RCtOdlp5R24yVmFUL2tES1h3NE1JaHJnR1ZxNkJuOHdMWG9UMUxrSVorRnpRVmtKUFBMUU9WNEtjWHFTbENWUERTL0RpQ0RnRTIyMlRJbU12V05hRU1hVU9Uc0lHdlRRPT0iLCJhbXIiOlsid2lhIl0sImFwcGlkIjoiNzVkYmU3N2YtMTBhMy00ZTU5LTg1ZmQtOGMxMjc1NDRmMTdjIiwiYXBwaWRhY3IiOiIwIiwiZW1haWwiOiJBYmVMaUBtaWNyb3NvZnQuY29tIiwiZmFtaWx5X25hbWUiOiJMaW5jb2xuIiwiZ2l2ZW5fbmFtZSI6IkFiZSAoTVNGVCkiLCJpZHAiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC83MmY5ODhiZi04NmYxLTQxYWYtOTFhYi0yZDdjZDAxMjIyNDcvIiwiaXBhZGRyIjoiMjIyLjIyMi4yMjIuMjIiLCJuYW1lIjoiYWJlbGkiLCJvaWQiOiIwMjIyM2I2Yi1hYTFkLTQyZDQtOWVjMC0xYjJiYjkxOTQ0MzgiLCJyaCI6IkkiLCJzY3AiOiJ1c2VyX2ltcGVyc29uYXRpb24iLCJzdWIiOiJsM19yb0lTUVUyMjJiVUxTOXlpMmswWHBxcE9pTXo1SDNaQUNvMUdlWEEiLCJ0aWQiOiJmYTE1ZDY5Mi1lOWM3LTQ0NjAtYTc0My0yOWYyOTU2ZmQ0MjkiLCJ1bmlxdWVfbmFtZSI6ImFiZWxpQG1pY3Jvc29mdC5jb20iLCJ1dGkiOiJGVnNHeFlYSTMwLVR1aWt1dVVvRkFBIiwidmVyIjoiMS4wIn0.D3H6pMUtQnoJAGq6AHd).

### <a name="v20"></a>Версия 2.0

```
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSJ9.eyJhdWQiOiI2ZTc0MTcyYi1iZTU2LTQ4NDMtOWZmNC1lNjZhMzliYjEyZTMiLCJpc3MiOiJodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vNzJmOTg4YmYtODZmMS00MWFmLTkxYWItMmQ3Y2QwMTFkYjQ3L3YyLjAiLCJpYXQiOjE1MzcyMzEwNDgsIm5iZiI6MTUzNzIzMTA0OCwiZXhwIjoxNTM3MjM0OTQ4LCJhaW8iOiJBWFFBaS84SUFBQUF0QWFaTG8zQ2hNaWY2S09udHRSQjdlQnE0L0RjY1F6amNKR3hQWXkvQzNqRGFOR3hYZDZ3TklJVkdSZ2hOUm53SjFsT2NBbk5aY2p2a295ckZ4Q3R0djMzMTQwUmlvT0ZKNGJDQ0dWdW9DYWcxdU9UVDIyMjIyZ0h3TFBZUS91Zjc5UVgrMEtJaWpkcm1wNjlSY3R6bVE9PSIsImF6cCI6IjZlNzQxNzJiLWJlNTYtNDg0My05ZmY0LWU2NmEzOWJiMTJlMyIsImF6cGFjciI6IjAiLCJuYW1lIjoiQWJlIExpbmNvbG4iLCJvaWQiOiI2OTAyMjJiZS1mZjFhLTRkNTYtYWJkMS03ZTRmN2QzOGU0NzQiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJhYmVsaUBtaWNyb3NvZnQuY29tIiwicmgiOiJJIiwic2NwIjoiYWNjZXNzX2FzX3VzZXIiLCJzdWIiOiJIS1pwZmFIeVdhZGVPb3VZbGl0anJJLUtmZlRtMjIyWDVyclYzeERxZktRIiwidGlkIjoiNzJmOTg4YmYtODZmMS00MWFmLTkxYWItMmQ3Y2QwMTFkYjQ3IiwidXRpIjoiZnFpQnFYTFBqMGVRYTgyUy1JWUZBQSIsInZlciI6IjIuMCJ9.pj4N-w_3Us9DrBLfpCt
```

Изучите этот маркер версии 2.0 на сайте [jwt.ms](https://jwt.ms/#access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imk2bEdrM0ZaenhSY1ViMkMzbkVRN3N5SEpsWSJ9.eyJhdWQiOiI2ZTc0MTcyYi1iZTU2LTQ4NDMtOWZmNC1lNjZhMzliYjEyZTMiLCJpc3MiOiJodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vNzJmOTg4YmYtODZmMS00MWFmLTkxYWItMmQ3Y2QwMTFkYjQ3L3YyLjAiLCJpYXQiOjE1MzcyMzEwNDgsIm5iZiI6MTUzNzIzMTA0OCwiZXhwIjoxNTM3MjM0OTQ4LCJhaW8iOiJBWFFBaS84SUFBQUF0QWFaTG8zQ2hNaWY2S09udHRSQjdlQnE0L0RjY1F6amNKR3hQWXkvQzNqRGFOR3hYZDZ3TklJVkdSZ2hOUm53SjFsT2NBbk5aY2p2a295ckZ4Q3R0djMzMTQwUmlvT0ZKNGJDQ0dWdW9DYWcxdU9UVDIyMjIyZ0h3TFBZUS91Zjc5UVgrMEtJaWpkcm1wNjlSY3R6bVE9PSIsImF6cCI6IjZlNzQxNzJiLWJlNTYtNDg0My05ZmY0LWU2NmEzOWJiMTJlMyIsImF6cGFjciI6IjAiLCJuYW1lIjoiQWJlIExpbmNvbG4iLCJvaWQiOiI2OTAyMjJiZS1mZjFhLTRkNTYtYWJkMS03ZTRmN2QzOGU0NzQiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJhYmVsaUBtaWNyb3NvZnQuY29tIiwicmgiOiJJIiwic2NwIjoiYWNjZXNzX2FzX3VzZXIiLCJzdWIiOiJIS1pwZmFIeVdhZGVPb3VZbGl0anJJLUtmZlRtMjIyWDVyclYzeERxZktRIiwidGlkIjoiNzJmOTg4YmYtODZmMS00MWFmLTkxYWItMmQ3Y2QwMTFkYjQ3IiwidXRpIjoiZnFpQnFYTFBqMGVRYTgyUy1JWUZBQSIsInZlciI6IjIuMCJ9.pj4N-w_3Us9DrBLfpCt).

## <a name="claims-in-access-tokens"></a>Утверждения в маркерах доступа

Маркеры JWT состоят из трех частей.

* **Заголовок** содержит сведения о том, как можно [проверить маркер](#validating-tokens), в том числе сведения о типе и способе подписывания маркера.
* **Полезные данные** содержат все важные сведения о пользователе или приложении, которые пытаются вызвать эту службу.
* **Подпись** содержит исходный материал для проверки маркера.

Эти части разделяются точками (`.`) и кодируются в Base64 по отдельности.

В маркер включаются только те утверждения, для которых существуют значения. Таким образом, ваше приложение не должно зависеть от присутствия претензии. Примеры `pwd_exp` включают (не каждый арендатор `family_name` требует, чтобы пароли истекали) или (клиент скиетир[(v1.0](../azuread-dev/v1-oauth2-client-creds-grant-flow.md), [v2.0](v2-oauth2-client-creds-grant-flow.md)) потоки от имени приложений, которые не имеют имен). Утверждения, используемые для проверки маркера доступа, присутствуют всегда.

> [!NOTE]
> Некоторые утверждения помогают Azure AD защищать маркеры от повторного использования. Они отмечаются в описании как Opaque (Непрозрачные), то есть недоступные для широкого использования. Такие утверждения могут присутствовать или отсутствовать в маркере, и в любой момент без предварительного уведомления могут быть добавлены новые.

### <a name="header-claims"></a>Утверждения заголовка

|Утверждение | Формат | Описание |
|--------|--------|-------------|
| `typ` | Строка — всегда JWT | Указывает, что маркер имеет тип JWT.|
| `nonce` | Строка | Уникальный идентификатор для защиты от атак с повторением маркеров. Ваш ресурс может сохранять это значение для защиты от повторов. |
| `alg` | Строка | Обозначает алгоритм, с помощью которого был подписан маркер, например RS256. |
| `kid` | Строка | Содержит отпечаток для открытого ключа, который использовался для подписания этого маркера. Выпускаются в маркерах доступа версий 1.0 и 2.0. |
| `x5t` | Строка | Действует и указывается точно так же, как `kid`. `x5t` — устаревшее утверждение, которое выпускается только в маркерах доступа версии 1.0 для обеспечения совместимости. |

### <a name="payload-claims"></a>Утверждения полезных данных

| Утверждение | Формат | Описание |
|-----|--------|-------------|
| `aud` | Строка с URI идентификатора приложения | Определяет целевого получателя маркера. В маркерах ID аудитория — это идентификатор приложения, назначенный вашему приложению на портале Azure. Приложение должно проверить это значение и отклонить маркер, если он ему не соответствует. |
| `iss` | Строка с URI службы токенов безопасности | Определяет службу маркеров безопасности (STS), которая создает и возвращает маркер, а также клиент Azure AD, в котором пользователь прошел аутентификацию. Если выданный маркер является маркером версии 2.0 (см. утверждение `ver`), URI заканчивается на `/v2.0`. GUID, который указывает, что пользователь является потребителем с учетной записью Майкрософт: `9188040d-6c67-4c5b-b112-36a304b66dad`. Приложению также следует использовать часть утверждения, содержащую GUID, для ограничения списка клиентов, которым разрешено входить в приложение, если это применимо. |
|`idp`| Строка, обычно — URI STS | Фиксирует поставщика удостоверений, который проверил подлинность субъекта маркера. Это значение идентично значению утверждения издателя, за исключением случаев, когда учетная запись пользователя и издатель принадлежат разным клиентам (например, гости). Если претензии нет, это означает, что `iss` значение может быть использовано вместо.  Для пользовательских учетных записей, используемых в контексте организации (например, приглашение пользовательской учетной записи в клиент Azure AD), утверждение `idp` может быть live.com или URI STS, содержащим клиент учетной записи Microsoft `9188040d-6c67-4c5b-b112-36a304b66dad`. |
| `iat` | int, метка времени UNIX | Значение Issued At (Выпущено в) показывает, когда произошла проверка подлинности этого маркера. |
| `nbf` | int, метка времени UNIX | Утверждение nbf (не ранее) определяет время, до которого маркер JWT не должен приниматься в обработку. |
| `exp` | int, метка времени UNIX | Утверждение exp (время окончания срока действия) указывает время окончания срока действия или время, начиная с которого маркер JWT не должен приниматься в обработку. Важно отметить, что ресурс может отклонить маркер и раньше указанного времени, если, например, требуется изменить способ аутентификации или маркер был отозван. |
| `aio` | Непрозрачная строка | Внутреннее утверждение, в котором Azure AD сохраняет данные для повторного использования маркеров. Ресурсы не должны использовать это утверждение. |
| `acr` | Строка со значением 0 или 1 | Присутствует только в маркерах версии 1.0. Утверждение Authentication context class (Класс контекста аутентификации). Значение 0 означает, что аутентификация конечного пользователя не соответствовала требованиям ISO/IEC 29115. |
| `amr` | Массив строк в формате JSON | Присутствует только в маркерах версии 1.0. Указывает способ проверки подлинности субъекта токена. Дополнительные сведения см. в [разделе об утверждении amr](#the-amr-claim). |
| `appid` | Строка с идентификатором GUID | Присутствует только в маркерах версии 1.0. Идентификатор приложения клиента, использующего маркер. Приложение может действовать самостоятельно или от имени пользователя. Идентификатор приложения, как правило, представляет объект приложения, но может также представлять и объект субъекта-службы в Azure AD. |
| `appidacr` | 0, 1 или 2 | Присутствует только в маркерах версии 1.0. Указывает на способ проверки подлинности клиента. Для общедоступного клиента значение равно 0. При использовании идентификатора и секрета клиента значение равно 1. Если для аутентификации использовался сертификат клиента, значение равно 2. |
| `azp` | Строка с идентификатором GUID | Только присутствует в токенах v2.0, замена для `appid`. Идентификатор приложения клиента, использующего маркер. Приложение может действовать самостоятельно или от имени пользователя. Идентификатор приложения, как правило, представляет объект приложения, но может также представлять и объект субъекта-службы в Azure AD. |
| `azpacr` | 0, 1 или 2 | Только присутствует в токенах v2.0, замена для `appidacr`. Указывает на способ проверки подлинности клиента. Для общедоступного клиента значение равно 0. При использовании идентификатора и секрета клиента значение равно 1. Если для аутентификации использовался сертификат клиента, значение равно 2. |
| `preferred_username` | Строка | Основное имя пользователя, представляющее пользователя. Это может быть адрес электронной почты, телефонный номер или универсальное имя пользователя без определенного формата. Его значение не является неизменяемым и может меняться с течением времени. Так как это значение является изменяемым, его нельзя использовать для принятия решений об авторизации.  Но его можно использовать в качестве подсказки при вводе имени пользователя. Чтобы получить это утверждение, необходимо указать область `profile`. |
| `name` | Строка | Предоставляет удобное для восприятия значение, которое идентифицирует субъект маркера. Это значение не обязательно должно быть уникальным. Оно изменяемое и предназначено только для отображения. Чтобы получить это утверждение, необходимо указать область `profile`. |
| `scp` | Строка, список областей с разделителями-пробелами | Набор областей, предоставляемых приложением, для которых клиентское приложение уже запросило (и получило) согласие. Приложению следует проверить, что здесь указаны допустимые предоставляемые приложением области, а затем принять решение об авторизации на основе значений для этих областей. Включаются только в [маркеры пользователя](#user-and-application-tokens). |
| `roles` | Массив строк, список разрешений | Набор разрешений, выставленных вашим приложением, что запрашивающее приложение или пользователь получил разрешение на вызов. Для [токенов приложений,](#user-and-application-tokens)это используется во время потока учетных данных клиента[(v1.0](../azuread-dev/v1-oauth2-client-creds-grant-flow.md), [v2.0](v2-oauth2-client-creds-grant-flow.md)) вместо пользовательских областей.  Для [токенов пользователей](#user-and-application-tokens) это заполняется ролями, назначенными пользователю в целевом приложении. |
| `wids` | Массив [RoleTemplateID](https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles#role-template-ids) GUIDs | Обозначает роли, назначенные пользователю по всему веб-аниме, из раздела ролей, присутствующих [на странице ролей админа.](https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles#role-template-ids)  Эта претензия настроена на основе в `groupMembershipClaims` зависимости от заявки, через свойство [манифеста приложения.](reference-app-manifest.md)  Требуется установка его на "Все" или "DirectoryRole".  Может не присутствовать в токенах, полученных через неявный поток из-за проблем длины маркеров. |
| `groups` | Массив идентификаторов GUID в формате JSON | Предоставляет идентификаторы объектов, представляющие членство субъекта в группах. Эти значения уникальны (см. раздел «Object ID»), их можно безопасно использовать для управления доступом, например для принудительной авторизации для доступа к ресурсу. Группы, входящие в утверждение groups, настраиваются для конкретного приложения с помощью свойства `groupMembershipClaims` в [манифесте приложения](reference-app-manifest.md). Если установлено значение null, исключаются все группы, если значение SecurityGroup — включается только членство в группах безопасности Active Directory, а значение All подразумевает включение как групп безопасности, так и списков рассылки Office 365. <br><br>См. описание утверждения `hasgroups` ниже, чтобы получить сведения об использовании утверждения `groups` с неявным разрешением. <br>Для других потоков, если количество групп, в которых находится пользователь, превышает лимит (150 для SAML, 200 для JWT), то претензия о завышении будет добавлена к источникам претензий, указывающим на конечную точку Microsoft Graph, содержащую список групп для пользователя. |
| `hasgroups` | Логическое | Если он присутствует, всегда имеет значение `true`. Это обозначает, что пользователь входит как минимум в одну группу. Используется вместо утверждения `groups` для JWT в неявных потоках предоставления, если утверждение полной группы расширяет фрагмент URI за пределы ограничения длины URL-адреса (в настоящее время 6 или более групп). Указывается, что клиент должен использовать API Microsoft Graph`https://graph.microsoft.com/v1.0/users/{userID}/getMemberObjects`для определения групп пользователей (). |
| `groups:src1` | Объект JSON | Для запросов маркеров, которые не ограничены по длине (см. `hasgroups` выше), но все еще слишком большие для маркеров, будет добавлена ссылка на полный список групп, в которые входит пользователь. Используется для JWT в качестве распределенного утверждения и для SAML в качестве нового утверждения вместо `groups`. <br><br>**Пример значения JWT**: <br> `"groups":"src1"` <br> `"_claim_sources`: `"src1" : { "endpoint" : "https://graph.microsoft.com/v1.0/users/{userID}/getMemberObjects" }` |
| `sub` | Строка с идентификатором GUID | Субъект, в отношении которого маркер утверждает сведения, например данные о пользователе приложения. Это значение является неизменяемым и не может быть переназначено или повторно использовано. Это значение можно использовать для безопасных проверок авторизации, например, когда маркер используется для доступа к ресурсу, а также в качестве ключа в таблицах базы данных. Так как субъект всегда присутствует в выдаваемых Azure AD маркерах, мы советуем использовать это значение в системе авторизации общего назначения. Тем не менее субъект — это попарный идентификатор, который является уникальным для конкретного приложения. Если один пользователь войдет в два различных приложения с помощью двух разных идентификаторов клиента, эти приложения получат два разных значения в утверждении субъекта. Это может быть или не быть необходимым в зависимости от требований архитектуры и конфиденциальности. Смотрите также `oid` претензию (которая остается той же в приложениях в рамках арендатора). |
| `oid` | Строка с идентификатором GUID | Неизменяемый идентификатор объекта на платформе удостоверений Майкрософт. В нашем случае это учетная запись пользователя. Его можно использовать для безопасных проверок авторизации, а также в качестве ключа в таблицах базы данных. Этот идентификатор уникально идентифицирует пользователя в приложениях. Если один пользователь войдет в два различных приложения с помощью двух разных идентификаторов клиента, эти приложения получат одинаковое значение в утверждении `oid`. Это означает, что `oid` может использоваться при выполнении запросов к веб-службам корпорации Майкрософт, например Microsoft Graph. График Майкрософт вернет этот `id` идентификатор в качестве свойства для данной [учетной записи пользователя.](/graph/api/resources/user) Так как `oid` позволяет нескольким приложениям сопоставлять пользователей, для получения этого утверждения необходимо указать область `profile`. Обратите внимание, что если один пользователь существует в нескольких клиентах, его учетная запись в каждом клиенте будет содержать разные идентификаторы объекта. Такие учетные записи считаются разными, даже если пользователь входит в каждую из них с помощью одних учетных данных. |
| `tid` | Строка с идентификатором GUID | Представляет клиент Azure AD, в котором определен пользователь. Для рабочих и учебных учетных записей значением GUID является неизменяемый идентификатор клиента организации, к которой принадлежит пользователь. Для личных учетных записей значением является `9188040d-6c67-4c5b-b112-36a304b66dad`. Чтобы получить это утверждение, необходимо указать область `profile`. |
| `unique_name` | Строка | Присутствует только в маркерах версии 1.0. Предоставляет удобное для восприятия значение, которое идентифицирует субъект маркера. Это значение не обязательно должно быть уникальным в пределах клиента. Оно используется только для отображения. |
| `uti` | Непрозрачная строка | Внутреннее утверждение, используемое Azure для повторной проверки маркеров. Ресурсы не должны использовать эту претензию. |
| `rh` | Непрозрачная строка | Внутреннее утверждение, используемое Azure для повторной проверки маркеров. Ресурсы не должны использовать это утверждение. |
| `ver` | Строка, `1.0` либо`2.0` | Обозначает номер версии маркера доступа. |

**Претензия групп по завышению**

Чтобы гарантировать, что размер маркера не превышает предельно допустимого размера заголовка HTTP, Azure AD ограничивает количество идентификаторов объектов, которые он включает в претензии групп. Если пользователь является членом большего числа групп, чем лимит перебора (150 для токенов SAML, 200 для токенов JWT), то Azure AD не испускает претензии групп в токене. Вместо этого он включает в себя претензию о перерасходе в маркере, которая указывает на приложение для запроса API Microsoft Graph для получения членства в группе пользователя.

```JSON
{
  ...
  "_claim_names": {
   "groups": "src1"
    },
    {
  "_claim_sources": {
    "src1": {
        "endpoint":"[Url to get this user's group membership from]"
        }
       }
     }
  ...
 }
 ```

Вы можете `BulkCreateGroups.ps1` использовать предоставленную в папке [App Creation Scripts папку,](https://github.com/Azure-Samples/active-directory-aspnetcore-webapp-openidconnect-v2/tree/master/5-WebApp-AuthZ/5-2-Groups/AppCreationScripts) чтобы помочь проверить сценарии переизбытки.

#### <a name="v10-basic-claims"></a>Базовые утверждения в версии 1.0

Следующие претензии будут включены в токены v1.0, если это применимо, но не включены в токены v2.0 по умолчанию. Если вы используете v2.0 и вам нужен один из этих требований, запросите их с помощью [дополнительных требований.](active-directory-optional-claims.md)

| Утверждение | Формат | Описание |
|-----|--------|-------------|
| `ipaddr`| Строка | IP-адрес, с которого пользователь прошел аутентификацию. |
| `onprem_sid`| Строка в [формате SID](https://docs.microsoft.com/windows/desktop/SecAuthZ/sid-components) | В тех случаях, когда пользователь использует локальную аутентификацию, это утверждение содержит его идентификатор безопасности. Вы можете использовать `onprem_sid` для авторизации в приложениях прежних версий.|
| `pwd_exp`| int, метка времени UNIX | Указывает, когда истекает срок действия пароля пользователя. |
| `pwd_url`| Строка | URL-адрес, на который можно направить пользователя для сброса пароля. |
| `in_corp`| Логическое | Посылает сигнал, если клиент входит в корпоративную сеть. Если они не являются, претензии не включены. |
| `nickname`| Строка | Дополнительное имя для пользователя, отдельное от имени или фамилии.|
| `family_name` | Строка | Указывает фамилию пользователя, которая определена в объекте пользователя. |
| `given_name` | Строка | Указывает личное имя пользователя, которое задано в объекте пользователя. |
| `upn` | Строка | Имя пользователя. Может содержать номер телефона, адрес электронной почты или любую неформатированную строку. Должно использоваться только для отображения и подсказки имени пользователя в сценариях повторной аутентификации. |

#### <a name="the-amr-claim"></a>Утверждение `amr`

Идентификационные данные Майкрософт могут быть проверены по-разному, что может иметь отношение к вашему приложению. Утверждение `amr` представляет собой массив с несколькими элементами, например `["mfa", "rsa", "pwd"]`, и используется при аутентификации с помощью пароля и приложения Authenticator.

| Значение | Описание |
|-----|-------------|
| `pwd` | Проверка пароля. Это может быть пароль учетной записи Майкрософт для пользователя или секрет клиента для приложения. |
| `rsa` | Аутентификация выполнялась путем проверки ключа RSA, например с помощью [приложения Microsoft Authenticator](https://aka.ms/AA2kvvu). Это включает в себя, если аутентификация была сделана самостоятельно подписанным JWT с сертификатом X509, принадлежащим сервису. |
| `otp` | Одноразовый секретный код, переданный по электронной почте или в текстовом сообщении. |
| `fed` | Использовалось утверждение федеративной проверки подлинности (например, JWT или SAML). |
| `wia` | Встроенная проверка подлинности Windows |
| `mfa` | Использовалась многофакторная проверка подлинности. Если указано это утверждение, будут перечислены и другие методы проверки подлинности. |
| `ngcmfa` | Эквивалентно `mfa`, используется для подготовки определенных расширенных типов учетных данных. |
| `wiaormfa`| Пользователь использовал для аутентификации учетные данные Windows или MFA. |
| `none` | Проверка подлинности не проводилась. |

## <a name="validating-tokens"></a>Проверка маркеров

Для проверки id_token или access_token приложение должно проверить подпись и утверждения маркера. Для проверки токенов доступа приложение должно также проверить эмитента, аудиторию и токены подписи. Они должны проверяться на соответствие значениям в документе обнаружения OpenID. Например, независимая для арендатора версия [https://login.microsoftonline.com/common/.well-known/openid-configuration](https://login.microsoftonline.com/common/.well-known/openid-configuration)документа находится по адресу .

ПО промежуточного слоя Azure AD содержит встроенные возможности для проверки маркеров доступа. Вы можете найти пример для выбранного вами языка в нашем наборе [примеров](https://docs.microsoft.com/azure/active-directory/active-directory-code-samples).

Мы предоставляем библиотеки и образцы кода, которые показывают, как обрабатывать проверку маркеров. Ниже предоставляется информация для тех, кто хочет разобраться в базовых процессах. Есть также несколько сторонних библиотек с открытым исходным кодом доступны для проверки JWT - есть по крайней мере один вариант для почти каждой платформы и языка там. Дополнительные сведения о библиотеках аутентификации Azure AD и примеры кода см. в документации по библиотекам проверки подлинности [версии 1.0](../azuread-dev/active-directory-authentication-libraries.md) и [версии 2.0](reference-v2-libraries.md).

### <a name="validating-the-signature"></a>Проверка подписи

Маркер JWT содержит три сегмента, разделенных символом `.` . Первый сегмент называется **заголовком**, второй — **телом**, а третий — **подписью**. Сегмент подписи можно использовать для проверки подлинности маркера, чтобы приложение доверяло ему.

Токены, выпущенные Azure AD, подписаны с использованием стандартных в отрасли асимметричных алгоритмов шифрования, таких как RS256. Заголовок JWT содержит сведения о ключе и методе шифрования, используемых для подписания маркера.

```json
{
  "typ": "JWT",
  "alg": "RS256",
  "x5t": "iBjL1Rcqzhiy4fpxIxdZqohM2Yk",
  "kid": "iBjL1Rcqzhiy4fpxIxdZqohM2Yk"
}
```

Претензия `alg` указывает алгоритм, который использовался для подписания `kid` токена, в то время как претензия указывает на конкретный общедоступный ключ, который использовался для проверки токена.

Azure AD может в любой момент времени подписать маркер идентификации с использованием любой пары открытого и закрытого ключей из определенного набора пар. Azure AD периодически изменяет возможный набор ключей, поэтому при создании приложения необходимо обеспечить автоматическую обработку подобных изменений ключей. Рекомендуем проверять наличие обновлений открытых ключей, которые использует служба Azure AD, каждые 24 часа.

Вы можете приобрести ключевые данные подписи, необходимые для проверки подписи, используя [документ метаданных OpenID Connect, расположенный](v2-protocols-oidc.md#fetch-the-openid-connect-metadata-document) по адресу:

```
https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration
```

> [!TIP]
> Попробуйте этот [URL-адрес](https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration) в браузере!

Документ метаданных:

* Является объектом JSON, содержащим несколько полезных частей информации, таких как расположение различных конечных точек, необходимых для проверки подлинности OpenID Connect.
* Он включает `jwks_uri` с информацией о расположении набора общедоступных ключей, используемых для подписания маркеров. Веб-ключ JSON (JWK), `jwks_uri` расположенный на сайте, содержит всю общедоступную ключевую информацию, используемую в данный конкретный момент времени.  Формат JWK описан в [RFC 7517](https://tools.ietf.org/html/rfc7517).  Приложение может использовать утверждение `kid` в заголовке маркера JWT, чтобы выбрать открытый ключ в этом документе, использованный для подписания определенного маркера. Затем он может сделать проверку подписи, используя правильный открытый ключ и указанный алгоритм.

> [!NOTE]
> Конечная точка версии 1.0 возвращает оба утверждения `x5t` и `kid`, в то время как конечная точка версии 2.0 отправляет только утверждение `kid`. В будущем мы рекомендуем использовать утверждение `kid` для проверки маркера.

Проверка подписи выходит за рамки этого документа - в случае необходимости имеется много библиотек с открытым исходным кодом, которые помогут вам сделать это.  Тем не менее, платформа Microsoft Identity имеет одно расширение подписи маркеров к стандартам - пользовательские клавиши подписания.

Если в приложении есть пользовательские ключи подписи в результате использования функции [отображения утверждений,](active-directory-claims-mapping.md) необходимо прижать параметр `appid` запроса, содержащий идентификатор приложения, чтобы получить указание на ключевую `jwks_uri` информацию вашего приложения, которая должна быть использована для проверки. Например: `https://login.microsoftonline.com/{tenant}/.well-known/openid-configuration?appid=6731de76-14a6-49ae-97bc-6eba6914391e` содержит `jwks_uri` `https://login.microsoftonline.com/{tenant}/discovery/keys?appid=6731de76-14a6-49ae-97bc-6eba6914391e`a .

### <a name="claims-based-authorization"></a>Авторизация на основе утверждений

Этот шаг зависит от бизнес-логики конкретного приложения. Ниже просто описаны несколько распространенных методов авторизации.

* Проверьте `scp` `roles` или утверждают, что все присутствующие области совпадают с теми, которые были выявлены вашим API, и позвольте клиенту вынести запрошенное действие.
* С помощью утверждения `appid` убедитесь, что вызывающий клиент имеет право вызывать API.
* Проверка статуса проверки подлинности `appidacr` вызываемого клиента с помощью - она не должна быть 0, если публичным клиентам не разрешается звонить вашему API.
* Проверьте список `nonce` прошлых претензий для проверки токена не воспроизводится.
* Убедитесь, что `tid` обозначает клиент, который имеет право вызывать этот API.
* С помощью утверждения `acr` проверьте, прошел ли пользователь многофакторную проверку подлинности. Это должно быть выполнено с помощью [условия доступа](https://docs.microsoft.com/azure/active-directory/conditional-access/overview).
* Если вы запросили `roles` или `groups` претензии в маркере доступа, убедитесь, что пользователю разрешено выполнять это действие.
  * В случае с маркерами, получаемых через неявный поток, для получения этих данных обычно нужно запрашивать [Microsoft Graph](https://developer.microsoft.com/graph/), ведь их размер часто превышает допустимый для маркера.

## <a name="user-and-application-tokens"></a>Маркеры пользователя и приложения

Ваше приложение может получать токены от имени пользователя (обычный поток) или непосредственно из приложения (через поток учетных данных клиента[(v1.0](../azuread-dev/v1-oauth2-client-creds-grant-flow.md), [v2.0](v2-oauth2-client-creds-grant-flow.md)). Маркеры для приложений указывают, что вызов поступает от самого приложения, а не по запросу пользователя. Эти маркеры обрабатываются в целом как обычно, но с некоторыми отличиями:

* Токены только для приложений `scp` не будут иметь `roles` претензии, и вместо этого могут иметь претензию. Именно в нем будут указываться разрешения приложения (в отличие от делегированных разрешений). Для получения дополнительной информации о делегированных и разрешениях на применение, см. разрешение и согласие[(v1.0](../azuread-dev/v1-permissions-consent.md), [v2.0](v2-permissions-and-consent.md)).
* Многие конкретные требования человека будут `name` отсутствуют, такие как или `upn`.
* `sub` Претензии `oid` и претензии будут одинаковыми.

## <a name="token-revocation"></a>Отзыв маркеров

Обновления токенов могут быть аннулированы или аннулированы в любое время по разным причинам. Эти причины делятся на две основные категории: время ожидания и отзыв.

### <a name="token-timeouts"></a>Время ожидания для маркеров

Используя [конфигурацию срока службы токенов,](active-directory-configurable-token-lifetimes.md)срок службы маркеров обновления может быть изменен.  Это нормально и ожидается, что некоторые жетоны будут обходиться без использования (например, пользователь не открывает приложение в течение 3 месяцев) и поэтому истекает.  Приложения столкнутся со сценариями, в которых сервер входа излучает маркер обновления из-за возраста. 

* MaxInactiveTime: Если токен обновления не был использован в течение времени, продиктоватого MaxInactiveTime, токен Refresh больше не будет действителен.
* MaxSessionAge: если MaxAgeSessionMultiFactor или MaxAgeSessionSingleFactor имеют значения, отличные от значений по умолчанию (Until-revoked), то по истечении периода, заданного в параметре MaxAgeSession*, потребуется повторная аутентификация.
* Примеры:
  * У арендатора есть MaxInactiveTime в течение пяти дней, и пользователь ушел в отпуск на неделю, и поэтому Azure AD не видел новый запрос маркера от пользователя в течение 7 дней. В следующий раз, когда пользователь запросит новый маркер, он обнаружит, что их маркер Refresh был отозван, и он должен ввести свои учетные данные снова.
  * Чувствительное приложение имеет MaxAgeSessionSingleFactor одного дня. Если пользователь входит в систему в понедельник и во вторник (через 25 часов), он будет обязан повторно подтвердить подлинность.

### <a name="revocation"></a>Запрет доступа

Обновления токенов могут быть отозваны сервером из-за изменения учетных данных или из-за использования или действия администратора.  Обновления токенов делятся на два класса - те, которые выдаются конфиденциальным клиентам (самая правая колонка) и те, которые выдаются публичным клиентам (все остальные столбцы).   

|   | Файл cookie на основе пароля | Токен на основе пароля | Файл cookie без использования пароля | Токен без использования пароля | Конфиденциальный маркер клиента |
|---|-----------------------|----------------------|---------------------------|--------------------------|---------------------------|
| Срок действия пароля | Остается активным | Остается активным | Остается активным | Остается активным | Остается активным |
| Пароль изменен пользователем | Отменен | Отменен | Остается активным | Остается активным | Остается активным |
| Пользователь выполняет SSPR | Отменен | Отменен | Остается активным | Остается активным | Остается активным |
| Администратор сбрасывает пароль | Отменен | Отменен | Остается активным | Остается активным | Остается активным |
| Пользователь отменяет свои маркеры обновления [с помощью PowerShell](https://docs.microsoft.com/powershell/module/azuread/revoke-azureadsignedinuserallrefreshtoken) | Отменен | Отменен | Отменен | Отменен | Отменен |
| Админ отменяет все маркеры обновления для пользователя [через PowerShell](https://docs.microsoft.com/powershell/module/azuread/revoke-azureaduserallrefreshtoken) | Отменен | Отменен |Отменен | Отменен | Отменен |
| Одиночный вывески[(v1.0](../azuread-dev/v1-protocols-openid-connect-code.md#single-sign-out), [v2.0](v2-protocols-oidc.md#single-sign-out) ) на паутине | Отменен | Остается активным | Отменен | Остается активным | Остается активным |

> [!NOTE]
> Вход без пароля означает, что пользователь не вводит пароль, чтобы войти. Например, использование лица с Windows Hello, ключом FIDO2 или PIN-кодом.
>
> Первичные токены обновления (PRT) на Windows 10 сегрегированы на основе учетных данных. Например, Windows Hello и пароль имеют свои соответствующие PRT, изолированные друг от друга. Когда пользователь впишется в учетные данные Hello (PIN или биометрия), а затем изменяет пароль, полученный ранее PRT на основе пароля будет аннулирован. Регистрация обратно с паролем аннулирует старый PRT и запрашивает новый.
>
> Обновления токенов не аннулируются и не отменяться при использовании для получения нового токена доступа и обновления токена.  Однако приложение должно отказаться от старого, как только оно будет использовано, и заменить его на новый, так как в новом маркере есть новое время истечения срока действия. 

## <a name="next-steps"></a>Дальнейшие действия

* Узнайте об этом [ `id_tokens` в Azure AD](id-tokens.md).
* Узнайте о разрешении и согласии [(v1.0](../azuread-dev/v1-permissions-consent.md), [v2.0](v2-permissions-and-consent.md)).
