---
title: Проверка подлинности через посредника в Android | Службы
titlesuffix: Microsoft identity platform
description: Обзор проверки подлинности через посредника & авторизации для Android на платформе Microsoft Identity
services: active-directory
author: shoatman
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 09/14/2019
ms.author: shoatman
ms.custom: aaddev
ms.reviewer: shoatman, hahamil, brianmel
ms.collection: M365-identity-device-management
ms.openlocfilehash: f5204ad71efa2587341600d2c5c1e5195d15445e
ms.sourcegitcommit: c38a1f55bed721aea4355a6d9289897a4ac769d2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/05/2019
ms.locfileid: "74843722"
---
# <a name="brokered-authentication-in-android"></a>Проверка подлинности через посредника в Android

Для участия в программе единого входа (SSO) на уровне устройства и для соответствия политикам условного доступа Организации необходимо использовать один из брокеров проверки подлинности Майкрософт. Интеграция с брокером обеспечивает следующие преимущества:

- Единый вход устройства
- Условный доступ для:
  - Защита приложений Intune
  - Регистрация устройства (Workplace Join)
  - Управление мобыльными устройствами
- Управление учетными записями на уровне устройства
  -  через Android AccountManager & параметры учетной записи
  - "Рабочая учетная запись" — настраиваемый тип учетной записи

В Android брокер проверки подлинности (Майкрософт) является компонентом, который входит в состав [Microsoft Authenticatorного приложения](https://play.google.com/store/apps/details?id=com.azure.authenticator) и [Корпоративный портал Intune](https://play.google.com/store/apps/details?id=com.microsoft.windowsintune.companyportal)

> [!TIP]
> Только одно приложение, в котором размещается брокер, будет активно в качестве брокера за раз. Какое приложение активно в качестве брокера, определяется порядком установки на устройстве. Первый компонент, который должен быть установлен или последним на устройстве, станет активным брокером.

На следующей схеме показана связь между приложением, библиотекой проверки подлинности Майкрософт (MSAL) и брокерами проверки подлинности Майкрософт.

![Схема развертывания компонента Service Broker](./media/brokered-auth/brokered-deployment-diagram.png)

## <a name="installing-apps-that-host-a-broker"></a>Установка приложений, на которых размещается брокер

Приложения, размещенные в брокере, могут быть установлены владельцем устройства из своего магазина приложений (обычно Google Play Маркет) в любое время. Однако некоторые интерфейсы API (Resources) защищены политиками условного доступа, для которых требуется, чтобы устройства были:

- Зарегистрировано (присоединено к рабочему месту) и (или)
- Зарегистрировано в управлении устройствами или
- Зарегистрировано в Защита приложений Intune

Если на устройстве еще не установлено приложение брокера, MSAL предписывает пользователю установить его, как только приложение попытается получить маркер в интерактивном режиме. После этого приложение потребует от пользователя выполнить шаги, чтобы сделать устройство совместимым с требуемой политикой.

## <a name="effects-of-installing-and-uninstalling-a-broker"></a>Последствия установки и удаления брокера

### <a name="when-a-broker-is-installed"></a>При установке брокера

При установке брокера на устройстве все последующие запросы интерактивных маркеров (вызовы `acquireToken()`) обрабатываются брокером, а не локально с помощью MSAL. Любое состояние SSO, ранее доступное MSAL, недоступно брокеру. В результате пользователь должен снова пройти проверку подлинности или выбрать учетную запись из существующего списка учетных записей, известных устройству.

Установка брокера не требует от пользователя повторного входа. Только когда пользователь должен разрешить `MsalUiRequiredException` будет следующий запрос к брокеру. `MsalUiRequiredException` вызывается по ряду причин, и его необходимо разрешить в интерактивном режиме. Ниже приведены некоторые распространенные причины.

- Пользователь изменил пароль, связанный с учетной записью.
- Учетная запись пользователя больше не соответствует политике условного доступа.
- Пользователь отозвал согласие на то, что приложение будет связано с учетной записью.

### <a name="when-a-broker-is-uninstalled"></a>При удалении брокера

Если установлено только одно приложение размещения брокера и оно удаляется, пользователю потребуется снова войти в систему. При удалении активного брокера учетная запись и связанные с ним токены удаляются с устройства.

Если Корпоративный портал Intune установлен и работает как активный брокер, а Microsoft Authenticator также установлен, то при удалении Корпоративный портал Intune (Active Broker) пользователю потребуется снова войти в систему. После повторного входа в приложение Microsoft Authenticator станет активным брокером.

## <a name="integrating-with-a-broker"></a>Интеграция с брокером

### <a name="generating-a-redirect-uri-for-a-broker"></a>Создание URI перенаправления для брокера

Необходимо зарегистрировать URI перенаправления, совместимый с брокером. URI перенаправления для брокера должен включать имя пакета приложения, а также представление подписи приложения в кодировке Base64.

Формат URI перенаправления: `msauth://<yourpackagename>/<base64urlencodedsignature>`

Создайте закодированную подпись с помощью URL-адреса Base64, используя ключи подписывания приложения. Ниже приведено несколько примеров команд, использующих ключи подписывания отладки.

#### <a name="macos"></a>MacOS

```bash
keytool -exportcert -alias androiddebugkey -keystore ~/.android/debug.keystore | openssl sha1 -binary | openssl base64
```

#### <a name="windows"></a>Windows

```powershell
keytool -exportcert -alias androiddebugkey -keystore %HOMEPATH%\.android\debug.keystore | openssl sha1 -binary | openssl base64
```

Сведения о подписывании приложения см. [в статье Знакомство с приложением](https://developer.android.com/studio/publish/app-signing) .

> [!IMPORTANT]
> Используйте рабочий ключ подписывания для рабочей версии приложения.

### <a name="configure-msal-to-use-a-broker"></a>Настройка MSAL для использования брокера

Чтобы использовать брокер в приложении, необходимо подтвердить, что вы настроили перенаправление брокера. Например, включите оба URI перенаправления с включенным брокером и укажите, что вы зарегистрировали его, включив в файл конфигурации MSAL следующее:

```javascript
"redirect_uri" : "<yourbrokerredirecturi>",
"broker_redirect_uri_registered": true
```

> [!TIP]
> Новый пользовательский интерфейс регистрации приложений портал Azure позволяет создать URI перенаправления брокера. Если вы зарегистрировали приложение с помощью старого интерфейса или использовали портал регистрации приложений Майкрософт, вам может потребоваться создать URI перенаправления и обновить список URI перенаправления на портале вручную.

### <a name="broker-related-exceptions"></a>Исключения, связанные с брокером

MSAL взаимодействует с брокером двумя способами:

- Служба, привязанная к брокеру
- AccountManager Android

Сначала MSAL использует привязанную службу брокера, так как для вызова этой службы не требуются разрешения Android. При сбое привязки к привязанной службе MSAL будет использовать API AccountManager для Android. MSAL делает это только в том случае, если приложению уже предоставлено разрешение `"READ_CONTACTS"`.

Если вы получаете `MsalClientException` с кодом ошибки `"BROKER_BIND_FAILURE"`, есть два варианта:

- Попросите пользователя отключить Энергосбережение для приложения Microsoft Authenticator и Корпоративный портал Intune.
- Попросите пользователя предоставить разрешение `"READ_CONTACTS"`
