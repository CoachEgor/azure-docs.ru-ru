---
title: Проверка подлинности через посредника в Android | Службы
titleSuffix: Microsoft identity platform
description: Обзор проверки подлинности через посредника & авторизации для Android на платформе Microsoft Identity
services: active-directory
author: shoatman
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 09/17/2020
ms.author: shoatman
ms.custom: aaddev
ms.reviewer: shoatman, hahamil, brianmel
ms.openlocfilehash: 5042bfad2cfe06c7c368c6b476aa1b02d67bcc9c
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91760760"
---
# <a name="brokered-authentication-in-android"></a>Проверка подлинности через посредника в Android

Для участия в программе единого входа (SSO) на уровне устройства и для соответствия политикам условного доступа Организации необходимо использовать один из брокеров проверки подлинности Майкрософт. Интеграция с брокером обеспечивает следующие преимущества:

- Единый вход устройства
- Условный доступ для:
  - Защита приложений Intune
  - Регистрация устройства (Workplace Join)
  - Управление мобильными устройствами
- Управление учетными записями на уровне устройства
  -  через Android AccountManager & параметры учетной записи
  - "Рабочая учетная запись" — настраиваемый тип учетной записи

В Android брокер проверки подлинности (Майкрософт) является компонентом, который входит в состав [Microsoft Authenticatorного приложения](https://play.google.com/store/apps/details?id=com.azure.authenticator) и [Корпоративный портал Intune](https://play.google.com/store/apps/details?id=com.microsoft.windowsintune.companyportal).

На следующей схеме показана связь между приложением, библиотекой проверки подлинности Майкрософт (MSAL) и брокерами проверки подлинности Майкрософт.

![Схема, на которой показано, как приложение связывается с MSAL, приложениями брокера и диспетчером учетных записей Android.](./media/brokered-auth/brokered-deployment-diagram.png)

## <a name="installing-apps-that-host-a-broker"></a>Установка приложений, на которых размещается брокер

Приложения, размещенные в брокере, могут быть установлены владельцем устройства из своего магазина приложений (обычно Google Play Маркет) в любое время. Однако некоторые интерфейсы API (Resources) защищены политиками условного доступа, для которых требуется, чтобы устройства были:

- Зарегистрировано (присоединено к рабочему месту) и (или)
- Зарегистрировано в управлении устройствами или
- Зарегистрировано в Защита приложений Intune

Если на устройстве еще не установлено приложение брокера, MSAL предписывает пользователю установить его, как только приложение попытается получить маркер в интерактивном режиме. После этого приложение потребует от пользователя выполнить шаги, чтобы сделать устройство совместимым с требуемой политикой.

## <a name="effects-of-installing-and-uninstalling-a-broker"></a>Последствия установки и удаления брокера

### <a name="when-a-broker-is-installed"></a>При установке брокера

При установке брокера на устройстве все последующие запросы интерактивных маркеров (вызовы `acquireToken()` ) обрабатываются брокером, а не локально с помощью MSAL. Любое состояние SSO, ранее доступное MSAL, недоступно брокеру. В результате пользователь должен снова пройти проверку подлинности или выбрать учетную запись из существующего списка учетных записей, известных устройству.

Установка брокера не требует от пользователя повторного входа. Только когда пользователь должен разрешить, `MsalUiRequiredException` будет отправлен следующий запрос к брокеру. `MsalUiRequiredException` может вызываться по нескольким причинам и должно быть разрешено в интерактивном режиме. Пример:

- Пользователь изменил пароль, связанный с учетной записью.
- Учетная запись пользователя больше не соответствует политике условного доступа.
- Пользователь отозвал согласие на то, что приложение будет связано с учетной записью.

#### <a name="multiple-brokers"></a>Несколько посредников

Если на устройстве установлено несколько брокеров, то брокер, который был установлен первым, всегда является активным брокером. На устройстве может быть активным только один компонент Service Broker.

### <a name="when-a-broker-is-uninstalled"></a>При удалении брокера

Если установлено только одно приложение размещения брокера и оно удаляется, пользователю потребуется снова войти в систему. При удалении активного брокера учетная запись и связанные с ним токены удаляются с устройства.

Если Корпоративный портал Intune установлен и работает как активный брокер, а Microsoft Authenticator также установлен, то при удалении Корпоративный портал Intune (Active Broker) пользователю потребуется снова войти в систему. После повторного входа в приложение Microsoft Authenticator станет активным брокером.

## <a name="integrating-with-a-broker"></a>Интеграция с брокером

### <a name="generating-a-redirect-uri-for-a-broker"></a>Создание URI перенаправления для брокера

Необходимо зарегистрировать URI перенаправления, совместимый с брокером. URI перенаправления для брокера должен включать имя пакета приложения и представление подписи приложения в кодировке Base64.

Формат URI перенаправления: `msauth://<yourpackagename>/<base64urlencodedsignature>`

Вы можете использовать [keytool](https://manpages.debian.org/buster/openjdk-11-jre-headless/keytool.1.en.html) для создания хэша подписи в кодировке Base64 с помощью ключей подписывания приложения, а затем использовать портал Azure для создания URI перенаправления с помощью этого хэша.

Linux и macOS:

```bash
keytool -exportcert -alias androiddebugkey -keystore ~/.android/debug.keystore | openssl sha1 -binary | openssl base64
```

Windows:

```powershell
keytool -exportcert -alias androiddebugkey -keystore %HOMEPATH%\.android\debug.keystore | openssl sha1 -binary | openssl base64
```

После создания хэша подписи с помощью *keytool*используйте портал Azure, чтобы создать URI перенаправления:

1. Войдите в [портал Azure](https://portal.azure.com) и выберите приложение Android в **Регистрация приложений**.
1. Выберите **Проверка подлинности**  >  **Добавить платформу**  >  **Android**.
1. В открывшейся области **Настройка приложения Android** введите созданный ранее **хэш подписи** и **имя пакета**.
1. Нажмите кнопку **настроить** .

Портал Azure создает URI перенаправления и отображает его в поле **URI перенаправления** в области **конфигурации Android** .

Дополнительные сведения о подписывании приложения см. в разделе [Знакомство](https://developer.android.com/studio/publish/app-signing) с приложением Android Studio пользователя.

> [!IMPORTANT]
> Используйте рабочий ключ подписывания для рабочей версии приложения.

### <a name="configure-msal-to-use-a-broker"></a>Настройка MSAL для использования брокера

Чтобы использовать брокер в приложении, необходимо подтвердить, что вы настроили перенаправление брокера. Например, включите оба URI перенаправления с включенным брокером и укажите, что вы зарегистрировали его, включив в файл конфигурации MSAL следующие параметры:

```json
"redirect_uri" : "<yourbrokerredirecturi>",
"broker_redirect_uri_registered": true
```

### <a name="broker-related-exceptions"></a>Исключения, связанные с брокером

MSAL взаимодействует с брокером двумя способами:

- Служба, привязанная к брокеру
- AccountManager Android

Сначала MSAL использует привязанную к брокеру службу, так как для вызова этой службы не требуются разрешения Android. При сбое привязки к привязанной службе MSAL будет использовать API AccountManager для Android. MSAL делает это только в том случае, если приложению уже предоставлено `"READ_CONTACTS"` разрешение.

Если получен `MsalClientException` код ошибки `"BROKER_BIND_FAILURE"` , есть два варианта:

- Попросите пользователя отключить Энергосбережение для приложения Microsoft Authenticator и Корпоративный портал Intune.
- Попросите пользователя предоставить `"READ_CONTACTS"` разрешение

## <a name="verifying-broker-integration"></a>Проверка интеграции брокера

Возможно, не будет немедленно ясно, что интеграция компонента Service Broker работает, но можно выполнить следующие действия для проверки:

1. На устройстве Android выполните запрос с помощью брокера.
1. В параметрах на устройстве Android найдите только что созданную учетную запись, соответствующую учетной записи, с помощью которой была выполнена проверка подлинности. Учетная запись должна иметь тип " *Рабочая учетная запись*".

Вы можете удалить учетную запись из параметров, если хотите повторить тест.

## <a name="next-steps"></a>Дальнейшие шаги

[Режим общего устройства для устройств Android](msal-android-shared-devices.md) позволяет настроить устройство Android таким образом, чтобы его можно было легко предоставить нескольким сотрудникам.
