---
title: Брокерская аутентификация в Android Azure
titlesuffix: Microsoft identity platform
description: Обзор посреднической проверки подлинности & авторизации для Android в платформе идентификации Майкрософт
services: active-directory
author: shoatman
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 09/14/2019
ms.author: shoatman
ms.custom: aaddev
ms.reviewer: shoatman, hahamil, brianmel
ms.openlocfilehash: a734589178438fd65d9a2d156fd91fc82807f578
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76697903"
---
# <a name="brokered-authentication-in-android"></a>Брокерская аутентификация в Android

Для участия в работе Единого знака (SSO) и для выполнения организационных политик условного доступа необходимо использовать одного из брокеров microsoft для участия в работе единых систем регистрации (SSO). Интеграция с брокером обеспечивает следующие преимущества:

- Устройство одного входного
- Условный доступ для:
  - Защита приложений Intune
  - Регистрация устройств (присоединение к рабочему месту)
  - Управление мобильными устройствами
- Управление учетным счетом в масштабах всего устройства
  -  через Android AccountManager & настройки учетной записи
  - "Рабочий счет" - пользовательский тип учетной записи

На Android, Microsoft Аутентификация Брокер является компонентом, который включен в [Microsoft Authenticator App](https://play.google.com/store/apps/details?id=com.azure.authenticator) и [Intune компании портал](https://play.google.com/store/apps/details?id=com.microsoft.windowsintune.companyportal)

> [!TIP]
> Только одно приложение, в котором находится брокер, будет активен в качестве брокера одновременно. Какое приложение действует в качестве брокера, определяется порядком установки на устройство. Первым, который будет установлен, или последний подарок на устройстве, становится активным брокером.

Следующая диаграмма иллюстрирует связь между вашим приложением, Библиотекой подлинности Майкрософт (MSAL) и брокерами по аутентификации Майкрософт.

![Диаграмма развертывания брокера](./media/brokered-auth/brokered-deployment-diagram.png)

## <a name="installing-apps-that-host-a-broker"></a>Установка приложений, в мещах брокера

Приложения для размещения брокеров могут быть установлены владельцем устройства из магазина приложений (обычно Google Play Store) в любое время. Однако некоторые AA (ресурсы) защищены политиками условного доступа, которые требуют, чтобы устройства были:

- Зарегистрирован (присоединено к рабочему месту) и/или
- Зачислено в управление устройствами или
- Зарегистрируйтесь в Intune App Protection

Если на устройстве уже нет приложения брокера, MSAL поручает пользователю установить его, как только приложение попытается получить токен в интерактивном режиме. Затем приложение должно будет вести пользователя через шаги, чтобы сделать устройство совместимым с требуемой политикой.

## <a name="effects-of-installing-and-uninstalling-a-broker"></a>Эффекты установки и удаления брокера

### <a name="when-a-broker-is-installed"></a>При установке брокера

Когда брокер установлен на устройстве, все последующие интерактивные запросы маркеров (звонки в `acquireToken()`) обрабатываются брокером, а не локально MSAL. Любое состояние SSO, ранее доступное MSAL, не доступно брокеру. В результате пользователю необходимо будет снова проверить подлинность или выбрать учетную запись из существующего списка учетных записей, известных устройству.

Установка брокера не требует, чтобы пользователь снова ввезло. Только тогда, когда пользователю необходимо решить `MsalUiRequiredException` будет следующий запрос перейти к брокеру. `MsalUiRequiredException`брошенпой по ряду причин, и должна быть решена в интерактивном режиме. Вот некоторые распространенные причины:

- Пользователь изменил пароль, связанный с их учетной записью.
- Учетная запись пользователя больше не соответствует политике условного доступа.
- Пользователь отозвал свое согласие на то, чтобы приложение было связано с их учетной записью.

### <a name="when-a-broker-is-uninstalled"></a>Когда брокер не установлен

Если установлен только один брокер хостинг приложение, и оно удаляется, то пользователю нужно будет войти снова. При установке активного брокера снимает счет и связанные с ним токены с устройства.

Если intune Company Portal установлен и работает в качестве активного брокера, а также установлен Microsoft Authenticator, то, если портал Intune Company (активный брокер) не установлен, пользователю необходимо войти в систему снова. Как только они снова вписываются, приложение Microsoft Authenticator становится активным брокером.

## <a name="integrating-with-a-broker"></a>Интеграция с брокером

### <a name="generating-a-redirect-uri-for-a-broker"></a>Создание перенаправления URI для брокера

Вы должны зарегистрировать перенаправление URI, который совместим с брокером. Перенаправление URI для брокера должно включать имя пакета вашего приложения, а также закодированное представление подписи приложения.

Формат перенаправления URI:`msauth://<yourpackagename>/<base64urlencodedsignature>`

Создайте код закодированную подпись Base64 с помощью ключей подписи вашего приложения. Вот некоторые примеры команд, которые используют ваши ключи подписи отладки:

#### <a name="macos"></a>macOS

```bash
keytool -exportcert -alias androiddebugkey -keystore ~/.android/debug.keystore | openssl sha1 -binary | openssl base64
```

#### <a name="windows"></a>Windows

```powershell
keytool -exportcert -alias androiddebugkey -keystore %HOMEPATH%\.android\debug.keystore | openssl sha1 -binary | openssl base64
```

Просмотрите [информацию о подписании](https://developer.android.com/studio/publish/app-signing) приложения.

> [!IMPORTANT]
> Используйте ключ подписи к продукции для производственной версии приложения.

### <a name="configure-msal-to-use-a-broker"></a>Настройка MSAL для использования брокера

Чтобы использовать брокера в приложении, вы должны подтвердить, что вы настроили ваш брокер перенаправить. Например, включите как включенное брокером перенаправление URI- и укажите, что вы зарегистрировали его, включив в файл конфигурации MSAL следующее:

```javascript
"redirect_uri" : "<yourbrokerredirecturi>",
"broker_redirect_uri_registered": true
```

> [!TIP]
> Новый ui регистрации приложений портала Azure поможет вам создать брокера перенаправить URI. Если вы зарегистрировали приложение с помощью старого опыта или сделали это с помощью портала регистрации приложений Майкрософт, возможно, потребуется создать перенаправление URI и обновить список перенаправления URIs на портале вручную.

### <a name="broker-related-exceptions"></a>Исключения, связанные с брокером

MSAL общается с брокером двумя способами:

- Брокерский сервис связан
- Android AccountManager

MSAL сначала использует услугу, связанную брокером, потому что вызов этой службы не требует каких-либо разрешений Android. Если привязка к связанной службе не сработает, MSAL будет использовать API Android AccountManager. MSAL делает это только в том `"READ_CONTACTS"` случае, если ваше приложение уже получило разрешение.

Если вы `MsalClientException` получаете `"BROKER_BIND_FAILURE"`код ошибки, то есть два варианта:

- Попросите пользователя отключить оптимизацию мощности для приложения Microsoft Authenticator и портала компании Intune.
- Попросите пользователя `"READ_CONTACTS"` предоставить разрешение
