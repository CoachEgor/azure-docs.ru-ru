---
title: Настройка приложений Azure AD SAML токенов
titleSuffix: Microsoft identity platform
description: Узнайте, как настраивать утверждения, выпущенные в токене SAML для корпоративных приложений в Azure AD.
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: article
ms.date: 10/22/2019
ms.author: ryanwi
ms.reviewer: luleon, paulgarn, jeedes
ms.custom: aaddev
ms.openlocfilehash: 87a9632ec2433b8698e3ae3761ba733aa6bc63a5
ms.sourcegitcommit: d187fe0143d7dbaf8d775150453bd3c188087411
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80885690"
---
# <a name="how-to-customize-claims-issued-in-the-saml-token-for-enterprise-applications"></a>Как: настроить претензии, выданные в токене SAML для корпоративных приложений

Сегодня Active Directory Azure (Azure AD) поддерживает одиночный всходной (SSO) с большинством корпоративных приложений, включая оба приложения, предварительно интегрированные в галерею приложений Azure AD, а также пользовательские приложения. Когда пользователь проходит аутентификацию для приложения в Azure AD с помощью протокола SAML 2.0, Azure AD отправляет токен в приложение (через запрос HTTP POST). Затем приложение проверяет и использует маркер для входа пользователя вместо запроса имени пользователя и пароля. Эти токены SAML содержат фрагменты информации о пользователе, известном как *претензии.*

*Утверждение* представляет собой информацию, предложенную поставщиком удостоверений, о пользователе в составе токена, выпущенного для этого пользователя. В [токене SAML](https://en.wikipedia.org/wiki/SAML_2.0)эти данные обычно содержит оператор атрибута SAML. А уникальный идентификатор пользователя, как правило, представлен в субъекте SAML, который также называют идентификатором имени.

По умолчанию Azure AD выдает в приложение токен SAML, содержащий `NameIdentifier` претензию со значением имени пользователя (также известного как имя пользователя) в Azure AD, который может однозначно идентифицировать пользователя. Маркер SAML включает также дополнительные утверждения, содержащие адрес электронной почты, имя и фамилию пользователя.

Чтобы просмотреть или изменить утверждения, выданные приложению в токене SAML, откройте приложение на портале Azure. Затем откройте раздел **«Атрибуты пользователя & претензий».**

![Откройте раздел «Атрибуты & пользователей» на портале Azure](./media/active-directory-saml-claims-customization/sso-saml-user-attributes-claims.png)

Изменение утверждений, выданных в маркере SAML, может потребоваться по двум основным причинам:

* Приложение требует, `NameIdentifier` чтобы утверждение или NameID было чем-то другим, кроме имени пользователя (или главного имени пользователя), хранящегося в Azure AD.
* Приложение требует другого набора URI утверждений или значений утверждений.

## <a name="editing-nameid"></a>Редактирование nameID

Для отослалили NameID (значение идентификатора имени):

1. Откройте страницу **значения идентификатора имени.**
1. Выберите атрибут или преобразование, которые необходимо применить к атрибуту. Дополнительно можно указать формат, который вы хотите иметь претензии NameID.

   ![Отсечение значения NameID (идентификатор имени)](./media/active-directory-saml-claims-customization/saml-sso-manage-user-claims.png)

### <a name="nameid-format"></a>Формат NameID

Если запрос SAML содержит элемент NameIDPolicy с определенным форматом, то Azure AD будет соблюдать формат в запросе.

Если запрос SAML не содержит элемент для NameIDPolicy, то Azure AD выдаст NameID с указанным форматом. Если формат не указан, Azure AD будет использовать исходный формат по умолчанию, связанный с выбранным источником претензий.

Из **выпадения формата идентификатора «Выбрать имя»** можно выбрать один из следующих вариантов.

| Формат NameID | Описание |
|---------------|-------------|
| **По умолчанию** | Azure AD будет использовать исходный формат по умолчанию. |
| **Постоянный** | Azure AD будет использовать Persistent в качестве формата NameID. |
| **Emailaddress** | Azure AD будет использовать EmailAddress в качестве формата NameID. |
| **Неопределенное** | Azure AD будет использовать Unspecified в качестве формата NameID. |
| **Кондонное имя домена Windows** | Azure AD будет использовать WindowsDomainQualifiedName в качестве формата NameID. |

Transient NameID также поддерживается, но не доступен в выпадении и не может быть настроен на стороне Azure. Чтобы узнать больше об атрибуте [Single Sign-On SAML protocol](single-sign-on-saml-protocol.md)NameIDPolicy, см.

### <a name="attributes"></a>Атрибуты

Выберите нужный источник для утверждения `NameIdentifier` (или NameID). Вы можете выбирать из следующих параметров.

| Имя | Описание |
|------|-------------|
| Email | Адрес электронной почты пользователя |
| userprincipalName | Основное имя пользователя (UPN) пользователя |
| onpremisessamaccount | Имя учетной записи SAM, синхронизированное из локального Azure AD |
| objectid | Объект пользователя в Azure AD |
| employeeid | Идентификатор сотрудника пользователя |
| Расширения каталогов | Расширения каталогов, [синхронизированные из локальной Active Directory с помощью синхронизации Azure AD Connect](../hybrid/how-to-connect-sync-feature-directory-extensions.md) |
| Атрибуты расширения 1–15 | Локальные атрибуты расширения, используемые для расширения схемы Azure AD |

Для получения дополнительной информации [см. Таблицу 3: Значения действительного идентификатора на источник.](active-directory-claims-mapping.md#table-3-valid-id-values-per-source)

Можно также присвоить любое постоянное (статическое) значение любым утверждениям, которые вы определяете в Azure AD. Пожалуйста, следуйте ниже шаги, чтобы назначить постоянное значение:

1. На [портале Azure](https://portal.azure.com/)в разделе **Атрибуты & запросов пользователя** нажмите на значок **«Edit»** для отсеивательь утверждений.

1. Нажмите на требуемую претензию, которую вы хотите изменить.

1. Введите постоянное значение без кавычек в **атрибуте Исходного кода** в рамках организации и нажмите **Сохранить.**

    ![Откройте раздел «Атрибуты & пользователей» на портале Azure](./media/active-directory-saml-claims-customization/organization-attribute.png)

1. Постоянное значение будет отображаться ниже.

    ![Откройте раздел «Атрибуты & пользователей» на портале Azure](./media/active-directory-saml-claims-customization/edit-attributes-claims.png)

### <a name="special-claims---transformations"></a>Особые претензии - преобразования

Можно также использовать функции преобразований требований.

| Функция | Описание |
|----------|-------------|
| **ExtractMailPrefix()** | Удаляет суффикс домена либо с адреса электронной почты, либо с главного имени пользователя. В таком случае будет извлекаться только первая часть передаваемого имени пользователя (например, joe_smith вместо joe_smith@contoso.com). |
| **Присоединиться()** | Присоединяет атрибут к проверенному домену. Если выбранное значение идентификатора пользователя имеет домен, он извлечет имя пользователя для добавления выбранного проверенного домена. Например, если в качестве значения идентификатора пользователя вы выберите адрес электронной почты (joe_smith@contoso.com), а в качестве проверенного домена выберите contoso.onmicrosoft.com, то в результате получите joe_smith@contoso.onmicrosoft.com. |
| **Толоуер()** | Преобразует символы выбранного атрибута в символы нижнего регистра. |
| **Тоуппер()** | Преобразует символы выбранного атрибута в символы верхнего регистра. |

## <a name="adding-application-specific-claims"></a>Добавление утверждений, специфичных для конкретных приложений

Добавление утверждений, к онемка для конкретных приложений:

1. В **пользовательских атрибутах & претензий**выберите **Добавить новую претензию,** чтобы открыть страницу **претензий пользователя Manage.**
1. Введите **название** претензий. Значение строго не нужно следовать шаблону URI, в спецификации SAML. Если вам нужен шаблон URI, вы можете поместить его в поле **Namespace.**
1. Выберите **Источник,** в котором претензия будет получена для получения его значения. Можно выбрать атрибут пользователя из выпадения атрибута исходного кода или применить преобразование к атрибуту пользователя, прежде чем излучать его в качестве претензии.

### <a name="claim-transformations"></a>Преобразования утверждения

Чтобы применить преобразование к атрибуту пользователя:

1. В **претензии Manage**выберите *Преобразование* в качестве источника претензии для открытия страницы **преобразования Управления.**
2. Выберите функцию из момента выпадения преобразования. В зависимости от выбранной функции, вам придется предоставить параметры и постоянное значение для оценки в преобразовании. Для получения дополнительной информации об имеющихся функциях обратитесь к таблице ниже.
3. Чтобы применить несколько преобразований, нажмите на **преобразование Добавить**. К претензии можно применить максимум две преобразования. Например, можно сначала извлечь приставку `user.mail`электронной почты. Затем сделайте строку верхнего корпуса.

   ![Отсечение значения NameID (идентификатор имени)](./media/active-directory-saml-claims-customization/sso-saml-multiple-claims-transformation.png)

Можно использовать следующие функции для преобразования требований.

| Функция | Описание |
|----------|-------------|
| **ExtractMailPrefix()** | Удаляет суффикс домена либо с адреса электронной почты, либо с главного имени пользователя. В таком случае будет извлекаться только первая часть передаваемого имени пользователя (например, joe_smith вместо joe_smith@contoso.com). |
| **Присоединиться()** | Создает новое значение, объединяя два атрибута. Дополнительно можно использовать сепаратор между двумя атрибутами. Для преобразования требования NameID соединение ограничено проверенным доменом. Если выбранное значение идентификатора пользователя имеет домен, он извлечет имя пользователя для добавления выбранного проверенного домена. Например, если в качестве значения идентификатора пользователя вы выберите адрес электронной почты (joe_smith@contoso.com), а в качестве проверенного домена выберите contoso.onmicrosoft.com, то в результате получите joe_smith@contoso.onmicrosoft.com. |
| **Толоуер()** | Преобразует символы выбранного атрибута в символы нижнего регистра. |
| **Тоуппер()** | Преобразует символы выбранного атрибута в символы верхнего регистра. |
| **Содержит()** | Выводы атрибута или постоянной, если вход соответствует заданного значения. В противном случае можно указать другой выход, если нет совпадений.<br/>Например, если вы хотите издать претензию, где значение является адресом электронной почты пользователя, если он содержит домен ",@contoso.comв противном случае вы хотите вывести имя пользователя основное. Для этого можно настроить следующие значения:<br/>*Параметр 1 (ввод)*: user.email<br/>*Значение*:@contoso.com" "<br/>Параметр 2 (выход): user.email<br/>Параметр 3 (выход, если нет совпадения): user.userprincipalname |
| **EndWith()** | Выводы атрибута или постоянной, если вход заканчивается с указанным значением. В противном случае можно указать другой выход, если нет совпадений.<br/>Например, если вы хотите издать претензию, в которой значение является идентификатором сотрудника, если идентификатор сотрудника заканчивается "000", в противном случае вы хотите вывести атрибут расширения. Для этого можно настроить следующие значения:<br/>*Параметр 1 (ввод)*: user.employeeid<br/>*Значение*: "000"<br/>Параметр 2 (выход): user.employeeid<br/>Параметр 3 (выход, если нет совпадений): user.extensionattribute1 |
| **StartWith()** | Выводы атрибута или постоянной, если вход начинается с заданного значения. В противном случае можно указать другой выход, если нет совпадений.<br/>Например, если вы хотите издать претензию, в которой значение является идентификатором сотрудника пользователя, если страна/регион начинается с "US", в противном случае вы хотите вывести атрибут расширения. Для этого можно настроить следующие значения:<br/>*Параметр 1 (ввод)*: user.country<br/>*Значение*: "США"<br/>Параметр 2 (выход): user.employeeid<br/>Параметр 3 (выход, если нет совпадений): user.extensionattribute1 |
| **Экстракт() - После сопоставления** | Возвращает подстроку после того, как она соответствует указанному значению.<br/>Например, если значение ввода "Finance_BSimon", сопоставленное значение "Finance_", то вывод претензии - "BSimon". |
| **Экстракт() - Перед сопоставлением** | Возвращает подстроку до тех пор, пока она не будет соотведеньна к указанному значению.<br/>Например, если значение ввода "BSimon_US", сопоставленное значение "_US", то вывод претензии - "BSimon". |
| **Экстракт() - Между соответствием** | Возвращает подстроку до тех пор, пока она не будет соотведеньна к указанному значению.<br/>Например, если значение ввода "Finance_BSimon_US", первое сопоставленное значение "Finance_", второе сопоставленное значение "_US", то вывод претензии - "BSimon". |
| **ExtractAlpha() - Префикс** | Возвращает приставку алфавитной части строки.<br/>Например, если значение ввода "BSimon_123", то он возвращает "BSimon". |
| **ExtractAlpha () - Суффикс** | Возвращает алфавитную часть суффикса строки.<br/>Например, если значение ввода "123_Simon", то оно возвращает "Simon". |
| **ExtractNumeric () - Префикс** | Возвращает приставку численной части строки.<br/>Например, если значение ввода "123_BSimon", то оно возвращает "123". |
| **ExtractNumeric () - Суффикс** | Возвращает числовую часть строки суффикса.<br/>Например, если значение ввода "BSimon_123", то оно возвращает "123". |
| **ЕслиО".)** | Выводы атрибута или постоянной, если вход недействителен или пуст.<br/>Например, если требуется вывести атрибут, сохраненный в атрибуте расширения, если идентификатор сотрудника для данного пользователя пуст. Для этого можно настроить следующие значения:<br/>Параметр 1 (ввод): user.employeeid<br/>Параметр 2 (выход): user.extensionattribute1<br/>Параметр 3 (выход, если нет совпадения): user.employeeid |
| **IfNotEmpty()** | Выводы атрибута или постоянной, если вход не является недействительным или пустым.<br/>Например, если требуется вывести атрибут, сохраненный в атрибуте расширения, если идентификатор сотрудника для данного пользователя не пуст. Для этого можно настроить следующие значения:<br/>Параметр 1 (ввод): user.employeeid<br/>Параметр 2 (выход): user.extensionattribute1 |

Если вам нужны дополнительные преобразования, отправьте свою идею на [форум обратной связи в Azure AD](https://feedback.azure.com/forums/169401-azure-active-directory?category_id=160599) в категории *приложений SaaS.*

## <a name="emitting-claims-based-on-conditions"></a>Излучая претензии на основе условий

Можно указать источник претензии на основе типа пользователя и группы, к которой принадлежит пользователь. 

Тип пользователя может быть:
- **Любой:** Все пользователи имеют доступ к приложению.
- **Члены**: Родной член арендатора
- **Все гости**: Пользователь привозит из внешней организации с Azure AD или без нее.
- **Гости AAD**: Гостевой пользователь принадлежит к другой организации, используюейкоторой Azure AD.
- **Внешние гости**: Гостевой пользователь принадлежит к внешней организации, которая не имеет Azure AD.


Один из сценариев, где это полезно, когда источник претензии отличается для гостя и сотрудника, доступ к приложению. Вы можете указать, что если пользователь является сотрудником, nameID получен от user.email, но если пользователь является гостем, то NameID получен от user.extensionattribute1.

Чтобы добавить условие претензии:

1. В **претензии Управления**, расширить условия претензии.
2. Выберите тип пользователя.
3. Выберите группу (ы), к которой должен принадлежать пользователь. Вы можете выбрать до 10 уникальных групп по всем заявкам для данного приложения. 
4. Выберите **Источник,** в котором претензия будет получена для получения его значения. Можно выбрать атрибут пользователя из выпадения атрибута исходного кода или применить преобразование к атрибуту пользователя, прежде чем излучать его в качестве претензии.

Порядок, в котором вы добавляете условия имеют важное значение. Azure AD оценивает условия сверху вниз, чтобы решить, какое значение следует излучать в претензии. 

Например, Брита Саймон является гостем арендатора Contoso. Она принадлежит к другой организации, которая также использует Azure AD. Учитывая ниже конфигурацию для приложения Fabrikam, когда Брита пытается войти в Fabrikam, Azure AD будет оценивать условия, как следовать.

Во-первых, Azure AD проверяет, является ли `All guests`тип пользователя Brita . Так как это верно, то Azure AD назначает `user.extensionattribute1`источник для претензии . Во-вторых, Azure AD проверяет, является `AAD guests`ли тип пользователя Brita, так как это также верно, то Azure AD присваивает источник для `user.mail`претензии. Наконец, претензия излучается `user.email` с значением для Brita.

![Претензии условная конфигурация](./media/active-directory-saml-claims-customization/sso-saml-user-conditional-claims.png)

## <a name="next-steps"></a>Дальнейшие действия

* [Управление приложениями с помощью Azure Active Directory](../manage-apps/what-is-application-management.md)
* [Настройка федеративного единого входа для приложения не из коллекции](../manage-apps/configure-federated-single-sign-on-non-gallery-applications.md)
* [Устранение неполадок единого входа на основе SAML](../azuread-dev/howto-v1-debug-saml-sso-issues.md)
