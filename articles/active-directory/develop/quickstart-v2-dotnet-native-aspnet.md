---
title: Вызов веб-API ASP.NET, защищенного с помощью платформы удостоверений Майкрософт
description: Из этого краткого руководства вы узнаете, как вызвать веб-API ASP.NET, защищенный с помощью платформы удостоверений Майкрософт, из приложения Windows Desktop (WPF). Клиент WPF выполняет проверку подлинности пользователя, запрашивает маркер доступа и вызывает веб-API.
services: active-directory
author: jmprieur
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: quickstart
ms.workload: identity
ms.date: 12/12/2019
ms.author: jmprieur
ms.custom: devx-track-csharp, aaddev, identityplatformtop40, scenarios:getting-started, languages:ASP.NET
ms.openlocfilehash: 0fc31fd397f8206f7c6f0509dd03495631dde609
ms.sourcegitcommit: c28fc1ec7d90f7e8b2e8775f5a250dd14a1622a6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/13/2020
ms.locfileid: "88165640"
---
# <a name="quickstart-call-an-aspnet-web-api-protected-by-microsoft-identity-platform"></a>Краткое руководство. Вызов веб-API ASP.NET, защищенного с помощью платформы удостоверений Майкрософт

Из этого краткого руководства вы узнаете, как предоставить веб-API и защитить его, чтобы доступ к нему могли получить только пользователи, прошедшие аутентификацию. В этом примере показано, как предоставить веб-API ASP.NET, чтобы он мог принимать маркеры, выданные личными учетными записями (включая outlook.com, live.com и др.), а также рабочими и учебными учетными записями любой компании или организации, которая использует платформу удостоверений Майкрософт.

В примере также представлен клиент классического приложения для Windows (WPF) для демонстрации того, как можно запросить маркер доступа для доступа к веб-API.

## <a name="prerequisites"></a>Предварительные требования

Для запуска этого примера потребуется:

* Visual Studio 2017 или 2019.  Скачайте [Visual Studio бесплатно](https://www.visualstudio.com/downloads/).

* [Учетная запись Майкрософт](https://www.outlook.com) или [Программа для разработчиков Microsoft 365](/office/developer-program/office-365-developer-program).

## <a name="download-or-clone-this-sample"></a>Скачивание или клонирование этого примера

Этот пример можно клонировать из оболочки или командной строки:

  ```console
  git clone https://github.com/AzureADQuickStarts/AppModelv2-NativeClient-DotNet.git
  ```

Вы также можете [скачать пример в виде ZIP-файла](https://github.com/AzureADQuickStarts/AppModelv2-NativeClient-DotNet/archive/complete.zip).

## <a name="register-your-web-api-in-the-application-registration-portal"></a>Регистрация веб-API на портале регистрации приложений

### <a name="choose-the-azure-ad-tenant-where-you-want-to-create-your-applications"></a>Выбор клиента Azure AD, в котором вы хотите создать приложения

Если вы хотите зарегистрировать приложения вручную, в качестве первого шага потребуется следующее:

1. Войдите на [портал Azure](https://portal.azure.com) с помощью личной учетной записи Майкрософт либо рабочей или учебной учетной записи.
1. Если ваша учетная запись имеется в нескольких клиентах Azure AD, выберите профиль в правом верхнем углу меню в верхней части страницы, а затем **переключите каталог**.
   Измените сеанс портала на нужный клиент Azure AD.

### <a name="register-the-service-app-todolistservice"></a>Регистрация приложения службы (TodoListService)

1. Перейдите на страницу [Регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) Платформы удостоверений Майкрософт для разработчиков.
1. Выберите **Новая регистрация**.
1. После появления страницы **Регистрация приложения** введите сведения о регистрации приложения:
   - В разделе **Имя** введите понятное имя приложения, которое будет отображаться пользователям приложения, например `AppModelv2-NativeClient-DotNet-TodoListService`.
   - Измените значение параметра **Поддерживаемые типы учетных записей** на **Учетные записи в любом каталоге организации**.
   - Выберите **Зарегистрировать**, чтобы создать приложение.

1. На странице приложения **Обзор** найдите **идентификатор приложения (клиента)** и запишите его, чтобы использовать позже. Он понадобится для настройки файла конфигурации Visual Studio для этого проекта (`ClientId` в `TodoListService\Web.config`).
1. Выберите раздел **Предоставление API** и:
   - Выберите **Добавить область**.
   - Примите предложенный URI идентификатора приложения (api://{clientId}), выбрав **Сохранить и продолжить**.
   - Задайте следующие параметры:
     - Для **имени области** используйте `access_as_user`.
     - Убедитесь, что для параметра **Кто может давать согласие** выбран вариант **Admins and users** (Администраторы и пользователи).
     - В поле **Отображаемое имя согласия администратора** введите `Access TodoListService as a user`.
     - В поле **Описание согласия администратора** введите `Accesses the TodoListService web API as a user`.
     - В поле **Отображаемое имя согласия пользователя** введите `Access TodoListService as a user`.
     - В поле **Описание согласия пользователя** введите `Accesses the TodoListService web API as a user`.
     - Сохраните для параметра **Состояние** значение **Включено**.
     - Выберите **Добавить область**.

### <a name="configure-the-service-project-to-match-the-registered-web-api"></a>Настройка проекта службы в соответствии с зарегистрированным веб-API

1. Откройте решение в Visual Studio, а затем откройте файл **Web.config** в корневом каталоге проекта **TodoListService**.
1. Замените значение параметра `ida:ClientId` на **идентификатор клиента (идентификатор приложения)** из приложения, которое вы только что зарегистрировали на портале регистрации приложений.

### <a name="add-the-new-scope-to-the-todolistclients-appconfig"></a>Добавление новой области в файл app.config проекта *TodoListClient*

* Откройте файл **app.config**, расположенный в корневой папке проекта **TodoListClient**, а затем вставьте **идентификатор приложения** из приложения, которое вы только что зарегистрировали для *TodoListService*, в параметр `TodoListServiceScope`, заменив строку `{Enter the Application ID of your TodoListService from the app registration portal}`.

  > [!NOTE]
  > Убедитесь, что используется следующий формат:
  >
  > `api://{TodoListService-Application-ID}/access_as_user`
  >
  >(где {TodoListService-Application-ID} — это GUID, представляющий идентификатор приложения для TodoListService).

## <a name="register-the-client-app-todolistclient"></a>Регистрация клиентского приложения (TodoListClient)

На этом шаге вы настроите проект *TodoListClient*, зарегистрировав новое приложение на портале регистрации приложений. В случаях, когда клиент и сервер считаются *одним и тем же приложением*, вы можете просто повторно использовать то же приложение, зарегистрированное на шаге 2. Если вы хотите, чтобы пользователи могли выполнять вход с помощью личных учетных записей Майкрософт, необходимо использовать то же приложение.

### <a name="register-the-todolistclient-application-in-the-application-registration-portal"></a>Регистрация приложения *TodoListClient* на *портале регистрации приложений*

1. Перейдите на страницу [Регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) Платформы удостоверений Майкрософт для разработчиков.
1. Выберите **Новая регистрация**.
1. После появления страницы **Регистрация приложения** введите сведения о регистрации приложения:
   - В разделе **Имя** введите понятное имя приложения, которое будет отображаться пользователям приложения, например `NativeClient-DotNet-TodoListClient`.
   - Измените значение параметра **Поддерживаемые типы учетных записей** на **Учетные записи в любом каталоге организации**.
   - Выберите **Зарегистрировать**, чтобы создать приложение.
   
   > [!NOTE]
   > Для проекта *TodoListClient* в файле **app.config** для `ida:Tenant` используется значение по умолчанию `common`.
   >
   > `common` означает, что вы можете войти с помощью рабочей или учебной учетной записи или личной учетной записи Майкрософт (так как в выбрали параметр **Учетные записи в любом каталоге организации**).
   >
   > `organizations` означает, что вы можете войти с помощью рабочей или учебной учетной записи.
   >
   > `consumers` означает, что вы можете войти только с помощью личной учетной записи Майкрософт.
   >
   
1. На странице обзора приложения выберите раздел **Аутентификация**.
   1. В разделе **Конфигурации платформ** нажмите кнопку **Добавить платформу**.
   1. Для параметра **Мобильные и классические приложения** выберите значение **Мобильные и классические приложения**.
   1. Для параметра **URI перенаправления** установите флажок **https://login.microsoftonline.com/common/oauth2/nativeclient** .
   1. Нажмите кнопку **Настроить**.   
1. Выберите раздел **Разрешения API**.
   1. Нажмите кнопку **Add a permission** (Добавить разрешение).
   1. Выберите вкладку **Мои API**.
   1. В списке API выберите `AppModelv2-NativeClient-DotNet-TodoListService API` или имя, введенное для веб-API.
   1. Установите разрешение **access_as_user**, если оно еще не установлено. При необходимости используйте поле поиска.
   1. Нажмите кнопку **Add permissions** (Добавить разрешения).

### <a name="configure-your-todolistclient-project"></a>Настройка проекта *TodoListClient*

1. На *портале регистрации приложения* на странице **Обзор** скопируйте значение **идентификатора приложения (клиента)** .
1. Откройте файл **app.config**, расположенный в корневой папке проекта **TodoListClient**, и вставьте значение в значение параметра `ida:ClientId`

## <a name="run-your-project"></a>Запуск проекта

1. Нажмите клавишу `<F5>`, чтобы запустить проект. *TodoListClient* должен открыться.
1. Выберите параметр **Войти** в правом верхнем углу и выполните вход с помощью того же пользователя, который использовался для регистрации приложения, или пользователя в том же каталоге.
1. На этом этапе, если вы впервые входите в систему, вам может быть предложено дать согласие на веб-API *TodoListService*.
1. При входе также запрашивается маркер доступа к области *access_as_user* для доступа к веб-API *TodoListService* и обработки списка *задач*.

## <a name="pre-authorize-your-client-application"></a>Предварительная авторизация клиентского приложения

Одним из способов предоставления пользователям из других каталогов доступа к веб-API является *предварительная авторизация* клиентских приложений для доступа к веб-API путем добавления идентификаторов приложения из клиентских приложений в список *предварительно авторизованных* приложений для веб-API. Когда предварительно авторизованный клиент будет добавлен, необходимость согласия пользователя на использование веб-API отпадет. Чтобы выполнить предварительную авторизацию веб-приложения, сделайте следующее:

1. Вернитесь на *портал регистрации приложения* и откройте свойства **TodoListService**.
1. В разделе **Предоставление API** щелкните **Добавить клиентское приложение** в подразделе *Авторизованные клиентские приложения*.
1. В поле *Идентификатор клиента* вставьте идентификатор приложения `TodoListClient`.
1. В разделе *Авторизованные области* выберите область для этого `api://<Application ID>/access_as_user` веб-API.
1. Нажмите кнопку **Добавить приложение** в нижней части страницы.

## <a name="run-your-project"></a>Запуск проекта

1. Нажмите клавишу `<F5>`, чтобы запустить проект. *TodoListClient* должен открыться.
1. Выберите **Войти** в правом верхнем углу (или "Очистить кэш/Войти"), а затем войдите в систему с помощью личной учетной записи Майкрософт (live.com или hotmail.com), рабочей или учебной учетной записи.

## <a name="optional-restrict-sign-in-access-to-your-application"></a>Необязательное действие: Ограничение доступа на вход в приложении

По умолчанию при скачивании этого примера кода и настройке приложения для использования конечной точки Azure Active Directory версии 2 по указанным выше инструкциям запрашивать маркеры и получать доступ к веб-API могут как личные учетные записи (такие как outlook.com, live.com и др.), так и рабочие или учебные учетные записи любой организации, использующей Azure AD.

Чтобы ограничить круг пользователей, которые могут входить в приложение, используйте один из следующих вариантов:

### <a name="option-1-restrict-access-to-a-single-organization-single-tenant"></a>Вариант 1. Ограничение доступа одной организацией (один клиент)

Вы можете ограничить доступ на вход в приложение до тех учетных записей пользователей, которые находятся в одном клиенте Azure AD, включая *гостевые учетные записи* этого клиента. Это распространенный сценарий для *бизнес-приложений*:

1. Откройте файл **App_Start\Startup.Auth** и измените значение конечной точки метаданных, передаваемое в `OpenIdConnectSecurityTokenProvider`, на `"https://login.microsoftonline.com/{Tenant ID}/v2.0/.well-known/openid-configuration"` (также можно использовать имя клиента, например `contoso.onmicrosoft.com`).
2. В том же файле задайте для свойства `ValidIssuer` в `TokenValidationParameters` значение `"https://sts.windows.net/{Tenant ID}/"`, а для аргумента `ValidateIssuer` — значение `true`.

### <a name="option-2-use-a-custom-method-to-validate-issuers"></a>Вариант 2. Используйте пользовательский метод для проверки издателей

Пользовательский метод можно реализовать для проверки издателей с помощью параметра **IssuerValidator**. Дополнительные сведения о том, как использовать этот параметр, см. в статье [TokenValidationParameters Class](/dotnet/api/microsoft.identitymodel.tokens.tokenvalidationparameters?view=azure-dotnet) (Класс TokenValidationParameters).

[!INCLUDE [Help and support](../../../includes/active-directory-develop-help-support-include.md)]

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о сценарии защищенного веб-API, который поддерживается платформой удостоверений Microsoft:
> [!div class="nextstepaction"]
> [Scenario: Protected web API](scenario-protected-web-api-overview.md) (Сценарий: защищенный веб-API)
