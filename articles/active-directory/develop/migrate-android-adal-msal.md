---
title: ADAL к MSAL миграционного руководства для Android (ru) Azure
description: Узнайте, как перенести приложение Azure Active Directory Authentication Library (ADAL) в Библиотеку подлинности Майкрософт (MSAL).
services: active-directory
author: mmacy
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.tgt_pltfrm: Android
ms.workload: identity
ms.date: 09/6/2019
ms.author: marsma
ms.reviewer: shoatman
ms.custom: aaddev
ms.openlocfilehash: 21866bb7dab3d5a093ffc4655161b80853eadfc5
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77084054"
---
# <a name="adal-to-msal-migration-guide-for-android"></a>ADAL к MSAL миграционного руководства для Android

В этой статье освещаются изменения, необходимые для переноса приложения, использующее Библиотеку подлинности активных каталогов Azure (ADAL) для использования библиотеки подлинности Майкрософт (MSAL).

## <a name="difference-highlights"></a>Основные моменты различий

ADAL работает с конечным пунктом Azure Active Directory v1.0. Библиотека аутентификации Майкрософт (MSAL) работает с платформой идентификации Майкрософт, ранее известной как Azure Active Directory v2.0. Платформа идентификации Майкрософт отличается от Azure Active Directory v1.0 тем, что она:

Поддерживаются следующие возможности:
  - Организационная идентичность (Активный каталог Azure)
  - Неорганизационные идентификаторы, такие как Outlook.com, Xbox Live и так далее
  - (Только B2C) Федеративный логин с Google, Facebook, Twitter и Amazon

- Совместимы ли стандарты с:
  - OAuth v2.0
  - OpenID Connect (OIDC)

API MSAL вносит важные изменения, в том числе:

- Новая модель доступа к токетонам:
  - ADAL предоставляет доступ к токенам через `AuthenticationContext`, который представляет сервер. MSAL предоставляет доступ к токенам `PublicClientApplication`через , который представляет клиента. Разработчикам клиентов не нужно `PublicClientApplication` создавать новый экземпляр для каждого органа, с которым им необходимо взаимодействовать. Требуется `PublicClientApplication` только одна конфигурация.
  - Поддержка запроса токенов доступа с использованием областей в дополнение к идентификаторам ресурсов.
  - Поддержка поэтапного согласия. Разработчики могут запрашивать области, поскольку пользователь получает все больше и больше функциональных возможностей в приложении, включая те, которые не включены во время регистрации приложения.
  - Власти больше не проверяются во время выполнения. Вместо этого разработчик объявляет список «известных авторитетов» во время разработки.
- Изменения API токенов:
  - В ADAL `AcquireToken()` сначала делает молчаливый запрос. В противном случае, он делает интерактивный запрос. Такое поведение привело к тому, что некоторые разработчики полагались только на, `AcquireToken`что привело к неожиданному запросу пользователя на учетные данные в разы. MSAL требует от разработчиков быть преднамеренными, когда пользователь получает запрос пользовательского интерфейса.
    - `AcquireTokenSilent`всегда приводит к молчаливому запросу, который либо удается, либо терпит неудачу.
    - `AcquireToken`всегда приводит к запросу, который подсказывает пользователю через пользовательский интерфейс.
- MSAL поддерживает входной связи либо из браузера по умолчанию, либо со встроенного веб-вида:
  - По умолчанию используется браузер по умолчанию на устройстве. Это позволяет MSAL использовать состояние аутентификации (cookies), которое может уже присутствовать для одного или нескольких подписанных в учетных записях. Если состояние аутентификации отсутствует, аутентификация во время авторизации через MSAL приводит к созданию состояния аутентификации (cookie) в интересах других веб-приложений, которые будут использоваться в том же браузере.
- Новая модель исключения:
  - Исключения более четко определяют тип ошибки, которая произошла, и то, что разработчик должен сделать, чтобы устранить ее.
- MSAL поддерживает параметры `AcquireToken` `AcquireTokenSilent` объектов для и вызовов.
- MSAL поддерживает декларативную конфигурацию для:
  - Идентификатор клиента, перенаправить URI.
  - Встроенный против браузера по умолчанию
  - Власти
  - Настройки HTTP, такие как время чтения и подключение

## <a name="your-app-registration-and-migration-to-msal"></a>Регистрация и миграция приложения в MSAL

Вам не нужно менять существующую регистрацию приложений, чтобы использовать MSAL. Если вы хотите воспользоваться дополнительным/прогрессивным согласием, возможно, потребуется просмотреть регистрацию, чтобы определить конкретные области, которые вы хотите запросить постепенно. Более подробная информация о сферах и постепенное согласие следующим образом.

При регистрации приложения на портале вы увидите вкладку **разрешений API.** При этом приводится список AA и разрешений (областей), к которым в настоящее время настроено приложение для запроса доступа. Он также показывает список имен областей, связанных с каждым разрешением API.

### <a name="user-consent"></a>предоставление согласия пользователем.

С ADAL и конечной точкой AAD v1 согласие пользователя на ресурсы, которыми они владеют, было предоставлено при первом использовании. С MSAL и платформой идентификации Майкрософт согласие может быть запрошено постепенно. Инкрементное согласие полезно для разрешений, которые пользователь может считать высокой привилегией, или может иным образом задаться вопросом, если не будет предоставлено четкое объяснение того, почему разрешение требуется. В ADAL эти разрешения могут привести к отказу пользователя от вхинга в ваше приложение.

> [!TIP]
> Мы рекомендуем использовать дополнительное согласие в сценариях, где необходимо предоставить пользователю дополнительный контекст о том, почему ваше приложение нуждается в разрешении.

### <a name="admin-consent"></a>Согласие администратора

Администраторы организации могут дать согласие на получение разрешений, необходимых вашему заявлению от имени всех членов организации. Некоторые организации разрешают только приложениям соглашаться на приложения. Согласие админ требует, чтобы вы включили все разрешения ИПИ и области, используемые вашим приложением, в регистрацию приложения.

> [!TIP]
> Даже если вы можете запросить область применения MSAL для чего-то, что не включено в регистрацию приложения, мы рекомендуем вам обновить регистрацию приложения, чтобы включить все ресурсы и области, на которые пользователь может когда-либо дать разрешение.

## <a name="migrating-from-resource-ids-to-scopes"></a>Миграция из идов ресурсов в области

### <a name="authenticate-and-request-authorization-for-all-permissions-on-first-use"></a>Authenticate и запрос разрешения на все разрешения на первое использование

Если вы в настоящее время используете ADAL и вам не нужно использовать дополнительное согласие, `acquireToken` самый простой способ начать использовать MSAL — сделать запрос с помощью нового `AcquireTokenParameter` объекта и установить значение идентификатора ресурса.

> [!CAUTION]
> Невозможно установить как области, так и идентификатор ресурса. Попытка установить оба приведет `IllegalArgumentException`к .

 Это приведет к тому же поведению v1, что вы использовали. Все разрешения, запрошенные при регистрации приложения, запрашиваются у пользователя во время первого взаимодействия.

### <a name="authenticate-and-request-permissions-only-as-needed"></a>Authenticate и запрашивать разрешения только по мере необходимости

Чтобы воспользоваться дополнительным согласием, составьте список разрешений (объемов), которые приложение использует из регистрации приложения, и упорядочить их в два списка на основе:

- Какие области вы хотите запросить во время первого взаимодействия пользователя с вашим приложением во время входиний.
- Разрешения, связанные с важной функцией приложения, которые необходимо будет объяснить пользователю.

После того как вы организовали области, организовать каждый список, по которому ресурс (API) вы хотите запросить маркер для. Как и любые другие области, которые вы хотите, чтобы пользователь авторизовал в то же время.

Объект параметров, используемый для запроса на поддержку MSAL:

- `Scope`: Список областей, которые вы хотите запросить авторизацию и получить токен доступа.
- `ExtraScopesToConsent`: Дополнительный список областей, для получения авторизации — пока вы запрашиваете токен доступа для другого ресурса. Этот список областей позволяет свести к минимуму количество раз, что вам нужно запросить авторизацию пользователя. Это означает меньшее количество запросов авторизации или согласия пользователя.

## <a name="migrate-from-authenticationcontext-to-publicclientapplications"></a>Переход от аутентификацииКонтекст к публичным клиентам

### <a name="constructing-publicclientapplication"></a>Создание приложения для публичных клиентов

При использовании MSAL, вы мгновенно `PublicClientApplication`. Этот объект моделирует личность приложения и используется для запросов в один или несколько органов власти. С помощью этого объекта вы будете настраивать идентификацию клиента, перенаправлять URI, полномочия по умолчанию, следует ли использовать браузер устройства против встроенного веб-зрения, уровень журнала и многое другое.

Вы можете декларативно настроить этот объект с помощью JSON, который вы предоставляете как файл или храните в качестве ресурса в APK.

Хотя этот объект не является синглтоном, `Executors` внутренне он использует общие для интерактивных и бесшумных запросов.

### <a name="business-to-business"></a>Бизнес бизнесу

В ADAL каждая организация, от которую вы запрашиваете токены доступа, требует отдельного экземпляра `AuthenticationContext`. В MSAL это больше не является требованием. Вы можете указать полномочия, из которых вы хотите запросить маркер, как часть вашего молчаливого или интерактивного запроса.

### <a name="migrate-from-authority-validation-to-known-authorities"></a>Миграция из проверки власти в известные органы власти

MSAL не имеет флага для включения или отключать проверку полномочий. Проверка функции в ADAL и в ранних выпусках MSAL не позволяет вашему коду запрашивать токены у потенциально вредоносного органа. MsAL теперь получает список авторитетов, известных корпорации Майкрософт, и объединяет этот список с указанными вами органами в конфигурации.

> [!TIP]
> Если вы являетесь пользователем Azure Business to Consumer (B2C), это означает, что вам больше не нужно отменять проверку полномочий. Вместо этого включите каждую из поддерживаемых вами политик Azure AD B2C в качестве авторитетов в конфигурации MSAL.

Если вы попытаетесь использовать авторитет, который не известен корпорации Майкрософт и не `UnknownAuthorityException`включен в конфигурацию, вы получите .

### <a name="logging"></a>Ведение журнала
Теперь можно декларативно настроить журнал как часть конфигурации, как это:

 ```
 "logging": {
    "pii_enabled": false,
    "log_level": "WARNING",
    "logcat_enabled": true
  }
  ```

## <a name="migrate-from-userinfo-to-account"></a>Переход от UserInfo к учетной записи

В ADAL `AuthenticationResult` предоставляется `UserInfo` объект, используемый для получения информации о подлинной учетной записи. Термин "пользователь", что означает человек или агент программного обеспечения, был применен таким образом, что затрудняет общение, что некоторые приложения поддерживают одного пользователя (будь то человек или агент программного обеспечения), который имеет несколько учетных записей.

Рассмотрим банковский счет. У вас может быть более одного счета в более чем одном финансовом учреждении. Когда вы открываете учетную запись, вам (пользователю) выдаются учетные данные, такие как карта банкомата & PIN-код, которые используются для доступа к вашему балансу, оплате счетов и так далее для каждого счета. Эти учетные данные могут быть использованы только в финансовом учреждении, которое их выдало.

По аналогии, как и учетные записи в финансовом учреждении, учетные записи в платформе идентификации Майкрософт доступны с использованием учетных данных. Эти учетные данные либо зарегистрированы в корпорации Майкрософт, либо выдаются им. Или корпорацией Майкрософт от имени организации.

В тех случаях, когда идентификационная платформа Майкрософт отличается от финансового учреждения, в этой аналогии, платформа идентификации Майкрософт предоставляет платформу, позволяющую пользователю использовать одну учетную запись и связанные с ней учетные данные, для доступа к ресурсам, которые принадлежат нескольких отдельных лиц и организаций. Это все равно, что использовать карту, выданную одним банком, в еще одном финансовом учреждении. Это работает, потому что все организации, о которых идет речь, используют платформу идентификации Майкрософт, которая позволяет использовать одну учетную запись в нескольких организациях. Ниже приведен пример:

Сэм работает на Contoso.com но управляет виртуальными машинами Azure, принадлежащими Fabrikam.com. Для Сэма, чтобы управлять виртуальными машинами Фабрикама, он должен иметь к ним доступ. Этот доступ может быть предоставлен путем добавления учетной записи Сэма в Fabrikam.com, и предоставление его учетной записи роль, которая позволяет ему работать с виртуальными машинами. Это будет сделано с порталом Azure.

Добавление Contoso.com аккаунта Сэма в качестве члена Fabrikam.com приведет к созданию новой записи в Active Directory Fabrikam.com для Sam. Запись Сэма в Active Directory Azure известна как объект пользователя. В этом случае этот пользовательский объект будет указывать на объект пользователя Sam в Contoso.com. Объект пользователя Sam Fabrikam является локальным представлением Сэма и будет использоваться для хранения информации об учетной записи, связанной с Сэмом в контексте Fabrikam.com. В Contoso.com, Сэм титул старшего консультанта DevOps. В Fabrikam, Сэм название Подрядчик-Виртуальные машины. В Contoso.com Сэм не несет ответственности и не уполномочен управлять виртуальными машинами. В Fabrikam.com, это его единственная функция работы. Тем не менее, Сэм по-прежнему имеет только один набор учетных данных, чтобы отслеживать, которые являются полномочия, выданные Contoso.com.

Как только `acquireToken` будет сделан успешный вызов, `IAccount` вы увидите ссылку `acquireTokenSilent` на объект, который может быть использован в последующих запросах.

### <a name="imultitenantaccount"></a>IMultiTenantAccount

Если у вас есть приложение, которое получает доступ к утверждениям об учетной записи от каждого из клиентов, в которых представлена учетная запись, вы можете отбросить `IAccount` объекты в `IMultiTenantAccount`. Этот интерфейс предоставляет `ITenantProfiles`карту, с ключами от идентификатора арендатора, что позволяет получить доступ к утверждениям, которые принадлежат учетной записи в каждом из арендаторов вы просили токен от, по отношению к текущей учетной записи.

Претензии в корне `IAccount` и `IMultiTenantAccount` всегда содержат претензии от дома арендатора. Если вы еще не сделали запрос на токен в доме арендатора, эта коллекция будет пустой.

## <a name="other-changes"></a>Другие изменения

### <a name="use-the-new-authenticationcallback"></a>Используйте новую аутентификациюCallback

```java
// Existing ADAL Interface
public interface AuthenticationCallback<T> {

    /**
     * This will have the token info.
     *
     * @param result returns <T>
     */
    void onSuccess(T result);

    /**
     * Sends error information. This can be user related error or server error.
     * Cancellation error is AuthenticationCancelError.
     *
     * @param exc return {@link Exception}
     */
    void onError(Exception exc);
}
```

```java
// New Interface for Interactive AcquireToken
public interface AuthenticationCallback {

    /**
     * Authentication finishes successfully.
     *
     * @param authenticationResult {@link IAuthenticationResult} that contains the success response.
     */
    void onSuccess(final IAuthenticationResult authenticationResult);

    /**
     * Error occurs during the authentication.
     *
     * @param exception The {@link MsalException} contains the error code, error message and cause if applicable. The exception
     *                  returned in the callback could be {@link MsalClientException}, {@link MsalServiceException}
     */
    void onError(final MsalException exception);

    /**
     * Will be called if user cancels the flow.
     */
    void onCancel();
}

// New Interface for Silent AcquireToken
public interface SilentAuthenticationCallback {

    /**
     * Authentication finishes successfully.
     *
     * @param authenticationResult {@link IAuthenticationResult} that contains the success response.
     */
    void onSuccess(final IAuthenticationResult authenticationResult);

    /**
     * Error occurs during the authentication.
     *
     * @param exception The {@link MsalException} contains the error code, error message and cause if applicable. The exception
     *                  returned in the callback could be {@link MsalClientException}, {@link MsalServiceException} or
     *                  {@link MsalUiRequiredException}.
     */
    void onError(final MsalException exception);
}


```

## <a name="migrate-to-the-new-exceptions"></a>Миграция к новым исключениям

В ADAL есть один тип исключения, `AuthenticationException`который включает метод получения `ADALError` значения enum.
В MSAL существует иерархия исключений, и каждый из них имеет свой собственный набор связанных конкретных кодов ошибок.

Список исключений MSAL

|Исключение  | Описание  |
|---------|---------|
| `MsalException`     | По умолчанию проверено исключение, брошенное MSAL.  |
| `MsalClientException`     | Брошено, если ошибка является стороной клиента. |
| `MsalArgumentException`     | Брошено, если один или несколько аргументов ввода недействительны. |
| `MsalClientException`     | Брошено, если ошибка является стороной клиента. |
| `MsalServiceException`     | Брошено, если ошибка является стороной сервера. |
| `MsalUserCancelException`     | Брошено, если пользователь отменил поток проверки подлинности.  |
| `MsalUiRequiredException`     | Брошено, если маркер не может быть освежен молча.  |
| `MsalDeclinedScopeException`     | Брошено, если один или несколько запрошенных областей были отклонены сервером.  |
| `MsalIntuneAppProtectionPolicyRequiredException` | Выброшен, если ресурс включен в политику защиты MAMCA. |

### <a name="adalerror-to-msalexception-errorcode"></a>ADALОшибка к MsalException ОшибкаКод

### <a name="adal-logging-to-msal-logging"></a>ADAL Регистрация на MSAL Logging

```java
// Legacy Interface
    StringBuilder logs = new StringBuilder();
    Logger.getInstance().setExternalLogger(new ILogger() {
            @Override
            public void Log(String tag, String message, String additionalMessage, LogLevel logLevel, ADALError errorCode) {
                logs.append(message).append('\n');
            }
        });
```

```java
// New interface
  StringBuilder logs = new StringBuilder();
  Logger.getInstance().setExternalLogger(new ILoggerCallback() {
            @Override
            public void log(String tag, Logger.LogLevel logLevel, String message, boolean containsPII) {
                logs.append(message).append('\n');
            }
        });

// New Log Levels:
public enum LogLevel
{
        /**
         * Error level logging.
         */
        ERROR,
        /**
         * Warning level logging.
         */
        WARNING,
        /**
         * Info level logging.
         */
        INFO,
        /**
         * Verbose level logging.
         */
        VERBOSE
}
```
