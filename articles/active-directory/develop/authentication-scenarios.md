---
title: Проверка подлинности на платформе удостоверений Майкрософт | Azure
description: Сведения об основах проверки подлинности в платформе Microsoft Identity Platform (v 2.0).
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 04/24/2020
ms.author: ryanwi
ms.reviewer: jmprieur, saeeda, sureshja, hirsin
ms.custom: aaddev, identityplatformtop40, scenarios:getting-started
ms.openlocfilehash: d979745d9b5bb65bd08f69db86801156de2a489d
ms.sourcegitcommit: fad3aaac5af8c1b3f2ec26f75a8f06e8692c94ed
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/27/2020
ms.locfileid: "82161747"
---
# <a name="authentication-basics"></a>Основные сведения об аутентификации

В этой статье рассматриваются многие основные понятия проверки подлинности, которые необходимо знать для создания защищенных веб-приложений, веб-API или приложений, вызывающих защищенные веб-API. Если вы видите термин, который вам не знаком, попробуйте наш [Глоссарий](developer-glossary.md) или [видеоролики Майкрософт по платформе идентификации](identity-videos.md) , которые охватывают основные понятия.

## <a name="authentication-vs-authorization"></a>Сравнение проверки подлинности и авторизации

**Проверка подлинности** — это процесс подтверждения того, что вы говорите. Аутентификация иногда сокращенно обозначается AuthN (Authentication). Платформа Microsoft Identity реализует протокол [OpenID Connect Connect](https://openid.net/connect/) для обработки проверки подлинности.

**Авторизация** — это действие предоставления проверяющей стороны разрешения на выполнение каких-либо действий. Он определяет, к каким данным разрешен доступ и что можно делать с этими данными. Авторизация иногда сокращенно обозначается AuthZ (Authorization). Платформа Microsoft Identity реализует протокол [OAuth 2,0](https://oauth.net/2/) для обработки авторизации.

Вместо создания приложений, каждый из которых хранит свои собственные сведения о имени пользователя и пароле, что влечет за собой высокий уровень административной нагрузки при необходимости добавления или удаления пользователей в нескольких приложениях, приложения могут делегировать ответственность за централизованный поставщик удостоверений.

Azure Active Directory (Azure AD) — это централизованный поставщик удостоверений в облаке. Делегирование проверки подлинности и авторизации в него позволяет выполнять такие сценарии, как политики условного доступа, требующие, чтобы пользователь найдет в определенном месте, использовать многофакторную проверку подлинности, а также разрешить пользователю входить один раз, а затем автоматически войти во все веб-приложения, использующие один централизованный каталог. Эта возможность называется **единым входом (SSO)**.

Платформа идентификации Майкрософт упрощает проверку подлинности и авторизацию для разработчиков приложений, предоставляя удостоверение в качестве службы с поддержкой стандартных отраслевых протоколов, таких как OAuth 2,0 и OpenID Connect Connect, а также библиотек с открытым исходным кодом для различных платформ, позволяющих быстро начать программировать. Она позволяет разработчикам создавать приложения, которые подписывают все удостоверения Майкрософт, получать маркеры для вызова [Microsoft Graph](https://developer.microsoft.com/graph/), других API-интерфейсов Майкрософт или интерфейсов API, созданных разработчиками. Дополнительные сведения см. в [статье развитие платформы идентификации Майкрософт](about-microsoft-identity-platform.md).

## <a name="security-tokens"></a>Маркеры безопасности Центра Интернета вещей

Централизованный поставщик удостоверений особенно важен для приложений, имеющих пользователей по всему миру, которые не обязательно входят в сеть предприятия. Платформа удостоверений Майкрософт проверяет подлинность пользователей и предоставляет маркеры безопасности, такие как [маркер доступа](developer-glossary.md#access-token), [маркер обновления](developer-glossary.md#refresh-token)и [маркеры идентификации](developer-glossary.md#id-token), которые позволяют [клиентскому приложению](developer-glossary.md#client-application) получать доступ к защищенным ресурсам на [сервере ресурсов](developer-glossary.md#resource-server).

**Маркеры доступа** — это маркер безопасности, выданный сервером авторизации. Он содержит сведения о пользователе и приложении, для которых предназначен маркер. который можно использовать для доступа к веб-API и другим защищенным ресурсам. Дополнительные сведения о том, как платформа идентификации Майкрософт выдает маркеры доступа, см. в разделе [маркеры доступа](access-tokens.md).

Маркеры доступа допустимы только в течение короткого периода времени, поэтому серверы авторизации иногда выдают **маркеры обновления** одновременно с выданным маркером доступа. После этого клиентское приложение может при необходимости обмениваться этим маркером обновления для нового маркера доступа. Дополнительные сведения о том, как платформа Microsoft Identity использует маркеры обновления для отзыва разрешений, см. в разделе [отзыв маркера](access-tokens.md#token-revocation).

**Маркеры идентификации** отправляются в клиентское приложение как часть потока [подключения OpenID Connect](v2-protocols-oidc.md) . Они могут отправляться вместе или вместо маркера доступа и использоваться клиентом для проверки подлинности пользователя. Дополнительные сведения о том, как платформа идентификации Майкрософт выдает маркеры идентификации, см. в разделе [токены](id-tokens.md)идентификации.

### <a name="validating-security-tokens"></a>Проверка маркеров безопасности

Это приложение, для которого был создан маркер, веб-приложение, выполнившего вход пользователя или вызываемый веб-API, для проверки маркера. Маркер подписывается сервером маркеров безопасности (STS) с закрытым ключом. STS публикует соответствующий открытый ключ. Чтобы проверить маркер, приложение проверяет подпись с помощью открытого ключа STS, чтобы проверить, была ли подпись создана с помощью закрытого ключа.

Маркеры допустимы только в течение ограниченного периода времени. Как правило, STS предоставляет пару токенов:

* Маркер доступа для доступа к приложению или защищенному ресурсу;
* Маркер обновления, используемый для обновления маркера доступа, когда маркер доступа близок к истечению срока действия.

Маркеры доступа передаются в веб-интерфейс API в качестве токена носителя `Authorization` в заголовке. Приложение может предоставить службе STS маркер обновления, и если пользователь не отменил доступ к приложению, он получит новый маркер доступа и новый маркер обновления. Таким способом обрабатывается ситуация, когда кто-то выходит из Организации. Когда STS получает маркер обновления, он не будет выдавать другой действительный маркер доступа, если пользователь больше не является полномочным.

### <a name="json-web-tokens-jwts-and-claims"></a>Веб-маркеры JSON (JWT) и утверждения

Платформа Microsoft Identity реализует маркеры безопасности в виде веб-маркеров JSON (JWT), которые содержат утверждения.

[Утверждение](developer-glossary.md#claim) предоставляет утверждения об одной сущности, например клиентском приложении или [владельцу ресурса](developer-glossary.md#resource-owner), к другой сущности, такой как сервер ресурсов.

Утверждения — это пары "имя-значение", которые ретранслировать факты о субъекте маркера. Например, утверждение может содержать факты о субъекте безопасности, проверенном [сервером авторизации](developer-glossary.md#authorization-server). Утверждения, представленные в заданном маркере, зависят от многих вещей, в том числе от типа маркера, типа учетных данных, используемых для проверки подлинности субъекта, конфигурации приложения и т. д.

Приложения могут использовать утверждения для различных задач, таких как:

* Проверка маркера
* Определение клиента субъекта маркера
* Отображение сведений о пользователе
* Определение авторизации субъекта

Утверждение состоит из пар «ключ-значение», которые предоставляют такие сведения, как:

* Сервер маркеров безопасности, создавший токен
* Дата создания маркера
* Тема (например, пользователь--, Кроме управляющих программ)
* Аудитория — приложение, для которого был создан маркер
* Приложение (клиент), которое запросило маркер. В случае веб-приложений это может совпадать с аудиторией

Дополнительные сведения о том, как платформа удостоверений Майкрософт реализует токены и сведения о заявках, см. в разделе [маркеры доступа](access-tokens.md) и [маркеры идентификации](id-tokens.md).

### <a name="how-each-flow-emits-tokens-and-codes"></a>Как каждый поток порождает маркеры и коды

В зависимости от того, как строится клиент, он может использовать один (или несколько) потоков проверки подлинности, поддерживаемых платформой идентификации Майкрософт. Эти потоки могут создавать различные маркеры (id_tokens, маркеры обновления, маркеры доступа), а также коды авторизации, и для их работы требуются разные токены. На этой диаграмме представлен обзор:

|Поток | Требуется . | id_token | Twitter, | маркер обновления | Код авторизации |
|-----|----------|----------|--------------|---------------|--------------------|
|[Поток кода авторизации](v2-oauth2-auth-code-flow.md) | | x | x | x | x|
|[Неявный поток](v2-oauth2-implicit-grant-flow.md) | | x        | x    |      |                    |
|[Гибридный поток OIDC](v2-protocols-oidc.md#get-access-tokens)| | x  | |          |            x   |
|[Активация токена обновления](v2-oauth2-auth-code-flow.md#refresh-the-access-token) | маркер обновления | x | x | x| |
|[Поток "от имени"](v2-oauth2-on-behalf-of-flow.md) | Twitter,| x| x| x| |
|[Учетные данные клиента](v2-oauth2-client-creds-grant-flow.md) | | | x (только для приложений)| | |

Токены, выданные через неявный режим, имеют ограничение длины, так как они передаются обратно в `response_mode` браузер `query` через `fragment`URL-адрес (где — или).  Некоторые браузеры имеют ограничение на размер URL-адреса, который может быть размещен в строке браузера, и завершается ошибкой, если она слишком длинная.  Поэтому эти маркеры не имеют `groups` никаких утверждений `wids` или.

## <a name="tenants"></a>Клиенты

Облачный поставщик удостоверений обслуживает множество организаций. Чтобы пользователи из разных организаций разделялись друг от друга, Azure AD разделяется на клиенты, с одним клиентом на организацию.

Клиенты отслеживают пользователей и связанные с ними приложения. Платформа Microsoft Identity также поддерживает пользователей, которые входят в систему с помощью личных учетных записей Майкрософт.

Azure AD также предоставляет Azure Active Directory B2C, чтобы организации могли входить в систему пользователей, как правило, с помощью социальных удостоверений, таких как учетная запись Google. Дополнительные сведения см. в [документации по Azure Active Directory B2C](https://docs.microsoft.com/azure/active-directory-b2c) .

Теперь, когда у вас есть общие сведения об основах, ознакомьтесь с основными сведениями о модели и API приложения удостоверений, Узнайте о том, как выполняется подготовка в платформе Microsoft Identity, и получите ссылки на подробную информацию о распространенных сценариях, поддерживаемых платформой Microsoft Identity Platform.

## <a name="application-model"></a>Модель приложения

Приложения могут входить в систему самих пользователей или делегировать вход поставщику удостоверений. Сведения о сценариях входа, поддерживаемых платформой идентификации Майкрософт, см. в статье [потоки проверки подлинности и сценарии приложений](authentication-flows-app-scenarios.md) .

Чтобы поставщик удостоверений знал, что пользователь имеет доступ к конкретному приложению, как пользователь, так и приложение должны быть зарегистрированы в поставщике удостоверений. При регистрации приложения в Azure AD вы предоставляете конфигурацию удостоверения для приложения, которое позволяет интегрировать его с платформой Microsoft Identity. Регистрация приложения также позволяет:

* Настройте фирменную символику приложения в диалоговом окне входа. Это важно, так как это первый интерфейс пользователя, который будет иметь приложение.
* Решите, следует ли разрешить пользователям входить в систему только в том случае, если они принадлежат вашей организации. Это приложение одного клиента. Или разрешить пользователям входить с помощью любой рабочей или учебной учетной записи. Это приложение с несколькими клиентами. Вы также можете разрешить доступ к личным учетным записям Майкрософт или учетной записи социальных сетей из LinkedIn, Google и т. д.
* Запрос разрешения области. Например, можно запросить область "пользователь. Read", которая предоставляет разрешение на чтение профиля пользователя, выполнившего вход.
* Определите области, определяющие доступ к веб-API. Как правило, когда приложению требуется доступ к API, ему необходимо запросить разрешения для определенных областей.
* Поделитесь своим секретом с платформой идентификации Майкрософт, которая подтверждает подлинность приложения.  Это касается случая, когда приложение является конфиденциальным клиентским приложением. Конфиденциальное клиентское приложение — это приложение, которое может безопасно хранить учетные данные. Для хранения учетных данных им требуется доверенный внутренний сервер.

После регистрации приложению будет предоставлен уникальный идентификатор, который приложение использует совместно с платформой идентификации Майкрософт при запросе маркеров. Если приложение является [конфиденциальным клиентским приложением](developer-glossary.md#client-application), оно также будет совместно использовать секрет или открытый ключ *-в зависимости от того, использовались ли сертификаты или секреты.

Платформа Microsoft Identity представляет приложения, использующие модель, выполняющую две основные функции:

* Идентификация приложения по поддерживаемым протоколам проверки подлинности
* Укажите все идентификаторы, URL-адреса, секреты и связанные сведения, необходимые для проверки подлинности

Платформа Microsoft Identity:

* Содержит все данные, необходимые для поддержки проверки подлинности во время выполнения
* Содержит все данные для решения о том, к каким ресурсам может потребоваться доступ приложению, и при каких обстоятельствах необходимо выполнить заданный запрос.
* Предоставляет инфраструктуру для реализации подготовки приложений в клиенте разработчика приложения и в любом другом клиенте Azure AD.
* Обрабатывает согласие пользователя во время запроса маркера и упрощает динамическую подготовку приложений для клиентов.

Согласие — это процесс предоставления владельцу ресурса авторизации для доступа клиентского приложения к защищенным ресурсам в соответствии с конкретными разрешениями от имени владельца ресурса. Платформа Microsoft Identity:

* позволяет пользователям и администраторам динамически предоставлять или отзывать согласие для приложения на доступ к ресурсам от их имени;
* позволяет администраторам единолично решить, какие действия разрешены приложениям, какие пользователи могут использовать определенные приложения и каким способом осуществляется доступ к ресурсам каталога.

В платформе Microsoft Identity платформа [объект приложения](developer-glossary.md#application-object) описывает приложение. Во время развертывания платформа Microsoft Identity использует объект приложения в качестве схемы для создания [субъекта-службы](developer-glossary.md#service-principal-object), который представляет конкретный экземпляр приложения в каталоге или клиенте. Субъект-служба определяет, что приложение может реально выполнять в определенном целевом каталоге, кто может его использовать, какие ресурсы он имеет доступ и т. д. Платформа удостоверений Майкрософт создает субъект-службу из объекта приложения путем предоставления **согласия**.

На следующей схеме показан упрощенный процесс подготовки платформы удостоверений Майкрософт на основе согласия. В нем показаны два клиента: *A* и *B*.

* *Клиент а* владеет приложением.
* *Клиент б* создает экземпляр приложения с помощью субъекта-службы.

![Упрощенный процесс подготовки на основе согласия](./media/authentication-scenarios/simplified-provisioning-flow-consent-driven.svg)

В этом процессе подготовки:

1. Пользователь клиента B пытается выполнить вход в приложение. Конечная точка авторизации запрашивает маркер безопасности для приложения.
1. Учетные данные пользователя будут получены и проверены на проверку подлинности.
1. Пользователю предлагается предоставить согласие на получение доступа к клиенту б для приложения.
1. Платформа Microsoft Identity использует объект приложения в клиенте а в качестве схемы создания субъекта-службы в клиенте б.
1. Пользователь получает запрошенный маркер.

Этот процесс можно повторить для дополнительных клиентов. Клиент A сохраняет схему для приложения (объект приложения). Пользователи и администраторы всех других клиентов, на которых приложение получает согласие, контролируйте, что приложение может выполнять через соответствующий объект субъекта-службы в каждом клиенте. Дополнительные сведения см. в [этой статье](app-objects-and-service-principals.md).

## <a name="web-app-sign-in-flow-with-microsoft-identity-platform"></a>Поток входа веб-приложения с платформой Microsoft Identity

Когда пользователь переходит в браузер в веб-приложение, происходит следующее:

* Веб-приложение определяет, прошел ли пользователь проверку подлинности.
* Если пользователь не прошел проверку подлинности, веб-приложение делегирует в Azure AD вход пользователя. Этот вход будет соответствовать политике Организации. это может означать, что пользователь должен ввести свои учетные данные, использовать многофакторную проверку подлинности или вообще не использовать пароль (например, с помощью Windows Hello).
* Пользователю предлагается согласие на доступ, который требуется клиентскому приложению. Именно поэтому клиентские приложения должны быть зарегистрированы в Azure AD, чтобы платформа Microsoft Identity могла предоставлять маркеры, представляющие доступ, который пользователь предоставил.

При успешной проверке подлинности пользователя:

* Платформа Microsoft Identity отправляет маркер веб-приложению.
* Файл cookie сохраняется, связанный с доменом Azure AD, который содержит удостоверение пользователя в JAR-файле cookie браузера. В следующий раз, когда приложение использует браузер для перехода на конечную точку авторизации платформы идентификации Майкрософт, браузер отображает файл cookie, чтобы пользователю не применялись для входа. Это также способ достижения единого входа. Файл cookie создается в Azure AD и может быть понятен только в Azure AD.
* Затем веб-приложение проверяет маркер. Если проверка будет выполнена, веб-приложение отобразит защищенную страницу и сохранит файл cookie сеанса в файле JAR файла cookie браузера. Когда пользователь переходит на другую страницу, веб-приложение знает, что проверка подлинности пользователя выполняется на основе файла cookie сеанса.

Это взаимодействие обобщено на следующей схеме последовательностей:

![процесс проверки подлинности веб-приложения](media/authentication-scenarios/web-app-how-it-appears-to-be.png)

### <a name="how-a-web-app-determines-if-the-user-is-authenticated"></a>Как веб-приложение определяет, прошел ли пользователь проверку подлинности

Разработчики веб-приложений могут указать, требуется ли проверка подлинности для всех или только определенных страниц. Например, в ASP.NET/ASP.NET Core это можно сделать, добавив `[Authorize]` атрибут к действиям контроллера.

Этот атрибут заставляет ASP.NET проверять наличие файла cookie сеанса, содержащего идентификатор пользователя. Если файл cookie отсутствует, ASP.NET перенаправляет проверку подлинности в указанный поставщик удостоверений. Если поставщиком удостоверений является Azure AD, веб-приложение перенаправляет проверку подлинности в `https://login.microsoftonline.com`, которая отображает диалоговое окно входа.

### <a name="how-a-web-app-delegates-sign-in-to-microsoft-identity-platform-and-obtains-a-token"></a>Как веб-приложение делегирует вход на платформу удостоверений Майкрософт и получает маркер

Проверка подлинности пользователя осуществляется через браузер. Протокол OpenID Connect использует стандартные сообщения протокола HTTP.

* Веб-приложение отправляет в браузер HTTP 302 (Redirect) для использования платформы Microsoft Identity.
* При проверке подлинности пользователя платформа Microsoft Identity отправляет маркер в веб-приложение с помощью перенаправления через браузер.
* Перенаправление предоставляется веб-приложением в форме URI перенаправления. Этот URI перенаправления зарегистрирован в объекте приложения Azure AD. Может существовать несколько URI перенаправления, поскольку приложение может быть развернуто по нескольким URL-адресам. Поэтому веб-приложению также потребуется указать URI перенаправления для использования.
* Azure AD проверяет, что URI перенаправления, отправленный веб-приложением, является одним из зарегистрированных URI перенаправления для приложения.

## <a name="desktop-and-mobile-app-sign-in-flow-with-microsoft-identity-platform"></a>Поток входа настольных и мобильных приложений с платформой Microsoft Identity

Описанный выше поток применим и с незначительными отличиями к настольным и мобильным приложениям.

Для проверки подлинности настольные и мобильные приложения могут использовать встроенный веб-элемент управления или системный браузер. На следующей схеме показано, как настольное или мобильное приложение использует библиотеку проверки подлинности Майкрософт (MSAL) для получения маркеров доступа и вызова веб-API.

![Настольное приложение, как оно выглядит](media/authentication-scenarios/desktop-app-how-it-appears-to-be.png)

MSAL использует браузер для получения маркеров. Как и в случае с веб-приложениями, проверка подлинности делегируется на платформу Microsoft Identity.

Так как Azure AD сохраняет в браузере тот же файл cookie удостоверения, что и для веб-приложений, если в собственном или мобильном приложении используется системный браузер, он немедленно получит единый вход с соответствующим веб-приложением.

По умолчанию MSAL использует системный браузер. Исключением является .NET Framework классических приложений, где внедренный элемент управления обеспечивает более тесное взаимодействие с пользователем.

## <a name="next-steps"></a>Следующие шаги

* Общие термины см. в [глоссарии разработчика платформы удостоверений Майкрософт](developer-glossary.md) .
* Дополнительные сведения о других сценариях проверки подлинности пользователей, поддерживаемых платформой идентификации Майкрософт, см. в статье [потоки проверки подлинности и сценарии приложений](authentication-flows-app-scenarios.md) .
* Сведения о библиотеках Майкрософт, которые помогут разрабатывать приложения, работающие с учетными записями Майкрософт, учетными записями Azure AD, а также Azure AD B2C пользователями в единой и простой модели программирования, см. в разделе [библиотеки MSAL](msal-overview.md) .
* Сведения о настройке проверки подлинности для приложения службы приложений см. в статье [Интеграция службы приложений с платформой Microsoft Identity](/azure/app-service/configure-authentication-provider-aad) .
