---
title: Использование веб-браузеров (MSAL.NET) Azure
titleSuffix: Microsoft identity platform
description: Узнайте о конкретных соображениях при использовании Xamarin Android в библиотеке подлинности Microsoft для .NET (MSAL.NET).
services: active-directory
author: mmacy
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 07/16/2019
ms.author: marsma
ms.reviewer: saeeda
ms.custom: aaddev
ms.openlocfilehash: ed1f47ae99f6346a932d0fe94be7586dc25a672f
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79262741"
---
# <a name="using-web-browsers-msalnet"></a>Использование веб-браузеров (MSAL.NET)

Веб-браузеры необходимы для интерактивной аутентификации. По умолчанию MSAL.NET поддерживает [системный веб-браузер](#system-web-browser-on-xamarinios-xamarinandroid) на Xamarin.iOS и Xamarin.Android. Но [вы также можете включить встроенный веб-браузер](#enable-embedded-webviews-on-ios-and-android) в зависимости от ваших требований (UX, необходимость в одном входе (SSO), безопасность) в [приложениях Xamarin.iOS](#choosing-between-embedded-web-browser-or-system-browser-on-xamarinios) и [Xamarin.Android.](#detecting-the-presence-of-custom-tabs-on-xamarinandroid) И вы даже можете [выбрать динамически,](#detecting-the-presence-of-custom-tabs-on-xamarinandroid) какой веб-браузер для использования на основе наличия Chrome или браузер поддержки Chrome пользовательских вкладок в Android. MSAL.NET поддерживает системный браузер только в настольных приложениях .NET Core Core.

## <a name="web-browsers-in-msalnet"></a>Веб-браузеры в MSAL.NET

### <a name="interaction-happens-in-a-web-browser"></a>Взаимодействие происходит в веб-браузере

Важно понимать, что при приобретении токенов в интерактивном режиме содержимое диалогового окна предоставляется не библиотекой, а STS (Security Token Service). Конечная точка проверки подлинности отправляет обратно некоторые HTML и JavaScript, который контролирует взаимодействие, которое отображается в веб-браузере или веб-контроле. Разрешение СТС обрабатывать HTML взаимодействия имеет много преимуществ:

- Пароль (если один из них был набран) никогда не хранится ни приложением, ни библиотекой аутентификации.
- Позволяет перенаправить на других поставщиков идентификационных данных (например, вход в систему с учетной записью рабочей школы или личной учетной записью в MSAL, или с социальной учетной записью с Azure AD B2C).
- Позволяет управлять STS Условный доступ, например, имея пользователя делать несколько факторов проверки подлинности (MFA) на этапе проверки подлинности (ввод контакта Windows Hello, или вызова на свой телефон, или на приложение аутентификации на своем телефоне). В тех случаях, когда требуемая многофакторная аутентификация еще не настроена, пользователь может настроить ее как раз вовремя в том же диалоге.  Пользователь вводит свой номер мобильного телефона и руководствуется, чтобы установить приложение проверки подлинности и сканировать тег кр, чтобы добавить свою учетную запись. Этот сервер управляемых взаимодействия большой опыт!
- Позволяет пользователю изменить свой пароль в этом же диалоге, когда пароль истек (предоставление дополнительных полей для старого пароля и нового пароля).
- Позволяет заклеймить клиента или приложение (изображения), контролируемое админ-амином AD Azure AD/ владельцем приложения.
- Позволяет пользователям дать согласие на доступ к ресурсам/примкам приложения от их имени сразу после проверки подлинности.

### <a name="embedded-vs-system-web-ui"></a>Встроенный против системы веб-uI

MSAL.NET является многопрофильной библиотекой и имеет фреймворковый код для размещения браузера в элементе управления пользовательским интерфейсом (например, на .Net Classic он использует WinForms, на Xamarin он использует нативные мобильные элементы управления и т.д.). Этот элемент `embedded` управления называется веб-uI. Кроме того, MSAL.NET также может начать систему ОС браузера.

Как правило, рекомендуется использовать платформу по умолчанию, и это, как правило, системный браузер. Системный браузер лучше запоминает пользователей, которые вошли в систему раньше. Если вам необходимо изменить это поведение, используйте`WithUseEmbeddedWebView(bool)`

### <a name="at-a-glance"></a>Вкратце

| FRAMEWORK        | Внедренный | Система | Значение по умолчанию |
| ------------- |-------------| -----| ----- |
| .NET Классика     | Да | Да | Внедренный |
| .NET Core     | нет | Да | Система |
| .NET Standard | нет | Да | Система |
| UWP | Да | нет | Внедренный |
| Xamarin.Android | Да | Да  | Система |
| Xamarin.iOS | Да | Да  | Система |
| Xamarin.Mac| Да | нет | Внедренный |

Требует "http://localhostперенаправить URI

## <a name="system-web-browser-on-xamarinios-xamarinandroid"></a>Системный веб-браузер на Xamarin.iOS, Xamarin.Android

По умолчанию MSAL.NET поддерживает системный веб-браузер на Xamarin.iOS, Xamarin.Android и .NET Core. Для всех платформ, предоставляющих uI (т.е. не .NET Core), диалог обеспечивается библиотекой, встраивающей элемент управления веб-браузером. MSAL.NET также использует встроенный веб-вид для рабочего стола .NET и WAB для платформы UWP. Тем не менее, он использует по умолчанию **системный веб-браузер** для приложений Xamarin iOS и Xamarin Android. На iOS он даже выбирает веб-представление для использования в зависимости от версии операционной системы (iOS12, iOS11 и ранее).

Использование системного браузера имеет значительное преимущество совместного использования состояния SSO с другими приложениями и с веб-приложениями без необходимости брокера (портал компании / Authenticator). Системный браузер использовался, по умолчанию, в MSAL.NET для платформ Xamarin iOS и Xamarin Android, потому что на этих платформах веб-браузер системы занимает весь экран, и пользовательский опыт лучше. Веб-представление системы не отличается от диалога. На iOS, однако, пользователь, возможно, придется дать согласие на браузер, чтобы перезвонить в приложение, которое может раздражать.

## <a name="system-browser-experience-on-net-core"></a>Опыт системного браузера на ядро .NET

На .NET Core MSAL.NET запустит системный браузер как отдельный процесс. MSAL.NET не имеет контроля над этим браузером, но как только пользователь заканчивает аутентификацию, веб-страница перенаправляется таким образом, что MSAL.NET можете перехватить Uri.

Вы также можете настроить приложения, написанные для .NET Classic, чтобы использовать этот браузер, указав

```csharp
await pca.AcquireTokenInteractive(s_scopes)
         .WithUseEmbeddedWebView(false)
```

MSAL.NET не можете определить, если пользователь перемещается или просто закрывает браузер. Приложениям, использующим этот метод, рекомендуется `CancellationToken`определить тайм-аут (через). Мы рекомендуем тайм-аут, по крайней мере несколько минут, чтобы принять во внимание случаи, когда пользователю предлагается изменить пароль или выполнить многофакторную аутентификацию.

### <a name="how-to-use-the-default-os-browser"></a>Как использовать браузер ОС по умолчанию

MSAL.NET должен прослушивать `http://localhost:port` и перехватывать код, который AAD отправляет при проверке подлинности пользователя (см. код [авторизации](v2-oauth2-auth-code-flow.md) для деталей)

Для включения системного браузера:

1. Во время регистрации `http://localhost` приложения, настроить как перенаправление uri (в настоящее время не поддерживается B2C)
2. При построении приложения PublicClientApplication укажите это перенаправление:

```csharp
IPublicClientApplication pca = PublicClientApplicationBuilder
                            .Create("<CLIENT_ID>")
                             // or use a known port if you wish "http://localhost:1234"
                            .WithRedirectUri("http://localhost")  
                            .Build();
```

> [!Note]
> Если вы `http://localhost`настраиваете, внутренне MSAL.NET найдете случайный открытый порт и использовать его.

### <a name="linux-and-mac"></a>Linux и MAC

На Linux, MSAL.NET откроет браузер ОС по умолчанию с помощью xdg-открытый инструмент. Для устранения неполадок запустите инструмент с терминала, например,`xdg-open "https://www.bing.com"`  
На Mac браузер открывается путем`open <url>`

### <a name="customizing-the-experience"></a>Настройка опыта

> [!NOTE]
> Настройка доступна в MSAL.NET 4.1.0 или позже.

MSAL.NET может ответить сообщением HTTP при получении токена или в случае ошибки. Вы можете отобразить HTML-сообщение или перенаправить на URL по вашему выбору:

```csharp
var options = new SystemWebViewOptions() 
{
    HtmlMessageError = "<p> An error occured: {0}. Details {1}</p>",
    BrowserRedirectSuccess = new Uri("https://www.microsoft.com");
}

await pca.AcquireTokenInteractive(s_scopes)
         .WithUseEmbeddedWebView(false)
         .WithSystemWebViewOptions(options)
         .ExecuteAsync();
```

### <a name="opening-a-specific-browser-experimental"></a>Открытие конкретного браузера (экспериментальный)

Вы можете настроить способ MSAL.NET открывает браузер. Например, вместо того, чтобы использовать любой браузер по умолчанию, вы можете заставить открыть определенный браузер:

```csharp
var options = new SystemWebViewOptions() 
{
    OpenBrowserAsync = SystemWebViewOptions.OpenWithEdgeBrowserAsync
}
```

### <a name="uwp-doesnt-use-the-system-webview"></a>UWP не использует системный веб-вью

Для настольных приложений, однако, запуск системы Webview приводит к subpar пользовательский опыт, как пользователь видит браузер, где они, возможно, уже другие вкладки открыты. И когда проверка подлинности произошла, пользователи получают страницу с просьбой закрыть это окно. Если пользователь не обращает внимания, он может закрыть весь процесс (включая другие вкладки, не связанные с аутентификацией). Использование системного браузера на рабочем столе также потребует открытия локальных портов и прослушивания на них, что может потребовать расширенных разрешений для приложения. Вы, как разработчик, пользователь или администратор, можете неохотно относиться к этому требованию.

## <a name="enable-embedded-webviews-on-ios-and-android"></a>Включить встроенные веб-просмотры на iOS и Android

Вы также можете включить встроенные веб-просмотры в приложениях Xamarin.iOS и Xamarin.Android. Начиная с MSAL.NET 2.0.0-предварительный просмотр, MSAL.NET также поддерживает использование **встроенного** варианта веб-вью. Для ADAL.NET, встроенный веб-вью является единственным поддерживаемым вариантом.

Как разработчик, использующий MSAL.NET таргетингx Xamarin, вы можете использовать либо встроенные веб-просмотры, либо системные браузеры. Это ваш выбор в зависимости от пользовательского опыта и проблем безопасности, на которые вы хотите ориентироваться.

В настоящее время MSAL.NET пока не поддерживает брокеров Android и iOS. Поэтому, если вам нужно предоставить единый ввод (SSO), системный браузер все еще может быть лучшим вариантом. Поддержка брокеров со встроенным веб-браузером находится на MSAL.NET отставание.

### <a name="differences-between-embedded-webview-and-system-browser"></a>Различия между встроенным веб-вью и системным браузером
Есть некоторые визуальные различия между встроенным веб-вью и системным браузером в MSAL.NET.

**Интерактивный входе с MSAL.NET с помощью встроенного Webview:**

![внедренного](media/msal-net-web-browsers/embedded-webview.png)

**Интерактивный входе с MSAL.NET с помощью системного браузера:**

![Системный браузер](media/msal-net-web-browsers/system-browser.png)

### <a name="developer-options"></a>Параметры разработчика

Как разработчик, использующий MSAL.NET, у вас есть несколько вариантов отображения интерактивного диалога от STS:

- **Системный браузер.** Системный браузер устанавливается по умолчанию в библиотеке. При использовании Android читайте [системные браузеры](msal-net-system-browser-android-considerations.md) для получения конкретной информации о том, какие браузеры поддерживаются для проверки подлинности. При использовании системного браузера в Android, мы рекомендуем устройство имеет браузер, который поддерживает Chrome пользовательских вкладок.  В противном случае проверка подлинности может быть отклонена.
- **Встроенный веб-вью.** Чтобы использовать только встроенный веб-винопредставлениев в MSAL.NET, `AcquireTokenInteractively` в составе параметров содержится `WithUseEmbeddedWebView()` метод.

    iOS

    ```csharp
    AuthenticationResult authResult;
    authResult = app.AcquireTokenInteractively(scopes)
                    .WithUseEmbeddedWebView(useEmbeddedWebview)
                    .ExecuteAsync();
    ```

    Android:

    ```csharp
    authResult = app.AcquireTokenInteractively(scopes)
                .WithParentActivityOrWindow(activity)
                .WithUseEmbeddedWebView(useEmbeddedWebview)
                .ExecuteAsync();
    ```

#### <a name="choosing-between-embedded-web-browser-or-system-browser-on-xamarinios"></a>Выбор между встроенным веб-браузером или системным браузером на Xamarin.iOS

В вашем приложении `AppDelegate.cs` iOS, в `ParentWindow` `null`вас можно инициализировать к . Он не используется в iOS

```csharp
App.ParentWindow = null; // no UI parent on iOS
```

#### <a name="choosing-between-embedded-web-browser-or-system-browser-on-xamarinandroid"></a>Выбор между встроенным веб-браузером или системным браузером на Xamarin.Android

В вашем приложении `MainActivity.cs` для Android можно настроить родительскую активность, чтобы результат проверки подлинности вернулся к нему:

```csharp
 App.ParentWindow = this;
```

Затем в `MainPage.xaml.cs`:

```csharp
authResult = await App.PCA.AcquireTokenInteractive(App.Scopes)
                      .WithParentActivityOrWindow(App.ParentWindow)
                      .WithUseEmbeddedWebView(true)
                      .ExecuteAsync();
```

#### <a name="detecting-the-presence-of-custom-tabs-on-xamarinandroid"></a>Обнаружение наличия пользовательских вкладок на Xamarin.Android

Если вы хотите использовать веб-браузер системы для включения SSO с приложениями, работающими в браузере, но беспокоитесь о пользовательском опыте `IPublicClientApplication`для устройств Android, не имеющих браузера с пользовательской поддержкой вкладок, у вас есть возможность принять решение, позвонив в `IsSystemWebViewAvailable()` метод. Этот метод `true` возвращается, если PackageManager `false` обнаруживает пользовательские вкладки и если они не обнаружены на устройстве.

На основе значения, возвращенного этим методом, и ваших требований, вы можете принять решение:

- Пользователь может вернуть пользовательское сообщение об ошибке. Например: "Пожалуйста, установите Chrome, чтобы продолжить проверку подлинности" -OR-
- Вы можете вернуться к встроенной опции веб-вью и запустить uI в качестве встроенного веб-вью.

В приведенном ниже коде показана встроенная опция веб-вью:

```csharp
bool useSystemBrowser = app.IsSystemWebviewAvailable();

authResult = await App.PCA.AcquireTokenInteractive(App.Scopes)
                      .WithParentActivityOrWindow(App.ParentWindow)
                      .WithUseEmbeddedWebView(!useSystemBrowser)
                      .ExecuteAsync();
```

#### <a name="net-core-doesnt-support-interactive-authentication-with-an-embedded-browser"></a>Ядро .NET не поддерживает интерактивную аутентификацию со встроенным браузером

Для .NET Core приобретение токенов в интерактивном режиме доступно только через веб-браузер системы, а не со встроенными веб-представлениями. Действительно, .NET Core пока не предоставляет uI.
Если вы хотите настроить просмотр с помощью веб-браузера системы, вы можете реализовать интерфейс [IWithCustomUI](scenario-desktop-acquire-token.md#withcustomwebui) и даже предоставить свой собственный браузер.
