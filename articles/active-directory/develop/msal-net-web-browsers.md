---
title: Использование веб-браузеров (MSAL.NET) | Службы
titleSuffix: Microsoft identity platform
description: Ознакомьтесь с конкретными соображениями при использовании Xamarin Android с библиотекой проверки подлинности Майкрософт для .NET (MSAL.NET).
services: active-directory
author: mmacy
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 07/16/2019
ms.author: marsma
ms.reviewer: saeeda
ms.custom: aaddev
ms.openlocfilehash: ed1f47ae99f6346a932d0fe94be7586dc25a672f
ms.sourcegitcommit: cfbea479cc065c6343e10c8b5f09424e9809092e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2020
ms.locfileid: "77084599"
---
# <a name="using-web-browsers-msalnet"></a>Использование веб-браузеров (MSAL.NET)

Для интерактивной проверки подлинности требуются веб-браузеры. По умолчанию MSAL.NET поддерживает [системный веб-браузер](#system-web-browser-on-xamarinios-xamarinandroid) для Xamarin. iOS и Xamarin. Android. Но [вы также можете включить встроенный веб-браузер](#enable-embedded-webviews-on-ios-and-android) в зависимости от ваших требований (UX, необходимость единого входа (SSO), безопасность) в приложениях [Xamarin. iOS](#choosing-between-embedded-web-browser-or-system-browser-on-xamarinios) и [Xamarin. Android](#detecting-the-presence-of-custom-tabs-on-xamarinandroid) . Кроме того, можно [выбрать динамически](#detecting-the-presence-of-custom-tabs-on-xamarinandroid) используемый веб-браузер в зависимости от наличия Chrome или браузера, поддерживающего настраиваемые вкладки Chrome в Android. MSAL.NET поддерживает только браузер системы в классических приложениях .NET Core.

## <a name="web-browsers-in-msalnet"></a>Веб-браузеры в MSAL.NET

### <a name="interaction-happens-in-a-web-browser"></a>Взаимодействие происходит в веб-браузере

Важно понимать, что при получении маркера в интерактивном режиме содержимое диалогового окна не предоставляется библиотекой, а STS (служба маркеров безопасности). Конечная точка аутентификации отправляет обратно некоторые HTML и JavaScript, которые управляют взаимодействием, отображаемым в веб-браузере или веб-элементе управления. Разрешение STS на обработку взаимодействия HTML имеет много преимуществ:

- Пароль (если он был введен) никогда не хранится приложением или библиотекой проверки подлинности.
- Включает перенаправления для других поставщиков удостоверений (например, для входа в учетную запись рабочего учебного заведения или личную учетную запись с помощью MSAL или с учетной записью социальных сетей с Azure AD B2C).
- Позволяет службе STS управлять условным доступом, например, если пользователь выполняет многофакторную проверку подлинности (MFA) на этапе аутентификации (ввод ПИН-кода Windows Hello или вызов на телефоне или на приложении проверки подлинности на телефоне). В тех случаях, когда требуемая многофакторная проверка подлинности еще не настроена, пользователь может настроить ее по времени в том же диалоговом окне.  Пользователь вводит свой номер мобильного телефона и поступает к установке приложения проверки подлинности и сканированию QR-тега для добавления учетной записи. Такое взаимодействие, управляемое сервером, — отличная работа!
- Позволяет пользователю изменить свой пароль в этом диалоговом окне, когда истек срок действия пароля (при этом для старого пароля и нового пароля предоставляются дополнительные поля).
- Включение фирменной символики клиента или приложения (образов), контролируемого администратором или владельцем приложения клиента Azure AD.
- Дает пользователям разрешение на предоставление приложению доступа к ресурсам и областям в своем имени сразу после проверки подлинности.

### <a name="embedded-vs-system-web-ui"></a>Встроенный веб-интерфейс VS System

MSAL.NET является библиотекой с несколькими платформами и имеет код, зависящий от платформы, для размещения браузера в элементе управления пользовательского интерфейса (например, на классическом языке .NET использует WinForms, в Xamarin он использует собственные мобильные элементы управления и т. д.). Этот элемент управления называется `embedded` веб-интерфейс. Кроме того, MSAL.NET также может запускать обозреватель системных ОС.

Как правило, рекомендуется использовать платформу по умолчанию, и обычно это системный браузер. Обозреватель системы лучше запомнить пользователей, выполнивших вход. Если необходимо изменить это поведение, используйте `WithUseEmbeddedWebView(bool)`

### <a name="at-a-glance"></a>Вкратце

| FRAMEWORK        | Внедренный | Система | По умолчанию |
| ------------- |-------------| -----| ----- |
| Классическая платформа .NET     | Да | Да ^ | Внедренный |
| .NET Core     | нет | Да ^ | Система |
| .NET Standard | нет | Да ^ | Система |
| UWP | Да | нет | Внедренный |
| Xamarin.Android | Да | Да  | Система |
| Xamarin.iOS | Да | Да  | Система |
| Xamarin. Mac| Да | нет | Внедренный |

Для ^ требуется "http://localhost" URI перенаправления

## <a name="system-web-browser-on-xamarinios-xamarinandroid"></a>Системный веб-браузер в Xamarin. iOS, Xamarin. Android

По умолчанию MSAL.NET поддерживает системный веб-браузер для Xamarin. iOS, Xamarin. Android и .NET Core. Для всех платформ, предоставляющих пользовательский интерфейс (то есть не .NET Core), диалоговое окно предоставляется библиотекой, внедренной в элемент управления веб-браузера. MSAL.NET также использует встроенное веб-представление для настольных систем .NET и WAB для платформы UWP. Однако он использует по умолчанию **системный веб-браузер** для приложений Xamarin iOS и Xamarin Android. В iOS он даже выбирает веб-представление для использования в зависимости от версии операционной системы (iOS12, iOS11 и более ранних версий).

Использование системного браузера значительно выгодно совместное использование состояния единого входа с другими приложениями и веб-приложениями без необходимости брокера (корпоративного портала или средства проверки подлинности). По умолчанию в MSAL.NET для платформ Xamarin iOS и Xamarin Android использовался браузер системы, поскольку на этих платформах системный веб-браузер занимает весь экран, а взаимодействие с пользователем лучше. Системное веб-представление не является различимым в диалоговом окне. Однако в iOS пользователю может потребоваться предоставить согласие на вызов приложения в браузере, что может раздражать.

## <a name="system-browser-experience-on-net-core"></a>Взаимодействие с браузером в .NET Core

В .NET Core MSAL.NET запустит системный браузер как отдельный процесс. MSAL.NET не имеет контроля над этим браузером, но после того, как пользователь завершит проверку подлинности, веб-страница перенаправляется таким образом, что MSAL.NET может перехватить универсальный код ресурса (URI).

Вы также можете настроить приложения, написанные для классической платформы .NET, чтобы использовать этот браузер, указав

```csharp
await pca.AcquireTokenInteractive(s_scopes)
         .WithUseEmbeddedWebView(false)
```

MSAL.NET не может определить, выполняет ли пользователь отменяет или просто закрывает браузер. Для приложений, использующих этот прием, рекомендуется определить время ожидания (через `CancellationToken`). Рекомендуется не менее нескольких минут, чтобы учитывать случаи, когда пользователю предлагается изменить пароль или выполнить многофакторную проверку подлинности.

### <a name="how-to-use-the-default-os-browser"></a>Использование браузера ОС по умолчанию

MSAL.NET должен прослушивать `http://localhost:port` и перехватывать код, который AAD отправляет после проверки подлинности пользователя (см. раздел [код авторизации](v2-oauth2-auth-code-flow.md) для получения дополнительных сведений).

Чтобы включить системный браузер, выполните следующие действия.

1. Во время регистрации приложения настройте `http://localhost` как URI перенаправления (в настоящее время не поддерживается B2C)
2. При создании Публикклиентаппликатион укажите этот URI перенаправления:

```csharp
IPublicClientApplication pca = PublicClientApplicationBuilder
                            .Create("<CLIENT_ID>")
                             // or use a known port if you wish "http://localhost:1234"
                            .WithRedirectUri("http://localhost")  
                            .Build();
```

> [!Note]
> При настройке `http://localhost`внутренне MSAL.NET найдет случайный открытый порт и будет использовать его.

### <a name="linux-and-mac"></a>Linux и MAC

В Linux MSAL.NET будет открывать браузер ОС по умолчанию с помощью средства xdg-Open. Чтобы устранить неполадки, запустите средство из терминала, например `xdg-open "https://www.bing.com"`  
На компьютере Mac браузер открывается путем вызова `open <url>`

### <a name="customizing-the-experience"></a>Настройка интерфейса

> [!NOTE]
> Настройка доступна в MSAL.NET 4.1.0 или более поздней версии.

MSAL.NET может ответить HTTP-сообщением при получении маркера или в случае ошибки. Можно отобразить HTML-сообщение или перенаправить URL-адрес по своему усмотрению:

```csharp
var options = new SystemWebViewOptions() 
{
    HtmlMessageError = "<p> An error occured: {0}. Details {1}</p>",
    BrowserRedirectSuccess = new Uri("https://www.microsoft.com");
}

await pca.AcquireTokenInteractive(s_scopes)
         .WithUseEmbeddedWebView(false)
         .WithSystemWebViewOptions(options)
         .ExecuteAsync();
```

### <a name="opening-a-specific-browser-experimental"></a>Открытие конкретного браузера (экспериментальный)

Вы можете настроить способ, которым MSAL.NET открывает браузер. Например, вместо использования любого браузера по умолчанию можно принудительно открыть конкретный браузер:

```csharp
var options = new SystemWebViewOptions() 
{
    OpenBrowserAsync = SystemWebViewOptions.OpenWithEdgeBrowserAsync
}
```

### <a name="uwp-doesnt-use-the-system-webview"></a>UWP не использует System WebView

Однако для настольных приложений Запуск системы WebView приводит к субпар взаимодействия с пользователем, так как пользователь видит браузер, где у них уже могут быть открытые вкладки. Если проверка подлинности выполнена, пользователи получают страницу с просьбой закрыть это окно. Если пользователь не имеет особого внимания, он может закрыть весь процесс (в том числе другие вкладки, которые не связаны с проверкой подлинности). При использовании системного браузера на рабочем столе также потребуется открыть локальные порты и прослушивать их, что может потребовать дополнительных разрешений для приложения. Вы, как разработчик, пользователь или администратор, могут быть неохотно об этом требовании.

## <a name="enable-embedded-webviews-on-ios-and-android"></a>Включение встроенных представлений в iOS и Android

Встроенные веб – представления также можно включить в приложениях Xamarin. iOS и Xamarin. Android. Начиная с MSAL.NET 2.0.0-Preview, MSAL.NET также поддерживает использование параметра **Embedded** WebView. Для ADAL.NET поддерживается только параметр Embedded WebView.

Как разработчик, использующий MSAL.NET, предназначенный для Xamarin, вы можете использовать внедренные представления или системные браузеры. Это можно выбрать в зависимости от того, какие аспекты работы пользователя и безопасности вы хотите ориентировать.

Сейчас MSAL.NET еще не поддерживает брокеры Android и iOS. Поэтому, если необходимо обеспечить единый вход (SSO), обозреватель системы может быть лучшим вариантом. Вспомогательные брокеры с внедренным веб-браузером находятся в MSAL.NET невыполненной работы.

### <a name="differences-between-embedded-webview-and-system-browser"></a>Различия между встроенными WebView и браузером системы
Между внедренными WebView и системным браузером в MSAL.NET есть некоторые визуальные различия.

**Интерактивный вход с помощью MSAL.NET с внедренным WebView:**

![внедренные](media/msal-net-web-browsers/embedded-webview.png)

**Интерактивный вход с MSAL.NET с помощью браузера системы:**

![Браузер системы](media/msal-net-web-browsers/system-browser.png)

### <a name="developer-options"></a>Параметры разработчика

Как разработчик, использующий MSAL.NET, у вас есть несколько вариантов отображения интерактивного диалогового окна от STS:

- **Системный браузер.** Браузер системы по умолчанию задан в библиотеке. При использовании Android ознакомьтесь с [системными браузерами](msal-net-system-browser-android-considerations.md) для получения конкретных сведений о том, какие браузеры поддерживают проверку подлинности. При использовании системного браузера в Android рекомендуется использовать для устройства браузер, поддерживающий настраиваемые вкладки Chrome.  В противном случае проверка подлинности может завершиться ошибкой.
- **Внедренный WebView.** Чтобы использовать только внедренные WebView в MSAL.NET, построитель параметров `AcquireTokenInteractively` содержит метод `WithUseEmbeddedWebView()`.

    iOS

    ```csharp
    AuthenticationResult authResult;
    authResult = app.AcquireTokenInteractively(scopes)
                    .WithUseEmbeddedWebView(useEmbeddedWebview)
                    .ExecuteAsync();
    ```

    Android:

    ```csharp
    authResult = app.AcquireTokenInteractively(scopes)
                .WithParentActivityOrWindow(activity)
                .WithUseEmbeddedWebView(useEmbeddedWebview)
                .ExecuteAsync();
    ```

#### <a name="choosing-between-embedded-web-browser-or-system-browser-on-xamarinios"></a>Выбор между внедренным веб-браузером или системным браузером в Xamarin. iOS

В приложении iOS в `AppDelegate.cs` можно инициализировать `ParentWindow` для `null`. Он не используется в iOS

```csharp
App.ParentWindow = null; // no UI parent on iOS
```

#### <a name="choosing-between-embedded-web-browser-or-system-browser-on-xamarinandroid"></a>Выбор между внедренным веб-браузером или системным браузером в Xamarin. Android

В приложении Android в `MainActivity.cs` можно задать родительское действие, чтобы результат проверки подлинности был возвращен к нему:

```csharp
 App.ParentWindow = this;
```

Затем в `MainPage.xaml.cs`:

```csharp
authResult = await App.PCA.AcquireTokenInteractive(App.Scopes)
                      .WithParentActivityOrWindow(App.ParentWindow)
                      .WithUseEmbeddedWebView(true)
                      .ExecuteAsync();
```

#### <a name="detecting-the-presence-of-custom-tabs-on-xamarinandroid"></a>Обнаружение наличия пользовательских вкладок в Xamarin. Android

Если вы хотите использовать системный веб-браузер для включения единого входа с приложениями, работающими в браузере, но не беспокоитесь о пользовательском интерфейсе для устройств Android без поддержки настраиваемой вкладки, можно выбрать вызов метода `IsSystemWebViewAvailable()` в `IPublicClientApplication`. Этот метод возвращает `true`, если PackageManager обнаруживает пользовательские вкладки и `false`, если они не обнаружены на устройстве.

В зависимости от значения, возвращаемого этим методом, и ваших требований можно принять решение:

- Пользователь может вернуть пользователю пользовательское сообщение об ошибке. Например: "установите Chrome, чтобы продолжить проверку подлинности"-или-
- Можно вернуться к внедренному параметру WebView и запустить пользовательский интерфейс как внедренный WebView.

В приведенном ниже коде показан внедренный параметр WebView:

```csharp
bool useSystemBrowser = app.IsSystemWebviewAvailable();

authResult = await App.PCA.AcquireTokenInteractive(App.Scopes)
                      .WithParentActivityOrWindow(App.ParentWindow)
                      .WithUseEmbeddedWebView(!useSystemBrowser)
                      .ExecuteAsync();
```

#### <a name="net-core-doesnt-support-interactive-authentication-with-an-embedded-browser"></a>.NET Core не поддерживает интерактивную проверку подлинности с помощью встроенного браузера

Для .NET Core получение маркеров в интерактивном режиме доступно только через веб-браузер системы, а не с внедренными веб-представлениями. Действительно, .NET Core пока не предоставляет пользовательский интерфейс.
Если вы хотите настроить интерфейс для просмотра с помощью системного веб-браузера, вы можете реализовать интерфейсы [ивискустомуи](scenario-desktop-acquire-token.md#withcustomwebui) и даже предоставить собственный браузер.
