---
title: Вопиющий с грантом учетных данных владельца паролей владельца ресурса (ru) Azure
titleSuffix: Microsoft identity platform
description: Поддержка потоков проверки подлинности браузера с помощью гранта владельца паролей (ROPC).
services: active-directory
documentationcenter: ''
author: rwike77
manager: CelesteDG
editor: ''
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 11/19/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.openlocfilehash: b935ad2491ca486a3bc6878f0332e5390600b1bc
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76700691"
---
# <a name="microsoft-identity-platform-and-oauth-20-resource-owner-password-credentials"></a>Платформа идентификации Майкрософт и учетные данные владельца ресурсов OAuth 2.0

Платформа майкрософт поддерживает [грант владельца ресурсов OAuth 2.0 (ROPC),](https://tools.ietf.org/html/rfc6749#section-4.3)который позволяет приложению войти в систему пользователя, непосредственно обрабатывая свой пароль.  В этой статье описывается, как запрограммировать непосредственно против протокола в приложении.  Когда это возможно, мы рекомендуем вам использовать поддерживаемые библиотеки подлинности Майкрософт (MSAL) вместо того, чтобы [приобретать токены и вызывать защищенные web-aIS.](authentication-flows-app-scenarios.md#scenarios-and-supported-authentication-flows)  Также взгляните на [образец приложений, которые используют MSAL](sample-v2-code.md).

> [!WARNING]
> Корпорация Майкрософт рекомендует _не_ использовать поток ROPC. В большинстве сценариев доступны и рекомендуются более безопасные альтернативы. Этот поток требует очень высокой степени доверия к приложению и несет в себе риски, которых нет в других потоках. Этот поток следует использовать только тогда, когда другие, более безопасные потоки не могут быть использованы.

> [!IMPORTANT]
>
> * Конечная точка идентификационных платформ Майкрософт поддерживает ROPC только для арендаторов Azure AD, а не для личных учетных записей. Это означает, что придется использовать конечную точку клиента (`https://login.microsoftonline.com/{TenantId_or_Name}`) или конечную точку `organizations`.
> * Пользователи личных учетных записей, приглашенные в клиент Azure AD, не могут использовать ROPC.
> * Пользователи учетных записей без пароля не смогут войти в систему через ROPC. Для таких случаев мы рекомендуем использовать для приложения другой поток.
> * Если пользователи должны использовать для входа в приложение многофакторную проверку подлинности (MFA), они будут заблокированы.
> * ROPC не поддерживается в [сценариях гибридной федерации идентификационных данных](/azure/active-directory/hybrid/whatis-fed) (например, Azure AD и ADFS, используемые для проверки подлинности учетных записей). Если пользователи перенаправляются на сайт провайдеров идентификации, Azure AD не может протестировать имя пользователя и пароль в отношении этого поставщика идентификационных данных. [Однако сквозная аутентификация](/azure/active-directory/hybrid/how-to-connect-pta) поддерживается ROPC.

## <a name="protocol-diagram"></a>Схема протокола

На следующей схеме показано представление потока ROPC.

![Диаграмма, показывающая поток учетных данных владельца паролей ресурса](./media/v2-oauth2-ropc/v2-oauth-ropc.svg)

## <a name="authorization-request"></a>Запрос авторизации

Поток ROPC — это единый запрос: он отправляет идентификацию клиента и учетные данные пользователя в ВПЛ, а затем получает токены взамен. Перед этим клиент должен получить от пользователя адрес электронной почты (или другое имя участника-пользователя) и пароль. Сразу после успешного выполнения запроса клиент обязан безопасно удалить из памяти учетные данные пользователя. Ни в коем случае нельзя сохранять их.

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman.
> [![Попробуйте запустить этот запрос в Postman](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)


```
// Line breaks and spaces are for legibility only.  This is a public client, so no secret is required. 

POST {tenant}/oauth2/v2.0/token
Host: login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&scope=user.read%20openid%20profile%20offline_access
&username=MyUsername@myTenant.com
&password=SuperS3cret
&grant_type=password
```

| Параметр | Условие | Описание |
| --- | --- | --- |
| `tenant` | Обязательно | Клиент каталога, в который пользователь выполняет вход. Его можно указать в виде GUID или понятного имени. Этот параметр не может иметь значение `common` или `consumers`, но может быть равен `organizations`. |
| `client_id` | Обязательно | Идентификатор приложения (клиента), который имеет [сявок портала Azure -](https://go.microsoft.com/fwlink/?linkid=2083908) страница регистраций приложений, назначенная вашему приложению. | 
| `grant_type` | Обязательно | Нужно задать значение `password`. |
| `username` | Обязательно | Адрес электронной почты пользователя. |
| `password` | Обязательно | Пароль пользователя. |
| `scope` | Рекомендуемая | Разделенный пробелами список [областей](v2-permissions-and-consent.md) или разрешений, которые нужны приложению. В интерактивном потоке админ или пользователь должны дать согласие на эти области заранее. |
| `client_secret`| Иногда требуется | Если ваше приложение является публичным `client_secret` `client_assertion` клиентом, то включено или не может быть включено.  Если приложение является конфиденциальным клиентом, то оно должно быть включено. | 
| `client_assertion` | Иногда требуется | Другая `client_secret`форма, генерируемая с помощью сертификата.  Для получения более подробной информации можно ознакомиться с [учетных данных сертификатов.](active-directory-certificate-credentials.md) | 

### <a name="successful-authentication-response"></a>Успешный ответ аутентификации

Следующий пример показывает успешный ответ маркера:

```json
{
    "token_type": "Bearer",
    "scope": "User.Read profile openid email",
    "expires_in": 3599,
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```

| Параметр | Формат | Описание |
| --------- | ------ | ----------- |
| `token_type` | Строка | Всегда имеет значение `Bearer`. |
| `scope` | Строки, разделенные пробелами | Если возвращен маркер доступа, этот параметр содержит список областей, для которых действует этот маркер. |
| `expires_in`| INT | Количество секунд, в течение которых действует предоставленный маркер доступа. |
| `access_token`| Непрозрачная строка | Выдается для запрошенных [областей](v2-permissions-and-consent.md). |
| `id_token` | JWT | Выдается, если исходный параметр `scope` содержит область `openid`. |
| `refresh_token` | Непрозрачная строка | Выдается, если исходный параметр `scope` содержит `offline_access`. |

Вы можете использовать маркер обновления для получения новых маркеров доступа и маркеров обновления с помощью того же потока, который описан в [документации по потоку кода OAuth](v2-oauth2-auth-code-flow.md#refresh-the-access-token).

### <a name="error-response"></a>Сообщение об ошибке

Если пользователь не указал правильное имя пользователя или пароль, либо клиент не получил требуемое согласие, аутентификация завершается ошибкой.

| Error | Описание | Действие клиента |
|------ | ----------- | -------------|
| `invalid_grant` | Сбой аутентификации | Учетные данные указаны неверно или у клиента отсутствует согласие для запрошенных областей. Если области не предоставлены, `consent_required` ошибка будет возвращена. В этом случае клиент должен перенаправить пользователя в интерактивный интерфейс через веб-представление или браузер. |
| `invalid_request` | Запрос был неправильно сформирован | Тип гранта не поддерживается `/common` `/consumers` в контекстах или контекстах проверки подлинности.  Вместо `/organizations` этого используйте или идентификатор клиента. |

## <a name="learn-more"></a>Дополнительные сведения

* Вы можете опробовать ROPC самостоятельно с помощью [примера консольного приложения](https://github.com/azure-samples/active-directory-dotnetcore-console-up-v2).
* Чтобы определить, следует ли использовать конечную точку v2.0, прочитайте об [ограничениях платформы идентификации Майкрософт.](active-directory-v2-limitations.md)
