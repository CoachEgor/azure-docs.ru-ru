---
title: Использование платформы удостоверений Майкрософт для входа пользователей с помощью учетных данных владельца ресурса (РОПК) Grant | Службы
description: Поддержка внебраузерных потоков аутентификации с помощью предоставления пароля владельца ресурса.
services: active-directory
documentationcenter: ''
author: rwike77
manager: CelesteDG
editor: ''
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 11/19/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: e4504a1ae60aaac790ca15c120433159c2ff78fa
ms.sourcegitcommit: d6b68b907e5158b451239e4c09bb55eccb5fef89
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2019
ms.locfileid: "74207769"
---
# <a name="microsoft-identity-platform-and-the-oauth-20-resource-owner-password-credentials"></a>Учетные данные для пароля владельца ресурса OAuth 2,0

Платформа удостоверений Майкрософт поддерживает [учетные данные владельца ресурса OAuth 2,0 (ропк)](https://tools.ietf.org/html/rfc6749#section-4.3), что позволяет приложению входить в систему пользователя, напрямую обрабатывая свой пароль.  В этой статье описывается, как программировать непосредственно по протоколу в приложении.  По возможности рекомендуется использовать поддерживаемые библиотеки проверки подлинности Майкрософт (MSAL) вместо [получения маркеров и вызова защищенных веб-API](authentication-flows-app-scenarios.md#scenarios-and-supported-authentication-flows).  Также ознакомьтесь с [примерами приложений, которые используют MSAL](sample-v2-code.md).

> [!WARNING]
> Корпорация Майкрософт рекомендует _не_ использовать поток ропк. В большинстве случаев доступны и рекомендуются более безопасные альтернативы. Этот поток требует очень высокого уровня доверия в приложении и несет риски, отсутствующие в других потоках. Этот поток следует использовать только в том случае, если нельзя использовать другие более безопасные потоки.

> [!IMPORTANT]
>
> * Конечная точка платформы Microsoft Identity поддерживает только РОПК для клиентов Azure AD, а не для личных учетных записей. Это означает, что придется использовать конечную точку клиента (`https://login.microsoftonline.com/{TenantId_or_Name}`) или конечную точку `organizations`.
> * Пользователи личных учетных записей, приглашенные в клиент Azure AD, не могут использовать ROPC.
> * Пользователи учетных записей без пароля не смогут войти в систему через ROPC. Для таких случаев мы рекомендуем использовать для приложения другой поток.
> * Если пользователи должны использовать для входа в приложение многофакторную проверку подлинности (MFA), они будут заблокированы.
> * РОПК не поддерживается в сценариях [Федерации гибридной идентификации](/azure/active-directory/hybrid/whatis-fed) (например, Azure AD и ADFS, используемые для проверки подлинности локальных учетных записей). Если пользователи полностью перенаправлены на страницу локальных поставщиков удостоверений, то Azure AD не сможет проверить имя пользователя и пароль для этого поставщика удостоверений. Однако в РОПК поддерживается [сквозная аутентификация](/azure/active-directory/hybrid/how-to-connect-pta) .

## <a name="protocol-diagram"></a>Схема протокола

На следующей схеме показано представление потока ROPC.

![Схема, показывающая поток учетных данных для пароля владельца ресурса](./media/v2-oauth2-ropc/v2-oauth-ropc.svg)

## <a name="authorization-request"></a>Запрос авторизации

Поток РОПК — это один запрос: он отправляет идентификатор клиента и учетные данные пользователя в IDP, а затем получает маркеры в Return. Перед этим клиент должен получить от пользователя адрес электронной почты (или другое имя участника-пользователя) и пароль. Сразу после успешного выполнения запроса клиент обязан безопасно удалить из памяти учетные данные пользователя. Ни в коем случае нельзя сохранять их.

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman.
> [![попытаться выполнить этот запрос в POST](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)


```
// Line breaks and spaces are for legibility only.  This is a public client, so no secret is required. 

POST {tenant}/oauth2/v2.0/token
Host: login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&scope=user.read%20openid%20profile%20offline_access
&username=MyUsername@myTenant.com
&password=SuperS3cret
&grant_type=password
```

| Параметр | Условие | ОПИСАНИЕ |
| --- | --- | --- |
| `tenant` | обязательные | Клиент каталога, в который пользователь выполняет вход. Его можно указать в виде GUID или понятного имени. Этот параметр не может иметь значение `common` или `consumers`, но может быть равен `organizations`. |
| `client_id` | обязательные | Идентификатор приложения (клиента), которому назначена страница [портал Azure регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) приложения. | 
| `grant_type` | обязательные | Нужно задать значение `password`. |
| `username` | обязательные | Адрес электронной почты пользователя. |
| `password` | обязательные | Пароль пользователя. |
| `scope` | Рекомендуется | Разделенный пробелами список [областей](v2-permissions-and-consent.md) или разрешений, которые нужны приложению. В интерактивном потоке администратор или пользователь должен заранее согласиться на эти области. |
| `client_secret`| Иногда требуется | Если приложение является общедоступным клиентом, то `client_secret` или `client_assertion` не могут быть добавлены.  Если приложение является конфиденциальным клиентом, оно должно быть включено. | 
| `client_assertion` | Иногда требуется | Другая форма `client_secret`, созданная с помощью сертификата.  Дополнительные сведения см. в разделе [учетные данные сертификата](active-directory-certificate-credentials.md) . | 

### <a name="successful-authentication-response"></a>Успешный ответ аутентификации

В следующем примере показан успешный ответ маркера:

```json
{
    "token_type": "Bearer",
    "scope": "User.Read profile openid email",
    "expires_in": 3599,
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD..."
}
```

| Параметр | Формат | ОПИСАНИЕ |
| --------- | ------ | ----------- |
| `token_type` | Строка, | Всегда имеет значение `Bearer`. |
| `scope` | Строки, разделенные пробелами | Если возвращен маркер доступа, этот параметр содержит список областей, для которых действует этот маркер. |
| `expires_in`| int | Количество секунд, в течение которых действует предоставленный маркер доступа. |
| `access_token`| Непрозрачная строка | Выдается для запрошенных [областей](v2-permissions-and-consent.md). |
| `id_token` | JWT | Выдается, если исходный параметр `scope` содержит область `openid`. |
| `refresh_token` | Непрозрачная строка | Выдается, если исходный параметр `scope` содержит `offline_access`. |

Вы можете использовать маркер обновления для получения новых маркеров доступа и маркеров обновления с помощью того же потока, который описан в [документации по потоку кода OAuth](v2-oauth2-auth-code-flow.md#refresh-the-access-token).

### <a name="error-response"></a>Сообщение об ошибке

Если пользователь не указал правильное имя пользователя или пароль, либо клиент не получил требуемое согласие, аутентификация завершается ошибкой.

| Ошибка | ОПИСАНИЕ | Действие клиента |
|------ | ----------- | -------------|
| `invalid_grant` | Сбой аутентификации | Учетные данные указаны неверно или у клиента отсутствует согласие для запрошенных областей. Если области не предоставлены, будет возвращена ошибка `consent_required`. В этом случае клиент должен перенаправить пользователя в интерактивный интерфейс через веб-представление или браузер. |
| `invalid_request` | Запрос был неправильно сформирован | Тип предоставления не поддерживается в контекстах проверки подлинности `/common` или `/consumers`.  Вместо этого используйте `/organizations` или идентификатор клиента. |

## <a name="learn-more"></a>Подробнее

* Вы можете опробовать ROPC самостоятельно с помощью [примера консольного приложения](https://github.com/azure-samples/active-directory-dotnetcore-console-up-v2).
* Чтобы определить, следует ли использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями платформы удостоверений Майкрософт](active-directory-v2-limitations.md).
