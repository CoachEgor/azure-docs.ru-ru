---
title: Потоки проверки подлинности MSAL Azure
titleSuffix: Microsoft identity platform
description: Узнайте о потоках и гранях, используемых Библиотекой подлинности Майкрософт (MSAL).
services: active-directory
author: mmacy
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 01/30/2020
ms.author: marsma
ms.reviewer: saeeda
ms.custom: aaddev
ms.openlocfilehash: 25c219bedbbbec9fbc0c5617c7bd9fc482faf49a
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80050506"
---
# <a name="authentication-flows"></a>Потоки аутентификации

В этой статье описаны различные потоки аутентификации, предоставляемые библиотекой подлинности Майкрософт (MSAL).  Эти потоки могут быть использованы в различных сценариях применения.

| Поток | Описание | Используется в|  
| ---- | ----------- | ------- | 
| [Интерактивная](#interactive) | Получает токен через интерактивный процесс, который подсказывает пользователю учетные данные через браузер или всплывающее окно. | [Настольные приложения,](scenario-desktop-overview.md) [мобильные приложения](scenario-mobile-overview.md) |
| [Неявное разрешение](#implicit-grant) | Позволяет приложению получать токены без выполнения серверного обмена учетными данными сервера. Это позволяет приложению войти в пользователя, поддерживать сеанс и получать токены в другие web-аПЫ, все в пределах кода JavaScript клиента.| [Одностраничные приложения (SPA)](scenario-spa-overview.md) |
| [Код авторизации](#authorization-code) | Используется в приложениях, которые устанавливаются на устройстве для получения доступа к защищенным ресурсам, таким как веб-aI. Это позволяет добавлять вход и API доступ к мобильным и настольным приложениям. | [Настольные приложения,](scenario-desktop-overview.md) [мобильные приложения,](scenario-mobile-overview.md) [веб-приложения](scenario-web-app-call-api-overview.md) | 
| [От имени](#on-behalf-of) | Приложение вызывает службу или веб-API, который, в свою очередь, должен вызывать другую службу или web API. Идея состоит в том, чтобы распространить делегированное удостоверение пользователя и разрешения с помощью цепочки запросов. | [Интерфейсы веб-API](scenario-web-api-call-api-overview.md) |
| [Учетные данные клиента](#client-credentials) | Позволяет получить доступ к веб-ресурсам, используя идентификацию приложения. Обычно используется для взаимодействия от сервера к серверу, которые должны работать в фоновом режиме, без немедленного взаимодействия с пользователем. | [Приложения Daemon](scenario-daemon-overview.md) |
| [Код устройства](#device-code) | Позволяет пользователям входить в систему на устройствах с ограничениями ввода, таких как смарт-телевизор, IoT-устройство или принтер. | [Настольные/мобильные приложения](scenario-desktop-acquire-token.md#command-line-tool-without-a-web-browser) |
| [Встроенная проверка подлинности Windows](scenario-desktop-acquire-token.md#integrated-windows-authentication) | Позволяет приложениям в домене или совместно использовать active Directory (Azure AD) для получения токена бесшумно (без взаимодействия пользовательского интерфейса).| [Настольные/мобильные приложения](scenario-desktop-acquire-token.md#integrated-windows-authentication) |
| [Имя пользователя/пароль](scenario-desktop-acquire-token.md#username-and-password) | Позволяет приложению войти в пользователя, непосредственно обрабатывая его пароль. Этот поток не рекомендуется. | [Настольные/мобильные приложения](scenario-desktop-acquire-token.md#username-and-password) |

## <a name="how-each-flow-emits-tokens-and-codes"></a>Как каждый поток испускает токены и коды
 
В зависимости от того, как ваш клиент построен, он может использовать один (или несколько) потоков аутентификации, поддерживаемых платформой идентификации Майкрософт.  Эти потоки могут создавать различные токены (id_tokens, обновления токенов, токенов доступа), а также коды авторизации и требуют различных токенов, чтобы заставить их работать. Эта диаграмма содержит обзор:
 
|Поток | Требуется . | id_token | Twitter, | обновить токен | Код авторизации | 
|-----|----------|----------|--------------|---------------|--------------------|
|[Поток кода авторизации](v2-oauth2-auth-code-flow.md) | | x | x | x | x|  
|[Неявный поток](v2-oauth2-implicit-grant-flow.md) | | x        | x    |      |                    |
|[Гибридный поток OIDC](v2-protocols-oidc.md#get-access-tokens)| | x  | |          |            x   |
|[Обновление выкупа токенов](v2-oauth2-auth-code-flow.md#refresh-the-access-token) | обновить токен | x | x | x| |
|[Поток On-Behalf-Of](v2-oauth2-on-behalf-of-flow.md) | Twitter,| x| x| x| |
|[Поток кода устройства](v2-oauth2-device-code.md) | | x| x| x| |
|[Учетные данные клиента](v2-oauth2-client-creds-grant-flow.md) | | | x (только для приложений)| | |
 
Токены, выпущенные через неявный режим, имеют ограничение длины `response_mode` из-за того, что они передаются обратно в браузер через URL (где находится `query` или `fragment`).  Некоторые браузеры имеют ограничение на размер URL, который может быть помещен в строку браузера и не, когда это слишком долго.  Таким образом, эти токены не имеют `groups` или `wids` претензий.

## <a name="interactive"></a>Интерактивно

MSAL поддерживает возможность интерактивно подсказывать пользователю, чтобы их учетные данные ввелись, и получить токен, используя эти учетные данные.

![Диаграмма интерактивного потока](media/msal-authentication-flows/interactive.png)

Для получения дополнительной информации об использовании MSAL.NET для интерактивного приобретения токенов на определенных платформах см.:
- [Xamarin Android](msal-net-xamarin-android-considerations.md)
- [Xamarin iOS](msal-net-xamarin-ios-considerations.md)
- [Универсальная платформа Windows](msal-net-uwp-considerations.md)

Для получения дополнительной информации об интерактивных вызовах в MSAL.js [см.](msal-js-prompt-behavior.md)

## <a name="implicit-grant"></a>Неявное разрешение

MSAL поддерживает [неявный поток грантов OAuth 2,](v2-oauth2-implicit-grant-flow.md)который позволяет приложению получать токены с платформы идентификации Майкрософт без выполнения обмена учетными данными сервера. Это позволяет приложению войти в пользователя, поддерживать сеанс и получать токены в другие web-аПЫ, все в пределах кода JavaScript клиента.

![Диаграмма неявного потока грантов](media/msal-authentication-flows/implicit-grant.svg)

Многие современные веб-приложения построены как клиентские, одностраничные приложения, написанные с помощью JavaScript или spa-инфраструктуры, таких как Angular, Vue.js и React.js. Эти приложения работают в веб-браузере и имеют различные характеристики аутентификации, чем традиционные веб-приложения на стороне сервера. Платформа идентификации Майкрософт позволяет одностраничным приложениям подписываться в пользователях и получать токены для доступа к бэк-энд-сервисам или веб-AA, используя неявный поток грантов. Неявный поток позволяет приложению получать токены ID для представления аутентифицированных пользователей, а также маркеры доступа, необходимые для вызова защищенных AIS.

Этот поток аутентификации не включает сценарии приложений, в которых используются кроссплатформенные платформы JavaScript, такие как Electron и React-Native, поскольку для этого требуются дополнительные возможности для взаимодействия с нативными платформами.

## <a name="authorization-code"></a>Код авторизации

MSAL поддерживает [грант кода авторизации OAuth 2.](v2-oauth2-auth-code-flow.md) Этот грант может быть использован в приложениях, которые установлены на устройстве для получения доступа к защищенным ресурсам, таким как веб-aI. Это позволяет добавлять вход и API доступ к мобильным и настольным приложениям. 

При входе пользователей в веб-приложения (веб-сайты) веб-приложение получает код авторизации.  Код авторизации выкуплен для приобретения токена для вызова web-aIS. В ASP.NET и ASP.NET веб-приложений `AcquireTokenByAuthorizationCode` Core, единственной целью является добавление маркера в кэш маркеров. Затем токен может быть использован приложением (обычно в контроллерах, которые просто получают `AcquireTokenSilent`токен для API с помощью).

![Диаграмма потока кода авторизации](media/msal-authentication-flows/authorization-code.png)

На предыдущей диаграмме приложение:

1. Запрашивает код авторизации, который выкуплен для токена доступа.
2. Использует токен доступа для вызова веб-API.

### <a name="considerations"></a>Рекомендации

- Код авторизации можно использовать только один раз, чтобы выкупить токен. Не пытайтесь приобрести токен несколько раз с одинаковым кодом авторизации (это явно запрещено стандартной спецификацией протокола). Если вы выкупите код несколько раз намеренно, или потому, что вы не знаете, что фреймворк также делает это за вас, вы получите следующую ошибку:`AADSTS70002: Error validating credentials. AADSTS54005: OAuth2 Authorization code was already redeemed, please retry with a new valid code or use an existing refresh token.`

- Если вы пишете ASP.NET или ASP.NET основное приложение, это может произойти, если вы не сообщите об уже погашении кода авторизации. Для этого необходимо вызвать `context.HandleCodeRedemption()` метод `AuthorizationCodeReceived` обработчика событий.

- Избегайте совместного использования токена доступа с ASP.NET, что может предотвратить правильное согласие. Для получения дополнительной информации см [#693.](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/issues/693)

## <a name="on-behalf-of"></a>От имени

MSAL поддерживает [поток oAuth 2 от имени аутентификации.](v2-oauth2-on-behalf-of-flow.md)  Этот поток используется, когда приложение вызывает службу или веб-API, который, в свою очередь, должен вызывать другую службу или Web API. Идея состоит в том, чтобы распространить делегированное удостоверение пользователя и разрешения с помощью цепочки запросов. Для того чтобы служба среднего уровня внедупала запросы в службу ниже по течению, она должна обеспечить доступ к токену с платформы идентификации Майкрософт от имени пользователя.

![Диаграмма потока от имени](media/msal-authentication-flows/on-behalf-of.png)

На предыдущей схеме показано следующее:

1. Приложение приобретает токен доступа для web-aPI.
2. Клиент (веб,, настольный, мобильный или одностраничное приложение) вызывает защищенный веб-API, добавляя маркер доступа в качестве маркера на предъявителя в заголовок проверки подлинности запроса HTTP. Веб-API проверяет подлинность пользователя.
3. Когда клиент вызывает веб-API, веб-API запрашивает другой токен от имени пользователя.  
4. Защищенный веб-API использует этот маркер для вызова ниже по течению веб-API от имени пользователя.  Веб-API также позже может запрашивать токены для других аПО (но все еще от имени того же пользователя).

## <a name="client-credentials"></a>Учетные данные клиента

MSAL поддерживает [поток учетных данных клиентов OAuth 2.](v2-oauth2-client-creds-grant-flow.md) Этот поток позволяет получить доступ к веб-ресурсов, используя личность приложения. Этот тип предоставления разрешения часто используется для взаимодействия между серверами, которое должно выполняться в фоновом режиме без непосредственного взаимодействия с пользователем. Такие типы приложений часто называют управляющими программами или учетными записями служб. 

Клиент учетных данных предоставить поток позволяет веб-службы (конфиденциальный клиент) использовать свои собственные учетные данные, вместо того, чтобы выдавать себя за пользователя, для проверки подлинности при вызове другого веб-сервиса. В этом сценарии клиент, как правило, веб-сервис среднего уровня, служба daemon или веб-сайт. Для большей надежности платформа удостоверений Майкрософт также позволяет вызывающей службе использовать в качестве учетных данных сертификат (вместо общего секрета).

> [!NOTE]
> Конфиденциальный клиентский поток недоступен на мобильных платформах (UWP, Xamarin.iOS и Xamarin.Android), так как они поддерживают только приложения для публичных клиентов. Публичные клиентские приложения не знают, как доказать личность приложения поставщику идентификационных данных. Безопасное соединение может быть достигнуто на веб-приложении или веб-API назад заканчивается путем развертывания сертификата.

MSAL.NET поддерживает два типа учетных данных клиентов. Эти учетные данные клиентов должны быть зарегистрированы в Azure AD. Учетные данные передаются конструкторам конфиденциального клиентского приложения в коде.

### <a name="application-secrets"></a>Секреты приложений

![Диаграмма конфиденциального клиента с паролем](media/msal-authentication-flows/confidential-client-password.png)

На предыдущей диаграмме приложение:

1. Приобретает токен с помощью секретных учетных данных приложения или учетных данных паролей.
2. Использует токен для запросов ресурса.

### <a name="certificates"></a>Сертификаты

![Диаграмма конфиденциального клиента с сертификатом](media/msal-authentication-flows/confidential-client-certificate.png)

На предыдущей диаграмме приложение:

1. Приобретает токен с помощью учетных данных сертификата.
2. Использует токен для запросов ресурса.

Эти учетные данные клиента должны быть:
- Зарегистрирован в Azure AD.
- Сдалприт при строительстве конфиденциального клиентского приложения в вашем коде.

## <a name="device-code"></a>Код устройства

MSAL поддерживает [поток кода устройства OAuth 2,](v2-oauth2-device-code.md)который позволяет пользователям входить в систему с ограниченными данными устройствами, такими как смарт-телевизор, IoT-устройство или принтер. Интерактивная аутентификация с Azure AD требует веб-браузера. Поток кода устройства позволяет пользователю использовать другое устройство (например, другой компьютер или мобильный телефон) для интерактивного входного сигнала, где устройство или операционная система не предоставляет веб-браузер.

Используя поток кода устройства, приложение получает токены через двухступенчатый процесс, специально разработанный для этих устройств или операционных систем. Примерами таких приложений являются приложения, работающие на устройствах IoT или командных инструментах (CLI). 

![Диаграмма потока кода устройства](media/msal-authentication-flows/device-code.png)

На предыдущей схеме показано следующее:

1. Всякий раз, когда требуется проверка подлинности пользователя, приложение предоставляет код и просит пользователя использовать другое устройство (например, подключенный к Интернету смартфон), чтобы перейти к URL (например, `https://microsoft.com/devicelogin`). Затем пользователю предлагается ввести код, и он проходит через обычный опыт проверки подлинности, включая запросы согласия и многофакторную аутентификацию, если это необходимо.

2. После успешной проверки подлинности приложение командной строки получает необходимые токены через обратный канал и использует их для выполнения необходимых вызовов Web API.

### <a name="constraints"></a>Ограничения

- Поток кода устройства доступен только в общедоступных клиентских приложениях.
- Полномочия, принятые при построении публичного клиентского приложения, должны быть одним из следующих:
  - Аренда (формы, `https://login.microsoftonline.com/{tenant}/` `{tenant}` где либо GUID, представляющий идентификатор арендатора, или домен, связанный с арендатором).
  - Для любой работы`https://login.microsoftonline.com/organizations/`и школьных счетов ().
- Личные учетные записи Майкрософт пока не поддерживаются конечной точкой Azure `/common` `/consumers` AD v2.0 (вы не можете использовать или арендаторов).

## <a name="integrated-windows-authentication"></a>Встроенная проверка подлинности Windows

MSAL поддерживает интегрированную аутентификацию Windows (IWA) для настольных или мобильных приложений, которые работают на домене, присоединенном или azure AD, присоединивом к Windows computer. Используя IWA, эти приложения могут приобретать токен молча (без какого-либо взаимодействия пользовательского интерфейса от пользователя). 

![Диаграмма интегрированной аутентификации Windows](media/msal-authentication-flows/integrated-windows-authentication.png)

На предыдущей диаграмме приложение:

1. Приобретает токен с помощью интегрированной аутентификации Windows.
2. Использует токен для запросов ресурса.

### <a name="constraints"></a>Ограничения

IWA поддерживает только федеративных пользователей, то есть пользователей, созданных в Active Directory и поддерживаемых Azure AD. Пользователи, созданные непосредственно в Azure AD, без поддержки Active Directory (управляемые пользователи) не могут использовать этот поток аутентификации. Это ограничение не влияет на [поток имени пользователя/пароля.](#usernamepassword)

IWA предназначен для приложений, написанных для платформ .NET Framework, .NET Core и Universal Windows Platform.

IWA не обходит многофакторную аутентификацию. Если настроена многофакторная аутентификация, IWA может выполнить неудачу, если потребуется многофакторная проблема аутентификации. Многофакторная аутентификация требует взаимодействия с пользователем.

Вы не контролируете, когда поставщик идентификационных данных запрашивает двухфакторную аутентификацию для выполнения. Арендатор админ делает. Как правило, при входной связи из другой страны требуется двухфакторная аутентификация, когда вы не подключены через VPN к корпоративной сети, а иногда даже при подключении через VPN. Azure AD использует ИИ для непрерывного изучения двухфакторной аутентификации. Если IWA не удается, вы должны вернуться к "интерактивному запросу пользователя" (#interactive).

Полномочия, принятые при построении публичного клиентского приложения, должны быть одним из следующих:
- Аренда (формы, `https://login.microsoftonline.com/{tenant}/` `tenant` где либо гид, представляющий идентификатор арендатора, или домен, связанный с арендатором).
- Для любой работы`https://login.microsoftonline.com/organizations/`и школьных счетов (). Личные учетные записи Майкрософт `/common` не `/consumers` поддерживаются (вы не можете использовать или арендаторов).

Поскольку IWA является тихим потоком, один из следующих должен быть правдой:
- Пользователь приложения должен был ранее дать согласие на использование приложения. 
- Админ-арендатор должен был ранее дать согласие всем пользователям в арендаторе на использование приложения.

Это означает, что один из следующих истин:
- Вы, как разработчик, выбрали **Грант** на портале Azure для себя.
- Админ-арендатор выбрал **грант/отзыв админа на «арендаторный домен»** в вкладке **разрешений API** регистрации приложения (см. [Разрешения добавить для доступа к web-АДИ).](quickstart-configure-app-access-web-apis.md#add-permissions-to-access-web-apis)
- Вы предоставили пользователям возможность дать согласие на приложение [(см. Запрос индивидуального согласия пользователя).](v2-permissions-and-consent.md#requesting-individual-user-consent)
- Вы предоставили поставщику данных, чтобы дать согласие на применение (см. [согласие админа).](v2-permissions-and-consent.md#requesting-consent-for-an-entire-tenant)

Поток IWA включен для настольных компьютеров .NET, .NET Core и Windows Universal Platform приложений. На .NET Core вы должны предоставить имя пользователя IWA, потому что .NET Core не может получить имена пользователей из операционной системы.
  
Для получения дополнительной информации о согласии, [см. v2.0 разрешений и согласия](v2-permissions-and-consent.md).

## <a name="usernamepassword"></a>Имя пользователя и пароль

MSAL поддерживает [грант владельца паролей владельца ресурса OAuth 2,](v2-oauth-ropc.md)который позволяет приложению войти в пользователя, непосредственно обрабатывая его пароль. В вашем настольном приложении вы можете использовать поток имени пользователя/пароля для бесшумного приобретения маркера. При использовании приложения не требуется uI iI.

![Диаграмма потока имени пользователя/пароля](media/msal-authentication-flows/username-password.png)

На предыдущей диаграмме приложение:

1. Приобретает токен, отправив имя пользователя и пароль поставщику идентификационных данных.
2. Вызывает веб-API с помощью маркера.

> [!WARNING]
> Этот поток не рекомендуется. Это требует высокой степени доверия и воздействия на пользователей.  Этот поток следует использовать только тогда, когда другие, более безопасные потоки не могут быть использованы. Для получения дополнительной информации, см [Какое решение растущей проблемы паролей?](https://news.microsoft.com/features/whats-solution-growing-problem-passwords-says-microsoft/). 

Предпочтительным потоком для бесшумного приобретения токена на устройствах, связанных с доменом Windows, является [интегрированная аутентификация Windows.](#integrated-windows-authentication) В противном случае можно также использовать [поток кода устройства.](#device-code)

Хотя это полезно в некоторых случаях (сценарии DevOps), если вы хотите использовать имя пользователя /пароль в интерактивных сценариях, где вы предоставляете свой собственный пользовательский интерфейс, старайтесь избегать его. С помощью имени пользователя / пароля:
- Пользователи, которым необходимо сделать многофакторную аутентификацию, не смогут войти в систему (так как нет взаимодействия).
- Пользователи не смогут делать одиночный входной знак.

### <a name="constraints"></a>Ограничения

Помимо [ограничений по проверке подлинности Windows,](#integrated-windows-authentication)применяются следующие ограничения:

- Поток имени пользователя/пароля не совместим с условным доступом и многофакторной аутентификацией. Как следствие, если ваше приложение работает в адепрах Azure AD, где админ-арендатор требует многофакторной аутентификации, этот поток не используется. Многие организации делают это.
- Он работает только для рабочих и школьных учетных записей (не учетных записей Microsoft).
- Поток доступен на рабочем столе .NET и .NET Core, но не на универсальной платформе Windows.

### <a name="azure-ad-b2c-specifics"></a>Специфика Azure AD B2C

Для получения дополнительной информации об использовании MSAL.NET и Azure AD B2C см [MSAL.NET.](msal-net-aad-b2c-considerations.md#resource-owner-password-credentials-ropc-with-azure-ad-b2c)
