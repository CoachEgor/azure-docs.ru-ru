---
title: Потоки проверки подлинности MSAL | Azure
titleSuffix: Microsoft identity platform
description: Сведения о потоках проверки подлинности и предоставлении разрешений, используемых библиотекой проверки подлинности Майкрософт (MSAL).
services: active-directory
author: mmacy
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 05/18/2020
ms.author: marsma
ms.reviewer: saeeda
ms.custom: aaddev
ms.openlocfilehash: ce81af90baeeda519f1b56d1e10a46923ebd22c2
ms.sourcegitcommit: 318d1bafa70510ea6cdcfa1c3d698b843385c0f6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/21/2020
ms.locfileid: "83772137"
---
# <a name="authentication-flows"></a>Потоки проверки подлинности

В этой статье описаны различные потоки проверки подлинности, предоставляемые библиотекой проверки подлинности Майкрософт (MSAL).  Эти потоки можно использовать в различных сценариях приложений.

| Поток | Описание | Используется в|  
| ---- | ----------- | ------- | 
| [Интерактивный](#interactive) | Получает маркер через интерактивный процесс, который запрашивает у пользователя учетные данные через браузер или всплывающее окно. | [Классические приложения](scenario-desktop-overview.md), [мобильные приложения](scenario-mobile-overview.md) |
| [Неявное разрешение](#implicit-grant) | Позволяет приложению получать маркеры без обмена учетными данными в серверной части. Так приложение может авторизовать пользователей, поддерживать сеансы и получать маркеры для других веб-API — и все это из клиентского кода JavaScript.| [Одностраничные приложения (SPA)](scenario-spa-overview.md) |
| [Код авторизации](#authorization-code) | Используется в приложениях, установленных на устройстве, для получения доступа к защищенным ресурсам, таким как веб-API. Это позволяет вам добавить доступ к мобильным и классическим приложениям с помощью функции входа и API. | [Классические приложения](scenario-desktop-overview.md), [мобильные приложения](scenario-mobile-overview.md), [веб-приложения](scenario-web-app-call-api-overview.md) | 
| [On-behalf-of](#on-behalf-of) | Приложение вызывает службу или веб-API, который, в свою очередь, должен вызывать другую службу или веб-API. Идея состоит в том, чтобы распространить делегированное удостоверение пользователя и разрешения с помощью цепочки запросов. | [Интерфейсы веб-API](scenario-web-api-call-api-overview.md) |
| [Учетные данные клиента](#client-credentials) | Позволяет получить доступ к ресурсам, размещенным в Интернете, с помощью удостоверения приложения. Часто используется для взаимодействия между серверами, которое должно выполняться в фоновом режиме без непосредственного взаимодействия с пользователем. | [Управляющие программы](scenario-daemon-overview.md) |
| [Код устройства](#device-code) | Позволяет пользователям входить на устройства с ограничениями ввода, например устройство типа Smart TV, устройство Интернета вещей или принтер. | [Классические и мобильные приложения](scenario-desktop-acquire-token.md#command-line-tool-without-a-web-browser) |
| [Встроенная аутентификация Windows](scenario-desktop-acquire-token.md#integrated-windows-authentication) | Позволяет приложениям на компьютерах, подключенных к домену или Azure Active Directory (Azure AD), получать маркер автоматически (без взаимодействия с пользовательским интерфейсом).| [Классические и мобильные приложения](scenario-desktop-acquire-token.md#integrated-windows-authentication) |
| [Имя пользователя и пароль](scenario-desktop-acquire-token.md#username-and-password) | Позволяет приложению войти в систему, напрямую обрабатывая пароль. Этот поток не рекомендуется. | [Классические и мобильные приложения](scenario-desktop-acquire-token.md#username-and-password) |

## <a name="how-each-flow-emits-tokens-and-codes"></a>Как каждый поток выдает маркеры и коды
 
В зависимости от того, как строится клиент, он может использовать один или несколько потоков проверки подлинности, поддерживаемых платформой удостоверений Microsoft.  Эти потоки могут создавать различные маркеры (id_tokens, маркеры обновления, маркеры доступа), а также коды авторизации, и для их работы требуются разные маркеры. На диаграмме представлены общие сведения:
 
|Поток | Требования | id_token | Twitter, | маркер обновления | Код авторизации | 
|-----|----------|----------|--------------|---------------|--------------------|
|[Поток кода авторизации](v2-oauth2-auth-code-flow.md) | | x | x | x | x|  
|[Неявный поток](v2-oauth2-implicit-grant-flow.md) | | x        | x    |      |                    |
|[Гибридный поток OIDC](v2-protocols-oidc.md#get-access-tokens)| | x  | |          |            x   |
|[Активация маркера обновления](v2-oauth2-auth-code-flow.md#refresh-the-access-token) | маркер обновления | x | x | x| |
|[Поток On-Behalf-Of](v2-oauth2-on-behalf-of-flow.md) | Twitter,| x| x| x| |
|[Поток кода устройства](v2-oauth2-device-code.md) | | x| x| x| |
|[Учетные данные клиента](v2-oauth2-client-creds-grant-flow.md) | | | x (только для приложений)| | |
 
Маркеры, выданные через неявный режим, имеют ограничение длины, так как они передаются обратно в браузер через URL-адрес (где `response_mode` — `query` или `fragment`).  Некоторые браузеры имеют ограничение на размер URL-адреса, который можно разместить в строке браузера, и завершаются ошибкой, если он слишком длинный.  Поэтому у этих маркеров нет утверждений `groups` или `wids`.

## <a name="interactive"></a>Интерактивно

MSAL позволяет в интерактивном режиме запрашивать у пользователя учетные данные для входа и получать маркер с использованием этих учетных данных.

![Схема интерактивного потока](media/msal-authentication-flows/interactive.png)

Дополнительные сведения об использовании MSAL.NET для интерактивного получения маркеров на конкретных платформах см. в следующих статьях.
- [Xamarin Android](msal-net-xamarin-android-considerations.md)
- [Xamarin iOS](msal-net-xamarin-ios-considerations.md)
- [Универсальная платформа Windows](msal-net-uwp-considerations.md)

Дополнительные сведения об интерактивных вызовах в MSAL.js см. в разделе [Поведение запросов в интерактивных запросах MSAL.js](msal-js-prompt-behavior.md).

## <a name="implicit-grant"></a>Неявное разрешение

MSAL поддерживает [неявное предоставление разрешения OAuth 2](v2-oauth2-implicit-grant-flow.md), что позволяет приложению получать маркеры от платформы удостоверений Microsoft, не выполняя обмен учетными данными на сервере. Так приложение может авторизовать пользователей, поддерживать сеансы и получать маркеры для других веб-API — и все это из клиентского кода JavaScript.

![Схема потока неявного предоставления разрешений](media/msal-authentication-flows/implicit-grant.svg)

Многие современные веб-приложения создаются в качестве одностраничных клиентских приложений, написанных с использованием JavaScript или платформы SPA, таких как Angular, Vue.js и React.js. Эти приложения работают в веб-браузере и имеют характеристики проверки подлинности, отличные от традиционных серверных веб-приложений. Платформа удостоверений Microsoft позволяет одностраничным приложениям поддерживать вход пользователей, а также получать маркеры для доступа к внутренним службам или веб-API, используя поток неявного предоставления разрешения. Неявный поток позволяет приложению получать маркеры идентификаторов для представления пользователя, прошедшего проверку подлинности, а также маркеры, необходимые для вызова защищенных API.

Этот поток проверки подлинности не включает сценарии приложений, в которых используются межплатформенные фреймворки JavaScript, такие как Electron и React-Native, так как они требуют дополнительные возможности для взаимодействия с собственными платформами.

## <a name="authorization-code"></a>Код авторизации

MSAL поддерживает [предоставление кода авторизации OAuth 2](v2-oauth2-auth-code-flow.md). Это разрешение используется в приложениях, установленных на устройстве, для получения доступа к защищенным ресурсам, таким как веб-API. Это позволяет вам добавить доступ к мобильным и классическим приложениям с помощью функции входа и API. 

При входе пользователей в веб-приложения (веб-сайты) веб-приложение получает код авторизации.  Код авторизации активируется для получения маркера для вызова веб-API. В веб-приложениях ASP.NET и ASP.NET Core единственной целью `AcquireTokenByAuthorizationCode` является добавление маркера в кэш маркеров. Затем маркер может использоваться приложением (обычно в контроллерах, которые просто получают маркер для API с помощью `AcquireTokenSilent`).

![Схема потока кода авторизации](media/msal-authentication-flows/authorization-code.png)

На предыдущей схеме приложение:

1. запрашивает код авторизации, который активируется для маркера доступа;
2. использует маркер доступа для вызова веб-API.

### <a name="considerations"></a>Рекомендации

- Код авторизации можно использовать только один раз для активации маркера. Не пытайтесь получить маркер несколько раз с одним и тем же кодом авторизации (это явно запрещено спецификацией стандарта протокола). Если вы активируете код несколько раз преднамеренно или не знаете, что платформа также делает это, возникает следующая ошибка: `AADSTS70002: Error validating credentials. AADSTS54005: OAuth2 Authorization code was already redeemed, please retry with a new valid code or use an existing refresh token.`

- Если вы пишете приложение ASP.NET или ASP.NET Core, это может произойти, если вы не сообщите платформе, что уже активировали код авторизации. Для этого необходимо вызвать метод `context.HandleCodeRedemption()` обработчика событий `AuthorizationCodeReceived`.

- Избегайте совместного использования маркера доступа с ASP.NET, что может помешать правильному последовательному согласию. Дополнительные сведения см. в разделе [Проблема № 693](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/issues/693).

## <a name="on-behalf-of"></a>On-behalf-of

MSAL поддерживает [поток проверки подлинности OAuth 2 On-Behalf-Of](v2-oauth2-on-behalf-of-flow.md).  Этот поток используется, когда приложение вызывает службу или веб-API, который, в свою очередь, должен вызывать другую службу или веб-API. Идея состоит в том, чтобы распространить делегированное удостоверение пользователя и разрешения с помощью цепочки запросов. Для того чтобы служба среднего уровня могла выполнять запросы к службе нижнего уровня с проверкой подлинности, служба среднего уровня должна защитить маркер доступа с платформы удостоверений Microsoft от имени пользователя.

![Схема потока On-Behalf-Of](media/msal-authentication-flows/on-behalf-of.png)

На предыдущей схеме показано следующее.

1. Приложение получает маркер доступа для веб-API.
2. Клиент (веб-, классическое, мобильное или одностраничное приложение) вызывает защищенный веб-API, добавляя маркер доступа в качестве маркера носителя в заголовок проверки подлинности HTTP-запроса. Веб-API выполняет проверку подлинности пользователя.
3. Когда клиент вызывает веб-API, веб-API запрашивает другой маркер от имени пользователя.  
4. Защищенный веб-API использует этот маркер для вызова нижестоящего веб-API от имени пользователя.  Веб-API также может запрашивать маркеры для других нижестоящих API (но по-прежнему от имени одного и того же пользователя).

## <a name="client-credentials"></a>Учетные данные клиента

MSAL поддерживает [поток учетных данных клиента OAuth 2](v2-oauth2-client-creds-grant-flow.md). Этот поток позволяет получить доступ к ресурсам, размещенным в Интернете, с помощью удостоверения приложения. Этот тип предоставления разрешения часто используется для взаимодействия между серверами, которое должно выполняться в фоновом режиме без непосредственного взаимодействия с пользователем. Такие типы приложений часто называют управляющими программами или учетными записями служб. 

Процесс предоставления учетных данных клиента позволяет веб-службе (конфиденциальный клиент) вместо олицетворения пользователя использовать свои собственные учетные данные для проверки подлинности при вызове другой веб-службы. В этом сценарии клиент обычно является веб-службой среднего уровня, службой управляющей программы или веб-сайтом. Для большей надежности платформа удостоверений Майкрософт также позволяет вызывающей службе использовать в качестве учетных данных сертификат (вместо общего секрета).

> [!NOTE]
> Конфиденциальный поток клиента недоступен на мобильных платформах (UWP, Xamarin.iOS и Xamarin.Android), так как они поддерживают только общедоступные клиентские приложения. Общедоступные клиентские приложения не знают, как подтвердить удостоверение приложения для поставщика удостоверений. Безопасное подключение может быть достигнуто в веб-приложении или серверной части веб-API путем развертывания сертификата.

MSAL.NET поддерживает два типа клиентских учетных данных. Эти клиентские учетные данные должны быть зарегистрированы в Azure AD. Учетные данные передаются в конструкторы конфиденциального клиентского приложения в коде.

### <a name="application-secrets"></a>Секреты приложений

![Схема конфиденциального клиента с паролем](media/msal-authentication-flows/confidential-client-password.png)

На предыдущей схеме приложение:

1. получает маркер с помощью секрета приложения или учетных данных пароля;
2. использует маркер для выполнения запросов к ресурсу.

### <a name="certificates"></a>Сертификаты

![Схема конфиденциального клиента с сертификатом](media/msal-authentication-flows/confidential-client-certificate.png)

На предыдущей схеме приложение:

1. получает маркер с помощью учетных данных сертификата;
2. использует маркер для выполнения запросов к ресурсу.

Эти учетные данные клиента должны быть:
- зарегистрированы в Azure AD.
- Переданы в конструкторы конфиденциального клиентского приложения в коде.

## <a name="device-code"></a>Код устройства

MSAL поддерживает [поток кода устройства OAuth 2](v2-oauth2-device-code.md), который позволяет пользователям входить на устройства с ограничениями ввода, например устройство типа Smart TV, устройство Интернета вещей или принтер. Для интерактивной проверки подлинности в Azure AD требуется веб-браузер. Поток кода устройства позволяет пользователю использовать другое устройство (например, другой компьютер или мобильный телефон) для входа в интерактивном режиме, если устройство или операционная система не предоставляют веб-браузер.

С помощью потока кода устройства приложение получает маркеры через двухэтапный процесс, специально предназначенный для этих устройств или операционных систем. К примерам таких приложений относятся те, которые работают на устройствах Интернета вещей или в программах командной строки (CLI). 

![Схема потока кода устройства](media/msal-authentication-flows/device-code.png)

На предыдущей схеме показано следующее.

1. Всякий раз, когда требуется проверка подлинности пользователя, приложение предоставляет код и запрашивает у пользователя использование другого устройства (например, смартфона, подключенного к Интернету) для перехода по URL-адресу (например, `https://microsoft.com/devicelogin`). После этого пользователю будет предложено ввести код и выполнить обычную проверку подлинности, включая запросы согласия и [многофакторную проверку подлинности](../authentication/concept-mfa-howitworks.md) при необходимости.

2. После успешной проверки подлинности приложение командной строки получает необходимые маркеры через канал обратного вызова и использует их для выполнения необходимых вызовов веб-API.

### <a name="constraints"></a>Ограничения

- Поток кода устройства доступен только в общедоступных клиентских приложениях.
- При создании общедоступного клиентского приложения необходим один из следующих центров.
  - Клиентский (вида `https://login.microsoftonline.com/{tenant}/`, где `{tenant}` — это идентификатор GUID, представляющий идентификатор клиента или домен, связанный с клиентом).
  - Для всех рабочих и учебных учетных записей (`https://login.microsoftonline.com/organizations/`).
- Личные учетные записи Майкрософт пока не поддерживаются конечной точкой Azure AD версии 2.0 (вы не можете использовать клиенты `/common` или `/consumers`).

## <a name="integrated-windows-authentication"></a>Встроенная проверка подлинности Windows

MSAL поддерживает встроенную проверку подлинности Windows (IWA) для классических или мобильных приложений, работающих на компьютере Windows, присоединенном к домену или Azure AD. С помощью IWA эти приложения могут получать маркер автоматически (без взаимодействия с пользовательским интерфейсом). 

![Схема встроенной проверки подлинности Windows](media/msal-authentication-flows/integrated-windows-authentication.png)

На предыдущей схеме приложение:

1. получает маркер с использованием встроенной проверки подлинности Windows;
2. использует маркер для выполнения запросов к ресурсу.

### <a name="constraints"></a>Ограничения

IWA поддерживает только федеративных пользователей, то есть пользователей, созданных в Active Directory и поддерживаемых Azure AD. Пользователи, созданные непосредственно в Azure AD без поддержки Active Directory (управляемые пользователи), не могут использовать этот поток проверки подлинности. Это ограничение не влияет на [поток имени пользователя и пароля](#usernamepassword).

IWA предназначена для приложений, написанных для платформ .NET Framework, .NET Core и универсальной платформы Windows.

IWA не обходит многофакторную проверку подлинности. Если настроена многофакторная проверка подлинности, IWA может завершиться ошибкой, когда требуется запрос многофакторной проверки подлинности. Многофакторная проверка подлинности требует взаимодействия с пользователем.

Вы не контролируете, когда поставщик удостоверений запрашивает двухфакторную проверку подлинности. Этим занимается администратор клиента. Обычно двухфакторная проверка подлинности требуется при входе из другой страны или региона, если вы не подключены через VPN к корпоративной сети, и иногда даже при подключении через VPN. Azure AD использует искусственный интеллект для непрерывного изучения необходимости двухфакторной проверки подлинности. В случае сбоя IWA следует вернуться к [интерактивному запросу пользователя] (#interactive).

При создании общедоступного клиентского приложения необходим один из следующих центров.
- Клиентский (вида `https://login.microsoftonline.com/{tenant}/`, где `tenant` — это идентификатор GUID, представляющий идентификатор клиента или домен, связанный с клиентом).
- Для всех рабочих и учебных учетных записей (`https://login.microsoftonline.com/organizations/`). Личные учетные записи Майкрософт не поддерживаются (вы не можете использовать клиенты `/common` или `/consumers`).

Так как IWA является автоматическим потоком, необходимо выполнить одно из следующих условий.
- Пользователь приложения должен быть предварительно одобрен, чтобы использовать приложение. 
- Администратор клиента должен предварительно одобрить всех пользователей в клиенте для использования приложения.

Это означает, что выполняется одно из следующих условий.
- Вы как разработчик выбрали **Предоставить разрешение** на портале Azure для самого себя.
- Администратор клиента выбрал **Предоставить или отозвать согласие администратора для {домен клиента}** на вкладке **Разрешения API** в разделе регистрации приложения (см. [Добавление разрешений для доступа к веб-API](quickstart-configure-app-access-web-apis.md#add-permissions-to-access-web-apis)).
- Вы указали способ предоставления пользователям разрешения на приложение (см. [Запрос разрешения для отдельного пользователя](v2-permissions-and-consent.md#requesting-individual-user-consent)).
- Вы указали способ предоставления администратором клиента согласия для приложения (см. [согласие администратора](v2-permissions-and-consent.md#requesting-consent-for-an-entire-tenant)).

Поток IWA включен для классических приложений .NET, приложений .NET Core и универсальной платформы Windows. В .NET Core необходимо предоставить IWA имя пользователя, так как .NET Core не может получить имена пользователей из операционной системы.
  
Дополнительные сведения о согласии см. в разделе [разрешения и согласия в версии 2.0](v2-permissions-and-consent.md).

## <a name="usernamepassword"></a>Имя пользователя и пароль

MSAL поддерживает [предоставление пароля владельца ресурса OAuth 2](v2-oauth-ropc.md), что позволяет приложению обрабатывать вход пользователя, непосредственно используя его пароль. В классическом приложении можно использовать поток имени пользователя и пароля для автоматического получения маркера. При использовании приложения не нужен пользовательский интерфейс.

![Схема потока имени пользователя и пароля](media/msal-authentication-flows/username-password.png)

На предыдущей схеме приложение:

1. получает маркер, отправляя имя пользователя и пароль поставщику удостоверений;
2. вызывает веб-API с помощью маркера.

> [!WARNING]
> Этот поток не рекомендуется. Для этого требуется высокая степень доверия и доступность пользователя.  Этот поток следует использовать только в том случае, если другие, более безопасные потоки, не могут использоваться. Дополнительные сведения см. в разделе [Как решить насущную проблему паролей?](https://news.microsoft.com/features/whats-solution-growing-problem-passwords-says-microsoft/). 

Предпочтительным потоком для автоматического получения маркера на компьютерах, присоединенных к домену Windows, является [встроенная проверка подлинности Windows](#integrated-windows-authentication). Также можно использовать [поток кода устройства](#device-code).

Хотя это полезно в некоторых случаях (сценарии DevOps), если вы хотите использовать имя пользователя и пароль в интерактивных сценариях, где вы предоставляете собственный пользовательский интерфейс, постарайтесь избежать этого. По имени пользователя и паролю.
- Пользователи, которым требуется выполнить многофакторную проверку подлинности, не смогут войти в систему (так как взаимодействие отсутствует).
- Пользователи не смогут выполнять единый вход.

### <a name="constraints"></a>Ограничения

Помимо [ограничений встроенной проверки подлинности Windows](#integrated-windows-authentication), также применяются следующие ограничения.

- Поток имени пользователя и пароля несовместим с условным доступом и многофакторной проверкой подлинности. Как следствие, если приложение выполняется в клиенте Azure AD, где администратор клиента требует многофакторную проверку подлинности, вы не сможете использовать этот поток. Так поступают многие организации.
- Это подходит только для рабочих и учебных учетных записей (не учетных записей Майкрософт).
- Поток доступен для классических приложений .NET и .NET Core, но не для универсальной платформы Windows.

### <a name="azure-ad-b2c-specifics"></a>Особенности Azure AD B2C

Дополнительные сведения об использовании ROPC в MSAL.NET и Azure AD B2C см. в разделе [Использование ROPC с Azure AD B2C](msal-net-aad-b2c-considerations.md#resource-owner-password-credentials-ropc).
