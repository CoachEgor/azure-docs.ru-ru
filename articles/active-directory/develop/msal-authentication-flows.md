---
title: Потоки проверки подлинности (библиотека проверки подлинности Майкрософт) | Azure
description: Дополнительные сведения о потоках проверки подлинности и предоставляет использовать библиотеку проверки подлинности Майкрософт (MSAL).
services: active-directory
documentationcenter: dev-center-name
author: rwike77
manager: CelesteDG
editor: ''
ms.service: active-directory
ms.subservice: develop
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 04/25/2019
ms.author: ryanwi
ms.reviewer: saeeda
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: b7ba6ae188c098e85573503a1518ba65480d713a
ms.sourcegitcommit: 47ce9ac1eb1561810b8e4242c45127f7b4a4aa1a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2019
ms.locfileid: "67807211"
---
# <a name="authentication-flows"></a>Потоки проверки подлинности

В этой статье описывается потоков проверки подлинности, предоставленные библиотеки проверки подлинности Майкрософт (MSAL).  Эти потоки можно использовать в разнообразных различных сценариях приложений.

| Поток | Описание | Используется в|  
| ---- | ----------- | ------- | 
| [Интерактивный](#interactive) | Получает токен через интерактивный процесс, который запрашивает у пользователя учетные данные с помощью браузера или всплывающего окна. | [Классические приложения](scenario-desktop-overview.md), [мобильных приложений](scenario-mobile-overview.md) |
| [Неявное разрешение](#implicit-grant) | Позволяет приложению получать маркеры, не выполняя обмен учетными данными для внутреннего сервера. Это позволяет приложению вход пользователя, поддерживать сеансы и получать маркеры для других веб-API, все это из клиентского кода JavaScript.| [Одностраничных приложениях (SPA)](scenario-spa-overview.md) |
| [Код авторизации](#authorization-code) | Используется в приложениях, установленных на устройстве, чтобы получить доступ к защищенным ресурсам, таким как веб-API. Это позволяет добавить входа в систему и доступа к API для мобильных и настольных приложений. | [Классические приложения](scenario-desktop-overview.md), [мобильных приложений](scenario-mobile-overview.md), [веб-приложения](scenario-web-app-call-api-overview.md) | 
| [On-behalf-of](#on-behalf-of) | Приложение вызывает службу или веб-API, который в свою очередь должен вызывать другую службу или веб-API. Идея состоит в том, чтобы распространить делегированное удостоверение пользователя и разрешения с помощью цепочки запросов. | [Интерфейсы веб-API](scenario-web-api-call-api-overview.md) |
| [Учетные данные клиента](#client-credentials) | Обеспечивает доступ к Интернет-ресурсам, используя удостоверение приложения. Обычно используется для взаимодействия между серверами, которые должны выполняться в фоновом режиме без немедленного вмешательства пользователя. | [управляющая программа приложений](scenario-daemon-overview.md) |
| [Код устройства](#device-code) | Пользователи должны входить ограниченное ввода устройств, таких как смарт-ТВ, устройства Интернета вещей или принтер. | [Рабочий стол или мобильные приложения](scenario-desktop-acquire-token.md#command-line-tool-without-web-browser) |
| [Встроенная аутентификация Windows](scenario-desktop-acquire-token.md#integrated-windows-authentication) | Позволяет получить маркер в автоматическом режиме (без вмешательства пользовательского интерфейса от пользователя) приложения в домене или Azure Active Directory (Azure AD) присоединенных к компьютерам.| [Рабочий стол или мобильные приложения](scenario-desktop-acquire-token.md#integrated-windows-authentication) |
| [Имя пользователя и пароль](scenario-desktop-acquire-token.md#username--password) | Позволяет приложению вход пользователя непосредственно обрабатывая свой пароль. Этот поток не рекомендуется. | [Рабочий стол или мобильные приложения](scenario-desktop-acquire-token.md#username--password) | 

## <a name="interactive"></a>Interactive
MSAL поддерживает возможность интерактивно приглашение ввести свои учетные данные на вход и получить маркер с использованием этих учетных данных.

![Схема интерактивного потока](media/msal-authentication-flows/interactive.png)

Дополнительные сведения об использовании MSAL.NET интерактивного получения маркеров на определенных платформах см. в разделе:
- [Xamarin Android](msal-net-xamarin-android-considerations.md)
- [Xamarin iOS](msal-net-xamarin-ios-considerations.md)
- [Универсальная платформа Windows](msal-net-uwp-considerations.md)

Дополнительные сведения о интерактивные вызовы в MSAL.js, см. в разделе [поведение в интерактивных запросов MSAL.js подсказки](msal-js-prompt-behavior.md).

## <a name="implicit-grant"></a>Неявное разрешение

MSAL поддерживает [потоке предоставления OAuth 2 неявное](v2-oauth2-implicit-grant-flow.md), который позволяет приложению для получения маркеров из платформы удостоверений Microsoft без выполнения внутреннего сервера exchange учетных данных. Это позволяет приложению вход пользователя, поддерживать сеансы и получать маркеры для других веб-API, все это из клиентского кода JavaScript.

![Схема потока неявное предоставление](media/msal-authentication-flows/implicit-grant.svg)

Многие современные веб-приложения строятся как клиента, одной страницы приложения, написанные с помощью JavaScript или такие платформы SPA, Angular, Vue.js и React.js. Эти приложения выполняются в веб-браузер и имеют характеристики проверки подлинности, отличный от традиционных серверных веб-приложений. Платформы удостоверений позволяет приложениям одной страницы входа в систему и получить маркеры для доступа к внутренним службам или веб-API, с помощью неявного потока предоставления. Неявный поток позволяет приложению получить маркеры Идентификации для представления пользователя, прошедшего аутентификацию, а также маркеры, требовалось вызывать защищенный API доступа.

Этот поток проверки подлинности не включает сценарии приложений, использующих кросс платформенных инфраструктур JavaScript, например Electron и React-Native, так как они требуют дополнительные возможности для взаимодействия с платформ.

## <a name="authorization-code"></a>Код авторизации
MSAL поддерживает [предоставление кода авторизации OAuth 2](v2-oauth2-auth-code-flow.md). Это право может использоваться в приложениях, установленных на устройстве, чтобы получить доступ к защищенным ресурсам, таким как веб-API. Это позволяет добавить входа в систему и доступа к API для мобильных и настольных приложений. 

При входе пользователей веб-приложений (веб-сайты), веб-приложение получает код авторизации.  Чтобы получить маркер для вызова веб-API является обменять код авторизации. В ASP.NET и ASP.NET Core веб-приложениях, единственное предназначение этого `AcquireTokenByAuthorizationCode` — добавить маркер в кэш маркера. Затем маркер можно использовать для приложения (обычно в контроллерах, который просто получить маркер для API с помощью `AcquireTokenSilent`).

![Схема потока кода авторизации](media/msal-authentication-flows/authorization-code.png)

На предыдущей схеме приложения:

1. Запрашивает код авторизации, который используется для маркера доступа.
2. Использует маркер доступа для вызова веб-API.

### <a name="considerations"></a>Рекомендации
- Можно использовать только один раз код авторизации в обмене маркера. Не следует пытаться получить маркер несколько раз с тем же кодом авторизации (он запрещен явным образом в стандартной спецификации протокола). Если его активировать код несколько раз намеренно или не учитывать, что платформа также делает это автоматически, вы получите следующую ошибку: `AADSTS70002: Error validating credentials. AADSTS54005: OAuth2 Authorization code was already redeemed, please retry with a new valid code or use an existing refresh token.`

- Если вы создаете приложение ASP.NET или ASP.NET Core, это может произойти, если не сообщить платформе, вы уже активировали код авторизации. Для этого необходимо вызвать `context.HandleCodeRedemption()` метод `AuthorizationCodeReceived` обработчик событий.

- Избегайте совместного использования маркера доступа с помощью ASP.NET, что может помешать добавочное согласие, происходит правильно. Дополнительные сведения см. в разделе [выдавать #693](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/issues/693).

## <a name="on-behalf-of"></a>On-behalf-of

MSAL поддерживает [поток on-behalf-of аутентификации OAuth 2](v2-oauth2-on-behalf-of-flow.md).  Этот поток используется, когда приложение вызывает службу или веб-API, который в свою очередь должен вызывать другую службу или веб-API. Идея состоит в том, чтобы распространить делегированное удостоверение пользователя и разрешения с помощью цепочки запросов. Служба среднего уровня для прошедшего проверку подлинности запросов к подчиненной службе она должна для защиты маркера доступа с платформой Microsoft identity, от имени пользователя.

![Схема потока on-behalf-of](media/msal-authentication-flows/on-behalf-of.png)

На схеме выше:

1. Приложение получает маркер доступа для веб-API.
2. Клиент (Интернета, рабочего стола, мобильных или одностраничного приложения) вызывает защищенный веб-API, добавление маркер доступа в качестве маркера носителя в заголовке проверки подлинности HTTP-запроса. Веб-API проверяет подлинность пользователя.
3. Когда клиент вызывает веб-API, веб-API запрашивает другой токен on-behalf-of пользователя.  
4. Защищенный веб-API использует этот маркер для вызова нисходящего веб-API on-behalf-of пользователя.  Веб-API могут также более поздние версии запроса маркеров для других подчиненных API (но по-прежнему от имени одного пользователя).

## <a name="client-credentials"></a>Учетные данные клиента

MSAL поддерживает [поток учетных данных клиента OAuth 2](v2-oauth2-client-creds-grant-flow.md). Этот поток позволяет получить доступ к Интернет-ресурсам, используя удостоверение приложения. Этот тип предоставления разрешения часто используется для взаимодействия между серверами, которое должно выполняться в фоновом режиме без непосредственного взаимодействия с пользователем. Приложения такого типа часто называются управляющих программ или учетные записи служб. 

Разрешает поток предоставления учетных данных клиента веб-службы (конфиденциальный клиент) использовать свои собственные учетные данные вместо олицетворения пользователя, для проверки подлинности при вызове другой веб-службы. В этом сценарии клиент обычно является средний уровень веб-службы, служба управляющей программы или веб-сайта. Для большей надежности платформа удостоверений Майкрософт также позволяет вызывающей службе использовать в качестве учетных данных сертификат (вместо общего секрета).

> [!NOTE]
> Последовательность, конфиденциального клиента недоступна на мобильных платформах (UWP, Xamarin.iOS и Xamarin.Android), так как они поддерживают только общедоступных клиентских приложений. Открытый клиентские приложения не знаю, как для подтверждения удостоверения приложения для поставщика удостоверений. Безопасное подключение может осуществляться на веб-приложения или веб-API обратно заканчивается, развернув сертификат.

MSAL.NET поддерживает два типа учетных данных клиента. Эти учетные данные клиента должны быть зарегистрированы с помощью Azure AD. Учетные данные передаются в конструкторы конфиденциального клиентского приложения в коде.

### <a name="application-secrets"></a>Секреты приложений 

![Схема конфиденциального клиента с паролем](media/msal-authentication-flows/confidential-client-password.png)

На предыдущей схеме приложения:

1. Получает маркер, используя учетные данные приложения секретный код или пароль.
2. Использует маркер для выполнения запросов ресурса.

### <a name="certificates"></a>Сертификаты 

![Схема конфиденциального клиента с сертификатом](media/msal-authentication-flows/confidential-client-certificate.png)

На предыдущей схеме приложения:

1. Получает маркер, с помощью учетных данных сертификата.
2. Использует маркер для выполнения запросов ресурса.

Эти учетные данные клиента должны быть:
- Зарегистрировано в Azure AD.
- Переданный во время создания объекта конфиденциального клиентского приложения в коде.


## <a name="device-code"></a>Код устройства
MSAL поддерживает [потока кода OAuth 2 устройства](v2-oauth2-device-code.md), которая позволяет пользователям входить устройства, ограниченного входных данных, например, смарт-ТВ, устройства Интернета вещей или принтер. Интерактивная проверка подлинности с помощью Azure AD требует веб-браузер. Поток кода устройства пользователь может использовать другое устройство (например, другой компьютер или мобильный телефон) для входа в интерактивном режиме, где устройство или операционная система не предоставляет веб-браузер.

С помощью потока кода устройства, приложение получает маркеры через двухэтапный процесс, специально предназначенный для этих устройств и операционных систем. Примеры таких приложений относятся устройства под управлением устройствами Интернета вещей или средства командной строки (CLI). 

![Схема потока кода устройства](media/msal-authentication-flows/device-code.png)

На схеме выше:

1. Каждый раз, когда необходима проверка подлинности пользователя, приложение предоставляет код и пользователю предлагается использовать другое устройство (например смартфонов с подключением к Интернету), чтобы перейти на URL-адрес (например, https://microsoft.com/devicelogin). Пользователь будет предложено ввести код и продолжается по возможности обычной проверки подлинности, включая запросы согласия и многофакторной проверки подлинности, при необходимости.

2. После успешной проверки подлинности приложение командной строки получает необходимые маркеры через обратного канала и использует их для выполнения вызовов API web, которые необходимы.

### <a name="constraints"></a>Ограничения

- Поток кода устройства доступна только в общедоступных клиентских приложений.
- Центр, переданный при создании общедоступного клиентского приложения должен быть одним из следующих:
  - Клиентский (в формате `https://login.microsoftonline.com/{tenant}/` где `{tenant}` — это GUID, представляющий идентификатор клиента или домен, связанный с клиентом).
  - для любой рабочих и учебных учетных записей (`https://login.microsoftonline.com/organizations/`).
- Личные учетные записи Майкрософт еще не поддерживаются конечной точкой версии 2.0 Azure AD (нельзя использовать `/common` или `/consumers` клиентов).

## <a name="integrated-windows-authentication"></a>Встроенная проверка подлинности Windows
MSAL поддерживает встроенную проверку подлинности Windows (IWA) для рабочего стола или мобильных приложений, работающих на присоединенных к домену или Azure AD присоединенных к компьютеру Windows. С помощью IWA, эти приложения можно получить токен автоматически (без пользовательского интерфейса взаимодействия от пользователя). 

![Схема проверки подлинности встроенная Windows](media/msal-authentication-flows/integrated-windows-authentication.png)

На предыдущей схеме приложения:

1. Получает маркер, с помощью встроенной проверки подлинности Windows.
2. Использует маркер для выполнения запросов ресурса.

### <a name="constraints"></a>Ограничения

IWA поддерживает федеративных пользователей, то есть пользователей, созданные в Active Directory и с Azure AD. Пользователи, созданные непосредственно в Azure AD, без Active Directory для (управляемых пользователей) не могут использовать этот поток проверки подлинности. Это ограничение не влияет на [имя пользователя и пароль потока](#usernamepassword).

Для приложений, написанных для платформ .NET Framework, .NET Core и универсальной платформы Windows — IWA.

IWA не обойти многофакторную проверку подлинности. Если настроена многофакторная проверка подлинности, IWA может завершиться ошибкой, если требуется многофакторная проверка подлинности сложной задачей. Многофакторная проверка подлинности требует взаимодействия с пользователем.

Вы не контролируете, когда поставщик удостоверений запрашивает двухфакторная проверка подлинности должна выполнять. Выполняет администратора клиента. Как правило двухфакторной проверки подлинности является обязательным при входе из другой страны, если вы не подключены через VPN-Подключение к корпоративной сети, а иногда даже при подключении через VPN. Azure AD использует искусственный Интеллект постоянно дополнительные если двухфакторная проверка подлинности не требуется. В случае сбоя IWA вам следует переключиться на [интерактивный пользователь привилегиями] (#interactive).

Центр, переданный при создании общедоступного клиентского приложения должен быть одним из следующих:
- Клиентский (в формате `https://login.microsoftonline.com/{tenant}/` где `tenant` — это guid, представляющий идентификатор клиента или домен, связанный с клиентом).
- для любой рабочих и учебных учетных записей (`https://login.microsoftonline.com/organizations/`). Личные учетные записи Майкрософт не поддерживаются (вы не можете использовать `/common` или `/consumers` клиентов).

Поскольку IWA автоматической потока, одно из следующих должны выполняться условия.
- пользователь приложения должен ранее согласились использовать приложение. 
- Администратор клиента должен дали согласие на всех пользователей в клиенте на использование приложения ранее.

Это означает, что одно из следующих:
- Как разработчик вы выбрали **Grant** на портале Azure для себя.
- Администратора клиента выбрал **согласия администратора Grant/revoke для {домен}** в **разрешения API** вкладка регистрации для приложения (см. в разделе [добавить разрешения для доступа к веб-API ](quickstart-configure-app-access-web-apis.md#add-permissions-to-access-web-apis)).
- Вы предоставили пользователям предоставить согласие для приложения (см. в разделе [запрос на получение согласия пользователя](v2-permissions-and-consent.md#requesting-individual-user-consent)).
- Вы предоставили позволяет администратору клиентов предоставить согласие для приложения (см. в разделе [согласия администратора](v2-permissions-and-consent.md#requesting-consent-for-an-entire-tenant)).

Классические приложения .NET, .NET Core и приложениях универсальной платформы Windows включения потока IWA. В .NET Core доступна только перегрузка, принимающая имя пользователя. Платформа .NET Core не может задавать имя пользователя для операционной системы.
  
Дополнительные сведения о согласие, см. в разделе [версии 2.0 разрешения и согласие](v2-permissions-and-consent.md).

## <a name="usernamepassword"></a>Имя пользователя или пароль 
MSAL поддерживает [предоставление пароля владельца ресурса OAuth 2](v2-oauth-ropc.md), который позволяет приложению вход пользователя непосредственно обрабатывая свой пароль. В приложения для настольных компьютеров можно использовать потоку имя пользователя и пароль, чтобы получить маркер без вмешательства пользователя. Пользовательский Интерфейс не является обязательным при использовании приложения.

![Диаграмма передачи имени пользователя и пароля](media/msal-authentication-flows/username-password.png)

На предыдущей схеме приложения:

1. Получает маркер, отправив имя пользователя и пароль на поставщика удостоверений.
2. Вызывает веб-API с помощью маркера.

> [!WARNING]
> Этот поток не рекомендуется. Он необходим высокий уровень доверия и пользователем раскрытия.  Этот поток следует использовать только в том случае, когда потоки других, более безопасные, нельзя использовать. Дополнительные сведения см. в разделе [каково ее решение с растущей проблемой паролей?](https://news.microsoft.com/features/whats-solution-growing-problem-passwords-says-microsoft/). 

Основной поток для получения маркера без уведомления на компьютерах, присоединенных к домену Windows [встроенную проверку подлинности Windows](#integrated-windows-authentication). В противном случае можно также использовать [потока кода устройства](#device-code).

Несмотря на то, что это полезно в некоторых случаях (сценарии DevOps), если вы хотите использовать имя пользователя и пароль в интерактивных сценариях, где можно ввести собственный пользовательский Интерфейс, старайтесь избегать его. С помощью имени пользователя и пароля:
- Пользователи, которым необходимо выполнить многофакторную проверку подлинности не будет входить в систему (как никак не взаимодействует).
- Пользователи не будут иметь возможность единого входа.

### <a name="constraints"></a>Ограничения

Помимо [ограничения встроенной проверки подлинности Windows](#integrated-windows-authentication), также применяются следующие ограничения:

- Потоку имя пользователя и пароль не совместим с условным доступом и многофакторной проверки подлинности. Как следствие Если приложение выполняется в клиенте Azure AD, где администратор клиента требует многофакторной проверки подлинности, нельзя использовать этот поток. Во многих организациях для этого.
- Он работает только для рабочих и учебных учетных записей (не учетные записи Microsoft).
- Поток можно найти в Классические приложения .NET и .NET Core, но не в универсальной платформы Windows.

### <a name="azure-ad-b2c-specifics"></a>Особенности Azure AD B2C

Дополнительные сведения об использовании MSAL.NET и Azure AD B2C, см. в разделе [с помощью ROPC с B2C Azure AD (MSAL.NET)](msal-net-aad-b2c-considerations.md#resource-owner-password-credentials-ropc-with-azure-ad-b2c).
