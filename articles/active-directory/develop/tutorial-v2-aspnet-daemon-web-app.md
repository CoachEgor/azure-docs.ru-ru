---
title: Вызов веб-API ASP.NET, защищенного с помощью Azure AD. Платформа удостоверений Майкрософт
description: Из этого краткого руководства вы узнаете, как вызвать веб-API ASP.NET, защищенный с помощью Azure Active Directory, из приложения Windows Desktop (WPF). Клиент WPF выполняет проверку подлинности пользователя, запрашивает маркер доступа и вызывает веб-API.
services: active-directory
documentationcenter: dev-center-name
author: jmprieur
manager: CelesteDG
editor: ''
ms.assetid: ''
ms.service: active-directory
ms.subservice: develop
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 11/20/2019
ms.author: jmprieur
ms.custom: aaddev, identityplatformtop40, scenarios:getting-started, languages:ASP.NET
ms.collection: M365-identity-device-management
ms.openlocfilehash: c558d45702498e6c1164d7ee1731e80ff195349e
ms.sourcegitcommit: b77e97709663c0c9f84d95c1f0578fcfcb3b2a6c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/22/2019
ms.locfileid: "74328553"
---
# <a name="build-a-multi-tenant-daemon-with-the-microsoft-identity-platform-endpoint"></a>Создание мультитенантной управляющей программы с помощью конечной точки платформы удостоверений Майкрософт

В этом учебнике вы узнаете, как использовать платформу удостоверений Майкрософт для доступа к данным бизнес-клиентов Майкрософт с использованием продолжительного неинтерактивного процесса. Пример управляющей программы использует [предоставление учетных данных клиента OAuth2](v2-oauth2-client-creds-grant-flow.md) для получения маркера доступа, который затем используется для вызова [Microsoft Graph](https://graph.microsoft.io) и доступа к данным организации.

Мы создадим приложение MVC ASP.NET, в котором для входа пользователей используется ПО промежуточного слоя OWIN OpenID Connect.  Компонент "управляющая программа" приложения в этом примере представляет собой контроллер API, который при вызове извлекает список пользователей в арендаторе Azure AD пользователя из Microsoft Graph.  `SyncController.cs` активируется вызовом AJAX в веб-приложении и использует [библиотеку аутентификации Майкрософт (MSAL) для .NET](msal-overview.md), чтобы получить маркер доступа для Microsoft Graph.

Чтобы получить упрощенную консольную управляющую программу, ознакомьтесь со статьей [Краткое руководство. Получение маркера безопасности и вызов API Microsoft Graph из консольного приложения с помощью удостоверения приложения](quickstart-v2-netcore-daemon.md).

## <a name="scenario"></a>Сценарий

Так как это мультитенантное приложение, предназначенное для использования любым бизнес-арендатором корпорации Майкрософт, оно должно предоставить арендаторам возможность зарегистрироваться или подключить приложение к данным организации.  В рамках потока подключения администратор компании сначала напрямую предоставляет **разрешения** приложению, чтобы оно могло получать доступ к данным компании неинтерактивным способом (при отсутствии пользователя, выполнившего вход).  Большая часть логики в этом примере показывает, как реализовать этот поток подключения с помощью конечной точки предоставления [согласия администратора](v2-permissions-and-consent.md#using-the-admin-consent-endpoint) платформы удостоверений.

![Топология](./media/tutorial-v2-aspnet-daemon-webapp/topology.png)

Дополнительные сведения об основных понятиях, используемых в этом примере, см. в [документации по протоколу учетных данных клиента для конечной точки платформы удостоверений](v2-oauth2-client-creds-grant-flow.md).

## <a name="prerequisites"></a>Предварительные требования

Чтобы запустить пример в этом кратком руководстве, вам потребуется:

- [Visual Studio 2017 или 2019.](https://visualstudio.microsoft.com/downloads/)
- Клиент Azure Active Directory (Azure AD). Дополнительные сведения о том, как получить арендатор Azure AD, см. в [этой статье](quickstart-create-new-tenant.md).
- Одна или несколько учетных записей пользователей в арендаторе Azure AD. Этот пример не будет работать с учетной записью Майкрософт (ранее — учетная запись Windows Live). Таким образом, если вы вошли на [портал Azure](https://portal.azure.com) с помощью учетной записи Майкрософт и ранее не создали учетную запись пользователя в каталоге, ее необходимо создать сейчас.

## <a name="clone-or-download-this-repository"></a>Клонирование или скачивание этого репозитория

Из оболочки или командной строки:

```Shell
git clone https://github.com/Azure-Samples/active-directory-dotnet-daemon-v2.git
```

Вы также можете [скачать пример в виде ZIP-файла](https://github.com/Azure-Samples/ms-identity-aspnet-daemon-webapp/archive/master.zip).

## <a name="register-the-sample-application-with-your-azure-ad-tenant"></a>Регистрация примера приложения в арендаторе Azure AD

В этом примере присутствует один проект. Чтобы зарегистрировать его, можно выполнить следующие действия:

- Выполните действия, описанные в разделах [Регистрация примера приложения в арендаторе Azure AD](#register-the-sample-application-with-your-azure-ad-tenant) и [Выбор арендатора Azure Active Directory для приложения](#choose-the-azure-ad-tenant-for-the-applications).
- В качестве альтернативного варианта вы можете использовать скрипты PowerShell, которые:
  - **автоматически** создают приложения Azure AD и связанные объекты (пароли, разрешения и зависимости);
  - изменяют файлы конфигурации проектов Visual Studio.

Если вы хотите использовать этот способ автоматизации:

1. В Windows запустите PowerShell и перейдите в корень клонированного каталога.
1. В PowerShell запустите следующее:

   ```PowerShell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force
   ```

1. Запустите скрипт, чтобы создать приложение Azure AD и соответствующим образом настроить код примера приложения.
1. В PowerShell запустите следующее:

   ```PowerShell
   .\AppCreationScripts\Configure.ps1
   ```

   > Другие способы выполнения скриптов описаны в [этой статье](https://github.com/Azure-Samples/ms-identity-aspnet-daemon-webapp/blob/master/AppCreationScripts/AppCreationScripts.md).

1. Откройте решение Visual Studio и нажмите кнопку запуска, чтобы выполнить код.

Если вы не хотите использовать такой способ автоматизации, выполните приведенные ниже действия.

### <a name="choose-the-azure-ad-tenant-for-the-applications"></a>Выбор арендатора Azure Active Directory для приложения

В качестве первого шага сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com) с помощью личной учетной записи Майкрософт либо рабочей или учебной учетной записи.
1. Если ваша учетная запись имеется в нескольких клиентах Azure AD, выберите профиль в правом верхнем углу меню в верхней части страницы, а затем **переключите каталог**.
   Измените сеанс портала на нужный клиент Azure AD.

### <a name="register-the-client-app-dotnet-web-daemon-v2"></a>Зарегистрируйте клиентское приложение (dotnet-web-daemon-v2).

1. Перейдите на страницу [Регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) Платформы удостоверений Майкрософт для разработчиков.
1. Выберите **Новая регистрация**.
1. После появления страницы **Регистрация приложения** введите сведения о регистрации приложения:
   - В разделе **Имя** введите понятное имя приложения, которое будет отображаться пользователям приложения, например `dotnet-web-daemon-v2`.
   - В разделе **Поддерживаемые типы учетных записей** выберите **Учетные записи в любом каталоге организации**.
   - В разделе "URI перенаправления (необязательно)" выберите **Интернет** в поле со списком и введите следующие URI перенаправления:
       - `https://localhost:44316/`
       - `https://localhost:44316/Account/GrantPermissions`При наличии нескольких URI перенаправления их необходимо будет добавить на вкладке **Аутентификация** после успешного создания приложения.
1. Выберите **Зарегистрировать**, чтобы создать приложение.
1. На странице приложения **Обзор** найдите **идентификатор приложения (клиента)** и запишите его, чтобы использовать позже. Он понадобится для настройки файла конфигурации Visual Studio для этого проекта.
1. В списке страниц приложения выберите **Проверка подлинности**.
   - В разделе **Дополнительные параметры** задайте для параметра **URL-адрес выхода** значение `https://localhost:44316/Account/EndSession`.
   - В разделе **Дополнительные параметры** | **Неявное предоставление** установите флажки **Маркеры доступа** и **Токен идентификатора**, так как в этом примере требуется включить [поток неявного предоставления разрешений](v2-oauth2-implicit-grant-flow.md), чтобы предоставить пользователю вход в систему и вызвать API.
1. Щелкните **Сохранить**.
1. На странице **Сертификаты и секреты** в разделе **Секреты клиента** выберите **Новый секрет клиента**.

   - Введите описание ключа (экземпляр `app secret`).
   - Выберите срок действия ключа **1 год**, **2 года** или **Срок действия неограничен**.
   - Значение ключа отобразится после нажатия кнопки **Добавить**. Скопируйте и сохраните его в надежном расположении.
   - Этот ключ потребуется позже для настройки проекта в Visual Studio. Это значение ключа не будет отображаться повторно и не сможет быть извлечено другими способами, поэтому запишите его, как только оно отобразится на портале Azure.
1. Из списка страниц приложения выберите **Разрешения API**.
   - Нажмите кнопку **Добавить разрешение**.
   - Убедитесь, что вкладка **API Майкрософт** выбрана.
   - В разделе *Часто используемые интерфейсы API Microsoft* щелкните **Microsoft Graph**.
   - В разделе **Разрешения приложений** убедитесь, что выбраны нужные разрешения: **User.Read.All**.
   - Нажмите кнопку **Добавить разрешения**.

## <a name="configure-the-sample-to-use-your-azure-ad-tenant"></a>Настройка примера для использования арендатора Azure AD

На следующих шагах ClientID совпадает с идентификатором приложения или AppId.

Откройте решение в Visual Studio для настройки проектов.

### <a name="configure-the-client-project"></a>Настройка клиентского проекта

Если вы использовали скрипты установки, будут применены следующие изменения.

1. Откройте файл `UserSync\Web.Config`.
1. Найдите ключ приложения `ida:ClientId` и замените существующее значение идентификатором (clientId) приложения `dotnet-web-daemon-v2`, скопированным на портале Azure.
1. Найдите ключ приложения `ida:ClientSecret` и замените существующее значение ключом, сохраненным во время создания приложения `dotnet-web-daemon-v2` на портале Azure.

## <a name="run-the-sample"></a>Запуск примера

Очистите, повторно создайте решение, запустите приложение UserSync и войдите в систему от имени администратора в арендаторе Azure AD.  Если у вас нет арендатора Azure AD для тестирования, [выполните эти инструкции](quickstart-create-new-tenant.md), чтобы получить его.

Когда вы будете входить в систему, приложение сначала запросит у вас разрешение на вход и чтение профиля пользователя.  Это согласие подтверждает для приложения, что вы являетесь бизнес-пользователем.

![Предоставление согласия пользователем](./media/tutorial-v2-aspnet-daemon-webapp/firstconsent.png)

Приложение попытается синхронизировать список пользователей из арендатора Azure AD с помощью Microsoft Graph.  Если это не удается сделать, появится запрос, чтобы вы (администратор арендатора) подключили арендатор к приложению.

Затем приложение запросит разрешение на чтение списка пользователей в арендаторе.

![Согласие администратора](./media/tutorial-v2-aspnet-daemon-webapp/adminconsent.PNG)

**После предоставления разрешений вы выйдите из системы приложения**. Это делается для того, чтобы все существующие маркеры доступа для Graph были удалены из кэша маркеров. Когда вы повторно войдете, новый полученный маркер будет иметь необходимые разрешения для выполнения вызовов к Microsoft Graph.
Получив от вас разрешения, приложение сможет запрашивать пользователей в любой момент.  Это можно проверить, нажав кнопку **Синхронизация пользователей** на странице "Пользователи", что приведет к обновлению списка пользователей.  Попробуйте добавить или удалить пользователя и повторно синхронизировать список (но обратите внимание, что синхронизируется только первая страница списка пользователей).

## <a name="about-the-code"></a>Примечания о коде

Соответствующий код для этого примера находится в следующих файлах:

- Изначальный вход: `App_Start\Startup.Auth.cs`, `Controllers\AccountController.cs`.  В частности, действия на контроллере имеют атрибут авторизации, который принудительно выполняет вход пользователя в систему. Приложение использует [поток кода авторизации](v2-oauth2-auth-code-flow.md) для входа пользователя.
- Синхронизация списка пользователей с локальным хранилищем в памяти: `Controllers\SyncController.cs`.
- Отображение списка пользователей из локального хранилища в памяти: `Controllers\UserController.cs`.
- Получение разрешений от администратора арендатора с помощью конечной точки предоставления согласия администратора: `Controllers\AccountController.cs`.

## <a name="recreate-this-sample-app"></a>Повторное создание этого примера приложения

1. В Visual Studio создайте проект `Visual C#` `ASP.NET Web Application (.NET Framework)`. В следующем окне выберите шаблон проекта `MVC`. Добавьте ссылки на папку и основные компоненты для `Web API`, так как вы добавите контроллер веб-API позже.  Оставьте выбранный по умолчанию режим проверки подлинности проекта, то есть `No Authentication`.
2. Выберите проект в окне **обозревателя решений** и нажмите клавишу **F4**, чтобы вывести свойства проекта. В свойствах проекта задайте для параметра **SSL включен** значение `True`. Обратите внимание на **URL-адрес SSL**. Он понадобится при настройке регистрации этого приложения на портале Azure.
3. Добавьте следующие пакеты NuGet ПО промежуточного слоя ASP.NET OWIN: `Microsoft.Owin.Security.ActiveDirectory`, `Microsoft.Owin.Security.Cookies`, `Microsoft.Owin.Host.SystemWeb`, `Microsoft.IdentityModel.Protocol.Extensions`, `Microsoft.Owin.Security.OpenIdConnect` и `Microsoft.Identity.Client`. 
4. В папке `App_Start` создайте класс `Startup.Auth.cs`. Удалите `.App_Start` из имени пространства имен.  Замените код класса `Startup` кодом из того же файла примера приложения.  Обязательно примите все определение класса.  Определение изменится с `public class Startup` на `public partial class Startup`.
5. В `Startup.Auth.cs` разрешите отсутствующие ссылки, добавив инструкции `using`, предлагаемые Visual Studio IntelliSense.
6. Щелкните проект правой кнопкой мыши, выберите "Добавить", а затем — "Класс" и в поле поиска введите OWIN.  Отобразится выделенный пункт "Класс Startup OWIN". Выберите его и назовите класс `Startup.cs`.
7. В `Startup.cs` замените код класса `Startup` кодом из того же файла примера приложения.  Обратите внимание, что определение изменится с `public class Startup` на `public partial class Startup`.
8. В папке добавьте новый класс с именем `MsGraphUser.cs`.  Замените реализацию содержимым файла с тем же именем из примера.
9. Добавьте новый экземпляр **Контроллер MVC 5 — пустой** с именем `AccountController`. Замените реализацию содержимым файла с тем же именем из примера.
10. Добавьте новый экземпляр **Контроллер MVC 5 — пустой** с именем `UserController`. Замените реализацию содержимым файла с тем же именем из примера.
11. Добавьте новый экземпляр **Контроллер веб-API 2 — пустой** с именем `SyncController`. Замените реализацию содержимым файла с тем же именем из примера.
12. Для пользовательского интерфейса в папке `Views\Account` добавьте три **пустые представления (без модели)** с именами `GrantPermissions`, `Index` и `UserMismatch`, а также одно с именем `Index` в папке `Views\User`. Замените реализацию содержимым файла с тем же именем из примера.
13. Обновите `Shared\_Layout.cshtml` и `Home\Index.cshtml`, чтобы правильно связать различные представления.

## <a name="deploy-this-sample-to-azure"></a>Развертывание этого примера в Azure

Этот проект содержит проекты веб-приложения и веб-API. Чтобы развернуть их на веб-сайтах Azure, для каждого из них потребуется:

- создать веб-сайт Azure;
- опубликовать веб-приложение или веб-API на веб-сайте;
- изменить клиенты, настроив вызов веб-сайта, а не IIS Express.

### <a name="create-and-publish-the-dotnet-web-daemon-v2-to-an-azure-web-site"></a>Создание и публикация `dotnet-web-daemon-v2` на веб-сайте Azure

1. Войдите на [портале Azure](https://portal.azure.com).
1. Щелкните `Create a resource` в верхнем левом углу, выберите **Интернет** --> **Веб-приложение** и присвойте веб-сайту имя, например, `dotnet-web-daemon-v2-contoso.azurewebsites.net`.
1. Затем выберите `Subscription`, `Resource Group` и `App service plan and Location`. `OS` будет иметь значение **Windows**, а `Publish` — значение **Code**.
1. Щелкните `Create` и дождитесь создания службы приложений.
1. Получив уведомление `Deployment succeeded`, щелкните `Go to resource`, чтобы перейти к только что созданной службе приложений.
1. После создания веб-сайта перейдите на **панель мониторинга** и щелкните ее, чтобы открыть окно **обзора** **службы приложений**.
1. На вкладке **Обзор** службы приложений скачайте профиль публикации, щелкнув ссылку **Скачать профиль публикации**, и сохраните его.  Вы также можете использовать и другие механизмы развертывания, например развертывание из системы управления версиями.
1. Откройте Visual Studio и перейдите к проекту dotnet-web-daemon-v2.  В обозревателе решений щелкните правой кнопкой мыши проект и выберите **Опубликовать**.  Щелкните **Импортировать профиль** на нижней панели и импортируйте скачанный ранее профиль публикации.
1. Щелкните **Настроить** и в `Connection tab` обновите URL-адрес назначения так, чтобы он соответствовал `https` в URL-адресе домашней страницы, например, [https://dotnet-web-daemon-v2-contoso.azurewebsites.net](https://dotnet-web-daemon-v2-contoso.azurewebsites.net). Щелкните **Далее**.
1. Убедитесь, что на вкладке "Параметры" не выбран элемент `Enable Organizational Authentication`.  Выберите команду **Сохранить**. Щелкните **Опубликовать** на главном экране.
1. Visual Studio опубликует проект и автоматически откроет в браузере URL-адрес проекта.  Если отображается веб-страница по умолчанию проекта, публикация прошла успешно.

### <a name="update-the-azure-ad-tenant-application-registration-for-dotnet-web-daemon-v2"></a>Обновление регистрации приложения в арендаторе Azure AD для `dotnet-web-daemon-v2`

1. Вернитесь на [портал Azure](https://portal.azure.com).
В области навигации слева выберите службу **Azure Active Directory**, а затем выберите **Регистрация приложений**.
1. В окне результатов выберите приложение `dotnet-web-daemon-v2`.
1. На странице **Проверка подлинности** приложения обновите поля URL-адреса выхода, указав адрес службы, например, [https://dotnet-web-daemon-v2-contoso.azurewebsites.net](https://dotnet-web-daemon-v2-contoso.azurewebsites.net).
1. В меню *Фирменная символика* измените **URL-адрес домашней страницы** на адрес службы, например, [https://dotnet-web-daemon-v2-contoso.azurewebsites.net](https://dotnet-web-daemon-v2-contoso.azurewebsites.net). Сохраните конфигурацию.
1. Добавьте тот же URL-адрес в список значений в меню *Проверка подлинности > URI перенаправления*. При наличии нескольких URL-адресов перенаправления убедитесь в наличии новой записи, использующей универсальный код ресурса (URI) службы приложений для каждого URL-адреса перенаправления.

## <a name="community-help-and-support"></a>Справка и поддержка в сообществе

Для получения поддержки от сообщества используйте [Stack Overflow](http://stackoverflow.com/questions/tagged/msal).
Задайте вопросы на сайте Stack Overflow и просмотрите имеющиеся проблемы, чтобы узнать, не задавал ли кто-то аналогичные вопросы раньше.
Пометьте вопросы и комментарии тегом [`adal` `msal` `dotnet`].

Если в примере обнаружена ошибка, напишите об этой ошибке в разделе [проблем на сайте GitHub](https://github.com/Azure-Samples/ms-identity-aspnet-daemon-webapp/issues).

Если в MSAL.NET обнаружена ошибка, напишите об этой ошибке в разделе [проблем с MSAL.NET на сайте GitHub](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/issues).

Чтобы предоставить рекомендацию, посетите страницу [форума User Voice](https://feedback.azure.com/forums/169401-azure-active-directory).

## <a name="next-steps"></a>Дополнительная информация
Дополнительные сведения о различных потоках проверки подлинности и сценариях приложений, поддерживаемых платформой идентификации Майкрософт, см. [здесь](authentication-flows-app-scenarios.md).

Дополнительные сведения см. в следующей документации:

- [Tenancy in Azure Active Directory](single-and-multi-tenant-apps.md) (Аренда в Azure Active Directory)
- [Основные сведения о процедуре предоставления согласия для приложений Azure AD](application-consent-experience.md)
- [How to: Sign in any Azure Active Directory user using the multi-tenant application pattern](howto-convert-app-to-be-multi-tenant.md) (Вход любого пользователя Azure Active Directory с помощью шаблона мультитенантного приложения)
- [Understand user and admin consent](howto-convert-app-to-be-multi-tenant.md#understand-user-and-admin-consent) (Получение согласия пользователя и администратора)
- [Application and service principal objects in Azure Active Directory](app-objects-and-service-principals.md) (Объекты приложения и субъекта-службы в Azure Active Directory)
- [Краткое руководство Регистрация приложения с помощью платформы удостоверений Майкрософт](quickstart-register-app.md)
- [Краткое руководство Настройка клиентского приложения для доступа к веб-API](quickstart-configure-app-access-web-apis.md)
- [Public client and confidential client applications](msal-client-applications.md) (Общедоступные клиентские и конфиденциальные клиентские приложения)

Чтобы упростить консольное приложение консоли, ознакомьтесь со статьей [Краткое руководство. Получение маркера безопасности и вызов API Microsoft Graph из консольного приложения с помощью удостоверения приложения](quickstart-v2-netcore-daemon.md).
