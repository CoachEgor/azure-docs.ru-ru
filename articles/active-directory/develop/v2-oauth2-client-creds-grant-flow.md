---
title: Учетные данные клиентов OAuth 2.0 поступают на платформу идентификации Майкрософт Azure
description: Создавайте веб-приложения с помощью реализации платформы идентификации Microsoft протокола аутентификации OAuth 2.0.
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 12/17/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev, identityplatformtop40
ms.openlocfilehash: a03f8cb412b6d6ae95165331ae836bdfde5d670d
ms.sourcegitcommit: d187fe0143d7dbaf8d775150453bd3c188087411
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80886302"
---
# <a name="microsoft-identity-platform-and-the-oauth-20-client-credentials-flow"></a>Платформа идентификации Майкрософт и поток учетных данных клиентов OAuth 2.0

[Предоставление учетных данных клиента OAuth 2.0](https://tools.ietf.org/html/rfc6749#section-4.4), указанное в спецификации RFC 6749, которое иногда называют также *двусторонним OAuth*, можно использовать для доступа к интернет-ресурсам с помощью удостоверения приложения. Этот тип предоставления разрешения часто используется для взаимодействия между серверами, которое должно выполняться в фоновом режиме без непосредственного взаимодействия с пользователем. Такие типы приложений часто называют *управляющими программами* или *учетными записями служб*.

В этой статье описывается, как запрограммировать непосредственно против протокола в приложении. Когда это возможно, мы рекомендуем вам использовать поддерживаемые библиотеки подлинности Майкрософт (MSAL) вместо того, чтобы [приобретать токены и вызывать защищенные web-aIS.](authentication-flows-app-scenarios.md#scenarios-and-supported-authentication-flows)  Также взгляните на [образец приложений, которые используют MSAL](sample-v2-code.md).

Процесс предоставления учетных данных клиента OAuth 2.0 позволяет веб-службе (конфиденциальный клиент) вместо олицетворения пользователя использовать свои собственные учетные данные для аутентификации при вызове другой веб-службы. В этом сценарии клиент обычно является веб-службой среднего уровня, службой управляющей программы или веб-сайтом. Для большей надежности платформа удостоверений Майкрософт также позволяет вызывающей службе использовать в качестве учетных данных сертификат (вместо общего секрета).

> [!NOTE]
> Конечная точка платформы майкрософт не поддерживает все сценарии и функции Azure AD. Чтобы определить, следует ли использовать конечную точку платформы идентификации Майкрософт, прочитайте об [ограничениях платформы идентификации Майкрософт.](active-directory-v2-limitations.md)

В более распространенном сценарии *трехстороннего OAuth* клиентскому приложению предоставляется разрешение на доступ к ресурсу от имени определенного пользователя. Обычно разрешение делегируется от пользователя к приложению во время [предоставления разрешений](v2-permissions-and-consent.md) . Однако в потоке учетных данных клиента (*трехстороннего OAuth*) разрешения предоставляются приложению напрямую. Когда приложение предоставляет маркер для ресурса, то для выполнения действия этот ресурс требует авторизацию приложения, а не пользователя.

## <a name="protocol-diagram"></a>Схема протокола

Весь поток учетных данных клиента аналогичен приведенному на следующей схеме. Описание каждого шага приведено далее в этой статье.

![Диаграмма, показывающая поток учетных данных клиента](./media/v2-oauth2-client-creds-grant-flow/convergence-scenarios-client-creds.svg)

## <a name="get-direct-authorization"></a>Получение прямой авторизации

Как правило, приложение получает прямую авторизацию на доступ к ресурсу двумя способами:

* [через список управления доступом (ACL) в ресурсе;](#access-control-lists)
* [путем назначения разрешений приложению в Azure AD.](#application-permissions)

Эти два метода являются самыми распространенными в Azure AD, и их рекомендуется использовать для клиентов и ресурсов, применяющих поток учетных данных клиента. Ресурс также может выбрать другой способ авторизации клиентов. Каждый сервер ресурсов может выбрать метод, являющийся наиболее оптимальным для приложения.

### <a name="access-control-lists"></a>Доступ к спискам управления

Поставщик ресурсов может принудительно применять проверку авторизации на основе списка известных идентификаторов приложений (клиента), а также предоставлять определенный уровень доступа на основе этих идентификаторов. Когда ресурс получает токен из конечных точек платформы Майкрософт, он может декодировать `appid` токен и извлечь идентификатор приложения клиента из идентификатора приложения. `iss` Затем он проверяет наличие приложения в действующем списке управления доступом. Детализация и методы использования списка управления доступом для разных ресурсов могут значительно отличаться.

Нередко список управления доступом используется для выполнения тестов веб-приложения или веб-API. Веб-API может предоставить определенному клиенту только ограниченный набор прав доступа. Для выполнения сквозных тестов на API создайте тестовый клиент, который приобретает токены из конечных точек платформы Майкрософт, а затем отправляет их в API. Затем API может проверить идентификатор приложения тестового клиента с помощью списка управления доступом для предоставления доступа ко всем возможностям API. При использовании такого списка управления доступом нужно не только проверить значение `appid` вызывающей стороны, но и убедиться в надежности значения `iss` маркера.

Данный тип авторизации часто используется в управляющих программах и учетных записях служб, которым требуется доступ к данным пользователей, являющихся потребителями с личной учетной записью Майкрософт. Необходимую авторизацию для доступа к корпоративным данным рекомендуется получать с помощью разрешений приложения.

### <a name="application-permissions"></a>Разрешения приложения

Вместо использования ACL можно использовать AIS для размещения набора **разрешений приложений.** Администратор организации предоставляет приложению разрешения, которые можно использовать только для доступа к данным, принадлежащим этой организации и ее сотрудникам. Например, Microsoft Graph предоставляет несколько разрешений приложений для следующих действий:

* чтение почты во всех почтовых ящиках;
* чтение и запись почты во всех почтовых ящиках;
* отправка почты любым пользователем;
* Прочитать данные каталога

Дополнительные сведения о разрешениях приложения см. на сайте [Microsoft Graph](https://developer.microsoft.com/graph).

Чтобы использовать разрешения приложения в приложении, выполните шаги, описанные в следующих разделах.


> [!NOTE]
> При проверке подлинности как приложения, в отличие от пользователя, нельзя использовать "делегированные разрешения" (области, предоставляемые пользователем).  Необходимо использовать "разрешения приложений", также известные как "роли", которые предоставляются админом для приложения (или через предварительную авторизацию веб-API).    


#### <a name="request-the-permissions-in-the-app-registration-portal"></a>Запрос разрешений на портале регистрации приложения

1. Зарегистрируйтесь и создайте приложение через новый [опыт регистрации приложений (Preview).](quickstart-register-app.md)
2. Перейдите к своему заявлению в опыте регистрации приложений (Preview). Перейдите в раздел **Сертификаты & секреты,** и добавить **новый секрет клиента**, потому что вам понадобится по крайней мере один секрет клиента, чтобы запросить маркер.
3. Найдите раздел **Разрешения API** и добавьте **разрешения приложения**, необходимые для приложения.
4. **Сохраните** регистрацию приложения.

#### <a name="recommended-sign-the-user-into-your-app"></a>Рекомендуем: Подпишите пользователя в приложение

Обычно при создании приложения, использующего разрешения, для него нужно настроить страницу или представление, в котором администратор может утвердить разрешения приложения. Эта страница может быть частью потока входа в приложение, параметров приложения или выделенного потока подключения. Во многих случаях разумно отображать это представление подключения в приложении только после того, как пользователь выполнил вход с помощью учебной или рабочей учетной записи Майкрософт.

Если вы впишете пользователя в приложение, вы можете определить организацию, к которой принадлежит пользователь, прежде чем попросить пользователя одобрить разрешение приложения. Хотя это не обязательно, таким образом можно сделать пользовательский интерфейс более интуитивно понятным. Чтобы войти в систему пользователя, следуйте нашим [учебникам по протоколу платформы идентификации Майкрософт.](active-directory-v2-protocols.md)

#### <a name="request-the-permissions-from-a-directory-admin"></a>Запрос разрешений у администратора каталога

Когда вы будете готовы запросить разрешения у админа организации, вы можете перенаправить пользователя на *конечную точку согласия*пользователя Майкрософт.

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman. (Используйте свой собственный идентификатор приложения для достижения наилучших результатов - учебное приложение не будет запрашивать полезные разрешения.) [Попробуйте запустить этот запрос в Postman ![](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

```
// Line breaks are for legibility only.

GET https://login.microsoftonline.com/{tenant}/adminconsent?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&state=12345
&redirect_uri=http://localhost/myapp/permissions
```

```
// Pro tip: Try pasting the following request in a browser.
```

```
https://login.microsoftonline.com/common/adminconsent?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&state=12345&redirect_uri=http://localhost/myapp/permissions
```

| Параметр | Условие | Описание |
| --- | --- | --- |
| `tenant` | Обязательно | Клиент каталога, из которого необходимо запросить разрешение. Его можно указать в виде GUID или понятного имени. Если неизвестно, какому клиенту относится пользователь, и нужно обеспечить его вход с помощью любого клиента, используйте `common`. |
| `client_id` | Обязательно | **Идентификатор приложения (клиента),** который имеется на [портале Azure - Регистрация приложений,](https://go.microsoft.com/fwlink/?linkid=2083908) назначенная вашему приложению. |
| `redirect_uri` | Обязательно | Универсальный код ресурса (URI) перенаправления, на который нужно направлять ответ для обработки в приложении. Он должен в точности соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных на портале, но иметь вид URL-адреса. Он может содержать дополнительные сегменты пути. |
| `state` | Рекомендуемая | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |

На этом этапе Azure AD закрепляет, что только администратор-арендатор может войти в запрос. Администратору будет предложено утвердить все непосредственные разрешения, запрошенные для приложения на портале регистрации приложений.

##### <a name="successful-response"></a>Успешный ответ

Если администратор утверждает разрешения для приложения, успешный ответ будет выглядеть следующим образом.

```
GET http://localhost/myapp/permissions?tenant=a8990e1f-ff32-408a-9f8e-78d3b9139b95&state=state=12345&admin_consent=True
```

| Параметр | Описание |
| --- | --- |
| `tenant` | Клиент каталога, предоставивший приложению запрошенные разрешения в формате GUID. |
| `state` | Значение, добавленное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |
| `admin_consent` | Установить на **истину**. |

##### <a name="error-response"></a>Сообщение об ошибке

Если администратор не утверждает разрешения для приложения, сообщение о неудачном выполнении будет выглядеть следующим образом.

```
GET http://localhost/myapp/permissions?error=permission_denied&error_description=The+admin+canceled+the+request
```

| Параметр | Описание |
| --- | --- |
| `error` | Строка кода ошибки, которую можно использовать для классификации типов ошибок и реагирования на ошибки. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки. |

После получения успешного ответа от конечной точки подготовки приложения приложение получило запрошенные непосредственные разрешения. Теперь вы можете запросить маркер для ресурса, который вам нужен.

## <a name="get-a-token"></a>Получение маркера

Авторизовав приложение, можно переходить к получению маркеров доступа для интерфейсов API. Чтобы получить токен, используя грант учетных данных клиента, отправьте запрос POST в конечную точку платформы `/token` Майкрософт:

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman. (Используйте свой собственный идентификатор приложения для достижения наилучших результатов - учебное приложение не будет запрашивать полезные разрешения.) [Попробуйте запустить этот запрос в Postman ![](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

### <a name="first-case-access-token-request-with-a-shared-secret"></a>Первый сценарий: запрос маркера доступа с помощью общего секрета

```
POST /{tenant}/oauth2/v2.0/token HTTP/1.1           //Line breaks for clarity
Host: login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=535fb089-9ff3-47b6-9bfb-4f1264799865
&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default
&client_secret=qWgdYAmab0YSkuL1qKv5bPX
&grant_type=client_credentials
```

```
// Replace {tenant} with your tenant! 
curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d 'client_id=535fb089-9ff3-47b6-9bfb-4f1264799865&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default&client_secret=qWgdYAmab0YSkuL1qKv5bPX&grant_type=client_credentials' 'https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token'
```

| Параметр | Условие | Описание |
| --- | --- | --- |
| `tenant` | Обязательно | Клиент каталога, который будет использовать приложение, в формате GUID или доменного имени. |
| `client_id` | Обязательно | Идентификатор приложения, назначенный приложению. Эти сведения можно найти на портале, где вы зарегистрировали свое приложение. |
| `scope` | Обязательно | Значение, передаваемое для параметра `scope` в этом запросе, должно быть идентификатором требуемого ресурса (универсальным кодом ресурса (URI) идентификатора приложения) с суффиксом `.default`. В примере Microsoft Graph используется значение `https://graph.microsoft.com/.default`. <br/>Это значение указывает конечной точке платформы идентификации Майкрософт, что из всех разрешений прямого приложения, настроенных для вашего приложения, конечная точка должна выпустить маркер для тех, которые связаны с ресурсом, который вы хотите использовать. Дополнительные сведения об области `/.default` можно найти в документации о согласии [здесь](v2-permissions-and-consent.md#the-default-scope). |
| `client_secret` | Обязательно | Секрет клиента, который вы создали для приложения на портале регистрации приложений. Секрет клиента должен быть преобразован в формат URL-адреса перед отправкой. |
| `grant_type` | Обязательно | Нужно задать значение `client_credentials`. |

### <a name="second-case-access-token-request-with-a-certificate"></a>Второй сценарий: запрос маркера доступа с помощью сертификата

```
POST /{tenant}/oauth2/v2.0/token HTTP/1.1               // Line breaks for clarity
Host: login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

scope=https%3A%2F%2Fgraph.microsoft.com%2F.default
&client_id=97e0a5b7-d745-40b6-94fe-5f77d35c6e05
&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer
&client_assertion=eyJhbGciOiJSUzI1NiIsIng1dCI6Imd4OHRHeXN5amNScUtqRlBuZDdSRnd2d1pJMCJ9.eyJ{a lot of characters here}M8U3bSUKKJDEg
&grant_type=client_credentials
```

| Параметр | Условие | Описание |
| --- | --- | --- |
| `tenant` | Обязательно | Клиент каталога, который будет использовать приложение, в формате GUID или доменного имени. |
| `client_id` | Обязательно |Идентификатор приложения (клиента), который назначен приложению. |
| `scope` | Обязательно | Значение, передаваемое для параметра `scope` в этом запросе, должно быть идентификатором требуемого ресурса (универсальным кодом ресурса (URI) идентификатора приложения) с суффиксом `.default`. В примере Microsoft Graph используется значение `https://graph.microsoft.com/.default`. <br/>Это значение сообщает конечной точке платформы идентификации Майкрософт о том, что из всех разрешений прямого приложения, настроенных для вашего приложения, следует выпустить маркер для тех, которые связаны с ресурсом, который вы хотите использовать. Дополнительные сведения об области `/.default` можно найти в документации о согласии [здесь](v2-permissions-and-consent.md#the-default-scope). |
| `client_assertion_type` | Обязательно | Необходимо установить значение `urn:ietf:params:oauth:client-assertion-type:jwt-bearer`. |
| `client_assertion` | Обязательно | Утверждение (JSON Web Token), которое необходимо создать и подписать с помощью сертификата, зарегистрированного как учетные данные для приложения. Ознакомьтесь с информацией об [учетных данных сертификата](active-directory-certificate-credentials.md), чтобы узнать, как зарегистрировать сертификат и задать формат утверждения.|
| `grant_type` | Обязательно | Нужно задать значение `client_credentials`. |

Обратите внимание на то, что параметры являются почти такими же, как и при использовании запроса с помощью общего секрета, за исключением параметра client_secret, который заменяется двумя параметрами: client_assertion_type и client_assertion.

### <a name="successful-response"></a>Успешный ответ

Успешный ответ выглядит следующим образом.

```
{
  "token_type": "Bearer",
  "expires_in": 3599,
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBP..."
}
```

| Параметр | Описание |
| --- | --- |
| `access_token` | Запрашиваемый маркер доступа. Приложение может использовать этот маркер для аутентификации в защищенном ресурсе, таком как веб-API. |
| `token_type` | Указывает значение типа маркера. Единственный тип, который поддерживает `bearer`идентификационная платформа Майкрософт, — это. |
| `expires_in` | Срок действия маркера доступа (в секундах). |

### <a name="error-response"></a>Сообщение об ошибке

Сообщение об ошибке выглядит следующим образом.

```
{
  "error": "invalid_scope",
  "error_description": "AADSTS70011: The provided value for the input parameter 'scope' is not valid. The scope https://foo.microsoft.com/.default is not valid.\r\nTrace ID: 255d1aef-8c98-452f-ac51-23d051240864\r\nCorrelation ID: fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7\r\nTimestamp: 2016-01-09 02:02:12Z",
  "error_codes": [
    70011
  ],
  "timestamp": "2016-01-09 02:02:12Z",
  "trace_id": "255d1aef-8c98-452f-ac51-23d051240864",
  "correlation_id": "fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7"
}
```

| Параметр | Описание |
| --- | --- |
| `error` | Строка кода ошибки, которую можно использовать для классификации типов возникших ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |
| `error_codes` | Список кодов ошибок, характерных для службы маркеров безопасности, которые могут помочь при диагностике. |
| `timestamp` | Время, когда произошла ошибка. |
| `trace_id` | Уникальный идентификатор для запроса, который помогает при диагностике. |
| `correlation_id` | Уникальный идентификатор для запроса, который помогает при диагностике компонентов. |

## <a name="use-a-token"></a>Использование маркера

После получения маркера его можно использовать для выполнения запросов к ресурсу. По истечении срока действия маркера повторно отправьте запрос к конечной точке `/token`, чтобы получить новый маркер доступа.

```
GET /v1.0/me/messages
Host: https://graph.microsoft.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

```
// Pro tip: Try the following command! (Replace the token with your own.)
```

```
curl -X GET -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbG...." 'https://graph.microsoft.com/v1.0/me/messages'
```

## <a name="code-samples-and-other-documentation"></a>Примеры кода и другая документация

Чтобы получить дополнительные сведения об учетных данных клиента, прочтите [эту статью](https://aka.ms/msal-net-client-credentials) из библиотеки проверки подлинности Майкрософт.

| Образец | Платформа |Описание |
|--------|----------|------------|
|[active-directory-dotnetcore-daemon-v2](https://github.com/Azure-Samples/active-directory-dotnetcore-daemon-v2) | Консоль .NET Core 2.1 | Простое приложение .NET Core, которое отображает пользователей клиента, которые делают запрос в Microsoft Graph не от имени пользователя, а используя удостоверение приложения. В примере также показаны различные варианты проверки подлинности с помощью сертификатов. |
|[active-directory-dotnet-daemon-v2](https://github.com/Azure-Samples/active-directory-dotnet-daemon-v2)|ASP.NET MVC 3 | Веб-приложение, которое синхронизирует данные из Microsoft Graph на основе удостоверения приложения, а не имени пользователя. |
