---
title: Azure Active Directory. Справочные материалы о критических изменениях | Документация Майкрософт
description: Дополнительные сведения об изменениях, внесенных в протоколы Azure AD, которые могут повлиять на приложение.
services: active-directory
documentationcenter: ''
author: rwike77
manager: CelesteDG
editor: ''
ms.assetid: 68517c83-1279-4cc7-a7c1-c7ccc3dbe146
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 08/28/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: 6dd50aa00368469a9c5b42c41826da28566268d4
ms.sourcegitcommit: 07700392dd52071f31f0571ec847925e467d6795
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2019
ms.locfileid: "70125420"
---
# <a name="whats-new-for-authentication"></a>Новые возможности для проверки подлинности. 

>Получайте уведомления об обновлениях этой страницы. Добавьте [этот URL-адрес](https://docs.microsoft.com/api/search/rss?search=%22whats%20new%20for%20authentication%22&locale=en-us) своему читателю RSS-канала.

Система проверки подлинности изменяет и добавляет функции на постоянной основе для безопасности и соответствия стандартам. Чтобы вы оставались в курсе последних разработок, в этой статье предоставлены такие сведения:

- Новые возможности
- Известные проблемы
- Изменения протокола
- Нерекомендуемые функции.

> [!TIP] 
> Эта страница обновляется регулярно, поэтому нужно часто пересматривать ее. Если иное не указано, эти изменения вводятся только для приложений, зарегистрированных после вступления в силу соответствующих изменений.  

## <a name="upcoming-changes"></a>Предстоящие изменения

Сентябрь 2019: Дополнительное применение семантики POST в соответствии с правилами анализа URL-адресов. при дублировании параметров будет вызвана ошибка и [Спецификация](https://www.w3.org/International/questions/qa-byte-order-mark) пропускается.

## <a name="august-2019"></a>Август 2019 г.

### <a name="post-form-semantics-will-be-enforced-more-strictly---spaces-and-quotes-will-be-ignored"></a>Семантика отправки формы будет требовать более строгого пробела, а кавычки будут пропущены.

**Дата вступления в силу**: 2 сентября 2019 г.

**Затронутые конечные точки**: версии 1.0 и 2.0.

**Затронутый протокол**: Используется запись в любом месте[(учетные данные клиента](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow), [код авторизации активации](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow), [ропк](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth-ropc), [OBO](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow)и активация [токена обновления](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow#refresh-the-access-token)).

Начиная с 9/2 недели, запросы проверки подлинности, использующие метод POST, будут проверены с использованием более длинных стандартов HTTP.  В частности, пробелы и двойные кавычки (") больше не будут удаляться из значений формы запроса. Эти изменения не приводят к нарушению работы существующих клиентов и гарантируют, что запросы, отправляемые в Azure AD, будут надежно обрабатываться каждый раз. В будущем (см. выше) мы планируем дополнительно отклонить дублирующиеся параметры и игнорировать СПЕЦИФИКАЦИю в запросах. 

Пример:

В настоящее `?e=    "f"&g=h` время синтаксический анализ выполняется так `?e=f&g=h` же, `e`как и  ==  `f`.  После этого изменения он будет проанализирован таким образом, что `e`  ==  `    "f"` это вряд ли будет допустимым аргументом, и запрос теперь завершится ошибкой. 


## <a name="july-2019"></a>2019 июля

### <a name="app-only-tokens-for-single-tenant-applications-are-only-issued-if-the-client-app-exists-in-the-resource-tenant"></a>Маркеры только для приложения для приложений с одним клиентом выдаются только в том случае, если клиентское приложение существует в клиенте ресурса.

**Дата вступления в силу**: 26 июля 2019 г.

**Затронутые конечные точки**: [V 1.0](https://docs.microsoft.com/azure/active-directory/develop/v1-oauth2-client-creds-grant-flow) и [v 2.0](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow)

**Затронутый протокол**: [Учетные данные клиента (токены только для приложений)](https://docs.microsoft.com/azure/active-directory/develop/v1-oauth2-client-creds-grant-flow)

Изменена безопасность, 26th июля, которая изменяет способ выдачи маркеров, доступных только для приложений (через предоставление учетных данных клиента). Ранее приложениям было разрешено получать маркеры для вызова любого другого приложения независимо от наличия в клиенте или ролях, которые были предоставлены для этого приложения.  Это поведение было обновлено таким образом, чтобы для ресурсов (иногда называемых веб-интерфейсами API) был установлен режим "один клиент" (по умолчанию), клиентское приложение должно существовать в клиенте ресурса.  Обратите внимание, что существующее согласие между клиентом и API по-прежнему не требуется, и приложения должны выполнять собственные проверки авторизации, чтобы убедиться `roles` в наличии утверждения и содержать ожидаемое значение для API.

В настоящее время сообщение об ошибке для этого сценария указывает на следующее: 

`The service principal named <appName> was not found in the tenant named <tenant_name>. This can happen if the application has not been installed by the administrator of the tenant.`

Чтобы устранить эту проблему, используйте интерфейс предоставления согласия администратора для создания субъекта-службы клиентского приложения в клиенте или создайте его вручную.  Это требование гарантирует, что клиент предоставил приложению разрешение на работу в клиенте.  

#### <a name="example-request"></a>Пример запроса

`https://login.microsoftonline.com/contoso.com/oauth2/authorize?resource=https://gateway.contoso.com/api&response_type=token&client_id=14c88eee-b3e2-4bb0-9233-f5e3053b3a28&...`В этом примере клиент ресурсов (центр) — это contoso.com, а приложение ресурсов — это приложение с одним клиентом, которое `gateway.contoso.com/api` вызывается для клиента Contoso, а клиентское приложение `14c88eee-b3e2-4bb0-9233-f5e3053b3a28`—.  Если у клиентского приложения есть субъект-служба в Contoso.com, этот запрос может быть продолжен.  Однако если это не так, запрос завершится с ошибкой, описанной выше.  

Однако если приложение шлюза Contoso было приложением с несколькими клиентами, то запрос будет продолжать работать независимо от клиентского приложения с субъектом-службой в Contoso.com.  

### <a name="redirect-uris-can-now-contain-query-string-parameters"></a>URI перенаправления теперь могут содержать параметры строки запроса

**Дата вступления в силу**: 22 июля 2019 г.

**Затронутые конечные точки**: версии 1.0 и 2.0.

**Затронутый протокол**: Все потоки

В соответствии с [RFC 6749](https://tools.ietf.org/html/rfc6749#section-3.1.2)приложения Azure AD теперь могут регистрировать и использовать URI перенаправления (ответ) со статическими параметрами запроса ( https://contoso.com/oauth2?idp=microsoft) например, для запросов OAuth 2,0).  Динамические URI перенаправления по-прежнему запрещены, так как они представляют угрозу безопасности, и не могут использоваться для сохранения сведений о состоянии в запросе на проверку подлинности. для этого используется `state` параметр.

Параметр статического запроса подлежит совпадению строк для URI перенаправления, как и любая другая часть URI перенаправления. Если ни одна строка не зарегистрирована, совпадающая с URI-адресом redirect_uri, то запрос будет отклонен.  Если URI найден в регистрации приложения, то для перенаправления пользователя будет использоваться вся строка, включая параметр статического запроса. 

Обратите внимание, что в настоящее время (окончание июля 2019) пользовательский интерфейс регистрации приложений в портал Azure все еще блокирует параметры запроса.  Однако можно изменить манифест приложения вручную, чтобы добавить параметры запроса и проверить это в приложении.  


## <a name="march-2019"></a>Март 2019 г.

### <a name="looping-clients-will-be-interrupted"></a>Циклическое выполнение клиентов будет прервано

**Дата вступления в силу**: 25 марта 2019 г.

**Затронутые конечные точки**: версии 1.0 и 2.0.

**Затронутый протокол**: Все потоки

Иногда клиентские приложения могут вести себя некорректно, выдавая сотни одинаковых запросов на вход в течение короткого периода времени.  Эти запросы могут быть неуспешными, но все они способствуют снижению пользовательского интерфейса и повышенной рабочей нагрузке для IDP, увеличению задержки для всех пользователей и уменьшению доступности IDP.  Эти приложения работают вне границ обычного использования и должны быть обновлены для правильной работы.  

Клиенты, которые выдают дублирующиеся запросы несколько раз, `invalid_grant` будут отправлять `AADSTS50196: The server terminated an operation because it encountered a loop while processing a request`сообщение об ошибке:. 

Большинству клиентов не нужно изменять поведение, чтобы избежать этой ошибки.  Эта ошибка может повлиять только на неправильно настроенные клиенты (без кэширования маркеров или с помощью таких циклов запросов).  Клиенты отправляются локально (через файл cookie) на основе каждого экземпляра по следующим факторам:

* Подсказка пользователя, если таковая имеется

* Области или запрашиваемый ресурс

* Идентификатор клиента

* URI-перенаправления

* Тип и режим ответа

Приложения, выполняющие несколько запросов (более 15) в течение короткого периода времени (5 минут), `invalid_grant` получат сообщение об ошибке, объясняющее, что они находятся в цикле.  Запрашиваемые токены имеют достаточно длительное время существования (по умолчанию 10 минут, 60 минут), поэтому повторяющиеся запросы за этот период времени не нужны.  

Все приложения должны работать `invalid_grant` , отображая Интерактивные запросы, а не запрашивать маркер автоматически.  Чтобы избежать этой ошибки, клиенты должны убедиться в том, что они правильно кэшируют маркеры, которые они получают.


## <a name="october-2018"></a>Октябрь 2018 г.

### <a name="authorization-codes-can-no-longer-be-reused"></a>Коды авторизации больше нельзя использовать повторно

**Дата вступления в силу**: 15 ноября 2018 г.

**Затронутые конечные точки**: версии 1.0 и 2.0.

**Затронутый протокол**: [поток кода](v2-oauth2-auth-code-flow.md).

С 15 ноября 2018 г. в Azure AD прекращается поддержка использованных кодов аутентификации для приложений. Это изменение системы безопасности помогает Azure AD соответствовать спецификации OAuth и будет применяться для конечных точек версии 1 и 2.

Если ваше приложение повторно использует коды проверки подлинности для получения маркеров для нескольких ресурсов, мы рекомендуем использовать код для получения маркера обновления, а затем использовать этот маркер для получения дополнительных маркеров для других ресурсов. Коды проверки подлинности можно использовать только один раз, однако маркеры обновления можно использовать несколько раз для нескольких ресурсов. Любое новое приложение, которое пытается повторно использовать код проверки подлинности во время потока кода OAuth, получит ошибку invalid_grant.

Дополнительные сведения о маркерах обновления см. в статье [Обновление маркеров доступа](v1-protocols-oauth-code.md#refreshing-the-access-tokens).  При использовании ADAL или MSAL обработку выполняет библиотека — замените второй экземпляр AcquireTokenByAuthorizationCodeAsync на AcquireTokenSilentAsync. 

## <a name="may-2018"></a>Май 2018 г.

### <a name="id-tokens-cannot-be-used-for-the-obo-flow"></a>Для потока OBO нельзя использовать маркеры идентификации

**Дата**. 1 мая 2018 г.

**Затронутые конечные точки**: версии 1.0 и 2.0.

**Затронутые протоколы**: неявный поток и [поток OBO](v1-oauth2-on-behalf-of-flow.md)/

Начиная с 1 мая 2018 г. новые приложения не могут использовать маркеры id_token в качестве утверждения в потоке OBO. Вместо этого следует использовать маркеры доступа для защиты API, даже между клиентом и средним уровнем того же приложения. Приложения, зарегистрированные до 1 мая 2018 г., будут дальше работать с возможностью замены маркеров id_token на маркеры доступа, но это нерекомендуемый подход.

Чтобы обойти это изменение, можно сделать следующее.

1. Создайте веб-API для своего приложения с одной или несколькими областями. Такая явная точка входа позволит обеспечить более точный контроль и защиту.
1. В манифесте вашего приложения, на [портале Azure](https://portal.azure.com) или [портале регистрации приложений](https://apps.dev.microsoft.com), убедитесь, что приложению разрешено выдавать маркеры доступа через неявный поток. Это определяется с помощью ключа `oauth2AllowImplicitFlow`.
1. Когда ваше клиентское приложение запрашивает id_token через `response_type=id_token`, оно также запрашивает маркер доступа (`response_type=token`) для веб-API, созданного выше. Таким образом при использовании конечной точки версии 2.0 параметр `scope` должен выглядеть примерно так: `api://GUID/SCOPE`. В конечной точке версии 1.0 параметр `resource` должен быть универсальным кодом ресурса (URI) приложения веб-API.
1. Передайте этот маркер доступа на средний уровень вместо id_token.  
