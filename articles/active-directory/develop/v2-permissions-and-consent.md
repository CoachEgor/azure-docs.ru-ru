---
title: Области, разрешения и согласие платформы идентификации Майкрософт Документы Майкрософт
description: Описание авторизации в конечной точке платформы майкрософт, включая области, разрешения и согласие.
services: active-directory
documentationcenter: ''
author: rwike77
manager: CelesteDG
editor: ''
ms.assetid: 8f98cbf0-a71d-4e34-babf-e644ad9ff423
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 1/3/2020
ms.author: ryanwi
ms.reviewer: hirsin, jesakowi, jmprieur
ms.custom: aaddev, fasttrack-edit
ms.openlocfilehash: f4b51641ed6bd7317060b567cf839775be426ac8
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80050052"
---
# <a name="permissions-and-consent-in-the-microsoft-identity-platform-endpoint"></a>Разрешения и согласие для конечной точки платформы удостоверений Майкрософт

Приложения, которые интегрируются с платформой удостоверений Майкрософт, следуют модели авторизации, при которой пользователи и администраторы контролируют доступ к данным. Реализация модели авторизации была обновлена на конечной точке платформы майкрософт и меняет способ взаимодействия приложения с платформой идентификации Майкрософт. В этой статье рассматриваются основные понятия этой модели авторизации, включая области, разрешения и согласие на их предоставление.

> [!NOTE]
> Конечная точка платформы идентификации Майкрософт не поддерживает все сценарии и функции. Чтобы определить, следует ли использовать конечную точку платформы идентификации Майкрософт, прочитайте об [ограничениях платформы идентификации Майкрософт.](active-directory-v2-limitations.md)

## <a name="scopes-and-permissions"></a>Области и разрешения

Платформа удостоверений Майкрософт реализует протокол авторизации [OAuth 2.0](active-directory-v2-protocols.md). OAuth 2.0 — это метод, посредством которого стороннее приложение может обращаться к интернет-ресурсам от имени пользователя. Любой интернет-ресурс, интегрируемый с платформой удостоверений Майкрософт, имеет идентификатор ресурса или *универсальный код ресурса (URI) идентификатора приложения*. К примеру, ниже приведены некоторые из размещенных в Интернете ресурсов Майкрософт:

* Microsoft Graph: `https://graph.microsoft.com`
* API почты Office 365: `https://outlook.office.com`;
* Убежище ключей Azure:`https://vault.azure.net`

> [!NOTE]
> Мы настоятельно рекомендуем использовать Microsoft Graph вместо API Office 365 Mail и т.д.

То же касается любых сторонних ресурсов, интегрированных с платформой удостоверений Майкрософт. Любой из этих ресурсов может также определять набор разрешений, с помощью которых можно разделить функции ресурса на меньшие блоки. Например, в [Microsoft Graph](https://graph.microsoft.com) определены разрешения для выполнения таких задач, как:

* чтение календаря пользователя;
* запись в календарь пользователя;
* отправка сообщений в качестве пользователя.

Благодаря определению этих разрешений ресурс получает детализированный контроль над своими данными и предоставлением внешнего доступа к функционалу API. Стороннее приложение может запрашивать эти разрешения у пользователей и администраторов. Они должны подтвердить такой запрос, прежде чем приложение получит доступ к данным или начнет действовать от имени пользователя. Разделяя функции ресурса на меньшие наборы разрешений, приложения сторонних производителей можно настроить таким образом, чтобы они запрашивали только определенные разрешения, необходимые им для выполнения своих задач. Пользователи и администраторы могут точно знать, к каким данным приложение имеет доступ, и они могут быть более уверены, что оно ведет себя не со злыми намерениями. Разработчики должны всегда придерживаться принципа минимальных прав доступа и запрашивать только те разрешения, которые необходимы для работы приложения.

В OAuth 2.0 разрешения такого типа называются *областями*. Они также часто называют *разрешения.* На платформе удостоверений Майкрософт они представлены в виде значения строки. Продолжим рассмотрение примера для Microsoft Graph. Значение строки для каждого разрешения следующее:

* чтение календаря пользователя с помощью `Calendars.Read`;
* запись в календарь пользователя с помощью `Calendars.ReadWrite`;
* отправка сообщений в качестве пользователя с помощью `Mail.Send`.

Приложение чаще всего запрашивает эти разрешения, указывая области в запросах на платформу идентификации Майкрософт, авторизующую конечную точку. Однако некоторые разрешения на высокие привилегии могут быть предоставлены только с согласия администратора и запрошены/предоставлены с помощью [конечной точки согласия администратора.](v2-permissions-and-consent.md#admin-restricted-permissions) Ознакомьтесь с дополнительными сведениями, чтобы узнать больше.

## <a name="permission-types"></a>Типы разрешений

Платформа удостоверений Майкрософт поддерживает два типа разрешений: **делегированное разрешение** и **разрешение приложения**.

* **Делегированные разрешения** используются приложениями с авторизованным пользователем. Для этих приложений пользователь или администратор соглашается на разрешения, которые запрашивает приложение, и приложению делегируется разрешение выступать в качестве пользователя, включенного в нее при звонках на целевой ресурс. Для некоторых делегированных разрешений могут предоставить согласие пользователи без прав администратора, а для других разрешений, с более высоким уровнем прав, необходимо [согласие администратора](v2-permissions-and-consent.md#admin-restricted-permissions). Сведения о том, администраторы каких ролей могут предоставлять делегированные разрешения, см. в статье [Разрешения роли администратора в Azure Active Directory](../users-groups-roles/directory-assign-admin-roles.md).

* **Разрешения приложений** используются в приложениях, работающих без авторизованного пользователя (например, приложения, работающие как фоновые службы или управляющие программы).  Для таких разрешений согласие предоставляет [только администратор](v2-permissions-and-consent.md#requesting-consent-for-an-entire-tenant).

_Действующие разрешения_ — это разрешения, которые есть у приложений при запросе целевого ресурса. Важно понимать разницу между делегированными и приложениями, которые предоставляется приложению, и его эффективными разрешениями при вызове на целевой ресурс.

- Для делегированных разрешений _действующие разрешения_ приложения являются минимальным пересечением делегированных разрешений, предоставленных приложению (с согласия пользователя), и привилегий авторизованного пользователя. Приложения не могут иметь больше привилегий, чем авторизованный пользователь. В рамках организаций привилегии авторизованного пользователя могут определяться политикой или членством в одной или нескольких ролях администратора. Сведения о том, администраторы каких ролей могут предоставлять делегированные разрешения, см. в статье [Разрешения роли администратора в Azure Active Directory](../users-groups-roles/directory-assign-admin-roles.md).

   Например, предположим, что вашему приложению предоставлено делегированное разрешение _User.ReadWrite.All_. Это разрешение номинально предоставляет вашему приложению разрешение читать и обновлять профиль каждого пользователя в организации. Если авторизованный пользователь является глобальным администратором, ваше приложение сможет обновлять профиль каждого пользователя в организации. Однако, если пользователь, вписанный в нее, не в роли администратора, ваше приложение сможет обновлять только профиль пользователя, вписавого в нее. Оно не сможет обновлять профили других пользователей в организации, потому что пользователь, от имени которого это приложение действует, не имеет таких привилегий.
  
- Для разрешений приложений _действующие разрешения_ вашего приложения будут представлять собой полный уровень привилегий, подразумеваемых разрешением. Например, приложение, имеющее разрешение _User.ReadWrite.All_, может обновлять профиль каждого пользователя в организации. 

## <a name="openid-connect-scopes"></a>Области OpenId Connect

Реализация платформы идентификации Microsoft OpenID Connect имеет несколько четко определенных областей, `profile`которые `offline_access`не применяются к определенному ресурсу: `openid` `email`, и . Области OpenID Connect `address` и `phone` не поддерживаются.

### <a name="openid"></a>OpenId

Если приложение выполняет вход с помощью протокола [OpenID Connect](active-directory-v2-protocols.md), оно должно запросить область `openid`. В рабочей учетной записи область `openid` отображается на странице согласия в виде разрешения "Вход", а в личной учетной записи Майкрософт — в виде разрешения "View your profile and connect to apps and services using your Microsoft account" (Просмотр профиля и подключение к приложениям и службам с помощью учетной записи Майкрософт). Это разрешение позволяет приложению получить уникальный идентификатор для пользователя в виде утверждения `sub`. Оно также предоставляет приложению доступ к конечной точке сведений о пользователе. Область `openid` может быть использована в токене платформы Майкрософт для приобретения токенов ID, которые могут быть использованы приложением для проверки подлинности.

### <a name="email"></a>email

Область `email` можно использовать вместе с областью `openid` и любыми другими областями. Она предоставляет приложению доступ к основному электронному адресу пользователя в виде утверждения `email`. Претензия `email` включена в токен только в том случае, если адрес электронной почты связан с учетной записью пользователя, что не всегда так. При использовании области `email` приложение должно быть готово обрабатывать случаи, когда утверждение `email` в маркере отсутствует.

### <a name="profile"></a>Профиль

Область `profile` можно использовать вместе с областью `openid` и любыми другими областями. Она предоставляет приложению доступ к существенному объему сведений о пользователе. Информация, к которую он может получить доступ, включает, но не ограничивается, имя пользователя, фамилия, предпочтительное имя пользователя и идентификатор объекта. Для полного списка претензий профиля, доступных в id_tokens [ `id_tokens` ](id-tokens.md)параметре для конкретного пользователя, см.

### <a name="offline_access"></a>offline_access

[ `offline_access` Область](https://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess) предоставляет приложению доступ к ресурсам от имени пользователя в течение длительного времени. На странице предоставления согласия эта область отображается в виде разрешения "Maintain access to data you have given it access to" (Сохранение доступа к данным, к которым он был предоставлен). Когда пользователь утверждает `offline_access` область действия, приложение может получать маркеры обновления с точки конечных токенов платформы Майкрософт. Маркеры обновления имеют большой срок действия. Приложение может получать новые маркеры доступа после того, как срок действия старых истечет.

> [!NOTE]
> Это разрешение отображается на всех экранах согласия сегодня, даже для потоков, которые не обеспечивают маркер обновления [(неявного потока).](v2-oauth2-implicit-grant-flow.md)  Это необходимо для покрытия сценариев, в которых клиент может начать сяпом в потоке, а затем перейти к потоку кода, где ожидается обновление токена.

На платформе идентификации Майкрософт (запросы, сделанные в конечную точку v2.0) приложение должно явно запросить `offline_access` область действия, чтобы получить маркеры обновления. Это значит, что при использовании кода авторизации в [потоке кода авторизации OAuth 2.0](active-directory-v2-protocols.md) от конечной точки `/token` вы получите только маркер доступа. Маркер доступа действителен недолго. Как правило, его срок действия истекает через один час. В этот момент приложению будет необходимо перенаправить пользователя обратно к конечной точке `/authorize`, чтобы получить новый код авторизации. При этом, в зависимости от типа приложения, пользователю может потребоваться повторно ввести учетные данные или предоставить разрешения. 

Для получения дополнительной информации о том, как [Microsoft identity platform protocol reference](active-directory-v2-protocols.md)получить и использовать маркеры обновления, см.

## <a name="requesting-individual-user-consent"></a>Запрос на получение согласия одного пользователя

В запросе авторизации [OpenID Connect или OAuth 2.0](active-directory-v2-protocols.md) приложение может запросить необходимые разрешения с помощью параметра запроса `scope`. Например, при входе пользователя в приложение оно отправит запрос следующего вида (разрывы строк добавлены для удобства чтения).

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=
https%3A%2F%2Fgraph.microsoft.com%2Fcalendars.read%20
https%3A%2F%2Fgraph.microsoft.com%2Fmail.send
&state=12345
```

Параметр `scope` — это запрашиваемый приложением список делегированных разрешений с разделителями-пробелами. Чтобы указать каждое разрешение, его значение добавляется к идентификатору ресурса (универсальному коду ресурса (URI) идентификатора приложения). В приведенном примере запроса приложению требуется разрешение на чтение календаря пользователя и отправку сообщений от его имени.

После того, как пользователь вводит свои учетные данные, конечная точка платформы Майкрософт проверяет на соответствие записи *согласия пользователя.* Если пользователь не дал согласия ни на один из запрошенных разрешений в прошлом, а также не дал согласия администратора на эти разрешения от имени всей организации, конечная точка платформы Майкрософт просит пользователя предоставить запрошенные разрешения.

> [!NOTE]
>В настоящее время разрешения `offline_access` ("Maintain access to data you have given it access to" (Сохранение доступа к данным, к которым он был предоставлен)) и `user.read` ("Sign you in and read your profile" (Вход и чтение профиля)) автоматически добавляются в начальное согласие для приложения.  Обычно эти разрешения необходимы для правильной работы приложения. `offline_access` обеспечивает приложению доступ к маркерам обновления, что крайне важно для собственных приложений и веб-приложений. `user.read` предоставляет доступ к утверждению `sub`, что позволяет клиенту или приложению правильно идентифицировать пользователя на протяжении времени и получать доступ к элементарным сведениям о пользователе.  

![Пример скриншота, отобрадавшего согласие на работу учетной записи](./media/v2-permissions-and-consent/work_account_consent.png)

После того как пользователь утвердит разрешение, факт согласия будет записан, чтобы пользователю не пришлось повторно давать его при входе в учетную запись приложения в дальнейшем.

## <a name="requesting-consent-for-an-entire-tenant"></a>Запрос на получение согласия для клиента

Часто, когда организация приобретает лицензию или подписку на приложение, планируется установка приложения для использования всеми сотрудниками. В ходе этого процесса администратор может предоставить этому приложению разрешение действовать от имени любого пользователя. Если администратор предоставляет разрешения для всего клиента, то пользователи организации не увидят страницу согласия для приложения.

Чтобы запросить согласие на делегированные разрешения для всех пользователей в клиенте, приложение может использовать конечную точку предоставления согласия администратора.

Кроме того, конечная точка предоставления согласия администратора понадобится для запроса разрешений приложения.

## <a name="admin-restricted-permissions"></a>Разрешения, предназначенные только для администраторов

Некоторые высокопривилегированные разрешения в экосистеме Майкрософт могут быть помечены как *предназначенные только для администраторов*. Ниже приведены примеры подобных разрешений:

* чтение данных полных профилей пользователей с помощью `User.Read.All`;
* запись данных в каталог организации с помощью `Directory.ReadWrite.All`;
* чтение данных всех групп в каталоге организации с помощью `Groups.Read.All`.

Хотя пользователь, являющийся потребителем, и может предоставить приложению доступ к таким данным, корпоративным пользователям нельзя предоставлять доступ к таким же конфиденциальным данным компании. Если приложение запрашивает доступ к одному из этих разрешений у организационного пользователя, пользователь получает сообщение об ошибке, в которое говорится, что он не уполномочен давать согласие на разрешения приложения.

Если вашему приложению требуется доступ к областям только для администраторов организаций, следует запросить их непосредственно у администратора компании, а также с помощью конечной точки предоставления согласия администратора, как описано ниже.

Если приложение запрашивает высокопривилегированные делегированные разрешения и администратор предоставляет эти разрешения через конечную точку предоставления согласия администратора, согласие получат все пользователи в клиенте.

Если приложение запрашивает разрешения на приложение, а администратор предоставляет эти разрешения через конечную точку согласия администратора, этот грант не выполняется от имени какого-либо конкретного пользователя. а *напрямую* клиентскому приложению. Эти типы разрешений используются только службами daemon и другими неинтерактивными приложениями, которые работают в фоновом режиме.

## <a name="using-the-admin-consent-endpoint"></a>Использование конечной точки предоставления согласия администратора

> [!NOTE] 
> Пожалуйста, обратите внимание, что после предоставления согласия админа с помощью конечная точка согласия админа, вы закончили предоставление согласия админа, и пользователям не нужно выполнять какие-либо дополнительные действия. После предоставления согласия админ, пользователи могут получить токен доступа через типичный поток auth и в результате токен доступа будет иметь согласованные разрешения. 

Когда администратор компании, используя ваше приложение, переходит к конечной точке авторизации, платформа удостоверений Майкрософт определяет роль пользователя и предлагает ему предоставлять согласие на запрошенные вами разрешения от имени всего клиента. Если вы хотите, чтобы администратор предоставлял разрешения от имени всего клиента, можно использовать выделенную конечную точку предоставления согласия администратора. Использование этой конечной точки также необходимо для запроса разрешений на применение (которые не могут быть запрошены с помощью авторизации endpoint).

Если вы выполните описанные здесь действия, приложение получит возможность запрашивать разрешения для всех пользователей в клиенте, включая области только для администраторов. Эта операция является высокопривилегированной, поэтому ее следует выполнять, только если это необходимо для вашего сценария.

Пример кода, реализующий эти действия, см. в [примере областей только для администраторов](https://github.com/Azure-Samples/active-directory-dotnet-admin-restricted-scopes-v2).

### <a name="request-the-permissions-in-the-app-registration-portal"></a>Запрос разрешений на портале регистрации приложения

Приложения могут уметить, какие разрешения они требуют (как делегированные, так и приложения) на портале регистрации приложений.  Это позволяет использовать `/.default` область действия и опцию портала Azure "Грант-админ-согласие".  В целом, рекомендуется обеспечить, чтобы разрешения, статические для данного приложения, были супернабором разрешений, которые оно будет запрашивать динамически/постепенно.

> [!NOTE]
>Разрешения приложений могут быть запрошены [`/.default`](#the-default-scope) только с помощью - так что если ваше приложение нуждается в разрешении приложения, убедитесь, что они перечислены на портале регистрации приложения.

#### <a name="to-configure-the-list-of-statically-requested-permissions-for-an-application"></a>Настройка списка статично запрошенных разрешений для приложения

1. Перейдите к приложению на [портале Azure — опыт регистрации приложений](https://go.microsoft.com/fwlink/?linkid=2083908) или [создайте приложение,](quickstart-register-app.md) если вы еще этого не сделали.
2. Найдите раздел **Разрешения API,** а в разрешении API нажмите Добавить разрешение.
3. Выберите **Microsoft Graph** из списка доступных AIS, а затем добавьте разрешения, которые требуются приложению.
3. **Сохраните** регистрацию приложения.

### <a name="recommended-sign-the-user-into-your-app"></a>Рекомендуем: Подпишите пользователя в приложение

Как правило, при создании приложения, использующего конечную точку предоставления согласия администратора, для него нужно настроить страницу или представление, в котором администратор может утвердить разрешения приложения. Эта страница может быть частью потока регистрации приложения, параметров приложения или выделенного потока подключения. Во многих случаях разумно отображать это представление подключения в приложении только после того, как пользователь выполнил вход с помощью учебной или рабочей учетной записи Майкрософт.

При входе пользователя в приложение можно определить организацию, к которой принадлежит администратор, прежде чем запрашивать у него утверждение необходимых разрешений. Хотя это не обязательно, таким образом можно сделать пользовательский интерфейс более интуитивно понятным для сотрудников организации. Чтобы войти в систему пользователя, следуйте нашим [учебникам по протоколу платформы идентификации Майкрософт.](active-directory-v2-protocols.md)

### <a name="request-the-permissions-from-a-directory-admin"></a>Запрос разрешений у администратора каталога

Когда вы будете готовы запросить разрешения у админа организации, вы можете перенаправить пользователя на *конечную точку согласия*пользователя Майкрософт.

```
// Line breaks are for legibility only.
  GET https://login.microsoftonline.com/{tenant}/v2.0/adminconsent?
  client_id=6731de76-14a6-49ae-97bc-6eba6914391e
  &state=12345
  &redirect_uri=http://localhost/myapp/permissions
  &scope=
  https://graph.microsoft.com/calendars.read 
  https://graph.microsoft.com/mail.send
```


| Параметр        | Условие        | Описание                                                                                |
|:--------------|:--------------|:-----------------------------------------------------------------------------------------|
| `tenant` | Обязательно | Клиент каталога, из которого необходимо запросить разрешение. Может быть предоставлена в GUID или дружественном формате имени или в общих сведениях с организациями, как видно из примера. Не используйте 'общее', так как личные аккаунты не могут предоставить согласие на участие в этом деле, кроме как в контексте арендатора. Чтобы обеспечить наилучшую совместимость с личными учетными записями, которые управляют арендаторами, используйте идентификатор клиента, когда это возможно. |
| `client_id` | Обязательно | **Идентификатор приложения (клиента),** который имеется на [портале Azure - Регистрация приложений,](https://go.microsoft.com/fwlink/?linkid=2083908) назначенная вашему приложению. |
| `redirect_uri` | Обязательно |Универсальный код ресурса (URI) перенаправления, на который нужно направлять ответ для обработки в приложении. Он должен в точности соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных на портале регистрации приложений. |
| `state` | Рекомендуемая | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержания. Используйте параметр state для кодирования сведений о состоянии пользователя в приложении перед выполнением запроса на аутентификацию. Например, это могут быть сведения об открытой на тот момент странице или представлении. |
|`scope`        | Обязательно        | Определяет набор разрешений, запрашиваемых приложением. Это могут быть как [`/.default`](#the-default-scope)статические (с помощью), так и динамические области.  Это может включать в себя`openid` `profile`области `email`OIDC (, , ). Если вам нужны разрешения приложения, `/.default` необходимо использовать для запроса статической настроенной списка разрешений.  | 


На этом этапе Azure AD требует, чтобы администратор клиента вошел в систему, чтобы выполнить запрос. Администратору предлагается утвердить все запрашиваемые разрешения `scope` в параметре.  Если вы использовали статическое`/.default`значение () оно будет функционировать как конечная точка согласия admin admin и запрос согласия для всех областей, найденных в необходимых разрешениях для приложения.

#### <a name="successful-response"></a>Успешный ответ

Если администратор утверждает разрешения для приложения, то успешный ответ будет выглядеть следующим образом.

```
GET http://localhost/myapp/permissions?tenant=a8990e1f-ff32-408a-9f8e-78d3b9139b95&state=state=12345&admin_consent=True
```

| Параметр | Описание |
| --- | --- |
| `tenant` | Клиент каталога, предоставивший приложению запрошенные разрешения, в виде GUID. |
| `state` | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержания. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |
| `admin_consent` | Для этого параметра будет задано значение `True`. |

#### <a name="error-response"></a>Сообщение об ошибке

Если администратор не утверждает разрешения для приложения, то сообщение о неудачном выполнении будет выглядеть следующим образом.

```
GET http://localhost/myapp/permissions?error=permission_denied&error_description=The+admin+canceled+the+request
```

| Параметр | Описание |
| --- | --- |
| `error` | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки. |

После получения успешного ответа от конечной точки предоставления согласия администратора приложение получит запрошенные разрешения. Далее вы можете запросить маркер для ресурса, который вам нужен.

## <a name="using-permissions"></a>Использование разрешений

После того как пользователь предоставит разрешения для приложения, оно может получать маркеры доступа, представляющие разрешение приложения на определенный уровень доступа к ресурсу. Маркер доступа можно использовать только для отдельного ресурса, но в этом маркере закодированы все разрешения, предоставленные приложению для данного ресурса. Чтобы приобрести токен доступа, приложение может сделать запрос на конечную точку маркера платформы Майкрософт, как это:

```
POST common/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
    "grant_type": "authorization_code",
    "client_id": "6731de76-14a6-49ae-97bc-6eba6914391e",
    "scope": "https://outlook.office.com/mail.read https://outlook.office.com/mail.send",
    "code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
    "redirect_uri": "https://localhost/myapp",
    "client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

Полученный маркер доступа можно использовать в HTTP-запросах к ресурсу. Он достоверно указывает ресурсу, что у приложения имеется необходимое разрешение для выполнения определенной задачи. 

Для получения дополнительной информации о протоколе OAuth 2.0 и [Microsoft identity platform endpoint protocol reference](active-directory-v2-protocols.md)о том, как получить токены доступа, см.

## <a name="the-default-scope"></a>Область /.default

Эту `/.default` область можно использовать для переноса приложений из конечных точек v1.0 в конечную точку платформы Майкрософт. Это встроенная область для каждого приложения, которая ссылается на статический список разрешений, настроенных в регистрации приложения. Значение `scope` параметра `https://graph.microsoft.com/.default` обеспечивает те же функции, что и параметр`resource=https://graph.microsoft.com` конечных точек версии 1.0: запрашивается маркер с областями в Microsoft Graph, зарегистрированными для приложения на портале Azure.  Он построен с использованием `/.default` ресурса URI (например, `https://contosoApp.com`если ресурс URI есть, `https://contosoApp.com/.default`то запрашиваемый объем будет).  Смотрите [раздел о задних слэшах](#trailing-slash-and-default) для случаев, когда необходимо включить вторую слэш, чтобы правильно запросить маркер.

Область /.по умолчанию может быть использована в любом потоке OAuth 2.0, но необходима в [потоке On-Behalf-Of](v2-oauth2-on-behalf-of-flow.md) и [клиентских учетных данных,](v2-oauth2-client-creds-grant-flow.md)а также при использовании конечной точки согласия admin v2 для запроса разрешений на применение.  

> [!NOTE]
> Клиенты не могут`/.default`объединить статическое () и динамическое согласие в одном запросе. Поэтому `scope=https://graph.microsoft.com/.default+mail.read` приведет к ошибке из-за объединения типов области.

### <a name="default-and-consent"></a>Область /.default и согласие

Область `/.default` также активирует поведение конечной точки версии 1.0 для `prompt=consent`. Она запрашивает согласие для всех разрешений, зарегистрированных для приложения, вне зависимости от ресурса. Если она включена в `/.default` запрос, область возвращает маркер, содержащий области для запрашиваемого ресурса.

### <a name="default-when-the-user-has-already-given-consent"></a>Использование области /.default, когда пользователь уже предоставил согласие

Так как область `/.default` функционально идентична конечной точке версии 1.0 на основе `resource`, она также использует механизм согласия конечной точки версии 1.0. А именно, `/.default` активирует запрос на продолжение, только если пользователь не предоставил разрешение между клиентом и ресурсом. Если же согласие существует, будет возвращен маркер, содержащий все области, предоставленные пользователем для этого ресурса. Тем не менее, если разрешение не было предоставлено или был указан параметр `prompt=consent`, будет отображен запрос на продолжение для всех областей, зарегистрированных клиентским приложением.

#### <a name="example-1-the-user-or-tenant-admin-has-granted-permissions"></a>Пример 1: Пользователь или админ-арендатор выдал разрешения

В этом примере пользователь (или администратор-арендатор) предоставил клиенту `mail.read` `user.read`разрешения Microsoft Graph и: Если клиент запрашивает `scope=https://graph.microsoft.com/.default`, запрос на продолжение не отобразится независимо от содержимого зарегистрированных разрешений клиентских приложений для Microsoft Graph. Будет возвращен маркер с областями `mail.read` и `user.read`.

#### <a name="example-2-the-user-hasnt-granted-permissions-between-the-client-and-the-resource"></a>Пример 2: Пользователь не выдал разрешений между клиентом и ресурсом

В этом примере между клиентом и Microsoft Graph не существует согласия пользователя. Для клиента зарегистрированы разрешения `user.read` и `contacts.read`, а также область Azure Key Vault `https://vault.azure.net/user_impersonation`. Когда клиент запросит маркер для `scope=https://graph.microsoft.com/.default`, пользователь увидит экран предоставления согласия для областей `user.read`, `contacts.read` и области Key Vault `user_impersonation`. Возвращенный токен будет `user.read` иметь `contacts.read` только и области в нем и будет только быть пригодным для удовена против Microsoft Graph.

#### <a name="example-3-the-user-has-consented-and-the-client-requests-additional-scopes"></a>Пример 3: Пользователь дал согласие, и клиент запрашивает дополнительные области

В этом примере пользователь уже `mail.read` дал согласие на запрос клиента. Клиент зарегистрировал область `contacts.read` в своей регистрации. Когда клиент делает запрос на использование `scope=https://graph.microsoft.com/.default` токена и запрашивает согласие через, `prompt=consent`то пользователь увидит экран согласия для всех (и только) разрешений, зарегистрированных приложением. Разрешение `contacts.read` будет представлено на экране предоставления согласия, а разрешение `mail.read` — нет. Будет возвращен маркер для Microsoft Graph, содержащий `mail.read` и `contacts.read`.

### <a name="using-the-default-scope-with-the-client"></a>Использование области /.default с клиентом

Особым случаем области `/.default` является ситуация, когда клиент запрашивает собственную область `/.default`. Этот сценарий показан в следующем примере.

```
// Line breaks are for legibility only.

GET https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
response_type=token            //code or a hybrid flow is also possible here
&client_id=9ada6f8a-6d83-41bc-b169-a306c21527a5
&scope=9ada6f8a-6d83-41bc-b169-a306c21527a5/.default
&redirect_uri=https%3A%2F%2Flocalhost
&state=1234
```

В результате отображается экран предоставления согласия для всех зарегистрированных разрешений (если применимо в соответствии с приведенным выше описанием согласия и `/.default`), а затем возвращается маркер id_token, а не маркер доступа.  Такое поведение существует для некоторых устаревших клиентов, перемещающихся из ADAL в MSAL, и **не должно** использоваться новыми клиентами, ориентированными на конечную точку платформы Майкрософт.  

### <a name="trailing-slash-and-default"></a>Трейлинг слэш и /.по умолчанию

Некоторые ури ресурсов имеют задняя слэш (в`https://contoso.com/` отличие `https://contoso.com`от), который может вызвать проблемы с проверкой токенов.  Это может произойти в первую очередь при`https://management.azure.com/`запросе токена для управления ресурсами Azure (), который имеет отстающую слэш на их ресурсе URI и требует, чтобы он присутствовал при запросе токена.  Таким образом, при запросе `https://management.azure.com/` токена для `/.default`использования, вы должны запросить `https://management.azure.com//.default` - обратите внимание на двойную черту! 

В целом - если вы подтвердили, что токен выдается, и токен отклоняется API, который должен принять его, рассмотрите возможность добавления второй слэйс и попробуйте еще раз. Это происходит потому, что сервер входа излучает маркер с `scope` аудиторией, соответствующей URIs в параметре - с `/.default` удаленным из конца.  Если это устраняет задняя черта, сервер входа по-прежнему обрабатывает запрос и проверяет его на ресурсе URI, даже если они больше не совпадают - это нестандартно и не должно полагаться на ваше приложение.  

## <a name="troubleshooting-permissions-and-consent"></a>Устранение неполадок при использовании разрешений и механизма согласия

Если вы или пользователи приложения видите неожиданные ошибки в процессе согласия, просмотрите эту статью для устранения неполадок: [Неожиданная ошибка при выполнении согласия на приложение.](../manage-apps/application-sign-in-unexpected-user-consent-error.md)
