---
title: Поток кода авторизации для платформы Microsoft Identity и OAuth 2,0 | Службы
titleSuffix: Microsoft identity platform
description: Создавайте веб-приложения, используя реализацию платформы идентификации (Майкрософт) для протокола проверки подлинности OAuth 2,0.
services: active-directory
author: hpsin
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 05/06/2020
ms.author: hirsin
ms.reviewer: hirsin
ms.custom: aaddev, identityplatformtop40
ms.openlocfilehash: 29720b338326a29e65af1b6564cb0b59a976c62c
ms.sourcegitcommit: a6d477eb3cb9faebb15ed1bf7334ed0611c72053
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2020
ms.locfileid: "82926448"
---
# <a name="microsoft-identity-platform-and-oauth-20-authorization-code-flow"></a>Поток кода авторизации для платформы Microsoft Identity и OAuth 2,0

Код авторизации OAuth 2.0 может использоваться в приложениях, установленных на устройстве, для получения доступа к защищенным ресурсам, таким как веб-API. Используя реализацию OAuth 2,0 на платформе Microsoft Identity, вы можете добавить доступ для входа и API для мобильных и классических приложений. Для выполнения задач этого руководства не предусмотрено использование конкретного языка. Здесь объясняется, как отправлять и получать сообщения HTTP без применения [библиотек аутентификации Azure с открытым кодом](reference-v2-libraries.md).

В этой статье описывается, как программировать непосредственно по протоколу в приложении.  По возможности рекомендуется использовать поддерживаемые библиотеки проверки подлинности Майкрософт (MSAL) вместо [получения маркеров и вызова защищенных веб-API](authentication-flows-app-scenarios.md#scenarios-and-supported-authentication-flows).  Также ознакомьтесь с [примерами приложений, которые используют MSAL](sample-v2-code.md).

Описание потока кода авторизации OAuth 2.0 см. в [разделе 4.1 спецификации OAuth 2.0](https://tools.ietf.org/html/rfc6749). Он используется для проверки подлинности и авторизации в большинстве типов приложений, включая [веб-приложения](v2-app-types.md#web-apps) и [изначально установленные приложения](v2-app-types.md#mobile-and-native-apps). Этот поток OAuth позволяет приложениям безопасно получать access_tokens, которые можно использовать для доступа к ресурсам, защищенным конечной точкой платформы Microsoft Identity.

## <a name="protocol-diagram"></a>Схема протокола

На высоком уровне весь поток проверки подлинности OAuth2 для собственного или мобильного приложения выглядит немного следующим образом:

![Поток кода проверки подлинности OAuth](./media/v2-oauth2-auth-code-flow/convergence-scenarios-native.svg)

## <a name="request-an-authorization-code"></a>Запрос кода авторизации

Поток кода авторизации начинается с того, что клиент направляет пользователя к конечной точке `/authorize` . В этом запросе клиент запрашивает разрешения `openid`, `offline_access`и `https://graph.microsoft.com/mail.read ` у пользователя.  Некоторые разрешения ограничены администратором, например запись данных в каталог организации с помощью `Directory.ReadWrite.All`. Если приложение запрашивает доступ к одному из этих разрешений от пользователя организации, то пользователь получает сообщение об ошибке, сообщающее, что у него нет прав на согласие с разрешениями вашего приложения. Чтобы запросить доступ к областям, ограниченным администратором, необходимо запросить их непосредственно у администратора компании.  Дополнительные сведения см. в статье [разрешения, ограниченные администратором](v2-permissions-and-consent.md#admin-restricted-permissions).

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=openid%20offline_access%20https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
&state=12345
```

> [!TIP]
> Чтобы выполнить этот запрос, щелкните ссылку ниже! После входа браузер будет перенаправлен по адресу `https://localhost/myapp/`, при этом в адресной строке будет указано `code`.
> <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=code&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&response_mode=query&scope=openid%20offline_access%20https%3A%2F%2Fgraph.microsoft.com%2Fmail.read&state=12345" target="_blank">https://login.microsoftonline.com/common/oauth2/v2.0/authorize...</a>

| Параметр    | Обязательный или необязательный | Описание |
|--------------|-------------|--------------|
| `tenant`    | обязательно    | Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints).  |
| `client_id`   | обязательно    | **Идентификатор приложения (клиента)** , который [портал Azure — регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) , назначенный приложению.  |
| `response_type` | обязательно    | Должен содержать `code` для потока кода авторизации.       |
| `redirect_uri`  | обязательные | URI перенаправления для приложения, по которому оно может отправлять и получать ответы на запросы проверки подлинности. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. Для собственных и мобильных приложений следует использовать значение `https://login.microsoftonline.com/common/oauth2/nativeclient` по умолчанию.   |
| `scope`  | обязательно    | Разделенный пробелами список [областей](v2-permissions-and-consent.md) , на которые пользователь должен согласиться.  `/authorize` Для части запроса это может охватывать несколько ресурсов, позволяя приложению получить согласие на несколько веб-API, которые требуется вызвать. |
| `response_mode`   | рекомендуется | Определяет метод, который следует использовать для отправки созданного маркера запрашивающему приложению. Может принимать следующие значения:<br/><br/>- `query`<br/>- `fragment`<br/>- `form_post`<br/><br/>`query` предоставляет код в качестве параметра строки запроса в URI перенаправления. Если вы запрашиваете маркер идентификатора с помощью неявного потока, вы `query` не сможете использовать, как указано в [спецификации OpenID Connect](https://openid.net/specs/oauth-v2-multiple-response-types-1_0.html#Combinations). Если вы запрашиваете только код, можно использовать `query`, `fragment`или. `form_post` `form_post` выполняет запрос POST, который содержит код для URI перенаправления. Дополнительные сведения см. в статье о [протоколе OpenID Connect](https://docs.microsoft.com/azure/active-directory/develop/active-directory-protocols-openid-connect-code).  |
| `state`                 | рекомендуется | Значение, включаемое в запрос, которое также будет возвращено в ответе с маркером. Это может быть строка с любым содержимым на ваше усмотрение. Для предотвращения атак с подделкой [межсайтовых запросов](https://tools.ietf.org/html/rfc6749#section-10.12)обычно используется случайное уникальное значение. Это значение также используется для кодирования сведений о состоянии пользователя в приложении перед выполнением запроса проверки подлинности, например о просматриваемой странице или представлении. |
| `prompt`  | необязательные    | Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственные допустимые значения — `login`, `none` и `consent`.<br/><br/>При значении - `prompt=login` пользователю придется вводить учетные данные по запросу. Единый вход не сработает.<br/>- `prompt=none`обратное — это гарантирует, что пользователь не будет представлен ни в каких интерактивных запросах. Если запрос не может быть выполнен автоматически с помощью единого входа, конечная точка платформы Microsoft Identity возвратит `interaction_required` ошибку.<br/>Если установить значение - `prompt=consent`, то после входа пользователь увидит диалоговое окно согласия OAuth с запросом на предоставление разрешений приложению.<br/>- `prompt=select_account`приведет к прерыванию единого входа, предоставляющей возможности выбора учетной записи со списком всех учетных записей в сеансе или любой сохраненной учетной записи, или возможность использовать другую учетную запись полностью.<br/> |
| `login_hint`  | необязательные    | Может использоваться для предварительного заполнения полей имени пользователя или адреса электронной почты на отображаемой пользователю странице входа, если имя пользователя уже известно. Зачастую этот параметр используется в приложениях при повторной проверке подлинности. При этом имя пользователя извлекается во время предыдущего входа с помощью утверждения `preferred_username`.   |
| `domain_hint`  | необязательные    | Может использоваться значение `consumers` или `organizations`.<br/><br/>Если этот параметр включен, процесс обнаружения на основе электронной почты будет пропускаться на странице входа, что упрощает работу пользователя. Обычно этот параметр применяется в приложениях при повторной аутентификации. Для этого значение утверждения `tid` извлекается из предыдущего сеанса входа. Если значение утверждения `tid` — `9188040d-6c67-4c5b-b112-36a304b66dad`, следует использовать `domain_hint=consumers`. Или используйте `domain_hint=organizations`.  |
| `code_challenge_method` | необязательные    | Метод, используемый для кодирования `code_verifier` в параметре `code_challenge`. Может иметь одно из следующих значений:<br/><br/>- `plain` <br/>- `S256`<br/><br/>Если этот параметр не указан, для `code_challenge` принимается формат открытого текста, если задано значение `code_challenge`. Платформа Microsoft Identity поддерживает `plain` и, `S256`и. Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). |
| `code_challenge`  | необязательно | Используется для защиты предоставлений кода авторизации через PKCE (ключ подтверждения для обмена кодами) из нативного клиента. Является обязательным, если указан параметр `code_challenge_method`. Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). |

В этом сценарии пользователю будет предложено ввести учетные данные и выполнить проверку подлинности. Конечная точка платформы идентификации Майкрософт также обеспечит, чтобы пользователь предоставил разрешения, указанные в параметре `scope` запроса. Если пользователь не предоставил какие-либо из этих разрешений, конечная точка запросит их у пользователя. Подробные сведения о [разрешениях, согласии на предоставление и мультитенантных приложениях можно найти здесь](v2-permissions-and-consent.md).

После того как пользователь пройдет проверку подлинности и предоставит согласие, конечная точка платформы идентификации Майкрософт возвратит ответ на ваше `redirect_uri`приложение в указанном виде с помощью `response_mode` метода, указанного в параметре.

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```HTTP
GET https://login.microsoftonline.com/common/oauth2/nativeclient?
code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...
&state=12345
```

| Параметр | Описание:  |
|-----------|--------------|
| `code` | Запрашиваемый приложением код авторизации. Приложение может использовать этот код авторизации для запроса маркера доступа к целевому ресурсу. Authorization_codes имеет короткий срок действия, обычно около десяти минут. |
| `state` | Если в запрос включен этот параметр состояния, идентичное значение должно содержаться и в ответе на этот запрос. Приложение должно проверять идентичность значений состояния в запросе и ответе. |

#### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение обрабатывало их должным образом:

```HTTP
GET https://login.microsoftonline.com/common/oauth2/nativeclient?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание:  |
|----------|------------------|
| `error`  | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

#### <a name="error-codes-for-authorization-endpoint-errors"></a>Коды ошибок конечной точки авторизации

В таблице ниже описаны различные коды ошибок, которые могут возвращаться в параметре `error` ответа с ошибкой.

| Код ошибки  | Описание    | Действие клиента   |
|-------------|----------------|-----------------|
| `invalid_request` | Ошибка протокола, например отсутствует обязательный параметр. | Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая обычно определяется во время первоначального тестирования. |
| `unauthorized_client` | Клиентскому приложению не разрешено запрашивать код авторизации. | Эта ошибка обычно возникает, когда клиентское приложение не зарегистрировано в Azure AD или не Добавлено в клиент Azure AD пользователя. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| `access_denied`  | Владелец ресурса отказал в использовании  | Клиентское приложение может уведомить пользователя о том, что оно не может быть продолжено, пока пользователь не отправит. |
| `unsupported_response_type` | Сервер авторизации не поддерживает тип ответа в запросе. | Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая обычно определяется во время первоначального тестирования.  |
| `server_error`  | Сервер обнаружил непредвиденную ошибку.| Повторите запрос. Эти ошибки могут возникать в связи с временными условиями. Из клиентского приложения может поступить сообщение о том, что его ответ задерживается из-за временной ошибки. |
| `temporarily_unavailable`   | Сервер временно занят и не может обработать запрос. | Повторите запрос. Клиентское приложение может объяснить пользователю, что его ответ откладывается из-за временного состояния. |
| `invalid_resource`  | Целевой ресурс недопустим, так как он не существует, Azure AD не может найти его или неправильно настроен. | Это означает, что ресурс не существует или не настроен в клиенте. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| `login_required` | Слишком много пользователей или пользователи не найдены | Клиент запросил автоматическую аутентификацию (`prompt=none`), но одного пользователя не удалось найти. Это может означать, что в сеансе активно несколько пользователей или пользователи отсутствуют. При этом учитывается выбранный клиент (например, если имеются две учетные записи Azure AD, а одна учетная запись Майкрософт и `consumers` выбрана, автоматическая проверка подлинности будет работать). |
| `interaction_required` | Для запроса требуется взаимодействие с пользователем. | Требуется дополнительный шаг аутентификации или предоставление согласия. Повторите запрос без `prompt=none`. |

## <a name="request-an-access-token"></a>Запрос маркера доступа

После получения кода авторизации и разрешения от пользователя вы можете применить `code` для получения `access_token` к требуемому ресурсу. Для этого отправьте запрос `POST` к конечной точке `/token`:

```HTTP
// Line breaks for legibility only

POST /{tenant}/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
&code=OAAABAAAAiL9Kn2Z27UubvWFPbm0gLWQJVzCTE9UkP3pSx1aXxUjq3n8b2JRLk4OxVXr...
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&grant_type=authorization_code
&client_secret=JqQX2PNo9bpM0uEihUPzyrh    // NOTE: Only required for web apps. This secret needs to be URL-Encoded.
```

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman. (Не забудьте заменить `code`) [Попробуйте выполнить этот запрос в Post ![](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

| Параметр  | Обязательный или необязательный | Описание     |
|------------|-------------------|----------------|
| `tenant`   | обязательно   | Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints).  |
| `client_id` | обязательно  | Идентификатор приложения (клиента), которому в приложении назначена страница [портал Azure – регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) . |
| `grant_type` | обязательно   | Должен быть `authorization_code` для потока кода авторизации.   |
| `scope`      | обязательно   | Список областей с разделителями-пробелами. Области, запрашиваемые на этом участке, должны быть эквивалентны областям, запрашиваемым на первом участке, или являться их подмножеством. Все области должны быть из одного ресурса, а также с областями OIDC (`profile`, `openid`, `email`). Более подробное описание областей можно найти в разделе, посвященном [разрешениям, согласию на их предоставление и областям](v2-permissions-and-consent.md). |
| `code`          | обязательно  | Код авторизации, полученный на первом участке потока. |
| `redirect_uri`  | обязательно  | Значение redirect_uri, которое использовалось для получения кода authorization_code. |
| `client_secret` | Требуется для веб-приложений. | Секрет приложения, который вы создали на портале регистрации приложения. Не следует использовать секрет приложения в нативном приложении, так как на устройствах нет возможности надежно хранить client_secrets. Он требуется для веб-приложений и веб-API, которые могут безопасно хранить client_secret на стороне сервера.  Секрет клиента должен быть закодирован в формат URL-адреса перед отправкой. Дополнительные сведения см. в [спецификации универсального синтаксиса URI](https://tools.ietf.org/html/rfc3986#page-12). |
| `code_verifier` | необязательные  | Это тот же параметр code_verifier, который использовался для получения кода авторизации (authorization_code). Требуется, если в запросе на предоставление кода авторизации использовался ключ PKCE. Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). |

### <a name="successful-response"></a>Успешный ответ

Успешный ответ на запрос маркера будет выглядеть следующим образом:

```json
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "token_type": "Bearer",
    "expires_in": 3599,
    "scope": "https%3A%2F%2Fgraph.microsoft.com%2Fmail.read",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD...",
}
```

| Параметр     | Описание:   |
|---------------|------------------------------|
| `access_token`  | Запрошенный маркер доступа. Приложение может использовать этот маркер для аутентификации в защищенном ресурсе, таком как веб-API.  |
| `token_type`    | Обозначает значение типа маркера. Единственный тип, поддерживаемый Azure AD, — носитель |
| `expires_in`    | Срок действия маркера доступа (в секундах). |
| `scope`         | Области, для которых действует access_token. |
| `refresh_token` | Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров доступа после истечения срока действия текущего маркера доступа. Refresh_token имеет длительный срок действия и может использоваться для сохранения доступа к ресурсам в течение продолжительного периода времени. См. дополнительные сведения об [обновлении маркеров доступа](#refresh-the-access-token). <br> **Примечание.** Предоставляется, только если подан запрос на область `offline_access`. |
| `id_token`      | JSON Web Token (JWT). Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать и отображать значения, но оно не должно полагаться на них при авторизации или в целях безопасности. Дополнительные сведения о id_tokens см. в [`id_token reference`](id-tokens.md)разделе. <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |

### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках выглядят следующим образом:

```json
{
  "error": "invalid_scope",
  "error_description": "AADSTS70011: The provided value for the input parameter 'scope' is not valid. The scope https://foo.microsoft.com/mail.read is not valid.\r\nTrace ID: 255d1aef-8c98-452f-ac51-23d051240864\r\nCorrelation ID: fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7\r\nTimestamp: 2016-01-09 02:02:12Z",
  "error_codes": [
    70011
  ],
  "timestamp": "2016-01-09 02:02:12Z",
  "trace_id": "255d1aef-8c98-452f-ac51-23d051240864",
  "correlation_id": "fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7"
}
```

| Параметр         | Описание:    |
|-------------------|----------------|
| `error`       | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |
| `error_codes` | Список кодов ошибок, характерных для службы маркеров безопасности, которые могут помочь при диагностике.  |
| `timestamp`   | Время возникновения ошибки. |
| `trace_id`    | Уникальный идентификатор для запроса, который может помочь при диагностике. |
| `correlation_id` | Уникальный идентификатор для запроса, который может помочь при диагностике нескольких компонентов. |

### <a name="error-codes-for-token-endpoint-errors"></a>Коды ошибок конечных точек токенов

| Код ошибки         | Описание        | Действие клиента    |
|--------------------|--------------------|------------------|
| `invalid_request`  | Ошибка протокола, например отсутствует обязательный параметр. | Исправьте запрос и отправьте его повторно.   |
| `invalid_grant`    | Недопустимый или устаревший код авторизации или средство проверки PKCE. | Повторите запрос к конечной точке `/authorize` и убедитесь, что параметр code_verifier указан правильно.  |
| `unauthorized_client` | Прошедший проверку подлинности клиент не авторизован для использования этого типа предоставления авторизации. | Обычно это происходит, когда клиентское приложение не зарегистрировано в Azure AD или не добавляется в клиент Azure AD пользователя. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| `invalid_client` | Сбой проверки подлинности клиента.  | Учетные данные клиента недействительны. Чтобы устранить проблему, администратору приложения необходимо обновить учетные данные.   |
| `unsupported_grant_type` | Сервер авторизации не поддерживает тип предоставления авторизации. | Измените тип предоставления в запросе. Ошибка этого типа должна происходить только во время разработки, и ее должны обнаружить при первоначальном тестировании. |
| `invalid_resource` | Целевой ресурс недопустим, так как он не существует, Azure AD не может найти его или неправильно настроен. | Это означает, что ресурс, если он существует, не настроен в клиенте. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD.  |
| `interaction_required` | Для запроса требуется взаимодействие с пользователем. К примеру, требуется дополнительный шаг проверки подлинности. | Выполните запрос снова, используя тот же ресурс.  |
| `temporarily_unavailable` | Сервер временно занят и не может обработать запрос. | Повторите запрос. Клиентское приложение может объяснить пользователю, что его ответ откладывается из-за временного состояния. |

## <a name="use-the-access-token"></a>Использование маркера доступа

Теперь, когда вы успешно получили `access_token`, вы можете использовать маркер в запросах к веб-API, включив его в `Authorization` заголовок:

> [!TIP]
> Выполните этот запрос в Postman. (Сначала замените `Authorization` заголовок) [Попробуйте выполнить этот запрос в Post ![](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

```HTTP
GET /v1.0/me/messages
Host: https://graph.microsoft.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

## <a name="refresh-the-access-token"></a>Обновление маркера доступа

Access_token имеет короткий срок действия, и после истечения этого срока маркер нужно обновить, чтобы сохранить доступ к ресурсам. Для этого можно отправить еще один запрос `POST` на конечную точку `/token`, прибегнув к `refresh_token` вместо `code`.  Маркеры обновления действуют для всех разрешений, на которые ваш клиент уже получил согласия, например, маркер обновления выданный по запросу для `scope=mail.read` может использоваться для запроса нового маркера доступа для `scope=api://contoso.com/api/UseResource`.

Маркеры обновления не имеют определенного времени существования. Обычно этот период является относительно долгим. Но может случиться так, что у маркера обновления истекает срок действия, он отзывается или не имеет достаточных привилегий для требуемого действия. Приложение должно правильно рассчитывать и справляться с [ошибками, возвращаемыми конечной точкой выдачи маркера](#error-codes-for-token-endpoint-errors) .

Хотя маркеры обновления не отзываются при использовании для получения новых маркеров доступа, обычно предполагается, что старый маркер обновления после этого удаляется. В [спецификации OAuth 2,0](https://tools.ietf.org/html/rfc6749#section-6) говорится: "сервер авторизации может выдать новый маркер обновления. в этом случае клиент должен удалить старый маркер обновления и заменить его новым маркером обновления. Сервер авторизации МОЖЕТ отозвать старый маркер обновления после выдачи нового маркера обновления для клиента."

```HTTP
// Line breaks for legibility only

POST /{tenant}/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
&refresh_token=OAAABAAAAiL9Kn2Z27UubvWFPbm0gLWQJVzCTE9UkP3pSx1aXxUjq...
&grant_type=refresh_token
&client_secret=JqQX2PNo9bpM0uEihUPzyrh      // NOTE: Only required for web apps. This secret needs to be URL-Encoded
```

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman. (Не забудьте заменить `refresh_token`) [Попробуйте выполнить этот запрос в Post ![](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)
>

| Параметр     |                | Описание        |
|---------------|----------------|--------------------|
| `tenant`        | обязательно     | Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints).   |
| `client_id`     | обязательно    | **Идентификатор приложения (клиента)** , который [портал Azure — регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) , назначенный приложению. |
| `grant_type`    | обязательно    | Должен быть `refresh_token` для этого участка потока кода авторизации. |
| `scope`         | обязательно    | Список областей с разделителями-пробелами. Области, запрашиваемые на этом участке, должны быть эквивалентны областям, запрашиваемым на исходном участке запроса кода авторизации, или являться их подмножеством. Если области, указанные в этом запросе, охватывают несколько серверов ресурсов, конечная точка платформы Microsoft Identity возвратит маркер для ресурса, указанного в первой области. Более подробное описание областей можно найти в разделе, посвященном [разрешениям, согласию на их предоставление и областям](v2-permissions-and-consent.md). |
| `refresh_token` | обязательные    | Содержит маркер обновления, полученный во второй части потока. |
| `client_secret` | Требуется для веб-приложений. | Секрет приложения, который вы создали на портале регистрации приложения. Его не следует использовать в собственном приложении, так как client_secrets нельзя надежно хранить на устройствах. Он требуется для веб-приложений и веб-API, которые могут безопасно хранить client_secret на стороне сервера. Этот секрет должен быть закодирован в виде URL-адреса. Дополнительные сведения см. в [спецификации универсального синтаксиса URI](https://tools.ietf.org/html/rfc3986#page-12). |

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ на запрос маркера будет выглядеть следующим образом:

```json
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "token_type": "Bearer",
    "expires_in": 3599,
    "scope": "https%3A%2F%2Fgraph.microsoft.com%2Fmail.read",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD...",
}
```

| Параметр     | Описание         |
|---------------|-------------------------------------------------------------|
| `access_token`  | Запрошенный маркер доступа. Приложение может использовать этот маркер для аутентификации в защищенном ресурсе, таком как веб-API. |
| `token_type`    | Обозначает значение типа маркера. Единственный тип, поддерживаемый Azure AD, — носитель |
| `expires_in`    | Срок действия маркера доступа (в секундах).   |
| `scope`         | Области, для которых действует access_token.    |
| `refresh_token` | Новый токен обновления OAuth 2.0. Вам следует заменить старый токен обновления вновь полученным, чтобы обеспечить максимальный срок действия токенов обновления. <br> **Примечание.** Предоставляется, только если подан запрос на область `offline_access`.|
| `id_token`      | Неподписанный веб-маркер JSON (JWT). Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать и отображать значения, но оно не должно полагаться на них при авторизации или в целях безопасности. Дополнительные сведения о id_tokens см. в [`id_token reference`](id-tokens.md)разделе. <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |

#### <a name="error-response"></a>Сообщение об ошибке

```json
{
  "error": "invalid_scope",
  "error_description": "AADSTS70011: The provided value for the input parameter 'scope' is not valid. The scope https://foo.microsoft.com/mail.read is not valid.\r\nTrace ID: 255d1aef-8c98-452f-ac51-23d051240864\r\nCorrelation ID: fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7\r\nTimestamp: 2016-01-09 02:02:12Z",
  "error_codes": [
    70011
  ],
  "timestamp": "2016-01-09 02:02:12Z",
  "trace_id": "255d1aef-8c98-452f-ac51-23d051240864",
  "correlation_id": "fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7"
}
```

| Параметр         | Описание                                                                                        |
|-------------------|----------------------------------------------------------------------------------------------------|
| `error`           | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности.           |
| `error_codes` |Список кодов ошибок, характерных для службы маркеров безопасности, которые могут помочь при диагностике. |
| `timestamp` | Время возникновения ошибки. |
| `trace_id` | Уникальный идентификатор для запроса, который может помочь при диагностике. |
| `correlation_id` | Уникальный идентификатор для запроса, который может помочь при диагностике нескольких компонентов. |

Описание кодов ошибок и рекомендуемых действий в клиенте см. в разделе [Коды ошибок конечных точек токенов](#error-codes-for-token-endpoint-errors).
