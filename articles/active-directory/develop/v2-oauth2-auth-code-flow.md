---
title: Поток кода авторизации OAuth - идентификационная платформа Майкрософт Azure
description: Создавайте веб-приложения с помощью реализации платформы идентификации Microsoft протокола аутентификации OAuth 2.0.
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 01/31/2020
ms.author: hirsin
ms.reviewer: hirsin
ms.custom: aaddev, identityplatformtop40
ms.openlocfilehash: ac630c4901c126ed883adbdc7efb03f36372e6ff
ms.sourcegitcommit: 31ef5e4d21aa889756fa72b857ca173db727f2c3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81535882"
---
# <a name="microsoft-identity-platform-and-oauth-20-authorization-code-flow"></a>Платформа идентификации Майкрософт и поток кода авторизации OAuth 2.0

Код авторизации OAuth 2.0 может использоваться в приложениях, установленных на устройстве, для получения доступа к защищенным ресурсам, таким как веб-API. Используя реализацию платформы идентификации Microsoft OAuth 2.0, вы можете добавить вход и доступ к API к вашим мобильным и настольным приложениям. Для выполнения задач этого руководства не предусмотрено использование конкретного языка. Здесь объясняется, как отправлять и получать сообщения HTTP без применения [библиотек аутентификации Azure с открытым кодом](reference-v2-libraries.md).

В этой статье описывается, как запрограммировать непосредственно против протокола в приложении.  Когда это возможно, мы рекомендуем вам использовать поддерживаемые библиотеки подлинности Майкрософт (MSAL) вместо того, чтобы [приобретать токены и вызывать защищенные web-aIS.](authentication-flows-app-scenarios.md#scenarios-and-supported-authentication-flows)  Также взгляните на [образец приложений, которые используют MSAL](sample-v2-code.md).

> [!NOTE]
> Не все сценарии Active Directory Azure & функции поддерживаются конечными точками платформы идентификации Майкрософт. Чтобы определить, следует ли использовать конечную точку платформы идентификации Майкрософт, прочитайте об [ограничениях платформы идентификации Майкрософт.](active-directory-v2-limitations.md)

Описание потока кода авторизации OAuth 2.0 см. в [разделе 4.1 спецификации OAuth 2.0](https://tools.ietf.org/html/rfc6749). Он используется для выполнения аутентификации и авторизации в большинстве типов приложений, включая [веб-приложения](v2-app-types.md#web-apps) и [нативно установленные приложения.](v2-app-types.md#mobile-and-native-apps) Поток позволяет приложениям безопасно приобретать access_tokens, которые могут быть использованы для доступа к ресурсам, защищенным конечным пунктом платформы идентификации Майкрософт.

## <a name="protocol-diagram"></a>Схема протокола

В общих чертах весь поток проверки подлинности для собственных или мобильных приложений можно представить следующим образом:

![Поток кода проверки подлинности OAuth](./media/v2-oauth2-auth-code-flow/convergence-scenarios-native.svg)

## <a name="request-an-authorization-code"></a>Запрос кода авторизации

Поток кода авторизации начинается с того, что клиент направляет пользователя к конечной точке `/authorize` . В этом запросе клиент `openid` `offline_access`запрашивает `https://graph.microsoft.com/mail.read `, и разрешения от пользователя.  Некоторые разрешения ограничены амин-амин, например, запись данных в `Directory.ReadWrite.All`каталог организации с помощью. Если приложение запрашивает доступ к одному из этих разрешений у организационного пользователя, пользователь получает сообщение об ошибке, в которое говорится, что он не уполномочен давать согласие на разрешения приложения. Чтобы запросить доступ к ограниченным областям, ограниченным администратором, следует запросить их непосредственно у администратора компании.  Для получения дополнительной информации прочитайте разрешения с ограниченным доступом к [аминистам.](v2-permissions-and-consent.md#admin-restricted-permissions)

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=openid%20offline_access%20https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
&state=12345
```

> [!TIP]
> Чтобы выполнить этот запрос, щелкните ссылку ниже! После входа браузер будет перенаправлен по адресу `https://localhost/myapp/`, при этом в адресной строке будет указано `code`.
> <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=code&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&response_mode=query&scope=openid%20offline_access%20https%3A%2F%2Fgraph.microsoft.com%2Fmail.read&state=12345" target="_blank">https://login.microsoftonline.com/common/oauth2/v2.0/authorize...</a>

| Параметр    | Обязательный/необязательный | Описание |
|--------------|-------------|--------------|
| `tenant`    | обязательно    | Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints).  |
| `client_id`   | обязательно    | **Идентификатор приложения (клиента),** который имеется на [портале Azure - Регистрация приложений,](https://go.microsoft.com/fwlink/?linkid=2083908) назначенная вашему приложению.  |
| `response_type` | обязательно    | Должен содержать `code` для потока кода авторизации.       |
| `redirect_uri`  | обязательно | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. Для собственных и мобильных приложений следует использовать значение `https://login.microsoftonline.com/common/oauth2/nativeclient` по умолчанию.   |
| `scope`  | обязательно    | Разделенный пробелами список [областей](v2-permissions-and-consent.md) , для которого необходимо согласие пользователя.  Для `/authorize` этапа запроса это может охватывать несколько ресурсов, что позволяет приложению получить согласие на несколько Web-AI, которые вы хотите вызвать. |
| `response_mode`   | рекомендуется | Указывает метод, с помощью которого результирующий маркер будет отправлен приложению. Может применяться один из перечисленных ниже типов.<br/><br/>- `query`<br/>- `fragment`<br/>- `form_post`<br/><br/>`query` предоставляет код в качестве параметра строки запроса в URI перенаправления. Если вы запрашиваете токен ID с помощью неявного потока, вы не можете использовать, `query` как указано в [спецификации OpenID.](https://openid.net/specs/oauth-v2-multiple-response-types-1_0.html#Combinations) Если вы запрашиваете только код, `query`вы `fragment`можете `form_post`использовать, или . `form_post` выполняет запрос POST, который содержит код для URI перенаправления. Дополнительные сведения см. в статье о [протоколе OpenID Connect](https://docs.microsoft.com/azure/active-directory/develop/active-directory-protocols-openid-connect-code).  |
| `state`                 | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Случайно сгенерированное уникальное значение обычно используется для [предотвращения атак подделки запросов на кросс-сайт.](https://tools.ietf.org/html/rfc6749#section-10.12) Также в этом значении кодируются сведения о состоянии пользователя в приложении перед выполнением запроса на аутентификацию. Например, это могут быть сведения об открытой на тот момент странице или представлении. |
| `prompt`  | необязательный    | Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственные допустимые значения — `login`, `none` и `consent`.<br/><br/>При значении - `prompt=login` пользователю придется вводить учетные данные по запросу. Единый вход не сработает.<br/>- `prompt=none`наоборот - это будет гарантировать, что пользователь не представлен с какой-либо интерактивный запрос бы то ни было. Если запрос не может быть выполнен в режиме бесшумно с помощью `interaction_required` одного знака, конечная точка платформы Майкрософт вернет ошибку.<br/>Если установить значение - `prompt=consent`, то после входа пользователь увидит диалоговое окно согласия OAuth с запросом на предоставление разрешений приложению.<br/>- `prompt=select_account`прервет одиночный опыт выбора учетной записи, перечисляя все учетные записи в сеансе или любой запоминаемый счет или возможность выбора использовать другую учетную запись вообще.<br/> |
| `login_hint`  | необязательный    | Можно применять для предварительного заполнения поля имени пользователя или адреса электронной почты на странице входа пользователя (если имя пользователя известно заранее). Зачастую этот параметр используется в приложениях при повторной проверке подлинности. При этом имя пользователя извлекается во время предыдущего входа с помощью утверждения `preferred_username`.   |
| `domain_hint`  | необязательный    | Может использоваться значение `consumers` или `organizations`.<br/><br/>Если он будет включен, он пропустит процесс обнаружения на основе электронной почты, который пользователь проходит на странице вхождения, что приведет к немного более обтекаемой пользовательской работы. Обычно этот параметр применяется в приложениях при повторной аутентификации. Для этого значение утверждения `tid` извлекается из предыдущего сеанса входа. Если значение утверждения `tid` — `9188040d-6c67-4c5b-b112-36a304b66dad`, следует использовать `domain_hint=consumers`. Или используйте `domain_hint=organizations`.  |
| `code_challenge_method` | необязательный    | Метод, используемый для кодирования `code_verifier` в параметре `code_challenge`. Может использоваться одно из следующих значений:<br/><br/>- `plain` <br/>- `S256`<br/><br/>Если этот параметр не указан, для `code_challenge` принимается формат открытого текста, если задано значение `code_challenge`. Платформа идентификации `plain` Майкрософт поддерживает как, так и `S256`. Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). |
| `code_challenge`  | необязательный | Используется, чтобы защитить разрешения кода авторизации из собственного клиента при помощи ключа проверки для обмена кодом (PKCE). Является обязательным, если указан параметр `code_challenge_method`. Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). |

На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Конечная точка платформы идентификации Майкрософт также гарантирует, что пользователь `scope` дал согласие на разрешения, указанные в параметре запроса. Если пользователь не предоставил какие-либо из этих разрешений, конечная точка запросит их у пользователя. Подробные сведения о [разрешениях, согласии на предоставление и мультитенантных приложениях можно найти здесь](v2-permissions-and-consent.md).

Как только пользователь удостоверяет подлинность и предоставляет согласие, конечная точка платформы Майкрософт возвращает ответ вашему приложению в указанном, `redirect_uri`используя метод, указанный в параметре. `response_mode`

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```
GET https://login.microsoftonline.com/common/oauth2/nativeclient?
code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...
&state=12345
```

| Параметр | Описание  |
|-----------|--------------|
| `code` | Запрашиваемый приложением код авторизации. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Authorization_codes недолго, как правило, они истекают примерно через 10 минут. |
| `state` | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

#### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение обрабатывало их должным образом:

```
GET https://login.microsoftonline.com/common/oauth2/nativeclient?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание  |
|----------|------------------|
| `error`  | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

#### <a name="error-codes-for-authorization-endpoint-errors"></a>Коды ошибок конечной точки авторизации

В таблице ниже описаны различные коды ошибок, которые могут возвращаться в параметре `error` ответа с ошибкой.

| Код ошибки  | Описание    | Действие клиента   |
|-------------|----------------|-----------------|
| `invalid_request` | Ошибка протокола, например отсутствует обязательный параметр. | Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая обычно определяется во время первоначального тестирования. |
| `unauthorized_client` | Клиентское приложение не имеет права запрашивать код авторизации. | Эта ошибка обычно возникает, когда клиентское приложение не зарегистрировано в Azure AD или не добавлено в число пользователей Azure AD-арендатора. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| `access_denied`  | Владелец ресурса отказал в использовании  | Клиентское приложение может уведомить пользователя о том, что оно не может продолжить работу, если пользователь не согласится. |
| `unsupported_response_type` | Сервер авторизации не поддерживает тип ответа в запросе. | Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая обычно определяется во время первоначального тестирования.  |
| `server_error`  | Сервер обнаружил непредвиденную ошибку.| Повторите запрос. Эти ошибки могут возникать в связи с временными условиями. Из клиентского приложения может поступить сообщение о том, что его ответ задерживается из-за временной ошибки. |
| `temporarily_unavailable`   | Сервер временно занят и не может обработать запрос. | Повторите запрос. Клиентское приложение может объяснить пользователю, что его ответ задерживается из-за временного состояния. |
| `invalid_resource`  | Целевой ресурс недействителен, поскольку он не существует, Azure AD не может найти его, или он неправильно настроен. | Это означает, что ресурс не существует или не настроен в клиенте. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| `login_required` | Слишком много пользователей или пользователи не найдены | Клиент запросил автоматическую аутентификацию (`prompt=none`), но одного пользователя не удалось найти. Это может означать, что в сеансе активно несколько пользователей или пользователи отсутствуют. При этом учитывается выбранный арендатором (например, если есть две активные `consumers` учетные записи Azure AD и одна учетная запись Майкрософт, и выбрана, тихая аутентификация будет работать). |
| `interaction_required` | Для запроса требуется взаимодействие с пользователем. | Требуется дополнительный шаг аутентификации или предоставление согласия. Повторите запрос без `prompt=none`. |

## <a name="request-an-access-token"></a>Запрос маркера доступа

После получения кода авторизации и разрешения от пользователя вы можете применить `code` для получения `access_token` к требуемому ресурсу. Для этого отправьте запрос `POST` к конечной точке `/token`:

```
// Line breaks for legibility only

POST /{tenant}/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
&code=OAAABAAAAiL9Kn2Z27UubvWFPbm0gLWQJVzCTE9UkP3pSx1aXxUjq3n8b2JRLk4OxVXr...
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&grant_type=authorization_code
&client_secret=JqQX2PNo9bpM0uEihUPzyrh    // NOTE: Only required for web apps. This secret needs to be URL-Encoded.
```

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman. (Не забудьте заменить `code`) [Попробуйте запустить этот запрос в Postman ![](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

| Параметр  | Обязательный/необязательный | Описание     |
|------------|-------------------|----------------|
| `tenant`   | обязательно   | Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints).  |
| `client_id` | обязательно  | Идентификатор приложения (клиента), который является [порталом Azure - страницерегистрации приложений,](https://go.microsoft.com/fwlink/?linkid=2083908) назначенной вашему приложению. |
| `grant_type` | обязательно   | Должен быть `authorization_code` для потока кода авторизации.   |
| `scope`      | обязательно   | Список областей с разделителями-пробелами. Области, запрашиваемые на этом участке, должны быть эквивалентны областям, запрашиваемым на первом участке, или являться их подмножеством. Области должны быть из одного ресурса, наряду с`profile` `openid`области `email`OIDC (, , ). Более подробное описание областей можно найти в разделе, посвященном [разрешениям, согласию на их предоставление и областям](v2-permissions-and-consent.md). |
| `code`          | обязательно  | Код авторизации, полученный на первом участке потока. |
| `redirect_uri`  | обязательно  | Значение redirect_uri, которое использовалось для получения кода authorization_code. |
| `client_secret` | необходим для веб-приложений | Секрет приложения, созданный на портале регистрации для приложения. Секрет приложения не следует использовать в родном приложении, так как client_secrets не может надежно храниться на устройствах. Это необходимо для веб-приложений и веб-AI, которые имеют возможность хранить client_secret надежно на стороне сервера.  Секрет клиента должен быть преобразован в формат URL-адреса перед отправкой. Для получения дополнительной информации нажмите [здесь](https://tools.ietf.org/html/rfc3986#page-12). |
| `code_verifier` | необязательный  | Это тот же параметр code_verifier, который использовался для получения кода авторизации (authorization_code). Является обязательным, если в запросе на код авторизации использовался PKCE. Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). |

### <a name="successful-response"></a>Успешный ответ

Успешный ответ маркера выглядит следующим образом:

```json
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "token_type": "Bearer",
    "expires_in": 3599,
    "scope": "https%3A%2F%2Fgraph.microsoft.com%2Fmail.read",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD...",
}
```

| Параметр     | Описание   |
|---------------|------------------------------|
| `access_token`  | Запрашиваемый маркер доступа. Приложение может использовать этот маркер для аутентификации в защищенном ресурсе, таком как веб-API.  |
| `token_type`    | Указывает значение типа маркера. Единственный тип, поддерживаемый Azure AD, — носитель |
| `expires_in`    | Срок действия маркера доступа (в секундах). |
| `scope`         | Области, для которых действителен маркер доступа. |
| `refresh_token` | Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров доступа после истечения срока действия текущего маркера доступа. Токены обновления действуют в течение долгого времени. Их можно использовать для длительного сохранения доступа к ресурсам. См. дополнительные сведения об [обновлении маркеров доступа](#refresh-the-access-token). <br> **Примечание.** Предоставляется, только если подан запрос на область `offline_access`. |
| `id_token`      | A JSON Web Token (JWT). Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать и отображать значения, но оно не должно полагаться на них при авторизации или в целях безопасности. Для получения дополнительной информации [`id_token reference`](id-tokens.md)о id_tokens, см. <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |

### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках выглядят следующим образом:

```json
{
  "error": "invalid_scope",
  "error_description": "AADSTS70011: The provided value for the input parameter 'scope' is not valid. The scope https://foo.microsoft.com/mail.read is not valid.\r\nTrace ID: 255d1aef-8c98-452f-ac51-23d051240864\r\nCorrelation ID: fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7\r\nTimestamp: 2016-01-09 02:02:12Z",
  "error_codes": [
    70011
  ],
  "timestamp": "2016-01-09 02:02:12Z",
  "trace_id": "255d1aef-8c98-452f-ac51-23d051240864",
  "correlation_id": "fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7"
}
```

| Параметр         | Описание    |
|-------------------|----------------|
| `error`       | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |
| `error_codes` | Список кодов ошибок, характерных для службы маркеров безопасности, которые могут помочь при диагностике.  |
| `timestamp`   | Время возникновения ошибки. |
| `trace_id`    | Уникальный идентификатор для запроса, который может помочь при диагностике. |
| `correlation_id` | Уникальный идентификатор для запроса, который может помочь при диагностике нескольких компонентов. |

### <a name="error-codes-for-token-endpoint-errors"></a>Коды ошибок конечных точек токенов

| Код ошибки         | Описание        | Действие клиента    |
|--------------------|--------------------|------------------|
| `invalid_request`  | Ошибка протокола, например отсутствует обязательный параметр. | Исправьте запрос и отправьте его повторно.   |
| `invalid_grant`    | Недопустимый или устаревший код авторизации или средство проверки PKCE. | Повторите запрос к конечной точке `/authorize` и убедитесь, что параметр code_verifier указан правильно.  |
| `unauthorized_client` | Клиент, удостоверяющийподлинное подлинность, не имеет права использовать этот тип разрешения. | Обычно это происходит, когда клиентское приложение не зарегистрировано в Azure AD или не добавляется в число пользователей Azure AD-арендатора. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| `invalid_client` | Сбой проверки подлинности клиента.  | Учетные данные клиента недействительны. Чтобы устранить проблему, администратору приложения необходимо обновить учетные данные.   |
| `unsupported_grant_type` | Сервер авторизации не поддерживает тип предоставления авторизации. | Измените тип предоставления в запросе. Ошибка этого типа должна происходить только во время разработки, и ее должны обнаружить при первоначальном тестировании. |
| `invalid_resource` | Целевой ресурс недействителен, поскольку он не существует, Azure AD не может найти его, или он неправильно настроен. | Это означает, что ресурс, если он существует, не настроен в клиенте. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD.  |
| `interaction_required` | Для запроса требуется взаимодействие с пользователем. К примеру, требуется дополнительный шаг проверки подлинности. | Выполните запрос снова, используя тот же ресурс.  |
| `temporarily_unavailable` | Сервер временно занят и не может обработать запрос. | Повторите запрос. Клиентское приложение может объяснить пользователю, что его ответ задерживается из-за временного состояния. |

## <a name="use-the-access-token"></a>Использование маркера доступа

Теперь, когда вы `access_token`успешно приобрели, вы можете использовать маркер в запросах `Authorization` на веб-AIS, включив его в заголовок:

> [!TIP]
> Выполните этот запрос в Postman. (Сначала `Authorization` замените заголовок) [Попробуйте запустить этот запрос в Postman ![](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

```
GET /v1.0/me/messages
Host: https://graph.microsoft.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

## <a name="refresh-the-access-token"></a>Обновление маркера доступа

Срок действия маркеров доступа весьма ограничен, поэтому их нужно обновлять после его истечения, чтобы продолжить пользоваться запросами. Для этого можно отправить еще один запрос `POST` на конечную точку `/token`, прибегнув к `refresh_token` вместо `code`.  Маркеры обновления действуют для всех разрешений, на которые ваш клиент уже получил согласия, например, маркер обновления выданный по запросу для `scope=mail.read` может использоваться для запроса нового маркера доступа для `scope=api://contoso.com/api/UseResource`.

Для маркеров обновления не устанавливается определенное время существования. Обычно у маркеров обновления относительно продолжительное время существования. Но в некоторых случаях маркер обновления оказывается устаревшим или отозванным или не имеет достаточных привилегий для требуемого действия. Ваше приложение должно ожидать и правильно обрабатывать [ошибки, возвращаемые конечной точкой выдачи маркера](#error-codes-for-token-endpoint-errors).

Хотя токены обновления не отменяются при использовании для получения новых токенов доступа, ожидается, что старый маркер обновления отбросит. Спецификация [OAuth 2.0](https://tools.ietf.org/html/rfc6749#section-6) гласит: «Сервер авторизации МОЖЕТ выпустить новый маркер обновления, и в этом случае клиент должен отказаться от старого маркера обновления и заменить его новым маркером обновления. Сервер авторизации МОЖЕТ отозвать старый маркер обновления после выдачи клиенту нового токена обновления.

```
// Line breaks for legibility only

POST /{tenant}/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
&refresh_token=OAAABAAAAiL9Kn2Z27UubvWFPbm0gLWQJVzCTE9UkP3pSx1aXxUjq...
&grant_type=refresh_token
&client_secret=JqQX2PNo9bpM0uEihUPzyrh      // NOTE: Only required for web apps. This secret needs to be URL-Encoded
```

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman. (Не забудьте заменить `refresh_token`) [Попробуйте запустить этот запрос в Postman ![](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)
>

| Параметр     |                | Описание        |
|---------------|----------------|--------------------|
| `tenant`        | обязательно     | Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints).   |
| `client_id`     | обязательно    | **Идентификатор приложения (клиента),** который имеется на [портале Azure - Регистрация приложений,](https://go.microsoft.com/fwlink/?linkid=2083908) назначенная вашему приложению. |
| `grant_type`    | обязательно    | Должен быть `refresh_token` для этого участка потока кода авторизации. |
| `scope`         | обязательно    | Список областей с разделителями-пробелами. Области, запрашиваемые на этом участке, должны быть эквивалентны областям, запрашиваемым на исходном участке запроса кода авторизации, или являться их подмножеством. Если области, указанные в этом запросе, охватывают несколько серверов ресурсов, то конечная точка платформы идентификации Майкрософт возвращает токен для ресурса, указанного в первой области. Более подробное описание областей можно найти в разделе, посвященном [разрешениям, согласию на их предоставление и областям](v2-permissions-and-consent.md). |
| `refresh_token` | обязательно    | Токен обновления, полученный на втором участке потока. |
| `client_secret` | необходим для веб-приложений | Секрет приложения, созданный на портале регистрации для приложения. Он не должен использоваться в родном приложении, потому что client_secrets не может быть надежно сохранен на устройствах. Это необходимо для веб-приложений и веб-AI, которые имеют возможность хранить client_secret надежно на стороне сервера. Этот секрет должен быть ЗАкодирован URL-кодом, для получения дополнительной информации нажмите [здесь](https://tools.ietf.org/html/rfc3986#page-12). |

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ маркера выглядит следующим образом:

```json
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "token_type": "Bearer",
    "expires_in": 3599,
    "scope": "https%3A%2F%2Fgraph.microsoft.com%2Fmail.read",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD...",
}
```
| Параметр     | Описание         |
|---------------|-------------------------------------------------------------|
| `access_token`  | Запрашиваемый маркер доступа. Приложение может использовать этот маркер для аутентификации в защищенном ресурсе, таком как веб-API. |
| `token_type`    | Указывает значение типа маркера. Единственный тип, поддерживаемый Azure AD, — носитель |
| `expires_in`    | Срок действия маркера доступа (в секундах).   |
| `scope`         | Области, для которых действителен маркер доступа.    |
| `refresh_token` | Новый токен обновления OAuth 2.0. Вам следует заменить старый токен обновления вновь полученным, чтобы обеспечить максимальный срок действия токенов обновления. <br> **Примечание.** Предоставляется, только если подан запрос на область `offline_access`.|
| `id_token`      | Неподписанный веб-маркер JSON (JWT). Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать и отображать значения, но оно не должно полагаться на них при авторизации или в целях безопасности. Для получения дополнительной информации [`id_token reference`](id-tokens.md)о id_tokens, см. <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |

#### <a name="error-response"></a>Сообщение об ошибке

```json
{
  "error": "invalid_scope",
  "error_description": "AADSTS70011: The provided value for the input parameter 'scope' is not valid. The scope https://foo.microsoft.com/mail.read is not valid.\r\nTrace ID: 255d1aef-8c98-452f-ac51-23d051240864\r\nCorrelation ID: fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7\r\nTimestamp: 2016-01-09 02:02:12Z",
  "error_codes": [
    70011
  ],
  "timestamp": "2016-01-09 02:02:12Z",
  "trace_id": "255d1aef-8c98-452f-ac51-23d051240864",
  "correlation_id": "fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7"
}
```

| Параметр         | Описание                                                                                        |
|-------------------|----------------------------------------------------------------------------------------------------|
| `error`           | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности.           |
| `error_codes` |Список кодов ошибок, характерных для службы маркеров безопасности, которые могут помочь при диагностике. |
| `timestamp` | Время возникновения ошибки. |
| `trace_id` | Уникальный идентификатор для запроса, который может помочь при диагностике. |
| `correlation_id` | Уникальный идентификатор для запроса, который может помочь при диагностике нескольких компонентов. |

Описание кодов ошибок и рекомендуемых действий в клиенте см. в разделе [Коды ошибок конечных точек токенов](#error-codes-for-token-endpoint-errors).
