---
title: Узнайте, как предоставлять дополнительные утверждения для приложения Azure AD | Документация Майкрософт
description: Руководство по добавлению пользовательских или дополнительных утверждений в токены SAML 2.0 и JSON Web Token (JWT), выдаваемых службой Azure Active Directory.
documentationcenter: na
author: rwike77
services: active-directory
manager: CelesteDG
editor: ''
ms.service: active-directory
ms.subservice: develop
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 05/22/2019
ms.author: ryanwi
ms.reviewer: paulgarn, hirsin
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: 8c0e5035331cbe4f54926f0ae60ae0c5c31f6a9a
ms.sourcegitcommit: 778e7376853b69bbd5455ad260d2dc17109d05c1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/23/2019
ms.locfileid: "66119727"
---
# <a name="how-to-provide-optional-claims-to-your-azure-ad-app"></a>Практическое руководство: Предоставлять дополнительные утверждения для приложения Azure AD

Эта возможность используется разработчиками приложения, чтобы указать утверждения, которые нужно поместить в токены, отправляемые в приложение. Необязательные утверждения можно использовать, чтобы:

- выбрать дополнительные утверждения для включения в токены для приложения;
- изменить поведение определенных утверждений в токенах, возвращаемых Azure AD;
- добавлять пользовательские утверждения для приложения и обращаться к ним.

Список стандартных утверждений, см. в разделе [маркер доступа](access-tokens.md) и [id_token](id-tokens.md) утверждений документации. 

Необязательные утверждения поддерживаются в версии 1.0 и версии 2.0 маркеры формата, как так и маркеры SAML, они обеспечивают большую часть их значение при переходе от версии 1.0, версии 2.0. Одна из целей [конечной точки Azure AD версии 2.0](active-directory-appmodel-v2-overview.md) — уменьшение размеров токенов для обеспечения оптимальной производительности для клиентов. В результате нескольких утверждений, ранее включенных в маркеры доступа и идентификаторов, больше нет в токенах версии 2.0 и их нужно запрашивать специально для каждого приложения.

**Таблица 1. Применимость**

| Тип учетной записи | Токены версии 1.0 | Маркеров версии 2.0  |
|--------------|---------------|----------------|
| Личная учетная запись Майкрософт  | Н/Д  | Поддерживаются|
| Учетная запись Azure AD      | Поддерживаются | Поддерживаются |

## <a name="v10-and-v20-optional-claims-set"></a>Версия 1.0 и необязательные утверждения версии 2.0

Набор необязательных утверждений доступен по умолчанию для использования приложениями, перечисленными ниже. Чтобы добавить настраиваемые необязательные утверждения для приложения, ознакомьтесь с разделом [Расширения каталога](#configuring-directory-extension-optional-claims) ниже. При добавлении утверждений для **маркер доступа**, будут применены к запрошено токены доступа *для* приложение (веб-API), не *по* приложения. Это гарантирует, что независимо от того, получил ли клиент доступ к вашему API, в маркере доступа, используемом при аутентификации с помощью API, будут присутствовать правильные данные.

> [!NOTE]
> Большую часть этих утверждений можно включить в JWT для токенов версии 1.0 и 2.0, кроме токенов SAML, за исключением оговоренных в столбце типов токенов. Учетные записи потребителя поддерживают подмножество этих утверждений, помеченные в столбце «Тип пользователя».  Многие из перечисленных утверждений не применяются для пользователей-клиентов (они имеют нет клиента, поэтому `tenant_ctry` не имеет значения).  

**Таблица 2. Версии 1.0 и версии 2.0 необязательный набор утверждений**

| ИМЯ                       |  Описание   | Тип маркера | Тип пользователя | Примечания  |
|----------------------------|----------------|------------|-----------|--------|
| `auth_time`                | Время, когда пользователь последний раз проходил аутентификацию. Ознакомьтесь со спецификацией OpenID Connect.| JWT        |           |  |
| `tenant_region_scope`      | Регион клиента ресурса | JWT        |           | |
| `home_oid`                 | Для гостевых пользователей идентификатор объекта пользователя — это домашний клиент пользователя.| JWT        |           | |
| `sid`                      | Идентификатор сеанса, используемый для каждого сеанса пользователя на выход. | JWT        |  Личные и учетных записей Azure AD.   |         |
| `platf`                    | Платформа устройства    | JWT        |           | Только для управляемых устройств, которые могут проверить тип устройства.|
| `verified_primary_email`   | Источник: PrimaryAuthoritativeEmail пользователя      | JWT        |           |         |
| `verified_secondary_email` | Источник: SecondaryAuthoritativeEmail пользователя   | JWT        |           |        |
| `enfpolids`                | Идентификаторы применяемой политики. Список идентификаторов политик, оцененных для текущего пользователя. | JWT |  |  |
| `vnet`                     | Сведения об описателе виртуальной сети. | JWT        |           |      |
| `fwd`                      | IP-адрес.| JWT    |   | Добавляет исходный IPv4-адрес запрашивающего клиента (при использовании внутри виртуальной сети) |
| `ctry`                     | Страна пользователя | JWT |  | Azure AD возвращает необязательное утверждение `ctry`, если оно имеется, и значением утверждения является стандартный двухбуквенный код страны, например FR, JP, SZ и т. д. |
| `tenant_ctry`              | Страна ресурса клиента | JWT | | |
| `xms_pdl`          | Предпочтительное расположение данных   | JWT | | Для поддержки нескольких клиентов это трехбуквенный код, показывающий географический регион, в которой находится пользователь. Дополнительные сведения см. в разделе [документации по Azure AD Connect о предпочтительного расположения данных](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectsync-feature-preferreddatalocation).<br/>Например: `APC` для Азиатско-Тихоокеанского региона. |
| `xms_pl`                   | Предпочитаемый язык пользователя  | JWT ||Предпочитаемый язык пользователя, если задан. Источник: домашний клиент пользователя в сценариях гостевого доступа. Формат: ЯЯ-СС ("en-us"). |
| `xms_tpl`                  | Предпочитаемый язык клиента| JWT | | Предпочитаемый язык клиента ресурса, если задан. Формат: ЯЯ ("en"). |
| `ztdid`                    | Идентификатор развертывания без участия пользователя | JWT | | Идентификатор устройства, используемый для [Windows AutoPilot](https://docs.microsoft.com/windows/deployment/windows-autopilot/windows-10-autopilot) |
| `email`                    | Доступный адрес электронной почты для этого пользователя (если имеется).  | JWT, SAML | MSA, AAD | Это значение добавляется по умолчанию, если пользователь является гостем в клиенте.  Для управляемых пользователей (в клиенте) это значение должно запрашиваться посредством необязательного утверждения или, в версии 2.0, с использованием области OpenID.  Адреса электронной почты для управляемых пользователей должны быть заданы на [портале администрирования Office](https://portal.office.com/adminportal/home#/users).| 
| `groups`| Необязательно, форматирование для утверждения о группе |JWT, SAML| |Используется в сочетании с параметром GroupMembershipClaims в [манифест приложения](reference-app-manifest.md), которое должно быть равно также. Дополнительные сведения см. [группе утверждений](#Configuring-group-optional claims) ниже. Дополнительные сведения о утверждений о группах см. в разделе [настройка утверждений о группах](../hybrid/how-to-connect-fed-group-claims.md)
| `acct`             | Состояние учетной записи пользователя в клиенте. | JWT, SAML | | Если пользователь является членом клиента, это значение равно `0`. Если он является гостем, это значение равно `1`. |
| `upn`                      | Утверждение UserPrincipalName. | JWT, SAML  |           | Несмотря на то, что это утверждение автоматически включается, можно указать его в качестве необязательного утверждения для присоединения дополнительных свойств, чтобы изменить его поведение в варианте использования гостевым пользователем.  |

### <a name="v20-optional-claims"></a>Необязательные утверждения версии 2.0

Эти утверждения всегда включается в токенах Azure AD версии 1.0, но не включены в маркерах версии 2.0, если запрошено. Эти утверждения применяются только для JWT (токены Идентификации и маркеры доступа). 

**Таблица 3. Необязательные утверждения, предназначенные только для версии 2.0**

| Утверждение JWT     | ИМЯ                            | Описание                                | Примечания |
|---------------|---------------------------------|-------------|-------|
| `ipaddr`      | IP-адрес                      | IP-адрес, с которого клиент вошел в систему.   |       |
| `onprem_sid`  | Локальный идентификатор безопасности |                                             |       |
| `pwd_exp`     | Срок действия пароля        | Дата и время истечения срока действия пароля. |       |
| `pwd_url`     | Изменить URL-адрес пароля             | URL-адрес, перейдя по которому пользователь может изменить свой пароль.   |   |
| `in_corp`     | В корпоративной сети        | Посылает сигнал, если клиент входит в корпоративную сеть. Если их нет, утверждение не будет включено.   |  На основе параметров [надежных IP-адресов](../authentication/howto-mfa-mfasettings.md#trusted-ips) в MFA.    |
| `nickname`    | Псевдоним                        | Дополнительное имя для пользователя, отдельное от имени или фамилии. | 
| `family_name` | Фамилия                       | Предоставляет последний имя, Фамилия или фамилию пользователя, как определено в объекте пользователя. <br>"family_name":"Miller" | Поддерживается в MSA и AAD   |
| `given_name`  | Имя                      | Указывает на имя или «заданное» имя пользователя, которое было задано в объекте пользователя.<br>"given_name": "Frank"                   | Поддерживается в MSA и AAD  |
| `upn`         | Имя субъекта-пользователя | Идентификатор пользователя, который можно использовать с параметром username_hint.  Не является долговременным идентификатором для пользователя и не должен использоваться для ключевых данных. | См. в разделе [Дополнительные свойства необязательных утверждений](#additional-properties-of-optional-claims) указанном ниже для конфигурации утверждения. |

### <a name="additional-properties-of-optional-claims"></a>Дополнительные свойства необязательных утверждений

Некоторые необязательные утверждения можно настроить так, чтобы изменить способ возврата утверждения. Эти дополнительные свойства используются в основном для переноса локальных приложений с различными требованиями к данным (например, `include_externally_authenticated_upn_without_hash` помогает при работе с клиентами, которые не обрабатывают метки хэширования (`#`) в имени участника-пользователя).

**Таблица 4. Значения для настройки необязательных утверждений**

| Имя свойства  | Имя дополнительного свойства | Описание |
|----------------|--------------------------|-------------|
| `upn`          |                          | Может использоваться для ответов SAML и JWT и для токенов v1.0 и v2.0. |
|                | `include_externally_authenticated_upn`  | Включает гостевое имя участника-пользователя, сохраненное в клиенте ресурса. Например: `foo_hometenant.com#EXT#@resourcetenant.com`  |             
|                | `include_externally_authenticated_upn_without_hash` | Аналогично предыдущему примеру, за исключением того, что метки хэширования (`#`) будут заменены символами нижнего подчеркивания (`_`), например `foo_hometenant.com_EXT_@resourcetenant.com` |

#### <a name="additional-properties-example"></a>Пример дополнительных свойств:

```json
 "optionalClaims": 
   {
       "idToken": [ 
             { 
                "name": "upn", 
            "essential": false,
                "additionalProperties": [ "include_externally_authenticated_upn"]  
              }
        ]
}
```

Этот объект OptionalClaims вызывает маркер идентификатора, возвращаемый клиенту, для включения другого имени участника-пользователя с дополнительными сведениями о домашнем клиенте и клиенте ресурса. Он может изменить утверждение `upn` в маркере, только если пользователь является гостем в клиенте (который использует другой поставщик удостоверений для проверки подлинности). 

## <a name="configuring-optional-claims"></a>Настройка необязательных утверждений

С помощью изменения манифеста приложения можно настроить необязательные утверждения (см. пример ниже). Дополнительные сведения см. в разделе [основные сведения о статье манифеста приложения Azure AD](reference-app-manifest.md).

> [!IMPORTANT]
> Маркеры доступа являются **всегда** создан с помощью манифеста ресурса, а не на клиенте.  Таким образом, в запрос `...scope=https://graph.microsoft.com/user.read...` ресурс является графа.  Таким образом маркер доступа создается с помощью манифеста Graph, не манифест клиента.  Изменение манифеста приложения никогда не приведет к потере маркеры для графика, чтобы выглядеть по-другому.  Чтобы проверить, что ваш `accessToken` изменения вступают в силу, необходимо запросить маркер для приложения, не другого приложения.  

**Пример схемы:**

```json
"optionalClaims":  
   {
      "idToken": [
            {
                  "name": "auth_time", 
                  "essential": false
             }
      ],
      "accessToken": [
             {
                    "name": "ipaddr", 
                    "essential": false
              }
      ],
      "saml2Token": [
              {
                    "name": "upn", 
                    "essential": false
               },
               {
                    "name": "extension_ab603c56068041afb2f6832e2a17e237_skypeId",
                    "source": "user", 
                    "essential": false
               }
       ]
   }
```

### <a name="optionalclaims-type"></a>Тип OptionalClaims

Объявляет необязательные утверждения, запрошенные приложением. В приложении можно настроить необязательные утверждения, которые должны возвращаться в каждый из трех типов токенов (токен идентификации, маркер доступа, токен SAML 2), которые оно может получить из службы токенов безопасности. Приложение может настроить различные наборы необязательных утверждений, которые будут возвращаться в каждый тип токена. Свойство optionalClaims сущности приложения — это объект optionalClaims.

**Таблица 5. Свойства типа OptionalClaims**

| ИМЯ        | Тип                       | Описание                                           |
|-------------|----------------------------|-------------------------------------------------------|
| `idToken`     | Коллекция (OptionalClaim) | Необязательные утверждения, возвращаемые в токен идентификации JWT. |
| `accessToken` | Коллекция (OptionalClaim) | Необязательные утверждения, возвращаемые в маркер доступа JWT. |
| `saml2Token`  | Коллекция (OptionalClaim) | Необязательные утверждения, возвращаемые в токен SAML.   |

### <a name="optionalclaim-type"></a>Тип OptionalClaim

Содержит необязательное утверждение, связанное с приложением или субъект-службой. Свойства idToken, accessToken и saml2Token типа [OptionalClaims](https://msdn.microsoft.com/library/azure/ad/graph/api/entity-and-complex-type-reference#optionalclaims-type) являются коллекцией OptionalClaim.
С помощью поля AdditionalProperties можно изменить поведение OptionalClaim, если это поддерживается определенным утверждением.

**Таблица 6. Свойства типа OptionalClaims**

| ИМЯ                 | Тип                    | Описание                                                                                                                                                                                                                                                                                                   |
|----------------------|-------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `name`                 | Edm.String              | Имя необязательного утверждения.                                                                                                                                                                                                                                                                           |
| `source`               | Edm.String              | Источник утверждения (объект каталога). Существуют стандартные утверждения и определяемые пользователем утверждения из свойств расширения. Если исходное значение равно null, утверждение будет являться предопределенным необязательным утверждением. Если исходное значение — user, значение в имени свойства будет свойством расширения из объекта пользователя. |
| `essential`            | Edm.Boolean             | Если значение равно true, утверждение, указанное клиентом, необходимо для обеспечения плавной авторизации конкретной задачи, запрашиваемой пользователем. По умолчанию для этого параметра используется значение false.                                                                                                             |
| `additionalProperties` | Коллекция (Edm.String) | Дополнительные свойства утверждений. Если свойство существует в коллекции, оно изменяет поведение дополнительного утверждения, указанного в свойстве имени.                                                                                                                                               |
## <a name="configuring-directory-extension-optional-claims"></a>Настройка необязательных утверждений расширения каталога

Помимо набора стандартных необязательных утверждений можно также настроить маркеры для включения расширений схемы каталогов. Дополнительные сведения см. в разделе [расширения схемы каталогов](https://msdn.microsoft.com/Library/Azure/Ad/Graph/howto/azure-ad-graph-api-directory-schema-extensions). Эта возможность полезна при присоединении дополнительных сведений о пользователях, которые может использовать приложение, например, дополнительный идентификатор или важный параметр конфигурации, заданный пользователем. 

> [!Note]
> Расширения схемы каталога — это возможность, предназначенная только для AAD, поэтому если ваш манифест приложения запрашивает пользовательское расширение, а пользователь MSA регистрируется в вашем приложении, эти расширения не будут возвращены.

### <a name="directory-extension-formatting"></a>Расширение Directory форматирование

Для атрибутов расширения используйте полное имя расширения (в формате: `extension_<appid>_<attributename>`) в манифесте приложения. `<appid>` Должен соответствовать Идентификатору приложения, запрашивающего утверждение. 

В рамках JWT эти утверждения будут передаваться с помощью следующего формата имени: `extn.<attributename>`.

В рамках токенов SAML эти утверждения будут передаваться с помощью следующего формата URI: `http://schemas.microsoft.com/identity/claims/extn.<attributename>`

## <a name="configuring-group-optional-claims"></a>Настройки группы необязательных утверждений

   > [!NOTE]
   > Возможность создания группы имена пользователей и группы, синхронизированные из локальной является общедоступной предварительной версии

В этом разделе рассматриваются параметры конфигурации в разделе необязательные утверждения для изменения группы атрибутов, используемых в заявки о группе из objectID группы по умолчанию атрибуты, синхронизированные из локальной Windows Active Directory
> [!IMPORTANT]
> См. в разделе [настроить групповые заявки для приложений с Azure Active Directory](../hybrid/how-to-connect-fed-group-claims.md) Дополнительные сведения, включая важные предупреждения для общедоступной предварительной версии групповые заявки от локальных атрибутов.

1. На портале "->" Azure Active Directory "->" приложение регистрации -> выберите приложение манифест, "->"

2. Включить утверждения членства в группах, изменив groupMembershipClaim

   Допустимыми значениями являются:

   - «Все»
   - «SecurityGroup»
   - «DistributionList»
   - «DirectoryRole»

   Например:

   ```json
   "groupMembershipClaims": "SecurityGroup"
   ```

   По умолчанию группы идентификаторы objectid, будет использовано в группе значение утверждения.  Чтобы изменить значение утверждения для размещения в локальной среде атрибуты группы или изменить тип утверждения роли, используйте конфигурацию OptionalClaims следующим образом:

3. Задайте имя группы: Конфигурация необязательные утверждения.

   Если вы хотите группы в маркере, который должен содержать в локальном каталоге AD атрибутов группы в разделе необязательные утверждения указать, какой тип маркера необязательного утверждения, которые должны быть применены к, имя необязательно требование и другие свойства и требуемого.  Может быть перечислено несколько типов маркеров:

   - idToken для маркера OIDC Идентификации
   - accessToken маркера доступа OAuth или OIDC
   - Saml2Token для маркеров SAML.

   > [!NOTE]
   > Saml2Token типа относится к SAML1.1 и SAML 2.0 формат маркеров

   Для каждого соответствующего типа маркера измените утверждение групп для использования в разделе OptionalClaims в манифесте. OptionalClaims схема выглядит следующим образом:

   ```json
   {
   "name": "groups",
   "source": null,
   "essential": false,
   "additionalProperties": []
   }
   ```

   | Необязательные утверждения схемы | Value |
   |----------|-------------|
   | **Имя:** | Должен быть «группы» |
   | **Источник:** | Не используется. Не указан или указано значение null |
   | **важные:** | Не используется. Не указан или задано значение false |
   | **additionalProperties:** | Список дополнительных свойств.  Допустимые значения: «sam_account_name», «dns_domain_and_sam_account_name», «netbios_domain_and_sam_account_name», «emit_as_roles» |

   AdditionalProperties только один из «sam_account_name», «dns_domain_and_sam_account_name», «netbios_domain_and_sam_account_name» являются обязательными.  При наличии более одного используется первый, и любые другие игнорируются.

   Некоторые приложения требуют группы сведений о пользователе в утверждении роли.  Чтобы изменить тип утверждения, из группы заявляют, что утверждение роли, добавьте дополнительные свойства «emit_as_roles».  Значения группы, будет использовано в утверждении роли.

   > [!NOTE]
   > Если используется «emit_as_roles» любой роли приложения настроены, что пользователю назначена будет отображается в утверждении роли

**Примеры** Создайте группы, что имена групп в маркеры доступа OAuth в формате dnsDomainName\sAMAccountName

```json
"optionalClaims": {
    "accessToken": [{
        "name": "groups",
        "additionalProperties": ["dns_domain_and_sam_account_name"]
    }]
}
 ```

Для порождения имена групп должны быть возвращены в формате netbiosDomain\sAMAccountName как роли Утверждение SAML и маркеров Идентификации OIDC:

```json
"optionalClaims": {
    "saml2Token": [{
        "name": "groups",
        "additionalProperties": ["netbios_name_and_sam_account_name", "emit_as_roles"]
    }],

    "idToken": [{
        "name": "groups",
        "additionalProperties": ["netbios_name_and_sam_account_name", "emit_as_roles"]
    }]
 }

 ```

## <a name="optional-claims-example"></a>Пример необязательного утверждения

В этом разделе можно пошагово выполнить сценарий, чтобы узнать, как можно использовать возможность необязательных утверждений для приложения.
Есть несколько доступных вариантов обновления свойств в конфигурации удостоверения приложения, позволяющих включить и настроить необязательные утверждения:
-   Вы можете изменить манифест приложения. В приведенном ниже примере будет использовать этот метод для выполнения конфигурации. Ознакомьтесь со статьей [Манифест приложения Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/active-directory-application-manifest), чтобы получить общие сведения о манифесте.
-   Вы также можете написать приложение, в котором для обновления используется [API Graph](https://docs.microsoft.com/azure/active-directory/develop/active-directory-graph-api). [Справочник по сущностям и сложным типам](https://msdn.microsoft.com/library/azure/ad/graph/api/entity-and-complex-type-reference#optionalclaims-type) в справочнике по API Graph может помочь вам с конфигурацией необязательных утверждений.

**Пример.** В приведенном ниже примере манифест приложения изменяется, чтобы добавить утверждения в маркеры доступа, идентификации и SAML, предназначенные для приложения.

1. Войдите на [портале Azure](https://portal.azure.com).
1. Пройдя аутентификацию, выберите клиент Azure AD, щелкнув его в правом верхнем углу страницы.
1. Выберите в левой части **Регистрация приложений**.
1. Найдите в списке приложение, для которого нужно настроить необязательные утверждения, и щелкните его.
1. Щелкните **Манифест** на странице приложения, чтобы открыть встроенный редактор манифеста. 
1. Можно напрямую изменить манифест с помощью этого редактора. Манифест соответствует схеме для [сущности приложения](https://docs.microsoft.com/azure/active-directory/develop/reference-app-manifest) и автоматически форматирует манифест после сохранения. В свойство `OptionalClaims` будут добавлены новые элементы.

    ```json
      "optionalClaims": 
      {
            "idToken": [ 
                  { 
                        "name": "upn", 
                        "essential": false, 
                        "additionalProperties": [ "include_externally_authenticated_upn"]  
                  }
            ],
            "accessToken": [ 
                  {
                        "name": "auth_time", 
                        "essential": false
                  }
            ],
            "saml2Token": [ 
                  { 
                        "name": "extension_ab603c56068041afb2f6832e2a17e237_skypeId",
                        "source": "user", 
                        "essential": true
                  }
            ]
      }

    ```

    В этом случае различные необязательные утверждения будут добавлены к каждому типу токена, который может получить приложение. Теперь токены идентификации содержат имена участников-пользователей федеративных пользователей в полной форме (`<upn>_<homedomain>#EXT#@<resourcedomain>`). Маркеры доступа, запрашиваемые для этого приложения другими клиентами, будут включены в утверждение auth_time. Токен SAML будет содержать расширение схемы каталога skypeId (в этом примере идентификатор этого приложения — ab603c56068041afb2f6832e2a17e237). Токен SAML представит идентификатор Skype как `extension_skypeId`.

1. Завершив изменение манифеста, нажмите кнопку **Сохранить**, чтобы сохранить его.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о стандартных утверждениях, предоставляемых Azure AD, см. в следующих статьях.

- [Маркеры идентификации](id-tokens.md)
- [Маркеры доступа в Azure Active Directory](access-tokens.md)
