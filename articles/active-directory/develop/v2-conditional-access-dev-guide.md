---
title: Руководство для разработчиков для условного доступа к условному каталогу Azure
description: Руководство разработчика и сценарии для условного доступа Azure AD и платформы идентификации Майкрософт.
services: active-directory
keywords: ''
author: rwike77
manager: CelesteDG
ms.author: ryanwi
ms.reviewer: jmprieur, saeeda
ms.date: 03/16/2020
ms.service: active-directory
ms.subservice: develop
ms.custom: aaddev
ms.topic: conceptual
ms.workload: identity
ms.openlocfilehash: aae1b8aa27363e8f1d3c72d3934146c47b0cf2c9
ms.sourcegitcommit: 31ef5e4d21aa889756fa72b857ca173db727f2c3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81535899"
---
# <a name="developer-guidance-for-azure-active-directory-conditional-access"></a>Руководство для разработчиков для условного доступа к условному каталогу Azure

Функция «Условный доступ» в Active Directory Azure (Azure AD) предлагает один из нескольких способов защиты приложения и защиты службы. Условный доступ позволяет разработчикам и корпоративным клиентам защищать услуги множеством способов, включая:

* Многофакторная Идентификация
* разрешение доступа к определенным службам только устройствам, зарегистрированным в Intune;
* ограничение расположения пользователей и диапазонов IP-адресов.

Для получения дополнительной информации о полной возможности условного доступа [см.](../active-directory-conditional-access-azure-portal.md)

Для разработчиков, строящих приложения для Azure AD, эта статья показывает, как можно использовать условный доступ, а также о воздействии доступа к ресурсам, которые у вас нет контроля над этими политиками условного доступа. В статье также рассматриваются последствия условного доступа в потоке, веб-приложениях, доступе к Microsoft Graph и вызове AI.

Предполагается знание [однотенантных](quickstart-register-app.md) и [мультитенантных](howto-convert-app-to-be-multi-tenant.md) приложений, а также [распространенных шаблонов аутентификации](authentication-scenarios.md).

> [!NOTE]
> Для использования этой функции требуется лицензия Azure AD Premium P1. Чтобы найти подходящую лицензию, ознакомьтесь с разделом [Сравнение общедоступных функций выпусков Free, Basic и Premium](https://azure.microsoft.com/pricing/details/active-directory/).
> Клиенты с [лицензиями Microsoft 365 бизнес](/office365/servicedescriptions/microsoft-365-service-descriptions/microsoft-365-business-service-description) также имеют доступ к функциям условного доступа.

## <a name="how-does-conditional-access-impact-an-app"></a>Как Условный доступ влияет на приложение?

### <a name="app-types-impacted"></a>Затронутые типы приложений

В наиболее распространенных случаях условный доступ не изменяет поведение приложения и не требует каких-либо изменений от разработчика.Только в некоторых случаях, когда приложение косвенно или бесшумно запрашивает маркер для службы, приложение требует изменений кода для обработки "проблем" условиях доступа.Это может быть так же просто, как выполнение запроса на интерактивный вход.

В частности, следующие сценарии требуют, чтобы код обрабатывал "проблемы" условного доступа:

* приложения, выполняющие поток On-Behalf-Of;
* приложения, получающие доступ к нескольким службам или ресурсам;
* Одностраничные приложения с использованием MSAL.js
* веб-приложения, которые вызывают ресурс.

Политики условного доступа могут быть применены к приложению, но также могут быть применены к веб-API, к который к нему обращается приложение. Подробнее о том, как настроить политику условного доступа, можно найти в [веб-центре «Быстрый старт: требуйте МИД» для конкретных приложений с помощью условного доступа Azure Active Directory.](../conditional-access/app-based-mfa.md)

В зависимости от сценария корпоративный клиент может применять и удалять политики условного доступа в любое время. Чтобы ваше приложение продолжало функционировать при применении новой политики, необходимо реализовать обработку запросов. В следующих примерах показана обработка запроса.

### <a name="conditional-access-examples"></a>Примеры условного доступа

Некоторые сценарии требуют изменения кода для обработки условия доступа, в то время как другие работают как есть. Вот несколько сценариев с использованием условного доступа для многофакторной аутентификации, которая дает некоторое представление о разнице.

* Вы строите одноместное приложение iOS и применяете политику условного доступа. В приложении выполняется вход пользователя и оно не запрашивает доступ к API. При входе пользователя в систему политика автоматически вызывается и пользователю необходимо выполнить многофакторную проверку подлинности (MFA).
* Вы создаете собственное приложение, в котором используется служба среднего уровня для доступа к нисходящему API. Корпоративный клиент в организации, использующей это приложение, применяет политику к нисходящему API. Когда пользователь входит в систему, собственное приложение запрашивает доступ к среднему уровню и отправляет маркер. Средний уровень выполняет поток On-Behalf-Of для запроса доступа к нисходящему API. На этом этапе запрос утверждений передается на средний уровень. Средний уровень отправляет вызов обратно в родное приложение, которое должно соответствовать политике условного доступа.

#### <a name="microsoft-graph"></a>Microsoft Graph

Microsoft Graph имеет особые соображения при создании приложений в средах условного доступа. Как правило, механика условного доступа ведет себя одинаково, но политики, которые видят пользователи, будут основываться на базовых данных, которые ваше приложение запрашивает на графике.

В частности, все области Microsoft Graph представляют собой некоторый набор данных, который может индивидуально применять политики. Поскольку политикам условного доступа присваиваются определенные наборы данных, Azure AD будет применять политики условного доступа на основе данных, лежащих в основе графика, а не самого Графика.

Например, если приложение запрашивает следующие области Microsoft Graph,

```
scopes="Bookings.Read.All Mail.Read"
```

Приложение может ожидать, что их пользователи выполнят все политики, установленные на Bookings and Exchange. Некоторые области могут отображаться в нескольких наборах данных, если они предоставляют доступ.

### <a name="complying-with-a-conditional-access-policy"></a>Соблюдение политики условного доступа

Для нескольких различных топологий приложений при установлении сеанса оценивается политика условного доступа. Поскольку политика условного доступа работает на детализации приложений и служб, точка, в которой она вызывается, в значительной степени зависит от сценария, который вы пытаетесь выполнить.

Когда приложение пытается получить доступ к службе с политикой условного доступа, оно может столкнуться с проблемой условного доступа. Эта задача закодирована `claims` в параметре, который приходит в ответ езком Azure AD. Ниже приведен пример этого параметра запроса:

```
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

Разработчики могут воспользоваться этим запросом и добавить его в новый запрос к Azure AD. Передача этого состояния побуждает конечному пользователю выполнять любые действия, необходимые для соблюдения политики условного доступа. В следующих сценариях описываются особенности ошибок и представлены сведения о том, как извлечь параметр.

## <a name="scenarios"></a>Сценарии

### <a name="prerequisites"></a>Предварительные требования

Условный доступ Azure AD — это функция, включенная в [Azure AD Premium.](https://docs.microsoft.com/azure/active-directory/active-directory-whatis) Клиенты с [лицензиями Microsoft 365 бизнес](/office365/servicedescriptions/microsoft-365-service-descriptions/microsoft-365-business-service-description) также имеют доступ к функциям условного доступа.

### <a name="considerations-for-specific-scenarios"></a>Рекомендации для конкретных сценариев

Следующая информация применяется только в следующих сценариях условного доступа:

* приложения, выполняющие поток On-Behalf-Of;
* приложения, получающие доступ к нескольким службам или ресурсам;
* Одностраничные приложения с использованием MSAL.js

В следующих разделах рассматриваются более сложные сценарии. Основным принципом работы является оценка политики условного доступа во время запроса токена для службы, которая применяет политику условного доступа.

## <a name="scenario-app-performing-the-on-behalf-of-flow"></a>Сценарий: приложение, в котором выполняется поток On-Behalf-Of

В этом сценарии рассматривается вариант, при котором собственное приложение вызывает веб-службу или API. Эта служба, в свою очередь, выполняет поток On-Behalf-Of для вызова подчиненной службы. В нашем случае мы применили нашу политику условного доступа к службе ниже по течению (Web API 2) и используем нативное приложение, а не приложение сервера/деймона.

![Схема приложения, выполняющего поток On-Behalf-Of](./media/v2-conditional-access-dev-guide/app-performing-on-behalf-of-scenario.png)

В изначальном запросе маркера для веб-API 1 не отображается запрос на многофакторную проверку подлинности пользователя, так как веб-API 1 может не всегда получить доступ к подчиненному API. Когда веб-API 1 пытается запросить маркер от имени пользователя для веб-API 2, запрос завершается ошибкой, так как пользователь не выполнил вход и не прошел многофакторную проверку подлинности.

Azure AD возвращает ответ HTTP с некоторыми полезными данными:

> [!NOTE]
> В данном случае это многофакторное описание ошибки проверки подлинности, но существует широкий спектр возможных возможностей, `interaction_required` относящихся к условному доступу.

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API 2 App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

В веб-API 1 перехватывается ошибка `error=interaction_required` и отправляется запрос `claims` в классическое приложение. На этом этапе классическое приложение может сделать новый вызов `acquireToken()` и добавить запрос `claims` в качестве дополнительного параметра строки запроса. Новый запрос требует от пользователя выполнить многофакторную проверку подлинности, отправить новый маркер в веб-API 1 и завершить поток On-Behalf-Of.

Чтобы опробовать этот сценарий, см. [пример кода .NET](https://github.com/Azure-Samples/active-directory-dotnet-native-aspnetcore-v2/blob/master/Microsoft.Identity.Web/README.md#handle-conditional-access). Он демонстрирует передачу запроса утверждений из веб-API 1 в собственное приложение и создание запроса в клиентском приложении.

## <a name="scenario-app-accessing-multiple-services"></a>Сценарий: приложение, получающее доступ к нескольким службам

В этом сценарии мы просматриваем случай, когда веб-приложение получает доступ к двум службам, одна из которых имеет назначенную политику условного доступа. В зависимости от логики приложения ему может не потребоваться доступ к обеим веб-службам. В этом сценарии порядок запроса маркера играет важную роль при взаимодействии с пользователем.

Допустим, у нас есть веб-сервис A и B и веб-сервис B применяет сярпришет к политике условного доступа. В то время как первоначальный интерактивный запрос auth требует согласия для обеих услуг, политика условного доступа не требуется во всех случаях. Если приложение запрашивает маркер для веб-службы B, тогда вызывается политика и последующие запросы к веб-службе A также выполняются следующим образом.

![Схема приложения, получающего доступ к нескольким службам](./media/v2-conditional-access-dev-guide/app-accessing-multiple-services-scenario.png)

Кроме того, если приложение изначально запрашивает маркер для веб-службы А, конечный пользователь не ссылается на политику условного доступа. Это позволяет разработчику приложения контролировать взаимодействие с конечным пользователем и не принуждать к вызову политики условного доступа во всех случаях. Сложный случай, если приложение впоследствии запрашивает маркер для веб-сервиса B. На этом этапе конечный пользователь должен соблюдать политику условного доступа. Когда приложение пытается выполнить операцию `acquireToken`, может произойти следующая ошибка (как показано на схеме ниже):

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

![Приложение, получающее доступ к нескольким службам, запрашивающим новый маркер](./media/v2-conditional-access-dev-guide/app-accessing-multiple-services-new-token.png)

Если приложение использует библиотеку MSAL, отказ в приобретении токена всегда переудалируется в интерактивном режиме. Когда этот интерактивный запрос выполняется, конечный пользователь имеет возможность соответствовать условному доступу. Это верно, если запрос `AcquireTokenSilentAsync` `PromptBehavior.Never` не является или в этом ```AcquireToken``` случае приложение должно выполнить интерактивный запрос, чтобы дать конечному пользователю возможность соблюдать политику.

## <a name="scenario-single-page-app-spa-using-msaljs"></a>Сценарий: Одностраничное приложение (SPA) с использованием MSAL.js

В этом случае мы проходим через случай, когда у нас есть одностраничное приложение (SPA), используя MSAL.js для вызова защищенного веб-aPI условного доступа. Это простая архитектура, но имеет некоторые нюансы, которые необходимо учитывать при разработке вокруг условного доступа.

В MSAL.js есть несколько функций, которые `loginPopup()` `acquireTokenSilent(...)`получают `acquireTokenPopup(…)`токены: , , и `acquireTokenRedirect(…)`.

* `loginPopup()`получает токен ID через интерактивный запрос на вход, но не получает токенов доступа для любой службы (включая защищенный веб-aPI для условного доступа).
* `acquireTokenSilent(…)` может использоваться для автоматического получения маркера доступа. Это означает, что он никогда не будет отображаться на пользовательском интерфейсе.
* `acquireTokenPopup(…)` и `acquireTokenRedirect(…)` используются для автоматического запроса маркера для ресурса. Это означает, что они всегда отображаются на пользовательском интерфейсе входа.

Когда приложению нужен маркер доступа для вызова веб-API, оно пытается выставить `acquireTokenSilent(…)`. Если сеанс токенов истек или нам необходимо соблюдать политику условного доступа, то функция `acquireTokenPopup()` `acquireTokenRedirect()` *acquireToken* выходит из строя и приложение использует или .

![Одностраничное приложение с использованием диаграммы потока MSAL](./media/v2-conditional-access-dev-guide/spa-using-msal-scenario.png)

Давайте рассмотрим пример с нашим сценарием условного доступа. Пользователь только что зашел на веб-сайт и не имеет сеанса. Мы выполним вызов `loginPopup()` и получим идентификатор маркера без многофакторной проверки подлинности. Затем пользователь нажимает кнопку, которая требует от приложения запросить данные из веб-API. Приложение пытается сделать `acquireTokenSilent()` вызов, но не справляется, так как пользователь еще не выполнил многофакторную аутентификацию и должен соответствовать политике условного доступа.

Azure AD отправляет следующий ответ HTTP:

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
```

Приложению необходимо перехватить `error=interaction_required`. Приложение может использовать `acquireTokenPopup()` или `acquireTokenRedirect()` для того же ресурса. Пользователь вынужден пройти многофакторную проверку подлинности. После того как пользователь завершит многофакторную проверку подлинности, приложению выдается новый маркер доступа для запрашиваемого ресурса.

Чтобы проверить этот сценарий, см. [пример кода On-Behalf-Of JS SPA](https://github.com/Azure-Samples/active-directory-dotnet-native-aspnetcore-v2/blob/master/Microsoft.Identity.Web/README.md#handle-conditional-access). В этом примере кода используется политика условного доступа и веб-aPI, зарегистрированный ранее в JS SPA, чтобы продемонстрировать этот сценарий. Он показывает, как правильно справиться с проблемой претензий и получить токен доступа, который может быть использован для вашего веб-API. Кроме того ознакомьтесь с общим [примером кода Angular.js](https://github.com/Azure-Samples/active-directory-javascript-graphapi-v2) для получения руководства по Angular SPA.

## <a name="see-also"></a>См. также

* Дополнительные сведения о возможностях условного доступа см. в статье об [условном доступе в Azure Active Directory](/azure/active-directory/conditional-access/overview).
* Дополнительные примеры кода Azure AD можно узнать из [примеров.](sample-v2-code.md)
* Для получения дополнительной информации о MSAL SDK и доступ к справочной документации, см [Microsoft Authentication Библиотека обзор](msal-overview.md).
* Дополнительные сведения о сценариях с несколькими клиентами см. в статье [Как реализовать вход любого пользователя Azure Active Directory (AD) с помощью шаблона мультитенантного приложения](howto-convert-app-to-be-multi-tenant.md).
* Подробнее об [условном доступе и обеспечении доступа к приложениям IoT.](/azure/architecture/example-scenario/iot-aad/iot-aad)
