---
title: Протоколы согласия платформы идентификации Майкрософт
description: Описание авторизации в конечной точке платформы майкрософт, включая области, разрешения и согласие.
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 12/3/2019
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.openlocfilehash: 537d609c1281929203d1891f37614b7627e1683a
ms.sourcegitcommit: af1cbaaa4f0faa53f91fbde4d6009ffb7662f7eb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2020
ms.locfileid: "81868666"
---
# <a name="admin-consent-on-the-microsoft-identity-platform"></a>Согласие админа на платформе идентификации Майкрософт

Некоторые разрешения требуют согласия администратора, прежде чем они могут быть предоставлены в рамках арендатора.  Вы также можете использовать конечную точку согласия админа для предоставления разрешений всему арендатору.

## <a name="recommended-sign-the-user-into-your-app"></a>Рекомендуем: Подпишите пользователя в приложение

Как правило, при создании приложения, использующего конечную точку предоставления согласия администратора, для него нужно настроить страницу или представление, в котором администратор может утвердить разрешения приложения. Эта страница может быть частью потока регистрации приложения, параметров приложения или выделенного потока подключения. Во многих случаях разумно отображать это представление подключения в приложении только после того, как пользователь выполнил вход с помощью учебной или рабочей учетной записи Майкрософт.

При входе пользователя в приложение можно определить организацию, к которой принадлежит администратор, прежде чем запрашивать у него утверждение необходимых разрешений. Хотя это не обязательно, таким образом можно сделать пользовательский интерфейс более интуитивно понятным для сотрудников организации. Чтобы войти в систему пользователя, следуйте нашим [учебникам по протоколу платформы идентификации Майкрософт.](active-directory-v2-protocols.md)

## <a name="request-the-permissions-from-a-directory-admin"></a>Запрос разрешений у администратора каталога

Когда вы будете готовы запросить разрешения у админа организации, вы можете перенаправить пользователя на *конечную точку согласия*пользователя Майкрософт.

```HTTP
// Line breaks are for legibility only.
GET https://login.microsoftonline.com/{tenant}/v2.0/adminconsent?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&state=12345
&redirect_uri=http://localhost/myapp/permissions
&scope=
https://graph.microsoft.com/calendars.read
https://graph.microsoft.com/mail.send
```


| Параметр     | Условие     | Описание                                                                               |
|--------------:|--------------:|:-----------------------------------------------------------------------------------------:|
| `tenant` | Обязательно | Клиент каталога, из которого необходимо запросить разрешение. Может быть указан как GUID или в формате понятного имени, а также использоваться в универсальной ссылке с элементом `organizations`, как показано в примере. Не используйте 'общее', так как личные аккаунты не могут предоставить согласие на участие в этом деле, кроме как в контексте арендатора. Чтобы обеспечить наилучшую совместимость с личными учетными записями, которые управляют арендаторами, используйте идентификатор клиента, когда это возможно. |
| `client_id` | Обязательно | **Идентификатор приложения (клиента),** который имеется на [портале Azure - Регистрация приложений,](https://go.microsoft.com/fwlink/?linkid=2083908) назначенная вашему приложению. |
| `redirect_uri` | Обязательно |Универсальный код ресурса (URI) перенаправления, на который нужно направлять ответ для обработки в приложении. Он должен в точности соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных на портале регистрации приложений. |
| `state` | Рекомендуемая | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержания. Используйте параметр state для кодирования сведений о состоянии пользователя в приложении перед выполнением запроса на аутентификацию. Например, это могут быть сведения об открытой на тот момент странице или представлении. |
|`scope`        | Обязательно      | Определяет набор разрешений, запрашиваемых приложением. Это могут быть как статические (с использованием /.по умолчанию), либо динамические области.  Это может включать в себя`openid` `profile`области `email`OIDC (, , ). |


На этом этапе Azure AD требует, чтобы администратор клиента вошел в систему, чтобы выполнить запрос. Администратору предлагается утвердить все запрашиваемые разрешения `scope` в параметре.  Если вы использовали статическое`/.default`значение () оно будет функционировать как конечная точка согласия admin admin и запрос согласия для всех областей, найденных в необходимых разрешениях для приложения.

### <a name="successful-response"></a>Успешный ответ

Если администратор утверждает разрешения для приложения, то успешный ответ будет выглядеть следующим образом.

```
http://localhost/myapp/permissions?admin_consent=True&tenant=fa00d692-e9c7-4460-a743-29f2956fd429&state=12345&scope=https%3a%2f%2fgraph.microsoft.com%2fCalendars.Read+https%3a%2f%2fgraph.microsoft.com%2fMail.Send
```

| Параметр         | Описание                                                                                       |
|------------------:|:-------------------------------------------------------------------------------------------------:|
| `tenant`| Клиент каталога, предоставивший приложению запрошенные разрешения, в виде GUID.|
| `state`           | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержания. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении.|
| `scope`          | Набор разрешений, к которым был предоставлен доступ для приложения.|
| `admin_consent`   | Для этого параметра будет задано значение `True`.|

### <a name="error-response"></a>Сообщение об ошибке

`http://localhost/myapp/permissions?error=consent_required&error_description=AADSTS65004%3a+The+resource+owner+or+authorization+server+denied+the+request.%0d%0aTrace+ID%3a+d320620c-3d56-42bc-bc45-4cdd85c41f00%0d%0aCorrelation+ID%3a+8478d534-5b2c-4325-8c2c-51395c342c89%0d%0aTimestamp%3a+2019-09-24+18%3a34%3a26Z&admin_consent=True&tenant=fa15d692-e9c7-4460-a743-29f2956fd429&state=12345`

Добавление к параметрам, видимым в успешном ответе, параметры ошибки рассматриваются ниже.

| Параметр          | Описание                                                                                      |
|-------------------:|:-------------------------------------------------------------------------------------------------:|
| `error`            | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них.|
| `error_description`| Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки.|
| `tenant`| Клиент каталога, предоставивший приложению запрошенные разрешения, в виде GUID.|
| `state`           | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержания. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении.|
| `admin_consent`   | Будет установлено, чтобы `True` указать, что этот ответ произошел на потоке согласия админа.|

## <a name="next-steps"></a>Дальнейшие действия
- Дополнительные сведения см. в руководстве по [преобразованию приложения в мультитенантное](howto-convert-app-to-be-multi-tenant.md).
- Узнайте, как [поддерживается согласие на уровне протокола OAuth 2.0 во время потока предоставления кода авторизации.](v2-oauth2-auth-code-flow.md#request-an-authorization-code)
- Узнайте, [как мультитенантное приложение может использовать платформу согласия](active-directory-devhowto-multi-tenant-overview.md) для реализации согласия «пользователя» и «админ», поддерживая более продвинутые многоуровневые шаблоны приложений.
- Понимание [опыта согласия приложения Azure AD](application-consent-experience.md)
