---
title: Защита одностраничных приложений, с помощью неявного потока платформы удостоверений Microsoft | Azure
description: Создание веб-приложений с помощью реализации платформы удостоверений Microsoft неявный поток для одностраничных приложений.
services: active-directory
documentationcenter: ''
author: CelesteDG
manager: mtillman
editor: ''
ms.assetid: 3605931f-dc24-4910-bb50-5375defec6a8
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 04/12/2019
ms.author: celested
ms.reviewer: hirsin
ms.custom: aaddev
ms.collection: M365-identity-device-management
ms.openlocfilehash: d517828b30629cd9dfba5459b1d90913d8bc4f77
ms.sourcegitcommit: 61c8de2e95011c094af18fdf679d5efe5069197b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62112154"
---
# <a name="microsoft-identity-platform-and-implicit-grant-flow"></a>Платформе Microsoft identity и неявное предоставление потока

[!INCLUDE [active-directory-develop-applies-v2](../../../includes/active-directory-develop-applies-v2.md)]

С конечной точкой платформы удостоверений Microsoft пользователи могут входить в одностраничных приложениях благодаря как личных и рабочих или учебных учетных записей от корпорации Майкрософт. Во время проверки подлинности одностраничные и другие приложения JavaScript, которые запускаются в основном в браузере, сталкиваются с некоторыми проблемами.

* Характеристики безопасности этих приложений значительно отличаются от традиционных серверных веб-приложений.
* Многие серверы авторизации и поставщики удостоверений не поддерживают запросы CORS.
* Полностраничный браузер перенаправляет пользователя из приложения, взаимодействие с которым становится особенно агрессивным.

Для этих приложений (AngularJS, Ember.js, React.js и т. д.) платформой Microsoft identity поддерживает поток OAuth 2.0 Implicit Grant. Подробное описание неявного потока данных см. в [спецификации OAuth 2.0](https://tools.ietf.org/html/rfc6749#section-4.2). Его основное преимущество заключается том, что приложение могло получать маркеры из платформы удостоверений Microsoft без выполнения внутреннего сервера exchange учетных данных. Так, приложение может авторизовать пользователей, поддерживать сеансы и получать маркеры для других веб-API — и все это из клиентского кода JavaScript. Во время использования неявного потока данных необходимо обращать внимание на некоторые важные вопросы безопасности, касающиеся [клиента](https://tools.ietf.org/html/rfc6749#section-10.3) и [маскировки под другого пользователя](https://tools.ietf.org/html/rfc6749#section-10.3).

Если вы хотите использовать неявный поток и платформе Microsoft identity для добавления проверки подлинности в приложение JavaScript, мы рекомендуем использовать библиотеку JavaScript открытым исходным кодом, [msal.js](https://github.com/AzureAD/microsoft-authentication-library-for-js).

Но в одностраничном приложении можно обойтись без использования библиотеки. Отправлять сообщения протокола в таком случае нужно самостоятельно. Для этого выполните следующие шаги.

> [!NOTE]
> Не все сценарии Azure Active Directory (Azure AD) и возможности поддерживаются конечной точкой платформа удостоверений Майкрософт. Чтобы определить, если необходимо использовать конечную точку платформы Microsoft identity, ознакомьтесь [ограничения платформы удостоверений Microsoft](active-directory-v2-limitations.md).

## <a name="protocol-diagram"></a>Схема протокола

На следующей схеме показано, как выглядит весь неявный входной поток. В последующих разделах каждый шаг описывается более подробно.

![Дорожки OpenID Connect](./media/v2-oauth2-implicit-grant-flow/convergence-scenarios-implicit.svg)

## <a name="send-the-sign-in-request"></a>Отправка запроса на вход

Для первого входа пользователя в приложение, можно отправить [OpenID Connect](v2-protocols-oidc.md) запрос на проверку подлинности и получите `id_token` из конечной точки платформы Microsoft identity.

> [!IMPORTANT]
> Для успешного запроса идентификатора маркера, зарегистрированного приложения в [Azure портал регистрации приложений](https://go.microsoft.com/fwlink/?linkid=2083908) страница должна иметь неявный поток предоставления правильно, включается при выборе **маркеры доступа** и **Маркеры Идентификации** под **неявное предоставление** раздел. Если не включена, `unsupported_response` будет возвращена ошибка: **The provided value for the input parameter 'response_type' is not allowed for this client. Expected value is 'code'** (Указанное значение параметра response_type запрещено для данного клиента. Ожидаемое значение: code).

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&scope=openid
&response_mode=fragment
&state=12345
&nonce=678910
```

> [!TIP]
> Чтобы проверить вход с помощью неявного потока, щелкните <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=id_token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=openid&response_mode=fragment&state=12345&nonce=678910" target="_blank">https://login.microsoftonline.com/common/oauth2/v2.0/authorize...</a> После входа браузер будет перенаправлен по адресу `https://localhost/myapp/`, при этом в адресной строке будет `id_token`.
>

| Параметр |  | Описание |
| --- | --- | --- |
| `tenant` | Требуется |Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints). |
| `client_id` | Требуется | Идентификатор приложения (клиента), [Azure портал регистрации приложений](https://go.microsoft.com/fwlink/?linkid=2083908) страницы, назначенный вашему приложению. |
| `response_type` | Требуется |Должен включать `id_token` для входа в OpenID Connect. Этот параметр также может содержать значение `token` параметра response_type (тип ответа). Использование `token` здесь позволяет приложению получать токен доступа непосредственно от конечной точки авторизации, при этом отправлять новый запрос на вход в эту конечную точку не требуется. При использовании типа ответа `token` параметр `scope` должен содержать область, определяющую ресурсы, для которых необходимо выдавать токен. |
| `redirect_uri` | рекомендуется |URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| `scope` | Требуется |Список [областей](v2-permissions-and-consent.md) с разделителями-пробелами. При использовании протокола OpenID Connect он должен содержать область `openid`, что преобразуется в разрешение "Вход" в пользовательском интерфейсе предоставления согласия. Если требуется доступ к дополнительным данным пользователя, вы также можете указать области `email` или `profile`. Этот запрос может также включать другие области в зависимости от ресурсов, к которым требуется получить доступ. |
| `response_mode` | дополнительный |Указывает метод, с помощью которого результирующий маркер будет отправлен приложению. По умолчанию для маркера доступа используется метод query, но если запрос включает маркер id_token, значением по умолчанию является fragment. |
| `state` | рекомендуется |Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, для [предотвращения подделки межсайтовых запросов](https://tools.ietf.org/html/rfc6749#section-10.12)используется генерируемое случайным образом уникальное значение. Параметр "state" также используется для кодирования информации о состоянии пользователя в приложении перед созданием запроса на проверку подлинности, например информации об открытой на тот момент странице или представлении. |
| `nonce` | Требуется |Значение, включенное в запрос и созданное приложением, которое войдет в состав полученного токена "id_token" в качестве утверждения. Приложение может проверить это значение во избежание атак с использованием воспроизведения токена. Это значение обычно представляет собой случайную уникальную строку, которую можно использовать для определения источника запроса. Требуется только при запросе id_token. |
| `prompt` | дополнительный |Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственные допустимые значения — login, none, select_account и consent. При значении `prompt=login` пользователю придется вводить учетные данные по запросу. Единый вход не сработает. `prompt=none` является противоположным — оно гарантирует, что пользователю не предоставлены все запросы на экран ни при каких обстоятельствах. Если запрос не удастся завершить автоматически с помощью единого входа, конечная точка платформы удостоверений Microsoft вернет ошибку. `prompt=select_account` отправляет пользователя в средство выбора учетных записей, где будут отображаться все учетные записи, запомненные в сеансе. Если установить значение `prompt=consent`, то после входа пользователь увидит диалоговое окно согласия OAuth с запросом на предоставление разрешений приложению. |
| `login_hint`  |дополнительный |Можно применять для предварительного заполнения поля имени пользователя или электронного адреса на странице входа пользователя (если имя пользователя известно заранее). Зачастую этот параметр используется в приложениях при повторной проверке подлинности. При этом имя пользователя извлекается во время предыдущего входа с помощью утверждения `preferred_username`.|
| `domain_hint` | дополнительный |Может использоваться значение `consumers` или `organizations`. Если включен, пропускается процесс обнаружения на основе электронной почты который проходит пользователь на странице входа, что приводит к несколько упрощает взаимодействие с пользователем. Обычно этот параметр используется в приложениях при повторной проверке подлинности. Для этого значение утверждения `tid` извлекается из параметра id_token. Если значением утверждения `tid` является `9188040d-6c67-4c5b-b112-36a304b66dad` (клиента объекта-получателя учетной записи Майкрософт), то следует использовать `domain_hint=consumers`. В противном случае можно использовать `domain_hint=organizations` при повторной проверке подлинности. |

На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Конечная точка платформы удостоверений Microsoft гарантирует, что пользователь предоставил разрешения, указанные в `scope` параметр запроса. Если пользователь **не предоставил** какие-либо из этих разрешений, конечная точка запросит их у пользователя. Дополнительные сведения см. в статье [Разрешения и предоставление согласия в конечной точке Azure Active Directory версии 2.0](v2-permissions-and-consent.md).

После того как пользователь проходит проверку подлинности и дает свое согласие, конечной точкой платформа удостоверений Майкрософт вернет ответ в приложение на указанный `redirect_uri`, с помощью метода, указанного в `response_mode` параметра.

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием `response_mode=fragment` и `response_type=id_token+token` выглядит следующим образом (разрывы строк — для удобства чтения):

```
GET https://localhost/myapp/#
access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&token_type=Bearer
&expires_in=3599
&scope=https%3a%2f%2fgraph.microsoft.com%2fuser.read 
&id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&state=12345
```

| Параметр | Описание |
| --- | --- |
| `access_token` |Указывается, если параметр `response_type` содержит значение `token`. Это маркер доступа, запрошенный приложением. В данном случае для Microsoft Graph. Маркер доступа не должно быть декодирована или иным образом проверять, его следует рассматривать как непрозрачную строку. |
| `token_type` |Указывается, если параметр `response_type` содержит значение `token`. Всегда будет использоваться значение `Bearer`. |
| `expires_in`|Указывается, если параметр `response_type` содержит значение `token`. Указывает количество секунд, в течение которых маркер остается допустимым (для кэширования). |
| `scope` |Указывается, если параметр `response_type` содержит значение `token`. Указывает области, для которых будет допустимым access_token. Не может содержать все области, запрашиваемые, если они неприменимы для пользователя (в случае Azure AD области только для запрашиваемого при использовании личной учетной записи для входа). |
| `id_token` | Подписанный JSON Web Token (JWT). Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать значения и отображать их, но оно не следует полагаться на них авторизации или в целях безопасности. См. дополнительные сведения о маркерах id_token: [`id_token reference`](id-tokens.md). <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |
| `state` |Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

#### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение обрабатывало их должным образом:

```
GET https://localhost/myapp/#
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание |
| --- | --- |
| `error` |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` |Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

## <a name="validate-the-idtoken"></a>Проверка токена "id_token"

Просто получить маркер "id_token" недостаточно для проверки подлинности пользователя; также необходимо проверить подпись маркера и утверждения в маркере, в соответствии с требованиями вашего приложения. Конечная точка платформы Microsoft identity использует [маркеры JSON Web Token (JWT)](https://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) и шифрование с открытым ключом для подписи маркеров и убедитесь, что они допустимым.

Вы можете выбрать проверку `id_token` в клиентском коде, но обычно `id_token` отправляется на проверку внутреннему серверу. После проверки подписи маркера идентификации, то есть вам потребуется проверить несколько утверждений. См. [справочник по `id_token`](id-tokens.md) и дополнительные сведения о [проверке маркеров](id-tokens.md#validating-an-id_token) и [смене ключей подписывания](active-directory-signing-key-rollover.md). Советуем использовать библиотеку для синтаксического анализа и проверки токенов. Для большинства языков и платформ доступна по крайней мере одна такая библиотека.

Вам также может потребоваться проверить дополнительные утверждения в зависимости от сценария. Ниже приведены некоторые из стандартных проверок:

* Обеспечение регистрации пользователя или организации в приложении.
* Предоставление пользователю необходимого уровня авторизации и привилегий.
* Обеспечение определенного уровня проверки подлинности, например Многофакторной Идентификации.

После проверки маркера идентификации, можно начать сеанс с пользователем и использовать утверждения в id_token для получения сведений о пользователе в приложении. Эти сведения можно использовать для отображения, записей, персонализации и многое другое.

## <a name="get-access-tokens"></a>Получение маркеров доступа

Теперь, когда пользователь вошел в одностраничное приложение, можно получить маркеры доступа для вызова веб-API, защищенным платформы удостоверений Microsoft, таких как [Microsoft Graph](https://developer.microsoft.com/graph). Даже если вы уже получили токен с использованием параметра response_type со значением `token`, этот метод можно использовать для получения токенов к дополнительным ресурсам. При наличии этих токенов пользователям не нужно повторно выполнять вход.

В обычном потоке OpenID Connect и OAuth, это можно сделать, выполнив запрос к платформе Microsoft identity `/token` конечной точки. Тем не менее конечная точка платформы удостоверений Microsoft не поддерживает запросы CORS, поэтому невозможно вызовов AJAX, получать и обновлять маркеры. Вместо этого для получения новых маркеров для других веб-API можно использовать неявный поток данных в скрытом iframe. 

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fuser.read 
&response_mode=fragment
&state=12345&nonce=678910
&prompt=none
&domain_hint=organizations
&login_hint=myuser@mycompany.com
```

Дополнительные сведения о параметрах запроса в URL-адресе см. в разделе [Отправка запроса на вход](#send-the-sign-in-request).

> [!TIP]
> Попробуйте скопировать и вставить запрос, показанный ниже, на вкладку браузера. (Не забудьте заменить значения `login_hint` на правильное значение для вашего пользователя.)
>
>`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=token&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&scope=https%3A%2F%2Fgraph.microsoft.com%2user.read&response_mode=fragment&state=12345&nonce=678910&prompt=none&login_hint=your-username`
>

Благодаря параметру `prompt=none` этот запрос успешно выполнится или немедленно завершится с ошибкой, и вы вернетесь к своему приложению. Успешный ответ будет отправлен в ваше приложение на указанный `redirect_uri` с помощью метода, заданного в параметре `response_mode`.

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием метода `response_mode=fragment` выглядит следующим образом:

```
GET https://localhost/myapp/#
access_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
&state=12345
&token_type=Bearer
&expires_in=3599
&scope=https%3A%2F%2Fgraph.windows.net%2Fdirectory.read
```

| Параметр | Описание |
| --- | --- |
| `access_token` |Указывается, если параметр `response_type` содержит значение `token`. Это маркер доступа, запрошенный приложением. В данном случае для Microsoft Graph. Маркер доступа не должно быть декодирована или иным образом проверять, его следует рассматривать как непрозрачную строку. |
| `token_type` | Всегда будет использоваться значение `Bearer`. |
| `expires_in` | Указывает количество секунд, в течение которых маркер остается допустимым (для кэширования). |
| `scope` | Указывает области, для которых будет допустимым access_token. Не может содержать все области, запрашиваемые, если они неприменимы для пользователя (в случае Azure AD области только для запрашиваемого при использовании личной учетной записи для входа). |
| `id_token` | Подписанный JSON Web Token (JWT). Указывается, если параметр `response_type` содержит значение `id_token`. Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать значения и отображать их, но оно не следует полагаться на них авторизации или в целях безопасности. Дополнительные сведения о маркерах id_token см. в статье [`id_token`Маркеры идентификаторов](id-tokens.md). <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |
| `state` |Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверить, совпадают ли значения параметра "state" в запросе и ответе. |

#### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение правильно обрабатывало их. Если вы используете `prompt=none`, отобразится следующая ошибка.

```
GET https://localhost/myapp/#
error=user_authentication_required
&error_description=the+request+could+not+be+completed+silently
```

| Параметр | Описание |
| --- | --- |
| `error` |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` |Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

После появления этой ошибки в запросе iframe пользователю необходимо войти еще раз в интерактивном режиме для получения нового маркера. Этот случай можно обрабатывать любым способом, который лучше всего подходит для вашего приложения.

## <a name="validating-access-tokens"></a>Проверка маркеров доступа

При получении маркера доступа обязательно проверьте подпись маркера, а также указанные ниже утверждения. Вам также может потребоваться проверить дополнительные утверждения в зависимости от сценария.

* Утверждение **Audience**. Необходимо для подтверждения того, что маркер действительно должен был быть выдан вашему приложению.
* **издатель** утверждения, чтобы убедиться, что маркер был выдан в приложение конечная точка платформы удостоверений Microsoft
* Утверждения **Not Before** и **Expiration Time**. Необходимы для подтверждения того, что срок действия маркера не истек.

См. дополнительные сведения об утверждениях, присутствующих в [маркерах доступа](access-tokens.md).

## <a name="refreshing-tokens"></a>Обновление маркеров

Неявное предоставление не обеспечивает маркеры обновления. Срок действия маркеров `id_token` и `access_token` очень короткий, поэтому приложение должно быть готово периодически обновлять их. Чтобы обновить маркер любого типа, можно выполнять тот же скрытый запрос iframe приведенный выше, используя `prompt=none` параметр для управления поведением платформы идентификации. Чтобы получить новый `id_token`, обязательно используйте `response_type=id_token` и `scope=openid`, а также параметр `nonce`.

## <a name="send-a-sign-out-request"></a>Отправка запроса на выход

OpenID Connect `end_session_endpoint` позволяет приложению отправить запрос к конечной точке платформы удостоверений Microsoft для прекращения сеанса пользователя и очистки файлов cookie, установленных конечной точкой платформы Microsoft identity. Чтобы пользователь полностью вышел из веб-приложения, приложение должно завершить свой сеанс пользователя (обычно с помощью очистки кэша маркеров или файлов cookie), а затем перенаправить браузер на:

```
https://login.microsoftonline.com/{tenant}/oauth2/v2.0/logout?post_logout_redirect_uri=https://localhost/myapp/
```

| Параметр |  | Описание |
| --- | --- | --- |
| `tenant` |Требуется |Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints). |
| `post_logout_redirect_uri` | рекомендуется | URL-адрес, на который следует возвратить пользователя после выхода. Это значение должно соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных для приложения. Если не включен, пользователь будет отображаться универсальное сообщение конечной точкой платформы Microsoft identity. |

## <a name="next-steps"></a>Дальнейшие действия

* Перейдите на страницу [примеров MSAL JS](https://github.com/AzureAD/microsoft-authentication-library-for-js/wiki/Samples), чтобы приступить к созданию кода.
