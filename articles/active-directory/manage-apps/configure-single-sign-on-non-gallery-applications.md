---
title: Единый вход SAML — приложения не из коллекции — платформа удостоверений Майкрософт | Документация Майкрософт
description: Настройка единого входа (SSO) для приложений не из коллекции на платформе удостоверений Майкрософт (Azure AD)
services: active-directory
author: kenwith
manager: celestedg
ms.service: active-directory
ms.subservice: app-mgmt
ms.topic: how-to
ms.workload: identity
ms.date: 06/08/2020
ms.author: kenwith
ms.reviewer: arvinh,luleon
ms.collection: M365-identity-device-management
ms.openlocfilehash: 3cee2b9a0ea32a3b331849263c8a97f55930542d
ms.sourcegitcommit: 0100d26b1cac3e55016724c30d59408ee052a9ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/07/2020
ms.locfileid: "86024237"
---
# <a name="configure-saml-based-single-sign-on-to-non-gallery-applications"></a>Настройка единого входа на основе SAML для приложений не из коллекции

При [добавлении приложения из коллекции](add-gallery-app.md) или [веб-приложения не из коллекции](add-non-gallery-app.md) в корпоративные приложения Azure AD одним из доступных вариантов единого входа является [единый вход на основе SAML](what-is-single-sign-on.md#saml-sso). По возможности всегда выбирайте SAML для приложений, которые для проверки подлинности используют один из протоколов SAML. При использовании единого входа на основе SAML служба Azure AD выполняет аутентификацию в приложении, используя учетную запись Azure AD пользователя. Azure AD передает приложению данные для входа через протокол соединения. Вы можете сопоставлять пользователей с конкретными ролями приложений согласно правилам, определенным в утверждениях SAML. В этой статье описывается настройка единого входа на основе SAML для приложения не из коллекции. 

> [!NOTE]
> Добавляете приложение из коллекции? Пошаговые инструкции по установке см. в [списке руководств по приложениям SaaS](../saas-apps/tutorial-list.md).

Чтобы настроить единый вход SAML для приложения не из коллекции без написания кода, необходима подписка Azure AD Premium. Кроме того, приложение должно поддерживать SAML 2.0. Дополнительные сведения о версиях Azure AD см. в разделе [Цены на Azure AD](https://azure.microsoft.com/pricing/details/active-directory/).

## <a name="before-you-begin"></a>Перед началом

Если приложение еще не добавлено в клиент Azure AD, ознакомьтесь со статьей, посвященной [добавлению приложения не из коллекции](add-non-gallery-app.md).

## <a name="step-1-edit-the-basic-saml-configuration"></a>Шаг 1. Правка базовой конфигурации SAML

1. Войдите на [портал Azure](https://portal.azure.com) в качестве администратора облачных приложений или администратора приложения для клиента Azure AD.

2. Перейдите в **Azure Active Directory** > **Корпоративные приложения** и выберите приложение из списка. 
   
   - Чтобы выполнить поиск приложения, в меню **Тип приложения** выберите **Все приложения** и щелкните **Применить**. В поле поиска введите имя приложения, а затем выберите нужное приложение на панели результатов.

3. В разделе **Управление** щелкните **Единый вход**. 

   - Обратите внимание, что в некоторых случаях параметр **единого входа** отсутствует. Например, если приложение было зарегистрировано с помощью **Регистрация приложений** то функция единого входа будет настроена на использование OIDC OAuth по умолчанию. В этом случае параметр **единого входа** не отображается в области навигации в разделе **корпоративные приложения**. При использовании **Регистрация приложений** для добавления пользовательского приложения необходимо настроить параметры в файле манифеста. Дополнительные сведения о файле манифеста см. в разделе ( https://docs.microsoft.com/azure/active-directory/develop/reference-app-manifest) . Дополнительные сведения о стандартах единого входа см. в разделе ( https://docs.microsoft.com/azure/active-directory/develop/authentication-vs-authorization#authentication-and-authorization-using-microsoft-identity-platform) . В других сценариях, где в переходе будет отсутствовать **единый вход** , появится сообщение о том, что приложение размещено в другом клиенте или если у вашей учетной записи нет необходимых разрешений (глобальный администратор, администратор облачных приложений, администратор приложения или владелец субъекта-службы). Кроме того, разрешения могут вызвать сценарий, в котором можно открыть **единый вход** , но сохранить его не удастся. Дополнительные сведения об административных ролях Azure AD см. в разделе ( https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles) .

4. Выберите **SAML**. Откроется страница **Настройка единого входа с помощью SAML**.

   ![Шаг 1. Изменение базовой конфигурации SAML](media/configure-single-sign-on-non-gallery-applications/step-one-basic-saml-config.png)

5. Чтобы изменить основные параметры конфигурации SAML, выберите значок **Изменить** (карандаш) в правом верхнем углу раздела **Базовая конфигурация SAML**.

1. Введите следующие параметры. Их можно получить у поставщика приложения. Вы можете вручную ввести значения или отправить файл метаданных, чтобы извлечь значения полей.

    | Параметр "Базовая конфигурация SAML" | Инициированный поставщиком услуг | Инициированный поставщиком удостоверений | Описание |
    |:--|:--|:--|:--|
    | **Идентификатор (идентификатор сущности)** | Требуется для некоторых приложений | Требуется для некоторых приложений | Служит для уникальной идентификации приложения. Azure AD отправляет идентификатор в приложение в качестве параметра "Аудитория" токена SAML. Приложение должно проверить его. Это значение также отображается как идентификатор сущности во всех метаданных SAML, предоставленных приложением. Введите URL-адрес в следующем формате: https://<subdomain>. contoso.com *. Это значение можно найти в элементе **Издатель** в запросе **AuthnRequest** (запросе SAML), отправленном приложением.* |
    | **URL-адрес ответа** | Обязательное значение | Обязательное значение | Этот параметр указывает место, где приложение ожидает токен SAML. URL-адрес ответа также называется URL-адресом службы обработчика утверждений (ACS). Для указания нескольких URL-адресов ответа можно использовать дополнительные поля URL-адреса ответа. Например, для нескольких поддоменов могут потребоваться дополнительные URL-адреса ответа. Также в целях тестирования можно одновременно указать несколько URL-адресов ответа (локальный узел и общедоступные URL-адреса). |
    | **URL-адрес входа** | Обязательно | Не указывайте | Когда пользователь открывает этот URL-адрес, поставщик услуг выполняет перенаправление в Azure AD для аутентификации и входа пользователя в систему. Azure AD использует URL-адрес, чтобы запустить приложение из Office 365 или на панели доступа Azure AD. Если это поле пустое, Azure AD выполняет вход, инициированный поставщиком удостоверений, когда пользователь запускает приложение из Office 365, на панели доступа Azure AD или с помощью URL-адреса единого входа в Azure AD.|
    | **Состояние ретранслятора** | Необязательный | Необязательный | Указывает приложению, куда перенаправить пользователя после аутентификации. Обычно здесь указывается допустимый URL-адрес приложения. Но некоторые приложения используют это поле по-другому. Чтобы получить дополнительные сведения, обратитесь к поставщику приложения.
    | **URL-адрес выхода**. | Необязательно | Необязательно | Используется для отправки приложению ответов при завершении сеанса SAML.

Дополнительные сведения см. в разделе [Протокол единого входа SAML](../develop/single-sign-on-saml-protocol.md).

## <a name="step-2-configure-user-attributes-and-claims"></a>Шаг 2. Настройка атрибутов пользователя и утверждений 

Когда пользователь проходит проверку подлинности в приложении, Azure AD выдает приложению токен SAML. В нем собрана информация (утверждения), которая однозначно идентифицирует пользователя. По умолчанию в нем указаны имя для входа, адрес электронной почты, имя и фамилия пользователя. Может потребоваться настроить эти утверждения, например, если приложению требуются определенные значения утверждений или **Имя** в формате, отличном от имени пользователя. Требования к приложениям из коллекции описаны в [руководствах для конкретных приложений](../saas-apps/tutorial-list.md), либо можно обратиться к поставщику приложения. Ниже приведены общие действия по настройке атрибутов пользователей и утверждений.

1. В разделе **Атрибуты пользователя и утверждения** выберите значок **Изменить** (карандаш) в правом верхнем углу.

   ![Шаг 2. Настройка атрибутов пользователя и утверждений](media/configure-single-sign-on-non-gallery-applications/step-two-user-attributes-claims.png)

2. Проверьте **значение идентификатора имени**. Значение по умолчанию — *user.principalname*. Идентификатор пользователя является уникальным идентификатором для каждого пользователя в приложении. Например, если адрес электронной почты является и именем пользователя, и уникальным идентификатором, задайте значение *user.mail*.

3. Чтобы изменить **значение идентификатора имени**, щелкните значок **Изменить** (карандаш) рядом с полем **Значение идентификатора имени**. Если потребуется, внесите соответствующие изменения в формат идентификатора и источник. Дополнительные сведения см. в разделе [Изменение NameID](../develop/active-directory-saml-claims-customization.md#editing-nameid). Сохраните изменения, когда все будет готово. 
 
4. Чтобы настроить утверждения группы, выберите значок **Изменить** для поля **Groups returned in claim** (Группы, возвращенные в утверждении). Дополнительные сведения см. в статье о [настройке утверждений групп](../hybrid/how-to-connect-fed-group-claims.md).

5. Чтобы добавить утверждение, щелкните **Добавить новое утверждение** в верхней части страницы. Введите **Имя** и выберите соответствующий источник. Если вы выберете источник **Атрибут**, следует выбрать требуемый **Атрибут источника**. Если вы выберете источник **Перевод**, следует выбрать требуемые значения параметров **Преобразование** и **Параметр 1**. Дополнительные сведения см. в разделе [Добавление утверждений для конкретного приложения](../develop/active-directory-saml-claims-customization.md#adding-application-specific-claims). Сохраните изменения, когда все будет готово. 

6. Щелкните **Сохранить**. В таблице появится новое утверждение.

   > [!NOTE]
   > Дополнительные способы настройки токена SAML из Azure AD в приложение см. в следующих ресурсах.
   >- Сведения о создании пользовательских ролей с помощью портала Azure см. в статье о [настройке утверждений роли](../develop/active-directory-enterprise-app-role-management.md).
   >- Сведения о настройке утверждений с помощью PowerShell см. в статье о [настройке утверждений в PowerShell](../develop/active-directory-claims-mapping.md).
   >- Сведения об изменении манифеста приложения для настройки необязательных утверждений для вашего приложения см. в [этой статье](../develop/active-directory-optional-claims.md).
   >- Сведения о настройке политик времени жизни маркера для маркеров обновления, доступа, сеансов и идентификатора см. в статье [Configurable token lifetimes in Azure Active Directory (Preview)](../develop/active-directory-configurable-token-lifetimes.md) (Время существования маркеров с возможностью настройки в Azure Active Directory (предварительная версия)). Сведения об ограничении сеансов проверки подлинности с помощью условного доступа Azure AD см. в [этой статье](https://go.microsoft.com/fwlink/?linkid=2083106).

## <a name="step-3-manage-the-saml-signing-certificate"></a>Шаг 3. Управление сертификатом для подписи SAML

Azure AD использует сертификат для подписи токенов SAML, отправляемых в приложение. Этот сертификат понадобится вам, чтобы настроить доверие между Azure AD и приложением. Дополнительные сведения о формате сертификата см. в документации по SAML приложения. Дополнительные сведения см. в разделах [Управление сертификатами для федеративного единого входа](manage-certificates-for-federated-single-sign-on.md) и [Дополнительные параметры подписи сертификата в токене SAML](certificate-signing-options.md).

Из Azure AD можно скачать активный сертификат в формате Base64 или RAW непосредственно на главной странице **Настройка единого входа с помощью SAML**. Кроме того, активный сертификат можно получить, скачав XML-файл метаданных приложения или воспользовавшись URL-адресом метаданных федерации приложения. Чтобы просмотреть, создать или скачать сертификаты (активные или неактивные), выполните следующие действия.

1. Перейдите в раздел **Сертификат подписи SAML**. 

   ![Шаг 3. Управление сертификатом для подписи SAML](./media/configure-single-sign-on-non-gallery-applications/step-three-certificate.png)

2. Убедитесь, что у сертификата есть указанные ниже элементы.

   - *Нужный срок действия.* Вы можете настроить срок действия до трех лет в будущем.
   - *Состояние активности требуемого сертификата.* Если сертификат находится в **неактивном** состоянии, переведите его в **активное** состояние. Чтобы изменить состояние, щелкните правой кнопкой мыши строку нужного сертификата и выберите **Активировать сертификат**.
   - *Правильный параметр подписывания и алгоритм.*
   - *Правильные адреса электронной почты для отправки уведомлений.* Если приближается дата окончания срока действия активного сертификата, Azure AD отправляет соответствующее уведомление на электронный адрес, указанный в этом поле.

2. Чтобы скачать сертификат, выберите один из параметров в формате Base64, RAW или в формате XML-файла метаданных федерации. Azure AD также предоставляет **URL-адрес метаданных федерации приложений**, в котором можно получить доступ к метаданным, уникальным для приложения, в формате `https://login.microsoftonline.com/<Directory ID>/federationmetadata/2007-06/federationmetadata.xml?appid=<Application ID>`.

3. Чтобы создать, импортировать сертификат или управлять им, щелкните значок **Изменить** (карандаш) в правом верхнем углу раздела **Сертификат подписи SAML**.

   ![Сертификат подписи SAML](./media/configure-single-sign-on-non-gallery-applications/saml-signing-certificate.png)


   Выполните любое из следующих действий.

   - Чтобы создать сертификат, выберите **Новый сертификат**, **Дата окончания срока действия**, а затем нажмите кнопку **Сохранить**. Чтобы активировать сертификат, выберите контекстное меню ( **...** ) и пункт **Активировать сертификат**.
   - Чтобы отправить сертификат с закрытым ключом и учетными данными PFX, выберите **Импорт сертификата** и перейдите к сертификату. Введите **пароль PFX**, а затем щелкните **Добавить**.  
   - Чтобы настроить дополнительные параметры подписи сертификатов, используйте следующие параметры. Описание этих параметров см. в статье [Advanced certificate signing options in the SAML token for gallery apps in Azure Active Directory](certificate-signing-options.md) (Расширенные параметры подписи сертификата в маркере SAML для приложений коллекции в Azure Active Directory).
      - В раскрывающемся списке **Вариант подписывания** выберите **Ответ знака SAML**, **Утверждение знака SAML** или **Ответ знака SAML и утверждение**.
      - В раскрывающемся списке **Алгоритм подписывания** выберите **SHA-1** или **SHA-256**.
   - Чтобы уведомить дополнительных пользователей о том, что срок действия активного сертификата скоро истечет, введите адреса электронной почты в полях **Адреса электронной почты для уведомлений**.

4. Если вы внесли изменения, нажмите **Сохранить** в верхней части раздела **Сертификат подписи SAML**. 

## <a name="step-4-set-up-the-application-to-use-azure-ad"></a>Шаг 4. Настройка использования Azure AD в приложении

В разделе **Настройка \<applicationName> ** перечислены значения, которые необходимо настроить в приложении, поэтому он будет использовать Azure AD в качестве поставщика удостоверений SAML. Необходимые значения зависят от приложения. Дополнительные сведения см. в документации к SAML приложения. Чтобы найти документацию, перейдите к заголовку **Настройка \<application name> ** и выберите **Просмотреть**пошаговые инструкции. Документация отображается на странице **Настройка входа**. На этой странице вы заполните **URL-адрес входа**, **идентификатор Azure AD**и ** \<application name> ** значения **URL-адреса выхода** в заголовке Настройка.

1. Прокрутите вниз до раздела **Настройка \<applicationName>**. 
   
   ![Шаг 4. Настройка приложения](media/configure-single-sign-on-non-gallery-applications/step-four-app-config.png)

1. При необходимости скопируйте значение из каждой строки в этом разделе и следуйте инструкциям конкретного приложения по добавлению значения в приложение. Для приложений из коллекции можно просмотреть документацию, выбрав **Просмотреть пошаговые инструкции**. 
   - Значения **URL-адрес входа** и **URL-адрес выхода** указывают на одну конечную точку, то есть на конечную точку обработки запроса SAML для вашего экземпляра Azure AD. 
   - **Идентификатор Azure AD** — это значение **издателя** в токене SAML, выданном приложению.
2. Завершив перенос значений в нужные поля, щелкните **Сохранить**.

## <a name="step-5-validate-single-sign-on"></a>Шаг 5. Проверка единого входа

После настройки приложения на использование Azure AD в качестве поставщика удостоверений на основе SAML можно проверить параметры, чтобы узнать, работает ли единый вход для вашей учетной записи. 

2. Прокрутите страницу до раздела **Validate single sign-on with <applicationName>** (Проверка единого входа с помощью).

   ![Шаг 5. Проверка единого входа](media/configure-single-sign-on-non-gallery-applications/step-five-validate.png)

3. Выберите **Проверить**. Отобразятся параметры тестирования.

4. Выберите **Войдите от имени текущего пользователя**. 

Если вход выполнен успешно, можно приступить к назначению пользователей и групп для приложения SAML.
Если появится сообщение об ошибке, сделайте следующее:

1. Скопируйте и вставьте сведения об ошибке в поле **Как выглядит ошибка**.

    ![Получение рекомендаций по устранению](media/configure-single-sign-on-non-gallery-applications/error-guidance.png)

2. Щелкните **Получить рекомендации по устранению**. Отобразятся сведения о причине ошибки и рекомендации по ее устранению.  В этом примере пользователь не был назначен приложению.

3. Прочтите рекомендации по разрешению и устраните проблему, если возможно.

4. Выполните проверку еще раз, чтобы она завершилась успешно.

Дополнительные сведения см. в статье [Отладка единого входа на основе SAML в приложениях в Azure Active Directory](../azuread-dev/howto-v1-debug-saml-sso-issues.md).

## <a name="next-steps"></a>Дальнейшие действия

- [Assign users and groups to an application in Azure Active Directory](methods-for-assigning-users-and-groups.md) (Назначение пользователей и групп для приложения в Azure Active Directory)
- [Managing user account provisioning for enterprise apps in the Azure portal](../app-provisioning/configure-automatic-user-provisioning-portal.md) (Управление подготовкой учетных записей пользователей для корпоративных приложений на портале Azure)
