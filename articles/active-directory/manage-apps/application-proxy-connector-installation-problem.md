---
title: Проблема при установке соединителя агента прокси приложения | Документы Майкрософт
description: Устранение проблем при установке соединителя агента прокси приложения
services: active-directory
documentationcenter: ''
author: msmimart
manager: CelesteDG
ms.assetid: ''
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 05/21/2018
ms.author: mimart
ms.reviewer: japere
ms.collection: M365-identity-device-management
ms.openlocfilehash: 4d773e6302edf0b799e6dfccc702750a9cc74f60
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81406700"
---
# <a name="problem-installing-the-application-proxy-agent-connector"></a>Проблема при установке соединителя агента прокси приложения

Соединитель прокси приложения Microsoft AAD — это внутренний компонент домена, использующий исходящие соединения для установки подключения из конечной точки в облаке к внутреннему домену.

## <a name="general-problem-areas-with-connector-installation"></a>Общие проблемные области при установке соединителя

При сбое установки соединителя первопричина обычно относится к одной из следующих областей:

1.  **Подключение** — для успешной установки новому соединителю нужно зарегистрироваться и установить свойства доверия. Это осуществляется путем подключения к облачной службе прокси приложения AAD.

2.  **Установление отношений доверия** — новый соединитель создает самозаверяющий сертификат и регистрируется в облачной службе.

3.  **Проверка подлинности администратора** — для завершения установки соединителя пользователю нужно предоставить учетные данные администратора.

> [!NOTE]
> Системы установки connector можно найти в папке %TEMP% и могут помочь предоставить дополнительную информацию о том, что вызывает сбой установки.

## <a name="verify-connectivity-to-the-cloud-application-proxy-service-and-microsoft-login-page"></a>Проверка подключения к прокси-службе облачного приложения и странице входа Майкрософт

**Цель:** убедитесь, что компьютер соединителя может подключиться к конечной точке регистрации прокси приложения AAD, а также к странице входа Майкрософт.

1.  На сервере разъема запустите портовый тест с помощью [telnet](https://docs.microsoft.com/windows-server/administration/windows-commands/telnet) или другого инструмента тестирования порта, чтобы убедиться, что порты 443 и 80 открыты.

2.  Если какой-либо из этих портов не успешен, убедитесь, что брандмауэр или прокси бэкэнда имеет доступ к требуемым доменотам и портам, [подготовьте среду.](application-proxy-add-on-premises-application.md#prepare-your-on-premises-environment)

3.  Откройте браузер (отдельную вкладку), перейдите к веб-странице `https://login.microsoftonline.com` и убедитесь, что можете войти на эту страницу.

## <a name="verify-machine-and-backend-components-support-for-application-proxy-trust-certificate"></a>Поддержка компонентов машины и бэкэнда для сертификата доверия приложения Proxy

**Цель:** Убедитесь, что разъем машины, бэкэнд прокси и брандмауэр может поддерживать сертификат, созданный разъем для будущего доверия и что сертификат действителен.

>[!NOTE]
>Соединитель пытается создать сертификат SHA512, поддерживаемый TLS1.2. Если машина или бэкэнд брандмауэр и прокси-сервер не поддерживают TLS1.2, установка завершается сбой.
>
>

**Просмотрите необходимые предварительные требования:**

1.  Убедитесь, что компьютер поддерживает TLS1.2. Для этого требуется версия Windows после 2012 R2. Если на компьютере соединителя используется версия 2012 R2 или более ранняя, убедитесь, что на нем установлены следующие пакеты обновления: <https://support.microsoft.com/help/2973337/sha512-is-disabled-in-windows-when-you-use-tls-1.2>

2.  Обратитесь к администратору сети и попросите убедиться, что внутренний прокси-сервер и брандмауэр не блокируют SHA512 для исходящего трафика.

**Для проверки сертификата клиента:**

Проверьте отпечаток пальца текущего сертификата клиента. Хранилище сертификатов можно найти в %ProgramData% -Microsoft AAD Приложение Прокси-коннектор

```
<?xml version="1.0" encoding="utf-8"?>
<ConnectorTrustSettingsFile xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <CloudProxyTrust>
    <Thumbprint>4905CC64B2D81BBED60962ECC5DCF63F643CCD55</Thumbprint>
    <IsInUserStore>false</IsInUserStore>
  </CloudProxyTrust>
</ConnectorTrustSettingsFile>
```

Вот возможные значения и значения **IsInUserStore:**

- **ложное** - Сертификат клиента был создан во время установки или регистрации, инициированной командой Register-AppProxyConnector. Хранится в личном контейнере в магазине сертификатов местной машины. 

Выполните действия по проверке сертификата:

1. Выполнить **certlm.msc**
2. В консоли управления расширить личный контейнер и нажмите на сертификаты
3. Найдите сертификат, выданный **connectorregistrationca.msappproxy.net**

- **правда** - Автоматически обновленный сертификат хранится в личном контейнере в магазине сертификатов пользователя Сетевой службы. 

Выполните действия по проверке сертификата:

1. Скачать [PsTools.zip](https://docs.microsoft.com/sysinternals/downloads/pstools)
2. Извлеките [PsExec](https://docs.microsoft.com/sysinternals/downloads/psexec) из пакета и запустите **psexec -i -u "nt authority'network service" cmd.exe** из повышенной командной подсказки.
3. Выполнить **certmgr.msc** в недавно появившейся командной подсказке
2. В консоли управления расширить личный контейнер и нажмите на сертификаты
3. Найдите сертификат, выданный «connectorregistrationca.msappproxy.ne

**Для продления сертификата клиента:**

Если соединитель несколько месяцев не подключается к службе, возможно, его сертификаты устарели. Сбой в продлении сертификата приводит к просроченной сертификации. Это делает службу разъема, чтобы остановить работу. Событие 1000 записано в админ-журнале разъема:

"Перерегистрация коннектора не удалась: истек срок действия сертификата доверия Connector. Запустите PowerShell cmdlet Register-AppProxyConnectconnector на компьютере, на котором работает коннектор для перерегистрации вашего разъема".

В этом случае, удалить и переустановить разъем, чтобы вызвать регистрацию или вы можете запустить следующие команды PowerShell:

```
Import-module AppProxyPSModule
Register-AppProxyConnector
```

Чтобы узнать больше о команде Register-AppProxyConnector, пожалуйста, смотрите [Создать без присмотра сценарий установки для разъема прокси-сервера Приложения Azure AD](https://docs.microsoft.com/azure/active-directory/manage-apps/application-proxy-register-connector-powershell)

## <a name="verify-admin-is-used-to-install-the-connector"></a>Проверка прав администратора у пользователя, устанавливающего соединитель

**Цель:** убедитесь, что пользователь, пытающийся установить соединитель, является администратором с подходящими учетными данными. В настоящее время пользователь должен быть по крайней мере администратором приложения для успешной установки.

**Проверка правильности учетных данных:**

Подключитесь к `https://login.microsoftonline.com` и используйте те же учетные данные. Убедитесь, что вход прошел успешно. Вы можете проверить роль пользователя, перейдя к **пользователям ИТ-каталога Azure Active Directory**  - &gt; **и группам**  - &gt; **всех пользователей.** 

Выберите учетную запись пользователя, а затем "Роль каталога" в полученном меню. Убедитесь, что выбранная роль является "Администратор приложения". Если вам не удается открыть какие-либо страницы при выполнении описанных действий, у вас нет нужной роли.

## <a name="next-steps"></a>Дальнейшие действия
[Понять разъемы прокси-приложений Azure AD](application-proxy-connectors.md)
