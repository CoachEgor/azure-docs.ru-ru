---
title: Проблема при установке соединителя агента прокси приложения | Документы Майкрософт
description: Устранение проблем при установке соединителя агента прокси приложения
services: active-directory
documentationcenter: ''
author: kenwith
manager: celestedg
ms.assetid: ''
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: troubleshooting
ms.date: 05/21/2018
ms.author: kenwith
ms.reviewer: japere
ms.collection: M365-identity-device-management
ms.openlocfilehash: 602ca070bcaefd20585681e409ab85e9d455160a
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84764695"
---
# <a name="problem-installing-the-application-proxy-agent-connector"></a>Проблема при установке соединителя агента прокси приложения

Соединитель прокси приложения Microsoft AAD — это внутренний компонент домена, использующий исходящие соединения для установки подключения из конечной точки в облаке к внутреннему домену.

## <a name="general-problem-areas-with-connector-installation"></a>Общие проблемные области при установке соединителя

При сбое установки соединителя первопричина обычно относится к одной из следующих областей:

1.  **Подключение** — для успешной установки новому соединителю нужно зарегистрироваться и установить свойства доверия. Это осуществляется путем подключения к облачной службе прокси приложения AAD.

2.  **Установление отношений доверия** — новый соединитель создает самозаверяющий сертификат и регистрируется в облачной службе.

3.  **Проверка подлинности администратора** — для завершения установки соединителя пользователю нужно предоставить учетные данные администратора.

> [!NOTE]
> Журналы установки соединителя находятся в папке% TEMP%. они могут помочь в предоставлении дополнительных сведений о причинах сбоя установки.

## <a name="verify-connectivity-to-the-cloud-application-proxy-service-and-microsoft-login-page"></a>Проверка подключения к прокси-службе облачного приложения и странице входа Майкрософт

**Цель:** убедитесь, что компьютер соединителя может подключиться к конечной точке регистрации прокси приложения AAD, а также к странице входа Майкрософт.

1.  На сервере соединителя выполните проверку порта с помощью [Telnet](https://docs.microsoft.com/windows-server/administration/windows-commands/telnet) или другого средства тестирования портов, чтобы убедиться, что порты 443 и 80 открыты.

2.  Если какой-либо из этих портов не прошел успешно, убедитесь, что брандмауэр или серверный прокси имеет доступ к нужным доменам и портам, а затем [Подготовьте локальную среду](application-proxy-add-on-premises-application.md#prepare-your-on-premises-environment).

3.  Откройте браузер (отдельную вкладку), перейдите к веб-странице `https://login.microsoftonline.com` и убедитесь, что можете войти на эту страницу.

## <a name="verify-machine-and-backend-components-support-for-application-proxy-trust-certificate"></a>Проверка поддержки компьютеров и серверных компонентов для сертификата доверия прокси приложения

**Цель:** Убедитесь, что компьютер соединителя, внутренний прокси-сервер и брандмауэр могут поддерживать сертификат, созданный соединителем для будущего доверия, и что сертификат действителен.

>[!NOTE]
>Соединитель пытается создать сертификат SHA512, поддерживаемый TLS1.2. Если компьютер или серверный брандмауэр и прокси-сервер не поддерживают TLS 1.2, установка завершается сбоем.
>
>

**Ознакомьтесь с необходимыми предварительными требованиями:**

1.  Убедитесь, что компьютер поддерживает TLS1.2. Для этого требуется версия Windows после 2012 R2. Если на компьютере соединителя используется версия 2012 R2 или более ранняя, убедитесь, что на нем установлены следующие пакеты обновления: <https://support.microsoft.com/help/2973337/sha512-is-disabled-in-windows-when-you-use-tls-1.2>

2.  Обратитесь к администратору сети и попросите убедиться, что внутренний прокси-сервер и брандмауэр не блокируют SHA512 для исходящего трафика.

**Чтобы проверить сертификат клиента, выполните следующие действия.**

Проверьте отпечаток текущего сертификата клиента. Хранилище сертификатов можно найти в прокси приложения%Програмдата%\микрософт\микрософт AAD Connector\Config\TrustSettings.xml

```
<?xml version="1.0" encoding="utf-8"?>
<ConnectorTrustSettingsFile xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <CloudProxyTrust>
    <Thumbprint>4905CC64B2D81BBED60962ECC5DCF63F643CCD55</Thumbprint>
    <IsInUserStore>false</IsInUserStore>
  </CloudProxyTrust>
</ConnectorTrustSettingsFile>
```

Ниже приведены возможные значения **исинусерсторе** и их смысл:

- **false** — сертификат клиента был создан во время установки или регистрации, инициированной командой Register-апппроксиконнектор. Он хранится в личном контейнере в хранилище сертификатов на локальном компьютере. 

Выполните следующие действия, чтобы проверить сертификат:

1. Запуск **certlm. msc**
2. В консоли управления разверните личный контейнер и щелкните Сертификаты.
3. Определение местонахождения сертификата, выданного **connectorregistrationca.msappproxy.NET**

- **true** — автоматически обновленный сертификат хранится в личном контейнере в хранилище сертификатов пользователя сетевой службы. 

Выполните следующие действия, чтобы проверить сертификат:

1. Скачать [PsTools.zip](https://docs.microsoft.com/sysinternals/downloads/pstools)
2. Извлеките [PsExec](https://docs.microsoft.com/sysinternals/downloads/psexec) из пакета и выполните команду **PsExec-i-u "NT authority\network Service" cmd.exe** из командной строки с повышенными привилегиями.
3. Запустите **CertMgr. msc** в вновь появившийся командной строке.
2. В консоли управления разверните личный контейнер и щелкните Сертификаты.
3. Определение местонахождения сертификата, выданного **connectorregistrationca.msappproxy.NET**

**Чтобы продлить сертификат клиента, выполните следующие действия.**

Если соединитель несколько месяцев не подключается к службе, возможно, его сертификаты устарели. Сбой обновления сертификата приводит к просроченному сертификату. Это позволит службе соединителя перестать работать. Событие 1000 регистрируется в журнале администратора соединителя:

"Сбой повторной регистрации соединителя: срок действия сертификата доверия соединителя истек. Выполните командлет PowerShell Register-Апппроксиконнектор на компьютере, на котором запущен соединитель, чтобы повторно зарегистрировать соединитель. "

В этом случае удалите и переустановите соединитель для активации регистрации или выполните следующие команды PowerShell:

```
Import-module AppProxyPSModule
Register-AppProxyConnector
```

Дополнительные сведения о команде Register-Апппроксиконнектор см. в статье [Создание сценария автоматической установки для соединителя Azure AD application proxy](https://docs.microsoft.com/azure/active-directory/manage-apps/application-proxy-register-connector-powershell) .

## <a name="verify-admin-is-used-to-install-the-connector"></a>Проверка прав администратора у пользователя, устанавливающего соединитель

**Цель:** убедитесь, что пользователь, пытающийся установить соединитель, является администратором с подходящими учетными данными. В настоящее время для успешности установки пользователь должен быть по крайней мере администратором приложения.

**Проверка правильности учетных данных:**

Подключитесь к `https://login.microsoftonline.com` и используйте те же учетные данные. Убедитесь, что вход прошел успешно. Чтобы проверить роль пользователя, перейдите в **Azure Active Directory**  - &gt; **Пользователи и группы**  - &gt; **все пользователи**. 

Выберите учетную запись пользователя, а затем "роль каталога" в итоговом меню. Убедитесь, что выбрана роль "Администратор приложения". Если вам не удается открыть какие-либо страницы при выполнении описанных действий, у вас нет нужной роли.

## <a name="next-steps"></a>Дальнейшие действия
[Сведения о соединителях прокси приложения Azure AD](application-proxy-connectors.md)
