---
title: Аутентификация на основе заголовков с использованием PingAccess для прокси приложения Azure AD | Документация Майкрософт
description: Публикация приложений с использованием PingAccess и прокси приложения для реализации аутентификации на основе заголовка.
services: active-directory
documentationcenter: ''
author: msmimart
manager: CelesteDG
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 10/24/2019
ms.author: celested
ms.reviewer: harshja
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: f3fb94629262519f8cfa5da72ee343726aa7d1c1
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77367981"
---
# <a name="header-based-authentication-for-single-sign-on-with-application-proxy-and-pingaccess"></a>Аутентификация на основе заголовка для единого входа с использованием прокси приложения и PingAccess

Прокси-сервер приложения Azure Active Directory (Azure AD) сотрудничает с PingAccess, чтобы клиенты Azure AD могли получить доступ к большему количестве приложений. PingAccess позволяет включить в [существующие предложения прокси приложения](application-proxy.md) возможность доступа с единым входом к приложениям, в которых используется аутентификация на основе заголовков.

## <a name="whats-pingaccess-for-azure-ad"></a>Что такое PingAccess для Azure AD?

С PingAccess for Azure AD вы можете предоставить пользователям доступ и одиночный вход (SSO) к приложениям, которые используют заголовки для проверки подлинности. Прокси приложения обрабатывает такие приложения, как и любые другие, используя Azure AD для аутентификации доступа и передавая трафик через службу соединителя. PingAccess находится перед приложениями и переводит токен доступа из Azure AD в заголовок. Затем приложение получает аутентификацию в формате, который он может прочитать.

Получая доступ к корпоративным приложениям, пользователи не заметят никаких отличий в процедуре входа. Они по-прежнему смогут работать в любом расположении и на любом устройстве. Разъемы App Proxy направляют удаленный трафик во все приложения без учета типа аутентификации, поэтому они будут автоматически балансировать нагрузки.

## <a name="how-do-i-get-access"></a>Как мне получить доступ?

Поскольку этот сценарий исходит из партнерства между Active Directory Azure и PingAccess, вам нужны лицензии для обеих служб. Тем не менее подписки Azure Active Directory Premium включает в себя базовую лицензию PingAccess, которая поддерживает до 20 приложений. Если необходимо опубликовать более 20 приложений, использующих заголовки, вы можете приобрести дополнительную лицензию PingAccess.

Дополнительные сведения см. в разделе [Выпуски Azure Active Directory](../fundamentals/active-directory-whatis.md).

## <a name="publish-your-application-in-azure"></a>Публикация приложения в Azure

Эта статья предназначена для того, чтобы люди впервые опубликовали приложение с этим сценарием. Помимо детализации публикации шаги, он направляет вас в начале работы с обоих приложения прокси и PingAccess. Если вы уже настроили обе службы, но хотите переостереть шаги публикации, перейдите к [приложению «Добавить приложение» в раздел Azure AD с](#add-your-application-to-azure-ad-with-application-proxy) разделом Application Proxy.

> [!NOTE]
> Так как этот сценарий предполагает совместное использование Azure AD и PingAccess, некоторые инструкции доступны на сайте Ping Identity.

### <a name="install-an-application-proxy-connector"></a>Установка соединителя прокси приложения

Если вы включили приложение Прокси включен и установили разъем уже, вы можете пропустить этот раздел и перейти к [добавлению приложения в Azure AD с application Proxy.](#add-your-application-to-azure-ad-with-application-proxy)

Разъем application Proxy — это служба Windows Server, которая направляет трафик от удаленных сотрудников к опубликованным приложениям. Для более подробных инструкций по установке см. [Tutorial: Добавьте приложение для удаленного доступа через Application Proxy в Active Directory Azure.](application-proxy-add-on-premises-application.md)

1. Вопиюсь на [порталaz Active Directory](https://aad.portal.azure.com/) в качестве администратора приложений. Отображается страница **центра adin-центра Azure Active Directory.**
1. Выберите **Azure Active Directory** > **Application прокси** > **Скачать службу разъема.** Появляется страница **загрузки подключения прокси-сервера приложения.**

   ![Загрузка прокси-разъема приложения](./media/application-proxy-configure-single-sign-on-with-ping-access/application-proxy-connector-download.png)

1. Следуйте инструкциям по установке.

Загрузка разъема должна автоматически включать прокси-сервер приложения для вашего каталога, но если нет, вы можете выбрать **Прокси-приложение Включить.**

### <a name="add-your-application-to-azure-ad-with-application-proxy"></a>Добавление приложения в Azure AD с помощью прокси-сервера приложений

Существуют два действия, которые необходимо выполнить на портале Azure. Во-первых, необходимо опубликовать приложение с помощью прокси приложения. Затем необходимо собрать некоторую информацию о приложении, которое можно использовать во время шагов PingAccess.

#### <a name="publish-your-application"></a>Публикация приложения

Сначала вам придется опубликовать свое заявление. Это действие включает в себя:

- Добавление приложения в Azure AD
- Назначение пользователя для тестирования приложения и выбора SSO на основе заголовка
- Настройка URL-адреса перенаправления приложения
- Предоставление пользователям и другим приложениям разрешений на использование вашего приложения

Чтобы опубликовать собственное приложение:

1. Если вы не в последнем разделе, вопийте на [портале Active Directory Azure](https://aad.portal.azure.com/) в качестве администратора приложений.
1. Выберите **приложения** > Enterprise**Новое приложение** > **Добавление приложения для локтевого.** **Отображается собственная** страница приложения.

   ![Добавить собственное приложение](./media/application-proxy-configure-single-sign-on-with-ping-access/add-your-own-on-premises-application.png)
1. Заполните необходимые поля информацией о новом приложении. Используйте приведенное ниже руководство для настроек.

   > [!NOTE]
   > Более подробное представление об этом шаге можно узнать в [приложении Azure AD.](application-proxy-add-on-premises-application.md#add-an-on-premises-app-to-azure-ad)

   1. **Внутренний URL:** Обычно вы предоставляете URL-адрес, который приведет вас к странице регистрации приложения, когда вы находитесь в корпоративной сети. Для этого сценария разъем должен рассматривать прокси PingAccess как первую страницу приложения. Используйте следующий формат: `https://<host name of your PingAccess server>:<port>`. Порт 3000 используется по умолчанию, но его можно настроить в PingAccess.

      > [!WARNING]
      > Для этого типа единого ввода внутренний `https` URL должен `http`использоваться и не использоваться.

   1. **Метод предварительной аутентификации**: Выберите **активный каталог Azure**.
   1. **Переведите URL-адрес в заголовках:** Выберите **нет**.

   > [!NOTE]
   > Если это ваше первое приложение, для начала используйте порт 3000, а затем измените этот параметр, если измените конфигурацию доступа PingAccess. Для последующих приложений порт должен соответствовать слушателю, настроенного в PingAccess. Узнайте больше о [прослушивателях в PingAccess](https://support.pingidentity.com/s/document-item?bundleId=pingaccess-52&topicId=reference/ui/pa_c_Listeners.html).

1. Нажмите кнопку **Добавить**. Отображается страница обзора нового приложения.

Теперь назначайте пользователя для тестирования приложений и выберите одиночный вписаться в заголовок:

1. Из боковой панели приложения выберите **пользователей и группы** > **Добавление** > **пользователей и групп (количество\<> выбрано).** Список пользователей и групп отображается для вас на выбор.

   ![Отображает список пользователей и групп](./media/application-proxy-configure-single-sign-on-with-ping-access/users-and-groups.png)

1. Выберите пользователя для тестирования приложения и **выберите .** Убедитесь, что у тестовой учетной записи есть доступ к локальному приложению.
1. Выберите **Назначить**.
1. Из боковой панели приложения выберите **одиночный указатель на** > **заголовке.**

   > [!TIP]
   > Если вы впервые используете единый вход на основе заголовка, необходимо установить PingAccess. Чтобы обеспечить автоматическую привязку подписки Azure к установленной службе PingAccess, используйте ссылку на этой странице единого входа для скачивания PingAccess. Вы можете прямо сейчас перейти на сайт скачивания или вернуться на эту страницу позже.

   ![Показывает заголовок на основе экрана и PingAccess](./media/application-proxy-configure-single-sign-on-with-ping-access/sso-header.png)

1. Нажмите кнопку **Сохранить**.

Затем убедитесь, что URL-адрес перенаправления установлен на внешний URL:

1. На боковой панели **admin-центра Azure Active Directory** выберите**регистрацию приложений** **Azure Active Directory.** >  Отображается список приложений.
1. Выберите приложение.
1. Выберите ссылку рядом с **REdirect URIs**, показывая количество перенаправить URIs, созданных для веб-клиентов и публичных клиентов. Название приложения> - появляется страница ** \<аутентификации.**
1. Проверьте, находится ли внешний URL-адрес, назначенный приложению ранее, в списке **URIs Redirect.** Если это не так, добавьте внешний URL сейчас, используя перенаправление типа **URI Web,** и выберите **Сохранить**.

Наконец, навлажьте свое приложение для чтения, а другие приложения считывались/писали:

1. Из **боковой панели регистраций приложений для приложения** выберите разрешения >  **API****Добавление разрешения** > **Microsoft API** > **Microsoft Graph.** Отображается страница **разрешений API запроса** для **Microsoft Graph,** которая содержит API для Active Directory Windows Azure.

   ![Отображает страницу разрешений API запроса](./media/application-proxy-configure-single-sign-on-with-ping-access/required-permissions.png)

1. Выберите **делегированные** > разрешения**User** > **User.Read**.
1. Выберите**Application** >  **разрешения** > приложения**Application.ReadWrite.All**.
1. Выберите **Добавить разрешения**.
1. На странице **разрешений API** выберите **согласие админа-консультанта Гранта на \<имя каталога>. **

#### <a name="collect-information-for-the-pingaccess-steps"></a>Сбор сведений об этапах PingAccess

Для настройки приложения pingAccess необходимо собрать эти три части информации (все GUID):

| Название поля Azure AD | Название поля PingAccess | Формат данных |
| --- | --- | --- |
| **Application (client) ID** (Идентификатор приложения (клиент)) | **Идентификатор клиента** | GUID |
| **Идентификатор каталога (клиент)** | **Эмитента** | GUID |
| `PingAccess key` | **Секрет клиента** | Случайная строка |

Для сбора этой информации:

1. На боковой панели **admin-центра Azure Active Directory** выберите**регистрацию приложений** **Azure Active Directory.** >  Отображается список приложений.
1. Выберите приложение. Появляется страница **регистрации приложений** для вашего приложения.

   ![Обзор регистрации приложения](./media/application-proxy-configure-single-sign-on-with-ping-access/registration-overview-for-an-application.png)

1. Рядом со значением **id приложения (клиента)** выберите **значок copy to clipboard,** затем скопируйте и сохраните его. Это значение позже указано как идентификатор клиента PingAccess.
1. Далее **значение идентификатора каталога (арендатора),** также выберите **Copy в буфер обмена,** затем скопируйте и сохраните его. Это значение вы укажете позже в качестве эмитента PingAccess.
1. С боковой панели **регистрации приложения** для вашего приложения, выберите **Сертификаты и секреты** > **Новый секрет клиента**. **Появляется секретная** страница клиента.

   ![Отображает страницу «Добавить секретную страницу клиента»](./media/application-proxy-configure-single-sign-on-with-ping-access/add-a-client-secret.png)

1. В **Описании**, тип `PingAccess key`.
1. В **соответствии**с истекает, выбрать, как установить ключ PingAccess: **В 1 год**, в 2 **года,** или **никогда**.
1. Нажмите кнопку **Добавить**. Ключ PingAccess отображается в таблице секретов клиента, со случайной строкой, которая автозаполняется в поле **VALUE.**
1. Рядом с полем **VALUE** ключа PingAccess выберите **значок Copy для значка буфера обмена,** а затем скопируйте и сохраните его. Вы укажете это значение позже как секрет клиента PingAccess.

**Обновление `acceptMappedClaims` поля:**

1. Вопиюсь на [порталaz Active Directory](https://aad.portal.azure.com/) в качестве администратора приложений.
1. Выберите > **регистрацию приложений**Active **Directory Azure.** Отображается список приложений.
1. Выберите приложение.
1. С боковой панели **страницы регистрации приложения** для вашего приложения выберите **Manifest**. Отображается манифест JSON-код для регистрации приложения.
1. Поиск `acceptMappedClaims` поля и изменение значения `True`на .
1. Нажмите кнопку **Сохранить**.

### <a name="use-of-optional-claims-optional"></a>Использование дополнительных требований (необязательно)

Дополнительные требования позволяют добавлять стандартные, но не включенные по умолчанию утверждения, которые есть у каждого пользователя и арендатора. Вы можете настроить дополнительные претензии для приложения, изменив манифест приложения. Для получения дополнительной [Understanding the Azure AD application manifest article](https://docs.microsoft.com/azure/active-directory/develop/reference-app-manifest/) информации см.

Пример включения адреса электронной почты в access_token, который pingAccess будет потреблять:
```
    "optionalClaims": {
        "idToken": [],
        "accessToken": [
            {
                "name": "email",
                "source": null,
                "essential": false,
                "additionalProperties": []
            }
        ],
        "saml2Token": []
    },
```

### <a name="use-of-claims-mapping-policy-optional"></a>Использование политики картирования требований (необязательно)

[Политика картирования требований (предварительный просмотр)](https://docs.microsoft.com/azure/active-directory/develop/active-directory-claims-mapping#claims-mapping-policy-properties) для атрибутов, которых не существует в AzureAD. Отображение утверждений позволяет перенести старые приложения на прем в облако, добавляя дополнительные пользовательские требования, которые поддерживаются вашими объектами ADFS или пользовательскими объектами

Чтобы сделать приложение использовать пользовательскую заявку и включить дополнительные поля, убедитесь, что вы также [создали пользовательскую политику отображения требований и присвоили ее приложению.](../develop/active-directory-claims-mapping.md#claims-mapping-policy-assignment)

> [!NOTE]
> Чтобы использовать настраиваемое утверждение, также необходимо определить настраиваемую политику и назначить ее приложению. Эта политика должна включать все обязательные настраиваемые атрибуты.
>
> Вы можете выполнять определение и назначение политики через PowerShell или Microsoft Graph. Если вы делаете их в PowerShell, вам `New-AzureADPolicy` может понадобиться сначала использовать, `Add-AzureADServicePrincipalPolicy`а затем назначить его в приложение с . Для получения дополнительной [Claims mapping policy assignment](../develop/active-directory-claims-mapping.md#claims-mapping-policy-assignment)информации см.

Пример
```powershell
$pol = New-AzureADPolicy -Definition @('{"ClaimsMappingPolicy":{"Version":1,"IncludeBasicClaimSet":"true", "ClaimsSchema": [{"Source":"user","ID":"employeeid","JwtClaimType":"employeeid"}]}}') -DisplayName "AdditionalClaims" -Type "ClaimsMappingPolicy"

Add-AzureADServicePrincipalPolicy -Id "<<The object Id of the Enterprise Application you published in the previous step, which requires this claim>>" -RefObjectId $pol.Id
```

### <a name="enable-pingaccess-to-use-custom-claims"></a>Включить PingAccess для использования пользовательских требований

Включение PingAccess в использование пользовательских требований является необязательным, но требуется, если вы ожидаете, что приложение потребляет дополнительные требования.

Когда вы будете настраивать PingAccess на следующем этапе, веб-сессия, которая будет создаваться (Настройки >доступ->веб-сессии) должна иметь **профиль запроса,** неизбираемый и **обновлять атрибуты пользователя, установленные** **на Нет**

## <a name="download-pingaccess-and-configure-your-application"></a>Скачать PingAccess и настроить приложение

Теперь, когда вы выполнили все этапы установки Azure Active Directory, можно перейти к настройке PingAccess.

Подробные шаги для части PingAccess этого сценария продолжаются в документации Ping Identity. Следуйте инструкциям в [Configure PingAccess for Azure AD для защиты приложений, опубликованных с помощью прокси-приложения Microsoft Azure AD](https://support.pingidentity.com/s/document-item?bundleId=pingaccess-52&topicId=agents/azure/pa_c_PAAzureSolutionOverview.html) на веб-сайте Ping Identity.

Эти шаги помогут вам установить PingAccess и настроить учетную запись PingAccess (если у вас ее еще нет). Затем, чтобы создать подключение Azure AD OpenID Connect (OIDC), вы настроили поставщика токенов с **идентификатором каталога (арендатора),** который вы скопировали с портала Azure AD. Затем, чтобы создать веб-сессию на PingAccess, вы `PingAccess key` используете **идентификатор приложения (клиента)** и значения. После этого вы сможете настроить сопоставление удостоверений и создать виртуальный узел, сайт и приложение.

### <a name="test-your-application"></a>Тестирование приложения

Когда вы завершаете все эти этапы, приложение должно быть запущено. Чтобы протестировать его, откройте браузер и перейдите на созданный внешний URL при публикации приложения в Azure. Воспримите тестовую учетную запись, назначенную приложению.

## <a name="next-steps"></a>Дальнейшие действия

- [Нанастройка PingAccess для Azure AD для защиты приложений, опубликованных с помощью прокси-приложения Microsoft Azure AD](https://support.pingidentity.com/s/document-item?bundleId=pingaccess-52&topicId=agents/azure/pa_c_PAAzureSolutionOverview.html)
- [Единый вход в приложениях в Azure Active Directory](what-is-single-sign-on.md)
- [Устранение неполадок и сообщения об ошибках прокси приложения](application-proxy-troubleshoot.md)
