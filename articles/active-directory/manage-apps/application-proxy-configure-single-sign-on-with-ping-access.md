---
title: Аутентификация на основе заголовков с использованием PingAccess для прокси приложения Azure AD | Документация Майкрософт
description: Публикация приложений с использованием PingAccess и прокси приложения для реализации аутентификации на основе заголовка.
services: active-directory
documentationcenter: ''
author: msmimart
manager: CelesteDG
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 05/08/2019
ms.author: celested
ms.reviewer: harshja
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: ab08c93662988655154cf300ac4ee3758fbc7872
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "66472800"
---
# <a name="header-based-authentication-for-single-sign-on-with-application-proxy-and-pingaccess"></a>Аутентификация на основе заголовка для единого входа с использованием прокси приложения и PingAccess

Прокси приложения Azure Active Directory (Azure AD) сотрудничает с PingAccess, позволяя клиентам Azure AD получать доступ к несколько приложений. PingAccess позволяет включить в [существующие предложения прокси приложения](application-proxy.md) возможность доступа с единым входом к приложениям, в которых используется аутентификация на основе заголовков.

## <a name="whats-pingaccess-for-azure-ad"></a>Что такое PingAccess для Azure AD?

С использованием PingAccess для Azure AD можно предоставить пользователям доступ и единый вход (SSO) для приложений, использующих заголовки для проверки подлинности. Прокси приложения обрабатывает такие приложения, как и любые другие, используя Azure AD для аутентификации доступа и передавая трафик через службу соединителя. PingAccess находится перед приложений и преобразовывает маркер доступа из Azure AD в заголовок. Затем приложение получает проверку подлинности в тот формат, который может считывать.

Получая доступ к корпоративным приложениям, пользователи не заметят никаких отличий в процедуре входа. Они по-прежнему смогут работать в любом расположении и на любом устройстве. Соединители прокси приложения направляют удаленный трафик во все приложения независимо от поддерживаемого типа аутентификации, поэтому они по-прежнему будет распределять нагрузку автоматически.

## <a name="how-do-i-get-access"></a>Как мне получить доступ?

Так как этот сценарий возникает в связи между Azure Active Directory и PingAccess, вам понадобятся лицензии для обеих служб. Тем не менее подписки Azure Active Directory Premium включает в себя базовую лицензию PingAccess, которая поддерживает до 20 приложений. Если необходимо опубликовать более 20 приложений, использующих заголовки, вы можете приобрести дополнительную лицензию PingAccess.

Дополнительные сведения см. в разделе [Выпуски Azure Active Directory](../fundamentals/active-directory-whatis.md).

## <a name="publish-your-application-in-azure"></a>Публикация приложения в Azure

Эта статья предназначена для людей опубликовать приложение с этим сценарием, в первый раз. Помимо детального рассмотрения этапы публикации, он помогает при начале работы с прокси приложения и PingAccess. Если вы уже настроили обе службы, но хотите вспомнить действия по публикации, перейдите к разделу [добавить приложения в Azure AD с помощью прокси приложения](#add-your-application-to-azure-ad-with-application-proxy) раздел.

> [!NOTE]
> Так как этот сценарий предполагает совместное использование Azure AD и PingAccess, некоторые инструкции доступны на сайте Ping Identity.

### <a name="install-an-application-proxy-connector"></a>Установка соединителя прокси приложения

Если вы включили прокси приложения включен и уже установили соединитель, можно пропустить этот раздел и перейдите к [добавить приложения в Azure AD с помощью прокси приложения](#add-your-application-to-azure-ad-with-application-proxy).

Соединитель прокси приложения — это служба Windows Server, которая направляет трафик от удаленных сотрудников к опубликованным приложениям. Более подробные инструкции по установке, см. в разделе [руководства: Добавление локального приложения для удаленного доступа через прокси приложения в Azure Active Directory](application-proxy-add-on-premises-application.md).

1. Войдите в [портал Azure Active Directory](https://aad.portal.azure.com/) как администратор приложений. **Центр администрирования Azure Active Directory** появится страница.
2. Выберите **Azure Active Directory** > **прокси приложения** > **скачать службу соединителя**. **Скачивания соединителя прокси приложения** появится страница.

   ![Скачивание соединителя прокси приложения](./media/application-proxy-configure-single-sign-on-with-ping-access/application-proxy-connector-download.png)
3. Выполните инструкции по установке.

Загрузка connector должен автоматически включить прокси приложения для каталога, но если это не так, можно выбрать **Включение прокси приложения**.

### <a name="add-your-application-to-azure-ad-with-application-proxy"></a>Добавление приложения в Azure AD с помощью прокси приложения

Существуют два действия, которые необходимо выполнить на портале Azure. Во-первых, необходимо опубликовать приложение с помощью прокси приложения. Затем необходимо собрать некоторые сведения о приложении, которое можно использовать во время выполнения процедуры PingAccess.

#### <a name="publish-your-application"></a>Публикация приложения

Во-первых, вы получите для публикации приложения. Это действие включает в себя:

- Добавление локального приложения в Azure AD
- Назначение пользователя для тестирования приложения и выбрав единый вход на основе заголовка
- Настройка URL-адрес перенаправления приложения
- Предоставление разрешений для пользователей и другим приложениям использовать приложения на предприятии

Чтобы опубликовать приложение в локальной:

1. Если это еще не сделали, войдите в [портал Azure Active Directory](https://aad.portal.azure.com/) как администратор приложений.
2. Выберите **корпоративные приложения** > **новое приложение** > **локальное приложение**. **Добавление собственного приложения в локальной** появится страница.

   ![Добавление собственного приложения на предприятии](./media/application-proxy-configure-single-sign-on-with-ping-access/add-your-own-on-premises-application.png)
3. Заполните обязательные поля с информацией о нового приложения. Следуйте инструкциям ниже для параметров.

   > [!NOTE]
   > Более подробное Пошаговое руководство для этого шага, см. в разделе [Добавление локального приложения в Azure AD](application-proxy-add-on-premises-application.md#add-an-on-premises-app-to-azure-ad).

   1. **Внутренний URL-адрес**. Обычно вы предоставить URL-адрес для перехода к странице входа приложения от корпоративной сети. В этом сценарии соединителя необходимо считать прокси-сервер PingAccess титульной страницей приложения. Используйте следующий формат: `https://<host name of your PingAccess server>:<port>`. Порт 3000 используется по умолчанию, но его можно настроить в PingAccess.

      > [!WARNING]
      > Для этого типа единого входа, необходимо использовать внутренний URL-адрес `https` и не может использовать `http`.

   2. **Метод предварительной аутентификации**. Выберите **Azure Active Directory**.
   3. **Перевод веб-страниц в заголовках**. Выберите **нет**.

   > [!NOTE]
   > Если это ваше первое приложение, для начала используйте порт 3000, а затем измените этот параметр, если измените конфигурацию доступа PingAccess. Для последующих приложений порт должны соответствовать прослушивателю, настроенному в PingAccess. Узнайте больше о [прослушивателях в PingAccess](https://documentation.pingidentity.com/pingaccess/pa31/index.shtml#Listeners.html).
4. Выберите **Добавить**. Откроется страница "Обзор" для нового приложения.

Теперь назначьте пользователя для тестирования приложений и выберите на основе заголовков единого входа:

1. В боковой панели приложения выберите **пользователей и групп** > **добавить пользователя** > **пользователей и групп (\<номер > выбрано)** . Появится список пользователей и групп для на ваш выбор.

   ![Пользователи и группы](./media/application-proxy-configure-single-sign-on-with-ping-access/users-and-groups.png)
2. Выберите пользователя для тестирования приложений и выберите **выберите**. Убедитесь, что у тестовой учетной записи есть доступ к локальному приложению.
3. Выберите **Назначить**.
4. В боковой панели приложения выберите **единого входа** > **на основе заголовка**.

   > [!TIP]
   > Если вы впервые используете единый вход на основе заголовка, необходимо установить PingAccess. Чтобы обеспечить автоматическую привязку подписки Azure к установленной службе PingAccess, используйте ссылку на этой странице единого входа для скачивания PingAccess. Вы можете прямо сейчас перейти на сайт скачивания или вернуться на эту страницу позже.

   ![Единый входа на основе заголовка](./media/application-proxy-configure-single-sign-on-with-ping-access/sso-header.png)
5. Щелкните **Сохранить**.

Затем убедитесь, что ваш URL-адрес имеет значение URL-адреса внешнего перенаправления:

1. Из **Центр администрирования Azure Active Directory** боковой панели, выберите **Azure Active Directory** > **регистрация приложений**. Появится список приложений.

   ![Регистрация приложений](./media/application-proxy-configure-single-sign-on-with-ping-access/app-registrations.png)
2. Выберите приложение.
3. Выберите ссылку рядом с полем **URI перенаправления**, показывая количество перенаправления, настроить идентификаторы URI для общедоступных клиентских приложений и веб. **\<Имя приложения >-проверки подлинности** появится страница.
4. Проверьте, является ли внешний URL-адрес, назначенный приложению ранее в **URI перенаправления** списка. Если это не так, добавьте внешний URL-адрес, с помощью типа URI перенаправления **Web**и выберите **Сохранить**.

Наконец настройте приложение в локальной, чтобы пользователи имеют доступ на чтение и других приложений с доступом на чтение и запись:

1. Из **регистрация приложений** боковой панели для вашего приложения, выберите **разрешения API** > **добавить разрешение**  >   **API-интерфейсов Microsoft** > **Microsoft Graph**. **Разрешения запроса API** странице **Microsoft Graph** появится, который содержит API-интерфейсы для Windows Azure Active Directory.

   ![Запросить разрешения API](./media/application-proxy-configure-single-sign-on-with-ping-access/required-permissions.png)
2. Выберите **делегированные разрешения** > **пользователя** > **User.Read**.
3. Выберите **разрешения приложения** > **приложения** > **Application.ReadWrite.All**.
4. Выберите **добавить разрешения**.
5. В **разрешения API** выберите **предоставления согласия администратора \<имя каталога >** .

#### <a name="collect-information-for-the-pingaccess-steps"></a>Сбор сведений об этапах PingAccess

Необходимо собрать эти три элемента информации (все GUID), чтобы настроить приложение с использованием PingAccess:

| Имя поля в Azure AD | Имя поля PingAccess | Формат данных |
| --- | --- | --- |
| **Идентификатор приложения (клиент)** | **Идентификатор клиента** | GUID |
| **Идентификатор каталог (клиент)** | **Издатель** | GUID |
| `PingAccess key` | **Секрет клиента** | Случайная строка |

Для сбора этой информации:

1. Из **Центр администрирования Azure Active Directory** боковой панели, выберите **Azure Active Directory** > **регистрация приложений**. Появится список приложений.
2. Выберите приложение. **Регистрация приложений** приложения отобразится страница.

   ![Общие сведения о регистрации для приложения](./media/application-proxy-configure-single-sign-on-with-ping-access/registration-overview-for-an-application.png)
3. Рядом с полем **идентификатор приложения (клиент)** выберите **Копировать в буфер обмена** значок, а затем скопируйте и сохраните его. Задайте это значение позже как идентификатор клиента в PingAccess.
4. Далее **каталог (клиент) идентификатор** значений, также выберите **Копировать в буфер обмена**, затем скопируйте и сохраните его. Задайте это значение позже как издателя в PingAccess.
5. Из боковой панели элемента **регистрация приложений** для вашего приложения, выберите **сертификаты и секреты** > **новый секрет клиента**. **Добавление секрета клиента** появится страница.

   ![Добавление секрета клиента](./media/application-proxy-configure-single-sign-on-with-ping-access/add-a-client-secret.png)
6. В **описание**, тип `PingAccess key`.
7. В разделе **Expires**, выберите способ для указания ключа PingAccess: **Через 1 год**, **в 2 года**, или **никогда**.
8. Выберите **Добавить**. PingAccess ключ отображается в таблице секреты клиента со случайным строкой, autofills в **значение** поля.
9. Рядом с PingAccess для ключа **значение** выберите **Копировать в буфер обмена** значок, а затем скопируйте и сохраните его. Задайте это значение позже как секрет клиента в PingAccess.

### <a name="update-graphapi-to-send-custom-fields-optional"></a>Обновление API Graph для отправки настраиваемых полей (необязательно)

Если требуется пользовательское утверждение, отправляющее другие маркеры в маркер доступа, потребляемая PingAccess, задайте `acceptMappedClaims` поле приложения `True`. Можно использовать Graph Explorer или манифест приложения на портале Azure AD, чтобы внести это изменение.

**В этом примере используется Graph Explorer.**

```
PATCH https://graph.windows.net/myorganization/applications/<object_id_GUID_of_your_application>

{
  "acceptMappedClaims":true
}
```

**В этом примере используется [портал Azure Active Directory](https://aad.portal.azure.com/) обновить `acceptMappedClaims` поля:**

1. Войдите в [портал Azure Active Directory](https://aad.portal.azure.com/) как администратор приложений.
2. Выберите **Azure Active Directory** > **Регистрация приложений**. Появится список приложений.
3. Выберите приложение.
4. Из боковой панели элемента **регистрация приложений** страницу приложения, выберите **манифеста**. Появится манифеста код JSON для регистрации вашего приложения.
5. Поиск `acceptMappedClaims` поле и измените значение на `True`.
6. Щелкните **Сохранить**.


### <a name="use-of-optional-claims-optional"></a>Необязательные утверждения (необязательно)
Необязательные утверждения можно добавить standard-but-not-included-by-default утверждения, у каждого пользователя и клиента. Необязательные утверждения для приложения можно настроить, изменив манифест приложения. Дополнительные сведения см. в разделе [основные сведения о статье манифеста приложения Azure AD](https://docs.microsoft.com/azure/active-directory/develop/reference-app-manifest/)

Пример для включения адрес электронной почты в маркер доступа, который будет потреблять PingAccess.
```
    "optionalClaims": {
        "idToken": [],
        "accessToken": [
            {
                "name": "email",
                "source": null,
                "essential": false,
                "additionalProperties": []
            }
        ],
        "saml2Token": []
    },
```

### <a name="use-of-claims-mapping-policy-optional"></a>Использование утверждений, сопоставление политики (необязательно)
[Утверждения сопоставления политики (Предварительная версия)](https://docs.microsoft.com/azure/active-directory/develop/active-directory-claims-mapping#claims-mapping-policy-properties/) для атрибутов, которые не существуют в Azure AD. Сопоставление утверждений позволяет переносить старых локальных приложений в облако путем добавления дополнительных настраиваемых утверждений, связанных с ADFS или пользователь объектов

Чтобы сделать приложение использовать настраиваемое утверждение и включение дополнительных полей, убедитесь, что вы уже также [создается политика сопоставления настраиваемых утверждений и назначается приложение](../develop/active-directory-claims-mapping.md#claims-mapping-policy-assignment).

> [!NOTE]
> Чтобы использовать настраиваемое утверждение, также необходимо определить настраиваемую политику и назначить ее приложению. Эта политика должна включать все обязательные настраиваемые атрибуты.
>
> Это можно сделать, определения политики и назначения с помощью PowerShell, Azure AD Graph Explorer или Microsoft Graph. Если вы выполняете их в PowerShell, может потребоваться сначала использовать `New-AzureADPolicy` и назначьте его в приложение с помощью `Add-AzureADServicePrincipalPolicy`. Дополнительные сведения см. в разделе [назначение политики сопоставления утверждений](../develop/active-directory-claims-mapping.md#claims-mapping-policy-assignment).

Пример:
```powershell
$pol = New-AzureADPolicy -Definition @('{"ClaimsMappingPolicy":{"Version":1,"IncludeBasicClaimSet":"true", "ClaimsSchema": [{"Source":"user","ID":"employeeid","JwtClaimType":"employeeid"}]}}') -DisplayName "AdditionalClaims" -Type "ClaimsMappingPolicy"

Add-AzureADServicePrincipalPolicy -Id "<<The object Id of the Enterprise Application you published in the previous step, which requires this claim>>" -RefObjectId $pol.Id 
```

### <a name="enable-pingaccess-to-use-custom-claims-optional-but-required-if-you-expect-the-application-to-consume-additional-claims"></a>Включить PingAccess использовать настраиваемые утверждения (необязательно, но требуется, если предполагается, что приложению применять дополнительные утверждения)
При следующем шаге вы настроите PingAccess, веб-сеанс будет создан (доступа на "->" Параметры "->" веб-сеансами) должен иметь **запроса профиля** отменой выделения и **обновить атрибуты пользователя** значение **нет**

## <a name="download-pingaccess-and-configure-your-application"></a>Скачивание PingAccess и настройка приложения

Теперь, когда вы выполнили все этапы установки Azure Active Directory, можно перейти к настройке PingAccess.

Подробные инструкции по PingAccess частью данного сценария по-прежнему в документации по Ping Identity. Следуйте инструкциям в [Настройка PingAccess для Azure AD для защиты приложений, опубликованных с помощью прокси приложения Microsoft Azure AD](https://docs.pingidentity.com/bundle/paaad_m_ConfigurePAforMSAzureADSolution_paaad43/page/pa_c_PAAzureSolutionOverview.html) веб-сайте Ping Identity.

Эти действия помогут вам установить PingAccess и настроить учетную запись PingAccess (если у вас еще нет). Затем, чтобы создать подключение к Azure AD OpenID Connect (OIDC), нужно настроить поставщик маркеров с **каталог (клиент) идентификатор** значение, скопированное на портале Azure AD. Затем для создания веб-сеанса на PingAccess, используйте **идентификатор приложения (клиент)** и `PingAccess key` значения. После этого вы сможете настроить сопоставление удостоверений и создать виртуальный узел, сайт и приложение.

### <a name="test-your-application"></a>Тестирование приложения

После завершения этих шагов, ваше приложение должно быть приступить к работе. Чтобы протестировать его, откройте браузер и перейдите на внешний URL-адрес, созданный при публикации приложения в Azure. Вход с тестовой учетной записи, которое было назначено приложение.

## <a name="next-steps"></a>Дальнейшие действия

- [Настройка PingAccess для Azure AD для защиты приложений, опубликованных с помощью прокси приложения Microsoft Azure AD](https://docs.pingidentity.com/bundle/paaad_m_ConfigurePAforMSAzureADSolution_paaad43/page/pa_c_PAAzureSolutionOverview.html)
- [Единый вход в приложениях в Azure Active Directory](what-is-single-sign-on.md)
- [Устранение неполадок и сообщения об ошибках прокси приложения](application-proxy-troubleshoot.md)
