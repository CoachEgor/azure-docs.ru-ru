---
title: Использование ограничения клиентов для управления доступом к SaaS облачных приложений — Azure | Документация Майкрософт
description: Сведения об использовании ограничения клиентов для управления, какие пользователи могут обращаться к приложениям с учетом своего клиента Azure AD.
services: active-directory
documentationcenter: ''
author: CelesteDG
manager: mtillman
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 03/28/2019
ms.author: celested
ms.reviewer: richagi
ms.collection: M365-identity-device-management
ms.openlocfilehash: fa4eeb0a21525d636c7c1193c125d525774fa3fe
ms.sourcegitcommit: 44a85a2ed288f484cc3cdf71d9b51bc0be64cc33
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64707179"
---
# <a name="use-tenant-restrictions-to-manage-access-to-saas-cloud-applications"></a>Использовать ограничение клиентов для управления доступом к облачным приложениям SaaS

Крупные организации, уделяющие безопасности особое внимание, стремятся перейти в облачные службы, такие как Office 365, но им нужны гарантии, что их пользователи смогут получить доступ только к утвержденным ресурсам. В большинстве случаев для управления доступом компании ограничивают доменные имена или IP-адреса. Такой подход не работает в мире, где программное обеспечение как служба (или SaaS) приложения размещаются в общедоступном облаке, выполняющемся на общих доменных именах, таких как [outlook.office.com](https://outlook.office.com/) и [login.microsoftonline.com](https://login.microsoftonline.com/). Блокирование этих адресов полностью запретит пользователям интернет-доступ к Outlook, а не просто ограничит его в соответствии с утвержденными удостоверениями и ресурсами.

Решения Azure Active Directory (Azure AD) для этой задачи — это функция, называемая ограничением клиентов. С ограничением клиентов организации могут контролировать доступ к облачным приложениям SaaS, на основе клиента Azure AD, используемого приложениями для единого входа. Например, можно разрешить доступ к приложениям Office 365 в своей организации, но запретить доступ к экземплярам тех же приложений в других организациях.  

С ограничением клиентов организации могут указать список клиентов, к которым разрешен доступ к своим пользователям. После этого Azure AD только предоставляет доступ к этим разрешенным клиентам.

Эта статья посвящена ограничения клиентов для Office 365, но данный компонент должен работать с любым облачным приложением SaaS, использующим современные протоколы аутентификации с Azure AD для единого входа. При использовании приложений SaaS с клиентом Azure AD, отличным от клиента для Office 365, убедитесь, что все необходимые клиенты разрешены. Дополнительные сведения об облачных приложениях SaaS см. на сайте [Active Directory Marketplace](https://azure.microsoft.com/marketplace/active-directory/).

## <a name="how-it-works"></a>Принцип работы

В общих чертах решение состоит из следующих компонентов.

1. **Azure AD**. Если `Restrict-Access-To-Tenants: <permitted tenant list>` является отсутствует, поэтому Azure AD только выдает маркеры безопасности разрешенным клиентам.

2. **Инфраструктура прокси-сервера в локальной**: Эта инфраструктура — это устройство прокси-сервера, для проверки Secure Sockets Layer (SSL). Необходимо настроить прокси-сервер для вставки заголовка, содержащего список разрешенных клиентов в трафик, предназначенный для Azure AD.

3. **Клиентское программное обеспечение**: Для поддержки ограничения клиентов, клиентское программное обеспечение должно запрашивать маркеры непосредственно из Azure AD, таким образом, чтобы инфраструктуры прокси-сервера может перехватывать трафика. Браузерные приложения Office 365 в настоящее время поддержки ограничения клиентов, как и клиентах Office, использующие современную проверку подлинности (например, OAuth 2.0).

4. **Современная проверка подлинности**: Облачные службы должны использовать современную проверку подлинности, чтобы использовать ограничение клиентов и блокировать доступ для всех запрещенных клиентов. Необходимо настроить облачные службы Office 365, чтобы использовать современные протоколы проверки подлинности по умолчанию. Последние сведения о поддержке современной аутентификации в Office 365 доступны в статье [Updated Office 365 modern authentication](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/) (Обновление поддержи современной аутентификации в Office 365).

На следующей схеме показан общий маршрут прохождения трафика. Ограничение клиентов требуется проверка SSL только для трафика в Azure AD, а не к облачным службам Office 365. Это различие важно, так как объем трафика для проверки подлинности Azure AD обычно гораздо меньше, чем объем трафика к приложениям SaaS, например Exchange Online и SharePoint Online.

![Ограничения поток трафика клиента — схема](./media/tenant-restrictions/traffic-flow.png)

## <a name="set-up-tenant-restrictions"></a>Настройка ограничения клиентов

Существуют два шага, чтобы приступить к работе с ограничением клиентов. Во-первых убедитесь, что ваши клиенты могут подключаться к соответствующим адресам. Во-вторых Настройка инфраструктуры прокси-сервера.

### <a name="urls-and-ip-addresses"></a>URL-адреса и IP-адреса

Чтобы использовать ограничение клиентов, должен быть возможность подключиться к следующим Azure AD URL-адресам для проверки подлинности клиентов: [login.microsoftonline.com](https://login.microsoftonline.com/), [login.microsoft.com](https://login.microsoft.com/), и [ Login.Windows.NET](https://login.windows.net/). Кроме того, для доступа к Office 365, клиенты также должны быть видимы для подключения к полные доменные имена (FQDN), URL-адреса, и IP-адресам, определенным в [диапазоны адресов Office 365 URLs and IP](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2). 

### <a name="proxy-configuration-and-requirements"></a>Конфигурация и требования прокси-сервера

Для применения ограничения клиентов с помощью инфраструктуры прокси-сервера требуется следующая конфигурация. Данное руководство является универсальным, поэтому за определенными инструкциями по реализации следует обратиться к документации поставщика вашего прокси-сервера.

#### <a name="prerequisites"></a>Технические условия

- Прокси-сервер должен поддерживать перехват SSL, вставку заголовка HTTP и фильтрацию назначения с использованием полных доменных имен или URL-адресов.

- Клиенты должны доверять цепочке сертификатов, представляемой прокси-сервером для взаимодействия по протоколу SSL. Например если сертификаты из внутреннего [инфраструктуры открытых ключей (PKI)](/windows/desktop/seccertenroll/public-key-infrastructure) при использовании внутреннего выдающего корневой сертификат центра сертификации должен быть доверенным.

- Эта функция включена в подписках Office 365, но если вы хотите использовать ограничение клиентов для управления доступом к другим приложениям SaaS, затем лицензии Azure AD Premium 1 являются обязательными.

#### <a name="configuration"></a>Параметр Configuration

Для каждого входящего запроса к login.microsoftonline.com login.microsoft.com и login.windows.net следует вставлять два заголовка HTTP: *Restrict-Access-To-Tenants* и *Restrict-Access-Context*.

Эти заголовки должен содержать следующие элементы.

- Для *Restrict-Access-To-Tenants*, используйте значение \<разрешен список клиента\>, это разделенный запятыми список клиентов, которые вы хотите разрешить пользователям доступ к. Для идентификации клиента в этом списке может использоваться любой домен, зарегистрированный в клиенте. Например, чтобы разрешить доступ к клиентам Contoso и Fabrikam, используются пары "имя-значение" следующего вида: `Restrict-Access-To-Tenants: contoso.onmicrosoft.com,fabrikam.onmicrosoft.com`

- Для *Restrict-Access-Context*, используйте значение отдельного идентификатора каталога, объявление какой клиент устанавливает клиент ограничения. К примеру Чтобы объявить Contoso в качестве клиента, установить политику ограничения клиентов, пары "имя/значение" следующего вида: `Restrict-Access-Context: 456ff232-35l2-5h23-b3b3-3236w0826f3d`  

> [!TIP]
> Можно найти идентификатор каталога [портал Azure Active Directory](https://aad.portal.azure.com/). Войдите в качестве администратора, выберите **Azure Active Directory** слева, затем выберите **Свойства**.

Чтобы запретить пользователям вставлять собственный заголовок HTTP с помощью неутвержденных клиентов, прокси-сервер должен заменять *Restrict-Access-To-Tenants* заголовка, если он уже существует во входящем запросе.

Клиенты должны принудительно использовать прокси-сервер для всех запросов к login.microsoftonline.com, login.microsoft.com и login.windows.net. Например если PAC-файлы используются для направления клиентов на использование прокси-сервера, конечные пользователи не должны иметь возможность изменить или отключить эти файлы.

## <a name="the-user-experience"></a>Взаимодействие с пользователями

В этом разделе описывается работа для конечных пользователей и администраторов.

### <a name="end-user-experience"></a>Возможности для пользователей

Например, пользователь находится в сети компании Contoso, но пытается получить доступ к экземпляру Fabrikam такого общего приложения SaaS, как Outlook в Интернете. Если компания Fabrikam является разрешенным клиентом для экземпляра Contoso, пользователь видит сообщение Отказ доступа, который говорит, что вы пытаетесь получить доступ к ресурсу, который относится к неутвержденные ИТ-отделом организации.

### <a name="admin-experience"></a>Возможности для администраторов

Хотя Настройка ограничения клиентов выполняется в инфраструктуре корпоративных прокси-сервера, администраторы могут напрямую обращаться к отчеты ограничения клиента на портале Azure. Для просмотра отчетов:

1. Войдите в [портал Azure Active Directory](https://aad.portal.azure.com/). **Центр администрирования Azure Active Directory** появится панель мониторинга.

2. В области слева выберите **Azure Active Directory**. Откроется окно Обзор Azure Active Directory.

3. В **другие возможности** щелкните **клиента ограничения**.

Администратор для клиента, указанные в виде клиента Restricted-Access-Context этот отчет можно использовать для просмотра попытки входа, заблокированные из-за ограничений политики клиента, включая использованное удостоверение и целевой каталог идентификатор. Входы отображаются, если на клиенте установлено соответствующее ограничение для клиента пользователя или ресурса.

Как и в других отчетах на портале Azure, можно использовать фильтры, чтобы задать определенную область. Можно фильтровать на заданный интервал времени, пользователя, приложение, клиент или состояния. При выборе **столбцы** кнопку, вы можете отображать данные с любым сочетанием следующих полей:

- **User**
- **Приложения**
- **Состояние**
- **Дата**
- **Дата (UTC)** (где UTC — время)
- **Способ многофакторной Идентификации** (метод многофакторной проверки подлинности)
- **Сведения о многофакторной проверки Подлинности** (многофакторная проверка подлинности деталей)
- **Результат многофакторной проверки Подлинности**
- **IP-адрес**
- **Клиент**
- **Имя пользователя**
- **Местоположение.**
- **ИД целевого клиента**

## <a name="office-365-support"></a>Поддержка Office 365

Приложения Office 365 должны соответствовать двум условиям для полной поддержки ограничения клиентов:

1. Используемый клиент должен поддерживать современную проверку подлинности.
2. Современная аутентификация должна использоваться по умолчанию для облачной службы.

Ознакомьтесь со статьей [Updated Office 365 modern authentication](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/) (Обновление поддержи современной аутентификации в Office 365), чтобы получить последние сведения о том, какие клиенты Office сейчас поддерживают современную аутентификацию. На этой странице также указаны ссылки на инструкции по включению современной аутентификации для конкретных клиентов Exchange Online и Skype для бизнеса Online. SharePoint Online уже включает современную проверку подлинности по умолчанию.

Браузерные приложения Office 365 (портал Office, Yammer, сайты SharePoint, Outlook в Интернете и многое другое) в настоящее время поддержки ограничения клиентов. «Толстые» клиенты (Outlook, Скайп для бизнеса, Word, Excel, PowerPoint и многое другое) можно принудительно задать ограничение клиентов только в том случае, при использовании современной проверки подлинности.  

Outlook и Скайп для бизнес-клиентами, которые поддерживают современную проверку подлинности по-прежнему могут использовать устаревшие протоколы для клиентов, не поддерживающих современную аутентификацию, эффективно обходя политику ограничения клиентов. Ограничение клиентов может блокировать приложения, использующие устаревшие протоколы, если они к login.microsoftonline.com, login.microsoft.com или login.windows.net во время проверки подлинности.

Для Outlook в Windows клиенты могут добавить ограничения, запрещающие пользователям добавлять неутвержденые учетные записи почты в свои профили. Вы можете ознакомиться с примером настройки групповой политики, который [запрещает добавление нестандартных учетных записей Exchange](https://gpsearch.azurewebsites.net/default.aspx?ref=1).

## <a name="testing"></a>Тестирование

Если вы хотите испытать ограничения клиентов перед ее внедрением во всей организации, у вас есть два варианта: подход на основе узла с помощью такого средства, как Fiddler, или поэтапное развертывание параметров прокси-сервера.

### <a name="fiddler-for-a-host-based-approach"></a>Использование Fiddler для подхода на основе узлов

Fiddler — бесплатный прокси-сервер веб-отладки, который может использоваться для записи и изменения трафика HTTP и HTTPS, включая вставку заголовков HTTP. Чтобы настроить Fiddler для проверки ограничения клиентов, выполните следующие действия:

1. [Скачайте и установите Fiddler](https://www.telerik.com/fiddler).

2. Настройте Fiddler для расшифровки трафика HTTPS, как описано в [справочной документации Fiddler](https://docs.telerik.com/fiddler/Configure-Fiddler/Tasks/DecryptHTTPS).

3. Настройте Fiddler для вставки заголовков *Restrict-Access-To-Tenants* и *Restrict-Access-Context* с помощью настраиваемых правил.

   1. В инструменте Fiddler Web Debugger выберите меню **Rules** (Правила) и щелкните **Customize Rules…** (Настройка правил…), чтобы открыть файл CustomRules.

   2. Добавьте следующие строки в начале `OnBeforeRequest` функции. Замените \<домен клиента\> с домен, зарегистрированный в клиенте (например, `contoso.onmicrosoft.com`). Замените \<directory ID\> идентификатором GUID Azure AD своего клиента.

      ```JScript.NET
      if (
          oSession.HostnameIs("login.microsoftonline.com") ||
          oSession.HostnameIs("login.microsoft.com") ||
          oSession.HostnameIs("login.windows.net")
      )
      {
          oSession.oRequest["Restrict-Access-To-Tenants"] = "<tenant domain>";
          oSession.oRequest["Restrict-Access-Context"] = "<directory ID>";
      }
      ```

      Если необходимо разрешить несколько клиентов, используйте запятые для разделения их имен. Например: 

      `oSession.oRequest["Restrict-Access-To-Tenants"] = "contoso.onmicrosoft.com,fabrikam.onmicrosoft.com";`

4. Сохраните и закройте файл CustomRules.

После настройки Fiddler можно начать записывать трафик, перейдя в меню **File** (Файл) и выбрав **Capture Traffic** (Запись трафика).

### <a name="staged-rollout-of-proxy-settings"></a>Поэтапное развертывание параметров прокси-сервера

В зависимости от возможностей инфраструктуры прокси-сервера можно выполнить поэтапное развертывание параметров для пользователей. Ниже приведено несколько общих способов, которые вы можете рассмотреть.

1. Используйте PAC-файлы, чтобы направить тестовых пользователей в тестовую инфраструктуру прокси-сервера, а обычные пользователи пусть продолжат использовать рабочую инфраструктуру прокси-сервера.
2. Некоторые прокси-серверы могут поддерживать различные конфигурации с использованием групп.

Конкретные сведения обратитесь к документации сервера прокси-сервера.

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь со статьей [Updated Office 365 modern authentication](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/) (Обновление поддержи современной аутентификации в Office 365).
- Прочтите статью [URL-адреса и диапазоны IP-адресов Office 365](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2).
