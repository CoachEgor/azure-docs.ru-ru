---
title: Используйте ограничения для клиентов для управления доступом к приложениям SaaS - Azure AD
description: Как использовать ограничения для управления пользователями приложений на основе их арендатора Azure AD.
services: active-directory
documentationcenter: ''
author: msmimart
manager: CelesteDG
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 03/28/2019
ms.author: mimart
ms.reviewer: richagi
ms.collection: M365-identity-device-management
ms.openlocfilehash: ecd49b340810f92727f0fc98f84031c8cbf68179
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79481183"
---
# <a name="use-tenant-restrictions-to-manage-access-to-saas-cloud-applications"></a>Используйте ограничения для клиентов для управления доступом к облачным приложениям SaaS

Крупные организации, уделяющие безопасности особое внимание, стремятся перейти в облачные службы, такие как Office 365, но им нужны гарантии, что их пользователи смогут получить доступ только к утвержденным ресурсам. В большинстве случаев для управления доступом компании ограничивают доменные имена или IP-адреса. Этот подход не удается в мире, где программное обеспечение как сервис (или SaaS) приложения размещаются в общедоступном облаке, работает на общих доменных имен, таких как [outlook.office.com](https://outlook.office.com/) и [login.microsoftonline.com](https://login.microsoftonline.com/). Блокирование этих адресов полностью запретит пользователям интернет-доступ к Outlook, а не просто ограничит его в соответствии с утвержденными удостоверениями и ресурсами.

Решение azure Active Directory (Azure AD) для решения этой задачи — это функция, называемая ограничениями для арендаторов. С ограничениями для арендаторов организации могут контролировать доступ к облачным приложениям SaaS, на основе того, как арендатор Azure AD использует приложения для одного входного. Например, можно разрешить доступ к приложениям Office 365 в своей организации, но запретить доступ к экземплярам тех же приложений в других организациях.  

С ограничениями для арендаторов организации могут указать список арендаторов, к которым разрешен доступ их пользователям. После этого Azure AD только предоставляет доступ к этим разрешенным клиентам.

В этой статье основное внимание уделяется ограничениям для клиентов Office 365, но функция должна работать с любым облачным приложением SaaS, которое использует современные протоколы аутентификации с Azure AD для одного входного. При использовании приложений SaaS с клиентом Azure AD, отличным от клиента для Office 365, убедитесь, что все необходимые клиенты разрешены. Дополнительные сведения об облачных приложениях SaaS см. на сайте [Active Directory Marketplace](https://azure.microsoft.com/marketplace/active-directory/).

## <a name="how-it-works"></a>Принцип работы

В общих чертах решение состоит из следующих компонентов.

1. **Azure AD**: `Restrict-Access-To-Tenants: <permitted tenant list>` Если он присутствует, Azure AD выпускает только маркеры безопасности для разрешенных клиентов.

2. **Инфраструктура прокси-серверов:** Эта инфраструктура представляет собой прокси-устройство, способное инспекции Безопасности транспортного слоя (TLS). Необходимо настроить прокси-сервер, чтобы вставить заголовок, содержащий список разрешенных арендаторов, в трафик, предназначенный для Azure AD.

3. **Программное обеспечение клиента:** Для поддержки ограничений арендаторов клиентское программное обеспечение должно запрашивать токены непосредственно из Azure AD, чтобы инфраструктура прокси-сервера мог перехватывать трафик. Браузер на основе Office 365 приложений в настоящее время поддерживают ограничения арендаторов, как и клиенты Office, которые используют современную аутентификацию (например, OAuth 2.0).

4. **Современная аутентификация**: Облачные службы должны использовать современную аутентификацию для использования ограничений арендаторов и блокировать доступ ко всем неразрешенным арендаторам. Необходимо настроить облачные службы Office 365 для использования современных протоколов аутентификации по умолчанию. Последние сведения о поддержке современной аутентификации в Office 365 доступны в статье [Updated Office 365 modern authentication](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/) (Обновление поддержи современной аутентификации в Office 365).

На следующей схеме показан общий маршрут прохождения трафика. Ограничения для арендаторов требуют проверки TLS только на трафик в Azure AD, а не в облачные службы Office 365. Это различие важно, поскольку объем трафика для проверки подлинности в Azure AD, как правило, значительно ниже, чем объем трафика для приложений SaaS, таких как Exchange Online и SharePoint Online.

![Арендатор ограничения транспортного потока - диаграмма](./media/tenant-restrictions/traffic-flow.png)

## <a name="set-up-tenant-restrictions"></a>Настройка ограничений для арендаторов

Есть два шага, чтобы начать работу с арендатором ограничений. Во-первых, убедитесь, что ваши клиенты могут подключиться к нужным адресам. Во-вторых, настроить инфраструктуру прокси.

### <a name="urls-and-ip-addresses"></a>URL-адреса и IP-адреса

Чтобы использовать ограничения для клиентов, ваши клиенты должны иметь возможность подключения к следующим URL-адресам Azure AD для проверки подлинности: [login.microsoftonline.com,](https://login.microsoftonline.com/) [login.microsoft.com](https://login.microsoft.com/)и [login.windows.net.](https://login.windows.net/) Кроме того, чтобы получить доступ к Office 365, ваши клиенты должны также иметь возможность подключиться к полностью квалифицированным доменным именам (ФЗН), URL-адресам и IP-адресам, определенным в [диапазонах URL-адресов Office 365 и IP-адресов.](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2) 

### <a name="proxy-configuration-and-requirements"></a>Конфигурация и требования прокси-сервера

Для включения ограничений для арендатора через инфраструктуру прокси требуется следующая конфигурация. Данное руководство является универсальным, поэтому за определенными инструкциями по реализации следует обратиться к документации поставщика вашего прокси-сервера.

#### <a name="prerequisites"></a>Предварительные требования

- Прокси должен быть в состоянии выполнять перехват TLS, вставку заголовка HTTP и фильтровать назначения с помощью F-DNs/URLs.

- Клиенты должны доверять цепочке сертификатов, представленной прокси для сообщений TLS. Например, если используются сертификаты из внутренней [инфраструктуры ключей общего пользования (PKI),](/windows/desktop/seccertenroll/public-key-infrastructure) необходимо доверять внутреннему сертификату о выдаче корневого сертификата.

- Эта функция включена в подписку Office 365, но если вы хотите использовать ограничения для клиента для контроля доступа к другим приложениям SaaS, то требуются лицензии Azure AD Premium 1.

#### <a name="configuration"></a>Параметр Configuration

Для каждого входящего запроса к login.microsoftonline.com login.microsoft.com и login.windows.net следует вставлять два заголовка HTTP: *Restrict-Access-To-Tenants* и *Restrict-Access-Context*.

Эти заголовки должен содержать следующие элементы.

- Для *ограниченного доступа к арендаторам*используйте значение разрешенного \<списка\>арендаторов, который представляет собой разделенный запятой список арендаторов, к которым вы хотите предоставить пользователям доступ. Для идентификации клиента в этом списке может использоваться любой домен, зарегистрированный в клиенте. Например, чтобы разрешить доступ к клиентам Contoso и Fabrikam, используются пары "имя-значение" следующего вида: `Restrict-Access-To-Tenants: contoso.onmicrosoft.com,fabrikam.onmicrosoft.com`

- Для *ограниченного доступа-контекста*используйте значение единого идентификатора каталога, объявляя, какой арендатор устанавливает ограничения для арендатора. Например, чтобы объявить Contoso в качестве арендатора, который устанавливает политику ограничений арендатора, пара имен/значений выглядит следующим образом: `Restrict-Access-Context: 456ff232-35l2-5h23-b3b3-3236w0826f3d`  

> [!TIP]
> Идентификатор каталога можно найти на [портале Active Directory Azure.](https://aad.portal.azure.com/) Войдите в качестве администратора, выберите **Azure Active Directory** слева, затем выберите **Свойства**.

Чтобы предотвратить включение пользователями собственного заголовка HTTP с неутвержденными арендаторами, прокси необходимо заменить заголовок *«Ограничитель-доступ к арендаторам»,* если он уже присутствует в входящий запрос.

Клиенты должны принудительно использовать прокси-сервер для всех запросов к login.microsoftonline.com, login.microsoft.com и login.windows.net. Например, если файлы PAC используются для направления клиентов на использование прокси-сервера, конечные пользователи не должны иметь возможность отсеивать или отсутсвить файлы PAC.

## <a name="the-user-experience"></a>Взаимодействие с пользователями

В этом разделе описывается опыт как для конечных пользователей, так и для админ- и уапов.

### <a name="end-user-experience"></a>Возможности для пользователей

Например, пользователь находится в сети компании Contoso, но пытается получить доступ к экземпляру Fabrikam такого общего приложения SaaS, как Outlook в Интернете. Если Fabrikam является неразрешенным арендатором для экземпляра Contoso, пользователь видит сообщение об отказе в доступе, в котором говорится, что вы пытаетесь получить доступ к ресурсу, который принадлежит организации, не одобренной вашим ИТ-отделом.

### <a name="admin-experience"></a>Возможности для администраторов

В то время как конфигурация ограничений для клиентов выполняется на корпоративной инфраструктуре прокси, админы могут получить доступ к отчетам об ограничениях на емле на портале Azure напрямую. Для просмотра отчетов:

1. Вопием на [портале Active Directory Azure](https://aad.portal.azure.com/). Отображается **панель мониторинга центра azure Active Directory.**

2. В области слева выберите **Azure Active Directory**. Отображается страница обзора active Directory Azure.

3. В заголовке **«Другие возможности»** выберите **ограничения арендатора.**

Админ для арендатора, указанного в качестве арендатора с ограниченным доступом и контекста, может использовать этот отчет, чтобы увидеть блокировки входов из-за политики ограничений арендатора, включая идентификатор и идентификатор целевого каталога. Входы отображаются, если на клиенте установлено соответствующее ограничение для клиента пользователя или ресурса.

> [!NOTE]
> Отчет может содержать ограниченную информацию, например идентификатор целевого каталога, когда в входящий пользователь, не являйся арендатором ограниченного доступа и контекста. В этом случае идентифицируемая пользователем информация, например имя и имя пользователя, маскируется для защиты пользовательских данных других арендаторов.

Как и в других отчетах на портале Azure, можно использовать фильтры, чтобы задать определенную область. Вы можете фильтровать на определенном интервале времени, пользователь, приложение, клиент, или статус. Если вы выберете кнопку **Колонки,** вы можете отобразить данные с любой комбинацией следующих полей:

- **Пользователь**
- **Приложение**
- **Состояние**
- **Дата**
- **Дата (UTC)** (где UTC координируется по универсальному времени)
- **Метод MFA Auth** (метод многофакторной аутентификации)
- **МидА Аут Деталь** (многофакторная деталь аутентификации)
- **МИД Результат**
- **IP-адрес**;
- **Клиент**
- **Пользователя**
- **Расположение**
- **Идентификатор целевого клиента**

## <a name="office-365-support"></a>Поддержка Office 365

Заявки Office 365 должны соответствовать двум критериям для полной поддержки ограничений арендаторов:

1. Используемый клиент поддерживает современную аутентификацию.
2. Современная аутентификация должна использоваться по умолчанию для облачной службы.

Ознакомьтесь со статьей [Updated Office 365 modern authentication](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/) (Обновление поддержи современной аутентификации в Office 365), чтобы получить последние сведения о том, какие клиенты Office сейчас поддерживают современную аутентификацию. На этой странице также указаны ссылки на инструкции по включению современной аутентификации для конкретных клиентов Exchange Online и Skype для бизнеса Online. SharePoint Online уже позволяет современную аутентификацию по умолчанию.

Office 365 браузерных приложений (Офисный портал, Yammer, сайты SharePoint, Outlook в Интернете и многое другое) в настоящее время поддерживают ограничения арендаторов. Толстые клиенты (Outlook, Skype для бизнеса, Word, Excel, PowerPoint и многое другое) могут применять ограничения клиентов только при использовании современной аутентификации.  

Outlook и Skype для бизнес-клиентов, поддерживающих современную аутентификацию, могут по-прежнему использовать устаревшие протоколы против арендаторов, где современная аутентификация не включена, фактически минуя ограничения арендаторов. Ограничения для арендаторов могут блокировать приложения, которые используют устаревшие протоколы, если они связываются с login.microsoftonline.com, login.microsoft.com или login.windows.net во время проверки подлинности.

Для Outlook в Windows клиенты могут добавить ограничения, запрещающие пользователям добавлять неутвержденые учетные записи почты в свои профили. Вы можете ознакомиться с примером настройки групповой политики, который [запрещает добавление нестандартных учетных записей Exchange](https://gpsearch.azurewebsites.net/default.aspx?ref=1).

## <a name="testing"></a>Тестирование

Если вы хотите опробовать ограничения арендаторов перед реализацией для всей организации, у вас есть два варианта: подход на основе хоста с использованием такого инструмента, как Fiddler, или поэтапное развертывание параметров прокси.

### <a name="fiddler-for-a-host-based-approach"></a>Использование Fiddler для подхода на основе узлов

Fiddler — бесплатный прокси-сервер веб-отладки, который может использоваться для записи и изменения трафика HTTP и HTTPS, включая вставку заголовков HTTP. Для настройки Fiddler для тестирования ограничений арендатора выполните следующие действия:

1. [Скачайте и установите Fiddler](https://www.telerik.com/fiddler).

2. Настройте Fiddler для расшифровки трафика HTTPS, как описано в [справочной документации Fiddler](https://docs.telerik.com/fiddler/Configure-Fiddler/Tasks/DecryptHTTPS).

3. Настройте Fiddler для вставки заголовков *Restrict-Access-To-Tenants* и *Restrict-Access-Context* с помощью настраиваемых правил.

   1. В инструменте Fiddler Web Debugger выберите меню **Rules** (Правила) и щелкните **Customize Rules…** (Настройка правил…), чтобы открыть файл CustomRules.

   2. Добавьте следующие строки `OnBeforeRequest` в начале функции. Замените \<\> домен арендатора доменом домен, зарегистрированный на вашего арендатора (например, `contoso.onmicrosoft.com`). Замените \<directory ID\> идентификатором GUID Azure AD своего клиента.

      ```JScript.NET
      if (
          oSession.HostnameIs("login.microsoftonline.com") ||
          oSession.HostnameIs("login.microsoft.com") ||
          oSession.HostnameIs("login.windows.net")
      )
      {
          oSession.oRequest["Restrict-Access-To-Tenants"] = "<tenant domain>";
          oSession.oRequest["Restrict-Access-Context"] = "<directory ID>";
      }
      ```

      Если необходимо разрешить несколько клиентов, используйте запятые для разделения их имен. Пример:

      `oSession.oRequest["Restrict-Access-To-Tenants"] = "contoso.onmicrosoft.com,fabrikam.onmicrosoft.com";`

4. Сохраните и закройте файл CustomRules.

После настройки Fiddler можно начать записывать трафик, перейдя в меню **File** (Файл) и выбрав **Capture Traffic** (Запись трафика).

### <a name="staged-rollout-of-proxy-settings"></a>Поэтапное развертывание параметров прокси-сервера

В зависимости от возможностей инфраструктуры прокси-сервера можно выполнить поэтапное развертывание параметров для пользователей. Ниже приведено несколько общих способов, которые вы можете рассмотреть.

1. Используйте PAC-файлы, чтобы направить тестовых пользователей в тестовую инфраструктуру прокси-сервера, а обычные пользователи пусть продолжат использовать рабочую инфраструктуру прокси-сервера.
2. Некоторые прокси-серверы могут поддерживать различные конфигурации с использованием групп.

Для получения более подробной информации обратитесь к вашей документации прокси-сервера.

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь со статьей [Updated Office 365 modern authentication](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/) (Обновление поддержи современной аутентификации в Office 365).
- Прочтите статью [URL-адреса и диапазоны IP-адресов Office 365](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2).
