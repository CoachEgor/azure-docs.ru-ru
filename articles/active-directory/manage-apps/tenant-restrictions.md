---
title: Использование ограничений клиента для управления доступом к приложениям SaaS в Azure AD
description: Использование ограничений клиентов для управления доступом пользователей к приложениям на основе клиента Azure AD.
services: active-directory
documentationcenter: ''
author: msmimart
manager: CelesteDG
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 03/28/2019
ms.author: mimart
ms.reviewer: richagi
ms.collection: M365-identity-device-management
ms.openlocfilehash: 64f73dd8dbef3f08cd4ea5841e4ec21bac2f55bf
ms.sourcegitcommit: 653e9f61b24940561061bd65b2486e232e41ead4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/21/2019
ms.locfileid: "74276503"
---
# <a name="use-tenant-restrictions-to-manage-access-to-saas-cloud-applications"></a>Использование ограничений клиента для управления доступом к облачным приложениям SaaS

Крупные организации, уделяющие безопасности особое внимание, стремятся перейти в облачные службы, такие как Office 365, но им нужны гарантии, что их пользователи смогут получить доступ только к утвержденным ресурсам. В большинстве случаев для управления доступом компании ограничивают доменные имена или IP-адреса. Этот подход завершается неудачей в мире, где приложения программного обеспечения как услуга (или SaaS) размещаются в общедоступном облаке, с использованием общих доменных имен, таких как [Outlook.Office.com](https://outlook.office.com/) и [Login.microsoftonline.com](https://login.microsoftonline.com/). Блокирование этих адресов полностью запретит пользователям интернет-доступ к Outlook, а не просто ограничит его в соответствии с утвержденными удостоверениями и ресурсами.

Решение Azure Active Directory (Azure AD) для этой задачи — это функция, называемая ограничениями клиента. Благодаря ограничениям клиентов организации могут управлять доступом к облачным приложениям SaaS на основе клиента Azure AD, используемого приложениями для единого входа. Например, можно разрешить доступ к приложениям Office 365 в своей организации, но запретить доступ к экземплярам тех же приложений в других организациях.  

С помощью ограничений клиента организации могут указать список клиентов, к которым разрешен доступ пользователям. После этого Azure AD только предоставляет доступ к этим разрешенным клиентам.

В этой статье рассматриваются ограничения клиента для Office 365, но эта функция должна работать с любым облачным приложением SaaS, которое использует современные протоколы проверки подлинности с Azure AD для единого входа. При использовании приложений SaaS с клиентом Azure AD, отличным от клиента для Office 365, убедитесь, что все необходимые клиенты разрешены. Дополнительные сведения об облачных приложениях SaaS см. на сайте [Active Directory Marketplace](https://azure.microsoft.com/marketplace/active-directory/).

## <a name="how-it-works"></a>Принцип работы

В общих чертах решение состоит из следующих компонентов.

1. **Azure AD**. если имеется `Restrict-Access-To-Tenants: <permitted tenant list>`, Azure AD выдает только маркеры безопасности для разрешенных клиентов.

2. **Локальная инфраструктура прокси-сервера**. Эта инфраструктура является прокси-устройством, поддерживающим проверку SSL (SSL). Необходимо настроить прокси-сервер для вставки заголовка, содержащего список разрешенных клиентов, в трафик, предназначенный для Azure AD.

3. **Клиентское программное обеспечение**. для поддержки ограничений клиентов клиентское программное обеспечение должно запрашивать маркеры непосредственно из Azure AD, чтобы инфраструктура прокси могла перехватывать трафик. Приложения Office 365 на основе браузера в настоящее время поддерживают ограничения клиентов, так же как и клиенты Office, использующие современную проверку подлинности (например, OAuth 2,0).

4. **Современная проверка подлинности**. облачные службы должны использовать современные проверки подлинности для использования ограничений клиентов и блокировать доступ ко всем неразрешенным клиентам. Необходимо настроить облачные службы Office 365 для использования современных протоколов проверки подлинности по умолчанию. Последние сведения о поддержке современной аутентификации в Office 365 доступны в статье [Updated Office 365 modern authentication](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/) (Обновление поддержи современной аутентификации в Office 365).

На следующей схеме показан общий маршрут прохождения трафика. Ограничения клиента требуют проверки SSL только для трафика в Azure AD, а не для облачных служб Office 365. Это различие важно, так как объем трафика для проверки подлинности в Azure AD обычно намного ниже, чем объем трафика для приложений SaaS, таких как Exchange Online и SharePoint Online.

![Схема потока трафика ограничений клиента](./media/tenant-restrictions/traffic-flow.png)

## <a name="set-up-tenant-restrictions"></a>Настройка ограничений клиента

Существует два шага для начала работы с ограничениями клиентов. Сначала убедитесь, что клиенты могут подключаться к нужным адресам. Во-вторых, настройте инфраструктуру прокси.

### <a name="urls-and-ip-addresses"></a>URL-адреса и IP-адреса

Чтобы использовать ограничения клиента, клиенты должны иметь возможность подключения к следующим URL-адресам Azure AD для проверки подлинности: [Login.microsoftonline.com](https://login.microsoftonline.com/), [Login.Microsoft.com](https://login.microsoft.com/)и [Login.Windows.NET](https://login.windows.net/). Кроме того, для доступа к Office 365 Клиенты должны иметь возможность подключения к полным доменным именам (FQDN), URL-адресам и IP-адресам, определенным в [URL-адресах и диапазонах IP-адресов office 365](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2). 

### <a name="proxy-configuration-and-requirements"></a>Конфигурация и требования прокси-сервера

Для включения ограничений клиентов с помощью инфраструктуры прокси-сервера требуется следующая конфигурация. Данное руководство является универсальным, поэтому за определенными инструкциями по реализации следует обратиться к документации поставщика вашего прокси-сервера.

#### <a name="prerequisites"></a>предварительным требованиям

- Прокси-сервер должен поддерживать перехват SSL, вставку заголовка HTTP и фильтрацию назначения с использованием полных доменных имен или URL-адресов.

- Клиенты должны доверять цепочке сертификатов, представляемой прокси-сервером для взаимодействия по протоколу SSL. Например, если используются сертификаты из внутренней [инфраструктуры открытых ключей (PKI)](/windows/desktop/seccertenroll/public-key-infrastructure) , внутренний выдающий сертификат корневого центра сертификации должен быть доверенным.

- Эта функция включена в подписки Office 365, но если вы хотите использовать ограничения клиентов для управления доступом к другим приложениям SaaS, необходимо Azure AD Premium 1 лицензий.

#### <a name="configuration"></a>Параметр Configuration

Для каждого входящего запроса к login.microsoftonline.com login.microsoft.com и login.windows.net следует вставлять два заголовка HTTP: *Restrict-Access-To-Tenants* и *Restrict-Access-Context*.

Эти заголовки должен содержать следующие элементы.

- Для *ограничений "доступ к клиентам*" используйте значение \<разрешенный список клиентов\>, который представляет собой список клиентов с разделителями-запятыми, к которым необходимо разрешить доступ пользователям. Для идентификации клиента в этом списке может использоваться любой домен, зарегистрированный в клиенте. Например, чтобы разрешить доступ к клиентам Contoso и Fabrikam, используются пары "имя-значение" следующего вида: `Restrict-Access-To-Tenants: contoso.onmicrosoft.com,fabrikam.onmicrosoft.com`

- Для *restrict-Access-context*используйте значение одного идентификатора каталога, объявляя, какой клиент устанавливает ограничения клиента. Например, чтобы объявить Contoso в качестве клиента, который задает политику ограничений клиента, пара "имя-значение" выглядит следующим образом: `Restrict-Access-Context: 456ff232-35l2-5h23-b3b3-3236w0826f3d`  

> [!TIP]
> Идентификатор каталога можно найти на [портале Azure Active Directory](https://aad.portal.azure.com/). Войдите в качестве администратора, выберите **Azure Active Directory** слева, затем выберите **Свойства**.

Чтобы пользователи не могли вставлять собственный заголовок HTTP с неодобренными клиентами, прокси-сервер должен заменить заголовок *restrict-Access-to-клиента* , если он уже существует во входящем запросе.

Клиенты должны принудительно использовать прокси-сервер для всех запросов к login.microsoftonline.com, login.microsoft.com и login.windows.net. Например, если файлы PAC используются для направления клиентов на использование прокси-сервера, конечные пользователи не должны иметь возможности изменять или отключать файлы PAC.

## <a name="the-user-experience"></a>Взаимодействие с пользователями

В этом разделе описывается взаимодействие для конечных пользователей и администраторов.

### <a name="end-user-experience"></a>Возможности для пользователей

Например, пользователь находится в сети компании Contoso, но пытается получить доступ к экземпляру Fabrikam такого общего приложения SaaS, как Outlook в Интернете. Если Fabrikam является неразрешенным клиентом для экземпляра Contoso, он видит сообщение о том, что вы пытаетесь получить доступ к ресурсу, который принадлежит Организации, не утвержденной ИТ-отделом.

### <a name="admin-experience"></a>Возможности для администраторов

Хотя настройка ограничений клиента выполняется в корпоративной инфраструктуре прокси, администраторы могут получить доступ к отчетам об ограничениях клиентов в портал Azure напрямую. Для просмотра отчетов выполните следующие действия.

1. Войдите на [портал Azure Active Directory](https://aad.portal.azure.com/). Откроется панель мониторинга **центра администрирования Azure Active Directory** .

2. В области слева выберите **Azure Active Directory**. Откроется страница Обзор Azure Active Directory.

3. В заголовке **другие возможности** выберите **ограничения клиента**.

Администратор клиента, указанный в качестве клиента с ограниченным доступом к контексту доступа, может использовать этот отчет для просмотра заблокированных входов из-за политики ограничений клиента, включая использованное удостоверение и идентификатор целевого каталога. Входы отображаются, если на клиенте установлено соответствующее ограничение для клиента пользователя или ресурса.

Как и в других отчетах на портале Azure, можно использовать фильтры, чтобы задать определенную область. Можно выполнить фильтрацию по определенному интервалу времени, пользователю, приложению, клиенту или состоянию. При нажатии кнопки **столбцы** можно выбрать отображение данных с любым сочетанием следующих полей:

- **User**
- **Приложения**
- **Состояние**
- **Дата**
- **Дата (UTC)** (где UTC — координированное время по Гринвичу)
- **Метод MFA auth** (метод многофакторной проверки подлинности)
- **Сведения о** проверке подлинности MFA (сведения о многофакторной идентификации)
- **Результат MFA**
- **IP-адрес**
- **Клиент**
- **Имя пользователя**
- **Местоположение.**
- **Идентификатор целевого клиента**

## <a name="office-365-support"></a>Поддержка Office 365

Приложения Office 365 должны отвечать двум критериям, чтобы полностью поддерживать ограничения клиентов:

1. Используемый клиент поддерживает современную проверку подлинности.
2. Современная аутентификация должна использоваться по умолчанию для облачной службы.

Ознакомьтесь со статьей [Updated Office 365 modern authentication](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/) (Обновление поддержи современной аутентификации в Office 365), чтобы получить последние сведения о том, какие клиенты Office сейчас поддерживают современную аутентификацию. На этой странице также указаны ссылки на инструкции по включению современной аутентификации для конкретных клиентов Exchange Online и Skype для бизнеса Online. SharePoint Online уже включает современную проверку подлинности по умолчанию.

Приложения на основе браузера Office 365 (портал Office, Yammer, сайты SharePoint, Outlook в Интернете и др.) в настоящее время поддерживают ограничения клиентов. Толстые клиенты (Outlook, Skype для бизнеса, Word, Excel, PowerPoint и др.) могут применять ограничения клиента только при использовании современной проверки подлинности.  

Клиенты Outlook и Skype для бизнеса, поддерживающие современные проверки подлинности, могут по-прежнему иметь возможность использовать устаревшие протоколы для клиентов, где не включена современная проверка подлинности, что позволяет обходить ограничения клиента. Ограничения клиента могут блокировать приложения, использующие устаревшие протоколы, если они взаимодействуют с login.microsoftonline.com, login.microsoft.com или login.windows.net во время проверки подлинности.

Для Outlook в Windows клиенты могут добавить ограничения, запрещающие пользователям добавлять неутвержденые учетные записи почты в свои профили. Вы можете ознакомиться с примером настройки групповой политики, который [запрещает добавление нестандартных учетных записей Exchange](https://gpsearch.azurewebsites.net/default.aspx?ref=1).

## <a name="testing"></a>Тестирование

Если вы хотите испытать ограничения клиента, прежде чем внедрять его для всей Организации, у вас есть два варианта: подход на основе узла с помощью такого средства, как Fiddler, или промежуточное развертывание параметров прокси-сервера.

### <a name="fiddler-for-a-host-based-approach"></a>Использование Fiddler для подхода на основе узлов

Fiddler — бесплатный прокси-сервер веб-отладки, который может использоваться для записи и изменения трафика HTTP и HTTPS, включая вставку заголовков HTTP. Чтобы настроить Fiddler для проверки ограничений клиента, выполните следующие действия.

1. [Скачайте и установите Fiddler](https://www.telerik.com/fiddler).

2. Настройте Fiddler для расшифровки трафика HTTPS, как описано в [справочной документации Fiddler](https://docs.telerik.com/fiddler/Configure-Fiddler/Tasks/DecryptHTTPS).

3. Настройте Fiddler для вставки заголовков *Restrict-Access-To-Tenants* и *Restrict-Access-Context* с помощью настраиваемых правил.

   1. В инструменте Fiddler Web Debugger выберите меню **Rules** (Правила) и щелкните **Customize Rules…** (Настройка правил…), чтобы открыть файл CustomRules.

   2. Добавьте следующие строки в начало функции `OnBeforeRequest`. Замените домен клиента \<\> доменом, зарегистрированным в клиенте (например, `contoso.onmicrosoft.com`). Замените \<directory ID\> идентификатором GUID Azure AD своего клиента.

      ```JScript.NET
      if (
          oSession.HostnameIs("login.microsoftonline.com") ||
          oSession.HostnameIs("login.microsoft.com") ||
          oSession.HostnameIs("login.windows.net")
      )
      {
          oSession.oRequest["Restrict-Access-To-Tenants"] = "<tenant domain>";
          oSession.oRequest["Restrict-Access-Context"] = "<directory ID>";
      }
      ```

      Если необходимо разрешить несколько клиентов, используйте запятые для разделения их имен. Например,

      `oSession.oRequest["Restrict-Access-To-Tenants"] = "contoso.onmicrosoft.com,fabrikam.onmicrosoft.com";`

4. Сохраните и закройте файл CustomRules.

После настройки Fiddler можно начать записывать трафик, перейдя в меню **File** (Файл) и выбрав **Capture Traffic** (Запись трафика).

### <a name="staged-rollout-of-proxy-settings"></a>Поэтапное развертывание параметров прокси-сервера

В зависимости от возможностей инфраструктуры прокси-сервера можно выполнить поэтапное развертывание параметров для пользователей. Ниже приведено несколько общих способов, которые вы можете рассмотреть.

1. Используйте PAC-файлы, чтобы направить тестовых пользователей в тестовую инфраструктуру прокси-сервера, а обычные пользователи пусть продолжат использовать рабочую инфраструктуру прокси-сервера.
2. Некоторые прокси-серверы могут поддерживать различные конфигурации с использованием групп.

Конкретные сведения см. в документации по прокси-серверу.

## <a name="next-steps"></a>Дополнительная информация

- Ознакомьтесь со статьей [Updated Office 365 modern authentication](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/) (Обновление поддержи современной аутентификации в Office 365).
- Прочтите статью [URL-адреса и диапазоны IP-адресов Office 365](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2).
