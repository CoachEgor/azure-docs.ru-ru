---
title: Высокая доступность и балансировка нагрузки - Azure AD Application Proxy
description: Как работает распределение трафика с развертыванием приложения Proxy. Включает в себя советы о том, как оптимизировать производительность разъема и использовать балансировку нагрузки для серверов бэк-энда.
services: active-directory
documentationcenter: ''
author: msmimart
manager: CelesteDG
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 10/08/2019
ms.author: mimart
ms.reviewer: japere
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: 992075378737552e890bd2d6fed3c519e6c62aa7
ms.sourcegitcommit: 7e04a51363de29322de08d2c5024d97506937a60
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81312947"
---
# <a name="high-availability-and-load-balancing-of-your-application-proxy-connectors-and-applications"></a>Высокая доступность и балансировка нагрузки разъемов и приложений Application Proxy

В этой статье объясняется, как распределение трафика работает с развертыванием приложения Proxy. Мы обсудим:

- Как трафик распределяется между пользователями и разъемами, а также советы по оптимизации производительности разъема

- Как трафик течет между разъемами и серверами приложений бэк-энда, с рекомендациями по балансировке нагрузки между несколькими серверами бэк-энда

## <a name="traffic-distribution-across-connectors"></a>Распределение трафика по разъемым

Соединительы устанавливают свои связи на основе принципов высокой доступности. Там нет гарантии, что трафик всегда будет равномерно распределены по разъемым и нет сеанса сродства. Тем не менее, использование варьируется, и запросы отправляются случайным образом в экземпляры службы application Proxy. В результате трафик обычно распределяется почти равномерно по разъемым. Диаграмма и приведенные ниже шаги иллюстрируют, как устанавливаются связи между пользователями и разъемами.

![Диаграмма, показывающая связи между пользователями и разъемами](media/application-proxy-high-availability-load-balancing/application-proxy-connections.png)

1. Пользователь на клиентском устройстве пытается получить доступ к приложению, опубликованному через Application Proxy.
2. Запрос проходит через балансер загрузки Azure, чтобы определить, какой экземпляр службы приложения Proxy должен принять запрос. В каждом регионе имеется десятки экземпляров, доступных для принятия запроса. Этот метод помогает равномерно распределить трафик по экземплярам службы.
3. Запрос отправляется в [Сервисный автобус.](https://docs.microsoft.com/azure/service-bus-messaging/)
4. Сервисный автобус сигнализирует на доступный разъем. Затем разъем забирает запрос от Service Bus.
   - На шаг 2 запросы переходят в различные экземпляры службы Application Proxy, поэтому соединения с большей вероятностью будут сделаны с различными разъемами. В результате разъемы почти равномерно используются в группе.
5. Разъем передает запрос на сервер приложения. Затем приложение отправляет ответ обратно в разъем.
6. Разъем завершает ответ, открывая исходящие соединения к экземпляру службы, откуда пришел запрос. Затем это соединение немедленно закрывается. По умолчанию каждый разъем ограничен 200 одновременными исходящими соединениями.
7. Ответ затем передается клиенту из экземпляра службы.
8. Последующие запросы из того же соединения повторяют вышеуказанные шаги.

Приложение часто имеет много ресурсов и открывает несколько подключений при загрузке. Каждое соединение проходит через вышеперечисленные шаги, чтобы стать выделенным экземпляру службы, выберите новый доступный разъем, если соединение еще не было ранее сопряжено с разъемом.


## <a name="best-practices-for-high-availability-of-connectors"></a>Лучшие практики для высокой доступности разъемов

- Из-за того, как трафик распределяется между разъемами для высокой доступности, важно всегда иметь по крайней мере два разъема в группе разъемов. Три разъема предпочитают предоставлять дополнительный буфер между разъемами. Чтобы определить необходимое необходимое количество разъемов, следуйте документации по планированию емкости.

- Разместите разъемы на различных исходящих соединениях, чтобы избежать одной точки сбоя. Если разъемы используют одно и то же исходящие соединения, сетевая проблема с соединением может повлиять на все разъемы, использующие его.

- Избегайте принудительного запуска разъемов при подключении к производственным приложениям. Это может негативно сказаться на распределении трафика по разъемам. Перезапуск разъемов приводит к тому, что больше разъемов недоступно и заставляет соединения с оставшимся доступным разъемом. Результатом является неравномерное использование разъемов на начальном этапе.

- Избегайте всех форм внедорожной проверки исходящих сообщений TLS между разъемами и Azure. Этот тип внеливной инспекции приводит к деградации потока связи.

- Убедитесь в том, чтобы автоматические обновления работали для разъемов. Если служба обновления подключения прокси-сервера приложения работает, разъемы обновляются автоматически и получают последнюю обновленную. Если служба обновления соединителей не отображается на сервере, для получения обновлений необходимо переустановить соединитель.

## <a name="traffic-flow-between-connectors-and-back-end-application-servers"></a>Поток трафика между разъемами и серверами приложений бэк-энда

Еще одной ключевой областью, где высокая доступность является фактором, является связь между разъемами и серверами бэк-энда. Когда приложение публикуется через Azure AD Application Proxy, трафик от пользователей к приложениям перетекает через три перехода:

1. Пользователь подключается к общедоступной конечной точке приложения Azure AD Proxy в Azure. Связь устанавливается между исходяющим IP-адресом клиента (общественным) клиента и IP-адресом конечной точки Приложения Proxy.
2. Разъем приложения Прокси тянет запрос HTTP клиента из службы прокси приложения.
3. Разъем приложения Proxy подключается к целевому приложению. Разъем использует свой собственный IP-адрес для установления соединения.

![Диаграмма подключения пользователя к приложению через приложение Прокси](media/application-proxy-high-availability-load-balancing/application-proxy-three-hops.png)

### <a name="x-forwarded-for-header-field-considerations"></a>X-Forwarded-Для заголовок поля соображений
В некоторых ситуациях (например, аудит, балансировка нагрузки и т.д.) обязательное требование является обмен исходным IP-адресом внешнего клиента с предварительной средой. Чтобы удовлетворить это требование, разъем azure AD Application Proxy добавляет поле X-Forwarded-For header с исходным IP-адресом клиента (открытым) в запрос HTTP. Соответствующее сетевое устройство (балансер нагрузки, брандмауэр) или веб-сервер или приложение бэк-энда могут затем читать и использовать информацию.

## <a name="best-practices-for-load-balancing-among-multiple-app-servers"></a>Лучшие практики для балансировки нагрузки между несколькими серверами приложений
Когда группа разъемов, назначенная приложению Application Proxy, имеет два или более разъемов, и вы работаете с веб-приложением на нескольких серверах (серверная ферма), требуется хорошая стратегия балансировки нагрузки. Хорошая стратегия гарантирует, что серверы будут выбирать запросы клиентов равномерно и предотвращает чрезмерное или недостаточное использование серверов на ферме серверов.
### <a name="scenario-1-back-end-application-does-not-require-session-persistence"></a>Сценарий 1: Приложение back-end не требует сохранения сеанса
Самый простой сценарий, когда задней конце веб-приложения не требует сеанса липкость (сессия настойчивости). Любой запрос от пользователя может быть обработан любым экземпляром бэк-энда на серверной ферме. Вы можете использовать балансизатор нагрузки 4 слоя и настроить его без сродства. Некоторые варианты включают балансировку загрузки сети Майкрософт и балансизатор нагрузки Azure или балансизатор нагрузки от другого поставщика. Кроме того, можно настроить круглогодичные DNS.
### <a name="scenario-2-back-end-application-requires-session-persistence"></a>Сценарий 2: Резервное приложение требует сохранения сеанса
В этом сценарии веб-приложение бэк-энда требует липкости сеанса (сохранение сеанса) во время сеанса аутентифицированного сеанса. Все запросы от пользователя должны обрабатываться экземпляром бэк-энда, который работает на одном сервере на серверной ферме.
Этот сценарий может быть более сложным, поскольку клиент обычно устанавливает несколько подключений к службе Application Proxy. Запросы на различные соединения могут поступать в различные разъемы и серверы на ферме. Поскольку каждый разъем использует свой собственный IP-адрес для этой коммуникации, балансизатор нагрузки не может обеспечить липкость сеанса на основе IP-адреса разъемов. Источник IP Affinity также не может быть использован.
Вот несколько вариантов сценария 2:

- Вариант 1: Основы сохранения сеанса на файле cookie сеанса, установленном балансера нагрузки. Эта опция рекомендуется, поскольку она позволяет более равномерно распределять нагрузку между серверами бэк-энда. Это требует слоя 7 балансомер нагрузки с этой возможностью и что может обрабатывать трафик HTTP и прекратить подключение TLS. Вы можете использовать azure Application Gateway (Session Affinity) или балансирум нагрузки от другого поставщика.

- Вариант 2: Основы сохранения сеанса на поле X-Forwarded-For header. Эта опция требует баланса нагрузки уровня 7 с этой возможностью, которая может обрабатывать трафик HTTP и прекращать подключение TLS.  

- Вариант 3: Настройка бэк-энда приложения, чтобы не требовать сохранения сеанса.

Обратитесь к документации поставщика программного обеспечения, чтобы понять требования к балансировке нагрузки в бэк-энд-приложении.

## <a name="next-steps"></a>Следующие шаги

- [Включение прокси приложения](application-proxy-add-on-premises-application.md)
- [Включение единого входа](application-proxy-configure-single-sign-on-with-kcd.md)
- [Включить условный доступ](application-proxy-integrate-with-sharepoint-server.md)
- [Устранение неполадок с прокси приложения](application-proxy-troubleshoot.md)
- [Узнайте, как архитектура Azure AD поддерживает высокую доступность](https://docs.microsoft.com/azure/active-directory/fundamentals/active-directory-architecture)
