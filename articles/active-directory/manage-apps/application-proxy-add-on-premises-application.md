---
title: Учебник. Добавление локального приложения с помощью прокси приложения в Azure AD
description: Azure Active Directory (Azure AD) содержит службу прокси приложения, которая позволяет пользователям получать доступ к локальным приложениям при входе с использованием своей учетной записи Azure AD. В этом учебнике описано, как подготовить среду для использования с Application Proxy. Затем используется портал Azure для добавления локального приложения в клиент Azure AD.
services: active-directory
author: kenwith
manager: celestedg
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.topic: tutorial
ms.date: 10/24/2019
ms.author: kenwith
ms.reviewer: japere
ms.collection: M365-identity-device-management
ms.openlocfilehash: fc1d0687c0d2d48a64e38fd5a57fe32c13063890
ms.sourcegitcommit: bc943dc048d9ab98caf4706b022eb5c6421ec459
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/14/2020
ms.locfileid: "84760309"
---
# <a name="tutorial-add-an-on-premises-application-for-remote-access-through-application-proxy-in-azure-active-directory"></a>Руководство по Добавление локального приложения для удаленного доступа через Application Proxy в Azure Active Directory

Azure Active Directory (Azure AD) содержит службу прокси приложения, которая позволяет пользователям получать доступ к локальным приложениям при входе с использованием своей учетной записи Azure AD. В руководстве подготавливается среда для использования с прокси приложения. После подготовки среды вы будете использовать портал Azure для добавления локального приложения в свой клиент Azure AD.

В этом руководстве рассматривается:

> [!div class="checklist"]
> * Открытие портов для исходящего трафика и разрешения доступа к определенным URL-адресам.
> * Установка соединителя на сервере Windows и его регистрация с помощью прокси приложения.
> * Проверка правильности установки и регистрации соединителя.
> * Добавление локального приложения в клиент Azure AD.
> * Проверка возможности входа в приложение для тестового пользователя с помощью учетной записи Azure AD.

## <a name="before-you-begin"></a>Перед началом

Чтобы добавить локальное приложение в Azure AD, вам потребуется следующее:

* [подписка Microsoft Azure AD ценовой категории "Премиум"](https://azure.microsoft.com/pricing/details/active-directory);
* учетная запись администратора приложения.
* Удостоверения пользователей должны быть синхронизированы из локального каталога или созданы непосредственно в клиентах Azure AD. Синхронизация удостоверений позволяет Azure AD выполнить предварительную проверку подлинности пользователей до предоставления им доступа к опубликованным приложениям Application Proxy и получить сведения об идентификаторах пользователей для выполнения единого входа (SSO).

### <a name="windows-server"></a>Windows Server

Чтобы использовать Application Proxy, вам потребуется сервер под управлением Windows Server 2012 R2 или более поздней версии. Соединитель Application Proxy устанавливается на сервер. Серверу соединителя нужна возможность подключаться к службам прокси приложения в Azure, а также к локальным приложениям, которые вы планируете публиковать.

Для обеспечения высокого уровня доступности рабочей среде рекомендуем использовать несколько серверов Windows. Для этого руководства достаточно и одного сервера Windows.

> [!IMPORTANT]
> Если вы устанавливаете соединитель на Windows Server 2019, необходимо отключить поддержку протокола HTTP2 в компоненте WinHttp. В более ранних версиях поддерживаемых операционных систем она по умолчанию отключена. Добавление следующего раздела реестра и перезагрузка сервера приведет к отключению поддержки в Windows Server 2019. Обратите внимание, что этот раздел реестра действует для всего компьютера.
>
> ```
> HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\WinHttp\EnableDefaultHttp2 (DWORD) Value: 0 
> ```
>

#### <a name="recommendations-for-the-connector-server"></a>Рекомендации для сервера соединителя

1. Физически найдите сервер соединителя рядом с серверами приложения для оптимизации производительности между соединителем и приложением. Дополнительные сведения см. в статье [Аспекты топологии сети при использовании прокси приложения Azure Active Directory](application-proxy-network-topology.md).
1. Сервер соединителя и серверы веб-приложений должны принадлежать одному домену Active Directory или диапазону доверенных доменов. Размещение серверов в одном домене или диапазоне доверенных доменов необходимо для использования единого входа с помощью встроенной проверки подлинности Windows (IWA) и ограниченного делегирования Kerberos (KCD). Если сервер соединителя и серверы веб-приложения находятся в разных доменах Active Directory, для единого входа необходимо использовать делегирование на основе ресурсов. Дополнительные сведения см. в статье [Ограниченное делегирование Kerberos для поддержки единого входа в приложения с помощью прокси приложения](application-proxy-configure-single-sign-on-with-kcd.md).

> [!WARNING]
> Если вы развернули прокси-сервер защиты паролем Azure AD, не устанавливайте Azure AD Application Proxy на одном компьютере с ним. Azure AD Application Proxy и прокси-сервер защиты паролем Azure AD устанавливают разные версии службы Azure AD Connect Agent Updater. Эти разные версии несовместимы при установке вместе на одном компьютере.

#### <a name="tls-requirements"></a>Требования к TLS

Прежде чем установить этот соединитель, на сервере Windows Server нужно включить протокол TLS 1.2.

Включение протокола TLS 1.2

1. Настройте следующие разделы реестра:
    
    ```
    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2]
    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Client] "DisabledByDefault"=dword:00000000 "Enabled"=dword:00000001
    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Server] "DisabledByDefault"=dword:00000000 "Enabled"=dword:00000001
    [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v4.0.30319] "SchUseStrongCrypto"=dword:00000001
    ```

1. Перезапустите сервер.

> [!IMPORTANT]
> Для обеспечения лучшего в своем классе шифрования прокси-служба приложения поддерживает доступ только по протоколам TLS 1.2. Эти изменения внедрялись поэтапно и окончательно вступили в силу 31 августа 2019 г. Убедитесь, что все ваши комбинации "клиент-сервер" и "браузер-сервер" обновлены для использования протокола TLS 1.2 и смогут обеспечить подключение к прокси-службе приложения. Это также касается клиентов, с помощью которых ваши пользователи получают доступ к приложениям, опубликованным через прокси приложения. Полезные ссылки и ресурсы см. в статье [Подготовка к использованию TLS 1.2 в Office 365](https://support.microsoft.com/help/4057306/preparing-for-tls-1-2-in-office-365).

## <a name="prepare-your-on-premises-environment"></a>Подготовка локальной среды

Для подготовки среды для Azure AD Application Proxy необходимо сначала установить связь с центрами обработки данных Azure. Если в сетевом пути используется брандмауэр, убедитесь, что он открыт. Открытый брандмауэр разрешает соединителю выполнять запросы HTTPS (TCP) к Application Proxy.

### <a name="open-ports"></a>Открытие портов

Откройте следующие порты для **исходящего** трафика.

   | Номер порта | Как он используется |
   | --- | --- |
   | 80 | Скачивание списков отзыва сертификатов при проверке TLS/SSL-сертификата |
   | 443 | Весь исходящий обмен данными со службой прокси приложения |

Если брандмауэр инициирует трафик в соответствии с отправляющими его пользователями, откройте порты 80 и 443 для трафика, поступающего от служб Windows, которые работают как сетевая служба.

### <a name="allow-access-to-urls"></a>Разрешение доступа к URL-адресам

Разрешите доступ к следующим URL-адресам.

| URL-адрес | Как он используется |
| --- | --- |
| \*.msappproxy.net;<br>\*.servicebus.windows.net. | Связь между соединителем и облачной службой прокси приложения |
| mscrl.microsoft.com:80<br>crl.microsoft.com:80<br>ocsp.msocsp.com:80<br>www.microsoft.com:80 | Соединитель использует эти URL-адреса для проверки сертификатов. |
| login.windows.net<br>secure.aadcdn.microsoftonline-p.com<br>\*.microsoftonline.com<br>\*.microsoftonline-p.com<br>\*.msauth.net<br>\*.msauthimages.net<br>\*.msecnd.net<br>\*.msftauth.net<br>\*.msftauthimages.net<br>\*.phonefactor.net<br>enterpriseregistration.windows.net<br>management.azure.com<br>policykeyservice.dc.ad.msft.net<br>ctdl.windowsupdate.com:80 | Соединитель использует эти URL-адреса во время регистрации. |

Вы можете разрешить подключения к \*.msappproxy.net и \*.servicebus.windows.net, если брандмауэр или прокси-сервер позволяет настроить списки разрешенных DNS. В противном случае необходимо разрешить доступ к [диапазонам IP-адресов Azure и тегам служб в общедоступном облаке](https://www.microsoft.com/download/details.aspx?id=56519). Список диапазонов IP-адресов обновляется еженедельно.

## <a name="install-and-register-a-connector"></a>Установка и регистрация соединителя

Чтобы использовать Application Proxy, необходимо установить соединитель на каждом сервере Windows, который вы используете со службой Application Proxy. Соединитель — это агент, который управляет исходящим подключением локальных серверов приложений к прокси приложения в Azure AD. Соединитель можно установить на серверах, на которых установлены также другие агенты проверки подлинности, например Azure AD Connect.

Для установки соединителя:

1. Войдите на [портал Azure](https://portal.azure.com/) как администратор приложения каталога, который использует прокси приложения. Например, если домен клиента contoso.com, администратором должен быть пользователь admin@contoso.com или другой псевдоним администратора в этом домене.
1. В правом верхнем углу выберите свое имя пользователя. Убедитесь, что вы вошли в каталог, который использует Application Proxy. Если необходимо изменить каталоги, щелкните **Переключение каталога** и выберите каталог, который использует Application Proxy.
1. В области навигации слева выберите **Azure Active Directory**.
1. В разделе **Управление** выберите **Прокси приложения**.
1. Выберите **Скачать службу соединителя**.

    ![Скачайте службу соединителя, чтобы просмотреть условия предоставления услуг.](./media/application-proxy-add-on-premises-application/application-proxy-download-connector-service.png)

1. Ознакомьтесь с условиями предоставления услуг. Когда вы будете готовы, выберите **Accept terms & Download** (Принять условия и скачать).
1. В нижней части окна выберите **Выполнить**, чтобы установить соединитель. Откроется мастер установки.
1. Следуйте указаниям мастера, чтобы установить службу. Когда будет предложено зарегистрировать соединитель с помощью прокси приложения для вашего клиента Azure AD, укажите учетные данные администратора приложения.
    - Если в Internet Explorer **включена** **конфигурация усиленной безопасности Internet Explorer**, возможно, экран регистрации не отобразится. Чтобы получить к нему доступ, выполните указания, приведенные в сообщении об ошибке. Убедитесь, что **конфигурация усиленной безопасности Internet Explorer** **отключена**.

### <a name="general-remarks"></a>Общие замечания

Если вы ранее установили соединитель, переустановите его, чтобы получить последнюю версию. Чтобы просмотреть сведения о предыдущих версиях и изменениях в них, см. статью [Azure AD Application Proxy: Version release history](application-proxy-release-version-history.md) (Azure AD Application Proxy. Журнал выпуска версий).

Если вы выбрали несколько серверов Windows для локальных приложений, необходимо установить и зарегистрировать соединитель на каждом сервере. Соединители можно упорядочить в группы. Дополнительные сведения см. в статье [Публикация приложений в отдельных сетях и расположениях с помощью групп соединителей](application-proxy-connector-groups.md).

Если в вашей организации для подключения к Интернету используются прокси-серверы, необходимо настроить их для Application Proxy.  Дополнительные сведения см. в статье [Работа с имеющимися локальными прокси-серверами](application-proxy-configure-connectors-with-proxy-servers.md). 

Сведения о соединителях, поддержании их актуальности и планировании емкости см. в статье [Сведения о соединителях прокси приложения Azure AD](application-proxy-connectors.md).

## <a name="verify-the-connector-installed-and-registered-correctly"></a>Проверка правильности установки и регистрации соединителя

Используйте портал Azure или сервер Windows для подтверждения того, что новый соединитель установлен правильно.

### <a name="verify-the-installation-through-azure-portal"></a>Проверка установки через портал Azure

Для подтверждения правильности установки и регистрации соединителя:

1. Войдите в свой каталог клиента на [портале Azure](https://portal.azure.com).
1. В области навигации слева выберите **Azure Active Directory**, а затем **Прокси приложения** в разделе **Управление**. На этой странице отображаются все соединители и группы соединителей.
1. Просмотрите соединитель, чтобы проверить сведения о нем. Соединители должны быть развернуты по умолчанию. Если соединитель, который вы хотите просмотреть, не развернут, разверните его, чтобы просмотреть сведения. Активная зеленая метка указывает на то, что соединитель может подключиться к службе. Тем не менее, несмотря на то, что метка зеленая, проблема с сетью по-прежнему может помешать соединителю получать сообщения.

    ![Соединители Azure AD Application Proxy](./media/application-proxy-add-on-premises-application/app-proxy-connectors.png)

Дополнительные сведения об установке соединителя см. в статье [Problem installing the Application Proxy Agent Connector](application-proxy-connector-installation-problem.md) (Проблемы при установке соединителя агента прокси приложения).

### <a name="verify-the-installation-through-your-windows-server"></a>Проверка установки через сервер Windows

Для подтверждения правильности установки и регистрации соединителя:

1. Откройте диспетчер служб Windows, щелкнув клавишу **Windows** и введя *services.msc*.
1. Проверьте наличие состояния **Выполняется** для двух следующих служб.
   - **Соединитель Microsoft AAD Application Proxy** обеспечивает возможность подключения.
   - **Средство обновления соединителя прокси приложения Microsoft AAD** выполняет роль службы автоматического обновления. Средство обновления проверяет наличие новых версий соединителя и обновляет его по мере необходимости.

     ![Службы соединителей прокси приложения — снимок экрана](./media/application-proxy-add-on-premises-application/app_proxy_services.png)

1. Если состояние службы не **Выполняется**, щелкните правой кнопкой мыши каждую службу и выберите **Запустить**.

## <a name="add-an-on-premises-app-to-azure-ad"></a>Добавление локального приложения в Azure AD

Теперь, когда вы подготовили среду и установили соединитель, вы готовы добавить локальные приложения в Azure AD.  

1. Войдите на [портал Azure](https://portal.azure.com/) с учетной записью администратора.
2. В области навигации слева выберите **Azure Active Directory**.
3. Перейдите в колонку **Корпоративные приложения** и выберите **Новое приложение**.
4. В разделе **Локальные приложения** выберите **Добавление локального приложения**.
5. В разделе **Добавление локального приложения** укажите следующие сведения о приложении.

    | Поле | Описание |
    | :---- | :---------- |
    | **имя**; | Имя приложения, которое будет отображаться на панели доступа и на портале Azure. |
    | **Внутренний URL-адрес** | URL-адрес для доступа к приложению в частной сети. Для публикации можно указать только конкретный адрес на внутреннем сервере; при этом другие адреса сервера не публикуются. Это позволяет публиковать на одном сервере разные сайты, назначая каждому из них отдельное имя и правила доступа.<br><br>Если вы публикуете путь, он должен включать в себя все необходимые изображения, скрипты и таблицы стилей для вашего приложения. Например, если приложение расположено по адресу https:\//yourapp/app и использует образы, расположенные по адресу https:\//yourapp/media, следует опубликовать путь https:\//yourapp/. Этот внутренний URL-адрес не должен отображаться на целевой странице, которую видят пользователи. Дополнительные сведения см. в разделе [Настройка пользовательской домашней страницы для опубликованных приложений с помощью прокси приложения Azure AD](application-proxy-configure-custom-home-page.md). |
    | **Внешний URL-адрес** | Адрес для пользователей, чтобы получить доступ к приложению за пределами вашей сети. Если вы не хотите использовать домен прокси приложения по умолчанию, прочитайте сведения о [личных доменах в прокси приложения Azure AD](application-proxy-configure-custom-domain.md).|
    | **Предварительная проверка подлинности** | Здесь указывается метод проверки пользователей, который использует прокси приложения, прежде чем предоставить доступ к приложению.<br><br>**Azure Active Directory** — прокси приложения перенаправляет пользователей на страницу входа в Azure AD, где будет выполняться проверка подлинности их разрешений для каталога и приложения. Мы советуем оставить значение этого параметра по умолчанию, чтобы воспользоваться преимуществами функций безопасности Azure AD, например условным доступом и Многофакторной идентификацией. Служба **Azure Active Directory** необходима для мониторинга приложения с помощью Microsoft Cloud Application Security.<br><br>**Сквозной режим** — пользователям для доступа к приложению не нужно выполнять аутентификацию в Azure AD. Вы по-прежнему можете настроить требования к аутентификации на серверной стороне. |
    | **Группа соединителей** | Соединители обрабатывают удаленный доступ к приложению, а группы соединителей позволяют упорядочивать соединители и приложения по регионам, сетям и назначению. Если вы еще не создали какие-либо группы соединителей, приложение назначается в группу **по умолчанию**.<br><br>Если ваше приложение использует WebSocket для подключения, все соединители в группе должны быть версии 1.5.612.0 или более поздней.|

6. При необходимости настройте **дополнительные параметры**. Для большинства приложений следует сохранить значения этих параметров по умолчанию. 

    | Поле | Описание |
    | :---- | :---------- |
    | **Время ожидания серверного приложения** | Задайте для этого параметра значение **Длинный**, только если приложение медленно выполняет проверку подлинности и подключение. По умолчанию время ожидания серверного приложения составляет 85 секунд. Когда установлено значение "Длинный", время ожидания сервера увеличивается до 180 секунд. |
    | **Use HTTP-Only Cookie** (Использовать файл cookie только HTTP-Only) | Задайте для этого параметра значение **Да**, чтобы файлы cookie прокси приложения содержали флаг HTTPOnly в заголовке ответа HTTP. Если используете службы удаленных рабочих столов, задайте значение **Нет**.|
    | **Использовать безопасный файл cookie**| Установите значение **Да**, чтобы файлы cookie передавались по защищенному каналу, как например зашифрованный HTTPS-запрос.
    | **Сохранять файлы сookie**| Для этого параметра оставьте значение **Нет**. Этот параметр нужно использовать только для приложений, в которых файлы cookie не используются совместно между процессами. Дополнительные сведения о параметрах файлов cookie см. в статье [Cookie settings for accessing on-premises applications in Azure Active Directory](https://docs.microsoft.com/azure/active-directory/manage-apps/application-proxy-configure-cookie-settings) (Параметры файлов cookie для доступа к локальным приложениям в Azure Active Directory).
    | **Translate URLs in Headers** (Преобразование URL-адресов в заголовках) | Оставьте значением этого параметра **Да**, если только приложению не требуется исходный заголовок узла в запросе на аутентификацию. |
    | **Translate URLs in Application Body** (Преобразовывать URL-адреса в коде приложения) | Только если вы используете жестко закодированные ссылки HTML на другие локальные приложения и не используете личные домены, следует изменить значение этого параметра по умолчанию на **Нет**. Дополнительные сведения см. в статье [Перенаправление встроенных ссылок для приложений, опубликованных с помощью прокси приложения Azure AD](application-proxy-configure-hard-coded-link-translation.md).<br><br>Установите значение **Да**, если вы планируете осуществлять мониторинг этого приложения с помощью Microsoft Cloud App Security (MCAS). Дополнительные сведения см. в статье [Configure real-time application access monitoring with Microsoft Cloud App Security and Azure Active Directory](application-proxy-integrate-with-microsoft-cloud-application-security.md) (Настройка мониторинга доступа к приложениям в режиме реального времени с помощью Microsoft Cloud App Security и Azure Active Directory). |

7. Выберите **Добавить**.

## <a name="test-the-application"></a>Тестирование приложения

Все готово к тестированию правильности добавления приложения. На следующих этапах добавьте учетную запись пользователя в приложение и попробуйте войти.

### <a name="add-a-user-for-testing"></a>Добавление пользователя для тестирования

Прежде чем добавить пользователя к приложению, убедитесь, что у учетной записи есть разрешения на доступ к приложению из корпоративной сети.

Чтобы добавить тестового пользователя:

1. Щелкните **Корпоративные приложения** и выберите приложение, которое необходимо проверить.
2. Щелкните **Приступая к работе** и выберите **Assign a user for testing** (Назначение пользователя для тестирования).
3. В разделе **Пользователи и группы** выберите **Добавление пользователя**.
4. В разделе **Добавление назначения** выберите **Пользователи и группы**. Появится раздел **Пользователи и группы**.
5. Выберите учетную запись, которую вы хотите добавить.
6. Щелкните **Выбрать**, а затем выберите **Назначить**.

### <a name="test-the-sign-on"></a>Проверка единого входа

Для тестирования единого входа в приложение:

1. В приложении, которое необходимо протестировать, выберите **Application Proxy**.
2. В верхней части страницы выберите **Тестировать приложение**, чтобы запустить тест в приложении и проверить наличие проблем с конфигурацией.
3. Сначала запустите приложение, чтобы проверить функцию входа в приложение, а затем скачайте диагностический отчет, чтобы просмотреть рекомендации по устранению обнаруженных проблем.

Сведения об устранении неполадок вы найдете [здесь](application-proxy-troubleshoot.md).

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы подготовили локальную среду для работы с прокси приложения, а затем установили и зарегистрировали соединитель прокси приложения. После этого вы добавили приложение в клиент Azure AD. Проверили возможность входа в приложение для тестового пользователя с помощью учетной записи Azure AD.

Вы выполнили такие действия:
> [!div class="checklist"]
> * Открыли порты для исходящего трафика и разрешили доступ к определенным URL-адресам.
> * Установили соединитель на сервере Windows и зарегистрировали его с помощью прокси приложения.
> * Проверили правильность установки и регистрации соединителя.
> * Добавили локальное приложение в клиент Azure AD.
> * Проверили возможность входа в приложение для тестового пользователя с помощью учетной записи Azure AD.

Все готово для настройки единого входа. Используйте следующую ссылку, чтобы выбрать способ единого входа и найти руководства по его настройке.

> [!div class="nextstepaction"]
> [Настройка единого входа](what-is-single-sign-on.md#choosing-a-single-sign-on-method)
