---
title: Узнайте, как работает подготовка Azure AD | Документация Майкрософт
description: Узнайте, как работает подготовка Azure AD
services: active-directory
documentationcenter: ''
author: msmimart
manager: CelesteDG
ms.service: active-directory
ms.subservice: app-mgmt
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/10/2019
ms.author: mimart
ms.reviewer: arvinh
ms.collection: M365-identity-device-management
ms.openlocfilehash: 5238f8ca9258e4f7907d9d9755b7252e60f40de8
ms.sourcegitcommit: f52ce6052c795035763dbba6de0b50ec17d7cd1d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2020
ms.locfileid: "76711531"
---
# <a name="how-provisioning-works"></a>Описание процесса подготовки

Автоматическая подготовка подразумевает создание удостоверений пользователей и ролей в облачных приложениях, к которым пользователям требуется доступ. Кроме создания удостоверений пользователей, автоматическая подготовка включает в себя обслуживание и удаление удостоверений пользователей по мере изменения их статуса или ролей. Перед началом развертывания вы можете ознакомиться с этой статьей, чтобы узнать, как работает Azure AD, и получить рекомендации по настройке. 

**Служба подготовки Azure AD** подготавливает пользователей к приложениям SaaS и другим системам, подключаясь к системе для API управления пользовательским удостоверением (SCIM) 2,0, предоставленного поставщиком приложения. Эта конечная точка SCIM позволяет Azure AD программно создавать, обновлять и удалять пользователей. Для выбранных приложений Служба подготовки может также создавать, обновлять и удалять дополнительные объекты, связанные с удостоверениями, такие как группы и роли. Канал, используемый для подготовки между Azure AD и приложением, шифруется с помощью HTTPS SSL-шифрования.


![службы подготовки Azure AD](media/how-provisioning-works/provisioning0.PNG)
*рис. 1. Служба подготовки Azure AD*

Рабочий процесс подготовки исходящего пользователя ![](media/how-provisioning-works/provisioning1.PNG)
*рис. 2. "исходящий" Рабочий процесс подготовки пользователей из Azure AD в популярные приложения SaaS*

Рабочий процесс подготовки входящих пользователей ![](media/how-provisioning-works/provisioning2.PNG)
*рис. 3. "входящий" Рабочий процесс подготовки пользователей из популярных приложений управления человеческим капиталом (HCM) на Azure Active Directory и Windows Server Active Directory*

## <a name="provisioning-using-scim-20"></a>Подготовка с помощью SCIM 2,0

Служба подготовки Azure AD использует [протокол SCIM 2,0](https://techcommunity.microsoft.com/t5/Identity-Standards-Blog/bg-p/IdentityStandards) для автоматической подготовки. Служба подключается к конечной точке SCIM для приложения и использует схему объектов пользователей SCIM и интерфейсы API-интерфейсов RESTFUL для автоматизации подготовки и отмены подготовки пользователей и групп. Соединитель подготовки на основе SCIM предоставляется для большинства приложений в коллекции Azure AD. При создании приложений для Azure AD разработчики могут использовать API управления пользователями SCIM 2,0 для создания конечной точки SCIM, которая интегрирует Azure AD для подготовки. Дополнительные сведения см. [в статьях создание конечной точки scim и Настройка подготовки пользователей](use-scim-to-provision-users-and-groups.md).

Чтобы запросить автоматический соединитель подготовки Azure AD для приложения, которое в настоящее время не имеет такой учетной записи, заполните [запрос Azure Active Directory приложения](https://aka.ms/aadapprequest).

## <a name="authorization"></a>Авторизация

Для подключения Azure AD к API управления пользователями приложения требуются учетные данные. При настройке автоматической подготовки пользователей для приложения необходимо ввести допустимые учетные данные. Вы можете найти типы и требования к учетным данным для приложения, обратившись к учебнику по приложению. В портал Azure вы сможете протестировать учетные данные, получив Azure AD для подключения к приложению подготовки приложения с помощью предоставленных учетных данных.

Если для приложения также настроен единый вход на основе SAML, предельный размер хранилища для каждого приложения в Azure AD составляет 1024 байт. Это ограничение включает все сертификаты, секретные маркеры, учетные данные и связанные данные конфигурации, связанные с одним экземпляром приложения (также известного как запись субъекта-службы в Azure AD). При настройке единого входа на основе SAML сертификат, используемый для подписи токенов SAML, часто потребляет более 50% в процентах от пробела. Все дополнительные элементы (секретные маркеры, URI, адреса электронной почты для уведомлений, имена пользователей и пароли), введенные при настройке подготовки пользователей, могут превысить пределы хранилища. Дополнительные сведения см. в разделе [проблема при сохранении учетных данных администратора во время настройки подготовки пользователей](application-provisioning-config-problem-storage-limit.md).

## <a name="mapping-attributes"></a>Сопоставление атрибутов

При включении подготовки пользователей для стороннего приложения SaaS портал Azure определяет значения атрибутов с помощью сопоставлений атрибутов. Сопоставления определяют атрибуты пользователей, которые проходят между Azure AD и целевым приложением при подготовке или обновлении учетных записей пользователей.

Существует предварительно настроенный набор атрибутов и сопоставлений атрибутов между объектами пользователей Azure AD и объектами пользователей приложения SaaS. Некоторые приложения управляют другими типами объектов вместе с пользователями, например группами.

При настройке подготовки необходимо проверить и настроить сопоставления атрибутов и рабочие процессы, определяющие, какие свойства пользователя (или группы) поступают из Azure AD в приложение. Проверьте и настройте соответствующее свойство (**сопоставление объектов с помощью этого атрибута**), которое используется для уникальной идентификации и сопоставления пользователей и групп между двумя системами.

Сопоставление атрибутов по умолчанию можно настроить в соответствии с потребностями вашего бизнеса. Таким образом, можно изменить или удалить существующие сопоставления атрибутов или создать новые сопоставления атрибутов. Дополнительные сведения см. в разделе [Настройка сопоставления атрибутов подготовки пользователей для приложений SaaS](customize-application-attributes.md).

При настройке подготовки для приложения SaaS одним из типов сопоставления атрибутов, которые можно указать, является сопоставление выражений. Для этих сопоставлений необходимо написать выражение, аналогичное сценарию, которое позволяет преобразовывать данные пользователей в форматы, которые более приемлемы для приложения SaaS. Дополнительные сведения см. в разделе [Написание выражений для сопоставления атрибутов](functions-for-customizing-application-data.md).

## <a name="scoping"></a>Scoping 
### <a name="assignment-based-scoping"></a>Определение области на основе назначения

Для исходящей подготовки из Azure AD в приложение SaaS наиболее распространенным способом определения того, какие пользователи входят в область подготовки, является [Назначение пользователей или групп](assign-user-or-group-access-portal.md) . Так как назначения пользователей также используются для включения единого входа, один и тот же метод можно использовать для управления доступом и подготовкой. Области, основанные на назначении, не применяются к входящим сценариям подготовки, таким как Workday и Successfactors.

* **Группы.** С помощью Azure AD Premium плана лицензии можно использовать группы для назначения доступа к приложению SaaS. Затем, если для области подготовки задано значение **синхронизировать только назначенные пользователи и группы**, служба подготовки Azure AD будет подготавливать или отзывать пользователей в зависимости от того, являются ли они членами группы, назначенной приложению. Сам объект группы не подготавливается, если приложение не поддерживает объекты групп.

* **Динамические группы.** Служба подготовки пользователей Azure AD может читать и подготавливать пользователей в [динамических группах](../users-groups-roles/groups-create-rule.md). Примите во внимание следующие особенности и рекомендации:

  * Динамические группы могут повлиять на производительность сквозной подготовки из Azure AD в приложения SaaS.

  * Скорость подготовки или отмены подготовки пользователя в динамической группе в приложении SaaS зависит от того, насколько быстро динамическая группа может оценивать изменения в членстве. Дополнительные сведения о проверке состояния обработки динамической группы см. [в разделе Проверка состояния обработки для правила членства](../users-groups-roles/groups-create-rule.md).

  * Когда пользователь теряет членство в динамической группе, он считается событием отмены подготовки. Рассмотрим этот сценарий при создании правил для динамических групп.

* **Вложенные группы.** Служба подготовки пользователей Azure AD не может читать или подготавливать пользователей во вложенных группах. Служба может только считывать и подготавливать пользователей, которые являются непосредственными членами явно назначенной группы. Это ограничение "назначения на основе групп для приложений" также влияет на единый вход (см. раздел [Использование группы для управления доступом к приложениям SaaS](../users-groups-roles/groups-saasapps.md)). Вместо этого непосредственно назначьте или иным образом укажите [область в](define-conditional-rules-for-provisioning-user-accounts.md) группах, содержащих пользователей, которых необходимо подготовить.

### <a name="attribute-based-scoping"></a>Определение области на основе атрибутов 

Фильтры области можно использовать для определения правил на основе атрибутов, которые определяют, какие пользователи подготавливаются для приложения. Этот метод обычно используется для входящей подготовки из приложений HCM в Azure AD и Active Directory. Фильтры области настраиваются как часть сопоставления атрибутов для каждого соединителя подготовки пользователей Azure AD. Дополнительные сведения о настройке фильтров области на основе атрибутов см. [в разделе Подготовка приложений на основе атрибутов с помощью фильтров области](define-conditional-rules-for-provisioning-user-accounts.md).

### <a name="b2b-guest-users"></a>Пользователи B2B (гости)

Службу подготовки пользователей Azure AD можно использовать для подготовки пользователей B2B (или гостей) в Azure AD к приложениям SaaS. Тем не менее, чтобы пользователи B2B могли входить в приложение SaaS с помощью Azure AD, в приложении SaaS должна быть настроена возможность единого входа на основе SAML. Дополнительные сведения о настройке приложений SaaS для поддержки входа пользователей B2B см. в разделе [Настройка приложений SaaS для службы совместной работы B2B](../b2b/configure-saas-apps.md).

## <a name="provisioning-cycles-initial-and-incremental"></a>Циклы подготовки: Начальная и добавочная

Когда исходной системой является Azure AD, служба подготовки использует [функцию разностных запросов API Graph Azure AD](https://msdn.microsoft.com/Library/Azure/Ad/Graph/howto/azure-ad-graph-api-differential-query) для отслеживания пользователей и групп. Служба подготовки выполняет начальный цикл по отношению к исходной системе и целевой системе, за которыми следуют периодические инкрементные циклы.

### <a name="initial-cycle"></a>Начальный цикл

При запуске службы подготовки первый цикл выполняет следующие действия:

1. Запрашивает всех пользователей и все группы из исходной системы, получая все атрибуты, определенные в [сопоставлениях атрибутов](customize-application-attributes.md).

2. Фильтрует полученных пользователей и группы с помощью настроенных [назначений](assign-user-or-group-access-portal.md) или [фильтров области на основе атрибутов](define-conditional-rules-for-provisioning-user-accounts.md).

3. При назначении пользователя или в области для подготовки служба запрашивает у целевой системы соответствующего пользователя, используя указанные [атрибуты сопоставления](customize-application-attributes.md#understanding-attribute-mapping-properties). Пример. Если имя userPrincipal в исходной системе является совпадающим атрибутом и соответствует атрибуту userName в целевой системе, то служба подготовки запрашивает у целевой системы атрибуты userName, которые соответствуют значениям имени userPrincipal в исходной системе.

4. Если соответствующий пользователь не найден в целевой системе, он создается с использованием атрибутов, возвращенных исходной системой. После создания учетной записи пользователя Служба подготовки обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех последующих операций с этим пользователем.

5. Если найден соответствующий пользователь, он обновляется с использованием атрибутов, предоставляемых исходной системой. После сопоставления учетной записи пользователя Служба подготовки обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех последующих операций с этим пользователем.

6. Если сопоставления атрибутов содержат атрибуты "Reference", служба выполняет дополнительные обновления в целевой системе для создания и связывания объектов, на которые имеются ссылки. Например, пользователь может использовать атрибут Manager в целевой системе, который связан с другим пользователем, созданным в целевой системе.

7. Сохранить водяной знак в конце начального цикла, который предоставляет отправную точку для последующих инкрементных циклов.

Некоторые приложения, такие как ServiceNow, G Suite и Box, поддерживают не только пользователей, но и группы, а также их членов. В таких случаях, если в [сопоставлениях](customize-application-attributes.md)включена подготовка групп, служба подготовки синхронизирует пользователей и группы, а затем синхронизирует членство в группах.

### <a name="incremental-cycles"></a>Добавочные циклы

После начального цикла все остальные циклы будут:

1. Запрашивает у исходной системы всех пользователей и все группы, которые были обновлены с момента сохранения последнего водяного знака.

2. Фильтрует полученных пользователей и группы с помощью настроенных [назначений](assign-user-or-group-access-portal.md) или [фильтров области на основе атрибутов](define-conditional-rules-for-provisioning-user-accounts.md).

3. При назначении пользователя или в области для подготовки служба запрашивает у целевой системы соответствующего пользователя, используя указанные [атрибуты сопоставления](customize-application-attributes.md#understanding-attribute-mapping-properties).

4. Если соответствующий пользователь не найден в целевой системе, он создается с использованием атрибутов, возвращенных исходной системой. После создания учетной записи пользователя Служба подготовки обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех последующих операций с этим пользователем.

5. Если найден соответствующий пользователь, он обновляется с использованием атрибутов, предоставляемых исходной системой. Если это новая назначенная учетная запись, служба подготовки обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех последующих операций с этим пользователем.

6. Если сопоставления атрибутов содержат атрибуты "Reference", служба выполняет дополнительные обновления в целевой системе для создания и связывания объектов, на которые имеются ссылки. Например, пользователь может использовать атрибут Manager в целевой системе, который связан с другим пользователем, созданным в целевой системе.

7. Если пользователь, который ранее находился в области для подготовки, удаляется из области, включая неназначенный, служба отключает пользователя в целевой системе через обновление.

8. Если пользователь, который ранее был в области для подготовки, отключается или обратимо удаляется в исходной системе, то служба отключает этого пользователя в целевой системе при обновлении.

9. Если пользователь, который ранее был в области для подготовки, необратимо удаляется в исходной системе, то служба удаляет этого пользователя в целевой системе. В Azure AD пользователи жестко удаляются через 30 дней после обратимого удаления.

10. Сохранить новый водяной знак в конце инкрементного цикла, который предоставляет начальную точку для последующих инкрементных циклов.

> [!NOTE]
> При необходимости можно отключить операции **создания**, **обновления**или **удаления** с помощью флажков " **действия целевого объекта** " в разделе " [сопоставления](customize-application-attributes.md) ". Логикой отключения пользователей во время обновления также управляет сопоставление атрибутов из поля, например accountEnabled.

Служба подготовки продолжит выполнять добавочные Циклические переходы в течение неограниченного времени с интервалами, определенными в [руководстве по каждому приложению](../saas-apps/tutorial-list.md). Добавочные циклы продолжаются до тех пор, пока не произойдет одно из следующих событий:

- Служба останавливается вручную с помощью портала Azure или соответствующей команды API Graph. 
- Новый начальный цикл активируется с помощью параметра **очистить состояние и перезапустить** в портал Azure или с помощью соответствующей команды API Graph. Это действие очищает любой сохраненный водяной знак и вызывает повторную оценку всех исходных объектов.
- Новый начальный цикл запускается из-за изменения сопоставлений атрибутов или фильтров области. Это действие также очищает любой сохраненный водяной знак и вызывает повторную оценку всех исходных объектов.
- Процесс подготовки переходит в карантин (см. ниже) из-за высокой частоты ошибок и остается в карантине более четырех недель. В этом случае служба будет автоматически отключена.

### <a name="errors-and-retries"></a>Ошибки и повторные попытки

Если ошибка в целевой системе не допустит добавления, обновления или удаления отдельного пользователя в целевой системе, операция будет повторена в следующем цикле синхронизации. Если операция с пользователем продолжает завершаться сбоем, то повторные попытки будут выполняться с меньшей частотой вплоть до одной попытки в день. Чтобы устранить ошибку, администраторы должны проверить [журналы подготовки](../reports-monitoring/concept-provisioning-logs.md?context=azure/active-directory/manage-apps/context/manage-apps-context) , чтобы определить основную причину и предпринять соответствующие действия. Ниже перечислены распространенные ошибки.

- Не заполнен атрибут пользователей в исходной системе, требуемый в целевой системе.
- Пользователи, имеющие значение атрибута в исходной системе, для которого существует ограничение уникальности в целевой системе, и одно и то же значение присутствует в другой записи пользователя.

Устраните эти сбои, изменив значения атрибутов для затронутого пользователя в исходной системе или настроив сопоставления атрибутов так, чтобы они не вызывали конфликтов.

### <a name="quarantine"></a>Карантин

Если большинство или все вызовы, выполненные для целевой системы, постоянно завершаются сбоем из-за ошибки (например, недопустимые учетные данные администратора), задание подготовки переходит в состояние "карантина". Это состояние указывается в [сводном отчете по подготовке](check-status-user-account-provisioning.md) и по электронной почте, если уведомления по электронной почте были настроены в портал Azure.

В карантине частота добавочных циклов постепенно сокращается до одного раза в день.

Задание подготовки завершает работу в карантине после устранения всех ошибочных ошибок и запуска следующего цикла синхронизации. Если задания подготовки остается в карантине более четырех недель, оно отключается. Дополнительные сведения о состоянии карантина см. [здесь](application-provisioning-quarantine-status.md).

### <a name="how-long-provisioning-takes"></a>Длительность подготовки

Производительность зависит от того, выполняет ли задание подготовки первоначальный цикл подготовки или добавочный цикл. Дополнительные сведения о том, как долго выполняется подготовка и как отслеживать состояние службы подготовки, см. [в разделе Проверка состояния подготовки пользователей](application-provisioning-when-will-provisioning-finish-specific-user.md).

### <a name="how-to-tell-if-users-are-being-provisioned-properly"></a>Как определить, правильно ли подготовлены пользователи

Все операции, выполняемые службой подготовки пользователей, записываются в [журналы подготовки Azure AD (Предварительная версия)](../reports-monitoring/concept-provisioning-logs.md?context=azure/active-directory/manage-apps/context/manage-apps-context). Журналы включают все операции чтения и записи, выполненные в исходной и целевой системах, а также данные пользователя, которые были считаны или записаны во время каждой операции. Дополнительные сведения о том, как читать журналы подготовки в портал Azure, см. в разделе [руководство по подготовке отчетов](check-status-user-account-provisioning.md).

## <a name="de-provisioning"></a>Отмена подготовки

Служба подготовки Azure AD обеспечивает синхронизацию исходной и целевой систем путем отмены подготовки учетных записей, когда у пользователей больше нет доступа. 

Служба подготовки Azure AD будет обратимо удалять пользователя в приложении, когда приложение сууппортс обратимое удаление (запрос на обновление с активными = false) и происходит любое из следующих событий:

* Учетная запись пользователя удалена в Azure AD.
*   Пользователь не назначен из приложения
*   Пользователь больше не соответствует фильтру области и выходит за пределы области
    * По умолчанию служба подготовки Azure AD обратимо удаляет или отключает пользователей, которые выходят за пределы области. Если вы хотите переопределить это поведение по умолчанию, можно установить флаг, чтобы [пропустить удаления вне области](skip-out-of-scope-deletions.md).
*   Свойство AccountEnabled имеет значение false.

Если происходит одно из указанных выше четырех событий и целевое приложение не поддерживает обратимое удаление, служба подготовки отправит запрос на удаление для окончательного удаления пользователя из приложения. 

через 30 дней после удаления пользователя в Azure AD он будет окончательно удален из клиента. На этом этапе Служба подготовки отправит запрос на удаление для окончательного удаления пользователя в приложении. В любое время в течение 30-дневного периода можно [вручную удалить пользователя](../fundamentals/active-directory-users-restore.md), что приведет к отправке запроса на удаление в приложение.

Если в сопоставлениях атрибутов отображается атрибут Иссофтделетед, он используется для определения состояния пользователя и отправки запроса на обновление с параметром Active = false для обратимого удаления пользователя. 

## <a name="next-steps"></a>Next Steps

[Планирование развертывания автоматической подготовки пользователей](plan-auto-user-provisioning.md)

[Настройка подготовки для приложения из коллекции](configure-automatic-user-provisioning-portal.md)

[Создание конечной точки SCIM и Настройка подготовки при создании собственного приложения](use-scim-to-provision-users-and-groups.md)

[Устранение неполадок при настройке и подготовке пользователей для приложения](application-provisioning-config-problem.md).
