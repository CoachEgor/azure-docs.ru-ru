---
title: Доступ к локальным API с помощью прокси приложения Azure AD
description: Прокси приложения Azure Active Directory позволяет безопасно получить доступ к API приложения в машинном коде и бизнес-логику, размещения в локальной или в облаке виртуальных машин.
services: active-directory
author: jeevanbisht
manager: mtillman
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.topic: conceptual
ms.date: 05/23/2019
ms.author: celested
ms.reviewer: japere
ms.openlocfilehash: 47f6678f8d18d734176d964f18a6febecea957ab
ms.sourcegitcommit: cababb51721f6ab6b61dda6d18345514f074fb2e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/04/2019
ms.locfileid: "66481419"
---
# <a name="secure-access-to-on-premises-apis-with-azure-ad-application-proxy"></a>Безопасный доступ к локальным API с помощью прокси приложения Azure AD

Вы, возможно, бизнес-логики API, запущенные в локальной или размещенных на виртуальных машинах в облаке. Собственные приложения Android, iOS, Mac или Windows должны взаимодействовать с конечными точками API для использования данных или обеспечивать взаимодействие с пользователем. Прокси приложения Azure AD и [Azure Active Directory проверки подлинности библиотек (ADAL)](/azure/active-directory/develop/active-directory-authentication-libraries) let, собственные приложения безопасного доступа к вашей локальных интерфейсов API. Прокси приложения с Azure Active Directory — это решение быстрее и надежнее, чем открыть порты брандмауэра и управления проверкой подлинности и авторизации на уровне приложения. 

В этой статье описывается настройка прокси приложения Azure AD решение для размещения службы веб-API с доступом к собственных приложений. 

## <a name="overview"></a>Обзор

В примере ниже показан стандартный способ публикации локальных интерфейсов API. Этот подход требует открытия входящие порты 80 и 443.

![Традиционные доступ через API](./media/application-proxy-secure-api-access/overview-publish-api-open-ports.png)

Следующая схема показывает, как можно использовать прокси приложения Azure AD безопасно публиковать интерфейсы API без необходимости открывать какие-либо входящие порты:

![Доступ к Azure AD приложение прокси-сервер API](./media/application-proxy-secure-api-access/overview-publish-api-app-proxy.png)

Прокси приложения Azure AD образует основу решения, должным образом общедоступную конечную точку для доступа к API и предоставления проверки подлинности и авторизации. API-интерфейсы доступны из множества платформ с помощью [ADAL](/azure/active-directory/develop/active-directory-authentication-libraries) библиотеки. 

Так как прокси приложения Azure AD проверки подлинности и авторизации построены на основе Azure AD, чтобы убедиться, что только доверенные устройства могут получить доступ к API, которые опубликованы через прокси приложения можно использовать условный доступ Azure AD. Используйте присоединения к Azure AD и присоединено к Azure AD гибридного для настольных компьютеров и управляемых Intune для устройств. Можно также воспользоваться преимуществами функций Azure Active Directory Premium, например многофакторную идентификацию Azure и машины обучения резервные безопасность [защиты идентификации Azure](/azure/active-directory/active-directory-identityprotection).

## <a name="prerequisites"></a>Технические условия

Для выполнения данного пошагового руководства, вам потребуется:

- Административный доступ к каталогу Azure, под учетной записью, можно создавать и регистрировать приложения
- Пример веб-API и собственных клиентских приложений из [https://github.com/jeevanbisht/API-NativeApp-ADAL-SampleApp](https://github.com/jeevanbisht/API-NativeApp-ADAL-SampleApp) 

## <a name="publish-the-api-through-application-proxy"></a>Публикация API через прокси приложения

Чтобы опубликовать API за пределами интрасети через прокси приложения, выполните тот же шаблон, что и для публикации веб-приложений. Дополнительные сведения см. в статье [Руководство. Добавление локального приложения для удаленного доступа через прокси приложения в Azure Active Directory](application-proxy-add-on-premises-application.md).

Чтобы опубликовать SecretAPI веб-API через прокси приложения:

1. Создайте и опубликуйте SecretAPI пример проекта как веб-приложение ASP.NET на локальном компьютере или в интрасети. Убедитесь, что вы можете получить доступ к веб-приложение локально. 
   
1. В [портала Azure](https://portal.azure.com)выберите **Azure Active Directory** в области навигации слева. Затем на **Обзор** выберите **корпоративные приложения**.
   
1. В верхней части **корпоративные приложения — все приложения** выберите **новое приложение**.
   
1. На **добавить приложение** раздела **Добавление собственного приложения**выберите **локальное приложение**. 
   
1. Если у вас установлен соединитель прокси приложения, вам будет предложено установить его. Выберите **скачивание соединителя прокси приложения** для загрузки и установки соединителя. 
   
1. После установки соединителя прокси приложения, на **Добавление собственного приложения в локальной** страницы:
   
   1. Введите *SecretAPI* рядом с полем **имя**.
      
   1. Введите URL-адрес для доступа к API-интерфейса из интрасети, рядом с полем **внутренний URL-адрес**. 
      
   1. Убедитесь, что **предварительной проверки подлинности** присваивается **Azure Active Directory**. 
      
   1. Выберите **добавить** в верхней части страницы, а ожидания для создаваемого приложения.
   
   ![Добавление приложения API](./media/application-proxy-secure-api-access/3-add-api-app.png)
   
1. На **корпоративные приложения — все приложения** выберите **SecretAPI** приложения. 
   
1. На **SecretAPI - Обзор** выберите **свойства** в области навигации слева.
   
1. Вы не хотите API, доступные для конечных пользователей в **MyApps** панели, поэтому **видно пользователям** для **нет** в нижней части **свойства**странице, а затем выберите **Сохранить**.
   
   ![Не отображается для пользователей](./media/application-proxy-secure-api-access/5-not-visible-to-users.png)
   
Вы опубликовали веб-API через прокси приложения Azure AD. Теперь добавьте пользователей, которым разрешен доступ к приложению. 

1. На **SecretAPI - Обзор** выберите **пользователей и групп** в области навигации слева.
   
1. На **пользователей и групп** выберите **добавить пользователя**.  
   
1. На **добавить назначение** выберите **пользователей и групп**. 
   
1. На **пользователей и групп** странице, найдите и выберите пользователей, которым разрешен доступ к приложения, включая по крайней мере самостоятельно. После выбора всех пользователей, выберите **выберите**. 
   
   ![Выберите и назначьте пользователя](./media/application-proxy-secure-api-access/7-select-admin-user.png)
   
1. Вернитесь на **Добавление назначения** выберите **назначить**. 

> [!NOTE]
> Интерфейсы API, использующие встроенную проверку подлинности Windows может потребоваться [дополнительные действия](/azure/active-directory/manage-apps/application-proxy-configure-single-sign-on-with-kcd).

## <a name="register-the-native-app-and-grant-access-to-the-api"></a>Зарегистрировать собственное приложение и предоставить доступ к API

Собственные приложения — это программы, разработанные для использования на определенной платформе или устройстве. Прежде чем ваше собственное приложение может подключиться и получить доступ к API, необходимо зарегистрировать его в Azure AD. Ниже показано, как зарегистрировать собственное приложение и предоставить ему доступ к веб-API, которые опубликованы через прокси приложения.

Чтобы зарегистрировать собственное приложение AppProxyNativeAppSample:

1. В Azure Active Directory **Обзор** выберите **регистрация приложений**и в верхней части **регистрация приложений** области выберите **Регистрация нового** .
   
1. На **зарегистрировать приложение** страницы:
   
   1. В разделе **имя**, введите *AppProxyNativeAppSample*. 
      
   1. В разделе **Поддерживаемые типы учетных записей** выберите **Accounts in any organizational directory and personal Microsoft accounts** (Учетные записи в любом каталоге организации и личные учетные записи Майкрософт). 
      
   1. В разделе **URL-адрес перенаправления**, раскрывающийся список и выберите **общедоступным клиентом (классические и мобильные)** , а затем введите *https:\//appproxynativeapp*. 
      
   1. Выберите **зарегистрировать**и подождите, пока приложение будет успешно зарегистрирован. 
      
      ![Регистрация нового приложения](./media/application-proxy-secure-api-access/8-create-reg-ga.png)
   
Теперь вы зарегистрировали приложение AppProxyNativeAppSample в Azure Active Directory. Чтобы предоставить собственное приложение доступ к SecretAPI веб-API:

1. В Azure Active Directory **Обзор** > **регистрация приложений** выберите **AppProxyNativeAppSample** приложения. 
   
1. На **AppProxyNativeAppSample** выберите **разрешения API** в области навигации слева. 
   
1. На **разрешения API** выберите **добавить разрешение**.
   
1. На первом **разрешения запроса API** выберите **API, организации** вкладке, а затем найдите и выберите **SecretAPI**. 
   
1. На следующем **разрешения запроса API** странице, установите флажок рядом с полем **user_impersonation**и выберите **добавить разрешения**. 
   
    ![Выбор API](./media/application-proxy-secure-api-access/10-secretapi-added.png)
   
1. Вернитесь на **разрешения API** страницы, можно выбрать **предоставления согласия администратора Contoso** во избежание других пользователей от необходимости отдельно предоставить согласие на его. 

## <a name="configure-the-native-app-code"></a>Настройте код собственного приложения

Последним шагом является настройка собственного приложения. Следующий фрагмент кода из *Form1.cs* файл в примере приложения NativeClient вызывает библиотеку ADAL для получения маркера для запроса в вызове API и добавления его в качестве носителя в заголовке приложения. 
   
   ```csharp
       AuthenticationResult result = null;
       HttpClient httpClient = new HttpClient();
       authContext = new AuthenticationContext(authority);
       result = await authContext.AcquireTokenAsync(todoListResourceId, clientId, redirectUri, new PlatformParameters(PromptBehavior.Auto));
       
       // Append the token as bearer in the request header.
       httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", result.AccessToken);
       
       // Call the API.
       HttpResponseMessage response = await httpClient.GetAsync(todoListBaseAddress + "/api/values/4");
   
       // MessageBox.Show(response.RequestMessage.ToString());
       string s = await response.Content.ReadAsStringAsync();
       MessageBox.Show(s);
   ```
   
Чтобы настроить собственное приложение для подключения к Azure Active Directory и вызова прокси приложения API, замените значения заполнителей в *App.config* файла примера приложения NativeClient значениями из Azure AD: 

- Вставить **каталог (клиент) идентификатор** в `<add key="ida:Tenant" value="" />` поля. Можно найти и скопировать это значение (GUID) из **Обзор** странице приложений. 
  
- Вставьте AppProxyNativeAppSample **идентификатор приложения (клиент)** в `<add key="ida:ClientId" value="" />` поля. Можно найти и скопировать это значение (GUID) из AppProxyNativeAppSample **Обзор** страницы.
  
- Вставьте AppProxyNativeAppSample **URI перенаправления** в `<add key="ida:RedirectUri" value="" />` поля. Можно найти и скопировать это значение (URI) из AppProxyNativeAppSample **проверки подлинности** страницы. 
  
- Вставьте SecretAPI **URI идентификатора приложения** в `<add key="todo:TodoListResourceId" value="" />` поля. Можно найти и скопировать это значение (URI) из SecretAPI **предоставляют API** страницы.
  
- Вставьте SecretAPI **URL-адрес домашней страницы** в `<add key="todo:TodoListBaseAddress" value="" />` поля. Можно найти и скопировать это значение (URL-адрес) из SecretAPI **фирменной символики** страницы.

После настройки параметров, построение и запуск собственного приложения. При выборе **Sign In** кнопка, приложение позволяет войти в, а затем отображает экран успешного, чтобы убедиться, что он успешно подключена к SecretAPI.

![Успешно](./media/application-proxy-secure-api-access/success.png)

## <a name="next-steps"></a>Дальнейшие действия

- [Учебник. Добавление локального приложения для удаленного доступа через прокси приложения в Azure Active Directory](application-proxy-add-on-premises-application.md)
- [Краткое руководство Настройка клиентского приложения для доступа к веб-API](../develop/quickstart-configure-app-access-web-apis.md)
- [Как включить собственные клиентские приложения для взаимодействия с приложениями прокси](application-proxy-configure-native-client-application.md)
