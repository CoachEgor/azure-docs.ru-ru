---
title: Перемещение аутентификации приложений из AD FS в Active Directory Azure
description: Цель этой статьи — предоставить организациям сведения о перемещении локальных приложений в Azure AD, уделив особое внимание федеративным приложениям SaaS.
services: active-directory
author: barbaraselden
manager: CelesteDG
ms.service: active-directory
ms.subservice: app-mgmt
ms.topic: conceptual
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.date: 04/01/2020
ms.author: baselden
ms.collection: M365-identity-device-management
ms.openlocfilehash: bcb39606cdbb6488ccdee2828029d3617d689508
ms.sourcegitcommit: df8b2c04ae4fc466b9875c7a2520da14beace222
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2020
ms.locfileid: "80892122"
---
# <a name="moving-application-authentication-from-active-directory-federation-services-to-azure-active-directory"></a>Перемещение аутентификации приложений из службы Active Directory Federation в Active Directory

[Azure Active Directory (Azure AD)](https://docs.microsoft.com/azure/active-directory/fundamentals/active-directory-whatis) предлагает универсальную платформу идентификации, которая предоставляет вашим людям, партнерам и клиентам единую идентификацию для доступа к приложениям и совместной работы с любой платформы и устройства. Azure AD имеет [полный набор возможностей управления идентификацией.](https://docs.microsoft.com/azure/active-directory/fundamentals/active-directory-whatis) Стандартизация аутентификации и авторизации приложения (приложения) в Azure AD позволяет использовать преимущества этих возможностей. 

> [!NOTE]
> В этой статье основное внимание уделяется перемещению аутентификации приложений из службы ожидания в функциональном каталоге и в службу федерации активного каталога в Azure AD. Ознакомьтесь с публикацией [проверки подлинности приложения «Мигрирующая» в Azure AD](https://aka.ms/migrateapps/whitepaper) для получения обзора планирования этого шага. В «Белой книге» обсуждается, как планировать миграцию, тестирование и идеи.

## <a name="introduction"></a>Введение

Если у вас есть предприимчивый каталог, содержащий учетные записи пользователей, у вас, вероятно, есть много приложений, которые пользователи аутентифицируют. Каждое из этих приложений настроено для пользователей, чтобы получить доступ с помощью их идентификаторов. 


Пользователи также могут проверить подлинность непосредственно с помощью вашего наемного Active Directory. Активные службы Федерации каталогов (AD FS) — это стандарт, основанный на предпосылок идентификационных данных. AD FS расширяет возможности использования функции единого ввоза (SSO) между доверенными деловыми партнерами, не требуя от пользователей входе отдельно к каждому приложению. Это известно как Федерация.

Во многих организациях есть приложения Software as a Service (SaaS) или пользовательские приложения Line-of-Business (LOB), используемые непосредственно в AD FS, наряду с приложениями Office 365 и Azure AD. 

![Приложения, подключенные непосредственно на месте](media/migrate-adfs-apps-to-azure/app-integration-before-migration1.png)

**Чтобы повысить безопасность приложений, ваша цель состоит в том, чтобы иметь единый набор элементов управления доступом и политик в ваших местных и облачных средах.** 

![Приложения, подключенные через Azure AD](media/migrate-adfs-apps-to-azure/app-integration-after-migration1.png)



## <a name="types-of-apps-to-migrate"></a>Типы приложений для миграции

Миграция всей аутентификации приложения в Azure AD является оптимальной, так как она дает вам единую плоскость управления идентификацией и управлением доступом.

Для проверки подлинности приложения могут использовать современные или устаревшие протоколы. Рассмотрим первые мигрирующие приложения, которые используют современные протоколы аутентификации (такие как SAML и Open ID Connect). Эти приложения могут быть перенастроены для проверки подлинности с помощью Azure AD либо через встроенный разъем в нашей галерее приложений, либо путем регистрации приложения в Azure AD. Приложения, использующие старые протоколы, могут быть интегрированы с помощью [приложения Proxy.](https://docs.microsoft.com/azure/active-directory/manage-apps/what-is-application-proxy) 

Для получения дополнительной информации см., [какие типы приложений можно интегрировать с Azure AD?](https://docs.microsoft.com/azure/active-directory/manage-apps/what-is-application-management)

Отчет о деятельности приложения AD FS можно использовать [для переноса приложений в Azure AD,](https://docs.microsoft.com/azure/active-directory/manage-apps/migrate-adfs-application-activity) если у вас [есть возможность health AD Connect.](https://docs.microsoft.com/azure/active-directory/hybrid/how-to-connect-health-adfs) 

### <a name="the-migration-process"></a>Процесс миграции

В процессе перемещения аутентификации приложения в Azure AD, адекватно протестируйте приложения и конфигурацию. Мы рекомендуем продолжать использовать существующие тестовые среды для перехода к тестированию миграции в производственную среду. Если тестовая среда в настоящее время недоступна, можно настроить ее с помощью [службы приложений Azure](https://azure.microsoft.com/services/app-service/) или [виртуальных машин Azure](https://azure.microsoft.com/free/virtual-machines/search/?OCID=AID2000128_SEM_lHAVAxZC&MarinID=lHAVAxZC_79233574796345_azure%20virtual%20machines_be_c__1267736956991399_kwd-79233582895903%3Aloc-190&lnkd=Bing_Azure_Brand&msclkid=df6ac75ba7b612854c4299397f6ab5b0&ef_id=XmAptQAAAJXRb3S4%3A20200306231230%3As&dclid=CjkKEQiAhojzBRDg5ZfomsvdiaABEiQABCU7XjfdCUtsl-Abe1RAtAT35kOyI5YKzpxRD6eJS2NM97zw_wcB)в зависимости от архитектуры приложения.

При разработке конфигураций приложений можно настроить отдельный тестовый ad-натворец Azure AD. 

Процесс миграции может выглядеть следующим образом:

**Этап 1 - Текущее состояние: Проверка подлинности производственного приложения с помощью AD FS**

![Миграция этап 1 ](media/migrate-adfs-apps-to-azure/stage1.jpg)

 
**Этап 2 - OPTIONAL: Тестовый экземпляр приложения, указывающий на тестирование арендатора Azure**

Обновите конфигурацию, чтобы указать тестовый экземпляр приложения на тестовый ad-наниматель Azure AD, и внедьте все необходимые изменения. Приложение может быть протестировано с пользователями в тесте AUre AD-арендатора. В процессе разработки можно использовать такие инструменты, как [Fiddler](https://www.telerik.com/fiddler) для сравнения и проверки запросов и ответов.

Если настройка отдельного тест-арендатора невозможна, пропустите этот этап и встаньте в тестовом экземпляре приложения и направьте его на ваш производственный AD-арендатор, как описано на этапе 3 ниже.

![Миграционный этап 2 ](media/migrate-adfs-apps-to-azure/stage2.jpg)

**Этап 3 - Тест-приложение, указывавщее на арендатора производства Azure**

Обновите конфигурацию, чтобы указать тестовый экземпляр приложения на производственный экземпляр Azure. Теперь вы можете тестировать с пользователями в экземпляре производства. При необходимости просмотрите раздел этой статьи о переходных пользователях.

![Миграция этап 3 ](media/migrate-adfs-apps-to-azure/stage3.jpg)

**Этап 4 - Производство приложение, указывая на производство AD арендатора**

Обновите конфигурацию производственного приложения, чтобы указать на арендатора производственной Azure.

![Миграция этап 1 ](media/migrate-adfs-apps-to-azure/stage4.jpg)

 Приложения, которые аутентифицировать с AD FS могут использовать группы Active Directory для получения разрешений. Используйте [синхронизацию Azure AD Connect](https://docs.microsoft.com/azure/active-directory/hybrid/how-to-connect-sync-whatis) для синхронизации идентификационных данных между предварительной средой и Azure AD перед началом миграции. Проверить эти группы и членство до миграции, так что вы можете предоставить доступ к тем же пользователям, когда приложение мигрировало.

### <a name="line-of-business-lob-apps"></a>Бизнес-приложения (LOB)

LOB-приложения разрабатываются организацией внутри организации или доступны в качестве стандартного упакованного продукта, установленного в центре обработки данных. Примеры включают приложения, построенные на Windows Identity Foundation и приложениях SharePoint (не SharePoint Online). 

Lob-приложения, которые используют OAuth 2.0, OpenID Connect или WS-Federation, могут быть интегрированы с Azure AD в качестве [регистрации приложений.](https://docs.microsoft.com/azure/active-directory/develop/app-registrations-training-guide-for-app-registrations-legacy-users) Интегрируйте пользовательские приложения, которые используют SAML 2.0 или WS-Federation в качестве [негалерейных приложений](https://docs.microsoft.com/azure/active-directory/manage-apps/add-non-gallery-app) на странице корпоративных приложений на [портале Azure.](https://portal.azure.com/)

## <a name="saml-based-single-sign-on"></a>SAML на основе одного знака-On

Приложения, которые используют SAML 2.0 для проверки подлинности, могут быть настроены для [ОДНОГО знака на основе SAML](https://docs.microsoft.com/azure/active-directory/manage-apps/what-is-single-sign-on) (SAML-sSO). С [помощью SamL-SSO](https://docs.microsoft.com/azure/active-directory/manage-apps/what-is-single-sign-on)вы можете сопоставить пользователей с определенными ролями приложений на основе правил, которые вы определяете в своих претензиях SAML. 

Чтобы настроить приложение SaaS для ОДНОГО знака на основе SAML, [см.](https://docs.microsoft.com/azure/active-directory/manage-apps/configure-single-sign-on-non-gallery-applications) 

![SSO SAML Пользовательские скриншоты ](media/migrate-adfs-apps-to-azure/sso-saml-user-attributes-claims.png)

 
Многие приложения SaaS имеют учебник по [конкретному применению,](https://docs.microsoft.com/azure/active-directory/saas-apps/tutorial-list) который проходит через конфигурацию для SAML-однократного входного знака.

![приложение учебник](media/migrate-adfs-apps-to-azure/app-tutorial.png)

Некоторые приложения можно переместить без проблем. Приложениям с более комплексными требованиями, например пользовательскими утверждениями, может потребоваться дополнительная настройка в Azure AD или Azure AD Connect. Для получения информации об поддерживаемых отображениях претензий [см.](https://docs.microsoft.com/azure/active-directory/develop/active-directory-claims-mapping)

Имейте в виду следующие ограничения при отображении атрибутов:

* Не все атрибуты, которые могут быть выпущены в AD FS, будут отображаться в Azure AD в качестве атрибутов для испускаемых токенов SAML, даже если эти атрибуты синхронизированы. При речировании атрибута список выпадения значений покажет вам различные атрибуты, доступные в Azure AD. Проверьте конфигурацию [синхронизации Azure AD Connect,](https://docs.microsoft.com/azure/active-directory/hybrid/how-to-connect-sync-whatis) чтобы убедиться, что требуемый атрибут, например samAccountName, синхронизируется с Azure AD. Атрибуты расширения можно использовать для испускания любых утверждений, которые не являются частью стандартной схемы пользователя в Azure AD.

* В большинстве случаев приложению требуются только утверждение NameId и другие распространенные утверждения идентификатора пользователя. Чтобы определить, требуются ли дополнительные претензии, изучите, какие претензии вы выдаете aD FS.

* Не все претензии могут быть проблемами, так как некоторые претензии защищены в Azure AD. 

* Возможность использования зашифрованных токенов SAML в настоящее время в предварительном просмотре. [Узнайте, как: настроить требования, выданные в токене SAML для корпоративных приложений.](https://docs.microsoft.com/azure/active-directory/develop/active-directory-saml-claims-customization)

 

### <a name="software-as-a-service-saas-apps"></a>Программное обеспечение как сервисные приложения (SaaS)

Если пользователь впишется в приложения SaaS, такие как Salesforce, ServiceNow или Workday, и интегрирован с AD FS, вы используете федеративные подписи для приложений SaaS. 

Большинство приложений SaaS уже можно настроить в Azure AD. Корпорация Майкрософт имеет много преднастроенных подключений к приложениям SaaS в [галерее приложений Azure AD,](https://azuremarketplace.microsoft.com/marketplace/apps/category/azure-active-directory-apps)что упростит ваш переход. Приложения SAML 2.0 могут быть интегрированы с Azure AD через галерею приложений Azure AD или как [негалерейные приложения.](https://docs.microsoft.com/azure/active-directory/manage-apps/add-non-gallery-app) 

Приложения, которые используют OAuth 2.0 или OpenID Connect, могут быть интегрированы с Azure AD так же, как [и регистрация приложений.](https://docs.microsoft.com/azure/active-directory/develop/app-registrations-training-guide-for-app-registrations-legacy-users) Приложения, которые используют устаревшие протоколы, могут использовать [прокси-сервер Azure AD для](https://docs.microsoft.com/azure/active-directory/manage-apps/application-proxy) проверки подлинности с помощью Azure AD.

Для любых проблем с посадкой в приложенияS SaaS вы можете связаться с [псевдонимом SaaS Application Integration.](mailto:SaaSApplicationIntegrations@service.microsoft.com)

**Сертификаты подписи SAML для SSO:** Подписание сертификатов являются важной частью любого развертывания SSO. Azure AD создает сертификаты подписи для создания Federated SSO на основе SAML для ваших приложений SaaS. Как только вы добавите приложения галереи или негалереи, вы наверстируете добавленное приложение с помощью федеративного варианта SSO. Смотрите [сертификаты Управления для федеративного единого ввоза в Active Directory Azure.](https://docs.microsoft.com/azure/active-directory/manage-apps/manage-certificates-for-federated-single-sign-on)

### <a name="apps-and-configurations-that-can-be-moved-today"></a>Приложения и конфигурации, которые могут быть перемещены сегодня

Приложения, которые вы можете легко перемещать сегодня включают SAML 2.0 приложения, которые используют стандартный набор элементов конфигурации и претензий:

* Имя участника-пользователя

* Адрес электронной почты

* Имя

* Surname

* Альтернативный атрибут, такой как **NameID** SAML, включая атрибуты электронной почты Azure AD, префикса электронной почты, идентификатор сотрудника и расширения 1–15, или локальный атрибут **SamAccountName**. Дополнительные сведения см. в статье [Настройка утверждений, выпущенных в токене SAML для корпоративных приложений в Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/active-directory-saml-claims-customization).

* Пользовательские утверждения.

Следующие шаги конфигурации требуют перехода в Azure AD:

* Пользовательские авторизации или многофакторной аутентификации (MFA) правила в AD FS. Их настроить с помощью функции [условного доступа Azure AD.](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-azure-portal)

* Приложения с несколькими конечными точками URL-адреса ответов. Вы настраиваете их в Azure AD с помощью PowerShell или в интерфейсе портала Azure.

* Приложения WS-Federation, например приложения SharePoint, которым требуются токены SAML версии 1.1. Вы можете настроить их вручную с помощью PowerShell. Вы также можете добавить предварительно интегрированный общий шаблон для приложений SharePoint и SAML 1.1 из галереи. Мы поддерживаем протокол SAML 2.0.

* Комплексная выдача требований преобразует правила. Для получения информации об поддерживаемых отображениях претензий см.:
   *  [Сопоставление утверждений в Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/active-directory-claims-mapping) 
   * [Настройка утверждений, выпущенных в токене SAML для корпоративных приложений в Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/active-directory-saml-claims-customization)

 

### <a name="apps-and-configurations-not-supported-in-azure-ad-today"></a>Приложения и конфигурации, неподдерживаемые в Azure AD на сегодняшний день

Приложения, требующие следующих возможностей, не могут быть перенесены сегодня.

**Возможности протокола**

* Поддержка шаблона WS-Trust ActAs

* Разрешение артефактов SAML.

* Проверка подписи подписанных запросов SAML  
Обратите внимание, что подписанные запросы принимаются, но подпись не проверяется.  
Учитывая, что Azure AD вернет токен только конечным точкам, предварительно настроенным в приложении, проверка подписи в большинстве случаев скорее всего не требуется.

**Претензии в возможностях токенов**

* Претензии от атрибутов магазинов, помимо каталога Azure AD, если эти данные не синхронизированы с Azure AD. Для получения дополнительной информации смотрите [обзор API синхронизации API Azure AD.](https://docs.microsoft.com/graph/api/resources/synchronization-overview?view=graph-rest-beta)

* Выдача атрибутов мульти-стоимости каталога. Например, в настоящее время мы не можем выдавать многоценную претензию по прокси-адресам.

## <a name="map-app-settings-from-ad-fs-to-azure-ad"></a>Настройки приложения карты от AD FS до Azure AD

Перемещение начинается с оценки настройки приложения в локальной среде и сопоставления этой конфигурации с Azure AD. AD FS и Azure AD работают одинаково, поэтому в обоих случаях применяются понятия настройки URL-адресов доверия, ввоза и регистрации. Задокументируйте настройки конфигурации DD FS ваших приложений, чтобы можно было легко настроить их в Azure AD.

### <a name="map-app-configuration-settings"></a>Настройки конфигурации приложения карты

В следующей таблице описаны некоторые из наиболее распространенных отображений параметров между AD FS Relying Party Trust to Azure AD Enterprise Application:

* AD FS - Найти настройки в AD FS Опираясь партии доверия для приложения. Нажмите правой кнопкой полагаться на сторону и выбрать Свойства. 

* Azure AD — Настройка настраивается на [портал Azure](https://portal.azure.com/) в свойствах единого входного знака каждого приложения.

| Параметр конфигурации| AD FS| Как настроить в Azure AD| Токен SAML |
| - | - | - | - |
| **URL-адрес входа приложения** <p>URL-адрес пользователя для вхлечения в приложение в потоке SAML,по инициативе поставщика услуг (SP).| Недоступно| Открытая базовая конфигурация SAML от samL на основе| Недоступно |
| **URL-адрес ответа приложения** <p>URL-адрес приложения с точки зрения поставщика идентификационных данных (IdP). IdP отправляет пользователя и маркер здесь после того, как пользователь вписался в IdP.  Это также известно как **SAML утверждение потребительской конечной точки**.| Выберите вкладку **Endpoints**| Открытая базовая конфигурация SAML от samL на основе| Элемент назначения в токене SAML. Пример значения:[https://contoso.my.salesforce.com](https://contoso.my.salesforce.com/) |
| **URL-адрес выхода приложения** <p>Это URL, на который отправляются запросы на очистку от знаков, когда пользователь выходит из приложения. IdP отправляет запрос на выход пользователя из всех других приложений.| Выберите вкладку **Endpoints**| Открытая базовая конфигурация SAML от samL на основе| Недоступно |
| **Идентификатор приложения** <p>Это идентификатор приложения с точки зрения IdP. Значение URL-адресов регистрации часто используется для идентификатора (но не всегда).  Иногда приложение называет это "идентификатором сущности".| Выберите вкладку **«Идентификаторы»**|Открытая базовая конфигурация SAML от samL на основе| Карты элемента **аудитории** в токене SAML. |
| **Метаданные Федерации приложений** <p>Это расположение метаданных федерации приложения. Поставщик удостоверений использует его для автоматического обновления определенных настроек конфигурации, например конечных точек или сертификатов шифрования.| Выберите вкладку **Мониторинг**| Недоступно Azure AD не поддерживает метаданные федерации приложений напрямую. Метаданные федерации можно вручную импортировать.| Недоступно |
| **Идентификатор пользователя/ идентификатор имени** <p>Атрибут для уникального определения идентификатора пользователя из Azure AD или AD FS при входе в приложение.  Этот атрибут, как правило, либо UPN или адрес электронной почты пользователя.| Правила претензии. В большинстве случаев правило претензии выдает претензию с типом, который заканчивается NameIdentifier.| Вы можете найти идентификатор под заголовком **Атрибуты и претензии пользователя.** По умолчанию используется UPN| Карты элемента **NameID** в токене SAML. |
| **Другие претензии** <p>Примеры другой информации о претензиях, обычно отправляемых из IdP в приложение, включают имя, фамилию, адрес электронной почты и членство в группе.| В AD FS этот элемент может представлять собой другие правила утверждения проверяющей стороны.| Вы можете найти идентификатор под заголовком **Атрибуты пользователя & претензий.** Выберите **Просмотр** и измените все другие атрибуты пользователя.| Недоступно |


### <a name="map-identity-provider-idp-settings"></a>Настройки поставщика идентификационных данных map (IdP)

Наверскакните приложения, чтобы указать на Azure AD по сравнению с AD FS для SSO. Здесь мы сосредоточимся на приложениях SaaS, которые используют протокол SAML. Тем не менее, эта концепция распространяется на пользовательские приложения LOB, а также.

> [!NOTE]
> Значения конфигурации для Azure AD следуют шаблону, при котором идентификатор арендатора Azure заменяет «tenant-id», а идентификатор приложения заменяет «application-id». Эту информацию можно найти на [портале Azure](https://portal.azure.com/) в > свойств: 

* Выберите идентификатор каталога, чтобы просмотреть идентификатор арендатора. 

* Выберите идентификатор приложения, чтобы просмотреть идентификатор приложения.

 На высоком уровне нанеси карту следующих ключевых элементов конфигурации приложений SaaS в Azure AD. 

 

| Элемент| Значение конфигурации |
| - | - |
| Эмитент поставщика идентификационных данных| [https://sts.windows.net/{tenant-id}/](https://sts.windows.net/{tenant-id}/) |
| URL-адрес поставщика идентификационных данных| [https://login.microsoftonline.com/{tenant-id}/saml2](https://login.microsoftonline.com/{tenant-id}/saml2) |
| URL-адрес поставщика идентификационных данных| [https://login.microsoftonline.com/{tenant-id}/saml2](https://login.microsoftonline.com/{tenant-id}/saml2) |
| Расположение метаданных Федерации| [https://login.windows.net/{tenant-id}/federationmetadata/2007-06/federationmetadata.xml?appid={application-id}](https://login.windows.net/{tenant-id}/federationmetadata/2007-06/federationmetadata.xml?appid={application-id}) |


### <a name="map-sso-settings-for-saas-apps"></a>Настройки Карты SSO для приложений SaaS

ПриложенияМ SaaS необходимо знать, куда отправлять запросы на аутентификацию и как проверить полученные токены. В следующей таблице описаны элементы для настройки настроек SSO в приложении, а также их значения или местоположения в AD FS и Azure AD

| Параметр конфигурации| AD FS| Как настроить в Azure AD |
| - | - | - |
| **IDP Войти на URL** <p>Войдите в систему URL-адреса IdP с точки зрения приложения (где пользователь перенаправляется для входа).| URL-адрес AD FS — это имя службы федерации AD FS, за которым следует «/adfs/ls/». <p>Например:[https://fs.contoso.com/adfs/ls/](https://fs.contoso.com/adfs/ls/)| Замените «арендатор-идентификатор» идентификатором арендатора. <p> Для приложений, использовававававаемых протоколом SAML-P:[https://login.microsoftonline.com/{tenant-id}/saml2](https://login.microsoftonline.com/{tenant-id}/saml2) <p>Для приложений, использовававававаемых протоколом WS-Federation:[https://login.microsoftonline.com/{tenant-id}/wsfed](https://login.microsoftonline.com/{tenant-id}/wsfed) |
| **URL-адрес регистрации IdP**<p>Подпишите URL-адрес IdP с точки зрения приложения (где пользователь перенаправляется, когда он решит выйти из приложения).| URL-адрес регистрации либо совпадает с URL-адресом, либо тот же URL с придатковой надписью "wa'wsignout1.0". Например:[https://fs.contoso.com/adfs/ls/?wa=wsignout1.0](https://fs.contoso.com/adfs/ls/?wa=wsignout1.0)| Замените «арендатор-идентификатор» идентификатором арендатора.<p>Для приложений, использовававававаемых протоколом SAML-P:<p>[https://login.microsoftonline.com/{tenant-id}/saml2](https://login.microsoftonline.com/{tenant-id}/saml2) <p> Для приложений, использовававававаемых протоколом WS-Federation:[https://login.microsoftonline.com/common/wsfederation?wa=wsignout1.0](https://login.microsoftonline.com/common/wsfederation?wa=wsignout1.0) |
| **Сертификат для подписи маркера**<p>IdP использует закрытый ключ сертификата для подписи выданных токенов. Он проверяет, поступил ли токен от того же поставщика удостоверений, с которым у приложения настроено отношение доверия.| Сертификат для подписи маркера AD FS находится в управлении AD FS в разделе **Сертификаты**.| Найдите его на портале Azure в **едином подписном свойствах** приложения под **заголовком SAML Signing Certificate.** Здесь можно загрузить сертификат для передачи приложению.  <p>Если в приложении более одного сертификата, можно найти все сертификаты в файле метаданных Федерации XML. |
| **Идентификатор/ "эмитент"**<p>Идентификатор IdP с точки зрения приложения (иногда называемый "идентификатор эмитента").<p>В токене SAML значение отображается как элемент эмитента.| Идентификатор для AD FS, как правило, идентификатор службы федерации в AD FS управления **под службой > Edit Federation Service Properties**. Например:[http://fs.contoso.com/adfs/services/trust](http://fs.contoso.com/adfs/services/trust)| Замените «арендатор-идентификатор» идентификатором арендатора.<p>[https://sts.windows.net/{tenant-id}/](https://sts.windows.net/{tenant-id}/) |
| **Метаданные Федерации ИДП**<p>Расположение общедоступных метаданных федерации IdP. (Некоторые приложения используют метаданные федерации как альтернативу отдельной настройке администратора URL-адресов, идентификатору и сертификату для подписи маркера.)| Найдите URL метаданных федерации AD FS в AD FS Management в рамках **> конечных точек службы > типа Metadata >: Метаданные Федерации.** Например:[https://fs.contoso.com/FederationMetadata/2007-06/FederationMetadata.xml](https://fs.contoso.com/FederationMetadata/2007-06/FederationMetadata.xml)| Соответствующее значение для Azure AD [https://login.microsoftonline.com/{TenantDomainName}/FederationMetadata/2007-06/FederationMetadata.xml](https://login.microsoftonline.com/{TenantDomainName}/FederationMetadata/2007-06/FederationMetadata.xml)следует шаблону. Замените «TenantDomainName» на имя вашего арендатора в формате «contoso.onmicrosoft.com».   <p>Дополнительные сведения см. в статье [Метаданные федерации](https://docs.microsoft.com/azure/active-directory/azuread-dev/azure-ad-federation-metadata). |


## <a name="represent-ad-fs-security-policies-in-azure-ad"></a>Представление политик безопасности AD FS в Azure AD

При перемещении аутентификации приложения в Azure AD создавайте отображения из существующих политик безопасности в эквивалентные или альтернативные варианты, доступные в Azure AD. Обеспечение того, чтобы эти отображения могли быть выполнены при соблюдении стандартов безопасности, требуемых владельцами приложений, значительно упростит миграцию остальных приложений.

Для каждого типа правил и его примеров мы предлагаем, как это правило выглядит в AD FS, эквивалентном языке AD FS и как эта карта в Azure AD.

### <a name="map-authorization-rules"></a>Правила авторизации карты

Ниже приведены примеры типов правил авторизации в AD FS и способих их отображения в Azure AD:

#### <a name="example-1-permit-access-to-all-users"></a>Пример 1: Разрешить доступ всем пользователям

Разрешить доступ ко всем пользователям выглядит как в AD FS: 

![Миграция этап 1 ](media/migrate-adfs-apps-to-azure/sso-saml-user-attributes-claims.png)


Это карты для Azure AD в одном из следующих способов:

На [портале Azure](https://portal.azure.com/):
* Вариант 1: Установить назначение пользователя, необходимое для no ![отодвить политику управления доступом для приложений SaaS ](media/migrate-adfs-apps-to-azure/permit-access-to-all-users-2.png)

    Обратите внимание, что для установки назначения пользователя требуется переключение на Yes, необходимо, чтобы пользователи были назначены приложению для получения доступа. При установке на Нет, все пользователи имеют доступ. Этот переключатель не контролирует то, что показывает для пользователей в моем опыте приложений. 

 
* Вариант 2: В вкладке пользователей и групп присвоите приложение автоматической группе "Все пользователи". <p>
Необходимо [включить динамические группы](https://docs.microsoft.com/azure/active-directory/users-groups-roles/groups-create-rule) в вашем агонистом Azure AD для группы "Все пользователи" по умолчанию.

   ![Мои приложения SaaS в Azure AD ](media/migrate-adfs-apps-to-azure/permit-access-to-all-users-3.png)


#### <a name="example-2-allow-a-group-explicitly"></a>Пример 2: Разрешить группе явно

Явное групповое разрешение в AD FS:


![Правила выдачи авторизации ](media/migrate-adfs-apps-to-azure/allow-a-group-explicitly-1.png)


Вот как правило отображается в Azure AD:

На [портале Azure](https://portal.azure.com/)сначала [создадут группу пользователей,](https://docs.microsoft.com/azure/active-directory/fundamentals/active-directory-groups-create-azure-portal) соответствующую группе пользователей AD FS, а затем назначите разрешения на приложение этой группе:

![Добавление назначения ](media/migrate-adfs-apps-to-azure/allow-a-group-explicitly-2.png)


#### <a name="example-3-authorize-a-specific-user"></a>Пример 3: Авторизация конкретного пользователя

Явная авторизация пользователя в AD FS:

![Правила выдачи авторизации ](media/migrate-adfs-apps-to-azure/authorize-a-specific-user-1.png)

Вот как правило отображается в Azure AD:

На [портале Azure](https://portal.azure.com/)добавьте пользователя в приложение через вкладку «Добавить назначение» приложения, как показано ниже:

![Мои приложения SaaS в Azure ](media/migrate-adfs-apps-to-azure/authorize-a-specific-user-2.png)

 
### <a name="map-multi-factor-authentication-rules"></a>Карта Многофакторная аутентификация правил 

На месте развертывания [Multi-фактор аутентификации (MFA)](https://docs.microsoft.com/azure/active-directory/authentication/multi-factor-authentication) и AD FS будет по-прежнему работать после миграции, потому что вы федерированы с AD FS. Однако следует перейти на встроенные возможности MFA Azure, которые связаны с рабочими процессами условного доступа Azure AD. 

Ниже приведены примеры типов правил MFA в AD FS, и как их можно сопоставить с Azure AD на основе различных условий:

Настройки правил МИД в AD FS:

![Настройки МИД AD Azure AD](media/migrate-adfs-apps-to-azure/mfa-location-1.png)


#### <a name="example-1-enforce-mfa-based-on-usersgroups"></a>Пример 1: Принуждение МИД на основе пользователей/групп

Селектор пользователя/групп является правилом, которое позволяет применять МИД на основе групп (Group SID) или на основе на одного пользователя (Primary SID). Помимо назначений пользователей/групп, все дополнительные флажки в функции пользовательского интерфейса конфигурации AD FS MFA в качестве дополнительных правил, которые оцениваются после выполнения правила Пользователя/Группы. 


Укажите правила МИД для пользователя или группы в Azure AD:

1. Создайте [новую политику условного доступа.](https://docs.microsoft.com/azure/active-directory/authentication/tutorial-enable-azure-mfa?toc=/azure/active-directory/conditional-access/toc.json&bc=/azure/active-directory/conditional-access/breadcrumb/toc.json)

2. Выберите **назначения**. Добавьте пользователя (ы) или группу (ы), которые вы хотите обеспечить соблюдение МИД.

3. Нанастройка параметров **управления доступом,** показанная ниже:  
‎

![Настройки AAD МИД](media/migrate-adfs-apps-to-azure/mfa-usersorgroups.png)

 
 #### <a name="example-2-enforce-mfa-for-unregistered-devices"></a>Пример 2: Принуждение МИД для незарегистрированных устройств

Укажите правила МИД для незарегистрированных устройств в Azure AD:

1. Создайте [новую политику условного доступа.](https://docs.microsoft.com/azure/active-directory/authentication/tutorial-enable-azure-mfa?toc=/azure/active-directory/conditional-access/toc.json&bc=/azure/active-directory/conditional-access/breadcrumb/toc.json)

2. Установите **назначения** для **всех пользователей.**

3. Нанастройка параметров **управления доступом,** показанная ниже:  
‎

![Настройки AAD МИД](media/migrate-adfs-apps-to-azure/mfa-unregistered-devices.png)

 
При установке опции «Для нескольких элементов управления» требуется одно из выбранных элементов управления, это означает, что если какое-либо из условий, указанных в флажке, выполняется пользователем, ему будет предоставлен доступ к вашему приложению.

#### <a name="example-3-enforce-mfa-based-on-location"></a>Пример 3: Принуждение МИД в зависимости от местоположения

Укажите правила МИД, основанные на местоположении пользователя в Azure AD:

1. Создайте [новую политику условного доступа.](https://docs.microsoft.com/azure/active-directory/authentication/tutorial-enable-azure-mfa?toc=/azure/active-directory/conditional-access/toc.json&bc=/azure/active-directory/conditional-access/breadcrumb/toc.json)

1. Установите **назначения** для **всех пользователей.**

1. [Настройка названных местоположений в Azure AD](https://docs.microsoft.com/azure/active-directory/active-directory-named-locations) в противном случае федерации внутри вашей корпоративной сети доверяют. 

1. Назначайте **правила условий,** чтобы указать места, для которых вы хотели бы обеспечить соблюдение МИД.

![Настройки МИД AD Azure AD](media/migrate-adfs-apps-to-azure/mfa-location-1.png)

5. Нанастройка параметров **управления доступом,** показанная ниже:


![Политики управления доступом на карту](media/migrate-adfs-apps-to-azure/mfa-location-2.png)

 
### <a name="map-emit-attributes-as-claims-rule"></a>Атрибуты карты Излуча как правило Претензий

Вот пример того, как атрибуты отображаются в AD FS:

![Настройки МИД AD Azure AD](media/migrate-adfs-apps-to-azure/map-emit-attributes-as-claimsrule-1.png)


Вот как правило отображается в Azure AD:

На [портале Azure](https://portal.azure.com/)выберите **корпоративные приложения,** **Единый знак**и добавьте **атрибуты токенов SAML,** как показано ниже:

![Настройки МИД AD Azure AD](media/migrate-adfs-apps-to-azure/map-emit-attributes-as-claimsrule-2.png)



### <a name="map-built-in-access-control-policies"></a>Политика управления доступом в систему карты

AD FS 2016 имеет несколько встроенных политик управления доступом, которые вы можете выбрать из:

![Azure AD, встроенный в элемент управления доступом](media/migrate-adfs-apps-to-azure/map-builtin-access-control-policies-1.png)

 
Для реализации встроенных политик в Azure AD можно использовать [новую политику условного доступа](https://docs.microsoft.com/azure/active-directory/authentication/tutorial-enable-azure-mfa?toc=/azure/active-directory/conditional-access/toc.json&bc=/azure/active-directory/conditional-access/breadcrumb/toc.json) и настроить элементы управления доступом, или — создать разработчика пользовательских стратегий в AD FS 2016 для настройки политик управления доступом. Редактор правил имеет исчерпывающий список разрешений и за исключением вариантов, которые могут помочь вам сделать все виды перестановок.

![Политики управления доступом Azure AD](media/migrate-adfs-apps-to-azure/map-builtin-access-control-policies-2.png)



В этой таблице мы перечислили несколько полезных вариантов разрешения и за исключением и как они отображают карту Azure AD. 


| | Как настроить опцию Разрешения в Azure AD?| Как настроить за исключением опции в Azure AD? |
| - | - | - |
| Из конкретной сети| Карты [к названному местоположению](https://docs.microsoft.com/azure/active-directory/reports-monitoring/quickstart-configure-named-locations) в Azure AD| Используйте опцию **«Исключение»** для [доверенных мест](https://docs.microsoft.com/azure/active-directory/conditional-access/location-condition) |
| Из конкретных групп| [Установка назначения пользователя/групп](https://docs.microsoft.com/azure/active-directory/manage-apps/assign-user-or-group-access-portal)| Используйте опцию **«Исключить»** у пользователей и групп |
| От устройств с конкретным уровнем доверия| Установите это из-под контроля "Государство устройства" под задания - > условия| Используйте опцию **"Исключить"** в состоянии состояния устройства и включите **все устройства** |
| С конкретными претензиями в запросе| Этот параметр не может быть перенесен| Этот параметр не может быть перенесен |


Пример настройки опции «Исключить» для доверенных местоположений на портале Azure:

![Скриншот отображения политик управления доступом](media/migrate-adfs-apps-to-azure/map-builtin-access-control-policies-3.png)



## <a name="transition-users-from-ad-fs-to-azure-ad"></a>Пользователи перехода из AD FS в Azure AD

### <a name="sync-ad-fs-groups-in-azure-ad"></a>Синхронизация групп AD FS в Azure AD

При составлении карты правил авторизации приложения, которые аутентифицировать сядение подлинности с помощью AD FS, могут использовать для получения разрешений группы Active Directory. В таком случае используйте [Azure AD Connect](https://go.microsoft.com/fwlink/?LinkId=615771) для синхронизации этих групп с Azure AD перед миграцией приложений. Убедитесь, что вы проверяете эти группы и членство перед миграцией, чтобы вы могли предоставить доступ к тем же пользователям, когда приложение мигрировало.

Для получения дополнительной [информации см. Предпосылки для использования атрибутов группы, синхронизированных с Active Directory.](https://docs.microsoft.com/azure/active-directory/hybrid/how-to-connect-fed-group-claims)

### <a name="setup-user-self-provisioning"></a>Настройка самообеспечения пользователей 

Некоторые приложения SaaS поддерживают возможность самостоятельного предоставления пользователям при первом входе в приложение. В Active Directory Azure (Azure AD) термин «подготовка приложений» означает автоматическое создание идентификаторов пользователей и ролей в приложениях облака[(SaaS),](https://azure.microsoft.com/overview/what-is-saas/)к которым пользователи нуждаются в доступе. Пользователи, которые мигрировали, уже имеют учетную запись в приложении SaaS. Любые новые пользователи, добавленные после миграции, должны быть подготовлены. Тест [Ируйте приложение SaaS](https://docs.microsoft.com/azure/active-directory/app-provisioning/user-provisioning) после того, как приложение будет перенесено.

### <a name="sync-external-users-in-azure-ad"></a>Синхронизация внешних пользователей в Azure AD

Существующие внешние пользователи могут быть настроены двумя основными способами в рамках AD FS:

#### <a name="external-users-with-a-local-account-within-your-organization"></a>Внешние пользователи с локальной учетной записью в вашей организации

Вы будете продолжать использовать эти учетные записи так же, как ваши внутренние учетные записи пользователей работы. Эти внешние учетные записи пользователей имеют принципиальное имя в вашей организации, хотя электронная почта учетной записи может указывать внешне. При продвижении миграции вы можете воспользоваться преимуществами, которые предлагает [Azure AD B2B,](https://docs.microsoft.com/azure/active-directory/b2b/what-is-b2b) мигрируя с этими пользователями, чтобы использовать свой собственный фирменный стиль, когда такая идентификация доступна. Это упрощает процесс входа для этих пользователей, так как они часто вписываются в их собственный корпоративный logon. Администрация вашей организации также будет ослаблена, поскольку больше не будет иметь необходимости управлять учетными записями для внешних пользователей.

#### <a name="federated-external-identities"></a>Федеративные внешние идентичности

Если вы в настоящее время федераленс с внешней организацией, у вас есть несколько подходов, чтобы принять:

* [Добавьте пользователей совместной работы Azure Active Directory B2B на портал Azure.](https://docs.microsoft.com/azure/active-directory/b2b/add-users-administrator) Вы можете активно отправлять приглашения на совместное использование B2B с административного портала Azure AD в организацию-партнер, чтобы отдельные участники продолжали использовать приложения и ресурсы, к которой они привыкли. 

* [Создайте рабочий процесс регистрации в форме самообслуживания B2B,](https://docs.microsoft.com/azure/active-directory/b2b/self-service-portal) который генерирует запрос для отдельных пользователей в организации-партнере с помощью API приглашения B2B.

Независимо от того, как настроены существующие внешние пользователи, у них, скорее всего, есть разрешения, связанные с их учетной записью, либо в членстве в группе, либо в конкретных разрешениях. Оцените, нужно ли мигрировать или очищать эти разрешения. Учетные записи в вашей организации, представляющие внешнего пользователя, должны быть отключены после того, как пользователь был перенесен на внешнюю идентификацию. Процесс миграции следует обсудить с вашими деловыми партнерами, так как их возможности подключения к вашим ресурсам могут быть перебои.

## <a name="migrate-and-test-your-apps"></a>Мигрировать и протестировать приложения

Следите за процессом миграции, описанным в этой статье.

Затем перейдите на [портал Azure,](https://aad.portal.azure.com/) чтобы проверить, прошла ли миграция успешно. Выполните приведенные далее инструкции.
1. Выберите **корпоративные приложения** > **Все приложения** и найдите ваше приложение из списка.

1. Выберите **Управление** > **пользователями и группами,** чтобы назначить в приложение хотя бы одного пользователя или группу.

1. Выберите **Управление** > **условным доступом.** Просмотрите список политик и убедитесь, что вы не блокируете доступ к приложению с [помощью политики условного доступа.](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-azure-portal)

В зависимости от того, как вы настраиваете приложение, убедитесь, что SSO работает должным образом. 

| Authentication type (Тип проверки подлинности)| Тестирование |
| - | - |
| OAuth / OpenID Connect| Выберите **приложения Enterprise > разрешения** и убедитесь, что вы дали согласие на использование приложения в вашей организации в настройках пользователя для вашего приложения.  
‎ |
| Единый вход на основе SAML| Используйте кнопку [настройки test SAML,](https://docs.microsoft.com/azure/active-directory/develop/howto-v1-debug-saml-sso-issues) найденную под **одним знаком.**  
‎ |
| SSO на основе паролей| Скачать и установить [Безопасный знак](https://docs.microsoft.com/azure/active-directory/user-help/active-directory-saas-access-panel-introduction)[-](https://docs.microsoft.com/azure/active-directory/user-help/active-directory-saas-access-panel-introduction)MyApps[в расширении.](https://docs.microsoft.com/azure/active-directory/user-help/active-directory-saas-access-panel-introduction) Это расширение поможет запустить любое из облачных приложений вашей организации, которые требуют, чтобы вы использовали процесс SSO.  
‎ |
| Прокси приложения| Убедитесь, что ваш разъем работает и назначен вашему приложению. Посетите[ ](https://docs.microsoft.com/azure/active-directory/manage-apps/application-proxy-troubleshoot) [руководство по устранению неполадок приложения Proxy](https://docs.microsoft.com/azure/active-directory/manage-apps/application-proxy-troubleshoot) для получения дополнительной помощи.  
‎ |

> [!NOTE]
> Файлы cookie из старой среды AD FS по-прежнему будут постоянными на машинах пользователя. Эти файлы cookie могут вызвать проблемы с миграцией, поскольку пользователи могут быть направлены на старую среду входа в AD FS по сравнению с новым логином Azure AD. Возможно, вам придется очистить файлы cookie-файлов браузера пользователя вручную или с помощью скрипта. Вы также можете использовать диспетчер конфигурации Центра системы или аналогичную платформу.

### <a name="troubleshoot"></a>Диагностика

При наличии каких-либо ошибок в тесте мигрированных приложений, устранение неполадок может быть первым шагом, прежде чем вернуться к существующим Сторонам AD FS Relying. Узнайте, [как отладить одиночный знак на основе SAML в каталоге Active.](https://docs.microsoft.com/azure/active-directory/azuread-dev/howto-v1-debug-saml-sso-issues)

### <a name="rollback-migration"></a>Миграция отката

Если миграция не удается, мы рекомендуем вам оставить существующие Relying Стороны на серверах AD FS и удалить доступ к Relying Сторон. Это позволит быстро отыскать при необходимости во время развертывания.

### <a name="end-user-communication"></a>Общение конечных пользователей

Хотя само окно запланированного сбоя может быть минимальным, необходимо планировать упреждающее информирование сотрудников об этих таймфреймах при одновременном перенаправлении из AD FS в Azure AD. Убедитесь, что в вашем приложении есть кнопка обратной связи или указатели на справочную службу по проблемам.

После завершения развертывания можно отправлять сообщения, информирующие пользователей об успешном развертывании, и напоминать им о любых новых шагах, которые им необходимо предпринять.

* Поручить пользователям использовать [панель доступа](https://myapps.microsoft.com.com/) для доступа ко всем мигрированным приложениям. 

* Напомните пользователям, что им может потребоваться обновить настройки МИД. 

* Если сбросить паролем самообслуживания развернута, пользователям может потребоваться обновить или проверить свои методы проверки подлинности. Смотрите шаблоны связи [конечных](https://aka.ms/mfatemplates) пользователей MFA и [SSPR.](https://aka.ms/ssprtemplates)

Коммуникация с внешними пользователями: Эта группа пользователей, как правило, наиболее критически ею в случае проблем. Это особенно верно, если ваша позиция безопасности диктует другой набор правил условного доступа или профилей рисков для внешних партнеров. Убедитесь, что внешние партнеры осведомлены о графике миграции облака и имеют временные рамки, в течение которых им предлагается участвовать в пилотном развертывании, в котором будут тестовы все потоки, уникальные для внешнего сотрудничества. Наконец, убедитесь, что у них есть способ получить доступ к вашей службе поддержки в случае нарушения проблем.

## <a name="next-steps"></a>Next Steps
Читать [проверку подлинности мигрирующих приложений в Azure AD](https://aka.ms/migrateapps/whitepaper)<p>
Настройка [условного доступа](https://docs.microsoft.com/azure/active-directory/conditional-access/overview) и [МИД](https://docs.microsoft.com/azure/active-directory/authentication/concept-mfa-howitworks)
