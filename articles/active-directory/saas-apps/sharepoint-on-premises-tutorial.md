---
title: Руководство по Интеграция Azure Active Directory с локальной версией SharePoint | Документация Майкрософт
description: Узнайте, как настроить единый вход между Azure Active Directory и локальной версией SharePoint.
services: active-directory
documentationCenter: na
author: jeevansd
manager: mtillman
ms.reviewer: barbkess
ms.assetid: 85b8d4d0-3f6a-4913-b9d3-8cc327d8280d
ms.service: active-directory
ms.subservice: saas-app-tutorial
ms.workload: identity
ms.tgt_pltfrm: na
ms.topic: tutorial
ms.date: 01/15/2020
ms.author: miguego
ms.openlocfilehash: 7e47891a74feb60b0f3e4594bd1621e8b62d64d1
ms.sourcegitcommit: af1cbaaa4f0faa53f91fbde4d6009ffb7662f7eb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2020
ms.locfileid: "81867023"
---
# <a name="tutorial-azure-active-directory-single-sign-on-sso-integration-with-sharepoint-on-premises"></a>Руководство по интеграции единого входа Azure Active Directory с локальной версией SharePoint

В этом руководстве описано, как интегрировать локальную версию SharePoint с Azure Active Directory (Azure AD). Интеграция локальной версии SharePoint с Azure Active Directory обеспечивает следующие возможности.

* Вы можете управлять доступом пользователей к локальной версии SharePoint в Azure AD.
* Включение автоматического входа пользователей в локальную версию SharePoint (единый вход) с использованием учетных записей Azure AD.
* Централизованное управление учетными записями через портал Azure.

Чтобы узнать больше об интеграции приложений SaaS с Azure AD, прочитайте статью [Что такое доступ к приложениям и единый вход с помощью Azure Active Directory?](https://docs.microsoft.com/azure/active-directory/manage-apps/what-is-single-sign-on)

## <a name="prerequisites"></a>Предварительные требования

Чтобы настроить интеграцию Azure Active Directory с локальной версией SharePoint, вам потребуется следующее:

* Подписка Azure Active Directory. (если у вас нет среды Azure AD, вы можете получить [бесплатную учетную запись](https://azure.microsoft.com/free/));
* Ферма SharePoint 2013 или более поздней версии.

## <a name="scenario-description"></a>Описание сценария

В рамках этого руководства вы настроите и проверите единый вход Azure Active Directory в тестовой среде. Пользователи из Azure Active Directory смогут получать доступ к локальной среде SharePoint.

## <a name="create-the-enterprise-applications-in-azure-portal"></a>Создание корпоративных приложений на портале Azure

Чтобы настроить интеграцию локальной версии SharePoint с Azure AD, вам потребуется добавить локальную версию SharePoint из коллекции в ваш список управляемых приложений SaaS.

Чтобы добавить локальную версию SharePoint из коллекции, выполните следующие действия:

1. На **[портале Azure](https://portal.azure.com)** в области навигации слева щелкните значок **Azure Active Directory**.

 > [!NOTE]
 > Если элемент не должен быть доступен, его можно также открыть с помощью фиксированной ссылки **Все службы** вверху области навигации, находящейся слева. В следующем обзоре ссылка **Azure Active Directory** будет доступна в разделе **Удостоверение**. Можно также найти ее, используя текстовое поле фильтра.

2. Перейдите в колонку **Корпоративные приложения** и выберите **Все приложения**.

3. Чтобы добавить новое приложение, в верхней части диалогового окна нажмите кнопку **Создать приложение**.

4. В поле поиска введите **Локальная версия SharePoint** и выберите на панели результатов **SharePoint (локальная версия)** .

    <kbd>![Локальная версия SharePoint в списке результатов](./media/sharepoint-on-premises-tutorial/search-new-app.png)</kbd>

1. Укажите имя локального экземпляра SharePoint и нажмите кнопку **Добавить**, чтобы добавить приложение.

1. В новом корпоративном приложении щелкните "Свойства" и проверьте значение параметра **Требуется назначение пользователей**.

   <kbd>![Локальная версия SharePoint в списке результатов](./media/sharepoint-on-premises-tutorial/user-assignment-required.png)</kbd>

В нашем примере для этого параметра установлено значение **Нет**.

## <a name="configure-and-test-azure-ad"></a>Настройка и проверка Azure AD

В этом разделе описана настройка единого входа Azure AD для локального экземпляра SharePoint.
Для обеспечения работы единого входа необходимо установить связь между пользователем Azure AD и соответствующим пользователем в локальной версии SharePoint.

Чтобы настроить и протестировать единый вход Azure Active Directory для локального экземпляра SharePoint, вам потребуется выполнить действия в следующих стандартных блоках:

1. **[Настройка единого входа Azure AD](#configure-azure-ad-single-sign-on)** необходима, чтобы пользователи могли использовать эту функцию.
1. **[Настройка локальной версии SharePoint](#configure-sharepoint-on-premises)** необходима, чтобы настроить параметры единого входа на стороне приложения.
1. **[Создание тестового пользователя Azure AD на портале Azure](#create-an-azure-ad-test-user-in-the-azure-portal)** необходимо, чтобы создать в Azure AD нового пользователя для механизма единого входа.
1. **[Создание группы безопасности Azure AD на портале Azure](#create-an-azure-ad-security-group-in-the-azure-portal)** необходимо, чтобы создать группу безопасности в Azure AD и включить для нее единый вход.
1. **[Предоставление разрешений учетной записи Azure Active Directory в локальной версии SharePoint](#grant-permissions-to-azure-active-directory-account-in-sharepoint-on-premises)** необходимо для назначения разрешений пользователю Azure AD.
1. **[Предоставление разрешений группе Azure AD в локальной среде SharePoint](#grant-permissions-to-azure-ad-group-in-sharepoint-on-premises)** требуется для назначения разрешений группе Azure AD.
1. **[Предоставление учетной записи гостя доступа к локальной среде SharePoint на портале Azure](#grant-access-to-a-guest-account-to-sharepoint-on-premises-in-the-azure-portal)** необходимо, чтобы предоставить учетной записи гостя Azure AD разрешения в локальной среде SharePoint.
1. **[Настройка доверенного поставщика удостоверений для нескольких веб-приложений](#configuring-the-trusted-identity-provider-for-multiple-web-applications)** необходима для настройки одного доверенного поставщика удостоверений для нескольких веб-приложений.

### <a name="configure-azure-ad-single-sign-on"></a>Настройка единого входа Azure AD

В этом разделе описано включение единого входа Azure AD на портале Azure.

Чтобы настроить единый вход Azure AD для локальной версии SharePoint, выполните следующие действия:

1. На [портале Azure](https://portal.azure.com/) откройте каталог Azure AD, щелкните **Корпоративные приложения**, затем выберите **имя ранее созданного корпоративного приложения** и щелкните **Единый вход**.

2. В диалоговом окне **Выбрать метод единого входа** выберите режим **SAML**, чтобы включить единый вход.
 
3. На странице **Настройка единого входа с помощью SAML** щелкните значок **Изменить**, чтобы открыть диалоговое окно **Базовая конфигурация SAML**.

4. В разделе **Базовая конфигурация SAML** выполните приведенные ниже действия.

    ![Сведения о домене и URL-адресах единого входа для локальной версии SharePoint](./media/sharepoint-on-premises-tutorial/sp-identifier-reply.png)

    1. В поле **Идентификатор** введите URL-адрес в следующем формате: `urn:<sharepointFarmName>:<federationName>`.

    1. В текстовом поле **URL-адрес ответа** введите URL-адрес в формате `https://<YourSharePointSiteURL>/_trust/`.

    1. В текстовое поле **URL-адрес для входа** введите URL-адрес в следующем формате: `https://<YourSharePointSiteURL>/`.
    1. Щелкните "Сохранить".

    > [!NOTE]
    > Эти значения приведены для примера. Укажите вместо них фактические значения URL-адреса для входа, идентификатора и URL-адреса ответа.

5. На странице **Настройка единого входа с помощью SAML** в разделе **Сертификат подписи SAML** щелкните **Загрузить**, чтобы загрузить требуемый **сертификат (Base64)** из предложенных вариантов, и сохраните его на компьютере.

    ![Ссылка для скачивания сертификата](./media/sharepoint-on-premises-tutorial/certificatebase64.png)

6. Скопируйте требуемый URL-адрес из раздела **Настройка локальной версии SharePoint**.
    
    1. **Login URL** (URL-адрес для входа)
    
        Скопируйте URL-адрес для входа и замените значение **/saml2** в конце адреса строкой **/wsfed**, чтобы он выглядел примерно так: **https://login.microsoftonline.com/2c4f1a9f-be5f-10ee-327d-a95dac567e4f/wsfed** (это не реальное значение URL-адреса).

    1. **идентификатор Azure AD**;
    1. **URL-адрес выхода**.
    > [!NOTE]
    > Этот URL-адрес нельзя использовать в SharePoint без изменений, сначала замените **/saml2** на **/wsfed**. В локальном приложении SharePoint используется токен SAML 1.1, поэтому Azure AD ожидает запроса WS Fed от сервера SharePoint и после аутентификации создает токен SAML 1\.1.

### <a name="configure-sharepoint-on-premises"></a>Конфигурация локальной среды SharePoint

1. **Создание нового доверенного поставщика удостоверений в SharePoint Server 2016**

    Войдите в систему на сервере SharePoint и откройте командную консоль SharePoint. Заполните следующие поля:
    1. **$realm** — значение идентификатора из раздела со сведениями о домене и URL-адресах в локальной версии SharePoint на портале Azure;
    1. **$wsfedurl** — URL-адрес службы единого входа;
   1. **$filepath** — путь к файлу сертификата, скачанного с портала Azure.

    Выполните следующие команды, чтобы настроить новый доверенный поставщик удостоверений.

    > [!TIP]
    > Если вы не знаете, как использовать PowerShell, или хотите получить дополнительные сведения о том, как работает PowerShell, см. статью [SharePoint PowerShell](https://docs.microsoft.com/powershell/sharepoint/overview?view=sharepoint-ps).


    ```
    $realm = "urn:sharepoint:sps201x"
    $wsfedurl="https://login.microsoftonline.com/2c4f1a9f-be5f-10ee-327d-a95dac567e4f/wsfed"
    $filepath="C:\temp\SharePoint 2019 OnPrem.cer"
    $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($filepath)
    New-SPTrustedRootAuthority -Name "AzureAD" -Certificate $cert
    $map1 = New-SPClaimTypeMapping -IncomingClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name" -IncomingClaimTypeDisplayName "name" -LocalClaimType "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn"
    $map2 = New-SPClaimTypeMapping -IncomingClaimType "http://schemas.microsoft.com/ws/2008/06/identity/claims/role" -IncomingClaimTypeDisplayName "Role" -SameAsIncoming
    $ap = New-SPTrustedIdentityTokenIssuer -Name "AzureAD" -Description "Azure AD SharePoint server 201x" -realm $realm -ImportTrustCertificate $cert -ClaimsMappings $map1,$map2 -SignInUrl $wsfedurl -IdentifierClaim $map1.InputClaimType
    ```
1. **Включение доверенного поставщика удостоверений для приложения**

    а. В центре администрирования перейдите в раздел **Управление веб-приложениями** и выберите веб-приложение, которое необходимо защитить с помощью Azure AD.

    b. На ленте щелкните **Поставщики проверки подлинности** и выберите зону, которую нужно использовать.

    c. Щелкните пункт **Доверенный поставщик удостоверений** и выберите поставщика, которого вы только что зарегистрировали под именем *AzureAD*.

    d. Нажмите кнопку **ОК**.

    ![Настройка поставщика проверки подлинности](./media/sharepoint-on-premises-tutorial/config-auth-provider.png)

### <a name="create-an-azure-ad-test-user-in-the-azure-portal"></a>Создание тестового пользователя Azure AD на портале Azure

Цель этого раздела — создать на портале Azure тестового пользователя.

1. На портале Azure в области слева выберите **Azure Active Directory**, а затем на панели **Управление** выберите **Пользователи**.

2. В верхней части экрана выберите **Все пользователи** и **Новый пользователь**.

3. Выберите вариант **Создать пользователя**, а затем в разделе "Свойства пользователя" сделайте следующее:  
   Возможно, вы можете создавать пользователей в Azure AD с указанием суффикса клиента или любого проверенного домена. 

    а. В поле **Имя** введите имя пользователя, в нашем примере это **TestUser**.
  
    b. В поле **Имя пользователя** введите `TestUser@yourcompanydomain.extension`.  
    Например TestUser@contoso.com.

    ![Диалоговое окно "Пользователь"](./media/sharepoint-on-premises-tutorial/user-properties.png)

    c. Установите флажок **Показать пароль** и запишите значение, которое отображается в поле "Пароль".

    d. Нажмите кнопку **Создать**.

    д) Теперь можно предоставить общий доступ к сайту с помощью TestUser@contoso.com и разрешить этому пользователю доступ к нему.

### <a name="create-an-azure-ad-security-group-in-the-azure-portal"></a>Создание группы безопасности на портале Azure

1. Щелкните **Azure Active Directory > Группы**.

2. Щелкните **Новая группа**.

3. Заполните поля **Тип группы**, **Имя группы**, **Описание группы** и **Тип членства**. Щелкните стрелку, чтобы выбрать членов группы. Найдите или щелкните члена, которого необходимо добавить в группу. Щелкните **Выбрать**, чтобы добавить выбранных членов, и нажмите кнопку **Создать**.

![Создание группы безопасности Azure AD](./media/sharepoint-on-premises-tutorial/new-group.png)

### <a name="grant-permissions-to-azure-active-directory-account-in-sharepoint-on-premises"></a>Предоставление разрешений учетной записи Azure Active Directory в локальной среде SharePoint

Чтобы предоставить пользователю Azure Active Directory доступ к локальной версии SharePoint, необходимо предоставить общий доступ к семейству веб-сайтов или добавить пользователя Azure Active Directory в одну из групп семейства веб-сайтов. Сейчас в SharePoint 201x поддерживается вход пользователей с помощью удостоверений Azure AD, но вы можете дополнительно улучшить взаимодействие с пользователем. Например, при поиске пользователя в средстве выбора людей система возвращает несколько результатов поиска. Для каждого из трех типов утверждений, которые созданы в этом сопоставлении утверждений, предоставляется отдельный результат поиска. Чтобы выбрать пользователя с помощью средства выбора, вам потребуется ввести точное имя пользователя и выбрать результат утверждения **name**.

![Результаты поиска утверждений](./media/sharepoint-on-premises-tutorial/claims-search-results.png)

Система не проверяет значения, по которым вы выполняете поиск. Это может привести к опечаткам и ошибкам в выборе типа утверждения. Это может помешать пользователям получить доступ к ресурсам.

[Чтобы улучшить средство выбора людей](https://yvand.github.io/AzureCP/) для этого сценария, можно использовать решение с открытым кодом **AzureCP**, которое представляет собой настраиваемый поставщик утверждений для SharePoint 2013, 2016 и 2019. С помощью API Microsoft Graph он разрешает и проверяет вводимые пользователями данные. Дополнительные сведения см. в статье об [AzureCP](https://yvand.github.io/AzureCP/).

  > [!NOTE]
  > Вы можете добавить группы и без AzureCP, вручную добавив идентификатор группы Azure AD, но такой вариант неудобен и ненадежен. Вот как это выглядит:  
  >   
  >![Добавление группы Azure AD в группу SharePoint](./media/sharepoint-on-premises-tutorial/adding-group-by-id.png)
  
### <a name="grant-permissions-to-azure-ad-group-in-sharepoint-on-premises"></a>Предоставление разрешений группе Azure AD в локальной среде SharePoint

Чтобы назначить группы безопасности Azure Active Directory для локальной версии SharePoint, потребуется применить пользовательский поставщик утверждений для SharePoint Server. В нашем примере используется AzureCP.

 > [!NOTE]
 > Обратите внимание на то, что AzureCP не является продуктом корпорации Майкрософт и не обслуживается службой технической поддержки Майкрософт. Скачивание, установка и настройка AzureCP в локальной ферме SharePoint для https://yvand.github.io/AzureCP/. 

1. Настройте AzureCP на локальной ферме SharePoint или настройте альтернативный пользовательский поставщик утверждений. Шаги по настройке AzureCP доступны на странице https://yvand.github.io/AzureCP/Register-App-In-AAD.html

1. На портале Azure откройте каталог Azure AD. Откройте раздел **Корпоративные приложения**, щелкните **имя ранее созданного корпоративного приложения** и выберите **Единый вход**.

1. На странице **Настройка единого входа с помощью SAML** измените значения в разделе **Утверждения и атрибуты пользователя**.

1. Щелкните **Добавить утверждение о группе**.

1. Выберите группы, связанные с пользователем, которые должны возвращаться в утверждении. Для нашего примера выберите **Все группы**, затем в разделе "Исходный атрибут" выберите **Идентификатор группы** и щелкните **Сохранить**.

Чтобы предоставить группе безопасности Azure Active Directory доступ к локальной среде SharePoint, необходимо предоставить общий доступ к семейству веб-сайтов или добавить группу безопасности Azure Active Directory в одну из групп семейства веб-сайтов.

1. Перейдите к семейству веб-сайтов SharePoint и в разделе "Параметры сайта" для этого семейства веб-сайтов щелкните "Пользователи и группы". Выберите группу SharePoint, щелкните "Создать", "Добавить пользователей в эту группу" и начните ввод имени нужной группы. Средство выбора людей отобразит нужную группу безопасности Azure Active Directory.

    ![Добавление группы Azure AD в группу SharePoint](./media/sharepoint-on-premises-tutorial/permission-azure-ad-group.png)

### <a name="grant-access-to-a-guest-account-to-sharepoint-on-premises-in-the-azure-portal"></a>Предоставление гостевой учетной записи доступа к локальной среде SharePoint на портале Azure

Теперь вы можете стандартным образом предоставлять гостевой учетной записи доступ к сайту SharePoint. При этом изменяется имя участника-пользователя. Пользователь с адресом jdoe@outlook.com будет представлен как `jdoe_outlook.com#ext#@TENANT.onmicrosoft.com`. Можно создать удобную процедуру для предоставления внешним пользователям общего доступа к сайту, внеся некоторые изменения в раздел **Утверждения и атрибуты пользователя** на портале Azure.

1. На портале Azure откройте каталог Azure AD. Откройте раздел **Корпоративные приложения**, щелкните **имя ранее созданного корпоративного приложения** и выберите **Единый вход**.

1. На странице **Настройка единого входа с помощью SAML** измените значения в разделе **Утверждения и атрибуты пользователя**.

1. В области **Обязательное утверждение** щелкните **Уникальный идентификатор пользователя (ID)** .

1. Замените значение свойства **Исходный атрибут** на **user.localuserprincipalname** и щелкните **Сохранить**.

    ![Утверждения и атрибуты пользователя, исходное состояние](./media/sharepoint-on-premises-tutorial/manage-claim.png)

1. С помощью ленты вернитесь к странице **Единый вход на основе SAML**, где раздел **Утверждения и атрибуты пользователя** должен выглядеть следующим образом: 

    ![Утверждения и атрибуты пользователя, итоговое состояние](./media/sharepoint-on-premises-tutorial/user-attributes-claims-final.png)  

    > [!NOTE]
    > В этой конфигурации значения имени и фамилии не требуются.

1. На портале Azure щелкните элемент **Azure Active Directory** в области слева и выберите **Пользователи**.

1. Щелкните **Новый гостевой пользователь**.

1. Выберите вариант **Пригласить пользователя**, заполните свойства пользователя и щелкните **Пригласить**.

1. Теперь можно предоставить общий доступ к сайту с помощью MyGuestAccount@outlook.com и разрешить этому пользователю доступ к нему.

    ![Предоставление гостевым учетным записям доступа к сайту](./media/sharepoint-on-premises-tutorial/sharing-guest-account.png)

### <a name="configuring-the-trusted-identity-provider-for-multiple-web-applications"></a>Настройка доверенного поставщика удостоверений для нескольких веб-приложений

Эта конфигурации подходит для одного веб-приложения, но если вы планируете использовать тот же доверенный поставщик удостоверений для нескольких веб-приложений, нужна дополнительная настройка. Предположим, например, что мы расширили веб-приложение для использования URL-адреса `https://sales.contoso.com` и хотим также обеспечить проверку подлинности пользователей для `https://marketing.contoso.com`. Для этого нужно обновить поставщик удостоверений, чтобы учесть параметр WReply, и обновить регистрацию приложения в Azure AD, чтобы добавить URL-адрес ответа.

1. На портале Azure откройте каталог Azure AD. Откройте раздел **Корпоративные приложения**, щелкните **имя ранее созданного корпоративного приложения** и выберите **Единый вход**.

2. На странице **Настройка единого входа с помощью SAML** измените значения в разделе **Базовая конфигурация SAML**.

    ![Изменение базовой конфигурации SAML](./media/sharepoint-on-premises-tutorial/add-reply-url.png)

3. В поле **URL-адрес ответа (URL-адрес службы обработчика утверждений)** добавьте URL-адрес дополнительного веб-приложения и нажмите кнопку **Сохранить**.

    ![Изменение базовой конфигурации SAML](./media/sharepoint-on-premises-tutorial/reply-url-for-web-application.png)

4. На сервере SharePoint откройте **командную консоль SharePoint 201x** и выполните приведенные ниже команды, применив использованное ранее имя доверенного издателя токена удостоверения.
    ```
    $t = Get-SPTrustedIdentityTokenIssuer "AzureAD"
    $t.UseWReplyParameter=$true
    $t.Update()
    ```
5. В центре администрирования перейдите к веб-приложению и включите существующий доверенный поставщик удостоверений.

Если вы столкнетесь с другим сценарием, в котором потребуется предоставить внутренним пользователям доступ к локальной среде SharePoint, вам придется для этого развернуть средство Microsoft Azure Active Directory Connect, которое позволит синхронизировать локальных пользователей с Azure Active Directory. Такая конфигурация будет рассматриваться в другой статье. 

## <a name="additional-resources"></a>Дополнительные ресурсы

- [Список учебников по интеграции приложений SaaS с Azure Active Directory](https://docs.microsoft.com/azure/active-directory/active-directory-saas-tutorial-list)

- [Что такое доступ к приложениям и единый вход с помощью Azure Active Directory?](https://docs.microsoft.com/azure/active-directory/manage-apps/what-is-single-sign-on)

- [Что представляет собой условный доступ в Azure Active Directory?](https://docs.microsoft.com/azure/active-directory/conditional-access/overview)

- [Что собой представляет гибридная идентификация с использованием Azure Active Directory](https://docs.microsoft.com/azure/active-directory/hybrid/whatis-hybrid-identity)
