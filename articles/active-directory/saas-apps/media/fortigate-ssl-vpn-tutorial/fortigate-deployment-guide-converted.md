---
title: Руководство по развертыванию FortiGate | Документация Майкрософт
description: Узнайте, как настроить единый вход Azure Active Directory в VPN SSL FortiGate.
services: active-directory
documentationCenter: na
author: jeevansd
manager: mtillman
ms.reviewer: barbkess
ms.assetid: 18a3d9d5-d81c-478c-be7e-ef38b574cb88
ms.service: active-directory
ms.subservice: saas-app-tutorial
ms.workload: identity
ms.tgt_pltfrm: na
ms.topic: tutorial
ms.date: 08/11/2020
ms.author: jeedes
ms.collection: M365-identity-device-management
ms.openlocfilehash: 999e19ffad1d18e163881c844cbf30f8b7fef574
ms.sourcegitcommit: 271601d3eeeb9422e36353d32d57bd6e331f4d7b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "88657163"
---
# <a name="fortigate-deployment-guide"></a>Руководство по развертыванию FortiGate

## <a name="contents"></a>Содержимое

- Активация лицензии FortiGate
- Скачивание встроенного ПО
- Развертывание FortiGate VM
   - Установка статического общедоступного IP-адреса и назначение полного доменного имени
   - Создание входящего правила группы безопасности сети для TCP-порта
- Создание пользовательского приложения Azure для FortiGate
- Подготовка к сопоставлению групп
   - Создание групп для пользователей
- Настройка FortiGate VM
   - Установка лицензии
   - Обновление встроенного ПО
   - Изменение порта управления на TCP
   - Отправка сертификата для подписи SAML в Azure Active Directory
   - Отправка и настройка пользовательского SSL-сертификата
   - Выполнение настройки из командной строки
   - Создание VPN-порталов и политики брандмауэра
- Проверка входа с помощью Azure

## <a name="redeeming-the-fortigate-license"></a>Активация лицензии FortiGate

Брандмауэр следующего поколения Fortinet FortiGate доступен в виде виртуальной машины в Azure IaaS. Для этой виртуальной машины существует два режима лицензирования:

- Оплата по мере использования
- Использование собственных лицензий (BYOL)

При сотрудничестве с Fortinet для обеспечения указаний по безопасному гибридному доступу (SHA) Fortinet может предоставлять лицензии участникам Azure AD Get и команды Production SHA. Если лицензия не предоставлена, развертывание PAYG все равно будет работать.

Если лицензия выдана, Fortinet предоставляет регистрационный код, который необходимо активировать через Интернет.

![VPN SSL FortiGate](registration-code.png)

1. Зарегистрируйтесь по адресу https://support.fortinet.com/
2. После регистрации войдите на веб-сайт https://support.fortinet.com/
3. Последовательно выберите **Asset** - > **Register/Activate** (Ресурс -> Регистрация/Активация).
4. Введите регистрационный код, предоставленный Fortinet.
5. Укажите регистрационный код, выберите **The product will be used by a non-government user** (Продукт будет использоваться не государственными организациями) и нажмите кнопку **Далее**.
6. Введите описание продукта (например, FortiGate), задайте партнера Fortinet, выбрав **Other** - > **Microsoft** (Другие -> Microsoft), и нажмите кнопку **Далее**.
7. Примите **Fortinet Product Registration Agreement** (Соглашение о регистрации продукта Fortinet) и нажмите кнопку **Далее**.
8. Примите **Terms** (Условия) и нажмите кнопку **Confirm** (Подтвердить).
9. Щелкните **License File Download** (Скачать файл лицензии) и сохраните лицензию для последующего использования.


## <a name="download-firmware"></a>Скачивание встроенного ПО

На момент написания статьи виртуальная машина Azure Fortinet FortiGate не поставляется с версией встроенного ПО, необходимой для проверки подлинности SAML. Последняя версия должна быть получена из Fortinet.

1. Войдите на веб-сайт https://support.fortinet.com/
2. Последовательно выберите **Download** - > **Firmware Images** (Скачать -> Образы встроенного ПО).
3. Щелкните **Download** (Скачать) справа от **Release Notes** (Заметки о выпуске).
4. Щелкните **v6.**
5. Щелкните **6.**
6. Щелкните **6.4.**
7. Скачайте **FGT_VM64_AZURE-v6-build1637-FORTINET.out**, щелкнув ссылку **HTTPS** в той же строке.
8. Сохраните файл для последующего использования.


## <a name="deploy-the-fortigate-vm"></a>Развертывание FortiGate VM

1. Перейдите к https://portal.azure.com и войдите в подписку, в которой вы хотите развернуть виртуальную машину FortiGate.
2. Создайте или откройте группу ресурсов, в которой вы хотите развернуть виртуальную машину FortiGate.
3. Нажмите кнопку **Добавить**
4. Введите Forti в диалоговом окне **Поиск по Marketplace** и выберите **Fortinet FortiGate Next-** **Generation Firewall** (Брандмауэр следующего поколения Fortinet FortiGate).
5. Выберите план программного обеспечения (BYOL, если у вас есть лицензия, или PAYG, если нет) и нажмите кнопку **Создать**.
6. Заполните конфигурацию виртуальной машины.

    ![VPN SSL FortiGate](virtual-machine.png)

7. Задайте для типа аутентификации значение **Пароль** и укажите учетные данные администратора для виртуальной машины.
8. Щелкните **Просмотр и создание**.
9. Нажмите кнопку **Создать**.
10. Дождитесь завершения развертывания виртуальной машины.


### <a name="set-a-statuc-public-ip-address-and-assign-a-fully-qualified-domain-name"></a>Установка статического общедоступного IP-адреса и назначение полного доменного имени

Чтобы обеспечить единообразное взаимодействие с пользователем, желательно установить общедоступный IP-адрес, назначенный виртуальной машине FortiGate статически. Кроме того, сопоставление с полным доменным именем также полезно по тем же причинам.

_Установка статического общедоступного IP-адреса_

1. Перейдите к https://portal.azure.com и откройте параметры виртуальной машины FortiGate.
2. На экране **Обзор** щелкните общедоступный IP-адрес.

    ![VPN SSL FortiGate](public-ip-address.png)

3. Щелкните **Статический**, а затем нажмите кнопку **Сохранить**.

_Назначение полного доменного имени_

Если вы владеете общедоступным доменным именем с маршрутизацией для среды, в которой развертывается виртуальная машина FortiGate, создайте запись узла (A) для виртуальной машины, которая сопоставляется с общедоступным IP-адресом статически.

### <a name="create-a-new-inbound-network-security-group-rule-for-tcp-port"></a>Создание входящего правила группы безопасности сети для TCP-порта

1. Перейдите к https://portal.azure.com и откройте параметры виртуальной машины FortiGate.
2. В меню слева щелкните **Сеть**. Будет перечислен сетевой интерфейс, а также появятся правила входящих портов.
3. Выберите **Добавить правило входящего порта**.
4. Создайте правило входящего порта для TCP-порта 8443.

    ![VPN SSL FortiGate](port-rule.png)

5. Нажмите кнопку **Добавить**


## <a name="create-a-custom-azure-app-for-fortigate"></a>Создание пользовательского приложения Azure для FortiGate

1. Перейдите к https://portal.azure.com и откройте колонку Azure Active Directory для клиента, который предоставит удостоверение для входа в FortiGate.
2. В меню слева щелкните пункт **Корпоративные приложения**.
3. Щелкните **Новое приложение**.
4. Выберите **Приложение не из коллекции**.
5. Укажите имя (например, FortiGate) и нажмите кнопку **Добавить**.
6. В меню слева выберите пункт **Пользователи и группы**.
7. Добавьте пользователей для входа и выберите **Назначить**.
8. В меню слева щелкните **Единый вход**.
9. Выберите **SAML**.
10. В разделе **Базовая конфигурация SAML** щелкните значок карандаша, чтобы изменить конфигурацию.
11. Configure
    - Идентификатор (идентификатор сущности): `https://<address>/remote/saml/metadata`
    - URL-адрес ответа (URL-адрес службы обработчика утверждений): `https://<address>/remote/saml/login`
    - URL-адрес выхода: `https://<address>/remote/saml/logout`

    Где `address` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

    Запишите каждый из этих URL-адресов для последующего использования:

    - Идентификатор сущности
    - URL-адрес ответа
    - URL-адрес выхода.
12. Щелкните **Сохранить**.
13. Закройте базовую конфигурацию SAML.
14. В разделе 3 **Сертификат подписи SAML** скачайте **Сертификат (Base64)** , а затем сохраните его для последующего использования.
15. В разделе 4 **Set up (App Name)** (Настройка (имя приложения)), скопируйте URL-адрес входа Azure, идентификатор Azure AD и URL-адрес выхода Azure, а затем сохраните их для последующего использования.
    - URL-адрес входа Azure
    - Идентификатор Azure AD
    - URL-адрес выхода Azure
16. В разделе 2 **Атрибуты пользователя и утверждения** щелкните значок карандаша, чтобы изменить конфигурацию.
17. Щелкните **Добавить новое утверждение**.
18. Задайте имя для параметра **Имя пользователя**.
19. Задайте атрибут источника для параметра **user.userprincipalname**.
20. Щелкните **Сохранить**.
21. Выберите **Добавить утверждение о группе**.
22. Щелкните **Все группы**.
23. Установите флажок **Изменение имени утверждения группы**.
24. Задайте имя для параметра **Группа**.
25. Щелкните **Сохранить**.


## <a name="prepare-for-group-matching"></a>Подготовка к сопоставлению групп

FortiGate позволяет использовать различные возможности пользовательского портала после входа в систему в зависимости от членства в группе. Например, для группы "Маркетинг" может быть один интерфейс, а другой для группы "Финансы".

Настройте это следующим образом.

### <a name="create-groups-for-users"></a>Создание групп для пользователей

1. Перейдите к https://portal.azure.com и откройте колонку Azure Active Directory для клиента, который предоставит удостоверение для входа в FortiGate.
2. Щелкните **Группы**.
3. Выберите **Новая группа**.
4. Создайте группу с помощью таких параметров:
    - Тип группы = Безопасность
    - Имя группы = `a meaningful name`
    - Описание группы = `a meaningful description for the group`
    - Тип членства = Назначено
    - Члены = `users for the user experience that will map to this group`
5. Повторите шаги 3 и 4 для дополнительных пользовательских интерфейсов.
6. После создания групп выберите каждую группу и запишите идентификатор объекта для каждой из них.
7. Сохранить эти идентификаторы объектов и имена групп для последующего использования.


## <a name="configure-the-fortigate-vm"></a>Настройка FortiGate VM

### <a name="install-the-license"></a>Установка лицензии

1. Перейдите на страницу `https://<address>`.

    Здесь `address` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Продолжите после любых ошибок сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. Если развертывание использует модель BYOL, будет отображаться запрос на отправку лицензии. Выберите файл лицензии, созданный ранее, отправьте его, затем нажмите кнопку **ОК** и перезапустите виртуальную машину FortiGate.

    ![VPN SSL FortiGate](license.png)

5. После перезагрузки опять войдите в систему с учетными данными администратора, чтобы проверить лицензию.

### <a name="update-firmware"></a>Обновление встроенного ПО

1. Перейдите на страницу `https://<address>`.

    Здесь `address` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Продолжите после любых ошибок сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева щелкните **Система**.
5. В меню слева в разделе "Система" щелкните **Встроенное ПО**.
6. На странице управления встроенным ПО щелкните **Обзор** и выберите скачанный ранее файл встроенного ПО.
7. Игнорируйте предупреждение и щелкните **Backup config and upgrade** (Резервное копирование конфигурации и обновление).

    ![VPN SSL FortiGate](backup-configure-upgrade.png)

8. Нажмите кнопку **Продолжить**.
9. При появлении запроса на сохранение конфигурации FortiGate (как файла .conf) нажмите кнопку **Сохранить**.
10. Дождитесь загрузки встроенного ПО, чтобы применить его и перезагрузить виртуальную машину FortiGate.
11. После перезагрузки виртуальной машины FortiGate опять войдите в систему с учетными данными администратора.
12. При появлении запроса на выполнение настройки панели мониторинга нажмите кнопку **Позже**.
13. После запуска учебного видео нажмите кнопку **ОК**.

### <a name="change-the-management-port-to-tcp"></a>Изменение порта управления на TCP

1. Перейдите на страницу `https://<address>`.

    Здесь `address` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Продолжите после любых ошибок сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева щелкните **Система**.
5. В разделе параметров администрирования измените HTTPS-порт на **8443**.
6. Щелкните **Применить**.
7. После применения изменения браузер попытается перезагрузить страницу администрирования, но произойдет сбой. С этого момента адрес страницы администрирования будет `https://<address>`

    ![VPN SSL FortiGate](certificate.png)

### <a name="upload-the-azure-active-directory-saml-signing-certificate"></a>Отправка сертификата для подписи SAML в Azure Active Directory

1. Перейдите на страницу `https://<address>`.

    Здесь `address` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Продолжите после любых ошибок сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева щелкните **Система**.
5. В разделе системы щелкните **Сертификаты**.
6. Щелкните **Импорт** - > **Remote Certificate** (Удаленный сертификат).
7. Перейдите к сертификату, скачанному из развертывания пользовательского приложения FortiGate в клиенте Azure, выберите его и нажмите кнопку **ОК**.

### <a name="upload-and-configure-a-custom-ssl-certificate"></a>Отправка и настройка пользовательского SSL-сертификата

Возможно, потребуется настроить виртуальную машину FortiGate с помощью собственного SSL-сертификата, который поддерживает используемое полное доменное имя. Если у вас есть доступ к SSL-сертификату, упакованному с помощью закрытого ключа в формат PFX, то его можно использоваться для этой цели.

1. Перейдите на страницу `https://<address>`.

    Здесь `address` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Продолжите после любых ошибок сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева щелкните **Система**.
5. В разделе системы щелкните **Сертификаты**.
6. Щелкните **Импорт** - > **Local Certificate** (Локальный сертификат).
7. Выберите **PKCS #12 Certificate** (Сертификат PKCS #12).
8. Перейдите к PFX-файлу, содержащему SSL-сертификат и закрытый ключ.
9. Введите пароль для PFX-файла.
10. Введите понятное имя для сертификата.
11. Нажмите кнопку **ОК**.
12. В меню слева щелкните **Система**.
13. В разделе системы щелкните **Параметры**.
14. В разделе параметров администрирования разверните раскрывающийся список рядом с пунктом сертификата сервера HTTPS и выберите SSL-сертификат, импортированный выше.
15. Щелкните **Применить**.
16. Закройте окно браузера и снова перейдите к `https://<address>`
17. Войдите в систему с учетными данными администратора FortiGate и убедитесь, что используется правильный SSL-сертификат.


### <a name="perform-command-line-configuration"></a>Выполнение настройки из командной строки

_Выполнение настройки командной строки для проверки подлинности SAML_

1. Перейдите к https://portal.azure.com и откройте параметры виртуальной машины FortiGate.
2. В меню слева щелкните **Последовательная консоль**.
3. Войдите в последовательную консоль с учетными данными администратора виртуальной машины FortiGate.

    Для следующего шага будут необходимы URL-адреса, записанные ранее. А именно:

    - Идентификатор сущности
    - URL-адрес ответа
    - URL-адрес выхода.
    - URL-адрес входа Azure
    - Идентификатор Azure AD
    - URL-адрес выхода Azure
4. В последовательной консоли выполните такие команды:

    ```
    config user saml
    edit azure
    set entity-id <Entity ID>
    set single-sign-on-url <Reply URL>
    set single-logout-url <Logout URL>
    set idp-single-sign-on-url <Azure Login URL>
    set idp-entity-id <Azure AD Identifier>
    set idp-single-logout-url <Azure Logout URL>
    set idp-cert REMOTE_Cert_
    set user-name username
    set group-name group
    end
    ```
    > [!NOTE]
    > URL-адрес выхода Azure содержит знак ?. Для этого требуется специальная последовательность клавиш, чтобы правильно передать ее в последовательную консоль FortiGate. Обычно это URL-адрес:

    `https://login.microsoftonline.com/common/wsfederation?wa=wsignout1`

    Чтобы указать его в последовательной консоли, введите

    ```
    set idp-single-logout-url https://login.microsoftonline.com/common/wsfederation
    ```
    Затем нажмите клавиши CTRL+V

    и вставьте остальную часть URL-адреса, чтобы завершить строку.

    ```
    set idp-single-logout-url
    https://login.microsoftonline.com/common/wsfederation?wa=wsignout1.
    ```

5. Подтвердите конфигурацию, выполнив:

    ```
    show user saml
    ```

_Выполнение настройки командной строки для сопоставления групп_

1. Перейдите к https://portal.azure.com и откройте параметры виртуальной машины FortiGate.
2. В меню слева щелкните **Последовательная консоль**.
3. Войдите в последовательную консоль с учетными данными администратора виртуальной машины FortiGate.
4. В последовательной консоли выполните такие команды:

    ```
    config user group
    edit <group 1 name>
    set member azure
    config match
    edit 1
    set server-name azure
    set group-name <group 1 Object Id>
    next
    end
    next
    ```

    Повторите эти команды, начиная от edit `group 1 name`, для каждой дополнительной группы, которая будет использовать различные возможности портала в FortiGate.

_Выполнение настройки командной строки для времени ожидания аутентификации_

1. Перейдите к https://portal.azure.com и откройте параметры виртуальной машины FortiGate.
2. В меню слева щелкните **Последовательная консоль**.
3. Войдите в последовательную консоль с учетными данными администратора виртуальной машины FortiGate.
4. В последовательной консоли выполните такие команды:

    ```
    config system global
    set remoteauthtimeout 60
    end
    ```
### <a name="create-vpn-portals-and-firewall-policy"></a>Создание VPN-порталов и политики брандмауэра

1. Перейдите на страницу `https://<address>`.

    Здесь `address` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
3. В меню слева щелкните **VPN**.
4. В разделе VPN щелкните **SSL-VPN Portals** (Порталы SSL-VPN).
5. Щелкните кнопку **Создать**.
6. Укажите имя (обычно соответствующее ему в группе Azure, используемой для обеспечения возможностей пользовательского портала).
7. Щелкните знак "плюс" ( **+** ) рядом с пунктом Source IP Pools (Исходные пулы IP-адресов), выберите пул по умолчанию и нажмите кнопку **Закрыть**.
8. Настройте интерфейс для этой группы. Для тестирования это может быть настройка портала сообщений и темы. Здесь также можно создавать пользовательские закладки, через которые пользователь попадает на внутренние ресурсы.
9. Нажмите кнопку **ОК**.
10. Повторите шаги 5–9 для каждой группы Azure, которая будет работать с пользовательскими возможностями портала.
11. В разделе VPN щелкните **SSL-VPN Settings** (Настройки SSL-VPN).
12. Щелкните знак "плюс" ( **+** ) рядом с пунктом Listen on Interfaces (Прослушивание интерфейсов).
13. Выберите **Port1** и нажмите кнопку **Закрыть**.


14. Если ранее был установлен пользовательский SSL-сертификат, измените сертификат сервера на использование пользовательского SSL-сертификата в раскрывающемся меню.
15. В разделе Authentication/Portal Mapping (Проверка подлинности или сопоставление портала) щелкните **Создать**.
16. Выберите первую группу Azure и сопоставьте ее с порталом с тем же именем.
17. Нажмите кнопку **ОК**.
18. Повторите шаги 15–17 для каждой пары "Группа Azure — портал".
19. В разделе Authentication/Portal Mapping (Проверка подлинности или сопоставление портала) измените значение параметра **All Other Users/Groups** (Все остальные пользователи и группы).
20. Установите для портала **Полный доступ**.
21. Нажмите кнопку **ОК**.
22. Щелкните **Применить**.
23. Прокрутите до верхней границы страницы параметров SSL-VPN и щелкните предупреждение **No SSL-VPN policies**
    **exist (Политики SSL-VPN не существуют). Щелкните здесь, чтобы создать политику SSL-VPN с помощью этих параметров**.
24. Укажите имя, например **VPN Grp**.
25. Задайте для исходящего интерфейса **порт**.
26. Щелкните **Источник**.
27. В разделе "Адрес" выберите **Все**.
28. В разделе "Пользователь" выберите первую группу Azure.
29. Нажмите кнопку **Закрыть**.
30. Щелкните **Назначение**.
31. В разделе "Адрес" обычно это внутренняя сеть. Выберите login.microsoft.com для тестирования.
32. Нажмите кнопку **Закрыть**.
33. Щелкните **Служба**.
34. Выберите **Все**.
35. Нажмите кнопку **Закрыть**.
36. Нажмите кнопку **ОК**.
37. В меню слева щелкните **Policy & Objects** (Политика и объекты).
38. В разделе Policy & Objects (Политика и объекты) щелкните **Политика брандмауэра**.
39. Разверните узел **SSL-VPN tunnel interface (ssl.root) -> port** (Туннельный интерфейс SSL-VPN (ssl.root) -> порт).
40. Щелкните правой кнопкой мыши созданную ранее политику VPN (**VPN Grp 1**) и выберите пункт **Копировать**.
41. Щелкните правой кнопкой мыши политику VPN и выберите **Вставить** - >**Далее**.
42. Измените новую политику, указав другое имя (например, **VPN Grp2**), и изменение группы применится к другой группе Azure.
43. Щелкните правой кнопкой мыши новую политику и задайте ей состояние **Включено**.


## <a name="test-sign-in-using-azure"></a>Проверка входа с помощью Azure

1. С помощью закрытого сеанса браузера перейдите к `https://<address>` 
2. Для входа должно быть перенаправление на Azure Active Directory.
3. После предоставления учетных данных пользователя, назначенного приложению FortiGate в клиенте Azure, должен отображаться соответствующий пользовательский портал.

    ![VPN SSL FortiGate](test-sign-in.png)
