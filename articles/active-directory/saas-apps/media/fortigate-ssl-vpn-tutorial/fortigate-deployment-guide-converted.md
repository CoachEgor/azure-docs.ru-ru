---
title: Руководство по развертыванию FortiGate | Документация Майкрософт
description: Настройка и использование брандмауэра Fortinet FortiGate следующего поколения.
services: active-directory
documentationCenter: na
author: jeevansd
manager: mtillman
ms.reviewer: barbkess
ms.assetid: 18a3d9d5-d81c-478c-be7e-ef38b574cb88
ms.service: active-directory
ms.subservice: saas-app-tutorial
ms.workload: identity
ms.tgt_pltfrm: na
ms.topic: tutorial
ms.date: 08/11/2020
ms.author: jeedes
ms.collection: M365-identity-device-management
ms.openlocfilehash: 357eb0a60e6246996de9ab75337ecc213d845ae7
ms.sourcegitcommit: 32c521a2ef396d121e71ba682e098092ac673b30
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2020
ms.locfileid: "91273336"
---
# <a name="fortigate-deployment-guide"></a>Руководство по развертыванию FortiGate

Из этого руководства по развертыванию вы узнаете, как настроить и использовать брандмауэр Fortinet FortiGate следующего поколения.

## <a name="redeem-the-fortigate-license"></a>Активация лицензии FortiGate

Брандмауэр следующего поколения Fortinet FortiGate доступен в виде виртуальной машины в инфраструктуре как услуге (IaaS) Azure. Для этой виртуальной машины существует два режима лицензирования: с оплатой по мере использования и с использованием собственной лицензии.

Fortinet может предоставить лицензии участникам команды по обеспечению гибридного безопасного доступа для внедрения в рабочей среде в Azure Active Directory (Azure AD). Если лицензия не предоставлена, развертывание с оплатой по мере использования все равно будет работать.

Если лицензия выдана, Fortinet предоставляет регистрационный код, который необходимо активировать через Интернет.

![Снимок экрана с регистрационным кодом VPN для подключения к FortiGate через SSL.](registration-code.png)

1. Зарегистрируйтесь по адресу https://support.fortinet.com/.
2. После регистрации войдите на веб-сайт https://support.fortinet.com/.
3. Последовательно выберите **Asset** > **Register/Activate** (Ресурс > Зарегистрировать/активировать).
4. Введите регистрационный код, предоставленный Fortinet.
5. Укажите регистрационный код, выберите **The product will be used by a non-government user** (Продукт будет использоваться не государственными организациями) и нажмите кнопку **Next** (Далее).
6. Введите описание продукта (например, FortiGate), задайте партнера Fortinet, выбрав **Other** > **Microsoft** (Другие > Microsoft), и нажмите кнопку **Next** (Далее).
7. Примите **Fortinet Product Registration Agreement** (Соглашение о регистрации продукта Fortinet) и нажмите кнопку **Next** (Далее).
8. Примите **Terms** (Условия) и нажмите кнопку **Confirm** (Подтвердить).
9. Выберите **License File Download** (Скачать файл лицензии) и сохраните лицензию для последующего использования.


## <a name="download-firmware"></a>Скачивание встроенного ПО

Виртуальная машина Azure Fortinet FortiGate в данный момент не поставляется с версией встроенного ПО, необходимой для проверки подлинности SAML. Последняя версия должна быть получена из Fortinet.

1. Выполните вход на странице https://support.fortinet.com/.
2. Последовательно выберите **Download** > **Firmware Images** (Загрузить > Образы встроенного ПО).
3. Справа от **Release Notes** (Заметки о выпуске) выберите **Download** (Скачать).
4. Выберите **V6** (Версия 6). > **6.** > **6.4.** .
5. Скачайте **FGT_VM64_AZURE-v6-build1637-FORTINET.out**, выбрав ссылку **HTTPS** в той же строке.
6. Сохраните файл для последующего использования.


## <a name="deploy-the-fortigate-vm"></a>Развертывание FortiGate VM

1. Перейдите к https://portal.azure.com и войдите в подписку, в которой вы хотите развернуть виртуальную машину FortiGate.
2. Создайте или откройте группу ресурсов, в которой вы хотите развернуть виртуальную машину FortiGate.
3. Нажмите **Добавить**.
4. В поле **Search the Marketplace** (Поиск в Marketplace), введите *Forti*. Выберите **Fortinet FortiGate Next-Generation Firewall** (Брандмауэр Fortinet FortiGate следующего поколения).
5. Выберите план программного обеспечения (с использованием собственной лицензии, если она есть, или с оплатой по мере использования в случае ее отсутствия). Выберите **Создать**.
6. Заполните конфигурацию виртуальной машины.

    ![Снимок экрана, демонстрирующий создание виртуальной машины.](virtual-machine.png)

7. Задайте для параметра **Authentication type** (Тип аутентификации) значение **Password** (Пароль) и укажите учетные данные администратора для виртуальной машины.
8. Выберите **Просмотреть и создать** > **Создать**.
9. Дождитесь завершения развертывания виртуальной машины.


### <a name="set-a-static-public-ip-address-and-assign-a-fully-qualified-domain-name"></a>Установка статического общедоступного IP-адреса и назначение полного доменного имени

Чтобы обеспечить единообразное взаимодействие с пользователем, установите общедоступный IP-адрес, назначенный виртуальной машине FortiGate статически. Кроме того, сопоставьте его с полным доменным именем (FQDN).

1. Перейдите на сайт https://portal.azure.com и откройте параметры виртуальной машины FortiGate.
2. На экране **Overview** (Обзор) выберите общедоступный IP-адрес.

    ![Снимок экрана настроек VPN для подключения к FortiGate через SSL.](public-ip-address.png)

3. Выберите **Static** > **Save** (Статический > Сохранить).

Если вы владеете общедоступным доменным именем с маршрутизацией для среды, в которой развертывается виртуальная машина FortiGate, создайте запись узла (A) для виртуальной машины. Эта запись сопоставляется с общедоступным IP-адресом статически.

### <a name="create-a-new-inbound-network-security-group-rule-for-tcp-port"></a>Создание входящего правила группы безопасности сети для TCP-порта

1. Перейдите на сайт https://portal.azure.com и откройте параметры виртуальной машины FortiGate.
2. В меню слева выберите **Сеть**. Будет показан список с сетевым интерфейсом, а также правила входящих портов.
3. Выберите **Добавить правило входящего порта**.
4. Создайте правило входящего порта для TCP 8443.

    ![Снимок экрана, на котором показано добавление правила безопасности для входящего порта.](port-rule.png)

5. Нажмите **Добавить**.


## <a name="create-a-custom-azure-app-for-fortigate"></a>Создание пользовательского приложения Azure для FortiGate

1. Перейдите на портал https://portal.azure.com и откройте область Azure AD для клиента, который предоставит удостоверение для входа в FortiGate.
2. В меню слева выберите **Корпоративные приложения**.
3. Выберите **Создать приложение** > **Приложения не из коллекции**.
4. Введите имя (например, FortiGate) и выберите **Добавить**.
5. В меню слева выберите **Пользователи и группы**.
6. Добавьте пользователей для входа и выберите **Назначить**.
7. В меню слева выберите **Единый вход**.
8. Выберите **SAML**.
9. В разделе **Базовая конфигурация SAML** щелкните значок карандаша, чтобы изменить конфигурацию.
10. Настройте следующие параметры.
    - **Идентификатор (идентификатор сущности)** : `https://<address>/remote/saml/metadata`.
    - **URL-адрес ответа (URL-адрес службы обработчика утверждений)** : `https://<address>/remote/saml/login`.
    - **URL-адрес выхода**: `https://<address>/remote/saml/logout`.

    `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

11. Запишите каждый из этих URL-адресов для последующего использования: Идентификатор сущности, URL-адрес ответа и URL-адрес выхода.
12. Выберите **Сохранить** и закройте окно **Базовая конфигурация SAML**.
13. В разделе 3 **Сертификат подписи SAML** скачайте **Сертификат (Base64)** , а затем сохраните его для последующего использования.
14. В разделе 4 **Настройка (имя приложения)** , скопируйте URL-адрес входа Azure, идентификатор Azure AD и URL-адрес выхода Azure, а затем сохраните их для последующего использования.
15. В разделе 2 **Атрибуты пользователя и утверждения** нажмите значок карандаша, чтобы изменить конфигурацию.
16. Выберите **Добавить новое утверждение** и в качестве имени укажите **username**.
17. В качестве атрибута источника задайте **user.userprincipalname**.
18. Выберите **Сохранить** > **Добавить утверждение о группе** > **Все группы**.
19. Выберите **Изменение имени утверждения группы** и задайте в качестве имени значение **group**.
20. Щелкните **Сохранить**.


## <a name="prepare-for-group-matching"></a>Подготовка к сопоставлению групп

FortiGate позволяет использовать различные возможности пользовательского портала после входа в систему в зависимости от членства в группе. Например, для маркетинговой группы может быть один интерфейс, а для финансовой группы — другой. Вот как можно создать группы для пользователей:

1. Перейдите на портал https://portal.azure.com и откройте область Azure AD для клиента, который предоставит удостоверение для входа в FortiGate.
2. Выберите **Группы** > **Создать группу**.
3. Создайте группу, указав следующие сведения:
    - Тип группы = Безопасность
    - Имя группы = `a meaningful name`
    - Описание группы = `a meaningful description for the group`
    - Тип членства = Назначено
    - Члены = `users for the user experience that will map to this group`
4. Повторите шаги 3 и 4 для дополнительных пользовательских интерфейсов.
5. После создания групп выберите каждую группу и запишите **идентификатор объекта** для каждой из них.
6. Сохранить эти идентификаторы объектов и имена групп для последующего использования.


## <a name="configure-the-fortigate-vm"></a>Настройка FortiGate VM

В следующих разделах описано, как настроить виртуальную машину FortiGate.

### <a name="install-the-license"></a>Установка лицензии

1. Перейдите по адресу `https://<address>`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Пропустите все ошибки сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. Если в развертывании используется модель с собственной лицензией, вы увидите запрос на ее отправку. Выберите созданный ранее файл лицензии и отправьте его. Нажмите **ОК** и перезапустите виртуальную машину FortiGate.

    ![Снимок экрана с лицензией для виртуальной машины FortiGate.](license.png)

5. После перезагрузки опять войдите в систему с учетными данными администратора, чтобы проверить лицензию.

### <a name="update-firmware"></a>Обновление встроенного ПО

1. Перейдите по адресу `https://<address>`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Пропустите все ошибки сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева выберите **System** > **Firmware** (Система > Встроенное ПО).
5. На странице **Firmware Management** (Управление встроенным ПО) нажмите **Browse** (Обзор) и выберите скачанный ранее файл встроенного ПО.
6. Игнорируйте предупреждение и выберите **Backup config and upgrade** (Резервное копирование конфигурации и обновление).

    ![Снимок экрана страницы управления встроенным ПО.](backup-configure-upgrade.png)

7. Выберите **Continue** (Продолжить).
8. При появлении запроса на сохранение конфигурации FortiGate (в формате файла CONF) нажмите кнопку **Save** (Сохранить).
9. Дождитесь отправки и применения встроенного ПО. Дождитесь перезагрузки виртуальной машины FortiGate.
10. После перезагрузки виртуальной машины FortiGate опять войдите в систему с учетными данными администратора.
11. Когда появится запрос на настройку панели мониторинга, выберите **Later** (Позже).
12. После запуска учебного видео нажмите кнопку **ОК**.

### <a name="change-the-management-port-to-tcp"></a>Изменение порта управления на TCP

1. Перейдите по адресу `https://<address>`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Пропустите все ошибки сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева выберите **System** (Система).
5. В разделе **Administration Settings** (Параметры администрирования) измените HTTPS-порт на **8443** и нажмите **Apply**.
6. После применения изменения браузер попытается перезагрузить страницу администрирования, но произойдет сбой. С этого момента адресом страницы администрирования будет `https://<address>`.

    ![Снимок экрана, демонстрирующий отправку удаленного сертификата.](certificate.png)

### <a name="upload-the-azure-ad-saml-signing-certificate"></a>Отправка сертификата для подписи SAML в Azure AD

1. Перейдите по адресу `https://<address>`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Пропустите все ошибки сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева выберите **System** > **Certificates** (Система > Сертификаты).
5. Выберите **Импорт** > **Remote Certificate** (Удаленный сертификат).
6. Перейдите к сертификату, скачанному из развертывания пользовательского приложения FortiGate в клиенте Azure. Выберите его и нажмите кнопку **ОК**.

### <a name="upload-and-configure-a-custom-ssl-certificate"></a>Отправка и настройка пользовательского SSL-сертификата

При необходимости можно настроить виртуальную машину FortiGate с помощью собственного SSL-сертификата, который поддерживает используемое полное доменное имя. Если у вас есть доступ к SSL-сертификату, упакованному с помощью закрытого ключа в формат PFX, то его можно использоваться для этой цели.

1. Перейдите по адресу `https://<address>`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Пропустите все ошибки сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева выберите **System** > **Certificates** (Система > Сертификаты).
5. Выберите **Import** > **Local Certificate** > **PKCS #12 Certificate** (Импорт > Локальный сертификат >Сертификат PKCS #12).
6. Перейдите к PFX-файлу, содержащему SSL-сертификат и закрытый ключ.
7. Введите пароль к PFX-файлу и понятное имя для сертификата. Нажмите кнопку **ОК**.
8. В меню слева выберите **System** > **Settings** (Система > Параметры).
9. В разделе **Administration Settings** (Параметры администрирования) разверните список рядом с пунктом **HTTPS server certificate** (Сертификат сервера HTTPS) и выберите SSL-сертификат, импортированный ранее.
10. Нажмите кнопку **Применить**.
11. Закройте окно браузера и перейдите на страницу `https://<address>`.
12. Для входа укажите учетные данные администратора FortiGate. Теперь должен использовать правильный SSL-сертификат.


### <a name="perform-command-line-configuration"></a>Выполнение настройки из командной строки

В следующих разделах приведены инструкции по настройке различных конфигураций с помощью командной строки.

#### <a name="for-saml-authentication"></a>Проверка подлинности SAML

1. Перейдите на сайт https://portal.azure.com и откройте параметры виртуальной машины FortiGate.
2. В меню слева выберите **Последовательная консоль**.
3. Войдите в последовательную консоль с учетными данными администратора виртуальной машины FortiGate. Для следующего шага будут необходимы URL-адреса, записанные ранее:
    - Идентификатор сущности
    - URL-адрес ответа
    - URL-адрес выхода.
    - URL-адрес входа Azure
    - Идентификатор Azure AD
    - URL-адрес выхода Azure
4. В последовательной консоли запустите выполнение таких команд:

    ```
    config user saml
    edit azure
    set entity-id <Entity ID>
    set single-sign-on-url <Reply URL>
    set single-logout-url <Logout URL>
    set idp-single-sign-on-url <Azure Login URL>
    set idp-entity-id <Azure AD Identifier>
    set idp-single-logout-url <Azure Logout URL>
    set idp-cert REMOTE_Cert_
    set user-name username
    set group-name group
    end
    ```
    > [!NOTE]
    > URL-адрес выхода Azure содержит знак `?`. Для этого требуется специальная последовательность клавиш, чтобы правильно передать ее в последовательную консоль FortiGate. Обычно это URL-адрес `https://login.microsoftonline.com/common/wsfederation?wa=wsignout1`. Чтобы указать его в последовательной консоли, введите:
        ```
        set idp-single-logout-url https://login.microsoftonline.com/common/wsfederation
        ```.
    Затем нажмите клавиши CTRL+V и вставьте остальную часть URL-адреса, чтобы завершить строку: 
        ```
        set idp-single-logout-url
        https://login.microsoftonline.com/common/wsfederation?wa=wsignout1.
        ```

5. Чтобы проверить конфигурацию, воспользуйтесь следующей командой:

    ```
    show user saml
    ```

#### <a name="for-group-matching"></a>Сопоставление групп

1. Перейдите на сайт https://portal.azure.com и откройте параметры виртуальной машины FortiGate.
2. В меню слева выберите **Последовательная консоль**.
3. Войдите в последовательную консоль с учетными данными администратора виртуальной машины FortiGate.
4. В последовательной консоли запустите выполнение таких команд:

    ```
    config user group
    edit <group 1 name>
    set member azure
    config match
    edit 1
    set server-name azure
    set group-name <group 1 Object Id>
    next
    end
    next
    ```

    Для каждой дополнительной группы, которая будет использовать различные возможности портала в FortiGate повторите эти команды (начиная со второй строки кода).

#### <a name="for-authentication-timeout"></a>Время ожидания проверки подлинности

1. Перейдите на сайт https://portal.azure.com и откройте параметры виртуальной машины FortiGate.
2. В меню слева выберите **Последовательная консоль**.
3. Войдите в последовательную консоль с учетными данными администратора виртуальной машины FortiGate.
4. В последовательной консоли запустите выполнение таких команд:

    ```
    config system global
    set remoteauthtimeout 60
    end
    ```
### <a name="create-vpn-portals-and-firewall-policy"></a>Создание VPN-порталов и политики брандмауэра

1. Перейдите по адресу `https://<address>`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
3. В меню слева выберите **VPN** > **SSL-VPN Portals** > **Create New** (VPN > Порталы SSL-VPN > Создать).
6. Укажите имя (обычно соответствующее ему в группе Azure, используемой для обеспечения возможностей пользовательского портала).
7. Нажмите знак "плюс" ( **+** ) рядом с пунктом **Source IP Pools** (Исходные пулы IP-адресов), выберите пул по умолчанию, а затем нажмите кнопку **Close** (Закрыть).
8. Настройте интерфейс для этой группы. Для тестирования это может быть настройка сообщений и темы портала. Здесь также можно создавать пользовательские закладки, через которые пользователь попадает на внутренние ресурсы.
9. Щелкните **ОК**.
10. Повторите шаги 5–9 для каждой группы Azure, которая будет работать с пользовательскими возможностями портала.
11. В разделе VPN нажмите **SSL-VPN Settings** (Параметры SSL-VPN).
12. Нажмите знак "плюс" ( **+** ) рядом с пунктом **Listen on Interfaces** (Ожидать передачи данных с интерфейсов), выберите **Port1** (Порт 1), а затем нажмите **Close** (Закрыть).
14. Если ранее был установлен пользовательский SSL-сертификат, измените значение параметра **Server Certificate** (Сертификат сервера), выбрав пользовательский SSL-сертификат в раскрывающемся меню.
15. В разделе **Authentication/Portal Mapping** (Проверка подлинности или сопоставление портала) щелкните **Create New** (Создать). Выберите первую группу Azure и сопоставьте ее с порталом с тем же именем. Нажмите кнопку **ОК**.
18. Повторите шаги 15–17 для каждого связывания группы Azure и портала.
19. В разделе **Authentication/Portal Mapping** (Проверка подлинности или сопоставление портала) измените значение параметра **All Other Users/Groups** (Все остальные пользователи и группы).
20. Установите для портала значение **full-access** (Полный доступ) и нажмите **OK** > **Apply** (ОК > Применить).
23. Прокрутите до верхней границы страницы **SSL-VPN Setting** (Параметр SSL-VPN) и щелкните предупреждение **No SSL-VPN policies exist. Click here to create a new SSL-VPN policy using these settings** (Политики SSL-VPN не существуют. Щелкните здесь, чтобы создать политику SSL-VPN с использованием этих параметров).
24. Укажите имя, например **VPN Grp**. Затем задайте для параметра **Outgoing Interface** (Исходящий интерфейс) значение **port** (порт) и выберите **Source** (Источник).
27. В разделе **Address** (Адрес) выберите **all** (все).
28. В разделе **User** (Пользователь) выберите первую группу Azure.
29. Нажмите **Close** > **Destination** (Закрыть > Назначение). В разделе **Address** (Адрес) это обычно внутренняя сеть. Выберите **login.microsoft.com** для тестирования.
32. Выберите **Close** > **Service** > **All** (Закрыть > Служба > Все). Выберите **Close** > **OK** (Закрыть > ОК).
37. В меню слева выберите **Policy & Objects** > **Firewall Policy** (Политика и объекты > Политика брандмауэра).
39. Разверните узел **SSL-VPN tunnel interface (ssl.root)**  > **port** (Туннельный интерфейс SSL-VPN (ssl.root) > порт).
40. Щелкните правой кнопкой мыши созданную ранее политику VPN (**VPN Grp 1**) и выберите пункт **Copy** (Копировать).
41. Щелкните правой кнопкой мыши политику VPN и выберите **Paste** > **Below** (Вставить > Ниже).
42. Измените новую политику, указав для нее другое имя (например, **VPN Grp2**). Также измените группу, к которой она применяется (на другую группу Azure).
43. Щелкните правой кнопкой мыши новую политику и задайте для нее состояние **Enabled** (Включена).


## <a name="test-sign-in-by-using-azure"></a>Проверка входа с помощью Azure

1. С помощью закрытого сеанса браузера перейдите по адресу `https://<address>`.  
2. Для входа должно быть перенаправление на Azure AD.
3. После предоставления учетных данных пользователя, назначенного приложению FortiGate в клиенте Azure, должен отобразиться соответствующий пользовательский портал.

    ![Снимок экрана настроек VPN для подключения к FortiGate через SSL](test-sign-in.png)
