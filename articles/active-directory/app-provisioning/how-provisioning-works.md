---
title: Поймите, как работает подготовка Azure AD Документы Майкрософт
description: Понять, как работает подготовка Azure AD
services: active-directory
documentationcenter: ''
author: msmimart
manager: CelesteDG
ms.service: active-directory
ms.subservice: app-provisioning
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/10/2019
ms.author: mimart
ms.reviewer: arvinh
ms.collection: M365-identity-device-management
ms.openlocfilehash: 555fb39836054be05102f4c28167d72016805639
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79481506"
---
# <a name="how-provisioning-works"></a>Описание процесса подготовки

Автоматическое подготовка означает создание идентификаторов пользователей и ролей в облачных приложениях, к которым пользователи нуждаются в доступе. Кроме создания удостоверений пользователей, автоматическая подготовка включает в себя обслуживание и удаление удостоверений пользователей по мере изменения их статуса или ролей. Перед началом развертывания можно просмотреть эту статью, чтобы узнать, как работает положение Azure AD, и получить рекомендации по настройке. 

Служба **предоставления AD Azure** предоставляет пользователям приложения SaaS и другие системы, подключившись к системе управления кросс-доменами (SCIM) 2.0 API управления пользователями, предоставленной поставщиком приложений. Эта конечная точка SCIM позволяет Azure AD программно создавать, обновлять и удалять пользователей. Для отдельных приложений служба подготовки может также создавать, обновлять и удалять дополнительные объекты, связанные с идентификацией, такие как группы и роли. Канал, используемый для подготовки между Azure AD и приложением, зашифрован с помощью шифрования HTTPS TLS.


![Диаграмма службы](./media/how-provisioning-works/provisioning0.PNG)
обеспечения aD Azure*1: Служба обеспечения ад-а ВС Azure*

![Исходящие данные](./media/how-provisioning-works/provisioning1.PNG)
о подготовке пользователей*Рисунок 2: "Исходящий" рабочий процесс подготовки пользователей из Azure AD в популярные приложения SaaS*

![Входящий рабочий процесс](./media/how-provisioning-works/provisioning2.PNG)
подготовки пользователей*Рисунок 3: "Входящий" рабочий процесс подготовки пользователей из популярных приложений управления человеческим капиталом (HCM) в Active Directory Azure и Active Directory Windows Server*

## <a name="provisioning-using-scim-20"></a>Подготовка с использованием SCIM 2.0

Служба предоставления AD Azure использует [протокол SCIM 2.0](https://techcommunity.microsoft.com/t5/Identity-Standards-Blog/bg-p/IdentityStandards) для автоматической подготовки. Служба подключается к конечной точке SCIM для приложения и использует схему объектов пользователя SCIM и REST AIS для автоматизации подготовки и де-подготовки пользователей и групп. Разъем для подготовки на основе SCIM предусмотрен для большинства приложений в галерее Azure AD. При создании приложений для Azure AD разработчики могут использовать API управления пользователями SCIM 2.0 для создания конечной точки SCIM, которая интегрирует Azure AD для подготовки. Для получения подробной информации [см.](../app-provisioning/use-scim-to-provision-users-and-groups.md)

Чтобы запросить автоматический разъем для подключения Azure AD для приложения, которое в настоящее время не имеет его, заполните [запрос на использование приложений Active Directory Azure.](https://aka.ms/aadapprequest)

## <a name="authorization"></a>Авторизация

Для подключения Azure AD к API управления пользователями требуются учетные данные. Во время настройки автоматической подготовки пользователя для приложения необходимо ввести действительные учетные данные. Вы можете найти типы учетных данных и требования к приложению, ссылаясь на учебник приложения. На портале Azure вы сможете протестировать учетные данные, припопытки Azure AD подключиться к приложению, работая с помощью предоставленных учетных данных.

Если для приложения также настроена одна регистрация на основе SAML, то внутренний лимит хранения Azure AD составляет 1024 байта. Это ограничение включает в себя все сертификаты, секретные токены, учетные данные и связанные с ними данные конфигурации, связанные с одним экземпляром приложения (также известным как основная запись службы в Azure AD). При настройке одного знака на основе SAML сертификат, используемый для подписания токенов SAML, часто потребляет более 50% пространства. Любые дополнительные элементы (секретные токены, УРИ, адреса электронной почты уведомлений, имена пользователей и пароли), которые вы вводите во время настройки предоставления пользовательского резерва, могут превысить лимит хранения. Для получения дополнительной [информации](../manage-apps/application-provisioning-config-problem-storage-limit.md)см.

## <a name="mapping-attributes"></a>Атрибуты отображения

При вхотливке пользователя для стороннего приложения SaaS портал Azure контролирует значения атрибутов с помощью отображений атрибутов. Картографы определяют атрибуты пользователя, которые текут между Azure AD и целевым приложением при подготовке или обновлении учетных записей пользователей.

Существует предварительно настроенный набор атрибутов и отображений атрибутов между объектами пользователей Azure AD и пользовательскими объектами каждого приложения SaaS. Некоторые приложения управляют другими типами объектов вместе с пользователями, такими как Группы.

При настройке подготовки важно просмотреть и настроить отображение атрибутов и рабочие процессы, определяющие, какие пользовательские (или групповые) свойства перетекают из Azure AD в приложение. Просмотрите и научите соответствующие**свойства (объекты соответствия с помощью этого атрибута),** которое используется для однозначной идентификации и сопоставления пользователей/групп между двумя системами.

Сопоставление атрибутов по умолчанию можно настроить в соответствии с потребностями вашего бизнеса. Таким образом, можно изменить или удалить существующие отображения атрибутов или создать новые отображения атрибутов. Для получения подробной информации [см.](../manage-apps/customize-application-attributes.md)

При настройке подготовки для приложения SaaS одним из типов сопоставления атрибутов, которые можно указать, является сопоставление выражений. Для этих карт необходимо написать скриптообразное выражение, которое позволяет преобразовывать данные пользователей в форматы, более приемлемые для приложения SaaS. Для получения подробной информации [см.](functions-for-customizing-application-data.md)

## <a name="scoping"></a>Scoping 
### <a name="assignment-based-scoping"></a>Отслеживание на основе заданий

Для исходящего подготовки из Azure AD в приложение SaaS, опираясь на [пользовательские или групповые назначения,](../manage-apps/assign-user-or-group-access-portal.md) является наиболее распространенным способом определения того, какие пользователи находятся в возможности подготовки. Поскольку назначения пользователей также используются для включения одного включения, один и тот же метод может быть использован для управления доступом и подготовкой. Отслеживание на основе заданий не применяется к сценариям входящего обеспечения, таким как Workday и Successfactors.

* **Группы.** С помощью лицензионного плана Azure AD Premium можно использовать группы для предоставления доступа к приложению SaaS. Затем, когда область подготовки устанавливается для **синхронизации только назначенных пользователей и групп,** служба обеспечения AD Azure AD будет предоставлять или отменять пользователей в зависимости от того, являются ли они членами группы, назначенной приложению. Сам объект группы не подготовлен, если приложение не поддерживает групповые объекты.

* **Динамические группы.** Служба предоставления услуг по предоставлению пользователей Azure AD может читать и предоставлять пользователям в [динамических группах.](../users-groups-roles/groups-create-rule.md) Имейте в виду эти предостережения и рекомендации:

  * Динамические группы могут повлиять на производительность сквозной подготовки от приложений Azure AD до Приложений SaaS.

  * Как быстро пользователь в динамической группе готовится или отменяется в приложении SaaS, зависит от того, насколько быстро динамическая группа может оценить изменения членства. Для получения информации о том, как проверить состояние обработки динамической группы, [см.](../users-groups-roles/groups-create-rule.md)

  * Когда пользователь теряет членство в динамической группе, это считается событием де-подготовки. Рассмотрим этот сценарий при создании правил для динамических групп.

* **Вложенные группы.** Служба предоставления услуг по предоставлению запроса AD Не может читать или предоставлять пользователям в вложенных группах. Служба может только читать и предоставлять пользователям, которые являются непосредственными членами явно назначенной группы. Это ограничение "групповых назначений для приложений" также влияет на один вход (см. [Использование группы для управления доступом к приложениям SaaS).](../users-groups-roles/groups-saasapps.md) Вместо этого, непосредственно назначить или иным [образом области в](define-conditional-rules-for-provisioning-user-accounts.md) группах, которые содержат пользователей, которые должны быть подготовлены.

### <a name="attribute-based-scoping"></a>Отслеживание на основе атрибутов 

Можно использовать фильтры для сканирования для определения правил, основанных на атрибутах, определяющих, какие пользователи подготовлены к приложению. Этот метод обычно используется для входящих подготовки от hCM приложений до Azure AD и Active Directory. Фильтры области настраиваются как часть сопоставления атрибутов для каждого соединителя подготовки пользователей Azure AD. Подробнее о настройке фильтров на основе атрибутов [см.](define-conditional-rules-for-provisioning-user-accounts.md)

### <a name="b2b-guest-users"></a>B2B (гость) пользователи

Можно использовать службу предоставления пользователям Azure AD услуг для предоставления B2B (или гостевых) пользователей в приложениях Azure AD приложениям SaaS. Однако для того, чтобы пользователи B2B вступали в приложение SaaS с помощью Azure AD, приложение SaaS должно настроить свой SAML-одиночный знак определенным образом. Дополнительные сведения о настройке приложений SaaS для поддержки входа пользователей B2B см. в разделе [Настройка приложений SaaS для службы совместной работы B2B](../b2b/configure-saas-apps.md).

Обратите внимание, что пользовательPrincipalName для гостевого пользователя часто хранится как "псевдоним "EXT".@domain.com когда пользовательPrincipalName включен в отображение атрибутов в качестве исходного атрибута, #EXT "удаляется из пользовательского PrincipalName". Если вам требуется, чтобы #EXT, чтобы присутствовать, замените userPrincipalName оригинальнымUserPrincipalName в качестве исходного атрибута. 

## <a name="provisioning-cycles-initial-and-incremental"></a>Циклы подготовки: начальные и постепенные

Когда Azure AD является исходной системой, служба обеспечения использует [запрос «Использование дельты» для отслеживания изменений в данных Microsoft Graph](https://docs.microsoft.com/graph/delta-query-overview) для мониторинга пользователей и групп. Служба подготовки выполняет первоначальный цикл в отношении исходной и целевой системы, за которым следуют периодические постепенные циклы.

### <a name="initial-cycle"></a>Первоначальный цикл

При начале работы службы обеспечения первый цикл:

1. Запрашивает всех пользователей и все группы из исходной системы, получая все атрибуты, определенные в [сопоставлениях атрибутов](customize-application-attributes.md).

2. Фильтрует полученных пользователей и группы с помощью настроенных [назначений](../manage-apps/assign-user-or-group-access-portal.md) или [фильтров области на основе атрибутов](define-conditional-rules-for-provisioning-user-accounts.md).

3. Когда пользователь назначен или в области подготовки, служба запрашивает целевую систему для соответствующего пользователя, используя указанные [соответствующие атрибуты.](customize-application-attributes.md#understanding-attribute-mapping-properties) Пример. Если имя userPrincipal в исходной системе является совпадающим атрибутом и соответствует атрибуту userName в целевой системе, то служба подготовки запрашивает у целевой системы атрибуты userName, которые соответствуют значениям имени userPrincipal в исходной системе.

4. Если пользователь не найден в целевой системе, он создается с помощью атрибутов, возвращенных из исходной системы. После создания учетной записи пользователя служба обеспечения обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех будущих операций на этом пользователе.

5. Если найден подходящий пользователь, он обновляется с помощью атрибутов, предоставляемых исходной системой. После сопоставления учетной записи пользователя служба обеспечения обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех будущих операций на этом пользователе.

6. Если отображение атрибутов содержит атрибуты "ссылки", служба делает дополнительные обновления в целевой системе для создания и связи упомянутых объектов. Например, пользователь может использовать атрибут Manager в целевой системе, который связан с другим пользователем, созданным в целевой системе.

7. Сохраните водяной знак в конце начального цикла, который обеспечивает отправную точку для более поздних дополнительных циклов.

Некоторые приложения, такие как ServiceNow, G Suite и Box, поддерживают не только предоставление пользователям, но и группы подготовки и их членов. В этих случаях, если подготовка групп включена в [картографах,](customize-application-attributes.md)служба обеспечения синхронизирует пользователей и группы, а затем синхронизирует членство в группе.

### <a name="incremental-cycles"></a>Инкрементные циклы

После первоначального цикла, все другие циклы будут:

1. Запрашивает у исходной системы всех пользователей и все группы, которые были обновлены с момента сохранения последнего водяного знака.

2. Фильтрует полученных пользователей и группы с помощью настроенных [назначений](../manage-apps/assign-user-or-group-access-portal.md) или [фильтров области на основе атрибутов](define-conditional-rules-for-provisioning-user-accounts.md).

3. Когда пользователь назначен или в области подготовки, служба запрашивает целевую систему для соответствующего пользователя, используя указанные [соответствующие атрибуты.](customize-application-attributes.md#understanding-attribute-mapping-properties)

4. Если пользователь не найден в целевой системе, он создается с помощью атрибутов, возвращенных из исходной системы. После создания учетной записи пользователя служба обеспечения обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех будущих операций на этом пользователе.

5. Если найден подходящий пользователь, он обновляется с помощью атрибутов, предоставляемых исходной системой. Если это недавно назначенная учетная запись, которая совпадает, служба обеспечения обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех будущих операций на этом пользователе.

6. Если отображение атрибутов содержит атрибуты "ссылки", служба делает дополнительные обновления в целевой системе для создания и связи упомянутых объектов. Например, пользователь может использовать атрибут Manager в целевой системе, который связан с другим пользователем, созданным в целевой системе.

7. Если пользователь, ранее оплачиваемый для подготовки, удаляется из сферы действия, включая неназначенное, служба отключает пользователя в целевой системе с помощью обновления.

8. Если пользователь, который ранее был в области для подготовки, отключается или обратимо удаляется в исходной системе, то служба отключает этого пользователя в целевой системе при обновлении.

9. Если пользователь, который ранее был в области для подготовки, необратимо удаляется в исходной системе, то служба удаляет этого пользователя в целевой системе. В Azure AD пользователи удаляются через 30 дней после мягкого удаления.

10. Сохраните новый водяной знак в конце инкрементного цикла, который обеспечивает отправную точку для более поздних дополнительных циклов.

> [!NOTE]
> Можно дополнительно отключить операции **«Создание,** **обновление»** или **«Удалить»** с помощью флажков **действий целевого объекта** в разделе [Mappings.](customize-application-attributes.md) Логикой отключения пользователей во время обновления также управляет сопоставление атрибутов из поля, например accountEnabled.

Служба подготовки продолжает работать спина к спине дополнительных циклов на неопределенный срок, с интервалами, определенными в [учебнике, специфичным для каждого приложения.](../saas-apps/tutorial-list.md) Дополнительные циклы продолжаются до тех пор, пока не произойдет одно из следующих событий:

- Служба вручную прекращается с помощью портала Azure или с помощью соответствующей команды Microsoft GraphAPI.
- Новый начальный цикл срабатывает с помощью **ясного состояния и перезагрузки** опции на портале Azure или с помощью соответствующей команды Microsoft GraphAPI. Это действие очищает все сохраненные водяные знаки и вызывает повторную оценку всех исходных объектов.
- Новый начальный цикл срабатывает из-за изменения отображения атрибутов или фильтров для скопирования. Это действие также очищает все сохраненные водяные знаки и вызывает повторную оценку всех исходных объектов.
- Процесс подготовки переходит в карантин (см. ниже) из-за высокой частоты ошибок и остается в карантине более четырех недель. В этом случае служба будет автоматически отключена.

### <a name="errors-and-retries"></a>Ошибки и повторные попытки

Если ошибка в целевой системе предотвращает добавление, обновление или удаление отдельного пользователя в целевой системе, операция будет повторена в следующем цикле синхронизации. Если операция с пользователем продолжает завершаться сбоем, то повторные попытки будут выполняться с меньшей частотой вплоть до одной попытки в день. Чтобы устранить сбой, администраторы должны проверить [журналы подготовки,](../reports-monitoring/concept-provisioning-logs.md?context=azure/active-directory/manage-apps/context/manage-apps-context) чтобы определить причину и принять соответствующие меры. Ниже перечислены распространенные ошибки.

- Не заполнен атрибут пользователей в исходной системе, требуемый в целевой системе.
- Пользователи, имеющие значение атрибута в исходной системе, для которой есть уникальное ограничение в целевой системе, и то же значение присутствует в другой записи пользователя

Разрешить эти сбои, отрегулируя значения атрибутов для пострадавшего пользователя в исходной системе или путем настройки отображения атрибутов, чтобы они не вызывали конфликтов.

### <a name="quarantine"></a>Карантин

Если большинство или все вызовы, которые выполняются против целевой системы, постоянно выходят из-за ошибки (например, недействительных учетных данных админовов), задание подготовки переходит в состояние "карантина". Это состояние указывается в [сводном отчете](../manage-apps/check-status-user-account-provisioning.md) и по электронной почте, если уведомления по электронной почте были настроены на портале Azure.

При карантине частота дополнительных циклов постепенно снижается до одного раза в день.

Подготовка задания выходит из карантина после того, как все ошибки-нарушители будут исправлены и начинается следующий цикл синхронизации. Если задания подготовки остается в карантине более четырех недель, оно отключается. Подробнее о карантине [можно](../manage-apps/application-provisioning-quarantine-status.md)здесь.

### <a name="how-long-provisioning-takes"></a>Длительность подготовки

Производительность зависит от того, выполняется ли задание подготовки начального цикла подготовки или поэтапный цикл. Подробную информацию о том, сколько времени занимает подготовка и как контролировать состояние службы подготовки, [см.](../manage-apps/application-provisioning-when-will-provisioning-finish-specific-user.md)

### <a name="how-to-tell-if-users-are-being-provisioned-properly"></a>Как указывать, правильно ли подготовлены пользователи

Все операции, управляемые службой обеспечения пользователей, записываются в [журналы (предварительный просмотр)](../reports-monitoring/concept-provisioning-logs.md?context=azure/active-directory/manage-apps/context/manage-apps-context)AD Azure AD. В журналы входят все операции чтения и записи, сделанные в исходные и целевые системы, а также данные пользователей, которые были прочитаны или написаны во время каждой операции. Информацию о том, как читать журналы подготовки, можно узнать на портале Azure, смотрите [руководство по подготовке к отчетам](../manage-apps/check-status-user-account-provisioning.md).

## <a name="de-provisioning"></a>Де-предоставление

Служба предоставления AD Azure AD синхронизирует исходные и целевые системы путем де-предоставления учетных записей, когда пользователи больше не должны иметь доступ. 

Служба предоставления AD Azure мягко удаит пользователя в приложении, когда приложение suupports мягко удаляет (запрос обновления с активным и ложным) и любое из следующих событий происходит:

* Учетная запись пользователя удалена в Azure AD
*   Пользователь не назначен из приложения
*   Пользователь больше не отвечает фильтру скопирования и выходит за рамки
    * По умолчанию служба предоставления Azure AD мягко удаляет или отключает пользователей, которые выходят за рамки. Если вы хотите переопределить это поведение по умолчанию, можно установить флаг, чтобы [пропустить вне зоны удаления.](../app-provisioning/skip-out-of-scope-deletions.md)
*   Свойство AccountEnabled настроено на ложное

Если происходит одно из вышеперечисленных четырех событий и целевое приложение не поддерживает мягкие удаления, служба подготовки отправит запрос DELETE на постоянное удаление пользователя из приложения. 

Через 30 дней после удаления пользователя в Azure AD они будут удалены из клиента. На этом этапе служба обеспечения отправит запрос DELETE на постоянное удаление пользователя в приложении. В любое время в течение 30-дневного окна, вы можете [вручную удалить пользователя постоянно,](../fundamentals/active-directory-users-restore.md)который отправляет запрос на удаление в приложение.

Если в отображении атрибута IsSoftDeleted используется атрибут, он используется для определения состояния пользователя и отправки запроса на обновление с активным и ложным для мягкого удаления пользователя. 

## <a name="next-steps"></a>Next Steps

[Планирование развертывания автоматической подготовки пользователей](../app-provisioning/plan-auto-user-provisioning.md)

[Настройка подготовки для приложения из коллекции](../manage-apps/configure-automatic-user-provisioning-portal.md)

[Создайте конечную точку SCIM и настройте подготовку при создании собственного приложения](../app-provisioning/use-scim-to-provision-users-and-groups.md)

[Проблемы устранения неполадок при настройке и подготовке пользователей к приложению.](../manage-apps/application-provisioning-config-problem.md)
