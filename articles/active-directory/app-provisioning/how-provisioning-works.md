---
title: Общие сведения о процессе подготовки в Azure AD | Документация Майкрософт
description: Общие сведения о процессе подготовки в Azure AD
services: active-directory
author: msmimart
manager: CelesteDG
ms.service: active-directory
ms.subservice: app-provisioning
ms.topic: conceptual
ms.workload: identity
ms.date: 05/20/2020
ms.author: mimart
ms.reviewer: arvinh
ms.openlocfilehash: 533e38206b9a85b449880d88c9ff969c051fac53
ms.sourcegitcommit: 958f086136f10903c44c92463845b9f3a6a5275f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2020
ms.locfileid: "83712236"
---
# <a name="how-provisioning-works"></a>Описание процесса подготовки

Автоматическая подготовка приложений — это создание удостоверений и ролей пользователей в облачных приложениях, к которым пользователям требуется доступ. Кроме создания удостоверений пользователей, автоматическая подготовка включает в себя обслуживание и удаление удостоверений пользователей по мере изменения их статуса или ролей. Перед началом развертывания вы можете ознакомиться с этой статьей, чтобы узнать о процессе подготовки в Azure AD и получить рекомендации по настройке. 

**Служба подготовки Azure AD** подготавливает пользователей для приложений SaaS и других систем путем подключения к конечным точкам API управления пользователями System for Cross-Domain Identity Management (SCIM) версии 2.0, которые предоставляются каждым поставщиком приложений. Такая конечная точка SCIM позволяет Azure AD создавать, обновлять и удалять пользователей средствами программирования. Для выбранных приложений служба подготовки может также создавать, обновлять и удалять дополнительные объекты, связанные с удостоверениями, такие как группы и роли. Используемый для подготовки канал между Azure AD и приложением шифруется с использованием протокола HTTPS с шифрованием TLS 1.2.


![Служба подготовки Azure AD](./media/how-provisioning-works/provisioning0.PNG)
*Рис. 1. Служба подготовки Azure AD*

![Исходящий рабочий процесс подготовки пользователей](./media/how-provisioning-works/provisioning1.PNG)
*Рис. 2. "Исходящий" рабочий процесс подготовки пользователей из Azure AD в популярные приложения SaaS*

![Входящий рабочий процесс подготовки пользователей](./media/how-provisioning-works/provisioning2.PNG)
*Рис. 3. "Входящий" рабочий процесс подготовки пользователей из популярных приложений управления кадрами (HCM) в Azure Active Directory и Windows Server Active Directory*

## <a name="provisioning-using-scim-20"></a>Подготовка с помощью SCIM 2.0

Служба подготовки Azure AD использует для автоматической подготовки [протокол SCIM 2.0](https://techcommunity.microsoft.com/t5/Identity-Standards-Blog/bg-p/IdentityStandards). Служба подключается к конечной точке SCIM для приложения и использует схему объектов пользователей SCIM и интерфейсы REST API для автоматизации подготовки и отзыва пользователей и групп. Соединитель подготовки на основе SCIM предоставляется для большинства приложений в коллекции Azure AD. При создании приложений для Azure AD разработчики могут использовать API управления пользователями SCIM 2.0 для создания конечной точки SCIM, которая интегрирует Azure AD для подготовки. Дополнительные сведения см. в статье [Создание конечной точки SCIM и настройка подготовки пользователей](../app-provisioning/use-scim-to-provision-users-and-groups.md).

Чтобы запросить соединитель автоматической подготовки Azure AD для приложения, в котором он в настоящее время отсутствует, заполните [запрос приложения Azure Active Directory](https://aka.ms/aadapprequest).

## <a name="authorization"></a>Авторизация

Для подключения к API управления пользователями приложения Azure AD необходимы учетные данные. При настройке автоматической подготовки пользователей для приложения необходимо ввести действительные учетные данные. Типы учетных данных и требования к ним для приложения см. в учебнике по приложению. На портале Azure можно проверить определенные учетные данные. В ходе этой проверки осуществляется попытка подключения Azure AD к приложению для подготовки приложения.

Если для приложения также настроен единый вход на основе SAML, предельная емкость хранилища для каждого приложения в Azure AD составляет 1024 байт. Эта предельная емкость используется для всех сертификатов, секретных маркеров, учетных данных и связанных данных конфигурации, относящихся к одному экземпляру приложения (также известных как запись субъекта-службы в Azure AD). При настройке единого входа на основе SAML сертификат, используемый для подписания токенов SAML, часто занимает более 50 % пространства. Любые дополнительные элементы (токены секретов, URI, адреса электронной почты для уведомлений, имена пользователей и пароли), которые вводятся в ходе настройки подготовки пользователей, могут привести к превышению передельной емкости хранилища. Дополнительные сведения см. в статье [Проблема при сохранении учетных данных администратора во время настройки подготовки пользователей](../manage-apps/application-provisioning-config-problem-storage-limit.md).

## <a name="mapping-attributes"></a>Сопоставления атрибутов

Если включена подготовка пользователей для сторонних приложений SaaS, портал Azure определяет значения их атрибутов посредством сопоставления атрибутов. Сопоставления определяют атрибуты пользователей, которыми обмениваются Azure AD и целевое приложение, при подготовке и обновлении учетных записей пользователей.

Существует предварительно настроенный набор атрибутов и сопоставлений атрибутов между объектами пользователей Azure AD и каждого приложения SaaS. Некоторые приложения управляют не только пользователями, но и другими типами объектов, такими как группы.

При настройке подготовки важно просмотреть и настроить сопоставления атрибутов и рабочие процессы, которые определяют, какие свойства пользователей (или групп) передаются из Azure AD в приложение. Проверьте и настройте свойство сопоставления **Match objects using this attribute** (Сопоставлять объекты по этому атрибуту), используемое для уникальной идентификации и сопоставления пользователей или групп между двумя системами.

Сопоставление атрибутов по умолчанию можно настроить в соответствии с потребностями вашего бизнеса. Поэтому можно изменить или удалить существующие сопоставления атрибутов или создать новые. Дополнительные сведения см. в статье [Настройка сопоставлений атрибутов для подготовки пользователей для приложений SaaS](../manage-apps/customize-application-attributes.md).

При настройке подготовки для приложения SaaS одним из типов сопоставления атрибутов, которые можно указать, является сопоставление выражений. Для этих сопоставлений необходимо написать выражение, похожее на скрипт. Оно позволит вам преобразовать данные пользователей в форматы, более подходящие для приложений SaaS. Дополнительные сведения см. в статье [Запись выражений для сопоставления атрибутов](functions-for-customizing-application-data.md).

## <a name="scoping"></a>Scoping 
### <a name="assignment-based-scoping"></a>Определение области применения на основе назначения

Наиболее распространенным способом определения пользователей, для которых требуется выполнить исходящую подготовку из Azure AD для приложения SaaS, является [назначение пользователей или групп](../manage-apps/assign-user-or-group-access-portal.md). Так как назначения пользователей применяются также и для включения единого входа, для управления доступом и подготовкой можно использовать один и тот же метод. Определение области на основе назначения неприменимо для входящих сценариев подготовки, например для Workday и SuccessFactors.

* **Группы.** Благодаря плану лицензирования Azure AD Premium вы сможете использовать группы при предоставлении доступа к приложению SaaS. Затем, если для области подготовки задано значение **Sync only assigned users and groups** (Синхронизация только назначенных пользователей и групп), служба подготовки Azure AD будет подготавливать или отзывать пользователей в зависимости от того, являются ли они членами группы, назначенной приложению. Сам объект группы не подготавливается, если приложение не поддерживает объекты групп. Убедитесь, что для групп, назначенных приложению, свойство "SecurityEnabled" имеет значение "True".

* **Динамические группы.** Служба подготовки пользователей Azure AD может считывать и подготавливать пользователей в [динамических группах](../users-groups-roles/groups-create-rule.md). Примите во внимание следующие оговорки и рекомендации.

  * Использование динамических групп может повлиять на производительность комплексной подготовки из Azure AD для приложений SaaS.

  * Скорость подготовки и отзыва пользователя из динамической группы в приложении SaaS зависит от того, как быстро динамическая группа может оценить изменения членства. Дополнительные сведения см. в статье о том, [как проверить состояние обработки динамической группы на основе правила членства в коллекции](../users-groups-roles/groups-create-rule.md).

  * Когда пользователь теряет членство в динамической группе, это считается событием отзыва. Рассмотрим этот сценарий при создании правил для динамических групп.

* **Вложенные группы.** Служба подготовки пользователей Azure AD может считывать и подготавливать пользователей во вложенных группах. Она может только считать и подготовить пользователей, которые являются непосредственными участниками группы, назначенной явным образом. Это ограничение назначений на основе группы для приложений, которое также влияет на единый вход (см. статью [Использование группы для управления доступом к приложениям SaaS](../users-groups-roles/groups-saasapps.md)). Вместо этого следует явно назначить группы, содержащие пользователей, которых нужно подготовить, или [указать их область](define-conditional-rules-for-provisioning-user-accounts.md) другим способом.

### <a name="attribute-based-scoping"></a>Определение области на основе атрибутов 

С помощью фильтров области можно задать правила на основе атрибутов, которые управляют подготовкой пользователей для работы с приложением. Этот метод часто используется для входящей подготовки из приложений HCM для Azure AD и доменных служб Active Directory. Фильтры области настраиваются как часть сопоставления атрибутов для каждого соединителя подготовки пользователей Azure AD. Дополнительные сведения см. в статье о [настройке фильтров области на основе атрибутов ](define-conditional-rules-for-provisioning-user-accounts.md).

### <a name="b2b-guest-users"></a>Пользователи B2B (гостевые пользователи)

Службу подготовки пользователей Azure AD можно использовать для подготовки пользователей B2B (или гостевых пользователей) в Azure AD для приложений SaaS. Тем не менее, чтобы пользователи B2B вошли в приложение SaaS с помощью Azure AD, в приложении SaaS необходимо особым образом настроить возможность единого входа на основе SAML. Дополнительные сведения о настройке приложений SaaS для поддержки входа пользователей B2B см. в разделе [Настройка приложений SaaS для службы совместной работы B2B](../b2b/configure-saas-apps.md).

Обратите внимание, что атрибут userPrincipalName для гостевого пользователя часто хранится в виде "alias#EXT#@domain.com". Если userPrincipalName включен в сопоставления атрибутов как исходный атрибут, из него удаляется часть "#EXT#". Если требуется сохранить #EXT#, используйте в качестве исходного атрибута не userPrincipalName, а originalUserPrincipalName. 

## <a name="provisioning-cycles-initial-and-incremental"></a>Циклы подготовки: начальный и добавочный

Когда исходной системой является Azure AD, служба подготовки использует [разностный запрос для отслеживания данных в Microsoft Graph](https://docs.microsoft.com/graph/delta-query-overview), чтобы отслеживать пользователей и группы. Служба подготовки выполняет начальный цикл исходной и целевой систем, после чего осуществляет периодические добавочные циклы.

### <a name="initial-cycle"></a>Начальный цикл

При запуске службы подготовки выполняется первый цикл, состоящий из следующих этапов:

1. Запрашивает всех пользователей и все группы из исходной системы, получая все атрибуты, определенные в [сопоставлениях атрибутов](customize-application-attributes.md).

2. Фильтрует полученных пользователей и группы с помощью настроенных [назначений](../manage-apps/assign-user-or-group-access-portal.md) или [фильтров области на основе атрибутов](define-conditional-rules-for-provisioning-user-accounts.md).

3. Если пользователь назначен или должен быть подготовлен, служба запрашивает у целевой системы соответствующего пользователя с помощью указанных [совпадающих атрибутов](customize-application-attributes.md#understanding-attribute-mapping-properties). Пример Если имя userPrincipal в исходной системе является совпадающим атрибутом и соответствует атрибуту userName в целевой системе, то служба подготовки запрашивает у целевой системы атрибуты userName, которые соответствуют значениям имени userPrincipal в исходной системе.

4. Если соответствующий пользователь в целевой системе не найден, он создается с использованием атрибутов, возвращенных из исходной системы. После создания учетной записи пользователя служба подготовки обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех последующих операций с таким пользователем.

5. Если соответствующий пользователь найден, он обновляется с использованием атрибутов, предоставляемых исходной системой. После сопоставления учетной записи пользователя служба подготовки обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех последующих операций с таким пользователем.

6. Если сопоставления атрибутов содержат "ссылочные" атрибуты, то служба выполняет дополнительные обновления в целевой системе, чтобы создать и привязать объекты, на которые указывают ссылки. Например, пользователь может использовать атрибут Manager в целевой системе, который связан с другим пользователем, созданным в целевой системе.

7. В конце начального цикла сохраняется водяной знак, который обеспечивает начальную точку для последующих добавочных циклов.

Некоторые приложения, такие как ServiceNow, G Suite и Box, подготавливают не только пользователей, но и группы и их участников. В таких случаях, если подготовка групп включена в [сопоставления](customize-application-attributes.md), то служба подготовки синхронизирует пользователей и группы, а затем синхронизирует членство в группах.

### <a name="incremental-cycles"></a>Добавочные циклы

После начального цикла все остальные циклы выполняются следующим образом.

1. Запрашивает у исходной системы всех пользователей и все группы, которые были обновлены с момента сохранения последнего водяного знака.

2. Фильтрует полученных пользователей и группы с помощью настроенных [назначений](../manage-apps/assign-user-or-group-access-portal.md) или [фильтров области на основе атрибутов](define-conditional-rules-for-provisioning-user-accounts.md).

3. Если пользователь назначен или должен быть подготовлен, служба запрашивает у целевой системы соответствующего пользователя с помощью указанных [совпадающих атрибутов](customize-application-attributes.md#understanding-attribute-mapping-properties).

4. Если соответствующий пользователь в целевой системе не найден, он создается с использованием атрибутов, возвращенных из исходной системы. После создания учетной записи пользователя служба подготовки обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех последующих операций с таким пользователем.

5. Если соответствующий пользователь найден, он обновляется с использованием атрибутов, предоставляемых исходной системой. Если сопоставляется только что назначенная учетная запись пользователя, служба подготовки обнаруживает и кэширует идентификатор целевой системы для нового пользователя. Этот идентификатор используется для выполнения всех последующих операций с таким пользователем.

6. Если сопоставления атрибутов содержат "ссылочные" атрибуты, то служба выполняет дополнительные обновления в целевой системе, чтобы создать и привязать объекты, на которые указывают ссылки. Например, пользователь может использовать атрибут Manager в целевой системе, который связан с другим пользователем, созданным в целевой системе.

7. Если пользователь, который ранее был в области для подготовки, удаляется из нее (включая отмену назначения), то служба отключает этого пользователя в целевой системе при обновлении.

8. Если пользователь, который ранее был в области для подготовки, отключается или обратимо удаляется в исходной системе, то служба отключает этого пользователя в целевой системе при обновлении.

9. Если пользователь, который ранее был в области для подготовки, необратимо удаляется в исходной системе, то служба удаляет этого пользователя в целевой системе. В Azure AD пользователи необратимо удаляются через 30 дней после обратимого удаления.

10. В конце добавочного цикла сохраняется новый водяной знак, который обеспечивает начальную точку для последующих добавочных циклов.

> [!NOTE]
> Операции **создания**, **обновления** или **удаления** также можно отключить в разделе [Сопоставления](customize-application-attributes.md) с помощью флажков **Действия с целевыми объектами**. Логикой отключения пользователей во время обновления также управляет сопоставление атрибутов из поля, например accountEnabled.

Служба подготовки будет выполнять полные добавочные циклы неопределенно долгое время через интервалы, определенные в [отдельном учебнике по каждому приложению](../saas-apps/tutorial-list.md). Добавочные циклы продолжаются до тех пор, пока не произойдет одно из следующих событий.

- Служба останавливается вручную с помощью портала Azure или соответствующей команды API Microsoft Graph.
- Активируется новый начальный цикл с помощью параметра **Clear state and restart** (Очистить состояние и перезапустить) на портале Azure или с помощью соответствующей команды API Microsoft Graph. При выполнении этого действия также удаляются все сохраненные водяные знаки, а все исходные объекты должны быть оценены повторно.
- Из-за изменений сопоставлений атрибутов или фильтров области запускается новый начальный цикл. При выполнении этого действия также удаляются все сохраненные водяные знаки, а все исходные объекты должны быть оценены повторно.
- Процесс подготовки переходит в карантин (см. ниже) из-за высокой частоты ошибок и остается в карантине более четырех недель. В этом случае служба будет автоматически отключена.

### <a name="errors-and-retries"></a>Ошибки и повторные попытки

Если из-за произошедшей в целевой системе ошибки в ней не удается добавить, обновить или удалить отдельного пользователя, то данная операция будет повторена при следующем цикле синхронизации. Если операция с пользователем продолжает завершаться сбоем, то повторные попытки будут выполняться с меньшей частотой вплоть до одной попытки в день. Чтобы устранить ошибку, администраторы должны будут проверить [журналы подготовки](../reports-monitoring/concept-provisioning-logs.md?context=azure/active-directory/manage-apps/context/manage-apps-context), чтобы определить первопричину и предпринять соответствующие действия. Ниже перечислены распространенные ошибки.

- Не заполнен атрибут пользователей в исходной системе, требуемый в целевой системе.
- У пользователей в исходной системе имеется значение атрибута, для которого в целевой системе установлено уникальное ограничение, и это же значение присутствует в другой записи пользователя.

Устраните эти ошибки, настроив значения атрибутов для затронутого пользователя в исходной системе или настроив сопоставления атрибутов таким образом, чтобы не возникали конфликты.

### <a name="quarantine"></a>Карантин

Если большинство или все вызовы, отправленные целевой системе, последовательно завершаются сбоем из-за ошибки (например, в случае недопустимых учетных данных администратора), задание подготовки переходит в "карантин". Об этом состоянии сообщается в [сводном отчете о подготовке](../manage-apps/check-status-user-account-provisioning.md) и по электронной почте, если на портале Azure были настроены уведомления по электронной почте.

После перехода в карантин частота добавочных циклов постепенно уменьшается до одного раза в день.

Карантин снимается с задания подготовки после исправления всех ошибок, послуживших его причиной, после чего начнется следующий цикл синхронизации. Если задания подготовки остается в карантине более четырех недель, оно отключается. Дополнительные сведения о состояниях карантина см. [здесь](../manage-apps/application-provisioning-quarantine-status.md).

### <a name="how-long-provisioning-takes"></a>Длительность подготовки

Производительность зависит от того, какой цикл задания подготовки выполняется: первоначальный или добавочный. Дополнительные сведения о том, сколько времени занимает подготовка и как отслеживать состояние службы подготовки, см. в статье [Проверка состояния подготовки пользователей](../manage-apps/application-provisioning-when-will-provisioning-finish-specific-user.md).

### <a name="how-to-tell-if-users-are-being-provisioned-properly"></a>Проверка правильности подготовки пользователей

Все операции, которые выполняет служба подготовки пользователей, записываются в [журналы подготовки (предварительная версия)](../reports-monitoring/concept-provisioning-logs.md?context=azure/active-directory/manage-apps/context/manage-apps-context) Azure AD. Журналы содержат записи обо всех операциях чтения и записи, которые выполняются в исходной и целевой системах, а также сведения о том, какие данные пользователей считаны или записаны во время каждой из этих операций. Сведения о чтении журналов подготовки на портале Azure см. в [руководстве по отчетам о подготовке](../manage-apps/check-status-user-account-provisioning.md).

## <a name="de-provisioning"></a>Отзыв

Служба подготовки Azure AD обеспечивает синхронизацию исходной и целевой систем путем отзыва учетных записей, в результате которого пользователи лишаются права доступа. 

Служба подготовки Azure AD будет обратимо удалять пользователя из приложения, если приложение поддерживает такое удаление (в запросе на обновление параметр active имеет значение false) и происходит любое из следующих событий.

* Учетная запись пользователя удалена в Azure AD.
*   Назначение пользователя отменено из приложения.
*   Пользователь больше не соответствует условиям фильтра определения области и не принадлежит области.
    * По умолчанию служба подготовки Azure AD обратимо удаляет или отключает пользователей, которые больше не принадлежат области. Если вы хотите переопределить это поведение по умолчанию, можно установить флаг [пропуска удаления пользователей вне области](../app-provisioning/skip-out-of-scope-deletions.md).
*   Для свойства AccountEnabled установлено значение False.

Если происходит одно из четырех указанных выше событий, но целевое приложение не поддерживает обратимое удаление, служба подготовки отправит запрос DELETE для окончательного удаления пользователя из приложения. 

Через 30 дней после удаления пользователя из Azure AD он будет окончательно удален из клиента. На этом этапе служба подготовки отправит запрос DELETE для окончательного удаления пользователя из приложения. В течение этого 30-дневного периода можно в любое время [вручную окончательно удалить пользователя](../fundamentals/active-directory-users-restore.md), который отправил запрос на удаление в приложение.

Если в сопоставлениях атрибутов присутствует атрибут IsSoftDeleted, он используется для определения состояния пользователя и отправки запроса на обновление с параметром active равным false для обратимого удаления пользователя. 

## <a name="next-steps"></a>Next Steps

[Планирование развертывания автоматической подготовки пользователей](../app-provisioning/plan-auto-user-provisioning.md)

[Настройка подготовки для приложения из коллекции](../manage-apps/configure-automatic-user-provisioning-portal.md)

[Создание конечной точки SCIM и настройка подготовки при создании собственного приложения](../app-provisioning/use-scim-to-provision-users-and-groups.md)

[Устранение неполадок при настройке и подготовке пользователей для приложения](../manage-apps/application-provisioning-config-problem.md)
