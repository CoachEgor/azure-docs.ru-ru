---
title: Azure AD Connect устранение неполадок при подготовке облака
description: В этой статье описывается, как устранять неполадки, которые могут возникнуть при работе с агентом подготовки облака.
author: billmath
ms.author: billmath
manager: daveba
ms.date: 12/02/2019
ms.topic: how-to
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 34796a435536a48100b7434ed5267802cd2d549f
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "89226953"
---
# <a name="cloud-provisioning-troubleshooting"></a>Устранение неполадок подготовки облака

Подготовка облака затрагивает множество различных аспектов и имеет множество различных зависимостей. Эта широкая область может выдавать различные проблемы. Эта статья поможет вам устранить эти проблемы. В нем представлены типичные области, позволяющие сосредоточиться, как собирать дополнительные сведения, и различные методы, которые можно использовать для выявления проблем.


## <a name="common-troubleshooting-areas"></a>Распространенные области устранения неполадок

|Имя|Описание|
|-----|-----|
|[Проблемы с агентом](#agent-problems)|Убедитесь, что агент установлен правильно и взаимодействует с Azure Active Directory (Azure AD).|
|[Проблемы синхронизации объектов](#object-synchronization-problems)|Используйте журналы подготовки для устранения неполадок синхронизации объектов.|
|[Подготовка проблем, связанных с карантином](#provisioning-quarantined-problems)|Сведения о подготовке к работе в карантине и способах их устранения.|


## <a name="agent-problems"></a>Проблемы с агентом
Вот некоторые из первых вещей, которые необходимо проверить с помощью агента:

-  Установлен ли он?
-  Агент запущен локально?
-  Является ли агент на портале?
-  Помечен ли агент как работоспособный?

Эти элементы можно проверить в портал Azure и на локальном сервере, на котором выполняется агент.

### <a name="azure-portal-agent-verification"></a>Проверка агента на портале Azure

Чтобы убедиться, что агент отображается в Azure и является работоспособным, выполните следующие действия.

1. Войдите на портал Azure.
1. Слева щелкните **Azure Active Directory** > **Azure AD Connect**. Посередине выберите **Управление подготовкой (предварительная версия)** .
1. На экране **Подготовка Azure AD (предварительная версия)** щелкните **Проверить все агенты**.

   ![Проверка всех агентов](media/how-to-install/install7.png)</br>
 
1. На экране " **локальные агенты подготовки** " вы увидите установленные агенты. Убедитесь, что рассматриваемый агент есть и помечен как *работоспособный*.

   ![Экран локальных агентов подготовки](media/how-to-install/install8.png)</br>

### <a name="verify-the-port"></a>Проверка порта

Убедитесь, что Azure прослушивает порт 443 и что агент может обмениваться данными с ним. 

Этот тест проверяет, могут ли агенты обмениваться данными с Azure через порт 443. Откройте браузер и перейдите к предыдущему URL-адресу с сервера, на котором установлен агент.

![Проверка достижимости порта](media/how-to-install/verify2.png)

### <a name="on-the-local-server"></a>На локальном сервере

Чтобы убедиться, что агент выполняется, сделайте следующее.

1. На сервере с установленным агентом откройте **службы** , перейдя к нему или перейдя к запуску **Start**  >  **Run**  >  **Services. msc**.
1. В разделе **Службы** убедитесь, что **агент обновления Microsoft Azure AD Connect** и **агент подготовки Microsoft Azure AD Connect** присутствуют в списке и имеют состояние *Выполняется*.

   ![Экран служб](media/how-to-troubleshoot/troubleshoot1.png)

### <a name="common-agent-installation-problems"></a>Распространенные проблемы при установке агента

В следующих разделах описаны некоторые распространенные проблемы с установкой агентов и типичные способы их устранения.

#### <a name="agent-failed-to-start"></a>Не удалось запустить агент

Может появиться сообщение об ошибке, в котором говорится:

**Не удалось запустить службу "Microsoft Azure AD подключить агент подготовки". Убедитесь, что у вас есть необходимые привилегии для запуска системных служб.** 

Эта проблема обычно вызвана групповой политикой, которая не позволила применить разрешения к локальной учетной записи NT Service log-on, созданной установщиком (NT Сервице\аадконнектпровисионингажент). Эти разрешения необходимы для запуска службы.

Чтобы устранить эту проблему, выполните следующие действия.

1. Войдите на сервер, используя учетную запись администратора.
1. Перейдите на страницу **Службы** или откройте ее, последовательно выбрав **Пуск** > **Выполнить** > **Services.msc**.
1. В разделе " **службы**" дважды щелкните **Microsoft Azure AD подключить агент подготовки**.
1. На вкладке **Вход в** систему измените **эту учетную запись** на администратор домена. Затем перезапустите службу. 

   ![Вкладка "вход в систему"](media/how-to-troubleshoot/troubleshoot3.png)

#### <a name="agent-times-out-or-certificate-is-invalid"></a>Истекло время ожидания агента, или сертификат недействителен

При попытке зарегистрировать агент может появиться следующее сообщение об ошибке.

![Сообщение об ошибке времени ожидания](media/how-to-troubleshoot/troubleshoot4.png)

Обычно эта проблема связана с тем, что агент не может подключиться к гибридной службе удостоверений и требует настройки прокси-сервера HTTP. Чтобы устранить эту проблему, настройте исходящий прокси-сервер. 

Агент подготовки поддерживает использование исходящего прокси-сервера. Его можно настроить, изменив файл конфигурации агента *C:\Program Files\Microsoft Azure AD Connect подготовки Agent\AADConnectProvisioningAgent.exe.config*. Добавьте в него следующие строки в конец файла непосредственно перед закрывающим `</configuration>` тегом.
Замените переменные `[proxy-server]` и `[proxy-port]` значениями имени прокси-сервера и порта.

```xml
    <system.net>
        <defaultProxy enabled="true" useDefaultCredentials="true">
            <proxy
                usesystemdefault="true"
                proxyaddress="http://[proxy-server]:[proxy-port]"
                bypassonlocal="true"
            />
        </defaultProxy>
    </system.net>
```

#### <a name="agent-registration-fails-with-security-error"></a>Сбой регистрации агента с ошибкой безопасности

При установке агента подготовки облака может появиться сообщение об ошибке.

Эта проблема обычно вызвана тем, что агенту не удается выполнить сценарии регистрации PowerShell из-за локальных политик выполнения PowerShell.

Чтобы устранить эту проблему, измените политики выполнения PowerShell на сервере. Необходимо, чтобы политики компьютера и пользователя были заданы как *неопределенные* или *RemoteSigned*. Если они заданы как *неограниченные*, вы увидите эту ошибку. Дополнительные сведения см. в разделе [политики выполнения PowerShell](/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-6). 

### <a name="log-files"></a>Файлы журнала

По умолчанию агент выдает минимальные сообщения об ошибках и сведения о трассировке стека. Эти журналы трассировки можно найти в папке *К:\ПРОГРАМДАТА\МИКРОСОФТ\АЗУРЕ AD Connect подготовка Agent\Trace*.

Чтобы собрать дополнительные сведения для устранения неполадок, связанных с агентом, выполните следующие действия.

1. Закройте службу **Microsoft Azure AD подключить агент подготовки**.
1. Создайте копию исходного файла конфигурации: *C:\Program Files\Microsoft Azure AD Connect Agent\AADConnectProvisioningAgent.exe.configподготовки *.
1. Замените существующий `<system.diagnostics>` раздел следующим, и все сообщения трассировки будут отправлены в файл *проваженттраце. log*.

   ```xml
     <system.diagnostics>
         <sources>
         <source name="AAD Connect Provisioning Agent">
             <listeners>
             <add name="console"/>
             <add name="etw"/>
             <add name="textWriterListener"/>
             </listeners>
         </source>
         </sources>
         <sharedListeners>
         <add name="console" type="System.Diagnostics.ConsoleTraceListener" initializeData="false"/>
         <add name="etw" type="System.Diagnostics.EventLogTraceListener" initializeData="Azure AD Connect Provisioning Agent">
             <filter type="System.Diagnostics.EventTypeFilter" initializeData="All"/>
         </add>
         <add name="textWriterListener" type="System.Diagnostics.TextWriterTraceListener" initializeData="C:/ProgramData/Microsoft/Azure AD Connect Provisioning Agent/Trace/ProvAgentTrace.log"/>
         </sharedListeners>
     </system.diagnostics>
    
   ```
1. Запустите службу **Microsoft Azure AD подключить агент подготовки**.
1. Используйте следующую команду, чтобы зафрагментировать файл и отладить проблемы. 
    ```
    Get-Content “C:/ProgramData/Microsoft/Azure AD Connect Provisioning Agent/Trace/ProvAgentTrace.log” -Wait
    ```
## <a name="object-synchronization-problems"></a>Проблемы синхронизации объектов

В следующем разделе содержатся сведения об устранении неполадок синхронизации объектов.

### <a name="provisioning-logs"></a>Подготовка журналов

В портал Azure журналы подготовки можно использовать для выявления и устранения проблем синхронизации объектов. Чтобы просмотреть журналы, выберите **журналы**.

![Кнопка "Журналы"](media/how-to-troubleshoot/log1.png)

Журналы подготовки предоставляют обширную информацию о состоянии объектов, синхронизируемых между локальной средой Active Directory и Azure.

![Экран "журналы подготовки"](media/how-to-troubleshoot/log2.png)

С помощью раскрывающихся списков в верхней части страницы можно отфильтровать представление в соответствии с конкретными проблемами, например датами. Дважды щелкните отдельное событие, чтобы просмотреть дополнительные сведения.

![Сведения из раскрывающегося списка журналов подготовки](media/how-to-troubleshoot/log3.png)

Эти сведения содержат подробные инструкции и место возникновения проблемы синхронизации. Таким образом можно точно определить точное место проблемы.


## <a name="provisioning-quarantined-problems"></a>Подготовка проблем, связанных с карантином

Подготовка облака отслеживает работоспособность вашей конфигурации и помещает неработоспособные объекты в состояние карантина. Если большинство или все вызовы, выполненные для целевой системы, постоянно завершаются сбоем из-за ошибки, например недопустимых учетных данных администратора, задание подготовки помечается как помещенное в карантин.

![Состояние карантина](media/how-to-troubleshoot/quarantine1.png)

Выбрав состояние, можно просмотреть дополнительные сведения о карантине. Также можно получить код ошибки и сообщение.

![Сведения о состоянии карантина](media/how-to-troubleshoot/quarantine2.png)

### <a name="resolve-a-quarantine"></a>Разрешение карантина

- Используйте портал Azure, чтобы перезапустить задание подготовки. На странице Конфигурация агента выберите **перезапустить подготовку**.

  ![Перезапустить подготовку](media/how-to-troubleshoot/quarantine3.png)

- Используйте Microsoft Graph, чтобы [перезапустить задание подготовки](/graph/api/synchronization-synchronizationjob-restart?tabs=http&view=graph-rest-beta). Вы получите полный контроль над перезапусками. Вы можете выбрать следующие флажки:
  - Для перезапуска счетчика депонирования, который начисляется в направлении карантина.
  - Карантин, чтобы удалить приложение из карантина.
  - Водяные знаки. 
  
  Используйте следующий запрос:
 
  `POST /servicePrincipals/{id}/synchronization/jobs/{jobId}/restart`

## <a name="next-steps"></a>Дальнейшие действия 

- [Что собой представляет подготовка?](what-is-provisioning.md)
- [Что такое облачная подготовка Azure AD Connect?](what-is-cloud-provisioning.md)