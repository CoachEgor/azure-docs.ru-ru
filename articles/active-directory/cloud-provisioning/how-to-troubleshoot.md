---
title: Azure AD Connect устранение неполадок при подготовке облака
description: В этом документе описывается, как устранять неполадки, которые могут возникнуть при работе с агентом подготовки облака.
author: billmath
ms.author: billmath
manager: daveba
ms.date: 12/02/2019
ms.topic: article
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 4100886e0a24fa961b9085bd507ae3f4ebfdd6eb
ms.sourcegitcommit: 76b48a22257a2244024f05eb9fe8aa6182daf7e2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/03/2019
ms.locfileid: "74794241"
---
# <a name="cloud-provisioning-troubleshooting"></a>Устранение неполадок подготовки облака

Подготовка облака затрагивает множество различных аспектов и имеет множество различных зависимостей.  Естественно, это может привести к различным проблемам.  Этот документ предназначен для того, чтобы приступить к устранению этих проблем.  В этом документе вы узнаете о типичных областях, на которые следует обратить внимание, о сборе дополнительных сведений и различных методах, которые можно использовать для выявления проблем.  


## <a name="common-troubleshooting-areas"></a>Распространенные области устранения неполадок

|Name|Описание|
|-----|-----|
|[Проблемы с агентом](#agent-issues)|Убедитесь, что агент установлен правильно и взаимодействует с Azure AD.|
|[Проблемы синхронизации объектов](#object-synchronization-issues)|Используйте журналы подготовки для устранения неполадок, связанных с синхронизацией объектов.|
|[Подготовка проблем с карантином](#provisioning-quarantined-issues)|Сведения о подготовке к отдаче карантина и способах ее устранения.|


## <a name="agent-issues"></a>Проблемы с агентом
Вот некоторые из первых вещей, которые необходимо проверить с помощью агента:


-  установлен ли он?
-  агент запущен локально?
-  является ли агент на портале?
-  помечен ли агент как работоспособный?  

Эти элементы можно проверить в портал Azure и на локальном сервере, на котором выполняется агент.

### <a name="azure-portal-agent-verification"></a>Проверка агента портал Azure

Чтобы проверить, что агент отображается в Azure и является работоспособным, выполните следующие действия.

1. Войдите на портал Azure.
2. Слева выберите **Azure Active Directory**, щелкните **Azure AD Connect** и в центре выберите **Управление подготовка (Предварительная версия)** .
3.  На экране **Подготовка Azure AD (Предварительная версия)** щелкните **проверить все агенты**.
 ![подготовки Azure AD](media/how-to-install/install7.png)</br>
 
4. На **экране "локальные агенты подготовки** " вы увидите установленные агенты.  Убедитесь, что рассматриваемый агент есть и помечен как **работоспособный**.
 ![агенты подготовки](media/how-to-install/install8.png)</br>

### <a name="verify-the-port"></a>Проверка порта

Чтобы убедиться, что Azure прослушивает порт 443 и что агент может взаимодействовать с ним, можно использовать следующее средство:

https://aadap-portcheck.connectorporttest.msappproxy.net/ 

Этот тест проверит, что агенты могут взаимодействовать с Azure через порт 443.  Откройте браузер и перейдите по указанному выше URL-адресу с сервера, на котором установлен агент.
 ![Службы](media/how-to-install/verify2.png)

### <a name="on-the-local-server"></a>На локальном сервере

Чтобы проверить, работает ли агент, выполните следующие действия.

1.  На сервере с установленным агентом откройте **службы** , перейдя к нему или перейдя в меню Запуск/Запуск/службы. msc.
2.  В разделе " **службы**" убедитесь в том, что **Microsoft Azure AD Connect update Agent** and **Microsoft Azure AD Connect подготовка Agent** (состояние **выполняется**).
 ![Службы](media/how-to-troubleshoot/troubleshoot1.png)

### <a name="common-agent-installation-issues"></a>Распространенные проблемы при установке агента

Ниже приведены некоторые распространенные проблемы установки агентов и типичные способы их устранения.

#### <a name="agent-failed-to-start"></a>Не удалось запустить агент

Если появится сообщение об ошибке, в котором говорится:

**Не удалось запустить службу "Микросфофт Azure AD Connect подготовки агента".  Убедитесь, что у вас есть необходимые привилегии для запуска системных служб.** 

Обычно это происходит из-за того, что групповая политика, которая не позволила применить разрешения к локальной службе NT "учетная запись входа", созданной установщиком (NT Сервице\аадконнектпровисионингажент), эти разрешения необходимы для запуска службы.

Чтобы устранить эту проблему, выполните следующие действия.

1.  Вход на сервер с учетной записью администратора
2.  Откройте **службы** , перейдя к ней или перейдя к запуску/запуску/Services. msc.
3.  В разделе " **службы** " дважды щелкните **Microsoft Azure AD подключить агент подготовки** .
4. На вкладке измените значение "учетная запись входа" на "Администратор домена" и перезапустите службу. 

 ![Службы](media/how-to-troubleshoot/troubleshoot3.png)

#### <a name="agent-times-out-or-certificate-is-invalid"></a>Истекло время ожидания агента, или сертификат недействителен

При попытке зарегистрировать агент могут возникнуть следующие ошибки.

 ![Службы](media/how-to-troubleshoot/troubleshoot4.png)

Обычно это вызвано тем, что агент не может подключиться к гибридной службе удостоверений и требует настройки прокси-сервера HTTP.  Чтобы устранить эту проблему, настройте исходящий прокси-сервер. 

Агент подготовки поддерживает использование исходящего прокси-сервера. Его можно настроить, изменив файл конфигурации агента **C:\Program Files\Microsoft Azure AD Connect подготовки ажент\аадконнектпровисионингажент.ЕКСЕ.конфиг**. Добавьте в него следующие строки, расположенные ближе к концу файла непосредственно перед закрывающим тегом `</configuration>`.
Замените переменные [proxy-server] и [proxy-port] значениями имени прокси-сервера и номера порта.

```xml
    <system.net>
        <defaultProxy enabled="true" useDefaultCredentials="true">
            <proxy
                usesystemdefault="true"
                proxyaddress="http://[proxy-server]:[proxy-port]"
                bypassonlocal="true"
            />
        </defaultProxy>
    </system.net>
```

#### <a name="agent-registration-fails-with-security-error"></a>Сбой регистрации агента с ошибкой безопасности

При установке агента подготовки облака может появиться следующее сообщение об ошибке.

Обычно это вызвано тем, что агенту не удается выполнить сценарии регистрации PowerShell в связи с локальными политиками выполнения PowerShell.

Чтобы устранить эту проблему, измените политики выполнения PowerShell на сервере. Необходимо иметь политики компьютера и пользователя как "undefine" или "RemoteSigned". Если это "Unrestricted", появится эта ошибка.  Дополнительные сведения см. в разделе [политики выполнения PowerShell](https://docs.microsoft.com/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-6). 

### <a name="log-files"></a>Файлы журналов

По умолчанию агент выдает очень минимальные сообщения об ошибках и сведения о трассировке стека. Эти журналы трассировки можно найти в папке: **К:\ПРОГРАМДАТА\МИКРОСОФТ\АЗУРЕ AD Connect подготовка Agent\Trace**

Выполните следующие действия, чтобы собрать дополнительные сведения для устранения неполадок, связанных с агентом.

1. Останавливает службу **Microsoft Azure AD подключение агента подготовки**
2. Создайте копию исходного файла конфигурации: **C:\Program Files\Microsoft Azure AD Connect подготовки ажент\аадконнектпровисионингажент.ЕКСЕ.конфиг**
3. Замените существующий раздел < System. Diagnostics > следующим, и все сообщения трассировки будут отправлены в файл **проваженттраце. log.**

      ```xml
        <system.diagnostics>
            <sources>
            <source name="AAD Connect Provisioning Agent">
                <listeners>
                <add name="console"/>
                <add name="etw"/>
                <add name="textWriterListener"/>
                </listeners>
            </source>
            </sources>
            <sharedListeners>
            <add name="console" type="System.Diagnostics.ConsoleTraceListener" initializeData="false"/>
            <add name="etw" type="System.Diagnostics.EventLogTraceListener" initializeData="Azure AD Connect Provisioning Agent">
                <filter type="System.Diagnostics.EventTypeFilter" initializeData="All"/>
            </add>
            <add name="textWriterListener" type="System.Diagnostics.TextWriterTraceListener" initializeData="C:/ProgramData/Microsoft/Azure AD Connect Provisioning Agent/Trace/ProvAgentTrace.log"/>
            </sharedListeners>
        </system.diagnostics>

      ```
4. Запуск службы **Microsoft Azure AD подключение агента подготовки**
5. Чтобы зафрагментировать файл и выполнить отладку, можно использовать следующую команду: 
    ```
    Get-Content “C:/ProgramData/Microsoft/Azure AD Connect Provisioning Agent/Trace/ProvAgentTrace.log” -Wait
    ```
## <a name="object-synchronization-issues"></a>Проблемы синхронизации объектов

В следующем разделе содержатся сведения об устранении неполадок синхронизации объектов.

### <a name="provisioning-logs"></a>Подготовка журналов

В портал Azure журналы подготовки можно использовать для выявления и устранения проблем синхронизации объектов.  Чтобы просмотреть журналы, выберите **журналы**.
 ![журналов подготовки](media/how-to-troubleshoot/log1.png)

Журналы подготовки предоставляют массу информации о состоянии синхронизируемых объектов между локальной средой AD и Azure.

 ![Подготовка журналов](media/how-to-troubleshoot/log2.png)

Можно использовать раскрывающиеся раскрывающиеся меню в верхней части страницы, чтобы отфильтровать представление в соответствии с конкретными проблемами, датами и т. д.  Двойной щелчок по отдельному событию предоставит дополнительные подробные сведения.

 ![Подготовка журналов](media/how-to-troubleshoot/log3.png)

Эти сведения содержат подробные инструкции и место возникновения проблемы синхронизации.  Таким образом, это позволяет точно определить точное место возникновения проблемы.


## <a name="provisioning-quarantined-issues"></a>Подготовка проблем, связанных с карантином

Подготовка облака отслеживает работоспособность конфигурации и помещает неработоспособные объекты в состояние "карантина". Если большинство или все вызовы, выполненные для целевой системы, постоянно завершаются сбоем из-за ошибки, например недопустимых учетных данных администратора, задание подготовки помечается как помещенное в карантин.

 ![Карантин](media/how-to-troubleshoot/quarantine1.png)

Щелкнув состояние, можно просмотреть дополнительные сведения о карантине.  Также можно получить код ошибки и сообщение.

 ![Карантин](media/how-to-troubleshoot/quarantine2.png)

### <a name="resolving-a-quarantine"></a>Разрешение карантина

- Используйте портал Azure, чтобы перезапустить задание подготовки. На странице Конфигурация агента выберите **перезапустить подготовку**.

  ![Карантин](media/how-to-troubleshoot/quarantine3.png)

- Используйте Microsoft Graph, чтобы [перезапустить задание подготовки](https://docs.microsoft.com/graph/api/synchronization-synchronizationjob-restart?view=graph-rest-beta&tabs=http). Вы получите полный контроль над перезапусками. Вы можете снять флажки (чтобы перезапустить счетчик депонирования, который начисляется в сторону состояния карантина), Очистить карантин (чтобы удалить приложение из карантина) или снять пределы. Используйте следующий запрос:
 
  `POST /servicePrincipals/{id}/synchronization/jobs/{jobId}/restart`

## <a name="next-steps"></a>Дальнейшие действия 

- [Что такое подготовка?](what-is-provisioning.md)
- [Что такое Azure AD Connect подготовки облака?](what-is-cloud-provisioning.md)



