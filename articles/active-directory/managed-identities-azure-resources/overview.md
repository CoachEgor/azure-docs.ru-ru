---
title: Управляемые удостоверения для ресурсов Azure
description: Общие сведения об управляемых удостоверениях для ресурсов Azure.
services: active-directory
documentationcenter: ''
author: MarkusVi
manager: daveba
editor: ''
ms.assetid: 0232041d-b8f5-4bd2-8d11-27999ad69370
ms.service: active-directory
ms.subservice: msi
ms.devlang: ''
ms.topic: overview
ms.custom: mvc
ms.date: 06/18/2020
ms.author: markvi
ms.collection: M365-identity-device-management
ms.openlocfilehash: 3557bab44e1a4af5fdcbda5f8643018952e4e54e
ms.sourcegitcommit: 51718f41d36192b9722e278237617f01da1b9b4e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/19/2020
ms.locfileid: "85099530"
---
# <a name="what-are-managed-identities-for-azure-resources"></a>Что такое управляемые удостоверения для ресурсов Azure?

[!INCLUDE [preview-notice](../../../includes/active-directory-msi-preview-notice.md)]

Распространенная проблема при создании облачных приложений — управление учетными данными в коде для проверки подлинности в облачных службах. Обеспечение безопасности учетных данных является важной задачей. В идеальном случае учетные данные никогда не передаются на рабочие станции разработчиков и не проверяются после изменения в системе управления версиями. Azure Key Vault позволяет обеспечить безопасное хранение учетных данных, секретов, а также других ключей, но для их получения код должен выполнять проверку подлинности в Key Vault.

Функция управляемых удостоверений для ресурсов Azure в Azure Active Directory решает эту проблему. Функция предоставляет службам Azure автоматически управляемое удостоверение в Azure AD. Удостоверение можно использовать для проверки подлинности в любой службе, которая поддерживает проверку подлинности Azure AD, включая Key Vault, при этом не сохраняя каких-либо учетных данных в коде.

Использование функции управляемых удостоверений для ресурсов Azure предоставляется AAD бесплатно для подписок Azure. Дополнительные затраты отсутствуют.

> [!NOTE]
> Управляемые удостоверения для ресурсов Azure — это новое название службы "Управляемое удостоверение службы" (MSI).

## <a name="terminology"></a>Терминология

В документации по ресурсам Azure используются следующие термины для управляемых удостоверений.

- **Идентификатор клиента** — уникальный идентификатор, созданный с помощью Azure AD, который связан с приложением и субъектом-службой на этапе начальной подготовки.
- **Идентификатор субъекта** — идентификатор объекта субъекта-службы для управляемого удостоверения, которое используется для предоставления доступа на основе ролей к ресурсу Azure.
- **Служба метаданных экземпляров Azure (IMDS)**  — конечная точка REST, доступная всем виртуальным машинам IaaS, которые созданы с помощью Azure Resource Manager. Конечная точка доступна по известному IP-адресу без поддержки маршрутизации (169.254.169.254), к которому можно получить доступ только в пределах виртуальной машины.

## <a name="managed-identity-types"></a>Типы управляемых удостоверений

Существует два типа управляемых удостоверений.

- **Назначаемое системой управляемое удостоверение** включается непосредственно в экземпляре службы Azure. Если удостоверение включено, Azure создает удостоверение для экземпляра службы в клиенте Azure AD, который является доверенным в подписке этого экземпляра. После создания удостоверения учетные данные подготавливаются для передачи в экземпляр. Жизненный цикл назначаемого системой удостоверения напрямую связан с экземпляром службы Azure, в которой оно включено. При удалении экземпляра Azure автоматически очищает учетные данные и удостоверение в Azure AD.
- **Назначаемое пользователем управляемое удостоверение** создается как изолированный ресурс Azure. При этом Azure создает удостоверение в доверенном клиенте Azure AD используемой подписки. После создания удостоверения оно может быть назначено одному или нескольким экземплярам служб Azure. Управление жизненным циклом управляемого удостоверения, назначаемого пользователем, осуществляется отдельно от жизненного цикла экземпляров служб Azure, для которых оно назначено.

На внутреннем уровне управляемые удостоверения — это субъекты-службы особого типа, которые заблокированы только для использования с ресурсами Azure. При удалении управляемого удостоверения соответствующий субъект-служба автоматически удаляется.
Кроме того, при создании удостоверения, назначаемого пользователем или системой, для него поставщик ресурсов управляемых удостоверений (MSRP) на внутреннем уровне выдает сертификат. 

Затем ваш код может использовать управляемое удостоверение для запроса на получение маркеров доступа для служб, которые поддерживают аутентификацию Azure AD. Azure выполняет развертывание учетных данных, используемых экземпляром службы. 

## <a name="credential-rotation"></a>Смена учетных данных
Сменой учетных данных управляет поставщик ресурсов, в котором размещается ресурс Azure. По умолчанию учетные данные меняются каждые 46 дней. Запрос новых учетных данных выполняет поставщик ресурсов, то есть он может подождать больше 46 дней.

Работа управляемых удостоверений служб с виртуальными машинами Azure показана на следующей схеме.

![Управляемые удостоверения служб и виртуальные машины Azure](media/overview/data-flow.png)

|  Свойство    | Управляемое удостоверение, назначаемое системой | Управляемое удостоверение, назначаемое пользователем |
|------|----------------------------------|--------------------------------|
| Создание |  Создано как часть ресурса Azure (например, виртуальная машина Azure или Служба приложений Azure). | Создано в качестве автономного ресурса Azure. |
| Жизненный цикл | Жизненный цикл в общем доступе с ресурсом Azure, указанным при создании управляемого удостоверения. <br/> При удалении родительского ресурса управляемое удостоверение также удаляется. | Независимый жизненный цикл. <br/> Должен быть явно удален. |
| Совместное использование ресурсов Azure | Невозможно настроить общий доступ. <br/> Может быть связано только с одним ресурсом Azure. | Может быть в общем доступе. <br/> Одно и то же назначаемое пользователем управляемое удостоверение может быть связано с несколькими ресурсами Azure. |
| Распространенные варианты использования | Рабочие нагрузки, которые содержатся в одном ресурсе Azure. <br/> Рабочие нагрузки, для которых требуются независимые удостоверения. <br/> Например, приложение, выполняющееся на одной виртуальной машине. | Рабочие нагрузки, которые выполняются на нескольких ресурсах и могут совместно использовать одно удостоверение. <br/> Рабочие нагрузки, требующие предварительную авторизацию к защищенному ресурсу, как часть потока подготовки. <br/> Рабочие нагрузки, где ресурсы перезапускаются часто, но разрешения должны быть согласованными. <br/> Например, рабочая нагрузка, где нескольким виртуальным машинам требуется доступ к одному и тому же ресурсу. |

### <a name="how-a-system-assigned-managed-identity-works-with-an-azure-vm"></a>Использование назначаемого системой управляемого удостоверения с виртуальной машиной Azure

1. Azure Resource Manager получает запрос на включение назначаемого системой управляемого удостоверения MSI в виртуальной машине.

2. Azure Resource Manager создает субъект-службу в Azure AD для удостоверения виртуальной машины. В клиенте Azure AD, который является доверенным для этой подписки, создается субъект-служба.

3. Azure Resource Manager настраивает идентификатор в виртуальной машине, обновляя конечную точку удостоверения Службы метаданных экземпляров Azure с помощью идентификатора клиента и сертификата субъекта-службы.

4. После того как виртуальной машине было назначено удостоверение, для предоставления доступа виртуальной машины к ресурсам Azure используются сведения о субъекте-службе. Чтобы назначить соответствующую роль субъект-службе виртуальной машины, используйте Azure Resource Manager. Его можно вызвать с помощью управления доступом на основе ролей RBAC в Azure AD. Для вызова Key Vault следует предоставить доступ к определенному секрету или ключу в Key Vault.

5. Код, выполняющийся на виртуальной машине, может запросить маркер из конечной точки службы метаданных экземпляров Azure, доступной только на виртуальной машине: `http://169.254.169.254/metadata/identity/oauth2/token`
    - Параметр ресурса указывает службу, в которую отправляется маркер. Для проверки подлинности в Azure Resource Manager необходимо использовать `resource=https://management.azure.com/`.
    - Параметр версии API указывает версию IMDS. Используйте api-version=2018-02-01 или более позднюю версию.

6. В Azure AD выполняется вызов для запроса маркера доступа (как указано в шаге 5) с использованием идентификатора клиента и сертификата, настроенных на шаге 3. Azure AD возвращает маркер доступа JSON Web Token (JWT).

7. Код отправляет этот маркер доступа при вызове службы, которая поддерживает аутентификацию Azure AD.

### <a name="how-a-user-assigned-managed-identity-works-with-an-azure-vm"></a>Использование назначаемого пользователем управляемого удостоверения на виртуальной машине Azure

1. Azure Resource Manager получает запрос на создание назначаемого пользователем управляемого удостоверения.

2. Azure Resource Manager создает субъект-службу в Azure AD для назначаемого пользователем управляемого удостоверения. В клиенте Azure AD, который является доверенным для этой подписки, создается субъект-служба.

3. Azure Resource Manager получает запрос на настройку назначаемого пользователем управляемого удостоверения на виртуальной машине и обновляет конечную точку удостоверения Службы метаданных экземпляра Azure, используя назначенный пользователем идентификатор клиента и сертификат субъекта-службы управляемого удостоверения.

4. Создав назначаемое пользователем управляемое удостоверение, примените сведения о субъекте-службе, чтобы предоставить этому удостоверению доступ к ресурсам Azure. Чтобы назначить соответствующую роль субъекту-службе назначаемого пользователем удостоверения, используйте вызов Azure Resource Manager с помощью RBAC в Azure AD. Для вызова Key Vault следует предоставить доступ к определенному секрету или ключу в Key Vault.

   > [!Note]
   > Также данное действие можно выполнить перед шагом 3.

5. Код, выполняющийся на виртуальной машине, может запросить маркер из конечной точки Службы метаданных экземпляров Azure, доступной только на виртуальной машине: `http://169.254.169.254/metadata/identity/oauth2/token`
    - Параметр ресурса указывает службу, в которую отправляется маркер. Для проверки подлинности в Azure Resource Manager необходимо использовать `resource=https://management.azure.com/`.
    - Параметр идентификатора клиента определяет удостоверение, для которого запрашивается маркер. Это значение необходимо для устранения неоднозначности, когда на одной виртуальной машине доступны несколько назначаемых пользователем удостоверений.
    - Параметры версии API указывают версию Службы метаданных экземпляров Azure. Используйте `api-version=2018-02-01` или более поздней версии.

6. В Azure AD выполняется вызов для запроса маркера доступа (как указано в шаге 5) с использованием идентификатора клиента и сертификата, настроенных на шаге 3. Azure AD возвращает маркер доступа JSON Web Token (JWT).
7. Код отправляет этот маркер доступа при вызове службы, которая поддерживает аутентификацию Azure AD.

## <a name="how-can-i-use-managed-identities-for-azure-resources"></a>Как применять управляемые удостоверения для ресурсов Azure?

Дополнительные сведения об использовании управляемых удостоверений для получения доступа к разным ресурсам Azure приведены в следующих руководствах.

> [!NOTE]
> Дополнительные сведения об управляемых удостоверениях, в том числе пошаговые видео-руководства по нескольким поддерживаемым сценариям, см. в курсе по [внедрению управляемых удостоверений для ресурсов Microsoft Azure](https://www.pluralsight.com/courses/microsoft-azure-resources-managed-identities-implementing).

См. дополнительные сведения об использовании управляемого удостоверения для виртуальной машины Windows:

* [Доступ к Azure Data Lake Storage](tutorial-windows-vm-access-datalake.md)
* [Получение доступа к Azure Resource Manager с помощью управляемого удостоверения службы виртуальной машины Linux](tutorial-windows-vm-access-arm.md)
* [Доступ к Azure SQL](tutorial-windows-vm-access-sql.md)
* [Доступ к службе хранилища Azure с помощью управляемого удостоверения виртуальной машины Linux](tutorial-vm-windows-access-storage.md)
* [Руководство по использованию управляемого удостоверения службы виртуальной машины Linux для доступа к службе хранилища Azure с учетными данными SAS](tutorial-windows-vm-access-storage-sas.md)
* [Доступ к Azure Key Vault с помощью управляемого удостоверения службы виртуальной машины Linux](tutorial-windows-vm-access-nonaad.md)

См. дополнительные сведения об использовании управляемого удостоверения для виртуальной машины Linux:

* [Доступ к Реестру контейнеров Azure](../../container-registry/container-registry-authentication-managed-identity.md)
* [Доступ к Azure Data Lake Storage](tutorial-linux-vm-access-datalake.md)
* [Получение доступа к Azure Resource Manager с помощью управляемого удостоверения службы виртуальной машины Linux](tutorial-linux-vm-access-arm.md)
* [Доступ к службе хранилища Azure с помощью управляемого удостоверения виртуальной машины Linux](tutorial-linux-vm-access-storage.md)
* [Руководство по использованию управляемого удостоверения службы виртуальной машины Linux для доступа к службе хранилища Azure с учетными данными SAS](tutorial-linux-vm-access-storage-sas.md)
* [Доступ к Azure Key Vault с помощью управляемого удостоверения службы виртуальной машины Linux](tutorial-linux-vm-access-nonaad.md)

См. дополнительные сведения об использовании управляемого удостоверения для других служб Azure:

* [Служба приложений Azure](/azure/app-service/overview-managed-identity)
* [Управление API Azure](../../api-management/api-management-howto-use-managed-service-identity.md)
* [Экземпляры контейнеров Azure](../../container-instances/container-instances-managed-identity.md);
* [Задачи Реестра контейнеров Azure](../../container-registry/container-registry-tasks-authentication-managed-identity.md)
* [Центры событий Azure](../../event-hubs/authenticate-managed-identity.md)
* [Функции Azure](/azure/app-service/overview-managed-identity)
* [Служба Azure Kubernetes (AKS)](/azure/aks/use-managed-identity)
* [Azure Logic Apps](/azure/logic-apps/create-managed-service-identity)
* [служебной шине Azure](../../service-bus-messaging/service-bus-managed-service-identity.md)
* [Фабрика данных Azure](../../data-factory/data-factory-service-identity.md).


## <a name="what-azure-services-support-the-feature"></a>Службы Azure, в которых поддерживается данная функция.<a name="which-azure-services-support-managed-identity"></a>

Управляемые удостоверения для ресурсов Azure можно использовать для аутентификации служб с поддержкой аутентификации Azure AD. См. дополнительные сведения о [службах, которые поддерживают управляемые удостоверения для ресурсов Azure](services-support-msi.md).

## <a name="next-steps"></a>Дальнейшие действия

Чтобы использовать управляемые удостоверения для ресурсов Azure, ознакомьтесь со следующими краткими руководствами:

* [Использование назначаемого системой управляемого удостоверения на виртуальной машине Windows для доступа к Resource Manager](tutorial-windows-vm-access-arm.md)
* [Использование назначаемого системой управляемого удостоверения на виртуальной машине Linux для доступа к Resource Manager](tutorial-linux-vm-access-arm.md)