---
title: Используйте сервер Azure MFA с AD FS 2.0 - Активный каталог Azure
description: Эта страница посвящена Azure Multi-Factor Authentication. Она содержит сведения по началу работы с Azure MFA и AD FS 2.0.
services: multi-factor-authentication
ms.service: active-directory
ms.subservice: authentication
ms.topic: conceptual
ms.date: 07/11/2018
ms.author: iainfou
author: iainfoulds
manager: daveba
ms.reviewer: michmcla
ms.collection: M365-identity-device-management
ms.openlocfilehash: e71c1d28a90af72890b2399d5da24d08885f3cce
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80051209"
---
# <a name="configure-azure-multi-factor-authentication-server-to-work-with-ad-fs-20"></a>Настройка сервера Многофакторной идентификации Azure для работы с AD FS 2.0

Эта статья предназначена для организаций, в которых настроена федерация с Azure Active Directory и которым нужно защитить локальные или облачные ресурсы. Вы можете сделать это с помощью сервера Многофакторной идентификации Azure. Его нужно настроить для работы с AD FS, чтобы двухфакторная проверка подлинности запускалась для важных конечных точек.

Эта статья содержит информацию об использовании сервера Многофакторной идентификации Azure с AD FS 2.0. Дополнительные сведения о службах AD FS см. в статье [Защита облачных и локальных ресурсов с помощью сервера Многофакторной идентификации Azure со службами федерации Active Directory в Windows Server 2012 R2](howto-mfaserver-adfs-2012.md).

> [!IMPORTANT]
> С 1 июля 2019 года Microsoft больше не будет предлагать MFA Server для новых развертываний. Новые клиенты, которые хотели бы требовать многофакторной аутентификации от своих пользователей, должны использовать многофакторную аутентификацию Azure. Существующие клиенты, которые активировали MFA Server до 1 июля, смогут загружать последнюю версию, будущие обновления и генерировать учетные данные активации в обычном режиме.

## <a name="secure-ad-fs-20-with-a-proxy"></a>Защита AD FS 2.0 с помощью прокси-сервера

Чтобы защитить AD FS 2.0 с помощью прокси-сервера, установите сервер Многофакторной идентификации Azure на прокси-сервере AD FS.

### <a name="configure-iis-authentication"></a>Настройка проверки подлинности IIS

1. В azure Multi-Factor Authentication Server щелкните значок **подлинности IIS** в левом меню.
2. Нажмите на вкладку **на основе формы.**
3. Нажмите кнопку **Добавить**.

   ![MFA Server IIS Окно аутентификации](./media/howto-mfaserver-adfs-2/setup1.png)

4. Чтобы обнаружить имя пользователя, пароль и переменные домена `https://sso.contoso.com/adfs/ls`автоматически, введите URL входа (например) в поле диалога на основе автоматической настройки и **нажмите OK.**
5. Установите флажок **Требуется сопоставление пользователей многофакторной проверки подлинности**, если все пользователи были или будут импортированы на сервер и пройдут двухфакторную проверку подлинности. Если значительное число пользователей еще не импортировано на сервер или их исключат из двухфакторной проверки подлинности, не устанавливайте флажок.
6. Если переменные страницы не удается обнаружить автоматически, нажмите кнопку **Указать вручную...** в диалоговом окне "Автоматическая настройка веб-сайта на основе форм".
7. В диалоговом окне веб-сайта Add Form введите URL-адрес на страницу `https://sso.contoso.com/adfs/ls`входа в DD FS в поле URL-адреса Отправки (например) и введите имя приложения (по желанию). Имя приложения отображается в отчетах сервера Многофакторной идентификации Azure. Кроме того, оно может отображаться в SMS-сообщениях и сообщениях о проверке подлинности мобильного приложения.
8. В качестве формата запроса укажите **POST или GET**.
9. Введите переменную для имени пользователя (ctl00$ContentPlaceHolder1$UsernameTextBox) и переменную для пароля (ctl00$ContentPlaceHolder1$PasswordTextBox). Если на странице входа на основе форм отображается текстовое поле для домена, введите также переменную для домена. Чтобы найти имена полей ввода на странице входа, перейдите на нее в веб-браузере, щелкните страницу правой кнопкой мыши и выберите пункт **Просмотр источника**.
10. Установите флажок **Требуется сопоставление пользователей многофакторной проверки подлинности**, если все пользователи были или будут импортированы на сервер и пройдут двухфакторную проверку подлинности. Если значительное число пользователей еще не импортировано на сервер или их исключат из двухфакторной проверки подлинности, не устанавливайте флажок.

    ![Добавление веб-сайта на основе форм на сервер MFA Server](./media/howto-mfaserver-adfs-2/manual.png)

11. Нажмите кнопку **Дополнительно** чтобы просмотреть дополнительные параметры. Вы можете сделать следующие настройки:

    - выбрать специальный файл страницы отказа;
    - поместить в кэш успешные проверки подлинности с помощью файлов cookie;
    - выбрать способ проверки подлинности основных учетных данных.

12. Так как прокси-сервер AD FS, скорее всего, не будет присоединен к домену, можно использовать протокол LDAP, чтобы подключиться к контроллеру домена для импорта пользователей и выполнения предварительной проверки подлинности. В диалоговом окне "Расширенный веб-сайт на основе форм" щелкните вкладку **Основная проверка подлинности** и выберите **Привязка LDAP** в качестве типа предварительной проверки подлинности.
13. После этого нажмите кнопку **ОК**, чтобы вернуться к диалоговому окну "Добавление веб-сайта на основе форм".
14. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.
15. Когда переменные для URL-адреса и страницы будут введены или обнаружены, данные веб-сайта отобразятся на панели "На основе форм".
16. Чтобы включить подключаемый модуль IIS на нужном уровне, перейдите на вкладку **Собственный модуль** и выберите сервер, а также веб-сайт, с которым работает прокси-сервер AD FS (например, "Веб-сайт по умолчанию") или приложение прокси-сервера AD FS (например, ls после adfs).
17. Установите флажок **Включить проверку подлинности IIS** в верхней части экрана.

Проверка подлинности IIS включена.

### <a name="configure-directory-integration"></a>Настройка интеграции каталогов

Проверка подлинности IIS включена, но чтобы выполнить предварительную проверку подлинности для Active Directory (AD) с помощью протокола LDAP, нужно настроить LDAP-подключение к контроллеру домена.

1. Щелкните значок **Интеграция каталогов**.
2. На вкладке "Параметры" установите переключатель **Использовать определенную конфигурацию LDAP**.

   ![Настройка настроек LDAP для конкретных настроек LDAP](./media/howto-mfaserver-adfs-2/ldap1.png)

3. Щелкните **Правка**.
4. В диалоговом окне «Изменение конфигурации LDAP» заполните поля сведениями, нужными для подключения к контроллеру домена AD. Описание полей есть в файле справки по серверу Многофакторной идентификации Azure.
5. Проверьте LDAP-подключение. Для этого нажмите кнопку **Проверка**.

   ![Тестldируемая конфигурация LDAP в сервере MFA](./media/howto-mfaserver-adfs-2/ldap2.png)

6. Если проверка LDAP-подключения оказалась успешной, нажмите кнопку **ОК**.

### <a name="configure-company-settings"></a>Настройка параметров организации

1. Теперь щелкните значок **Параметры компании** и перейдите на вкладку **Разрешение имени пользователя**.
2. Установите переключатель **Для сопоставления имен пользователей использовать атрибут уникального идентификатора LDAP**.
3. Если имя пользователя введено в формате "домен\имя пользователя", то при создании запроса LDAP серверу нужно отделить домен от имени пользователя. Это можно сделать с помощью параметра реестра.
4. Откройте редактор реестра и перейдите в раздел HKEY_LOCAL_MACHINE/SOFTWARE/Wow6432Node/Positive Networks/PhoneFactor на 64-разрядном сервере. При использовании 32-разрядного сервера удалите из этого пути текст Wow6432Node. Создайте раздел реестра DWORD с именем "UsernameCxz_stripPrefixDomain" и задайте значение 1. После этого Многофакторная идентификация Azure будет защищать прокси-сервер AD FS.

Убедитесь, что пользователи импортированы из Active Directory на сервер Azure Multi-Factor Authentication. Если [Trusted IPs section](#trusted-ips) вы хотите разрешить внутренние IP-адреса, чтобы при входе на веб-сайт из этих мест не требовалась двухступенчатая проверка.

![Редактор реестра для настройки настроек компании](./media/howto-mfaserver-adfs-2/reg.png)

## <a name="ad-fs-20-direct-without-a-proxy"></a>AD FS 2.0 без прокси-сервера (напрямую)

Если прокси-сервер AD FS не используется, AD FS можно защитить. Установите сервер Многофакторной идентификации Azure на сервере AD FS и настройте его согласно приведенным ниже инструкциям.

1. В azure Multi-Factor Authentication Server щелкните значок **подлинности IIS** в левом меню.
2. Нажмите на вкладку **HTTP.**
3. Нажмите кнопку **Добавить**.
4. В поле диалога Add Base URL введите URL-адрес веб-сайта AD FS, где выполняется проверка подлинности HTTP (например) `https://sso.domain.com/adfs/ls/auth/integrated`в поле базового URL. Затем введите имя приложения (необязательно). Имя приложения отображается в отчетах сервера Многофакторной идентификации Azure. Кроме того, оно может отображаться в SMS-сообщениях и сообщениях о проверке подлинности мобильного приложения.
5. При необходимости задайте время ожидания простоя и максимальное время сеанса.
6. Установите флажок **Требуется сопоставление пользователей многофакторной проверки подлинности**, если все пользователи были или будут импортированы на сервер и пройдут двухфакторную проверку подлинности. Если значительное число пользователей еще не импортировано на сервер или их исключат из двухфакторной проверки подлинности, не устанавливайте флажок.
7. При необходимости установите флажок использования файлов cookie для помещения в кэш.

   ![AD FS 2.0 без прокси-сервера (напрямую)](./media/howto-mfaserver-adfs-2/noproxy.png)

8. Нажмите кнопку **ОК**.
9. Чтобы включить подключаемый модуль IIS на нужном уровне, перейдите на вкладку **Собственный модуль**, а потом выберите сервер и веб-сайт (например, "Веб-сайт по умолчанию") или приложение AD FS (например, ls после adfs).
10. Установите флажок **Включить проверку подлинности IIS** в верхней части экрана.

После этого Многофакторная идентификация Azure будет защищать AD FS.

Убедитесь, что пользователи импортированы из Active Directory на сервер Azure Multi-Factor Authentication. Если вы хотите разрешить внутренние IP-адреса, чтобы при входе на веб-сайт из этих мест не требовалась двухступенчатая проверка.

## <a name="trusted-ips"></a>Надежные IP-адреса

С помощью списка надежных IP-адресов можно обойти многофакторную проверку подлинности в Azure при обработке таких запросов на веб-сайты, которые исходят от определенных IP-адресов или подсетей. Например, из двухфакторной проверки подлинности можно исключить пользователей, которые входят с офисного компьютера. Для этого офисную подсеть нужно внести в список "Надежные IP-адреса".

### <a name="to-configure-trusted-ips"></a>Настройка надежных IP-адресов

1. В разделе проверки подлинности IIS перейдите на вкладку **Надежные IP-адреса**.
2. Нажмите **добавить...** .
3. В диалоговом окне Add Trusted IPs (Добавление надежных IP-адресов) выберите **Одиночный IP-адрес**, **Диапазон IP-адресов** или **Подсеть** с помощью переключателя.
4. Введите IP-адрес, диапазон IP-адресов или подсеть, которая должна быть разрешена. При вводе подсети выберите соответствующее значение в поле "Маска сети" и нажмите кнопку **ОК**.

![Настройка доверенных i-плеев на сервер МИД](./media/howto-mfaserver-adfs-2/trusted.png)
