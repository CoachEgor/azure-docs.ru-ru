---
title: Локальная обратная запись паролей с самостоятельным сбросом пароля — Azure Active Directory
description: Узнайте, как события изменения или сброса пароля в Azure Active Directory можно записать обратно в локальную среду каталога.
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: conceptual
ms.date: 04/14/2020
ms.author: iainfou
author: iainfoulds
manager: daveba
ms.reviewer: rhicock
ms.collection: M365-identity-device-management
ms.openlocfilehash: 89431c2bf1838d3264b03c8a5f2ce62cd6df3631
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82127844"
---
# <a name="how-does-self-service-password-reset-writeback-work-in-azure-active-directory"></a>Каким способом самостоятельная обратная запись паролей работает в Azure Active Directory?

Azure Active Directory (Azure AD) самостоятельный сброс пароля (SSPR) позволяет пользователям сбрасывать пароли в облаке, но в большинстве компаний также есть локальная среда домен Active Directory служб (AD DS), в которой находятся пользователи. Обратная запись паролей — это функция на основе [Azure AD Connect](../hybrid/whatis-hybrid-identity.md), позволяющая записывать изменения паролей, внесенные в облаке, в имеющийся локальный каталог в режиме реального времени. В такой конфигурации, когда пользователи изменяют или сбрасывают свои пароли с помощью SSPR в облаке, обновленные пароли также записываются обратно в локальную среду AD DS.

Компонент обратной записи паролей поддерживается в средах, использующих следующие гибридные модели идентификации:

* [Синхронизация хэша паролей](../hybrid/how-to-connect-password-hash-synchronization.md)
* [Сквозная аутентификация](../hybrid/how-to-connect-pta.md)
* [Службы федерации Active Directory (AD FS)](../hybrid/how-to-connect-fed-management.md)

Компонент обратной записи паролей предоставляет следующие возможности:

* **Применение политик паролей локальных домен Active Directory служб (AD DS)**. когда пользователь сбрасывает пароль, он проверяет соответствие локальной политики AD DS, прежде чем зафиксировать ее в этом каталоге. Эта проверка включает проверку журнала, сложности, возраста, фильтров паролей и любых других ограничений паролей, определенных в AD DS.
* **Обратная связь с нулевой задержкой.** Обратная запись паролей выполняется в синхронном режиме. Пользователи немедленно получают уведомления, если их пароль не соответствует политике или не может быть сброшен или изменен по какой либо причине.
* **Поддерживает изменения паролей с панели доступа и Office 365**: когда для федеративных пользователей или синхронизации паролей с истекшим сроком действия или с синхронизированными паролями приходится изменять пароли, которые не просрочены, эти пароли записываются обратно в AD DS.
* **Поддерживает обратную запись паролей, когда администратор сбрасывает их с портал Azure**: когда администратор сбрасывает пароль пользователя в [портал Azure](https://portal.azure.com), если он является федеративным или хэш пароля синхронизирован, пароль записывается обратно в локальную среду. В настоящее время эта функциональная возможность не поддерживается на портале администрирования Office.
* **Не требуются правила брандмауэра для входящих подключений**. компонент обратной записи паролей использует ретранслятор служебной шины Azure в качестве базового канала связи. Весь обмен данными является исходящим и осуществляется через порт 443.

> [!NOTE]
> Обратная запись паролей не поддерживается для учетных записей администраторов в защищенных группах в локальной службе Active Directory. Администраторы могут изменять свой пароль в облаке, но не могут использовать сброс пароля для сброса забытого пароля. Дополнительные сведения о защищенных группах см. в статье [Appendix C: Protected Accounts and Groups in Active Directory](/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory) (Приложение В. Защищенные учетные записи и группы в Active Directory).

## <a name="how-password-writeback-works"></a>Как работает обратная запись паролей

При попытке сброса или смены пароля в облаке федеративным пользователем или пользователем с синхронизацией хэшей паролей происходит следующее.

1. Проверяется установленный у пользователя тип пароля. Если пароль управляется локально:
   * Проверяется, работает ли служба обратной записи. Если это так, пользователь может продолжить операцию.
   * Если служба обратной записи отключена, пользователю сообщается о том, что сейчас невозможно сбросить пароль.
1. Затем пользователь проходит соответствующие этапы аутентификации и переходит на страницу **Сброс пароля**.
1. Пользователь выбирает новый пароль и подтверждает его.
1. После нажатия пользователем кнопки **Отправить** указанный в виде простого текста пароль шифруется с помощью симметричного ключа, который был создан в процессе установки компонента обратной записи.
1. Зашифрованный пароль добавляется в полезные данные, которые передаются по каналу HTTPS на ретранслятор служебной шины для определенного клиента (который был также настроен в процессе установки компонента обратной записи). Этот ретранслятор защищается случайно генерируемым паролем, который известен только локальной установленной системе.
1. После того как сообщение достигает служебной шины, конечная точка сброса пароля автоматически активируется и обнаруживает ожидающий запрос на сброс.
1. Затем служба выполняет поиск пользователя с помощью атрибута привязки облака. Для выполнения этого поиска должны выполняться следующие условия.

   * Объект пользователя должен существовать в пространстве соединителя Active Directory.
   * Объект пользователя должен быть связан с соответствующим объектом метавселенной (MV).
   * Объект пользователя должен быть связан с соответствующим объектом соединителя Azure Active Directory.
   * В ссылке из объекта соединителя Active Directory на MV должно быть правило синхронизации `Microsoft.InfromADUserAccountEnabled.xxx`.

   Когда поступает вызов из облака, модуль синхронизации использует атрибут **cloudAnchor**, чтобы найти объект пространства соединителя Azure Active Directory. Посл этого он переходит по ссылке к объекту MV, а затем — к объекту Active Directory. Так как для одного и того же пользователя может существовать несколько объектов Active Directory (несколько лесов), обработчик синхронизации полагается на ссылку `Microsoft.InfromADUserAccountEnabled.xxx` для выбора нужного из них.

1. После нахождения учетной записи пользователя предпринимается попытка сброса пароля непосредственно в соответствующем лесу Active Directory.
1. Если операция установки пароля прошла успешно, пользователь уведомляется о том, что его пароль изменен.

   > [!NOTE]
   > Если хэш пароля пользователя синхронизируется с Azure AD с помощью синхронизации хэшей паролей, существует вероятность, что локальная политика паролей является менее надежной, чем политика облачных паролей. В этом случае применяется локальная политика. Благодаря этому ваша локальная политика применяется в облаке независимо от того, обеспечиваете ли вы единый вход с помощью синхронизации хэшей паролей или федерации.

1. В случае сбоя операции установки пароля отображается сообщение об ошибки и пользователю предлагается повторить попытку. Операция может завершиться ошибкой по следующим причинам:
    * Служба была отключена.
    * Выбранный пароль не соответствует политикам организации.
    * Не удалось найти пользователя в локальном каталоге Active Directory.

   Сообщения об ошибках содержат рекомендации для пользователей, с помощью которых они могут попытаться устранить проблему без помощи администратора.

## <a name="password-writeback-security"></a>Безопасность компонента обратной записи паролей

Обратная запись паролей — это служба с высоким уровнем безопасности. Чтобы обеспечить защиту информации, включается 4-уровневая модель безопасности следующим образом.

* **Ретранслятор служебной шины для определенного клиента**
   * При настройке службы настраивается ретранслятор служебной шины для определенного клиента, который защищается случайно генерируемым надежным паролем. У корпорации Майкрософт нет доступа к этому паролю.
* **Заблокированный криптографически надежный ключ шифрования пароля**
   * После создания ретранслятора служебной шины создается надежный симметричный ключ сат'ис, используемый для шифрования пароля по сети. Этот ключ существует только в секретном хранилище компании в облаке, которое тщательно блокируется и контролируется, подобно любому паролю в каталоге.
* **Отраслевой стандартный протокол TLS**
   1. При выполнении сброса или изменения пароля в облаке пароль в виде простого текста шифруется с помощью вашего открытого ключа.
   1. Зашифрованный пароль помещается в сообщение HTTPS, которое отправляется по зашифрованному каналу с помощью сертификатов Microsoft TLS/SSL для ретранслятора служебной шины.
   1. После поступления сообщения в служебную шину ваш локальный агент активируется и проходит аутентификацию в служебной шине с использованием ранее созданного надежного пароля.
   1. Локальный агент извлекает зашифрованное сообщение и расшифровывает его с помощью закрытого ключа.
   1. Затем локальный агент пытается установить пароль через интерфейс AD DS SetPassword API. Именно этот этап позволяет принудительно применить политику паролей локальной службы Active Directory (например, сложность, срок пользования, историю, фильтры и т. д.) в облаке.
* **Политики срока действия сообщений**
   * Если по какой-либо причине сообщение задержится в служебной шине из-за неработающей локальной службы, срок его ожидания истечет и оно будет удалено через несколько минут. Время ожидания и удаление сообщения повышают безопасность.

### <a name="password-writeback-encryption-details"></a>Сведения о шифровании компонента обратной записи паролей

После того, как пользователь отправит пароль, запрос на сброс пройдет несколько этапов шифрования, прежде чем поступит в вашу локальную среду. Эти этапы шифрования обеспечивают максимальную надежность и безопасность службы. Они описаны ниже.

1. **Шифрование пароля с 2048-битным ключом RSA**. После того как пользователь отправит пароль для обратной записи в локальную среду, отправленный пароль шифруется с помощью 2048-разрядного ключа RSA.
1. **Шифрование на уровне пакета с помощью AES-GCM**. весь пакет, пароль и необходимые метаданные шифруются с помощью AES-GCM. Из-за этого пользователи с прямым доступом к базовому каналу служебной шины не могут просматривать или изменять содержимое.
1. **Все взаимодействие происходит через TLS/SSL**: все взаимодействие с servicebus происходит в канале SSL/TLS. Это позволяет защитить содержимое от несанкционированного стороннего доступа.
1. **Автоматическая смена ключей каждые шесть месяцев.** Каждые шесть месяцев или каждый раз после отключения и повторного включения компонента обратной записи паролей в Azure AD Connect выполняется автоматическая смена всех ключей, чтобы обеспечить максимальную защиту службы.

### <a name="password-writeback-bandwidth-usage"></a>Использование пропускной способности компонента обратной записи паролей

Компонент обратной записи паролей — это служба с низкой пропускной способностью, которая отправляет запросы в локальный агент только при следующих условиях:

* Два сообщения отправляются при включении или отключении компонента с помощью Azure AD Connect.
* Одно сообщение отправляется каждые 5 минут как сигнал пульса службы, если служба запущена.
* Два сообщения отправляются при каждой отправке нового пароля.
   * Первое сообщение является запросом на выполнение операции.
   * Второе сообщение содержит результат этой операции и отправляется в следующих случаях:
      * Во время каждой отправки нового пароля при самостоятельном сбросе пароля пользователем.
      * Во время каждой отправки нового пароля в ходе операции по смене пароля пользователя.
      * Во время каждой отправки нового пароля при сбросе пароля, инициированном администратором (только на портале администрирования Azure).

#### <a name="message-size-and-bandwidth-considerations"></a>Рекомендации по размеру сообщений и пропускной способности

Размер каждого сообщения, описанного выше, как правило, не превышает 1 КБ. Даже при экстремальных нагрузках служба обратной записи паролей будет потреблять несколько килобитов в секунду. Так как каждое сообщение отправляется в режиме реального времени, только если этого требует операция обновления пароля, и размер сообщения невелик, потребляемая компонентом обратной записи пропускная способность будет слишком незначительна, чтобы оказывать заметное влияние.

## <a name="supported-writeback-operations"></a>Поддерживаемые операции обратной записи

Обратная запись паролей осуществляется во всех следующих ситуациях:

* **Поддерживаемые операции пользователей:**
   * Любая операция самостоятельного изменения пароля для конечных пользователей.
   * Любая операция самостоятельного изменения пароля конечным пользователем, например срок действия пароля.
   * Любой пользователь самостоятельно сбрасывать пароль, который создается на [портале сброса паролей](https://passwordreset.microsoftonline.com).

* **Поддерживаемые операции администрирования:**
   * Любые действия по самостоятельному изменению пароля самообслуживания.
   * Любая операция самостоятельного изменения пароля администратором, например срок действия пароля.
   * Любой администратор самостоятельно сбрасывает пароль, который создается на [портале сброса паролей](https://passwordreset.microsoftonline.com).
   * Любые сброс пароля конечного пользователя, инициированный администратором, из [портал Azure](https://portal.azure.com).
   * Любые сброс пароля конечного пользователя, инициированный администратором, из [бета-версии Microsoft Graph API](https://docs.microsoft.com/graph/api/passwordauthenticationmethod-resetpassword?view=graph-rest-beta&tabs=http).

## <a name="unsupported-writeback-operations"></a>Неподдерживаемые операции обратной записи

Пароли не записываются обратно в следующих ситуациях:

* **Неподдерживаемые операции пользователей:**
   * Любой пользователь, устанавливающий собственный пароль с помощью PowerShell версии 1, версии 2 или API Microsoft Graph.
* **Неподдерживаемые операции администрирования:**
   * Все инициированные администратором сброс пароля из PowerShell версии 1, версии 2 или API Microsoft Graph (поддерживается [бета-версия Microsoft Graph API](https://docs.microsoft.com/graph/api/passwordauthenticationmethod-resetpassword?view=graph-rest-beta&tabs=http) ).
   * Любые сброс пароля конечного пользователя, инициированный администратором, из [центра администрирования Microsoft 365](https://admin.microsoft.com).

> [!WARNING]
> Используйте флажок "пользователь должен сменить пароль при следующем входе в систему" в локальных AD DS средствах администрирования, таких как Active Directory пользователи и компьютеры, или центр администрирования Active Directory поддерживается в качестве предварительной версии функции Azure AD Connect. Дополнительные сведения см. в статье о [реализации синхронизации хэша паролей с помощью службы синхронизации Azure AD Connect](../hybrid/how-to-connect-password-hash-synchronization.md).

## <a name="next-steps"></a>Дальнейшие шаги

Чтобы приступить к работе с обратной записью SSPR, выполните следующие действия.

> [!div class="nextstepaction"]
> [Учебник. Включение самостоятельного сброса пароля (SSPR)](tutorial-enable-writeback.md)
