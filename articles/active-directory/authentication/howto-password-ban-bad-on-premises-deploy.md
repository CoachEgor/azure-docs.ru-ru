---
title: Развертывание предприимчезных мер защиты паролем Azure AD
description: Узнайте, как планировать и развертывать защиту паролем Azure AD в предварительной среде активных служб домена каталогов
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: how-to
ms.date: 03/05/2020
ms.author: iainfou
author: iainfoulds
manager: daveba
ms.reviewer: jsimmons
ms.collection: M365-identity-device-management
ms.openlocfilehash: 9ac9b76dd8d3c950b14f6d7b331f15647427ac89
ms.sourcegitcommit: 62c5557ff3b2247dafc8bb482256fef58ab41c17
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2020
ms.locfileid: "80652734"
---
# <a name="plan-and-deploy-on-premises-azure-active-directory-password-protection"></a>Планирование и развертывание на месте Azure Активная защита ролей каталога

Пользователи часто создают пароли, которые используют общие местные слова, такие как школа, спортивная команда или известный человек. Эти пароли легко угадать, и слабы против словарных атак. Для обеспечения надежных паролей в вашей организации, Azure Active Directory (Azure AD) Password Protection предоставляет глобальный и пользовательский список запрещенных паролей. Запрос на изменение пароля не удается, если есть совпадение в этих запрещенных список паролей.

Для защиты среды Active Directory Domain Services (AD DS) можно установить и настроить Azure AD Password Protection для работы с вашим д-р на прем DC. В этой статье показано, как установить и зарегистрировать прокси-сервис Azure AD Password Protection и агент Azure AD Password Protection DC в вашей предварительной среде.

Для получения дополнительной информации о том, как Azure AD Password Protection работает в предварительной среде, [см.](concept-password-ban-bad-on-premises.md)

## <a name="deployment-strategy"></a>Стратегия развертывания

На следующей диаграмме показано, как основные компоненты Azure AD Password Protection работают вместе в предварительной среде Active Directory:

![Взаимодействие компонентов защиты паролем Azure AD](./media/concept-password-ban-bad-on-premises/azure-ad-password-protection.png)

Рекомендуется рассмотреть вопрос о том, как работает программное обеспечение, прежде чем его развертывать. Для получения дополнительной информации смотрите [концептуальный обзор защиты паролем Azure AD.](concept-password-ban-bad-on-premises.md)

Мы рекомендуем начать развертывание в режиме *аудита.* Режим аудита — это начальная настройка по умолчанию, где пароли могут продолжать устанавливаться. Пароли, которые будут заблокированы, записываются в журнал событий. После развертывания прокси-серверов и агентов постоянного тока в режиме аудита следите за воздействием политики паролей на пользователей при исполнении политики.

На этапе аудита многие организации обнаруживают, что применяются следующие ситуации:

* Необходимо улучшить имеющиеся операционные процессы, чтобы использовать более безопасные пароли.
* Пользователи часто используют небезопасные пароли.
* Они должны информировать пользователей о грядущем изменении в обеспечении безопасности, возможном воздействии на них и о том, как выбрать более безопасные пароли.

Кроме того, более сильная проверка пароля влияет на существующую автоматизацию развертывания контроллеров домена Active Directory. Мы рекомендуем, чтобы по крайней мере одно продвижение по DC и одно понижение DC произошло во время оценки периода аудита, чтобы помочь раскрыть такие проблемы. Дополнительные сведения см. в следующих статьях:

* [Ntdsutil.exe не может установить слабый пароль режима ремонта служб каталогов](howto-password-ban-bad-on-premises-troubleshoot.md#ntdsutilexe-fails-to-set-a-weak-dsrm-password)
* [Продвижение реплики контроллера домена не удается из-за слабого пароля режима ремонта служб каталогов](howto-password-ban-bad-on-premises-troubleshoot.md#domain-controller-replica-promotion-fails-because-of-a-weak-dsrm-password)
* [Понижение контроллера домена не удается из-за слабого локального пароля администратора](howto-password-ban-bad-on-premises-troubleshoot.md#domain-controller-demotion-fails-due-to-a-weak-local-administrator-password)

После того, как функция работает в режиме аудита в течение разумного периода времени, можно переключить конфигурацию с *аудита* на *Enforce,* чтобы потребовать более безопасных паролей. Дополнительный мониторинг в течение этого времени является хорошей идеей.

### <a name="multiple-forest-considerations"></a>Многочисленные соображения леса

Дополнительные требования для развертывания защиты паролем Azure AD в нескольких лесах отсутствуют.

Каждый лес настроен независимо, как описано в следующем разделе для [развертывания на prem Azure AD Password Protection.](#download-required-software) Каждый прокси-сервер Azure AD Password Protection может поддерживать только контроллеры доменов из леса, к которым он присоединился.

Программное обеспечение Azure AD Password Protection в любом лесу не знает о программном обеспечении для защиты паролей, развернутом в других лесах, независимо от конфигураций доверия Active Directory.

### <a name="read-only-domain-controller-considerations"></a>Соображения контроллера домена только для чтения

Изменение пароля или настройка событий не обрабатываются и сохраняются на контроллерах доменов только для чтения (RODCs). Вместо этого они перенаправляются в writable контроллеры доменов. Вам не нужно устанавливать программное обеспечение агента Azure AD Password Protection DC на RODCs.

Кроме того, он не поддерживается для запуска прокси-сервиса Azure AD Password Protection на контроллере домена только для чтения.

### <a name="high-availability-considerations"></a>Соображения высокой доступности

Основной проблемой для защиты паролем является наличие прокси-серверов Azure AD Password Protection, когда dCs в лесу пытаются загрузить новые политики или другие данные из Azure. Каждый агент Azure AD Password Protection DC использует простой алгоритм кругового типа при принятии решения о том, какой прокси-сервер вызывать. Агент пропускает прокси-серверы, которые не отвечая.

Для наиболее полностью подключенных развертываний Active Directory, которые имеют здоровую репликацию состояния как каталога, так и папки sysvol, достаточно двух прокси-серверов Azure AD Password Protection, чтобы обеспечить доступность. Эта конфигурация приводит к своевременной загрузке новых политик и других данных. При желании можно развернуть дополнительные прокси-серверы Azure AD Password Protection.

Дизайн программного обеспечения Azure AD Password Protection DC смягчает обычные проблемы, связанные с высокой доступностью. Агент Azure AD Password Protection Даже если все зарегистрированные прокси-серверы становятся недоступными, агенты Azure AD Password Protection продолжают применять свою политику кэшированных паролей.

Разумная частота обновления для политик паролей в большом развертывании обычно составляет несколько часов, а не часы или меньше. Таким образом, кратковременные сбои в работе прокси-серверов существенно не влияют на защиту паролем Azure AD.

## <a name="deployment-requirements"></a>Требования к развертыванию

Для получения информации [Azure AD Password Protection licensing requirements](concept-password-ban-bad.md#license-requirements)о лицензировании см.

Применяются следующие основные требования:

* Все машины, включая контроллеры доменов, которые оснащены компонентами защиты паролем Azure AD, должны быть установлены универсальным C Runtime.
    * Вы можете получить время выполнения, убедившись, что у вас есть все обновления из Windows Update. Или вы можете получить его в ос-специфическом пакете обновления. Для получения дополнительной информации, [см.](https://support.microsoft.com/help/2999226/update-for-uniersal-c-runtime-in-windows)
* Для регистрации леса Active Directory С помощью Azure AD нужна учетная запись с привилегиями администратора домена Active Directory в домене forest.
* Служба распределения ключей должна быть включена на всех контроллерах доменов в домене, который работает windows Server 2012. По умолчанию эта услуга включена с помощью ручного запуска триггера.
* Подключение к сети должно существовать между по крайней мере одним контроллером домена в каждом домене и по крайней мере одним сервером, на котором находится прокси-сервис для защиты паролем Azure AD. Это подключение должно позволить контроллеру домена получить доступ к порту конечных точек RPC mapper 135 и порту сервера RPC на прокси-сервисе.
    * По умолчанию порт сервера RPC является динамическим портом RPC, но его можно настроить для [использования статического порта.](#static)
* Все машины, на которых будет установлена служба прокси-сервера Azure AD Password Protection, должны иметь сетевой доступ к следующим конечным точкам:

    |**Конечная точка**|**Назначение**|
    | --- | --- |
    |`https://login.microsoftonline.com`|Запросы на аутентификацию|
    |`https://enterpriseregistration.windows.net`|Функция защиты паролем Azure AD|

### <a name="azure-ad-password-protection-dc-agent"></a>Агент защиты DC защиты dD AD Azure

Следующие требования применяются к агенту Azure AD Password Protection DC:

* Все машины, на которых будет установлено программное обеспечение агента Azure AD Password Protection DC, должны работать с Windows Server 2012 или позже.
    * Область Active Directory или лес не должны находиться на функциональном уровне домена Windows Server 2012 (DFL) или функциональном уровне леса (FFL). Как уже упоминалось в [принципе дизайна](concept-password-ban-bad-on-premises.md#design-principles), нет минимального DFL или FFL требуется либо для агента DC или прокси программного обеспечения для запуска.
* Все машины, запускаемые агентом Azure AD Password Protection DC, должны быть установлены .NET 4.5.
* Любой домен Active Directory, работающий в службе защиты dc Azure AD, должен использовать репликацию распределенной файловой системы (DFSR) для репликации sysvol.
   * Если ваш домен уже не использует DFSR, необходимо перенести сядо, прежде чем устанавливать защиту паролем Azure AD. Для получения дополнительной информации, см [SYSVOL репликации Миграция Руководство: FRS для DFS репликации](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd640019(v=ws.10))

    > [!WARNING]
    > Программное обеспечение агента Azure AD Password Protection DC в настоящее время устанавливается на контроллеры доменов в доменах, которые все еще используют FRS (предшественник технологии DFSR) для репликации sysvol, но программное обеспечение не будет работать должным образом в этой среде.
    >
    > Дополнительные негативные побочные эффекты включают отдельные файлы, не в состоянии воспроизвести, и sysvol восстановления процедур, как представляется, удалось, но молча не в состоянии воспроизвести все файлы.
    >
    > Мигрируйте, чтобы использовать DFSR как можно скорее, как для присущих DFSR преимуществ, так и для разблокировки развертывания Azure AD Password Protection. Будущие версии программного обеспечения будут автоматически отключены при запуске в домене, который все еще использует FRS.

### <a name="azure-ad-password-protection-proxy-service"></a>Служба защиты от рекламы AD Azure

Следующие требования применяются к прокси-сервису Azure AD Password Protection:

* Все машины, на которых будет установлен прокси-сервис Azure AD Password Protection, должны работать с Windows Server 2012 R2 или позже.

    > [!NOTE]
    > Развертывание прокси-службы Azure AD Password Protection является обязательным требованием для развертывания Azure AD Password Protection, даже несмотря на то, что контроллер домена может иметь исходящие прямые подключения к Интернету.

* Все машины, на которых будет установлен прокси-сервис Azure AD Password Protection, должны быть установлены .NET 4.7.
    * .NET 4.7 уже должен быть установлен на полностью обновленном Windows Server. При необходимости загрузите и запустите установщик, найденный в [оффлайн-установщике .NET 4.7 для Windows.](https://support.microsoft.com/help/3186497/the-net-framework-4-7-offline-installer-for-windows)
* Все машины, в которых размещена прокси-служба Azure AD Password Protection, должны быть настроены для предоставления контроллерам доменов возможности входа в прокси-сервис. Эта способность управляется с помощью назначения привилегий "Доступ к этому компьютеру из сети".
* Все машины, вмещающие прокси-сервис Azure AD Password Protection, должны быть настроены таким образом, чтобы обеспечить исходящий трафик TLS 1.2 HTTP.
* Учетная запись *глобального администратора* для регистрации прокси-сервиса Azure AD Password Protection и лесного сервиса Azure AD.
* Сетевой доступ должен быть включен для набора портов и URL-адресов, указанных в [процедурах настройки среды приложения Proxy.](https://docs.microsoft.com/azure/active-directory/manage-apps/application-proxy-add-on-premises-application#prepare-your-on-premises-environment)

### <a name="microsoft-azure-ad-connect-agent-updater-prerequisites"></a>Предпосылки обновления агента Microsoft Azure AD Connect

Служба обновления Microsoft Azure AD Connect Connect установлена бок о бок с прокси-сервисом Azure AD Password Protection. Дополнительная конфигурация необходима для того, чтобы служба обновления агента Microsoft Azure AD Connect, чтобы иметь возможность функционировать:

* Если в вашей среде используется прокси-сервер HTTP, следуйте рекомендациям, указанным в [работе с существующими прокси-серверами.](https://docs.microsoft.com/azure/active-directory/manage-apps/application-proxy-configure-connectors-with-proxy-servers)
* Служба обновления Microsoft Azure AD Connect Connect также требует TLS 1.2 шагов, указанных в [требованиях TLS.](https://docs.microsoft.com/azure/active-directory/manage-apps/application-proxy-add-on-premises-application#tls-requirements)

> [!WARNING]
> Прокси-сервер Azure AD Password Protection и прокси-сервер Azure AD Application устанавливают различные версии службы Microsoft Azure AD Connect Agent Update, поэтому инструкции относятся к содержимому прокси-приложений. Эти различные версии несовместимы при установке бок о бок, поэтому не рекомендуется устанавливать прокси-сервер Azure AD Password Protection и прокси-сервер приложений на одной машине.

## <a name="download-required-software"></a>Загрузить необходимое программное обеспечение

Для развертывания на территории Azure AD Password Protection предусмотрены два необходимых установки:

* Агент azure AD Password Protection DC *(AzureADPasswordProtectionDCSetup.msi*)
* Прокси-сервер Azure AD Password Protection (*AzureADPasswordProtectionProxySetup.exe*)

Скачать оба инсталлятора из [Microsoft Download Center](https://www.microsoft.com/download/details.aspx?id=57071).

## <a name="install-and-configure-the-proxy-service"></a>Установка и настройка прокси-сервиса

Прокси-служба Azure AD Password Protection обычно находится на сервере-члене в среде AD DS. После установки прокси-сервис Azure AD Password Protection общается с Azure AD для ведения копии глобальных и запрещенных клиентом списков паролей для вашего клиента Azure AD.

В следующем разделе вы установите dc-агенты Azure AD Password Protection на контроллеры доменов в среде AD DS. Эти агенты постоянного тока общаются с прокси-сервисом, чтобы получить последние запрещенные списки паролей для использования при обработке событий изменения пароля в домене.

Выберите один или несколько серверов для размещения прокси-сервиса Azure AD Password Protection. Следующие соображения применяются для сервера (ы):

* Каждая такая служба может предоставить только политики паролей для одного леса. Машина-хоста должна быть соединена с доменом в этом лесу. Корневые и детские домены поддерживаются. Вам необходимо подключение к сети между по крайней мере одним постоянного током в каждом домене леса и машиной защиты паролей.
* Вы можете запустить прокси-сервис Azure AD Password Protection на контроллере домена для тестирования, но для этого контроллера домена требуется подключение к Интернету. Это подключение может быть проблемой безопасности. Мы рекомендуем эту конфигурацию только для тестирования.
* Мы рекомендуем по крайней мере два прокси-сервера Azure AD Password Protection для избыточности, как отмечалось в предыдущем разделе, [посвященных соображениям высокой доступности.](#high-availability-considerations)
* Он не поддерживается для запуска прокси-сервиса Azure AD Password Protection на контроллере домена только для чтения.

Чтобы установить прокси-сервис Azure AD Password Protection, выполните следующие действия:

1. Чтобы установить прокси-сервис Azure AD `AzureADPasswordProtectionProxySetup.exe` Password Protection, запустите установщик программного обеспечения.

    Установка программного обеспечения не требует перезагрузки и может быть автоматизирована с помощью стандартных процедур MSI, как в следующем примере:
    
    ```console
    AzureADPasswordProtectionProxySetup.exe /quiet
    ```
    
    > [!NOTE]
    > Служба Windows Firewall должна работать перед `AzureADPasswordProtectionProxySetup.exe` установкой пакета, чтобы избежать ошибки установки.
    >
    > Если Windows Firewall настроен анетна, обходной путь должен временно включить и запустить службу Брандмауэра во время установки. Прокси-программное обеспечение не имеет конкретной зависимости от Windows Firewall после установки.
    >
    > Если вы используете брандмауэр сторонних, он должен быть настроен таким образом, чтобы удовлетворить требования к развертыванию. Они включают в себя разрешение входящего доступа к порту 135 и прокси RPC серверного порта. Для получения дополнительной информации смотрите предыдущий раздел о [требованиях к развертыванию.](#deployment-requirements)

1. Прокси-программное обеспечение Azure AD Password Protection `AzureADPasswordProtection`включает в себя новый модуль PowerShell. Следующие шаги запускаются различные cmdlets из этого модуля PowerShell.

    Чтобы использовать этот модуль, откройте окно PowerShell в качестве администратора и импортируйте новый модуль следующим образом:
    
    ```powershell
    Import-Module AzureADPasswordProtection
    ```

1. Чтобы проверить, работает прокси-служба Azure AD Password Protection, используйте следующую команду PowerShell:

    ```powershell
    Get-Service AzureADPasswordProtectionProxy | fl
    ```

    Результат должен показать **статус** *бега.*

1. Прокси-служба работает на машине, но не имеет учетных данных для связи с Azure AD. Зарегистрируйте прокси-сервер Azure AD Password Protection `Register-AzureADPasswordProtectionProxy` с помощью Azure AD с помощью cmdlet.

    Этот cmdlet требует глобальных учетных данных администратора для вашего арендатора Azure. Также необходимо в домене для администратора домена Active Directory привилегий администратора функциональности в домене корня леса. Этот cmdlet также должен быть запущен с помощью учетной записи с локальными привилегиями администратора:

    После того, как эта команда преуспевает один раз для прокси-сервиса Azure AD Password Protection, дополнительные вызовы успеха, но ненужные.

    Cmdlet `Register-AzureADPasswordProtectionProxy` поддерживает следующие три режима аутентификации. Первые два режима поддерживают многофакторную аутентификацию Azure, а третий — нет.

    > [!TIP]
    > До завершения впервый раз, когда этот cmdlet будет запущен для конкретного клиента Azure, может быть заметна задержка. Если не будет сообщено о сбое, не беспокойтесь об этой задержке.

     * Интерактивный режим проверки подлинности.

        ```powershell
        Register-AzureADPasswordProtectionProxy -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com'
        ```

        > [!NOTE]
        > Этот режим не работает на операционных системах Server Core. Вместо этого используйте один из следующих режимов проверки подлинности. Кроме того, этот режим может вывести из строя, если включена конфигурация расширенной безопасности Internet Explorer. Решение заключается в том, чтобы отключить конфигурацию, зарегистрировать прокси, а затем повторно включить его.

     * Режим проверки подлинности по коду устройства.

        ```powershell
        Register-AzureADPasswordProtectionProxy -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com' -AuthenticateUsingDeviceCode
        ```

        При запросе, следуя по ссылке, чтобы открыть веб-браузер и ввести код проверки подлинности.

     * Режим автоматической проверки подлинности (на основе пароля).

        ```powershell
        $globalAdminCredentials = Get-Credential
        Register-AzureADPasswordProtectionProxy -AzureCredential $globalAdminCredentials
        ```

        > [!NOTE]
        > Этот режим выходит из строя, если для вашей учетной записи требуется многофакторная аутентификация Azure Multi-Factor. В этом случае используйте один из двух предыдущих режимов проверки подлинности или вместо этого используйте другую учетную запись, которая не требует МИД.
        >
        > Вы также можете увидеть, что требуется МИД, если регистрация устройств Azure (которая используется под крышкой Azure AD Password Protection) была настроена для глобального требования МИД. Для обхода этого требования можно использовать другую учетную запись, которая поддерживает МИД с одним из двух предыдущих режимов проверки подлинности, или вы также можете временно ослабить требование о регистрации устройств Azure.
        >
        > Чтобы внести это изменение, ищите и выберите **активный каталог Azure** на портале Azure, а затем выберите **Устройства > настройки устройств.** Набор **Требуют Multi-Фактор Аут для присоединения устройств** к *No*. Не забудьте перенастроить эту настройку обратно в *Да,* как только регистрация будет завершена.
        >
        > Мы рекомендуем, чтобы требования МИД были обойдятся только для тестовых целей.

    В настоящее время не нужно указывать параметр *-ForestCredential,* который зарезервирован для будущей функциональности.

    Регистрация прокси-сервиса Azure AD Password Protection необходима только один раз в течение всего срока службы. После этого прокси-служба Azure AD Password Protection автоматически выполняет любое другое необходимое техническое обслуживание.

1. Теперь зарегистрируйте в помещении Active Directory forest с необходимыми `Register-AzureADPasswordProtectionForest` учетными данными для связи с Azure с помощью cmdlet PowerShell.

    > [!NOTE]
    > Если в вашей среде установлено несколько прокси-серверов Azure AD Password Protection, не имеет значения, какой прокси-сервер используется для регистрации леса.

    Cmdlet требует глобальных учетных данных администратора для вашего арендатора Azure. Вы также должны запустить этот cmdlet с помощью учетной записи с локальными привилегиями администратора. Он также требует привилегий администратора корпоративного управления Active Directory. Этот шаг выполняется один раз в каждом лесу.

    Cmdlet `Register-AzureADPasswordProtectionForest` поддерживает следующие три режима аутентификации. Первые два режима поддерживают многофакторную аутентификацию Azure, а третий — нет.

    > [!TIP]
    > До завершения впервый раз, когда этот cmdlet будет запущен для конкретного клиента Azure, может быть заметна задержка. Если не будет сообщено о сбое, не беспокойтесь об этой задержке.

     * Интерактивный режим проверки подлинности.

        ```powershell
        Register-AzureADPasswordProtectionForest -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com'
        ```

        > [!NOTE]
        > Этот режим не будет работать на операционных системах Server Core. Вместо этого используйте один из следующих двух режимов аутентификации. Кроме того, этот режим может вывести из строя, если включена конфигурация расширенной безопасности Internet Explorer. Решение заключается в том, чтобы отключить конфигурацию, зарегистрировать лес, а затем повторно включить его.  

     * Режим проверки подлинности по коду устройства.

        ```powershell
        Register-AzureADPasswordProtectionForest -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com' -AuthenticateUsingDeviceCode
        ```

        При запросе, следуя по ссылке, чтобы открыть веб-браузер и ввести код проверки подлинности.

     * Режим автоматической проверки подлинности (на основе пароля).

        ```powershell
        $globalAdminCredentials = Get-Credential
        Register-AzureADPasswordProtectionForest -AzureCredential $globalAdminCredentials
        ```

        > [!NOTE]
        > Этот режим выходит из строя, если для вашей учетной записи требуется многофакторная аутентификация Azure Multi-Factor. В этом случае используйте один из двух предыдущих режимов проверки подлинности или вместо этого используйте другую учетную запись, которая не требует МИД.
        >
        > Вы также можете увидеть, что требуется МИД, если регистрация устройств Azure (которая используется под крышкой Azure AD Password Protection) была настроена для глобального требования МИД. Для обхода этого требования можно использовать другую учетную запись, которая поддерживает МИД с одним из двух предыдущих режимов проверки подлинности, или вы также можете временно ослабить требование о регистрации устройств Azure.
        >
        > Чтобы внести это изменение, ищите и выберите **активный каталог Azure** на портале Azure, а затем выберите **Устройства > настройки устройств.** Набор **Требуют Multi-Фактор Аут для присоединения устройств** к *No*. Не забудьте перенастроить эту настройку обратно в *Да,* как только регистрация будет завершена.
        >
        > Мы рекомендуем, чтобы требования МИД были обойдятся только для тестовых целей.

       Эти примеры удаётся только в том случае, если в настоящее время пользователь является также администратором домена Active Directory для корневого домена. Если это не так, вы можете предоставить альтернативные учетные данные домена через *параметр -ForestCredential.*

    Регистрация леса "Активный каталог" необходима только один раз в жизни леса. После этого агенты Azure AD Password Protection в лесу автоматически выполняют любое другое необходимое техническое обслуживание. После `Register-AzureADPasswordProtectionForest` успешного бега в лес дополнительные вызовы cmdlet удались, но были ненужными.
    
    Для `Register-AzureADPasswordProtectionForest` того, чтобы добиться успеха, по крайней мере один DC под управлением Windows Server 2012 или позже должен быть доступен в домене прокси-сервера Azure AD Password Protection. Программное обеспечение агента Azure AD Password Protection DC не должно быть установлено на любых контроллерах доменов до этого шага.

### <a name="configure-the-proxy-service-to-communicate-through-an-http-proxy"></a>Настройка прокси-сервиса для связи через прокси HTTP

Если для среды требуется использование определенного прокси HTTP для связи с Azure, используйте следующие шаги для настройки службы защиты паролей Azure AD.

Создайте файл *AzureADPasswordProtectionProxy.exe.config* в папке. `%ProgramFiles%\Azure AD Password Protection Proxy\Service` Включите следующее содержание:

   ```xml
   <configuration>
      <system.net>
         <defaultProxy enabled="true">
         <proxy bypassonlocal="true"
            proxyaddress="http://yourhttpproxy.com:8080" />
         </defaultProxy>
      </system.net>
   </configuration>
   ```

Если прокси HTTP требует проверки подлинности, добавьте тег *useDefaultCredentials:*

   ```xml
   <configuration>
      <system.net>
         <defaultProxy enabled="true" useDefaultCredentials="true">
         <proxy bypassonlocal="true"
            proxyaddress="http://yourhttpproxy.com:8080" />
         </defaultProxy>
      </system.net>
   </configuration>
   ```

В обоих `http://yourhttpproxy.com:8080` случаях замените адрес и порт вашего конкретного прокси-сервера HTTP.

Если прокси HTTP настроен для использования политики авторизации, необходимо предоставить доступ к компьютерной учетной записи Active Directory машины, в котором находится прокси-сервис для защиты паролем.

Мы рекомендуем вам остановить и перезапустить прокси-сервис Azure AD Password Protection после создания или обновления файла *AzureADPasswordProtectionProxy.exe.config.*

Прокси-сервис не поддерживает использование определенных учетных данных для подключения к прокси HTTP.

### <a name="configure-the-proxy-service-to-listen-on-a-specific-port"></a>Настройка прокси-сервиса для прослушивания в определенном порту

Программное обеспечение azure AD Password Protection DC использует RPC over TCP для связи с прокси-сервисом. По умолчанию прокси-сервис Azure AD Password Protection слушает любую доступную динамическую конечную точку RPC. Вы можете настроить службу для прослушивания на определенном порте TCP, если это необходимо из-за сетевой топологии или требований к брандмауэру в вашей среде.

<a id="static" /></a>Для настройки службы для работы под `Set-AzureADPasswordProtectionProxyConfiguration` статическим портом используйте cmdlet следующим образом:

```powershell
Set-AzureADPasswordProtectionProxyConfiguration –StaticPort <portnumber>
```

> [!WARNING]
> Для вхлаживать эти изменения и перезапустить прокси-сервис Azure AD Password Protection.

Чтобы настроить службу для работы под динамическим портом, используйте ту же процедуру, но установите *StaticPort* обратно к нулю:

```powershell
Set-AzureADPasswordProtectionProxyConfiguration –StaticPort 0
```

> [!WARNING]
> Для вхлаживать эти изменения и перезапустить прокси-сервис Azure AD Password Protection.

Прокси-служба Azure AD Password Protection требует ручной перезагрузки после любых изменений в конфигурации порта. Вам не нужно перезапускать службу агента Azure AD Password Protection DC на контроллерах доменов после внесения этих изменений конфигурации.

Для запроса текущей конфигурации службы `Get-AzureADPasswordProtectionProxyConfiguration` используйте cmdlet, как показано в следующем примере

```powershell
Get-AzureADPasswordProtectionProxyConfiguration | fl
```

Следующий пример показывает, что прокси-сервис Azure AD Password Protection использует динамический порт:

```output
ServiceName : AzureADPasswordProtectionProxy
DisplayName : Azure AD password protection Proxy
StaticPort  : 0
```

## <a name="install-the-dc-agent-service"></a>Установка службы агента ПОСТОЯННОГО ТОКа

Чтобы установить службу агента azure AD `AzureADPasswordProtectionDCAgentSetup.msi` Password Protection, запустите пакет.

Вы можете автоматизировать установку программного обеспечения с помощью стандартных процедур MSI, как показано в следующем примере:

```console
msiexec.exe /i AzureADPasswordProtectionDCAgentSetup.msi /quiet /qn /norestart
```

Флаг `/norestart` может быть опущен, если вы предпочитаете, чтобы установщик автоматически перезагрузил машину.

Установка программного обеспечения, или неустановка, требует перезагрузки. Это требование связано с тем, что DLL фильтра паролей загружаются или выгружаются только при перезагрузке.

Установка on-prem Azure AD Password Protection завершена после установки программного обеспечения агента ПОСТОЯННОГО ТОНа на контроллер домена и перезагрузки компьютера. Дальнейшая настройка не требуется. События изменения пароля в отношении напре-DCs используют настроенные списки запрещенных паролей из Azure AD.

Для включения защиты паролем Azure [AD](howto-password-ban-bad-on-premises-operations.md)от портала Azure или настройки пользовательских запрещенных паролей см.

> [!TIP]
> Вы можете установить агент Azure AD Password Protection DC на машину, которая еще не является контроллером домена. В этом случае служба запускается и запускается, но остается неактивной до тех пор, пока машина не будет повышена до того, как машина не станет контроллером домена.

## <a name="upgrading-the-proxy-service"></a>Обновление прокси-сервиса

Прокси-сервис Azure AD Password Protection поддерживает автоматическое обновление. Автоматическое обновление использует службу Microsoft Azure AD Connect Connect Updater, которая устанавливается бок о бок с прокси-сервисом. Автоматическое обновление включено по умолчанию и `Set-AzureADPasswordProtectionProxyConfiguration` может быть включено или отключено с помощью cmdlet.

Текущая настройка может быть `Get-AzureADPasswordProtectionProxyConfiguration` запрошена с помощью cmdlet. Мы рекомендуем всегда входить в настройки автоматического обновления.

Cmdlet `Get-AzureADPasswordProtectionProxy` может быть использован для запроса программной версии всех установленных в настоящее время прокси-серверов Azure AD Password Protection в лесу.

### <a name="manual-upgrade-process"></a>Процесс ручного обновления

Ручное обновление осуществляется за счет запуска `AzureADPasswordProtectionProxySetup.exe` последней версии установщика программного обеспечения. Последняя версия программного обеспечения доступна в [Центре загрузки Microsoft.](https://www.microsoft.com/download/details.aspx?id=57071)

Не требуется универнять текущую версию прокси-сервиса Azure AD Password Protection - установщик выполняет обновление на месте. При обновлении прокси-сервиса перезагрузка не требуется. Обновление программного обеспечения может быть автоматизировано `AzureADPasswordProtectionProxySetup.exe /quiet`с помощью стандартных процедур MSI, таких как .

## <a name="upgrading-the-dc-agent"></a>Обновление агента постоянного тока

Когда доступна новая версия программного обеспечения Azure AD Password Protection DC, обновление выполняется `AzureADPasswordProtectionDCAgentSetup.msi` за счет запуска последней версии пакета программного обеспечения. Последняя версия программного обеспечения доступна в [Центре загрузки Microsoft.](https://www.microsoft.com/download/details.aspx?id=57071)

Это не требуется, чтобы удалить текущую версию программного обеспечения агента ПОСТОЯННОГО ТОК - установщик выполняет в месте обновления. Перезагрузка всегда требуется при обновлении программного обеспечения агента постоянного тока - это требование вызвано поведением основной Windows.

Обновление программного обеспечения может быть автоматизировано `msiexec.exe /i AzureADPasswordProtectionDCAgentSetup.msi /quiet /qn /norestart`с помощью стандартных процедур MSI, таких как .

Вы можете опустить флаг, `/norestart` если вы предпочитаете, чтобы установщик автоматически перезагрузил машину.

Cmdlet `Get-AzureADPasswordProtectionDCAgent` может быть использован для запроса программной версии всех установленных в настоящее время агентов Azure AD Password Protection DC в лесу.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы установили службы, необходимые для защиты паролем Azure AD на ваших серверах, [включите на порталaz AD защиту ad на портале Azure](howto-password-ban-bad-on-premises-operations.md) для завершения развертывания.
