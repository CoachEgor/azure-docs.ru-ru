---
title: Развертывание защиты пароля Azure AD — Azure Active Directory
description: Развертывание защиты пароля Azure AD для запрета неправильных паролей в локальной
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: article
ms.date: 02/01/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: jsimmons
ms.collection: M365-identity-device-management
ms.openlocfilehash: 4c22c9c202e6de3b31b99803dce4a07d38287a92
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67057281"
---
# <a name="deploy-azure-ad-password-protection"></a>Развертывание защиты паролем Azure AD

Теперь, когда вы знаете [применение защиты пароля Azure AD для Windows Server Active Directory](concept-password-ban-bad-on-premises.md), следующим шагом является планирование и выполнение развертывания.

## <a name="deployment-strategy"></a>Стратегия развертывания

Мы рекомендуем начать развертывание в режиме аудита. Режим аудита — это начальный параметр по умолчанию, где пароли можно продолжать задать. Пароли, заблокированные записываются в журнал событий. После развертывания прокси-серверы и агенты контроллера домена в режиме аудита, вы должны отслеживать влияние, которое будет иметь политику паролей для пользователей и среды при применении политики.

На этапе аудита во многих организациях узнать, что:

* Необходимо улучшить имеющиеся операционные процессы, чтобы использовать более безопасные пароли.
* Пользователи часто используют небезопасным пароли.
* Им необходимо проинформировать пользователей о предстоящих изменений в обеспечение безопасности, привести к снижению их и как выбрать более безопасных паролей.

После функции выполнения в режиме аудита в течение разумного периода, можно переключить конфигурацию из *аудита* для *принудительное применение* требуется более безопасных паролей. Детальный мониторинг в это время — хорошая идея.

## <a name="deployment-requirements"></a>Требования к развертыванию

* Требования к лицензированию для защиты паролей Azure AD можно найти в статье [исключить неправильных паролей в вашей организации](concept-password-ban-bad.md#license-requirements).
* Все контроллеры домена, которые получают агента DC, службы, для защиты паролей Azure AD установлен необходимо запустить Windows Server 2012 или более поздней версии. Это требование не означает, что Active Directory домена или леса также должно находиться в домене или лесу функциональный уровень Windows Server 2012. Как упоминалось в [принципы проектирования](concept-password-ban-bad-on-premises.md#design-principles), нет минимальное DFL или FFL, необходимые для любого контроллера домена агента или прокси-сервер работы программного обеспечения.
* Все компьютеры, служба агента DC установлен требуется платформа .NET 4.5.
* Все компьютеры, получающие прокси-сервер службы для Azure AD парольную защиту необходимо запустить Windows Server 2012 R2 или более поздней версии.
   > [!NOTE]
   > Развертывание службы прокси-сервера — это обязательное требование для развертывания защиты пароля Azure AD, несмотря на то, что контроллер домена может иметь исходящие прямое подключение к Интернету. 
   >
* Все компьютеры, где будет установлена служба прокси-сервера для защиты паролей Azure AD должен иметь .NET 4.7 установлена.
  .NET 4.7 уже должны быть установлены на сервере полностью обновленный Windows. Если это не так, скачайте и запустите установщик обнаружил на [автономный установщик .NET Framework 4.7 для Windows](https://support.microsoft.com/en-us/help/3186497/the-net-framework-4-7-offline-installer-for-windows).
* Все компьютеры, включая контроллеры домена, получающие установлены компоненты защиты пароля Azure AD должен иметь универсальная среда выполнения C установлены. Среда выполнения можно получить, убедившись, что у вас есть все обновления из центра обновления Windows. Также вы можете получить в пакет обновления для определенных Операционных систем. Дополнительные сведения см. в разделе [обновление для универсальной среды выполнения C в Windows](https://support.microsoft.com/help/2999226/update-for-uniersal-c-runtime-in-windows).
* Сетевое подключение между должно существовать по крайней мере один контроллер домена в каждом домене и хотя бы один сервер, на котором размещена служба прокси-сервера для защиты паролем. Это подключение необходимо разрешить контроллеру домена для доступа к RPC endpoint mapper-порт 135 и порт сервера RPC для службы прокси-сервера. По умолчанию сервер RPC-порт выделяется динамически RPC, но его можно настроить для [статический порт](#static).
* Все машины, на которых размещены службы прокси-сервер должен иметь сетевой доступ к следующим конечным точкам:

    |**Конечная точка**|**Назначение**|
    | --- | --- |
    |`https://login.microsoftonline.com`|Запросы на аутентификацию|
    |`https://enterpriseregistration.windows.net`|Функция защиты паролем Azure AD|

* Все машины, на которых размещены службы прокси-сервера для защиты паролем должен быть настроен так, чтобы разрешить исходящий трафик TLS 1.2 HTTP.
* Учетную запись глобального администратора, чтобы зарегистрировать службу прокси для защиты паролей и леса в Azure AD.
* Учетная запись с правами администратора домена Active Directory в корневом домене леса, чтобы зарегистрировать леса Windows Server Active Directory с Azure AD.
* Любому домену Active Directory с контроллера домена агента службы программным обеспечением необходимо использовать распределенной файловой системы репликации (DFSR) для репликации sysvol.
* Служба распространения ключей должна быть включена на всех контроллерах домена в домене под управлением Windows Server 2012. По умолчанию эта служба включена с помощью вручную активировать запуск.

## <a name="single-forest-deployment"></a>Развертывание одного леса

На следующей схеме показана, как основные компоненты защиты пароля Azure AD работают вместе в локальной среде Active Directory.

![Взаимодействие компонентов защиты паролем Azure AD](./media/concept-password-ban-bad-on-premises/azure-ad-password-protection.png)

Рекомендуется просмотреть, как работает программное обеспечение перед его развертыванием. См. в разделе [концептуальный обзор защиты пароля Azure AD](concept-password-ban-bad-on-premises.md).

### <a name="download-the-software"></a>Скачивание ПО

Существует два установщика, необходимые для защиты паролей Azure AD. Они доступны из [центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=57071).

### <a name="install-and-configure-the-proxy-service-for-password-protection"></a>Установка и настройка службы прокси-сервера для защиты паролем

1. Выберите один или несколько серверов для размещения службы прокси-сервера для защиты паролем.
   * Каждая такая служба может предоставить только политики паролей для одного леса. Хост-компьютер должен входить в домен, в этом лесу. Корневые и дочерние домены поддерживаются. Требуется сетевое подключение между по крайней мере один контроллер домена в каждом домене леса и компьютером защиты пароля.
   * Прокси-сервера службу можно запустить на контроллере домена, для тестирования. Но этот контроллер домена требует подключения к Интернету, который может быть угрозой безопасности. Мы рекомендуем этой конфигурации только для тестирования.
   * Мы рекомендуем по крайней мере два прокси-сервера для обеспечения избыточности. См. в разделе [высокий уровень доступности](howto-password-ban-bad-on-premises-deploy.md#high-availability).

1. Установка Azure AD службы прокси-сервера для защиты паролей с помощью `AzureADPasswordProtectionProxySetup.exe` установщика программного обеспечения.
   * Для этого не требуется перезагрузка. Установку программного обеспечения можно автоматизировать с использованием стандартных процедур MSI, например:

      `AzureADPasswordProtectionProxySetup.exe /quiet`

      > [!NOTE]
      > Должна быть запущена служба брандмауэра Windows, прежде чем устанавливать пакет AzureADPasswordProtectionProxySetup.msi во избежание ошибки установки. Если брандмауэр Windows настроен не следует запускать, решение — временно включить и запустить службу брандмауэра во время установки. Программное обеспечение прокси-сервер имеет зависимости, не определенные в брандмауэре Windows после установки. Если вы используете сторонний брандмауэр, его необходимо настроить по-прежнему для удовлетворения требования к развертыванию. К ним относятся, позволяя входящий доступ к порту 135 и прокси-сервера RPC-порт. См. в разделе [требования к развертыванию](howto-password-ban-bad-on-premises-deploy.md#deployment-requirements).

1. Откройте окно PowerShell от имени администратора.
   * Программное обеспечение прокси-сервера пароль защиты включает новый модуль PowerShell, *AzureADPasswordProtection*. Следующие шаги выполнять различные командлеты этого модуля PowerShell. Импортируйте новый модуль следующим образом:

      ```powershell
      Import-Module AzureADPasswordProtection
      ```

   * Чтобы проверить, что служба запущена, используйте следующую команду PowerShell:

      `Get-Service AzureADPasswordProtectionProxy | fl`.

     Результат должен показывать **состояние** «Running».

1. Зарегистрируйте прокси-сервер.
   * После завершения шага 3, служба прокси-сервера запущена на компьютере. Но служба еще не имеет необходимых учетных данных для взаимодействия с Azure AD. Требуется регистрация в Azure AD:

     `Register-AzureADPasswordProtectionProxy`

     Этот командлет требует учетные данные глобального администратора для клиента Azure. Необходимо также права администратора в локальной Active Directory домена в корневом домене леса. После успешного выполнения этой команды один раз для прокси-службы, дополнительные вызовы будет выполнена, но не нужны.

      `Register-AzureADPasswordProtectionProxy` Командлет поддерживает следующие три режима проверки подлинности.

     * Интерактивный режим проверки подлинности.

        ```powershell
        Register-AzureADPasswordProtectionProxy -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com'
        ```

        > [!NOTE]
        > В этом режиме не работает в операционных системах основных серверных компонентов. Вместо этого используйте один из следующих режимов проверки подлинности. Кроме того этот режим может завершиться ошибкой, если включена конфигурация усиленной безопасности Internet Explorer. Обойти это, чтобы отключить эту конфигурацию, регистрации прокси-сервера и затем включите ее повторно.

     * Режим проверки подлинности по коду устройства.

        ```powershell
        Register-AzureADPasswordProtectionProxy -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com' -AuthenticateUsingDeviceCode
        To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code XYZABC123 to authenticate.
        ```

        Затем пользователь прошедший проверку подлинности, следуя инструкциям отображаемые на другом устройстве.

     * Режим автоматической проверки подлинности (на основе пароля).

        ```powershell
        $globalAdminCredentials = Get-Credential
        Register-AzureADPasswordProtectionProxy -AzureCredential $globalAdminCredentials
        ```

        > [!NOTE]
        > Этот режим не выполняется, если многофакторная Идентификация Azure является обязательным. В этом случае используйте один из предыдущих два режима проверки подлинности.

       Вы в настоящее время нет необходимости указывать *- ForestCredential* параметр, который зарезервирован для будущих функциональных возможностей.

   Регистрация службы прокси-сервера для защиты паролей не требуется только один раз за время существования службы. После этого служба прокси-сервера автоматически выполнит все необходимые операции обслуживания.

   > [!TIP]
   > Может существовать значительная задержка до завершения впервые запускается этот командлет для конкретного клиента Azure. Если сообщение об ошибке, не беспокойтесь о этой задержки.

1. Зарегистрируйте лес.
   * Необходимо инициализировать в локальном лесу Active Directory необходимые учетные данные для взаимодействия с Azure с помощью `Register-AzureADPasswordProtectionForest` командлета PowerShell. Командлет требуются учетные данные глобального администратора для клиента Azure. Он также требует привилегий администратора домена в локальной Active Directory в корневом домене леса. Этот шаг выполняется один раз в каждом лесу.

      `Register-AzureADPasswordProtectionForest` Командлет поддерживает следующие три режима проверки подлинности.

     * Интерактивный режим проверки подлинности.

        ```powershell
        Register-AzureADPasswordProtectionForest -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com'
        ```

        > [!NOTE]
        > Этот режим не будет работать на основных серверных компонентов операционных систем. Вместо этого используйте один из следующих режимов проверки подлинности два. Кроме того этот режим может завершиться ошибкой, если включена конфигурация усиленной безопасности Internet Explorer. Обойти это, чтобы отключить эту конфигурацию, регистрации прокси-сервера и затем включите ее повторно.  

     * Режим проверки подлинности по коду устройства.

        ```powershell
        Register-AzureADPasswordProtectionForest -AccountUpn 'yourglobaladmin@yourtenant.onmicrosoft.com' -AuthenticateUsingDeviceCode
        To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code XYZABC123 to authenticate.
        ```

        Затем пользователь прошедший проверку подлинности, следуя инструкциям отображаемые на другом устройстве.

     * Режим автоматической проверки подлинности (на основе пароля).

        ```powershell
        $globalAdminCredentials = Get-Credential
        Register-AzureADPasswordProtectionForest -AzureCredential $globalAdminCredentials
        ```

        > [!NOTE]
        > Этот режим не выполняется, если многофакторная Идентификация Azure является обязательным. В этом случае используйте один из предыдущих два режима проверки подлинности.

       Эти примеры успешно только в том случае, если пользователя, вошедшего в систему также является администратором домена Active Directory для корневого домена. Если это не так, можно указать альтернативные учетные через *- ForestCredential* параметра.

   > [!NOTE]
   > Если установлено несколько прокси-серверов в вашей среде, не важно какой прокси-сервер, который используется для регистрации в лесу.
   >
   > [!TIP]
   > Может существовать значительная задержка до завершения впервые запускается этот командлет для конкретного клиента Azure. Если сообщение об ошибке, не беспокойтесь о этой задержки.

   Регистрация леса Active Directory не требуется только один раз за время существования леса. После этого агенты контроллера домена в лесу автоматически выполнит все необходимые операции обслуживания. После `Register-AzureADPasswordProtectionForest` выполняется успешно для леса, дополнительных вызовов командлета выполнена успешно, но не нужны.

   Для `Register-AzureADPasswordProtectionForest` для успешного выполнения, по крайней мере один контроллер домена под управлением Windows Server 2012 или более поздней версии должны быть доступны в домене прокси-сервера. Но программное обеспечение агента для контроллера домена не требуется устанавливать на всех контроллерах домена, до выполнения этого действия.

1. Настройка службы прокси-сервера для защиты паролей для обмена данными через HTTP-прокси.

   Если среда требует использования определенных HTTP-прокси для взаимодействия с Azure, используйте этот метод: Создание *AzureADPasswordProtectionProxy.exe.config* файл в папке %ProgramFiles%\Azure AD Proxy\Service защиты пароля. Включите следующее содержимое:

      ```xml
      <configuration>
        <system.net>
          <defaultProxy enabled="true">
           <proxy bypassonlocal="true"
               proxyaddress="http://yourhttpproxy.com:8080" />
          </defaultProxy>
        </system.net>
      </configuration>
      ```

   Если прокси-сервер HTTP требует проверки подлинности, добавьте *useDefaultCredentials* тега:

      ```xml
      <configuration>
        <system.net>
          <defaultProxy enabled="true" useDefaultCredentials="true">
           <proxy bypassonlocal="true"
               proxyaddress="http://yourhttpproxy.com:8080" />
          </defaultProxy>
        </system.net>
      </configuration>
      ```

   В обоих случаях замените `http://yourhttpproxy.com:8080` адрес и порт определенного прокси-сервера HTTP.

   Если настроен прокси-сервер HTTP для нас политику авторизации, необходимо предоставить доступ к учетной записи компьютера Active Directory компьютера, на котором размещена служба прокси-сервера для защиты паролем.

   Рекомендуется остановить и перезапустить службу прокси-сервера, после создания или обновления *AzureADPasswordProtectionProxy.exe.config* файла.

   Служба прокси-сервер не поддерживает использование определенные учетные данные для подключения к прокси-сервер HTTP.

1. Необязательно: Настройка службы прокси-сервера для защиты пароля на прослушивание определенного порта.
   * Программное обеспечение агента DC для защиты пароля на контроллерах домена используется RPC по TCP для взаимодействия со службой прокси. По умолчанию служба прокси-сервер прослушивает любая доступная динамические RPC конечная точка. Но можно настроить службу для прослушивания определенного TCP-порта, если это необходимо из-за топологией сети или требования к брандмауэру в вашей среде.
      * <a id="static" /></a>Чтобы настроить службу для запуска под статический порт, используйте `Set-AzureADPasswordProtectionProxyConfiguration` командлета.

         ```powershell
         Set-AzureADPasswordProtectionProxyConfiguration –StaticPort <portnumber>
         ```

         > [!WARNING]
         > Вы должны остановить и перезапустить службу, чтобы эти изменения вступили в силу.

      * Чтобы настроить службу для выполнения динамических портов, используйте процедуру, но задать *StaticPort* до нуля:

         ```powershell
         Set-AzureADPasswordProtectionProxyConfiguration –StaticPort 0
         ```

         > [!WARNING]
         > Вы должны остановить и перезапустить службу, чтобы эти изменения вступили в силу.

   > [!NOTE]
   > Служба прокси-сервера для защиты пароля требуется перезагрузка вручную, после каждого изменения в конфигурации порта. Но у вас нет необходимость в перезагрузке программного обеспечения службы агента для контроллера домена на контроллерах домена, после внесения изменений в конфигурацию.

   * Чтобы запросить для текущей конфигурации службы, используйте `Get-AzureADPasswordProtectionProxyConfiguration` командлета:

      ```powershell
      Get-AzureADPasswordProtectionProxyConfiguration | fl

      ServiceName : AzureADPasswordProtectionProxy
      DisplayName : Azure AD password protection Proxy
      StaticPort  : 0
      ```

### <a name="install-the-dc-agent-service"></a>Установка службы агента DC

   Установка службы агента для контроллера домена для защиты паролем с помощью `AzureADPasswordProtectionDCAgentSetup.msi` пакета.

   Установка программного обеспечения, или отмены установки, требуется перезагрузка. Это обусловлено фильтра пароля DLL только при загрузке или выгрузке перезапуском.

   Служба агента DC можно установить на компьютере, который еще не контроллером домена. В этом случае служба будет запустить и запуска, но остается неактивной, пока компьютер становится контроллером домена.

   Установка программного обеспечения можно автоматизировать с помощью стандартных процедур MSI. Пример:

   `msiexec.exe /i AzureADPasswordProtectionDCAgentSetup.msi /quiet /qn`

   > [!WARNING]
   > Команда msiexec пример вызывает немедленную перезагрузку. Чтобы этого избежать, используйте `/norestart` флаг.

Установка будет завершена после установки программного обеспечения агента для контроллера домена на контроллере домена, и этот компьютер перезагружается. Дальнейшая настройка не требуется.

## <a name="multiple-forest-deployments"></a>Развертывание в нескольких лесах

Дополнительные требования для развертывания защиты паролем Azure AD в нескольких лесах отсутствуют. Каждый лес настраивается независимо друг от друга, как описано в разделе «Развертывание с одним лесом». Каждый прокси защиты пароля поддерживает только контроллеры домена в лесу, которая соединяется с. Программное обеспечение защиты паролем в любом лесу, не знает о программное обеспечение для защиты паролей, который развертывается в других лесах, независимо от настроек доверия Active Directory.

## <a name="read-only-domain-controllers"></a>Контроллеры домена только для чтения

Изменения или задает пароль, не обрабатываются и сохраняются на контроллеры домена только для чтения (RODC). Они перенаправляются для записи контроллеров домена. Таким образом вам нет необходимости устанавливать программное обеспечение агента для контроллера домена на контроллере RODC.

## <a name="high-availability"></a>Высокий уровень доступности

Значения основных доступности для защиты паролем заключается в доступности прокси-серверов, при попытке загрузить новые политики или другие данные из Azure контроллеры домена в лесу. Каждого агента DC использует простой алгоритм циклический перебор стиле, при принятии решения о какой прокси-сервер для вызова. Агент пропускает прокси-серверы, которые не отвечать на запросы. Для наиболее полностью подключенными развертывания Active Directory, имеющие работоспособность репликации состояния папку directory и sysvol два прокси-сервера достаточно для обеспечения доступности. Это приводит своевременного загрузка новые политики и другие данные. Но вы можете развернуть дополнительные прокси-серверы.

Проектирование программного обеспечения агента DC уменьшает обычные проблемы, связанные с высоким уровнем доступности. Агент DC поддерживает локальный кэш самого последнего скачанного политики паролей. Даже если все зарегистрированные прокси-серверы, становятся недоступными, агентами контроллера домена по-прежнему требовать использование политики их кэшированных паролей. Обычно является разумным частоту политик паролей в широком развертывании *дней*, а не часов или меньше. Таким образом краткое простоев прокси-серверов не значительно повлиять на защиту паролем Azure AD.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы установили службы, которые необходимы для защиты паролей Azure AD на локальных серверах, [выполнения настройки после установки и как собрать сведения о формировании отчетов](howto-password-ban-bad-on-premises-operations.md) для завершения развертывания.

[Предварительная версия. Применение защиты паролем Azure AD для Windows Server Active Directory](concept-password-ban-bad-on-premises.md)
