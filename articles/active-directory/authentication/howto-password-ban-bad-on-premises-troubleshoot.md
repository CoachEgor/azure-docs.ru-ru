---
title: Устранение неполадок на месте Azure AD Защита паролем
description: Узнайте, как устранить неполадки в защите паролем Azure AD для среды служб доменов active Directory
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: troubleshooting
ms.date: 11/21/2019
ms.author: iainfou
author: iainfoulds
manager: daveba
ms.reviewer: jsimmons
ms.collection: M365-identity-device-management
ms.openlocfilehash: 79ebf543a3880a4f2c8ee8c0d706c268ef3f08d2
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79263651"
---
# <a name="troubleshoot-on-premises-azure-ad-password-protection"></a>Устранение неполадок: Защита паролем Azure AD

После развертывания функции защиты паролей Azure AD может потребоваться устранить неполадки. В этой статье подробно рассматриваются некоторые общие шаги по устранению неполадок.

## <a name="the-dc-agent-cannot-locate-a-proxy-in-the-directory"></a>Агент ПОСТОЯННОГО тока не может найти прокси в каталоге

Основным симптомом этой проблемы является 30017 событий в журнале событий агента DC Admin.

Обычная причина этой проблемы заключается в том, что прокси еще не зарегистрирован. Если прокси был зарегистрирован, может быть некоторая задержка из-за задержки репликации AD до тех пор, пока конкретный агент ПОСТОЯННОГО ТОк не сможет увидеть этот прокси.

## <a name="the-dc-agent-is-not-able-to-communicate-with-a-proxy"></a>Агент DC не может общаться с прокси

Основным симптомом этой проблемы является 30018 событий в журнале событий агента DC Admin. Эта проблема может иметь несколько возможных причин:

1. Агент ПОСТОЯННОГО ТОКа находится в изолированной части сети, которая не позволяет подключение сети к зарегистрированной прокси(ы). Эта проблема может быть доброкачественной до тех пор, пока другие агенты постоянного тока могут общаться с прокси-сервером(ы) для загрузки политики паролей из Azure. После загрузки эти политики будут получены изолированным DC с помощью репликации файлов политики в акции sysvol.

1. Машина прокси-хоста блокирует доступ к конечной точке картографа RPC (порт 135)

   Установщик прокси-сервера Azure AD Password Сразу создает входящий правило Windows Firewall, которое позволяет получить доступ к порту 135. Если это правило будет позже удалено или отключено, агенты постоянного тока не смогут связаться с службой Прокси. Если встроенный Брандмауэр Windows был отключен вместо другого продукта брандмауэра, необходимо настроить брандмауэр, чтобы обеспечить доступ к порту 135.

1. Машина прокси-хоста блокирует доступ к конечной точке RPC (динамической или статической), прослушиваемой службой Proxy

   Установщик прокси-сервера Azure AD Password Сразу создает входящий правило Windows Firewall, которое позволяет получить доступ к любым входящим портам, которые прослушивается службой прокси-сервера Azure AD Password Protection. Если это правило будет позже удалено или отключено, агенты постоянного тока не смогут связаться с службой Прокси. Если встроенный Windows Firewall был отключен вместо другого продукта брандмауэра, необходимо настроить этот брандмауэр, чтобы обеспечить доступ к любым входящим портам, которые прослушивается службой защиты паролей Azure AD. Эта конфигурация может быть более конкретной, если служба Proxy была настроена для `Set-AzureADPasswordProtectionProxyConfiguration` прослушивания на определенном статичном порту RPC (с помощью cmdlet).

1. Компьютер прокси-хоста не настроен, чтобы позволить контроллерам доменов войти на машину. Это поведение контролируется с помощью "Доступ к этому компьютеру из сети" назначение привилегий пользователя. Все контроллеры доменов во всех областях в лесу должны быть предоставлены этой привилегии. Эта настройка часто ограничена в рамках более крупных усилий по закаливания сети.

## <a name="proxy-service-is-unable-to-communicate-with-azure"></a>Прокси-сервис не может общаться с Azure

1. Убедитесь, что прокси-машина имеет подключение к конечным точкам, перечисленным в [требованиях развертывания.](howto-password-ban-bad-on-premises-deploy.md)

1. Убедитесь, что лес и все прокси-серверы зарегистрированы против одного и того же арендатора Azure.

   Вы можете проверить это `Get-AzureADPasswordProtectionProxy` требование, запустив и `Get-AzureADPasswordProtectionDCAgent` `AzureTenant` PowerShell cmdlets, а затем сравнить свойство каждого возвращенного элемента. Для правильной работы имя клиента должно быть одинаковым во всех агентах постоянного тока и прокси-серверах.

   Если условие несоответствия регистрации клиента Azure существует, эта `Register-AzureADPasswordProtectionProxy` проблема `Register-AzureADPasswordProtectionForest` может быть исправлена, запустив и/или PowerShell cmdlets по мере необходимости, убедившись, что для всех регистраций используются учетные данные одного и того же арендатора Azure.

## <a name="dc-agent-is-unable-to-encrypt-or-decrypt-password-policy-files"></a>Агент ПОСТОЯННОГО ТОКа не может шифровать или расшифровывать файлы политики паролей

Защита паролем Azure AD имеет критическую зависимость от функции шифрования и расшифровки, поставляемой Службой распределения ключей Майкрософт. Сбои шифрования или расшифровки могут проявляться с различными симптомами и иметь несколько потенциальных причин.

1. Убедитесь, что служба KDS включена и функционала на всех Windows Server 2012, а затем и в домене.

   По умолчанию режим запуска службы KDS настроен как Руководство (Trigger Start). Эта конфигурация означает, что при первой попытке клиента использовать сервис, он запускается по требованию. Этот режим запуска службы по умолчанию приемлем для работы Azure AD Password Protection.

   Если режим запуска службы KDS был настроен на отключенный, эта конфигурация должна быть исправлена, прежде чем Защита паролем Azure AD будет работать должным образом.

   Простой тест для этой проблемы заключается в том, чтобы вручную запустить службу KDS, либо через консоль MMC управления обслуживанием, либо с помощью других инструментов управления (например, запустить "чистый запуск kdssvc" с командной консоли быстрого управления). Ожидается, что служба KDS успешно запустится и будет работать.

   Наиболее распространенной основной причиной не возможности запуска службы KDS является то, что объект контроллера домена Active Directory находится за пределами контроллеров доменов по умолчанию OU. Эта конфигурация не поддерживается службой KDS и не является ограничением, налагаемым защитой паролем Azure AD. Исправление этого условия заключается в перемещении объекта контроллера домена в место, наносивееееео по умолчанию контроллеры домена OU.

1. Несовместимые KDS зашифрованный формат буфера изменения с Windows Server 2012 R2 на Windows Server 2016

   Исправление безопасности KDS было введено в Windows Server 2016, которое изменяет формат зашифрованных буферов KDS; эти буферы иногда не могут расшифровать на Windows Server 2012 и Windows Server 2012 R2. Обратное направление в порядке - буферы, которые зашифрованы KDS на Windows Server 2012 и Windows Server 2012 R2, всегда будут успешно расшифровываться на Windows Server 2016 и позже. Если контроллеры доменов в доменах Active Directory работают с помощью этих операционных систем, могут сообщаться о периодических сбоях в расшифровке паролей Azure AD. Невозможно точно предсказать время или симптомы этих сбоев, учитывая характер исправления безопасности, и учитывая, что это недетерминированное, которое Azure AD Password Protection DC Agent, на котором контроллер домена будет шифровать данные в данный момент времени.

   Корпорация Майкрософт изучает решение этой проблемы, но ETA пока не доступна. В то же время, нет никакого обходного пути для этой проблемы, кроме как не запускать сочетание этих несовместимых операционных систем в домене Active Directory (ы). Другими словами, вы должны запускать только Windows Server 2012 и Windows Server 2012 R2 контроллеры домена, или вы должны запускать только Windows Server 2016 и выше контроллеров доменов.

## <a name="weak-passwords-are-being-accepted-but-should-not-be"></a>Слабые пароли принимаются, но не должны быть

Эта проблема может иметь несколько причин.

1. Ваш агент постоянного тока (ы) работает публичная версия программного обеспечения предварительного просмотра, срок действия которого истек. Просмотр [программного обеспечения агента DC истек.](howto-password-ban-bad-on-premises-troubleshoot.md#public-preview-dc-agent-software-has-expired)

1. Ваш агент постоянного тока (ы) не может загрузить политику или не может расшифровать существующие политики. Проверьте возможные причины в приведенных выше темах.

1. Режим принудительного применения политики паролей по-прежнему имеет значение "Аудит". Если эта конфигурация действует, перенастроить ее для обеспечения с помощью портала защиты паролей Azure AD. Для получения дополнительной [информации см.](howto-password-ban-bad-on-premises-operations.md#modes-of-operation)

1. Политика паролей отключена. Если эта конфигурация действует, перенастроить ее на включенную с помощью портала azure AD Password Protection. Для получения дополнительной [информации см.](howto-password-ban-bad-on-premises-operations.md#modes-of-operation)

1. Вы не установили программное обеспечение агента ПОСТОЯННОГО ТО на всех контроллерах домена в домене. В этой ситуации трудно гарантировать, что удаленные клиенты Windows нацелились на определенный контроллер домена во время операции по изменению пароля. Если вы считаете, что успешно нацелились на конкретный округ постоянного тока, где установлено программное обеспечение агента ПОСТОЯННОГО ТО, вы можете проверить, перепроверив журнал событий агента DC: независимо от результата, будет по крайней мере одно событие для документирования результата пароля Проверки. Если нет события для пользователя, чей пароль изменен, то изменение пароля, вероятно, было обработано другим контроллером домена.

   В качестве альтернативного теста попробуйте заменить пароли во время входа непосредственно в dc, где установлено программное обеспечение агента ПОСТОЯННОГО ТОКа. Этот метод не рекомендуется для производства доменов Active Directory.

   В то время как инкрементное развертывание программного обеспечения агента ПОСТОЯННОГО ТО поддерживается с учетом этих ограничений, корпорация Майкрософт настоятельно рекомендует, чтобы программное обеспечение агента ПОСТОЯННОГО ТОка было установлено на всех контроллерах домена в домене как можно скорее.

1. Алгоритм проверки пароля может работать как ожидалось. [Узнайте, как оцениваются пароли.](concept-password-ban-bad.md#how-are-passwords-evaluated)

## <a name="ntdsutilexe-fails-to-set-a-weak-dsrm-password"></a>Ntdsutil.exe не удается установить слабый пароль DSRM

Active Directory всегда проверяет новый пароль режима ремонта служб каталогов, чтобы убедиться, что он соответствует требованиям сложности паролей домена; Эта проверка также вызывает в dlls фильтра паролей как защита пароля AD Azure. Если новый пароль DSRM отклонен, результаты сообщения об ошибке:

```text
C:\>ntdsutil.exe
ntdsutil: set dsrm password
Reset DSRM Administrator Password: reset password on server null
Please type password for DS Restore Mode Administrator Account: ********
Please confirm new password: ********
Setting password failed.
        WIN32 Error Code: 0xa91
        Error Message: Password doesn't meet the requirements of the filter dll's
```

Когда Azure AD Password Protection регистрирует событие регистрации событий проверки пароля (ы) для пароля Active Directory DSRM, ожидается, что сообщения журнала событий не будут содержать имя пользователя. Такое поведение происходит из-за того, что учетная запись DSRM является локальной учетной записью, которая не является частью фактического домена Active Directory.  

## <a name="domain-controller-replica-promotion-fails-because-of-a-weak-dsrm-password"></a>Продвижение реплики контроллера домена не удается из-за слабого пароля DSRM

Во время процесса продвижения DC новый пароль режима ремонта служб каталогов будет представлен существующему DC в домене для проверки. Если новый пароль DSRM отклонен, результаты сообщения об ошибке:

```powershell
Install-ADDSDomainController : Verification of prerequisites for Domain Controller promotion failed. The Directory Services Restore Mode password does not meet a requirement of the password filter(s). Supply a suitable password.
```

Так же, как и в вышеупомянутой проблеме, любое событие проверки пароля Azure AD Password Protection будет иметь пустые имена пользователей для этого сценария.

## <a name="domain-controller-demotion-fails-due-to-a-weak-local-administrator-password"></a>Понижение контроллера домена не удается из-за слабого локального пароля администратора

Поддерживается понижение контроллера домена, который все еще запускает программное обеспечение агента контроллера. Администраторы должны знать, что программное обеспечение агента контроллера домена продолжает применять текущую политику паролей во время процедуры понижения. Новый пароль учетной записи локального администратора (указанный как часть операции понижения) проверяется, как и любой другой пароль. Корпорация Майкрософт рекомендует выбирать безопасные пароли для учетных записей локальных администраторов в рамках процедуры понижения В должности.

После успешного понижения роли контроллера домена и перезагрузки и повторного запуска в качестве обычного рядового сервера программное обеспечение агента контроллера домена возвращается к работе в пассивном режиме. Затем его можно удалить в любое время.

## <a name="booting-into-directory-services-repair-mode"></a>Загрузка в режим ремонта служб каталогов

Если контроллер домена загружается в режим ремонта служб каталогов, фильтр пароля агента DC dll обнаруживает это условие и приведет к отключению всех действий по проверке паролей или обеспечению соблюдения, независимо от действующей в настоящее время политики Конфигурации. Фильтр паролей агента DC dll будет регистрировать событие предупреждения 10023 в журнале событий Admin, например:

```text
The password filter dll is loaded but the machine appears to be a domain controller that has been booted into Directory Services Repair Mode. All password change and set requests will be automatically approved. No further messages will be logged until after the next reboot.
```
## <a name="public-preview-dc-agent-software-has-expired"></a>Срок действия программного обеспечения агента dc в открытом доступе

Во время публичного предварительного просмотра Azure AD Password Protection программное обеспечение агента ПОСТОЯННОГО ТОК было жестко закодировано, чтобы остановить обработку запросов на проверку паролей в следующие даты:

* Версия 1.2.65.0 прекратит обработку запросов на проверку паролей 1 сентября 2019 года.
* Версия 1.2.25.0 и до прекращения обработки запросов на проверку пароля 1 июля 2019 года.

По мере приближения крайнего срока все ограниченные по времени версии агента ПОСТОЯННОГО тока будут излучать событие 10021 в журнале событий агента DC В журнале событий Admin во время загрузки, которое выглядит следующим образом:

```text
The password filter dll has successfully loaded and initialized.

The allowable trial period is nearing expiration. Once the trial period has expired, the password filter dll will no longer process passwords. Please contact Microsoft for an newer supported version of the software.

Expiration date:  9/01/2019 0:00:00 AM

This message will not be repeated until the next reboot.
```

Как только крайний срок прошел, все ограниченные по времени версии агента ПОСТОЯННОГО тока будут излучать событие 10022 в журнале событий агента DC в журнале событий загрузки, которое выглядит следующим образом:

```text
The password filter dll is loaded but the allowable trial period has expired. All password change and set requests will be automatically approved. Please contact Microsoft for a newer supported version of the software.

No further messages will be logged until after the next reboot.
```

Поскольку крайний срок проверяется только при начальной загрузке, эти события могут быть зарегистрированы только в течение длительного времени после окончания срока действия календаря. Как только крайний срок будет признан, никаких негативных последствий ни для контроллера домена, ни для более широкой среды, кроме всех паролей, не будет автоматически утверждено.

> [!IMPORTANT]
> Корпорация Майкрософт рекомендует немедленно обновить агенты dc с истекшим сроком действия до последнего просмотра до последней версии.

Самый простой способ обнаружить dc агентов в вашей среде, которые должны быть обновлены, например, при запуске `Get-AzureADPasswordProtectionDCAgent` cmdlet, например:

```powershell
PS C:\> Get-AzureADPasswordProtectionDCAgent

ServerFQDN            : bpl1.bpl.com
SoftwareVersion       : 1.2.125.0
Domain                : bpl.com
Forest                : bpl.com
PasswordPolicyDateUTC : 8/1/2019 9:18:05 PM
HeartbeatUTC          : 8/1/2019 10:00:00 PM
AzureTenant           : bpltest.onmicrosoft.com
```

Для этой темы поле SoftwareVersion, очевидно, является ключевым свойством для изучения. Вы также можете использовать фильтрацию PowerShell для фильтрации агентов постоянного тока, которые уже находятся на уровне или выше требуемой базовой версии, например:

```powershell
PS C:\> $LatestAzureADPasswordProtectionVersion = "1.2.125.0"
PS C:\> Get-AzureADPasswordProtectionDCAgent | Where-Object {$_.SoftwareVersion -lt $LatestAzureADPasswordProtectionVersion}
```

Программное обеспечение Azure AD Password Protection Proxy не ограничено по времени ни в одной версии. Корпорация Майкрософт по-прежнему рекомендует обновлять как DC, так и прокси-агентов до самых последних версий по мере их выпуска. Cmdlet `Get-AzureADPasswordProtectionProxy` может быть использован для поиска прокси-агентов, которые требуют обновления, подобно приведенным выше для агентов постоянного тока.

Для получения более подробной информации о конкретных процедурах обновления обратитесь к [службе обновления и](howto-password-ban-bad-on-premises-deploy.md#upgrading-the-dc-agent) [обновлению службы Proxy.](howto-password-ban-bad-on-premises-deploy.md#upgrading-the-proxy-service)

## <a name="emergency-remediation"></a>Аварийное исправление

Если служба агента контроллера домена вызывает проблемы, ее можно немедленно отключить. Библиотека DLL фильтрации паролей агента контроллера домена по-прежнему пытается вызвать нерабочую службу и регистрирует события предупреждения (10012, 10013), но все входящие пароли принимаются в течение этого времени. Затем служба агента контроллера домена также может быть настроена с помощью диспетчера управления службами Windows с типом запуска "Отключено" при необходимости.

Еще один способ устранения неполадки — установить для режима включения значение "Нет" на портале функции защиты паролей Azure AD. Как только обновленная политика будет скачана, каждая служба агента контроллера домена перейдет в режим бездействия, в котором все пароли принимаются как есть. Для получения дополнительной [информации см.](howto-password-ban-bad-on-premises-operations.md#modes-of-operation)

## <a name="removal"></a>Удаление

Если будет принято решение удалить программное обеспечение для защиты паролей Azure AD и очистить все связанное состояние от домена (ы) и леса, эта задача может быть выполнена с помощью следующих шагов:

> [!IMPORTANT]
> Важно выполнить эти шаги по порядку. Если какой-либо экземпляр службы прокси-сервера остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint. Если какой-либо экземпляр службы агента контроллера домена остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint и состояние sysvol.

1. Удалите программное обеспечение прокси-сервера со всех компьютеров. Для этого шага **не** требуется перезагрузка компьютера.
2. Удалите программное обеспечение агента контроллера домена со всех контроллеров. Для этого шага **требуется** перезагрузка компьютера.
3. Вручную удалите все точки подключения службы прокси-сервера в каждом контексте именования домена. Расположение этих объектов можно обнаружить с помощью следующей команды PowerShell Active Directory:

   ```powershell
   $scp = "serviceConnectionPoint"
   $keywords = "{ebefb703-6113-413d-9167-9f8dd4d24468}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Не опускайте звездочку (*) в конце значения переменной $keywords.

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную.

4. Вручную удалите все точки подключения агента контроллера домена в каждом контексте именования домена. Там может быть один эти объекты на контроллер домена в лесу, в зависимости от того, насколько широко программное обеспечение было развернуто. Расположение этого объекта можно обнаружить с помощью следующей команды PowerShell Active Directory:

   ```powershell
   $scp = "serviceConnectionPoint"
   $keywords = "{2bac71e6-a293-4d5b-ba3b-50b995237946}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную.

   Не опускайте звездочку (*) в конце значения переменной $keywords.

5. Вручную удалите состояние конфигурации уровня леса. Состояние конфигурации леса поддерживается в контейнере в контексте именования конфигурации Active Directory. Его можно обнаружить и удалить следующим образом:

   ```powershell
   $passwordProtectionConfigContainer = "CN=Azure AD Password Protection,CN=Services," + (Get-ADRootDSE).configurationNamingContext
   Remove-ADObject -Recursive $passwordProtectionConfigContainer
   ```

6. Вручную удалите все сведения о состоянии sysvol, удалив следующую папку и все ее содержимое:

   `\\<domain>\sysvol\<domain fqdn>\AzureADPasswordProtection`

   При необходимости к этому пути также можно получить доступ локально на данном контроллере домена. Расположение по умолчанию будет выглядеть следующим образом:

   `%windir%\sysvol\domain\Policies\AzureADPasswordProtection`

   Этот путь будет другим, если общий ресурс sysvol настроен в нестандартном местоположении.

## <a name="next-steps"></a>Дальнейшие действия

[Часто задаваемые вопросы о функции защиты паролей Azure AD](howto-password-ban-bad-on-premises-faq.md)

Для получения дополнительной информации о глобальном и пользовательском запрещенных списках паролей см. статью [Запрет неверных паролей в организации](concept-password-ban-bad.md).
