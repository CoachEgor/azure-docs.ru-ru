---
title: Устранение неполадок в службе защиты паролей Azure AD. Azure Active Directory
description: Общие сведения об устранении неполадок в службе защиты паролей Azure AD
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: conceptual
ms.date: 02/01/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: jsimmons
ms.collection: M365-identity-device-management
ms.openlocfilehash: 1d96f5bb189dfd20c65fc6fc6ddcb8fff66d52ff
ms.sourcegitcommit: fecb6bae3f29633c222f0b2680475f8f7d7a8885
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/30/2019
ms.locfileid: "68666235"
---
# <a name="azure-ad-password-protection-troubleshooting"></a>Устранение неполадок с функцией защиты паролей Azure AD

После развертывания функции защиты паролей Azure AD может потребоваться устранить неполадки. В этой статье подробно рассматриваются некоторые общие шаги по устранению неполадок.

## <a name="the-dc-agent-cannot-locate-a-proxy-in-the-directory"></a>Агенту контроллера домена не удается располагать прокси-сервер в каталоге

Основным симптомом этой проблемы является 30017 событий в журнале событий администратора агента контроллера домена.

Обычно причиной этой проблемы является то, что прокси-сервер еще не зарегистрирован. Если прокси-сервер зарегистрирован, в связи с задержкой репликации AD может возникнуть задержка, пока конкретный агент контроллера домена не сможет увидеть этот прокси-сервер.

## <a name="the-dc-agent-is-not-able-to-communicate-with-a-proxy"></a>Агенту контроллера домена не удается связаться с прокси-сервером

Основным симптомом этой проблемы является 30018 событий в журнале событий администратора агента контроллера домена. Эта проблема может иметь несколько возможных причин.

1. Агент контроллера домена находится в изолированной части сети, которая не разрешает сетевое подключение к зарегистрированным прокси-серверам. Таким образом, эта проблема может быть недостаточной, если другие агенты контроллеров домена могут взаимодействовать с прокси-сервером для загрузки политик паролей из Azure, которые затем будут получены изолированным контроллером домена через репликацию файлов политики в общей папке SYSVOL.

1. Компьютер-посредник блокирует доступ к конечной точке сопоставителя конечных точек RPC (порт 135).

   Установщик прокси-сервера защиты паролей Azure AD автоматически создает правило входящего трафика брандмауэра Windows, которое разрешает доступ к порту 135. Если это правило будет удалено или отключено, агенты контроллера домена не смогут взаимодействовать со службой прокси. Если встроенный брандмауэр Windows был отключен вместо другого продукта брандмауэра, необходимо настроить этот брандмауэр, чтобы разрешить доступ к порту 135.

1. Компьютер-посредник блокирует доступ к конечной точке RPC (динамической или статической), прослушиваемой службой прокси

   Установщик прокси-сервера защиты паролей Azure AD автоматически создает правило входящего трафика брандмауэра Windows, которое разрешает доступ ко всем входящим портам, прослушиваемым прокси-службой защиты паролей Azure AD. Если это правило будет удалено или отключено, агенты контроллера домена не смогут взаимодействовать со службой прокси. Если встроенный брандмауэр Windows был отключен вместо другого продукта брандмауэра, необходимо настроить этот брандмауэр, чтобы разрешить доступ ко всем входящим портам, прослушиваемым прокси-службой защиты паролей Azure AD. Эта конфигурация может быть сделана более конкретной, если прокси-служба настроена на прослушивание определенного статического порта RPC (с помощью `Set-AzureADPasswordProtectionProxyConfiguration` командлета).

## <a name="proxy-service-is-unable-to-communicate-with-azure"></a>Службе прокси не удается связаться с Azure

1. Убедитесь, что на прокси-компьютере есть подключение к конечным точкам, указанным в [требованиях к развертыванию](howto-password-ban-bad-on-premises-deploy.md).

1. Убедитесь, что лес и все прокси-серверы зарегистрированы в одном клиенте Azure.

   Это требование можно проверить, запустив `Get-AzureADPasswordProtectionProxy` `AzureTenant` командлеты `Get-AzureADPasswordProtectionDCAgent` и PowerShell, а затем сравните свойство каждого возвращенного элемента. Для правильной работы сообщаемое имя клиента должно быть одинаковым для всех агентов контроллера домена и прокси-серверов.

   Если условие несоответствия регистрации клиента Azure существует, эту проблему можно устранить, запустив `Register-AzureADPasswordProtectionProxy` командлеты и (или `Register-AzureADPasswordProtectionForest` ) PowerShell по мере необходимости, чтобы использовать учетные данные из одного и того же клиента Azure для всех регистраций.

## <a name="dc-agent-is-unable-to-encrypt-or-decrypt-password-policy-files"></a>Агенту контроллера домена не удалось зашифровать или расшифровать файлы политики паролей

Эта проблема может переявляться с различными симптомами, но обычно имеет основную причину.

Защита паролей Azure AD имеет критическую зависимость от функций шифрования и расшифровки, предоставляемых службой распространения ключей (Майкрософт), которая доступна на контроллерах домена под управлением Windows Server 2012 и более поздних версий. Служба KDS должна быть включена и работать на всех контроллерах домена Windows Server 2012 и более поздних версий в домене.

По умолчанию для режима запуска службы KDS задано значение вручную (запуск триггера). Такая конфигурация означает, что при первой попытке клиента использовать службу она запускается по запросу. Этот режим запуска службы по умолчанию приемлем для работы защиты паролей Azure AD.

Если для режима запуска службы KDS задано значение отключено, эту конфигурацию необходимо исправить, прежде чем защита паролей Azure AD будет работать правильно.

Простая проверка этой проблемы заключается в запуске службы KDS вручную с помощью консоли MMC для управления службами или при использовании других средств управления (например, запустите NET start кдссвк из консоли командной строки). Служба KDS должна начаться успешно и продолжать работать.

Наиболее распространенной причиной невозможности запуска службы KDS является то, что объект контроллера домена Active Directory находится за пределами подразделения контроллеров домена по умолчанию. Эта конфигурация не поддерживается службой KDS и не является ограничением, наложенным защитой паролем Azure AD. Исправление для этого условия заключается в перемещении объекта контроллера домена в расположение в подразделении контроллеров домена по умолчанию.

## <a name="weak-passwords-are-being-accepted-but-should-not-be"></a>Ненадежные пароли принимаются, но не должны быть

Эта проблема может быть вызвана несколькими причинами.

1. Агентам контроллера домена не удается загрузить политику или расшифровать существующие политики. Проверьте возможные причины в указанных выше разделах.

1. Режим принудительного применения политики паролей по-прежнему имеет значение "Аудит". Если эта конфигурация действует, перенастройте ее для принудительного применения с помощью портала защиты паролей Azure AD. См. раздел [Включение защиты паролем](howto-password-ban-bad-on-premises-operations.md#enable-password-protection).

1. Политика паролей отключена. Если эта конфигурация действует, перенастройте ее для включения с помощью портала защиты паролей Azure AD. См. раздел [Включение защиты паролем](howto-password-ban-bad-on-premises-operations.md#enable-password-protection).

1. Программное обеспечение агента контроллера домена не установлено на всех контроллерах домена в домене. В этом случае трудно убедиться, что удаленные клиенты Windows нацелены на конкретный контроллер домена во время операции смены пароля. Если вы считаете, что вы успешно нацелены на конкретный контроллер домена, на котором установлено программное обеспечение агента контроллера домена, вы можете проверить его, дважды проверив журнал событий администратора агента контроллеров доменов: независимо от результата, для документирования результата пароля будет существовать по крайней мере одно событие. проверки. Если для пользователя, чей пароль изменен, не существует события, то изменение пароля, скорее всего, было обработано другим контроллером домена.

   В качестве альтернативного теста попробуйте сеттинг\чангинг пароли, войдя непосредственно в контроллер домена, где установлено программное обеспечение агента контроллера домена. Этот метод не рекомендуется для рабочих Active Directory доменов.

   Хотя добавочное развертывание программного обеспечения агента контроллера домена поддерживается в соответствии с этими ограничениями, корпорация Майкрософт настоятельно рекомендует как можно скорее установить программное обеспечение агента DC на всех контроллерах домена в домене.

1. В действительности алгоритм проверки пароля может работать должным образом. Узнайте [, как оцениваются пароли](concept-password-ban-bad.md#how-are-passwords-evaluated).

## <a name="ntdsutilexe-fails-to-set-a-weak-dsrm-password"></a>Программе Ntdsutil. exe не удается установить надежный пароль DSRM

Active Directory всегда будет проверять новый пароль режима восстановления служб каталогов, чтобы убедиться, что он соответствует требованиям к сложности паролей домена. Эта проверка также вызывает библиотеки DLL фильтрации паролей, такие как защита паролей Azure AD. Если новый пароль DSRM отклоняется, появляется следующее сообщение об ошибке:

```text
C:\>ntdsutil.exe
ntdsutil: set dsrm password
Reset DSRM Administrator Password: reset password on server null
Please type password for DS Restore Mode Administrator Account: ********
Please confirm new password: ********
Setting password failed.
        WIN32 Error Code: 0xa91
        Error Message: Password doesn't meet the requirements of the filter dll's
```

Когда служба защиты паролей Azure AD регистрирует события журнала событий проверки пароля для Active Directory пароля DSRM, ожидается, что сообщения журнала событий не будут содержать имя пользователя. Это происходит потому, что учетная запись DSRM — это локальная учетная запись, которая не входит в фактический домен Active Directory.  

## <a name="domain-controller-replica-promotion-fails-because-of-a-weak-dsrm-password"></a>Сбой повышения реплики контроллера домена из-за ненадежного пароля DSRM

Во время процесса продвижения контроллера домена новый пароль режима восстановления служб каталогов будет отправлен в существующий контроллер домена в домене для проверки. Если новый пароль DSRM отклоняется, появляется следующее сообщение об ошибке:

```powershell
Install-ADDSDomainController : Verification of prerequisites for Domain Controller promotion failed. The Directory Services Restore Mode password does not meet a requirement of the password filter(s). Supply a suitable password.
```

Как и в описанной выше причине, любое событие результата проверки пароля для защиты паролем Azure AD будет иметь пустые имена пользователей для этого сценария.

## <a name="domain-controller-demotion-fails-due-to-a-weak-local-administrator-password"></a>Сбой понижения роли контроллера домена из-за ненадежного пароля локального администратора

Поддерживается понижение контроллера домена, который все еще запускает программное обеспечение агента контроллера. Администраторы должны знать, что программное обеспечение агента контроллера домена продолжает применять текущую политику паролей во время процедуры понижения. Новый пароль учетной записи локального администратора (указанный как часть операции понижения) проверяется, как и любой другой пароль. Корпорация Майкрософт рекомендует выбирать защищенные пароли для учетных записей локального администратора в рамках процедуры понижения роли контроллера домена.

После успешного понижения роли контроллера домена и перезагрузки и повторного запуска в качестве обычного рядового сервера программное обеспечение агента контроллера домена возвращается к работе в пассивном режиме. Затем его можно удалить в любое время.

## <a name="booting-into-directory-services-repair-mode"></a>Загрузка в режиме восстановления служб каталогов

Если контроллер домена загружается в режиме восстановления служб каталогов, то служба агента контроллера домена обнаруживает это условие и вызывает отключение всех действий по проверке пароля или принудительного применения, независимо от текущей конфигурации политики.

## <a name="emergency-remediation"></a>Аварийное исправление

Если служба агента контроллера домена вызывает проблемы, ее можно немедленно отключить. Библиотека DLL фильтрации паролей агента контроллера домена по-прежнему пытается вызвать нерабочую службу и регистрирует события предупреждения (10012, 10013), но все входящие пароли принимаются в течение этого времени. Затем служба агента контроллера домена также может быть настроена с помощью диспетчера управления службами Windows с типом запуска "Отключено" при необходимости.

Еще один способ устранения неполадки — установить для режима включения значение "Нет" на портале функции защиты паролей Azure AD. Как только обновленная политика будет скачана, каждая служба агента контроллера домена перейдет в режим бездействия, в котором все пароли принимаются как есть. Дополнительные сведения см. в разделе [Режим принудительного применения](howto-password-ban-bad-on-premises-operations.md#enforce-mode).

## <a name="removal"></a>Удаление

Если решено удалить программное обеспечение защиты паролей Azure AD и очистить все связанные состояния от доменов и леса, эту задачу можно выполнить, выполнив следующие действия.

> [!IMPORTANT]
> Важно выполнить эти шаги по порядку. Если какой-либо экземпляр службы прокси-сервера остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint. Если какой-либо экземпляр службы агента контроллера домена остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint и состояние sysvol.

1. Удалите программное обеспечение прокси-сервера со всех компьютеров. Для этого шага **не** требуется перезагрузка компьютера.
2. Удалите программное обеспечение агента контроллера домена со всех контроллеров. Для этого шага **требуется** перезагрузка компьютера.
3. Вручную удалите все точки подключения службы прокси-сервера в каждом контексте именования домена. Расположение этих объектов можно обнаружить с помощью следующей команды PowerShell Active Directory:

   ```powershell
   $scp = "serviceConnectionPoint"
   $keywords = "{ebefb703-6113-413d-9167-9f8dd4d24468}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Не опускайте звездочку (*) в конце значения переменной $keywords.

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную.

4. Вручную удалите все точки подключения агента контроллера домена в каждом контексте именования домена. В каждом контроллере домена в лесу может быть один из этих объектов, в зависимости от того, насколько сильно развернуто программное обеспечение. Расположение этого объекта можно обнаружить с помощью следующей команды PowerShell Active Directory:

   ```powershell
   $scp = "serviceConnectionPoint"
   $keywords = "{2bac71e6-a293-4d5b-ba3b-50b995237946}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную.

   Не опускайте звездочку (*) в конце значения переменной $keywords.

5. Вручную удалите состояние конфигурации уровня леса. Состояние конфигурации леса поддерживается в контейнере в контексте именования конфигурации Active Directory. Его можно обнаружить и удалить следующим образом:

   ```powershell
   $passwordProtectionConfigContainer = "CN=Azure AD Password Protection,CN=Services," + (Get-ADRootDSE).configurationNamingContext
   Remove-ADObject -Recursive $passwordProtectionConfigContainer
   ```

6. Вручную удалите все сведения о состоянии sysvol, удалив следующую папку и все ее содержимое:

   `\\<domain>\sysvol\<domain fqdn>\AzureADPasswordProtection`

   При необходимости к этому пути также можно получить доступ локально на данном контроллере домена. Расположение по умолчанию будет выглядеть следующим образом:

   `%windir%\sysvol\domain\Policies\AzureADPasswordProtection`

   Этот путь будет другим, если общий ресурс sysvol настроен в нестандартном местоположении.

## <a name="next-steps"></a>Следующие шаги

[Часто задаваемые вопросы о функции защиты паролей Azure AD](howto-password-ban-bad-on-premises-faq.md)

Для получения дополнительной информации о глобальном и пользовательском запрещенных списках паролей см. статью [Запрет неверных паролей в организации](concept-password-ban-bad.md).
