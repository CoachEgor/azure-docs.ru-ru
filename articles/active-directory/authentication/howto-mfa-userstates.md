---
title: Включение Многофакторной идентификации для отдельных пользователей в Azure Active Directory
description: Узнайте, как включить Многофакторную идентификацию Azure для отдельных пользователей, изменяя пользовательское состояние.
services: multi-factor-authentication
ms.service: active-directory
ms.subservice: authentication
ms.topic: how-to
ms.date: 04/13/2020
ms.author: iainfou
author: iainfoulds
manager: daveba
ms.reviewer: michmcla
ms.collection: M365-identity-device-management
ms.openlocfilehash: 0db72e30fbced17665c112ad56510d7c2ca23d12
ms.sourcegitcommit: fdec8e8bdbddcce5b7a0c4ffc6842154220c8b90
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2020
ms.locfileid: "83639625"
---
# <a name="enable-per-user-azure-multi-factor-authentication-to-secure-sign-in-events"></a>Включение Многофакторной идентификации Azure для отдельных пользователей для защиты событий входа

Защитить события входа пользователя с помощью многофакторной проверки подлинности в Azure AD можно двумя способами. Первым и предпочтительным вариантом является настройка политики условного доступа, которая требует многофакторной проверки подлинности при определенных условиях. Второй вариант — включить Многофакторную идентификацию Azure для каждого отдельного пользователя. В этом случае пользователи выполняют многофакторную проверку подлинности при каждом входе (за некоторыми исключениями, к примеру, если они входят из доверенных IP-адресов или включена функция _запоминания устройств_).

> [!NOTE]
> Рекомендуемым подходом является включение Многофакторной идентификации Azure с использованием политик условного доступа. Изменение состояний пользователей больше не рекомендуется, если только ваши лицензии не включают условный доступ, так как для этого требуется, чтобы пользователи проходили многофакторную проверку подлинности при каждом входе.
>
> Чтобы приступить к работе с условным доступом, см. [Учебник. Защита событий входа с помощью Многофакторной идентификации Azure](tutorial-enable-azure-mfa.md).

## <a name="azure-multi-factor-authentication-user-states"></a>Состояния пользователей в службе "Многофакторная идентификация Azure"

Учетные записи пользователей в службе Многофакторной идентификации Azure имеют три различных состояния:

> [!IMPORTANT]
> Включение Многофакторной идентификации Azure с помощью политики условного доступа не меняет состояние пользователя. Если пользователи отображаются как отключенные — это не повод для беспокойства. Условный доступ не изменяет состояние.
>
> **Если вы используете политики условного доступа, не следует переводить пользователей в состояние Enabled (Включено) или Enforced (Применено).**

| Состояние | Описание | Затронутые приложения, не использующие браузер | Затронутые приложения, использующие браузер | Затронутая современная аутентификация |
|:---:| --- |:---:|:--:|:--:|
| Выключено | Состояние по умолчанию для нового пользователя, не указанного в службе Многофакторной идентификации Azure. | нет | нет | нет |
| Активировано | Пользователь указан в службе "Многофакторная идентификация Azure", но не зарегистрирован. Ему будет предложено зарегистрироваться при следующем входе в систему. | Нет.  Они будут продолжать работать, пока не завершится регистрация. | Да. После истечения срока действия сеанса требуется регистрация в службе "Многофакторная идентификация Azure".| Да. После истечения срока действия маркера доступа требуется регистрация в службе "Многофакторная идентификация Azure". |
| Принудительно | Пользователь указан в службе "Многофакторная идентификация Azure" и завершил процесс регистрации для ее использования. | Да. Для приложений нужны пароли приложений. | Да. При входе в систему нужно пройти проверку в службе "Многофакторная идентификация Azure". | Да. При входе в систему нужно пройти проверку в службе "Многофакторная идентификация Azure". |

Состояние пользователя отражает, указал ли администратор его в службе "Многофакторная идентификация Azure" и завершил ли пользователь процесс регистрации.

Все пользователи начинают с состояния *Отключено*. При регистрации пользователей в службе "Многофакторная идентификация Azure" их состояние изменяется на *Enabled* (Включено). После включения пользователи входят в систему и завершают регистрацию, затем их состояние меняется на *Enforced* (Принудительно).

> [!NOTE]
> Если Многофакторная идентификация Azure (MFA) повторно включается для объекта пользователя, который уже содержит сведения о регистрации, такие как телефон или электронная почта, администраторы должны проконтролировать, чтобы этот пользователь повторно зарегистрировался в службе Многофакторной идентификации с помощью портала Azure или PowerShell. Если пользователь не зарегистрируется повторно, его состояние в MFA не изменится с *Enabled* (Включено) на *Enforced* (Применено) в пользовательском интерфейсе управления MFA.

## <a name="view-the-status-for-a-user"></a>Просмотр состояния пользователя

Чтобы открыть страницу портала Azure, на которой можно просмотреть состояния пользователей и управлять ими:

1. Войдите на [портал Azure](https://portal.azure.com) с использованием учетной записи администратора.
1. Найдите и выберите *Azure Active Directory*, а затем выберите **Пользователи** > **Все пользователи**.
1. Выберите **Многофакторная идентификация**. Возможно, чтобы увидеть этот пункт меню, вам понадобится прокрутить экран вправо. Выберите приведенный ниже снимок экрана, чтобы просмотреть окно портала Azure целиком и расположение меню: [![](media/howto-mfa-userstates/selectmfa-cropped.png "Выбор Многофакторной идентификации в окне "Пользователи" в Azure AD")](media/howto-mfa-userstates/selectmfa.png#lightbox)
1. Откроется новая страница со сведениями о состоянии пользователя, как показано в следующем примере.
   ![Снимок экрана, показывающий пример сведений о состоянии пользователя в службе "Многофакторная идентификация Azure"](./media/howto-mfa-userstates/userstate1.png)

## <a name="change-the-status-for-a-user"></a>Изменение состояния пользователя

Чтобы изменить состояние пользователя в службе "Многофакторная идентификация Azure":

1. Выполните шаги выше, чтобы перейти на страницу **пользователей** MFA.
1. Найдите пользователя, которого вы хотите включить в службе "Многофакторная идентификация Azure". Возможно, потребуется перейти на представление **Пользователи** в верхней части страницы.
   ![На вкладке "Пользователи" выберите пользователя, состояние которого нужно изменить.](./media/howto-mfa-userstates/enable1.png)
1. Установите флажки рядом с именами пользователей, состояния которых нужно изменить.
1. Справа, в разделе **быстрых действий**, выберите **Включить** или **Отключить**. В следующем примере рядом с именем пользователя *John Smith* установлен флажок, и он включается для использования: ![Включите выбранного пользователя, щелкнув "Включить" в меню быстрых действий](./media/howto-mfa-userstates/user1.png)

   > [!TIP]
   > Пользователи с состоянием *Enabled* (Включено) автоматически перейдут в состояние *Enforced* (Применено) при регистрации в службе "Многофакторная идентификация Azure". Не изменяйте состояние пользователя вручную на *Enforced* (Применено).

1. Подтвердите свой выбор во всплывающем окне, которое откроется.

После включения уведомите пользователей по электронной почте. Сообщите пользователям о том, что при следующем входе в систему им будет показан запрос на регистрацию. Кроме того, если ваша организация использует небраузерные приложения, не поддерживающие современную аутентификацию, потребуется создать пароли приложений. Чтобы помочь пользователям начать работу, изучите [руководство пользователя по Многофакторной идентификации Azure](../user-help/multi-factor-authentication-end-user.md).

## <a name="change-state-using-powershell"></a>Изменение состояния с помощью PowerShell

Чтобы изменить состояние пользователя с помощью [Azure AD PowerShell](/powershell/azure/overview), измените параметр `$st.State` для учетной записи пользователя. Существует три возможных состояния учетной записи пользователя:

* *Enabled*
* *Enforced* (Применено);
* *Отключено*  

Не переводите пользователей непосредственно в состояние *Применено*. Если сделать это, приложения, не использующие браузер, перестанут работать, так как пользователь не прошел регистрацию в службе "Многофакторная идентификация Azure" и не получил [пароль приложения](howto-mfa-mfasettings.md#app-passwords).

Чтобы начать работу, установите модуль *MSOnline* с помощью командлета [Install-Module](/powershell/module/powershellget/install-module) следующим образом:

```PowerShell
Install-Module MSOnline
```

Затем подключитесь с помощью командлета [Connect-MsolService](/powershell/module/msonline/connect-msolservice):

```PowerShell
Connect-MsolService
```

В следующем примере сценарий PowerShell включает Многофакторную идентификацию Azure (MFA) для отдельного пользователя с именем *bsimon@contoso.com* :

```PowerShell
$st = New-Object -TypeName Microsoft.Online.Administration.StrongAuthenticationRequirement
$st.RelyingParty = "*"
$st.State = "Enabled"
$sta = @($st)

# Change the following UserPrincipalName to the user you wish to change state
Set-MsolUser -UserPrincipalName bsimon@contoso.com -StrongAuthenticationRequirements $sta
```

PowerShell — удобный инструмент для массового включения многофакторной проверки подлинности для пользователей. Следующий сценарий обрабатывает список пользователей и включает MFA для их учетных записей. Определите учетные записи пользователей, заданные в первой строке для `$users`, следующим образом:

   ```PowerShell
   # Define your list of users to update state in bulk
   $users = "bsimon@contoso.com","jsmith@contoso.com","ljacobson@contoso.com"

   foreach ($user in $users)
   {
       $st = New-Object -TypeName Microsoft.Online.Administration.StrongAuthenticationRequirement
       $st.RelyingParty = "*"
       $st.State = "Enabled"
       $sta = @($st)
       Set-MsolUser -UserPrincipalName $user -StrongAuthenticationRequirements $sta
   }
   ```

Чтобы отключить MFA, код в следующем примере получает пользователя с помощью командлета [Get-MsolUser](/powershell/module/msonline/get-msoluser), а затем удаляет значение параметра *StrongAuthenticationRequirements* для пользователя, заданного с помощью [Set-MsolUser](/powershell/module/msonline/set-msoluser):

```PowerShell
Get-MsolUser -UserPrincipalName bsimon@contoso.com | Set-MsolUser -StrongAuthenticationRequirements @()
```

Можно также напрямую отключить MFA для пользователя с помощью командлета [Set-MsolUser](/powershell/module/msonline/set-msoluser) следующим образом:

```PowerShell
Set-MsolUser -UserPrincipalName bsimon@contoso.com -StrongAuthenticationRequirements @()
```

## <a name="convert-users-from-per-user-mfa-to-conditional-access-based-mfa"></a>Преобразование пользователей из MFA для каждого пользователя в MFA на основе условного доступа

Приведенный ниже код PowerShell поможет выполнить преобразование в службу "Многофакторная идентификация Azure" на основе условного доступа.

```PowerShell
# Sets the MFA requirement state
function Set-MfaState {

    [CmdletBinding()]
    param(
        [Parameter(ValueFromPipelineByPropertyName=$True)]
        $ObjectId,
        [Parameter(ValueFromPipelineByPropertyName=$True)]
        $UserPrincipalName,
        [ValidateSet("Disabled","Enabled","Enforced")]
        $State
    )

    Process {
        Write-Verbose ("Setting MFA state for user '{0}' to '{1}'." -f $ObjectId, $State)
        $Requirements = @()
        if ($State -ne "Disabled") {
            $Requirement =
                [Microsoft.Online.Administration.StrongAuthenticationRequirement]::new()
            $Requirement.RelyingParty = "*"
            $Requirement.State = $State
            $Requirements += $Requirement
        }

        Set-MsolUser -ObjectId $ObjectId -UserPrincipalName $UserPrincipalName `
                     -StrongAuthenticationRequirements $Requirements
    }
}

# Disable MFA for all users
Get-MsolUser -All | Set-MfaState -State Disabled
```

> [!NOTE]
> Мы недавно изменили поведение и этот сценарий PowerShell. Ранее сценарий сохранял методы MFA, отключал MFA и восстанавливал методы. Это больше не требуется, так как поведение по умолчанию для отключения не приводит к очистке методов.
>
> Если Многофакторная идентификация Azure (MFA) повторно включается для объекта пользователя, который уже содержит сведения о регистрации, такие как телефон или электронная почта, администраторы должны проконтролировать, чтобы этот пользователь повторно зарегистрировался в службе Многофакторной идентификации с помощью портала Azure или PowerShell. Если пользователь не зарегистрируется повторно, его состояние в MFA не изменится с *Enabled* (Включено) на *Enforced* (Применено) в пользовательском интерфейсе управления MFA.

## <a name="next-steps"></a>Дальнейшие действия

Чтобы настроить параметры Многофакторной идентификации Azure, например надежные IP-адреса, пользовательские голосовые сообщения и предупреждения о мошенничестве, см. статью [Настройка параметров Многофакторной идентификации Azure](howto-mfa-mfasettings.md). Сведения об управлении параметрами пользователей для Многофакторной идентификации Azure см. в [этой статье](howto-mfa-userdevicesettings.md).

Чтобы понять, почему пользователь получил или не получил запрос на многофакторную проверку подлинности, см. статью об [отчетах службы "Многофакторная идентификация Azure"](howto-mfa-reporting.md).
