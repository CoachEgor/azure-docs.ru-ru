---
title: Совмещение комбинированной регистрации - Активный каталог Azure
description: Устранение проблем Azure AD Multi-Фактор аутентификации и самообслуживания сбросить паролем комбинированной регистрации
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: troubleshooting
ms.date: 04/15/2020
ms.author: iainfou
author: iainfoulds
manager: daveba
ms.reviewer: rhicock
ms.collection: M365-identity-device-management
ms.openlocfilehash: 7c840df2c53554519f62a3d1d7a7d8b305187ffb
ms.sourcegitcommit: b55d7c87dc645d8e5eb1e8f05f5afa38d7574846
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81450944"
---
# <a name="troubleshooting-combined-security-information-registration"></a>Устранение проблем комбинированной регистрации информации о безопасности

Информация в этой статье предназначена для руководства управленцев, которые неустановят проблемы, сообщаемые пользователями объединенного опыта регистрации.

## <a name="audit-logs"></a>Журналы аудита

События, зарегистрированные для комбинированной регистрации, относятся к категории «Методы аутентификации» в журналах аудита Azure AD.

![Интерфейс журналов Azure AD Audit, показывающий события регистрации](media/howto-registration-mfa-sspr-combined-troubleshoot/combined-security-info-audit-log.png)

В следующей таблице перечислены все события аудита, генерируемые комбинированной регистрацией:

| Действие | Состояние | Причина | Описание |
| --- | --- | --- | --- |
| Пользователь зарегистрировал всю необходимую информацию о безопасности | Успешно | Пользователь зарегистрировал всю необходимую информацию о безопасности. | Это событие происходит, когда пользователь успешно завершил регистрацию.|
| Пользователь зарегистрировал всю необходимую информацию о безопасности | Failure | Пользователь отменил регистрацию информации о безопасности. | Это событие происходит, когда пользователь отменяет регистрацию из режима прерывания.|
| Информация о безопасности, зарегистрированная пользователем | Успешно | Пользователь *зарегистрированный метод*. | Это событие происходит, когда пользователь регистрирует индивидуальный метод. *Методом* может быть приложение Authenticator, телефон, электронная почта, вопросы безопасности, пароль приложения, альтернативный телефон и так далее.| 
| Пользователь просматривал информацию о безопасности | Успешно | Пользователь успешно просмотрел информацию о безопасности. | Это событие происходит, когда пользователь выбирает **выглядит хорошо** на странице обзора информации о безопасности.|
| Пользователь просматривал информацию о безопасности | Failure | Пользователь не смог просмотреть информацию о безопасности. | Это событие происходит, когда пользователь выбирает **выглядит хорошо** на странице обзора информации о безопасности, но что-то не удается на бэкэнде.|
| Пользователь удален информации о безопасности | Успешно | Пользователь удалил *метод*. | Это событие происходит, когда пользователь удаляет отдельный метод. *Методом* может быть приложение Authenticator, телефон, электронная почта, вопросы безопасности, пароль приложения, альтернативный телефон и так далее.|
| Пользователь удален информации о безопасности | Failure | Пользователь не удалил *метод*. | Это событие происходит, когда пользователь пытается удалить метод, но попытка по некоторым причинам не удается. *Методом* может быть приложение Authenticator, телефон, электронная почта, вопросы безопасности, пароль приложения, альтернативный телефон и так далее.|
| Пользователь изменил информацию безопасности по умолчанию | Успешно | Пользователь изменил информацию о безопасности по умолчанию для *метода.* | Это событие происходит, когда пользователь изменяет метод по умолчанию. *Method* can be Authenticator app notification, A code from my authenticator app or token, Call +X XXXXXXXXXX, Text a code to +X XXXXXXXXX, and so on.|
| Пользователь изменил информацию безопасности по умолчанию | Failure | Пользователь не смог изменить информацию о безопасности по умолчанию для *метода.* | Это событие происходит, когда пользователь пытается изменить метод по умолчанию, но попытка не удается по некоторым причинам. *Method* can be Authenticator app notification, A code from my authenticator app or token, Call +X XXXXXXXXXX, Text a code to +X XXXXXXXXX, and so on.|

## <a name="troubleshooting-interrupt-mode"></a>Режим прерывания неполадок

| Симптом | Действия по устранению неполадок |
| --- | --- |
| Я не вижу методов, которые я ожидал увидеть. | 1. Проверьте, есть ли у пользователя роль админа Ad Azure. Если да, просмотрите различия в политике sSPR. <br> 2. Определите, прерывается ли пользователь из-за применения многофакторной проверки подлинности или обеспечения регистрации SSPR. См. [диаграмму потока](../../active-directory/authentication/concept-registration-mfa-sspr-combined.md#combined-registration-modes) в "Комбинированные режимы регистрации", чтобы определить, какие методы должны быть показаны. <br> 3. Определите, как недавно была изменена политика многофакторной аутентификации или SSPR. Если изменение было недавним, то для распространения обновленной политики может потребоваться некоторое время.|

## <a name="troubleshooting-manage-mode"></a>Режим устранения неполадок

| Симптом | Действия по устранению неполадок |
| --- | --- |
| У меня нет возможности добавить определенный метод. | 1. Определите, включен ли метод для мультифакторной аутентификации или для SSPR. <br> 2. Если метод включен, сохраните политики снова и подождите 1-2 часа, прежде чем снова тестировать. <br> 3. Если метод включен, убедитесь, что пользователь еще не создал максимальное количество этого метода, которое ему разрешено настроить.|

## <a name="disable-combined-registration"></a>Отключить комбинированную регистрацию

Когда пользователь регистрирует номер телефона и/или мобильное приложение в новом комбинированном опыте, наша служба штамповирует набор флагов (StrongAuthenticationMethods) для этих методов на этом пользователе. Эта функция позволяет пользователю выполнять Multi-Фактор аутентификации с этими методами, когда многофакторная аутентификация требуется.

Если админ позволяет просматривать предварительный просмотр, пользователи регистрируются через новый опыт, а затем админ отстраняет предварительный просмотр, пользователи могут неосознанно быть зарегистрированы для Мультифакторной аутентификации также.

Если пользователь, завершивший комбинированную регистрацию, перейдет на текущую страницу [https://aka.ms/ssprsetup](https://aka.ms/ssprsetup)регистрации сбросить пароля самообслуживания (SSPR), пользователю будет предложено выполнить Многофакторную аутентификацию, прежде чем он сможет получить доступ к этой странице. Этот шаг ожидается с технической точки зрения, но он является новым для пользователей, которые ранее были зарегистрированы только для SSPR. Хотя этот дополнительный шаг улучшает безопасность пользователя, предоставляя другой уровень безопасности, админы могут захотеть откатить своих пользователей, чтобы они больше не могли выполнять Multi-Factor Authentication.  

### <a name="how-to-roll-back-users"></a>Как откатить пользователей

Если вы, как админ, хотите сбросить настройки мультифакторной аутентификации пользователя, вы можете использовать сценарий PowerShell, представленный в следующем разделе. Скрипт очистит свойство StrongAuthenticationMethods для мобильного приложения пользователя и/или номера телефона. Если вы запустите этот скрипт для пользователей, они должны будут перерегистрироваться для мультифакторной аутентификации, если они в ней нуждаются. Мы рекомендуем тестировать откат с одним или двумя пользователями, прежде чем откатвсех всех пострадавших пользователей.

Последующие действия помогут вам откатить пользователя или группу пользователей.

#### <a name="prerequisites"></a>Предварительные требования

1. Установите соответствующие модули Azure AD PowerShell. В окне PowerShell выполните следующие команды для установки модулей:

   ```powershell
   Install-Module -Name MSOnline
   Import-Module MSOnline
   ```

1. Сохранить список идентификаторов затрагиваемых объектов пользователя на компьютере в виде текстового файла с одним идентификатором на строку. Запишите расположение файла.
1. Сохраните следующий скрипт на компьютере и обратите внимание на местоположение скрипта:

   ```powershell
   <# 
   //********************************************************
   //*                                                      *
   //*   Copyright (C) Microsoft. All rights reserved.      *
   //*                                                      *
   //********************************************************
   #>

   param($path)

   # Define Remediation Fn
   function RemediateUser {

       param  
       (
           $ObjectId
       )

       $user = Get-MsolUser -ObjectId $ObjectId

       Write-Host "Checking if user is eligible for rollback: UPN: "  $user.UserPrincipalName  " ObjectId: "  $user.ObjectId -ForegroundColor Yellow

       $hasMfaRelyingParty = $false
       foreach($p in $user.StrongAuthenticationRequirements)
       {
           if ($p.RelyingParty -eq "*")
           {
               $hasMfaRelyingParty = $true
               Write-Host "User was enabled for per-user MFA." -ForegroundColor Yellow
           }
       }

       if ($user.StrongAuthenticationMethods.Count -gt 0 -and -not $hasMfaRelyingParty)
       {
           Write-Host $user.UserPrincipalName " is eligible for rollback" -ForegroundColor Yellow
           Write-Host "Rolling back user ..." -ForegroundColor Yellow
           Reset-MsolStrongAuthenticationMethodByUpn -UserPrincipalName $user.UserPrincipalName
           Write-Host "Successfully rolled back user " $user.UserPrincipalName -ForegroundColor Green
       }
       else
       {
           Write-Host $user.UserPrincipalName " is not eligible for rollback. No action required."
       }

       Write-Host ""
       Start-Sleep -Milliseconds 750
   }

   # Connect
   Import-Module MSOnline
   Connect-MsolService

   foreach($line in Get-Content $path)
   {
       RemediateUser -ObjectId $line
   }
   ```

#### <a name="rollback"></a>Откат

В окне PowerShell запустите следующую команду, предоставив местоположение скрипта и файлов пользователя. При появлении запроса введите учетные данные глобального администратора. Сценарий выведет результат каждой операции обновления пользователя.

`<script location> -path <user file location>`

### <a name="disable-the-updated-experience"></a>Отключить обновленный опыт

Чтобы отключить обновленный опыт для пользователей, выполните следующие действия:

1. Вопиюсь на портал Azure в качестве администратора пользователя.
2. Перейдите к настройкам **пользователя Azure Active Directory** > Manage**settings** > **для функций предварительного просмотра панели доступа.**
3. В **рамках пользователи могут использовать функции предварительного просмотра для регистрации и управления информацией о безопасности,** установить селектор **нет,** а затем выбрать **Сохранить**.

Пользователям больше не будет предложено зарегистрироваться с помощью обновленного опыта.

## <a name="next-steps"></a>Следующие шаги

* [Узнайте больше о комбинированной регистрации для сбона пароля самообслуживания и многофакторной аутентификации Azure](concept-registration-mfa-sspr-combined.md)
