---
title: Настройка расширения NPS для Azure AD MFA — Azure Active Directory
description: После установки расширения NPS выполните следующие действия для расширенной настройки, например списков разрешенных IP-адресов и замены UPN.
services: multi-factor-authentication
ms.service: active-directory
ms.subservice: authentication
ms.topic: how-to
ms.date: 07/11/2018
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: michmcla
ms.collection: M365-identity-device-management
ms.openlocfilehash: 55c6457ec73c9fe9b39d607f26ffe2a577cc200d
ms.sourcegitcommit: 0a9df8ec14ab332d939b49f7b72dea217c8b3e1e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2020
ms.locfileid: "94839052"
---
# <a name="advanced-configuration-options-for-the-nps-extension-for-multi-factor-authentication"></a>Параметры расширенной конфигурации расширения NPS для Многофакторной идентификации

Расширение сервера политики сети (NPS) расширяет возможности многофакторной идентификации Azure AD на основе облачных служб в локальной инфраструктуре. В этой статье предполагается, что расширение уже установлено и вы хотите узнать, как настроить его для своих потребностей. 

## <a name="alternate-login-id"></a>Альтернативное имя пользователя

Так как расширение NPS подключается и к локальному, и к облачному каталогу, может возникнуть проблема, при которой имена участников-пользователей в локальной и облачной средах не совпадают. Чтобы решить эту проблему, используйте альтернативные имена пользователей. 

В расширении NPS можно назначить Active Directory атрибут, который будет использоваться вместо имени участника-пользователя для многофакторной идентификации Azure AD. Это позволяет защитить локальные ресурсы с помощью двухфакторной проверки подлинности без изменения локальных имен участников-пользователей. 

Чтобы настроить альтернативные имена пользователей, перейдите к `HKLM\SOFTWARE\Microsoft\AzureMfa` и измените следующие значения реестра:

| Имя | Тип | Значение по умолчанию | Описание |
| ---- | ---- | ------------- | ----------- |
| LDAP_ALTERNATE_LOGINID_ATTRIBUTE | строка | Empty | Укажите имя атрибута Active Directory, которое нужно использовать вместо имени участника-пользователя. Этот атрибут используется в качестве атрибута AlternateLoginId. Если это значение реестра указано как [допустимый атрибут Active Directory](/windows/win32/adschema/attributes-all) (например, mail или displayName), тогда значение атрибута используется вместо имени участника-пользователя для проверки подлинности. Если значение реестра пустое или не настроено, тогда AlternateLoginId отключен и имя участника-пользователя используется для проверки подлинности. |
| LDAP_FORCE_GLOBAL_CATALOG | Логическое | False | Используйте этот параметр, чтобы принудительно использовать глобальный каталог для поисков LDAP при поиске AlternateLoginId. Настройте контроллер домена в качестве глобального каталога, добавьте для него атрибут AlternateLoginId, а затем включите этот параметр. <br><br> Если LDAP_LOOKUP_FORESTS настроен (не пустой), **этот параметр будет устанавливаться со значением TRUE** независимо от значения параметра реестра. В этом случае расширению NPS требуется глобальный каталог с настроенным атрибутом AlternateLoginId для каждого леса. |
| LDAP_LOOKUP_FORESTS | строка | Empty | Предоставьте список разделенных точкой с запятой лесов для поиска. Например, *contoso.com;foobar.com*. Если значение реестра настроено, расширение NPS итеративно ищет все леса в порядке, в котором они были перечислены, и возвращает первое успешное значение AlternateLoginId. Если значение реестра не настроено, поиск AlternateLoginId ограничен текущим доменом.|

Для устранения проблем с альтернативным именем пользователя выполните рекомендуемые действия, описанные в разделе [Ошибки с альтернативным именем пользователя](howto-mfa-nps-extension-errors.md#alternate-login-id-errors).

## <a name="ip-exceptions"></a>Исключения IP-адресов

При необходимости отслеживать доступность сервера эти проверки не должны блокироваться запросами проверки. Например, если подсистемы балансировки нагрузки проверяют, какие серверы запущены, перед отправкой рабочей нагрузки. Вместо этого создайте список IP-адресов, которые используются учетными записями служб, и отключите для него требования Многофакторной идентификации.

Чтобы настроить список разрешенных IP-адресов, перейдите к `HKLM\SOFTWARE\Microsoft\AzureMfa` следующему значению реестра и настройте его:

| Имя | Тип | Значение по умолчанию | Описание |
| ---- | ---- | ------------- | ----------- |
| IP_WHITELIST | строка | Empty | Предоставьте список разделенных точкой с запятой IP-адресов. Включите в него IP-адреса компьютеров, где создаются запросы к службе, например NAS- или VPN-сервер. Диапазоны IP-адресов и подсети не поддерживаются. <br><br> Например, *10.0.0.1;10.0.0.2;10.0.0.3*.

> [!NOTE]
> Этот раздел реестра не создается по умолчанию установщиком, и при перезапуске службы в журнале Аусзоптч появляется сообщение об ошибке. Эту ошибку в журнале можно игнорировать, но если этот раздел реестра создан и оставлен пустым, если не требуется, то сообщение об ошибке не возвращается.

Когда запрос поступает с IP-адреса, который существует в `IP_WHITELIST` , двухфакторная проверка подлинности пропускается. Список IP-адресов сравнивается с IP-адресом, указанным в атрибуте *ратнасипаддресс* запроса RADIUS. При поступлении запроса RADIUS без атрибута ratNASIPAddress регистрируется следующее предупреждение: P_WHITE_LIST_WARNING::IP Whitelist is being ignored as source IP is missing in RADIUS request in NasIpAddress attribute (P_WHITE_LIST_WARNING: утвержденный список IP-адресов игнорируется, так как в атрибуте NasIpAddress запроса RADIUS отсутствует исходный IP-адрес).

## <a name="next-steps"></a>Дальнейшие действия

[Разрешение сообщений об ошибках из расширения NPS для многофакторной идентификации Azure AD](howto-mfa-nps-extension-errors.md)