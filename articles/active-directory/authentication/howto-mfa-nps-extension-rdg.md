---
title: Интеграция шлюза удаленный рабочий стол с расширением NPS для Azure MFA — Azure Active Directory
description: Интеграция инфраструктуры шлюза удаленных рабочих столов с Azure MFA с помощью расширения сервера политики сети для Microsoft Azure.
services: multi-factor-authentication
ms.service: active-directory
ms.subservice: authentication
ms.topic: conceptual
ms.date: 12/03/2018
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: michmcla
ms.collection: M365-identity-device-management
ms.openlocfilehash: cf9188502dd2b17bcd898e2655138b06cfe5cebf
ms.sourcegitcommit: 3e7646d60e0f3d68e4eff246b3c17711fb41eeda
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2019
ms.locfileid: "70898557"
---
# <a name="integrate-your-remote-desktop-gateway-infrastructure-using-the-network-policy-server-nps-extension-and-azure-ad"></a>Интеграция инфраструктуры шлюза удаленных рабочих столов с помощью расширения сервера политики сети (NPS) и Azure AD

В этой статье описывается интеграция инфраструктуры шлюза удаленных рабочих столов с Многофакторной идентификацией Azure (MFA) с помощью расширения сервера политики сети (NPS) для Microsoft Azure.

Расширение сервера политики сети (NPS) для Azure позволяет клиентам защитить аутентификацию клиентов RADIUS с помощью облачной [Многофакторной идентификации (MFA)](multi-factor-authentication.md) Azure. Это решение предоставляет двухфакторную проверку подлинности в качестве второго уровня безопасности для входа пользователей в систему и транзакций.

В этой статье приведены пошаговые инструкции по интеграции инфраструктуры NPS с Azure MFA с помощью расширения NPS для Azure. Это обеспечивает надежную проверку пользователей, пытающихся войти на шлюз удаленных рабочих столов.

> [!NOTE]
> Эта статья не предназначена для развертываний серверов MFA. Она предназначена только для облачных развертываний Azure MFA.

Службы политики сети и доступа (NPS) дают организациям следующие возможности.

* Можно определить центральные расположения для управления сетевыми запросами и их контроля, указав, кто может подключаться, в какое время дня подключения разрешены, продолжительность подключений, уровень безопасности, который клиенты должны использовать для подключения, и так далее. Вместо того, чтобы задавать эти политики на каждом VPN-сервере или сервере шлюза удаленных рабочих столов, их можно указать один раз в центральном расположении. Протокол RADIUS обеспечивает централизованную аутентификацию, авторизацию и учет.
* Можно устанавливать и применять политики работоспособности клиента защиты доступа к сети (NAP), которые определяют, предоставляется ли устройствам неограниченный или ограниченный доступ к сетевым ресурсам.
* Можно внедрить средства аутентификации и авторизации для доступа к точкам беспроводного доступа и коммутаторам Ethernet, поддерживающим протокол 802.1x.

Как правило, организации используют NPS (RADIUS) для упрощения и централизации управления политиками VPN. Однако во многих организациях NPS также используется для упрощения и централизации управления политиками авторизации подключений к удаленным рабочим столам.

Организации могут также интегрировать NPS с Azure MFA, чтобы повысить безопасность и обеспечить высокий уровень соответствия. Это позволяет обеспечить применение пользователями двухфакторной проверки подлинности для входа на шлюз удаленных рабочих столов. Чтобы получить доступ, пользователю необходимо предоставить свои имя пользователя и пароль, а также сведения, которыми он управляет. Эта информация должна быть надежной, и ее копирование должно быть затруднено. Например, это может быть номер мобильного телефона, номер стационарного телефона, приложение на мобильном устройстве и т. д. В настоящее время RDG поддерживает телефонные звонки и Push-уведомления от методов приложения Microsoft Authenticator для 2FA. Дополнительные сведения о поддерживаемых методах проверки подлинности см. в разделе [Определение методов проверки подлинности, которые смогут использовать пользователи](howto-mfa-nps-extension.md#determine-which-authentication-methods-your-users-can-use).

До появления расширения NPS для Azure клиентам, желавшим внедрить двухфакторную проверку подлинности для интегрированных сред NPS и Azure MFA, приходилось настраивать и обслуживать отдельный сервер MFA в локальной среде, как описано в разделе [Шлюз удаленных рабочих столов и сервер Многофакторной идентификации Azure, использующие проверку подлинности RADIUS](howto-mfaserver-nps-rdg.md).

Теперь, когда доступно расширение NPS для Azure, организации имеют возможность развернуть локальное или облачное решение MFA для защиты аутентификации клиентов RADIUS.

## <a name="authentication-flow"></a>Поток аутентификации

Чтобы пользователи могли получить доступ к сетевым ресурсам через шлюз удаленных рабочих столов, они должны соответствовать условиям, заданным в одной политике авторизации подключений к удаленным рабочим столам (RD CAP) и одной политике авторизации ресурсов удаленных рабочих столов (RD RAP). Политики авторизации подключений к удаленным рабочим столам определяют, кому разрешено подключаться к шлюзам удаленных рабочих столов. Политики авторизации ресурсов удаленных рабочих столов определяют сетевые ресурсы, например удаленные рабочие столы или удаленные приложения, к которым пользователь может подключаться с помощью шлюза удаленных рабочих столов.

Шлюз удаленных рабочих столов можно настроить для использования центрального хранилища политик авторизации подключений к удаленным рабочим столам. Политики авторизации ресурсов удаленных рабочих столов не могут использовать центральное хранилище политик, так как они обрабатываются на шлюзе удаленных рабочих столов. В качестве примера шлюза удаленных рабочих столов, настроенного для использования центрального хранилища политик авторизации подключений к удаленным рабочим столам, можно привести клиент RADIUS на другом NPS-сервере, который выступает в качестве центрального хранилища политик.

Когда расширение NPS интегрировано с сервером политики сети и шлюзом удаленных рабочих столов, поток успешной аутентификации выглядит следующим образом.

1. Сервер шлюза удаленных рабочих столов получает запрос на аутентификацию от пользователя удаленного рабочего стола для подключения к ресурсу (например, к сеансу удаленного рабочего стола). Выступая в качестве клиента RADIUS, сервер шлюза удаленных рабочих столов преобразовывает запрос в сообщение Access-Request RADIUS и отправляет его на сервер RADIUS (NPS), на котором установлено расширение NPS.
1. Сочетание имени пользователя и пароля проверяется в Active Directory, после чего пользователь аутентифицируется.
1. Если выполнены все условия, указанные в запросе на подключение NPS и политиках сети (например, ограничение времени дня или членства в группах), расширение NPS активирует запрос дополнительной аутентификации с помощью Azure MFA.
1. Служба Azure MFA обращается к Azure AD, получает сведения о пользователе и выполняет дополнительную аутентификацию с помощью одного из поддерживаемых методов.
1. После успешного прохождения Многофакторной идентификации служба Azure MFA передает результат в расширение NPS.
1. NPS-сервер, на котором установлено расширение NPS, отправляет сообщение Access-Accept RADIUS для политики авторизации подключений к удаленным рабочим столам на сервер шлюза удаленных рабочих столов.
1. Пользователю предоставляется доступ к запрошенному сетевому ресурсу через шлюз удаленных рабочих столов.

## <a name="prerequisites"></a>Предварительные требования

В этом разделе описаны предварительные условия, которые необходимо выполнить для интеграции Azure MFA и шлюза удаленных рабочих столов. Прежде чем приступить к работе, следует подготовить приведенные ниже необходимые компоненты:  

* инфраструктура служб удаленных рабочих столов (RDS);
* лицензия Azure MFA;
* программное обеспечение Windows Server;
* роль "Службы политики сети и доступа" (NPS);
* Синхронизация Azure Active Directory с локальной службой Active Directory
* идентификатор GUID Azure Active Directory.

### <a name="remote-desktop-services-rds-infrastructure"></a>Инфраструктура служб удаленных рабочих столов (RDS)

Необходима рабочая инфраструктура служб удаленных рабочих столов (RDS). Если этого не сделать, вы можете быстро создать эту инфраструктуру в Azure, используя следующий шаблон быстрого запуска: [Create Remote Desktop Session Collection deployment](https://github.com/Azure/azure-quickstart-templates/tree/ad20c78b36d8e1246f96bb0e7a8741db481f957f/rds-deployment) (Создание развертывания коллекции ресурсов для сеансов подключения к удаленным рабочим столам).

Если вы хотите быстро вручную создать локальную инфраструктуру служб удаленных рабочих столов для тестирования, выполните соответствующие инструкции.
**Дополнительные сведения**. [Развертывание службы RDS с помощью](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-in-azure) быстрого [развертывания Azure и базовой инфраструктуры RDS](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure).

### <a name="azure-mfa-license"></a>лицензия Azure MFA;

Требуется лицензия для Azure MFA, которая предоставляется в составе Azure AD Premium или других пакетов, содержащих эту лицензию. Лицензии на основе потребления Azure MFA, такие как лицензии на пользователя или лицензии на аутентификацию, несовместимы с расширением NPS. Дополнительные сведения см. в разделе [Как получить службу Многофакторной идентификации Azure](concept-mfa-licensing.md). Для тестирования можно использовать пробную подписку.

### <a name="windows-server-software"></a>программное обеспечение Windows Server;

Для работы расширения NPS требуется Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более поздней версии с установленной службой роли NPS. Все действия в этом разделе были выполнены с помощью Windows Server 2016.

### <a name="network-policy-and-access-services-nps-role"></a>Роль "Службы политики сети и доступа" (NPS)

Служба роли NPS предоставляет функциональные возможности сервера и клиента RADIUS, а также службу работоспособности NAP. Эту роль необходимо установить как минимум на двух компьютерах в инфраструктуре: на шлюзе удаленных рабочих столов и на еще одном рядовом сервере или контроллере домена. По умолчанию эта роль уже существует на компьютере, который настроен в качестве шлюза удаленных рабочих столов.  Необходимо также установить роль NPS по крайней мере еще на одном компьютере, например контроллере домена или рядовом сервере.

Дополнительные сведения об установке службы роли NPS на компьютер под управлением Windows Server 2012 или более ранней версии см. в разделе [Install a NAP Health Policy Server](https://technet.microsoft.com/library/dd296890.aspx) (Установка сервера политики работоспособности NAP). Описание рекомендаций для сервера политики сети, включая рекомендации по установке сервера политики сети на контроллер домена, см. в разделе [Best Practices for NPS](https://technet.microsoft.com/library/cc771746) (Рекомендации для сервера политики сети).

### <a name="azure-active-directory-synched-with-on-premises-active-directory"></a>Синхронизация Azure Active Directory с локальной службой Active Directory

Для использования расширения NPS локальные пользователи должны быть синхронизированы с Azure AD и настроены для использования Многофакторной идентификации. В этом разделе предполагается, что синхронизация локальных пользователей с Azure AD выполнена с помощью AD Connect. Дополнительные сведения про Azure AD Connect см. в статье [Выборочная установка Azure AD Connect](../hybrid/whatis-hybrid-identity.md).

### <a name="azure-active-directory-guid-id"></a>идентификатор GUID Azure Active Directory.

Чтобы установить расширение NPS, необходимо знать идентификатор GUID Azure AD. Ниже приведены инструкции по поиску идентификатора GUID Azure AD.

## <a name="configure-multi-factor-authentication"></a>Настройка Многофакторной идентификации

Этот раздел содержит инструкции по интеграции Azure MFA со шлюзом удаленных рабочих столов. В качестве администратора необходимо настроить службу Azure MFA, прежде чем пользователи смогут самостоятельно регистрировать свои устройства или приложений для Многофакторной идентификации.

Следуйте указаниям в разделе [Приступая к работе со службой Многофакторной идентификации Azure в облаке](howto-mfa-getstarted.md), чтобы включить MFA для пользователей Azure AD.

### <a name="configure-accounts-for-two-step-verification"></a>Настройка учетных записей для двухфакторной проверки подлинности

После включения MFA для учетной записи вы не сможете выполнить вход для доступа к ресурсам, управляемым политикой MFA, пока не настроите доверенное устройство для второго фактора аутентификации и не пройдете двухфакторную проверку подлинности.

Следуйте указаниям в разделе [Что для меня означает Многофакторная идентификация Azure](../user-help/multi-factor-authentication-end-user.md), чтобы понять процедуру и правильно настроить устройства для Многофакторной идентификации с помощью своей учетной записи пользователя.

## <a name="install-and-configure-nps-extension"></a>Установка и настройка расширения NPS

Этот раздел содержит инструкции по настройке инфраструктуры служб удаленных рабочих столов для использования Azure MFA для аутентификации клиентов с помощью шлюза удаленных рабочих столов.

### <a name="acquire-azure-active-directory-guid-id"></a>Получение идентификатора GUID Azure Active Directory

При настройке расширения NPS необходимо ввести учетные данные администратора и идентификатор Azure AD для клиента Azure AD. Ниже описывается, как получить идентификатор клиента.

1. Войдите на [портал Azure](https://portal.azure.com) как глобальный администратор клиента Azure.
1. В области навигации слева щелкните значок **Azure Active Directory**.
1. Выберите **Свойства**.
1. В колонке "Свойства" рядом с идентификатором каталога щелкните значок **Копировать**, как показано ниже, чтобы скопировать идентификатор в буфер обмена.

   ![Получение идентификатора каталога из портал Azure](./media/howto-mfa-nps-extension-rdg/image1.png)

### <a name="install-the-nps-extension"></a>Установка расширения NPS

Установите расширение NPS на сервер, на котором установлена роль "Службы политики сети и доступа" (NPS). Он выполняет роль сервера RADIUS в нашей инфраструктуре.

> [!Important]
> Не следует устанавливать расширение NPS на сервер шлюза удаленных рабочих столов.
>

1. Скачайте [расширение NPS](https://aka.ms/npsmfa).
1. Скопируйте исполняемый установочный файл (NpsExtnForAzureMfaInstaller.exe) на NPS-сервер.
1. На NPS-сервере дважды щелкните файл **NpsExtnForAzureMfaInstaller.exe**. При появлении запроса щелкните **Запустить**.
1. В диалоговом окне "NPS Extension For Azure MFA Setup" (Установка расширения NPS для Azure MFA) ознакомьтесь с условиями лицензии на программное обеспечение, установите флажок **Я подтверждаю согласие с условиями лицензии** и нажмите кнопку **Установить**.
1. В диалоговом окне "NPS Extension For Azure MFA Setup" (Установка расширения NPS для Azure MFA) нажмите кнопку **Закрыть**.

### <a name="configure-certificates-for-use-with-the-nps-extension-using-a-powershell-script"></a>Настройка сертификатов для расширения NPS с помощью сценария PowerShell

Далее необходимо настроить сертификаты для расширения NPS, чтобы обеспечить безопасную связь и контроль. Компоненты NPS включают в себя сценарий Windows PowerShell, предназначенный для настройки самозаверяющего сертификата для сервера политики сети.

Этот сценарий выполняет следующие действия:

* создает самозаверяющий сертификат;
* связывает открытый ключ сертификата с субъектом-службой в Azure AD;
* сохраняет сертификат в хранилище на локальном компьютере;
* предоставляет сетевому пользователю доступ к закрытому ключу сертификата;
* перезапускает службу сервера политики сети.

Если вы хотите использовать собственные сертификаты, необходимо привязать открытый ключ сертификата к субъекту-службе в Azure AD и т. д.

Чтобы использовать этот сценарий, укажите в расширении свои учетные данные администратора Azure AD и идентификатор клиента Azure AD, скопированный ранее. Запустите сценарий на каждом NPS-сервере, на котором установлено расширение NPS. После этого выполните описанные ниже действия.

1. Откройте командную строку Windows PowerShell с правами администратора.
1. В командной строке PowerShell введите `cd ‘c:\Program Files\Microsoft\AzureMfa\Config’` и нажмите клавишу **ВВОД**.
1. Введите `.\AzureMfaNpsExtnConfigSetup.ps1` и нажмите клавишу **ВВОД**. Сценарий проверяет, установлен ли модуль Azure Active Directory для PowerShell. Если он не установлен, сценарий автоматически установит этот модуль.

   ![Запуск Азуремфанпсекстнконфигсетуп. ps1 в Azure AD PowerShell](./media/howto-mfa-nps-extension-rdg/image4.png)
  
1. Проверив установку модуля PowerShell, сценарий отображает диалоговое окно модуля Azure Active Directory для PowerShell. В этом диалоговом окне введите учетные данные администратора Azure AD и пароль, затем щелкните **Вход**.

   ![Проверка подлинности в Azure AD в PowerShell](./media/howto-mfa-nps-extension-rdg/image5.png)

1. При появлении запроса вставьте идентификатор каталога, скопированный ранее в буфер обмена, и нажмите клавишу **Ввод**.

   ![Вывод идентификатора каталога в PowerShell](./media/howto-mfa-nps-extension-rdg/image6.png)

1. Этот сценарий создает самозаверяющий сертификат и выполняет другие изменения конфигурация. На рисунке ниже показан пример выходных данных.

   ![Выходные данные PowerShell, отображающие самозаверяющий сертификат](./media/howto-mfa-nps-extension-rdg/image7.png)

## <a name="configure-nps-components-on-remote-desktop-gateway"></a>Настройка компонентов NPS на шлюзе удаленных рабочих столов

В этом разделе описывается настройка политик авторизации подключений к шлюзу удаленных рабочих столов и других параметров RADIUS.

Поток проверки подлинности требует обмена сообщениями RADIUS между шлюзом удаленный рабочий стол и сервером политики сети, на котором установлено расширение NPS. Это означает, что необходимо настроить параметры клиента RADIUS на шлюзе удаленных рабочих столов и NPS-сервере, на котором установлено расширение NPS.

### <a name="configure-remote-desktop-gateway-connection-authorization-policies-to-use-central-store"></a>Настройка политик авторизации подключений к шлюзу удаленных рабочих столов для использования центрального хранилища

Политики авторизации подключений к удаленным рабочим столам определяют требования для подключения к серверу шлюза удаленных рабочих столов. Эти политики могут сохраняться локально (по умолчанию) или в центральном хранилище, в котором выполняется сервер политики сети. Чтобы настроить интеграцию Azure MFA со службами удаленных рабочих столов, необходимо задать использование центрального хранилища.

1. На сервере шлюза удаленных рабочих столов откройте **диспетчер сервера**.
1. В меню щелкните **Средства**, наведите указатель мыши на пункт **Службы удаленных рабочих столов**, а затем щелкните **Диспетчер шлюза удаленных рабочих столов**.
1. В диспетчере шлюза удаленных рабочих столов щелкните правой кнопкой мыши **\[имя сервера\] (локальный)** и выберите **Свойства**.
1. В диалоговом окне "Свойства" выберите вкладку **Хранилище политики авторизации подключений к удаленным рабочим столам**.
1. На вкладке "Хранилище политики авторизации подключений к удаленным рабочим столам" выберите **Центральный сервер политики сети**. 
1. В поле **Введите имя или IP-адрес сервера политики сети** введите IP-адрес или имя сервера, на котором установлено расширение NPS.

   ![Введите имя или IP-адрес сервера NPS](./media/howto-mfa-nps-extension-rdg/image10.png)
  
1. Нажмите кнопку **Добавить**.
1. В диалоговом окне **Общий секрет** введите общий секрет и нажмите кнопку **ОК**. Обязательно запишите этот общий секрет и сохраните в безопасном месте.

   >[!NOTE]
   >Он используется для установления доверия между серверами и клиентами RADIUS. Создайте длинный и сложный секрет.
   >

   ![Создание общего секрета для установления доверия](./media/howto-mfa-nps-extension-rdg/image11.png)

1. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.

### <a name="configure-radius-timeout-value-on-remote-desktop-gateway-nps"></a>Настройка значения времени ожидания RADIUS на сервере политики сети шлюза удаленных рабочих столов

Чтобы обеспечить достаточно времени для проверки учетных данных пользователей, двухфакторной проверки подлинности, получения ответов и реагирования на сообщения RADIUS, необходимо настроить значение времени ожидания RADIUS.

1. На сервере шлюза удаленных рабочих столов откройте диспетчер сервера. В меню щелкните **Средства**, а затем щелкните **Сервер политики сети**.
1. В консоли **Сервер сетевых политик (локальный)** разверните элемент **RADIUS-клиенты и серверы** и выберите **Remote RADIUS Server** (Удаленный сервер RADIUS).

   ![Консоль управления сервером политики сети, показывающая удаленный сервер RADIUS](./media/howto-mfa-nps-extension-rdg/image12.png)

1. В области сведений дважды щелкните **TS GATEWAY SERVER GROUP** (Группа серверов шлюза службы терминалов).

   >[!NOTE]
   >Данная группа серверов RADIUS была создана при настройке центрального сервера для политик NPS. Шлюз удаленных рабочих столов перенаправляет сообщения RADIUS на этот сервер или в группу серверов, если серверов в группе несколько.
   >

1. В диалоговом окне **TS GATEWAY SERVER GROUP Properties** (Свойства группы серверов шлюза службы терминалов) выберите IP-адрес или имя NPS-сервера, настроенного для хранения политик авторизации подключений к удаленным рабочим столам, а затем нажмите кнопку **Изменить**.

   ![Выберите IP-адрес или имя сервера NPS, настроенного ранее](./media/howto-mfa-nps-extension-rdg/image13.png)

1. В диалоговом окне **Изменение сервера RADIUS** выберите вкладку **Балансировка нагрузки**.
1. На вкладке **Балансировка нагрузки** в поле **Число секунд без ответа, после которого запрос считается отброшенным** измените значение по умолчанию, равное 3, на значение в диапазоне от 30 до 60 секунд.
1. В поле **Число секунд между запросами, после которого сервер считается недоступным** измените значение по умолчанию, равное 30 секундам, на значение, которое равно или больше значения, указанного на предыдущем шаге.

   ![Изменение параметров времени ожидания сервера RADIUS на вкладке "Балансировка нагрузки"](./media/howto-mfa-nps-extension-rdg/image14.png)

1. Дважды нажмите кнопку **ОК**, чтобы закрыть диалоговые окна.

### <a name="verify-connection-request-policies"></a>Проверка политик запросов на подключение

По умолчанию при настройке шлюза удаленных рабочих столов для использования центрального хранилища для политик авторизации подключений шлюз удаленных рабочих столов перенаправляет запросы политик авторизации подключений на NPS-сервер. NPS-сервер, на котором установлено расширение Azure MFA, обрабатывает запрос на доступ RADIUS. Ниже показано, как проверить политику запросов на подключение по умолчанию.

1. На шлюзе удаленных рабочих столов в консоли "Сервер сетевых политик (локальный)" разверните элемент **Политики** и выберите **Политики запросов на подключение**.
1. Дважды щелкните **TS GATEWAY AUTHORIZATION POLICY** (Политика аутентификации шлюза службы терминалов).
1. В диалоговом окне **TS GATEWAY AUTHORIZATION POLICY properties** (Свойства политики авторизации шлюза службы терминалов) щелкните вкладку **Параметры**.
1. На вкладке **Параметры** в разделе "Пересылка запроса на подключение" щелкните **Проверка подлинности**. Клиент RADIUS настроен для пересылки запросов на аутентификацию.

   ![Настройка параметров проверки подлинности, указывающих группу серверов](./media/howto-mfa-nps-extension-rdg/image15.png)

1. Нажмите кнопку **Отмена**.

## <a name="configure-nps-on-the-server-where-the-nps-extension-is-installed"></a>Настройка компонентов NPS на сервере, на котором установлено расширение NPS

NPS-сервер, на котором установлено расширение NPS, должен иметь возможность обмениваться сообщениями RADIUS с NPS-сервером в шлюзе удаленных рабочих столов. Чтобы обеспечить этот обмен сообщениями, необходимо настроить компоненты NPS на сервере, на котором установлена служба расширения NPS.

### <a name="register-server-in-active-directory"></a>Регистрация сервера в Active Directory

Для правильной работы в этом сценарии NPS-сервер должен быть зарегистрирован в Active Directory.

1. На NPS-сервере откройте **диспетчер сервера**.
1. В диспетчере сервера щелкните **Средства**, а затем щелкните **Сервер политики сети**.
1. В консоли сервера политики сети щелкните правой кнопкой мыши **Сервер сетевых политик (локальный)** , а затем щелкните **Зарегистрировать сервер в Active Directory**.
1. Дважды нажмите кнопку **ОК**.

   ![Регистрация сервера NPS в Active Directory](./media/howto-mfa-nps-extension-rdg/image16.png)

1. Оставьте консоль открытой для выполнения следующей процедуры.

### <a name="create-and-configure-radius-client"></a>Создание и настройка клиента RADIUS

Шлюз удаленных рабочих столов необходимо настроить как клиент RADIUS на NPS-сервере.

1. На NPS-сервере, на котором установлено расширение NPS, в консоли **Сервер сетевых политик (локальный)** щелкните правой кнопкой мыши **RADIUS-клиенты** и выберите **Создать**.

   ![Создание нового RADIUS-клиента в консоли NPS](./media/howto-mfa-nps-extension-rdg/image17.png)

1. В диалоговом окне **Новый RADIUS-клиент** введите понятное имя, например _Шлюз_, и IP-адрес или DNS-имя сервера шлюза удаленных рабочих столов.
1. В полях **Общий секрет** и **Подтвердите общий секрет** введите тот же секрет, который использовался ранее.

   ![Настройте понятное имя и IP-адрес или DNS-сервер.](./media/howto-mfa-nps-extension-rdg/image18.png)

1. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно "Новый RADIUS-клиент".

### <a name="configure-network-policy"></a>Настройка политики сети

Как вы помните, NPS-сервер с расширением Azure MFA был назначен центральным хранилищем для политики авторизации подключений. Поэтому необходимо внедрить политику авторизации подключений на NPS-сервере для авторизации допустимых запросов на подключение.  

1. На NPS-сервере откройте консоль "Сервер сетевых политик (локальный)", разверните элемент **Политики** и щелкните **Сетевые политики**.
1. Щелкните правой кнопкой мыши **Подключения к другим серверам доступа** и щелкните **Повторяющаяся политика**.

   ![Дублирование подключения к другим политикам серверов доступа](./media/howto-mfa-nps-extension-rdg/image19.png)

1. Щелкните правой кнопкой мыши **Copy of Connections to other access servers** (Копия политики подключения к другим серверам доступа) и щелкните **Свойства**.
1. В диалоговом окне **Copy of Connections to other access servers** (Копировать подключения к другим серверам доступа) в поле **Имя политики** введите подходящее имя, например _RDG_CAP_. Установите флажок **Политика включена** и щелкните **Разрешить доступ**. При необходимости в разделе **Тип сервера доступа к сети** выберите **Шлюз удаленных рабочих столов** или оставьте значение **Не указано**.

   ![Назовите политику, включите и предоставьте доступ.](./media/howto-mfa-nps-extension-rdg/image21.png)

1. Щелкните вкладку **Ограничения** и установите флажок **Разрешить подключение клиентов без согласования метода проверки подлинности**.

   ![Изменение методов проверки подлинности, чтобы разрешить клиентам подключаться](./media/howto-mfa-nps-extension-rdg/image22.png)

1. При необходимости щелкните вкладку **Условия** и добавьте условия, которые должны быть выполнены для авторизации подключения, например членство в определенной группе Windows.

   ![При необходимости укажите условия подключения](./media/howto-mfa-nps-extension-rdg/image23.png)

1. Нажмите кнопку **ОК**. При появлении предложения просмотреть соответствующий раздел справки нажмите кнопку **Нет**.
1. Убедитесь, что новая политика находится вверху списка, включена и предоставляет доступ.

   ![Перемещение политики в начало списка](./media/howto-mfa-nps-extension-rdg/image24.png)

## <a name="verify-configuration"></a>Проверка конфигурации

Чтобы проверить конфигурацию, необходимо войти на шлюз удаленных рабочих столов с помощью подходящего клиента RDP. Обязательно используйте учетную запись, которая разрешена вашими политиками авторизации подключений и для которой включена Многофакторная идентификация Azure.

Как показано на рисунке ниже, вы можете использовать страницу **Веб-доступ к удаленным рабочим столам**.

![Тестирование в удаленный рабочий стол Веб-доступ](./media/howto-mfa-nps-extension-rdg/image25.png)

После успешного ввода учетных данных для основной аутентификации в диалоговом окне подключения к удаленному рабочему столу отобразится состояние "Инициализация удаленного подключения", как показано ниже. 

После успешного прохождения дополнительной аутентификации, настроенной ранее в Azure MFA, вы будете подключены к ресурсу. Однако если вы не пройдете дополнительную аутентификацию, доступ к ресурсу будет запрещен. 

![подключение к удаленному рабочему столу инициализации удаленного подключения](./media/howto-mfa-nps-extension-rdg/image26.png)

В следующем примере приложение Authenticator в Windows Phone используется для дополнительной аутентификации.

![Пример Windows Phone приложения проверки подлинности, показывающего проверку](./media/howto-mfa-nps-extension-rdg/image27.png)

После успешного прохождения дополнительной аутентификации вы вошли в шлюз удаленных рабочих столов в обычном режиме. Однако, поскольку требуется использовать дополнительный метод проверки подлинности с помощью мобильного приложения на доверенном устройстве, процесс входа более безопасен, чем в противном случае.

### <a name="view-event-viewer-logs-for-successful-logon-events"></a>Просмотр событий успешного входа в журналах службы "Просмотр событий"

Чтобы просмотреть события успешного входа в журналах службы "Просмотр событий" Windows, можно выполнить приведенную команду Windows PowerShell, которая запрашивает журналы служб терминалов Windows и журналы безопасности Windows.

Чтобы запросить события успешного входа из операционных журналов шлюза _(Event Viewer\Applications and Services Logs\Microsoft\Windows\TerminalServices-Gateway\Operational)_ , используйте следующие команды PowerShell.

* `Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational | where {$_.ID -eq '300'} | FL`
* Эта команда отображает события Windows, в которых пользователь выполнил требования политики авторизации ресурсов удаленных рабочих столов и получил доступ.

![Просмотр событий с помощью PowerShell](./media/howto-mfa-nps-extension-rdg/image28.png)

* `Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational | where {$_.ID -eq '200'} | FL`
* Эта команда отображает события, в которых пользователь выполнил требования политики авторизации подключений.

![Просмотр политики авторизации подключений с помощью PowerShell](./media/howto-mfa-nps-extension-rdg/image29.png)

Можно также просмотреть этот журнал и отфильтровать информацию по идентификаторам событий, 300 и 200. Чтобы запросить события успешного входа из журналов безопасности службы "Просмотр событий", используйте следующую команду.

* `Get-WinEvent -Logname Security | where {$_.ID -eq '6272'} | FL`
* Эта команда может выполняться на центральном NPS-сервере или сервере шлюза удаленных рабочих столов.

![Примеры успешных событий входа](./media/howto-mfa-nps-extension-rdg/image30.png)

Можно также просмотреть настраиваемое представление журналов безопасности или служб политики сети и доступа, как показано ниже.

![Службы политики сети и доступа Просмотр событий](./media/howto-mfa-nps-extension-rdg/image31.png)

На сервере с расширением NPS для Azure MFA можно найти журналы приложений службы "Просмотр событий", относящиеся к расширению: _Application and Services Logs\Microsoft\AzureMfa_.

![Журналы приложения Просмотр событий AuthZ](./media/howto-mfa-nps-extension-rdg/image32.png)

## <a name="troubleshoot-guide"></a>Руководство по устранению неполадок

Если конфигурация не работает должным образом, то в первую очередь нужно убедиться, что пользователь настроен для использования Azure MFA. Подключите пользователя к [порталу Azure](https://portal.azure.com). Если пользователю предлагается дополнительная проверка и он может успешно пройти аутентификацию, то можно исключить ошибку в конфигурации Azure MFA.

Если пользователи успешно используют Azure MFA, следует изучить соответствующие журналы событий. К ним относятся журналы событий безопасности, операционные журналы шлюза и журналы Azure MFA, рассмотренные в предыдущем разделе.

Ниже приведен пример выходных данных журнала безопасности, содержащих событие неудачного входа (идентификатор события 6273).

![Пример события сбоя входа в систему](./media/howto-mfa-nps-extension-rdg/image33.png)

Ниже приведено связанное событие из журналов Azure MFA.

![Пример входа Azure MFA в Просмотр событий](./media/howto-mfa-nps-extension-rdg/image34.png)

Чтобы расширить возможности устранения неполадок, просмотрите файлы журнала в формате базы данных NPS в расположении, в котором установлена служба NPS. Эти файлы журналов создаются в папке _%SystemRoot%\System32\Logs_ в виде файлов с разделителями-запятыми.

Описание этих файлов журнала см. в разделе [Interpret NPS Database Format Log Files](https://technet.microsoft.com/library/cc771748.aspx) (Интерпретация файлов журнала в формате базы данных NPS). Записи в этих файлах журнала может быть сложно интерпретировать, не импортировав их в электронную таблицу или базу данных. Помочь в интерпретации файлов журнала могут несколько средств синтаксического анализа IAS в Интернете.

На рисунке ниже показаны выходные данные одной из таких скачиваемых [условно бесплатных программ](https://www.deepsoftware.com/iasviewer).

![Пример средства синтаксического анализа IAS приложения для условно-бесплатных приложений](./media/howto-mfa-nps-extension-rdg/image35.png)

Наконец, чтобы еще больше расширить возможности устранения неполадок, можно использовать анализатор протокола, например [Microsoft Message Analyzer](https://technet.microsoft.com/library/jj649776.aspx).

На рисунке ниже в Microsoft Message Analyzer показан сетевой трафик, отфильтрованный по протоколу RADIUS и содержащий имя пользователя **CONTOSO\AliceC**.

![Анализатор сообщений Майкрософт, демонстрирующий отфильтрованный трафик](./media/howto-mfa-nps-extension-rdg/image36.png)

## <a name="next-steps"></a>Следующие шаги

[Как получить службу Многофакторной идентификации Azure](concept-mfa-licensing.md)

[Шлюз удаленных рабочих столов и сервер Многофакторной идентификации Azure, использующие проверку подлинности RADIUS](howto-mfaserver-nps-rdg.md)

[Интеграция локальных каталогов с Azure Active Directory](../hybrid/whatis-hybrid-identity.md)
