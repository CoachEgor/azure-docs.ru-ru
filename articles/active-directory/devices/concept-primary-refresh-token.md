---
title: Первичный токен обновления (PRT) и Azure AD - Активный каталог Azure
description: Какова роль и как мы управляем токеном Primary Refresh (PRT) в Active Directory Azure?
services: active-directory
ms.service: active-directory
ms.subservice: devices
ms.topic: conceptual
ms.date: 05/29/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: ravenn
ms.collection: M365-identity-device-management
ms.openlocfilehash: 9a237ad35d9d5d8abee784926563d972d0ee95f9
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78672646"
---
# <a name="what-is-a-primary-refresh-token"></a>Что такое токен Первичного обновления?

Toprimary Refresh Token (PRT) — ключевой артефакт аутентификации Azure AD на устройствах Windows 10, iOS и Android. Это JSON Web Token (JWT), специально выданный брокерам токенов первой стороны Microsoft для включения одного включения в систему (SSO) в приложениях, используемых на этих устройствах. В этой статье мы предоставим подробную информацию о том, как PRT издается, используется и защищенна на устройствах Windows 10.

В этой статье предполагается, что вы уже понимаете различные состояния устройств, доступные в Azure AD, и то, как одиночный входе работает в Windows 10. Более подробную информацию об устройствах в Azure AD можно узнать в статье [«Что такое управление устройствами» в Active Directory Azure?](overview.md)

## <a name="key-terminology-and-components"></a>Ключевые термины и компоненты

Следующие компоненты Windows играют ключевую роль в запросе и использовании ГВП:

* **Поставщик облачной аутентификации** (CloudAP): CloudAP является современным поставщиком аутентификации для входа в систему Windows, который проверяет пользователей, входящих в систему с windows 10. CloudAP предоставляет плагинную платформу, которую поставщики идентификационных данных могут использовать для обеспечения аутентификации Windows с помощью учетных данных этого поставщика идентификационных данных.
* **Менеджер веб-счета** (WAM): WAM является брокером маркеров по умолчанию на устройствах Windows 10. WAM также предоставляет плагин, который поставщики идентификационных данных могут развивать и включать SSO в свои приложения, опираясь на этого поставщика идентификационных данных.
* **Плагин Azure AD CloudAP:** специальный плагин Azure AD, встроенный в платформу CloudAP, который проверяет учетные данные пользователей с помощью Azure AD во время вхвнутри Windows.
* **Плагин Azure AD WAM:** специальный плагин Azure AD, встроенный в платформу WAM, который позволяет SSO использовать приложения, которые полагаются на Azure AD для проверки подлинности.
* **Dsreg**: Специфический компонент Azure AD в Windows 10, который обрабатывает процесс регистрации устройства для всех состояний устройств.
* **Доверенный модуль платформы** (TPM): TPM — это аппаратный компонент, встроенный в устройство, который обеспечивает аппаратные функции безопасности для секретов пользователей и устройств. Более подробную информацию можно найти в статье [Trusted Platform Модуль Технологии Обзор](/windows/security/information-protection/tpm/trusted-platform-module-overview).

## <a name="what-does-the-prt-contain"></a>Что содержит ГВП?

PRT содержит утверждения, обычно содержащиеся в любом маркере обновления Azure AD. Кроме того, в ГВП включены некоторые претензии, связанные с конкретными устройствами. Вот они:

* **Идентификатор устройства:** PRT выдается пользователю на определенном устройстве. Претензия `deviceID` идентификатора устройства определяет устройство, на котором был выдан PRT пользователю. Позднее эта претензия выдается токенам, полученным через ГВП. Претензия идентификатора устройства используется для определения авторизации для условного доступа на основе состояния устройства или соответствия.
* **Ключ сеанса**: Ключ сеанса представляет собой зашифрованный симметричный ключ, генерируемый службой аутентификации Azure AD, выданным в рамках PRT. Ключ сеанса служит доказательством владения, когда PRT используется для получения токенов для других приложений.

### <a name="can-i-see-whats-in-a-prt"></a>Могу ли я увидеть, что в ГВП?

PRT — это непрозрачная капля, отправленная из Azure AD, содержимое которой не известно ни одной клиентской составляющей. Вы не можете видеть то, что находится внутри ГВП.

## <a name="how-is-a-prt-issued"></a>Как издается ГВП?

Регистрация устройств является необходимым условием для проверки подлинности устройств в Azure AD. PRT выдается пользователям только на зарегистрированных устройствах. Для получения более подробной информации о [Windows Hello for Business and Device Registration](/windows/security/identity-protection/hello-for-business/hello-how-it-works-device-registration)регистрации устройств, см. Во время регистрации устройства компонент dsreg генерирует два набора криптографических ключевых пар:

* Ключ от устройства (dkpub/dkpriv)
* Транспортный ключ (tkpub/tkpriv)

Частные ключи привязаны к TPM устройства, если устройство имеет действительный и функционирующий TPM, в то время как общедоступные ключи отправляются в Azure AD во время процесса регистрации устройства. Эти ключи используются для проверки состояния устройства во время запросов PRT.

PRT выдается во время проверки подлинности пользователя на устройстве Windows 10 в двух сценариях:

* **Azure AD присоединился** или **гибрид Azure AD присоединился:** PRT выдается во время входа Windows, когда пользователь входит в свои учетные данные организации. PRT выдается со всеми учетными данными, поддерживаемыми Windows 10, например, паролем и Windows Hello for Business. В этом сценарии плагин Azure AD CloudAP является основным органом для ГВП.
* **Зарегистрированное устройство Azure AD:** PRT выдается, когда пользователь добавляет вторичную рабочую учетную запись на свое устройство Windows 10. Пользователи могут добавить учетную запись в Windows 10 двумя различными способами -  
   * Добавление учетной записи через **эту учетную запись во всем мире на этом устройстве** запрос после вступления в приложение (например, Outlook)
   * Добавление учетной записи из **"Настройки** > **учетных записей"** > **Access Work или School** > **Connect**

В сценариях зарегистрированных устройств Azure AD плагин Azure AD WAM является основным органом для PRT, так как журнал Windows не работает с этой учетной записью Azure AD.

> [!NOTE]
> Поставщики идентификационных данных третьих сторон должны поддерживать протокол WS-Trust, чтобы обеспечить выдачу PRT на устройствах Windows 10. Без WS-Trust PRT не может быть выдана пользователям на гибридных AD Azure или устройствах, присоединившихся к Azure AD

## <a name="what-is-the-lifetime-of-a-prt"></a>Что такое срок службы ГВП?

После выдачи, PRT действителен в течение 14 дней и постоянно обновляется до тех пор, как пользователь активно использует устройство.  

## <a name="how-is-a-prt-used"></a>Как используется ГВП?

PRT используется двумя ключевыми компонентами в Windows:

* **Плагин Azure AD CloudAP:** Во время вхвнутри Windows плагин Azure AD CloudAP запрашивает PRT от Azure AD с помощью учетных данных, предоставляемых пользователем. Он также кэши ГВП, чтобы позволить кэшированный вход, когда пользователь не имеет доступа к интернет-соединению.
* **Плагин Azure AD WAM:** Когда пользователи пытаются получить доступ к приложениям, плагин Azure AD WAM использует PRT для включения SSO на Windows 10. Плагин Azure AD WAM использует PRT для запроса обновлений и доступа к токетомам для приложений, которые используют WAM для запросов токенов. Он также позволяет SSO на браузерах путем впрыскивания PRT в браузерные запросы. Браузер SSO в Windows 10 поддерживается на Microsoft Edge (родной) и Chrome (через Windows 10 Счета или Office Online расширение).

## <a name="how-is-a-prt-renewed"></a>Как продлевается ГВП?

ГВП обновляется двумя различными методами:

* **Плагин Azure AD CloudAP каждые 4 часа:** плагин CloudAP обновляет PRT каждые 4 часа во время вхвнутри Windows. Если пользователь не имеет подключения к Интернету в течение этого времени, плагин CloudAP будет обновлять PRT после того, как устройство подключено к Интернету.
* **Плагин Azure AD WAM во время запросов маркеров приложений:** плагин WAM позволяет SSO на устройствах Windows 10, позволяя бесшумные запросы на токены для приложений. Плагин WAM может обновлять PRT во время этих запросов токенов двумя различными способами:
   * Приложение запрашивает WAM для токена доступа, но для этого приложения нет маркера обновления. В этом случае WAM использует PRT, чтобы запросить токен для приложения и получает обратно новый PRT в ответ.
   * Приложение запрашивает WAM для токена доступа, но PRT является недействительным или Azure AD требует дополнительной авторизации (например, Azure Multi-Factor Authentication). В этом случае WAM инициирует интерактивный logon, требующий от пользователя повторной проверки или предоставления дополнительной проверки, и на успешной аутентификации выдается новый PRT.

### <a name="key-considerations"></a>Основные рекомендации

* PRT выдается и обновляется только во время проверки подлинности нативного приложения. PRT не продлевается и не выдается во время сеанса браузера.
* В Azure AD, объединенных и гибридных устройствах Azure AD, плагин CloudAP является основным органом для PRT. Если PRT обновляется во время запроса токенов на основе WAM, PRT отправляется обратно в плагин CloudAP, который проверяет действительность PRT с Azure AD, прежде чем принять его.

## <a name="how-is-the-prt-protected"></a>Как защищена ГВП?

PRT защищен, привязывая его к устройству, в которое подписался пользователь. Azure AD и Windows 10 обеспечивают защиту ГВП следующими методами:

* **Во время первого вхостана в**: Во время первого вхоложена, PRT выдается путем подписывать запросы используя ключ устройства cryptographically произведенный во время зарегистрирования устройства. На устройстве с действительным и функционирующим TPM ключ устройства защищен TPM, предотвращающим вредоносный доступ. PRT не выдается, если соответствующая подпись ключа устройства не может быть проверена.
* **Во время запросов и обновления токенов:** При выдаче PRT Azure AD также выдает зашифрованный ключ сеанса к устройству. Он шифруется с помощью ключа общественного транспорта (tkpub), сгенерированного и отправленного в Azure AD в рамках регистрации устройства. Этот ключ сеанса может быть расшифрочен только с помощью ключа частного транспорта (tkpriv), защищенного TPM. Ключом сеанса является ключ Proof-of-Possession (POP) для любых запросов, отправленных в Azure AD.  Ключ сеанса также защищен TPM, и ни один другой компонент ОС не может получить к нему доступ. Запросы токенов или запросы на продление ГВП надежно подписываются этим ключом сеанса через TPM и, следовательно, не могут быть изменены. Azure AD аннулирует любые запросы от устройства, которые не подписаны соответствующим ключом сеанса.

Закрепив эти ключи с помощью TPM, злоумышленники не могут украсть ключи или воспроизвести ГВП в другом месте, так как TPM недоступен, даже если злоумышленник имеет физическое владение устройством.  Таким образом, использование TPM значительно повышает безопасность присоединения Azure AD, гибридного Azure AD к ним и зарегистрированных Azure AD устройств против кражи учетных данных. Для производительности и надежности TPM 2.0 является рекомендуемой версией для всех сценариев регистрации устройств Azure AD на Windows 10.

### <a name="how-are-app-tokens-and-browser-cookies-protected"></a>Как защищены токены приложений и файлов cookie браузера?

**Токены приложений:** Когда приложение запрашивает токен через WAM, Azure AD выдает токен обновления и токен доступа. Тем не менее, WAM возвращает токен доступа в приложение и защищает маркер обновления в своем кэше, шифруя его с помощью интерфейса программирования приложения защиты данных пользователя (DPAPI). WAM надежно использует маркер обновления, подписывая запросы с ключом сеанса для выпуска токенов дополнительного доступа. Ключ DPAPI защищен симметричным ключом azure AD в самом Azure AD. Когда устройству необходимо расшифровать профиль пользователя с помощью ключа DPAPI, Azure AD предоставляет ключ DPAPI, зашифрованный ключом сеанса, который плагин CloudAP просит TPM расшифровать. Эта функциональность обеспечивает согласованность в обеспечении защиты маркеров обновления и позволяет избежать реализации приложений для собственных механизмов защиты.  

**Браузер ныезаписи**: В Windows 10 Azure AD поддерживает браузер SSO в Internet Explorer и Microsoft Edge на родине или в Google Chrome через расширение учетных записей Windows 10. Безопасность создана не только для защиты файлов cookie, но и конечных точек, на которые отправляются файлы cookie. Файлы cookie браузера защищены так же, как И PRT, используя ключ сеанса для подписания и защиты файлов cookie.

Когда пользователь инициирует взаимодействие браузера, браузер (или расширение) вызывает ухозяина клиента COM. Хозяин родного клиента гарантирует, что страница находится в одном из разрешенных доменов. Браузер может отправлять другие параметры на родной ухозяин клиента, в том числе nonce, однако родной клиент хост гарантирует проверку хоста. Хозяин родного клиента запрашивает PRT-cookie от плагина CloudAP, который создает и подписывает его с tPM-защищенным ключом сессии. Поскольку PRT-cookie подписан ключом сеанса, его нельзя подделать. Это правило PRT включено в заголовок запроса для Azure AD для проверки устройства, с которого оно исходит. При использовании браузера Chrome только расширение, явно определенное в манифесте родного клиента, может вызывать его, предотвращая произвольные расширения от этих запросов. Как только Azure AD проверяет файлы cookie PRT, он выдает cookie-файлы сеанса браузеру. В этом файле также содержится тот же ключ сеанса, выпущенный с помощью PRT. Во время последующих запросов ключ сеанса проверяется, эффективно связывая файлы cookie с устройством и предотвращая повторы из других стран.

## <a name="when-does-a-prt-get-an-mfa-claim"></a>Когда ГВП получить претензии МИД?

В конкретных сценариях ГВП может получить многофакторную проверку подлинности (MFA). Когда PRT, базирующийся в МИД, используется для запроса токенов для приложений, претензия МИД передается этим токенам приложения. Эта функциональность обеспечивает бесшовный опыт для пользователей, предотвращая mFA вызов для каждого приложения, которое требует его. ГВП может получить претензию МИД следующим образом:

* **Вопийте с Windows Hello for Business:** Windows Hello for Business заменяет пароли и использует криптографические ключи для обеспечения сильной двухфакторной аутентификации. Windows Hello for Business специфична для пользователя на устройстве, а сама требует, чтобы МИД предусмотрел. Когда пользователь входит в систему с Windows Hello for Business, ГВП пользователя получает претензию МИД. Этот сценарий также применяется к пользователям, входящих в систему с помощью смарт-карт, если аутентификация смарт-карты производит претензию МИД от ADFS.
   * Поскольку Windows Hello for Business считается многофакторной аутентификацией, претензия МИД обновляется, когда сама ГВП обновляется, поэтому продолжительность МИД будет постоянно расширяться, когда пользователи входят в wIndows Hello for Business
* **МИД во время интерактивного вхлечения WAM :** Во время запроса токенов через WAM, если пользователь обязан сделать МИД для доступа к приложению, PRT, который обновляется во время этого взаимодействия, запечатлен с претензией МИД.
   * В этом случае претензия МИД не обновляется непрерывно, поэтому продолжительность срока службы МИД основывается на сроке службы, установленной в каталоге.
   * Когда предыдущие существующие ГВП и RT используются для доступа к приложению, PRT и RT будут рассматриваться как первое доказательство аутентификации. Новый AT будет необходимо со вторым доказательством и запечатленной претензии МИД. Это также выпустит новый ГВП и RT.
* **МИД во время регистрации устройства**: Если админ настроил настройки своего устройства в Azure AD, чтобы [потребовать от МИД регистрации устройств,](device-management-azure-portal.md#configure-device-settings)пользователю необходимо сделать МИД для завершения регистрации. В ходе этого процесса, PRT, который выдается пользователю имеет МИД претензии, полученные в ходе регистрации. Эта возможность применяется только к пользователю, который сделал операцию соединения, а не к другим пользователям, которые вписываются на это устройство.
   * Как и в интерактивном входе WAM, претензия МИД не обновляется непрерывно, поэтому продолжительность срока службы МИД основана на продолжительности жизни, установленной в каталоге.

Windows 10 поддерживает разделенный список ГВП для каждого учетных данных. Таким образом, есть PRT для каждого из Windows Hello для бизнеса, пароль, или смарт-карты. Этот раздел гарантирует, что претензии МИД изолированы на основе используемых учетных данных, а не смешиваются во время запросов токенов.

## <a name="how-is-a-prt-invalidated"></a>Как ГВП признана недействительной?

ГВП недействительна в следующих сценариях:

* **Недействительный пользователь:** Если пользователь удален или отключен в Azure AD, его ГВП не действителен и не может использоваться для получения токенов для приложений. Если удаленный или отключенный пользователь уже вписался в устройство раньше, кэшированный вход в систему введет его в систему до тех пор, пока CloudAP не узнает об их недействительном состоянии. Как только CloudAP определяет, что пользователь недействителен, он блокирует последующие логины. Недействительный пользователь автоматически блокируется от ввоза на новые устройства, которые не имеют свои учетные данные кэшированы.
* **Недействительное устройство**: Если устройство удалено или отключено в Azure AD, ГВП, полученный на этом устройстве, является недействительным и не может использоваться для получения токенов для других приложений. Если пользователь уже вписался в недействительное устройство, он может продолжать это делать. Но все токены на устройстве недействительно, и пользователь не имеет SSO на любые ресурсы с этого устройства.
* **Изменение пароля**: После того, как пользователь меняет свой пароль, PRT, полученный с предыдущим паролем, аннулируется Azure AD. Изменение пароля приводит к получению пользователем новой PRT. Это недействительность может произойти двумя различными способами:
   * Если пользователь впишется в Windows со своим новым паролем, CloudAP отбрасывает старый PRT и просит Azure AD выпустить новый PRT с новым паролем. Если у пользователя нет подключения к Интернету, новый пароль не может быть проверен, Windows может потребовать от пользователя ввести свой старый пароль.
   * Если пользователь вошел в систему со своим старым паролем или изменил свой пароль после входа в Windows, старый PRT используется для любых запросов токенов на основе WAM. В этом случае пользователю предлагается повторно провести повторную аутентификацию во время запроса токенов WAM и выдать новый PRT.
* **Проблемы TPM**: Иногда TPM устройства может колебаться или выйти из строя, что приводит к недоступности ключей, защищенных TPM. В этом случае устройство не в состоянии получить PRT или запрашивать токены с помощью существующего ГВП, поскольку оно не может доказать обладание криптографическими ключами. В результате любой существующий ГВП аннулируется Azure AD. Когда Windows 10 обнаруживает сбой, она инициирует поток восстановления для перерегистрации устройства с новыми криптографическими ключами. При соединении Hybrid Azure Ad, как и при первоначальной регистрации, восстановление происходит без пользовательского ввода. Для устройств, зарегистрированных на Azure AD или Azure AD, восстановление должно быть выполнено пользователем, имеющим привилегии администратора на устройстве. В этом случае поток восстановления инициируется с помощью запроса Windows, который направляет пользователя к успешному восстановлению устройства.

## <a name="detailed-flows"></a>Подробные потоки

Следующие диаграммы иллюстрируют основные детали при выпуске, обновлении и использовании ГВП для запроса токена доступа для приложения. Кроме того, в этих шагах также описывается, как в этих взаимодействиях применяются вышеупомянутые механизмы безопасности.

### <a name="prt-issuance-during-first-sign-in"></a>Выдача ГВП во время первого вхливки

![Выдача ГВП при первом же знаке в детальном потоке](./media/concept-primary-refresh-token/prt-initial-sign-in.png)

> [!NOTE]
> В устройствах, объединенных совместно Azure AD, этот обмен происходит синхронно, чтобы выпустить PRT, прежде чем пользователь сможет войти в Windows. В гибридных устройствах, объединенных Azure AD, основным органом является on-premises Active Directory. Таким образом, пользователь только ждет, пока они могут приобрести TGT для входа, в то время как выдача PRT происходит асинхронно. Этот сценарий не применяется к зарегистрированным устройствам Azure AD, поскольку журнал не использует учетные данные Azure AD.

| Шаг | Описание |
| :---: | --- |
| Объект | Пользователь вводит свой пароль в знак в пользовательском интерфейсе. LogonUI передает учетные данные в буфере auth в LSA, который в поворотах передает их внутренне в CloudAP. CloudAP перенаправляет этот запрос на плагин CloudAP. |
| B | Плагин CloudAP инициирует запрос на обнаружение области для идентификации поставщика идентификационных данных пользователя. Если у клиента пользователя есть настройка поставщика федерации, Azure AD возвращает конечную точку метаданных биржи федерации (MEX). В противном случае Azure AD возвращает управление пользователя, указывая на то, что пользователь может проверить подлинность с помощью Azure AD. |
| C | Если пользователь управляется, CloudAP получит nonce от Azure AD. Если пользователь является федеративным, плагин CloudAP запрашивает токен SAML у поставщика услуг федерации с учетными данными пользователя. Как только он получает токен SAML, он запрашивает nonce от Azure AD. |
| D | Плагин CloudAP конструирует запрос на аутентификацию с помощью учетных данных пользователя, nonce и области брокера, подписывает запрос ключом устройства (dkpriv) и отправляет его в Azure AD. В федеративной среде плагин CloudAP использует токен SAML, возвращенный поставщиком федерации, вместо учетных данных пользователя. |
| E | Azure AD проверяет учетные данные пользователей, nonce и подпись устройства, проверяет, что устройство действительно в арендаторе и выдает зашифрованный PRT. Наряду с PRT Azure AD также выпускает симметричный ключ, называемый ключом сеанса, зашифрованным Azure AD с помощью ключа Transport (tkpub). Кроме того, ключ сессии также встроен в PRT. Эта сессия является ключом к доказательству владения (PoP) для последующих запросов с ГВП. |
| F | Плагин CloudAP передает зашифрованный ключ от PRT и session в CloudAP. CloudAP просит TPM расшифровать ключ сеанса с помощью ключа Transport (tkpriv) и повторно зашифровать его с помощью собственного ключа TPM. CloudAP хранит зашифрованный ключ сессии в своем кэше вместе с PRT. |

### <a name="prt-renewal-in-subsequent-logons"></a>Обновление ГВП в последующих логонах

![Обновление ГВП в последующих логонах](./media/concept-primary-refresh-token/prt-renewal-subsequent-logons.png)

| Шаг | Описание |
| :---: | --- |
| Объект | Пользователь вводит свой пароль в знак в пользовательском интерфейсе. LogonUI передает учетные данные в буфере auth в LSA, который в поворотах передает их внутренне в CloudAP. CloudAP перенаправляет этот запрос на плагин CloudAP. |
| B | Если пользователь ранее вошел в систему к пользователю, Windows инициирует кэшированный вход и проверяет учетные данные для входа пользователя в систему. Каждые 4 часа плагин CloudAP асинхронно инициирует обновление PRT. |
| C | Плагин CloudAP инициирует запрос на обнаружение области для идентификации поставщика идентификационных данных пользователя. Если у клиента пользователя есть настройка поставщика федерации, Azure AD возвращает конечную точку метаданных биржи федерации (MEX). В противном случае Azure AD возвращает управление пользователя, указывая на то, что пользователь может проверить подлинность с помощью Azure AD. |
| D | Если пользователь является федеративным, плагин CloudAP запрашивает токен SAML у поставщика услуг федерации с учетными данными пользователя. Как только он получает токен SAML, он запрашивает nonce от Azure AD. Если пользователь управляется, CloudAP получит nonce от Azure AD. |
| E | Плагин CloudAP конструирует запрос на аутентификацию с помощью учетных данных пользователя, nonce и существующего PRT, подписывает запрос ключом сеанса и отправляет его в Azure AD. В федеративной среде плагин CloudAP использует токен SAML, возвращенный поставщиком федерации, вместо учетных данных пользователя. |
| F | Azure AD проверяет ключевую подпись сеанса, сравнивая ее с ключом сеанса, встроенным в ГВП, проверяет nonce и проверяет, что устройство действительно в арендаторе и выдает новую ГВП. Как видно ранее, ГВП снова сопровождается ключом сессии, зашифрованным транспортным ключом (tkpub). |
| G. | Плагин CloudAP передает зашифрованный ключ от PRT и session в CloudAP. CloudAP просит TPM расшифровать ключ сеанса с помощью ключа Transport (tkpriv) и повторно зашифровать его с помощью собственного ключа TPM. CloudAP хранит зашифрованный ключ сессии в своем кэше вместе с PRT. |

### <a name="prt-usage-during-app-token-requests"></a>Использование PRT во время запросов токенов приложений

![Использование PRT во время запросов токенов приложений](./media/concept-primary-refresh-token/prt-usage-app-token-requests.png)

| Шаг | Описание |
| :---: | --- |
| Объект | Приложение (например, Outlook, OneNote и т.д.) инициирует запрос маркера на WAM. WAM, в свою очередь, просит плагин Azure AD WAM обслуживать запрос маркера. |
| B | Если токен Refresh для приложения уже доступен, плагин Azure AD WAM использует его для запроса токена доступа. Чтобы предоставить подтверждение привязки устройства, плагин WAM подписывает запрос ключом Session. Azure AD проверяет ключ сеанса и выдает токен доступа и новый маркер обновления для приложения, зашифрованный ключом сеанса. Плагин WAM запрашивает плагин Cloud AP для расшифровки токенов, который, в свою очередь, просит TPM расшифровать с помощью ключа Session, в результате чего плагин WAM получает оба токена. Далее плагин WAM предоставляет только токен доступа к приложению, в то время как он повторно шифрует маркер обновления с DPAPI и хранит его в своем собственном кэше  |
| C |  Если токен Refresh для приложения недоступен, плагин Azure AD WAM использует PRT для запроса токена доступа. Чтобы предоставить доказательство владения, WAM плагин подписывает запрос, содержащий PRT с ключом сессии. Azure AD проверяет ключевую подпись сеанса, сравнивая ее с ключом сеанса, встроенным в ГВП, проверяет, что устройство является действительным, и выдает токен доступа и маркер обновления для приложения. кроме того, Azure AD может выпустить новый PRT (на основе цикла обновления), все они зашифрованы ключом сеанса. |
| D | Плагин WAM запрашивает плагин Cloud AP для расшифровки токенов, который, в свою очередь, просит TPM расшифровать с помощью ключа Session, в результате чего плагин WAM получает оба токена. Далее плагин WAM предоставляет только токен доступа к приложению, в то время как он повторно шифрует маркер обновления с DPAPI и хранит его в собственном кэше. WAM плагин будет использовать маркер обновления идти вперед для этого приложения. Плагин WAM также возвращает новый ПЛАГин Cloud AP, который проверяет PRT с помощью Azure AD перед обновлением в собственном кэше. Облачный плагин AP будет использовать новый PRT в будущем. |
| E | WAM предоставляет недавно выданный токен доступа к WAM, который, в свою очередь, предоставляет его обратно в вызываемый|

### <a name="browser-sso-using-prt"></a>Браузер SSO с использованием PRT

![Браузер SSO с использованием PRT](./media/concept-primary-refresh-token/browser-sso-using-prt.png)

| Шаг | Описание |
| :---: | --- |
| Объект | Пользователь входит в Windows с их учетными данными, чтобы получить PRT. Как только пользователь открывает браузер, браузер (или расширение) загружает URL-адреса из реестра. |
| B | Когда пользователь открывает URL-адрес входа ВС АДУ Azure AD, браузер или расширение проверяет URL-адрес с теми, которые получены из реестра. Если они совпадают, браузер вызывает у себя узла клиента для получения токена. |
| C | Хозяин родного клиента подтверждает, что URL-адреса принадлежат поставщикам идентификационных данных Майкрософт (учетная запись Microsoft или Azure AD), извлекает nonce, отправленный из URL-адреса, и делает звонок в плагин CloudAP, чтобы получить файл-куки PRT. |
| D | Плагин CloudAP создаст файл-кикс PRT, впишется в ключ сеанса, привязанный к TPM, и отправит его обратно на устус клиента. Поскольку файл cookie подписан ключом сеанса, его нельзя подделать. |
| E | Хозяин родного клиента вернет это файл-cookie PRT в браузер, который будет включать его в качестве части заголовка запроса x-ms-RefreshTokenCredential и запрашивает токены из Azure AD. |
| F | Azure AD проверяет ключевую подпись сеанса на файле-шикарном ГВП, проверяет nonce, проверяет, что устройство действительно в арендаторе, и выдает маркер идентификатора для веб-страницы и зашифрованное cookie-сессию для браузера. |

## <a name="next-steps"></a>Дальнейшие действия

Для получения дополнительной информации о проблемах, [Troubleshooting hybrid Azure Active Directory joined Windows 10 and Windows Server 2016 devices](troubleshoot-hybrid-join-windows-current.md)связанных с устранением неполадок, см.
