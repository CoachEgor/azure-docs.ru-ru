---
title: Основной маркер обновления (PRT) и Azure AD — Azure Active Directory
description: Какова роль и как управлять основным маркером обновления (PRT) в Azure Active Directory?
services: active-directory
ms.service: active-directory
ms.subservice: devices
ms.topic: conceptual
ms.date: 05/29/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: ravenn
ms.collection: M365-identity-device-management
ms.openlocfilehash: 7b9240b863eef4d460cd8d3a47304fb96ffb4bc8
ms.sourcegitcommit: 3c925b84b5144f3be0a9cd3256d0886df9fa9dc0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/28/2020
ms.locfileid: "77917787"
---
# <a name="what-is-a-primary-refresh-token"></a>Что такое основной маркер обновления?

Основной маркер обновления (PRT) является ключевым артефактом проверки подлинности Azure AD на устройствах с Windows 10, iOS и Android. Это JSON Web Token (JWT), специально выданный для брокеров токенов Майкрософт, чтобы обеспечить единый вход (SSO) между приложениями, используемыми на этих устройствах. В этой статье мы предложим сведения о том, как PRT, используется и защищен на устройствах Windows 10.

В этой статье предполагается, что вы уже знакомы с различными состояниями устройств, доступными в Azure AD, и как работает единый вход в Windows 10. Дополнительные сведения об устройствах в Azure AD см. в статье [что такое управление устройствами в Azure Active Directory?](overview.md)

## <a name="key-terminology-and-components"></a>Ключевая терминология и компоненты

Следующие компоненты Windows играют ключевую роль в запросе и использовании PRT:

* **Поставщик проверки подлинности Cloud** (клаудап): клаудап — это современный поставщик проверки подлинности для входа в Windows, который проверяет, вошли ли пользователи на устройство Windows 10. Клаудап предоставляет инфраструктуру подключаемых модулей, на основе которой поставщики удостоверений могут выполнять проверку подлинности в Windows с использованием учетных данных этого поставщика удостоверений.
* **Диспетчер учетных записей Web** (WAM): WAM — это брокер маркеров по умолчанию на устройствах Windows 10. WAM также предоставляет инфраструктуру подключаемых модулей, на основе которой поставщики удостоверений могут создавать и включать единый вход для своих приложений, использующих этот поставщик удостоверений.
* **Подключаемый модуль Azure AD клаудап**. Специальный подключаемый модуль Azure AD, созданный на платформе клаудап, который проверяет учетные данные пользователя в Azure AD во время входа в Windows.
* **Подключаемый модуль Azure AD WAM**. Специальный подключаемый модуль Azure AD, созданный на платформе WAM Framework, который обеспечивает единый вход для приложений, которые используют Azure AD для проверки подлинности.
* **Дсрег**. Специальный компонент Azure AD в Windows 10, который обрабатывает процесс регистрации устройств для всех состояний устройств.
* **Доверенный платформенный модуль (TPM)** (TPM). доверенный платформенный модуль — это компонент оборудования, встроенный в устройство, обеспечивающий функции безопасности на основе оборудования для секретов пользователей и устройств. Дополнительные сведения можно найти в статье [Обзор технологий доверенный платформенный модуль (TPM)](https://docs.microsoft.com/windows/security/information-protection/tpm/trusted-platform-module-overview).

## <a name="what-does-the-prt-contain"></a>Что содержит PRT?

PRT содержит утверждения, которые обычно содержатся в маркере обновления Azure AD. Кроме того, в PRT есть определенные заявки для конкретных устройств. Вот они:

* **Идентификатор устройства**: PRT выдается пользователю на определенном устройстве. Утверждение идентификатора устройства `deviceID` определяет устройство, которое было выдано пользователю PRT. Это утверждение позже выдается маркерам, полученным через PRT. Утверждение идентификатора устройства используется для определения авторизации для условного доступа на основе состояния или соответствия устройства.
* **Ключ сеанса**. ключ сеанса — это зашифрованный симметричный ключ, созданный службой проверки подлинности Azure AD, выданный в составе PRT. Ключ сеанса выступает в качестве подтверждения принадлежности, когда PRT используется для получения маркеров для других приложений.

### <a name="can-i-see-whats-in-a-prt"></a>Можно ли увидеть, что находится в PRT?

PRT — это непрозрачный большой двоичный объект, отправленный из Azure AD, содержимое которого неизвестно ни одному из клиентских компонентов. Вы не видите, что находится внутри PRT.

## <a name="how-is-a-prt-issued"></a>Как выдается PRT?

Регистрация устройств является необходимым условием для проверки подлинности на основе устройств в Azure AD. PRT выдается пользователям только на зарегистрированных устройствах. Более подробные сведения о регистрации устройств см. в статье [Windows Hello для бизнеса и регистрация устройств](https://docs.microsoft.com/windows/security/identity-protection/hello-for-business/hello-how-it-works-device-registration). Во время регистрации устройства компонент дсрег создает два набора пар криптографических ключей:

* Ключ устройства (дкпуб/дкприв)
* Ключ транспорта (ткпуб/ткприв)

Закрытые ключи привязываются к доверенному платформенному модулю устройства, если устройство имеет действительный и работоспособный доверенный платформенный модуль, а открытые ключи отправляются в Azure AD во время процесса регистрации устройства. Эти ключи используются для проверки состояния устройства во время запросов PRT.

PRT выдается во время проверки подлинности пользователя на устройстве Windows 10 в двух сценариях:

* Присоединение **к Azure AD** или **гибридное подключение к Azure AD**. при входе пользователя в систему с УЧЕТными данными Организации PRT выдается во время входа в Windows. PRT выдается со всеми поддерживаемыми учетными данными Windows 10, например Password и Windows Hello для бизнеса. В этом сценарии подключаемый модуль Azure AD Клаудап является основным центром для PRT.
* **Зарегистрированное устройство Azure AD**. PRT выдается, когда пользователь добавляет дополнительную рабочую учетную запись на устройство Windows 10. Пользователи могут добавить учетную запись в Windows 10 двумя разными способами.  
   * Добавление учетной записи с помощью **этой учетной записи везде в этом устройстве** после входа в приложение (например, Outlook)
   * Добавление учетной записи из **параметров** > **учетных записей** > **доступа к рабочей или учебной** > **Подключение**

В сценариях зарегистрированных устройств Azure AD подключаемый модуль Azure AD WAM является основным центром для PRT, так как вход в систему Windows не происходит с этой учетной записью Azure AD.

> [!NOTE]
> сторонние поставщики удостоверений должны поддерживать протокол WS-Trust, чтобы включить выдачу PRT на устройствах Windows 10. Без WS-Trust PRT не может выдаваться пользователям на гибридных присоединенных Azure AD или устройствах, присоединенных к Azure AD.

## <a name="what-is-the-lifetime-of-a-prt"></a>Каково время существования PRT?

После выпуска PRT действителен в течение 14 дней и постоянно обновляется при условии, что пользователь активно использует устройство.  

## <a name="how-is-a-prt-used"></a>Как используется PRT?

PRT используется двумя ключевыми компонентами Windows:

* **Подключаемый модуль Azure AD клаудап**. во время входа в систему подключаемый модуль Azure AD клаудап запрашивает PRT из Azure AD, используя учетные данные, предоставленные пользователем. Кроме того, он кэширует PRT, чтобы включить кэшированный вход, когда у пользователя нет доступа к подключению к Интернету.
* **Подключаемый модуль Azure AD WAM**. когда пользователи пытаются получить доступ к приложениям, подключаемый модуль Azure AD WAM использует PRT для включения единого входа в Windows 10. Подключаемый модуль Azure AD WAM использует PRT для запроса маркеров обновления и доступа для приложений, которые используют WAM для запросов маркеров. Он также позволяет выполнять единый вход в браузерах, внедряя PRT в запросы браузера. Единый вход браузера в Windows 10 поддерживается в Microsoft (изначально) и Chrome (с помощью учетных записей Windows 10 или расширения Office Online).

## <a name="how-is-a-prt-renewed"></a>Как PRT продление?

PRT обновляется двумя разными методами:

* **Подключаемый модуль Azure AD клаудап каждые 4 часа**: подключаемый модуль КЛАУДАП обновляет PRT каждые 4 часа во время входа Windows. Если у пользователя нет подключения к Интернету в течение этого времени, подключаемый модуль Клаудап обновит PRT после подключения устройства к Интернету.
* **Подключаемый модуль WAM для Azure AD во время запросов маркера приложения**. подключаемый модуль WAM позволяет выполнять единый вход на устройствах Windows 10, включив автоматическую запросы маркеров для приложений. Подключаемый модуль WAM может продлить PRT во время запросов маркеров двумя разными способами:
   * Приложение запрашивает WAM для маркера доступа автоматически, но для этого приложения нет доступного маркера обновления. В этом случае WAM использует PRT для запроса маркера для приложения и возвращает новый PRT в ответе.
   * Приложение запрашивает WAM для маркера доступа, но PRT является недопустимым или для Azure AD требуется дополнительная авторизация (например, многофакторная идентификация Azure). В этом сценарии WAM инициирует интерактивный вход в систему, в котором пользователь должен выполнить повторную проверку подлинности или предоставить дополнительную проверку, а в случае успешной проверки подлинности будет выдана новая PRT.

### <a name="key-considerations"></a>Основные рекомендации

* PRT выдается и обновляется только во время проверки подлинности в собственном приложении. PRT не обновляется или не выдается во время сеанса браузера.
* В присоединенных к Azure AD и гибридных устройствах, присоединенных к Azure AD, подключаемый модуль Клаудап является основным центром для PRT. Если PRT обновляется во время запроса маркера на основе WAM, PRT отправляется обратно в подключаемый модуль Клаудап, который проверяет допустимость PRT в Azure AD перед его принятием.

## <a name="how-is-the-prt-protected"></a>Как PRT защищен?

PRT защищается с помощью привязки к устройству, в котором пользователь выполнил вход. Azure AD и Windows 10 включают защиту PRT с помощью следующих методов:

* **При первом входе в систему**: во время первого входа в систему PRT выдает запросы на подписывание, используя ключ устройства, криптографически формируемый во время регистрации устройства. На устройстве с допустимым и работающим TPM ключ устройства защищен доверенным платформенным модулем, предотвращая любой вредоносный доступ. PRT не выдается, если не удается проверить соответствующую сигнатуру ключа устройства.
* При **запросах маркера и продлении**: при выдаче PRT Azure AD также выдает устройству зашифрованный ключ сеанса. Он шифруется с помощью открытого ключа транспорта (ткпуб), который создается и отправляется в Azure AD в рамках регистрации устройства. Этот ключ сеанса может быть расшифрован только закрытым ключом транспорта (ткприв), защищенным доверенным платформенным модулем. Ключ сеанса — это ключ подтверждения принадлежности (POP) для любых запросов, отправленных в Azure AD.  Ключ сеанса также защищается доверенным платформенным модулем, а другие компоненты ОС не могут получить к нему доступ. Запросы маркеров или обновления PRT безопасно подписываются этим ключом сеанса через доверенный платформенный модуль, поэтому его нельзя подделать незаконным образом. Azure AD сделает недействительными все запросы устройства, которые не подписаны соответствующим ключом сеанса.

Обеспечивая защиту этих ключей с помощью доверенного платформенного модуля, вредоносные субъекты не смогут украсть ключи и воспроизвести PRT в других местах, так как доверенный платформенный модуль недоступен, даже если злоумышленник физически владеет устройством.  Поэтому использование TPM значительно расширяет безопасность присоединенных к Azure AD, гибридных присоединенных к Azure AD и устройств, зарегистрированных в Azure AD, для кражи учетных данных. Для повышения производительности и надежности TPM 2,0 является рекомендуемой версией для всех сценариев регистрации устройств Azure AD в Windows 10.

### <a name="how-are-app-tokens-and-browser-cookies-protected"></a>Как защищаются маркеры приложений и файлы cookie браузера?

**Маркеры приложений**: когда приложение запрашивает токен через WAM, Azure AD выдает маркер обновления и маркер доступа. Однако WAM возвращает только маркер доступа к приложению и защищает маркер обновления в своем кэше путем его шифрования с помощью ключа интерфейса прикладного программирования (DPAPI) защиты данных пользователя. WAM безопасно использует маркер обновления, подписывая запросы с ключом сеанса, чтобы выдать дополнительные маркеры доступа. Ключ DPAPI защищен симметричным ключом на основе Azure AD в самой Azure AD. Когда устройству требуется расшифровать профиль пользователя с помощью ключа DPAPI, Azure AD предоставляет ключ DPAPI, зашифрованный ключом сеанса, который подключаемый модуль Клаудап запрашивает для расшифровки TPM. Эта функция обеспечивает согласованность при защите маркеров обновления и позволяет избежать применения собственных механизмов защиты.  

**Файлы cookie браузера**. в Windows 10 Azure AD поддерживает единый вход браузера в Internet Explorer и Microsoft погранично в собственном режиме или в Google Chrome с помощью расширения учетных записей Windows 10. Безопасность встроена не только для защиты файлов cookie, но и для конечных точек, на которые отправляются файлы cookie. Файлы cookie браузера защищаются так же, как PRT, за счет использования ключа сеанса для подписывания и защиты файлов cookie.

Когда пользователь инициирует взаимодействие с браузером, браузер (или расширение) вызывает собственный узел клиента COM. Узел собственного клиента гарантирует, что страница находится в одном из разрешенных доменов. Браузер может отправить другие параметры на узел собственного клиента, в том числе nonce, однако сервер собственного клиента гарантирует проверку имени узла. Узел собственного клиента запрашивает файл PRT-cookie из подключаемого модуля Клаудап, который создает и подписывает его с помощью ключа сеанса, защищенного доверенным платформенным модулем. Так как файл PRT-cookie подписывается ключом сеанса, он не может быть изменен. Этот файл PRT-cookie включен в заголовок запроса Azure AD для проверки устройства, с которого оно выполняется. При использовании браузера Chrome только расширение, явно определенное в манифесте хоста собственного клиента, может вызывать его, предотвращая невыполнение этих запросов произвольными расширениями. После того как Azure AD проверит файл cookie PRT, он выдает браузеру файл cookie сеанса. Этот файл cookie сеанса также содержит тот же ключ сеанса, который был выдан PRT. Во время последующих запросов ключ сеанса проверяется с помощью эффективной привязки файла cookie к устройству и предотвращения воспроизведения из другого места.

## <a name="when-does-a-prt-get-an-mfa-claim"></a>Когда PRT получает утверждение MFA?

PRT может получить утверждение многофакторной проверки подлинности (MFA) в конкретных сценариях. Если PRT на основе MFA используется для запроса маркеров для приложений, утверждение MFA передается этим маркерам приложений. Эта функция обеспечивает бесперебойную работу пользователей, предотвращая запрос MFA для каждого приложения, которое ему требуется. PRT может получить утверждение MFA следующими способами:

* **Вход с помощью Windows Hello для бизнеса**: Windows Hello для бизнеса заменяет пароли и использует криптографические ключи для обеспечения надежной двухфакторной проверки подлинности. Windows Hello для бизнеса характерна для пользователя на устройстве, и для его инициализации требуется MFA. Когда пользователь входит в систему с помощью Windows Hello для бизнеса, PRT пользователя получает утверждение MFA. Этот сценарий также применяется к пользователям, которые могут войти в систему с помощью SmartCards, если проверка подлинности смарт-карт создает утверждение MFA из ADFS.
   * Так как Windows Hello для бизнеса считается многофакторной проверкой подлинности, утверждение MFA обновляется при обновлении самого PRT, поэтому длительность MFA будет постоянно расширяться при входе пользователей с помощью WIndows Hello для бизнеса.
* **MFA во время интерактивного входа в WAM**: во время запроса маркера через WAM, если пользователю требуется выполнить MFA для доступа к приложению, PRT, которая продлена во время этого взаимодействия, будет распечатана с утверждением mfa.
   * В этом случае утверждение MFA не обновляется непрерывно, поэтому продолжительность MFA зависит от времени существования, установленного в каталоге.
   * Если для доступа к приложению используются предыдущие существующие PRT и RT, то PRT и RT будут рассматриваться как первое подтверждение проверки подлинности. Новая возможность будет требоваться со вторым подтверждением и ненапечатанным утверждением MFA. При этом также будет выдаваться новый PRT и RT.
* **MFA во время регистрации устройства**. Если администратор настроил параметры устройства в Azure AD для [использования MFA для регистрации устройств](device-management-azure-portal.md#configure-device-settings), пользователю необходимо выполнить MFA для выполнения регистрации. Во время этого процесса PRT, выданный пользователю, имеет заявку MFA, полученную во время регистрации. Эта возможность применяется только к пользователю, который выполнил операцию присоединение, а не к другим пользователям, которые входят на это устройство.
   * Как и при интерактивном входе в WAM, утверждение MFA не обновляется непрерывно, поэтому продолжительность MFA зависит от времени существования, установленного в каталоге.

Windows 10 поддерживает секционированный список ПРТС для каждого учетного данных. Таким образом, существует PRT для каждого из Windows Hello для бизнеса, пароля или смарт-карты. Секционирование гарантирует, что утверждения MFA будут изолированы на основе учетных данных и не будут смешиваться во время запросов маркеров.

## <a name="how-is-a-prt-invalidated"></a>Как PRT становится недействительным?

PRT становится недействительным в следующих случаях:

* **Недопустимый пользователь**: Если пользователь удален или отключен в Azure AD, его PRT становится недействительным и не может быть использован для получения маркеров для приложений. Если удаленный или отключенный пользователь уже вошел на устройство раньше, в ходе кэшированного входа он войдет в систему, пока Клаудап не будет знать об их недопустимом состоянии. После того как Клаудап определит, что пользователь является недопустимым, он блокирует последующие входы в систему. Недопустимый пользователь автоматически блокирует вход на новые устройства, для которых учетные данные не кэшируются.
* **Недопустимое устройство**: Если устройство удалено или отключено в Azure AD, PRT, полученный на этом устройстве, становится недействительным и не может использоваться для получения маркеров для других приложений. Если пользователь уже вошел на недопустимое устройство, он может продолжить это действие. Но все токены на устройстве становятся недействительными, и пользователь не имеет единого входа для любых ресурсов с этого устройства.
* **Изменение пароля**. После изменения пароля пользователем PRT, полученный с предыдущим паролем, становится недействительным в Azure AD. В результате изменения пароля пользователь получает новый PRT. Такое недействительность может произойти двумя разными способами:
   * Если пользователь выполняет вход в Windows с новым паролем, Клаудап отменяет старый PRT и запрашивает у Azure AD новую PRT с новым паролем. Если у пользователя нет подключения к Интернету, новый пароль не может быть проверен, Windows может потребовать от пользователя ввести старый пароль.
   * Если пользователь вошел в систему со старым паролем или изменил свой пароль после входа в Windows, старый PRT используется для всех запросов маркеров на основе WAM. В этом сценарии пользователю предлагается выполнить повторную проверку подлинности во время запроса маркера WAM и выдается новый PRT.
* **Проблемы с TPM**. иногда доверенный платформенный модуль устройства может Фалтер или не работать, что приводит к недоступности ключей, защищенных доверенным платформенным модулем. В этом случае устройство не может получить PRT или запросить маркеры с помощью существующего PRT, так как он не может доказать владение криптографическими ключами. В результате все существующие PRTы в Azure AD станут недействительными. Когда Windows 10 обнаружит сбой, он инициирует поток восстановления для повторной регистрации устройства с новыми криптографическими ключами. При использовании гибридного присоединение к Azure AD, как и при первоначальной регистрации, восстановление происходит без вмешательства пользователя. Для присоединения к Azure AD или устройств, зарегистрированных в Azure AD, восстановление должно выполняться пользователем с правами администратора на устройстве. В этом сценарии поток восстановления инициируется запросом Windows, который позволяет пользователю успешно восстановить устройство.

## <a name="detailed-flows"></a>Подробные потоки

На следующих диаграммах показаны базовые сведения о выдаче, обновлении и использовании PRT для запроса маркера доступа для приложения. Кроме того, эти шаги также описывают, как упомянутые выше механизмы безопасности применяются во время этих взаимодействий.

### <a name="prt-issuance-during-first-sign-in"></a>Выдача PRT при первом входе

![PRT выдачи во время первого входа подробный поток](./media/concept-primary-refresh-token/prt-initial-sign-in.png)

> [!NOTE]
> В устройствах, присоединенных к Azure AD, этот обмен выполняется синхронно, чтобы выдать PRT, прежде чем пользователь сможет войти в Windows. В гибридных устройствах, присоединенных к Azure AD, локальная Active Directory является основным центром. Таким образом, пользователь ждет, пока он не сможет получить TGT для входа в систему, а выдача PRT происходит асинхронно. Этот сценарий не применяется к зарегистрированным устройствам Azure AD, так как вход не использует учетные данные Azure AD.

| Шаг | Описание |
| :---: | --- |
| А | Пользователь вводит свой пароль в пользовательском интерфейсе входа. Процесс LogonUI передает учетные данные в буфере проверки подлинности в LSA, который в своюмся образом передает его внутреннему Клаудап. Клаудап перенаправляет этот запрос в подключаемый модуль Клаудап. |
| B | Подключаемый модуль Клаудап инициирует запрос обнаружения области для идентификации поставщика удостоверений для пользователя. Если у клиента пользователя есть программа установки поставщика Федерации, Azure AD Возвращает конечную точку конечной точки обмена метаданными поставщика Федерации (MEX). В противном случае Azure AD возвращает управление пользователем, указывая, что пользователь может пройти проверку подлинности в Azure AD. |
| C | Если пользователь является управляемым, Клаудап получит nonce из Azure AD. Если пользователь является федеративным, подключаемый модуль Клаудап запрашивает маркер SAML от поставщика федерации с учетными данными пользователя. После получения маркера SAML он запрашивает nonce из Azure AD. |
| Г | Подключаемый модуль Клаудап формирует запрос проверки подлинности с использованием учетных данных пользователя, nonce и брокера, подписывает запрос с ключом устройства (дкприв) и отправляет его в Azure AD. В федеративной среде подключаемый модуль Клаудап использует токен SAML, возвращенный поставщиком Федерации, а не учетные данные пользователя. |
| Д | Azure AD проверяет учетные данные пользователя, nonce и подпись устройства, проверяет, является ли устройство допустимым в клиенте, и отправляет зашифрованные PRT. Вместе с PRT Azure AD также выдает симметричный ключ, который называется ключом сеанса, зашифрованным Azure AD, с помощью ключа транспорта (ткпуб). Кроме того, ключ сеанса также внедряется в PRT. Этот ключ сеанса выступает в качестве ключа подтверждения принадлежности (PoP) для последующих запросов с PRT. |
| C | Подключаемый модуль Клаудап передает зашифрованный PRT и ключ сеанса в Клаудап. Клаудап запрос доверенного платформенного модуля для расшифровки ключа сеанса с помощью ключа транспорта (ткприв) и его повторного шифрования с помощью собственного ключа TPM. Клаудап сохраняет зашифрованный ключ сеанса в своем кэше вместе с PRT. |

### <a name="prt-renewal-in-subsequent-logons"></a>PRT продление при последующих входах

![PRT продление при последующих входах](./media/concept-primary-refresh-token/prt-renewal-subsequent-logons.png)

| Шаг | Описание |
| :---: | --- |
| А | Пользователь вводит свой пароль в пользовательском интерфейсе входа. Процесс LogonUI передает учетные данные в буфере проверки подлинности в LSA, который в своюмся образом передает его внутреннему Клаудап. Клаудап перенаправляет этот запрос в подключаемый модуль Клаудап. |
| B | Если пользователь ранее вошел в систему пользователя, Windows инициирует кэшированный вход и проверяет учетные данные для входа пользователя в систему. Каждые 4 часа подключаемый модуль Клаудап инициирует асинхронное обновление PRT. |
| C | Подключаемый модуль Клаудап инициирует запрос обнаружения области для идентификации поставщика удостоверений для пользователя. Если у клиента пользователя есть программа установки поставщика Федерации, Azure AD Возвращает конечную точку конечной точки обмена метаданными поставщика Федерации (MEX). В противном случае Azure AD возвращает управление пользователем, указывая, что пользователь может пройти проверку подлинности в Azure AD. |
| Г | Если пользователь является федеративным, подключаемый модуль Клаудап запрашивает маркер SAML от поставщика федерации с учетными данными пользователя. После получения маркера SAML он запрашивает nonce из Azure AD. Если пользователь является управляемым, Клаудап будет напрямую получать nonce из Azure AD. |
| Д | Подключаемый модуль Клаудап формирует запрос проверки подлинности с учетными данными пользователя, nonce и существующим PRT, подписывает запрос с ключом сеанса и отправляет его в Azure AD. В федеративной среде подключаемый модуль Клаудап использует токен SAML, возвращенный поставщиком Федерации, а не учетные данные пользователя. |
| C | Azure AD проверяет сигнатуру ключа сеанса, сравнивая ее с ключом сеанса, внедренным в PRT, проверяет nonce и проверяет допустимость устройства в клиенте и выдает новый PRT. Как показано выше, PRT снова сопровождается ключом сеанса, зашифрованным ключом транспорта (ткпуб). |
| G | Подключаемый модуль Клаудап передает зашифрованный PRT и ключ сеанса в Клаудап. Клаудап запрашивает у доверенного платформенного модуля расшифровку ключа сеанса с помощью ключа транспорта (ткприв) и повторно зашифрует его с помощью собственного ключа TPM. Клаудап сохраняет зашифрованный ключ сеанса в своем кэше вместе с PRT. |

### <a name="prt-usage-during-app-token-requests"></a>Использование PRT при запросах маркера приложения

![Использование PRT при запросах маркера приложения](./media/concept-primary-refresh-token/prt-usage-app-token-requests.png)

| Шаг | Описание |
| :---: | --- |
| А | Приложение (например, Outlook, OneNote и т. д.) инициирует запрос маркера для WAM. WAM, в свою очередь, запрашивает у подключаемого модуля Azure AD WAM запрос маркера. |
| B | Если маркер обновления для приложения уже доступен, подключаемый модуль Azure AD WAM использует его для запроса маркера доступа. Чтобы обеспечить подтверждение привязки устройства, подключаемый модуль WAM подписывает запрос с ключом сеанса. Azure AD проверяет ключ сеанса и выдает маркер доступа и новый маркер обновления для приложения, зашифрованного ключом сеанса. Подключаемый модуль WAM запрашивает подключаемый модуль AP облака для расшифровки токенов, что, в свою очередь, запрашивает расшифровку TPM с помощью ключа сеанса, в результате чего подключаемый модуль WAM получает оба токена. Затем подключаемый модуль WAM предоставляет приложению только маркер доступа, в то время как он повторно шифрует маркер обновления с помощью DPAPI и сохраняет его в собственном кэше.  |
| C |  Если маркер обновления для приложения недоступен, подключаемый модуль Azure AD WAM использует PRT для запроса маркера доступа. Чтобы предоставить подтверждение владения, подключаемый модуль WAM подписывает запрос, содержащий PRT, с помощью ключа сеанса. Azure AD проверяет подпись ключа сеанса, сравнивая ее с ключом сеанса, внедренным в PRT, проверяет допустимость устройства и выдает маркер доступа и маркер обновления для приложения. Кроме того, Azure AD может выдать новый PRT (в зависимости от цикла обновления), все они шифруются ключом сеанса. |
| Г | Подключаемый модуль WAM запрашивает подключаемый модуль AP облака для расшифровки токенов, что, в свою очередь, запрашивает расшифровку TPM с помощью ключа сеанса, в результате чего подключаемый модуль WAM получает оба токена. Затем подключаемый модуль WAM предоставляет приложению только маркер доступа, в то время как он повторно шифрует маркер обновления с помощью DPAPI и сохраняет его в собственном кэше. Подключаемый модуль WAM будет использовать маркер обновления для этого приложения. Подключаемый модуль WAM также возвращает новый подключаемый модуль AP PRT к облаку, который проверяет PRT с помощью Azure AD перед обновлением в собственном кэше. Подключаемый модуль AP облака будет использовать новый PRT. |
| Д | WAM предоставляет вновь выданный маркер доступа для WAM, который, в свою очередь, предоставляет его обратно вызывающему приложению.|

### <a name="browser-sso-using-prt"></a>Единый вход браузера с помощью PRT

![Единый вход браузера с помощью PRT](./media/concept-primary-refresh-token/browser-sso-using-prt.png)

| Шаг | Описание |
| :---: | --- |
| А | Пользователь входит в Windows с помощью своих учетных данных для получения PRT. Когда пользователь открывает браузер, браузер (или расширение) загружает URL-адреса из реестра. |
| B | Когда пользователь открывает URL-адрес для входа в Azure AD, браузер или расширение проверяет URL-адрес, полученные из реестра. Если они совпадают, браузер вызывает собственный узел клиента для получения маркера. |
| C | Узел Native Client проверяет, принадлежат ли URL-адреса поставщикам удостоверений Майкрософт (учетная запись Майкрософт или Azure AD), извлекает nonce, отправленный с URL-адреса, и вызывает подключаемый модуль Клаудап для получения файла cookie PRT. |
| Г | Подключаемый модуль Клаудап создаст файл cookie PRT, выполнит вход с помощью ключа сеанса, привязанного к доверенному платформенному модулю, и отправит его обратно на узел собственного клиента. Так как файл cookie подписывается ключом сеанса, он не может быть изменен. |
| Д | Узел собственного клиента вернет этот файл cookie PRT в браузер, который будет включать его в заголовок запроса с именем x-MS-Рефрештокенкредентиал и токены запроса из Azure AD. |
| C | Azure AD проверяет подпись ключа сеанса в файле cookie PRT, проверяет значение nonce, проверяет допустимость устройства в клиенте и выдает маркер идентификатора для веб-страницы и зашифрованный сеанс cookie для браузера. |

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения об устранении неполадок, связанных с PRT, см. в статье [Устранение неполадок гибридных Azure Active Directory присоединенных к устройствам Windows 10 и Windows Server 2016](troubleshoot-hybrid-join-windows-current.md).
