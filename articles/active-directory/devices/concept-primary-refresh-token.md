---
title: Основного маркера обновления (PRT) и Azure AD — Azure Active Directory
description: Что такое роли и как управлять первичный обновления токена (PRT) в Azure Active Directory?
services: active-directory
ms.service: active-directory
ms.subservice: devices
ms.topic: conceptual
ms.date: 05/29/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: ravenn
ms.collection: M365-identity-device-management
ms.openlocfilehash: 5e195a93209875b9eabfaa2ad00772281922443c
ms.sourcegitcommit: f811238c0d732deb1f0892fe7a20a26c993bc4fc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/29/2019
ms.locfileid: "67476114"
---
# <a name="what-is-a-primary-refresh-token"></a>Что такое первичный токен обновления?

Основной обновления токена (PRT) — это артефакт ключа проверки подлинности Azure AD на устройствах Android, iOS и Windows 10. Это JSON Web Token (JWT) специально выданный Microsoft первого субъекта маркера посредников для включения единого входа (SSO) для приложений, используемых на этих устройствах. В этой статье мы предоставим сведения по как PRT выдан, использовании, а также защищены на устройствах Windows 10.

В этой статье предполагается, что вы уже знаете, состояния различных устройств доступны в Azure AD и как единый вход работает в Windows 10. Дополнительные сведения об устройствах в Azure AD, см. в статье [что такое управление устройствами в Azure Active Directory?](overview.md)

## <a name="key-terminology-and-components"></a>Основные термины и компоненты

Следующие компоненты Windows играют ключевую роль в запрашивая и используя PRT:

* **Облако поставщика проверки подлинности** (CloudAP): CloudAP является поставщиком современную проверку подлинности для Windows в систему, проверяет пользователей, ведение журнала на устройство Windows 10. CloudAP предоставляет платформу подключаемый модуль этот идентификатор, который поставщики можно создать на для включения аутентификации в Windows с использованием учетных данных этого поставщика удостоверений.
* **Диспетчер учетных записей Web** (WAM): WAM является брокер маркера по умолчанию на устройствах Windows 10. Это удостоверение, поставщики можно построить и включить единый вход в свои приложения, использующие поставщик услуг идентификации WAM также предоставляет платформу подключаемого модуля.
* **Подключаемый модуль Azure AD CloudAP**: Конкретного подключаемого модуля Azure AD на базе CloudAP framework, который проверяет учетные данные пользователя с помощью Azure AD во время входа Windows.
* **Подключаемый модуль Azure AD WAM**: Конкретного подключаемого модуля Azure AD на базе WAM framework, которое включает единый вход для приложения, использующие Azure AD для проверки подлинности.
* **Dsreg**: Указанного компонента Azure AD в Windows 10, который обрабатывает процесс регистрации устройства для всех состояний устройств.
* **Доверенный платформенный модуль** (TPM): TPM — это аппаратный компонент, встроенный в устройство, которое предоставляет функции безопасности на основе оборудования, секретные данные пользователей и устройств. Дополнительные сведения можно найти в статье [доверенные Обзор технологии платформы модуля](https://docs.microsoft.com/windows/security/information-protection/tpm/trusted-platform-module-overview).

## <a name="what-does-the-prt-contain"></a>Что содержит PRT?

PRT содержит утверждения, обычно содержащиеся в любой маркер обновления Azure AD. Кроме того существуют некоторые утверждения конкретного устройства, включенные в PRT. Вот они:

* **Идентификатор устройства**: PRT выдается пользователю на конкретном устройстве. Утверждение идентификатора устройства `deviceID` определяет PRT был выдан для пользователя на устройство. Позже это утверждение выдается маркеры, полученные через PRT. Утверждение идентификатора устройства используется для определения авторизации на основе состояния устройства или соответствия требованиям условного доступа.
* **Сеансовый ключ**: Сеансовый ключ остается зашифрованным симметричным ключом, созданным службой проверки подлинности Azure AD, как часть PRT. Сеансовый ключ служит доказательством прав обладания при PRT используется для получения маркеров для других приложений.

### <a name="can-i-see-whats-in-a-prt"></a>Можно ли узнать, что такое в PRT?

PRT является большой двоичный объект непрозрачным, отправляемого из Azure AD, содержимое которой не известно, что все клиентские компоненты. Не отображается, что находится внутри PRT.

## <a name="how-is-a-prt-issued"></a>Как выдается PRT?

Регистрация устройств является необходимым условием для проверки подлинности на основе устройств в Azure AD. PRT выдается пользователям только для зарегистрированных устройств. Дополнительные подробные сведения о регистрации устройств, см. в статье [Windows Hello для бизнеса и регистрацию устройств](https://docs.microsoft.com/windows/security/identity-protection/hello-for-business/hello-how-it-works-device-registration). Во время регистрации устройства формируемых компонентом dsreg два набора пар криптографических ключей:

* Ключ устройства (dkpub/dkpriv)
* Ключ транспорта (tkpub/tkpriv)

Закрытые ключи привязаны к устройства доверенного платформенного МОДУЛЯ, если устройство имеет работающему доверенным платформенным Модулем, а открытые ключи отправляются в Azure AD во время процесса регистрации устройства. Эти ключи используются для проверки состояния устройства во время PRT запросов.

PRT выдается во время проверки подлинности пользователя на устройстве Windows 10 в двух сценариях:

* **Присоединенные к Azure AD** или **гибридным**: PRT выдается во время входа в систему Windows при входе пользователя с помощью учетных данных организации. PRT выдается все Windows 10 поддерживается для учетных данных, например, пароль и Windows Hello для бизнеса. В этом случае Azure AD CloudAP подключаемый модуль является основным центром для PRT.
* **Устройства, зарегистрированные в Azure AD**: PRT выдается в том случае, когда пользователь добавляет дополнительный рабочей учетной записи на устройстве Windows 10. Пользователи могут добавлять учетную запись Windows 10 двумя разными способами —  
   * Добавление учетной записи с помощью **везде использовать эту учетную запись на этом устройстве** prompt после входа в приложение (например, Outlook)
   * Добавление учетной записи из **параметры** > **учетные записи** > **доступ к рабочей или учебной** > **Connect**

В сценариях устройства, зарегистрированные в Azure AD подключаемый модуль Azure AD WAM является основным центром для PRT, так как вход в систему Windows не происходит с этой учетной записью Azure AD.

> [!NOTE]
> сторонние поставщики удостоверений должны поддерживать протокол WS-Trust, который позволяет использовать PRT выдачи на устройствах Windows 10. Без WS-Trust, PRT не могут быть выполнены для пользователей в Azure гибридные, присоединенные к AD или Azure AD устройств, присоединенных к

## <a name="what-is-the-lifetime-of-a-prt"></a>Что такое время существования PRT?

После выпуска PRT действителен в течение 14 дней и постоянно обновляется до тех пор, пока пользователь активно использует устройство.  

## <a name="how-is-a-prt-used"></a>Как используется PRT?

PRT используется два ключевых компонента в Windows:

* **Подключаемый модуль Azure AD CloudAP**: Во время входа Windows подключаемый модуль Azure AD CloudAP запрашивает PRT из Azure AD, используя учетные данные, предоставленные пользователем. Он также кэширует PRT для включения кэшированных входа, когда пользователь не имеет доступа для подключения к Интернету.
* **Подключаемый модуль Azure AD WAM**: Когда пользователи пытаются получить доступ к приложениям, подключаемый модуль Azure AD WAM использует PRT для включения Единого входа в Windows 10. Подключаемый модуль Azure AD WAM использует PRT для запроса маркеров обновления и доступа для приложений, полагающихся на WAM запросов маркеров. Она также обеспечивает возможность единого входа в браузерах, включение PRT в запросы браузера. Браузер единого входа в Windows 10 (изначально) поддерживается в Microsoft Edge и Chrome (через расширение учетных записей Windows 10 или Office Online).

## <a name="how-is-a-prt-renewed"></a>Как продлить PRT?

PRT обновляется в двух разных методов:

* **Подключаемый модуль Azure AD CloudAP каждые 4 часа**: Подключаемый модуль CloudAP продлевает PRT каждые 4 часа, во время входа Windows. Если пользователь не имеет подключение к Интернету в течение этого времени, подключаемый модуль CloudAP продлевается PRT после устройство подключено к Интернету.
* **Подключаемый модуль Azure AD WAM во время запросов маркеров приложения**: Подключаемый модуль WAM обеспечивает возможность единого входа на устройствах Windows 10, позволяя автоматической запросов маркеров для приложений. Подключаемый модуль WAM можно продлить PRT во время этих запросов маркеров двумя разными способами:
   * Приложение запрашивает WAM маркер доступа без вмешательства пользователя, но нет отсутствует маркер обновления для этого приложения. В этом случае WAM использует PRT для запроса маркера для приложения и возвращает новый PRT в ответе.
   * Приложение запрашивает WAM маркер доступа, но PRT является недопустимым или Azure AD требует дополнительной авторизации (например, многофакторной идентификации Azure). В этом случае WAM инициирует интерактивный вход в систему, чтобы пользователю выполнить проверку подлинности, или предоставить дополнительную проверку и новый PRT выдается после успешной аутентификации.

### <a name="key-considerations"></a>Основные рекомендации

* PRT только выданный и обновлен во время проверки подлинности собственное приложение. PRT не продлить или выпущенных в процессе выполнения сеанса браузера.
* В Azure AD присоединенных к и гибридные устройства присоединены к Azure AD, CloudAP подключаемый модуль является основным центром для PRT. Во время запроса маркера на основе WAM случае продления PRT PRT отправляется обратно подключаемый модуль CloudAP, который проверяет правильность PRT с Azure AD, прежде чем принять его.

## <a name="how-is-the-prt-protected"></a>Способы защиты PRT?

Привязка, для которой его на устройство, пользователь вошел в PRT защищена. Azure AD и Windows 10 включите защиту PRT следующими способами:

* **Во время первого входа**: При первом входе в систему PRT выдает подписи запросов с использованием ключа устройства, криптографически создается во время регистрации устройства. На устройстве с работающему доверенным платформенным Модулем ключ устройства защищен доверенный платформенный модуль предотвращение вредоносного доступа. PRT не выдается, если не удается проверить подпись ключа соответствующего устройства.
* **Во время запросов маркеров и обновления**: Во время PRT, то Azure AD также выдает зашифрованного ключа сеанса на устройстве. Он зашифрован с помощью ключа общественный транспорт (tkpub) и передается как часть регистрации устройств Azure AD. Этот ключ сеанса могут быть расшифрованы только с помощью ключа закрытый транспорта (tkpriv), защищенных с помощью доверенного платформенного МОДУЛЯ. Сеансовый ключ является ключом проверки принадлежности (POP) для запросов, отправленных в Azure AD.  Сеансовый ключ также защищены с помощью TPM и доступ к нему ни один другой компонент операционной системы. Запросы маркеров или запросов на обновление PRT, были безопасно подписаны этот ключ сеанса через доверенный платформенный модуль и таким образом, не может быть изменены злоумышленником. Azure AD сделает недействительными все запросы от устройства, которые не вошли с соответствующим ключом сеанса.

Защищая эти ключи с помощью доверенного платформенного МОДУЛЯ, злоумышленников не удается извлечь ключи, ни воспроизведения PRT в другом месте, как доверенный платформенный модуль недоступен, даже если злоумышленник имеет само устройство.  Таким образом использование доверенного платформенного МОДУЛЯ значительно повышает безопасность присоединенных к Azure AD, гибридные, присоединенные к Azure AD, и устройства, от кражи учетных данных, зарегистрированные в Azure AD. Производительность и надежность TPM 2.0 является рекомендуемой версии для всех сценариев регистрации устройств Azure AD в Windows 10.

### <a name="how-are-app-tokens-and-browser-cookies-protected"></a>Как такое маркеры приложений и защищенные файлы cookie браузера

**Маркеры приложений**: Когда приложение запрашивает маркер через WAM, Azure AD выдает маркер обновления и маркер доступа. Тем не менее WAM только возвращает маркер доступа в приложение, а также обеспечивает защиту маркер обновления в своем кэше путем его шифрования с данных защиты приложения программирования интерфейса DPAPI ключ пользователя. Безопасно WAM использует токен обновления при подписании запросы сеансового ключа для дальнейшего выдачи маркеров доступа. Ключ DPAPI защищен с помощью симметричного ключа на основе Azure AD в Azure AD. Когда устройство требуется расшифровать профиль пользователя с помощью ключа API защиты данных, Azure AD предоставляет ключ DPAPI, зашифрован с помощью ключа сеанса, какой подключаемый модуль CloudAP запрашивает доверенного платформенного МОДУЛЯ для расшифровки. Эта функция обеспечивает согласованность в защите маркеры обновления и позволяет избежать реализации собственные механизмы защиты приложений.  

**Файлы cookie браузера**: В Windows 10 Azure AD поддерживает браузера единого входа в Internet Explorer и Microsoft Edge в собственном коде или в Google Chrome с помощью расширения для учетных записей Windows 10. Безопасность основывается не только для защиты файлов cookie, но также конечные точки, к которым отправляются файлы cookie. Файлы cookie браузера защищены так же является PRT, за счет использования сеансовый ключ для подписи и защиты файлов cookie.

Когда пользователь инициирует взаимодействие с браузером, браузер (или расширения) вызывает узлом собственный клиент COM. Узел собственного клиента гарантирует, что страницы относится к одному из разрешенных доменов. Браузер может отправить другие параметры для собственного клиента узла, включая nonce, однако узел собственного клиента гарантирует проверки имени узла. Узел собственного клиента запрашивает PRT-cookie от подключаемый модуль CloudAP, который создает и подписывает его, используя ключ сеанса, защищенный доверенным платформенным Модулем. Как PRT-куки-файл подписан с помощью ключа сеанса, он не может быть подменен. PRT-cookie включается в заголовке запроса для Azure AD для проверки устройства, на котором он поступил. Если при использовании браузера Chrome, только модуль, явно определенных в манифесте узел собственного клиента можно вызывать предотвращает выполнение этих запросов произвольных расширений. Когда Azure AD проверяет файл cookie PRT, она выдает файл cookie сеанса в браузер. Этот файл cookie сеанса также содержит тот же ключ сеанса, выпущенные с PRT. При последующих запросах сеансовый ключ проверяется эффективно привязки куки-файл на устройство и предотвращение воспроизведения из другого источника.

## <a name="when-does-a-prt-get-an-mfa-claim"></a>Когда PRT получать утверждение многофакторной Идентификации?

PRT можно получить утверждение многофакторной проверки подлинности (MFA) в определенных сценариях. При использовании для запроса маркеров для приложений на основе многофакторной Идентификации PRT утверждение MFA передается эти маркеры приложений. Эта функция обеспечивает удобную работу пользователей, так как запрос MFA для каждого приложения, которому он требуется. PRT можно получить утверждение многофакторной Идентификации, одним из следующих способов:

* **Войдите с помощью Windows Hello для бизнеса**: Windows Hello для бизнеса заменяет пароли и использует ключи шифрования для предоставления строгой двухфакторной проверки подлинности. Windows Hello для бизнеса пользователя на устройстве, а сам требует многофакторной проверки Подлинности для подготовки. При входе пользователя в систему с помощью Windows Hello для бизнеса пользователя PRT получает утверждение многофакторной Идентификации. Этот сценарий также применяется для пользователей, входящих в систему с помощью смарт-карт, если проверку подлинности смарт-карты создает утверждение многофакторной Идентификации из служб федерации Active Directory.
   * Так как Windows Hello для бизнеса считается многофакторной проверки подлинности, утверждение MFA обновляется при обновлении PRT, сам, длительность многофакторной проверки Подлинности будет постоянного продления, когда пользователи входят с WIndows Hello для бизнеса
* **MFA во время WAM интерактивного входа**: При запросе маркера через WAM Если пользователь является обязательной для выполнения многофакторной проверки Подлинности для доступа к приложению, PRT, которая обновляется во время взаимодействия отпечатанные с утверждение многофакторной Идентификации.
   * В этом случае утверждение MFA постоянное обновление не выполняется, поэтому длительность многофакторной проверки Подлинности зависит от срока жизни, установленного в каталоге.
* **MFA во время регистрации устройства**: Если администратор настроил их параметры устройств в Azure AD для [требовать многофакторную Идентификацию для регистрации устройств](device-management-azure-portal.md#configure-device-settings), пользователь должен проходить многофакторную Идентификацию для завершения регистрации. В ходе этого процесса PRT, который выдается пользователю имеет утверждение многофакторной Идентификации, полученные во время регистрации. Эта возможность применяется только к пользователь, выполнивший операцию соединения, не для других пользователей, которые выполняют вход в это устройство.
   * Подобно WAM интерактивного входа, утверждение MFA постоянное обновление не выполняется, поэтому длительность многофакторной проверки Подлинности зависит от срока жизни, установленного в каталоге.

Windows 10 поддерживает секционированные список Prt для каждых учетных данных. Таким образом нет PRT для каждого из Windows Hello для бизнеса, пароль или смарт-карты. Такое секционирование обеспечивает многофакторной проверки Подлинности утверждений изолированной зависимости от учетных данных используется и не путать во время запросов маркеров.

## <a name="how-is-a-prt-invalidated"></a>Как становится недействительным PRT?

PRT становится недействительным в следующих сценариях:

* **Недопустимый пользователь**: Если пользователь удален или отключен в Azure AD, их PRT становится недействительным и не может использоваться для получения маркеров для приложений. Если пользователь удален или отключен уже выполнил вход устройстве перед, кэшированные входа в систему будет войти, до CloudAP учитывает их в недопустимом состоянии. Как только CloudAP определяет, что пользователь является недопустимым, то блокирует работу последующих входах в систему. Неверное имя пользователя не блокируется войдите в систему на новых устройствах, не имеющие кэшированные учетные данные.
* **Недопустимое устройство**: Если устройство удален или отключен в Azure AD, PRT, полученный на этом устройстве становится недействительным и не может использоваться для получения маркеров для других приложений. Если пользователь уже выполнил вход на недопустимое устройство, они смогут продолжить делать. Но не делает недействительными все маркеры на устройстве и пользователь не имеет единого входа к любым ресурсам от этого устройства.
* **Изменение пароля**: Когда пользователь изменит свой пароль, PRT, полученное с прежний пароль становится недействительным, с помощью Azure AD. Результаты при изменении пароля пользователя, получение нового PRT. Этот недействительности может произойти двумя разными способами:
   * Если пользователь входит Windows с новым паролем, CloudAP удаляет старый PRT и запрашивает Azure AD для выдачи нового PRT с новым паролем. Если пользователь не имеет подключения к Интернету, новый пароль не может быть проверен, Windows может потребовать от пользователя ввести старый пароль.
   * Если пользователь войти в систему старый пароль или изменил пароль после входа в Windows, старый PRT используется для запросов на основе WAM токена. В этом случае пользователю предлагается повторно проходить проверку подлинности во время запроса маркера WAM и выдается новый PRT.
* **Неисправностей доверенного платформенного МОДУЛЯ**: В некоторых случаях устройства доверенного платформенного МОДУЛЯ можно сбою или завершиться ошибкой, что приводит к недоступности ключей, защищенных с помощью доверенного платформенного МОДУЛЯ. В этом случае устройство не начало PRT или запросе маркеров, с помощью существующего PRT, как его невозможно подтверждающего владение криптографических ключей. Таким образом любые существующие PRT становится недействительным, Azure AD. Когда Windows 10 обнаруживает сбой, он инициирует последовательности восстановления, чтобы повторно зарегистрировать устройство в новых криптографических ключей. С присоединением к Azure Ad гибридного, так же, как первоначальной регистрации восстановления происходит автоматически без вмешательства пользователя. Для устройства, зарегистрированные в Azure, присоединенные к AD или Azure AD, восстановление необходимо выполнять пользователь, у кого есть права администратора на устройстве. В этом случае последовательность восстановления инициируется запрос Windows, помогающий пользователю для успешного восстановления устройства.

## <a name="detailed-flows"></a>Подробные потоки

На следующей схеме показаны основные сведения о выдаче, обновление и использование PRT для запроса маркера доступа для приложения. Кроме того эти действия также описывают, как механизмы безопасности в упомянутых выше применяются при взаимодействии.

### <a name="prt-issuance-during-first-sign-in"></a>PRT выдачи во время первого входа

![PRT выдачи во время первого входа подробный поток](./media/concept-primary-refresh-token/prt-initial-sign-in.png)

> [!NOTE]
> В Azure AD устройств, присоединенных к, такой обмен происходит синхронно для выдачи PRT, прежде чем пользователь может войти в Windows. В гибридной среде присоединенные к Azure AD устройств, в локальном каталоге Active Directory является основным центром. Таким образом пользователь, ожидает только в том случае, пока они могли получить TGT для входа, во время выдачи PRT происходит асинхронно. Этот сценарий не применяется к устройства, зарегистрированные в Azure AD, что вход в систему не используют учетные данные Azure AD.

| Шаг | Описание |
| :---: | --- |
| A | Пользователь вводит свой пароль в пользовательский Интерфейс входа. Процесс LogonUI передает учетные данные в буфере auth LSA, который, в передает его внутренне CloudAP. CloudAP отправляет этот запрос CloudAP подключаемого модуля. |
| b | Подключаемый модуль CloudAP инициирует запрос на обнаружение области для идентификации поставщика удостоверений для пользователя. Если клиенту пользователя файл установки поставщика федерации, Azure AD возвращает поставщика federation Metadata Exchange (MEX) конечная точка конечной точки. Если нет, Azure AD возвращает, что пользователь является управляемым, указывающий, что этот пользователь могут проходить проверку подлинности с помощью Azure AD. |
| C | Если пользователь является управляемым, CloudAP получите специальное слово из Azure AD. Если пользователь является федеративным, подключаемый модуль CloudAP запрашивает маркер SAML от поставщика федерации с учетными данными пользователя. При получении, маркер SAML, он запрашивает nonce из Azure AD. |
| D | Подключаемый модуль CloudAP создает запрос на проверку подлинности с учетными данными пользователя, специальное слово и область брокера, подписывает запрос с ключом устройства (dkpriv) и отправляет его в Azure AD. В федеративной среде, подключаемый модуль CloudAP использует маркер SAML, возвращенный поставщиком федерации, вместо него "учетные данные. |
| E | Azure AD проверяет учетные данные пользователя, специальное слово, и устройства подпись, проверяет, что устройство является допустимым в клиенте и выдает зашифрованных PRT. Вместе с PRT Azure AD также выдает симметричный ключ, называемый ключ сеанса, зашифрованный с помощью Azure AD, используя ключ транспорта (tkpub). Кроме того сеансовый ключ также внедряется в PRT. Этот ключ сеанса выступает в качестве ключа для последующих запросов с PRT проверки принадлежности (PoP). |
| F | Подключаемый модуль CloudAP передает зашифрованный ключ сеанса и PRT CloudAP. CloudAP запрашивать доверенный платформенный модуль для расшифровки сеансового ключа, с помощью ключа транспорта (tkpriv) и повторно зашифровать его с помощью доверенного платформенного МОДУЛЯ собственный ключ. CloudAP сохраняет зашифрованный сеансовый ключ в своем кэше, а также PRT. |

### <a name="prt-renewal-in-subsequent-logons"></a>PRT обновление в последующих входах в систему

![PRT обновление в последующих входах в систему](./media/concept-primary-refresh-token/prt-renewal-subsequent-logons.png)

| Шаг | Описание |
| :---: | --- |
| A | Пользователь вводит свой пароль в пользовательский Интерфейс входа. Процесс LogonUI передает учетные данные в буфере auth LSA, который, в передает его внутренне CloudAP. CloudAP отправляет этот запрос CloudAP подключаемого модуля. |
| b | Если ранее пользователь вошел на пользователя, войдите в Windows инициирует кэшируются и проверяет учетные данные для входа пользователя. Каждые 4 часа, подключаемый модуль CloudAP инициирует обновление PRT асинхронно. |
| C | Подключаемый модуль CloudAP инициирует запрос на обнаружение области для идентификации поставщика удостоверений для пользователя. Если клиенту пользователя файл установки поставщика федерации, Azure AD возвращает поставщика federation Metadata Exchange (MEX) конечная точка конечной точки. Если нет, Azure AD возвращает, что пользователь является управляемым, указывающий, что этот пользователь могут проходить проверку подлинности с помощью Azure AD. |
| D | Если пользователь является федеративным, подключаемый модуль CloudAP запрашивает маркер SAML от поставщика федерации с учетными данными пользователя. При получении, маркер SAML, он запрашивает nonce из Azure AD. Если пользователь является управляемым, CloudAP напрямую получить специальное слово из Azure AD. |
| E | Подключаемый модуль CloudAP создает запрос на проверку подлинности с учетными данными пользователя, специальное слово и существующие PRT, подписывает запрос с ключом сеанса и отправляет его в Azure AD. В федеративной среде, подключаемый модуль CloudAP использует маркер SAML, возвращенный поставщиком федерации, вместо него "учетные данные. |
| F | Azure AD проверяет подпись ключа сеанса путем его сравнения с сеансового ключа, внедренного в PRT, проверяет специальное слово и проверяет, что устройство является допустимым в клиенте и выдает новый PRT. Как показано выше, прежде чем, PRT снова сопровождается ключ сеанса шифруется ключ транспорта (tkpub). |
| G. | Подключаемый модуль CloudAP передает зашифрованный ключ сеанса и PRT CloudAP. CloudAP запрашивает доверенного платформенного МОДУЛЯ для расшифровки сеансового ключа, с помощью ключа транспорта (tkpriv) и повторно зашифровать его с помощью доверенного платформенного МОДУЛЯ собственный ключ. CloudAP сохраняет зашифрованный сеансовый ключ в своем кэше, а также PRT. |

### <a name="prt-usage-during-app-token-requests"></a>Использование PRT во время запросов маркеров приложения

![Использование PRT во время запросов маркеров приложения](./media/concept-primary-refresh-token/prt-usage-app-token-requests.png)

| Шаг | Описание |
| :---: | --- |
| A | Приложение (например, Outlook, OneNote и т.д.) инициирует запрос маркера WAM. WAM, в свою очередь, запрашивает подключаемый модуль Azure AD WAM для обслуживания запроса маркера. |
| b | Если маркер обновления для приложения уже доступна, подключаемый модуль Azure AD WAM использует его для запроса маркера доступа. Для подтверждения привязки устройства, подключаемого модуля WAM подписывает запрос с ключом сеанса. Azure AD проверяет ключ сеанса и выдает маркер доступа и маркер обновления для приложения, зашифрован с помощью ключа сеанса. Подключаемый модуль WAM запрашивает подключаемого модуля AP облака для расшифровки токенов, которая, в свою очередь, запрашивает доверенного платформенного МОДУЛЯ для дешифрования с помощью сеансового ключа, полученный в подключаемом модуле WAM получения обоих маркеров. Далее WAM подключаемый модуль предоставляет только маркер доступа для приложения, хотя он повторно шифрует маркер обновления с помощью DPAPI и сохраняет его в собственный кэш  |
| C |  Если маркер обновления для приложения не доступен, подключаемый модуль Azure AD WAM использует PRT для запроса маркера доступа. Для подтверждения владения, подключаемый модуль WAM подписывает запрос, содержащий PRT ключом сеанса. Azure AD проверяет подпись ключа сеанса путем его сравнения с сеансового ключа, внедренного в PRT, проверяет, что устройство является допустимым и выдает маркер доступа и маркер обновления для приложения. Кроме того, Azure AD может выдавать новый PRT, (с учетом цикл обновления), то они зашифрован с помощью ключа сеанса. |
| D | Подключаемый модуль WAM запрашивает подключаемого модуля AP облака для расшифровки токенов, которая, в свою очередь, запрашивает доверенного платформенного МОДУЛЯ для дешифрования с помощью сеансового ключа, полученный в подключаемом модуле WAM получения обоих маркеров. Далее WAM подключаемый модуль предоставляет только маркер доступа для приложения, хотя он повторно шифрует маркер обновления с помощью DPAPI и сохраняет его в собственный кэш. Подключаемый модуль WAM будет использовать маркер обновления, в дальнейшем для этого приложения. Подключаемый модуль WAM также предоставляет обратно новый PRT к подключаемого модуля AP облака, который проверяет PRT с Azure AD перед его обновлением в собственном кэше. Подключаемого модуля AP облака будут использовать новый PRT, в дальнейшем. |
| E | WAM предоставляет маркер доступа, полученного для WAM, который в свою очередь, предоставляет его вызывающему приложению|

### <a name="browser-sso-using-prt"></a>Браузер единого входа с помощью PRT

![Браузер единого входа с помощью PRT](./media/concept-primary-refresh-token/browser-sso-using-prt.png)

| Шаг | Описание |
| :---: | --- |
| A | Пользователь входит в Windows с помощью учетных данных для получения PRT. Когда пользователь открывает браузер, браузер (или расширения) загружает из реестра URL-адреса. |
| b | Когда пользователь открывает URL-адрес входа Azure AD, браузер или расширение проверяет URL-адрес с тех, которые получены из реестра. Если они совпадают, браузер вызывает узел собственного клиента для получения маркера. |
| C | Узел собственного клиента проверяет, что URL-адреса принадлежит поставщиков удостоверений Майкрософт (учетную запись Майкрософт или Azure AD), извлекает nonce, отправляемых из URL-адрес и делает вызов CloudAP подключаемый модуль для PRT файл cookie. |
| D | Подключаемый модуль CloudAP создания файлов cookie PRT, войдите с помощью доверенного платформенного МОДУЛЯ привязкой сеансовый ключ и отправить его в ведущее приложение собственного клиента. Как файл cookie подписывается с помощью ключа сеанса, он не может быть подменен. |
| E | Узел собственного клиента будет отправлять этот файл cookie PRT браузер, который будет включать его как часть запроса заголовок с именем x-ms-RefreshTokenCredential и запросите маркеры из Azure AD. |
| F | Azure AD проверяет подпись ключа сеанса в файле cookie PRT, проверяет специальное слово, проверяет, что устройство является допустимым в клиенте и выдает маркер Идентификации для веб-страницы и файл cookie сеанса для браузера. |

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об устранении проблем, связанных с PRT см. в статье [устройств Windows 10 и Windows Server 2016, присоединенных к гибридной Устранение неполадок Azure Active Directory](troubleshoot-hybrid-join-windows-current.md).
