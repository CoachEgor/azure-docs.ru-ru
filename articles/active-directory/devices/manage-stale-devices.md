---
title: Управление устаревшими устройствами в Azure AD | Документация Майкрософт
description: Узнайте, как удалить устаревшие устройства из базы данных зарегистрированных устройств в active Directory Azure.
services: active-directory
ms.service: active-directory
ms.subservice: devices
ms.topic: conceptual
ms.date: 06/28/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: spunukol
ms.collection: M365-identity-device-management
ms.openlocfilehash: 46be728216ed4b9c9e84c1c7f68c5ddf2051f42b
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78672304"
---
# <a name="how-to-manage-stale-devices-in-azure-ad"></a>Как: Управление устаревшими устройствами в Azure AD

Чтобы правильно завершить жизненный цикл ставшего ненужным зарегистрированного устройства, нужно отменить его регистрацию. Но в некоторых случаях такие устройства остаются в среде как устаревшие, например если они украдены, потеряны, сломаны или на них переустановлена ОС. ИТ-администратору будет полезно научиться удалять такие устаревшие устройства, чтобы не тратить время не на них, а на другие актуальные ресурсы.

В этой статье описано, как управлять устаревшими устройствами в вашей среде.
  

## <a name="what-is-a-stale-device"></a>Что такое устаревшее устройство?

Устаревшим называется устройство, которое было зарегистрировано в Azure AD, но в течение некоторого времени уже не используется для доступа к приложениям. Устаревшие устройства негативно влияют на возможности поддержки устройств и пользователей и управлению ими в клиенте, так как: 

- избыточное число устройств мешает сотрудникам службы поддержки быстро определить, какое устройство используется;
- Увеличение числа устройств создает ненужные записи устройств, увеличивая время синхронизации Azure AD.
- поддержание актуальных сведений о состоянии устройств нужно для поддержания "гигиены" и соблюдения требований в среде. 

Устаревшие устройства в AAD мешают правильно применять политики жизненного цикла для устройств в организации.

## <a name="detect-stale-devices"></a>Выявление устаревших устройств

По определению устаревшими являются устройства, которые все еще зарегистрированы, но в течение периода времени не используются для доступа к облачным приложениям. Это означает, что для их выявления нужно свойство, сохраняющее метки времени. В AAD для этой цели используется свойство **ApproximateLastLogonTimestamp**, называемое **меткой активности**. Устройство считается устаревшим, если разница между текущей датой и значением **метки активности** превышает определенный для активных устройств интервал времени. Свойство **метки активности** предоставляется в режиме общедоступной предварительной версии.

## <a name="how-is-the-value-of-the-activity-timestamp-managed"></a>Как используется значение отметки активности?  

Оценка метки активности инициируется при запросе аутентификации с устройства. Azure AD оценивает метку активности в следующих случаях:

- Сработала политика «Условный доступ», требующая [управляемых устройств](../conditional-access/require-managed-devices.md) или [одобренных клиентских приложений.](../conditional-access/app-based-conditional-access.md)
- когда в сети активируются устройства Windows 10, использующие обычное или гибридное присоединение к AAD; 
- когда управляемые устройства Intune подключаются к этой службе.

Если дельта между существующим значением метки времени действия и текущим значением составляет более 14 дней (разница в 5 дней), существующее значение заменяется новым значением.

## <a name="how-do-i-get-the-activity-timestamp"></a>Как получить метку активности?

У вас есть два способа получить значение метки активности.

- Столбец **Действия** на [странице устройств](https://portal.azure.com/#blade/Microsoft_AAD_IAM/DevicesMenuBlade/Devices) на портале Azure:

    ![Метка активности](./media/manage-stale-devices/01.png)

- Командлет [Get-MsolDevice](/powershell/module/msonline/get-msoldevice?view=azureadps-1.0):

    ![Метка активности](./media/manage-stale-devices/02.png)

## <a name="plan-the-cleanup-of-your-stale-devices"></a>Планирование очистки устаревших устройств

Для эффективной очистки устаревших устройств в вашей среде следует определить соответствующую политику. Эта политика поможет вам учесть все аспекты, связанные с устаревшими устройствами. В следующих разделах приводятся разные аспекты, учитываемые при создании таких политик. 

### <a name="cleanup-account"></a>Учетная запись для очистки

Чтобы обновить сведения об устройствах в AAD, нужно использовать учетную запись с одной из следующих ролей:

- глобального администратора;
- Администратор облачного устройства
- Администратор службы Intune

Выберите для политики очистки учетные записи, которым назначены необходимые роли. 

### <a name="timeframe"></a>Временной интервал

Определите интервал времени, по которому определяются устаревшие устройства. При определении таймфрейма учесть окно, отмеченное для обновления метки времени действия, в значение. Например, не следует рассматривать метку времени, которая моложе 21 дня (включает дисперсию) в качестве индикатора для несвежего устройства. В некоторых ситуациях устройство может казаться устаревшим, хотя фактически им не является. Например, если владелец устройства уехал в отпуск или заболел  на период, превышающий выбранный вами интервал.

### <a name="disable-devices"></a>Отключение устройств

Мы не рекомендуем немедленно удалять устаревшее устройство, ведь в случае ложных положительных срабатываний отменить эту операцию не удастся. Лучше всего перед удалением отключать такое устройство на указанный период. Определите в политике интервал времени, в течение которого устройство будет отключено перед удалением.

### <a name="mdm-controlled-devices"></a>Устройства, управляемые MDM

Если устройство находится под управлением Intune или другого решения MDM, снимите устройство с учета в системе управления перед его отключением или удалением.

### <a name="system-managed-devices"></a>Устройства, управляемые системой

Не удаляйте устройства, управляемые системой. Как правило, это устройства, такие как Autopilot. После удаления эти устройства не могут быть переоднены. Новый командлет `get-msoldevice` по умолчанию пропускает устройства, управляемые системой. 

### <a name="hybrid-azure-ad-joined-devices"></a>Гибридные устройства, присоединенные к Azure AD

Гибридные устройства, присоединенные к Azure AD, должны соблюдать настроенные политики для управления локальными устаревшими устройствами. 

Для очистки AAD сделайте следующее:

- **Устройства Windows 10** — отключите или удалите устройства Windows 10 в локальном каталоге AD и дождитесь синхронизации изменений в Azure Active Directory.
- **Windows 7/8** - Отключить или удалить устройства Windows 7/8 в вашем помещении AD в первую очередь. Azure AD Connect нельзя использовать для отключения или удаления устройств Windows 7 или 8 в Azure AD. Вместо этого при вносе изменений в помещение необходимо отключить/удалить в Azure AD.

> [!NOTE]
>* Удаление устройств в вашем предварительном AD или Azure AD не удаляет регистрацию клиента. Это только предотвратит доступ к ресурсам, использующим устройство в качестве удостоверения личности (например, условный доступ). Читайте дополнительную информацию о том, как [удалить регистрацию на клиента](faq.md#hybrid-azure-ad-join-faq).
>* Удаление устройства Windows 10 только в Azure AD позволит повторно синхронизировать устройство с вашего собственного с помощью Azure AD Connect, но в качестве нового объекта в состоянии "В ожидании". На устройстве требуется перерегистрация.
>* Удаление устройства из области синхронизации для устройств Windows 10/Server 2016 удалит устройство Azure AD. Добавление его обратно в область синхронизации приведет к посыл нового объекта в состоянии "В ожидании". Необходима перерегистрация устройства.
>* Если вы не используете Azure AD Connect для устройств Windows 10 для синхронизации (например, только с помощью AD FS для регистрации), вы должны управлять жизненным циклом, аналогичным устройствам Windows 7/8.


### <a name="azure-ad-joined-devices"></a>Устройства, присоединенные к Azure AD

Отключите или удалите в Azure AD устройства, присоединенные к Azure AD.

> [!NOTE]
>* Удаление устройства Azure AD не удаляет регистрацию на клиенте. Это только предотвратит доступ к ресурсам, использующим устройство в качестве удостоверения личности (например, условный доступ). 
>* Подробнее о [том, как развернуться на Azure AD](faq.md#azure-ad-join-faq) 

### <a name="azure-ad-registered-devices"></a>Устройства, зарегистрированные в Azure AD

Отключите или удалите в Azure AD устройства, зарегистрированные в Azure AD.

> [!NOTE]
>* Удаление зарегистрированного устройства Azure AD в Azure AD не удаляет регистрацию клиента. Это только предотвратит доступ к ресурсам, использующим устройство в качестве удостоверения личности (например, условный доступ).
>* Подробнее о [том, как удалить регистрацию на клиента](faq.md#azure-ad-register-faq)

## <a name="clean-up-stale-devices-in-the-azure-portal"></a>Очистка устаревших устройств на портале Azure  

Хотя вы можете очистить устаревшие устройства на портале Azure, этот процесс удобнее выполнять с помощью скрипта PowerShell. Используйте новейший модуль PowerShell V1, чтобы использовать фильтр метки времени и отфильтровывать управляемые системой устройства, такие как Автопилот. Сейчас мы не рекомендуем применять PowerShell версии 2.

Типичная процедура состоит из следующих шагов:

1. подключение к Azure Active Directory с помощью командлета [Connect-MsolService](/powershell/module/msonline/connect-msolservice?view=azureadps-1.0);
1. Получение списка устройств
1. отключение устройства с помощью командлета [Disable-MsolDevice](/powershell/module/msonline/disable-msoldevice?view=azureadps-1.0); 
1. Ожидание периода времени перед удалением, в зависимости от количества указанных вами дней.
1. удаление устройства с помощью командлета [Remove-MsolDevice](/powershell/module/msonline/remove-msoldevice?view=azureadps-1.0).

### <a name="get-the-list-of-devices"></a>Получение списка устройств

Чтобы получить список всех устройств и сохранить эти данные в CSV-файл, выполните:

```PowerShell
Get-MsolDevice -all | select-object -Property Enabled, DeviceId, DisplayName, DeviceTrustType, Approxi
mateLastLogonTimestamp | export-csv devicelist-summary.csv
```

Если в каталоге есть большое количество устройств, используйте фильтр метки времени, чтобы сузить количество возвращенных устройств. Чтобы получить и сохранить в CSV-файл список всех устройств, у которых метка времени старше указанной даты, выполните: 

```PowerShell
$dt = [datetime]’2017/01/01’
Get-MsolDevice -all -LogonTimeBefore $dt | select-object -Property Enabled, DeviceId, DisplayName, DeviceTrustType, ApproximateLastLogonTimestamp | export-csv devicelist-olderthan-Jan-1-2017-summary.csv
```

## <a name="what-you-should-know"></a>Необходимая информация

### <a name="why-is-the-timestamp-not-updated-more-frequently"></a>Почему метка времени не обновляется чаще?

Эта метка времени обновляется только для управления жизненным циклом устройств. Она не предназначена для аудита. Чтобы получать более частые сведения об устройствах, применяйте журналы аудита входов.

### <a name="why-should-i-worry-about-my-bitlocker-keys"></a>Почему мне нужно беспокоиться о ключах BitLocker?

Если у вас настроены ключи BitLocker для устройств Windows 10, они хранятся в объекте устройства в AAD. Удаляя устаревшее устройство, вы удалите и сохраненные для него ключи BitLocker. Прежде чем удалять устаревшие устройства, нужно убедиться, соответствует ли выбранная политика очистки фактическим жизненным циклам устройств. 

### <a name="why-should-i-worry-about-windows-autopilot-devices"></a>Почему я должен беспокоиться об устройствах Windows Autopilot?

Когда устройство Azure AD было связано с объектом автопилота Windows, могут возникнуть следующие три сценария, если устройство будет перепрофилировано в будущем:
- При развертывании с использованием Windows Autopilot без использования белой перчатки будет создано новое устройство Azure AD, но оно не будет помечено с помощью «TDID».
- При развертывании автономного режима Windows Autopilot они потерпят неудачу из-за того, что не может быть найдено ассоциированное устройство Azure AD.  (Это механизм безопасности, чтобы убедиться, что никакие "самозваные" устройства не пытаются присоединиться к Azure AD без учетных данных.) Сбой будет указывать на несоответствие TDID.
- При развертывании белых перчаток Windows Autopilot они потерпят неудачу из-за того, что не может быть найдено связанное с ним устройство Azure AD. (За кулисами развертывание белых перчаток использует один и тот же процесс автономного развертывания, поэтому они обеспечивают соблюдение одних и тех же механизмов безопасности.)

### <a name="how-do-i-know-all-the-type-of-devices-joined"></a>Как мне изучить все типы присоединенных устройств?

Дополнительные сведения о разных типах вы найдете в руководстве по [управлению устройствами](overview.md).

### <a name="what-happens-when-i-disable-a-device"></a>Что произойдет, если я отключу устройство?

Будет запрещена любая аутентификация, которая включает проверку этого устройства в AAD. Ниже приведены распространенные примеры.

- **Гибридные устройства, присоединенные к AAD** — пользователь может использовать устройство для входа в локальный домен. Но он не получит доступ к ресурсам AAD, например к Office 365.
- **Устройства, присоединенные к AAD** — пользователь не может использовать устройство для входа. 
- **Мобильные устройства** — пользователь не получит доступа к ресурсам AAD, например к Office 365. 

## <a name="next-steps"></a>Дальнейшие действия

Чтобы получить общие сведения о том, как управлять устройствами на портале Azure, см. раздел [Управление устройствами с помощью портала Azure (предварительная версия)](device-management-azure-portal.md)
