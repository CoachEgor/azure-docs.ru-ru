---
title: Проверка подлинности на основе одноразового секретного кода для гостевых пользователей B2B — Azure Active Directory
description: Использование одноразового секретного кода, отправляемого по почте, для проверки подлинности гостевых пользователей B2B без использования учетной записи Майкрософт.
services: active-directory
ms.service: active-directory
ms.subservice: B2B
ms.topic: conceptual
ms.date: 05/11/2020
ms.author: mimart
author: msmimart
manager: celestedg
ms.reviewer: mal
ms.custom: it-pro, seo-update-azuread-jan, seoapril2019
ms.collection: M365-identity-device-management
ms.openlocfilehash: 520f42956a1e096893935b6b7844d67060958829
ms.sourcegitcommit: bb0afd0df5563cc53f76a642fd8fc709e366568b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2020
ms.locfileid: "83585931"
---
# <a name="email-one-time-passcode-authentication-preview"></a>Проверка подлинности с отправкой одноразового секретного кода по почте (предварительная версия)

|     |
| --- |
| Отправка одноразового секретного кода по почте — это функция, которая предоставляется в общедоступной предварительной версии в Azure Active Directory. См. подробные сведения о [дополнительных условиях использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).|
|     |

В статье описано, как включить отправку одноразового секретного кода по почте гостевым пользователям B2B. Функция отправки одноразового секретного кода по почте позволяет проверить подлинность гостевых пользователей B2B, если это невозможно сделать с помощью других средств, таких как Azure AD, учетная запись Майкрософт (MSA) или федерация с Google. Благодаря проверке подлинности на основе одноразового секретного кода больше не нужно создавать учетную запись Майкрософт. Если гостевой пользователь активирует приглашение или обращается к общему ресурсу, он может запросить временный код, который будет отправлен на адрес электронной почты этого пользователя. Этот код нужно ввести, чтобы войти в систему.

Сейчас доступна предварительная версия этой функции (дополнительные сведения см. в разделе [Согласие на использование предварительной версии](#opting-in-to-the-preview) ниже). По окончании срока действия предварительной версии эта функция будет включена по умолчанию для всех клиентов.

> [!NOTE]
> Если пользователь применяет для входа одноразовый секретный код, ему необходимо войти по ссылке, содержащей контекст клиента (например, `https://myapps.microsoft.com/?tenantid=<tenant id>` или `https://portal.azure.com/<tenant id>`, а в случае проверенного домена — `https://myapps.microsoft.com/<verified domain>.onmicrosoft.com`). Прямые ссылки на приложения и ресурсы также работают, если они содержат контекст клиента. В настоящее время пользователи не могут войти в систему, используя конечные точки, которые не имеют контекста клиента. Например, использование `https://myapps.microsoft.com`, `https://portal.azure.com` или общей конечной точки команды приведет к ошибке. 

## <a name="user-experience-for-one-time-passcode-guest-users"></a>Применение одноразового секретного кода гостевыми пользователями
При использовании проверки подлинности на основе одноразового секретного кода гостевой пользователь может активировать ваше приглашение, перейдя по прямой ссылке или используя письмо с приглашением. В обоих случаях в браузере отобразится сообщение о том, что секретный код будет отправлен на адрес электронной почты гостевого пользователя. Гостевому пользователю необходимо щелкнуть **Отправить код**:
 
   ![Снимок экрана с кнопкой "Отправить код"](media/one-time-passcode/otp-send-code.png)
 
Секретный код отправляется на адрес электронной почты пользователя. Пользователь получает секретный код в письме и вводит его в окне браузера:
 
   ![Снимок экрана со страницей для ввода кода](media/one-time-passcode/otp-enter-code.png)
 
После проверки подлинности гостевой пользователь может просмотреть общий ресурс или продолжить вход. 

> [!NOTE]
> Одноразовый секретный код действителен в течение 30 минут. По истечении 30 минут этот одноразовый секретный код станет недействительным, и пользователю придется запросить новый. Сеансы пользователя завершаются через 24 часа. По прошествии этого времени для доступа к ресурсу гостевому пользователю необходимо получить новый секретный код. Срок действия сеанса позволяет повысить уровень безопасности, особенно если гостевой пользователь увольняется из компании или ему больше не нужен доступ к ресурсам.

## <a name="when-does-a-guest-user-get-a-one-time-passcode"></a>Когда гостевой пользователь получает одноразовый секретный код?

Когда гостевой пользователь активирует приглашение или использует ссылку на ресурс, к которому был предоставлен общий доступ, он получит одноразовый секретный код, если:
- у него нет учетной записи в Azure AD; 
- у него нет учетной записи Майкрософт; 
- клиент, отправивший приглашение, не настроил федерацию с Google для пользователей доменов @gmail.com и @googlemail.com. 

Во время отправки приглашения нельзя определить, что приглашаемый пользователь будет применять проверку подлинности на основе одноразового секретного кода. Но если невозможно использовать другие методы проверки подлинности, когда гостевой пользователь входит в систему, в качестве резервного метода применяется проверка подлинности на основе одноразового секретного кода. 

На портале Azure можно просмотреть гостевых пользователей, которые вошли в систему с помощью одноразового секретного кода в разделе **Azure Active Directory** > **Пользователи**.

![Снимок экрана со сведениями о пользователе, выполнившем вход с помощью одноразового секретного кода](media/one-time-passcode/otp-users.png)

> [!NOTE]
> Если пользователь активирует одноразовый секретный код, а затем вводит данные MSA, учетной записи Azure AD или другой федеративной учетной записи, он по-прежнему считается пользователем с проверкой подлинности на основе одноразового секретного кода. Если необходимо обновить метод проверки подлинности пользователя, вы можете удалить учетную запись гостевого пользователя и пригласить его повторно.

### <a name="example"></a>Пример
Гостевой пользователь alexdoe@gmail.com приглашен в компанию Fabrikam, которая не поддерживает настройку федерации Google. У Алекса нет учетной записи Майкрософт. Он получит одноразовый секретный код для проверки подлинности.

## <a name="opting-in-to-the-preview"></a>Согласие на использование предварительной версии 
Чтобы согласие вступило в силу, может потребоваться несколько минут. После этого проверка подлинности на основе одноразового секретного кода будет использоваться только для вновь приглашенных пользователей, которые соответствуют указанным выше условиям. Гостевые пользователи, которые ранее активировали свои приглашения, будут продолжать использовать свой обычный метод проверки подлинности.

### <a name="to-opt-in-using-the-azure-ad-portal"></a>Подтверждение согласия с помощью портала Azure AD
1.  Войдите на [портал Azure](https://portal.azure.com/) с правами глобального администратора Azure AD.
2.  В области навигации выберите **Azure Active Directory**.
3.  Выберите **Внешние удостоверения** > **Параметры внешнего взаимодействия**.
5.  В разделе **Включить одноразовый секретный код электронной почты для гостей (предварительная версия)** выберите **Да**.
 
### <a name="to-opt-in-using-powershell"></a>Подтверждение согласия с помощью PowerShell

Убедитесь, что вы используете последнюю версию Azure AD PowerShell для модуля Graph (AzureADPreview). Затем проверьте, существуют ли политики B2B, и выполните соответствующие команды.

#### <a name="prerequisite-install-the-latest-azureadpreview-module"></a>Предварительные требования: Установка последнего модуля AzureADPreview
Сначала проверьте, какие модули вы установили. Для этого откройте Windows PowerShell от имени пользователя (функция "Запуск от имени администратора") и выполните следующую команду.
 
```powershell  
Get-Module -ListAvailable AzureAD*
```

Если модуль AzureADPreview отображается без сообщения о том, что имеется более поздняя версия, то все готово. В противном случае, на основе выходных данных выполните одно из следующих действий.

- Если результаты не отображаются, выполните следующую команду, чтобы установить модуль AzureADPreview.
  
   ```powershell  
   Install-Module AzureADPreview
   ```
- Если в результатах отображается только модуль AzureAD, выполните следующие команды, чтобы установить модуль AzureADPreview. 

   ```powershell 
   Uninstall-Module AzureAD 
   Install-Module AzureADPreview 
   ```
- Если в результатах отображается только модуль AzureADPreview, но вы получили сообщение о том, что существует более поздняя версия, выполните следующие команды для обновления модуля. 

   ```powershell 
   Uninstall-Module AzureADPreview 
   Install-Module AzureADPreview 
  ```

Вы можете получить запрос на установку модуля из ненадежного репозитория. Это происходит, если вы ранее не устанавливали репозиторий PSGallery в качестве доверенного. Нажмите клавишу **Y**, чтобы установить модуль.

#### <a name="check-for-existing-policies-and-opt-in"></a>Проверка наличия политик и подтверждение согласия

Затем с помощью следующей команды проверьте, существует ли политика B2BManagementPolicy:

```powershell 
$currentpolicy =  Get-AzureADPolicy | ?{$_.Type -eq 'B2BManagementPolicy' -and $_.IsOrganizationDefault -eq $true} | select -First 1
$currentpolicy -ne $null
```
- Если возвращается значение False, политика отсутствует. Создайте политику B2BManagementPolicy и согласитесь на использование предварительной версии, выполнив следующую команду:

   ```powershell 
   $policyValue=@("{`"B2BManagementPolicy`":{`"PreviewPolicy`":{`"Features`":[`"OneTimePasscode`"]}}}")
   New-AzureADPolicy -Definition $policyValue -DisplayName B2BManagementPolicy -Type B2BManagementPolicy -IsOrganizationDefault $true
   ```

- Если возвращается значение True, политика B2BManagementPolicy существует. Чтобы обновить политику и согласиться на использование предварительной версии, выполните следующую команду:
  
   ```powershell 
   $policy = $currentpolicy.Definition | ConvertFrom-Json
   $features=[PSCustomObject]@{'Features'=@('OneTimePasscode')}; $policy.B2BManagementPolicy | Add-Member 'PreviewPolicy' $features -Force; $policy.B2BManagementPolicy
   $updatedPolicy = $policy | ConvertTo-Json -Depth 3
   Set-AzureADPolicy -Definition $updatedPolicy -Id $currentpolicy.Id
   ```

## <a name="opting-out-of-the-preview-after-opting-in"></a>Отказ от использования предварительной версии после согласия на ее использование
Чтобы отказ вступил в силу, может потребоваться несколько минут. При отключении предварительной версии никто из гостевых пользователей, которые активировали одноразовый секретный код, не сможет войти в систему. Вы можете удалить гостевого пользователя и повторно пригласить его, чтобы разрешить ему вход в систему с помощью другого способа проверки подлинности.

### <a name="to-turn-off-the-preview-using-the-azure-ad-portal"></a>Отключение предварительной версии с помощью портала Azure AD
1.  Войдите на [портал Azure](https://portal.azure.com/) с правами глобального администратора Azure AD.
2.  В области навигации выберите **Azure Active Directory**.
3.  Выберите **Внешние удостоверения** > **Параметры внешнего взаимодействия**.
5.  В разделе **Включить одноразовый секретный код электронной почты для гостей (предварительная версия)** выберите **Нет**.

### <a name="to-turn-off-the-preview-using-powershell"></a>Отключение предварительной версии с помощью PowerShell
Установите последнюю версию модуля AzureADPreview, если он еще не установлен (см. раздел [Предварительные требования. Установка последнего модуля AzureADPreview](#prerequisite-install-the-latest-azureadpreview-module) выше). Затем убедитесь, что предварительная версия политики с использованием одноразовых секретных кодов существует, выполнив следующую команду:

```powershell 
$currentpolicy = Get-AzureADPolicy | ?{$_.Type -eq 'B2BManagementPolicy' -and $_.IsOrganizationDefault -eq $true} | select -First 1
($currentPolicy -ne $null) -and ($currentPolicy.Definition -like "*OneTimePasscode*")
```

Если возвращается значение True, откажитесь от использования предварительной версии с помощью следующей команды:

```powershell 
$policy = $currentpolicy.Definition | ConvertFrom-Json
$policy.B2BManagementPolicy.PreviewPolicy.Features = $policy.B2BManagementPolicy.PreviewPolicy.Features.Where({$_ -ne "OneTimePasscode"})
$updatedPolicy = $policy | ConvertTo-Json -Depth 3
Set-AzureADPolicy -Definition $updatedPolicy -Id $currentpolicy.Id
```

