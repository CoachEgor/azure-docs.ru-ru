---
title: Настройте прямую федерацию с AD FS для B2B — Azure Active Directory | Документация Майкрософт
description: Узнайте, как настроить AD FS, как поставщик удостоверений для прямой федерации, чтобы гости могли входить в приложения Azure AD
services: active-directory
ms.service: active-directory
ms.subservice: B2B
ms.topic: conceptual
ms.date: 07/01/2019
ms.author: mimart
author: msmimart
manager: celestedg
ms.reviewer: mal
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: a8f709186f0ef17e037c4203118be07ea2d4f511
ms.sourcegitcommit: 5bdd50e769a4d50ccb89e135cfd38b788ade594d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2019
ms.locfileid: "67544326"
---
# <a name="example-direct-federation-with-active-directory-federation-services-ad-fs-preview"></a>Пример: Прямую федерацию со службами федерации Active Directory (AD FS) (Предварительная версия)
|     |
| --- |
| Общедоступная Предварительная версия прямую федерацию функция Azure Active Directory. См. подробные сведения о [дополнительных условиях использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).|
|     |

В этой статье описывается, как настроить [прямой федерации](direct-federation.md) с помощью служб федерации Active Directory (AD FS) в качестве поставщика удостоверений SAML 2.0 или WS-Fed. Поддержка прямой федерации, определенные атрибуты и утверждения должен быть настроен на уровне поставщика удостоверений. Чтобы проиллюстрировать процесс настройки поставщика удостоверений для прямую федерацию, мы будем использовать службы федерации Active Directory (AD FS) в качестве примера. Будет показано, как настроить AD FS, как в качестве поставщика удостоверений SAML, так и в качестве поставщика удостоверений WS-Fed.

> [!NOTE]
> В этой статье описывается настройка AD FS для SAML и WS-Fed для иллюстрации. Для интеграции прямую федерацию, где поставщик удостоверений AD FS рекомендуется использовать WS-Fed в качестве протокола. 

## <a name="configure-ad-fs-for-saml-20-direct-federation"></a>Настройка AD FS для прямой федерации SAML 2.0
Azure AD B2B можно настроить в федерацию с поставщиками удостоверений, использующим протокол SAML с определенными требованиями, перечисленных ниже. Чтобы проиллюстрировать действия по настройке SAML, в этом разделе показано, как настроить AD FS для SAML 2.0. 

Чтобы настроить прямую федерацию, следующие атрибуты должно быть получено в ответ от поставщика удостоверений SAML 2.0. Эти атрибуты можно настроить путем связывания службе маркеров безопасности в сети XML-файл или ввести их вручную. Шаг 12 в [создать экземпляр теста AD FS](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed) описывает способы поиска конечных точек AD FS или как создавать URL-адрес метаданных, например `https://fs.iga.azure-test.net/federationmetadata/2007-06/federationmetadata.xml`. 

|Атрибут  |Значение  |
|---------|---------|
|AssertionConsumerService     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |URI партнера по обеспечению поставщиком удостоверений, например издателя `http://www.example.com/exk10l6w90DHM0yi...`         |

Следующие утверждения должны быть настроены в маркере SAML 2.0, выданный поставщиком удостоверений:


|Атрибут  |Значение  |
|---------|---------|
|Формат идентификатора имени     |`urn:oasis:names:tc:SAML:2.0:nameid-format:persistent`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |


Ниже показано, как настроить необходимые атрибуты и утверждений с помощью AD FS в качестве примера поставщика удостоверений SAML 2.0.

### <a name="before-you-begin"></a>Перед началом работы

Сервер AD FS должен задаваться вверх и их работе перед началом этой процедуры. Для получения справки по настройке сервера AD FS, см. в разделе [создать экземпляр теста AD FS 3.0 на виртуальной машине Azure](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed).

### <a name="add-the-claim-description"></a>Добавление описания утверждения

1. На сервере AD FS, выберите **средства** > **управления AD FS**.
2. В области навигации выберите **службы** > **описания утверждений**.
3. В разделе **действия**выберите **Добавление описания утверждения**.
4. В **Добавление описания утверждения** окне укажите следующие значения:

   - **Отображаемое имя**: Постоянный идентификатор
   - **Идентификатор утверждений**: `urn:oasis:names:tc:SAML:2.0:nameid-format:persistent` 
   - Установите флажок для **опубликовать это описание утверждений в метаданных федерации как тип утверждения, принимаемый этой службой федерации**.
   - Установите флажок для **опубликовать это описание утверждений в метаданных федерации как тип утверждения, отправляемый этой службой федерации**.

5. Нажмите кнопку **ОК**.

### <a name="add-the-relying-party-trust-and-claim-rules"></a>Добавление доверия с проверяющей стороной и правила утверждений

1. На сервере AD FS, перейдите в каталог **средства** > **управления AD FS**.
2. В области навигации выберите **отношения доверия** > **доверия проверяющей стороны**.
3. В разделе **действия**выберите **добавить доверие проверяющей стороны**. 
4. В окне доверяющей стороной доверия мастера для **Выбор источника данных**, используйте параметр **Импорт данных о проверяющей стороне, опубликованных через Интернет или по локальной сети**. Укажите эти метаданные федерации URL-адрес - https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xml. Оставьте другие параметры по умолчанию. Нажмите кнопку **Закрыть**.
5. **Изменение правил для утверждений** откроется мастер.
6. В **изменение правил для утверждений** мастера выберите **добавить правило**. В **выберите тип правила**выберите **отправлять атрибуты LDAP как утверждений**. Щелкните **Далее**.
7. В **Настройка правил утверждений**, укажите следующие значения: 

   - **Имя правила утверждения**: Правило для утверждений электронной почты 
   - **Хранилище атрибутов**: Active Directory 
   - **Атрибут LDAP**: Адреса электронной почты 
   - **Тип исходящего утверждения**: Адрес электронной почты

8. Выберите **Готово**.
9. **Изменение правил для утверждений** окно будет отображаться новое правило. Нажмите кнопку **Применить**. 
10. Нажмите кнопку **ОК**.  

### <a name="create-an-email-transform-rule"></a>Создать правило преобразования электронной почты
1. Перейдите к **изменение правил для утверждений** и нажмите кнопку **добавить правило**. В **выберите тип правила**выберите **преобразование входящего утверждения** и нажмите кнопку **Далее**. 
2. В **Настройка правил утверждений**, укажите следующие значения: 

   - **Имя правила утверждения**: Правила преобразования электронной почты 
   - **Тип входящего утверждения**: Адрес электронной почты 
   - **Тип исходящего утверждения**: Идентификатор имени 
   - **Исходящее имя формата идентификатора**: Постоянный идентификатор 
   - Щелкните **Пройти по всем значениям утверждений**.

3. Нажмите кнопку **Готово** 
4. **Изменение правил для утверждений** окне будут показаны новые правила. Нажмите кнопку **Применить**. 
5. Последовательно выберите **ОК**. Сервер AD FS теперь настроен для прямую федерацию по протоколу SAML 2.0.

## <a name="configure-ad-fs-for-ws-fed-direct-federation"></a>Настройка AD FS для WS-Fed прямую федерацию 
Azure AD B2B можно настроить в федерацию с поставщиками удостоверений, использующих протокол WS-Fed с определенными требованиями, перечисленных ниже. В настоящее время два поставщика WS-Fed были протестированы для совместимости с Azure AD, включают AD FS и Shibboleth. Здесь мы будем использовать службы федерации Active Directory (AD FS) в качестве примера поставщика удостоверений WS-Fed. Дополнительные сведения об установлении доверия с проверяющей стороной между поставщик WS-Fed совместимые с Azure AD Загрузите документы совместимости поставщика удостоверений Azure AD.

Чтобы настроить прямую федерацию, следующие атрибуты должно быть получено из поставщика удостоверений сообщения WS-Fed. Эти атрибуты можно настроить путем связывания службе маркеров безопасности в сети XML-файл или ввести их вручную. Шаг 12 в [создать экземпляр теста AD FS](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed) описывает способы поиска конечных точек AD FS или как создавать URL-адрес метаданных, например `https://fs.iga.azure-test.net/federationmetadata/2007-06/federationmetadata.xml`.
 
|Атрибут  |Значение  |
|---------|---------|
|PassiveRequestorEndpoint     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |URI партнера по обеспечению поставщиком удостоверений, например издателя `http://www.example.com/exk10l6w90DHM0yi...`         |

Требуемые заявки для WS-Fed токен, выданный службой поставщика удостоверений:

|Атрибут  |Значение  |
|---------|---------|
|ImmutableID     |`http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |

Ниже показано, как настроить необходимые атрибуты и утверждений, используя AD FS в качестве примера поставщика удостоверений WS-Fed.

### <a name="before-you-begin"></a>Перед началом работы
Сервер AD FS должен задаваться вверх и их работе перед началом этой процедуры. Для получения справки по настройке сервера AD FS, см. в разделе [создать экземпляр теста AD FS 3.0 на виртуальной машине Azure](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed).


### <a name="add-the-relying-party-trust-and-claim-rules"></a>Добавление доверия с проверяющей стороной и правила утверждений 
1. На сервере AD FS, перейдите в каталог **средства** > **управления AD FS**. 
1. В области навигации выберите **отношения доверия** > **доверия проверяющей стороны**. 
1. В разделе **действия**выберите **добавить доверие проверяющей стороны**.  
1. Проверяющая сторона доверия мастера для добавления **Выбор источника данных**, используйте параметр **Импорт данных о проверяющей стороне, опубликованных через Интернет или по локальной сети**. Укажите этот URL-адрес метаданных федерации: `https://nexus.microsoftonline-p.com/federationmetadata/2007-06/federationmetadata.xml`.  Оставьте другие параметры по умолчанию. Нажмите кнопку **Закрыть**.
1. **Изменение правил для утверждений** откроется мастер. 
1. В **изменение правил для утверждений** мастера выберите **добавить правило**. В **выберите тип правила**выберите **Отправка утверждений с помощью настраиваемого правила**. Щелкните *Далее*. 
1. В **Настройка правил утверждений**, укажите следующие значения:

   - **Имя правила утверждения**: Неизменяемый идентификатор проблемы  
   - **Настраиваемое правило**: `c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"] => issue(store = "Active Directory", types = ("http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID"), query = "samAccountName={0};objectGUID;{1}", param = regexreplace(c.Value, "(?<domain>[^\\]+)\\(?<user>.+)", "${user}"), param = c.Value);`

1. Выберите **Готово**. 
1. **Изменение правил для утверждений** окно будет отображаться новое правило. Нажмите кнопку **Применить**.  
1. В том же **изменение правил для утверждений** мастера выберите **добавить правило**. В **тип правила Cohose**выберите **отправлять атрибуты LDAP как утверждений**. Щелкните **Далее**.
1. В **Настройка правил утверждений**, укажите следующие значения: 

   - **Имя правила утверждения**: Правило для утверждений электронной почты  
   - **Хранилище атрибутов**: Active Directory  
   - **Атрибут LDAP**: Адреса электронной почты  
   - **Тип исходящего утверждения**: Адрес электронной почты 

1.  Выберите **Готово**. 
1.  **Изменение правил для утверждений** окно будет отображаться новое правило. Нажмите кнопку **Применить**.  
1.  Последовательно выберите **ОК**. Сервер AD FS теперь настроен для прямую федерацию с помощью WS-Fed.

## <a name="next-steps"></a>Дальнейшие действия
Далее вам необходимо [настроить прямую федерацию в Azure AD](direct-federation.md#step-2-configure-direct-federation-in-azure-ad) на портале Azure AD или с помощью PowerShell. 
