---
title: Настройка прямой Федерации с помощью AD FS для B2B — Azure AD
description: Узнайте, как настроить AD FS в качестве поставщика удостоверений для прямой Федерации, чтобы гости могли входить в приложения Azure AD.
services: active-directory
ms.service: active-directory
ms.subservice: B2B
ms.topic: conceptual
ms.date: 07/01/2019
ms.author: mimart
author: msmimart
manager: celestedg
ms.reviewer: mal
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: e350d6338b6ca589ab18d068ef6a314363fe205c
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "74272834"
---
# <a name="example-direct-federation-with-active-directory-federation-services-ad-fs-preview"></a>Пример: прямая Федерация с службы федерации Active Directory (AD FS) (AD FS) (Предварительная версия)
|     |
| --- |
| Direct Federation — это общедоступная Предварительная версия функции Azure Active Directory. Дополнительные сведения о предварительных версиях см. в разделе Дополнительные [условия использования для предварительных версий Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).|
|     |

В этой статье описывается, как настроить [прямую федерацию](direct-federation.md) с помощью службы федерации Active Directory (AD FS) (AD FS) в качестве поставщика удостоверений SAML 2,0 или WS-подач. Для поддержки прямой Федерации необходимо настроить определенные атрибуты и утверждения в поставщике удостоверений. Чтобы продемонстрировать, как настроить поставщик удостоверений для прямой Федерации, в качестве примера мы будем использовать службы федерации Active Directory (AD FS) (AD FS). Мы покажем, как настроить AD FS как поставщик удостоверений SAML и как поставщик удостоверений WS-подач.

> [!NOTE]
> В этой статье описывается, как настроить AD FS для SAML и WS-подача в целях иллюстрации. Для интеграции с прямыми федерациями, в которой AD FS поставщик удостоверений, рекомендуется использовать WS-подач в качестве протокола. 

## <a name="configure-ad-fs-for-saml-20-direct-federation"></a>Настройка AD FS для SAML 2,0 Direct Federation
Azure AD B2B можно настроить для создания Федерации с поставщиками удостоверений, которые используют протокол SAML с особыми требованиями, перечисленными ниже. Чтобы проиллюстрировать шаги настройки SAML, в этом разделе показано, как настроить AD FS для SAML 2,0. 

Чтобы настроить прямую федерацию, в ответе SAML 2,0 от поставщика удостоверений должны быть получены следующие атрибуты. Эти атрибуты можно настроить путем связывания с XML-файлом службы маркеров безопасности в сети или путем ввода их вручную. Шаг 12 в разделе [Создание экземпляра AD FS тестирования](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed) описывает поиск конечных точек AD FS или создание URL-адреса метаданных, например `https://fs.iga.azure-test.net/federationmetadata/2007-06/federationmetadata.xml`. 

|Атрибут  |Значение  |
|---------|---------|
|AssertionConsumerService     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |URI издателя IdP партнера, например`http://www.example.com/exk10l6w90DHM0yi...`         |

Следующие утверждения должны быть настроены в токене SAML 2,0, выданном поставщиком удостоверений:


|Атрибут  |Значение  |
|---------|---------|
|Формат NameID     |`urn:oasis:names:tc:SAML:2.0:nameid-format:persistent`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |


В следующем разделе показано, как настроить необходимые атрибуты и утверждения с помощью AD FS в качестве примера поставщика удостоверений SAML 2,0.

### <a name="before-you-begin"></a>Перед началом

Сервер AD FS должен быть уже настроен и работоспособен перед началом этой процедуры. Сведения о настройке сервера AD FS см. [в статье Создание экземпляра test AD FS 3,0 на виртуальной машине Azure](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed).

### <a name="add-the-claim-description"></a>Добавление описания утверждения

1. На AD FS сервере выберите **Сервис** > **AD FS управление**.
2. В области навигации выберите**описания утверждений** **службы** > .
3. В разделе **действия**выберите **Добавить описание утверждения**.
4. В окне **Добавление описания утверждения** укажите следующие значения:

   - **Отображаемое имя**: постоянный идентификатор
   - **Идентификатор утверждения**:`urn:oasis:names:tc:SAML:2.0:nameid-format:persistent` 
   - Установите флажок **опубликовать это описание утверждения в метаданных федерации в качестве типа утверждения, который может принимать эта служба федерации**.
   - Установите флажок **опубликовать это описание утверждения в метаданных федерации в качестве типа утверждения, который может быть отправлен этой службой федерации**.

5. Нажмите кнопку **ОК**.

### <a name="add-the-relying-party-trust-and-claim-rules"></a>Добавление правил доверия и утверждений проверяющей стороны

1. На AD FS сервере выберите **Сервис** > **AD FS управление**.
2. В области навигации выберите **доверительные отношения** > отношения доверия с**проверяющей стороной**.
3. В разделе **действия**выберите **Добавить отношение доверия с проверяющей стороной**. 
4. В мастере добавления отношения доверия с проверяющей стороной для **параметра Выбор источника данных**используйте параметр **Импорт данных о проверяющей стороне, опубликованной в Интернете или в локальной сети**. Укажите этот URL-адрес метаданных https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xmlФедерации —. Оставьте другие параметры по умолчанию. Выберите **Закрыть**.
5. Откроется мастер **изменения правил утверждений** .
6. В мастере **изменения правил утверждений** выберите **Добавить правило**. В окне **Выбор типа правила**выберите **Отправить атрибуты LDAP в качестве утверждений**. Выберите **Далее**.
7. В окне **Настройка правила для утверждений**укажите следующие значения. 

   - **Имя правила утверждения**: правило утверждения по электронной почте 
   - **Хранилище атрибутов**: Active Directory 
   - **Атрибут LDAP**: адреса электронной почты 
   - **Тип исходящего утверждения**: адрес электронной почты

8. Нажмите кнопку **Готово**.
9. В окне **изменение правил утверждений** отобразится новое правило. Нажмите кнопку **Применить**. 
10. Нажмите кнопку **ОК**.  

### <a name="create-an-email-transform-rule"></a>Создание правила преобразования электронной почты
1. Перейдите к разделу **изменение правил утверждений** и нажмите кнопку **Добавить правило**. В окне **Выбор типа правила**выберите **преобразовать входящее утверждение** и нажмите кнопку **Далее**. 
2. В окне **Настройка правила для утверждений**укажите следующие значения. 

   - **Имя правила утверждения**: правило преобразования электронной почты 
   - **Тип входящего утверждения**: адрес электронной почты 
   - **Тип исходящего утверждения**: ИД имени 
   - **Формат идентификатора исходящего имени**: постоянный идентификатор 
   - Выберите **передавать все значения утверждений**.

3. Нажмите кнопку **Готово**. 
4. В окне **изменение правил утверждений** отобразятся новые правила. Нажмите кнопку **Применить**. 
5. Нажмите кнопку **ОК**. Сервер AD FS теперь настроен для прямой Федерации с помощью протокола SAML 2,0.

## <a name="configure-ad-fs-for-ws-fed-direct-federation"></a>Настройка AD FS для прямой федерации WS-подачи 
Azure AD B2B можно настроить для создания Федерации с поставщиками удостоверений, которые используют протокол WS-подач с указанными ниже требованиями. В настоящее время два поставщика WS-подач были протестированы на совместимость с Azure AD, включая AD FS и Shibboleth. Здесь мы будем использовать службы федерации Active Directory (AD FS) (AD FS) в качестве примера поставщика удостоверений WS-подач. Дополнительные сведения о установлении отношения доверия между проверяющей стороной между поставщиком WS-подачи и Azure AD см. в статье документация по совместимости поставщика удостоверений Azure AD.

Чтобы настроить прямую федерацию, в сообщении WS-подача от поставщика удостоверений должны быть получены следующие атрибуты. Эти атрибуты можно настроить путем связывания с XML-файлом службы маркеров безопасности в сети или путем ввода их вручную. Шаг 12 в разделе [Создание экземпляра AD FS тестирования](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed) описывает поиск конечных точек AD FS или создание URL-адреса метаданных, например `https://fs.iga.azure-test.net/federationmetadata/2007-06/federationmetadata.xml`.
 
|Атрибут  |Значение  |
|---------|---------|
|пассиверекуесторендпоинт     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |URI издателя IdP партнера, например`http://www.example.com/exk10l6w90DHM0yi...`         |

Обязательные утверждения для токена WS-подач, выданного IdP:

|Атрибут  |Значение  |
|---------|---------|
|ImmutableID     |`http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |

В следующем разделе показано, как настроить необходимые атрибуты и утверждения с помощью AD FS в качестве примера поставщика удостоверений WS-подач.

### <a name="before-you-begin"></a>Перед началом
Сервер AD FS должен быть уже настроен и работоспособен перед началом этой процедуры. Сведения о настройке сервера AD FS см. [в статье Создание экземпляра test AD FS 3,0 на виртуальной машине Azure](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed).


### <a name="add-the-relying-party-trust-and-claim-rules"></a>Добавление правил доверия и утверждений проверяющей стороны 
1. На AD FS сервере выберите **Сервис** > **AD FS управление**. 
1. В области навигации выберите **доверительные отношения** > отношения доверия с**проверяющей стороной**. 
1. В разделе **действия**выберите **Добавить отношение доверия с проверяющей стороной**.  
1. В мастере добавления отношения доверия с проверяющей стороной в поле **Выбор источника данных**используйте параметр **Импорт данных о проверяющей стороне, опубликованной в Интернете или в локальной сети**. Укажите URL-адрес метаданных федерации `https://nexus.microsoftonline-p.com/federationmetadata/2007-06/federationmetadata.xml`:.  Оставьте другие параметры по умолчанию. Выберите **Закрыть**.
1. Откроется мастер **изменения правил утверждений** . 
1. В мастере **изменения правил утверждений** выберите **Добавить правило**. В окне **Выбор типа правила**выберите **Отправить утверждения с помощью настраиваемого правила**. Выберите *Далее*. 
1. В окне **Настройка правила для утверждений**укажите следующие значения.

   - **Имя правила утверждений**: выдача неизменяемого идентификатора  
   - **Настраиваемое правило**:`c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"] => issue(store = "Active Directory", types = ("http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID"), query = "samAccountName={0};objectGUID;{1}", param = regexreplace(c.Value, "(?<domain>[^\\]+)\\(?<user>.+)", "${user}"), param = c.Value);`

1. Нажмите кнопку **Готово**. 
1. В окне **изменение правил утверждений** отобразится новое правило. Нажмите кнопку **Применить**.  
1. В мастере **изменения правил утверждений** выберите **Добавить правило**. В списке **тип правила Соберите**выберите **Отправить атрибуты LDAP в качестве утверждений**. Выберите **Далее**.
1. В окне **Настройка правила для утверждений**укажите следующие значения. 

   - **Имя правила утверждения**: правило утверждения по электронной почте  
   - **Хранилище атрибутов**: Active Directory  
   - **Атрибут LDAP**: адреса электронной почты  
   - **Тип исходящего утверждения**: адрес электронной почты 

1.  Нажмите кнопку **Готово**. 
1.  В окне **изменение правил утверждений** отобразится новое правило. Нажмите кнопку **Применить**.  
1.  Нажмите кнопку **ОК**. Сервер AD FS теперь настроен для прямой Федерации с помощью WS-подач.

## <a name="next-steps"></a>Дальнейшие действия
Далее вы [настроите прямую федерацию в Azure AD](direct-federation.md#step-2-configure-direct-federation-in-azure-ad) на портале Azure AD или с помощью PowerShell. 
