---
title: Создать прямую федерацию с AD FS для B2B - Azure AD
description: Узнайте, как настроить AD FS в качестве поставщика идентификационных данных для прямой федерации, чтобы гости могли войти в приложения Azure AD
services: active-directory
ms.service: active-directory
ms.subservice: B2B
ms.topic: conceptual
ms.date: 07/01/2019
ms.author: mimart
author: msmimart
manager: celestedg
ms.reviewer: mal
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: e350d6338b6ca589ab18d068ef6a314363fe205c
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74272834"
---
# <a name="example-direct-federation-with-active-directory-federation-services-ad-fs-preview"></a>Пример: Прямая федерация с службами Федерации активных каталогов (AD FS) (предварительный просмотр)
|     |
| --- |
| Прямая федерация — это общедоступное функцию предварительного просмотра Active Directory Azure. Для получения дополнительной информации о предварительных просмотрах [см.](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)|
|     |

В этой статье описывается, как создать [прямую федерацию](direct-federation.md) с использованием активных служб Федерации каталогов (AD FS) в качестве поставщика идентификационных данных SAML 2.0 или WS-Fed. Для поддержки прямой федерации определенные атрибуты и требования должны быть настроены в поставщике идентификационных данных. Чтобы проиллюстрировать, как настроить поставщика идентификационных данных для прямой федерации, мы будем использовать в качестве примера службы Active Directory Federation Services (AD FS). Мы покажем, как настроить AD FS как поставщика идентификационных данных SAML, так и поставщика идентификационных данных WS-Fed.

> [!NOTE]
> В этой статье описывается, как настроить AD FS для SAML и WS-Fed для иллюстраций. Для прямой интеграции федераций, где поставщиком идентификационных данных является AD FS, мы рекомендуем использовать WS-Fed в качестве протокола. 

## <a name="configure-ad-fs-for-saml-20-direct-federation"></a>Настройка AD FS для прямой федерации SAML 2.0
Azure AD B2B можно настроить для федерации с поставщиками идентификационных данных, которые используют протокол SAML с конкретными требованиями, перечисленными ниже. Чтобы проиллюстрировать шаги конфигурации SAML, в этом разделе показано, как настроить AD FS для SAML 2.0. 

Чтобы создать прямую федерацию, следующие атрибуты должны быть получены в ответе SAML 2.0 от поставщика идентификационных данных. Эти атрибуты можно настроить путем ссылки на онлайн-сервис безопасности XML или ввод их вручную. Шаг 12 в [создании тестового экземпляра AD FS](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed) описывает, например, `https://fs.iga.azure-test.net/federationmetadata/2007-06/federationmetadata.xml`как найти конечные точки AD FS или как создать URL-адрес метаданных. 

|Атрибут  |Значение  |
|---------|---------|
|AssertionConsumerService     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |Эмитент URI партнера IdP, например`http://www.example.com/exk10l6w90DHM0yi...`         |

Следующие претензии должны быть настроены в токене SAML 2.0, выпущенном поставщиком идентификационных данных:


|Атрибут  |Значение  |
|---------|---------|
|Формат NameID     |`urn:oasis:names:tc:SAML:2.0:nameid-format:persistent`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |


В следующем разделе показано, как настроить требуемые атрибуты и претензии с помощью AD FS в качестве примера поставщика идентификационных данных SAML 2.0.

### <a name="before-you-begin"></a>Перед началом

Сервер AD FS уже должен быть настроен и функционирует, прежде чем начать эту процедуру. Для получения помощи в настройке [Create a test AD FS 3.0 instance on an Azure virtual machine](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed)сервера AD FS см.

### <a name="add-the-claim-description"></a>Добавить описание претензии

1. На сервере AD FS выберите **управление Инструментами** > **AD FS.**
2. В навигационном стеле выберите**описания претензий службы.** **Service** > 
3. В соответствии с **действиями,** выберите **Добавить описание претензии**.
4. В окне **описания претензии** укажите следующие значения:

   - **Имя дисплея**: Постоянный идентификатор
   - **Идентификатор претензий:**`urn:oasis:names:tc:SAML:2.0:nameid-format:persistent` 
   - Выберите флажок для **публикации этого описания претензий в метаданных федерации как тип претензии, который может принять эта служба федерации.**
   - Выберите флажок для **публикации этого описания претензий в метаданных федерации в качестве типа претензии, который эта служба федерации может отправить.**

5. Нажмите кнопку **ОК**.

### <a name="add-the-relying-party-trust-and-claim-rules"></a>Добавьте правила доверия и претензий полагаться на участников

1. На сервере AD FS **Tools** > перейдите к**управлению Tools AD FS.**
2. В навигационном панели выберите **Доверительные отношения,** > **опираясь на доверие.**
3. В соответствии с **действиями,** выберите **Добавить Relying Party Trust.** 
4. В добавлении опирающейся стороны доверяют мастеру для **Select Data Source,** используйте данные импорта опции **о полагающейся стороне, опубликованные в Интернете или в локальной сети.** Укажите этот URL-адрес https://nexus.microsoftonline-p.com/federationmetadata/saml20/federationmetadata.xmlметаданных федерации- . Оставьте другие выборы по умолчанию. Выберите **Закрыть**.
5. Открывается мастер **правил edit Claim.**
6. В мастере **правил изменения претензий** выберите **Правило добавления.** В **типе правила выберите** **Отправить атрибуты LDAP в качестве претензий.** Нажмите кнопку **Далее**.
7. В **правиле настройки претензии**укажите следующие значения: 

   - **Имя правила претензии**: Правило претензии по электронной почте 
   - **Магазин атрибутов**: Активный каталог 
   - **Атрибут LDAP**: E-Mail-Адреса 
   - **Исходящие тип претензии**: Адрес электронной почты

8. Нажмите кнопку **Готово**.
9. В окне **правил изменения претензий** будет отображаться новое правило. Щелкните **Применить**. 
10. Нажмите кнопку **ОК**.  

### <a name="create-an-email-transform-rule"></a>Создание правила преобразования электронной почты
1. Перейти к **правилу изменения претензий** и нажмите **Добавить правило**. В **выберите тип правила,** выберите **Преобразование входящие претензии** и нажмите **далее**. 
2. В **правиле настройки претензии**укажите следующие значения: 

   - **Имя правила претензии**: Правило преобразования электронной почты 
   - **Входящий тип претензии**: Адрес электронной почты 
   - **Исходящие типы претензий**: Идентификатор имени 
   - **Исходящие идентификаторы имен формата**: Постоянный идентификатор 
   - Выберите **Pass через все значения претензий.**

3. Нажмите кнопку **Готово**. 
4. В окне **правил edit Claim** будут отображаться новые правила. Щелкните **Применить**. 
5. Нажмите кнопку **ОК**. Сервер AD FS теперь настроен для прямой федерации с использованием протокола SAML 2.0.

## <a name="configure-ad-fs-for-ws-fed-direct-federation"></a>Настройка AD FS для прямой федерации WS-Fed 
Azure AD B2B можно настроить для федерации с поставщиками идентификационных данных, которые используют протокол WS-Fed с конкретными требованиями, перечисленными ниже. В настоящее время два провайдера WS-Fed прошли тестирование на совместимость с Azure AD, включая AD FS и Shibboleth. Здесь мы будем использовать службы Active Directory Federation (AD FS) в качестве примера поставщика идентификационных данных WS-Fed. Для получения дополнительной информации о создании доверия стороны от зависимости от зависимости от WS-Fed с Azure AD загрузите документы о совместимости поставщиков идентификационных данных Azure AD.

Чтобы создать прямую федерацию, следующие атрибуты должны быть получены в сообщении WS-Fed от поставщика идентификационных данных. Эти атрибуты можно настроить путем ссылки на онлайн-сервис безопасности XML или ввод их вручную. Шаг 12 в [создании тестового экземпляра AD FS](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed) описывает, например, `https://fs.iga.azure-test.net/federationmetadata/2007-06/federationmetadata.xml`как найти конечные точки AD FS или как создать URL-адрес метаданных.
 
|Атрибут  |Значение  |
|---------|---------|
|ПассивныйЗапросорEndpoint     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |Эмитент URI партнера IdP, например`http://www.example.com/exk10l6w90DHM0yi...`         |

Обязательные претензии к токену WS-Fed, выданному IdP:

|Атрибут  |Значение  |
|---------|---------|
|НеизменяемыйID     |`http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |

В следующем разделе показано, как настроить требуемые атрибуты и претензии с использованием AD FS в качестве примера поставщика идентификационных данных WS-Fed.

### <a name="before-you-begin"></a>Перед началом
Сервер AD FS уже должен быть настроен и функционирует, прежде чем начать эту процедуру. Для получения помощи в настройке [Create a test AD FS 3.0 instance on an Azure virtual machine](https://medium.com/in-the-weeds/create-a-test-active-directory-federation-services-3-0-instance-on-an-azure-virtual-machine-9071d978e8ed)сервера AD FS см.


### <a name="add-the-relying-party-trust-and-claim-rules"></a>Добавьте правила доверия и претензий полагаться на участников 
1. На сервере AD FS **Tools** > перейдите к**управлению Tools AD FS.** 
1. В навигационном панели выберите **Доверительные отношения,** > **опираясь на доверие.** 
1. В соответствии с **действиями,** выберите **Добавить Relying Party Trust.**  
1. В добавлении опирающихся стороны доверия мастера, для **выбора источника данных**, использовать опцию **Импорт данных о полагающейся стороной, опубликованной в Интернете или в локальной сети.** Укажите этот URL-адрес `https://nexus.microsoftonline-p.com/federationmetadata/2007-06/federationmetadata.xml`метаданных федерации: .  Оставьте другие выборы по умолчанию. Выберите **Закрыть**.
1. Открывается мастер **правил edit Claim.** 
1. В мастере **правил изменения претензий** выберите **Правило добавления.** В **типе правила выберите** **Отправить претензии с помощью пользовательского правила.** Нажмите кнопку *Далее*. 
1. В **правиле настройки претензии**укажите следующие значения:

   - **Имя правила претензии**: Выпуск неизменяемого идентификатора  
   - **Пользовательское правило**:`c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"] => issue(store = "Active Directory", types = ("http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID"), query = "samAccountName={0};objectGUID;{1}", param = regexreplace(c.Value, "(?<domain>[^\\]+)\\(?<user>.+)", "${user}"), param = c.Value);`

1. Нажмите кнопку **Готово**. 
1. В окне **правил изменения претензий** будет отображаться новое правило. Щелкните **Применить**.  
1. В том же мастере **правил изменения претензий** выберите **Правило добавления.** В **типе правила Cohose**выберите **Отправить атрибуты LDAP в качестве претензий.** Нажмите кнопку **Далее**.
1. В **правиле настройки претензии**укажите следующие значения: 

   - **Имя правила претензии**: Правило претензии по электронной почте  
   - **Магазин атрибутов**: Активный каталог  
   - **Атрибут LDAP**: E-Mail-Адреса  
   - **Исходящие тип претензии**: Адрес электронной почты 

1.  Нажмите кнопку **Готово**. 
1.  В окне **правил изменения претензий** будет отображаться новое правило. Щелкните **Применить**.  
1.  Нажмите кнопку **ОК**. Сервер AD FS теперь настроен для прямой федерации с помощью WS-Fed.

## <a name="next-steps"></a>Дальнейшие действия
Далее вы будете [настраивать прямую федерацию в Azure AD](direct-federation.md#step-2-configure-direct-federation-in-azure-ad) либо на портале Azure AD, либо с помощью PowerShell. 
