---
title: Прямая Федерация с поставщиком удостоверений для B2B — Azure AD
description: Прямое Федерацию с помощью поставщика удостоверений SAML или WS-подач, чтобы гости могли входить в приложения Azure AD.
services: active-directory
ms.service: active-directory
ms.subservice: B2B
ms.topic: conceptual
ms.date: 05/07/2020
ms.author: mimart
author: msmimart
manager: celestedg
ms.reviewer: mal
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: 474d2e0c31eed852ba96780ca996eca632bd5842
ms.sourcegitcommit: a6d477eb3cb9faebb15ed1bf7334ed0611c72053
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2020
ms.locfileid: "82926992"
---
# <a name="direct-federation-with-ad-fs-and-third-party-providers-for-guest-users-preview"></a>Прямая Федерация с AD FS и сторонними поставщиками для гостевых пользователей (Предварительная версия)
|     |
| --- |
| Direct Federation — это общедоступная Предварительная версия функции Azure Active Directory. Дополнительные сведения о предварительных версиях см. в разделе Дополнительные [условия использования для предварительных версий Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).|
|     |

В этой статье описывается, как настроить прямую федерацию с другой организацией для совместной работы B2B. Вы можете настроить прямую федерацию с любой организацией, чей поставщик удостоверений (IdP) поддерживает протокол SAML 2,0 или WS-подача.
Когда вы настраиваете прямую федерацию с IdP партнера, новые гостевые пользователи из этого домена могут использовать собственную учетную запись организации, управляемую IdP, чтобы войти в клиент Azure AD и начать сотрудничество с вами. Гостевому пользователю не нужно создавать отдельную учетную запись Azure AD.
> [!NOTE]
> Гостевые пользователи Федерации должны входить в систему с помощью ссылки, включающей контекст клиента (например, `https://myapps.microsoft.com/?tenantid=<tenant id>` или `https://portal.azure.com/<tenant id>`или в случае проверенного домена `https://myapps.microsoft.com/\<verified domain>.onmicrosoft.com`). Прямые ссылки на приложения и ресурсы также работают, если они содержат контекст клиента. Пользователи Direct Federation в настоящее время не могут выполнить вход, используя общие конечные точки, не имеющие контекста клиента. Например, использование `https://myapps.microsoft.com`, `https://portal.azure.com`или `https://teams.microsoft.com` приведет к ошибке.
 
## <a name="when-is-a-guest-user-authenticated-with-direct-federation"></a>Когда гостевой пользователь проходит проверку подлинности с помощью прямой Федерации?
После настройки прямой интеграции с Организацией все новые приглашенные гостевые пользователи будут проходить проверку подлинности с помощью прямой Федерации. Важно отметить, что Настройка Direct Federation не меняет метод проверки подлинности для гостевых пользователей, которые уже активировали приглашение. Ниже приводится несколько примеров.
 - Если гостевые пользователи уже активировали приглашения, а затем вы настроили прямую федерацию с их организацией, эти гостевые пользователи будут по прежнему использовать тот же метод проверки подлинности, который они использовали перед настройкой прямой Федерации.
 - Если вы настроили прямую федерацию с партнерской организацией и приглашаете гостевых пользователей, а затем Партнерская организация позже перейдет в Azure AD, то гостевые пользователи, которые уже активировали приглашения, продолжат использовать прямую федерацию при условии, что политика Direct Federation в клиенте существует.
 - При удалении прямой Федерации с партнерской организацией все гостевые пользователи, которые сейчас используют прямую федерацию, не смогут войти в систему.

В любом из этих сценариев вы можете обновить метод проверки подлинности гостевого пользователя, удалив учетную запись гостевого пользователя из каталога и перенаследуя их.

Прямая Федерация привязана к доменным пространствам имен, таким как contoso.com и fabrikam.com. При установке прямой конфигурации федерации с AD FS или сторонними IdP организации связывают одно или несколько пространств имен домена с этими поставщиков удостоверений. 

## <a name="end-user-experience"></a>Взаимодействие с конечным пользователем 
При использовании прямой Федерации гостевые пользователи входят в клиент Azure AD с помощью собственной учетной записи организации. Когда они обращаются к общим ресурсам и запрашивают вход, прямые пользователи Федерации перенаправляются в IdP. После успешного входа они возвращаются в Azure AD для доступа к ресурсам. Маркеры обновления пользователей прямой Федерации действительны в течение 12 часов, [Длина по умолчанию для токена транзитного обновления](../develop/active-directory-configurable-token-lifetimes.md#exceptions) в Azure AD. Если в Федеративной IdP включен единый вход, пользователь получит единый вход и не увидит запрос на вход после первоначальной проверки подлинности.

## <a name="limitations"></a>Ограничения

### <a name="dns-verified-domains-in-azure-ad"></a>Проверенные DNS-домены в Azure AD
Домен, с которым вы хотите создать федерацию, ***не*** должен быть проверен DNS в Azure AD. Вы можете настроить прямую федерацию с неуправляемыми клиентами Azure AD (проверенные по электронной почте или "вирусами"), так как они не проверены DNS.

### <a name="authentication-url"></a>URL-адрес проверки подлинности
Прямая Федерация разрешена только для политик, в которых домен URL-адреса проверки подлинности соответствует целевому домену, или если URL-адрес проверки подлинности является одним из этих разрешенных поставщиков удостоверений (этот список может быть изменен):

-   accounts.google.com
-   pingidentity.com
-   login.pingone.com
-   okta.com
-   oktapreview.com
-   okta-emea.com
-   my.salesforce.com
-   federation.exostar.com
-   federation.exostartest.com

Например, при настройке прямой Федерации для **Fabrikam.com**URL-адрес `https://fabrikam.com/adfs` проверки подлинности будет проходить проверку. Узел в том же домене также будет передавать, например `https://sts.fabrikam.com/adfs`. Однако URL-адрес `https://fabrikamconglomerate.com/adfs` проверки подлинности или `https://fabrikam.com.uk/adfs` для того же домена не передается.

### <a name="signing-certificate-renewal"></a>Подписывание продления сертификата
Если указать URL-адрес метаданных в параметрах поставщика удостоверений, Azure AD автоматически обновит сертификат подписи по истечении срока его действия. Тем не менее, если сертификат поворачивается по какой-либо причине до истечения срока действия или если вы не предложит адрес метаданных, Azure AD не сможет продлить его. В этом случае вам потребуется обновить сертификат подписи вручную.

### <a name="limit-on-federation-relationships"></a>Ограничение отношений Федерации
В настоящее время поддерживается не более 1 000 связей Федерации. Это ограничение включает как [внутренние Федерации](https://docs.microsoft.com/powershell/module/msonline/set-msoldomainfederationsettings?view=azureadps-1.0) , так и прямые Федерации.

### <a name="limit-on-multiple-domains"></a>Ограничение для нескольких доменов
Сейчас мы не поддерживаем прямую федерацию с несколькими доменами из одного и того же клиента.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы
### <a name="can-i-set-up-direct-federation-with-a-domain-for-which-an-unmanaged-email-verified-tenant-exists"></a>Можно ли настроить прямую федерацию с доменом, для которого существует неуправляемый клиент (с проверкой по электронной почте)? 
Да. Если домен не был проверен и клиент не прошел [администратору перенаправление](../users-groups-roles/domains-admin-takeover.md), можно настроить прямую федерацию с этим доменом. Неуправляемые или проверенные по электронной почте клиенты создаются, когда пользователь активирует приглашение B2B или выполняет самостоятельную регистрацию в Azure AD с помощью домена, который в настоящее время не существует. Вы можете настроить прямую федерацию с этими доменами. Если вы попытаетесь настроить прямую федерацию с доменом, проверенным DNS, либо в портал Azure, либо с помощью PowerShell, вы увидите ошибку.
### <a name="if-direct-federation-and-email-one-time-passcode-authentication-are-both-enabled-which-method-takes-precedence"></a>Если включена одновременная проверка подлинности Direct Federation и email, какой метод имеет приоритет?
Если прямая Федерация установлена в партнерской организации, она имеет приоритет над проверкой подлинности одноразового секретного кода для новых гостевых пользователей из этой Организации. Если гостевой пользователь активировал приглашение с помощью одноразовой проверки подлинности на основе секретного кода перед настройкой прямой Федерации, он будет продолжать использовать одноразовую проверку подлинности с помощью секретного кода. 
### <a name="does-direct-federation-address-sign-in-issues-due-to-a-partially-synced-tenancy"></a>Возникли ли проблемы с входом адреса прямой Федерации из-за частично синхронизированного аренды?
Нет, в этом сценарии следует использовать функцию [одноразового секретного кода по электронной почте](one-time-passcode.md) . "Частично синхронизированная Аренда" относится к клиенту Azure AD, где удостоверения локальных пользователей не полностью синхронизированы с облаком. Гостевой компьютер, удостоверение которого еще не существует в облаке, но кто пытается активировать ваше приглашение B2B, не сможет войти в систему. Функция одноразового секретного кода позволит этому гостевому входу войти в систему. Функция Direct Federation решает ситуации, когда у гостя есть собственная учетная запись организации, управляемая IdP, но у Организации нет присутствия Azure AD.

## <a name="step-1-configure-the-partner-organizations-identity-provider"></a>Шаг 1. Настройка поставщика удостоверений партнерской организации
Во-первых, партнерской организации необходимо настроить поставщик удостоверений с необходимыми утверждениями и отношениями доверия с проверяющей стороной. 

> [!NOTE]
> Чтобы продемонстрировать, как настроить поставщик удостоверений для прямой Федерации, в качестве примера мы будем использовать службы федерации Active Directory (AD FS) (AD FS). См. статью [Настройка прямой Федерации с AD FS](direct-federation-adfs.md), в которой приводятся примеры настройки AD FS в качестве поставщика удостоверений SAML 2,0 или WS-подач при подготовке к прямой интеграции.

### <a name="saml-20-configuration"></a>Конфигурация SAML 2.0

Azure AD B2B можно настроить для создания Федерации с поставщиками удостоверений, которые используют протокол SAML с особыми требованиями, перечисленными ниже. Дополнительные сведения о настройке отношения доверия между поставщиком удостоверений SAML и Azure AD см. в статье [Использование поставщика удостоверений saml 2,0 (IDP) для единого входа](https://docs.microsoft.com/azure/active-directory/hybrid/how-to-connect-fed-saml-idp).  

> [!NOTE]
> Целевой домен для прямой Федерации не должен проверяться DNS в Azure AD. Домен URL-адреса проверки подлинности должен соответствовать целевому домену, или он должен быть доменом разрешенного поставщика удостоверений. Дополнительные сведения см. в разделе [ограничения](#limitations) . 

#### <a name="required-saml-20-attributes-and-claims"></a>Обязательные атрибуты и утверждения SAML 2,0
В следующих таблицах приведены требования к конкретным атрибутам и утверждениям, которые должны быть настроены для стороннего поставщика удостоверений. Чтобы настроить прямую федерацию, в ответе SAML 2,0 от поставщика удостоверений должны быть получены следующие атрибуты. Эти атрибуты можно настроить путем связывания с XML-файлом службы маркеров безопасности в сети или путем ввода их вручную.

Обязательные атрибуты для ответа SAML 2,0 от IdP:

|Атрибут  |Значение  |
|---------|---------|
|AssertionConsumerService     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |URI издателя IdP партнера, например`http://www.example.com/exk10l6w90DHM0yi...`         |


Обязательные утверждения для токена SAML 2,0, выданного IdP:

|Атрибут  |Значение  |
|---------|---------|
|Формат NameID     |`urn:oasis:names:tc:SAML:2.0:nameid-format:persistent`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |

### <a name="ws-fed-configuration"></a>Конфигурация WS-подача 
Azure AD B2B можно настроить для создания Федерации с поставщиками удостоверений, которые используют протокол WS-подач с некоторыми конкретными требованиями, указанными ниже. В настоящее время два поставщика WS-подач были протестированы на совместимость с Azure AD, включая AD FS и Shibboleth. Дополнительные сведения о создании отношения доверия между проверяющей стороной между поставщиком WS-подачи и Azure AD [см. в документации по интеграции](https://www.microsoft.com/download/details.aspx?id=56843)STS с помощью протоколов WS.

> [!NOTE]
> Целевой домен для прямой Федерации не должен проверяться DNS в Azure AD. Домен URL-адреса проверки подлинности должен соответствовать целевому домену или домену разрешенного поставщика удостоверений. Дополнительные сведения см. в разделе [ограничения](#limitations) . 

#### <a name="required-ws-fed-attributes-and-claims"></a>Обязательные атрибуты и утверждения WS-подача

В следующих таблицах приведены требования к конкретным атрибутам и утверждениям, которые должны быть настроены для стороннего поставщика удостоверений WS-подач. Чтобы настроить прямую федерацию, в сообщении WS-подача от поставщика удостоверений должны быть получены следующие атрибуты. Эти атрибуты можно настроить путем связывания с XML-файлом службы маркеров безопасности в сети или путем ввода их вручную.

Обязательные атрибуты в сообщении WS-подача из IdP:
 
|Атрибут  |Значение  |
|---------|---------|
|пассиверекуесторендпоинт     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |URI издателя IdP партнера, например`http://www.example.com/exk10l6w90DHM0yi...`         |

Обязательные утверждения для токена WS-подач, выданного IdP:

|Атрибут  |Значение  |
|---------|---------|
|ImmutableID     |`http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |

## <a name="step-2-configure-direct-federation-in-azure-ad"></a>Шаг 2. Настройка прямой Федерации в Azure AD 
Далее вы настроите Федерацию с поставщиком удостоверений, настроенным на шаге 1 в Azure AD. Вы можете использовать портал Azure AD или PowerShell. Для вступления в силу непосредственной политики Федерации может потребоваться 5-10 минут. В течение этого времени не пытайтесь активировать приглашение для домена прямой Федерации. Ниже приведены обязательные атрибуты.
- URI-адрес издателя партнера IdP
- Конечная точка пассивной проверки подлинности партнера IdP (поддерживается только протокол HTTPS)
- Certificate

### <a name="to-configure-direct-federation-in-the-azure-ad-portal"></a>Настройка прямой Федерации на портале Azure AD

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Организационные связи**.
3. Выберите **поставщики удостоверений**, а затем щелкните **создать SAML/WS-подача IDP**.

    ![Снимок экрана, показывающий кнопку добавления нового SAML или WS-IdP](media/direct-federation/new-saml-wsfed-idp.png)

4. На странице **New SAML/WS-подача IDP** в разделе **протокол поставщика удостоверений**выберите **SAML** или **WS-подача**.

    ![Снимок экрана: кнопка "синтаксический анализ" на странице SAML или WS-IdP](media/direct-federation/new-saml-wsfed-idp-parse.png)

5. Введите имя домена партнерской организации, которое будет целевым доменным именем для прямой Федерации.
6. Можно передать файл метаданных для заполнения сведений о метаданных. Если вы решили ввести метаданные вручную, введите следующие сведения:
   - Доменное имя партнера IdP
   - Идентификатор сущности партнера IdP
   - Конечная точка пассивного запрашивающего IdP партнера
   - Certificate
   > [!NOTE]
   > URL-адрес метаданных является необязательным, но мы настоятельно рекомендуем его использовать. При предоставлении URL-адреса метаданных Azure AD может автоматически продлить сертификат подписи по истечении срока его действия. Если сертификат поворачивается по любой причине до истечения срока действия или если URL-адрес метаданных не указан, Azure AD не сможет продлить его. В этом случае вам потребуется обновить сертификат подписи вручную.

7. Нажмите кнопку **Сохранить**. 

### <a name="to-configure-direct-federation-in-azure-ad-using-powershell"></a>Настройка прямой Федерации в Azure AD с помощью PowerShell

1. Установите последнюю версию модуля Azure AD PowerShell для Graph ([AzureADPreview](https://www.powershellgallery.com/packages/AzureADPreview)). (Если вам нужны подробные инструкции, краткое руководство по добавлению гостевого пользователя включает в себя раздел [Установка последней версии модуля AzureADPreview](b2b-quickstart-invite-powershell.md#install-the-latest-azureadpreview-module).) 
2. Выполните следующую команду: 
   ```powershell
   Connect-AzureAD
   ```
1. При появлении запроса на вход войдите с помощью управляемой учетной записи глобального администратора. 
2. Выполните следующие команды, заменив значения из файла метаданных федерации. Для AD FS Server и Okta файл Федерации имеет формат FederationMetadata. XML, например: `https://sts.totheclouddemo.com/federationmetadata/2007-06/federationmetadata.xml`. 

   ```powershell
   $federationSettings = New-Object Microsoft.Open.AzureAD.Model.DomainFederationSettings
   $federationSettings.PassiveLogOnUri ="https://sts.totheclouddemo.com/adfs/ls/"
   $federationSettings.LogOffUri = $federationSettings.PassiveLogOnUri
   $federationSettings.IssuerUri = "http://sts.totheclouddemo.com/adfs/services/trust"
   $federationSettings.MetadataExchangeUri="https://sts.totheclouddemo.com/adfs/services/trust/mex"
   $federationSettings.SigningCertificate= <Replace with X509 signing cert’s public key>
   $federationSettings.PreferredAuthenticationProtocol="WsFed" OR "Samlp"
   $domainName = <Replace with domain name>
   New-AzureADExternalDomainFederation -ExternalDomainName $domainName  -FederationSettings $federationSettings
   ```

## <a name="step-3-test-direct-federation-in-azure-ad"></a>Шаг 3. Тестирование прямой Федерации в Azure AD
Теперь протестируйте прямую настройку Федерации, приглашая нового гостевого пользователя B2B. Дополнительные сведения см. [в разделе Добавление пользователей службы совместной работы Azure AD B2B в портал Azure](add-users-administrator.md).
 
## <a name="how-do-i-edit-a-direct-federation-relationship"></a>Разделы справки изменить связь между прямыми федерациями?

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Организационные связи**.
3. Выбор **поставщиков удостоверений**
4. В разделе **поставщики удостоверений SAML/WS-подача**выберите поставщика.
5. В области сведения о поставщике удостоверений обновите значения.
6. Нажмите кнопку **Сохранить**.


## <a name="how-do-i-remove-direct-federation"></a>Разделы справки удалить прямую федерацию?
Вы можете удалить настройку Direct Federation. В этом случае прямые гостевые пользователи Федерации, которые уже активировали свои приглашения, не смогут войти в систему. Но вы можете снова предоставить им доступ к ресурсам, удалив их из каталога и повторно приглашая. Чтобы удалить прямую федерацию с поставщиком удостоверений на портале Azure AD, сделайте следующее:

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Организационные связи**.
3. Выберите **поставщики удостоверений**.
4. Выберите поставщик удостоверений и нажмите кнопку **Удалить**. 
5. Выберите **Да**, чтобы подтвердить удаление. 

Чтобы удалить прямую федерацию с поставщиком удостоверений с помощью PowerShell, выполните следующие действия.
1. Установите последнюю версию модуля Azure AD PowerShell для Graph ([AzureADPreview](https://www.powershellgallery.com/packages/AzureADPreview)).
2. Выполните следующую команду: 
   ```powershell
   Connect-AzureAD
   ```
3. При появлении запроса на вход войдите с помощью управляемой учетной записи глобального администратора. 
4. Введите следующую команду:
   ```powershell
   Remove-AzureADExternalDomainFederation -ExternalDomainName  $domainName
   ```
