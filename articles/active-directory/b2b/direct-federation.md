---
title: Настройте прямую федерацию с помощью поставщика удостоверений для B2B — Azure Active Directory | Документация Майкрософт
description: Напрямую создать федерацию с поставщиком удостоверений SAML или WS-Fed, чтобы гости могли входить в приложения Azure AD
services: active-directory
ms.service: active-directory
ms.subservice: B2B
ms.topic: conceptual
ms.date: 07/01/2019
ms.author: mimart
author: msmimart
manager: celestedg
ms.reviewer: mal
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: a4dadc68e78fbaa979751d5bcd04ef481c3ab886
ms.sourcegitcommit: 5bdd50e769a4d50ccb89e135cfd38b788ade594d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2019
ms.locfileid: "67544352"
---
# <a name="direct-federation-with-ad-fs-and-third-party-providers-for-guest-users-preview"></a>Прямую федерацию с AD FS и сторонних поставщиков для гостевых пользователей (Предварительная версия)
|     |
| --- |
| Общедоступная Предварительная версия прямую федерацию функция Azure Active Directory. См. подробные сведения о [дополнительных условиях использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).|
|     |

В этой статье описывается, как настроить прямую федерацию с другой организации совместной работы B2B. Можно настроить прямую федерацию с любой организации, в которых поставщик удостоверений (IdP) поддерживает протокол SAML 2.0 или WS-Fed.
При настройке прямую федерацию с поставщиком удостоверений партнера новых гостевых пользователей из этого домена можно использовать собственный управляемый поставщик удостоверений учетной записи организации для входа в клиент Azure AD и начать работу с вами. Нет необходимости для гостевого пользователя для создания отдельной учетной записи Azure AD.
> [!NOTE]
> Прямой федерации гостевых пользователей необходимо выполнить вход с помощью ссылки, включающее контекст клиента (например, `https://myapps.microsoft.com/?tenantid=<tenant id>` или `https://portal.azure.com/<tenant id>`, или в случае проверенному домену, `https://myapps.microsoft.com/\<verified domain>.onmicrosoft.com`). Прямые ссылки на приложения и ресурсы также работают, если они содержат контекст клиента. Пользователям прямую федерацию сейчас не удалось выполнить вход с использованием общих конечных точек, имеющих контекст не клиента. Например, с помощью `https://myapps.microsoft.com`, `https://portal.azure.com`, или `https://teams.microsoft.com` приведет к ошибке.
 
## <a name="when-is-a-guest-user-authenticated-with-direct-federation"></a>Когда проходит гостевого пользователя проверку подлинности с прямой федерацией?
После настройки прямую федерацию с организацией, каждый новый гостевой пользователь приглашение будет проверяться с помощью прямую федерацию. Важно отметить, что настройка прямую федерацию не изменяется метод проверки подлинности для гостевых пользователей, которые уже активировали приглашение от вас. Далее приводятся некоторые примеры.
 - Если гостевые пользователи уже купили приглашения от, который вы впоследствии настроить прямую федерацию с своей организации, эти гостевых пользователей будет продолжать использовать тот же метод проверки подлинности, использованные до настройки прямую федерацию.
 - Если настроить прямую федерацию с партнерской организацией и приглашать гостевых пользователей, а затем перемещает позже партнерской организации в Azure AD, гостевых пользователей, которые уже активировали приглашения будут продолжать использовать прямую федерацию, при условии, прямые существует федерации политики в клиенте.
 - Если вы удалите прямую федерацию с партнерской организацией, любой гостевых пользователей, в настоящее время с помощью прямой федерации будет может войти в систему.

В любой из этих сценариев можно обновить метод проверки подлинности пользователя guest, удалив гостевой учетной записи пользователя из каталога и reinviting их.

Прямую федерацию привязывается к пространствам имен домена, например contoso.com и fabrikam.com. При установке конфигурации прямую федерацию с AD FS или стороннего поставщика удостоверений, организациям связать один или несколько пространств имен домена для этих поставщиков удостоверений. 

## <a name="end-user-experience"></a>Возможности для пользователей 
С прямой федерацией гостевых пользователей войти в клиенте Azure AD с помощью собственной учетной записи организации. Когда они обращаются к общим ресурсам и получают запрос на вход, прямую федерацию пользователи перенаправляются к их поставщику удостоверений. После успешного входа в систему они возвращаются в Azure AD для доступа к ресурсам. Прямой маркеров обновления пользователей федерации действительны в течение 12 часов [по умолчанию длина для маркера обновления passthrough](../develop/active-directory-configurable-token-lifetimes.md#exceptions) в Azure AD. Если Федеративный поставщик удостоверений с поддержкой единого входа, пользователь будет возникать единого входа и не увидит запросы входа в систему после начальной проверки подлинности.

## <a name="limitations"></a>Ограничения

### <a name="dns-verified-domains-in-azure-ad"></a>Проверка DNS доменов в Azure AD
Прямой федерации допустим только для доменов, которые являются ***не*** проверить DNS в Azure AD. Прямую федерацию допускается для неуправляемых (проверкой по электронной почте или «вирусной») Azure AD версии клиента, так как они не проверен DNS.
### <a name="authentication-url"></a>URL-адрес проверки подлинности
Прямую федерацию допускается только для политик, где домен URL-адреса проверки подлинности соответствующий целевой домен, или где URL-адрес проверки подлинности может быть любым из этих поставщиков удостоверений, разрешенных (этот список может быть изменена):
-   Accounts.Google.com
-   pingidentity.com
-   login.pingone.com
-   okta.com
-   my.salesforce.com
-   federation.exostar.com
-   federation.exostartest.com

Например, при настройке прямую федерацию для **fabrikam.com**, URL-адрес проверки подлинности `https://fabrikam.com/adfs` пройдет проверку. На узле в том же домене, будет соответствовать, например `https://sts.fabrikam.com/adfs`. Тем не менее URL-адрес проверки подлинности `https://fabrikamconglomerate.com/adfs` или `https://fabrikam.com.uk/adfs` для не будет передавать в том же домене.

### <a name="signing-certificate-renewal"></a>Обновление сертификата подписи
При указании URL-адрес метаданных в параметры поставщика удостоверений Azure AD будет автоматически продлена сертификата для подписи, по истечении его срока действия. Тем не менее если сертификат поворачивается по любой причине раньше времени истечения срока, или если вы не укажете URL-адрес метаданных, Azure AD будет не удалось продлить его. В этом случае необходимо вручную обновить сертификат для подписи.
## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы
### <a name="can-i-set-up-direct-federation-with-an-unmanaged-email-verified-tenant"></a>Можно ли настроить прямую федерацию с неуправляемого клиента (проверка электронной почты) 
Да. Если он еще не был проверен и клиента, не выполненные [смены администратором](../users-groups-roles/domains-admin-takeover.md), можно настроить прямую федерацию. Неуправляемые или проверкой по электронной почте клиентов создаются в том случае, когда пользователь активирует приглашение B2B или выполняет функцию самостоятельной регистрации для Azure AD, используется домен, в настоящее время нет. Можно настроить прямую федерацию с этих доменов. При попытке настроить прямую федерацию с доменом проверки DNS, на портале Azure или с помощью PowerShell, вы увидите ошибку.
### <a name="if-direct-federation-and-email-one-time-passcode-authentication-are-both-enabled-which-method-takes-precedence"></a>Если прямую федерацию и проверкой подлинности с одноразовым паролем электронной почты включена, какой метод имеет приоритет?
При установлении прямую федерацию с партнерской организацией, она имеет приоритет над проверкой подлинности с одноразовым паролем электронной почты для новых гостевых пользователей из этой организации. Если гостевой пользователь активировал приглашение, используя проверку подлинности с одноразовым паролем, перед настройкой прямую федерацию, они будут продолжать использовать проверку подлинности с одноразовым паролем. 
### <a name="does-direct-federation-address-sign-in-issues-due-to-a-partially-synced-tenancy"></a>Прямой федерации адрес проблем со входом из-за частично синхронизированные аренды?
Нет, [электронной почты с одноразовым паролем](one-time-passcode.md) функции следует использовать в этом сценарии. «Частично синхронизированные аренды» ссылается на партнера клиента Azure AD, где локальные удостоверения пользователя не полностью синхронизации с облачной службой. Гость, удостоверение которого еще не существует в облаке, но кто пытается активировать приглашение B2B не будет входить в систему. Функция одноразовый пароль позволит этого гостя для входа. Функция прямую федерацию предназначен для сценариев, у гостевого компьютера есть собственный управляемый поставщик удостоверений учетной записи организации, когда организация имеет без наличия Azure AD вообще.

## <a name="step-1-configure-the-partner-organizations-identity-provider"></a>Шаг 1. Настройка партнерской организации поставщика удостоверений
Во-первых партнерской организации необходимо настроить поставщика удостоверений с доверия с проверяющей стороной и требуемые утверждения. 

> [!NOTE]
> Чтобы проиллюстрировать процесс настройки поставщика удостоверений для прямую федерацию, мы будем использовать службы федерации Active Directory (AD FS) в качестве примера. См. в статье [настройте прямую федерацию с AD FS](direct-federation-adfs.md), которой приведены примеры того, как настроить AD FS в качестве поставщика удостоверений SAML 2.0 или WS-Fed в процессе подготовки к прямую федерацию.

### <a name="saml-20-configuration"></a>Настройка SAML 2.0

Azure AD B2B можно настроить в федерацию с поставщиками удостоверений, использующим протокол SAML с определенными требованиями, перечисленных ниже. Дополнительные сведения о настройке отношения доверия между поставщиком удостоверений SAML и Azure AD см. в разделе [использовать поставщика удостоверений (IdP) SAML 2.0 для единого входа](https://docs.microsoft.com/azure/active-directory/hybrid/how-to-connect-fed-saml-idp).  

> [!NOTE]
> Примечание для прямую федерацию целевой домен не должен быть проверен DNS в Azure AD. Домен URL-адрес проверки подлинности должны соответствовать целевой домен или он должен быть домен поставщика удостоверений, разрешенных. См. в разделе [ограничения](#limitations) подробные сведения см. 

#### <a name="required-saml-20-attributes-and-claims"></a>Обязательные атрибуты SAML 2.0 и утверждений
В следующих таблицах приведены требования к определенным атрибутам и утверждения, которые должны быть сконфигурированы на поставщика удостоверений сторонних. Чтобы настроить прямую федерацию, следующие атрибуты должно быть получено в ответ от поставщика удостоверений SAML 2.0. Эти атрибуты можно настроить путем связывания службе маркеров безопасности в сети XML-файл или ввести их вручную.

Обязательные атрибуты для ответа от поставщика удостоверений SAML 2.0:

|Атрибут  |Значение  |
|---------|---------|
|AssertionConsumerService     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |URI партнера по обеспечению поставщиком удостоверений, например издателя `http://www.example.com/exk10l6w90DHM0yi...`         |


Требуемые заявки для токена SAML 2.0, выданный поставщиком удостоверений:

|Атрибут  |Значение  |
|---------|---------|
|Формат идентификатора имени     |`urn:oasis:names:tc:SAML:2.0:nameid-format:persistent`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |

### <a name="ws-fed-configuration"></a>Конфигурации WS-Fed 
Azure AD B2B можно настроить в федерацию с поставщиками удостоверений, использующих протокол WS-Fed предъявляется ряд особых требований, как показано ниже. В настоящее время два поставщика WS-Fed были протестированы для совместимости с Azure AD, включают AD FS и Shibboleth. Дополнительные сведения об установлении доверия с проверяющей стороной между поставщик WS-Fed совместимые с Azure AD, см. в разделе «интеграции STS бумаги с использованием протоколов WS» в [совместимости поставщика документация по Azure AD Identity](https://www.microsoft.com/download/details.aspx?id=56843).

> [!NOTE]
> Целевой домен для прямой федерации не должен быть проверен DNS в Azure AD. Домен URL-адрес проверки подлинности должен соответствовать целевому домену или домен поставщика удостоверений, разрешенных. См. в разделе [ограничения](#limitations) подробные сведения см. 

#### <a name="required-ws-fed-attributes-and-claims"></a>Обязательные атрибуты WS-Fed и утверждений

В следующих таблицах приведены требования к определенным атрибутам и утверждения, которые должны быть сконфигурированы на поставщика удостоверений WS-Fed независимых производителей. Чтобы настроить прямую федерацию, следующие атрибуты должно быть получено из поставщика удостоверений сообщения WS-Fed. Эти атрибуты можно настроить путем связывания службе маркеров безопасности в сети XML-файл или ввести их вручную.

Обязательные атрибуты в сообщении от поставщика удостоверений WS-Fed:
 
|Атрибут  |Значение  |
|---------|---------|
|PassiveRequestorEndpoint     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |URI партнера по обеспечению поставщиком удостоверений, например издателя `http://www.example.com/exk10l6w90DHM0yi...`         |

Требуемые заявки для WS-Fed токен, выданный службой поставщика удостоверений:

|Атрибут  |Значение  |
|---------|---------|
|ImmutableID     |`http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |

## <a name="step-2-configure-direct-federation-in-azure-ad"></a>Шаг 2. Настроить прямую федерацию в Azure AD 
Далее вы настроите федерации с поставщиком удостоверений, настроенные на этапе 1, в Azure AD. Можно использовать PowerShell или портала Azure AD. Может занять 5 – 10 минут, прежде чем политика прямую федерацию вступает в силу. На этом этапе не пытайтесь активировать приглашение на прямую федерацию домена. Ниже приведены обязательные атрибуты.
- Issuer URI партнера по обеспечению поставщика удостоверений
- Пассивная проверка подлинности конечной точки партнера поставщика удостоверений (поддерживается только протокол https)
- Сертификат

### <a name="to-configure-direct-federation-in-the-azure-ad-portal"></a>Чтобы настроить прямую федерацию на портале Azure AD

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Организационные связи**.
3. Выберите **поставщиков удостоверений**, а затем выберите **IdP новый SAML/WS-Fed**.

    ![Снимок экрана: кнопка отображения для добавления новых SAML или поставщика удостоверений WS-Fed](media/direct-federation/new-saml-wsfed-idp.png)

4. На **IdP новый SAML/WS-Fed** раздела **протокола поставщика удостоверений**выберите **SAML** или **WS-FED**.

    ![Снимок экрана кнопка синтаксического анализа отображение на странице SAML или поставщика удостоверений WS-Fed](media/direct-federation/new-saml-wsfed-idp-parse.png)

5. Введите имя домена вашей организации партнера, которое будет использоваться имя целевого домена для прямую федерацию
6. Можно отправить файл метаданных, чтобы заполнить сведения для метаданных. Если вы решили вручную входные метаданные, введите следующие сведения:
   - Доменное имя партнера по обеспечению поставщика удостоверений
   - Идентификатор сущности поставщика удостоверений партнера
   - Конечную точку пассивной службы запросов партнера поставщика удостоверений
   - Сертификат
   > [!NOTE]
   > URL-адрес метаданных является необязательным, но мы настоятельно рекомендуем. Если указать URL-адрес метаданных, Azure AD можно автоматически обновить сертификат для подписи при окончании срока ее. Если сертификат поворачивается по любой причине до времени окончания срока действия или если вы не укажете URL-адрес метаданных, Azure AD не сможет возобновить его. В этом случае необходимо вручную обновить сертификат для подписи.

7. Щелкните **Сохранить**. 

### <a name="to-configure-direct-federation-in-azure-ad-using-powershell"></a>Чтобы настроить прямую федерацию в Azure AD, с помощью PowerShell

1. Установите последнюю версию модуля Azure AD PowerShell для Graph ([AzureADPreview](https://www.powershellgallery.com/packages/AzureADPreview)). (Если вам требуется подробное описание действий, краткое руководство по добавлению пользователя guest разделом [установить последнюю версию модуля AzureADPreview](b2b-quickstart-invite-powershell.md#install-the-latest-azureadpreview-module).) 
2. Выполните следующую команду: 
   ```powershell
   Connect-AzureAD
   ```
1. При появлении запроса на вход войдите с помощью управляемой учетной записи глобального администратора. 
2. Выполните следующие команды, заменив значения из файла метаданных федерации. Для сервера AD FS и Okta, федерации он federationmetadata.xml, например: `https://sts.totheclouddemo.com/federationmetadata/2007-06/federationmetadata.xml`. 

   ```powershell
   $federationSettings = New-Object Microsoft.Open.AzureAD.Model.DomainFederationSettings
   $federationSettings.PassiveLogOnUri ="https://sts.totheclouddemo.com/adfs/ls/"
   $federationSettings.LogOffUri = $federationSettings.PassiveLogOnUri
   $federationSettings.IssuerUri = "http://sts.totheclouddemo.com/adfs/services/trust"
   $federationSettings.MetadataExchangeUri="https://sts.totheclouddemo.com/adfs/services/trust/mex"
   $federationSettings.SigningCertificate= <Replace with X509 signing cert’s public key>
   $federationSettings.PreferredAuthenticationProtocol="WsFed" OR "Samlp"
   $domainName = <Replace with domain name>
   New-AzureADExternalDomainFederation -ExternalDomainName $domainName  -FederationSettings $federationSettings
   ```

## <a name="step-3-test-direct-federation-in-azure-ad"></a>Шаг 3. Проверить прямую федерацию в Azure AD
Теперь можно Проверьте установку прямую федерацию, приглашение нового гостевого пользователя B2B. Дополнительные сведения см. в разделе [пользователей службы совместной работы Azure AD B2B, добавить на портале Azure](add-users-administrator.md).
 
## <a name="how-do-i-edit-a-direct-federation-relationship"></a>Как изменить отношение прямую федерацию?

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Организационные связи**.
3. Выберите **поставщиков удостоверений**
4. В разделе **поставщиков удостоверений SAML/WS-Fed**, выберите поставщик.
5. В области сведений поставщика удостоверений обновите значения.
6. Щелкните **Сохранить**.


## <a name="how-do-i-remove-direct-federation"></a>Как удалить прямую федерацию?
Вы можете удалить настройки прямую федерацию. В противном случае прямую федерацию гостевых пользователей, которые уже активировали свои приглашения не будет входить в систему. Но вы можно предоставить им доступ к ресурсам повторно, удалив их из каталога и reinviting их. Чтобы удалить прямую федерацию с помощью поставщика удостоверений на портале Azure AD:

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Организационные связи**.
3. Выберите **поставщиков удостоверений**.
4. Выберите поставщика удостоверений, а затем выберите **удалить**. 
5. Выберите **Да**, чтобы подтвердить удаление. 

Чтобы удалить прямую федерацию с помощью поставщика удостоверений с помощью PowerShell:
1. Установите последнюю версию модуля Azure AD PowerShell для Graph ([AzureADPreview](https://www.powershellgallery.com/packages/AzureADPreview)).
2. Выполните следующую команду: 
   ```powershell
   Connect-AzureAD
   ```
3. При появлении запроса на вход войдите с помощью управляемой учетной записи глобального администратора. 
4. Введите следующую команду:
   ```powershell
   Remove-AzureADExternalDomainFederation -ExternalDomainName  $domainName
   ```
