---
title: Прямая федерация с поставщиком идентификационных данных для B2B - Azure AD
description: Непосредственно федеративная связь с поставщиком идентификационных данных SAML или WS-Fed, чтобы гости могли войти в приложения Azure AD
services: active-directory
ms.service: active-directory
ms.subservice: B2B
ms.topic: conceptual
ms.date: 02/27/2019
ms.author: mimart
author: msmimart
manager: celestedg
ms.reviewer: mal
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: 2b99a80a90df8fcfc5efe6dfa0c2cd7e8e5e04e0
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80050877"
---
# <a name="direct-federation-with-ad-fs-and-third-party-providers-for-guest-users-preview"></a>Прямая федерация с AD FS и сторонними провайдерами для гостевых пользователей (предварительный просмотр)
|     |
| --- |
| Прямая федерация — это общедоступное функцию предварительного просмотра Active Directory Azure. Для получения дополнительной информации о предварительных просмотрах [см.](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)|
|     |

В этой статье описывается, как создать прямую федерацию с другой организацией для совместной работы B2B. Вы можете создать прямую федерацию с любой организацией, поставщик идентификационных данных (IdP) поддерживает протокол SAML 2.0 или WS-Fed.
При настройке прямой федерации с IdP партнера новые гостевые пользователи из этого домена могут использовать свою собственную организационную учетную запись, управляемую IdP, чтобы войти в состав вашего арендатора Azure AD и начать сотрудничать с вами. Гостевому пользователю не нужно создавать отдельную учетную запись Azure AD.
> [!NOTE]
> Прямые гостевые пользователи федерации должны войти `https://myapps.microsoft.com/?tenantid=<tenant id>` в `https://portal.azure.com/<tenant id>`систему с помощью ссылки, которая включает контекст арендатора (например, или, или в случае проверенного домена, `https://myapps.microsoft.com/\<verified domain>.onmicrosoft.com`). Прямые ссылки на приложения и ресурсы также работают, если они содержат контекст клиента. В настоящее время пользователи прямых федераций не могут войти в систему с использованием общих конечных точек, не имеющих контекста арендатора. Например, `https://myapps.microsoft.com`использование, `https://portal.azure.com` `https://teams.microsoft.com` или приведет к ошибке.
 
## <a name="when-is-a-guest-user-authenticated-with-direct-federation"></a>Когда пользователь-гость проверяется с помощью прямой федерации?
После создания прямой федерации с организацией все новые приглашенные пользователи, с помощью реконцентрируемых, будут проверены с помощью прямой федерации. Важно отметить, что настройка прямой федерации не изменяет метод проверки подлинности для гостевых пользователей, которые уже выкупили приглашение от вас. Ниже приведены некоторые примеры:
 - Если гостевые пользователи уже выкупили приглашения от вас, и вы впоследствии создали прямую федерацию с их организацией, эти гостевые пользователи будут продолжать использовать тот же метод проверки подлинности, который они использовали, прежде чем настроить прямую федерацию.
 - Если вы создали прямую федерацию с организацией-партнером и пригласили гостевых пользователей, а затем организация-партнер переедет в Azure AD, гостевые пользователи, которые уже выкупили приглашения, будут продолжать использовать прямую федерацию, если прямая политика федерации в вашем арендаторе существует.
 - Если вы удалите прямую федерацию с организацией-партнером, все гостевые пользователи, использующие в настоящее время прямую федерацию, не смогут войти в систему.

В любом из этих сценариев можно обновить метод аутентификации гостевого пользователя, удалив учетную запись гостевого пользователя из каталога и переприглашаив их.

Прямая федерация привязана к доменным пространствам имен, таким как contoso.com и fabrikam.com. При создании прямой конфигурации федерации с AD FS или сторонним IdP организации связывают одно или несколько доменных имен с этими Идп. 

## <a name="end-user-experience"></a>Возможности для пользователей 
С помощью прямой федерации гостевые пользователи вписываются в ваш арендатор Azure AD, используя свою организационную учетную запись. Когда они получают доступ к общим ресурсам и получают запрос на вход, прямые пользователи федерации перенаправляются на свой IdP. После успешного входинии они возвращаются в Azure AD для доступа к ресурсам. Токены обновления пользователей direct federation действительны в течение 12 часов, что является длиной для [токена проходного обновления](../develop/active-directory-configurable-token-lifetimes.md#exceptions) в Azure AD. Если федеративный IdP включен SSO, пользователь будет испытывать SSO и не будет видеть какой-либо запрос на входе после первоначальной проверки подлинности.

## <a name="limitations"></a>Ограничения

### <a name="dns-verified-domains-in-azure-ad"></a>Проверенные DNS домены в Azure AD
Домен, с помощью которых вы хотите разогнаться, ***не*** должен быть проверен DNS в Azure AD. Вы можете создать прямую федерацию с неуправляемыми (проверенными по электронной почте или "вирусными") арендаторами Azure AD, поскольку они не проверены DNS.

### <a name="authentication-url"></a>URL-адрес аутентификации
Прямая федерация допускается только для политик, где домен URL-адреса проверки подлинности соответствует целевому домену, или когда URL-адрес проверки подлинности является одним из этих разрешенных поставщиков идентификационных данных (этот список может быть изменен):
-   accounts.google.com
-   pingidentity.com
-   login.pingone.com
-   okta.com
-   my.salesforce.com
-   federation.exostar.com
-   federation.exostartest.com

Например, при настройке прямой федерации `https://fabrikam.com/adfs` для **fabrikam.com**URL-адрес проверки подлинности будет передавать проверку. Хост в том же домене `https://sts.fabrikam.com/adfs`также пройдет, например. Однако URL-адрес `https://fabrikamconglomerate.com/adfs` `https://fabrikam.com.uk/adfs` проверки подлинности или для того же домена не пройдет.

### <a name="signing-certificate-renewal"></a>Продление сертификата подписи
Если вы укажете URL-адрес метаданных в настройках поставщика идентификационных данных, Azure AD автоматически возобновит сертификат подписи по истечении срока его действия. Однако, если сертификат повреждается по какой-либо причине до истечения срока действия, или если вы не предоставили URL-адрес метаданных, Azure AD не сможет обновить его. В этом случае необходимо обновить сертификат подписи вручную.

### <a name="limit-on-federation-relationships"></a>Ограничение отношений с федерацией
В настоящее время поддерживается не более 1000 отношений с федерацией. Это ограничение включает в себя как [внутренние федерации,](https://docs.microsoft.com/powershell/module/msonline/set-msoldomainfederationsettings?view=azureadps-1.0) так и прямые федерации.

### <a name="limit-on-multiple-domains"></a>Ограничение по нескольким доменотам
В настоящее время мы не поддерживаем прямую федерацию с несколькими доменами одного и того же арендатора.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы
### <a name="can-i-set-up-direct-federation-with-a-domain-for-which-an-unmanaged-email-verified-tenant-exists"></a>Могу ли я настроить прямую федерацию с доменом, для которого существует неуправляемый (проверенный по электронной почте) арендатор? 
Да. Если домен не был проверен и арендатор не подвергся [поглощению админом,](../users-groups-roles/domains-admin-takeover.md)вы можете настроить прямую федерацию с этим доменом. Неуправляемые или проверенные по электронной почте арендаторы создаются, когда пользователь выкупит приглашение B2B или выполняет регистрацию самообслуживания для Azure AD с помощью домена, который в настоящее время не существует. Вы можете настроить прямую федерацию с этими доменами. Если вы попытаетесь настроить прямую федерацию с проверенным доменом DNS, либо на портале Azure, либо через PowerShell, вы увидите ошибку.
### <a name="if-direct-federation-and-email-one-time-passcode-authentication-are-both-enabled-which-method-takes-precedence"></a>Если включена прямая федерация и электронная почта одноразового аутентификации пароля, какой метод имеет приоритет?
Когда прямая федерация создается с организацией-партнером, она имеет приоритет над электронной почтой одноразовой аутентификации пароля для новых гостевых пользователей из этой организации. Если гость выкупил приглашение, используя одноразовую проверку подлинности пароля перед настройкой прямой федерации, он продолжит использовать одноразовую проверку подлинности паролей. 
### <a name="does-direct-federation-address-sign-in-issues-due-to-a-partially-synced-tenancy"></a>Решает ли прямая федерация проблемы, связанные с ввозами из-за частично синхронизированной аренды?
Нет, функция [электронного письма с одноразовым кодом доступа](one-time-passcode.md) должна использоваться в этом сценарии. "Частично синхронизированная аренда" относится к партнеру- арендатору Azure AD, где идентификаторы пользователей не полностью синхронизированы с облаком. Гость, личность которого еще не существует в облаке, но который пытается выкупить приглашение B2B, не сможет войти в систему. Функция одноразового пароля позволит этому гостю войти в систему. Функция прямой федерирования рассматривает сценарии, в которых у гостя есть собственная организационная учетная запись, управляемая IdP, но организация вообще не имеет присутствия Azure AD.

## <a name="step-1-configure-the-partner-organizations-identity-provider"></a>Шаг 1: Настройка поставщика удостоверений личности организации-партнера
Во-первых, вашей организации-партнеру необходимо настроить своего поставщика идентификационных данных с требуемыми претензиями и полагаясь на трасты. 

> [!NOTE]
> Чтобы проиллюстрировать, как настроить поставщика идентификационных данных для прямой федерации, мы будем использовать в качестве примера службы Active Directory Federation Services (AD FS). Смотрите статью [Настройка прямой федерации с AD FS](direct-federation-adfs.md), который дает примеры того, как настроить AD FS в качестве поставщика SAML 2.0 или WS-Fed идентичности в рамках подготовки к прямой федерации.

### <a name="saml-20-configuration"></a>Конфигурация SAML 2.0

Azure AD B2B можно настроить для федерации с поставщиками идентификационных данных, которые используют протокол SAML с конкретными требованиями, перечисленными ниже. Для получения дополнительной информации о создании траста между поставщиком идентификационных данных SAML и Azure AD [см.](https://docs.microsoft.com/azure/active-directory/hybrid/how-to-connect-fed-saml-idp)  

> [!NOTE]
> Целевой домен для прямой федерации не должен быть проверен DNS на Azure AD. Домен URL-адреса проверки подлинности должен соответствовать целевому домену или он должен быть доменом разрешенного поставщика идентификационных данных. Подробнее о разделе [Ограничения.](#limitations) 

#### <a name="required-saml-20-attributes-and-claims"></a>Обязательные атрибуты и претензии SAML 2.0
В следующих таблицах отображается требования к определенным атрибутам и требованиям, которые должны быть настроены на стороннего поставщика идентификационных данных. Чтобы создать прямую федерацию, следующие атрибуты должны быть получены в ответе SAML 2.0 от поставщика идентификационных данных. Эти атрибуты можно настроить путем ссылки на онлайн-сервис безопасности XML или ввод их вручную.

Необходимые атрибуты для ответа SAML 2.0 от IdP:

|Атрибут  |Значение  |
|---------|---------|
|AssertionConsumerService     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |Эмитент URI партнера IdP, например`http://www.example.com/exk10l6w90DHM0yi...`         |


Обязательные претензии к токену SAML 2.0, выпущенному IdP:

|Атрибут  |Значение  |
|---------|---------|
|Формат NameID     |`urn:oasis:names:tc:SAML:2.0:nameid-format:persistent`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |

### <a name="ws-fed-configuration"></a>Конфигурация WS-Fed 
Azure AD B2B можно настроить для федерации с поставщиками идентификационных данных, которые используют протокол WS-Fed с некоторыми конкретными требованиями, перечисленными ниже. В настоящее время два провайдера WS-Fed прошли тестирование на совместимость с Azure AD, включая AD FS и Shibboleth. Для получения дополнительной информации о создании доверия стороны от зависимости от зависимости от WS-Fed с Azure AD можно найти в документах о совместимости поставщиков [идентификации AD Azure AD.](https://www.microsoft.com/download/details.aspx?id=56843)

> [!NOTE]
> Целевой домен для прямой федерации не должен быть проверен DNS на Azure AD. Домен URL-адреса проверки подлинности должен соответствовать либо целевому домену, либо домену разрешенного поставщика идентификационных данных. Подробнее о разделе [Ограничения.](#limitations) 

#### <a name="required-ws-fed-attributes-and-claims"></a>Обязательные атрибуты и претензии WS-Fed

В следующих таблицах отображаются требования к конкретным атрибутам и требованиям, которые должны быть настроены на стороннего поставщика идентификационных данных WS-Fed. Чтобы создать прямую федерацию, следующие атрибуты должны быть получены в сообщении WS-Fed от поставщика идентификационных данных. Эти атрибуты можно настроить путем ссылки на онлайн-сервис безопасности XML или ввод их вручную.

Необходимые атрибуты в сообщении WS-Fed от IdP:
 
|Атрибут  |Значение  |
|---------|---------|
|ПассивныйЗапросорEndpoint     |`https://login.microsoftonline.com/login.srf`         |
|Аудитория     |`urn:federation:MicrosoftOnline`         |
|Издатель     |Эмитент URI партнера IdP, например`http://www.example.com/exk10l6w90DHM0yi...`         |

Обязательные претензии к токену WS-Fed, выданному IdP:

|Атрибут  |Значение  |
|---------|---------|
|НеизменяемыйID     |`http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID`         |
|emailaddress     |`http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress`         |

## <a name="step-2-configure-direct-federation-in-azure-ad"></a>Шаг 2: Настройка прямой федерации в Azure AD 
Далее вы настраиваете федерацию с поставщиком идентификационных данных, настроенным в шаге 1 в Azure AD. Вы можете использовать либо портал Azure AD, либо PowerShell. Это может занять 5-10 минут, прежде чем всрёт политика прямой федерации. В течение этого времени не пытайтесь выкупить приглашение на прямой домен федерации. Ниже приведены обязательные атрибуты.
- Эмитент URI партнера IdP
- Пассивная конечная точка аутентификации партнера IdP (поддерживается только https)
- Сертификат

### <a name="to-configure-direct-federation-in-the-azure-ad-portal"></a>Настройка прямой федерации на портале Azure AD

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Организационные связи**.
3. Выберите **поставщиков идентификационных данных,** а затем выберите **New SAML/WS-Fed IdP.**

    ![Скриншот, показывающий кнопку для добавления нового SAML или WS-Fed IdP](media/direct-federation/new-saml-wsfed-idp.png)

4. На новой странице **SAML/WS-Fed IdP,** в соответствии с **протоколом поставщика идентификации,** выберите **SAML** или **WS-FED**.

    ![Скриншот, показывающий кнопку разбора на странице SAML или WS-Fed IdP](media/direct-federation/new-saml-wsfed-idp-parse.png)

5. Введите доменное имя организации-партнера, которое будет целевым доменным именем для прямой федерации
6. Вы можете загрузить файл метаданных для заполнения деталей метаданных. Если вы решите вводить метаданные вручную, введите следующую информацию:
   - Доменное имя партнера IdP
   - Идентификатор сущности партнера IdP
   - Пассивная конечная точка запроса партнера IdP
   - Сертификат
   > [!NOTE]
   > Metadata URL является необязательным, однако мы настоятельно рекомендуем его. Если вы предоставляете URL-адрес метаданных, Azure AD может автоматически возобновить сертификат подписи по истечении срока его действия. Если сертификат повреждается по какой-либо причине до истечения срока действия или если вы не предоставите URL-адрес метаданных, Azure AD не сможет обновить его. В этом случае необходимо обновить сертификат подписи вручную.

7. Нажмите кнопку **Сохранить**. 

### <a name="to-configure-direct-federation-in-azure-ad-using-powershell"></a>Настройка прямой федерации в Azure AD с помощью PowerShell

1. Установите последнюю версию модуля Azure AD PowerShell для Graph ([AzureADPreview](https://www.powershellgallery.com/packages/AzureADPreview)). (Если вам нужны подробные шаги, быстрый запуск для добавления гостевого пользователя включает в себя раздел [Установить последний модуль AzureADPreview](b2b-quickstart-invite-powershell.md#install-the-latest-azureadpreview-module).) 
2. Выполните следующую команду: 
   ```powershell
   Connect-AzureAD
   ```
1. При появлении запроса на вход войдите с помощью управляемой учетной записи глобального администратора. 
2. Выполнить следующие команды, заменив значения из файла метаданных федерации. Для AD FS Server и Okta файл федерации является federationmetadata.xml, например: `https://sts.totheclouddemo.com/federationmetadata/2007-06/federationmetadata.xml`. 

   ```powershell
   $federationSettings = New-Object Microsoft.Open.AzureAD.Model.DomainFederationSettings
   $federationSettings.PassiveLogOnUri ="https://sts.totheclouddemo.com/adfs/ls/"
   $federationSettings.LogOffUri = $federationSettings.PassiveLogOnUri
   $federationSettings.IssuerUri = "http://sts.totheclouddemo.com/adfs/services/trust"
   $federationSettings.MetadataExchangeUri="https://sts.totheclouddemo.com/adfs/services/trust/mex"
   $federationSettings.SigningCertificate= <Replace with X509 signing cert’s public key>
   $federationSettings.PreferredAuthenticationProtocol="WsFed" OR "Samlp"
   $domainName = <Replace with domain name>
   New-AzureADExternalDomainFederation -ExternalDomainName $domainName  -FederationSettings $federationSettings
   ```

## <a name="step-3-test-direct-federation-in-azure-ad"></a>Шаг 3: Испытание прямой федерации в Azure AD
Теперь проверьте свою прямую установку федерации, пригласив нового гостевого пользователя B2B. Подробнее о работе пользователей Azure AD B2B на портале Azure читайте в материале [«Добавить пользователей совместной работы Azure AD B2B».](add-users-administrator.md)
 
## <a name="how-do-i-edit-a-direct-federation-relationship"></a>Как отсеять прямые отношения с федерацией?

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Организационные связи**.
3. Выбрать **поставщиков идентификационных данных**
4. В соответствии с **поставщиками идентификационных данных SAML/WS-Fed**выберите поставщика.
5. В панели поставщика идентификационных данных обновляются значения.
6. Нажмите кнопку **Сохранить**.


## <a name="how-do-i-remove-direct-federation"></a>Как удалить прямую федерацию?
Вы можете удалить прямую установку федерации. Если вы это сделаете, прямые гостевые пользователи федерации, которые уже выкупили свои приглашения, не смогут войти в систему. Но вы можете дать им доступ к вашим ресурсам снова, удалив их из каталога и переприглашаив их. Чтобы удалить прямую федерацию с поставщиком идентификационных данных на портале Azure AD:

1. Перейдите на [портал Azure](https://portal.azure.com/). В области слева выберите **Azure Active Directory**. 
2. Выберите **Организационные связи**.
3. Выберите **поставщиков идентификационных данных.**
4. Выберите поставщика идентификационных данных, а затем выберите **Удалить**. 
5. Выберите **Да**, чтобы подтвердить удаление. 

Чтобы удалить прямую федерацию с поставщиком идентификационных данных с помощью PowerShell:
1. Установите последнюю версию модуля Azure AD PowerShell для Graph ([AzureADPreview](https://www.powershellgallery.com/packages/AzureADPreview)).
2. Выполните следующую команду: 
   ```powershell
   Connect-AzureAD
   ```
3. При появлении запроса на вход войдите с помощью управляемой учетной записи глобального администратора. 
4. Введите следующую команду:
   ```powershell
   Remove-AzureADExternalDomainFederation -ExternalDomainName  $domainName
   ```
