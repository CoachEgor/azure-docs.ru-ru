---
title: Зачем обновлять идентификационную платформу Майкрософт (v2.0) Azure
description: Знайте различия между конечной точкой идентификационных данных Майкрософт (v2.0) и конечным пунктом Azure Active Directory (Azure AD) v1.0 и узнайте преимущества обновления до v2.0.
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: azuread-dev
ms.workload: identity
ms.topic: conceptual
ms.date: 11/26/2019
ms.author: ryanwi
ms.reviewer: saeeda, hirsin, jmprieur, sureshja, jesakowi, lenalepa, kkrishna, negoe
ms.custom: aaddev
ROBOTS: NOINDEX
ms.openlocfilehash: 67a54a2cd4fa071fd47bcebb9aa53fd11fefd61e
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80154922"
---
# <a name="why-update-to-microsoft-identity-platform-v20"></a>Зачем выполнять обновление до платформы удостоверений Майкрософт (версия 2.0)?

При разработке нового приложения важно знать различия между платформой идентификации Майкрософт (v2.0) и apure Active Directory (v1.0). В этой статье рассматриваются основные различия между конечными точками и некоторыми существующими ограничениями для платформы идентификации Майкрософт.

> [!NOTE]
> Конечная точка платформы майкрософт не поддерживает все сценарии и функции Azure AD. Чтобы определить, следует ли использовать конечную точку платформы идентификации Майкрософт, прочитайте об [ограничениях платформы идентификации Майкрософт.](#limitations)

## <a name="who-can-sign-in"></a>Каким учетным записям разрешен вход

![Кто может входить в систему с помощью конечных точек версии 1.0 и версии 2.0](media/azure-ad-endpoint-comparison/who-can-signin.svg)

* Конечная точка версии 1.0 позволяет входить в приложение (Azure AD) только с рабочими и учебными учетными записями.
* Конечная точка платформы майкрософт позволяет входить в систему учетных записей о работе и школах из AD Azure AD и личных учетных записей Майкрософт (MSA), таких как hotmail.com, outlook.com и msn.com.
* Обе конечные точки также принимают входе в список *[гостевых пользователей](https://docs.microsoft.com/azure/active-directory/b2b/what-is-b2b)* каталога Azure AD для приложений, настроенных`https://login.microsoftonline.com/{TenantId_or_Name}`как *[одно-арендаторили](../develop/single-and-multi-tenant-apps.md?toc=/azure/active-directory/azuread-dev/toc.json&bc=/azure/active-directory/azuread-dev/breadcrumb/toc.json)* или для *мультитенантных* приложений, настроенных для обозначения конечной точки для конкретного клиента ().

Конечная точка платформы майкрософт позволяет писать приложения, которые принимают входе из личных учетных записей Майкрософт, а также рабочие и школьные учетные записи. Это дает возможность создавать приложения, абсолютно не зависящие от типа учетной записи. Например, если приложение вызывает [Microsoft Graph](https://graph.microsoft.io), пользователям с рабочими учетными записями будут доступны некоторые дополнительные функции и данные, такие как сайты SharePoint или данные каталога. Но для многих действий, таких как [чтение почты пользователя](https://docs.microsoft.com/graph/api/user-list-messages?view=graph-rest-1.0), тот же код сможет получить доступ к электронной почте как для личных, так и для рабочих и учебных учетных записей.

Для конечных точек платформы идентификации Майкрософт можно использовать библиотеку подлинности Майкрософт (MSAL) для получения доступа к миру потребителей, образовательных и корпоративных стран. Конечная точка Azure AD версии 1.0 принимает вход только с рабочими и учебными учетными записями.

## <a name="incremental-and-dynamic-consent"></a>Добавочное и динамическое согласие

В приложениях, где используется конечная точка Azure AD версии 1.0, необходимо указывать необходимые разрешения OAuth 2.0 заранее, например:

![Пример, показывающий uI регистрации разрешений](./media/azure-ad-endpoint-comparison/app-reg-permissions.png)

Разрешения, задаваемые непосредственно при регистрации приложения, являются **статическими**. Статические разрешения для приложения, заданные на портале Azure, позволяют упростить код, но при этом представляют определенные потенциальные сложности для разработчиков:

* Приложение должно запрашивать все разрешения, которые когда-либо могут потребоваться, при первом входе пользователя в систему. В результате список разрешений может получиться таким длинным, что это отобьет у пользователей желание разрешить приложению доступ при первом входе.

* Приложению заранее должны быть известны все ресурсы, к которым оно когда-либо обратится. Было трудно создавать приложения, использующие произвольное количество ресурсов.

С конечной точкой платформы идентификации Майкрософт можно игнорировать статические разрешения, определенные в регистрационной информации приложения на портале Azure, и запрашивать разрешения постепенно вместо этого, что означает запрос минимального набора разрешений заранее и растет с течением времени, как клиент использует дополнительные функции приложения. Для этого можно указать области, необходимые приложению в любое время, включив новые области в параметр `scope` при запросе маркера доступа — без необходимости предварительно определять их в регистрационных данных приложения. Если пользователь еще не предоставил согласие на новые области, добавленные в запрос, ему будет предложено принять только новые разрешения. Дополнительные сведения об областях, разрешениях и предоставлении согласия см. [здесь](../develop/v2-permissions-and-consent.md?toc=/azure/active-directory/azuread-dev/toc.json&bc=/azure/active-directory/azuread-dev/breadcrumb/toc.json).

Возможность приложения динамически запрашивать разрешения с помощью параметра `scope` дает разработчикам полный контроль над взаимодействием с пользователями. Вы также можете предварительно загрузить страницу согласия и запросить все разрешения в едином первоначальном запросе авторизации. Если приложению требуется множество разрешений, вы можете запрашивать их у пользователей постепенно, по мере применения определенных функций приложения.

Для согласия администратора от имени организации по-прежнему используются статические разрешения, зарегистрированные для приложения. Поэтому следует задавать такие разрешения для приложений на портале регистрации приложения, если нужно, чтобы администратор давал согласие от имени всей организации. Это позволяет сократить циклические действия, необходимые администратору организации для настройки приложения.

## <a name="scopes-not-resources"></a>Области, а не ресурсы

Приложение, в котором используется конечная точка версии 1.0, может вести себя как **ресурс** или получатель маркеров. Ресурс может определить несколько **областей** или **разрешений oAuth2**, которые он распознает, позволяя клиентским приложениям запрашивать маркеры у этого ресурса для определенного набора областей. Пример ресурса рассмотрим API Microsoft Graph:

* Идентификатор ресурса или `AppID URI`: `https://graph.microsoft.com/`
* Области или `oAuth2Permissions`: `Directory.Read`, `Directory.Write` и т. д.

Это относится и к конечная точка платформы идентификации Майкрософт. Приложение по-прежнему может вести себя как ресурс, определять области и идентифицироваться по универсальному коду ресурса (URI). Клиентские приложения по-прежнему могут запрашивать доступ к этим областям. Однако способ запроса этих разрешений клиента изменился.

Для конечной точки версии 1.0 запрос авторизации OAuth 2.0 в Azure AD выглядел так:

```text
GET https://login.microsoftonline.com/common/oauth2/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e
&resource=https://graph.microsoft.com/
...
```

Здесь параметр **resource** указывает, к какому ресурсу запрашивает авторизацию клиентское приложение. Служба Azure AD определяла разрешения, необходимые приложению, на основе статической конфигурации на портале Azure и выдавала маркеры соответствующим образом.

Для приложений, использующих конечную точку платформы идентификации Майкрософт, тот же запрос OAuth 2.0 авторизует:

```text
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e
&scope=https://graph.microsoft.com/directory.read%20https://graph.microsoft.com/directory.write
...
```

Здесь параметр **scope** указывает, для каких ресурсов и разрешений приложение запрашивает авторизацию. Нужный ресурс по-прежнему присутствует в запросе — он указан в каждом значении параметра области. Использование параметра области таким образом позволяет конечному пункту платформы Майкрософт быть более совместимой со спецификацией OAuth 2.0 и более тесно согласуется с обычными отраслевыми практиками. Он также позволяет приложениям делать [постепенное согласие](#incremental-and-dynamic-consent) - только запрашивая разрешения, когда приложение требует их, а не авансом.

## <a name="well-known-scopes"></a>Хорошо известные области

### <a name="offline-access"></a>Автономный доступ

Приложениям, использующим конечную точку платформы Майкрософт, может потребоваться использование нового известного разрешения для приложений - `offline_access` сферы действия. Всем приложения требуется запросить это разрешение, если им необходимо доступ к ресурсам от имени пользователя в течение длительного времени, даже если пользователь не работает с приложением активно. Область `offline_access` отображается в диалоговых окнах запроса согласия как разрешение **Доступ к вашим данным в любое время**, которое пользователь должен принять. Запрос `offline_access` разрешения позволит вашему веб-приложению получать OAuth 2.0 refresh_tokens от конечных точек платформы майкрософт. У маркеров обновления длительный срок действия, и их можно заменить на новые маркеры доступа OAuth 2.0 на значительные периоды доступа.

Если приложение не запрашивает `offline_access` область действия, оно не получит маркеры обновления. Это значит, что при использовании кода авторизации в потоке кода авторизации OAuth 2.0 вы получите только маркер доступа из конечной точки `/token`. Этот маркер доступа будет действителен в течение короткого времени (обычно одного часа), но в конечном итоге срок его действия истечет. В этот момент приложению будет необходимо перенаправить пользователя обратно в конечную точку `/authorize`, чтобы получить новый код авторизации. При этом пользователю может потребоваться повторно ввести учетные данные или повторно предоставить разрешения в зависимости от типа приложения.

Чтобы узнать больше о OAuth `refresh_tokens` `access_tokens`2.0, и , проверить [ссылку на протокол платформы идентификации Microsoft](../develop/active-directory-v2-protocols.md?toc=/azure/active-directory/azuread-dev/toc.json&bc=/azure/active-directory/azuread-dev/breadcrumb/toc.json).

### <a name="openid-profile-and-email"></a>OpenID, профиль и электронная почта

Исторически сложилось так, что самый основной OpenID Connect поток входе с платформой microsoft идентификации будет предоставлять много информации о пользователе в результате *id_token*. Утверждения в id_token могут содержать имя пользователя, предпочтительное имя пользователя, адрес электронной почты, идентификатор объекта и другие сведения.

Сейчас сведения, доступные вашему приложению с помощью области `openid`, ограничены. Теперь область `openid` позволит пользователю только войти в приложение и получить соответствующий идентификатор. Чтобы получить личные сведения о пользователе в приложении, приложение должно запросить у пользователя дополнительные разрешения. Чтобы запросить дополнительные разрешения, используйте две новые области — `email` и `profile`.

* Область `email` позволяет приложению получить доступ к основному `email` адресу электронной почты пользователя через претензию в id_token, при условии, что у пользователя есть адресный адрес электронной почты.
* Область `profile` предоставляет приложению доступ ко всей другой основной информации о пользователе, например, его имени, предпочтительному имени пользователя, идентификатору объекта и так далее, в id_token.

Эти области позволяют создать код приложения с минимальным разглашением сведений, поэтому вы можете запросить у пользователя только те сведения, которые нужны приложению для выполнения задания. Для получения дополнительной информации [the Microsoft identity platform scope reference](../develop/v2-permissions-and-consent.md?toc=/azure/active-directory/azuread-dev/toc.json&bc=/azure/active-directory/azuread-dev/breadcrumb/toc.json)об этих областях см.

## <a name="token-claims"></a>Утверждения маркера

Конечная точка платформы идентификации Майкрософт выдает меньший набор требований в своих токенах по умолчанию, чтобы сохранить небольшие полезные нагрузки. Если у вас есть приложения и службы, которые зависят от конкретной претензии в токене v1.0, который больше не предусмотрен по умолчанию в токене платформы идентификации Майкрософт, рассмотрите возможность использования [функции факультативных требований](../develop/active-directory-optional-claims.md?toc=/azure/active-directory/azuread-dev/toc.json&bc=/azure/active-directory/azuread-dev/breadcrumb/toc.json) для включения этой претензии.

> [!IMPORTANT]
> v1.0 и v2.0 токены могут быть выпущены как v1.0, так и v2.0 конечными точками! id_tokens *всегда* совпадают с конечной точкой, от которой они запрашиваются, и токены доступа *всегда* соответствуют формату, ожидаемому Web API, который клиент вызовет с помощью этого маркера.  Так что если ваше приложение использует конечную точку v2.0, чтобы получить токен для вызова Microsoft Graph, который ожидает токенов доступа формата v1.0, ваше приложение получит токен в формате v1.0.  

## <a name="limitations"></a>Ограничения

Есть несколько ограничений, о которых следует знать при использовании платформы идентификации Майкрософт.

При создании приложений, интегрирующихся с платформой идентификации Майкрософт, необходимо решить, соответствуют ли вам конечным точкам платформы идентификации Майкрософт и протоколам проверки подлинности. Конечная точка и платформа v1.0 по-прежнему полностью поддерживаются и, в некоторых отношениях, более богаты функциями, чем платформа идентификации Microsoft. Тем не менее, идентификационная платформа Майкрософт [приносит разработчикам значительные преимущества.](azure-ad-endpoint-comparison.md)

Вот упрощенная рекомендация для разработчиков сейчас:

* Если вы хотите или нуждаетесь в поддержке личных учетных записей Майкрософт в приложении или пишете новое приложение, используйте платформу идентификации Майкрософт. Но перед этим убедитесь, что вы понимаете ограничения, описанные в этой статье.
* Если вы мигрируете или обновляете приложение, которое опирается на SAML, вы не можете использовать платформу идентификации Майкрософт. Вместо этого обратитесь к [руководству Azure AD v1.0](v1-overview.md).

Конечная точка платформы идентификации Майкрософт будет развиваться, чтобы устранить ограничения, перечисленные здесь, так что вам будет нужно использовать только конечную точку платформы идентификации Майкрософт. В то же время используйте эту статью, чтобы определить, подходит ли вам конечная точка платформы идентификационных данных Майкрософт. Мы будем продолжать обновлять эту статью, чтобы отразить текущее состояние конечной точки платформы идентификации Майкрософт. Вернитесь к переоценке ваших требований в отношении возможностей платформы идентификации Майкрософт.

### <a name="restrictions-on-app-registrations"></a>Ограничения регистрации приложений

Для каждого приложения, которое вы хотите интегрировать с конечным пунктом платформы идентификации Майкрософт, можно создать регистрацию приложения в новом [опыте **регистрации приложений** ](https://aka.ms/appregistrations) на портале Azure. Существующие приложения учетной записи Майкрософт не совместимы с порталом, но все приложения Azure AD, независимо от того, где и когда они были зарегистрированы.

Регистрация приложений, поддерживающих рабочие, учебные и личные учетные записи, имеет такие особенности:

* Для идентификатора приложения можно использовать только два секрета приложения.
* Приложением, не зарегистрированным в клиенте, можно управлять только через учетную запись, в которой оно зарегистрировано. Он не может быть совместно с другими разработчиками. Это справедливо для большинства приложений, зарегистрированных с личной учетной записью Майкрософт на портале регистрации приложений. Если вы хотите поделиться регистрацией приложения с несколькими разработчиками, зарегистрируйте приложение у арендатора с помощью нового раздела **регистрации приложений** портала Azure.
* К формату URL-адреса перенаправления применяется несколько ограничений. Дополнительные сведения об URL-адресе перенаправления см. в следующем разделе.

### <a name="restrictions-on-redirect-urls"></a>Ограничения для URL-адресов перенаправления

Приложения, зарегистрированные на платформу идентификации Майкрософт, ограничены ограниченным набором значений url-адресов. URL-адрес перенаправления для веб-приложений и служб должен начинаться со схемы `https`, и во всех его значениях должен использоваться один домен DNS.  Система регистрации сравнивает полное DNS-имя существующего URL-адреса перенаправления и DNS-имя добавляемого URL-адреса перенаправления. `http://localhost` также поддерживается в качестве URL-адреса перенаправления.  

Запрос на добавление DNS-имени завершится ошибкой при выполнении любого из следующих условий.  

* Если полное DNS-имя нового URL-адреса перенаправления не соответствует DNS-имени существующего URL-адреса перенаправления.
* Если полное DNS-имя нового URL-адреса перенаправления не является поддоменом существующего URL-адреса перенаправления.

#### <a name="example-1"></a>Пример 1

Если в приложении используется URL-адрес перенаправления `https://login.contoso.com`, можно добавить URL-адрес перенаправления с полностью совпадающим DNS-именем, как показано в примере ниже.

`https://login.contoso.com/new`

Или же можно использовать ссылку на поддомен DNS login.contoso.com, как показано в примере ниже.

`https://new.login.contoso.com`

#### <a name="example-2"></a>Пример 2

Если вы хотите, чтобы в приложении использовались URL-адреса перенаправления `login-east.contoso.com` и `login-west.contoso.com`, добавьте их в таком порядке:

`https://contoso.com`  
`https://login-east.contoso.com`  
`https://login-west.contoso.com`  

Вы можете добавить последние два, потому что они поддомены первого перенаправления URL, contoso.com.

Вы можете иметь только 20 URL-адресов ответа для конкретного приложения - этот лимит применяется во всех типах приложений, которые поддерживает регистрация (одностраничное приложение (SPA), родной клиент, веб-приложение и сервис).  

Чтобы узнать, как зарегистрировать приложение для использования с платформой идентификации Майкрософт, [см.](../develop/quickstart-register-app.md?toc=/azure/active-directory/azuread-dev/toc.json&bc=/azure/active-directory/azuread-dev/breadcrumb/toc.json)

### <a name="restrictions-on-libraries-and-sdks"></a>Ограничения для библиотек и пакетов SDK

В настоящее время поддержка библиотеки для конечных точек платформы идентификации Майкрософт ограничена. Если вы хотите использовать конечную точку платформы Майкрософт в производственном приложении, у вас есть следующие параметры:

* При создании веб-приложения можно безопасно использовать общедоступный серверный промежуточное программное обеспечение для проверки ввоза и маркеров. В нее входит ПО промежуточного слоя OWIN OpenID Connect для ASP.NET и подключаемый модуль NodeJS Passport. Для образцов кода, которые используют программное обеспечение Microsoft, смотрите начатый раздел [платформы идентификации Майкрософт.](../develop/v2-overview.md?toc=/azure/active-directory/azuread-dev/toc.json&bc=/azure/active-directory/azuread-dev/breadcrumb/toc.json#getting-started)
* При создании настольного или мобильного приложения можно использовать одну из библиотек подлинности Майкрософт (MSAL). Эти библиотеки, как правило, доступны или в производственном предварительном просмотре, поэтому их безопасно использовать в производственных приложениях. Дополнительные сведения об условиях предварительной версии и доступных библиотеках см. в статье [Библиотеки проверки подлинности Azure Active Directory версии 2.0](../develop/reference-v2-libraries.md?toc=/azure/active-directory/azuread-dev/toc.json&bc=/azure/active-directory/azuread-dev/breadcrumb/toc.json).
* Для платформ, не охваченных библиотеками Майкрософт, можно интегрироваться с конечней точкой платформы Майкрософт, напрямую отправляя и получая протокольные сообщения в коде приложения. Протоколы OpenID Connect и OAuth [явно документированы,](../develop/active-directory-v2-protocols.md?toc=/azure/active-directory/azuread-dev/toc.json&bc=/azure/active-directory/azuread-dev/breadcrumb/toc.json) чтобы помочь вам сделать такую интеграцию.
* Наконец, для интеграции с конечной точкой платформы идентификации Майкрософт можно использовать библиотеки OpenID Connect и OAuth с открытым исходным кодом. Конечная точка платформы майкрософт должна быть совместима со многими библиотеками протоколов с открытым исходным кодом без изменений. Наличие этих библиотек зависит от языка и платформы. На веб-сайтах [OpenID Connect](https://openid.net/connect/) и [OAuth 2.0](https://oauth.net/2/) можно ознакомиться со списком популярных реализаций. Для получения дополнительной информации см. [платформу идентификации Майкрософт и библиотеки аутентификации,](../develop/reference-v2-libraries.md?toc=/azure/active-directory/azuread-dev/toc.json&bc=/azure/active-directory/azuread-dev/breadcrumb/toc.json)а также список библиотек клиентов с открытым исходным кодом и образцов, которые были протестированы с конечной точкой платформы идентификации Майкрософт.
* Для справки, конечная `.well-known` точка для общей `https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration`конечной точки платформы идентификации Майкрософт является. Замените `common` идентификатором вашего клиента, чтобы получить данные, относящиеся к вашему клиенту.  

### <a name="protocol-changes"></a>Изменения протокола

Конечная точка платформы майкрософт не поддерживает SAML или WS-Federation; он поддерживает только OpenID Connect и OAuth 2.0.  К существенным отличиям протоколов OAuth 2.0 по сравнению с конечной точкой версии 1.0 относятся: 

* Утверждение `email` возвращается, если настроено необязательное утверждение **или** в запросе указано scope=email. 
* Вместо параметра `resource` теперь поддерживается параметр `scope`.  
* Многие отклики изменены для большего соответствия спецификации OAuth 2.0, например, `expires_in` возвращается в виде целого числа, а не строки.  

Чтобы лучше понять область функциональности протокола, поддерживаемую [OpenID Connect and OAuth 2.0 protocol reference](../develop/active-directory-v2-protocols.md?toc=/azure/active-directory/azuread-dev/toc.json&bc=/azure/active-directory/azuread-dev/breadcrumb/toc.json)в конечной точке платформы идентификации Майкрософт, см.

#### <a name="saml-restrictions"></a>Ограничения SAML

Если вы использовали Библиотеку подлинности Active Directory Library (ADAL) в приложениях Windows, вы могли бы воспользоваться преимуществами интегрированной аутентификации Windows, которая использует грант на утверждение языка защиты утверждений (SAML). С его помощью пользователи федеративных клиентов Azure AD могут проходить аутентификацию в локальном экземпляре Active Directory автоматически, без необходимости ввода учетных данных. Грант на утверждение SAML не поддерживается на конечной точке платформы идентификации Майкрософт.
