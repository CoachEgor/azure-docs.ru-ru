---
title: Настройка производительности с кэшированием результирующего набора | Документация Майкрософт
description: Обзор возможностей
services: sql-data-warehouse
author: XiaoyuMSFT
manager: craigg
ms.service: sql-data-warehouse
ms.topic: conceptual
ms.subservice: development
ms.date: 10/10/2019
ms.author: xiaoyul
ms.reviewer: nidejaco;
ms.openlocfilehash: 6dd3172dd9098db0cb7ec09e812eec65f717340a
ms.sourcegitcommit: 0b1a4101d575e28af0f0d161852b57d82c9b2a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73163208"
---
# <a name="performance-tuning-with-result-set-caching"></a>Настройка производительности с кэшированием результирующего набора  
Если включено кэширование результирующего набора, хранилище данных SQL Azure автоматически кэширует результаты запроса в пользовательской базе данных для многократного использования.  Это позволяет последующим выполнениям запросов получать результаты непосредственно из материализованного кэша, поэтому перерасчет не требуется.   Кэширование результирующего набора улучшает производительность запросов и сокращает использование ресурсов вычислений.  Кроме того, запросы, использующие кэшированный набор результатов, не используют слоты выдачи и поэтому не учитываются для существующих ограничений параллелизма. В целях безопасности пользователи могут получить доступ к кэшированным результатам только в том случае, если они имеют те же разрешения на доступ к данным, что и пользователи, создающие кэшированные результаты.  

## <a name="key-commands"></a>Ключевые команды
[Включение/ВЫКЛЮЧЕНие кэширования результирующего набора для пользовательской базы данных](https://docs.microsoft.com/sql/t-sql/statements/alter-database-transact-sql-set-options?view=azure-sqldw-latest)

[Включение/ВЫКЛЮЧЕНие кэширования результирующего набора для сеанса](https://docs.microsoft.com/sql/t-sql/statements/set-result-set-caching-transact-sql?view=azure-sqldw-latest)

[Проверка размера кэшированного результирующего набора](https://docs.microsoft.com/sql/t-sql/database-console-commands/dbcc-showresultcachespaceused-transact-sql?view=azure-sqldw-latest)  

[Очистка кэша](https://docs.microsoft.com/sql/t-sql/database-console-commands/dbcc-dropresultsetcache-transact-sql?view=azure-sqldw-latest)

## <a name="whats-not-cached"></a>Что не кэшировано  

После включения кэширования результирующего набора для базы данных результаты будут кэшироваться для всех запросов, пока кэш не будет заполнен, за исключением следующих запросов:
- Запросы, использующие недетерминированные функции, такие как DateTime. Now ()
- Запросы, использующие определяемые пользователем функции
- Запросы, использующие таблицы с включенной безопасностью на уровне строк или на уровне столбцов
- Запросы, возвращающие данные с размером строки, превышающим 64 КБ

> [!IMPORTANT]
> Операции по созданию кэша результирующего набора и извлечению данных из кэша происходят в управляющем узле экземпляра хранилища данных. Если включено кэширование результирующего набора, то выполнение запросов, возвращающих большие результирующие наборы (например, > 1 миллион строк), может привести к высокой загрузке ЦП на управляющем узле и замедлить общий ответ на запрос экземпляра.  Эти запросы обычно используются во время изучения данных или операций ETL. Чтобы избежать нагрузки управляющего узла и вызвать проблемы с производительностью, пользователям следует отключить кэширование результирующего набора в базе данных перед выполнением этих типов запросов.  

Выполнить этот запрос в течение времени, затраченного на выполнение операций кэширования результирующего набора для запроса:

```sql
SELECT step_index, operation_type, location_type, status, total_elapsed_time, command 
FROM sys.dm_pdw_request_steps 
WHERE request_id  = <'request_id'>; 
```

Ниже приведен пример выходных данных для запроса, выполненного с отключенным кэшированием результирующего набора.

![Запрос-шаги-with-RSC-Disabled](media/performance-tuning-result-set-caching/query-steps-with-rsc-disabled.png)

Ниже приведен пример выходных данных для запроса, выполненного с включенным кэшированием результирующего набора.

![Запрос — шаги с включенным параметром-RSC](media/performance-tuning-result-set-caching/query-steps-with-rsc-enabled.png)

## <a name="when-cached-results-are-used"></a>При использовании кэшированных результатов

Кэшированный результирующий набор повторно используется для запроса, если все перечисленные ниже требования выполнены.
- Пользователь, выполняющий запрос, имеет доступ ко всем таблицам, на которые имеются ссылки в запросе.
- Существует точное соответствие между новым запросом и предыдущим запросом, создавшим кэш результирующего набора.
- В таблицах, из которых был создан кэшированный результирующий набор, отсутствуют изменения данных или схемы.

Выполните эту команду, чтобы проверить, был ли выполнен запрос с попаданием или промахом кэша результатов. При попадании в кэш result_cache_hit возвратит 1.

```sql
SELECT request_id, command, result_cache_hit FROM sys.dm_pdw_exec_requests 
WHERE request_id = <'Your_Query_Request_ID'>
```

## <a name="manage-cached-results"></a>Управление кэшированными результатами 

Максимальный размер кэша результирующего набора составляет 1 ТБ на базу данных.  Кэшированные результаты автоматически становятся недействительными при изменении данных базового запроса.  

Исключение кэша управляется хранилищем данных SQL Azure автоматически по следующему расписанию: 
- Каждые 48 часов, если результирующий набор не использовался или был признан недействительным. 
- Если размер кэша результирующего набора приближается к максимальному.

Пользователи могут вручную очистить весь кэш результирующего набора с помощью одного из следующих параметров: 
- Отключение функции кэша результирующего набора для базы данных 
- Выполнение инструкции DBCC ДРОПРЕСУЛТСЕТКАЧЕ при подключении к базе данных

Приостановка базы данных не приведет к пустому кэшированному результирующему набору.  

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные советы по разработке см. в статье [Проектные решения и методики программирования для хранилища данных SQL](sql-data-warehouse-overview-develop.md). 
