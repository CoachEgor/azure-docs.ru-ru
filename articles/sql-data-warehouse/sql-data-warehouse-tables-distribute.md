---
title: Руководство по проектированию распределенных таблиц в хранилище данных SQL Azure | Документация Майкрософт
description: Рекомендации по проектированию хэш-распределенных таблиц и таблиц с распределением методом циклического перебора в хранилище данных SQL Azure.
services: sql-data-warehouse
author: ronortloff
manager: craigg
ms.service: sql-data-warehouse
ms.topic: conceptual
ms.subservice: implement
ms.date: 04/17/2018
ms.author: rortloff
ms.reviewer: igorstan
ms.openlocfilehash: c3de7b46449b8075d17a19733eda88d692b1d876
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60935820"
---
# <a name="guidance-for-designing-distributed-tables-in-azure-sql-data-warehouse"></a>Руководство по проектированию распределенных таблиц в хранилище данных SQL Azure
Рекомендации по проектированию хэш-распределенных таблиц и таблиц с распределением методом циклического перебора в хранилище данных SQL Azure.

В этой статье предполагается, что вы знакомы с распределением данных и основными понятиями перемещения данных в хранилище данных SQL.  См. дополнительные сведения о [хранилище данных SQL Azure и архитектуре обработки с массовым параллелизмом (MPP)](massively-parallel-processing-mpp-architecture.md). 

## <a name="what-is-a-distributed-table"></a>Что такое распределенная таблица?
Распределенная таблица отображается как отдельная таблица, но ее строки фактически хранятся в 60 распределениях. Строки распределяются с помощью хэш-алгоритма или алгоритма циклического перебора.  

**Хэш-распределенные таблицы**, описанные в этой статье, повышают производительность запросов в больших таблицах фактов. **Таблицы с распределением методом циклического перебора** используются для ускорения загрузки. Правильный выбор при проектировании может оказать значительное влияние на повышение производительности запросов и скорости загрузки.

Другой вариант хранения таблиц — репликация небольшой таблицы на все вычислительные узлы. Дополнительные сведения см. в статье [Руководство по проектированию для использования реплицированных таблиц в хранилище данных SQL Azure](design-guidance-for-replicated-tables.md). Чтобы быстро выбрать один из трех вариантов, ознакомьтесь с разделом "Распределенные таблицы" в [обзоре таблиц](sql-data-warehouse-tables-overview.md). 

При проектировании таблиц необходимо максимально четко понять, как устроены данные и как выполняются запросы к данным.  Например, для этого можно использовать следующие вопросы:

- Каков размер таблицы?   
- Как часто она обновляется?   
- Имеются ли в хранилище данных таблицы фактов и таблицы измерений?   


### <a name="hash-distributed"></a>Хэш-распределение
Хэш-распределенная таблица распределяет строки между вычислительными узлами с помощью детерминированной хэш-функции. При этом каждая строка назначается одному [распределению](massively-parallel-processing-mpp-architecture.md#distributions). 

![Распределенная таблица](media/sql-data-warehouse-distributed-data/hash-distributed-table.png "Распределенная таблица")  

Так как хэш-функция всегда назначает одинаковые значения в одно и то же распределение, хранилище данных содержит встроенные сведения о расположении строк. Хранилище данных SQL использует эти сведения, чтобы свести к минимуму перемещение данных во время выполнения запросов, что повышает их производительность. 

Хэш-распределенные таблицы подходят для больших таблиц фактов в схеме типа "звезда". Они могут содержать очень большое количество строк и все равно обеспечивать высокую производительность. Конечно, существуют некоторые аспекты проектирования, помогающие достичь производительности, которую должна обеспечивать распределенная система. Выбор соответствующего столбца распределения — первый из этих аспектов, описанных в этой статье. 

Рассмотрите возможность использования хэш-распределенных таблиц, если:

- Размер таблицы на диске превышает 2 ГБ.
- Таблица содержит частые операции вставки, обновления и удаления. 

### <a name="round-robin-distributed"></a>Распределение методом циклического перебора
Таблица с распределением методом циклического перебора равномерно распределяет строки по всем распределениям. Строки произвольным образом назначаются в распределения. В отличие от хэш-распределенных таблиц, строки с одинаковыми значениями не обязательно назначаются в одно и то же распределение. 

Таким образом, чтобы упорядочить данные перед разрешением запроса, системе иногда требуется вызывать операции перемещения данных.  Это дополнительное действие может повлиять на производительность запросов. Например, для операции соединения с таблицей с распределением методом циклического перебора, как правило, требуется перегруппировать строки, что снижает производительность.

Рассмотрите возможность использования распределения методом циклического перебора для таблицы в следующих сценариях:

- если это простая отправная точка для начала работы, так как используется по умолчанию;
- если отсутствует очевидный ключ соединения;
- если отсутствует подходящий для хэш-распределения таблицы столбец;
- если таблица не использует общий ключ соединения с другими таблицами;
- Если соединение менее важно, чем других соединения в запросе.
- если таблица является временной.

В руководстве по [загрузке данных о такси Нью-Йорка в хранилище данных SQL Azure ](load-data-from-azure-blob-storage-using-polybase.md#load-the-data-into-your-data-warehouse) приведен пример загрузки данных в промежуточную таблицу с распределением методом циклического перебора.


## <a name="choosing-a-distribution-column"></a>Выбор столбца распределения
В хэш-распределенной таблице имеется столбец распределения, который является хэш-ключом. Например, приведенный ниже код создает хэш-распределенную таблицу со столбцом распределения ProductKey.

```SQL
CREATE TABLE [dbo].[FactInternetSales]
(   [ProductKey]            int          NOT NULL
,   [OrderDateKey]          int          NOT NULL
,   [CustomerKey]           int          NOT NULL
,   [PromotionKey]          int          NOT NULL
,   [SalesOrderNumber]      nvarchar(20) NOT NULL
,   [OrderQuantity]         smallint     NOT NULL
,   [UnitPrice]             money        NOT NULL
,   [SalesAmount]           money        NOT NULL
)
WITH
(   CLUSTERED COLUMNSTORE INDEX
,  DISTRIBUTION = HASH([ProductKey])
)
;
``` 

Выбор столбца распределения — это важное решение при проектировании, так как значения в этом столбце определяет, как распределяются строки. Лучший выбор зависит от нескольких факторов и обычно включает в себя компромиссы. Тем не менее, если вы не выберете наилучший столбец с первого раза, можно будет выполнить инструкцию [CREATE TABLE AS SELECT (CTAS)](/sql/t-sql/statements/create-table-as-select-azure-sql-data-warehouse), чтобы повторно создать таблицу с другим столбцом распределения. 

### <a name="choose-a-distribution-column-that-does-not-require-updates"></a>Выбор столбца распределения, который не требует обновления
Чтобы обновить столбец распределения, нужно обязательно удалить строку и вставить новую строку с обновленными значениями. Поэтому следует выбрать столбец со статическими значениями. 

### <a name="choose-a-distribution-column-with-data-that-distributes-evenly"></a>Выбор столбца распределения с данными, которые распределены равномерно

Для достижения наилучшей производительности все распределения должны содержать примерно одинаковое число строк. Если одно или несколько распределений содержат непропорционально большое количество строк, то некоторые распределения будут завершать свою часть параллельного запроса раньше прочих. Так как запрос невозможно выполнить до завершения обработки всех распределений, каждый запрос выполняется со скоростью обработки самого медленного распределения.

- Неравномерное распределение данных означает, что данные неравномерно распределяются между распределениями.
- Неравномерная обработка означает, что при выполнении параллельных запросов некоторые распределения обрабатываются дольше, чем другие. Это может произойти, если данные распределены неравномерно.
  
Чтобы сбалансировать параллельную обработку, выберите столбец распределения, который:

- **Содержит много уникальных значений**. Столбец может иметь несколько повторяющихся значений. Однако все строки с одинаковым значением назначаются в одно и то же распределение. Так как существуют 60 распределений, столбец должен иметь по крайней мере 60 уникальных значений.  Обычно количество уникальных значений гораздо больше.
- **Не содержит значений NULL или содержит всего несколько значений NULL.** Яркий пример: если все значения в столбце — это значения NULL, то все строки назначаются в одно и то же распределение. В результате обработка запросов будет использовать только одно распределение, и преимущества параллельной обработки не будут реализованы. 
- **Не является столбцом даты**. Все данные с одинаковой датой попадают в одно распределение. Если несколько пользователей использует фильтр по одной дате, то только 1 из 60 распределений выполняет всю обработку. 

### <a name="choose-a-distribution-column-that-minimizes-data-movement"></a>Выбор столбца распределения, который сводит к минимуму перемещение данных

Для получения корректных результатов запросы могут перемещать данные с одного вычислительного узла на другой. Перемещение данных обычно происходит в том случае, когда запросы содержат операции соединения и агрегирования с распределенными таблицами. Выбор столбца распределения, который минимизирует перемещение данных, — одна из самых важных стратегий оптимизации производительности хранилища данных SQL.

Чтобы минимизировать перемещение данных, выберите столбец распределения, который:

- Используется в предложениях `JOIN`, `GROUP BY`, `DISTINCT`, `OVER` и `HAVING`. Когда с двумя большими таблицами фактов часто выполняются операции соединения, производительность запросов повышается при распределении этих таблицы по одному из столбцов соединения.  Если таблица не используется в операциях соединения, рассмотрите возможность распределения таблицы по столбцу, который часто используется в предложении `GROUP BY`.
- *Не* используется в предложениях `WHERE`. Это может ограничить выполнение запроса, в результате его он будет выполнен не для всех распределений. 
- *Не* является столбцом даты. В предложениях WHERE часто используется фильтрация по дате.  В этом случае вся обработка может быть выполнена только на некоторых распределениях.

### <a name="what-to-do-when-none-of-the-columns-are-a-good-distribution-column"></a>Что делать, если ни один из столбцов не является удачным столбцом распределения

Если ни один из столбцов не содержит достаточное количество уникальных значений, чтобы послужить столбцом распределения, можно создать новый столбец, содержащий одно или несколько значений. Чтобы избежать перемещения данных во время выполнения запросов, используйте составной столбец распределения в качестве столбца соединения в запросах.

После завершения проектирования хэш-распределенной таблицы следующим шагом является загрузка данных в эту таблицу.  Руководство по загрузке представлено в [обзоре загрузки](sql-data-warehouse-overview-load.md). 

## <a name="how-to-tell-if-your-distribution-column-is-a-good-choice"></a>Как определить, удачно ли выбран столбец распределения
После загрузки данных в хэш-распределенную таблицу проверьте, насколько равномерно распределены строки между 60 распределениями. Отличие числа строк на распределение может достигать 10 % без заметного влияния на производительность. 

### <a name="determine-if-the-table-has-data-skew"></a>Как выявить неравномерное распределение данных в таблице
Быстро проверить наличие неравномерного распределения данных можно с помощью [DBCC PDW_SHOWSPACEUSED](/sql/t-sql/database-console-commands/dbcc-pdw-showspaceused-transact-sql). Приведенный ниже код SQL возвращает число строк таблицы, которые хранятся в каждом из 60 распределений. Для обеспечения сбалансированной производительности строки в распределенной таблице должны размещаться равномерно по всем распределениям.

```sql
-- Find data skew for a distributed table
DBCC PDW_SHOWSPACEUSED('dbo.FactInternetSales');
```

Вот как можно определить, в каких таблицах неравномерное распределение данных не превышает 10 %.

1. Создайте представление dbo.vTableSizes, которое показано в статье [Общие сведения о проектировании таблиц в хранилище данных SQL Azure](sql-data-warehouse-tables-overview.md#table-size-queries).  
2. Выполните следующий запрос:

```sql
select *
from dbo.vTableSizes
where two_part_name in
    (
    select two_part_name
    from dbo.vTableSizes
    where row_count > 0
    group by two_part_name
    having (max(row_count * 1.000) - min(row_count * 1.000))/max(row_count * 1.000) >= .10
    )
order by two_part_name, row_count
;
```

### <a name="check-query-plans-for-data-movement"></a>Проверка планов запроса для перемещения данных
Удачный столбец распределения обеспечивает минимальное перемещение данных при операциях соединения и агрегирования. Это влияет на способ программирования соединений. Чтобы обеспечить минимальное перемещение данных при операции соединения с двумя хэш-распределенными таблицами, один из столбцов соединения должен быть столбцом распределения.  Когда выполняется операция соединения с двумя хэш-распределенными таблицами по столбцу распределения того же типа данных, соединение не требует перемещения данных. Операции соединения могут использовать дополнительные столбцы без необходимости перемещения данных.

Вот как можно избежать перемещения данных во время соединения.

- Таблицы, входящие в соединение, должны быть распределены по методу хэш-распределения по **одному** из столбцов соединения.
- Типы данных столбцов соединения в обеих таблицах должны совпадать.
- Объединение столбцов необходимо выполнять с помощью оператора equals.
- Типом соединения не может быть `CROSS JOIN`.

Чтобы узнать, вызывают ли запросы перемещение данных, можно просмотреть план запроса.  


## <a name="resolve-a-distribution-column-problem"></a>Устранение проблемы со столбцом распределения
Устранять все случаи неравномерного распределения данных не обязательно. В основе распределения данных лежит поиск баланса между уменьшением неравномерности распределения данных и перемещения данных. Не всегда можно уменьшить и неравномерность распределения данных, и перемещение данных. Иногда преимущество минимального перемещения данных может компенсировать последствия неравномерного распределения данных.

Чтобы решить, следует ли устранять смещение данных в таблице, нужно узнать как можно больше об объемах данных и запросах в рамках рабочей нагрузки. Можно использовать инструкции в статье [Мониторинг рабочей нагрузки с помощью динамических административных представлений](sql-data-warehouse-manage-monitor.md), чтобы отслеживать влияние неравномерного распределения на производительность запросов. В частности, определите время, затрачиваемое на выполнение больших запросов для отдельных распределений.

Так как невозможно изменить столбец распределения для существующей таблицы, общепринятым способом устранения неравномерного распределения данных является повторное создание таблицы с другим столбцом распределения.  

### <a name="re-create-the-table-with-a-new-distribution-column"></a>Повторное создание таблицы с новым столбцом распределения
В примере ниже для повторного создания таблицы с другим столбцом хэш-распределения используется инструкция [CREATE TABLE AS SELECT](https://docs.microsoft.com/sql/t-sql/statements/create-table-as-select-azure-sql-data-warehouse?view=aps-pdw-2016-au7).

```sql
CREATE TABLE [dbo].[FactInternetSales_CustomerKey]
WITH (  CLUSTERED COLUMNSTORE INDEX
     ,  DISTRIBUTION =  HASH([CustomerKey])
     ,  PARTITION       ( [OrderDateKey] RANGE RIGHT FOR VALUES (   20000101, 20010101, 20020101, 20030101
                                                                ,   20040101, 20050101, 20060101, 20070101
                                                                ,   20080101, 20090101, 20100101, 20110101
                                                                ,   20120101, 20130101, 20140101, 20150101
                                                                ,   20160101, 20170101, 20180101, 20190101
                                                                ,   20200101, 20210101, 20220101, 20230101
                                                                ,   20240101, 20250101, 20260101, 20270101
                                                                ,   20280101, 20290101
                                                                )
                        )
    )
AS
SELECT  *
FROM    [dbo].[FactInternetSales]
OPTION  (LABEL  = 'CTAS : FactInternetSales_CustomerKey')
;

--Create statistics on new table
CREATE STATISTICS [ProductKey] ON [FactInternetSales_CustomerKey] ([ProductKey]);
CREATE STATISTICS [OrderDateKey] ON [FactInternetSales_CustomerKey] ([OrderDateKey]);
CREATE STATISTICS [CustomerKey] ON [FactInternetSales_CustomerKey] ([CustomerKey]);
CREATE STATISTICS [PromotionKey] ON [FactInternetSales_CustomerKey] ([PromotionKey]);
CREATE STATISTICS [SalesOrderNumber] ON [FactInternetSales_CustomerKey] ([SalesOrderNumber]);
CREATE STATISTICS [OrderQuantity] ON [FactInternetSales_CustomerKey] ([OrderQuantity]);
CREATE STATISTICS [UnitPrice] ON [FactInternetSales_CustomerKey] ([UnitPrice]);
CREATE STATISTICS [SalesAmount] ON [FactInternetSales_CustomerKey] ([SalesAmount]);

--Rename the tables
RENAME OBJECT [dbo].[FactInternetSales] TO [FactInternetSales_ProductKey];
RENAME OBJECT [dbo].[FactInternetSales_CustomerKey] TO [FactInternetSales];
```

## <a name="next-steps"></a>Дальнейшие действия

Чтобы создать распределенную таблицу, воспользуйтесь одной из следующих инструкций:

- [CREATE TABLE (хранилище данных Azure SQL)](https://docs.microsoft.com/sql/t-sql/statements/create-table-azure-sql-data-warehouse)
- [CREATE TABLE AS SELECT (хранилище данных Azure SQL)](https://docs.microsoft.com/sql/t-sql/statements/create-table-as-select-azure-sql-data-warehouse)


