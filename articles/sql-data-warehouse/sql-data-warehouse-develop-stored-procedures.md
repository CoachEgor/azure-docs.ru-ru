---
title: Использование хранимых процедур в хранилище данных SQL | Документация Майкрософт
description: Советы по реализации хранимых процедур в хранилище данных SQL Azure для разработки решений.
services: sql-data-warehouse
author: XiaoyuMSFT
manager: craigg
ms.service: sql-data-warehouse
ms.topic: conceptual
ms.subservice: development
ms.date: 04/02/2019
ms.author: xiaoyul
ms.reviewer: igorstan
ms.openlocfilehash: 2c12a679ed5f0a1574deb34df8c0151e737d2d01
ms.sourcegitcommit: 75a56915dce1c538dc7a921beb4a5305e79d3c7a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/24/2019
ms.locfileid: "68479588"
---
# <a name="using-stored-procedures-in-sql-data-warehouse"></a>Использование хранимых процедур в хранилище данных SQL
Советы по реализации хранимых процедур в хранилище данных SQL Azure для разработки решений.

## <a name="what-to-expect"></a>Чего следует ожидать

Хранилище данных SQL Azure поддерживает многие функции T-SQL, которые используются в SQL Server. Что более важно, в нем есть специальные функции горизонтального масштабирования, с помощью которых можно максимально увеличить производительность решения.

Однако существует и некоторые компоненты и функции для обеспечения масштаба и производительности хранилища данных SQL, поведение которых отличается, а также те, что не поддерживаются.


## <a name="introducing-stored-procedures"></a>Введение в хранимые процедуры
Хранимые процедуры — это отличный метод инкапсуляции кода SQL, при котором он хранится близко к данным в хранилище данных. Инкапсуляция кода в хранимые процедуры управляемых элементов помогает разработчикам добиться модульности своих решений и упрощает многократное использование кода. Каждая хранимая процедура может также принимать параметры, что делает их еще более гибкими.

Хранилище данных SQL предоставляет упрощенную и оптимизированную реализацию хранимых процедур. Главное отличие от SQL Server — хранимая процедура не является предварительно скомпилированным кодом. В хранилищах данных время компиляции мало по сравнению со временем, которое требуется для выполнения запросов к большим объемам данных. Более важно убедиться, что код хранимой процедуры правильно оптимизирован для больших запросов. Цель — сэкономить часы, минуты и секунды, но не миллисекунды. Поэтому удобнее считать хранимые процедуры контейнерами для логики SQL.     

Когда хранилище данных SQL выполняет хранимую процедуру, инструкции SQL анализируются, транслируются и оптимизируются во время выполнения. Во время этого процесса каждая инструкция преобразуется в распределенные запросы. Код SQL, который выполняется с данными, отличается от отправляемого запроса.

## <a name="nesting-stored-procedures"></a>Вложенные хранимые процедуры
Когда хранимые процедуры вызывают другие хранимые процедуры или выполняют динамический код SQL, то внутреннюю хранимую процедуру или код вызова называют вложенными.

Хранилище данных SQL Azure поддерживает максимум восемь уровней вложенности. Это немного отличается от SQL Server. Уровень вложенности в SQL Server — 32.

Вызов хранимой процедуры верхнего уровня считается 1 уровнем вложенности.

```sql
EXEC prc_nesting
```
Если хранимая процедура также выполняет еще один вызов EXEC, уровень вложенности увеличится до 2.

```sql
CREATE PROCEDURE prc_nesting
AS
EXEC prc_nesting_2  -- This call is nest level 2
GO
EXEC prc_nesting
```
Если вторая процедура затем выполняет какой-либо динамический SQL-запрос, уровень вложенности увеличится до 3.

```sql
CREATE PROCEDURE prc_nesting_2
AS
EXEC sp_executesql 'SELECT 'another nest level'  -- This call is nest level 2
GO
EXEC prc_nesting
```

Примечание. Хранилище данных SQL в настоящее время не поддерживает [@@NESTLEVEL](/sql/t-sql/functions/nestlevel-transact-sql). Необходимо отслеживать уровень вложенности. Маловероятно, что вы превысите восемь уровней вложенности, но если вы это сделаете, вам нужно переписать свой код, чтобы он соответствовал уровням вложенности в этих пределах.

## <a name="insertexecute"></a>INSERT..EXECUTE
Хранилище данных SQL не разрешает использовать результирующий набор хранимой процедуры в инструкции INSERT. Однако существует другой подход, которым можно воспользоваться. Например, см. статью о [временных таблицах](sql-data-warehouse-tables-temporary.md). 

## <a name="limitations"></a>Ограничения
Существуют некоторые аспекты хранимых процедур Transact-SQL, которые не реализованы в хранилище данных SQL.

Подробные сведения.

* временные хранимые процедуры;
* нумерованные хранимые процедуры;
* расширенные хранимые процедуры;
* хранимые процедуры CLR;
* возможность шифрования;
* возможность репликации;
* параметры с табличным значением;
* параметры только для чтения;
* параметры по умолчанию;
* контекст выполнения;
* инструкция Return.

## <a name="next-steps"></a>Следующие шаги
Дополнительные советы по разработке приведены в [обзоре разработки](sql-data-warehouse-overview-develop.md).

