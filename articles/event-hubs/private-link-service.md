---
title: Интеграция концентраторов событий Azure со службой частной связи Azure
description: Узнайте, как интегрировать концентраторы событий Azure со службой частной связи Azure
services: event-hubs
author: spelluru
ms.author: spelluru
ms.date: 03/12/2020
ms.service: event-hubs
ms.topic: article
ms.openlocfilehash: 110d4b94eda8315c20f4baa70256f7e5ed378530
ms.sourcegitcommit: 354a302d67a499c36c11cca99cce79a257fe44b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2020
ms.locfileid: "82106480"
---
# <a name="integrate-azure-event-hubs-with-azure-private-link-preview"></a>Интеграция концентраторов событий Azure с помощью частной связи Azure (Предварительная версия)
Служба "Частная связь Azure" позволяет получать доступ к службам Azure (например, концентраторам событий Azure, службе хранилища Azure и Azure Cosmos DB) и службам клиентов и партнеров Azure, размещенным в **частной конечной точке** в виртуальной сети.

Частная конечная точка — это сетевой интерфейс, который обеспечивает безопасное и надежное подключение к службе с помощью частной связи Azure. Частная конечная точка использует частный IP-адрес из виртуальной сети, по сути перемещая службу в виртуальную сеть. Весь трафик к службе может маршрутизироваться через частную конечную точку, поэтому шлюзы, устройства преобразования сетевых адресов (NAT), подключения ExpressRoute и VPN, а также общедоступные IP-адреса не требуются. Трафик между виртуальной сетью и службой проходит через магистральную сеть Майкрософт, что позволяет избежать рисков общедоступного Интернета. Вы можете подключиться к экземпляру ресурса Azure, обеспечивая наивысшую степень детализации в управлении доступом.

Дополнительные сведения см. в статье [Что такое Приватный канал Azure](../private-link/private-link-overview.md).

> [!IMPORTANT]
> Эта функция поддерживается только на **выделенном** уровне. Дополнительные сведения о выделенном уровне см. в разделе [Общие сведения о центры событий (цен. Категория "выделенный")](event-hubs-dedicated-overview.md). 
>
> Сейчас эта функция доступна в **предварительной версии**. 

>[!WARNING]
> Включение частных конечных точек может препятствовать взаимодействию других служб Azure с концентраторами событий.
>
> Доверенные службы Майкрософт не поддерживаются, если реализованы виртуальные сети.
>
> Распространенные сценарии Azure, которые не работают с виртуальными сетями (обратите внимание, что список **НЕ** является исчерпывающим):
> - Azure Monitor (параметр диагностики)
> - Azure Stream Analytics
> - Интеграция со службой "Сетка событий Azure".
> - Маршруты Центра Интернета вещей Azure.
> - Device Explorer Интернета вещей Azure.
>
> Следующие службы Майкрософт должны находиться в виртуальной сети
> - Веб-приложения Azure
> - Функции Azure

## <a name="add-a-private-endpoint-using-azure-portal"></a>Добавление частной конечной точки с помощью портал Azure

### <a name="prerequisites"></a>Предварительные требования

Чтобы интегрировать пространство имен концентраторов событий с помощью частной ссылки Azure, вам потребуются следующие сущности или разрешения:

- Пространство имен Центров событий.
- Виртуальная сеть Azure.
- Подсеть в виртуальной сети.
- Разрешения владельца или участника для пространства имен и виртуальной сети.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. При выборе региона для частной конечной точки с помощью портала будут автоматически фильтроваться только виртуальные сети в этом регионе. Пространство имен может находиться в другом регионе.

Частная конечная точка использует частный IP-адрес в виртуальной сети.

### <a name="steps"></a>Шаги
Если у вас уже есть пространство имен концентраторов событий, можно создать подключение к частной ссылке, выполнив следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com). 
2. В строке поиска введите **концентраторы событий**.
3. Выберите **пространство имен** из списка, в который необходимо добавить частную конечную точку.
4. Выберите вкладку **сети** в разделе **Параметры**.
5. Выберите вкладку **подключения к частным конечным точкам (Предварительная версия)** в верхней части страницы. Если вы не используете выделенный уровень концентраторов событий, вы увидите сообщение: **подключения к частным конечным точкам в концентраторах событий поддерживаются только пространствами имен, созданными в выделенном кластере**.
6. Нажмите кнопку **+ Частная конечная точка** в верхней части страницы.

    ![Образ —](./media/private-link-service/private-link-service-3.png)
7. На странице **Основные сведения** выполните следующие действия. 
    1. Выберите **подписку Azure** , в которой вы хотите создать закрытую конечную точку. 
    2. Выберите **группу ресурсов** для ресурса частной конечной точки.
    3. Введите **имя** частной конечной точки. 
    5. Выберите **регион** для закрытой конечной точки. Частная конечная точка должна находиться в том же регионе, что и виртуальная сеть, но может находиться в другом регионе, из ресурс закрытой ссылки, к которому вы подключаетесь. 
    6. Нажмите кнопку **Далее: >ресурсов** в нижней части страницы.

        ![Создание частной конечной точки — страница "Основные сведения"](./media/private-link-service/create-private-endpoint-basics-page.png)
8. На странице **ресурсов** выполните следующие действия.
    1. Если **в моем каталоге выбран вариант подключиться к ресурсу Azure**, то для метода подключения выполните следующие действия. 
        1. Выберите **подписку Azure** , в которой существует **пространство имен концентраторов событий** . 
        2. В поле **тип ресурса**выберите **Microsoft. EventHub/пространства имен** для **типа ресурса**.
        3. В поле **ресурс**выберите пространство имен концентраторов событий из раскрывающегося списка. 
        4. Убедитесь, что **целевой подресурс** имеет значение **пространство имен**.
        5. Нажмите кнопку **Далее: >конфигурации** в нижней части страницы. 
        
            ![Создание частной конечной точки — страница ресурсов](./media/private-link-service/create-private-endpoint-resource-page.png)    
    2. Если вы выбрали **подключиться к ресурсу Azure по идентификатору или псевдониму ресурса**, выполните следующие действия.
        1. Введите идентификатор или **псевдоним** **ресурса** . Это может быть идентификатор ресурса или псевдоним, к которому вам предоставили доступ некоторые.
        2. В качестве **целевого вспомогательного ресурса**введите **Namespace**. Это тип подресурса, к которому имеет доступ частная конечная точка.
        3. используемых Введите **сообщение запроса**. Владелец ресурса видит это сообщение при управлении подключением к частной конечной точке.
        4. Затем нажмите кнопку **Далее: настройка >** в нижней части страницы.

            ![Создание частной конечной точки — подключение с использованием идентификатора ресурса](./media/private-link-service/connect-resource-id.png)
9. На странице **Конфигурация** выберите подсеть в виртуальной сети, в которую требуется развернуть закрытую конечную точку. 
    1. Выберите **виртуальную сеть**. В раскрывающемся списке перечислены только виртуальные сети в выбранной подписке и расположении. 
    2. Выберите **подсеть** в выбранной виртуальной сети. 
    3. Нажмите кнопку **Далее: теги >** в нижней части страницы. 

        ![Создание частной конечной точки — страница конфигурации](./media/private-link-service/create-private-endpoint-configuration-page.png)
10. На странице **теги** создайте теги (имена и значения), которые нужно связать с ресурсом частной конечной точки. Затем в нижней части страницы нажмите кнопку **Просмотр и создание** . 
11. На странице **Просмотр и создание**проверьте все параметры и выберите **создать** , чтобы создать частную конечную точку.
    
    ![Создание закрытой конечной точки — Просмотр и создание страницы](./media/private-link-service/create-private-endpoint-review-create-page.png)
12. Убедитесь, что созданное подключение к частной конечной точке отображается в списке конечных точек. В этом примере частная конечная точка будет утверждена как автоматическая, так как вы подключились к ресурсу Azure в вашем каталоге и имеете достаточные разрешения. 

    ![Закрытая конечная точка создана](./media/private-link-service/private-endpoint-created.png)

## <a name="add-a-private-endpoint-using-powershell"></a>Добавление частной конечной точки с помощью PowerShell
В следующем примере показано, как использовать Azure PowerShell для создания подключения к частной конечной точке. Он не создает выделенный кластер. Выполните действия, описанные в [этой статье](event-hubs-dedicated-cluster-create-portal.md) , чтобы создать выделенный кластер концентраторов событий. 

```azurepowershell-interactive
# create resource group

$rgName = "<RESOURCE GROUP NAME>"
$vnetlocation = "<VIRTUAL NETWORK LOCATION>"
$vnetName = "<VIRTUAL NETWORK NAME>"
$subnetName = "<SUBNET NAME>"
$namespaceLocation = "<NAMESPACE LOCATION>"
$namespaceName = "<NAMESPACE NAME>"
$peConnectionName = "<PRIVATE ENDPOINT CONNECTION NAME>"

# create virtual network
$virtualNetwork = New-AzVirtualNetwork `
                    -ResourceGroupName $rgName `
                    -Location $vnetlocation `
                    -Name $vnetName `
                    -AddressPrefix 10.0.0.0/16

# create subnet with endpoint network policy disabled
$subnetConfig = Add-AzVirtualNetworkSubnetConfig `
                    -Name $subnetName `
                    -AddressPrefix 10.0.0.0/24 `
                    -PrivateEndpointNetworkPoliciesFlag "Disabled" `
                    -VirtualNetwork $virtualNetwork

# update virtual network
$virtualNetwork | Set-AzVirtualNetwork

# create an event hubs namespace in a dedicated cluster
$namespaceResource = New-AzResource -Location $namespaceLocation `
                                    -ResourceName $namespaceName `
                                    -ResourceGroupName $rgName `
                                    -Sku @{name = "Standard"; capacity = 1} `
                                    -Properties @{clusterArmId = "/subscriptions/<SUBSCRIPTION ID>/resourceGroups/<RESOURCE GROUP NAME>/providers/Microsoft.EventHub/clusters/<EVENT HUBS CLUSTER NAME>"} `
                                    -ResourceType "Microsoft.EventHub/namespaces" -ApiVersion "2018-01-01-preview"

# create private endpoint connection
$privateEndpointConnection = New-AzPrivateLinkServiceConnection `
                                -Name $peConnectionName `
                                -PrivateLinkServiceId $namespaceResource.ResourceId `
                                -GroupId "namespace"

# get subnet object that you will use later
$virtualNetwork = Get-AzVirtualNetwork -ResourceGroupName  $rgName -Name $vnetName
$subnet = $virtualNetwork | Select -ExpandProperty subnets `
                                | Where-Object  {$_.Name -eq $subnetName}  
   
# create a private endpoint   
$privateEndpoint = New-AzPrivateEndpoint -ResourceGroupName $rgName  `
                                -Name $vnetName   `
                                -Location $vnetlocation `
                                -Subnet  $subnet   `
                                -PrivateLinkServiceConnection $privateEndpointConnection

(Get-AzResource -ResourceId $namespaceResource.ResourceId -ExpandProperties).Properties


```

### <a name="configure-the-private-dns-zone"></a>Настройка частной зоны DNS
Создайте частную зону DNS для домена концентраторов событий и создайте связь связи с виртуальной сетью.

```azurepowershell-interactive
$zone = New-AzPrivateDnsZone -ResourceGroupName $rgName `
                            -Name "privatelink.servicebus.windows.net" 
 
$link  = New-AzPrivateDnsVirtualNetworkLink -ResourceGroupName $rgName `
                                            -ZoneName "privatelink.servicebus.windows.net" `
                                            -Name "mylink" `
                                            -VirtualNetworkId $virtualNetwork.Id  
 
$networkInterface = Get-AzResource -ResourceId $privateEndpoint.NetworkInterfaces[0].Id -ApiVersion "2019-04-01" 
 
foreach ($ipconfig in $networkInterface.properties.ipConfigurations) { 
    foreach ($fqdn in $ipconfig.properties.privateLinkConnectionProperties.fqdns) { 
        Write-Host "$($ipconfig.properties.privateIPAddress) $($fqdn)"  
        $recordName = $fqdn.split('.',2)[0] 
        $dnsZone = $fqdn.split('.',2)[1] 
        New-AzPrivateDnsRecordSet -Name $recordName -RecordType A -ZoneName "privatelink.servicebus.windows.net"  `
                                -ResourceGroupName $rgName -Ttl 600 `
                                -PrivateDnsRecords (New-AzPrivateDnsRecordConfig -IPv4Address $ipconfig.properties.privateIPAddress)  
    } 
}
```

## <a name="manage-private-endpoints-using-azure-portal"></a>Управление частными конечными точками с помощью портал Azure

При создании частной конечной точки подключение должно быть утверждено. Если ресурс, для которого создается частная конечная точка, находится в вашем каталоге, вы можете утвердить запрос на подключение, если у вас есть необходимые разрешения. При подключении к ресурсу Azure в другом каталоге необходимо дождаться, пока владелец этого ресурса утвердит запрос на подключение.

Существует четыре состояния подготовки:

| Действие службы | Состояние частной конечной точки объекта-получателя службы | Описание |
|--|--|--|
| None | Ожидает | Подключение создается вручную и ожидает утверждения от владельца ресурса Приватного канала. |
| Утверждение | Approved | Подключение утверждено автоматически или вручную и готово к использованию. |
| Reject | Отклонено | Подключение отклонил владелец ресурса Приватного канала. |
| Удалить | Отключено | Подключение удалил владелец ресурса Приватного канала. Частная конечная точка станет информативной и подлежит удалению для очистки. |
 
###  <a name="approve-reject-or-remove-a-private-endpoint-connection"></a>Утверждение, отклонение или удаление подключения к частной конечной точке

1. Войдите на портал Azure.
2. В строке поиска введите **концентраторы событий**.
3. Выберите **пространство имен** , которым требуется управлять.
4. Перейдите на вкладку **сети** .
5. Перейдите к соответствующему разделу в зависимости от операции, которую нужно выполнить: утвердить, отклонить или удалить.

### <a name="approve-a-private-endpoint-connection"></a>Утверждение подключения к частной конечной точке
1. Если ожидаются какие-либо подключения, в состоянии подготовки вы увидите подключение в списке **Ожидание** . 
2. Выберите **закрытую конечную точку** , которую вы хотите утвердить
3. Нажмите кнопку **утвердить** .

    ![Образ —](./media/private-link-service/approve-private-endpoint.png)
4. На странице **утверждение подключения** добавьте комментарий (необязательно) и выберите **Да**. Если выбрано значение **нет**, ничего не происходит. 
5. Состояние подключения к частной конечной точке должно отобразиться в списке изменено на **утверждено**. 

### <a name="reject-a-private-endpoint-connection"></a>Отклонение подключения к частной конечной точке

1. Если есть подключения к частным конечным точкам, которые вы хотите отклонить, является ли он ожидающим запросом или существующим соединением, выберите соединение и нажмите кнопку **отклонить** .

    ![Образ —](./media/private-link-service/private-endpoint-reject-button.png)
2. На странице **отклонить подключение** введите комментарий (необязательно) и нажмите **кнопку Да**. Если выбрано значение **нет**, ничего не происходит. 
3. Состояние подключения к частной конечной точке должно отобразиться в списке изменено на **отклонено**. 

### <a name="remove-a-private-endpoint-connection"></a>Удаление подключения к частной конечной точке

1. Чтобы удалить подключение к частной конечной точке, выберите его в списке и нажмите кнопку **Удалить** на панели инструментов.
2. На странице **Удаление подключения** выберите **Да** , чтобы подтвердить удаление закрытой конечной точки. Если выбрано значение **нет**, ничего не происходит.
3. Вы увидите, что состояние изменилось на **отключено**. Затем вы увидите, что конечная точка исчезнет из списка.

## <a name="validate-that-the-private-link-connection-works"></a>Проверка работоспособности подключения Приватного канала

Необходимо проверить, что ресурсы в одной подсети ресурса частной конечной точки подключаются к пространству имен концентраторов событий по частному IP-адресу и что они имеют правильную интеграцию частной зоны DNS.

Сначала создайте виртуальную машину, выполнив действия, описанные в статье [Краткое руководство. Создание виртуальной машины Windows на портале Azure](../virtual-machines/windows/quick-create-portal.md).

На вкладке **Сетевые подключения** выполните следующие действия.

1. Укажите **виртуальную сеть** и **подсеть**. Можно создать виртуальную сеть или выбрать существующую. При выборе существующей сети убедитесь, что регион соответствует.
1. Укажите ресурс **общедоступного IP-адреса** .
1. В **группе сетевой сетевой безопасности**выберите **нет**.
1. В поле **Балансировка нагрузки**выберите **нет**.

Откройте командную строку и выполните следующую команду:

```console
nslookup <your-event-hubs-namespace-name>.servicebus.windows.net
```

Если выполнить команду NS Lookup, чтобы разрешить IP-адрес пространства имен концентраторов событий через общедоступную конечную точку, вы увидите результат, который выглядит следующим образом:

```console
c:\ >nslookup <your-event-hubs-namespae-name>.servicebus.windows.net

Non-authoritative answer:
Name:    
Address:  (public IP address)
Aliases:  <your-event-hubs-namespace-name>.servicebus.windows.net
```

Если выполнить команду NS Lookup, чтобы разрешить IP-адрес пространства имен концентраторов событий через частную конечную точку, вы увидите результат, который выглядит следующим образом:

```console
c:\ >nslookup your_event-hubs-namespace-name.servicebus.windows.net

Non-authoritative answer:
Name:    
Address:  10.1.0.5 (private IP address)
Aliases:  <your-event-hub-name>.servicebus.windows.net
```

## <a name="limitations-and-design-considerations"></a>Ограничения и рекомендации по проектированию

**Цены**. Сведения о ценах на службу "Приватный канал Azure" см. [здесь](https://azure.microsoft.com/pricing/details/private-link/).

**Ограничения**. Частная конечная точка для концентраторов событий Azure доступна в общедоступной предварительной версии. Эта возможность есть во всех общедоступных регионах Azure.

**Максимальное число частных конечных точек на пространство имен концентраторов событий**: 120.

Дополнительные сведения см. в разделе [Azure Private Link service: Limitations](../private-link/private-link-service-overview.md#limitations) (Служба "Приватный канал Azure". Ограничения)

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о службе [Приватный канал Azure](../private-link/private-link-service-overview.md)
- Дополнительные сведения о [концентраторах событий Azure](event-hubs-about.md)
