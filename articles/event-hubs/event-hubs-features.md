---
title: Обзор функций Центров событий Azure | Документация Майкрософт
description: В этой статье приводится терминология и сведения о функциях Центров событий Azure.
ms.topic: article
ms.date: 06/23/2020
ms.openlocfilehash: 9e004b3a8a9dd454eae5a20564a1ab74a26b66d5
ms.sourcegitcommit: 62e1884457b64fd798da8ada59dbf623ef27fe97
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2020
ms.locfileid: "88936237"
---
# <a name="features-and-terminology-in-azure-event-hubs"></a>Функции и терминология в Центрах событий Azure

Центры событий Azure — это масштабируемая служба обработки событий, которая принимает и обрабатывает большие объемы событий и данных с низкой задержкой и высокой надежностью. Подробный обзор этой службы см. в статье [Что такое Центры событий?](./event-hubs-about.md).

Эта статья продолжает тему [Центров событий](./event-hubs-about.md) и содержит техническую информацию и сведения о реализации компонентов и функций этой службы.

## <a name="namespace"></a>Пространство имен
Пространство имен концентраторов событий предоставляет уникальный контейнер, ограничивающий область действия. Вы можете обращаться к этому контейнеру по [полному доменному имени](https://en.wikipedia.org/wiki/Fully_qualified_domain_name) и создавать в нем концентраторы событий или разделы Kafka. 

## <a name="event-hubs-for-apache-kafka"></a>Центры событий для Apache Kafka

[Эта функция](event-hubs-for-kafka-ecosystem-overview.md) предоставляет конечную точку, которая позволяет клиентам обращаться к концентраторам событий с помощью протокола Kafka. Такая интеграция обеспечивает клиентам конечную точку Kafka. Благодаря этому пользователи могут настроить свои существующие приложения Kafka, для взаимодействия с концентраторами событий, предоставляя альтернативу запуску собственных кластеров Kafka. Концентраторы событий для Apache Kafka поддерживают протокол Kafka версии 1.0 и более поздних версий. 

При такой интеграции вам не нужно запускать кластеры Kafka или управлять ими с помощью Zookeeper. Это также позволяет работать с некоторыми из самых требовательных функций концентраторов событий, такими как Сбор, Автоматическое расширение и Геоизбыточное аварийное восстановление.

Такая интеграция также позволяет таким приложениям как Mirror Maker или платформе как Kafka Connect работать без кластеров с недавно измененной конфигурацией. 

## <a name="event-publishers"></a>Издатели событий

Любая сущность, которая отправляет данные в концентратор событий, является создателем или *издателем событий*. Издатели событий могут публиковать события с помощью HTTPS, AMQP 1.0 или Kafka (версия 1.0 и более поздние). Издатели событий используют маркер подписанного URL-адреса (SAS), чтобы идентифицировать себя в концентраторе событий. Также они могут использовать уникальное удостоверение или общий подписанный URL-адрес.

### <a name="publishing-an-event"></a>Публикация события

Вы можете опубликовать событие через протокол AMQP 1.0, Kafka 1.0 (или более поздние) или HTTPS. Центры событий предоставляют [клиентские библиотеки и классы](./event-hubs-dotnet-framework-getstarted-send.md) для публикации событий в концентраторе событий от клиентов .NET. Для других сред выполнения и платформ можно использовать любой клиент AMQP 1.0, например [Apache Qpid](https://qpid.apache.org/). Можно публиковать события по отдельности или в пакетном режиме. Для одной публикации (экземпляра данных события) установлено ограничение в 1 МБ, независимо от того, одиночное это событие или пакет. Публикация событий, размер которых превышает это пороговое значение, приводит к ошибке. Рекомендуется, чтобы издатели не знают о секциях в концентраторе событий и указали *ключ секции* (представленный в следующем разделе) или их удостоверение через маркер SAS.

Решение об использовании AMQP или HTTPS обусловлено сценарием использования. AMQP требует установки постоянного двунаправленного сокета в дополнение к безопасности на уровне транспорта (TLS) или протоколу SSL/TLS. При инициализации сеанса AMQP имеет более высокие затраты на сеть, однако для каждого запроса протокол HTTPS требует дополнительной нагрузки TLS. AMQP отличается более высокой производительностью при частых публикациях.

![Ключи секции](./media/event-hubs-features/partition_keys.png)

Центры событий обеспечивают доставку всех событий, использующих одинаковое значение ключа секции, в соответствующем порядке и в одну секцию. Если ключи секций используются с применением политик издателя, удостоверение издателя и значение ключа секции должны совпадать. В противном случае возникает ошибка.

### <a name="publisher-policy"></a>Политика издателя

Центры событий обеспечивают точный контроль над издателями событий через *политики издателя*. Политики издателя — это функции среды выполнения, которые упрощают обработку большого количества независимых издателей событий. Благодаря политикам издателя каждый издатель использует свой собственный уникальный идентификатор при публикации событий в концентраторе событий с помощью следующего механизма:

```http
//<my namespace>.servicebus.windows.net/<event hub name>/publishers/<my publisher name>
```

Не требуется создавать имена издателей заранее, но они должны соответствовать маркеру SAS, который используется при публикации события, для обеспечения идентификации независимого издателя. При использовании политик издателей значению **PartitionKey** присваивается имя издателя. Для правильной работы эти значения должны совпадать.

## <a name="capture"></a>Сбор данных

[Функция "Сбор" в Центрах событий](event-hubs-capture-overview.md) позволяет автоматически собирать данные потоковой передачи в Центры событий и сохранять их в выбранной учетной записи хранения BLOB-объектов или учетной записи службы Azure Data Lake. Эту функцию можно включить на портале Azure и указать минимальный размер записываемых данных и интервал времени для записи. С помощью функции "Сбор" в Центрах событий можно указать собственную учетную запись хранилища BLOB-объектов Azure и контейнер или учетную запись службы Azure Data Lake, используемую для хранения собранных данных. Зафиксированные данные записываются в формате Apache Avro.

## <a name="partitions"></a>Секции
[!INCLUDE [event-hubs-partitions](../../includes/event-hubs-partitions.md)]


## <a name="sas-tokens"></a>Маркеры SAS

Концентраторы событий используют *подписанные*URL-адрес, которые доступны на уровне пространства имен и концентратора событий. Маркер SAS создается на основе ключа SAS и хэша SHA URL-адреса, закодированного в определенном формате. С помощью имени ключа (политики) и маркера Центры событий могут повторно создать хэш, чтобы аутентифицировать отправителя. Как правило, маркеры SAS для издателей событий создаются только с привилегиями **отправки** в определенном концентраторе событий. Этот механизм URL-адреса маркера SAS является основой для идентификации издателя, представленной в политике издателя. Дополнительные сведения о работе с SAS см. в статье [Проверка подлинности подписи при общем доступе с помощью служебной шины](../service-bus-messaging/service-bus-sas.md).

## <a name="event-consumers"></a>Получатели событий

Любая сущность, считывающая данные о событиях из концентратора событий, является *потребителем события*. Все потребители Центров событий подключаются через сеанс AMQP 1.0, в рамках которого события доставляются, как только становятся доступными. Клиенту не требуется проводить опрос доступности данных.

### <a name="consumer-groups"></a>Группы потребителей

Механизм публикации или подписки центров событий включается с помощью *групп потребителей*. Группа потребителей — это представление всего концентратора событий (состояние, позиция или смещение). Группы потребителей обеспечивают каждому из нескольких потребляющих приложений отдельное представление потока событий, а также возможность считывания потока независимо друг от друга в своем темпе и с собственными смещениями.

В архитектуре обработки потока каждое потребляющее приложение соответствует группе потребителей. Если вы хотите записать данные событий в долговременное хранилище, то приложение, записывающее данные в хранилище, является группой потребителей. Сложную обработку событий затем может выполнить еще одна (отдельная) группа потребителей. К секции можно обращаться только через группу потребителей. В концентраторе событий всегда есть группа потребителей по умолчанию, и можно создать до 20 групп потребителей для концентратора событий стандартного уровня.

В секции для каждой группы потребителей может существовать не более пяти одновременных считывателей. Однако **рекомендуется, чтобы в секции для каждой группы потребителей поддерживался только один активный получатель**. Внутри одного раздела каждый читатель получает все сообщения. Если в одном разделе находится несколько читателей, процесс обработки сообщений будет дублироваться. Это нужно обработать в своем коде, что не может быть тривиальной задачей. Тем не менее для некоторых сценариев такой поход допустим.

Некоторые клиенты, предлагаемые пакетами SDK для Azure, являются интеллектуальными агентами потребителей, которые автоматически управляют сведениями о том, что каждая секция имеет один модуль чтения и что все секции для концентратора событий считываются из. Это позволяет коду сосредоточиться на обработке событий, считываемых из концентратора событий, чтобы можно было пропускать многие сведения о секциях. Дополнительные сведения см. [в разделе Подключение к разделу](#connect-to-a-partition).

В следующих примерах показано соглашение универсального кода ресурса группы потребителей.

```http
//<my namespace>.servicebus.windows.net/<event hub name>/<Consumer Group #1>
//<my namespace>.servicebus.windows.net/<event hub name>/<Consumer Group #2>
```

На следующем рисунке показана архитектура обработки потока Центров событий.

![Архитектура концентраторов событий](./media/event-hubs-features/event_hubs_architecture.png)

### <a name="stream-offsets"></a>Смещение потока

*Смещение* — это положение события внутри секции. Смещение можно представить как клиентский курсор. Смещение представляет собой байт-нумерацию события. Благодаря этому потребитель события (модуль чтения) может указать точку в потоке событий, с которой требуется начать чтение событий. Можно указать смещение как отметку времени или как значение смещения. Потребители ответственны за хранение своих собственных значений смещения вне службы "Центры событий". В секции каждое событие включает смещение.

![Смещение секции](./media/event-hubs-features/partition_offset.png)

### <a name="checkpointing"></a>Назначение контрольных точек

*Создание контрольных точек* — это процесс, с помощью которого модули чтения помечают или фиксируют свое положение в последовательности событий секции. Создание контрольных точек является ответственностью потребителя и выполняется для каждой секции в пределах группы потребителей. Это означает, что для каждой группы потребителей модуль чтения каждой секции должен хранить свое текущее положение в потоке событий и может сообщать службе, когда он считает поток данных завершенным.

Если модуль чтения отключается от секции, при повторном подключении он приступает к чтению данных с контрольной точки, которая ранее была отправлена последним модулем чтения этой секции в этой группе потребителей. При подключении модуль чтения передает это смещение в концентратор событий, чтобы указать место, с которого следует начинать чтение. Таким образом, можно использовать контрольные точки как для маркировки событий как "завершенных" подчиненными приложениями, так и для обеспечения устойчивости в случае отработки отказа между модулями чтения, работающими на разных компьютерах. Вы можете вернуться к предыдущим данным, указав более низкое значение смещения по отношению к этому процессу создания контрольных точек. В рамках такого подхода при создании контрольных точек вы обеспечиваете отказоустойчивость и воспроизведение потока событий.

> [!NOTE]
> Если вы используете хранилище BLOB-объектов Azure в качестве хранилища контрольных точек в среде, которая поддерживает другую версию пакета SDK для большого двоичного объекта хранилища, чем обычно доступно в Azure, необходимо использовать код, чтобы изменить версию API службы хранилища до определенной версии, поддерживаемой этой средой. Например, если вы используете [концентраторы событий в Azure Stack Hub версии 2002](/azure-stack/user/event-hubs-overview), самая высокая доступная версия для службы хранилища — версия 2017-11-09. В этом случае необходимо использовать код для настройки API службы хранилища до версии 2017-11-09. Пример назначения конкретной версии API хранилища см. в следующих примерах на сайте GitHub: 
> - [.NET](https://github.com/Azure/azure-sdk-for-net/tree/master/sdk/eventhub/Azure.Messaging.EventHubs.Processor/samples/Sample10_RunningWithDifferentStorageVersion.cs). 
> - [Java](https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/eventhubs/azure-messaging-eventhubs-checkpointstore-blob/src/samples/java/com/azure/messaging/eventhubs/checkpointstore/blob/)
> - [JavaScript](https://github.com/Azure/azure-sdk-for-js/blob/master/sdk/eventhub/eventhubs-checkpointstore-blob/samples/javascript) или  [TypeScript](https://github.com/Azure/azure-sdk-for-js/blob/master/sdk/eventhub/eventhubs-checkpointstore-blob/samples/typescript)
> - [Python](https://github.com/Azure/azure-sdk-for-python/blob/master/sdk/eventhub/azure-eventhub-checkpointstoreblob-aio/samples/)

### <a name="common-consumer-tasks"></a>Стандартные задачи потребителя

Все потребители Центров событий подключаются через двунаправленный канал связи с поддержкой состояния и сеанса AMQP 1.0. Каждая секция связана с сеансом связи AMQP 1.0, что упрощает транспортировку событий, разделенных по секциям.

#### <a name="connect-to-a-partition"></a>Подключение к секции

При соединении с секциями обычно используется механизм аренды для координации соединений чтения с конкретными секциями. Таким образом, каждый раздел в группе потребителей может иметь только один активный модуль чтения. Создание контрольных точек, предоставление аренды и управление читателями упрощены с помощью клиентов в пакетах SDK концентраторов событий, которые действуют как интеллектуальные агенты потребителей. А именно:

- [Евентпроцессорклиент](/dotnet/api/azure.messaging.eventhubs.eventprocessorclient) для .NET
- [Евентпроцессорклиент](/java/api/com.azure.messaging.eventhubs.eventprocessorclient) для Java
- [Евенсубконсумерклиент](/python/api/azure-eventhub/azure.eventhub.aio.eventhubconsumerclient) для Python
- [Евенсубконсумерклиент](/javascript/api/@azure/event-hubs/eventhubconsumerclient) для JavaScript/TypeScript

#### <a name="read-events"></a>Чтение событий

После открытия сеанса и связи AMQP 1.0 для определенной секции служба Центров событий доставляет события в клиент AMQP 1.0. Этот механизм доставки обеспечивает более высокую пропускную способность и меньшую задержку, чем механизмы извлечения по запросу, такие как HTTP GET. Когда события отправляются клиенту, каждый экземпляр данных событий содержит важные метаданные, такие как смещение и порядковый номер, которые используются для упрощения создания контрольных точек в последовательности событий.

Данные событий
* Offset
* Порядковый номер
* Текст
* Свойства пользователя
* Свойства системы

Пользователь управляет смещением самостоятельно.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о Центрах событий см. по следующим ссылкам:

- Приступая к работе с Центрами событий
    - [.NET](event-hubs-dotnet-standard-getstarted-send.md)
    - [Java](event-hubs-java-get-started-send.md)
    - [Python](event-hubs-python-get-started-send.md)
    - [JavaScript](event-hubs-java-get-started-send.md)
* [Руководство по программированию Центров событий](event-hubs-programming-guide.md)
* [Доступность и согласованность в Центрах событий](event-hubs-availability-and-consistency.md)
* [Часто задаваемые вопросы о Центрах событий](event-hubs-faq.md)
* [Примеры Центров событий](event-hubs-samples.md)
