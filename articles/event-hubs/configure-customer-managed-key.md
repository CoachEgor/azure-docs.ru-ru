---
title: Настройка собственного ключа для шифрования неактивных данных концентраторов событий Azure
description: В этой статье содержатся сведения о том, как настроить собственный ключ для шифрования оставшейся работы данных концентраторов событий Azure.
services: event-hubs
ms.service: event-hubs
documentationcenter: ''
author: spelluru
ms.topic: conceptual
ms.date: 08/13/2019
ms.author: spelluru
ms.openlocfilehash: 311f69ffa436eebb261fb8aa5ee72886ad9fe9d0
ms.sourcegitcommit: 94ee81a728f1d55d71827ea356ed9847943f7397
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2019
ms.locfileid: "70035911"
---
# <a name="configure-customer-managed-keys-for-encrypting-azure-event-hubs-data-at-rest-by-using-the-azure-portal"></a>Настройка управляемых клиентом ключей для шифрования неактивных данных концентраторов событий Azure с помощью портал Azure
Концентраторы событий Azure обеспечивают шифрование неактивных данных с помощью Azure Шифрование службы хранилища (Azure SSE). Концентраторы событий используют хранилище Azure для хранения данных. по умолчанию все данные, хранящиеся в службе хранилища Azure, шифруются с помощью ключей, управляемых корпорацией Майкрософт. 

## <a name="overview"></a>Обзор
Концентраторы событий Azure теперь поддерживают возможность шифрования неактивных данных с помощью ключей, управляемых корпорацией Майкрософт, или ключей, управляемых клиентом (создание собственных ключей – BYOK). Эта функция позволяет создавать, поворачивать, отключать и отменять доступ к управляемым клиентом ключам, которые используются для шифрования неактивных данных концентраторов событий Azure.

Включение функции BYOK — это процесс установки в пространстве имен.

> [!NOTE]
> Возможность BYOK поддерживается выделенными в концентраторами событий кластерами с [одним клиентом](event-hubs-dedicated-overview.md) . Его нельзя включить для стандартных пространств имен концентраторов событий.

Вы можете использовать Azure Key Vault для управления ключами и аудита использования ключа. Можно либо создать собственные ключи и сохранить их в хранилище ключей, либо использовать Azure Key Vault API для создания ключей. Дополнительные сведения о хранилище ключей Azure см. в статье [Что такое хранилище ключей Azure?](../key-vault/key-vault-overview.md)

В этой статье показано, как настроить хранилище ключей с ключами, управляемыми клиентом, с помощью портал Azure. Сведения о создании хранилища ключей с помощью портал Azure см. в разделе [] Краткое руководство. Задайте и извлеките секрет из Azure Key Vault с помощью портал Azure] (.. /Кэй-Ваулт/куикк-креате-портал.МД).

> [!IMPORTANT]
> Для использования ключей, управляемых клиентом, с концентраторами событий Azure необходимо, чтобы в хранилище ключей было настроено два обязательных свойства. Подробные сведения.  **Обратимое удаление** и **не очищается**. Эти свойства включены по умолчанию при создании нового хранилища ключей в портал Azure. Однако если необходимо включить эти свойства в существующем хранилище ключей, необходимо использовать PowerShell или Azure CLI.

## <a name="enable-customer-managed-keys"></a>Включить управляемые клиентом ключи
Чтобы включить управляемые клиентом ключи в портал Azure, выполните следующие действия.

1. Перейдите к кластеру Центры событий (цен. категория "Выделенный").
1. Выберите пространство имен, в котором необходимо включить BYOK.
1. На странице **Параметры** пространства имен концентраторов событий выберите **Шифрование (Предварительная версия)** . 
1. Выберите **управляемое клиентом шифрование ключа неактивных** , как показано на следующем рисунке. 

    ![Включить управляемый ключ клиента](./media/configure-customer-managed-key/enable-customer-managed-key.png)

## <a name="set-up-a-key-vault-with-keys"></a>Настройка хранилища ключей с ключами
После включения ключей, управляемых клиентом, необходимо связать ключ, управляемый клиентом, с пространством имен концентраторов событий Azure. Концентраторы событий поддерживают только Azure Key Vault. Если включить **Шифрование с помощью ключа, управляемого клиентом** , в предыдущем разделе, необходимо импортировать ключ в Azure Key Vault. Кроме того, ключи должны иметь **обратимое удаление** и **не следует очищать** ключ. Эти параметры можно настроить с помощью [PowerShell](../key-vault/key-vault-soft-delete-powershell.md) или [CLI](../key-vault/key-vault-soft-delete-cli.md#enabling-purge-protection).

1. Чтобы создать новое хранилище ключей, следуйте инструкциям в [кратком руководстве](../key-vault/key-vault-overview.md)по Azure Key Vault. Дополнительные сведения об импорте существующих ключей см. в разделе [о ключах, секретах и сертификатах](../key-vault/about-keys-secrets-and-certificates.md).
1. Чтобы включить защиту с обратимым удалением и очисткой при создании хранилища, используйте команду [AZ keyvault Create](/cli/azure/keyvault?view=azure-cli-latest#az-keyvault-create) .

    ```azurecli-interactive
    az keyvault create --name ContosoVault --resource-group ContosoRG --location westus --enable-soft-delete true --enable-purge-protection true
    ```    
1. Чтобы добавить защиту от очистки в существующем хранилище (для которого уже включено обратимое удаление), используйте команду [AZ keyvault Update](/cli/azure/keyvault?view=azure-cli-latest#az-keyvault-update) .

    ```azurecli-interactive
    az keyvault update --name ContosoVault --resource-group ContosoRG --enable-purge-protection true
    ```
1. Создайте ключи, выполнив следующие действия.
    1. Чтобы создать новый ключ, выберите **Создать или импортировать** из меню **Ключи** в разделе **Параметры**.
        
        ![Кнопка "создать/импортировать"](./media/configure-customer-managed-key/select-generate-import.png)
    1. Задайте **Параметры**, чтобы **Создать** и присвоить имя для ключа.

        ![Создание ключа](./media/configure-customer-managed-key/create-key.png) 
    1. Теперь можно выбрать этот ключ, чтобы связать с пространством имен концентраторов событий для шифрования из раскрывающегося списка. 

        ![Выбор ключа из хранилища ключей](./media/configure-customer-managed-key/select-key-from-key-vault.png)
    1. Введите сведения о ключе и нажмите кнопку **выбрать**. Это обеспечивает шифрование неактивных данных в пространстве имен с помощью управляемого клиентом ключа. 

        > [!NOTE]
        > В предварительной версии можно выбрать только один ключ. 

## <a name="rotate-your-encryption-keys"></a>Смена ключей шифрования
Вы можете повернуть ключ в хранилище ключей, используя механизм смены хранилища ключей Azure. Дополнительные сведения см. в разделе [Настройка смены ключей и аудита](../key-vault/key-vault-key-rotation-log-monitoring.md). Для автоматизации смены ключей можно также задать даты активации и истечения срока действия. Служба концентраторов событий обнаружит новые версии ключей и начнет использовать их автоматически.

## <a name="revoke-access-to-keys"></a>Отозвать доступ к ключам
Отмена доступа к ключам шифрования не приводит к очистке данных из концентраторов событий. Однако доступ к данным из пространства имен концентраторов событий невозможен. Вы можете отозвать ключ шифрования с помощью политики доступа или путем удаления ключа. Узнайте больше о политиках доступа и защите хранилища ключей от [безопасного доступа к хранилищу ключей](../key-vault/key-vault-secure-your-key-vault.md).

После отзыва ключа шифрования служба концентраторов событий в зашифрованном пространстве имен станет неработоспособной. Если доступ к ключу включен или восстановлен ключ удаления, служба концентраторов событий выберет ключ, чтобы получить доступ к данным из зашифрованного пространства имен концентраторов событий.

> [!NOTE]
> Если удалить существующий ключ шифрования из хранилища ключей и заменить его новым ключом в пространстве имен концентраторов событий, так как ключ удаления по-прежнему является допустимым (так как он кэшируется) в течение часа, старые данные (которые были зашифрованы с помощью старого ключа) могут по-прежнему быть доступны вместе.  с новыми данными, которые теперь доступны только с помощью нового ключа. Это поведение реализовано в предварительной версии функции. 

## <a name="set-up-diagnostic-logs"></a>Настройка журналов диагностики 
Настройка журналов диагностики для пространств имен с включенным BYOK предоставляет необходимые сведения об операциях, когда пространство имен шифруется с помощью ключей, управляемых клиентом. Эти журналы можно включить и позже передать в концентратор событий или проанализировать с помощью log Analytics или передать в хранилище для выполнения настраиваемой аналитики. Дополнительные сведения о журналах диагностики см. в статье [Обзор журналов диагностики Azure](../azure-monitor/platform/diagnostic-logs-overview.md).

## <a name="enable-user-logs"></a>Включить журналы пользователей
Выполните следующие действия, чтобы включить журналы для ключей, управляемых клиентом.

1. В портал Azure перейдите к пространству имен с включенным BYOK.
1. Выберите **параметры диагностики** в разделе **мониторинг**.

    ![Выбор параметров диагностики](./media/configure-customer-managed-key/select-diagnostic-settings.png)
1. Выберите **+ Добавить параметр диагностики**. 

    ![Выберите Добавить параметр диагностики.](./media/configure-customer-managed-key/select-add-diagnostic-setting.png)
1. Укажите **имя** и выберите, куда следует выполнять потоковую передачу журналов.
1. Выберите **кустомерманажедкэйусерлогс** и **Сохраните**. Это действие активирует журналы для BYOK в пространстве имен.

    ![Выбор параметра "пользовательские журналы управляемого ключа для клиентов"](./media/configure-customer-managed-key/select-customer-managed-key-user-logs.png)

## <a name="log-schema"></a>Схема журнала 
Все журналы хранятся в формате JSON (нотация объектов JavaScript). Каждая запись содержит строковые поля, в которых используется формат, описанный в следующей таблице. 

| Название | Описание |
| ---- | ----------- | 
| TaskName | Описание задачи, завершившейся сбоем. |
| ActivityId | Внутренний идентификатор, используемый для отслеживания. |
| category | Определяет классификацию задачи. Например, если ключ из хранилища ключей отключен, то это будет категория сведений или если ключ не может быть распакован, он может попадать в ошибку. |
| resourceId | Идентификатор ресурса Azure Resource Manager |
| keyVault | Полное имя хранилища ключей. |
| ключ | Имя ключа, используемое для шифрования пространства имен концентраторов событий. |
| version | Версия используемого ключа. |
| operation | Операция, выполняемая над ключом в хранилище ключей. Например, отключение/включение ключа, перенос или распаковка |
| code | Код, связанный с операцией. Пример: Код ошибки, 404 означает, что ключ не найден. |
| message | Любое сообщение об ошибке, связанное с операцией |

Ниже приведен пример журнала для ключа, управляемого клиентом:

```json
{
   "TaskName": "CustomerManagedKeyUserLog",
   "ActivityId": "11111111-1111-1111-1111-111111111111",
   "category": "error"
   "resourceId": "/SUBSCRIPTIONS/11111111-1111-1111-1111-11111111111/RESOURCEGROUPS/DEFAULT-EVENTHUB-CENTRALUS/PROVIDERS/MICROSOFT.EVENTHUB/NAMESPACES/FBETTATI-OPERA-EVENTHUB",
   "keyVault": "https://mykeyvault.vault-int.azure-int.net",
   "key": "mykey",
   "version": "1111111111111111111111111111111",
   "operation": "wrapKey",
   "code": "404",
   "message": "Key not found: ehbyok0/111111111111111111111111111111",
}



{
   "TaskName": "CustomerManagedKeyUserLog",
   "ActivityId": "11111111111111-1111-1111-1111111111111",
   "category": "info"
   "resourceId": "/SUBSCRIPTIONS/111111111-1111-1111-1111-11111111111/RESOURCEGROUPS/DEFAULT-EVENTHUB-CENTRALUS/PROVIDERS/MICROSOFT.EVENTHUB/NAMESPACES/FBETTATI-OPERA-EVENTHUB",
   "keyVault": "https://mykeyvault.vault-int.azure-int.net",
   "key": "mykey",
   "version": "111111111111111111111111111111",
   "operation": "disable" | "restore",
   "code": "",
   "message": "",
}
```

## <a name="troubleshoot"></a>Устранение неполадок
Рекомендуется всегда включать журналы, как показано в предыдущем разделе. Он помогает отслеживать действия при включенном шифровании BYOK. Он также помогает в области видимости проблем.

Ниже приведены распространенные коды ошибок для поиска при включенном шифровании BYOK.

| Action | Код ошибки | Итоговое состояние данных |
| ------ | ---------- | ----------------------- | 
| Удаление разрешения на перенос и распаковки из хранилища ключей | 403 |    Недоступен |
| Удаление членства в роли AAD из субъекта AAD, которому предоставлено разрешение на отправку или перенос | 403 |  Недоступен |
| Удаление ключа шифрования из хранилища ключей | 404 | Недоступен |
| Удаление хранилища ключей | 404 | Недоступно (предполагается, что обратимое удаление является обязательным параметром.) |
| Изменение срока действия ключа шифрования так, чтобы его срок действия был уже истек | 403 |   Недоступен  |
| Изменение NBF (не ранее), если ключ шифрования ключа не активен | 403 | Недоступен  |
| Выбор параметра **Разрешить службы MSFT** для брандмауэра хранилища ключей или блокировка сетевого доступа к хранилищу ключей, имеющему ключ шифрования; | 403 | Недоступен |
| Перемещение хранилища ключей в другой клиент | 404 | Недоступен |  
| Неисправность сети или сбой DNS/AAD/MSI |  | Доступ с помощью кэшированного ключа шифрования данных |

> [!IMPORTANT]
> Чтобы включить геоаварийное восстановление в пространстве имен, использующем шифрование BYOK, вторичное пространство имен для связывания должно быть в выделенном кластере и на нем должно быть включено управляемое удостоверение, назначенное системой. Дополнительные сведения см. в статье [управляемые удостоверения для ресурсов Azure](../active-directory/managed-identities-azure-resources/overview.md).

> [!NOTE]
> Если в Azure Key Vault для пространства имен концентраторов событий настроены конечные точки службы виртуальной сети, BYOK не будет поддерживаться. 


## <a name="next-steps"></a>Следующие шаги
Ознакомьтесь со следующими статьями:
- [Общие сведения о Центрах событий](event-hubs-about.md)
- [Обзор Key Vault](../key-vault/key-vault-overview.md)




