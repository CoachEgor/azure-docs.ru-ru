---
title: Использование управляемых удостоверений для ресурсов Azure с Центрами событий Azure | Документация Майкрософт
description: В этой статье рассказывается, как использовать управляемые удостоверения для ресурсов Azure с Центрами событий Azure.
services: event-hubs
documentationcenter: na
author: ShubhaVijayasarathy
manager: timlt
ms.service: event-hubs
ms.devlang: na
ms.topic: article
ms.custom: seodec18
ms.date: 12/06/2018
ms.author: shvija
ms.openlocfilehash: 784d8c9280aeff7224f90ecee0b16c9c30381aeb
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60746922"
---
# <a name="managed-identities-for-azure-resources-with-event-hubs"></a>Использование управляемых удостоверений для ресурсов Azure с Центрами событий

[Управляемые удостоверения для ресурсов Azure](../active-directory/managed-identities-azure-resources/overview.md) — это функция Azure, которая позволяет создавать удостоверения безопасности, связанные с развертыванием, в рамках которого выполняется код приложения. Затем можно связать этот идентификатор с ролями управления доступом, предоставляющими настраиваемые разрешения для доступа к определенным ресурсам Azure, необходимым приложению. 

С помощью управляемых удостоверений платформа Azure управляет этим идентификатором среды выполнения. Ключи доступа не нужно хранить и защищать в коде приложений или конфигурации ни для удостоверения, ни для ресурсов, к которым необходимо получить доступ. Клиентскому приложению Центров событий, которое выполняется в приложении Службы приложений Azure или на виртуальной машине со включенной поддержкой управляемых удостоверений для ресурсов Azure, не нужно обрабатывать правила и ключи SAS или любые другие маркеры доступа. Клиентскому приложению достаточно только адреса конечной точки пространства имен Центров событий. При подключении приложения Центры событий привязывают контекст управляемого удостоверения к клиенту в операции, показанной в примере далее в этой статье.

Как только он будет связан с управляемым удостоверением, клиент Центров событий сможет выполнять все авторизованные операции. Авторизация выполняется путем привязывания управляемого удостоверения к ролям Центров событий. 

## <a name="event-hubs-roles-and-permissions"></a>Роли и разрешения Центров событий

Управляемые удостоверения можно привязать только к ролям "Владелец" и "Участник" из пространства имен Центров событий, которые предоставляют удостоверению полный доступ ко всем сущностям в пространстве имен. Однако операции управления, изменяющие топологию пространства имен, изначально поддерживаются только через Azure Resource Manager. Они не поддерживаются через собственный интерфейс управления REST для Центров событий. Эта поддержка также означает, что нельзя использовать объект [NamespaceManager](/dotnet/api/microsoft.servicebus.namespacemanager) клиента .NET Framework в управляемом удостоверении. 
 
## <a name="use-event-hubs-with-managed-identities-for-azure-resources"></a>Использование Центров событий с управляемыми удостоверениями для ресурсов Azure

В следующих подразделах описаны такие шаги:

1. Создание и развертывание примера приложения, которое запускается с использованием управляемого удостоверения.
2. Предоставление этому удостоверению доступа к пространству имен Центров событий.
3. Способ взаимодействия приложения с Центрами событий через этот идентификатор.

В этом обзоре описано веб-приложение, размещенное в [службе приложений Azure](https://azure.microsoft.com/services/app-service/). Шаги для приложения, размещенного на виртуальной машине, аналогичны.

### <a name="create-an-app-service-web-application"></a>Создание веб-приложения службы приложений

Первым шагом является создание приложения ASP.NET службы приложения. Если вы не знаете, как это сделать в Azure, ознакомьтесь с [этим руководством](../app-service/app-service-web-get-started-dotnet-framework.md). Однако вместо того, чтобы создавать приложение MVC, как показано в этом руководстве, создайте приложение веб-форм.

### <a name="set-up-the-managed-identity"></a>Настройка управляемого удостоверения

После создания приложения перейдите к только что созданному веб-приложению на портале Azure (также отображается в практическом руководстве), а затем перейдите на страницу **Управляемое удостоверение службы** и включите возможность: 

![Страница Управляемого удостоверения службы](./media/event-hubs-managed-service-identity/msi1.png)
 
После включения возможности в Azure Active Directory будет создано удостоверение службы и настроено в узле службы приложений.

### <a name="create-a-new-event-hubs-namespace"></a>Создание пространства имен Центров событий

Теперь [создайте пространство имен Центров событий](event-hubs-create.md) в одном из регионов Azure с поддержкой предварительной версии управляемых удостоверений для ресурсов Azure: **восточная часть США**, **восточная часть США 2** или **Западная Европа**. 

Перейдите к пространству имен на странице **Управление доступом (IAM)** на портале и щелкните **Добавить назначение ролей**, чтобы добавить управляемое удостоверение к роли **Владелец**. Для этого найдите название веб-приложения на панели **Добавление разрешений** в поле **Select** (Выбор), а затем щелкните запись. Нажмите кнопку **Сохранить**. Теперь управляемое удостоверение для веб-приложения имеет доступ к пространству имен Центров событий и к ранее созданному концентратору событий. 

### <a name="run-the-app"></a>Запуск приложения

Теперь можно изменить страницу по умолчанию созданного вами приложения ASP.NET. Вы также можете использовать код веб-приложения из этого [репозитория GitHub](https://github.com/Azure/azure-event-hubs/tree/master/samples/DotNet/MSI/EventHubsMSIDemoWebApp). 

После запуска приложения перейдите в браузере к файлу EventHubsMSIDemo.aspx. Его также можно установить в качестве начальной страницы. Код можно найти в файле EventHubsMSIDemo.aspx.cs. В результате вы получите самое простое веб-приложение с несколькими полями для ввода и кнопками **отправки** и **получения**, которые позволяют отправлять события в Центры событий или получать их оттуда. 

Обратите внимание, как инициализируется объект [MessagingFactory](/dotnet/api/microsoft.servicebus.messaging.messagingfactory). Вместо того чтобы использовать поставщик общих маркеров доступа (SAS), код создает поставщик маркеров для управляемого удостоверения с помощью вызова `TokenProvider.CreateManagedServiceIdentityTokenProvider(ServiceAudience.EventHubAudience)`. Таким образом, нет никаких секретов для хранения и использования. Поток контекста управляемого удостоверения в Центры событий и подтверждение авторизации автоматически обрабатываются поставщиком маркеров, что является более простой моделью, чем использование SAS.

После внесения этих изменений опубликуйте и запустите приложение. Чтобы получить правильные данные публикации, скачайте их, а затем импортируйте профиль публикации в Visual Studio:

![Импорт профиля публикации](./media/event-hubs-managed-service-identity/msi3.png)
 
Чтобы отправлять или получать сообщения, введите имя пространства имен и имя созданной сущности, а затем нажмите кнопки **отправки** или **получения**. 
 
Управляемое удостоверение работает только в среде Azure и только в развертывании службы приложения, в котором оно было настроено. На данный момент управляемые удостоверения не работают со слотами развертывания Службы приложений.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о Центрах событий см. по следующим ссылкам:

* Начало работы с помощью [учебника по Центрам событий](event-hubs-dotnet-standard-getstarted-send.md)
* [Часто задаваемые вопросы о Центрах событий](event-hubs-faq.md)
* [Сведения о ценах на Центры событий](https://azure.microsoft.com/pricing/details/event-hubs/)
* [Примеры приложений, использующих Центры событий](https://github.com/Azure/azure-event-hubs/tree/master/samples)
