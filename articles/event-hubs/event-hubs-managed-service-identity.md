---
title: Использование управляемых удостоверений для ресурсов Azure с Центрами событий Azure | Документация Майкрософт
description: В этой статье рассказывается, как использовать управляемые удостоверения для ресурсов Azure с Центрами событий Azure.
services: event-hubs
documentationcenter: na
author: ShubhaVijayasarathy
manager: timlt
ms.service: event-hubs
ms.devlang: na
ms.topic: article
ms.custom: seodec18
ms.date: 05/20/2019
ms.author: shvija
ms.openlocfilehash: 4e6f16a15547583baab63f452504d36eb2e43b85
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "65978464"
---
# <a name="managed-identities-for-azure-resources-with-event-hubs"></a>Использование управляемых удостоверений для ресурсов Azure с Центрами событий

[Управляемые удостоверения для ресурсов Azure](../active-directory/managed-identities-azure-resources/overview.md) — это функция Azure, которая позволяет создавать удостоверения безопасности, связанные с развертыванием, в рамках которого выполняется код приложения. Затем можно связать этот идентификатор с ролями управления доступом, предоставляющими настраиваемые разрешения для доступа к определенным ресурсам Azure, необходимым приложению. 

С помощью управляемых удостоверений платформа Azure управляет этим идентификатором среды выполнения. Ключи доступа не нужно хранить и защищать в коде приложений или конфигурации ни для удостоверения, ни для ресурсов, к которым необходимо получить доступ. Клиентскому приложению Центров событий, которое выполняется в приложении Службы приложений Azure или на виртуальной машине со включенной поддержкой управляемых удостоверений для ресурсов Azure, не нужно обрабатывать правила и ключи SAS или любые другие маркеры доступа. Клиентскому приложению достаточно только адреса конечной точки пространства имен Центров событий. При подключении приложения Центры событий привязывают контекст управляемого удостоверения к клиенту в операции, показанной в примере далее в этой статье.

Как только он будет связан с управляемым удостоверением, клиент Центров событий сможет выполнять все авторизованные операции. Авторизация выполняется путем привязывания управляемого удостоверения к ролям Центров событий. 

## <a name="event-hubs-roles-and-permissions"></a>Роли и разрешения Центров событий
Можно добавить управляемое удостоверение для **владельца данных концентраторов событий** роль пространство имен концентраторов событий. Эта роль предоставляет удостоверение, полный доступ (для управления и операций с данными) по всем сущностям в пространстве имен.

>[!IMPORTANT]
> Ранее поддерживается добавление управляемое удостоверение для **владельца** или **участник** роли. Однако права для доступа к данным **владельца** и **участник** роли больше не учитываются. Если вы используете **владельца** или **участник** роль в переходе на использование **владельца данных концентраторов событий** роли.

Чтобы использовать новые встроенные роли, выполните следующие действия. 

1. Перейдите на [портал Azure](https://portal.azure.com).
2. Перейдите к пространству имен концентраторов событий.
3. На **пространство имен концентраторов событий** выберите **доступа (IAM)** в меню слева.
4. На **управление доступом (IAM)** выберите **добавить** в **добавить назначение роли** раздел. 

    ![Добавьте кнопку назначения роли](./media/event-hubs-managed-service-identity/add-role-assignment-button.png)
5. На **добавить назначение роли** выполните следующие действия: 
    1. Для **роли**выберите **владельца данных концентраторов событий Azure**. 
    2. Выберите **удостоверений** для добавления роли.
    3. Щелкните **Сохранить**. 

        ![Роль владельца данных концентраторов событий](./media/event-hubs-managed-service-identity/add-role-assignment-dialog.png)
6. Переключиться в режим **назначения ролей** странице и убедитесь, что пользователь добавлен **владельца данных концентраторов событий Azure** роли. 

    ![Убедитесь, что пользователь добавляется в роль](./media/event-hubs-managed-service-identity/role-assignments.png)
 
## <a name="use-event-hubs-with-managed-identities-for-azure-resources"></a>Использование Центров событий с управляемыми удостоверениями для ресурсов Azure

В следующих подразделах описаны такие шаги:

1. Создание и развертывание примера приложения, которое запускается с использованием управляемого удостоверения.
2. Предоставление этому удостоверению доступа к пространству имен Центров событий.
3. Способ взаимодействия приложения с Центрами событий через этот идентификатор.

В этом обзоре описано веб-приложение, размещенное в [службе приложений Azure](https://azure.microsoft.com/services/app-service/). Шаги для приложения, размещенного на виртуальной машине, аналогичны.

### <a name="create-an-app-service-web-application"></a>Создание веб-приложения службы приложений

Первым шагом является создание приложения ASP.NET службы приложения. Если вы не знаете, как это сделать в Azure, ознакомьтесь с [этим руководством](../app-service/app-service-web-get-started-dotnet-framework.md). Однако вместо того, чтобы создавать приложение MVC, как показано в этом руководстве, создайте приложение веб-форм.

### <a name="set-up-the-managed-identity"></a>Настройка управляемого удостоверения

После создания приложения перейдите к только что созданному веб-приложению на портале Azure (также отображается в практическом руководстве), а затем перейдите на страницу **Управляемое удостоверение службы** и включите возможность: 

![Страница Управляемого удостоверения службы](./media/event-hubs-managed-service-identity/msi1.png)
 
После включения возможности в Azure Active Directory будет создано удостоверение службы и настроено в узле службы приложений.

### <a name="create-a-new-event-hubs-namespace"></a>Создание пространства имен Центров событий

Далее, [создать пространство имен концентраторов событий](event-hubs-create.md). 

Перейдите к пространству имен на странице **Управление доступом (IAM)** на портале и щелкните **Добавить назначение ролей**, чтобы добавить управляемое удостоверение к роли **Владелец**. Для этого найдите название веб-приложения на панели **Добавление разрешений** в поле **Select** (Выбор), а затем щелкните запись. Нажмите кнопку **Сохранить**. Теперь управляемое удостоверение для веб-приложения имеет доступ к пространству имен Центров событий и к ранее созданному концентратору событий. 

### <a name="run-the-app"></a>Запуск приложения

Теперь можно изменить страницу по умолчанию созданного вами приложения ASP.NET. Вы также можете использовать код веб-приложения из этого [репозитория GitHub](https://github.com/Azure/azure-event-hubs/tree/master/samples/DotNet/MSI/EventHubsMSIDemoWebApp). 

После запуска приложения перейдите в браузере к файлу EventHubsMSIDemo.aspx. Его также можно установить в качестве начальной страницы. Код можно найти в файле EventHubsMSIDemo.aspx.cs. В результате вы получите самое простое веб-приложение с несколькими полями для ввода и кнопками **отправки** и **получения**, которые позволяют отправлять события в Центры событий или получать их оттуда. 

Обратите внимание, как инициализируется объект [MessagingFactory](/dotnet/api/microsoft.servicebus.messaging.messagingfactory). Вместо того чтобы использовать поставщик общих маркеров доступа (SAS), код создает поставщик маркеров для управляемого удостоверения с помощью вызова `TokenProvider.CreateManagedServiceIdentityTokenProvider(ServiceAudience.EventHubAudience)`. Таким образом, нет никаких секретов для хранения и использования. Поток контекста управляемого удостоверения в Центры событий и подтверждение авторизации автоматически обрабатываются поставщиком маркеров, что является более простой моделью, чем использование SAS.

После внесения этих изменений опубликуйте и запустите приложение. Чтобы получить правильные данные публикации, скачайте их, а затем импортируйте профиль публикации в Visual Studio:

![Импорт профиля публикации](./media/event-hubs-managed-service-identity/msi3.png)
 
Чтобы отправлять или получать сообщения, введите имя пространства имен и имя созданной сущности, а затем нажмите кнопки **отправки** или **получения**. 
 
Управляемое удостоверение работает только в среде Azure и только в развертывании службы приложения, в котором оно было настроено. На данный момент управляемые удостоверения не работают со слотами развертывания Службы приложений.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о Центрах событий см. по следующим ссылкам:

* Начало работы с помощью [учебника по Центрам событий](event-hubs-dotnet-standard-getstarted-send.md)
* [Часто задаваемые вопросы о Центрах событий](event-hubs-faq.md)
* [Сведения о ценах на Центры событий](https://azure.microsoft.com/pricing/details/event-hubs/)
* [Примеры приложений, использующих Центры событий](https://github.com/Azure/azure-event-hubs/tree/master/samples)
