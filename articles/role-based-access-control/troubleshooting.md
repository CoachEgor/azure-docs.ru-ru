---
title: Устранение неполадок Azure RBAC
description: Проблемы устранения проблем с управлением доступом на основе ролей Azure (Azure RBAC).
services: azure-portal
documentationcenter: na
author: rolyon
manager: mtillman
ms.assetid: df42cca2-02d6-4f3c-9d56-260e1eb7dc44
ms.service: role-based-access-control
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 03/18/2020
ms.author: rolyon
ms.reviewer: bagovind
ms.custom: seohack1
ms.openlocfilehash: 09d5b7a126a1b8832bfe40e2e25dd4000d5d9155
ms.sourcegitcommit: 980c3d827cc0f25b94b1eb93fd3d9041f3593036
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2020
ms.locfileid: "80548289"
---
# <a name="troubleshoot-azure-rbac"></a>Устранение неполадок Azure RBAC

В этой статье ответы на некоторые распространенные вопросы о элементе управления доступом на основе ролей Azure (Azure RBAC), чтобы вы знали, чего ожидать при использовании ролей и могли устранить проблемы доступа.

## <a name="azure-role-assignments-limit"></a>Ограничение назначений ролей Azure

Azure поддерживает до **2000** назначений ролей на подписку. Если вы получаете сообщение об ошибке "Больше не может быть создано назначение ролей (код: RoleAssignmentLimitexceeded)" при попытке назначить роль, постарайтесь уменьшить количество назначений ролей в подписке.

> [!NOTE]
> Ограничение ролевых **заданий 2000** года на подписку фиксируется и не может быть увеличено.

Если вы приближаетесь к этому пределу, вот несколько способов, которые можно уменьшить количество назначений ролей:

- Добавляйте пользователей в группы и вместо этого назначайте роли группам. 
- Объедините несколько встроенных ролей с пользовательской ролью. 
- Делайте общие назначения ролей в более высокой области, например, в группе подписки или управления.
- Если у вас есть Azure AD Premium P2, сделайте ролевые назначения подходящими в [Azure AD Privileged Identity Management](../active-directory/privileged-identity-management/pim-configure.md) вместо постоянного назначения. 
- Добавьте дополнительную подписку. 

Чтобы получить количество назначений ролей, можно просмотреть [диаграмму на странице управления доступом (IAM)](role-assignments-list-portal.md#list-number-of-role-assignments) на портале Azure. Вы также можете использовать следующие команды Azure PowerShell:

```azurepowershell
$scope = "/subscriptions/<subscriptionId>"
$ras = Get-AzRoleAssignment -Scope $scope | Where-Object {$_.scope.StartsWith($scope)}
$ras.Count
```

## <a name="problems-with-azure-role-assignments"></a>Проблемы с назначениями ролей Azure

- Если вы не можете добавить назначение ролей в azure portal на **портале управления доступом (IAM),** потому что**параметр назначения роли** **Add** > Add является отключенным или потому что вы получаете ошибку `Microsoft.Authorization/roleAssignments/write` разрешений "Клиент с идентификатором объекта не имеет разрешения для выполнения действий", проверьте, что вы в настоящее время подписаны с пользователем, который назначен роль, которая имеет разрешение, такие как [владелец](built-in-roles.md#owner) или [администратор пользовательского доступа](built-in-roles.md#user-access-administrator) в области, которую вы пытаетесь назначить.

## <a name="problems-with-custom-roles"></a>Проблемы с пользовательскими ролями

- Если вам нужны шаги для создания пользовательской роли, смотрите пользовательские руководства по роли с помощью [портала Azure](custom-roles-portal.md) (в настоящее время в предварительном просмотре), [Azure PowerShell](tutorial-custom-role-powershell.md)или [Azure CLI.](tutorial-custom-role-cli.md)
- Если вы не можете обновить существующую пользовательскую роль, проверьте, что вы в настоящее время подписаны с пользователем, который назначен роль, которая имеет `Microsoft.Authorization/roleDefinition/write` разрешение, такие как [владелец](built-in-roles.md#owner) или администратор [пользовательского доступа.](built-in-roles.md#user-access-administrator)
- Если вы не можете удалить пользовательскую роль и получить сообщение об ошибке "Есть существующие назначения ролей, ссылающиеся на роль (код: RoleDefinitionHasAssignments)", то есть назначения ролей, все еще использующие пользовательскую роль. Удалите эти назначения и снова попытайтесь удалить пользовательскую роль.
- Если при попытке создать пользовательскую роль отображается сообщение об ошибке "Превышено ограничение на определение ролей. Больше не может быть создано определение ролей (код: RoleDefinitionLimitExceeded)" при попытке создать новую пользовательскую роль, удалите любые пользовательские роли, которые не используются. Azure поддерживает до **5000** пользовательских ролей в каталоге. (Для Azure Германии и Azure China 21Vianet лимит составляет 2000 пользовательских ролей.)
- Если вы получаете ошибку, похожую на "Клиент имеет разрешение на выполнение действия ' Microsoft.Authorization/roleDefinitions/write' на область '/подписка /'подписка', однако связанная подписка не была найдена" при попытке обновить пользовательскую роль, проверьте, были ли удалены один или несколько [присвоенных областей](role-definitions.md#assignablescopes) в каталоге. Если область удалена, создайте запрос в службу поддержки, так как способа самостоятельного решения этой проблемы пока не существует.

## <a name="custom-roles-and-management-groups"></a>Пользовательские роли и группы управления

- Можно определить только одну `AssignableScopes` группу управления в пользовательской роли. Добавление группы `AssignableScopes` управления в настоящее время находится в предварительном просмотре.
- Пользовательские `DataActions` роли с не могут быть назначены в области группы управления.
- Менеджер ресурсов Azure не проверяет существование группы управления в области определения роли.
- Для получения дополнительной информации о пользовательских ролей и групп управления, [перечниОрганизуйте свои ресурсы с группами управления Azure.](../governance/management-groups/overview.md#custom-rbac-role-definition-and-assignment)

## <a name="transferring-a-subscription-to-a-different-directory"></a>Перенос подписки в другой каталог

- Если вам нужны шаги для переноса подписки в другой каталог Azure AD, [см.](../cost-management-billing/manage/billing-subscription-transfer.md)
- При переводе подписки в другой каталог Azure AD все назначения ролей **навсегда** удаляются из исходного каталога Azure AD и не переносятся в целевой каталог Azure AD. Необходимо воссоздать ролевые назначения в целевом каталоге. Также необходимо вручную воссоздать управляемые идентификаторы для ресурсов Azure. Для получения дополнительной [FAQs and known issues with managed identities](../active-directory/managed-identities-azure-resources/known-issues.md)информации см.
- Если вы являетесь глобальным администратором Azure AD и у вас нет доступа к подписке после того, как она была переведена между каталогами, используйте **управление доступом для ресурсов Azure,** чтобы временно [повысить доступ](elevate-access-global-admin.md) к подписке.

## <a name="issues-with-service-admins-or-co-admins"></a>Проблемы с администраторами или соадминистраторами служб

- Если у вас возникли проблемы с администратором службы или соадминистраторами, [Classic subscription administrator roles, Azure roles, and Azure AD administrator roles](rbac-and-directory-admin-roles.md)см. [Add or change Azure subscription administrators](../cost-management-billing/manage/add-change-subscription-administrator.md)

## <a name="access-denied-or-permission-errors"></a>Ошибки доступа или разрешения

- Если вы получаете ошибку разрешений "Клиент с идентификатором объекта не имеет разрешения на выполнение действий над областью (код: AuthorizationFailed)" при попытке создания ресурса, проверьте, что вы в настоящее время подписаны с пользователем, который назначен роль, которая написала разрешение на ресурс в выбранной области. Например, для управления виртуальными машинами в группе ресурсов вам должна быть назначена роль [Участник виртуальных машин](built-in-roles.md#virtual-machine-contributor) для этой группы ресурсов (или вышестоящего уровня). Список разрешений для каждой встроенной роли см. в статье [Built-in roles for Azure resources](built-in-roles.md) (Встроенные роли для ресурсов Azure).
- Если вы получили ошибку разрешений "У вас нет разрешения на создание запроса на поддержку" при попытке создать или обновить билет поддержки, `Microsoft.Support/supportTickets/write` проверьте, что вы в настоящее время подписаны с пользователем, который назначен роль, которая имеет разрешение, например, [Запрос на поддержку](built-in-roles.md#support-request-contributor).

## <a name="role-assignments-with-unknown-security-principal"></a>Назначения ролей с неизвестным директором безопасности

Если вы назначаете роль директору безопасности (пользователь, группа, директор службы или управляемая личность), а затем удаляете этот принцип безопасности без удаления назначения роли, основной тип безопасности для назначения роли будет указан как **Неизвестный**. На следующем снимке экрана приведен пример на портале Azure. Основное имя безопасности указано как **Identity deleted** и **Identity больше не существует.** 

![Группа ресурсов веб-приложений](./media/troubleshooting/unknown-security-principal.png)

Если вы перечислите это назначение ролей с помощью `DisplayName` Azure PowerShell, вы увидите пустой и `ObjectType` набор неизвестных. Например, [Get-AzRoleAssignment](/powershell/module/az.resources/get-azroleassignment) возвращает ролевую уступку, аналогичную следующему:

```
RoleAssignmentId   : /subscriptions/11111111-1111-1111-1111-111111111111/providers/Microsoft.Authorization/roleAssignments/22222222-2222-2222-2222-222222222222
Scope              : /subscriptions/11111111-1111-1111-1111-111111111111
DisplayName        :
SignInName         :
RoleDefinitionName : Storage Blob Data Contributor
RoleDefinitionId   : ba92f5b4-2d11-453d-a403-e96b0029c9fe
ObjectId           : 33333333-3333-3333-3333-333333333333
ObjectType         : Unknown
CanDelegate        : False
```

Аналогичным образом, если вы перечислите это назначение ролей с `principalName`помощью Azure CLI, вы увидите пустое . Например, [список назначений ролей az](/cli/azure/role/assignment#az-role-assignment-list) возвращает назначение ролей, аналогичное следующему:

```
{
    "canDelegate": null,
    "id": "/subscriptions/11111111-1111-1111-1111-111111111111/providers/Microsoft.Authorization/roleAssignments/22222222-2222-2222-2222-222222222222",
    "name": "22222222-2222-2222-2222-222222222222",
    "principalId": "33333333-3333-3333-3333-333333333333",
    "principalName": "",
    "roleDefinitionId": "/subscriptions/11111111-1111-1111-1111-111111111111/providers/Microsoft.Authorization/roleDefinitions/ba92f5b4-2d11-453d-a403-e96b0029c9fe",
    "roleDefinitionName": "Storage Blob Data Contributor",
    "scope": "/subscriptions/11111111-1111-1111-1111-111111111111",
    "type": "Microsoft.Authorization/roleAssignments"
}
```

Оставить эти назначения не проблема, но можно удалить их с помощью шагов, похожих на другие назначения ролей. Для получения информации об удалении назначений ролей можно на [портале Azure,](role-assignments-portal.md#remove-a-role-assignment) [Azure PowerShell](role-assignments-powershell.md#remove-a-role-assignment)или [Azure CLI](role-assignments-cli.md#remove-a-role-assignment)

В PowerShell, если вы попытаетесь удалить назначения ролей с помощью идентификатора объекта и имени определения роли, и более чем одно назначение роли соответствует вашим параметрам, вы получите сообщение об ошибке: "Предоставленная информация не отображается на назначение ролей". Ниже приводится пример сообщения об ошибке:

```
PS C:\> Remove-AzRoleAssignment -ObjectId 33333333-3333-3333-3333-333333333333 -RoleDefinitionName "Storage Blob Data Contributor"

Remove-AzRoleAssignment : The provided information does not map to a role assignment.
At line:1 char:1
+ Remove-AzRoleAssignment -ObjectId 33333333-3333-3333-3333-333333333333 ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ CategoryInfo          : CloseError: (:) [Remove-AzRoleAssignment], KeyNotFoundException
+ FullyQualifiedErrorId : Microsoft.Azure.Commands.Resources.RemoveAzureRoleAssignmentCommand
```

Если вы получили это сообщение об ошибке, убедитесь, что вы также указать `-Scope` или `-ResourceGroupName` параметры.

```
PS C:\> Remove-AzRoleAssignment -ObjectId 33333333-3333-3333-3333-333333333333 -RoleDefinitionName "Storage Blob Data Contributor" - Scope /subscriptions/11111111-1111-1111-1111-111111111111
```

## <a name="role-assignment-changes-are-not-being-detected"></a>Изменения назначения ролей не обнаруживаются

Azure Resource Manager иногда кэширует конфигурации и данные для повышения производительности. При добавлении или удалении назначений ролей может пройти до 30 минут, чтобы изменения вступили в силу. Если вы используете портал Azure, Azure PowerShell или Azure CLI, можно принудительно обновить изменения назначения ролей, выйдя из учетной записи и повторно войдя в нее. Если вы вносите изменения в назначения ролей с помощью вызовов REST API, можно принудительно обновить изменения, обновив маркер доступа.

Если вы добавляете или удаляете назначение ролей в `DataActions`области управления группой и роль, доступ на плоскости данных может не обновляться в течение нескольких часов. Это относится только к области группы управления и плоскости данных.

## <a name="web-app-features-that-require-write-access"></a>Компоненты веб-приложений, требующие доступа для записи

Если предоставить пользователю доступ только для чтения к одному веб-приложению, некоторые компоненты могут неожиданно отключиться. Перечисленные ниже возможности управления требуют доступа к веб-приложению с правом **записи** (роль участника или владельца), поэтому они недоступны при наличии прав только на чтение.

* Команды (такие как запуск, остановка и т. д.).
* Изменение параметров, таких как общие параметры конфигурации, параметры масштабирования, резервного копирования и мониторинга.
* Доступ к учетным данным для публикации и другим секретным сведениям, например к параметрам приложений и строкам подключения.
* Журналы потоковой передачи.
* Конфигурация журналов диагностики.
* Консоль (командная строка).
* Активные и недавние развертывания (для локального непрерывного развертывания Git).
* Приблизительные затраты.
* Веб-тесты
* Виртуальная сеть (видна читателю только в том случае, если ранее была настроена пользователем с доступом на запись).

Если у вас нет доступа ни к одной из этих плиток, попросите администратора предоставить вам доступ к веб-приложению с правами участника.

## <a name="web-app-resources-that-require-write-access"></a>Ресурсы веб-приложений, требующие доступа для записи

Работа с веб-приложениями осложняется наличием нескольких взаимосвязанных ресурсов. Вот типичная группа ресурсов, связанная с несколькими веб-сайтами:

![Группа ресурсов веб-приложений](./media/troubleshooting/website-resource-model.png)

В результате, если вы предоставите кому-либо доступ только к веб-приложению, многие функции в колонке веб-сайта на портале Azure будут отключены.

Для этих элементов требуется доступ на **запись** к **плану службы приложений**, который соответствует вашему веб-сайту:  

* просмотр ценовой категории веб-приложения (например, "Бесплатный" или "Стандартный");  
* параметры масштабирования (число экземпляров, размер виртуальной машины, настройки автоматического масштабирования);  
* квоты (квоты хранилища, пропускной способности, ресурсов ЦП).  

Элементы, требующие доступа на **запись** ко всей **группе ресурсов**, которая содержит веб-сайт:  

* Сертификаты и привязки TLS/SSL (сертификаты TLS/SSL могут быть совместно распределены между сайтами в одной и той же группе ресурсов и в геолокации)  
* Правила оповещения  
* параметры автоматического масштабирования;  
* компоненты Application Insights;  
* Веб-тесты  

## <a name="virtual-machine-features-that-require-write-access"></a>Компоненты виртуальных машин, требующие доступа для записи

Как и в случае с веб-приложениями, для некоторых функций в колонке виртуальной машины нужен доступ к виртуальной машине или другим ресурсам в группе ресурсов с правами на запись.

Виртуальные машины связаны с доменными именами, виртуальными сетями, учетными записями хранения и правилами оповещений.

Элементы, требующие доступа к **виртуальной** машине с правом **записи**:

* Конечные точки  
* IP-адреса  
* Диски  
* Расширения  

Элементы, требующие доступа на **запись** как к **виртуальной машине**, так и к **группе ресурсов**, в которой она находится (а также к доменному имени):  

* Группа доступности  
* набор балансировки нагрузки;  
* Правила оповещения  

Если у вас нет доступа ни к одному из этих элементов, попросите администратора предоставить вам права участника для группы ресурсов.

## <a name="azure-functions-and-write-access"></a>Функции Azure и доступ для записи

Для некоторых компонентов решения [Функции Azure](../azure-functions/functions-overview.md) требуется доступ на запись. Например, если пользователю назначена роль [Читателя,](built-in-roles.md#reader) он не сможет просматривать функции в приложении функции. На портале отобразится текст **(Нет доступа)**.

![Сообщение об отсутствии доступа в приложении-функции](./media/troubleshooting/functionapps-noaccess.png)

Пользователь с ролью читателя может щелкнуть вкладку **Функции платформы** и выбрать **Все параметры**, чтобы просмотреть некоторые параметры, связанные с приложением-функцией (так же, как для веб-приложения), но не может изменить эти параметры. Чтобы получить доступ к этим функциям, вам понадобится роль [вкладчика.](built-in-roles.md#contributor)

## <a name="next-steps"></a>Дальнейшие действия

- [Устранение неполадок для гостевых пользователей](role-assignments-external-users.md#troubleshoot)
- [Управление доступом с помощью RBAC и портала Azure](role-assignments-portal.md)
- [Просмотр журналов действий для изменений RBAC в ресурсах Azure](change-history-report.md)
