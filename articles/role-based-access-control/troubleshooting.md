---
title: Устранение неполадок RBAC для ресурсов Azure | Документация Майкрософт
description: Устранение неполадок с управлением доступом на основе ролей (RBAC) для ресурсов Azure.
services: azure-portal
documentationcenter: na
author: rolyon
manager: mtillman
ms.assetid: df42cca2-02d6-4f3c-9d56-260e1eb7dc44
ms.service: role-based-access-control
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 08/22/2019
ms.author: rolyon
ms.reviewer: bagovind
ms.custom: seohack1
ms.openlocfilehash: 158222c256e3efc7ca87d7a3781ca68e1c4307b1
ms.sourcegitcommit: 8074f482fcd1f61442b3b8101f153adb52cf35c9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/22/2019
ms.locfileid: "72750186"
---
# <a name="troubleshoot-rbac-for-azure-resources"></a>Устранение неполадок RBAC в Azure

В этой статье содержатся ответы на часто задаваемые вопросы об управлении доступом на основе ролей (RBAC) для ресурсов Azure. Вы узнаете, какие ситуации возможны при использовании ролей на портале Azure, а также сможете устранить неполадки, связанные с доступом.

## <a name="problems-with-rbac-role-assignments"></a>Проблемы с назначениями ролей в RBAC

- Если не удается добавить назначение роли в портал Azure **управления доступом (IAM)** , так как параметр **Добавить**  > **добавить назначение ролей** отключен или получено сообщение об ошибке "у клиента с идентификатором объекта нет Авторизация для выполнения действия. Убедитесь, что вы вошли в систему с помощью пользователя, которому назначена роль с разрешениями `Microsoft.Authorization/roleAssignments/write`, такими как [владелец](built-in-roles.md#owner) или [администратор доступа пользователей](built-in-roles.md#user-access-administrator) в области, в которой вы пытаетесь назначить роль.
- Если вы получаете сообщение об ошибке "больше не удается создать назначения ролей (код: Ролеассигнментлимитексцеедед)" при попытке назначить роль, попробуйте уменьшить число назначений ролей, назначив вместо них роли группам. Azure поддерживает до **2000** назначений ролей на подписку.

## <a name="problems-with-custom-roles"></a>Проблемы с пользовательскими ролями

- Инструкции по созданию настраиваемой роли см. в руководствах по настраиваемым ролям с помощью [Azure PowerShell](tutorial-custom-role-powershell.md) или [Azure CLI](tutorial-custom-role-cli.md).
- Если не удается обновить существующую пользовательскую роль, убедитесь, что вы вошли в систему с помощью пользователя, которому назначена роль с `Microsoft.Authorization/roleDefinition/write` разрешением, например [владелец](built-in-roles.md#owner) или [администратор доступа пользователей](built-in-roles.md#user-access-administrator).
- Если вы не можете удалить пользовательскую роль и получить сообщение об ошибке "имеются существующие назначения ролей, ссылающиеся на Role (код: Роледефинитионхасассигнментс)", то существуют назначения ролей, по-прежнему использующие настраиваемую роль. Удалите эти назначения и снова попытайтесь удалить пользовательскую роль.
- Если при попытке создать пользовательскую роль отображается сообщение об ошибке "Превышено ограничение на определение ролей. Невозможно создать дополнительные определения ролей (код: Роледефинитионлимитексцеедед). при попытке создать новую пользовательскую роль удалите все пользовательские роли, которые не используются. Azure поддерживает до **5000** пользовательских ролей в клиенте. (Специализированные облачные службы, такие как Azure для государственных организаций, Azure для Германии и Azure для Китая от 21Vianet поддерживают до 2000 пользовательских ролей.)
- Если появляется сообщение об ошибке "клиент имеет разрешение на выполнение действия" Microsoft. Authorization/roleDefinitions/Write "в области"/субскриптионс/{субскриптионид} ", но связанная подписка не найдена при попытке обновить пользовательскую роль, проверьте Указывает, были ли удалены в клиенте одна или несколько [назначаемых областей](role-definitions.md#assignablescopes) . Если область удалена, создайте запрос в службу поддержки, так как способа самостоятельного решения этой проблемы пока не существует.

## <a name="recover-rbac-when-subscriptions-are-moved-across-tenants"></a>Восстановление RBAC при перемещении подписок между клиентами

- Инструкции по переносу подписки на другой клиент Azure AD см. [в статье перемещение прав владения подпиской Azure в другую учетную запись](../billing/billing-subscription-transfer.md).
- Когда вы переносите подписку в другой клиент Azure AD, все назначения ролей удаляются из исходного клиента Azure AD без возможности восстановления и не переносятся в целевой клиент Azure AD. Необходимо повторно создать назначения ролей в целевом клиенте. Также необходимо вручную создать управляемые удостоверения для ресурсов Azure. Дополнительные сведения см. в разделе [часто задаваемые вопросы и известные проблемы с управляемыми удостоверениями](../active-directory/managed-identities-azure-resources/known-issues.md).
- Если вы являетесь глобальным администратором Azure AD и у вас нет доступа к подписке после перемещения между клиентами, используйте переключатель **Управление доступом для ресурсов Azure** , чтобы временно [повысить уровень доступа](elevate-access-global-admin.md) , чтобы получить доступ к подписке.

## <a name="issues-with-service-admins-or-co-admins"></a>Проблемы с администраторами или соадминистраторами служб

- Если у вас возникли проблемы с администратором служб или соадминистратором, см. статью [Добавление или изменение администраторов Подписки Azure](../billing/billing-add-change-azure-subscription-administrator.md) и [ролей администратора классической подписки, ролей RBAC Azure и РОЛЕЙ администратора Azure AD](rbac-and-directory-admin-roles.md).

## <a name="access-denied-or-permission-errors"></a>Отказ в доступе или ошибках разрешений

- Если возникла ошибка разрешений "клиент с идентификатором объекта не имеет авторизации для выполнения действий с областью действия (Code: AuthorizationFailed)" при попытке создать ресурс, убедитесь, что вы вошли с пользователем, которому назначена роль с записью разрешение на доступ к ресурсу в выбранной области. Например, для управления виртуальными машинами в группе ресурсов вам должна быть назначена роль [Участник виртуальных машин](built-in-roles.md#virtual-machine-contributor) для этой группы ресурсов (или вышестоящего уровня). Список разрешений для каждой встроенной роли см. в статье [Built-in roles for Azure resources](built-in-roles.md) (Встроенные роли для ресурсов Azure).
- Если при попытке создать или обновить запрос в службу поддержки появится сообщение об ошибке "у вас нет разрешения на создание запроса на поддержку", убедитесь, что вы вошли с пользователем, которому назначена роль с разрешением `Microsoft.Support/supportTickets/write` , например [участник запроса на поддержку](built-in-roles.md#support-request-contributor).

## <a name="role-assignments-with-unknown-security-principal"></a>Назначения ролей с неизвестным субъектом безопасности

При перечислении назначений ролей с помощью Azure PowerShell можно увидеть назначения с пустым `DisplayName`, а `ObjectType` установить в значение Unknown (неизвестный). Например, командлет [Get-азролеассигнмент](/powershell/module/az.resources/get-azroleassignment) Возвращает назначение роли, похожее на следующее:

```azurepowershell
RoleAssignmentId   : /subscriptions/11111111-1111-1111-1111-111111111111/providers/Microsoft.Authorization/roleAssignments/22222222-2222-2222-2222-222222222222
Scope              : /subscriptions/11111111-1111-1111-1111-111111111111
DisplayName        :
SignInName         :
RoleDefinitionName : Storage Blob Data Contributor
RoleDefinitionId   : ba92f5b4-2d11-453d-a403-e96b0029c9fe
ObjectId           : 33333333-3333-3333-3333-333333333333
ObjectType         : Unknown
CanDelegate        : False
```

Аналогично, когда вы перечислите назначения ролей с помощью Azure CLI, вы можете увидеть назначения с пустым `principalName`. Например, [AZ Role назначений List](/cli/azure/role/assignment#az-role-assignment-list) Возвращает назначение роли, похожее на следующее:

```azurecli
{
    "canDelegate": null,
    "id": "/subscriptions/11111111-1111-1111-1111-111111111111/providers/Microsoft.Authorization/roleAssignments/22222222-2222-2222-2222-222222222222",
    "name": "22222222-2222-2222-2222-222222222222",
    "principalId": "33333333-3333-3333-3333-333333333333",
    "principalName": "",
    "roleDefinitionId": "/subscriptions/11111111-1111-1111-1111-111111111111/providers/Microsoft.Authorization/roleDefinitions/ba92f5b4-2d11-453d-a403-e96b0029c9fe",
    "roleDefinitionName": "Storage Blob Data Contributor",
    "scope": "/subscriptions/11111111-1111-1111-1111-111111111111",
    "type": "Microsoft.Authorization/roleAssignments"
}
```

Эти назначения ролей происходят при назначении роли участнику безопасности (пользователю, группе, субъекту-службе или управляемому удостоверению), а впоследствии удаляется этот субъект безопасности. Эти назначения ролей не отображаются в портал Azure и их не следует оставлять. Однако при желании можно удалить эти назначения ролей.

Чтобы удалить эти назначения ролей, используйте команды [Remove-азролеассигнмент](/powershell/module/az.resources/remove-azroleassignment) или [AZ Role назначения Delete](/cli/azure/role/assignment#az-role-assignment-delete) .

В PowerShell при попытке удаления назначений ролей с помощью идентификатора объекта и имени определения роли, а также нескольких назначений ролей, соответствующих Вашим параметрам, вы получите сообщение об ошибке: "указанные сведения не соответствуют назначению роли". Ниже приведен пример сообщения об ошибке.

```Example
PS C:\> Remove-AzRoleAssignment -ObjectId 33333333-3333-3333-3333-333333333333 -RoleDefinitionName "Storage Blob Data Contributor"

Remove-AzRoleAssignment : The provided information does not map to a role assignment.
At line:1 char:1
+ Remove-AzRoleAssignment -ObjectId 33333333-3333-3333-3333-333333333333 ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ CategoryInfo          : CloseError: (:) [Remove-AzRoleAssignment], KeyNotFoundException
+ FullyQualifiedErrorId : Microsoft.Azure.Commands.Resources.RemoveAzureRoleAssignmentCommand
```

Если вы получаете это сообщение об ошибке, убедитесь, что вы также указали параметры `-Scope` или `-ResourceGroupName`.

```Example
PS C:\> Remove-AzRoleAssignment -ObjectId 33333333-3333-3333-3333-333333333333 -RoleDefinitionName "Storage Blob Data Contributor" - Scope /subscriptions/11111111-1111-1111-1111-111111111111
```

## <a name="rbac-changes-are-not-being-detected"></a>Не удается обнаружить изменения RBAC

Azure Resource Manager иногда кэширует конфигурации и данные для повышения производительности. При создании или удалении назначения ролей вступление изменений в силу может занять до 30 минут. Если вы используете портал Azure, Azure PowerShell или Azure CLI, можно принудительно обновить изменения назначения ролей, выйдя из учетной записи и повторно войдя в нее. Если вы вносите изменения в назначения ролей с помощью вызовов REST API, можно принудительно обновить изменения, обновив маркер доступа.

## <a name="web-app-features-that-require-write-access"></a>Компоненты веб-приложений, требующие доступа для записи

Если предоставить пользователю доступ только для чтения к одному веб-приложению, некоторые компоненты могут неожиданно отключиться. Перечисленные ниже возможности управления требуют доступа к веб-приложению с правом **записи** (роль участника или владельца), поэтому они недоступны при наличии прав только на чтение.

* Команды (такие как запуск, остановка и т. д.).
* Изменение параметров, таких как общие параметры конфигурации, параметры масштабирования, резервного копирования и мониторинга.
* Доступ к учетным данным для публикации и другим секретным сведениям, например к параметрам приложений и строкам подключения.
* Журналы потоковой передачи.
* Конфигурация журналов диагностики.
* Консоль (командная строка).
* Активные и недавние развертывания (для локального непрерывного развертывания Git).
* Приблизительные затраты.
* Веб-тесты
* Виртуальная сеть (видна читателю только в том случае, если ранее была настроена пользователем с доступом на запись).

Если у вас нет доступа ни к одной из этих плиток, попросите администратора предоставить вам доступ к веб-приложению с правами участника.

## <a name="web-app-resources-that-require-write-access"></a>Ресурсы веб-приложений, требующие доступа для записи

Работа с веб-приложениями осложняется наличием нескольких взаимосвязанных ресурсов. Вот типичная группа ресурсов, связанная с несколькими веб-сайтами:

![Группа ресурсов веб-приложений](./media/troubleshooting/website-resource-model.png)

В результате, если вы предоставите кому-либо доступ только к веб-приложению, многие функции в колонке веб-сайта на портале Azure будут отключены.

Для этих элементов требуется доступ на **запись** к **плану службы приложений**, который соответствует вашему веб-сайту:  

* просмотр ценовой категории веб-приложения (например, "Бесплатный" или "Стандартный");  
* параметры масштабирования (число экземпляров, размер виртуальной машины, настройки автоматического масштабирования);  
* квоты (квоты хранилища, пропускной способности, ресурсов ЦП).  

Элементы, требующие доступа на **запись** ко всей **группе ресурсов**, которая содержит веб-сайт:  

* SSL-сертификаты и привязки (SSL-сертификаты могут совместно использоваться сайтами, относящимися к одной группе ресурсов и находящимися в одном географическом расположении);  
* Правила генерации оповещений  
* параметры автоматического масштабирования;  
* компоненты Application Insights;  
* Веб-тесты  

## <a name="virtual-machine-features-that-require-write-access"></a>Компоненты виртуальных машин, требующие доступа для записи

Как и в случае с веб-приложениями, для некоторых функций в колонке виртуальной машины нужен доступ к виртуальной машине или другим ресурсам в группе ресурсов с правами на запись.

Виртуальные машины связаны с доменными именами, виртуальными сетями, учетными записями хранения и правилами оповещений.

Элементы, требующие доступа к **виртуальной** машине с правом **записи**:

* Конечные точки  
* IP-адреса  
* Диски  
* расширения.  

Элементы, требующие доступа на **запись** как к **виртуальной машине**, так и к **группе ресурсов**, в которой она находится (а также к доменному имени):  

* Группа доступности  
* набор балансировки нагрузки;  
* Правила генерации оповещений  

Если у вас нет доступа ни к одному из этих элементов, попросите администратора предоставить вам права участника для группы ресурсов.

## <a name="azure-functions-and-write-access"></a>Функции Azure и доступ для записи

Для некоторых компонентов решения [Функции Azure](../azure-functions/functions-overview.md) требуется доступ на запись. Например, если пользователю назначена роль [читателя](built-in-roles.md#reader) , он не сможет просматривать функции в приложении-функции. На портале отобразится текст **(Нет доступа)** .

![Сообщение об отсутствии доступа в приложении-функции](./media/troubleshooting/functionapps-noaccess.png)

Пользователь с ролью читателя может щелкнуть вкладку **Функции платформы** и выбрать **Все параметры**, чтобы просмотреть некоторые параметры, связанные с приложением-функцией (так же, как для веб-приложения), но не может изменить эти параметры. Для доступа к этим возможностям потребуется роль [участника](built-in-roles.md#contributor) .

## <a name="next-steps"></a>Дальнейшие действия

- [Устранение неполадок для гостевых пользователей](role-assignments-external-users.md#troubleshoot)
- [Управление доступом к ресурсам Azure с помощью RBAC и портала Azure](role-assignments-portal.md)
- [Просмотр журналов действий для изменений RBAC в ресурсах Azure](change-history-report.md)

