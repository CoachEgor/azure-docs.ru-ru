---
title: Службы мультимедиа Azure. Сигнализация метаданных времени в потоковой трансляции | Документация Майкрософт
description: В этой спецификации описываются два режима, поддерживаемые службами мультимедиа для сигнализации метаданных времени в потоковой трансляции. К ним относится поддержка универсальных сигналов метаданных времени, а также сигнализация SCTE-35 для вставки рекламы.
services: media-services
documentationcenter: ''
author: johndeu
manager: femila
editor: johndeu
ms.assetid: 265b94b1-0fb8-493a-90ec-a4244f51ce85
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/20/2019
ms.author: johndeu;
ms.openlocfilehash: 10dbf7e8cf67ab721cf525d4a1e7594473592bd4
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61459119"
---
# <a name="signaling-timed-metadata-in-live-streaming"></a>Сигнализация метаданных времени в потоковой трансляции 


## <a name="1-introduction"></a>1. Введение 
Для упрощения вставки рекламы или пользовательских событий в клиентский проигрыватель вещатели часто используют метаданные времени, внедренные в видео. Для реализации этих сценариев службы мультимедиа поддерживают передачу метаданных времени и мультимедиа из точки приема канала потоковой передачи в клиентское приложение.
В этой спецификации описываются два режима, поддерживаемые службами мультимедиа для метаданных времени в сигналах потоковой трансляции.

1. Сигнализация [SCTE-35], которая соответствует основным рекомендациям по работе, описанным в [SCTE-67].

2. Режим сигнализации уникальных метаданных времени для сообщений, которые не относятся к [SCTE-35].

### <a name="12-conformance-notation"></a>1.2. Замечание о соответствии
Ключевые слова "НЕОБХОДИМО" ("ДОЛЖНО"), "НЕДОПУСТИМО", "ТРЕБУЕТСЯ", "НУЖНО", "НЕ ПОЗВОЛЯЕТСЯ", "СЛЕДУЕТ" ("ДОЛЖНО"), "НЕ СЛЕДУЕТ", "РЕКОМЕНДУЕТСЯ", "ВОЗМОЖНО" и "НЕОБЯЗАТЕЛЬНО" в данном документе интерпретируются согласно описанию в документе RFC 2119.

### <a name="13-terms-used"></a>1.3. Используемые термины

| Срок действия              | Определение                                                                                                                                                                                                                       |
|-------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Время презентации | Время, когда событие демонстрируется зрителю. Это момент на временной шкале мультимедийного содержимого, когда зритель увидит событие. Например, время презентации командного сообщения SCTE-35 splice_info() — splice_time(). |
| Время получения      | Время поступления сообщения о событии. Обычно это время отличается от времени презентации события, так как сообщения о событии отправляются до его начала.                                     |
| Разреженная дорожка      | Дорожка мультимедиа, которая не является непрерывной и синхронизируется по времени с родительской или контрольной дорожкой.                                                                                                                                    |
| Исходный            | Служба потоковой передачи мультимедиа Azure.                                                                                                                                                                                                |
| Приемник канала      | Служба потоковой передачи мультимедиа в реальном времени Azure.                                                                                                                                                                                           |
| HLS               | Протокол Apple HTTP Live Streaming.                                                                                                                                                                                               |
| DASH              | Динамическая адаптивная потоковая передача по протоколу HTTP.                                                                                                                                                                                             |
| Smooth            | Протокол Smooth Streaming.                                                                                                                                                                                                        |
| MPEG2-TS          | Транспортные потоки MPEG-2.                                                                                                                                                                                                         |
| RTMP              | Протокол мультимедиа в режиме реального времени.                                                                                                                                                                                                    |
| uimsbf            | Целое число без знака, наиболее значимый бит указан первым.                                                                                                                                                                                    |

-----------------------

## <a name="2-timed-metadata-ingest"></a>2. Прием метаданных времени
## <a name="21-rtmp-ingest"></a>2.1. Прием RTMP
RTMP поддерживает сигналы метаданных времени, отправленные в качестве сообщений-сигналов AMF, внедренных в поток RTMP. Сообщения-сигналы можно отправлять за некоторое время до фактического события, в противном случае необходимо будет вставить рекламу. Для реализации этого сценария фактическое время соединения или сегмент отправляются в сообщении-сигнале. Чтобы получить дополнительные сведения, ознакомьтесь с [AMF0].

В следующей таблице описан формат полезных данных сообщения AMF, которые будут принимать службы мультимедиа.

Имя сообщения AMF можно использовать для дифференциации нескольких потоков событий одного типа.  Для сообщений [SCTE-35] имя сообщения AMF ДОЛЖНО быть onAdCue, как рекомендовано в [SCTE-67].  Все поля, не указанные ниже, ДОЛЖНЫ игнорироваться, позволяя этой инновационной конструкции не блокироваться в будущем.

### <a name="signal-syntax"></a>Синтаксис сигнала
В простом режиме RTMP службы мультимедиа поддерживают одно сообщение-сигнал AMF с именем onAdCue следующего формата:

### <a name="simple-mode"></a>Простой режим

| Имя поля | Тип поля | Обязательный? | Описание                                                                                                             |
|------------|------------|----------|--------------------------------------------------------------------------------------------------------------------------|
| cue        | String     | Обязательно для заполнения | Сообщение о событии.  Должно иметь значение SpliceOut, чтобы иметь возможность назначить соединение в простом режиме.                                              |
| идентификатор         | String     | Обязательно для заполнения | Уникальный идентификатор, описывающий соединение или сегмент. Определяет экземпляр сообщения.                            |
| длительность   | число     | Обязательно для заполнения | Длительность соединения. Единицы измерения — доли секунды.                                                                |
| elapsed    | число     | Необязательно | Если сигнал повторяется для поддержки настройки, это поле должно отображать количество времени презентации, которое прошло с момента начала соединения. Единицы измерения — доли секунды. В простом режиме это значение не должно превышать первоначальную длительность соединения.                                                  |
| time       | число     | Обязательно для заполнения | Должно соответствовать времени соединения в рамках времени презентации. Единицы измерения — доли секунды.                                     |

---------------------------

### <a name="scte-35-mode"></a>Режим SCTE-35

| Имя поля | Тип поля | Обязательный? | Описание                                                                                                             |
|------------|------------|----------|--------------------------------------------------------------------------------------------------------------------------|
| cue        | String     | Обязательно для заполнения | Сообщение о событии.  Для сообщений [SCTE-35] это ДОЛЖНО быть значение splice_info_section(), закодированное в виде строки Base64 (IETF RFC 4648) в двоичном формате, чтобы иметь возможность отправить сообщения клиентам HLS, Smooth и Dash в соответствии с [SCTE-67].                                              |
| тип       | String     | Обязательно для заполнения | URN или URL-адрес, определяющий схему сообщения. Для сообщений [SCTE-35] это ДОЛЖНО быть значение urn:scte:scte35:2013a:bin, чтобы иметь возможность отправить сообщения клиентам HLS, Smooth и Dash в соответствии с [SCTE-67].  |
| идентификатор         | String     | Обязательно для заполнения | Уникальный идентификатор, описывающий соединение или сегмент. Определяет экземпляр сообщения.  Сообщения с одинаковой семантикой должны иметь одно и то же значение.|
| длительность   | число     | Обязательно для заполнения | Длительность события или сегмента добавления рекламы (если она известна). Если она не известна, значение должно быть равно 0.                                                                 |
| elapsed    | число     | Необязательно | Если сигнал рекламы [SCTE-35] повторяется для настройки, это поле должно отображать количество времени презентации, которое прошло с момента начала соединения. Единицы измерения — доли секунды. В режиме [SCTE-35] это значение может превышать исходную указанную длительность соединения или сегмента.                                                  |
| time       | число     | Обязательно для заполнения | Время презентации события или вставки рекламы.  Время презентации и длительность ДОЛЖНЫ соответствовать точкам доступа к потоку типа 1 или 2 в соответствии с дополнением I [ISO-14496-12]. Для HLS исходящий трафик, время и длительность ДОЛЖНЫ соответствовать границам сегмента. Время презентации и длительность различных сообщений о событии в одном потоке событий НЕ ДОЛЖНЫ перекрываться. Единицы измерения — доли секунды.

---------------------------

#### <a name="211-cancellation-and-updates"></a>2.1.1. Отмена и обновления

Сообщения можно отменить или обновить, отправив несколько сообщений с одинаковым временем и идентификатором презентации. Время и идентификатор презентации уникально идентифицируют событие, а последнее сообщение, полученное для конкретного времени презентации, которое соответствует ограничениям до начала просмотра, — это сообщение, в отношении которого выполняются действия. Обновленное событие заменяет любые сообщения, полученные ранее. Ограничение до начала просмотра — четыре секунды. Сообщения, полученные хотя бы на четыре секунды раньше времени презентации, будут обрабатываться.

## <a name="22-fragmented-mp4-ingest-smooth-streaming"></a>2.2. Прием фрагментированного MP4 (Smooth Streaming)
Ознакомьтесь с [LIVE-FMP4], чтобы получить сведения о приеме потока в реальном времени. В следующих разделах содержатся сведения о получении метаданных времени презентации.  Метаданные времени презентации принимаются как разреженная дорожка, которая определена в поле манифеста сервера прямой передачи (см. MS-SSTR) и поле фильма (moov).  Каждый разреженный фрагмент состоит из поля фрагмента фильма (moof) и поля данных мультимедиа (mdat), где поле mdat — это двоичное сообщение.

#### <a name="221-live-server-manifest-box"></a>2.2.1. Поле манифеста сервера прямой передачи
Разреженная дорожка ДОЛЖНА объявляться в поле манифеста сервера прямой передачи с помощью записи \<textstream\> и ДОЛЖНА иметь следующий набор атрибутов:

| **Имя атрибута** | **Тип поля** | **Обязательный?** | **Описание**                                                                                                                                                                                                                                                 |
|--------------------|----------------|---------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| systemBitrate      | число         | Обязательно для заполнения      | ДОЛЖНО иметь значение 0, указывающее дорожку с неизвестной переменной скоростью.                                                                                                                                                                                                 |
| parentTrackName    | String         | Обязательно для заполнения      | ДОЛЖНО быть указано имя родительской дорожки, с которой коды времени разреженной дорожки согласованы по шкале времени. Родительская дорожка не может быть разреженной.                                                                                                                    |
| manifestOutput     | Boolean        | Обязательно для заполнения      | ДОЛЖЕН иметь значение true, чтобы определить, что разреженная дорожка будет внедрена в манифест клиента Smooth.                                                                                                                                                               |
| Subtype            | String         | Обязательно для заполнения      | Это ДОЛЖЕН быть четырехзначный код DATA.                                                                                                                                                                                                                         |
| Схема             | String         | Обязательно для заполнения      | Это должен быть URN или URL-адрес, определяющий схему сообщения. Для сообщений [SCTE-35] это ДОЛЖНО быть значение urn:scte:scte35:2013a:bin, чтобы иметь возможность отправить сообщения клиентам HLS, Smooth и Dash в соответствии с [SCTE-67]. |
| trackName          | String         | Обязательно для заполнения      | ДОЛЖНО быть указано имя разреженной дорожки. Атрибут trackName можно использовать для дифференциации нескольких потоков событий в одной схеме. Каждый уникальный поток событий должен иметь уникальное имя дорожки.                                                                           |
| timescale          | число         | Необязательно      | ДОЛЖНО указывать шкалу времени родительской дорожки.                                                                                                                                                                                                                      |

-------------------------------------

### <a name="222-movie-box"></a>2.2.2. Поле фильма

Поле фильма (moov) соответствует полю манифеста сервера прямой передачи как часть заголовка потока для родительской дорожки.

Поле moov ДОЛЖНО содержать поле **TrackHeaderBox (tkhd)**, как указано в [ISO-14496-12], со следующими ограничениями:

| **Имя поля** | **Тип поля**          | **Обязательный?** | **Описание**                                                                                                |
|----------------|-------------------------|---------------|----------------------------------------------------------------------------------------------------------------|
| длительность       | 64-разрядное целое число без знака | Обязательно для заполнения      | ДОЛЖНО иметь значение 0, так как поле дорожки не имеет образцов и общая длительность образцов в поле дорожки равна 0. |

-------------------------------------

Поле moov ДОЛЖНО содержать**HandlerBox (hdlr)**, как указано в [ISO-14496-12], со следующими ограничениями:

| **Имя поля** | **Тип поля**          | **Обязательный?** | **Описание**   |
|----------------|-------------------------|---------------|-------------------|
| handler_type   | 32-разрядное целое число без знака | Обязательно для заполнения      | ДОЛЖНО иметь значение meta. |

-------------------------------------

Поле stsd ДОЛЖНО содержать поле MetaDataSampleEntry с именем кодирования, как указано в [ISO-14496-12].  Например, для сообщений SCTE-35 имя кодирования ДОЛЖНО быть scte.

### <a name="223-movie-fragment-box-and-media-data-box"></a>2.2.3. Поле фрагмента фильма и поле данных мультимедиа

Фрагменты разреженной дорожки содержат поле фрагмента фильма (moof) и поле данных мультимедиа (mdat).

Поле MovieFragmentBox (moof) должно содержать поле **TrackFragmentExtendedHeaderBox (uuid)**, как указано в [MS-SSTR], со следующими полями.

| **Имя поля**         | **Тип поля**          | **Обязательный?** | **Описание**                                                                               |
|------------------------|-------------------------|---------------|-----------------------------------------------------------------------------------------------|
| fragment_absolute_time | 64-разрядное целое число без знака | Обязательно для заполнения      | ДОЛЖНО указывать время получения события. Это значение согласовывает сообщение с родительской дорожкой.   |
| fragment_duration      | 64-разрядное целое число без знака | Обязательно для заполнения      | ДОЛЖНО указывать длительность события. Длительность может иметь значение 0. Это значит, что длительность неизвестна. |

------------------------------------


Поле MediaDataBox (mdat) ДОЛЖНО иметь следующий формат:

| **Имя поля**          | **Тип поля**                   | **Обязательный?** | **Описание**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|-------------------------|----------------------------------|---------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| версия                 | 32-разрядное целое число без знака (uimsbf) | Обязательно для заполнения      | Определяет формат содержимого поля mdat. Нераспознанные версии будут игнорироваться. Сейчас поддерживается только версия 1.                                                                                                                                                                                                                                                                                                                                                      |
| идентификатор                      | 32-разрядное целое число без знака (uimsbf) | Обязательно для заполнения      | Определяет экземпляр сообщения. Сообщения с одинаковой семантикой должны иметь одинаковое значение. Поэтому обработки любого поля сообщения о событии с одинаковым идентификатором будет достаточно.                                                                                                                                                                                                                                                                                                            |
| presentation_time_delta | 32-разрядное целое число без знака (uimsbf) | Обязательно для заполнения      | Сумма времени fragment_absolute_time, указанного в TrackFragmentExtendedHeaderBox, и времени presentation_time_delta ДОЛЖНА представлять время презентации события. Время презентации и длительность ДОЛЖНЫ соответствовать точкам доступа к потоку типа 1 или 2 в соответствии с дополнением I [ISO-14496-12]. Для HLS исходящий трафик, время и длительность ДОЛЖНЫ соответствовать границам сегмента. Время презентации и длительность различных сообщений о событии в одном потоке событий НЕ ДОЛЖНЫ перекрываться. |
| Message                 | массив байтов;                       | Обязательно для заполнения      | Сообщение о событии. Для сообщений [SCTE-35] это splice_info_section() в двоичном формате, хотя это и не рекомендуется в [SCTE-67]. Для сообщений [SCTE-35] это ДОЛЖНО быть splice_info_section(), чтобы иметь возможность отправить сообщения клиентам HLS, Smooth и Dash в соответствии с [SCTE-67]. Для сообщений [SCTE-35] splice_info_section() в двоичном формате — это полезные данные поля mdat, которые НЕ закодированы в виде строки Base64.                                                            |

------------------------------


### <a name="224-cancellation-and-updates"></a>2.2.4. Отмена и обновления
Сообщения можно отменить или обновить, отправив несколько сообщений с одинаковым временем и идентификатором презентации.  Время и идентификатор презентации уникально идентифицируют событие. Последнее сообщение, полученное для конкретного времени презентации, которое соответствует ограничениям до начала просмотра, — это сообщение, в отношении которого выполняются действия. Обновленное сообщение заменяет любые сообщения, полученные ранее.  Ограничение до начала просмотра — четыре секунды. Сообщения, полученные хотя бы на четыре секунды раньше времени презентации, будут обрабатываться. 


## <a name="3-timed-metadata-delivery"></a>3. Доставка метаданных времени

Данные потока событий являются непрозрачными для служб мультимедиа. Службы мультимедиа просто передают три элемента информации между конечной точкой приема и клиента. Следующие свойства доставляются клиенту в соответствии с [SCTE-67] и протоколом потоковой передачи клиента:

1.  Схема — URN или URL-адрес, определяющий схему сообщения.

2.  Время презентации — время презентации события на временной шкале мультимедийного содержимого.

3.  Длительность — длительность события.

4.  Идентификатор — дополнительный уникальный идентификатор события.

5.  Сообщение — данные события.


## <a name="31-smooth-streaming-delivery"></a>3.1. Доставка Smooth Streaming

Ознакомьтесь со сведениями об обработке разреженной дорожки в спецификации [MS-SSTR].

#### <a name="smooth-client-manifest-example"></a>Пример манифеста клиента Smooth
~~~ xml
<?xml version=”1.0” encoding=”utf-8”?>
<SmoothStreamingMedia MajorVersion=”2” MinorVersion=”0” TimeScale=”10000000” IsLive=”true” Duration=”0”
  LookAheadFragmentCount=”2” DVRWindowLength=”6000000000”>

  <StreamIndex Type=”video” Name=”video” Subtype=”” Chunks=”0” TimeScale=”10000000”
    Url=”QualityLevels({bitrate})/Fragments(video={start time})”>
    <QualityLevel Index=”0” Bitrate=”230000”
      CodecPrivateData=”250000010FC3460B50878A0B5821FF878780490800704704DC0000010E5A67F840” FourCC=”WVC1”
      MaxWidth=”364” MaxHeight=”272”/>
    <QualityLevel Index=”1” Bitrate=”305000”
      CodecPrivateData=”250000010FC3480B50878A0B5821FF87878049080894E4A7640000010E5A67F840” FourCC=”WVC1”
      MaxWidth=”364” MaxHeight=”272”/>
    <c t=”0” d=”20000000” r=”300” />
  </StreamIndex>
  <StreamIndex Type=”audio” Name=”audio” Subtype=”” Chunks=”0” TimeScale=”10000000”
    Url=”QualityLevels({bitrate})/Fragments(audio={start time})”>
    <QualityLevel Index=”0” Bitrate=”96000” CodecPrivateData=”1000030000000000000000000000E00042C0”
      FourCC=”WMAP” AudioTag=”354” Channels=”2” SamplingRate=”44100” BitsPerSample=”16” PacketSize=”4459”/>
    <c t=”0” d=”20000000” r=”300” />
  </StreamIndex>
  <StreamIndex Type=”text” Name=”scte35-event-stream” Subtype=”DATA” Chunks=”0” TimeScale=”10000000”
    ParentStreamIndex=”video” ManifestOutput=”true” 
    Url=”QualityLevels({bitrate})/Fragments(captions={start time})”>
    <QualityLevel Index=”0” Bitrate=”0” CodecPrivateData=”” FourCC=””>
      <CustomAttributes>
        <Attribute Name=”Scheme” Value=”urn:scte:scte35:2013a:bin”/>
      </CustomAttributes>
    </QualityLevel>
    <!-- <f> contains base-64 encoded splice_info_section() message 
    <c t=”600000000” d=”300000000”>
<f>PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48QWNxdWlyZWRTaWduYWwgeG1sbnM9InVybjpjYWJsZWxhYnM6bWQ6eHNkOnNpZ25hbGluZzozLjAiIGFjcXVpc2l0aW9uUG9pbnRJZGVudGl0eT0iRVNQTl9FYXN0X0FjcXVpc2l0aW9uX1BvaW50XzEiIGFjcXVpc2l0aW9uU2lnbmFsSUQ9IjRBNkE5NEVFLTYyRkExMUUxQjFDQTg4MkY0ODI0MDE5QiIgYWNxdWlzaXRpb25UaW1lPSIyMDEyLTA5LTE4VDEwOjE0OjI2WiI+PFVUQ1BvaW50IHV0Y1BvaW50PSIyMDEyLTA5LTE4VDEwOjE0OjM0WiIvPjxTQ1RFMzVQb2ludERlc2NyaXB0b3Igc3BsaWNlQ29tbWFuZFR5cGU9IjUiPjxTcGxpY2VJbnNlcnQgc3BsaWNlRXZlbnRJRD0iMzQ0NTY4NjkxIiBvdXRPZk5ldHdvcmtJbmRpY2F0b3I9InRydWUiIHVuaXF1ZVByb2dyYW1JRD0iNTUzNTUiIGR1cmF0aW9uPSJQVDFNMFMiIGF2YWlsTnVtPSIxIiBhdmFpbHNFeHBlY3RlZD0iMTAiLz48L1NDVEUzNVBvaW50RGVzY3JpcHRvcj48U3RyZWFtVGltZXM+PFN0cmVhbVRpbWUgdGltZVR5cGU9IkhTUyIgdGltZVZhbHVlPSI1MTUwMDAwMDAwMDAiLz48L1N0cmVhbVRpbWVzPjwvQWNxdWlyZWRTaWduYWw+</f>
    </c>
    <c t=”1200000000” d=”400000000”>      <f>PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48QWNxdWlyZWRTaWduYWwgeG1sbnM9InVybjpjYWJsZWxhYnM6bWQ6eHNkOnNpZ25hbGluZzozLjAiIGFjcXVpc2l0aW9uUG9pbnRJZGVudGl0eT0iRVNQTl9FYXN0X0FjcXVpc2l0aW9uX1BvaW50XzEiIGFjcXVpc2l0aW9uU2lnbmFsSUQ9IjRBNkE5NEVFLTYyRkExMUUxQjFDQTg4MkY0ODI0MDE5QiIgYWNxdWlzaXRpb25UaW1lPSIyMDEyLTA5LTE4VDEwOjE0OjI2WiI+PFVUQ1BvaW50IHV0Y1BvaW50PSIyMDEyLTA5LTE4VDEwOjE0OjM0WiIvPjxTQ1RFMzVQb2ludERlc2NyaXB0b3Igc3BsaWNlQ29tbWFuZFR5cGU9IjUiPjxTcGxpY2VJbnNlcnQgc3BsaWNlRXZlbnRJRD0iMzQ0NTY4NjkxIiBvdXRPZk5ldHdvcmtJbmRpY2F0b3I9InRydWUiIHVuaXF1ZVByb2dyYW1JRD0iNTUzNTUiIGR1cmF0aW9uPSJQVDFNMFMiIGF2YWlsTnVtPSIxIiBhdmFpbHNFeHBlY3RlZD0iMTAiLz48L1NDVEUzNVBvaW50RGVzY3JpcHRvcj48U3RyZWFtVGltZXM+PFN0cmVhbVRpbWUgdGltZVR5cGU9IkhTUyIgdGltZVZhbHVlPSI1MTYyMDAwMDAwMDAiLz48L1N0cmVhbVRpbWVzPjwvQWNxdWlyZWRTaWduYWw+</f>
    </c>
  </StreamIndex>
</SmoothStreamingMedia> 
~~~ 

## <a name="32--apple-hls-delivery"></a>3.2. Доставка Apple HLS
Метаданные времени для Apple HTTP Live Streaming (HLS) могут быть внедрены в список воспроизведения сегмента внутри пользовательского тега M3U.  Прикладной уровень может анализировать список воспроизведения M3U и обрабатывать теги M3U. Службы мультимедиа Azure будут внедрять метаданные времени в тег EXT-X-CUE, определенный в [HLS].  Сейчас тег EXT-X-CUE используется DynaMux для сообщений типа ADI3.  Для поддержки сообщений SCTE-35 и сообщений, не относящихся к SCTE-35, укажите атрибуты тега EXT-X-CUE, как указано ниже.

| **Имя атрибута** | **Тип**                      | **Обязательный?**                             | **Описание**                                                                                                                                                                                                                                                                      |
|--------------------|-------------------------------|-------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| CUE                | строка в кавычках                 | Обязательно для заполнения                                  | Сообщение, закодированное в виде строки Base64, как описано в [IETF RFC 4648](https://tools.ietf.org/html/rfc4648). Для сообщений [SCTE-35] это splice_info_section(), закодированное в виде строки Base64.                                                                                                |
| ТИП               | строка в кавычках                 | Обязательно для заполнения                                  | URN или URL-адрес, определяющий схему сообщения. Для сообщений [SCTE-35] тип имеет особое значение scte35.                                                                                                                                |
| ИД                 | строка в кавычках                 | Обязательно для заполнения                                  | Уникальный идентификатор события. Если идентификатор не указан при принятии сообщения, службы мультимедиа Azure создадут уникальный идентификатор.                                                                                                                                          |
| DURATION           | десятичное число с плавающей запятой | Обязательно для заполнения                                  | Длительность события. Если она не известна, значение должно быть равно 0. Единицы измерения — доли секунды.                                                                                                                                                                                           |
| ELAPSED            | десятичное число с плавающей запятой | Необязательно, но требуется для скользящего окна | Если сигнал повторяется для поддержки скользящего окна презентации, это поле ДОЛЖНО отображать количество времени презентации, которое прошло с момента начала события. Единицы измерения — доли секунды. Это значение может превышать исходную указанную длительность соединения или сегмента. |
| ВРЕМЯ               | десятичное число с плавающей запятой | Обязательно для заполнения                                  | Время презентации события. Единицы измерения — доли секунды.                                                                                                                                                                                                                    |


Прикладной уровень проигрывателя HLS будет использовать ТИП для определения формата сообщения, декодирования сообщения, применения необходимых преобразований времени и обработки события.  События синхронизируются по времени в списке воспроизведений сегмента родительской дорожки в соответствии с меткой времени события.  Они вставляются перед ближайшим сегментом (тег #EXTINF).

#### <a name="hls-segment-playlist-example"></a>Пример списка воспроизведения сегмента HLS
~~~
#EXTM3U
#EXT-X-VERSION:4
#EXT-X-ALLOW-CACHE:NO
#EXT-X-MEDIA-SEQUENCE:346
#EXT-X-TARGETDURATION:6
#EXT-X-I-FRAMES-ONLY
#EXT-X-PROGRAM-DATE-TIME:2018-12-13T15:54:19.462Z
#EXTINF:4.000000,no-desc
KeyFrames(video_track=15447164594627600,format=m3u8-aapl)
#EXTINF:6.000000,no-desc
KeyFrames(video_track=15447164634627600,format=m3u8-aapl)
#EXT-X-CUE:ID="1026",TYPE="scte35",DURATION=30.000000,TIME=1544716520.022760,CUE="/DAlAAAAAAAAAP/wFAUAAAQCf+//KRjAfP4AKTLgAAAAAAAAVYsh2w=="
#EXTINF:6.000000,no-desc
KeyFrames(video_track=15447165474627600,format=m3u8-aapl)
~~~

#### <a name="hls-message-handling"></a>Обработка сообщений HLS

Сведения о событиях сообщаются в списке воспроизведения сегмента каждой видео- и аудиодорожки. Тег EXT-X-CUE всегда ДОЛЖЕН находиться перед первым сегментом HLS (для разделения или запуска сегмента) или непосредственно после последнего сегмента HLS (для соединения или завершения сегмента), на которые указывают атрибуты TIME и DURATION, как требуется в [HLS].

Если скользящее окно презентации включено, тег EXT-X-CUE ДОЛЖЕН повторяться достаточное количество раз, чтобы соединение или сегмент всегда полностью описывались в списке воспроизведения сегмента. Атрибут ELAPSED ДОЛЖЕН использоваться для определения длительности времени активности соединения или сегмента, как требуется в [HLS].

Если скользящее окно презентации включено, теги EXT-X-CUE удаляются из списка воспроизведения сегмента, когда время мультимедиа, к которому они относятся, прошло в скользящем окне презентации.

## <a name="33--dash-delivery"></a>3.3. Доставка DASH
[DASH] предоставляет три способа сообщения о событиях:

1.  О событиях сообщается в MPD.
2.  О событиях сообщается по общему каналу в представлении (в поле сообщений о событии (emsg)).
3.  Путем сочетания 1 и 2 способов.

События, о которых сообщается в MPD, полезны для потоковой передачи VOD, так как клиенты имеют доступ ко всем событиям сразу же при скачивании MPD. Внутриканальное решение полезно для потоковой трансляции, так как клиентам не нужно скачивать MPD повторно. Для сегментации на основе времени клиент определяет URL-адрес следующего сегмента путем добавления длительности и метки времени текущего сегмента. Если запрос завершается ошибкой, клиент предполагает прерывание и скачивает MPD. В противном случае он продолжает осуществлять потоковую передачу, не скачивая MPD.

Службы мультимедиа Azure будут выполнять процесс сигнализации в MPD и в общем канале с помощью поля сообщения о событии.

#### <a name="mpd-signaling"></a>Сигнализация MPD

О событиях будет сообщаться в MPD с помощью элемента EventStream, который появляется в элементе Period.

Элемент EventStream имеет следующие атрибуты:

| **Имя атрибута** | **Тип**                | **Обязательный?** | **Описание**                                                                                                                                                                                                                                                                                   |
|--------------------|-------------------------|---------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| scheme_id_uri      | string                  | Обязательно для заполнения      | Определяет схему сообщения. Схема получает значение атрибута Scheme в поле манифеста сервера прямой передачи. Значение должно соответствовать URN или URL-адресу, определяющему схему сообщения, например "urn:scte:scte35:2013a:bin".                                                                |
| value              | string                  | Необязательно      | Дополнительное строковое значение, используемое владельцами схемы для настройки семантики сообщения. Чтобы различить несколько потоков событий с одной схемой, значением ДОЛЖНО быть имя потока события (trackName для приема Smooth или имя сообщения AMF для приема RTMP). |
| Шкала времени          | 32-разрядное целое число без знака | Обязательно для заполнения      | Шкала времени (тактов в секунду) полей времени и длительности в поле emsg.                                                                                                                                                                                                       |


В элементе EventStream может содержаться как ноль, так и несколько элементов события. Они имеют следующие атрибуты:

| **Имя атрибута**  | **Тип**                | **Обязательный?** | **Описание**                                                                                                                                                                                                             |
|---------------------|-------------------------|---------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| presentation_time   | 64-разрядное целое число без знака | Необязательно      | ДОЛЖНО указывать время презентации мультимедиа события относительно начала периода. Время и длительность презентации ДОЛЖНЫ соответствовать точкам доступа к потоку типа 1 или 2 в соответствии с дополнением I [ISO-14496-12]. |
| длительность            | 32-разрядное целое число без знака | Необязательно      | Длительность события. Если длительность неизвестна, этот атрибут НЕОБХОДИМО пропустить.                                                                                                                                                 |
| идентификатор                  | 32-разрядное целое число без знака | Необязательно      | Определяет экземпляр сообщения. Сообщения с одинаковой семантикой должны иметь одно и то же значение. Если идентификатор не указан при принятии сообщения, службы мультимедиа Azure создадут уникальный идентификатор.             |
| Значение элемента события | string                  | Обязательно для заполнения      | Сообщение события, закодированное в виде строки Base64, как описано в [IETF RFC 4648](https://tools.ietf.org/html/rfc4648).                                                                                                                   |

#### <a name="xml-syntax-and-example-for-dash-manifest-mpd-signaling"></a>Синтаксис XML и пример для сигнализации манифеста DASH (MPD)

~~~ xml
<!-- XML Syntax -->
<xs:complexType name=”EventStreamType”>
  <xs:sequence>
    <xs:element name=”Event” type=”EventType” minOccurs=”0” maxOccurs=”unbounded”/>
    <xs:any namespace=”##other” processContents=”lax” minOccurs=”0” maxOccurs=”unbounded”/>
  </xs:sequence>
  <xs:attribute ref=”xlink:href”/>
  <xs:attribute ref=”xlink:actuate” default=”onRequest”/>
  <xs:attribute name=”schemeIdUri” type=”xs:anyURI” use=”required”/>
  <xs:attribute name=”value” type=”xs:string”/>
  <xs:attribute name=”timescale” type=”xs:unsignedInt”/>
</xs:complexType>
<!-- Event -->
<xs:complexType name=”EventType”>
  <xs:sequence>
    <xs:any namespace=”##other” processContents=”lax” minOccurs=”0” maxOccurs=”unbounded”/>
  </xs:sequence>
  <xs:attribute name=”presentationTime” type=”xs:unsignedLong” default=”0”/>
  <xs:attribute name=”duration” type=”xs:unsignedLong”/>
  <xs:attribute name=”id” type=”xs:unsignedInt”/>
  <xs:anyAttribute namespace=”##other” processContents=”lax”/>
</xs:complexType><?xml version=”1.0” encoding=”utf-8”?>


<!-- Example Section in MPD -->
  <EventStream schemeIdUri="urn:scte:scte35:2013a:bin" value="scte35_track_001_000" timescale="10000000">
        <Event presentationTime="15447165200227600" duration="300000000" id="1026">/DAlAAAAAAAAAP/wFAUAAAQCf+//KRjAfP4AKTLgAAAAAAAAVYsh2w==</Event>
        <Event presentationTime="15447166250227600" duration="300000000" id="1027">/DAlAAAAAAAAAP/wFAUAAAQDf+//KaeGwP4AKTLgAAAAAAAAn75a3g==</Event>
        <Event presentationTime="15447167300227600" duration="600000000" id="1028">/DAlAAAAAAAAAP/wFAUAAAQEf+//KjkknP4AUmXAAAAAAAAAWcEldA==</Event>
        <Event presentationTime="15447168350227600" duration="600000000" id="1029">/DAlAAAAAAAAAP/wFAUAAAQFf+//KslyqP4AUmXAAAAAAAAAvKNt0w==</Event>
        <Event presentationTime="15447169400227600" duration="300000000" id="1030">/DAlAAAAAAAAAP/wFAUAAAQGf+//K1mIvP4AKTLgAAAAAAAAt2zEbw==</Event>
        <Event presentationTime="15447170450227600" duration="600000000" id="1031">/DAlAAAAAAAAAP/wFAUAAAQHf+//K+hc/v4AUmXAAAAAAAAANNRzVw==</Event>
    </EventStream>
~~~

>[!NOTE]
>Обратите внимание, что presentationTime — это время презентации события, а не время получения сообщения.
>

### <a name="431-in-band-event-message-box-signaling"></a>4.3.1. Сигнализация поля сообщения о событии по общему каналу
Для потока событий по общему каналу необходимо, чтобы MPD имел элемент InbandEventStream на уровне набора адаптации.  Этот элемент имеет обязательный атрибут schemeIdUri и дополнительный атрибут timescale, который также отображается в поле сообщения о событии (emsg).  Поля сообщений о событии с идентификаторами схем, не определенными в MPD, должны отсутствовать. Если клиент DASH обнаруживает поле сообщения о событии со схемой, не определенной в MPD, он ее проигнорирует.
Поле сообщения о событии (emsg) сообщает об универсальных событиях, связанных с временем презентации мультимедиа. Если присутствует, поле emsg должно находиться перед любым полем moof.

### <a name="dash-event-message-box-emsg"></a>Поле сообщения о событии DASH emsg
~~~
Box Type: `emsg’
Container: Segment
Mandatory: No
Quantity: Zero or more
~~~

~~~ c
aligned(8) class DASHEventMessageBox extends FullBox(‘emsg’, version = 0, flags =0) 
{
    string scheme_id_uri;
    string value;
    unsigned int(32) timescale;
    unsigned int(32) presentation_time_delta;
    unsigned int(32) event_duration;
    unsigned int(32) id;
    unsigned int(8) message_data[];
}
~~~

Поля DASHEventMessageBox определены ниже.

| **Имя поля**          | **Тип поля**          | **Обязательный?** | **Описание**                                                                                                                                                                                                                                                                                                                                                    |
|-------------------------|-------------------------|---------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| scheme_id_uri           | string                  | Обязательно для заполнения      | Определяет схему сообщения. Схема получает значение атрибута Scheme в поле манифеста сервера прямой передачи. Это должен быть URN или URL-адрес, определяющий схему сообщения. Для сообщений [SCTE-35] оно имеет особое значение urn:scte:scte35:2013a:bin, хотя это и не рекомендуется в [SCTE-67]. |
| Value                   | string                  | Обязательно для заполнения      | Дополнительное строковое значение, используемое владельцами схемы для настройки семантики сообщения. Чтобы различить несколько потоков событий с одной схемой, в качестве значения будет использоваться имя потока события (trackName для приема Smooth или имя сообщения AMF для приема RTMP).                                                                  |
| Шкала времени               | 32-разрядное целое число без знака | Обязательно для заполнения      | Шкала времени (тактов в секунду) полей времени и длительности в поле emsg.                                                                                                                                                                                                                                                                        |
| Presentation_time_delta | 32-разрядное целое число без знака | Обязательно для заполнения      | Разница во времени между временем презентации события и временем первой презентации в сегменте. Время и длительность презентации ДОЛЖНЫ соответствовать точкам доступа к потоку типа 1 или 2 в соответствии с дополнением I [ISO-14496-12].                                                                                            |
| event_duration          | 32-разрядное целое число без знака | Обязательно для заполнения      | Длительность события или 0xFFFFFFFF для определения неизвестной длительности.                                                                                                                                                                                                                                                                                          |
| Идентификатор                      | 32-разрядное целое число без знака | Обязательно для заполнения      | Определяет экземпляр сообщения. Сообщения с одинаковой семантикой должны иметь одно и то же значение. Если идентификатор не указан при принятии сообщения, службы мультимедиа Azure создадут уникальный идентификатор.                                                                                                                                                    |
| Message_data            | массив байтов;              | Обязательно для заполнения      | Сообщение о событии. Для сообщений [SCTE-35] данные сообщения имеют двоичный формат splice_info_section(), хотя это и не рекомендуется в [SCTE-67].                                                                                                                                                                                                                                 |

### <a name="332-dash-message-handling"></a>3.3.2.Обработка сообщений DASH

О событиях сообщается по общему каналу в поле emsg для видео- и аудиодорожек.  Это происходит для всех запросов сегментов, значение presentation_time_delta которых 15 секунд или меньше. Если скользящее окно презентации включено, сообщения о событии удаляются из MPD, когда сумма времени и длительность сообщения о событии меньше времени данных мультимедиа в манифесте.  Другими словами сообщения о событиях удаляются из манифеста, когда время мультимедиа, к которому они относятся, прошло в скользящем окне презентации.

## <a name="4-scte-35-ingest"></a>4. Прием SCTE-35

Сообщения [SCTE-35] добавляются в двоичном формате с использованием схемы **urn:scte:scte35:2013a:bin** для приема Smooth и типа **scte35** для приема RTMP. Чтобы упростить преобразование времени [SCTE-35], которое основывается на метке времени презентации (PTS) транспортного потока MPEG-2, сопоставление между PTS (pts_time + pts_adjustment значения splice_time()) и временной шкалой мультимедийного содержимого определяется временем презентации события (поле fragment_absolute_time для приема Smooth и поле времени для приема RTMP). Сопоставление является необходимым, так как 33-разрядное значение PTS изменяется приблизительно каждые 26,5 часов.

Для приема Smooth Streaming поле данных мультимедиа (mdat) ДОЛЖНО содержать строку **splice_info_section()**, определенную в таблице 8–1 [SCTE-35]. Для приема RTMP атрибут cue сообщения AMF получает значение в виде строки **splice_info_section()** в кодировке Base64. Когда сообщения имеют указанный выше формат, они отправляются в клиенты HLS, Smooth и Dash в соответствии с [SCTE-67].


## <a name="5-references"></a>5. Справочные материалы

**[SCTE-35]** ANSI/SCTE 35 2013a — Digital Program Insertion Cueing Message for Cable, 2013a (Передача сообщений цифровой вставки программ для кабельного телевидения, 2013a).

**[SCTE-67]** ANSI/SCTE 67 2014 — Recommended Practice for SCTE 35: Digital Program Insertion Cueing Message for Cable (Рекомендуется для SCTE 35. Передача сообщений цифровой вставки программ для кабельного телевидения).

**[DASH]** ISO/IEC 23009-1 2014 — Information technology – Dynamic adaptive streaming over HTTP (DASH) – Part 1: Media Presentation description and segment formats, 2nd edition (Информационные технологии. Динамическая адаптивная потоковая передача по протоколу HTTP (DASH). Часть 1. Форматы описания представления мультимедиа и сегмента, 2 выпуск.)

**[HLS]** [HTTP Live Streaming, draft-pantos-http-live-streaming-14, 14 октября 2014 г.](http://tools.ietf.org/html/draft-pantos-http-live-streaming-14)

**[MS-SSTR]** [Протокол Microsoft Smooth Streaming, 15 мая 2014 г.](https://download.microsoft.com/download/9/5/E/95EF66AF-9026-4BB0-A41D-A4F81802D92C/%5bMS-SSTR%5d.pdf)

**[AMF0]** [Формат инициирующего сообщения AMF0](https://download.macromedia.com/pub/labs/amf/amf0_spec_121207.pdf).

**[LIVE-FMP4]** [Спецификация приема фрагментированного MP4 в реальном времени в службах мультимедиа Azure](https://docs.microsoft.com/azure/media-services/media-services-fmp4-live-ingest-overview)

**[ISO-14496-12]** ISO/IEC 14496-12: часть 12. Файл формата базового медиафайла ISO, четвертый выпуск от 15.07.2012.

**[RTMP]** [Протокол обмена сообщений в реальном времени Adobe, 21 декабря 2012 г.](https://www.adobe.com/devnet/rtmp.html) 

------------------------------------------

## <a name="next-steps"></a>Дальнейшие действия
Просмотрите схемы обучения работе со службами мультимедиа.

[!INCLUDE [media-services-learning-paths-include](../../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a>Отзывы
[!INCLUDE [media-services-user-voice-include](../../../includes/media-services-user-voice-include.md)]
