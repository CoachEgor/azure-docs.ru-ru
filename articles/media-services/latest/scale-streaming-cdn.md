---
title: Содержание потока с интеграцией CDN
titleSuffix: Azure Media Services
description: Узнайте о потоковом контенте с интеграцией CDN, а также о prefetching и Origin-Assist CDN-Prefetch.
services: media-services
documentationcenter: ''
author: Juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: ''
ms.topic: article
ms.date: 02/13/2020
ms.author: juliako
ms.openlocfilehash: 4ed8ada306720b7a8b44ddd59cefe399238c906a
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80128067"
---
# <a name="stream-content-with-cdn-integration"></a>Содержание потока с интеграцией CDN

Azure CDN предлагает разработчикам глобальное решение для быстрой доставки больших объемов содержимого пользователям путем кэширования содержимого на стратегически расположенных физических узлах по всему миру.  

CDN кэширует содержимое потокового из медиа-служб [потоковой точки (происхождения)](streaming-endpoint-concept.md) на кодек, на протокол потоковой передачи, на битрат, на формат контейнера и на шифрование/DRM. Для каждой комбинации код-потоковых протокол-контейнер формат-битрат-шифрование, будет отдельный кэш CDN.

Популярный контент будет подаваться непосредственно из кэша CDN при кэше видео. При просмотре в режиме реального времени содержимое с большой вероятностью кэшируется, так как обычно у вас есть много людей, наблюдающих за одними данными. Содержание по требованию может быть немного сложнее, потому что вы могли бы иметь некоторые содержание, которое популярно, а некоторые, что нет. Если у вас есть миллионы видео активов, где ни один из них не популярны (только один или два зрителя в неделю), но у вас есть тысячи людей, смотрящих все различные видео, CDN становится гораздо менее эффективным.

Необходимо также учитывать, как работает адаптивная потоковая передача. Каждый отдельный фрагмент видео кэшируется как своя сущность. Например, представьте себе первый раз, когда просматривается определенное видео. Если зритель пропускает смотреть только несколько секунд здесь и там, только видео фрагменты, связанные с тем, что человек смотрел получить кэшируется в CDN. При использовании адаптивной потоковой передачи можно применять от 5 до 7 разных скоростей передачи видео. Если один человек смотрит один битрейт, а другой человек смотрит другой битрейт, то каждый из них кэшируется отдельно в CDN. Даже если два человека смотрят один и тот же битрат, они могут передавать сяпотку по разным протоколам. Все протоколы (HLS, MPEG-DASH, Smooth Streaming) кэшируются отдельно. Таким образом, каждая скорость и протокол кэшируются отдельно и кэшируются только запрашиваемые фрагменты видео.

При принятии решения о том, включать или не включать CDN на [конечную точку потоковой передачи медиа-услуг,](streaming-endpoint-concept.md)учитывайте количество ожидаемых зрителей. CDN помогает только в том случае, если вы ожидаете много зрителей для вашего контента. Если максимальная параллель зрителей ниже 500, рекомендуется отключить CDN, так как CDN лучше всего масштабируется с параллелизмом.

Эта тема обсуждает сярприза, позволяющие [интегрировать CDN.](#enable-azure-cdn-integration) Это также объясняет prefetching (активное кэширование) и концепцию [Origin-Assist CDN-Prefetch.](#origin-assist-cdn-prefetch)

## <a name="considerations"></a>Рекомендации

* Конечная `hostname` [точка потоковой передачи](streaming-endpoint-concept.md) и URL-адрес потоковой передачи остаются неизменными независимо от того, включите ли вы CDN.
* Если вам нужна возможность протестировать содержимое с CDN или без него, создайте другую конечную точку потоковой передачи, которая не включена CDN.

## <a name="enable-azure-cdn-integration"></a>Включение интеграции Azure CDN

> [!IMPORTANT]
> Вы не можете включить CDN для пробных или студенческих учетных записей Azure.
>
> Интеграция CDN включена во всех центрах обработки данных Azure, за исключением регионов федерального правительства и Китая.

После того, как конечная точка потоковой передачи предоставляется с включенным CDN, в Службах Мультимедиа есть определенное время ожидания, прежде чем будет сделано обновление DNS для отображения точки потоковой передачи в конечную точку CDN.

Если позже вы захотите отключить или включить CDN, конечную точку потоковой передачи нужно перевести в состояние **Остановлена**. Включение интеграции Azure CDN и активация изменений по всем расположениям POP CDN может занять до двух часов. Тем не менее, вы можете начать потоковую конечную точку и поток без перерывов с точки зрения потоковой передачи. Как только интеграция завершена, поток доставляется из CDN. В период подготовки конечная точка потоковой передачи будет находиться в **исходном** состоянии, и вы можете наблюдать снижение производительности.

Когда создается конечная точка потоковой передачи Standard, она настраивается по умолчанию со стандартной Verizon. Вы можете настроить Premium Verizon или Стандартный Akamai провайдеров с помощью REST AIS.

Для конечных точек потоковой передачи уровня "Стандартный" интеграция служб мультимедиа Azure с Azure CDN реализуется на базе **Azure CDN от Verizon**. Конечные точки потоковой передачи уровня "Премиум" можно настроить, используя все **ценовые категории и поставщики Azure CDN**.

> [!NOTE]
> Для получения подробной информации о Azure CDN, [см.](../../cdn/cdn-overview.md)

## <a name="determine-if-a-dns-change-was-made"></a>Определить, было ли внесено изменение DNS

Вы можете определить, было ли внесено изменение DNS на конечную точку потоковой <https://www.digwebinterface.com>передачи (трафик направляется в Azure CDN) с помощью . Если вы видите azureedge.net доменных имен в результатах, трафик в настоящее время указывается на CDN.

## <a name="origin-assist-cdn-prefetch"></a>Происхождение-Assist CDN-Prefetch

Кэширование CDN является реактивным процессом. Если CDN может предсказать, что будет запрошено следующим объектом, CDN может заранее запросить и кэшировать следующий объект. С помощью этого процесса можно достичь кэш-хит для всех (или большинство) объектов, что повышает производительность.

Концепция prefetching стремится позиционировать объекты на "край интернета" в ожидании, что они будут запрошены игроком в ближайшее время, тем самым сокращая время, чтобы доставить этот объект игроку.

Для достижения этой цели потоковая конечная точка (происхождение) и CDN должны работать рука об руку несколькими способами:

- Происхождение Медиа-служб ы должно иметь "интеллект" (Origin-Assist) для информирования CDN о следующем объекте для предварительного извлечения.
- CDN делает prefetch и кэширование (cdN-prefetch часть). CDN также должен иметь "интеллект", чтобы сообщить о происхождении, будь то prefetch или регулярные принести, обрабатывать 404 ответов, и способ избежать бесконечного цикла prefetch.

### <a name="benefits"></a>Преимущества

Преимущества функции *Origin-Assist CDN-Prefetch* включают в себя:

- Prefetch улучшает качество воспроизведения видео, предварительно распомещая ожидаемые сегменты видео на краю во время воспроизведения, уменьшая задержку для зрителя и улучшая время загрузки видеосегмента. Это приводит к более быстрому времени запуска видео и более низким случаям rebuffering.
- Эта концепция применима к общему сценарию CDN-происхождения и не ограничивается носителями.
- Akamai добавил эту функцию в [облако Akamai Embed (ACE).](https://learn.akamai.com/en-us/products/media_delivery/cloud_embed.html)

> [!NOTE]
> Эта функция пока не применима к AKAmai CDN, интегрированному с конечным пунктом потоковой передачи медиа-услуг. Тем не менее, он доступен для клиентов Media Services, которые имеют уже существующий контракт Akamai и требуют пользовательской интеграции между Akamai CDN и происхождением Медиа-услуг.

### <a name="how-it-works"></a>Принцип работы

Поддержка CDN `Origin-Assist CDN-Prefetch` для заголовков (как для потоковой передачи в прямом эфире, так и для потокового видео) доступна клиентам, имеющим прямой контракт с Akamai CDN. Функция включает в себя следующие обмены заголовками HTTP между Akamai CDN и источником медиа-услуг:

|Заголовок HTTP|Значения|Отправитель|Получатель|Назначение|
| ---- | ---- | ---- | ---- | ----- |
|`CDN-Origin-Assist-Prefetch-Enabled` | 1 (по умолчанию) или 0 |CDN|Исходный домен|Для обозначения CDN включена пределечная.|
|`CDN-Origin-Assist-Prefetch-Path`| Пример <br/>Фрагменты (видео 14000000000,формат-mpd-время-cmaf)|Исходный домен|CDN|Чтобы обеспечить путь prefetch к CDN.|
|`CDN-Origin-Assist-Prefetch-Request`|1 (запрос на prefetch) или 0 (обычный запрос)|CDN|Исходный домен|Указать запрос от CDN является предварительным извлечением.|

Чтобы увидеть часть обмена заголовком в действии, вы можете попробовать следующие шаги:

1. Используйте Postman или cURL для выдачи запроса в службу массовой информации происхождения для аудио или видео сегмента или фрагмента. Убедитесь в том, `CDN-Origin-Assist-Prefetch-Enabled: 1` чтобы добавить заголовок в запросе.
2. В ответе следует видеть заголовок `CDN-Origin-Assist-Prefetch-Path` с относительным путем в качестве его значения.

### <a name="supported-streaming-protocols"></a>Поддерживаемые протоколы потоковой передачи

Функция `Origin-Assist CDN-Prefetch` поддерживает следующие потоковые протоколы для потоковой передачи и потоковой передачи по требованию:

* HLS v3
* HLS v4
* HLS CMAF
* DASH (CSF)
* ДАИШ (CMAF)
* Потоковая передача Smooth Streaming

### <a name="faqs"></a>Часто задаваемые вопросы

* Что делать, если URL-адрес пути prefetch является недействительным, так что CDN prefetch получает 404?

    CDN будет кэшировать только 404 ответ в течение 10 секунд (или другое настроенное значение).

* Предположим, у вас есть видео по запросу. Если включен апарт-претация CDN, означает ли эта функция, что как только клиент запрашивает первый сегмент видео, prefetch запустит цикл для подготовки всех последующих сегментов видео в одном битрате?

    Нет, CDN-prefetch выполняется только после запроса/ответа, инициированного клиентом. CDN-prefetch никогда не вызывается prefetch, чтобы избежать цикла prefetch.

* Всегда ли функция Origin-Assist CDN-Prefetch? Как его можно/выключить?

    Эта возможность отключена по умолчанию. Клиенты должны включить его через Akamai API.

* Что будет с Origin-Assist, если следующий сегмент или фрагмент еще не доступен, то что произойдет с Origin-Assist?

    В этом случае происхождение Медиа-услуг `CDN-Origin-Assist-Prefetch-Path` не будет предоставлять заголовок и CDN-prefetch не будет происходить.

* Как `Origin-Assist CDN-Prefetch` работает с динамическими фильтрами манифеста?

    Эта функция работает независимо от явного фильтра. Когда следующий фрагмент находится вне окна фильтра, его URL-адрес будет по-прежнему находиться, загнав в необработанный манифест клиента, а затем возвращен в качестве заголовка ответа CDN prefetch. Так CDN получит URL фрагмента, который отфильтрочен из DASH/HLS/Smooth manifest. Тем не менее, игрок никогда не сделает запрос GET на CDN, чтобы получить этот фрагмент, потому что этот фрагмент не включен в dash/HLS/Smooth manifest, проводимый игроком (игрок не знает о существовании этого фрагмента).

* Можно ли провести плейлист DASH MPD/HLS/Smooth manifest?

    Нет, DASH MPD, мастер плейлист HLS, плейлист варианта HLS или плавный URL-адрес манифеста не добавляется в заголовок prefetch.

* Являются ли URL-адреса prefetch относительными или абсолютными?

    В то время как Akamai CDN позволяет использовать оба, происхождение Медиа-услуг предоставляет только относительные URL-адреса для пути prefetch, потому что нет никакой очевидной пользы в использовании абсолютных URL-адресов.

* Работает ли эта функция с защищенным DRM содержимым?

    Да, так как эта функция работает на уровне HTTP, она не расшифровывает и не разбирает какой-либо сегмент/фрагмент. Это не волнует, является ли содержание зашифровано или нет.

* Работает ли эта функция с вставкой Ad-вставки Server Side (SSAI)?
    
    Он работает для оригинального/основного контента (оригинальное видеоконтента перед вставкой рекламы), так как SSAI не изменяет отметку времени исходного контента из истоков Media Services. Работает ли эта функция с содержанием рекламы, зависит от того, поддерживает ли происхождение рекламы Origin-Assist. Например, если содержимое рекламы также размещается в службах мультимедиа Azure (то же или отдельное происхождение), содержимое рекламы также будет предварительно извлечено.

* Работает ли эта функция с содержимым UHD/HEVC?

    Да.

## <a name="ask-questions-give-feedback-get-updates"></a>Получение справки, отправка отзывов, получение обновлений

Прочитайте статью [сообщества Служб мультимедиа Azure](media-services-community.md), чтобы узнать, как задавать вопросы, оставлять отзывы и получать новости о Службах мультимедиа.

## <a name="next-steps"></a>Дальнейшие действия

* Убедитесь в том, чтобы просмотреть документ [конечной точки потоковой передачи (происхождения).](streaming-endpoint-concept.md)
* [В этом репозитории](https://github.com/Azure-Samples/media-services-v3-dotnet-quickstarts/blob/master/AMSV3Quickstarts/EncodeAndStreamFiles/Program.cs) предоставлен пример запуска стандартной конечной точки потоковой передачи с помощью .NET.
