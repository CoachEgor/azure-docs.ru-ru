---
title: Шифрование видео с помощью AES-128
titleSuffix: Azure Media Services
description: Узнайте, как зашифровать видео с помощью алгоритма AES с 128-разрядным шифрованием и использовать службу доставки ключей в службах мультимедиа Azure.
services: media-services
documentationcenter: ''
author: IngridAtMicrosoft
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/31/2020
ms.author: inhenkel
ms.openlocfilehash: d8bc270549f702f9ba277b3514a3332d16b52d8d
ms.sourcegitcommit: bcda98171d6e81795e723e525f81e6235f044e52
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/01/2020
ms.locfileid: "89267179"
---
# <a name="tutorial-encrypt-video-with-aes-128-and-use-the-key-delivery-service"></a>Учебник. шифрование видео с помощью AES-128 и использование службы доставки ключей

[!INCLUDE [media services api v3 logo](./includes/v3-hr.md)]

> [!NOTE]
> Несмотря на то, что в этом учебнике используются примеры для [пакета SDK для .NET](/dotnet/api/microsoft.azure.management.media.models.liveevent?view=azure-dotnet), общие шаги одинаковы для [REST API](/rest/api/media/liveevents), [CLI](/cli/azure/ams/live-event?view=azure-cli-latest) или других поддерживаемых [пакетов SDK](media-services-apis-overview.md#sdks).

Службы мультимедиа можно использовать для доставки содержимого HTTP Live Streaming (HLS), MPEG-DASH и Smooth Streaming, зашифрованного с помощью 128-битных ключей шифрования AES. Они также включают в себя службу доставки ключей, которая доставляет ключи шифрования авторизованным пользователям. Если вы хотите, чтобы службы мультимедиа динамически шифровались видео, необходимо связать ключ шифрования с указателем потоковой передачи, а также настроить политику ключа содержимого. Когда поток запрашивается проигрывателем, службы мультимедиа используют указанный ключ для динамического шифрования содержимого с помощью AES-128. Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценит политику ключа содержимого, заданную для него.

Каждый ресурс можно зашифровать с помощью нескольких типов шифрования (AES-128, PlayReady, Widevine, FairPlay). Чтобы понять, что лучше объединять, см. раздел [Протоколы потоковой передачи и типы шифрования](content-protection-overview.md#streaming-protocols-and-encryption-types). См. также раздел [Защита с помощью DRM](protect-with-drm.md).

Выходные данные примера этой статьи включают URL-адрес Проигрыватель мультимедиа Azure, URL-адрес манифеста и маркер AES, необходимый для воспроизведения содержимого. В примере задается срок действия маркера JSON Web Token (JWT) равным 1 часу. Можно открыть браузер и вставить полученный URL-адрес, чтобы запустить демонстрационную страницу Проигрывателя мультимедиа Azure с URL-адресом и токеном, который уже указан (в следующем формате: ```https://ampdemo.azureedge.net/?url= {dash Manifest URL} &aes=true&aestoken=Bearer%3D{ JWT Token here}```).

В этом учебнике демонстрируется выполнение следующих действий:

> [!div class="checklist"]
> * Скачайте пример [енкриптвисаес](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithAES) , описанный в этой статье.
> * Начните использовать API служб мультимедиа с пакетом SDK для .NET.
> * Создайте выходной ресурс.
> * Создайте преобразование кодировки.
> * Отправка задания.
> * Дождитесь завершения задания.
> * Создание политики ключа содержимого
> * Настройте политику для использования ограничения маркера JWT.
> * Создайте указатель потоковой передачи.
> * Настройте указатель потоковой передачи для шифрования видео с помощью AES (Клеаркэй).
> * Получение токена теста.
> * Создайте URL-адрес потоковой передачи.
> * Очистка ресурсов.

[!INCLUDE [quickstarts-free-trial-note](../../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>Предварительные требования

Ниже перечислены необходимые условия для выполнения действий, описанных в этом учебнике.

* Просмотрите статью [Обзор системы защиты содержимого](content-protection-overview.md).
* Установите Visual Studio Code или Visual Studio.
* [Создание учетной записи Служб мультимедиа](./create-account-howto.md).
* Получите учетные данные, необходимые для использования API служб мультимедиа с помощью [API доступа](./access-api-howto.md).

## <a name="download-code"></a>Скачать код

Клонируйте репозиторий GitHub, содержащий полный пример .NET, который был рассмотрен в этой статье, на компьютер с помощью следующей команды.

 ```bash
 git clone https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials.git
 ```

Образец "Шифровать с AES-128" находится в папке [EncryptWithAES](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithAES).

> [!NOTE]
> В этом примере уникальные ресурсы создаются каждый раз при запуске приложения. Как правило, вы будете повторно использовать существующие ресурсы, такие как преобразования и политики (если у существующего ресурса есть необходимые конфигурации).

## <a name="start-using-media-services-apis-with-net-sdk"></a>Начало использования API Служб мультимедиа с пакетом SDK для .NET

Чтобы приступить к использованию API-интерфейсов служб мультимедиа в .NET, создайте объект **азуремедиасервицесклиент** . Чтобы создать объект, введите учетные данные, необходимые клиенту для подключения к Azure с помощью Azure AD. В коде, клонированном в начале статьи, функция **GetCredentialsAsync** создает объект ServiceClientCredentials с использованием учетных данных, предоставленных в локальном файле конфигурации.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#CreateMediaServicesClient)]

## <a name="create-an-output-asset"></a>Создание выходного ресурса  

Выходной [ресурс](/rest/api/media/assets) сохраняет результаты задания кодирования.  

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#CreateOutputAsset)]

## <a name="get-or-create-an-encoding-transform"></a>Получение или создание преобразования кодировки

При создании нового экземпляра [преобразования](/rest/api/media/transforms) необходимо указать, что требуется создать в качестве выходных данных. Обязательный параметр — это объект **TransformOutput**, как показано в приведенном ниже примере кода. Каждый объект **TransformOutput** содержит **предустановку** (Preset). **Предустановка** описывает пошаговые инструкции для операций обработки видео и звука, которые будут использоваться для создания нужного объекта **TransformOutput**. Пример, описанный в этой статье, использует встроенную предустановку, называемую **AdaptiveStreaming**. Предустановка кодирует входное видео в автоматически создаваемые пары скорости (в парах скорости) на основе разрешения ввода и скорости, а затем создает MP4-файлы ISO с H. 264 Video и AAC Audio, соответствующие каждой паре для разрешения скорости.

Перед созданием нового [преобразования](/rest/api/media/transforms)сначала проверьте, существует ли оно с помощью метода **Get** , как показано в приведенном ниже коде. В Службах мультимедиа версии 3 методы **Get**, отправленные к сущностям, возвращают значение **NULL**, если сущность не существует (проверка по имени без учета регистра).

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#EnsureTransformExists)]

## <a name="submit-job"></a>Отправка задания

Как было указано выше, объект [преобразования](/rest/api/media/transforms) является набором инструкций, а [задание](/rest/api/media/jobs) — фактическим запросом к Службам мультимедиа для применения этого **преобразования** к данному видео и аудио. **Задание** указывает такую информацию, как расположение входного и выходного видео.

В этом руководстве мы создадим входные данные задания на основе файла, который принимается непосредственно из [URL-адреса источника HTTPS](job-input-from-http-how-to.md).

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#SubmitJob)]

## <a name="wait-for-the-job-to-complete"></a>Ожидание завершения задания

Запуск задания занимает некоторое время. Поэтому вам пригодится уведомление. В примере кода ниже показано, как опрашивать службу о состоянии [задания](/rest/api/media/jobs). Опрос не рекомендуется для приложений рабочей среды из-за потенциальной задержки. Его можно регулировать при чрезмерном использовании в учетной записи. Вместо этого разработчики должны использовать службу "Сетка событий". Дополнительные сведения см. в статье [Create and monitor Media Services events with Event Grid using the Azure CLI](job-state-events-cli-how-to.md) (Создание и мониторинг событий Служб мультимедиа с помощью Сетки событий и Azure CLI).

Для **задания** обычно последовательно устанавливаются следующие состояния: **Запланировано**, **В очереди**, **Идет обработка**, **Завершено** (конечное состояние). Если в задании обнаружена ошибка, вы получите состояние **Ошибка**. Если задание находится в процессе отмены, вы получите состояние **Выполнение отмены** и **Отменено** по завершении.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#WaitForJobToFinish)]

## <a name="create-a-content-key-policy"></a>Создание политики ключа содержимого

Ключ содержимого обеспечивает безопасность доступа к ресурсам. Необходимо создать **политику ключа содержимого** , которая настраивает способ доставки ключа содержимого конечным клиентам. Ключ содержимого связан с **указателем потоковой передачи**. Они также включают в себя службу доставки ключей, которая доставляет ключи шифрования авторизованным пользователям.

Когда поток запрашивается проигрывателем, службы мультимедиа используют указанный ключ для динамического шифрования содержимого (в данном случае с помощью шифрования AES). Чтобы расшифровать поток, проигрыватель запрашивает ключ от службы доставки ключей. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценит политику ключа содержимого, заданную для него.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#GetOrCreateContentKeyPolicy)]

## <a name="create-a-streaming-locator"></a>Создание указателя потоковой передачи

После выполнения кодирования и установки политики ключа содержимого следующий шаг — это сделать видео на выходном ресурсе доступным для воспроизведения клиентами. Сделать видео доступным в два этапа:

1. Создайте [указатель потоковой передачи](/rest/api/media/streaminglocators).
2. Создайте URL-адрес потоковой передачи, который смогут использовать клиенты.

Процесс создания **указателя потоковой передачи** называется публикацией. По умолчанию **указатель потоковой передачи** действителен сразу же после выполнения вызовов API. Он продолжается до тех пор, пока не будет настроено дополнительное время начала и окончания.

При создании [указателя потоковой передачи](/rest/api/media/streaminglocators)необходимо указать требуемый **стреамингполицинаме**. В этом руководстве мы используем один из ПредефинедстреамингполиЦиес, который сообщает службам мультимедиа Azure о том, как опубликовать содержимое для потоковой передачи. В этом примере применяется шифрование конверта AES (это шифрование также называется шифрованием Клеаркэй, поскольку ключ передается клиенту воспроизведения по протоколу HTTPS, а не по лицензии DRM).

> [!IMPORTANT]
> При использовании настраиваемой политики [StreamingPolicy](/rest/api/media/streamingpolicies) следует разработать ограниченный набор таких политик для учетной записи Служб мультимедиа и повторно использовать их для указателей потоковой передачи каждый раз, когда требуются те же параметры и протоколы шифрования. У вашей учетной записи Служб мультимедиа есть квота на количество записей StreamingPolicy. Не следует создавать новый Стреамингполици для каждого указателя потоковой передачи.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#CreateStreamingLocator)]

## <a name="get-a-test-token"></a>Получение маркера тестирования

В этом руководстве указывается, что политика ключа содержимого включает ограничение по маркеру. При ограничении с помощью маркера к политике должен прилагаться маркер, выданный службой маркеров безопасности (STS). Службы мультимедиа поддерживают маркеры в формате [JWT](/previous-versions/azure/azure-services/gg185950(v=azure.100)#BKMK_3) , и именно это мы настраиваем в примере.

Контенткэйидентифиерклаим используется в **политике ключей содержимого**. Это означает, что маркер, предоставленный службе доставки ключей, должен содержать идентификатор ключа содержимого. В примере мы не указали ключ содержимого при создании указателя потоковой передачи, система создала случайную единицу для нас. Чтобы создать токен теста, необходимо получить Контенткэйид, чтобы поместить его в утверждение Контенткэйидентифиерклаим.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#GetToken)]

## <a name="build-a-dash-streaming-url"></a>Создайте URL-адрес потоковой передачи данных DASH

Теперь, когда [указатель потоковой передачи](/rest/api/media/streaminglocators) создан, можно получить URL-адреса потоковой передачи. Чтобы создать URL-адрес, необходимо объединить имя узла [StreamingEndpoint](/rest/api/media/streamingendpoints) и путь **потокового указателя** . В этом примере используется **конечная точка потоковой передачи** *по умолчанию*. При первом создании учетной записи Служб мультимедиа эта **конечная точка потоковой передачи** *по умолчанию* будет находиться в состоянии "Остановлено", поэтому вам необходимо вызвать функцию **Start**.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#GetMPEGStreamingUrl)]

## <a name="clean-up-resources-in-your-media-services-account"></a>Очистка ресурсов в учетной записи Служб мультимедиа

Как правило, следует очищать все, кроме объектов, которые планируется повторно использовать (как правило, используются преобразования, указатели потоковой передачи и т. д.). Если учетную запись требуется очистить после эксперимента, удалите ресурсы, которые не планируется использовать повторно. Удалить задание, созданные ресурсы и политику ключа содержимого можно с помощью следующего кода:

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithAES/Program.cs#CleanUp)]

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вам больше не нужны какие-либо ресурсы в группе ресурсов, включая Службы мультимедиа и учетные записи хранения, созданные для этого руководства, удалите группу ресурсов, созданную ранее.

Выполните следующую команду CLI:

```azurecli
az group delete --name amsResourceGroup
```

## <a name="ask-questions-give-feedback-get-updates"></a>Получение справки, отправка отзывов, получение обновлений

Прочитайте статью [сообщества Служб мультимедиа Azure](media-services-community.md), чтобы узнать, как задавать вопросы, оставлять отзывы и получать новости о Службах мультимедиа.

## <a name="additional-notes"></a>Дополнительные замечания

* Widevine — это служба, которая предоставляется компанией Google Inc. и подпадает под условия предоставления услуг и политику конфиденциальности Google Inc.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Защита с помощью DRM](protect-with-drm.md)
