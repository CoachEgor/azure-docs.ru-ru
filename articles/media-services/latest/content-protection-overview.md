---
title: Защитите свой контент с помощью динамического шифрования Media Services v3
titleSuffix: Azure Media Services
description: Узнайте о защите контента с динамическим шифрованием, потоковыми протоколами и типами шифрования в медиаслужбах Azure.
services: media-services
documentationcenter: ''
author: Juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/17/2020
ms.author: juliako
ms.custom: seodec18
ms.openlocfilehash: c1c9440f7ec70cea98f270f04c3030c800dd0fde
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79461118"
---
# <a name="protect-your-content-with-media-services-dynamic-encryption"></a>Защитите свой контент динамическим шифрованием Media Services

Используйте медиа-службы Azure, чтобы защитить медиа-носители от времени, когда он покидает компьютер на протяжении всего пути хранения, обработки и доставки. а также доставлять в режиме реального времени и по требованию содержимое, зашифрованное динамически с помощью Advanced Encryption Standard (AES-128) или трех основных систем управления цифровыми правами (DRM): Microsoft PlayReady, Google Widevine и Apple FairPlay. Они также обеспечивают службу доставки ключей AES и лицензий DRM (PlayReady, Widevine и FairPlay) авторизованным клиентам. Если содержимое зашифровано с помощью четкого ключа AES и передается через HTTPS, это не ясно, пока не достигнет клиента. 

В Media Services v3 ключ содержимого связан с потоковым locator (см. [этот пример).](protect-with-aes128.md) При использовании службы доставки ключей Медиа-услуг вы можете позволить службам мультимедиа Azure —снабдить ключ содержимого для вас. Ключ содержимого должен быть сгенерирован самостоятельно, если вы используете собственную службу доставки ключей, или если вам нужно обрабатывать сценарий высокой доступности, где вам нужно иметь тот же ключ содержимого в двух центрах обработки данных.

Когда поток запрашивается проигрывателем, Службы мультимедиа используют указанный ключ для динамического шифрования содержимого с помощью незащищенного ключа AES или DRM. Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей служб мультимедиа или в указанной вами службе доставки ключей. Чтобы решить, имеет ли пользователь право получить ключ, служба оценивает политику ключа содержимого, указанную для ключа.

Чтобы настроить политики авторизации и аутентификации для лицензий и ключей, можно использовать REST API или клиентскую библиотеку мультимедиа.

Следующее изображение иллюстрирует рабочий процесс для защиты контента media Services:

![Рабочий процесс для защиты контента медиасервисов](./media/content-protection/content-protection.svg)
  
&#42; *динамическое шифрование поддерживает четкий ключ AES-128, CBCS и CENC. Для получения подробной [support matrix](#streaming-protocols-and-encryption-types)информации см.*

В этой статье разъясняется концепция и терминология, которые помогают вам понять защиту контента с помощью Media Services.

## <a name="main-components-of-a-content-protection-system"></a>Основные компоненты системы защиты контента

Чтобы успешно завершить систему защиты контента, необходимо полностью понять масштабы усилий. Следующие разделы дают обзор трех частей, которые необходимо реализовать.

> [!NOTE]
> Мы настоятельно рекомендуем вам сосредоточиться и полностью протестировать каждую часть в следующих разделах, прежде чем перейти к следующей части. Чтобы протестировать систему защиты контента, используйте инструменты, указанные в разделах.

### <a name="media-services-code"></a>Код медиа-услуг
  
[Пример DRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM/Program.cs) показывает, как реализовать мульти-DRM системы с Медиа-услуг v3 с помощью .NET. Он также показывает, как использовать лицензию Media Services /ключевую службу доставки.
  
Каждый ресурс можно зашифровать с помощью нескольких типов шифрования (AES-128, PlayReady, Widevine, FairPlay). Чтобы узнать, что имеет [Streaming protocols and encryption types](#streaming-protocols-and-encryption-types)смысл объединить, см.

В примере показано, как выполнить следующие задачи.

1. Создание и настройка [политики ключа содержимого.](content-key-policy-concept.md)

   Вы создаете политику ключа содержимого для настройки того, как ключ содержимого (который обеспечивает безопасный доступ к вашим ресурсам) доставляется конечным клиентам:  

   * Определите авторизацию лицензии. Укажите логику проверки авторизации на основе утверждений в JSON Web Token (JWT).
   * Направьтесь [лицензиями PlayReady,](playready-license-template-overview.md) [Widevine](widevine-license-template-overview.md)и/или [FreePlay.](fairplay-license-overview.md) Шаблоны позволяют настроить права и разрешения для каждого из DRM.

     ```
     ContentKeyPolicyPlayReadyConfiguration playReadyConfig = ConfigurePlayReadyLicenseTemplate();
     ContentKeyPolicyWidevineConfiguration widevineConfig = ConfigureWidevineLicenseTempate();
     ContentKeyPolicyFairPlayConfiguration fairPlayConfig = ConfigureFairPlayPolicyOptions();
     ```

2. Создайте [потоковое локатор,](streaming-locators-concept.md) настроенный для потоковой передачи зашифрованного актива.
  
   Потоковый локатор должен быть связан с [политикой потоковой передачи.](streaming-policy-concept.md) В примере мы `StreamingLocator.StreamingPolicyName` устанавливаем политику "Predefined_MultiDrmCencStreaming".

   Применяются шифрования PlayReady и Widevine, а ключ доставляется клиенту воспроизведения на основе настроенных лицензий DRM. Если вы также хотите зашифровать свой поток с помощью CBCS (FairPlay), используйте политику "Predefined_MultiDrmStreaming".

   Потоковое локатор также связано с политикой ключа содержимого, которую вы определили.

3. Создание тестового токена.

   Метод `GetTokenAsync` показывает, как создать маркер теста.
4. Создание URL-адреса потоковой передачи.

   Метод `GetDASHStreamingUrlAsync` показывает, как создать URL-адрес потоковой передачи. В этом примере URL-адрес передает содержимое DASH.

### <a name="player-with-an-aes-or-drm-client"></a>Игрок с клиентом AES или DRM

Приложение видеопроигрывателя на основе пакета SDK проигрывателя (или собственное, или браузерное) должно отвечать следующим требованиям.

* Игрок SDK поддерживает необходимых клиентов DRM.
* Игрок SDK поддерживает необходимые протоколы потоковой передачи: Smooth, DASH и/или HTTP Live Streaming (HLS).
* Игрок SDK может обрабатывать прохождение токена JWT в запросе на приобретение лицензии.

Проигрыватель можно создать с помощью [API проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/). [API ProtectionInfo Проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/) позволяет указать, какие технологии DRM следует использовать на разных платформах DRM.

Для тестирования зашифрованного содержимого AES или CENC (Widevine и (или) PlayReady) можно использовать [Проигрыватель мультимедиа Azure](https://aka.ms/azuremediaplayer). Убедитесь, что вы выберете **Расширенные варианты** и проверьте параметры шифрования.

Если необходимо протестировать зашифрованное содержимое FairPlay, используйте [этот тестовый проигрыватель](https://aka.ms/amtest). Игрок поддерживает Widevine, PlayReady и FairPlay DRMs, а также шифрование ключей AES-128.

Выберите правильный браузер для тестирования различных DRM:

* Хром, Опера или Firefox для Widevine.
* Microsoft Edge или Internet Explorer 11 для PlayReady.
* Сафари на macOS для FairPlay.

### <a name="security-token-service"></a>Служба токенов безопасности

Служба маркеров безопасности (STS) выпускает JWT в качестве токена доступа для бэк-энда доступа к ресурсам. В качестве резервного ресурса можно использовать службу доставки лицензий/ключов Media Services Azure. СТС должен определить следующие вещи:

* Эмитент и аудитория (или область охвата).
* Претензии, которые зависят от бизнес-требований в области защиты контента.
* Симметричная или асимметричная проверка для проверки подписи.
* Поддержка опрокидывания ключа (при необходимости).

Вы можете использовать [этот инструмент STS](https://openidconnectweb.azurewebsites.net/DRMTool/Jwt) для тестирования STS. Он поддерживает все три типа ключей проверки: симметричный, асимметричный или Активный каталог Azure (Azure AD) с опрокидыванием ключей.

## <a name="streaming-protocols-and-encryption-types"></a>Протоколы потоковой передачи и типы шифрования

Службы мультимедиа Azure доставляют содержимое, динамически зашифрованное с помощью незащищенного ключа AES или шифрования DRM путем использования PlayReady, Widevine или FairPlay. В настоящее время можно шифровать форматы HLS, MPEG DASH и Smooth Streaming. Каждый протокол поддерживает следующие методы шифрования.

### <a name="hls"></a>HLS

Протокол HLS поддерживает следующие форматы контейнеров и схемы шифрования:

|Формат контейнера|Схема шифрования|Пример URL|
|---|---|---|
|All|AES|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-aapl,encryption=cbc)`|
|MPG2-TS |CBCS (FairPlay) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-aapl,encryption=cbcs-aapl)`|
|CMAF(fmp4) |CBCS (FairPlay) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-cmaf,encryption=cbcs-aapl)`|
|MPG2-TS |CENC (PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-aapl,encryption=cenc)`|
|CMAF(fmp4) |CENC (PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-cmaf,encryption=cenc)`|

HLS/CMAF - FairPlay (включая HEVC/H.265) поддерживается на следующих устройствах:

* iOS 11 или позже.
* iPhone 8 или позже.
* MacOS High Sierra с процессором Intel 7-го поколения.

### <a name="mpeg-dash"></a>MPEG-DASH

Протокол MPEG-DASH поддерживает следующие форматы контейнеров и схемы шифрования:

|Формат контейнера|Схема шифрования|Примеры URL-адресов
|---|---|---|
|All|AES|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=mpd-time-csf,encryption=cbc)`|
|CSF(fmp4) |CENC (Widevine + PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=mpd-time-csf,encryption=cenc)`|
|CMAF(fmp4)|CENC (Widevine + PlayReady)|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=mpd-time-cmaf,encryption=cenc)`|

### <a name="smooth-streaming"></a>Smooth Streaming

Протокол Smooth Streaming поддерживает следующие форматы контейнеров и схемы шифрования.

|Протокол|Формат контейнера|Схема шифрования|
|---|---|---|
|fMP4|AES|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(encryption=cbc)`|
|fMP4 | CENC (PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(encryption=cenc)`|

### <a name="browsers"></a>Браузеры

Общие браузеры поддерживают следующих клиентов DRM:

|Браузер|Шифрование|
|---|---|
|Chrome|Widevine|
|Microsoft Edge, Internet Explorer 11|PlayReady|
|Firefox|Widevine|
|Opera|Widevine|
|Safari|FairPlay|

## <a name="controlling-content-access"></a>Контроль доступа к контенту

Вы можете контролировать пользователей, имеющих доступ к содержимому, настроив политику ключей содержимого. Службы мультимедиа поддерживают несколько способов авторизации пользователей, которые запрашивают ключи. Прежде чем ключ будет доставлен клиенту (проигрыватель), он должен быть приведен в соответствие с политикой. Политика ключей содержимого может иметь ограничения по *открытию* или по *маркеру*.

Политика ключа ключа с открытым ограничением содержания может использоваться, если вы хотите выдать лицензию любому человеку без разрешения. Например, если ваш доход основан на рекламе, а не на подписке.  

С политикой ключа содержимого с ограничением токена ключ к содержимому ключ отправляется только клиенту, который представляет действительный токен JWT или простой веб-токен (SWT) в запросе лицензии/ключа. Этот токен должен быть выдан STS.

Вы можете использовать Azure AD в качестве STS или развернуть [пользовательский STS.](#using-a-custom-sts) Чтобы создать маркер, подписанный указанным ключом, и получить утверждения, указанные в конфигурации ограничения по маркерам, должна быть настроена служба маркеров безопасности. Лицензия Media Services/key delivery service возвращает запрашиваемую лицензию или ключ клиенту, если оба эти условия существуют:

* Токен действителен.
* Претензии в токене совпадают с требованиями, настроенными для лицензии или ключа.

При настройке политики ограничения по маркеру необходимо задать такие параметры, как основной ключ проверки, издатель и аудитория. Основной ключ проверки содержит ключ, которым был подписан маркер. Издателем является служба STS, которая выдала маркер. Аудитория, иногда называемая областью, описывает цель маркера или ресурса, к которому маркер разрешает доступ. Служба лицензирования/ключа службы доставки Media Services подтверждает, что эти значения в токене соответствуют значениям в шаблоне.

### <a name="token-replay-prevention"></a>Профилактика повтора токенов

Функция *Предотвращения воспроизведения токенов* позволяет клиентам Media Services устанавливать лимит на количество раз, сколько раз один и тот же маркер может быть использован для запроса ключа или лицензии. Клиент может добавить в `urn:microsoft:azure:mediaservices:maxuses` токен претензию типа, где значение — это количество раз, когда токен может быть использован для приобретения лицензии или ключа. Все последующие запросы с тем же маркером key Delivery возвращают несанкционированный ответ. Узнайте, как добавить претензию в [пример DRM.](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM/Program.cs#L601)
 
#### <a name="considerations"></a>Рекомендации

* Клиенты должны иметь контроль над генерацией токенов. Претензия должна быть помещена в сам токен.
* При использовании этой функции запросы с токенами, срок действия которых составляет более одного часа от момента получения запроса, отклоняются с несанкционированным ответом.
* Токены однозначно идентифицируются по их подписи. Любое изменение полезной нагрузки (например, обновление времени истечения срока действия или претензии) изменяет подпись токена, и оно будет засчитываться как новый маркер, с которым ранее не сталкивался Key Delivery.
* Воспроизведение завершается неудачей, `maxuses` если токен превысил значение, установленное клиентом.
* Эта функция может быть использована для всего существующего защищенного содержимого (необходимо изменить только выданный токен).
* Эта функция работает как с JWT, так и с SWT.

## <a name="using-a-custom-sts"></a>Использование пользовательского STS

Клиент может использовать пользовательский STS для предоставления токенов. Некоторые из причин:

* Поставщик идентификационных данных (IDP), используемый клиентом, не поддерживает STS. В этом случае решение — использовать пользовательскую службу STS.
* Клиенту может потребоваться более гибкий или более жесткий контроль при интеграции STS с системой выставления счетов подписчика клиента.

   Например, [OTT](https://en.wikipedia.org/wiki/Over-the-top_media_services) оператор OTT-сервиса может предложить несколько пакетов абонентов, таких как премиум, базовый и спортивный. Оператору может потребоваться сопоставить утверждения в маркере с пакетом подписчика, чтобы предоставлялось только содержимое в определенном пакете. В этом случае пользовательская STS предоставляет необходимую гибкость и контроль.

* Включить пользовательские требования в токен для выбора между различными ContentKeyPolicyOptions с различными параметрами лицензии DRM (лицензия на подписку по сравнению с лицензией на аренду).
* Включить претензию, представляющую идентификатор ключа содержимого ключа, к доступу к которому предоставляется токен.

При применении пользовательской STS необходимо внести два изменения:

* При настройке службы доставки лицензий для ресурса необходимо указать ключ безопасности, используемый для проверки пользовательской STS вместо текущего ключа из Azure Active Directory.
* Когда создается маркер JTW, вместо закрытого ключа текущего сертификата X509 в Azure AD указан ключ безопасности.

Существует два типа ключей безопасности:

* Симметричный ключ: тот же ключ используется для создания и проверки маркера JWT.
* Асимметричный ключ: пара открытого и закрытого ключей в сертификате X509 используется с закрытым ключом для шифрования и создания маркера JWT и с открытым ключом для проверки маркера.

При использовании .NET Framework/C# в качестве платформы разработки сертификат X509, используемый для асимметричного ключа безопасности, должен иметь длину ключа минимум 2048 бит. Эта длина ключа является требованием класса System.IdentityModel.Tokens.X509AsymmetricSecurityKey в рамках .NET. В противном случае, выбрасывается следующее исключение: IDX10630: 'System.IdentityModel.Tokens.X509AsymmetricSecurityKey' для подписания не может быть меньше, чем биты '2048'.

## <a name="custom-key-and-license-acquisition-url"></a>Url-адрес пользовательских ключей и лицензий

Используйте следующие шаблоны, если вы хотите указать другую службу доставки лицензии/ключа (не Медиа-сервисы). Два сменных поля в шаблонах существуют, так что вы можете поделиться своей политикой потоковой передачи во многих ресурсах вместо создания политики потоковой передачи на ресурсы. 

* `EnvelopeEncryption.CustomKeyAcquisitionUrlTemplate`: Шаблон для URL пользовательского сервиса, который предоставляет ключи конечным пользователям. Это не требуется, когда вы используете медиа-службы Azure для выдачи ключей. 

   Шаблон поддерживает сменные маркеры, которые служба будет обновлять во время выполнения со значением, определенным для запроса.  В настоящее время поддерживаемые значения токенов:
   * `{AlternativeMediaId}`, который заменяется значением StreamingLocatorId.AlternativeMediaId.
   * `{ContentKeyId}`, который заменяется значением идентификатора запрашиваемого ключа.
* `StreamingPolicyPlayReadyConfiguration.CustomLicenseAcquisitionUrlTemplate`: Шаблон для URL пользовательского сервиса, который предоставляет лицензии конечным пользователям. Это не требуется, когда вы используете медиа-сервисы Azure для выдачи лицензий.

   Шаблон поддерживает сменные маркеры, которые служба будет обновлять во время выполнения со значением, определенным для запроса. В настоящее время поддерживаемые значения токенов:  
   * `{AlternativeMediaId}`, который заменяется значением StreamingLocatorId.AlternativeMediaId.
   * `{ContentKeyId}`, который заменяется значением идентификатора запрашиваемого ключа. 
* `StreamingPolicyWidevineConfiguration.CustomLicenseAcquisitionUrlTemplate`: То же, что и предыдущий шаблон, только для Widevine. 
* `StreamingPolicyFairPlayConfiguration.CustomLicenseAcquisitionUrlTemplate`: То же, что и предыдущий шаблон, только для FairPlay.  

Пример:

```csharp
streamingPolicy.EnvelopEncryption.customKeyAcquisitionUrlTemplate = "https://mykeyserver.hostname.com/envelopekey/{AlternativeMediaId}/{ContentKeyId}";
```

`ContentKeyId`имеет значение запрашиваемого ключа. Вы можете `AlternativeMediaId` использовать, если вы хотите сопоставить запрос с сущностью на вашей стороне. Например, `AlternativeMediaId` может быть использован, чтобы помочь вам найти разрешения.

Для примеров REST, которые используют пользовательские URL-адреса приобретения лицензий/ключов, [см.](https://docs.microsoft.com/rest/api/media/streamingpolicies/create)

> [!NOTE]
> Widevine — это служба, которая предоставляется компанией Google Inc. и подпадает под условия предоставления услуг и политику конфиденциальности Google Inc.

## <a name="troubleshoot"></a>Устранение неполадок

Если вы `MPE_ENC_ENCRYPTION_NOT_SET_IN_DELIVERY_POLICY` получили ошибку, убедитесь, что вы укажете соответствующую политику потоковой передачи.

Если вы получаете `_NOT_SPECIFIED_IN_URL`ошибки, которые заканчиваются, убедитесь, что вы укажете формат шифрования в URL. Например, `…/manifest(format=m3u8-cmaf,encryption=cbcs-aapl)`. Смотрите [протоколы потоковой передачи и типы шифрования.](#streaming-protocols-and-encryption-types)

## <a name="ask-questions-give-feedback-get-updates"></a>Получение справки, отправка отзывов, получение обновлений

Прочитайте статью [сообщества Служб мультимедиа Azure](media-services-community.md), чтобы узнать, как задавать вопросы, оставлять отзывы и получать новости о Службах мультимедиа.

## <a name="next-steps"></a>Дальнейшие действия

* [Использование динамического шифрования AES-128 и службы доставки ключей](protect-with-aes128.md)
* [Защита с помощью DRM](protect-with-drm.md)
* [Дизайн многофункциональной системы защиты контента DRM с помощью контроля доступа](design-multi-drm-system-with-access-control.md)
* [Шифрование на стороне хранилища](storage-account-concept.md#storage-side-encryption)
* [Часто задаваемые вопросы](frequently-asked-questions.md)
* [Обработчик веб-токенов JSON](https://docs.microsoft.com/dotnet/framework/security/json-web-token-handler)
