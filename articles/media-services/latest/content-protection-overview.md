---
title: Защита содержимого с помощью динамического шифрования служб мультимедиа в Azure | Документация Майкрософт
description: В этой статье приводятся общие сведения о защите содержимого с помощью динамического шифрования. Он также рассказывает о протоколах потоковой передачи и типах шифрования.
services: media-services
documentationcenter: ''
author: Juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/17/2019
ms.author: juliako
ms.custom: seodec18
ms.openlocfilehash: 5d31e4a523fdedf9907e33c70638f07a08461ed1
ms.sourcegitcommit: f5075cffb60128360a9e2e0a538a29652b409af9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/18/2019
ms.locfileid: "68310304"
---
# <a name="content-protection-with-dynamic-encryption"></a>Защита содержимого с помощью динамического шифрования

Службы мультимедиа Azure позволяют защитить данные мультимедиа, покидающие ваш компьютер, на этапах их хранения, обработки и доставки, а также доставлять в режиме реального времени и по требованию содержимое, зашифрованное динамически с помощью Advanced Encryption Standard (AES-128) или трех основных систем управления цифровыми правами (DRM): Microsoft PlayReady, Google Widevine и Apple FairPlay. Они также обеспечивают службу доставки ключей AES и лицензий DRM (PlayReady, Widevine и FairPlay) авторизованным клиентам. 

В службах мультимедиа v3 ключ содержимого связан с указателем потоковой передачи (см. [Этот пример](protect-with-aes128.md)). При использовании службы доставки ключей служб мультимедиа вы можете разрешить службам мультимедиа Azure создавать ключ содержимого. Ключ содержимого следует создавать самостоятельно, если вы используете собственную службу доставки ключей или хотите реализовать сценарий высокого уровня доступности, в котором необходимо иметь один и тот же ключ содержимого в двух центрах обработки данных.

Когда поток запрашивается проигрывателем, Службы мультимедиа используют указанный ключ для динамического шифрования содержимого с помощью незащищенного ключа AES или DRM. Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей служб мультимедиа или в указанной вами службе доставки ключей. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценит политику ключа содержимого, заданную для него.

Чтобы настроить политики авторизации и аутентификации для лицензий и ключей, можно использовать REST API или клиентскую библиотеку мультимедиа.

На следующем рисунке показан рабочий процесс защиты содержимого Служб мультимедиа: 

![Защита содержимого](./media/content-protection/content-protection.svg)

&#42; *динамическое шифрование поддерживает AES-128 "незащищенный ключ", CBCS и CENC. Для дополнительных сведений см. матрицу поддержки [здесь](#streaming-protocols-and-encryption-types).*

В этой статье объясняются основные понятия и термины, необходимые для понимания процесса защиты содержимого с помощью AMS.

## <a name="main-components-of-a-content-protection-system"></a>Основные компоненты системы защиты содержимого

Чтобы успешно завершить разработку проекта "защиты содержимого" системы или приложения, необходимо полностью представить объем трудозатрат. В следующем списке представлен обзор трех частей, которые необходимо применить. 

1. Код службы мультимедиа Azure
  
   В примере [DRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM/Program.cs) показано, как реализовать систему с несколькими DRM с помощью служб мультимедиа v3 с использованием .NET. В нем также показано, как использовать службу доставки лицензий и ключей служб мультимедиа. Каждый ресурс можно зашифровать с помощью нескольких типов шифрования (AES-128, PlayReady, Widevine, FairPlay). Чтобы понять, что лучше объединять, см. раздел [Протоколы потоковой передачи и типы шифрования](#streaming-protocols-and-encryption-types).
  
   В примере показано, как выполнить следующие задачи.

   1. Создание и настройка [политик ключей содержимого](content-key-policy-concept.md). Создайте **политику ключа содержимого** , чтобы настроить способ доставки ключа содержимого (который обеспечивает безопасный доступ к вашим ресурсам) конечным клиентам.    

      * Определите авторизацию доставки лицензии, определяющую логику проверки авторизации на основании утверждений в JWT.
      * Настройте лицензии [PlayReady](playready-license-template-overview.md), [Widevine](widevine-license-template-overview.md)и/или [Fairplay](fairplay-license-overview.md) . Шаблоны позволяют настраивать права и разрешения для каждого используемого DRM.

        ```
        ContentKeyPolicyPlayReadyConfiguration playReadyConfig = ConfigurePlayReadyLicenseTemplate();
        ContentKeyPolicyWidevineConfiguration widevineConfig = ConfigureWidevineLicenseTempate();
        ContentKeyPolicyFairPlayConfiguration fairPlayConfig = ConfigureFairPlayPolicyOptions();
        ```
   2. Создайте [указатель потоковой передачи](streaming-locators-concept.md) , настроенный на потоковую передачу зашифрованного ресурса. 
  
      **Указатель потоковой передачи** должен быть связан с [политикой потоковой передачи](streaming-policy-concept.md). В этом примере мы устанавливаем Стреаминглокатор. Стреамингполицинаме в политику "Predefined_MultiDrmCencStreaming". Применяются шифрования PlayReady и Widevine, ключ доставляется клиенту воспроизведения на основе настроенных лицензий DRM. Если необходимо выполнить шифрование потока с помощью CBCS (FairPlay), используйте Predefined_MultiDrmStreaming.
      
      Указатель потоковой передачи также связан с определенной **политикой ключа содержимого** .
    
   3. Создание тестового токена.

      Метод **GetTokenAsync** показывает, как создать тестовый токен.
   4. Создание URL-адреса потоковой передачи.

      Метод **GetDASHStreamingUrlAsync** показывает, как создать URL-адрес потоковой передачи. В этом примере URL-адрес передает содержимое **DASH**.

2. Проигрыватель с использованием клиента AES или DRM. Приложение видеопроигрывателя на основе пакета SDK проигрывателя (или собственное, или браузерное) должно отвечать следующим требованиям.
   * Пакет SDK проигрывателя поддерживает необходимые клиенты DRM
   * Пакет SDK проигрывателя поддерживает требуемые протоколы потоковой передачи: Smooth, DASH и/или HLS
   * Пакет SDK проигрывателя должен иметь возможность обрабатывать передачу маркера JWT в запросе на получение лицензии
  
     Проигрыватель можно создать с помощью [API проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/). [API ProtectionInfo Проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/) позволяет указать, какие технологии DRM следует использовать на разных платформах DRM.

     Для тестирования зашифрованного содержимого AES или CENC (Widevine и (или) PlayReady) можно использовать [Проигрыватель мультимедиа Azure](https://aka.ms/azuremediaplayer). Обязательно щелкните "Дополнительные параметры" и проверьте параметры шифрования.

     Если необходимо протестировать зашифрованное содержимое FairPlay, используйте [этот тестовый проигрыватель](https://aka.ms/amtest). Проигрыватель поддерживает DRM Widevine, PlayReady и FairPlay, а также шифрование незащищенного ключа AES-128. 
    
     Необходимо выбрать правильный браузер для тестирования различных систем управления цифровыми правами: Chrome/Opera/Firefox для Widevine, Microsoft Edge и IE 11 для PlayReady, Safari в macOS для FairPlay.

3. Служба токенов безопасности (STS), которая выдает JSON Web Token (JWT) в качестве маркера доступа для доступа к серверному ресурсу. Как серверный ресурс можно использовать службу доставки лицензий AMS. Служба токенов безопасности должна определять следующие данные.

   * Издатель и аудитория (или область)
   * Утверждения, которые зависят от бизнес-требований защиты содержимого
   * Симметричные или асимметричные проверки для проверки подписи
   * Поддержка смены ключей (при необходимости)

     Вы можете использовать [это средство службы токенов безопасности](https://openidconnectweb.azurewebsites.net/DRMTool/Jwt) для тестирования службы токенов безопасности, которое поддерживает все 3 типа ключей проверки: симметричный, асимметричный и Azure AD со сменой ключей. 

> [!NOTE]
> Настоятельно рекомендуется сосредоточиться и полностью проверить каждый элемент (описанный выше), прежде чем перейти к следующей части. Чтобы протестировать систему "защиты содержимого", используйте средства, указанные в списке выше.  

## <a name="streaming-protocols-and-encryption-types"></a>Протоколы потоковой передачи и типы шифрования

Службы мультимедиа Azure доставляют содержимое, динамически зашифрованное с помощью незащищенного ключа AES или шифрования DRM путем использования PlayReady, Widevine или FairPlay. Сейчас поддерживается шифрование в форматах HTTP Live Streaming (HLS), MPEG DASH и Smooth Streaming. Каждый протокол поддерживает следующие методы шифрования.

### <a name="hls"></a>HLS

Протокол HLS поддерживает следующие форматы контейнеров и схемы шифрования.

|Формат контейнера|Схема шифрования|Пример URL-адреса|
|---|---|---|
|Все|AES|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-aapl,encryption=cbc)`|
|MPG2-TS |CBCS (FairPlay) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-aapl,encryption=cbcs-aapl)`|
|CMAF(fmp4) |CBCS (FairPlay) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-cmaf,encryption=cbcs-aapl)`|
|MPG2-TS |CENC (PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-aapl,encryption=cenc)`|
|CMAF(fmp4) |CENC (PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=m3u8-cmaf,encryption=cenc)`|

HLS/КМАФ + FairPlay (включая HEVC/H. 265) поддерживается на следующих устройствах:

* iOS версии 11 или более поздняя версия 
* iPhone 8 или более поздней версии
* MacOS High Сьерра с процессором Intel 7 для поколения

### <a name="mpeg-dash"></a>MPEG-DASH

Протокол MPEG-ТИРЕ поддерживает следующие форматы контейнеров и схемы шифрования.

|Формат контейнера|Схема шифрования|Примеры URL-адресов
|---|---|---|
|Все|AES|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=mpd-time-csf,encryption=cbc)`|
|CSF(fmp4) |CENC (Widevine + PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=mpd-time-csf,encryption=cenc)`|
|CMAF(fmp4)|CENC (Widevine + PlayReady)|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(format=mpd-time-cmaf,encryption=cenc)`|

### <a name="smooth-streaming"></a>Smooth Streaming

Протокол Smooth Streaming поддерживает следующие форматы контейнеров и схемы шифрования.

|Протокол|Формат контейнера|Схема шифрования|
|---|---|---|
|fMP4|AES|`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(encryption=cbc)`|
|fMP4 | CENC (PlayReady) |`https://amsv3account-usw22.streaming.media.azure.net/00000000-0000-0000-0000-000000000000/ignite.ism/manifest(encryption=cenc)`|

### <a name="browsers"></a>Браузеры

Общие браузеры поддерживают следующие клиенты DRM:

|Browser|Шифрование|
|---|---|
|Chrome|Widevine|
|Microsoft ребро, IE 11|PlayReady|
|Firefox|Widevine|
|Opera|Widevine|
|Safari|FairPlay|

## <a name="control-content-access"></a>Доступ к содержимому элемента управления

Вы можете контролировать пользователей, имеющих доступ к содержимому, настроив политику ключей содержимого. Службы мультимедиа поддерживают несколько способов авторизации пользователей, которые запрашивают ключи. Потребуется настроить политику ключей содержимого. Прежде чем ключ будет доставлен клиенту (проигрыватель), он должен быть приведен в соответствие с политикой. Политика ключей содержимого может иметь ограничения по **открытию** или по **маркеру**. 

При использовании политики ключей содержимого с ограничением по маркеру ключ содержимого будет отправлен только тому клиенту, который предоставит в запросе ключа или лицензии действующий токен JSON Web Token (JWT) или простой веб-токен (SWT). Этот токен должен быть выдан службой токенов безопасности (STS). Вы можете использовать Azure Active Directory в качестве STS или развернуть пользовательскую службу токенов безопасности. Чтобы создать маркер, подписанный указанным ключом, и получить утверждения, указанные в конфигурации ограничения по маркерам, должна быть настроена служба маркеров безопасности. Служба доставки ключей Служб мультимедиа возвращает клиенту запрошенный ключ (или лицензию), если маркер является допустимым, а его утверждения соответствуют утверждениям, настроенным для ключа (или лицензии).

При настройке политики ограничения по маркеру необходимо задать такие параметры, как основной ключ проверки, издатель и аудитория. Основной ключ проверки содержит ключ, которым был подписан маркер. Издателем является служба токенов безопасности, которая выдает токен. Аудитория, иногда называемая областью, описывает назначение маркера или ресурс, доступ к которому обеспечивает маркер. Служба доставки ключей служб мультимедиа проверяет, соответствуют ли эти значения в маркере значениям в шаблоне.

Клиенты часто используют пользовательскую STS для включения настраиваемых утверждений в маркер для выбора между разными Контенткэйполициоптионс с различными параметрами лицензии DRM (лицензия подписки и лицензия на аренду) или для включения утверждения, представляющего ключ содержимого. Идентификатор ключа, к которому маркер предоставляет доступ.

### <a name="token-replay-prevention"></a>Предотвращение воспроизведения токенов

Функция *предотвращения воспроизведения маркеров* позволяет клиентам служб мультимедиа устанавливать ограничения на то, сколько раз один и тот же маркер можно использовать для запроса ключа или лицензии. Клиент может добавить утверждение типа `urn:microsoft:azure:mediaservices:maxuses` в маркер, где значение — это количество раз, когда маркер может быть использован для получения лицензии или ключа. Все последующие запросы с одинаковым токеном к доставке ключей будут возвращать несанкционированный ответ. См. статью как добавить утверждение в [Пример DRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM/Program.cs#L601).
 
#### <a name="considerations"></a>Рекомендации

* Клиенты должны иметь контроль над созданием маркеров. Утверждение необходимо поместить в сам маркер.
* При использовании этой функции запросы с маркерами, срок действия которых превышает один час с момента получения запроса, отклоняются с несанкционированным ответом.
* Маркеры уникально идентифицируются их сигнатурой. Любое изменение полезных данных (например, обновление до срока действия или утверждения) приводит к изменению подписи маркера и будет считаться новым маркером, который не был обнаружен до момента доставки ключа.
* Воспроизведение завершается ошибкой, если маркер превысил `maxuses` значение, установленное клиентом.
* Эта функция может использоваться для всего существующего защищенного содержимого (необходимо изменить только выданный маркер).
* Эта функция работает как с JWT, так и с SWT.

## <a name="custom-key-and-license-acquisition-url"></a>Пользовательский ключ и URL-адрес для получения лицензии

Используйте следующие шаблоны, если нужно указать другую ключ и службу доставки лицензий (не службы мультимедиа). Два заменяемых поля в шаблонах позволяют совместно использовать политику потоковой передачи во многих ресурсах вместо создания политики потоковой передачи для каждого ресурса. 

* EnvelopeEncryption. Кустомкэйаккуиситионурлтемплате — шаблон URL-адреса настраиваемой службы, предоставляющей ключи для игроков конечным пользователям. Не требуется при использовании служб мультимедиа Azure для выдачи ключей. Шаблон поддерживает заменяемые токены, которые служба будет обновлять во время выполнения, со значением, характерным для запроса.  В настоящее время поддерживаются значения маркера {Алтернативемедиаид}, которые заменяются значением Стреаминглокаторид. Алтернативемедиаид и {Контенткэйид}, которое заменяется значением идентификатора запрашиваемого ключа.
* Стреамингполициплайреадиконфигуратион. Кустомлиценсеаккуиситионурлтемплате — шаблон URL-адреса настраиваемой службы, предоставляющей лицензии конечным пользователям. Не требуется при использовании служб мультимедиа Azure для выдачи лицензий. Шаблон поддерживает заменяемые токены, которые служба будет обновлять во время выполнения, со значением, характерным для запроса. В настоящее время поддерживаются значения маркера {Алтернативемедиаид}, которые заменяются значением Стреаминглокаторид. Алтернативемедиаид и {Контенткэйид}, которое заменяется значением идентификатора запрашиваемого ключа. 
* Стреамингполицивидевинеконфигуратион. Кустомлиценсеаккуиситионурлтемплате — то же, что и выше, только для Widevine. 
* Стреамингполицифаирплайконфигуратион. Кустомлиценсеаккуиситионурлтемплате — то же, что и выше, только для FairPlay.  

Пример:

```csharp
streamingPolicy.EnvelopEncryption.customKeyAcquisitionUrlTemplate = "https://mykeyserver.hostname.com/envelopekey/{AlternativeMediaId}/{ContentKeyId}";
```

Объект `ContentKeyId` имеет значение запрашиваемого ключа, и его можно использовать `AlternativeMediaId` , если необходимо связать запрос с сущностью на стороне. Например, `AlternativeMediaId` можно использовать для поиска разрешений.

Примеры использования пользовательских ключей и URL-адресов для получения лицензий см. в разделе [политики потоковой передачи — создание](https://docs.microsoft.com/rest/api/media/streamingpolicies/create)

## <a name="troubleshoot"></a>Устранение неполадок

Если возникает `MPE_ENC_ENCRYPTION_NOT_SET_IN_DELIVERY_POLICY` ошибка, убедитесь, что указана соответствующая политика потоковой передачи.

При возникновении ошибок, которые заканчиваются `_NOT_SPECIFIED_IN_URL`на, убедитесь, что в URL-адресе указан формат шифрования. Например, `…/manifest(format=m3u8-cmaf,encryption=cbcs-aapl)`. См. раздел [протоколы потоковой передачи и типы шифрования](#streaming-protocols-and-encryption-types).

## <a name="ask-questions-give-feedback-get-updates"></a>Получение справки, отправка отзывов, получение обновлений

Прочитайте статью [сообщества Служб мультимедиа Azure](media-services-community.md), чтобы узнать, как задавать вопросы, оставлять отзывы и получать новости о Службах мультимедиа.

## <a name="next-steps"></a>Следующие шаги

* [Использование динамического шифрования AES-128 и службы доставки ключей](protect-with-aes128.md)
* [Защита с помощью DRM](protect-with-drm.md)
* [Разработка системы защиты содержимого с несколькими DRM с помощью контроля доступа](design-multi-drm-system-with-access-control.md)
* [Шифрование на стороне хранилища](storage-account-concept.md#storage-side-encryption)
* [Часто задаваемые вопросы](frequently-asked-questions.md)

