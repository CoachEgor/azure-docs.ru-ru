---
title: Кодирование высокой доступности медиаслужб Azure Media
description: Узнайте, как выйти из учетной записи вторичной медиаслужбы, если происходит сбой или сбой в работе регионального центра обработки данных.
services: media-services
documentationcenter: ''
author: juliako
manager: femila
editor: ''
ms.service: media-services
ms.subservice: ''
ms.workload: ''
ms.topic: article
ms.custom: ''
ms.date: 02/24/2020
ms.author: juliako
ms.openlocfilehash: afaa7545fbcbab016249e73a2247817310c5cdfc
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78934200"
---
# <a name="media-services-high-availability-encoding"></a>Медиа-услуги высокой доступности кодирования 

Служба кодирования мультимедиа Azure Media Service является региональной платформой обработки пакетов и в настоящее время не предназначена для высокой доступности в пределах одного региона. Служба кодирования в настоящее время не обеспечивает мгновенного сбоя службы при сбое в работе регионального центра обработки данных или сбоя базовых компонентов или зависимых служб (таких как хранение, S'L). В этой статье объясняется, как развертывать медиа-службы для поддержания архитектуры высокой доступности с отказом и обеспечения оптимальной доступности для ваших приложений.

Следуя рекомендациям и рекомендациям, описанным в статье, вы снизите риск сбоев кодирования, задержек и сведете к минимуму время восстановления, если сбой происходит в одном регионе.

## <a name="how-to-build-a-cross-regional-encoding-system"></a>Как построить межрегиональную систему кодирования

* [Создайте](create-account-cli-how-to.md) две (или более) учетные записи медиаслужб Ызуротации.

    Эти два счета должны быть в разных регионах. Для получения дополнительной [regions in which the Azure Media Services service is deployed](https://azure.microsoft.com/global-infrastructure/services/?products=media-services)информации см.
* Загрузите свои носители в тот же регион, из которого вы планируете представить задание. Для получения дополнительной информации о том, как начать кодирование, [Create a job input from a local file](job-input-from-local-file-how-to.md)см. [Create a job input from an HTTPS URL](job-input-from-http-how-to.md)

    Если вам необходимо повторно отправить [задание](transforms-jobs-concept.md) в другой регион, можно использовать JobInputHttp или использовать [Copy-Blob](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob) для копирования данных из контейнера исходного актива в контейнер активов в альтернативном регионе.
* Подпишитесь на сообщения JobStateChange в каждой учетной записи через Azure Event Grid. Дополнительные сведения см. в разделе:

    * [Образец аудиоаналитики,](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/master/AudioAnalytics/AudioAnalyzer) который показывает, как контролировать работу с Azure Event Grid, включая добавление запаса в случае задержки сообщений Azure Event Grid по некоторым причинам.
    * [Схемы службы "Сетка событий Azure" для событий Служб мультимедиа](media-services-event-schemas.md)
    * [Зарегистрируйтесь для участия в мероприятиях через портал Azure или CLI](reacting-to-media-services-events.md) (вы также можете сделать это с помощью EventGrid Management SDK)
    * [Microsoft.Azure.EventGrid SDK](https://www.nuget.org/packages/Microsoft.Azure.EventGrid/) (которая поддерживает события медиа-служб нативно).

    Вы также можете использовать события Event Grid через функции Azure.
* При создании [задания:](transforms-jobs-concept.md)

    * Случайно выберите учетную запись из списка используемых в настоящее время учетных записей (этот список обычно содержит обе учетные записи, но при обнаружении проблем может содержаться только одна учетная запись). Если список пуст, поднимите оповещение, чтобы оператор мог исследовать.
    * Общее руководство заключается в том, что вам нужно одно [медиа-зарезервированное устройство](media-reserved-units-cli-how-to.md) на [JobOutput](https://docs.microsoft.com/rest/api/media/jobs/create#joboutputasset) (если вы не используете [VideoAnalyzerPreset,](analyzing-video-audio-files-concept.md) где рекомендуется 3 медиа-зарезервированных единиц на JobOutput).
    * Получите количество зарезервированных средств массовой информации (MRUs) для выбранного счета. Если количество **зарезервированных единиц мультимедиа** уже не составляет максимальное значение, добавьте количество MrUs, необходимых заданиям, и обновите службу. Если уровень представления вакансии высок, и вы часто задаваете запрос мРА, чтобы найти вас на максимуме, используйте распределенный кэш для значения с разумным тайм-аутом.
    * Следите за количеством рабочих мест на борту.

* Когда обработчик JobStateChange получает уведомление о том, что задание достигло запланированного состояния, запишите время, когда оно входит в состояние расписания, и используемый регион/счет.
* Когда обработчик JobStateChange получает уведомление о том, что задание достигло состояния обработки, отметьте запись задания как обработку.
* Когда обработчик JobStateChange получает уведомление о том, что задание достигло состояния готового/ошибочного/отмененного состояния, пометьте запись для задания как окончательную и зафиксировав количество рабочих мест на борту. Получите количество зарезервированных средств массовой информации для выбранной учетной записи и сравните текущий номер MRU с числом рабочих мест на борту. Если количество вашего полета меньше, чем количество MRU, а затем утилизьте его и обновите услугу.
* Иметь отдельный процесс, который периодически смотрит на ваши записи о заданиях
    
    * Если у вас есть задания в запланированном состоянии, которые не перешли в состояние обработки в течение разумного периода времени для данного региона, удалите этот регион из списка используемых в настоящее время учетных записей.  В зависимости от ваших бизнес-требований, вы можете принять решение об отмене этих заданий сразу же и повторно представить их в другой регион. Или, вы могли бы дать им еще немного времени, чтобы перейти к следующему состоянию.
    * В зависимости от количества зарезервированных средств массовой информации, настроенных на учетную запись, и скорости представления, также могут быть задания в состоянии очереди, которые система еще не выбрала для обработки.  Если список заданий в состоянии очереди в регионе превышает допустимый предел, эти задания могут быть отменены и отправлены в другой регион.  Однако это может быть симптомом недостаточного количества зарезервированных единиц мультимедиа, настроенных на учетную запись для текущей нагрузки.  При необходимости можно запросить более высокую квоту зарезервированного блока мультимедиа через поддержку Azure.
    * Если регион был удален из списка учетных записей, следите за его восстановлением, прежде чем добавлять его обратно в список.  Региональное состояние здоровья может контролироваться через существующие рабочие места в регионе (если они не были отменены и повторно), добавив учетную запись обратно в список через некоторое время, и операторами мониторинга Azure сообщений о перебоях, которые могут повлиять на Медиа-службы Azure.
    
Если вы обнаружите, что количество MRU много обмолота вверх и вниз, переместите логику декретирования в периодическую задачу. Поите, чтобы логика отправки предварительной работы сравнила количество в полете с текущим количеством MRU, чтобы увидеть, нужно ли обновлять МРУ.

## <a name="next-steps"></a>Дальнейшие действия

* [Создание потокового видео по запросу кросс-региона](media-services-high-availability-streaming.md)
* Ознакомьтесь с [образцами кода](https://docs.microsoft.com/samples/browse/?products=azure-media-services)
