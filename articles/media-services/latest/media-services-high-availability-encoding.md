---
title: Кодировка высокой доступности служб мультимедиа Azure
description: Узнайте, как выполнить отработку отказа для дополнительной учетной записи служб мультимедиа при сбое или неудачном выполнении регионального центра обработки данных.
services: media-services
documentationcenter: ''
author: juliako
manager: femila
editor: ''
ms.service: media-services
ms.subservice: ''
ms.workload: ''
ms.topic: article
ms.custom: ''
ms.date: 02/24/2020
ms.author: juliako
ms.openlocfilehash: f5b02376111a3deba33cd5688330018bd7c370d8
ms.sourcegitcommit: 668b3480cb637c53534642adcee95d687578769a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/07/2020
ms.locfileid: "78899221"
---
# <a name="media-services-high-availability-encoding"></a>Кодировка высокой доступности служб мультимедиа 

Служба кодирования служб мультимедиа Azure — это региональная платформа пакетной обработки, которая в настоящее время не предназначена для обеспечения высокого уровня доступности в пределах одного региона. В настоящее время служба кодирования не обеспечивает мгновенную отработку отказа службы, если имеется Региональный центр обработки данных или сбой базового компонента или зависимых служб (таких как хранилище, SQL). В этой статье объясняется, как развертывать службы мультимедиа для поддержки архитектуры с высоким уровнем доступности с отработкой отказа и обеспечения оптимальной доступности приложений.

Следуя рекомендациям и рекомендациям, описанным в этой статье, вы снизите риск ошибок кодирования, задержек и сократите время восстановления в случае сбоя в одном регионе.

## <a name="how-to-build-a-cross-regional-encoding-system"></a>Создание системы кодирования в разных регионах

* [Создайте](create-account-cli-how-to.md) две (или более) учетные записи служб мультимедиа Azure.

    Две учетные записи должны находиться в разных регионах. Дополнительные сведения см. [в разделе регионы, в которых развертывается служба служб мультимедиа Azure](https://azure.microsoft.com/global-infrastructure/services/?products=media-services).
* Отправьте носитель в тот же регион, из которого вы планируете отправить задание. Дополнительные сведения о том, как начать кодирование, см. в разделе [Создание входных данных задания с помощью URL-адреса HTTPS](job-input-from-http-how-to.md) или [Создание входных данных задания из локального файла](job-input-from-local-file-how-to.md).

    Если вам нужно повторно отправить [Задание](transforms-jobs-concept.md) в другой регион, можно использовать Жобинпусттп или [скопировать-BLOB](https://docs.microsoft.com/rest/api/storageservices/Copy-Blob) , чтобы скопировать данные из контейнера исходного ресурса в контейнер ресурса в альтернативном регионе.
* Подпишитесь на сообщения Жобстатечанже в каждой учетной записи с помощью службы "Сетка событий Azure". Дополнительные сведения см. в разделе:

    * [Образец "Audio Analytics](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/master/AudioAnalytics/AudioAnalyzer) ", в котором показано, как отслеживать задание с помощью службы "Сетка событий Azure", включая добавление резервной стратегии в случае задержки сообщений службы "Сетка событий Azure" по какой-либо причине.
    * [Схемы службы "Сетка событий Azure" для событий служб мультимедиа](media-services-event-schemas.md)
    * [Регистрация событий с помощью портал Azure или интерфейса командной строки](reacting-to-media-services-events.md) (это также можно сделать с помощью пакета SDK для управления EventGrid).
    * [Пакет SDK Microsoft. Azure. EventGrid](https://www.nuget.org/packages/Microsoft.Azure.EventGrid/) (который поддерживает события служб мультимедиа изначально).

    Вы также можете использовать события службы "Сетка событий" с помощью функций Azure.
*    При создании [задания](transforms-jobs-concept.md):
    
    * Случайный выбор учетной записи из списка используемых в данный момент учетных записей (этот список обычно содержит обе учетные записи, но при обнаружении проблем может содержать только одну учетную запись). Если список пуст, создайте предупреждение, чтобы оператор мог исследовать его.
    * Общие рекомендации — это одна [зарезервированная единица мультимедиа](media-reserved-units-cli-how-to.md) на [жобаутпут](https://docs.microsoft.com/rest/api/media/jobs/create#joboutputasset) (если не используется [видеоанализерпресет](analyzing-video-audio-files-concept.md) , где рекомендуется 3 зарезервированных единиц мультимедиа на жобаутпут).
    * Получение числа зарезервированных единиц мультимедиа (Мрус) для выбранной учетной записи. Если текущее количество **зарезервированных единиц мультимедиа** еще не равно максимальному значению, добавьте номер мрус, необходимый для задания, и обновите службу. Если скорость отправки задания высока и вы часто запрашиваете Мрус, чтобы найти максимальное значение, используйте распределенный кэш для значения с разумным временем ожидания.
    * Сосчитайте количество заданий порядковых.

* Когда обработчик Жобстатечанже получает уведомление о том, что задание достигло запланированного состояния, запишите время, в которое он входит в состояние расписания, а также используемую область или учетную запись.
* Когда обработчик Жобстатечанже получает уведомление о том, что задание достигло состояния обработки, отметьте запись для задания как обработку.
* Когда обработчик Жобстатечанже получает уведомление о том, что задание достиго завершенного, ошибочного или отмененного состояния, отметьте запись для задания как окончательную и уменьшите число заданий порядковых. Получите количество зарезервированных единиц мультимедиа для выбранной учетной записи и сравните текущий номер MRU с числом заданий порядковых. Если число порядковых меньше числа MRU, уменьшите его и обновите службу.
* Наличие отдельного процесса, который периодически проверяет записи заданий
    
    * Если у вас есть задания в запланированном состоянии, которые еще не были расширены до состояния обработки в течение разумного периода времени для данного региона, удалите этот регион из списка используемых в данный момент учетных записей.  В зависимости от бизнес-требований вы можете отменить эти задания прямо сейчас и отправить их в другой регион. Вы также можете предоставить им дополнительное время, чтобы перейти к следующему состоянию.
    * В зависимости от количества зарезервированных единиц мультимедиа, настроенных в учетной записи, и скорости отправки, в состоянии очереди также могут быть задания, которые система еще не отбирала для обработки.  Если список заданий в состоянии "в очереди" выходит за пределы допустимого предела в регионе, эти задания можно отменить и отправить в другой регион.  Однако это может быть симптомом отсутствия достаточного количества зарезервированных единиц мультимедиа, настроенных в учетной записи для текущей нагрузки.  При необходимости вы можете запросить более высокую квоту на зарезервированную единицу мультимедиа через службу поддержки Azure.
    * Если регион был удален из списка учетных записей, прежде чем добавлять его в список, отслеживайте его для восстановления.  Региональную работоспособность можно отслеживать с помощью существующих заданий в регионе (если они не были отменены и не отправлены повторно), добавив учетную запись обратно в список по истечении определенного периода времени, а операторы отслеживают взаимодействие с Azure о сбоях, которые могут затронуть Службы мультимедиа Azure.
    
Если вы обнаружите, что число MRU пробуксовка вверх и вниз, переместите логику декремента к периодической задаче. Чтобы проверить, требуется ли обновление Мрус, логика отправки перед заданием сравнивает число порядковых с текущим числом MRU.

## <a name="next-steps"></a>Следующие шаги

* [Создание потоковой передачи видео по запросу](media-services-high-availability-streaming.md)
* Ознакомьтесь с [примерами кода](https://docs.microsoft.com/samples/browse/?products=azure-media-services)
