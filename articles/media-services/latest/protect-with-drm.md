---
title: Служба шифрования и доставки лицензий Azure Media Services DRM
titleSuffix: Azure Media Services
description: Узнайте, как использовать динамическое шифрование DRM и службу доставки лицензий для доставки потоков, зашифрованных с лицензиями Microsoft PlayReady, Google Widevine или Apple FairPlay.
services: media-services
documentationcenter: ''
author: juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 05/25/2019
ms.author: juliako
ms.custom: seodec18
ms.openlocfilehash: 14ba5f270138db22a76fd697b264046e22577427
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79086729"
---
# <a name="tutorial-use-drm-dynamic-encryption-and-license-delivery-service"></a>Учебник: Используйте услуги динамического шифрования DRM и службы доставки лицензий

> [!NOTE]
> Несмотря на то что в этом учебнике используются примеры для [пакета SDK для .NET](https://docs.microsoft.com/dotnet/api/microsoft.azure.management.media.models.liveevent?view=azure-dotnet), общие шаги одинаковы для [REST API](https://docs.microsoft.com/rest/api/media/liveevents), [CLI](https://docs.microsoft.com/cli/azure/ams/live-event?view=azure-cli-latest) или других поддерживаемых [пакетов SDK](media-services-apis-overview.md#sdks).

Службы мультимедиа Azure можно использовать для доставки потоков, которые были зашифрованы с помощью лицензий Microsoft PlayReady, Google Widevine или Apple FairPlay. Для углубленного объяснения [см. защиту контента с динамическим шифрованием.](content-protection-overview.md)

Media Services также предоставляет услуги по предоставлению лицензий PlayReady, Widevine и FairPlay DRM. Когда пользователь запрашивает контент, защищенный DRM, приложение игрока запрашивает лицензию у службы лицензирования Media Services. Если приложение игрока авторизовано, служба лицензирования Media Services выдает игроку лицензию. В лицензии содержится ключ расшифровки, который может использоваться клиентским проигрывателем для расшифровки и потоковой передачи содержимого.

В этой статье используется пример [шифрования с использованием DRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM).

Выполнение описанного здесь примера позволит получить следующий результат.

![AMS с защищенным DRM видео в Мультиплеплеплее Azure](./media/protect-with-drm/ams_player.png)

В этом учебнике описаны следующие процедуры.

> [!div class="checklist"]
> * Создайте кодирование Transform.
> * Установка ключа подписывания, используемого для проверки маркера безопасности.
> * Установите требования к ключевой политике содержимого.
> * Создайте StreamingLocator с указанной политикой потоковой передачи.
> * Создайте URL-адрес, используемый для воспроизведения файла.

[!INCLUDE [quickstarts-free-trial-note](../../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>Предварительные требования

Ниже перечислены необходимые условия для выполнения действий, описанных в этом руководстве:

* Просмотрите статью [Обзор системы защиты содержимого](content-protection-overview.md).
* Просмотрите [систему защиты мульти-DRM-контента Design с контролем доступа.](design-multi-drm-system-with-access-control.md)
* Установите Visual Studio Code или Visual Studio.
* Создайте учетную запись Служб мультимедиа Azure, как описано в [этом руководстве](create-account-cli-quickstart.md).
* Получите учетные данные, необходимые для использования API служб мультимедиа. Дополнительные сведения см. в разделе [Доступ к API Служб мультимедиа Azure с помощью Azure CLI](access-api-cli-how-to.md)
* Установите соответствующие значения в файле конфигурации приложения (appsettings.json).

## <a name="download-code"></a>Скачать код

Клонируйте репозиторий GitHub, содержащий полный пример .NET, который был рассмотрен в этой статье, на компьютер с помощью следующей команды.

 ```bash
 git clone https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials.git
 ```
 
Образец "Шифровать с DRM" находится в папке [EncryptWithDRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM).

> [!NOTE]
> Образец создает уникальные ресурсы каждый раз, когда вы запустите приложение. Как правило, вы повторно используете существующие ресурсы, такие как преобразования и политики (если существующий ресурс имеет необходимые конфигурации).

## <a name="start-using-media-services-apis-with-net-sdk"></a>Начало использования API Служб мультимедиа с пакетом SDK для .NET

Чтобы начать использовать AI медиасервисов с помощью .NET, создайте объект **AzureMediaServicesClient.** Чтобы создать объект, введите учетные данные, необходимые клиенту для подключения к Azure с помощью Azure AD. В коде, клонированном в начале статьи, функция **GetCredentialsAsync** создает объект ServiceClientCredentials с использованием учетных данных, предоставленных в локальном файле конфигурации.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CreateMediaServicesClient)]

## <a name="create-an-output-asset"></a>Создание выходного ресурса  

Выходной [ресурс](assets-concept.md) сохраняет результаты задания кодирования.  

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CreateOutputAsset)]

## <a name="get-or-create-an-encoding-transform"></a>Получение или создание преобразования кодировки

При создании нового экземпляра [преобразования](transforms-jobs-concept.md) необходимо указать, что требуется создать в качестве выходных данных. Требуемым параметром `transformOutput` является объект, как показано в приведенном ниже коде. Каждый объект TransformOutput содержит **предустановку** (Preset). Предустановка описывает пошаговые инструкции для операций обработки видео и звука, которые будут использоваться для создания нужного объекта TransformOutput. Пример, описанный в этой статье, использует встроенную предустановку, называемую **AdaptiveStreaming**. Preset кодирует входное видео в автогенерируемую битратную лестницу (пары битратного разрешения) на основе разрешения ввода и битра, а также производит файлы ISO MP4 с видео H.264 и аудио AAC, соответствующие каждой паре битратного разрешения. 

Перед созданием нового **преобразования** сначала проверьте, существует ли оно, с помощью метода **Get**, как показано в следующем коде.  В Службах мультимедиа версии 3 методы **Get**, отправленные к сущностям, возвращают значение **NULL**, если сущность не существует (проверка по имени без учета регистра).

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#EnsureTransformExists)]

## <a name="submit-job"></a>Отправка задания

Как было указано выше, объект **преобразования** является набором инструкций, а [задание](transforms-jobs-concept.md) — фактическим запросом к Службам мультимедиа для применения этого **преобразования** к данному видео и аудио. **Задание** указывает такую информацию, как расположение входного и выходного видео.

В этом учебнике мы создаем входную работу на основе файла, который попадает непосредственно из [URL источника HTTPs.](job-input-from-http-how-to.md)

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#SubmitJob)]

## <a name="wait-for-the-job-to-complete"></a>Ожидание завершения задания

Запуск задания занимает некоторое время. Поэтому вам пригодится уведомление. В примере кода ниже показано, как опрашивать службу о состоянии **задания**. Опрос не рекомендуется для приложений рабочей среды из-за потенциальной задержки. Его можно регулировать при чрезмерном использовании в учетной записи. Вместо этого разработчики должны использовать службу "Сетка событий". Дополнительные сведения см. в статье [Route Azure Media Services events to a custom web endpoint using CLI](job-state-events-cli-how-to.md) (Маршрутизация событий Служб мультимедиа в пользовательскую конечную точку с помощью CLI).

**Задание** обычно проходит через такие состояния: **Запланировано**, **В очереди**, **Обработка**, **Завершено** (конечное состояние). Если в задании обнаружена ошибка, вы получите состояние **Ошибка**. Если задание находится в процессе отмены, вы получите состояние **Выполнение отмены** и **Отменено** по завершении.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#WaitForJobToFinish)]

## <a name="create-a-content-key-policy"></a>Создание политики ключей содержимого

Ключ содержимого обеспечивает безопасность доступа к ресурсам. При шифровании содержимого DRM необходимо создать [политику ключей содержимого.](content-key-policy-concept.md) Политика настраивает способ доставки ключа содержимого конечным клиентам. Ключ содержимого связан с потоковым локатором. Службы мультимедиа также включают в себя службу доставки ключей, которая доставляет ключи шифрования и лицензии авторизованным пользователям.

Необходимо установить требования (ограничения) в **политике ключов содержимого,** которые должны быть выполнены для доставки ключей с указанной конфигурацией. Для этого примера будут установлены следующие конфигурации и требования.

* Параметр Configuration

    Лицензии [PlayReady](playready-license-template-overview.md) и [Widevine](widevine-license-template-overview.md) являются настраиваемыми, что позволяет доставлять их с помощью службы доставки лицензий для служб мультимедиа. Несмотря на то, что это приложение не настраивает лицензию [FairPlay,](fairplay-license-overview.md) оно содержит метод, который можно использовать для настройки FairPlay. В качестве еще одного варианта можно добавить конфигурацию FairPlay.

* Ограничение

    Приложение устанавливает в политике ограничение типа маркеров JSON Web Token (JWT).

Когда поток запрашивается проигрывателем, службы мультимедиа используют указанный ключ для динамического шифрования содержимого. Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценит политику ключа содержимого, заданную для него.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#GetOrCreateContentKeyPolicy)]

## <a name="create-a-streaming-locator"></a>Создание указателя потоковой передачи

После выполнения кодирования и установки политики ключа содержимого следующий шаг — это сделать видео на выходном ресурсе доступным для воспроизведения клиентами. Вы делаете видео доступным в два этапа:

1. Создайте [потоковое locator](streaming-locators-concept.md).
2. Создайте URL-адрес потоковой передачи, который смогут использовать клиенты.

Процесс создания **потокового Локатора** называется публикацией. По умолчанию **потоковый локатор** действителен сразу после выполнения вызовов API. Она длится до тех пор, пока не будет удалена, если только вы не наверстируете дополнительное время начала и окончания.

При создании **потокового локатора**необходимо указать нужный. `StreamingPolicyName` В этом учебнике мы используем одну из предопределенных политик потоковой передачи, которая рассказывает медиаслужбам Azure, как публиковать контент для потоковой передачи. В этом примере для StreamingLocator.StreamingPolicyName задается значение Predefined_MultiDrmCencStreaming. Применяются шифрования PlayReady и Widevine, а ключ доставляется клиенту воспроизведения на основе настроенных лицензий DRM. Если необходимо выполнить шифрование потока с помощью CBCS (FairPlay), используйте Predefined_MultiDrmStreaming.

> [!IMPORTANT]
> При использовании пользовательской [политики потоковой передачи](streaming-policy-concept.md) следует разработать ограниченный набор таких политик для учетной записи Служб мультимедиа и повторно использовать их для компонентов StreamingLocator каждый раз, когда требуются те же параметры шифрования и протоколы. У вашей учетной записи Служб мультимедиа есть квота на количество записей StreamingPolicy. Вы не должны создавать новую StreamingPolicy для каждого StreamingLocator.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CreateStreamingLocator)]

## <a name="get-a-test-token"></a>Получение маркера тестирования

В этом руководстве указывается, что политика ключа содержимого включает ограничение по маркеру. При ограничении с помощью маркера к политике должен прилагаться маркер, выданный службой маркеров безопасности (STS). Медиа-сервисы поддерживают токены в форматах [JWT,](https://msdn.microsoft.com/library/gg185950.aspx#BKMK_3) и это то, что мы настраиваем в выборке.

ContentKeyIdentifierClaim используется в ContentKeyPolicy. Это значит, что маркер, предоставленный службе доставки ключей, должен иметь идентификатор ContentKey. В примере мы не указывать ключ содержимого при создании потокового Locator, система создает случайный для нас. Для создания маркера теста мы должны получить ContentKeyId, чтобы поместить в заявку ContentKeyIdentifierclaim.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#GetToken)]

## <a name="build-a-streaming-url"></a>Создание потокового URL-адреса

После создания [StreamingLocator](https://docs.microsoft.com/rest/api/media/streaminglocators) вы можете получить URL-адреса потоковой передачи. Чтобы создать URL-адрес, необходимо совместить имя хоста [StreamingEndpoint](https://docs.microsoft.com/rest/api/media/streamingendpoints) и путь **потокового локатора.** В этом примере используется **конечная точка потоковой передачи** *по умолчанию.* При первом создании учетной записи Media Service эта **конечная точка потоковой передачи** *по умолчанию* будет находиться в остановленном состоянии, поэтому необходимо вызвать **Start.**

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#GetMPEGStreamingUrl)]

При запуске приложения вы видите следующий экран:

![Защита с помощью DRM](./media/protect-with-drm/playready_encrypted_url.png)

Чтобы запустить демонстрационную страницу проигрывателя мультимедиа Azure с URL-адресом и маркером, который уже указан, откройте браузер и вставьте полученный URL-адрес.

## <a name="clean-up-resources-in-your-media-services-account"></a>Очистка ресурсов в учетной записи Служб мультимедиа

Как правило, необходимо очистить все, кроме объектов, которые вы планируете повторно использовать (как правило, вы будете повторно использовать преобразования, StreamingLocators и так далее). Если учетную запись требуется очистить после эксперимента, удалите ресурсы, которые не планируется использовать повторно. Например, следующий код удаляет задания.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CleanUp)]

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вам больше не нужны какие-либо ресурсы в группе ресурсов, включая Службы мультимедиа и учетные записи хранения, созданные для этого руководства, удалите группу ресурсов, созданную ранее.

Выполните следующую команду CLI:

```azurecli
az group delete --name amsResourceGroup
```

## <a name="additional-notes"></a>Дополнительные замечания

* Widevine — это служба, которая предоставляется компанией Google Inc. и подпадает под условия предоставления услуг и политику конфиденциальности Google Inc.

## <a name="ask-questions-give-feedback-get-updates"></a>Получение справки, отправка отзывов, получение обновлений

Прочитайте статью [сообщества Служб мультимедиа Azure](media-services-community.md), чтобы узнать, как задавать вопросы, оставлять отзывы и получать новости о Службах мультимедиа.

## <a name="next-steps"></a>Дальнейшие действия

Извлечение

> [!div class="nextstepaction"]
> [Использование динамического шифрования AES-128 и службы доставки ключей](protect-with-aes128.md)
