---
title: Потоковая трансляция с помощью Служб мультимедиа Azure версии 3 и .NET | Документация Майкрософт
description: В этом руководстве описано, как настроить потоковую трансляцию с помощью Служб мультимедиа Azure v3 и .NET Core.
services: media-services
documentationcenter: ''
author: juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.custom: mvc
ms.date: 04/21/2019
ms.author: juliako
ms.openlocfilehash: e4f32e14e8c1035055bd8a37bb453764984fbe4d
ms.sourcegitcommit: f6ba5c5a4b1ec4e35c41a4e799fb669ad5099522
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65149135"
---
# <a name="tutorial-stream-live-with-media-services-v3-using-net"></a>Руководство по Потоковая трансляция в реальном времени с помощью Служб мультимедиа Azure версии 3 и .NET

В Службах мультимедиа Azure за обработку содержимого потоковой трансляции отвечают компоненты [событий потоковой трансляции](https://docs.microsoft.com/rest/api/media/liveevents). Событие потоковой трансляции предоставляет входную конечную точку (URL-адрес входа), которую вы можете передать динамическому кодировщику. Событие потоковой трансляции получает от динамического кодировщика входные потоки трансляции и предоставляет их для потоковой передачи через одну или несколько [конечных точек потоковой передачи](https://docs.microsoft.com/rest/api/media/streamingendpoints). Кроме того, события потоковой трансляции предоставляют конечную точку предварительного просмотра (URL-адрес предварительного просмотра), которая позволяет просмотреть и проверить поток перед его обработкой и доставкой. В этом руководстве описано, как с помощью .NET Core создавать события прямой трансляции **сквозного** типа. 

> [!NOTE]
> Прежде чем продолжить работу, ознакомьтесь со статьей [Live streaming with Azure Media Services v3](live-streaming-overview.md) (Потоковая трансляция в Службах мультимедиа Azure v3). 

В этом руководстве описаны следующие процедуры.    

> [!div class="checklist"]
> * Скачивание примера приложения, описанного в этой статье.
> * Проверка кода, который выполняет потоковую трансляцию
> * Просмотр событий с помощью [Azure Media Player](https://amp.azure.net/libs/amp/latest/docs/index.html) в https://ampdemo.azureedge.net
> * Очистка ресурсов

[!INCLUDE [quickstarts-free-trial-note](../../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>Предварительные требования

Ниже перечислены необходимые условия для выполнения действий, описанных в этом учебнике.

- Установите Visual Studio Code или Visual Studio.
- [Создание учетной записи Служб мультимедиа](create-account-cli-how-to.md).<br/>Запишите значения, которые вы использовали в качестве имени группы ресурсов и имени учетной записи Служб мультимедиа.
- Выполните действия, описанные в статье [Доступ к API Служб мультимедиа Azure с помощью Azure CLI](access-api-cli-how-to.md), и сохраните учетные данные. Эти данные понадобятся для доступа к API.
- Веб-камера или другое устройстве (например, ноутбук) для потоковой трансляции события.
- Локальный динамический кодировщик, который преобразует сигналы от камеры в потоки и отправляет их службе потоковой трансляции в Службах мультимедиа. Поток должен иметь формат **RTMP** или **Smooth Streaming**.

## <a name="download-and-configure-the-sample"></a>Скачивание и настройка примера

Клонируйте репозиторий GitHub, содержащий пример потоковой передачи данных .NET, на компьютер с помощью следующей команды:  

 ```bash
 git clone https://github.com/Azure-Samples/media-services-v3-dotnet-core-tutorials.git
 ```

Пример потоковой трансляции размещен в папке [Live](https://github.com/Azure-Samples/media-services-v3-dotnet-core-tutorials/tree/master/NETCore/Live/MediaV3LiveApp).

Откройте файл [appsettings.json](https://github.com/Azure-Samples/media-services-v3-dotnet-core-tutorials/blob/master/NETCore/Live/MediaV3LiveApp/appsettings.json) в скачанном проекте. Замените значения учетными данными, которые вы получили, выполнив действия из статьи [Доступ к API Служб мультимедиа Azure с помощью Azure CLI](access-api-cli-how-to.md).

> [!IMPORTANT]
> Этот пример использует уникальный суффикс для каждого ресурса. Если вы отмените отладку или завершите приложение раньше, чем оно закончит свою работу, в вашей учетной записи сохранятся несколько событий потоковой трансляции. <br/>Не забудьте остановить все запущенные события потоковой трансляции. В противном случае за них будет **начислена плата**!

## <a name="examine-the-code-that-performs-live-streaming"></a>Проверка кода, который выполняет потоковую трансляцию

В этом разделе описаны функции, определенные в файле [Program.cs](https://github.com/Azure-Samples/media-services-v3-dotnet-core-tutorials/blob/master/NETCore/Live/MediaV3LiveApp/Program.cs) проекта *MediaV3LiveApp*.

Этот пример создает уникальный суффикс для каждого ресурса, чтобы избежать конфликтов имен при многократном запуске примера без очистки.

> [!IMPORTANT]
> Этот пример использует уникальный суффикс для каждого ресурса. Если вы отмените отладку или завершите приложение раньше, чем оно закончит свою работу, в вашей учетной записи сохранятся несколько событий потоковой трансляции. <br/>
> Не забудьте остановить все запущенные события потоковой трансляции. В противном случае за них будет **начислена плата**!
 
### <a name="start-using-media-services-apis-with-net-sdk"></a>Начало использования API Служб мультимедиа с пакетом SDK для .NET

Чтобы начать использование API Служб мультимедиа с .NET, создайте объект **AzureMediaServicesClient**. Чтобы создать объект, введите учетные данные, необходимые клиенту для подключения к Azure с помощью Azure AD. В коде, который вы клонировали в начале статьи, функция **GetCredentialsAsync** создает объект ServiceClientCredentials с использованием учетных данных, предоставленных в локальном файле конфигурации. 

[!code-csharp[Main](../../../media-services-v3-dotnet-core-tutorials/NETCore/Live/MediaV3LiveApp/Program.cs#CreateMediaServicesClient)]

### <a name="create-a-live-event"></a>Создание события прямой трансляции

В этом разделе показано, как создать событие потоковой трансляции **сквозного** типа (для которого параметр LiveEventEncodingType имеет значение None). Дополнительные сведения о доступных типах событий потоковой трансляции см. в разделе [Типы событий потоковой трансляции](live-events-outputs-concept.md#live-event-types). 
 
При создании событий прямой трансляции вы также можете настроить следующее:

* Расположение Служб мультимедиа. 
* Протокол потоковой передачи для событий потоковой трансляции (сейчас поддерживаются протоколы RTMP и Smooth Streaming).<br/>Изменить протокол во время работы события потоковой трансляции или связанных с ним выходных данных потоковой трансляции нельзя. Если вам нужны другие протоколы потоковой передачи, создайте отдельное событие потоковой трансляции для каждого из них.  
* Ограничения по IP-адресам для приема и предварительного просмотра. Вы можете определить IP-адреса, с которых событие потоковой трансляции будет принимать видео. Можно указать отдельный допустимый IP-адрес (например, 10.0.0.1), или диапазон IP-адресов, используя IP-адрес и маску подсети CIDR (например, 10.0.0.1/22), или IP-адрес и маску подсети с точками (например, 10.0.0.1(255.255.252.0)).<br/>Если IP-адреса не указаны и правила не заданы, ни один IP-адрес не разрешен. Чтобы разрешить все IP-адреса, создайте правило и задайте адрес 0.0.0.0/0.<br/>IP-адреса должны быть представлены в одном из следующих форматов: IPv4-адрес с 4 цифрами, диапазон адресов CIDR.
* Для создаваемого события можно настроить автоматический запуск. <br/>Если для автозапуска задано значение true, событие прямой трансляции будет запущено после создания. Это означает, что плата начисляется сразу же после запуска события потоковой трансляции. Чтобы остановить начисление оплаты, нужно явно вызвать функцию Stop (Остановить) для ресурса события потоковой трансляции. Дополнительные сведения см. в статье [Состояния компонента LiveEvent и выставление счетов за его использование](live-event-states-billing.md).

[!code-csharp[Main](../../../media-services-v3-dotnet-core-tutorials/NETCore/Live/MediaV3LiveApp/Program.cs#CreateLiveEvent)]

### <a name="get-ingest-urls"></a>Получение URL-адресов приема

После создания события потоковой трансляции можно получить URL-адреса приема, которые необходимо передать динамическому кодировщику. Он использует эти адреса для передачи динамического потока на вход.

[!code-csharp[Main](../../../media-services-v3-dotnet-core-tutorials/NETCore/Live/MediaV3LiveApp/Program.cs#GetIngestURL)]

### <a name="get-the-preview-url"></a>Получение URL-адреса предварительного просмотра

Используйте конечную точку предварительного просмотра, чтобы проверить получение входных данных от кодировщика.

> [!IMPORTANT]
> Прежде, чем продолжить, убедитесь, что видео правильно передается на URL-адрес предварительного просмотра.

[!code-csharp[Main](../../../media-services-v3-dotnet-core-tutorials/NETCore/Live/MediaV3LiveApp/Program.cs#GetPreviewURLs)]

### <a name="create-and-manage-live-events-and-live-outputs"></a>Создание событий и выходных данных потоковой трансляции и управление ими

Настроив передачу потока данных в событие потоковой трансляции, можно запустить событие потоковой передачи, создав ресурс, выходные данные потоковой трансляции и указатель потоковой передачи. В результате вы сможете запустить архивирование потока и предложить его зрителям через конечную точку потоковой передачи. 

#### <a name="create-an-asset"></a>Создание ресурса

Создайте ресурс, который будет использоваться в выходных данных прямой трансляции.

[!code-csharp[Main](../../../media-services-v3-dotnet-core-tutorials/NETCore/Live/MediaV3LiveApp/Program.cs#CreateAsset)]

#### <a name="create-a-live-output"></a>Создание выходных данных прямой трансляции

Выходные данные прямой трансляции запускаются при создании и останавливаются при удалении. При удалении выходных данных прямой трансляции базовый ресурс и его содержимое не удаляются.

[!code-csharp[Main](../../../media-services-v3-dotnet-core-tutorials/NETCore/Live/MediaV3LiveApp/Program.cs#CreateLiveOutput)]

#### <a name="create-a-streaming-locator"></a>Создание указателя потоковой передачи

> [!NOTE]
> При создании учетной записи служб мультимедиа в нее добавляется конечная точка потоковой передачи **по умолчанию** в состоянии **Остановлена**. Чтобы начать потоковую передачу содержимого и воспользоваться функциями [динамической упаковки](dynamic-packaging-overview.md) и динамического шифрования, конечная точка потоковой передачи, из которой необходимо выполнять потоковую передачу содержимого, должна находиться в состоянии **Выполняется**. 

В случае публикации ресурса выходных данных потоковой трансляции с использованием указателя потоковой передачи событие потоковой трансляции (до длины окна DVR) будет доступно для просмотра до истечения срока действия или удаления указателя потоковой передачи, в зависимости от того, какое действие произойдет первым.

[!code-csharp[Main](../../../media-services-v3-dotnet-core-tutorials/NETCore/Live/MediaV3LiveApp/Program.cs#CreateStreamingLocator)]

```csharp

// Get the url to stream the output
ListPathsResponse paths = await client.StreamingLocators.ListPathsAsync(resourceGroupName, accountName, locatorName);

foreach (StreamingPath path in paths.StreamingPaths)
{
    UriBuilder uriBuilder = new UriBuilder();
    uriBuilder.Scheme = "https";
    uriBuilder.Host = streamingEndpoint.HostName;

    uriBuilder.Path = path.Paths[0];
    // Get the URL from the uriBuilder: uriBuilder.ToString()
}
```

### <a name="cleaning-up-resources-in-your-media-services-account"></a>Очистка ресурсов в учетной записи Служб мультимедиа

После завершения потоковой передачи мероприятия вы можете удалить выделенные ранее ресурсы с помощью описанной ниже процедуры.

* Остановите трансляцию потока из кодировщика.
* Остановите событие потоковой трансляции. Плата за остановленное событие потоковой трансляции не взимается. Если вам понадобится снова запустить его, вы можете воспользоваться тем же URL-адресом приема (перенастраивать кодировщик не потребуется).
* Вы можете остановить конечную точку потоковой передачи, если больше не собираетесь предоставлять доступ к архиву мероприятия в качестве потоковой передачи по требованию. Плата за остановленное событие потоковой трансляции не взимается.

[!code-csharp[Main](../../../media-services-v3-dotnet-core-tutorials/NETCore/Live/MediaV3LiveApp/Program.cs#CleanupLiveEventAndOutput)]

[!code-csharp[Main](../../../media-services-v3-dotnet-core-tutorials/NETCore/Live/MediaV3LiveApp/Program.cs#CleanupLocatorAssetAndStreamingEndpoint)]

Следующий код показывает, как удалить из учетной записи все события потоковой трансляции:

[!code-csharp[Main](../../../media-services-v3-dotnet-core-tutorials/NETCore/Live/MediaV3LiveApp/Program.cs#CleanupAccount)]   

## <a name="watch-the-event"></a>Просмотр события

Чтобы просмотреть событие, скопируйте URL-адрес потоковой передачи, полученный при выполнении кода в разделе "Создание указателя потоковой передачи", и вставьте его в любой проигрыватель. Для проверки потока на сайте https://ampdemo.azureedge.net можно использовать [Проигрыватель мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/index.html). 

После остановки событие потоковой трансляции автоматически преобразуется в содержимое по требованию. Даже после остановки и удаления события пользователи смогут запрашивать потоковую передачу архивированного видеосодержимого, пока не удален соответствующий ресурс. Ресурс невозможно удалить, пока он используется каким-либо событием: сначала нужно удалить это событие. 

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вам больше не нужны какие-либо ресурсы в группе ресурсов, включая Службы мультимедиа и учетные записи хранения, созданные для этого руководства, удалите группу ресурсов, созданную ранее.

Выполните следующую команду CLI:

```azurecli-interactive
az group delete --name amsResourceGroup
```

> [!IMPORTANT]
> За запущенное событие потоковой трансляции взимается плата. Учтите также, что при сбое или остановке проекта или программы по любой причине событие потоковой трансляции может остаться в работающем состоянии, за что будет взиматься плата.

## <a name="ask-questions-give-feedback-get-updates"></a>Получение справки, отправка отзывов, получение обновлений

Прочитайте статью [сообщества Служб мультимедиа Azure](media-services-community.md), чтобы узнать, как задавать вопросы, оставлять отзывы и получать новости о Службах мультимедиа.

## <a name="next-steps"></a>Дополнительная информация

[Потоковая передача файлов](stream-files-tutorial-with-api.md)
 
