---
title: Высокий уровень доступности служб мультимедиа Azure
description: Узнайте, как выполнить отработку отказа для дополнительной учетной записи служб мультимедиа при сбое или неудачном выполнении регионального центра обработки данных.
services: media-services
documentationcenter: ''
author: juliako
manager: femila
editor: ''
ms.service: media-services
ms.subservice: ''
ms.workload: ''
ms.topic: article
ms.custom: ''
ms.date: 02/24/2020
ms.author: juliako
ms.openlocfilehash: e2212c2ad5a0ab1899d281e99a89b33a2fc0298f
ms.sourcegitcommit: 225a0b8a186687154c238305607192b75f1a8163
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/29/2020
ms.locfileid: "78202290"
---
# <a name="azure-media-services-high-availability-guidance"></a>Рекомендации по обеспечению высокой доступности служб мультимедиа Azure

Служба кодирования служб мультимедиа Azure — это региональная платформа пакетной обработки, которая в настоящее время не предназначена для обеспечения высокого уровня доступности в пределах одного региона. В настоящее время служба кодирования не обеспечивает мгновенную отработку отказа службы, если имеется Региональный центр обработки данных или сбой базового компонента или зависимых служб (таких как хранилище, SQL и т. д.).  В этой статье объясняется, как развертывать службы мультимедиа для поддержки архитектуры с высоким уровнем доступности с отработкой отказа и обеспечения оптимальной доступности приложений. 

Следуя рекомендациям и рекомендациям, описанным в этой статье, вы снизите риск ошибок кодирования, задержек и сократите время восстановления в случае сбоя в одном регионе.

## <a name="how-to-build-a-cross-regional-encoding-system"></a>Создание системы кодирования в разных регионах

* [Создайте](create-account-cli-how-to.md) две (или более) учетные записи служб мультимедиа Azure.
* Подпишитесь на сообщения **жобстатечанже** в каждой учетной записи.

    * В службах мультимедиа v3 это делается через службу "Сетка событий Azure". Дополнительные сведения см. в разделе:
    
       * [Примеры сетки событий](../../event-grid/receive-events.md) 
       * [Схемы службы "Сетка событий Azure" для событий служб мультимедиа](media-services-event-schemas.md) 
       * [Регистрация событий с помощью портал Azure или интерфейса командной строки](reacting-to-media-services-events.md) (это также можно сделать с помощью пакета SDK для управления EventGrid).
       * [Пакет SDK Microsoft. Azure. EventGrid](https://www.nuget.org/packages/Microsoft.Azure.EventGrid/) (который поддерживает события служб мультимедиа изначально). 
       
        Вы также можете использовать события службы "Сетка событий" с помощью функций Azure.
    * В службах мультимедиа v2 это выполняется через [нотификатионендпоинтс](../previous/media-services-dotnet-check-job-progress-with-webhooks.md).
* При [создании задания](transforms-jobs-concept.md):

    * Случайный выбор учетной записи из списка используемых в данный момент учетных записей (этот список обычно содержит обе учетные записи, но при обнаружении проблем может содержать только одну учетную запись). Если список пуст, создайте предупреждение, чтобы оператор мог исследовать его.
    * Общие рекомендации: для каждой задачи или [жобаутпут](https://docs.microsoft.com/rest/api/media/jobs/create#joboutputasset) требуется одна [зарезервированная единица мультимедиа](media-reserved-units-cli-how-to.md) (если не используется [видеоанализерпресет](analyzing-video-audio-files-concept.md) в версии 3).
    * Получение числа [зарезервированных единиц мультимедиа](media-reserved-units-cli-how-to.md) (мрус) для выбранной учетной записи. Если текущее количество **зарезервированных единиц мультимедиа** еще не равно максимальному значению, добавьте номер мрус, необходимый для задания, и обновите службу. Если скорость отправки задания высока и вы часто запрашиваете Мрус, чтобы найти максимальное значение, используйте распределенный кэш для значения с разумным временем ожидания.
    * Сосчитайте количество заданий порядковых.
* Когда обработчик Жобстатечанже получает уведомление о том, что задание достигло запланированного состояния, запишите время, в которое он входит в состояние расписания, а также используемую область или учетную запись.    
* Когда обработчик Жобстатечанже получает уведомление о том, что задание достигло состояния обработки, отметьте запись для задания как обработку.
* Когда обработчик Жобстатечанже получает уведомление о том, что задание достиго завершенного, ошибочного или отмененного состояния, отметьте запись для задания как окончательную и уменьшите число заданий порядковых. Получите количество зарезервированных единиц мультимедиа для выбранной учетной записи и сравните текущий номер MRU с числом заданий порядковых. Если число порядковых меньше числа MRU, уменьшите его и обновите службу.
* Наличие отдельного процесса, который периодически проверяет записи заданий. Если у вас есть задания в запланированном состоянии, которые еще не были расширены до состояния обработки в течение разумного периода времени для данного региона, удалите этот регион из списка используемых в данный момент учетных записей.

    * В зависимости от бизнес-требований вы можете отменить эти задания прямо сейчас и отправить их в другую учетную запись. Вы также можете предоставить им дополнительное время, чтобы перейти к следующему состоянию.   
    * По истечении определенного периода времени снова добавьте учетную запись в текущий список (с предположением о восстановлении региона).
    
Если вы обнаружите, что число MRU пробуксовка вверх и вниз, переместите логику декремента к периодической задаче. Чтобы проверить, требуется ли обновление Мрус, логика отправки перед заданием сравнивает число порядковых с текущим числом MRU.

## <a name="how-to-build-video-on-demand-cross-region-streaming"></a>Создание потоковой передачи видео по запросу 

* Перекрестная передача видео по запросу включает в себя дублирование [ресурсов](assets-concept.md), [политик ключей содержимого](content-key-policy-concept.md) (если они используются), [политик потоковой передачи](streaming-policy-concept.md)и [указателей потоковой передачи](streaming-locators-concept.md). 
* Вам потребуется создать политики в обоих регионах и синхронизировать их в актуальном состоянии. 
* При создании указателей потоковой передачи необходимо использовать одно и то же значение идентификатора локатора, значение идентификатора ContentKey и значение ContentKey.  
* При кодировании содержимого рекомендуется кодировать содержимое в регионе а и опубликовать его, затем скопировать закодированное содержимое в регион б и опубликовать его, используя те же значения, что и в регионе а.
* Диспетчер трафика можно использовать в именах узлов для источника и службы доставки ключей (в конфигурации служб мультимедиа это будет выглядеть как URL-адрес пользовательского ключевого сервера).

## <a name="next-steps"></a>Следующие шаги

* [Создание учетной записи](create-account-cli-how-to.md)
* Ознакомьтесь с [примерами кода](https://docs.microsoft.com/samples/browse/?products=azure-media-services)
