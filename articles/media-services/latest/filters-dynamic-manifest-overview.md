---
title: Фильтры и динамические манифесты Служб мультимедиа Azure | Документация Майкрософт
description: В этом разделе описывается создание фильтров, с помощью которых клиент может передавать определенные секции потока. Для достижения такой выборочной потоковой передачи службы мультимедиа создают динамические манифесты.
services: media-services
documentationcenter: ''
author: Juliako
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: ne
ms.topic: article
ms.date: 07/11/2019
ms.author: juliako
ms.openlocfilehash: bbbb570cc042d5faa16b66c42aef9792b24fdb12
ms.sourcegitcommit: 470041c681719df2d4ee9b81c9be6104befffcea
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/12/2019
ms.locfileid: "67854051"
---
# <a name="pre-filtering-manifests-by-using-dynamic-packager"></a>Предварительная фильтрация манифестов с помощью динамического упаковщика

При передаче потокового содержимого с адаптивной скоростью на устройства часто требуется опубликовать несколько версий манифеста для конкретных возможностей устройства или доступной пропускной способности сети. [Динамический упаковщик](dynamic-packaging-overview.md) позволяет задавать фильтры, которые могут отфильтровывать определенные кодеки, разрешения, скорости и сочетания звуковых дорожек, устраняя необходимость создания нескольких копий. Вам просто нужно опубликовать новый URL-адрес с конкретным набором фильтров, настроенных для целевых устройств (iOS, Android, SmartTV или браузеры), и сетевые возможности (сценарии с высокой пропускной способностью, мобильными или низкой пропускной способностью). В этом случае клиенты могут управлять потоковой передачей содержимого через строку запроса (путем указания доступных [фильтров ресурсов или фильтров учетных записей](filters-concept.md)) и использовать фильтры для потоковой передачи конкретных разделов потока.

В некоторых сценариях доставки необходимо убедиться, что клиент не может получить доступ к определенным дорожкам. Например, может быть нежелательно публиковать манифест, содержащий записи HD, на определенном уровне подписчика. Или вы можете удалить определенные дорожки с адаптивной скоростью (ГРАНИЧНЫМ), чтобы снизить затраты на доставку на определенное устройство, которое не будет выгодно для дополнительных дорожек. В этом случае можно связать список предварительно созданных фильтров с указателем потоковой [передачи](streaming-locators-concept.md) при создании. В этом случае клиенты не могут управлять потоком содержимого, оно определяется **указателем потоковой передачи**.

Можно сочетать фильтрацию с помощью указания [фильтров для указателя потоковой передачи](filters-concept.md#associating-filters-with-streaming-locator) и дополнительных фильтров для конкретных устройств, которые клиент указывает в URL-адресе. Это может быть полезно для ограничения дополнительных дорожек, таких как метаданные или потоки событий, языки аудио или описательные звуковые дорожки. 

Это возможность указывать различные фильтры для потока, предоставляет мощное динамическое  решение для работы с манифестами, предназначенное для нескольких сценариев использования для целевых устройств. В этом разделе объясняются понятия, связанные с **динамическими манифестами**, и приводятся примеры сценариев, в которых может потребоваться эта функция.

> [!NOTE]
> Динамические манифесты не меняют актив и его манифест по умолчанию. 
> 

##  <a name="overview-of-manifests"></a>Общие сведения о манифестах

Службы мультимедиа Azure поддерживают протоколы HLS, MPEG ТИРЕ и Smooth Streaming. В рамках [динамической упаковки](dynamic-packaging-overview.md)манифесты клиента потоковой передачи (основной список воспроизведения HLS, описание мультимедийного представления [MPD] и Smooth Streaming) создаются динамически на основе селектора формата в URL-адресе. См. раздел протоколы доставки в [общем рабочем процессе по запросу](dynamic-packaging-overview.md#delivery-protocols). 

### <a name="get-and-examine-manifest-files"></a>Получение и просмотр файлов манифестов

Вы указываете список условий фильтра отслеживания, в зависимости от того, какие записи потока (в реальном времени или видео по запросу [VOD]) должны включаться в динамически создаваемый манифест. Чтобы получить и просмотреть свойства дорожек, необходимо сначала загрузить манифест Smooth Streaming.

В руководстве по [отправке, кодированию и потоковой передаче файлов с помощью .NET](stream-files-tutorial-with-api.md#get-streaming-urls) показано, как создавать URL-адреса потоковой передачи с помощью .NET. Если запустить приложение, один из URL-адресов будет указывать на манифест Smooth Streaming: `https://amsaccount-usw22.streaming.media.azure.net/00000000-0000-0000-0000-0000000000000/ignite.ism/manifest`.<br/> Скопируйте и вставьте URL-адрес в адресную строку браузера. Файл будет скачан. Вы можете открыть его в текстовом редакторе по своему усмотрению.

Пример для остальных компонентов см. в разделе [Отправка, кодирование и потоковая передача файлов с помощью остальных](stream-files-tutorial-with-rest.md#list-paths-and-build-streaming-urls)компонентов.

### <a name="monitor-the-bitrate-of-a-video-stream"></a>Отслеживание скорости видеопотока

Для отслеживания скорости видеопотока можно использовать [страницу с демонстрацией Проигрывателя мультимедиа Azure](https://aka.ms/azuremediaplayer). На странице демонстрация отображаются сведения о диагностике на вкладке **Диагностика** .

![Диагностика Проигрывателя мультимедиа Azure Media Player][amp_diagnostics]
 
### <a name="examples-urls-with-filters-in-query-string"></a>Примеры: URL-адреса с фильтрами в строке запроса

Фильтры можно применять к протоколам потоковой передачи ГРАНИЧНЫЙ: HLS, MPEG-DASH и Smooth Streaming. В представленной ниже таблице приводятся некоторые примеры URL-адресов с фильтрами.

|Протокол|Пример|
|---|---|
|HLS|`https://amsv3account-usw22.streaming.media.azure.net/fecebb23-46f6-490d-8b70-203e86b0df58/bigbuckbunny.ism/manifest(format=m3u8-aapl,filter=myAccountFilter)`|
|MPEG DASH|`https://amsv3account-usw22.streaming.media.azure.net/fecebb23-46f6-490d-8b70-203e86b0df58/bigbuckbunny.ism/manifest(format=mpd-time-csf,filter=myAssetFilter)`|
|Smooth Streaming|`https://amsv3account-usw22.streaming.media.azure.net/fecebb23-46f6-490d-8b70-203e86b0df58/bigbuckbunny.ism/manifest(filter=myAssetFilter)`|

## <a name="rendition-filtering"></a>Фильтрация представлений

Вы можете выбрать кодировку ресурса в нескольких профилях кодирования (H. 264, базовый, H. 264 High, AACL, ААЧ, Dolby Digital Plus) и несколько скоростей качества. Однако не все клиентские устройства будут поддерживать все профили и скорости потока вашего актива. Например, более старые устройства Android поддерживают только H. 264 Baseline + AACL. Отправка более высоких скоростей на устройство, которое не может получить преимущества, приведет к потере пропускной способности и вычислительных устройств. Такое устройство должно декодировать всю заданную информацию, чтобы масштабировать их для вывода.

С помощью динамического манифеста можно создавать профили устройств (например, мобильные устройства, консоли или HD/SD) и включать в них дорожки и качества, которые должны быть частью каждого профиля. Это называется фильтрацией представлений. На следующей схеме показан пример.

![Пример фильтрации представлений][renditions2]

В следующем примере использовался кодировщик для кодирования промежуточного актива в семь MP4-видеофайлов стандарта ISO (с разрешением от 180p до 1080p). Закодированный ресурс можно [динамически упаковать](dynamic-packaging-overview.md) в любой из следующих протоколов потоковой передачи: HLS, MPEG DASH и Smooth. 

В верхней части следующей диаграммы показан манифест HLS для ресурса без фильтров. (Содержит все семь представлений.)  В нижнем левом углу на схеме показан манифест HLS, к которому применен фильтр с именем «Ott». Фильтр "Ott" задает удаление всех скоростей ниже 1 Мбит/с, поэтому нижние уровни качества были удалены в ответе. В правом нижнем углу на схеме показан манифест HLS, к которому применен фильтр с именем Mobile. Фильтр "Mobile" указывает на удаление представлений, где разрешение больше 720p, поэтому два представления 1080p были удалены.

![Фильтрация представлений][renditions1]

## <a name="removing-language-tracks"></a>Удаление языковых дорожек
Активы могут содержать аудиодорожки на нескольких языках, например английском, испанском, французском и т. д. Как правило, пакет SDK проигрывателя управляет выбором аудиодорожки по умолчанию и доступными на выбор пользователя аудиодорожками.

Разработка таких пакетов SDK для проигрывателя является сложной задачей, так как требует различных реализаций в разных платформах проигрывателя для конкретных устройств. Кроме того, на некоторых платформах API-интерфейсы проигрывателя ограничены и не включают функцию выбора звука, когда пользователи не могут выбрать или изменить звуковую дорожку по умолчанию. С помощью фильтров активов можно управлять поведением проигрывателей, создавая фильтры с включением только нужных языков аудио.

![Фильтрация языковых дорожек][language_filter]

## <a name="trimming-the-start-of-an-asset"></a>Обрезка начала ресурса

При большинстве событий потоковой трансляции в реальном времени операторы проводят процедуры тестирования до фактического события. Например, перед началом события они могут включить заставку: «Программа начнется мгновенно». 

При архивировании программы данные проверок и заставок также будут архивированы и включены в представление. Однако эту информацию не следует отображать клиентам. С помощью динамического манифеста можно создать фильтр времени начала и удалить ненужные данные из манифеста.

![Начало обрезки][trim_filter]

## <a name="creating-subclips-views-from-a-live-archive"></a>Создание субклипов (представлений) из текущего архива

Многие текущие события являются длительными, и их текущий архив может включать в себя несколько событий. После окончания текущего события вещателям может потребоваться разбить текущий архив на логические последовательности начала и остановки программ. 

Вы можете опубликовать эти виртуальные программы отдельно, не обрабатывая динамический Архив, а не создавайте отдельные ресурсы (что не получит преимуществ существующих кэшированных фрагментов в CDN). Примерами таких виртуальных программ являются четверти при игре в американский футбол или баскетбол, иннинги в бейсболе или отдельные события любой программы о спорте.

С помощью динамического манифеста можно создавать фильтры, используя время начала и окончания, а также создавать виртуальные представления в верхней части динамического архива. 

![Фильтр субклипа][subclip_filter]

Вот отфильтрованный ресурс:

![Лыжный спорт][skiing]

## <a name="adjusting-the-presentation-window-dvr"></a>Настройка окна презентации (DVR)

Сейчас службы мультимедиа Azure предлагают циклический Архив, где длительность может быть настроена от 5 минут до 25 часов. Фильтрация манифеста позволяет создать скользящее окно DVR поверх архива, без удаления медиаданных. Есть множество сценариев, где вещателям требуется предоставить ограниченное окно DVR, которое перемещается вместе с текущей границей, и в то же время поддерживать более крупное окно архивации. Вещателю может понадобиться использовать данные, находящиеся за пределами окна DVR, для выделения клипов, или же предоставлять разные окна DVR для различных устройств. Например, большая часть мобильных устройств не обрабатывает большие окна DVR (для мобильных устройств можно использовать 2-минутное окно DVR и 1 час для настольных клиентов).

![Окно DVR][dvr_filter]

## <a name="adjusting-livebackoff-live-position"></a>Настройка LiveBackoff (динамической позиции)

Фильтрация манифеста позволяет удалить несколько секунд с динамической границы текущей программы. Фильтрация позволяет транслировать Просмотр презентации в точке предварительного просмотра и создавать точки вставки объявления перед получением потока средствами просмотра (с обратной скидкой 30 секунд). Затем вещательные рассылки могут отправить эти объявления на клиентские платформы во времени, чтобы они получали и обрабатывали информацию перед объявлением.

В дополнение к поддержке рекламы, параметр прямой архивации можно использовать для настройки расположения средств просмотра таким образом, чтобы при смещении клиентов и попадании в активное состояние они по-прежнему могли получать фрагменты с сервера. Таким образом клиенты не будут получать ошибку HTTP 404 или 412.

![Фильтр для динамического резервного копирования][livebackoff_filter]

## <a name="combining-multiple-rules-in-a-single-filter"></a>Объединение нескольких правил в одном фильтре

В одном фильтре можно объединить несколько правил фильтрации. В качестве примера можно определить правило диапазона для удаления заставок из текущего архива, а также для фильтрации доступных скоростей потока. При применении нескольких правил фильтрации конечный результат является пересечением всех правил.

![Несколько правил фильтрации][multiple-rules]

## <a name="combining-multiple-filters-filter-composition"></a>Объединение нескольких фильтров (сложение фильтров)

Кроме того, вы можете объединять несколько фильтров в одном URL-адресе. В следующем сценарии показано, для чего могут потребоваться подобные фильтры:

1. Необходимо отфильтровать качество видео для мобильных устройств, например Android или iPad (для ограничения качества видео). Чтобы удалить ненужные качества, создайте фильтр учетной записи, подходящий для профилей устройств. Вы можете использовать фильтры учетных записей для всех ресурсов в одной учетной записи служб мультимедиа без каких бы то ни было дальнейших связей.
1. При необходимости обрезать время начала и окончания ресурс-контейнера. Чтобы добиться этого, создайте фильтр ресурсов и задайте время начала и окончания. 
1. Необходимо объединить оба этих фильтра. Без сочетания, в фильтр обрезки необходимо добавить фильтр качества, что сделает использование фильтров более сложным.


Чтобы объединить фильтры, необходимо задать имена фильтров URL-адрес манифеста или списка воспроизведения в формате с разделителями-запятыми. Предположим, что у вас есть фильтр с именем *мимобиледевице* , который фильтрует качества, и у вас есть другой именованный *мистарттиме* для задания определенного времени начала. Вы можете объединить до трех фильтров. 

Дополнительные сведения см. в [этой записи блога](https://azure.microsoft.com/blog/azure-media-services-release-dynamic-manifest-composition-remove-hls-audio-only-track-and-hls-i-frame-track-support/).

## <a name="considerations-and-limitations"></a>Ограничения и рекомендации

- Значения для **форцеендтиместамп**, **пресентатионвиндовдуратион**и **ливебаккоффдуратион** не должны быть заданы для фильтра VOD. Они используются только для сценариев динамической фильтрации. 
-  Динамический манифест работает в границах GOP (ключевых кадрах), поэтому усечение имеет GOP точность.
-  Для фильтров учетных записей и активов можно использовать одно и то же имя фильтра. Фильтры активов имеют более высокий приоритет и переопределяют фильтры учетных записей.
- При обновлении фильтра для конечной точки потоковой передачи может потребоваться до 2 минут для обновления правил. Если вы использовали фильтры для обслуживания содержимого (а содержимое кэшировано в учетных записях-посредниках и кэшах CDN), обновление этих фильтров может привести к сбоям проигрывателя. Рекомендуется очищать кэш после обновления фильтра. Если этот параметр невозможен, попробуйте использовать другой фильтр.
- Клиентам необходимо вручную скачать манифест и проанализировать точную отметку времени начала и шкалу времени.
    
    - Чтобы определить свойства дорожек в ресурсе, [получите и проверьте файл манифеста](#get-and-examine-manifest-files).
    - Ниже приведена формула для задания свойств метки времени фильтра ресурсов: <br/>старттиместамп = &lt;время начала в манифесте&gt; +  &lt;ожидаемое время начала фильтра в&gt; секундах * шкала времени

## <a name="next-steps"></a>Следующие шаги

В следующих статьях показано, как создавать фильтры программным способом.  

- [Create filters with REST APIs](filters-dynamic-manifest-rest-howto.md) (Создание фильтров с помощью интерфейсов REST API)
- [Создание фильтров с помощью .NET](filters-dynamic-manifest-dotnet-howto.md)
- [Create filters with CLI](filters-dynamic-manifest-cli-howto.md) (Создание фильтров с помощью .NET)

[renditions1]: ./media/filters-dynamic-manifest-overview/media-services-rendition-filter.png
[renditions2]: ./media/filters-dynamic-manifest-overview/media-services-rendition-filter2.png

[rendered_subclip]: ./media/filters-dynamic-manifests/media-services-rendered-subclip.png
[timeline_trim_event]: ./media/filters-dynamic-manifests/media-services-timeline-trim-event.png
[timeline_trim_subclip]: ./media/filters-dynamic-manifests/media-services-timeline-trim-subclip.png

[multiple-rules]:./media/filters-dynamic-manifest-overview/media-services-multiple-rules-filters.png

[subclip_filter]: ./media/filters-dynamic-manifest-overview/media-services-subclips-filter.png
[trim_event]: ./media/filters-dynamic-manifests/media-services-timeline-trim-event.png
[trim_subclip]: ./media/filters-dynamic-manifests/media-services-timeline-trim-subclip.png
[trim_filter]: ./media/filters-dynamic-manifest-overview/media-services-trim-filter.png
[redered_subclip]: ./media/filters-dynamic-manifests/media-services-rendered-subclip.png
[livebackoff_filter]: ./media/filters-dynamic-manifest-overview/media-services-livebackoff-filter.png
[language_filter]: ./media/filters-dynamic-manifest-overview/media-services-language-filter.png
[dvr_filter]: ./media/filters-dynamic-manifest-overview/media-services-dvr-filter.png
[skiing]: ./media/filters-dynamic-manifest-overview/media-services-skiing.png
[amp_diagnostics]: ./media/filters-dynamic-manifest-overview/amp_diagnostics.png
