---
title: Ключи, управляемые клиентом, или создание собственных ключей (BYOK) для Служб мультимедиа
description: В этом руководстве показано, как использовать управляемые клиентом ключи для учетной записи хранения Служб мультимедиа
author: IngridAtMicrosoft
ms.author: inhenkel
ms.service: media-services
ms.topic: tutorial
ms.date: 10/18/2020
ms.openlocfilehash: c26da9d888bbcdf72c052fa4bd7fcdf443a2d8f7
ms.sourcegitcommit: ce8eecb3e966c08ae368fafb69eaeb00e76da57e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/21/2020
ms.locfileid: "92325892"
---
# <a name="tutorial-use-customer-managed-keys-or-bring-your-own-key-byok-with-media-services"></a>Руководство. Использование ключей, управляемых клиентом, или создание собственных ключей (BYOK) для Служб мультимедиа

API версии 2020-05-01 позволяет использовать управляемый клиентом ключ RSA для учетной записи Служб мультимедиа, у которой есть управляемое системой удостоверение.  В этом руководстве показано, как работать с коллекцией и средой Postman для отправки запросов REST в службы Azure.  Используемые службы:

- регистрация нового приложения для Postman в Azure Active Directory;
- API Microsoft Graph
- Хранилище Azure
- Azure Key Vault
- Службы мультимедиа

В этом руководстве показано, как выполнить следующие действия с помощью Postman:

> [!div class="checklist"]
> * получение маркеров для использования со службами Azure;
> * создание группы ресурсов и учетной записи хранения;
> * создание учетной записи Служб мультимедиа с удостоверением, управляемым системой;
> * создание Key Vault для хранения управляемого пользователем ключа RSA, чтобы использовать его с учетной записью хранения;
> * настройка учетной записи Служб мультимедиа для использования ключа RSA с учетной записью хранения;
> * использование переменных в Postman.

Если у вас еще нет подписки Azure, создайте [бесплатную пробную учетную запись](https://azure.microsoft.com/free/).

## <a name="prerequisites"></a>Предварительные требования

- Зарегистрируйте субъект-службу с нужными разрешениями.
- Установите [Postman](https://www.postman.com).
- Скачайте коллекцию Postman для этого руководства в разделе [media-services-customer-managed-keys-byok](https://github.com/Azure-Samples/media-services-customer-managed-keys-byok) из примеров Azure.

### <a name="register-a-service-principal-with-the-needed-permissions"></a>Регистрация субъекта-службы с нужными разрешениями

[Создайте субъект-службу](https://docs.microsoft.com/azure/active-directory/develop/howto-create-service-principal-portal).  Процесс получения секрета для субъекта-службы описан в разделе [Вариант 2](https://docs.microsoft.com/azure/active-directory/develop/howto-create-service-principal-portal#authentication-two-options).  Сохраните этот секрет, так как после ухода с этой страницы портала он станет недоступным.

Субъекту-службе нужны следующие разрешения для выполнения задач, описанных в этом руководстве.

![Необходимые разрешения для субъекта-службы](./media/tutorial-byok/service-principal-permissions-1.png)

### <a name="install-postman"></a>Установка Postman

Если вы еще не установили Postman для работы в Azure, получите его на сайте [postman.com](https://www.postman.com/).

### <a name="download-and-import-the-collection"></a>Скачивание и импорт коллекции

Скачайте коллекцию Postman для этого руководства в разделе [media-services-customer-managed-keys-byok](https://github.com/Azure-Samples/media-services-customer-managed-keys-byok) из примеров Azure.

## <a name="installation-of-collection-and-environment"></a>Установка коллекции и среды

1. Запустите Postman.
1. Выберите **Импортировать** .
1. Щелкните **Upload files** (Передать файлы).
1. Перейдите к расположению, в котором вы сохранили файлы коллекции и среды.
1. Выберите файл коллекции и среды.
1. Выберите **Open** (Открыть).  (Вы увидите предупреждение о том, что файлы будут импортированы не как API, а как коллекции.  Все в порядке.  Именно это вам и нужно.)
1. Теперь эта коллекция будет отображаться в списке коллекций с пометкой BYOK.
1. А переменные среды появятся в списке сред.

### <a name="understand-the-rest-api-requests-in-the-collection"></a>Общие сведения о запросах к REST API в коллекции

Коллекция предоставляет следующие запросы REST API. Эти запросы должны отправляться в указанной последовательности, так как большинство из них содержат тестовые скрипты, которые динамически создают глобальные переменные для следующего запроса в этой последовательности. Вам не нужно вручную создавать глобальные переменные.

В Postman эти переменные будут указываться в фигурных скобках (`{{ }}`).  Например, `{{bearerToken}}`.

1. Получение токена AAD — этот тест задает глобальную переменную *bearerToken* .
2. Получение токена Graph — этот тест задает глобальную переменную *graphToken* .
3. Получение сведений о субъекте-службе — этот тест задает глобальную переменную *servicePrincipalObjectId* .
4. Создание учетной записи хранения — этот тест задает глобальную переменную *storageAccountId* .
5. Создание учетной записи Служб мультимедиа с удостоверением, управляемым системой — этот тест задает глобальную переменную *principalId* .
6. Создание Key Vault, предоставление доступа к субъекту-службе — этот тест задает глобальную переменную *keyVaultId* .
7. Получение маркера Key Vault — этот тест задает глобальную переменную *keyVaultToken* .
8. Создание ключа RSA в хранилище ключей — этот тест задает глобальную переменную *keyId* .
9. Обновление учетной записи Служб мультимедиа, чтобы использовать ключ для учетной записи хранения — для этого запроса скрипт теста отсутствует.

## <a name="define-environment-variables"></a>Определение переменных среды

1. Перейдите к среде, которую вы скачали ранее, выбрав ее в раскрывающемся списке сред.
1. Задайте переменные среды в Postman. Они также используются в качестве переменных в фигурных скобках (`{{ }}`).  Например, `{{tenantId}}`.

    * *tenantId*  — ваш идентификатор клиента.
    * *servicePrincipalId*  — идентификатор субъекта-службы, который вы можете выяснить любым привычным методом (портал, CLI и т. д.).
    * *servicePrincipalSecret*  — секрет, созданный для субъекта-службы.
    * *subscription*  — идентификатор подписки.
    * *storageName*  — имя, которое вы хотите присвоить хранилищу.
    * *accountName*  — имя учетной записи Службы мультимедиа, которую вы хотите использовать.
    * *keyVaultName*  — имя Key Vault, которое вы хотите использовать.
    * *resourceLocation*  — centralus (или другой регион, куда вы хотите поместить ресурсы;  наша коллекция проверялась только в centralus).
    * *resourceGroup*  — имя группы ресурсов.

    Следующие переменные являются стандартными для работы с ресурсами Azure, поэтому их не нужно изменять.

    * *armResource* = `https://management.core.windows.net`
    * *graphResource* = `https://graph.windows.net/`
    * *keyVaultResource* = `https://vault.azure.net`
    * *armEndpoint* = `management.azure.com`
    * *graphEndpoint* = `graph.windows.net`
    * *aadEndpoint* = `login.microsoftonline.com`
    * *keyVaultDomainSuffix* = `vault.azure.net`

## <a name="send-the-requests"></a>Отправка запросов

После определения переменных среды вы можете выполнять запросы поочередно в указанной выше последовательности или выполнить всю коллекцию сразу с помощью средства выполнения тестов Postman.

## <a name="change-the-key"></a>Изменение ключа

Службы мультимедиа автоматически обнаруживают, что ключ был изменен.  Чтобы проверить это, создайте новую версию того же ключа. Службы мультимедиа должны обнаружить этот ключ не позднее, чем через 15 минут.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы не собираетесь использовать (и **оплачивать** ) созданные ресурсы, удалите их.

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения см. в следующей статье:
> [!div class="nextstepaction"]
> [Кодирование удаленного файла на основе URL-адреса и потоковой передачи видео с помощью REST](stream-files-tutorial-with-rest.md)
