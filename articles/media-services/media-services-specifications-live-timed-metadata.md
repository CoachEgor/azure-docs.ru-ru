---
title: Службы мультимедиа Azure. Сигнализация метаданных времени в потоковой трансляции | Документация Майкрософт
description: В этой спецификации описаны методы для сигнализации метаданных времени при приеме и потоковой передаче в службы мультимедиа Azure. Это включает поддержку универсальных сигналов с метаданными времени (ID3), а также SCTE-35 для сигнализации о вставке рекламы и присоединения к условию.
services: media-services
documentationcenter: ''
author: johndeu
manager: femila
editor: johndeu
ms.assetid: 265b94b1-0fb8-493a-90ec-a4244f51ce85
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/22/2019
ms.author: johndeu
ms.openlocfilehash: df2a86dd1292f58511765e842ee97daddcff4e3e
ms.sourcegitcommit: 44e85b95baf7dfb9e92fb38f03c2a1bc31765415
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2019
ms.locfileid: "70102919"
---
# <a name="signaling-timed-metadata-in-live-streaming"></a>Сигнализация метаданных времени в потоковой трансляции 

Последнее обновление: 2019-08-22

### <a name="conformance-notation"></a>Замечание о соответствии

Ключевые слова "НЕОБХОДИМО" ("ДОЛЖНО"), "НЕДОПУСТИМО", "ТРЕБУЕТСЯ", "НУЖНО", "НЕ ПОЗВОЛЯЕТСЯ", "СЛЕДУЕТ" ("ДОЛЖНО"), "НЕ СЛЕДУЕТ", "РЕКОМЕНДУЕТСЯ", "ВОЗМОЖНО" и "НЕОБЯЗАТЕЛЬНО" в данном документе интерпретируются согласно описанию в документе RFC 2119.

## <a name="1-introduction"></a>1. Введение 

Чтобы сообщить о вставке объявлений или пользовательских событий метаданных в клиентский проигрыватель, широковещательные рассылки часто используют метаданные времени, внедренные в видео. Чтобы включить эти сценарии, службы мультимедиа обеспечивают поддержку транспорта метаданных времени из точки приема канала потоковой передачи в клиентское приложение.
В этой спецификации представлено несколько режимов, поддерживаемых службами мультимедиа для метаданных времени в потоковых передачах.

1. [SCTE-35] сигнал, соответствующий стандартам [SCTE-35], [SCTE-214-1], [SCTE-214-3] и [RFC8216]

2. [SCTE-35] сигнал, который соответствует устаревшей спецификации [Adobe-Primetime] для передачи рекламы RTMP.
   
3. Общий режим сигнализации о времени метаданных для сообщений, **не** являющихся [SCTE-35], и может содержать [ID3v2] или другие пользовательские схемы, определенные разработчиком приложения.

## <a name="11-terms-used"></a>1,1. использованные термины

| Термин              | Определение |
|-------------------|------------|
| AD Break          | Расположение или момент времени, в течение которого можно запланировать доставку одной или нескольких рекламных объявлений; то же, что и возможность наличия и возможности размещения. |
| Служба принятия решений AD| Внешняя служба, которая определяет, какие AD (s) и длительности будут отображаться для пользователя. Службы обычно предоставляются партнером и выходят за рамки этого документа.|
| Сказк               | Указание времени и параметров предстоящего разрыва рекламы. Обратите внимание, что подсказки могут указывать на незавершенный переход на AD-Break, ожидание переключения на следующее рекламное объявление в случае разрыва рекламы и ожидающего переключения из рекламного объявления на основное содержимое. |
| Обусловлен          | Службы мультимедиа Azure "конечная точка потоковой передачи" предоставляют динамические возможности упаковки для ТИРЕ и HLS и называются "упаковщиком" в индустрии мультимедиа. 
| Время презентации | Время, когда событие демонстрируется зрителю. Это момент на временной шкале мультимедийного содержимого, когда зритель увидит событие. Например, время презентации командного сообщения SCTE-35 splice_info() — splice_time(). |
| Время получения      | Время поступления сообщения о событии. Обычно это время отличается от времени презентации события, так как сообщения о событии отправляются до его начала.                                     |
| Разреженная дорожка      | Дорожка мультимедиа, которая не является непрерывной и синхронизируется по времени с родительской или контрольной дорожкой.                                                                                                                                    |
| Исходный            | Служба потоковой передачи мультимедиа Azure.                                                                                                                                                                                                |
| Приемник канала      | Служба потоковой передачи мультимедиа в реальном времени Azure.                                                                                                                                                                                           |
| HLS               | Протокол Apple HTTP Live Streaming.                                                                                                                                                                                               |
| DASH              | Динамическая адаптивная потоковая передача по протоколу HTTP.                                                                                                                                                                                             |
| Smooth            | Протокол Smooth Streaming.                                                                                                                                                                                                        |
| MPEG2-TS          | Транспортные потоки MPEG-2.                                                                                                                                                                                                         |
| RTMP              | Протокол мультимедиа в режиме реального времени.                                                                                                                                                                                                    |
| uimsbf            | Целое число без знака, наиболее значимый бит указан первым.                                                                                                                                                                                    |

---

## <a name="12-normative-references"></a>1,2 Нормативные ссылки

В следующих документах содержатся указания, которые, по ссылке в этом тексте, составляют подготовку этого документа. Все документы подлежат пересмотру в соответствии с телом стандартов, и читателям рекомендуется исследовать возможность применения последних выпусков перечисленных ниже документов. Читатели также заносят напоминание о том, что новые выпуски документов, на которые имеются ссылки, могут быть несовместимы с этой версией спецификации метаданных по времени для служб мультимедиа Azure.


|Стандарт  |Определение  |
|---------|---------|
|[Adobe-Primetime] | [Спецификация сигнала для вставки цифровой программы Primetime 1,2](https://www.adobe.com/content/dam/acom/en/devnet/primetime/PrimetimeDigitalProgramInsertionSignalingSpecification.pdf) |
|[Adobe-Flash-AS] | [Справочник по языку ActionScript для FLASH](https://help.adobe.com/archive/en_US/as2/flashlite_2.x_3.x_aslr.pdf) |
| AMF0            | ["Формат сообщения действия AMF0"](https://download.macromedia.com/pub/labs/amf/amf0_spec_121207.pdf) |
| [ТИРЕ — IF-ИСТОЧНИКЕ]     | Многопунктирное руководство по взаимодействию с форумом v 4,2[https://dashif-documents.azurewebsites.net/DASH-IF-IOP/master/DASH-IF-IOP.html](https://dashif-documents.azurewebsites.net/DASH-IF-IOP/master/DASH-IF-IOP.html) |
| [HLS-ТМД]         | Метаданные времени для HTTP Live Streaming-[https://developer.apple.com/streaming](https://developer.apple.com/streaming) |
| [КМАФ-ID3]         | [Метаданные времени в общем формате приложения мультимедиа (КМАФ)](https://aomediacodec.github.io/av1-id3/)
| [ID3v2]           | Тег ID3 версии 2.4.0[http://id3.org/id3v2.4.0-structure](http://id3.org/id3v2.4.0-structure) |
| [ISO-14496-12]    | ISO/IEC 14496-12: Часть 12 базовый формат файла носителя ISO, Фаурседитион 2012-07-15  |
| [МПЕГДАШ]        | Информационные технологии — динамическая Адаптивная потоковая передача по протоколу HTTP (ТИРЕ) — часть 1: Описание презентации мультимедиа и форматы сегментов. 2014 мая. Выпущен. URL-адрес: https://www.iso.org/standard/65274.html |
| [МПЕГКМАФ]        | Информационные технологии — формат мультимедийных приложений (MPEG-A) — часть 19: Общий формат приложения мультимедиа (КМАФ) для сегментированного носителя. 2018 января. Выпущен. URL-адрес: https://www.iso.org/standard/71975.html |
| [МПЕГЦЕНК]        | Информационные технологии — технологии системы MPEG — часть 7. Распространенное шифрование в файлах формата файлов основного носителя ISO. Февраль 2016 г. Выпущен. URL-адрес: https://www.iso.org/standard/68042.html |
| [MS-SSTR]         | ["Microsoft Smooth Streaming Protocol", 15 мая 2014 г.](https://docs.microsoft.com/openspecs/windows_protocols/ms-sstr/8383f27f-7efe-4c60-832a-387274457251) |
| [MS-SSTR-прием]  | [Спецификация приема фрагментированного MP4 в реальном времени в службах мультимедиа Azure](https://docs.microsoft.com/azure/media-services/media-services-fmp4-live-ingest-overview) |
| [RFC8216]         | Тайлер Крой (Tyler Croy), Пантос, ED.; W. Май. HTTP Live Streaming. 2017 августа. Извещен. [https://tools.ietf.org/html/rfc8216](https://tools.ietf.org/html/rfc8216) |
| [RFC4648]         |Кодировки данных Base16, base32 и Base64 —[https://tools.ietf.org/html/rfc4648](https://tools.ietf.org/html/rfc4648) |
| RTMP            |["Протокол обмена сообщениями в реальном времени Adobe, 21 декабря, 2012](https://www.adobe.com/devnet/rtmp.html)  |
| [SCTE-35-2019]    | SCTE 35: 2019 — сообщение cueing для вставки цифровой программы для кабеля. https://www.scte.org/SCTEDocs/Standards/ANSI_SCTE%2035%202019r1.pdf  |
| [SCTE-214-1]      | SCTE 214-1 2016 — MPEG-ТИРЕ для служб кабелей на основе IP, часть 1: Ограничения и расширения MPD |
| [SCTE-214-3]      | SCTE 214-3 2015 MPEG для службы кабелей на основе IP-адресов, часть 3: Профиль ТИРЕ/FF |
| [SCTE-224]        | SCTE 224 2018r1 — планирование событий и интерфейс уведомлений |
| [SCTE-250]        | API управления событиями и сигнализацией (ЕСАМ) |

---


## <a name="2-timed-metadata-ingest"></a>2. Получение метаданных по времени

Службы мультимедиа Azure поддерживают встроенные в реальном времени метаданные для протоколов [RTMP] и Smooth Streaming [MS-SSTR-приема]. Метаданные в реальном времени можно использовать для определения пользовательских событий с собственными уникальными пользовательскими схемами (JSON, binary, XML), а также для отраслевых определенных форматов, таких как ID3, или SCTE-35 для рекламы в широковещательном потоке. 

В этой статье приводятся сведения о том, как отправить настраиваемые сигналы о времени в метаданных с помощью поддерживаемых протоколов приема для служб мультимедиа Azure. В этой статье также объясняется, как в манифестах для HLS, ТИРЕ и Smooth Streaming были добавлены сигналы времени метаданных, а также способ их передачи при доставке содержимого с помощью КМАФ (фрагментов MP4) или сегментов транспортного потока (TS) для HLS. 

Распространенные сценарии вариантов использования для метаданных со временем включают:

 - SCTE-35 AD сигнализирует о необходимости активации рекламы в интерактивном событии или линейной трансляции
 - Пользовательские метаданные ID3, которые могут активировать события в клиентском приложении (браузер, iOS или Android)
 - Пользовательские определенные метаданные JSON, binary или XML для активации событий в клиентском приложении
 - Данные телеметрии из динамического кодировщика, IP-камеры или помощью Дронов
 - События из IP-камеры, такие как перемещение, обнаружение лиц и т. д.
 - Сведения о географическом положении из камеры действия, помощью дронов или перемещающегося устройства
 - Песни песен
 - Границы программы в линейном динамическом канале
 - Изображения или дополнительные метаданные, отображаемые в активном канале
 - Сведения о спортивных показателях или часах игры
 - Интерактивные рекламные пакеты, отображаемые вместе с видео в браузере
 - Тесты или опросы
  
Динамические события и упаковщик служб мультимедиа Azure могут получать эти сигналы с превышением времени и преобразовывать их в поток метаданных, который может обращаться к клиентским приложениям с помощью протоколов на основе стандартов, таких как HLS и ТИРЕ.


## <a name="21-rtmp-timed-metadata"></a>2,1. метаданные времени ожидания RTMP

Протокол [RTMP] позволяет отправлять сигналы времени метаданных для различных сценариев, включая пользовательские метаданные, и сигналы SCTE-35 AD. 

Рекламные сигналы (сообщения подсказки) отправляются как сообщения подсказок [AMF0], внедренные в поток [RTMP]. Сообщения о подсказке могут быть отправлены в любое время до наступления фактического события или сигнала объединения AD [SCTE35]. Для поддержки этого сценария в сообщении подсказки отправляется фактическая отметка времени представления события. Чтобы получить дополнительные сведения, ознакомьтесь с [AMF0].

Следующие команды [AMF0] поддерживаются службами мультимедиа Azure для приема RTMP:

- **онусердатаевент** — используется для пользовательских метаданных или метаданных времени [ID3v2].
- **onAdCue** — используется в основном для сигнализации возможности размещения объявления в активном потоке. Поддерживаются две формы подсказки: простой режим и режим "SCTE-35". 
- **онкуепоинт** — поддерживается определенными локальными аппаратными кодировщиками, такими как закрывающий динамический кодировщик, для сигнализации сообщений [SCTE35]. 
  

В следующих таблицах описывается формат полезных данных сообщения AMF, которые службы мультимедиа будут принимать для режимов сообщений "Simple" и [SCTE35].

Имя сообщения [AMF0] можно использовать для различения нескольких потоков событий одного типа.  Для сообщений [SCTE-35] и простого режима имя сообщения AMF должно быть "onAdCue" в соответствии с требованиями спецификации [Adobe-Primetime].  Все поля, не перечисленные ниже, будут игнорироваться службами мультимедиа Azure во время приема.

## <a name="211-rtmp-with-custom-metadata-using-onuserdataevent"></a>стандарт RTMP с пользовательскими метаданными с помощью "Онусердатаевент"

Если вы хотите предоставить пользовательские каналы метаданных из вышестоящего кодировщика, IP-камеры, помощью дронов или устройства с помощью протокола RTMP, используйте тип команды сообщения Онусердатаевент [AMF0].

Команда сообщения **"онусердатаевент"** должна содержать полезные данные сообщения со следующим определением, которые должны быть захвачены службами мультимедиа и упакованы в файл в основном формате, а также манифесты для HLS, тире и Smooth Streaming.
Рекомендуется отсылать сообщения с превышением времени, но не чаще, чем раз в 0,5 секунд (500 мс) или из-за стабильности в реальном потоке. Каждое сообщение может объединять метаданные из нескольких кадров, если необходимо предоставить метаданные на уровне кадров. При отправке потоков с несколькими скоростями рекомендуется также предоставлять метаданные только с одной скоростью, чтобы уменьшить пропускную способность и избежать помех с помощью обработки видео и аудио. 

Полезная нагрузка для **"онусердатаевент"** должна быть сообщением формата XML [Мпегдаш] EventStream. Это упрощает передачу пользовательских определенных схем, которые могут быть перенесены в полезные данные "EMSG" для КМАФ [МПЕГКМАФ], которые доставляются по протоколам HLS или ТИРЕ. Каждое сообщение потока событий ТИРЕ содержит Счемеидури, который функционирует как идентификатор схемы сообщения URN и определяет полезную нагрузку сообщения. Некоторые схемы, например "https://aomedia.org/emsg/ID3" для [ID3v2] или **urn: SCTE: scte35:2013: bin** для [SCTE-35], стандартизованы в отрасли консортиа для взаимодействия. Любой поставщик приложения может определить собственную пользовательскую схему, используя URL-адрес, которым они управляют (владелец домена), и может предоставить спецификацию по этому URL-адресу, если они выбраны. Если у игрока есть обработчик для определенной схемы, то это единственный компонент, который должен понимать полезную нагрузку и протокол.

Схема для полезных данных XML [MPEG-ТИРЕ] EventStream определяется как (фрагмент из ТИРЕ ISO-IEC-23009-1-Третий выпуск). Обратите внимание, что в настоящее время поддерживается только один тип "EventType" для "EventStream". Если в **EventStream**указано несколько событий, будет обработано только первый элемент **события** .

```xml
  <!-- Event Stream -->
  <xs:complexType name="EventStreamType">
    <xs:sequence>
      <xs:element name="Event" type="EventType" minOccurs="0" maxOccurs="unbounded"/>
      <xs:any namespace="##other" processContents="lax" minOccurs="0" maxOccurs="unbounded"/>
    </xs:sequence>
    <xs:attribute ref="xlink:href"/>
    <xs:attribute ref="xlink:actuate" default="onRequest"/>
    <xs:attribute name="schemeIdUri" type="xs:anyURI" use="required"/>
    <xs:attribute name="value" type="xs:string"/>
    <xs:attribute name="timescale" type="xs:unsignedInt"/>
  </xs:complexType>
  <!-- Event  -->
  <xs:complexType name="EventType">
    <xs:sequence>
      <xs:any namespace="##other" processContents="lax" minOccurs="0" maxOccurs="unbounded"/>
    </xs:sequence>
    <xs:attribute name="presentationTime" type="xs:unsignedLong" default="0"/>
    <xs:attribute name="duration" type="xs:unsignedLong"/>
    <xs:attribute name="id" type="xs:unsignedInt"/>
    <xs:attribute name="contentEncoding" type="ContentEncodingType"/>
    <xs:attribute name="messageData" type="xs:string"/>
    <xs:anyAttribute namespace="##other" processContents="lax"/>
  </xs:complexType>
```


### <a name="example-xml-event-stream-with-id3-schema-id-and-base64-encoded-data-payload"></a>Пример потока событий XML с ИДЕНТИФИКАТОРом схемы ID3 и полезной нагрузкой данных в кодировке Base64.  
```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <EventStream schemeIdUri="https://aomedia.org/emsg/ID3">
         <Event contentEncoding="Base64">
          -- base64 encoded ID3v2 full payload here per [CMAF-TMD] --
         </Event>
   <EventStream>
```

### <a name="example-event-stream-with-custom-schema-id-and-base64-encoded-binary-data"></a>Пример потока событий с ИДЕНТИФИКАТОРом пользовательской схемы и двоичными данными в кодировке Base64  
```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <EventStream schemeIdUri="urn:example.org:custom:binary">
         <Event contentEncoding="Base64">
          -- base64 encoded custom binary data message --
         </Event>
   <EventStream>
```

### <a name="example-event-stream-with-custom-schema-id-and-custom-json"></a>Пример потока событий с идентификатором пользовательской схемы и пользовательским кодом JSON  
```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <EventStream schemeIdUri="urn:example.org:custom:JSON">
         <Event>
          [
            {"key1" : "value1"},
            {"key2" : "value2"}
          ]
         </Event>
   <EventStream>
```

### <a name="built-in-supported-scheme-id-uris"></a>Встроенные поддерживаемые URI ИДЕНТИФИКАТОРов схем
| URI идентификатора схемы                 |  Описание                                             |
|-------------------------------|----------------------------------------------------------|
| HTTPS:\//aomedia.org/EMSG/ID3   | Описывает, как можно переносить метаданные [ID3v2] в качестве метаданных времени в КМАФ-совместимом [МПЕГКМАФ] фрагментированном формате MP4. Дополнительные сведения см. в разделе [метаданные времени в стандартном формате приложения мультимедиа (кмаф)](https://aomediacodec.github.io/av1-id3/) . |

### <a name="event-processing-and-manifest-signaling"></a>Обработка событий и сигнализация манифеста

При получении допустимого события **"онусердатаевент"** службы мультимедиа Azure будут искать допустимые полезные данные XML, которые соответствуют евентстреамтипе (определенному в [мпегдаш]), анализируют полезные данные XML и преобразуют их в поле [мпегкмаф] с фрагментом MP4 "EMSG" версии 1 для хранение в динамическом архиве и передача в упаковщик служб мультимедиа.   Упаковщик обнаружит поле "EMSG" в динамическом потоке и:

- (а) "динамически упаковывать" в сегменты служб терминалов для доставки клиентам HLS в соответствии со спецификацией HLS метаданных [HLS-ТМД].
- (б) передать его через для доставки в КМАФ фрагментах через HLS или ТИРЕ или 
- (c) преобразуйте его в сигнал разреженной передачи для доставки с помощью Smooth Streaming [MS-SSTR].

В дополнение к стандартному формату "EMSG" КМАФ или протоколам TS для HLS, манифесты для ТИРЕ (MPD) и Smooth Streaming будут содержать ссылку на потоки событий с внутренним каналом (также известный как разреженный потоковый мониторинг в Smooth Streaming). 

Отдельные события или их полезные данные не выводятся непосредственно в манифесте HLS, ТИРЕ или Smooth. 

### <a name="additional-informational-constraints-and-defaults-for-onuserdataevent-events"></a>Дополнительные информационные ограничения и значения по умолчанию для событий Онусердатаевент

- Если шкала времени не задана в элементе EventStream, по умолчанию используется шкала RTMP 1 кГц.
- Доставка сообщения Онусердатаевент ограничивается каждые 500 мс. Если события отправляются чаще, это может повлиять на пропускную способность и стабильность интерактивного канала.

## <a name="212-rtmp-ad-cue-signaling-with-oncuepoint"></a>2.1.2 RTMP AD Cue с "Онкуепоинт"

Службы мультимедиа Azure могут прослушивать несколько типов сообщений [AMF0] и реагировать на них, которые могут использоваться для передачи в поток данных различных синхронизированных метаданных в реальном времени.  Спецификация [Adobe-Primetime] определяет два типа подсказок, которые называются "простыми" и "SCTE-35". В режиме "простой" службы мультимедиа поддерживают одно сообщение AMF Cue с именем "onAdCue", используя полезные данные, которые соответствуют таблице ниже, определенной для сигнала "простой режим".  

В следующем разделе представлены полезные данные "простой" режим "RTMP", которые можно использовать для сигнализации основного сигнала рекламы "Сплицеаут", который будет перенесен в манифест клиента для HLS, ТИРЕ и Microsoft Smooth Streaming. Это очень полезно в сценариях, где у клиента нет сложной системы SCTE-35 на основе сигнализации или развернутой службы, которая использует базовый локальный кодировщик для отправки сообщения подсказки через API. Как правило, локальный кодировщик будет поддерживать API на основе RESTFUL для активации этого сигнала, который также будет "присоединить" к видеопотоку, вставив кадр IDR в видео и запуская новый GOP.

## <a name="213--rtmp-ad-cue-signaling-with-oncuepoint---simple-mode"></a>сигнал 2.1.3 RTMP AD Cue с "Онкуепоинт" — простой режим

| Имя поля | Тип поля | Обязательный? | Описания                                                                                                             |
|------------|------------|----------|--------------------------------------------------------------------------------------------------------------------------|
| cue        | Строковое     | Обязательное значение | Сообщение о событии.  Должно иметь значение SpliceOut, чтобы иметь возможность назначить соединение в простом режиме.                                              |
| id         | Строковое     | Обязательное значение | Уникальный идентификатор, описывающий соединение или сегмент. Определяет экземпляр сообщения.                            |
| duration   | Number     | Обязательное значение | Длительность соединения. Единицы измерения — доли секунды.                                                                |
| elapsed    | Number     | Необязательный | Если сигнал повторяется для поддержки настройки, это поле должно отображать количество времени презентации, которое прошло с момента начала соединения. Единицы измерения — доли секунды. В простом режиме это значение не должно превышать первоначальную длительность соединения.                                                  |
| time       | Number     | Обязательное значение | Должно соответствовать времени соединения в рамках времени презентации. Единицы измерения — доли секунды.                                     |

---
 
## <a name="214-rtmp-ad-cue-signaling-with-oncuepoint---scte-35-mode"></a>сигнал 2.1.4 RTMP AD Cue с режимом "Онкуепоинт" — SCTE-35

При работе с более сложным производственным рабочим процессом вещания, требующем передачи полного сообщения полезных данных SCTE-35 в манифест HLS или ТИРЕ, лучше всего использовать режим SCTE-35 в спецификации [Adobe-Primetime].  Этот режим поддерживает сигналы SCTE-35, отправляемые непосредственно в локальный динамический кодировщик, который затем кодирует сигналы в поток RTMP, используя режим SCTE-35, указанный в спецификации [Adobe-Primetime]. 

Как правило, сообщения SCTE-35 могут появляться только в входных данных транспортного потока MPEG-2 (TS) в локальном кодировщике. Чтобы узнать, как настроить прием транспортного потока, содержащий SCTE-35, и включить его для передачи в RTMP в режиме Adobe SCTE-35, обратитесь к изготовителю кодировщика.

В этом сценарии следующие полезные данные должны быть отправлены из локального кодировщика с помощью типа сообщений **"onAdCue"** [AMF0].

| Имя поля | Тип поля | Обязательный? | Описания                                                                                                             |
|------------|------------|----------|--------------------------------------------------------------------------------------------------------------------------|
| cue        | Строковое     | Обязательное значение | Сообщение о событии.  Для сообщений [SCTE-35] это должен быть двоичный splice_info_section (RFC4648) в кодировке Base64, чтобы сообщения отправлялись клиентам HLS, Smooth и тире.                                              |
| type       | Строковое     | Обязательное значение | URN или URL-адрес, определяющий схему сообщения. Для сообщений [SCTE-35] это **должно** быть **"scte35"** , чтобы сообщения отправлялись клиентам HLS, Smooth и тире в соответствии с [Adobe-Primetime]. Кроме того, URN-имя URN: SCTE: scte35:2013: bin может также использоваться для сигнализации сообщения [SCTE – 35]. |
| id         | Строковое     | Обязательное значение | Уникальный идентификатор, описывающий соединение или сегмент. Определяет экземпляр сообщения.  Сообщения с одинаковой семантикой должны иметь одно и то же значение.|
| duration   | Number     | Обязательное значение | Длительность события или сегмента добавления рекламы (если она известна). Если значение неизвестно, **должно** быть равно 0.                                                                 |
| elapsed    | Number     | Необязательный | Если сигнал рекламы [SCTE-35] повторяется для настройки, это поле должно отображать количество времени презентации, которое прошло с момента начала соединения. Единицы измерения — доли секунды. В режиме [SCTE-35] это значение может превышать исходную указанную длительность соединения или сегмента.                                                  |
| time       | Number     | Обязательное значение | Время презентации события или вставки рекламы.  Время и длительность презентации **должны** быть согласованы с точками доступа к потоку (SAP) типа 1 или 2, как определено в приложении [ISO-14496-12] I. Для исходящего исходящего трафика HLS время и длительность **должны** соответствовать границам сегмента. Время презентации и длительность различных сообщений о событии в одном потоке событий НЕ ДОЛЖНЫ перекрываться. Единицы измерения — доли секунды.

---
## <a name="215-rtmp-ad-signaling-with-oncuepoint-for-elemental-live"></a>2.1.5 RTMP AD с "Онкуепоинт" для интерактивного динамического

Интерактивный локальный кодировщик поддерживает маркеры AD в сигнале RTMP. Сейчас службы мультимедиа Azure поддерживают только тип маркера AD "Онкуепоинт" для RTMP.  Это можно включить в параметрах группы Adobe RTMP в параметрах или интерфейсе API для параметров динамического кодировщика мультимедиа, установив для "**ad_markers**" значение "онкуепоинт".  Дополнительные сведения см. в документации по элементу Live. Включение этой функции в группе RTMP передаст сигналы SCTE-35 в выходные данные Adobe RTMP для обработки службами мультимедиа Azure.

Тип сообщений "Онкуепоинт" определен в [Adobe-Flash-AS] и имеет следующую структуру полезных данных при отправке из одноэлементного динамического потока RTMP.


| Свойство  |Описание  |
|---------|---------|
|  name     | Имя должно быть "**scte35**" с помощью элемента Live. |
|time     |  Время в секундах, в течение которого была обнаружена контрольная точка в видеофайле во время временной шкалы |
| type     | Для типа контрольной точки должно быть задано значение "**event**". |
| параметры | Ассоциативный массив строк пар "имя-значение", содержащий сведения из сообщения SCTE-35, включая идентификатор и длительность. Эти значения анализируются службами мультимедиа Azure и включаются в тег декорирования манифеста.  |


Если используется этот режим маркера AD, выходные данные манифеста HLS похожи на обычный режим Adobe. 

### <a name="216-cancellation-and-updates"></a>Отмена и обновление 2.1.6

Сообщения можно отменить или обновить, отправив несколько сообщений с одинаковым временем и идентификатором презентации. Время и идентификатор презентации уникально идентифицируют событие, а последнее сообщение, полученное для конкретного времени презентации, которое соответствует ограничениям до начала просмотра, — это сообщение, в отношении которого выполняются действия. Обновленное событие заменяет любые сообщения, полученные ранее. Ограничение до начала просмотра — четыре секунды. Сообщения, полученные хотя бы на четыре секунды раньше времени презентации, будут обрабатываться.

## <a name="22-fragmented-mp4-ingest-smooth-streaming"></a>2.2. Прием фрагментированного MP4 (Smooth Streaming)

Требования для приема в реальном потоке см. в [MS-SSTR-приеме]. В следующих разделах содержатся сведения о получении метаданных времени презентации.  Метаданные времени презентации принимаются как разреженная дорожка, которая определена в поле манифеста сервера прямой передачи (см. MS-SSTR) и поле фильма (moov).  

Каждый разреженный фрагмент состоит из поля фрагмента фильма (moof) и поля данных мультимедиа (mdat), где поле mdat — это двоичное сообщение.

Чтобы обеспечить точную вставку рекламных объявлений, кодировщик должен разбить фрагмент на время презентации, где требуется вставить подсказку.  НЕОБХОДИМО создать новый фрагмент, который начинается с вновь созданного кадра IDR или точек доступа к потоку (SAP) типа 1 или 2, как определено в приложении [ISO-14496-12] I. Это позволяет упаковщику мультимедиа Azure правильно создать манифест HLS и многофакторный манифест многопериодического ТИРЕ, в котором новый период начинается с подсчета времени представления с точностью в зависимости от кадра.

### <a name="221-live-server-manifest-box"></a>2.2.1. Поле манифеста сервера прямой передачи

Разреженная запись **должна** быть объявлена в поле манифеста Live Server с **\<\>** записью TextStream и иметь следующие атрибуты:

| **Имя атрибута** | **Тип поля** | **Обязательный?** | **Описание**                                                                                                                                                                                                                                                 |
|--------------------|----------------|---------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| systemBitrate      | Number         | Обязательное значение      | Значение **должно** быть равно "0", что указывает на запись с неизвестным переменным скоростью.                                                                                                                                                                                                 |
| parentTrackName    | Строковое         | Обязательное значение      | **Должно** быть именем родительской записи, для которой коды времени разреженной записи имеют значение по шкале времени. Родительская дорожка не может быть разреженной.                                                                                                                    |
| manifestOutput     | логический        | Обязательное значение      | **Должен** иметь значение "true", чтобы указать, что разреженная запись будет внедрена в манифест Smooth Client.                                                                                                                                                               |
| Subtype            | Строковое         | Обязательное значение      | Это **должен** быть 4 код СИМВОЛА "Data".                                                                                                                                                                                                                        |
| Схема             | Строковое         | Обязательное значение      | Это **должен** быть URN или URL-адрес, идентифицирующий схему сообщения. Для сообщений [SCTE-35] это **должно** быть "urn: SCTE: scte35:2013: bin", чтобы сообщения отправлялись клиентам HLS, Smooth и тире в соответствии с [SCTE-35]. |
| trackName          | Строковое         | Обязательное значение      | **Должно** быть именем разреженной записи. Атрибут trackName можно использовать для дифференциации нескольких потоков событий в одной схеме. Каждый уникальный поток событий **должен** иметь уникальное имя записи.                                                                           |
| timescale          | Number         | Необязательный      | **Должна** быть шкала времени родительской записи.                                                                                                                                                                                                                      |

---

### <a name="222-movie-box"></a>2.2.2. Поле фильма

Поле фильма (moov) соответствует полю манифеста сервера прямой передачи как часть заголовка потока для родительской дорожки.

Поле "Moov" **должно** содержать поле **траккхеадербокс (' ткхд ')** , как определено в [ISO-14496-12] со следующими ограничениями:

| **Имя поля** | **Тип поля**          | **Обязательный?** | **Описание**                                                                                                |
|----------------|-------------------------|---------------|----------------------------------------------------------------------------------------------------------------|
| duration       | 64-разрядное целое число без знака | Обязательное значение      | **Должно** быть равно 0, так как поле Track имеет нулевые выборки, а общая длительность выборок в поле Track равна 0. |

---

Поле "Moov" **должно** содержать **хандлербокс (' хдлр ')** , как определено в [ISO-14496-12] со следующими ограничениями:

| **Имя поля** | **Тип поля**          | **Обязательный?** | **Описание**   |
|----------------|-------------------------|---------------|-------------------|
| handler_type   | 32-разрядное целое число без знака | Обязательное значение      | **Должно** быть "META". |

---

Поле "стсд" **должно** содержать поле метадатасамплинтри с именем кода, как определено в [ISO-14496-12].  Например, для сообщений SCTE-35 имя кода **должно** быть "SCTE".

### <a name="223-movie-fragment-box-and-media-data-box"></a>2.2.3. Поле фрагмента фильма и поле данных мультимедиа

Фрагменты разреженной дорожки содержат поле фрагмента фильма (moof) и поле данных мультимедиа (mdat).

> [!NOTE]
> Чтобы обеспечить точную вставку рекламных объявлений, кодировщик должен разбить фрагмент на время презентации, где требуется вставить подсказку.  ДОЛЖЕН быть создан новый фрагмент, который начинается с вновь созданного кадра IDR или точек доступа к потоку (SAP) типа 1 или 2, как определено в приложении [ISO-14496-12] I
> 

Поле MovieFragmentBox (' moof ') **должно** содержать **TrackFragmentExtendedHeaderBox (' UUID ')** , как определено в [MS-SSTR], со следующими полями:

| **Имя поля**         | **Тип поля**          | **Обязательный?** | **Описание**                                                                               |
|------------------------|-------------------------|---------------|-----------------------------------------------------------------------------------------------|
| fragment_absolute_time | 64-разрядное целое число без знака | Обязательное значение      | **Должно** быть временем прибытия события. Это значение согласовывает сообщение с родительской дорожкой.   |
| fragment_duration      | 64-разрядное целое число без знака | Обязательное значение      | **Должно** быть длительностью события. Длительность может иметь значение 0. Это значит, что длительность неизвестна. |

---


Поле Медиадатабокс (' mdat ') **должно** иметь следующий формат:

| **Имя поля**          | **Тип поля**                   | **Обязательный?** | **Описание**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|-------------------------|----------------------------------|---------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| version                 | 32-разрядное целое число без знака (uimsbf) | Обязательное значение      | Определяет формат содержимого поля mdat. Нераспознанные версии будут игнорироваться. Сейчас поддерживается только версия 1.                                                                                                                                                                                                                                                                                                                                                      |
| id                      | 32-разрядное целое число без знака (uimsbf) | Обязательное значение      | Определяет экземпляр сообщения. Сообщения с одинаковой семантикой должны иметь одинаковое значение. Поэтому обработки любого поля сообщения о событии с одинаковым идентификатором будет достаточно.                                                                                                                                                                                                                                                                                                            |
| presentation_time_delta | 32-разрядное целое число без знака (uimsbf) | Обязательное значение      | Сумма fragment_absolute_time, указанная в TrackFragmentExtendedHeaderBox и presentation_time_delta, **должна** быть временем представления события. Время и длительность презентации **должны** быть согласованы с точками доступа к потоку (SAP) типа 1 или 2, как определено в приложении [ISO-14496-12] I. Для исходящего исходящего трафика HLS время и длительность **должны** соответствовать границам сегмента. Время презентации и длительность различных сообщений о событиях в одном потоке событий не **должны** перекрываться. |
| message                 | массив байтов;                       | Обязательное значение      | Сообщение о событии. Для сообщений [SCTE-35] сообщение является двоичным splice_info_section (). Для сообщений [SCTE-35] это **должен** быть splice_info_section (), чтобы сообщения отправлялись клиентам HLS, Smooth и тире в соответствии с [SCTE-35]. Для сообщений [SCTE-35] двоичный splice_info_section () является полезной нагрузкой в поле mdat и **не** кодируется в Base64.                                                            |

---


### <a name="224-cancellation-and-updates"></a>2.2.4. Отмена и обновления

Сообщения можно отменить или обновить, отправив несколько сообщений с одинаковым временем и идентификатором презентации.  Время и идентификатор презентации уникально идентифицируют событие. Последнее сообщение, полученное для конкретного времени презентации, которое соответствует ограничениям до начала просмотра, — это сообщение, в отношении которого выполняются действия. Обновленное сообщение заменяет любые сообщения, полученные ранее.  Ограничение до начала просмотра — четыре секунды. Сообщения, полученные хотя бы на четыре секунды раньше времени презентации, будут обрабатываться. 


## <a name="3-timed-metadata-delivery"></a>3\. Доставка метаданных времени

Данные потока событий являются непрозрачными для служб мультимедиа. Службы мультимедиа просто передают три элемента информации между конечной точкой приема и клиента. Следующие свойства доставляются клиенту в соответствии с [SCTE-35] и (или) протоколом потоковой передачи клиента:

1.  Схема — URN или URL-адрес, определяющий схему сообщения.
2.  Время презентации — время презентации события на временной шкале мультимедийного содержимого.
3.  Длительность — длительность события.
4.  Идентификатор — дополнительный уникальный идентификатор события.
5.  Сообщение — данные события.

## <a name="31-microsoft-smooth-streaming-manifest"></a>3,1 манифест Microsoft Smooth Streaming  

Дополнительные сведения о форматировании разреженных сообщений см. в разделе Обработка разреженных записей [MS-SSTR]. Для сообщений [SCTE35] Smooth Streaming выводит Base64-кодирование splice_info_section () в разреженный фрагмент.
Стреаминдекс **должен** иметь ПОДТИП "Data", а CustomAttributes **должен** содержать атрибут с именем = "Schema" и значением = "urn: SCTE: scte35:2013: bin".

#### <a name="smooth-client-manifest-example-showing-base64-encoded-scte35-splice_info_section"></a>Пример сглаживания манифеста клиента с кодировкой base64 [SCTE35] splice_info_section ()
~~~ xml
<?xml version=”1.0” encoding=”utf-8”?>
<SmoothStreamingMedia MajorVersion=”2” MinorVersion=”0” TimeScale=”10000000” IsLive=”true” Duration=”0”
  LookAheadFragmentCount=”2” DVRWindowLength=”6000000000”>

  <StreamIndex Type=”video” Name=”video” Subtype=”” Chunks=”0” TimeScale=”10000000”
    Url=”QualityLevels({bitrate})/Fragments(video={start time})”>
    <QualityLevel Index=”0” Bitrate=”230000”
      CodecPrivateData=”250000010FC3460B50878A0B5821FF878780490800704704DC0000010E5A67F840” FourCC=”WVC1”
      MaxWidth=”364” MaxHeight=”272”/>
    <QualityLevel Index=”1” Bitrate=”305000”
      CodecPrivateData=”250000010FC3480B50878A0B5821FF87878049080894E4A7640000010E5A67F840” FourCC=”WVC1”
      MaxWidth=”364” MaxHeight=”272”/>
    <c t=”0” d=”20000000” r=”300” />
  </StreamIndex>
  <StreamIndex Type=”audio” Name=”audio” Subtype=”” Chunks=”0” TimeScale=”10000000”
    Url=”QualityLevels({bitrate})/Fragments(audio={start time})”>
    <QualityLevel Index=”0” Bitrate=”96000” CodecPrivateData=”1000030000000000000000000000E00042C0”
      FourCC=”WMAP” AudioTag=”354” Channels=”2” SamplingRate=”44100” BitsPerSample=”16” PacketSize=”4459”/>
    <c t=”0” d=”20000000” r=”300” />
  </StreamIndex>
  <StreamIndex Type=”text” Name=”scte35-sparse-stream” Subtype=”DATA” Chunks=”0” TimeScale=”10000000”
    ParentStreamIndex=”video” ManifestOutput=”true” 
    Url=”QualityLevels({bitrate})/Fragments(captions={start time})”>
    <QualityLevel Index=”0” Bitrate=”0” CodecPrivateData=”” FourCC=””>
      <CustomAttributes>
        <Attribute Name=”Scheme” Value=”urn:scte:scte35:2013:bin”/>
      </CustomAttributes>
    </QualityLevel>
    <!-- The following <c> and <f> fragments contains the base64-encoded [SCTE35] splice_info_section() message -->
    <c t=”600000000” d=”300000000”>    <f>PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48QWNxdWlyZWRTaWduYWwgeG1sbnM9InVybjpjYWJsZWxhYnM6bWQ6eHNkOnNpZ25hbGluZzozLjAiIGFjcXVpc2l0aW9uUG9pbnRJZGVudGl0eT0iRVNQTl9FYXN0X0FjcXVpc2l0aW9uX1BvaW50XzEiIGFjcXVpc2l0aW9uU2lnbmFsSUQ9IjRBNkE5NEVFLTYyRkExMUUxQjFDQTg4MkY0ODI0MDE5QiIgYWNxdWlzaXRpb25UaW1lPSIyMDEyLTA5LTE4VDEwOjE0OjI2WiI+PFVUQ1BvaW50IHV0Y1BvaW50PSIyMDEyLTA5LTE4VDEwOjE0OjM0WiIvPjxTQ1RFMzVQb2ludERlc2NyaXB0b3Igc3BsaWNlQ29tbWFuZFR5cGU9IjUiPjxTcGxpY2VJbnNlcnQgc3BsaWNlRXZlbnRJRD0iMzQ0NTY4NjkxIiBvdXRPZk5ldHdvcmtJbmRpY2F0b3I9InRydWUiIHVuaXF1ZVByb2dyYW1JRD0iNTUzNTUiIGR1cmF0aW9uPSJQVDFNMFMiIGF2YWlsTnVtPSIxIiBhdmFpbHNFeHBlY3RlZD0iMTAiLz48L1NDVEUzNVBvaW50RGVzY3JpcHRvcj48U3RyZWFtVGltZXM+PFN0cmVhbVRpbWUgdGltZVR5cGU9IkhTUyIgdGltZVZhbHVlPSI1MTUwMDAwMDAwMDAiLz48L1N0cmVhbVRpbWVzPjwvQWNxdWlyZWRTaWduYWw+</f>
    </c>
    <c t=”1200000000” d=”400000000”>      <f>PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48QWNxdWlyZWRTaWduYWwgeG1sbnM9InVybjpjYWJsZWxhYnM6bWQ6eHNkOnNpZ25hbGluZzozLjAiIGFjcXVpc2l0aW9uUG9pbnRJZGVudGl0eT0iRVNQTl9FYXN0X0FjcXVpc2l0aW9uX1BvaW50XzEiIGFjcXVpc2l0aW9uU2lnbmFsSUQ9IjRBNkE5NEVFLTYyRkExMUUxQjFDQTg4MkY0ODI0MDE5QiIgYWNxdWlzaXRpb25UaW1lPSIyMDEyLTA5LTE4VDEwOjE0OjI2WiI+PFVUQ1BvaW50IHV0Y1BvaW50PSIyMDEyLTA5LTE4VDEwOjE0OjM0WiIvPjxTQ1RFMzVQb2ludERlc2NyaXB0b3Igc3BsaWNlQ29tbWFuZFR5cGU9IjUiPjxTcGxpY2VJbnNlcnQgc3BsaWNlRXZlbnRJRD0iMzQ0NTY4NjkxIiBvdXRPZk5ldHdvcmtJbmRpY2F0b3I9InRydWUiIHVuaXF1ZVByb2dyYW1JRD0iNTUzNTUiIGR1cmF0aW9uPSJQVDFNMFMiIGF2YWlsTnVtPSIxIiBhdmFpbHNFeHBlY3RlZD0iMTAiLz48L1NDVEUzNVBvaW50RGVzY3JpcHRvcj48U3RyZWFtVGltZXM+PFN0cmVhbVRpbWUgdGltZVR5cGU9IkhTUyIgdGltZVZhbHVlPSI1MTYyMDAwMDAwMDAiLz48L1N0cmVhbVRpbWVzPjwvQWNxdWlyZWRTaWduYWw+</f>
    </c>
  </StreamIndex>
</SmoothStreamingMedia>
~~~

## <a name="32-apple-hls-manifest-decoration"></a>3,2. Оформление манифеста Apple HLS

Службы мультимедиа Azure поддерживают следующие теги манифеста HLS для сигнализации сведений о рекламном проходе в реальном времени или в рамках события по требованию. 

- EXT-X-DATERANGE, как определено в Apple HLS [RFC8216]
- EXT-X-CUE, как определено в [Adobe-Primetime]. Этот режим считается устаревшим. По возможности клиенты должны принять тег EXT-X-DATERANGE.

Выходные данные каждого тега будут зависеть от используемого режима приема сигнала. Например, RTMP, принимающий простой режим Adobe, не содержит полные полезные данные SCTE-35 в кодировке Base64.

## <a name="321-apple-hls-with-adobe-primetime-ext-x-daterange-recommended"></a>3.2.1 Apple HLS с Adobe Primetime EXT-X-DATERANGE (рекомендуется)

Спецификация Apple HTTP Live Streaming [RFC8216] позволяет оповещать сообщения [SCTE-35]. Сообщения вставляются в список воспроизведения сегментов в разделе EXT-X-DATERANGE Tag for [RFC8216], озаглавленном "сопоставление SCTE-35 в EXT-X-DATERANGE".  Уровень клиентского приложения может анализировать список воспроизведения M3U и обрабатывать теги M3U, а также принимать события с помощью платформы Apple Player.  

**Рекомендуемый** подход в службах мультимедиа Azure (API версии 3) — подписаться на [RFC8216] и использовать тег ext-X_DATERANGE для [SCTE35] "ad", в манифесте.

## <a name="322-apple-hls-with-adobe-primetime-ext-x-cue-legacy"></a>3.2.2 Apple HLS with Adobe Primetime EXT-X-CUE (устаревшая)

Кроме того, в службах мультимедиа Azure (версии 2 и 3 API) существует реализация "Legacy", которая использует тег EXT-X-CUE, как определено в [Adobe-Primetime] "SCTE-35 Mode". В этом режиме службы мультимедиа Azure внедряют Base64-кодировку [SCTE-35] splice_info_section () в теге EXT-X-CUE.  

Тег "Legacy" EXT-X-CUE определяется как приведенный ниже, а также может быть указан в спецификации [Adobe-Primetime]. Этот параметр следует использовать только для устаревшей сигнализации SCTE35, если это необходимо, в противном случае рекомендуемый тег определяется в [RFC8216] как EXT-X-DATERANGE. 

| **Имя атрибута** | **Тип**                      | **Обязательный?**                             | **Описание**                                                                                                                                                                                                                                                                      |
|--------------------|-------------------------------|-------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| CUE                | строка в кавычках                 | Обязательное значение                                  | Сообщение кодируется в виде строки в кодировке Base64, как описано в [RFC4648]. Для сообщений [SCTE-35] это splice_info_section в кодировке Base64 ().                                                                                                |
| ТИП               | строка в кавычках                 | Обязательное значение                                  | URN или URL-адрес, определяющий схему сообщения. Для сообщений [SCTE-35] тип имеет особое значение scte35.                                                                                                                                |
| id                 | строка в кавычках                 | Обязательное значение                                  | Уникальный идентификатор события. Если идентификатор не указан при принятии сообщения, службы мультимедиа Azure создадут уникальный идентификатор.                                                                                                                                          |
| DURATION           | десятичное число с плавающей запятой | Обязательное значение                                  | Длительность события. Если значение неизвестно, **должно** быть равно 0. Единицы измерения — доли секунды.                                                                                                                                                                                           |
| ELAPSED            | десятичное число с плавающей запятой | Необязательно, но требуется для скользящего окна | Когда сигнал повторяется для поддержки скользящего окна презентации, это поле **должно** быть объемом времени презентации, истекшего с момента начала события. Единицы измерения — доли секунды. Это значение может превышать исходную указанную длительность соединения или сегмента. |
| TIME               | десятичное число с плавающей запятой | Обязательное значение                                  | Время презентации события. Единицы измерения — доли секунды.                                                                                                                                                                                                                    |


Прикладной уровень проигрывателя HLS будет использовать ТИП для определения формата сообщения, декодирования сообщения, применения необходимых преобразований времени и обработки события.  События синхронизируются по времени в списке воспроизведений сегмента родительской дорожки в соответствии с меткой времени события.  Они вставляются перед ближайшим сегментом (тег #EXTINF).

### <a name="323-hls-segment-playlist-example-using-legacy-adobe-primetime-ext-x-cue"></a>Пример списка воспроизведения сегмента 3.2.3 HLS с использованием "Legacy" Adobe Primetime EXT-X-CUE

В следующем примере показано декорирование манифеста HLS с помощью тега Adobe Primetime EXT-X-CUE.  Параметр "CUE" содержит полные полезные данные SCTE-35 splice_info в кодировке Base64, которые указывают на то, что этот сигнал поступил с использованием RTMP в Adobe SCTE-35 сигнальном режиме или поступил через Smooth Streaming SCTE-35 сигнальный режим. 

~~~
#EXTM3U
#EXT-X-VERSION:4
#EXT-X-ALLOW-CACHE:NO
#EXT-X-MEDIA-SEQUENCE:346
#EXT-X-TARGETDURATION:6
#EXT-X-I-FRAMES-ONLY
#EXT-X-PROGRAM-DATE-TIME:2018-12-13T15:54:19.462Z
#EXTINF:4.000000,no-desc
KeyFrames(video_track=15447164594627600,format=m3u8-aapl)
#EXTINF:6.000000,no-desc
KeyFrames(video_track=15447164634627600,format=m3u8-aapl)
#EXT-X-CUE:ID="1026",TYPE="scte35",DURATION=30.000000,TIME=1544716520.022760,CUE="/DAlAAAAAAAAAP/wFAUAAAQCf+//KRjAfP4AKTLgAAAAAAAAVYsh2w=="
#EXTINF:6.000000,no-desc
KeyFrames(video_track=15447165474627600,format=m3u8-aapl)
~~~

### <a name="324-hls-message-handling-for-legacy-adobe-primetime-ext-x-cue"></a>3.2.4 HLS обработка сообщений для "Legacy" Adobe Primetime EXT-X-CUE

Сведения о событиях сообщаются в списке воспроизведения сегмента каждой видео- и аудиодорожки. Расположение тега EXT-X-CUE всегда **должно** быть непосредственно перед первым сегментом HLS (для объединения или начала сегмента) или непосредственно после последнего сегмента HLS (для объединения в сегмент или в конце сегмента), к которому относятся его атрибуты времени и длительности. требуется для [Adobe-Primetime].

При включении скользящего окна презентации тег EXT-X-CUE **должен** повторяться достаточно часто, чтобы присоединение или сегмент всегда полностью описывались в списке воспроизведения сегментов, а атрибут Elapsed **должен** использоваться для указания времени, в течение которого соединение или сегмент активны в соответствии с требованиями [Adobe-Primetime].

Если скользящее окно презентации включено, теги EXT-X-CUE удаляются из списка воспроизведения сегмента, когда время мультимедиа, к которому они относятся, прошло в скользящем окне презентации.

## <a name="33-dash-manifest-decoration-mpd"></a>3,3. украшение манифестов ТИРЕ (MPD)

[МПЕГДАШ] предоставляет три способа оповещения о событиях:

1.  События, сигнальные в EventStream MPD
2.  События, сигнальные по каналу с помощью окна сообщения о событии ("EMSG")
3.  Путем сочетания 1 и 2 способов.

События, сигнальные в EventStream MPD, полезны для потоковой передачи VOD, так как клиенты имеют доступ ко всем событиям сразу после загрузки MPD. Он также полезен для ССАИ сигнала, когда нижестоящий поставщик ССАИ должен проанализировать сигналы из манифеста MPD с несколькими периодами и вставить содержимое Active Directory динамически.  Встроенное решение ("EMSG") полезно для динамической потоковой передачи, где клиентам не требуется загружать MPD повторно, или между клиентом и источником не происходит никаких манипуляций с манифестом ССАИ. 

Поведение по умолчанию служб мультимедиа Azure для ТИРЕ — сообщить как в EventStream MPD, так и в аппаратном канале, используя окно сообщения о событии ("EMSG").

Сообщения о подсказке, полученные через [RTMP] или [MS-SSTR-прием], сопоставлены с событиями ТИРЕ, используя встроенные поля "EMSG" и (или) in-MPD Евентстреамс. 

В SCTE-35 с сигналами для ТИРЕ следуют определение и требования, определенные в [SCTE-214-3], а также в разделе [ТИРЕ-IF-источнике] 13.12.2 (' SCTE35 Events '). 

Для in-SCTE [35] в поле сообщения события (' EMSG ') используется Счемеид = "urn: SCTE: scte35:2013: bin". Для декорирования манифеста MPD EventStream Счемеид использует urn: SCTE: scte35:2014: XML + bin.  Этот формат представляет собой XML-представление события, которое включает в себя двоичные выходные данные в кодировке Base64 для полного сообщения SCTE-35, полученного во время приема. 

Нормативные определения ссылочных данных каретки [SCTE-35] сообщения подсказок в ТИРЕ доступны в [SCTE-214-1] SEC 6.7.4 (MPD) и [SCTE-214-3] SEC 7.3.2 (каретка SCTE 35 сообщения Cue).

### <a name="331-mpeg-dash-mpd-eventstream-signaling"></a>3.3.1 MPEG ТИРЕ (MPD) EventStream сигнал

В MPD с помощью элемента EventStream, который отображается в элементе Period, будет отображаться сообщение о событии MANIFEST (MPD). Используется Счемеид "urn: SCTE: scte35:2014: XML + bin".

> [!NOTE]
> В целях краткости [SCTE-35] позволяет использовать раздел в кодировке Base64 в элементе SignalR. binary (а не элемент Signal. Сплицеинфосектион) в качестве альтернативы символу символа подсказок полностью проанализированных сообщений Cue.
> Службы мультимедиа Azure используют этот подход "XML + bin" для сигнализации в манифесте MPD.
> Это также рекомендуемый метод, используемый в [ТИРЕ-IF-источнике]. см. раздел ["потоки событий вставки AD" для тире, если правило источнике](https://dashif-documents.azurewebsites.net/DASH-IF-IOP/master/DASH-IF-IOP.html#ads-insertion-event-streams)
> 

Элемент EventStream имеет следующие атрибуты:

| **Имя атрибута** | **Тип**                | **Обязательный?** | **Описание**                                                                                                                                                                                                                                                                                   |
|--------------------|-------------------------|---------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| scheme_id_uri      | строка                  | Обязательное значение      | Определяет схему сообщения. Схема получает значение атрибута Scheme в поле манифеста сервера прямой передачи. Значение **должно** быть универсальным именем ресурса (URN) или URL-адресом, определяющим схему сообщения. Поддерживаемый выходной Счемеид должен иметь значение "urn: SCTE: scte35:2014: XML + bin" на [SCTE-214-1] SEC 6.7.4 (MPD), так как в настоящее время служба поддерживает только "XML + bin" для краткости в MPD.  |
| value              | строка                  | Необязательный      | Дополнительное строковое значение, используемое владельцами схемы для настройки семантики сообщения. Чтобы отличать несколько потоков событий одной и той же схемой, в качестве значения **необходимо** задать имя потока событий (trackName для [MS-SSTR-прием] или имя сообщения AMF для приема [RTMP]). |
| Шкала времени          | 32-разрядное целое число без знака | Обязательное значение      | Шкала времени в тактах в секунду.                                                                                                                                                                                                       |


### <a name="332-example-mpeg-dash-manifest-mpd-signaling-of-scte-35-using-eventstream"></a>3.3.2, пример использования манифеста MPEG ТИРЕ (MPD) SCTE-35 с помощью EventStream

~~~ xml
<!-- Example MPD using xml+bin style signaling per [SCTE-214-1] -->
  <EventStream schemeIdUri="urn:scte:scte35:2014:xml+bin" value="scte35_track_001_000" timescale="10000000">
        <Event presentationTime="15447165200227600" duration="300000000" id="1026">
            <scte35:Signal>
                <scte35:Binary>
                    /DAlAAAAAAAAAP/wFAUAAAQDf+//KaeGwP4AKTLgAAAAAAAAn75a3g==
                </scte35:Binary>
            </scte35:Signal>
        </Event>
        <Event presentationTime="15447166250227600" duration="300000000" id="1027">
           <scte35:Signal>
                <scte35:Binary>
                    /DAlAAAAAAAAAP/wFAUAAAQDf+//KaeGwP4AKTLgAAAAAAAAn75a3g==
                </scte35:Binary>
            </scte35:Signal>
        </Event>
    </EventStream>
~~~

> [!IMPORTANT]
> Обратите внимание, что Пресентатионтиме — время презентации события [SCTE-35], которое преобразуется относительно времени начала периода, а не времени прибытия сообщения.
> [Мпегдаш] определяет Event@presentationTime время показа события относительно начала периода.
> Значение времени презентации в секундах является делением значения этого атрибута и значения EventStream@timescale атрибута.
> Если он отсутствует, значение времени презентации равно 0.


### <a name="333-mpeg-dash-in-band-event-message-box-signaling"></a>Сигнал в окне сообщения о событии 3.3.3 MPEG ТИРЕ

Для потока событий по общему каналу необходимо, чтобы MPD имел элемент InbandEventStream на уровне набора адаптации.  Этот элемент имеет обязательный атрибут schemeIdUri и дополнительный атрибут timescale, который также отображается в поле сообщения о событии (emsg).  Окна сообщений о событиях с идентификаторами схем, не определенными в MPD, не **должны** присутствовать.

Для in-SCTE [35], сигналы **должны** использовать счемеид = "urn: SCTE: scte35:2013: bin".
Нормативные определения каретки [SCTE-35] сообщений в полосе задаются в [SCTE-214-3] сек 7.3.2 (перевозка символов SCTE 35).

Следующие сведения описывают конкретные значения, которые клиент должен ждать в "EMSG" в соответствии с [SCTE-214-3]:

| **Имя поля**          | **Тип поля**          | **Обязательный?** | **Описание**                                                                                                                                                                                                                                                                                                                                                    |
|-------------------------|-------------------------|---------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| scheme_id_uri           | строка                  | Обязательное значение      | Определяет схему сообщения. Схема получает значение атрибута Scheme в поле манифеста сервера прямой передачи. Значение **должно** быть именем URN, определяющим схему сообщения. Для сообщений [SCTE-35] это **должно** быть "urn: SCTE: scte35:2013: bin" в соответствии с [SCTE-214-3] |
| Значение                   | строка                  | Обязательное значение      | Дополнительное строковое значение, используемое владельцами схемы для настройки семантики сообщения. Чтобы различить несколько потоков событий с одной схемой, в качестве значения будет использоваться имя потока события (trackName для приема Smooth или имя сообщения AMF для приема RTMP).                                                                  |
| Шкала времени               | 32-разрядное целое число без знака | Обязательное значение      | Шкала времени (тактов в секунду) полей времени и длительности в поле emsg.                                                                                                                                                                                                                                                                        |
| Presentation_time_delta | 32-разрядное целое число без знака | Обязательное значение      | Разница во времени между временем презентации события и временем первой презентации в сегменте. Время и длительность презентации **должны** быть согласованы с точками доступа к потоку (SAP) типа 1 или 2, как определено в приложении [ISO-14496-12] I.                                                                                            |
| event_duration          | 32-разрядное целое число без знака | Обязательное значение      | Длительность события или 0xFFFFFFFF для определения неизвестной длительности.                                                                                                                                                                                                                                                                                          |
| Id                      | 32-разрядное целое число без знака | Обязательное значение      | Определяет экземпляр сообщения. Сообщения с одинаковой семантикой должны иметь одно и то же значение. Если идентификатор не указан при принятии сообщения, службы мультимедиа Azure создадут уникальный идентификатор.                                                                                                                                                    |
| Message_data            | массив байтов;              | Обязательное значение      | Сообщение о событии. Для сообщений [SCTE-35] данные сообщения являются двоичными splice_info_section () в соответствии с [SCTE-214-3]. |

### <a name="334-dash-message-handling"></a>Обработка сообщений 3.3.4 ТИРЕ

О событиях сообщается по общему каналу в поле emsg для видео- и аудиодорожек.  Это происходит для всех запросов сегментов, значение presentation_time_delta которых 15 секунд или меньше. 

Если скользящее окно презентации включено, сообщения о событии удаляются из MPD, когда сумма времени и длительность сообщения о событии меньше времени данных мультимедиа в манифесте.  Другими словами сообщения о событиях удаляются из манифеста, когда время мультимедиа, к которому они относятся, прошло в скользящем окне презентации.

## <a name="4-scte-35-ingest-implementation-guidance-for-encoder-vendors"></a>4. SCTE-35 рекомендации по реализации для поставщиков кодировщиков

Следующие рекомендации являются распространенными проблемами, которые могут повлиять на реализацию этой спецификации поставщиком кодировщика.  Приведенные ниже рекомендации были собраны на основе отзывов реальных партнеров, чтобы упростить реализацию этой спецификации для других пользователей. 

[SCTE-35] сообщения принимаются в двоичном формате с использованием схемы **"urn: SCTE: scte35:2013: bin"** для [MS-SSTR-приема] и типа **"scte35"** для приема [RTMP]. Чтобы упростить преобразование времени [SCTE-35], которое основывается на метке времени презентации (PTS) транспортного потока MPEG-2, сопоставление между PTS (pts_time + pts_adjustment значения splice_time()) и временной шкалой мультимедийного содержимого определяется временем презентации события (поле fragment_absolute_time для приема Smooth и поле времени для приема RTMP). Сопоставление является необходимым, так как 33-разрядное значение PTS изменяется приблизительно каждые 26,5 часов.

Smooth Streaming прием [MS-SSTR-прием] требует, чтобы Data Box носителя ("mdat") содержал **splice_info_section ()** , определенный в [SCTE-35]. 

Для приема RTMP атрибуту Cue сообщения AMF присваивается значение **splice_info_section ()** в кодировке Base64 (), определенное в [SCTE-35].  

Если сообщения имеют описанный выше формат, они отправляются клиентам HLS, Smooth и ТИРЕ, как определено выше.  

При тестировании реализации с помощью платформы служб мультимедиа Azure сначала запустите тестирование с "сквозным" Лививент, прежде чем переходить к тестированию на Лививент кодирования.

---

## <a name="change-history"></a>Журнал изменений

| Дата     | Изменения                                                                            |
|----------|------------------------------------------------------------------------------------|
| 07/2/19  | Пересмотренный RTMP, принимаемый для поддержки SCTE35, добавил RTMP "Онкуепоинт" для интерактивного элемента | 
| 08/22/19 | Добавлена Онусердатаевент в RTMP для пользовательских метаданных.                         |

## <a name="next-steps"></a>Следующие шаги
Просмотрите схемы обучения работе со службами мультимедиа.

[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a>Оставить отзыв
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]
