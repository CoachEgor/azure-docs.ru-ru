---
title: Анализ и мониторинг дрейфа данных на наборах данных (предварительный просмотр)
titleSuffix: Azure Machine Learning
description: Создавайте мониторы данных машинного обучения Azure Machine Learning (предварительный просмотр), отслеживайте дрейф данных в наборах данных и настраивайте оповещения.
services: machine-learning
ms.service: machine-learning
ms.subservice: core
ms.topic: conceptual
ms.reviewer: nibaccam
ms.author: copeters
author: lostmygithubaccount
ms.date: 11/04/2019
ms.openlocfilehash: e49c621d92a8aa604b5f95291c5d80c0141f41dd
ms.sourcegitcommit: acb82fc770128234f2e9222939826e3ade3a2a28
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81682723"
---
# <a name="detect-data-drift-preview-on-datasets"></a>Обнаружение дрейфа данных (предварительный просмотр) в наборах данных
[!INCLUDE [applies-to-skus](../../includes/aml-applies-to-basic-enterprise-sku.md)]

В этой статье вы узнаете, как создать мониторы набора данных Azure Machine Learning (предварительный просмотр), следить за дрейфом данных и статистическими изменениями в наборах данных и настраивать оповещения.

С помощью мониторов набора данных Azure Machine Learning вы можете:
* **Проанализируйте дрейф в данных,** чтобы понять, как они меняются с течением времени.
* **Мониторинг данных моделей** для различий между обучением и обслуживанием наборов данных.
* **Мониторинг новых данных** для получения различий между базовым и целевым набором данных.
* **Особенности профиля в данных** для отслеживания изменения статистических свойств с течением времени.
* **Настройка оповещений о дрейфе данных** для раннего предупреждения о потенциальных проблемах. 

Метрики и сведения доступны через ресурс [Azure Application Insights,](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview) связанный с рабочим пространством Azure Machine Learning.

> [!Important]
> Пожалуйста, обратите внимание, что мониторинг данных дрейфа с SDK доступен во всех изданиях, в то время как мониторинг данных дрейф через студию в Интернете только предприятие издание.

## <a name="prerequisites"></a>Предварительные требования

Для создания и работы с мониторами наборов данных необходимо:
* Подписка Azure. Если у вас еще нет подписки Azure, создайте бесплатную учетную запись, прежде чем начинать работу. Опробуйте [бесплатную или платную версию Машинного обучения Azure](https://aka.ms/AMLFree) уже сегодня.
* [Рабочее пространство машинного обучения Azure](how-to-manage-workspace.md).
* [Установлен SDK Для Python,](https://docs.microsoft.com/python/api/overview/azure/ml/install?view=azure-ml-py)который включает пакет наборов лазурных данных.
* Структурированные (табулярные) данные с меткой времени, указанной в пути файла, имени файла или столбце в данных.

## <a name="what-is-data-drift"></a>Что такое дрейф данных?

В контексте машинного обучения дрейф данных представляет собой изменение входных данных модели, что приводит к снижению производительности модели. Это одна из главных причин, по которым точность модели ухудшается с течением времени, таким образом, мониторинг дрейфа данных помогает обнаружить проблемы с производительностью модели.

Причины дрейфа данных включают: 

- Процесс восходящего потока изменяется, например, заменяется датчик, изменяя единицы измерения с дюймов до сантиметров. 
- Проблемы качества данных, такие как сломанный датчик, всегда читающий 0.
- Естественный дрейф в данных, таких как средняя температура меняется с сезоном.
- Изменение отношения между объектами или сдвиг ковариата. 

С помощью мониторов набора данных Azure Machine Learning можно настроить оповещения, которые помогают в обнаружении дрейфа данных в наборах данных с течением времени. 

### <a name="dataset-monitors"></a>Мониторы набора данных 

Можно создать монитор набора данных для обнаружения и оповещения о дрейфе данных на новых данных в наборе данных, анализировать исторические данные для дрейфа и профилировать новые данные с течением времени. Алгоритм дрейфа данных обеспечивает общую меру изменения данных и указание, какие функции отвечают за дальнейшее исследование. Мониторы набора данных производят ряд других метрик `timeseries` путем профилирования новых данных в наборе данных. Пользовательское оповещение можно настроить на всех метриках, генерируемых монитором через [Azure Application Insights.](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview) Мониторы наборов данных могут использоваться для быстрого выявления проблем с данными и сокращения времени на отладку проблемы путем выявления вероятных причин.  

Концептуально существует три основных сценария настройки мониторов набора данных в Azure Machine Learning.

Сценарий | Описание
---|---
Мониторинг данных модели, обслуживающих данные для дрейфа от обучающих данных модели | Результаты этого сценария можно интерпретировать как мониторинг прокси для точности модели, учитывая, что точность модели ухудшается, если обслуживающие данные дрейфуют от обучающих данных.
Мониторинг набора данных временных рядов для дрейфа по сравнению с предыдущим периодом времени. | Этот сценарий является более общим и может использоваться для мониторинга наборов данных, участвующих вверх по течению или вниз по течению построения моделей.  Целевой набор данных должен иметь столбец метки времени, в то время как базовый набор данных может быть любым таблисным набором данных, который имеет общие черты с целевым набором данных.
Выполнение анализа прошлых данных. | Этот сценарий может использоваться для понимания исторических данных и информирования решений в настройках для мониторов наборов данных.

## <a name="how-dataset-can-monitor-data"></a>Как набор данных может отслеживать данные

С помощью Машинного обучения Azure дрейф данных контролируется с помощью наборов данных. Для мониторинга дрейфа данных указан базовый набор данных - обычно набор данных для подготовки для модели. Целевой набор данных - обычно модель входных данных - со временем сравнивается с базовым набором данных. Это сравнение означает, что целевой набор данных должен иметь указанный столбец метки времени.

### <a name="set-the-timeseries-trait-in-the-target-dataset"></a>Установите `timeseries` черту в целевом наборе данных

Целевой набор данных `timeseries` должен иметь на нем признаки, указав столбец метки времени либо из столбца в данных, либо из виртуального столбца, полученного из шаблона пути файлов. Это можно сделать через студию Python SDK или Azure Machine Learning. Для добавления `timeseries` черты в набор данных необходимо указать столбец, представляющий метку времени "тонкое зерно". Если данные разделены на структуру папок с информацией о времени, например, 'Yyyyy/MM/dd', можно создать виртуальный столбец через настройки шаблона пути и установить его в качестве метки времени "грубого зерна", чтобы повысить важность функциональности временных рядов. 

#### <a name="python-sdk"></a>Пакет SDK для Python

[`with_timestamp_columns()`](https://docs.microsoft.com/python/api/azureml-core/azureml.data.tabulardataset?view=azure-ml-py#with-timestamp-columns-timestamp-none--partition-timestamp-none--validate-false----kwargs-) Метод [`Dataset`](https://docs.microsoft.com/python/api/azureml-core/azureml.data.tabulardataset?view=azure-ml-py#with-timestamp-columns-timestamp-none--partition-timestamp-none--validate-false----kwargs-) класса определяет столбец временной отметки для набора данных. 

```python 
from azureml.core import Workspace, Dataset, Datastore

# get workspace object
ws = Workspace.from_config()

# get datastore object 
dstore = Datastore.get(ws, 'your datastore name')

# specify datastore paths
dstore_paths = [(dstore, 'weather/*/*/*/*/data.parquet')]

# specify partition format
partition_format = 'weather/{state}/{date:yyyy/MM/dd}/data.parquet'

# create the Tabular dataset with 'state' and 'date' as virtual columns 
dset = Dataset.Tabular.from_parquet_files(path=dstore_paths, partition_format=partition_format)

# assign the timestamp attribute to a real or virtual column in the dataset
dset = dset.with_timestamp_columns('date')

# register the dataset as the target dataset
dset = dset.register(ws, 'target')
```

Полный пример использования `timeseries` черты наборов данных [example notebook](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/work-with-data/datasets-tutorial/timeseries-datasets/tabular-timeseries-dataset-filtering.ipynb) см. [datasets SDK documentation](https://docs.microsoft.com/python/api/azureml-core/azureml.data.tabulardataset?view=azure-ml-py#with-timestamp-columns-timestamp-none--partition-timestamp-none--validate-false----kwargs-)

#### <a name="azure-machine-learning-studio"></a>Студия машинного обучения Azure.
[!INCLUDE [applies-to-skus](../../includes/aml-applies-to-enterprise-sku-inline.md)]

При создании набора данных с помощью студии Машинного обучения Azure убедитесь, что путь к данным содержит информацию о метке времени, включите все субфалеры с данными и установите формат раздела. 

В следующем примере взяты все данные под субфолдером *NoaaIsdFlorida/2019,* а формат раздела определяет год, месяц и день. 

[![Формат раздела](./media/how-to-monitor-datasets/partition-format.png)](media/how-to-monitor-datasets/partition-format-expand.png)

В настройках **Schema** укажите столбец метки времени из виртуального или реального столбца в указанном наборе данных:

![Отметка времени](./media/how-to-monitor-datasets/timestamp.png)

## <a name="dataset-monitor-settings"></a>Настройки мониторинга набора данных

После создания набора данных с указанными настройками метки времени вы будете готовы настроить монитор набора данных.

Различные настройки монитора набора данных разбиты на три группы: **Базовая информация, настройки монитора** и **настройки Backfill.**

### <a name="basic-info"></a>Общие сведения

Эта таблица содержит основные настройки, используемые для монитора набора данных.

| Параметр | Описание | Советы | Изменяемый | 
| ------- | ----------- | ---- | ------- | 
| Имя | Название монитора набора данных. | | нет |
| Базовый набор данных | Табулярный набор данных, который будет использоваться в качестве базового уровня для сравнения целевого набора данных с течением времени. | Базовый набор данных должен иметь общие черты с целевым набором данных. Как правило, базовый условитель должен устанавливаться в наборе обучаемых данных модели или на фрагмент целевого набора данных. | нет |
| Целевой набор данных | Табулярный набор данных с указанным столбцом метки времени, который будет проанализирован для дрейфа данных. | Целевой набор данных должен иметь общие черты с базовым набором данных и должен быть набором `timeseries` данных, к которому прилагается новый набор данных. Исторические данные в целевом наборе данных могут быть проанализированы или новые данные могут быть проверены. | нет | 
| Частота | Частота, которая будет использоваться для планирования задания конвейера и анализа исторических данных при запуске засылки. Варианты включают ежедневные, еженедельные или ежемесячные. | Отрегулируйте эту настройку, чтобы включить сопоставимый размер данных в базовый упор. | нет | 
| Компоненты | Список функций, которые будут анализироваться для дрейфа данных с течением времени. | Установите функцию вывода модели (ы) для измерения дрейфа концепции. Не включайте функции, которые естественно дрейфуют с течением времени (месяц, год, индекс и т.д.). Вы можете заполнить и существующий монитор дрейфа данных после корректировки списка функций. | Да | 
| Целевой объект вычисления | Цель машинного обучения Azure Machine Learning для выполнения заданий мониторинга набора данных. | | Да | 

### <a name="monitor-settings"></a>Настройки монитора

Эти настройки для запланированного конвейера мониторинга набора данных, который будет создан. 

| Параметр | Описание | Советы | Изменяемый | 
| ------- | ----------- | ---- | ------- |
| Включить | Включить или отключить график на конвейере мониторинга набора данных | Отпустите расписание для анализа исторических данных с настройками задней заправки. Он может быть включен после создания монитора набора данных. | Да | 
| Задержка | Время, в часах, оно принимает для данных для того чтобы прибыть в набор данных. Например, если для поступления данных в S'L DB требуется три дня, установите задержку до 72. | Не может быть изменен после создания монитора набора данных | нет | 
| Адреса электронной почты. | Адреса электронной почты для оповещения на основе нарушения порога процентного заноса данных. | Электронные письма отправляются через Azure Monitor. | Да | 
| Порог | Порог процентного значения дрейфа данных для оповещения по электронной почте. | Дальнейшие оповещения и события могут быть установлены на многих других метриках в связанном ресурсе приложения. | Да | 

### <a name="backfill-settings"></a>Настройки заправок

Эти параметры для запуска backfill на прошлые данные для данных дрейфа метрик.

| Параметр | Описание | Советы |
| ------- | ----------- | ---- |
| Дата начала | Дата начала работы по засылке. | | 
| Дата окончания | Дата окончания задания по заполнению задней заправки. | Дата окончания не может быть более 31 частоты единиц времени с даты начала. На существующем мониторе набора данных метрики могут быть заполнены для анализа исторических данных или замены метрик обновленными настройками. |

## <a name="create-dataset-monitors"></a>Создание мониторов набора данных 

Создавайте мониторы наборов данных для обнаружения и оповещения о дрейфе данных в новом наборе данных со студией Машинного обучения Azure или Python SDK. 

### <a name="azure-machine-learning-studio"></a>Студия машинного обучения Azure.
[!INCLUDE [applies-to-skus](../../includes/aml-applies-to-enterprise-sku-inline.md)]

Для настройки оповещений на мониторе набора данных рабочее пространство, содержащее набор данных, для которого необходимо создать монитор, должно иметь возможности enterprise Edition. 

После подтверждения функциональности рабочего пространства перейдите на главную страницу студии и выберите вкладку Datasets слева. Выберите мониторы набора данных.

![Список мониторов](./media/how-to-monitor-datasets/monitor-list.png)

Нажмите на кнопку **«Создать монитор»** и продолжайте работать через мастера, нажав **кнопку Next**.

![Мастер](./media/how-to-monitor-datasets/wizard.png)

Полученный монитор набора данных появится в списке. Выберите его, чтобы перейти на страницу данных монитора.

### <a name="from-python-sdk"></a>Из Питона SDK

Для получения подробной информации смотрите [справочную документацию Python SDK о дрейфе данных.](/python/api/azureml-datadrift/azureml.datadrift) 

В следующем примере показано, как создать монитор набора данных с помощью Python SDK

```python
from azureml.core import Workspace, Dataset
from azureml.datadrift import DataDriftDetector
from datetime import datetime

# get the workspace object
ws = Workspace.from_config()

# get the target dataset
dset = Dataset.get_by_name(ws, 'target')

# set the baseline dataset
baseline = target.time_before(datetime(2019, 2, 1))

# set up feature list
features = ['latitude', 'longitude', 'elevation', 'windAngle', 'windSpeed', 'temperature', 'snowDepth', 'stationName', 'countryOrRegion']

# set up data drift detector
monitor = DataDriftDetector.create_from_datasets(ws, 'drift-monitor', baseline, target, 
                                                      compute_target='cpu-cluster', 
                                                      frequency='Week', 
                                                      feature_list=None, 
                                                      drift_threshold=.6, 
                                                      latency=24)

# get data drift detector by name
monitor = DataDriftDetector.get_by_name(ws, 'drift-monitor')

# update data drift detector
monitor = monitor.update(feature_list=features)

# run a backfill for January through May
backfill1 = monitor.backfill(datetime(2019, 1, 1), datetime(2019, 5, 1))

# run a backfill for May through today
backfill1 = monitor.backfill(datetime(2019, 5, 1), datetime.today())

# disable the pipeline schedule for the data drift detector
monitor = monitor.disable_schedule()

# enable the pipeline schedule for the data drift detector
monitor = monitor.enable_schedule()
```

Полный пример настройки `timeseries` набора данных и детектора дрейфа данных можно ознакомиться с нашим [примером для ноутбука.](https://aka.ms/datadrift-notebook)

## <a name="understanding-data-drift-results"></a>Понимание результатов дрейфа данных

Монитор данных дает две группы результатов: обзор Drift и сведения о функциях. Следующая анимация показывает доступные диаграммы монитора дрейфа на основе выбранной функции и метрики. 

![Демо-видео](./media/how-to-monitor-datasets/video.gif)

### <a name="drift-overview"></a>Обзор дрейфа

**Раздел обзора Drift** содержит информацию на высшем уровне о масштабах дрейфа данных и о том, какие функции следует дополнительно изучить. 

| Метрика | Описание | Советы | 
| ------ | ----------- | ---- | 
| Величина дрейфа данных | Учитывая в процентах между базовым и целевым набором данных с течением времени. Диапазон от 0 до 100, где 0 указывает идентичные наборы данных и 100 указывает на возможность дрейфа данных Azure Machine Learning, может полностью отличить два набора данных друг от друга. | Шум в точном проценте измеряется, как ожидается, из-за машинного обучения методы используются для создания этой величины. | 
| Дрифт вклад по функциям | Вклад каждой функции в целевой набор данных в измеренную величину дрейфа. |  Из-за изменения ковариата базовое распределение объекта не обязательно должно изменяться, чтобы иметь относительно высокое значение функции. | 

Следующее изображение является примером диаграмм, показанных в результатах **обзора Drift** в студии машинного обучения Azure, в результате заполнения [интегрированных поверхностных данных NOAA.](https://azure.microsoft.com/services/open-datasets/catalog/noaa-integrated-surface-data/) Данные были `stationName contains 'FLORIDA'`отобраны для, с января 2019 года используется в качестве базового набора данных и все данные 2019 года, используемые в качестве целевого показателя.
 
![Обзор дрейфа](./media/how-to-monitor-datasets/drift-overview.png)

### <a name="feature-details"></a>Детали функции

Раздел **сведения о функциях** содержит информацию об изменении дистрибутива выбранной функции, а также другие статистические данные с течением времени. 

Набор целевых данных также профилируется с течением времени. Статистическое расстояние между базовым распределением каждого объекта сравнивается с набором данных с течением времени, которое концептуально сходно с величиной дрейфа данных, за исключением того, что это статистическое расстояние предназначено для отдельного объекта. Мин, макс, и среднее также доступны. 

В студии машинного обучения Azure при нажатии на точку данных в графике распределение показанной функции будет соответствующим образом скорректировано. По умолчанию он показывает распределение базового набора данных и распределение последнего запуска той же функции. 

Эти метрики также могут быть извлечены `get_metrics()` в Python `DataDriftDetector` SDK с помощью метода на объекте. 

#### <a name="numeric-features"></a>Числовые особенности 

Числовые функции профилируются в каждом запуске монитора набора данных. Следующие из них выставлены в студии машинного обучения Azure. Плотность вероятности отображается для распределения.

| Метрика | Описание |  
| ------ | ----------- |  
| Расстояние Вассерштейна | Минимальный объем работы по преобразованию базового распределения в целевое распределение. |
| Среднее значение | Среднее значение объекта. |
| Минимальное значение | Минимальное значение функции. |
| Максимальное значение | Максимальное значение объекта. |

![Детали функции числовые](./media/how-to-monitor-datasets/feature-details.png)

#### <a name="categorical-features"></a>Категорические особенности 

Числовые функции профилируются в каждом запуске монитора набора данных. Следующие из них выставлены в студии машинного обучения Azure. Для распространения показана гистограмма.

| Метрика | Описание |  
| ------ | ----------- |  
| Расстояние Евклида | Геометрическое расстояние между базовыми и целевыми дистрибутивами. |
| Уникальные значения | Количество уникальных значений (кардинальность) функции. |


![Детали функции категоричны](./media/how-to-monitor-datasets/feature-details2.png)

## <a name="metrics-alerts-and-events"></a>Метрики, оповещения и события

Метрика может быть запрошена в ресурсе [Azure Application Insights,](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview) связанном с рабочим пространством машинного обучения. Что дает доступ ко всем функциям Application Insights, включая настройки для пользовательских правил оповещения и групп действий, чтобы вызвать действия, такие как, Функция Email/SMS/Push/Voice или Azure. Для получения подробной информации обратитесь к полной документации Application Insights. 

Чтобы начать работу, перейдите на портал Azure и выберите страницу **обзора** рабочего пространства.  Связанный ресурс Application Insights находится справа:

[![Обзор портала Azure](./media/how-to-monitor-datasets/ap-overview.png)](media/how-to-monitor-datasets/ap-overview-expanded.png)

Выберите журналы (аналитика) под мониторингом на левом стеле:

![Обзор информации о приложениях](./media/how-to-monitor-datasets/ai-overview.png)

Метрики монитора набора `customMetrics`данных сохраняются как . Вы можете написать и запустить запрос после настройки монитора набора данных для их просмотра:

[![Запрос аналитики журнала](./media/how-to-monitor-datasets/simple-query.png)](media/how-to-monitor-datasets/simple-query-expanded.png)

После определения метрик для настройки правил оповещения создайте новое правило оповещения:

![Новое правило генерации оповещений](./media/how-to-monitor-datasets/alert-rule.png)

Можно использовать существующую группу действий или создать новую для определения действия, необходимое для выполнения установленных условий:

![Новая группа действий](./media/how-to-monitor-datasets/action-group.png)

## <a name="troubleshooting"></a>Устранение неполадок

Ограничения и известные проблемы:

* Временной диапазон заданий заслили ассока ограничен 31 интервалом настройки частоты монитора. 
* Ограничение 200 функций, если список функций не указан (все функции используются).
* Размер вычисления должен быть достаточно большим для обработки данных. 
* Убедитесь, что в наборе данных есть данные в течение даты начала и окончания для заданного запуска монитора.
* Мониторы набора данных будут работать только на наборах данных, содержащих 50 строк или более. 

Столбцы, или объекты, в наборе данных классифицируются как категоричные или численные на основе условий в следующей таблице. Если функция не соответствует этим условиям - например, столбец строки типа с >100 уникальных значений - функция отбрасывается из нашего алгоритма дрейфа данных, но все еще профилируется. 

| Тип компонента | Тип данных | Условие | Ограничения | 
| ------------ | --------- | --------- | ----------- |
| категориальные; | строка, bool, Int, поплавок | Количество уникальных значений в объекте составляет менее 100 и менее 5% от числа строк. | Null рассматривается как своя категория. | 
| числовые; | int, поплавок | Значения в объекте имеют численный тип данных и не соответствуют условию для категорической функции. | Функция отбрасывается, если >15% значений являются нулевыми. | 

## <a name="next-steps"></a>Следующие шаги

* Отправляйтесь в [студию машинного обучения Azure](https://ml.azure.com) или [в блокнот Python,](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/work-with-data/datadrift-tutorial/datadrift-tutorial.ipynb) чтобы настроить монитор набора данных.
* Узнайте, как настроить дрейф данных на [моделях, развернутых в службе Azure Kubernetes.](how-to-monitor-data-drift.md)
* Настройка мониторов дрейфа набора данных с [помощью сетки событий.](how-to-use-event-grid.md) 
