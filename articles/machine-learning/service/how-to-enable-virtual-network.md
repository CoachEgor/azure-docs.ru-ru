---
title: Выполнение экспериментов и вывод в виртуальной сети
titleSuffix: Azure Machine Learning service
description: Выполняйте эксперименты машинного обучения и формируйте выводы в защищенной виртуальной сети Azure. Сведения о создании целевых объектов вычислений для обучения модели и формировании вывода в виртуальной сети. Сведения о требованиях к защищенным виртуальным сетям, например обязательные входящие и исходящие порты.
services: machine-learning
ms.service: machine-learning
ms.subservice: core
ms.topic: conceptual
ms.reviewer: jmartens
ms.author: aashishb
author: aashishb
ms.date: 08/05/2019
ms.openlocfilehash: 9bd56984f088ab16fc5d80c588afce2cdc31240b
ms.sourcegitcommit: 670c38d85ef97bf236b45850fd4750e3b98c8899
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/08/2019
ms.locfileid: "68848118"
---
# <a name="securely-run-experiments-and-inference-inside-an-azure-virtual-network"></a>Безопасный запуск экспериментов и вывод в виртуальной сети Azure

В этой статье вы узнаете, как выполнять эксперименты и вывод в виртуальной сети. Виртуальная сеть выполняет роль границы безопасности, изолируя ресурсы Azure от общедоступного Интернета. Также вы можете подключить виртуальную сеть Azure к локальной сети. Она позволяет безопасно обучать модели и получать доступ к развернутым моделям для вывода. Вывод или оценка модели — это этап, в котором развернутая модель используется для прогнозирования, чаще всего в рабочих данных.

Служба машинного обучения Azure использует вычислительные ресурсы других служб Azure. Вычислительные ресурсы (целевые объекты вычислений) используются для обучения и развертывания моделей. Эти целевые объекты вычислений могут создаваться в виртуальной сети. Например, вы можете обучить модель с помощью Виртуальной машины обработки и анализа данных корпорации Майкрософт, а затем развернуть модель в Службе Azure Kubernetes (AKS). См. дополнительные сведения [о виртуальных сетях Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-overview).

Эта статья содержит подробные сведения о **дополнительных параметрах безопасности**и не является обязательной для основных или экспериментальных вариантов использования. В разделах этой статьи содержатся сведения о конфигурации для различных сценариев, но их не нужно выполнять по порядку или полностью.

## <a name="prerequisites"></a>предварительные требования

Создайте [рабочую область](how-to-manage-workspace.md) службы машинное обучение Azure, если она еще не создана. В этом документе предполагается, что вы знакомы с виртуальными сетями Azure и IP-сетями в целом. В этом документе также предполагается, что вы создали виртуальную сеть и подсеть для использования с ресурсами вычислений. Если вы не знакомы с виртуальными сетями Azure, ознакомьтесь со следующими статьями, чтобы узнать о службе:

* [Назначение IP-адресов](https://docs.microsoft.com/azure/virtual-network/virtual-network-ip-addresses-overview-arm)
* [Группы безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview)
* [Краткое руководство Создание виртуальной сети](https://docs.microsoft.com/azure/virtual-network/quick-create-portal)
* [Фильтрация сетевого трафика](https://docs.microsoft.com/azure/virtual-network/tutorial-filter-network-traffic)

## <a name="storage-account-for-your-workspace"></a>Учетная запись хранения для рабочей области

Чтобы использовать учетную запись хранения Azure для рабочей области в виртуальной сети, выполните следующие действия.

1. Создайте вычисление эксперимента ex. Вычислительная среда Машинного обучения за виртуальную сеть или присоедините эксперимент к рабочей области, например. Кластер HDInsight или виртуальная машина. Дополнительные сведения см. в разделе [использование вычислительная среда машинного обучения](#use-machine-learning-compute) и [Использование виртуальных машин или кластеров HDInsight](#use-a-virtual-machine-or-hdinsight-cluster) в этом документе.
2. Перейдите к хранилищу, подключенному к рабочей области. ![Изображение портал Azure, показывающее службу хранилища Azure, подключенную к рабочей области службы Машинное обучение Azure](./media/how-to-enable-virtual-network/workspace-storage.png)
3. На странице Служба хранилища Azure выберите __брандмауэры и виртуальные сети__. ![Изображение портал Azure в разделе "брандмауэры и виртуальные сети" на странице службы хранилища Azure](./media/how-to-enable-virtual-network/storage-firewalls-and-virtual-networks.png)
4. На странице __брандмауэры и виртуальные сети__ выберите следующие записи:
    - Выберите __Выбранные сети__.
    - В разделе __виртуальные сети__выберите __Добавить существующую виртуальную сеть__ , чтобы добавить виртуальную сеть, в которой находится вычисление эксперимента. (См. шаг 1.)
    - Установите флажок __разрешить доверенным службам Майкрософт доступ к этой учетной записи хранения__.
![Изображение страницы портал Azure отображение брандмауэров и виртуальных сетей в службе хранилища Azure](./media/how-to-enable-virtual-network/storage-firewalls-and-virtual-networks-page.png)

5. Во время выполнения эксперимента в коде эксперимента измените конфигурацию запуска для использования хранилища BLOB-объектов:
    ```python
    run_config.source_directory_data_store = "workspaceblobstore"
    ```

> [!IMPORTANT]
> __Учетную запись хранения по умолчанию__ для службы машинное обучение Azure можно разместить в виртуальной сети __только при эксперименте__.
>
> __Учетные записи хранения, отличные от используемых по умолчанию__ , также могут размещаться в виртуальной сети, но __только для экспериментов__.
>
> Учетные записи хранения по умолчанию или не по умолчанию, используемые для __вывода__ данных, должны иметь неограниченный __доступ к учетным записям хранения__.
>
> Если вы не уверены, изменили ли вы эти параметры, ознакомьтесь с разделом __Изменение сетевого правила доступа по умолчанию__ из статьи [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](https://docs.microsoft.com/azure/storage/common/storage-network-security). Используйте шаги, чтобы разрешить доступ из всех сетей во время вывода или оценки модели.

## <a name="key-vault-for-your-workspace"></a>Хранилище ключей для рабочей области

Экземпляр Key Vault, связанный с рабочей областью, используется службой Машинное обучение Azure для хранения учетных данных различных типов:
* Строка подключения связанной учетной записи хранения
* Пароли для экземпляров репозитория контейнеров Azure
* Строки подключения к хранилищам данных.

Чтобы использовать Машинное обучение Azure возможности экспериментов с Key Vault за виртуальной сетью, выполните следующие действия.
1. Перейдите к Key Vault, связанному с рабочей областью. ![Изображение портал Azure показывающее Key Vault, связанных с рабочей областью службы Машинное обучение Azure](./media/how-to-enable-virtual-network/workspace-key-vault.png)
2. На странице Key Vault выберите раздел __брандмауэры и виртуальные сети__ . ![Изображение раздела портал Azure отображение брандмауэров и виртуальных сетей на Key Vault странице](./media/how-to-enable-virtual-network/key-vault-firewalls-and-virtual-networks.png)
3. На странице __брандмауэры и виртуальные сети__ выберите следующие записи:
    - Выберите __Выбранные сети__.
    - В разделе __виртуальные сети__выберите __Добавить существующие виртуальные сети__ , чтобы добавить виртуальную сеть, в которой находится вычисление экспериментов.
    - Установите флажок __разрешить доверенным службам Майкрософт обход этого брандмауэра__.
![Изображение портал Azure страница "брандмауэры и виртуальные сети" в разделе Key Vault](./media/how-to-enable-virtual-network/key-vault-firewalls-and-virtual-networks-page.png)


## <a name="use-machine-learning-compute"></a>Использование Вычислительной среды Машинного обучения

Чтобы использовать Машинное обучение Azure вычислений в виртуальной сети, примите во внимание следующие сведения о требованиях к сети.

- Виртуальная сеть должна размещаться в той же подписке и том же регионе, что и рабочая область Службы машинного обучения Azure.

- Подсеть, указанная для кластера вычислений, должна иметь достаточное число неназначенных IP-адресов, чтобы соответствовать количеству виртуальных машин, нацеленных на кластер. Если в подсети нет достаточного количества свободных IP-адресов, кластер будет выделен частично.

- Если вы планируете защитить виртуальную сеть путем ограниченного трафика, оставьте некоторые порты открытыми для службы вычислений. Дополнительные сведения см. в разделе [Требуемые порты](#mlcports).

- Проверьте, существуют ли политики безопасности или блокировки в подписке или группе ресурсов виртуальной сети, которые ограничивают права на управление виртуальной сетью.

- Если планируется разместить несколько кластеров вычислений в одной виртуальной сети, может потребоваться увеличить квоту для одного или нескольких ресурсов.

    Машинное обучение Azure вычислений автоматически выделяет дополнительные сетевые ресурсы в группе ресурсов, содержащей виртуальную сеть. Для каждого кластера вычислений Служба выделяет следующие ресурсы:

    - Одна группа безопасности сети

    - Один общедоступный IP-адрес

    - Один балансировщик нагрузки

  Эти ресурсы ограничены [квотами ресурсов](https://docs.microsoft.com/azure/azure-subscription-service-limits) в подписке.

### <a id="mlcports"></a> Требуемые порты

Сейчас Вычислительная среда Машинного обучения использует пакетную службу Azure для подготовки виртуальных машин в указанной виртуальной сети. Это означает, что подсеть должна разрешать входящие подключения из пакетной службы. Эта связь используется для планирования выполнений на узлах Вычислительной среды Машинного обучения, а также для взаимодействия со службой хранилища Azure и другими ресурсами. Пакетная группа добавляет группы безопасности сети (**NSG**) на уровне сетевых интерфейсов (**NIC**), подключенных к виртуальным машинам. Эти группы безопасности сети автоматически настраивают правила для входящего и исходящего трафика, чтобы разрешить следующий трафик:

- Входящий TCP-трафик на портах 29876 и 29877 из __тега службы__ __батчнодеманажемент__.

    ![Изображение портал Azure, показывающее правило входящего трафика с помощью тега службы Батчнодеманажемент](./media/how-to-enable-virtual-network/batchnodemanagement-service-tag.png)

- используемых Входящий TCP-трафик через порт 22 для разрешения удаленного доступа. Этот порт необходим, только если вы хотите подключиться по протоколу SSH к общедоступному IP-адресу.

- Исходящий трафик в виртуальную сеть на любом порту.

- Исходящий трафик в Интернет на любом порту.

Соблюдайте осторожность, если вы изменяете или добавляете правила для входящего и (или) исходящего трафика в группах безопасности сети, настроенных пакетной службой. Если NSG блокирует обмен данными с вычисленными узлами, Служба вычислений устанавливает для них состояние "непригоден для использования".

Вам не нужно указывать группы безопасности сети на уровне подсети, так как пакетная служба Azure настраивает собственный группы безопасности сети. Если указанной подсети уже назначены группы безопасности сети и (или) брандмауэр, настройте правила безопасности для входящего и исходящего трафика, как описано выше.

На следующем снимке экрана показано, как конфигурация правила NSG выглядит в портал Azure:

![Снимок экрана с правилами NSG для входящего трафика Вычислительной среды Машинного обучения](./media/how-to-enable-virtual-network/amlcompute-virtual-network-inbound.png)

![Снимок экрана с правилами NSG для исходящего трафика Вычислительной среды Машинного обучения](./media/how-to-enable-virtual-network/experimentation-virtual-network-outbound.png)

### <a id="limiting-outbound-from-vnet"></a>Ограничение исходящего подключения из виртуальной сети

Если вы не хотите использовать правила исходящего трафика по умолчанию и хотите ограничить исходящий доступ к виртуальной сети, выполните следующие действия.

- Запретить исходящее подключение к Интернету с помощью правил NSG

- Ограничьте исходящий трафик к службе хранилища Azure (с помощью __тега службы__ __Storage. Region_Name__ ex. Storage. EastUS), реестр контейнеров Azure (с использованием __тега службы__ __азуреконтаинеррегистри. Region_Name__ ex. Азуреконтаинеррегистри. EastUS) и служба Машинное обучение Azure (с использованием __тега службы__ __азуремачинелеарнинг__)

На следующем снимке экрана показано, как конфигурация правила NSG выглядит в портал Azure:

![Снимок экрана с правилами NSG для исходящего трафика Вычислительной среды Машинного обучения](./media/how-to-enable-virtual-network/limited-outbound-nsg-exp.png)

### <a name="user-defined-routes-for-forced-tunneling"></a>Пользовательские маршруты для принудительного туннелирования

При использовании принудительного туннелирования с Машинное обучение Azureным вычислением необходимо добавить [определяемые пользователем маршруты (UDR)](https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview) в подсеть, содержащую ресурс вычислений.

* Для каждого IP-адреса, используемого пакетной службой Azure в регионе, где существуют ресурсы, должен быть установлен определяемый пользователем маршрут. Эти определяемые пользователем маршруты позволяют пакетной службе взаимодействовать с вычисленными узлами для планирования задач. Чтобы получить список IP-адресов пакетной службы, обратитесь в службу поддержки Azure.

* Исходящий трафик к службе хранилища Azure (в частности, URL `<account>.table.core.windows.net`- `<account>.queue.core.windows.net`адреса формы `<account>.blob.core.windows.net`, и) не должен блокироваться локальным сетевым устройством.

При добавлении определяемых пользователем маршрутов определите маршрут для каждого соответствующего префикса IP-адреса пакета и задайте для параметра __тип следующего прыжка__ значение __Интернет__. На следующем рисунке показан пример UDR в портал Azure:

![Пример определяемого пользователем маршрута для префикса адреса](./media/how-to-enable-virtual-network/user-defined-route.png)

Дополнительные сведения см. в статье [Создание пула пакетной службы Azure в виртуальной сети](../../batch/batch-virtual-network.md#user-defined-routes-for-forced-tunneling) .

### <a name="create-machine-learning-compute-in-a-virtual-network"></a>Создание Вычислительной среды Машинного обучения в виртуальной сети

Чтобы создать кластер Машинное обучение Azure Compute с помощью портал Azure, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com) и выберите рабочее пространство Службы машинного обучения Azure.

1. В разделе __Приложение__ выберите __Вычисления__. Затем выберите __Добавить Вычислительную среду__.

1. Чтобы настроить использование виртуальной сети для этого вычислительного ресурса, укажите следующие параметры:

    - __Конфигурация сети__. Нажмите кнопку __Advanced__ (Дополнительно).

    - __Группа ресурсов.__ Выберите группу ресурсов, которая содержит нужную виртуальную сеть.

    - __Виртуальная сеть.__ Выберите виртуальную сеть, которая содержит нужную подсеть.

    - __Подсеть.__ Выберите подсеть, которую вы намерены использовать.

   ![Снимок экрана с параметрами виртуальной сети для вычислительной среды машинного обучения](./media/how-to-enable-virtual-network/amlcompute-virtual-network-screen.png)

Вы также можете создать кластер Вычислительной среды Машинного обучения с помощью пакета SDK для Машинного обучения Azure. Следующий код создает новый кластер Вычислительной среды Машинного обучения в подсети `default`, размещенной в виртуальной сети с именем `mynetwork`:

```python
from azureml.core.compute import ComputeTarget, AmlCompute
from azureml.core.compute_target import ComputeTargetException

# The Azure virtual network name, subnet, and resource group
vnet_name = 'mynetwork'
subnet_name = 'default'
vnet_resourcegroup_name = 'mygroup'

# Choose a name for your CPU cluster
cpu_cluster_name = "cpucluster"

# Verify that cluster does not exist already
try:
    cpu_cluster = ComputeTarget(workspace=ws, name=cpu_cluster_name)
    print("Found existing cpucluster")
except ComputeTargetException:
    print("Creating new cpucluster")

    # Specify the configuration for the new cluster
    compute_config = AmlCompute.provisioning_configuration(vm_size="STANDARD_D2_V2",
                                                           min_nodes=0,
                                                           max_nodes=4,
                                                           vnet_resourcegroup_name=vnet_resourcegroup_name,
                                                           vnet_name=vnet_name,
                                                           subnet_name=subnet_name)

    # Create the cluster with the specified name and configuration
    cpu_cluster = ComputeTarget.create(ws, cpu_cluster_name, compute_config)

    # Wait for the cluster to complete, show the output log
    cpu_cluster.wait_for_completion(show_output=True)
```

По завершении процесса создания вы обучите модель с помощью кластера в эксперименте. Дополнительные сведения вы найдете в статье [Настройка целевых объектов вычислений для обучения моделей](how-to-set-up-training-targets.md).

## <a name="use-a-virtual-machine-or-hdinsight-cluster"></a>Использование виртуальной машины или кластера HDInsight

Чтобы использовать виртуальную машину или кластер Azure HDInsight в виртуальной сети с рабочей областью, выполните следующие действия.

1. Создайте виртуальную машину или кластер HDInsight с помощью портала Azure или Azure CLI, а затем поместите в виртуальную сеть Azure. Дополнительные сведения см. в следующих документах:
    * [Создание и администрирование виртуальных сетей Azure для виртуальных машин Linux](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-virtual-network)

    * [Расширение возможностей HDInsight с помощью виртуальной сети Azure](https://docs.microsoft.com/azure/hdinsight/hdinsight-extend-hadoop-virtual-network).

1. Чтобы служба Машинное обучение Azure могла взаимодействовать с портом SSH на виртуальной машине или в кластере, необходимо настроить запись источника для группы безопасности сети. Обычно для SSH используется порт 22. Чтобы разрешить трафик из этого источника, выполните следующие действия.

    * __Источник__. Выберите __Service Tag__ (Тег службы).

    * __Тег службы источника__. Выберите __AzureMachineLearning__.

    * __Диапазоны исходных портов__. Выберите __*__ .

    * __Назначение__. Выберите __Любые__.

    * __Диапазоны портов назначения__. Выберите __22__.

    * __Протокол__: Выберите __Любые__.

    * __Действие__: Выберите __Разрешить__.

   ![Снимок экрана с правилами для входящего трафика, настроенными для экспериментирования на виртуальной машине или в кластере HDInsight в виртуальной сети](./media/how-to-enable-virtual-network/experimentation-virtual-network-inbound.png)

    Примите правила исходящего трафика по умолчанию для группы безопасности сети. Дополнительные сведения см. в описании стандартных правил безопасности в статье [о группах безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview#default-security-rules).

    Если вы не хотите использовать правила исходящего трафика по умолчанию и хотите ограничить исходящий доступ к виртуальной сети, см. раздел Ограничение исходящих [подключений из виртуальной сети](#limiting-outbound-from-vnet) .

1. Подключите виртуальную машину или кластер HDInsight к рабочей области Службы машинного обучения Azure. Дополнительные сведения вы найдете в статье [Настройка целевых объектов вычислений для обучения моделей](how-to-set-up-training-targets.md).

> [!IMPORTANT]
> Служба машинного обучения Azure поддерживает только виртуальные машины под управлением Ubuntu.

## <a name="use-azure-kubernetes-service"></a>Применение службы контейнеров Azure

Чтобы добавить службу Azure Kubernetes в виртуальную сеть в рабочую область, выполните следующие действия в портал Azure.

1. Убедитесь, что в группе безопасности сети (NSG), управляющей виртуальной сетью, включено правило входящего трафика для службы Машинное обучение Azure, использующей __азуремачинелеарнинг__ в качестве **источника**.

    ![Добавление вычислительной среды в Службу машинного обучения Azure](./media/how-to-enable-virtual-network/aks-vnet-inbound-nsg-aml.png)

1. Войдите на [портал Azure](https://portal.azure.com) и выберите рабочее пространство Службы машинного обучения Azure.

1. В разделе __Приложение__ выберите __Вычисления__. Затем выберите __Добавить Вычислительную среду__.

1. Чтобы настроить использование виртуальной сети для этого вычислительного ресурса, укажите следующие параметры:

    - __Конфигурация сети__. Нажмите кнопку __Advanced__ (Дополнительно).

    - __Группа ресурсов.__ Выберите группу ресурсов, которая содержит нужную виртуальную сеть.

    - __Виртуальная сеть.__ Выберите виртуальную сеть, которая содержит нужную подсеть.

    - __Подсеть.__ Выберите подсеть.

    - __Диапазон адресов службы Kubernetes.__ Выберите диапазон адресов службы Kubernetes. Для определения диапазона доступных IP-адресов используется нотация CIDR. Этот диапазон IP-адресов не должен пересекаться с диапазонами любой подсети. Пример: 10.0.0.0/16.

    - __IP-адрес службы доменных имен (DNS) Kubernetes.__ Выберите IP-адрес службы доменных имен Kubernetes. Это IP-адрес, назначенный службе DNS Kubernetes. Он должен находиться в пределах диапазона адресов службы Kubernetes. Пример: 10.0.0.10

    - __Адрес моста Docker.__ Выберите адрес моста Docker. Этот IP-адрес, назначенный мосту Docker. Он не должен пересекаться с диапазоном IP-адресов, выделенным для любой подсети или службы Kubernetes. Пример: 172.17.0.1/16.

   ![Служба машинного обучения Azure. Параметры виртуальной сети для Вычислительной среды Машинного обучения](./media/how-to-enable-virtual-network/aks-virtual-network-screen.png)

1. Убедитесь, что в группе NSG, управляющей виртуальной сетью, включено правило безопасности входящего трафика для конечной точки оценки, чтобы ее можно было вызывать извне виртуальной сети.

    ![Добавление вычислительной среды в Службу машинного обучения Azure](./media/how-to-enable-virtual-network/aks-vnet-inbound-nsg-scoring.png)

    > [!TIP]
    > Если в вашей виртуальной сети уже есть кластер AKS, можно подключить его к рабочему пространству. Дополнительные сведения см. в статье [о развертывании в Службе Azure Kubernetes](how-to-deploy-to-aks.md).

> [!IMPORTANT]
> Проверьте предварительные требования и спланируйте IP-адресацию для кластера, прежде чем продолжить выполнение описанных выше действий. Дополнительные сведения см. в статье [Настройка расширенных параметров сети в Службе Azure Kubernetes (AKS)](https://docs.microsoft.com/azure/aks/configure-advanced-networking).
>
>
> Сохраните правила по умолчанию для исходящего трафика для группы безопасности сети. Дополнительные сведения см. в описании стандартных правил безопасности в статье [о группах безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview#default-security-rules).
>
> Служба Azure Kubernetes и виртуальная сеть Azure должны находиться в одном регионе.

Вы также можете использовать **пакет SDK для Машинного обучения Azure**, чтобы добавить в виртуальную сеть Службу Azure Kubernetes. Следующий код создает новый кластер Службы Azure Kubernetes в подсети `default`, размещенной в виртуальной сети с именем `mynetwork`:

```python
from azureml.core.compute import ComputeTarget, AksCompute

# Create the compute configuration and set virtual network information
config = AksCompute.provisioning_configuration(location="eastus2")
config.vnet_resourcegroup_name = "mygroup"
config.vnet_name = "mynetwork"
config.subnet_name = "default"
config.service_cidr = "10.0.0.0/16"
config.dns_service_ip = "10.0.0.10"
config.docker_bridge_cidr = "172.17.0.1/16"

# Create the compute target
aks_target = ComputeTarget.create(workspace=ws,
                                  name="myaks",
                                  provisioning_configuration=config)
```

По завершении процесса создания вы можете вывести или оценить в кластере AKS за пределами виртуальной сети. Дополнительные сведения см. в статье [о развертывании в Службе Azure Kubernetes](how-to-deploy-to-aks.md).

## <a name="next-steps"></a>Следующие шаги

* [Настройка сред обучения](how-to-set-up-training-targets.md)
* [Где следует развертывать модели](how-to-deploy-and-where.md)
* [Безопасное развертывание моделей с помощью SSL](how-to-secure-web-service.md)

