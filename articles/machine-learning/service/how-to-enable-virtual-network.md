---
title: Безопасные эксперименты и вывод в виртуальной сети
titleSuffix: Azure Machine Learning service
description: Узнайте, как обеспечить безопасность заданий экспериментирования и обучения, а кроме заданий вывода и оценки в Машинное обучение Azure в виртуальной сети Azure.
services: machine-learning
ms.service: machine-learning
ms.subservice: core
ms.topic: conceptual
ms.reviewer: jmartens
ms.author: aashishb
author: aashishb
ms.date: 08/05/2019
ms.openlocfilehash: 1b5e3777109b13baa7d774a524664551798ba4ca
ms.sourcegitcommit: a6888fba33fc20cc6a850e436f8f1d300d03771f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/16/2019
ms.locfileid: "69558199"
---
# <a name="secure-azure-ml-experimentation-and-inference-jobs-within-an-azure-virtual-network"></a>Защита заданий экспериментирования и вывода машинного обучения Azure в виртуальной сети Azure

В этой статье вы узнаете, как защитить задания экспериментирования и обучения, а также задания определения и оценки в Машинное обучение Azure в виртуальной сети Azure. 

**Виртуальная сеть** выступает в качестве границы безопасности, изолируя ресурсы Azure из общедоступного Интернета. Также вы можете подключить виртуальную сеть Azure к локальной сети. Присоединяясь к сетям, вы можете безопасно обучать модели и получать доступ к развернутым моделям для вывода.

Служба машинного обучения Azure использует вычислительные ресурсы других служб Azure. Для обучения и развертывания моделей используются ресурсы вычислений или [целевые объекты вычислений](concept-compute-target.md). Целевые объекты можно создать в виртуальной сети. Например, виртуальную машину Майкрософт для обработки и анализа данных можно использовать для обучения модели, а затем развертывания модели в службе Azure Kubernetes Service (AKS). Дополнительные сведения о виртуальных сетях см. в статье [Общие сведения о виртуальной сети Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-overview).

В этой статье также содержатся подробные сведения о *дополнительных параметрах безопасности*, сведения, которые не требуются для основных или экспериментальных вариантов использования. В некоторых разделах этой статьи содержатся сведения о конфигурации для различных сценариев. Вам не нужно выполнять инструкции по порядку или целиком.

## <a name="prerequisites"></a>Предварительные требования

+ [Рабочая область](how-to-manage-workspace.md)службы машинное обучение Azure. 

+ Общие сведения о [службе виртуальной сети Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-overview) и [IP-сети](https://docs.microsoft.com/azure/virtual-network/virtual-network-ip-addresses-overview-arm). 

+ Предварительно Существующая виртуальная сеть и подсеть для использования с ресурсами вычислений. 

## <a name="use-a-storage-account-for-your-workspace"></a>Использование учетной записи хранения для рабочей области

Чтобы использовать учетную запись хранения Azure для рабочей области в виртуальной сети, выполните следующие действия.

1. Создайте вычислительный экземпляр эксперимента (например, Вычислительная среда Машинного обучения экземпляр) за виртуальной сетью или подключите вычислительный экземпляр эксперимента к рабочей области (например, к кластеру HDInsight или виртуальной машине). 

   Дополнительные сведения см. в разделах "использование Вычислительная среда Машинного обучения экземпляра" и "использование виртуальной машины или кластера HDInsight" этой статьи.

1. В портал Azure перейдите к хранилищу, подключенному к рабочей области. 

   ![Хранилище, подключенное к рабочей области службы Машинное обучение Azure](./media/how-to-enable-virtual-network/workspace-storage.png)

1. На странице Служба **хранилища Azure** выберите __брандмауэры и виртуальные сети__. 

   ![Область "брандмауэры и виртуальные сети" на странице службы хранилища Azure в портал Azure](./media/how-to-enable-virtual-network/storage-firewalls-and-virtual-networks.png)

1. На странице __брандмауэры и виртуальные сети__ выполните следующие действия.
    - Выберите __Выбранные сети__.
    - В разделе __виртуальные сети__щелкните ссылку __Добавить существующую виртуальную сеть__ . Это действие добавляет виртуальную сеть, в которой размещается вычислительный экземпляр эксперимента (см. шаг 1).
    - Установите флажок __разрешить доверенным службам Майкрософт доступ к этой учетной записи хранения__ .

   ![Панель "брандмауэры и виртуальные сети" в портал Azure](./media/how-to-enable-virtual-network/storage-firewalls-and-virtual-networks-page.png)

1. При запуске эксперимента в коде эксперимента измените конфигурацию запуска для использования хранилища BLOB-объектов Azure:

    ```python
    run_config.source_directory_data_store = "workspaceblobstore"
    ```

> [!IMPORTANT]
> _Учетную запись хранения по умолчанию_ для службы машинное обучение Azure можно разместить в виртуальной сети _только для экспериментов_.
>
> _Учетные записи хранения, отличные от используемых по умолчанию_ , можно разместить в виртуальной сети _только для экспериментов_.
>
> Учетные записи хранения по умолчанию и не по умолчанию, используемые для _вывода_ , должны иметь неограниченный _доступ к учетной записи хранения_.
>
> Если вы не уверены, что вы изменили параметры, см. раздел "изменение правила доступа к сети по умолчанию" статьи [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](https://docs.microsoft.com/azure/storage/common/storage-network-security). Следуйте инструкциям, чтобы разрешить доступ из всех сетей во время вывода или оценки модели.

## <a name="use-a-key-vault-instance-with-your-workspace"></a>Использование экземпляра хранилища ключей с рабочей областью

Экземпляр хранилища ключей, связанный с рабочей областью, используется службой Машинное обучение Azure для хранения следующих учетных данных:
* Строка подключения связанной учетной записи хранения
* Пароли для экземпляров репозитория контейнеров Azure
* Строки подключения к хранилищам данных

Чтобы использовать Машинное обучение Azure возможности экспериментов с Azure Key Vault за виртуальной сетью, выполните следующие действия.
1. Перейдите в хранилище ключей, связанное с рабочей областью. 

   ![Хранилище ключей, связанное с рабочей областью службы Машинное обучение Azure](./media/how-to-enable-virtual-network/workspace-key-vault.png)

1. На странице **Key Vault** в левой области выберите __брандмауэры и виртуальные сети__. 

   ![Раздел "брандмауэры и виртуальные сети" в области Key Vault](./media/how-to-enable-virtual-network/key-vault-firewalls-and-virtual-networks.png)

1. На странице __брандмауэры и виртуальные сети__ выполните следующие действия.
    - В разделе __Разрешить доступ из__ щелкните __Выбранные сети__.
    - В разделе __виртуальные сети__выберите __Добавить существующие виртуальные сети__ , чтобы добавить виртуальную сеть, в которой находится экземпляр вычислений экспериментирования.
    - В разделе __разрешить доверенным службам Майкрософт обходить этот брандмауэр__выберите __Да__.

   ![Раздел "брандмауэры и виртуальные сети" в области Key Vault](./media/how-to-enable-virtual-network/key-vault-firewalls-and-virtual-networks-page.png)

## <a name="use-a-machine-learning-compute-instance"></a>Использование экземпляра Вычислительная среда Машинного обучения

Чтобы использовать Машинное обучение Azure вычислительного экземпляра в виртуальной сети, учитывайте следующие требования к сети.

- Виртуальная сеть должна размещаться в той же подписке и том же регионе, что и рабочая область Службы машинного обучения Azure.

- Подсеть, указанная для кластера вычислений, должна иметь достаточное число неназначенных IP-адресов, чтобы соответствовать количеству виртуальных машин, нацеленных на кластер. Если в подсети нет достаточного количества свободных IP-адресов, кластер будет выделен частично.

- Если вы планируете защитить виртуальную сеть путем ограниченного трафика, оставьте некоторые порты открытыми для службы вычислений. Дополнительные сведения см. в разделе [Требуемые порты](#mlcports).

- Убедитесь, что политики безопасности или блокировки в подписке или группе ресурсов виртуальной сети ограничивают разрешения для управления виртуальной сетью.

- Если планируется разместить несколько кластеров вычислений в одной виртуальной сети, может потребоваться увеличить квоту для одного или нескольких ресурсов.

    Вычислительная среда Машинного обучения экземпляр автоматически выделяет дополнительные сетевые ресурсы в группе ресурсов, содержащей виртуальную сеть. Для каждого кластера вычислений Служба выделяет следующие ресурсы:

    - Одна группа безопасности сети

    - Один общедоступный IP-адрес

    - Один балансировщик нагрузки

  Эти ресурсы ограничены [квотами ресурсов](https://docs.microsoft.com/azure/azure-subscription-service-limits) в подписке.

### <a id="mlcports"></a> Требуемые порты

Сейчас Вычислительная среда Машинного обучения использует пакетную службу Azure для подготовки виртуальных машин в указанной виртуальной сети. Это означает, что подсеть должна разрешать входящие подключения из пакетной службы. Это взаимодействие можно использовать для планирования выполнения на узлах Вычислительная среда Машинного обучения, а также для взаимодействия с хранилищем Azure и другими ресурсами. Пакетная служба добавляет группы безопасности сети (группы безопасности сети) на уровне сетевых интерфейсов (NIC), подключенных к виртуальным машинам. Эти группы безопасности сети автоматически настраивают правила для входящего и исходящего трафика, чтобы разрешить следующий трафик:

- Входящий TCP-трафик на портах 29876 и 29877 из __тега службы__ __батчнодеманажемент__.

    ![Правило входящего трафика, использующее тег службы Батчнодеманажемент](./media/how-to-enable-virtual-network/batchnodemanagement-service-tag.png)

- Используемых Входящий TCP-трафик через порт 22 для разрешения удаленного доступа. Используйте этот порт только в том случае, если вы хотите подключиться по протоколу SSH на общедоступном IP-адресе.

- Исходящий трафик в виртуальную сеть на любом порту.

- Исходящий трафик в Интернет на любом порту.

Соблюдайте осторожность, если вы изменяете или добавляете правила для входящего и исходящего трафика в группах безопасности сети, настроенных для пакетной службы. Если NSG блокирует обмен данными с вычисленными узлами, Служба вычислений устанавливает для них состояние "непригоден для использования".

Вам не нужно указывать группы безопасности сети на уровне подсети, так как пакетная служба Azure настраивает собственный группы безопасности сети. Однако если указанная подсеть связана с группы безопасности сети или брандмауэром, настройте правила безопасности для входящего и исходящего трафика, как упоминалось ранее.

Конфигурация правила NSG в портал Azure показана на следующих изображениях:

![Правила NSG для входящего трафика для Вычислительная среда Машинного обучения](./media/how-to-enable-virtual-network/amlcompute-virtual-network-inbound.png)

![Правила исходящего NSG для Вычислительная среда Машинного обучения](./media/how-to-enable-virtual-network/experimentation-virtual-network-outbound.png)

### <a id="limiting-outbound-from-vnet"></a>Ограничение исходящего подключения из виртуальной сети

Если вы не хотите использовать правила исходящего трафика по умолчанию и вы хотите ограничить исходящий доступ к виртуальной сети, выполните следующие действия.

- Запрет исходящего подключения к Интернету с помощью правил NSG.

- Ограничить исходящий трафик следующими:
   - Служба хранилища Azure с помощью __тега службы__ __Storage. Region_Name__ (например, Storage. EastUS).
   - Реестр контейнеров Azure с помощью __тега службы__ __азуреконтаинеррегистри. Region_Name__ (например, азуреконтаинеррегистри. EastUS).
   - Машинное обучение Azure служба с помощью __тега службы__ __азуремачинелеарнинг__

Конфигурация правила NSG на портал Azure показана на следующем рисунке:

![Правила исходящего NSG для Вычислительная среда Машинного обучения](./media/how-to-enable-virtual-network/limited-outbound-nsg-exp.png)

### <a name="user-defined-routes-for-forced-tunneling"></a>Пользовательские маршруты для принудительного туннелирования

Если вы используете принудительное туннелирование с Вычислительная среда Машинного обучения, добавьте [определяемые пользователем маршруты (определяемые пользователем маршруты)](https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview) в подсеть, содержащую ресурс вычислений.

* Установите UDR для каждого IP-адреса, используемого пакетной службой Azure в регионе, где находятся ваши ресурсы. Эти определяемые пользователем маршруты позволяют пакетной службе взаимодействовать с вычисленными узлами для планирования задач. Чтобы получить список IP-адресов пакетной службы, обратитесь в службу поддержки Azure.

* Исходящий трафик в службу хранилища Azure не должен блокироваться локальным сетевым устройством. В частности, URL-адреса находятся в `<account>.table.core.windows.net`форме `<account>.queue.core.windows.net`, и `<account>.blob.core.windows.net`.

При добавлении определяемые пользователем маршруты определите маршрут для каждого соответствующего префикса IP-адреса пакета и задайте для параметра __тип следующего прыжка__ значение __Интернет__. На следующем рисунке показан пример UDR в портал Azure:

![Пример UDR для префикса адреса](./media/how-to-enable-virtual-network/user-defined-route.png)

Дополнительные сведения см. [в статье Создание пула пакетной службы Azure в виртуальной сети](../../batch/batch-virtual-network.md#user-defined-routes-for-forced-tunneling).

### <a name="create-a-machine-learning-compute-cluster-in-a-virtual-network"></a>Создание кластера Вычислительная среда Машинного обучения в виртуальной сети

Чтобы создать кластер Вычислительная среда Машинного обучения, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com) и выберите рабочее пространство Службы машинного обучения Azure.

1. В разделе __приложение__ выберите пункт __Вычисление__и щелкните __Добавить вычисление__.

1. Чтобы настроить этот ресурс вычислений для использования виртуальной сети, выполните следующие действия.

    1\. В качестве __конфигурации сети__выберите __Дополнительно__.

    2\. В раскрывающемся списке __Группа ресурсов__ выберите группу ресурсов, содержащую виртуальную сеть.

    В. В раскрывающемся списке __Виртуальная сеть__ выберите виртуальную сеть, содержащую подсеть.

    Г. В раскрывающемся списке __подсеть__ выберите подсеть для использования.

   ![Параметры виртуальной сети для Вычислительная среда Машинного обучения](./media/how-to-enable-virtual-network/amlcompute-virtual-network-screen.png)

Вы также можете создать кластер Вычислительной среды Машинного обучения с помощью пакета SDK для Машинного обучения Azure. Следующий код создает новый кластер Вычислительной среды Машинного обучения в подсети `default`, размещенной в виртуальной сети с именем `mynetwork`:

```python
from azureml.core.compute import ComputeTarget, AmlCompute
from azureml.core.compute_target import ComputeTargetException

# The Azure virtual network name, subnet, and resource group
vnet_name = 'mynetwork'
subnet_name = 'default'
vnet_resourcegroup_name = 'mygroup'

# Choose a name for your CPU cluster
cpu_cluster_name = "cpucluster"

# Verify that cluster does not exist already
try:
    cpu_cluster = ComputeTarget(workspace=ws, name=cpu_cluster_name)
    print("Found existing cpucluster")
except ComputeTargetException:
    print("Creating new cpucluster")

    # Specify the configuration for the new cluster
    compute_config = AmlCompute.provisioning_configuration(vm_size="STANDARD_D2_V2",
                                                           min_nodes=0,
                                                           max_nodes=4,
                                                           vnet_resourcegroup_name=vnet_resourcegroup_name,
                                                           vnet_name=vnet_name,
                                                           subnet_name=subnet_name)

    # Create the cluster with the specified name and configuration
    cpu_cluster = ComputeTarget.create(ws, cpu_cluster_name, compute_config)

    # Wait for the cluster to be completed, show the output log
    cpu_cluster.wait_for_completion(show_output=True)
```

По завершении процесса создания вы обучите модель с помощью кластера в эксперименте. Дополнительные сведения вы найдете в статье [Настройка целевых объектов вычислений для обучения моделей](how-to-set-up-training-targets.md).

## <a name="use-a-virtual-machine-or-hdinsight-cluster"></a>Использование виртуальной машины или кластера HDInsight

> [!IMPORTANT]
> Служба Машинное обучение Azure поддерживает только виртуальные машины под управлением Ubuntu.

Чтобы использовать виртуальную машину или кластер Azure HDInsight в виртуальной сети с рабочей областью, выполните следующие действия.

1. Создайте виртуальную машину или кластер HDInsight с помощью портал Azure или Azure CLI и вставьте кластер в виртуальную сеть Azure. Дополнительные сведения см. в следующих статьях:
    * [Создание и администрирование виртуальных сетей Azure для виртуальных машин Linux](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-virtual-network)

    * [Расширение возможностей HDInsight с помощью виртуальной сети Azure](https://docs.microsoft.com/azure/hdinsight/hdinsight-extend-hadoop-virtual-network).

1. Чтобы служба Машинное обучение Azure могла взаимодействовать с портом SSH на виртуальной машине или в кластере, настройте запись источника для группы безопасности сети. Обычно для SSH используется порт 22. Чтобы разрешить трафик из этого источника, выполните следующие действия.

    * В раскрывающемся списке __источник__ выберите __тег службы__.

    * В раскрывающемся списке __тег исходной службы__ выберите __азуремачинелеарнинг__.

    * В раскрывающемся списке __диапазоны исходных портов__ выберите __*__ .

    * В раскрывающемся списке __назначение__ выберите __любой__.

    * В раскрывающемся списке __диапазоны портов назначения выберите значение__ __22__.

    * В разделе __протокол__выберите __любой__.

    * В разделе __действие__выберите __Разрешить__.

   ![Правила для входящих подключений для экспериментов на виртуальной машине или в кластере HDInsight в виртуальной сети](./media/how-to-enable-virtual-network/experimentation-virtual-network-inbound.png)

    Примите правила исходящего трафика по умолчанию для группы безопасности сети. Дополнительные сведения см. в описании стандартных правил безопасности в статье [о группах безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview#default-security-rules).

    Если вы не хотите использовать правила исходящего трафика по умолчанию и вы хотите ограничить исходящий доступ к виртуальной сети, см. раздел [ограничение исходящего подключения в виртуальной сети](#limiting-outbound-from-vnet) .

1. Подключите виртуальную машину или кластер HDInsight к рабочей области Службы машинного обучения Azure. Дополнительные сведения вы найдете в статье [Настройка целевых объектов вычислений для обучения моделей](how-to-set-up-training-targets.md).

## <a name="use-azure-kubernetes-service-aks"></a>Применение службы Azure Kubernetes (AKS)

Чтобы добавить AKS в виртуальную сеть в рабочую область, выполните следующие действия.

> [!IMPORTANT]
> Прежде чем приступить к описанной ниже процедуре, проверьте предварительные требования и запланируйте IP-адресацию для кластера. Дополнительные сведения см. в статье [Настройка расширенных параметров сети в Службе Azure Kubernetes (AKS)](https://docs.microsoft.com/azure/aks/configure-advanced-networking).
>
> Экземпляр AKS и виртуальная сеть Azure должны находиться в одном регионе.

1. В [портал Azure](https://portal.azure.com)убедитесь, что NSG, управляющий виртуальной сетью, имеет правило входящего трафика, включенное для службы машинное обучение Azure, с помощью __Азуремачинелеарнинг__ в качестве **источника**.

    ![Панель вычислений Добавление Машинное обучение Azure службы](./media/how-to-enable-virtual-network/aks-vnet-inbound-nsg-aml.png)

1. Выберите рабочую область службы Машинное обучение Azure.

1. В разделе __приложение__ выберите пункт __Вычисление__и щелкните __Добавить вычисление__.

1. Чтобы настроить этот ресурс вычислений для использования виртуальной сети, выполните следующие действия.

    - В качестве __конфигурации сети__выберите __Дополнительно__.

    - В раскрывающемся списке __Группа ресурсов__ выберите группу ресурсов, содержащую виртуальную сеть.

    - В раскрывающемся списке __Виртуальная сеть__ выберите виртуальную сеть, содержащую подсеть.

    - В раскрывающемся списке __подсеть__ выберите подсеть.

    - В поле __диапазон адресов службы Kubernetes__ введите диапазон адресов службы Kubernetes. Этот диапазон адресов использует диапазон IP-адресов нотации, определяющий междоменную маршрутизацию (CIDR), чтобы определить IP-адреса, доступные для кластера. Он не должен пересекаться с диапазонами IP-адресов подсети (например, 10.0.0.0/16).

    - В поле __IP-адрес службы DNS Kubernetes__ введите IP-адрес службы DNS Kubernetes. Это IP-адрес, назначенный службе DNS Kubernetes. Он должен находиться в диапазоне адресов службы Kubernetes (например, 10.0.0.10).

    - В поле __адрес моста DOCKER__ введите адрес моста DOCKER. Этот IP-адрес, назначенный мосту Docker. Он не должен находиться в диапазонах IP-адресов подсети или в диапазоне номеров служб Kubernetes (например, 172.17.0.1/16).

   ![Служба машинного обучения Azure. Параметры виртуальной сети для Вычислительной среды Машинного обучения](./media/how-to-enable-virtual-network/aks-virtual-network-screen.png)

1. Убедитесь, что в группе NSG, управляющей виртуальной сетью, включено правило безопасности входящего трафика для конечной точки оценки, чтобы ее можно было вызывать извне виртуальной сети.
   > [!IMPORTANT]
   > Сохраните правила по умолчанию для исходящего трафика для группы безопасности сети. Дополнительные сведения см. в описании стандартных правил безопасности в статье [о группах безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview#default-security-rules).
  
   ![Правило безопасности для входящего трафика](./media/how-to-enable-virtual-network/aks-vnet-inbound-nsg-scoring.png)

Вы также можете добавить службу Kubernetes Azure в виртуальную сеть с помощью пакета SDK для Машинное обучение Azure. Если у вас уже есть кластер AKS в виртуальной сети, подключите его к рабочей области, как описано в разделе [развертывание в AKS](how-to-deploy-to-aks.md). Следующий код создает новый экземпляр AKS в `default` подсети виртуальной сети с именем: `mynetwork`

```python
from azureml.core.compute import ComputeTarget, AksCompute

# Create the compute configuration and set virtual network information
config = AksCompute.provisioning_configuration(location="eastus2")
config.vnet_resourcegroup_name = "mygroup"
config.vnet_name = "mynetwork"
config.subnet_name = "default"
config.service_cidr = "10.0.0.0/16"
config.dns_service_ip = "10.0.0.10"
config.docker_bridge_cidr = "172.17.0.1/16"

# Create the compute target
aks_target = ComputeTarget.create(workspace=ws,
                                  name="myaks",
                                  provisioning_configuration=config)
```

После завершения процесса создания можно выполнить вывод или оценку модели в кластере AKS за пределами виртуальной сети. Дополнительные сведения см. в статье [о развертывании в Службе Azure Kubernetes](how-to-deploy-to-aks.md).

## <a name="next-steps"></a>Следующие шаги

* [Настройка сред обучения](how-to-set-up-training-targets.md)
* [Где следует развертывать модели](how-to-deploy-and-where.md)
* [Безопасное развертывание моделей с помощью SSL](how-to-secure-web-service.md)

