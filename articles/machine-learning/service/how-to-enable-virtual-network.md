---
title: Выполнение экспериментов и вывод в виртуальной сети
titleSuffix: Azure Machine Learning service
description: Выполняйте эксперименты машинного обучения и формируйте выводы в защищенной виртуальной сети Azure. Сведения о создании целевых объектов вычислений для обучения модели и формировании вывода в виртуальной сети. Сведения о требованиях к защищенным виртуальным сетям, например обязательные входящие и исходящие порты.
services: machine-learning
ms.service: machine-learning
ms.subservice: core
ms.topic: conceptual
ms.reviewer: jmartens
ms.author: aashishb
author: aashishb
ms.date: 01/08/2019
ms.openlocfilehash: f1cb7c9aa0844c82acd333c4f9dd87a4dda013e7
ms.sourcegitcommit: 3e98da33c41a7bbd724f644ce7dedee169eb5028
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/17/2019
ms.locfileid: "67165345"
---
# <a name="securely-run-experiments-and-inference-inside-an-azure-virtual-network"></a>Безопасным образом запускать эксперименты и вывод внутри виртуальной сети Azure

В этой статье вы узнаете, как для выполнения экспериментов и вывод внутри виртуальной сети. Виртуальная сеть выполняет роль границы безопасности, изолируя ресурсы Azure от общедоступного Интернета. Также вы можете подключить виртуальную сеть Azure к локальной сети. Он позволяет безопасно Обучение модели и получить доступ к развернутой модели для вывода. Определение или модель оценки, — это этап, где используется развернутой модели для прогнозирования, чаще всего для производственных данных.

Служба машинного обучения Azure использует вычислительные ресурсы других служб Azure. Вычислительные ресурсы (целевые объекты вычислений) используются для обучения и развертывания моделей. Эти целевые объекты вычислений могут создаваться в виртуальной сети. Например, вы можете обучить модель с помощью Виртуальной машины обработки и анализа данных корпорации Майкрософт, а затем развернуть модель в Службе Azure Kubernetes (AKS). См. дополнительные сведения [о виртуальных сетях Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-overview).

## <a name="prerequisites"></a>Технические условия

В этом документе предполагается, что вы знакомы с виртуальными сетями Azure и IP-адрес сети в целом. В этом документе также предполагается, что вы создали виртуальную сеть и подсеть, используемую с ваших вычислительных ресурсов. Если вы не знакомы с виртуальными сетями Azure, в следующих статьях Дополнительные сведения о службе:

* [Назначение IP-адресов](https://docs.microsoft.com/azure/virtual-network/virtual-network-ip-addresses-overview-arm)
* [Группы безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview)
* [Краткое руководство Создание виртуальной сети](https://docs.microsoft.com/azure/virtual-network/quick-create-portal)
* [Фильтрация сетевого трафика](https://docs.microsoft.com/azure/virtual-network/tutorial-filter-network-traffic)

## <a name="storage-account-for-your-workspace"></a>Учетная запись хранения для рабочей области

> [!IMPORTANT]
> __Учетная запись хранения по умолчанию__ для машинного обучения Azure в виртуальной сети можно разместить службу __только при выполнении службы "Экспериментирование"__ .
>
> Для __учетные записи хранения по умолчанию для службы "Экспериментирование"__ , или если вы используете учетную запись хранения для __вывод__, необходимо иметь __неограниченный доступ к учетной записи хранения__.
> 
> Если вы не уверены, изменили ли вы эти параметры, ознакомьтесь с разделом __Изменение сетевого правила доступа по умолчанию__ из статьи [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](https://docs.microsoft.com/azure/storage/common/storage-network-security). Следуйте инструкциям, чтобы разрешить доступ из всех сетей во время вывода или модели оценки.

Чтобы использовать место учетной записи хранилища Azure по умолчанию для рабочей области в виртуальной сети, следуйте инструкциям ниже:

1. Создание вычислений службы "Экспериментирование" ex. Машинного обучения вычислений за виртуальной сети или присоединить к рабочей области, например вычислительные службы "Экспериментирование". Кластер HDInsight или виртуальной машины. Дополнительные сведения см. в разделе [вычислений для использования машинного обучения](#use-machine-learning-compute) и [использовать виртуальную машину или кластера HDInsight](#use-a-virtual-machine-or-hdinsight-cluster) в разделах этого документа
2. Перейдите в хранилище, подключенное к рабочей области. ![Снимок экрана портала Azure: хранилища Azure, подключенный к рабочей области службы машинного обучения Azure](./media/how-to-enable-virtual-network/workspace-storage.png)
3. На странице хранилища Azure, выберите __брандмауэры и виртуальные сети__. ![Снимок экрана: на портале Azure отображаются брандмауэры и виртуальные сети раздела на странице хранилища Azure](./media/how-to-enable-virtual-network/storage-firewalls-and-virtual-networks.png)
4. На __брандмауэры и виртуальные сети__ страницы выберите следующие записи:
    - Выберите __Выбранные сети__.
    - В разделе __виртуальные сети__выберите __добавить существующую виртуальную сеть__ добавить виртуальную сеть, где находится вычислительные службы "Экспериментирование". (См. шаг 1).
    - Выберите __разрешить доверенные службы Майкрософт для доступа к этой учетной записи хранения__.
![Снимок экрана: на портале Azure отображаются брандмауэры и виртуальные сети страницы в службе хранилища Azure](./media/how-to-enable-virtual-network/storage-firewalls-and-virtual-networks-page.png) 

5. Во время выполнения эксперимента, в коде службы "Экспериментирование", измените настройки выполнения для использования хранилища BLOB-объектов:
    ```python
    run_config.source_directory_data_store = "workspaceblobstore"
    ```
    
## <a name="key-vault-for-your-workspace"></a>Хранилище ключей для рабочей области
Экземпляр хранилища ключей, связанный с рабочей областью используется службой машинного обучения Azure для хранения учетных данных разного типа:
* Строка подключения учетной записи хранилища.
* Пароли к экземплярам репозиторий контейнеров Azure
* Строки подключения к данным хранилища. 

Для использования службы "Экспериментирование" машинного обучения Azure возможности с хранилищем ключей службы виртуальной сети выполните следующие действия:
1. Перейдите в хранилище ключей, связанных с рабочей областью. ![Снимок экрана портала Azure: хранилище ключей, которая связана с рабочей области службы машинного обучения Azure](./media/how-to-enable-virtual-network/workspace-key-vault.png)
2. На странице хранилища ключей выберите __брандмауэры и виртуальные сети__ раздел. ![Снимок экрана: на портале Azure отображаются брандмауэры и виртуальные сети раздела на странице хранилища ключей](./media/how-to-enable-virtual-network/key-vault-firewalls-and-virtual-networks.png)
3. На __брандмауэры и виртуальные сети__ страницы выберите следующие записи:
    - Выберите __Выбранные сети__.
    - В разделе __виртуальные сети__выберите __добавить существующие виртуальные сети__ добавить виртуальную сеть, где находится вычислительные службы "Экспериментирование".
    - Выберите __разрешить доверенные службы Майкрософт обходить этот брандмауэр__.
![Изображение на портале Azure отображаются брандмауэры и виртуальные сети в разделе Key Vault](./media/how-to-enable-virtual-network/key-vault-firewalls-and-virtual-networks-page.png) 


## <a name="use-machine-learning-compute"></a>Использование Вычислительной среды Машинного обучения

Чтобы использовать Вычислительную среду Машинного обучения в виртуальной сети, изучите следующие сведения о требованиях к сети.

- Виртуальная сеть должна размещаться в той же подписке и том же регионе, что и рабочая область Службы машинного обучения Azure.

- Указанная для кластера Вычислительной среды Машинного обучения подсеть должна иметь достаточное количество свободных IP-адресов для всех виртуальных машин, которые будут размещаться в этом кластере. Если в подсети нет достаточного количества свободных IP-адресов, кластер будет выделен частично.

- Если вы планируете защитить виртуальную сеть, применив ограничение трафика, оставьте некоторые порты открытыми для службы Вычислительной среды Машинного обучения. Дополнительные сведения см. в разделе [Требуемые порты](#mlcports).

- Проверьте, существуют ли политики безопасности или блокировки в подписке или группе ресурсов виртуальной сети, которые ограничивают права на управление виртуальной сетью.

- Если вы собираетесь разместить в одной виртуальной сети несколько кластеров Вычислительной среды Машинного обучения, может потребоваться увеличить квоту для одного или нескольких ресурсов.

    Вычислительная среда Машинного обучения автоматически выделяет дополнительные сетевые ресурсы в группе ресурсов, которая содержит виртуальную сеть. Служба машинного обучения Azure выделяет для каждого кластера Вычислительной среды Машинного обучения следующие ресурсы.

    - Одна группа безопасности сети (NSG).

    - Один общедоступный IP-адрес

    - Один балансировщик нагрузки

  Эти ресурсы ограничены [квотами ресурсов](https://docs.microsoft.com/azure/azure-subscription-service-limits) в подписке.

### <a id="mlcports"></a> Требуемые порты

Сейчас Вычислительная среда Машинного обучения использует пакетную службу Azure для подготовки виртуальных машин в указанной виртуальной сети. Это означает, что подсеть должна разрешать входящие подключения из пакетной службы. Эта связь используется для планирования выполнений на узлах Вычислительной среды Машинного обучения, а также для взаимодействия со службой хранилища Azure и другими ресурсами. Пакетная служба добавляет группы безопасности сети на уровне сетевых интерфейсов, подключенных к виртуальным машинам. Эти группы безопасности сети автоматически настраивают правила для входящего и исходящего трафика, чтобы разрешить следующий трафик:

- Входящий трафик TCP через порты 29876 и 29877 из __тег службы__ из __BatchNodeManagement__.

    ![Снимок экрана портала Azure: правило для входящего трафика с помощью тега службы BatchNodeManagement](./media/how-to-enable-virtual-network/batchnodemanagement-service-tag.png)
 
- (необязательно) Входящий трафик TCP через порт 22, чтобы разрешить удаленный доступ. Этот порт требуется только в том случае, если вы хотите подключиться с использованием SSH в общедоступный IP-адрес.
 
- Исходящий трафик в виртуальную сеть на любом порту.

- Исходящий трафик в Интернет на любом порту. 

Соблюдайте осторожность, если вы изменяете или добавляете правила для входящего и (или) исходящего трафика в группах безопасности сети, настроенных пакетной службой. Если группа безопасности сети заблокирует связь с вычислительными узлами, служба Вычислительной среды Машинного обучения установит состояние unusable (непригодно) для этих вычислительных узлов.

Вам не нужно указывать группы безопасности сети на уровне подсети, так как пакетная служба настраивает собственные группы. Если указанной подсети уже назначены группы безопасности сети и (или) брандмауэр, настройте правила безопасности для входящего и исходящего трафика, как описано выше. 

На следующем рисунке показан вид конфигурацию правила NSG на портале Azure:

![Снимок экрана с правилами NSG для входящего трафика Вычислительной среды Машинного обучения](./media/how-to-enable-virtual-network/amlcompute-virtual-network-inbound.png)

![Снимок экрана с правилами NSG для исходящего трафика Вычислительной среды Машинного обучения](./media/how-to-enable-virtual-network/experimentation-virtual-network-outbound.png)

### <a id="limiting-outbound-from-vnet"></a> Ограничение исходящие подключения из виртуальной сети

Если вы не хотите использовать исходящие правила по умолчанию и требуется ограничить исходящий доступ виртуальной сети, выполните следующие действия:

- Запретить исходящие подключение к Интернету с помощью правил группы безопасности сети 

- Ограничить исходящий трафик в службу хранилища Azure (с помощью __тег службы__ из __Storage.Region_Name__ ex. Storage.EastUS), реестра контейнеров Azure (с помощью __тег службы__ из __AzureContainerRegistry.Region_Name__ ex. AzureContainerRegistry.EastUS) и службы машинного обучения Azure (с помощью __тег службы__ из __AzureMachineLearning__)

На следующем рисунке показан вид конфигурацию правила NSG на портале Azure:

![Снимок экрана с правилами NSG для исходящего трафика Вычислительной среды Машинного обучения](./media/how-to-enable-virtual-network/limited-outbound-nsg-exp.png)

### <a name="user-defined-routes-for-forced-tunneling"></a>Пользовательские маршруты для принудительного туннелирования

Если вы используете Принудительное туннелирование с помощью вычислений машинного обучения Azure, необходимо добавить [определяемые пользователем маршруты (UDR)](https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview) подсети, которая содержит вычислительные ресурсы.

* Определяемый пользователем маршрут для каждого IP-адреса, используемые службой пакетной службы Azure в регионе, где существуют ресурсы. Эти определяемые пользователем маршруты включить пакетную службу для взаимодействия с вычислительными узлами для планирования задач. Чтобы получить список IP-адресов пакетной службы, обратитесь в службу поддержки Azure.

* Исходящий трафик в службу хранилища Azure (в частности, URL-адреса формы `<account>.table.core.windows.net`, `<account>.queue.core.windows.net`, и `<account>.blob.core.windows.net`) не должна быть заблокирована с устройством в локальной сети.

При добавлении определяемые пользователем маршруты, определить маршрут для каждого связанного префикса адреса IP-адрес пакета и задайте __тип следующего прыжка__ для __Internet__. Ниже показан пример этого определяемого пользователем Маршрута на портале Azure:

![Пример определяемый пользователем маршрут для префикса адреса](./media/how-to-enable-virtual-network/user-defined-route.png)

Дополнительные сведения см. в разделе [создать пул пакетной службы Azure в виртуальной сети](../../batch/batch-virtual-network.md#user-defined-routes-for-forced-tunneling) статьи.

### <a name="create-machine-learning-compute-in-a-virtual-network"></a>Создание Вычислительной среды Машинного обучения в виртуальной сети

Чтобы создать кластер Вычислительной среды Машинного обучения с помощью портала Azure, сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com) и выберите рабочее пространство Службы машинного обучения Azure.

1. В разделе __Приложение__ выберите __Вычисления__. Затем выберите __Добавить Вычислительную среду__. 

    ![Добавление вычислительной среды в Службу машинного обучения Azure](./media/how-to-enable-virtual-network/add-compute.png)

1. Чтобы настроить использование виртуальной сети для этого вычислительного ресурса, укажите следующие параметры:

    - __Конфигурация сети__. Нажмите кнопку __Advanced__ (Дополнительно).

    - __Группа ресурсов.__ Выберите группу ресурсов, которая содержит нужную виртуальную сеть.

    - __Виртуальная сеть__. Выберите виртуальную сеть, которая содержит нужную подсеть.

    - __Подсеть.__ Выберите подсеть, которую вы намерены использовать.

   ![Снимок экрана с параметрами виртуальной сети для вычислительной среды машинного обучения](./media/how-to-enable-virtual-network/amlcompute-virtual-network-screen.png)

Вы также можете создать кластер Вычислительной среды Машинного обучения с помощью пакета SDK для Машинного обучения Azure. Следующий код создает новый кластер Вычислительной среды Машинного обучения в подсети `default`, размещенной в виртуальной сети с именем `mynetwork`:

```python
from azureml.core.compute import ComputeTarget, AmlCompute
from azureml.core.compute_target import ComputeTargetException

# The Azure virtual network name, subnet, and resource group
vnet_name = 'mynetwork'
subnet_name = 'default'
vnet_resourcegroup_name = 'mygroup'

# Choose a name for your CPU cluster
cpu_cluster_name = "cpucluster"

# Verify that cluster does not exist already
try:
    cpu_cluster = ComputeTarget(workspace=ws, name=cpu_cluster_name)
    print("Found existing cpucluster")
except ComputeTargetException:
    print("Creating new cpucluster")
    
    # Specify the configuration for the new cluster
    compute_config = AmlCompute.provisioning_configuration(vm_size="STANDARD_D2_V2",
                                                           min_nodes=0,
                                                           max_nodes=4,
                                                           vnet_resourcegroup_name = vnet_resourcegroup_name,
                                                           vnet_name = vnet_name,
                                                           subnet_name = subnet_name)

    # Create the cluster with the specified name and configuration
    cpu_cluster = ComputeTarget.create(ws, cpu_cluster_name, compute_config)
    
    # Wait for the cluster to complete, show the output log
    cpu_cluster.wait_for_completion(show_output=True)
```

Когда завершится процесс создания, переходите к обучению модели с помощью кластера. Дополнительные сведения вы найдете в статье [Настройка целевых объектов вычислений для обучения моделей](how-to-set-up-training-targets.md).

## <a name="use-a-virtual-machine-or-hdinsight-cluster"></a>Использование виртуальной машины или кластера HDInsight

Чтобы в виртуальной сети с рабочим пространством использовать виртуальную машину или кластер HDInsight, выполните инструкции ниже.

> [!IMPORTANT]
> Служба машинного обучения Azure поддерживает только виртуальные машины под управлением Ubuntu.

1. Создайте виртуальную машину или кластер HDInsight с помощью портала Azure или Azure CLI, а затем поместите в виртуальную сеть Azure. Дополнительные сведения см. в следующих документах:
    * [Создание и администрирование виртуальных сетей Azure для виртуальных машин Linux](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-virtual-network)

    * [Расширение возможностей HDInsight с помощью виртуальной сети Azure](https://docs.microsoft.com/azure/hdinsight/hdinsight-extend-hadoop-virtual-network). 

1. Чтобы разрешить Службе машинного обучения Azure обращаться к порту SSH виртуальной машины или кластера, следует настроить для группы безопасности сети запись с данными об источнике. Обычно для SSH используется порт 22. Чтобы разрешить трафик от этого источника, укажите следующие данные:

    * __Источник__. Выберите __Service Tag__ (Тег службы).

    * __Тег службы источника__. Выберите __AzureMachineLearning__.

    * __Диапазоны исходных портов__. Выберите __*__ .

    * __Назначение__. Выберите __Любые__.

    * __Диапазоны портов назначения__. Выберите __22__.

    * __Протокол__: Выберите __Любые__.

    * __Действие__: Выберите __Разрешить__.

   ![Снимок экрана с правилами для входящего трафика, настроенными для экспериментирования на виртуальной машине или в кластере HDInsight в виртуальной сети](./media/how-to-enable-virtual-network/experimentation-virtual-network-inbound.png)

    Сохраните правила по умолчанию для исходящего трафика для группы безопасности сети. Дополнительные сведения см. в описании стандартных правил безопасности в статье [о группах безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview#default-security-rules).

    Если вы не хотите использовать исходящие правила по умолчанию и хотите ограничить исходящий доступ виртуальной сети, см. в разделе [ограничение исходящие подключения из виртуальной сети](#limiting-outbound-from-vnet)
    
1. Подключите виртуальную машину или кластер HDInsight к рабочей области Службы машинного обучения Azure. Дополнительные сведения вы найдете в статье [Настройка целевых объектов вычислений для обучения моделей](how-to-set-up-training-targets.md).

## <a name="use-azure-kubernetes-service"></a>Применение службы контейнеров Azure

> [!IMPORTANT]
> Проверьте предварительные требования и распределите для кластера IP-адреса, прежде чем переходить к описанным ниже действиям. Дополнительные сведения см. в статье [Настройка расширенных параметров сети в Службе Azure Kubernetes (AKS)](https://docs.microsoft.com/azure/aks/configure-advanced-networking).
> 
>
> Сохраните правила по умолчанию для исходящего трафика для группы безопасности сети. Дополнительные сведения см. в описании стандартных правил безопасности в статье [о группах безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview#default-security-rules).
>
> Служба Azure Kubernetes и виртуальная сеть Azure должны находиться в одном регионе.

Чтобы добавить к рабочему пространству Службу Azure Kubernetes, размещенную в виртуальной сети, выполните на портале Azure следующие шаги:

1. Убедитесь, что группа безопасности сети группирование, элементы управления, виртуальная сеть имеет входящее правило, включено для службы машинного обучения Azure с помощью __тег службы__ из __AzureMachineLearning__

    ![Добавление вычислительной среды в Службу машинного обучения Azure](./media/how-to-enable-virtual-network/aks-vnet-inbound-nsg-aml.png)     
 
1. Войдите на [портал Azure](https://portal.azure.com) и выберите рабочее пространство Службы машинного обучения Azure.

1. В разделе __Приложение__ выберите __Вычисления__. Затем выберите __Добавить Вычислительную среду__. 

    ![Добавление вычислительной среды в Службу машинного обучения Azure](./media/how-to-enable-virtual-network/add-compute.png)

1. Чтобы настроить использование виртуальной сети для этого вычислительного ресурса, укажите следующие параметры:

    - __Конфигурация сети__. Нажмите кнопку __Advanced__ (Дополнительно).

    - __Группа ресурсов.__ Выберите группу ресурсов, которая содержит нужную виртуальную сеть.

    - __Виртуальная сеть__. Выберите виртуальную сеть, которая содержит нужную подсеть.

    - __Подсеть.__ Выберите подсеть.

    - __Диапазон адресов службы Kubernetes.__ Выберите диапазон адресов службы Kubernetes. Для определения диапазона доступных IP-адресов используется нотация CIDR. Этот диапазон IP-адресов не должен пересекаться с диапазонами любой подсети. Пример: 10.0.0.0/16.

    - __IP-адрес службы доменных имен (DNS) Kubernetes.__ Выберите IP-адрес службы доменных имен Kubernetes. Это IP-адрес, назначенный службе DNS Kubernetes. Он должен находиться в пределах диапазона адресов службы Kubernetes. Пример: 10.0.0.10

    - __Адрес моста Docker.__ Выберите адрес моста Docker. Этот IP-адрес, назначенный мосту Docker. Он не должен пересекаться с диапазоном IP-адресов, выделенным для любой подсети или службы Kubernetes. Пример: 172.17.0.1/16.

   ![Служба машинного обучения Azure. Параметры виртуальной сети для Вычислительной среды Машинного обучения](./media/how-to-enable-virtual-network/aks-virtual-network-screen.png)

1. Убедитесь, что группа безопасности сети группирование, элементов управления, которые виртуальная сеть имеет правило, включена для конечной точки оценки, чтобы к нему можно обращаться из за пределами виртуальной сети для входящего трафика

    ![Добавление вычислительной среды в Службу машинного обучения Azure](./media/how-to-enable-virtual-network/aks-vnet-inbound-nsg-scoring.png)

    > [!TIP]
    > Если в вашей виртуальной сети уже есть кластер AKS, можно подключить его к рабочему пространству. Дополнительные сведения см. в статье [о развертывании в Службе Azure Kubernetes](how-to-deploy-to-aks.md).

Вы также можете использовать **пакет SDK для Машинного обучения Azure**, чтобы добавить в виртуальную сеть Службу Azure Kubernetes. Следующий код создает новый кластер Службы Azure Kubernetes в подсети `default`, размещенной в виртуальной сети с именем `mynetwork`:

```python
from azureml.core.compute import ComputeTarget, AksCompute

# Create the compute configuration and set virtual network information
config = AksCompute.provisioning_configuration(location="eastus2")
config.vnet_resourcegroup_name = "mygroup"
config.vnet_name = "mynetwork"
config.subnet_name = "default"
config.service_cidr = "10.0.0.0/16"
config.dns_service_ip = "10.0.0.10"
config.docker_bridge_cidr = "172.17.0.1/16"

# Create the compute target
aks_target = ComputeTarget.create(workspace = ws,
                                  name = "myaks",
                                  provisioning_configuration = config)
```

После завершения процесса создания, вы можете определение и оценка в кластере AKS за виртуальной сети. Дополнительные сведения см. в статье [о развертывании в Службе Azure Kubernetes](how-to-deploy-to-aks.md).

## <a name="next-steps"></a>Дальнейшие действия

* [Настройка сред обучения](how-to-set-up-training-targets.md)
* [Где следует развертывать модели](how-to-deploy-and-where.md)
* [Безопасное развертывание моделей с помощью SSL](how-to-secure-web-service.md)

