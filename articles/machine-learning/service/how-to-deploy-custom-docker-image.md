---
title: Развертывание модели с помощью пользовательского образа Docker
titleSuffix: Azure Machine Learning service
description: Узнайте, как использовать пользовательский образ Docker при развертывании моделей службы машинного обучения Azure. При развертывании обученной модели, для узла изображение, веб-сервер и другие компоненты, необходимые для запуска службы создается образ Docker. Службы машинного обучения Azure предоставляет образ по умолчанию для вас, также можно использовать свой собственный образ.
services: machine-learning
ms.service: machine-learning
ms.subservice: core
ms.topic: conceptual
ms.author: jordane
author: jpe316
ms.reviewer: larryfr
ms.date: 06/05/2019
ms.openlocfilehash: 29fdb200075a5b5843944a7a890cc2f8ad61f1ee
ms.sourcegitcommit: 5bdd50e769a4d50ccb89e135cfd38b788ade594d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2019
ms.locfileid: "67543857"
---
# <a name="deploy-a-model-using-a-custom-docker-image"></a>Развертывание модели с помощью пользовательского образа Docker

Узнайте, как использовать пользовательский образ Docker при развертывании обученных моделей в службе машинного обучения Azure.

При развертывании обученной модели веб-службы или устройство IoT Edge, создается образ Docker. Этот образ содержит модели, среды conda и ресурсы, необходимые для использования модели. Он также содержит веб-сервер для обработки входящих запросов, при развертывании в качестве веб-службы и компоненты, необходимые для работы с центром Интернета вещей Azure.

Служба машинного обучения Azure предоставляет образ Docker по умолчанию, поэтому вам не нужно беспокоиться о создании. Также можно использовать пользовательский образ, который создается в качестве _базового образа_. Базовый образ используется в качестве отправной точки при создании образа для развертывания. Он предоставляет базовой операционной системы и компоненты. Процесс развертывания затем добавляет дополнительные компоненты, такие как модель, среды conda и других ресурсов в образ перед его развертыванием.

Обычно создается пользовательский образ, если вы хотите контролировать версии компонентов или экономят время во время развертывания. Например может потребоваться стандартизацию на определенную версию Python, Conda или другого компонента. Можно также установить программное обеспечение, необходимые вашей модели, где процесс установки занимает много времени. Установка программного обеспечения, при создании базового образа, это означает, что не нужно установить его для каждого развертывания.

> [!IMPORTANT]
> При развертывании модели, не может переопределить основных компонентов, таких как веб-сервер или компоненты Edge Интернета вещей. Эти компоненты обеспечивают известных рабочей среды, протестированы и поддерживаются корпорацией Майкрософт.

> [!WARNING]
> Microsoft не может быть возможность устранения проблем, из-за пользовательского образа. Если у вас возникли проблемы, может потребоваться использовать образ по умолчанию, или один из образов, которые корпорация Майкрософт предоставляет ли проблема относится к изображению.

В этом документе разбивается на два раздела:

* Создание пользовательского образа: Сведения для администраторов и DevOps, о создании пользовательского образа и настройке проверки подлинности для реестра контейнеров Azure с помощью интерфейса командной строки Azure и Machine Learning CLI.
* Использование пользовательского образа: Сведения об использовании пользовательских образов при развертывании обученной модели из пакета SDK для Python или командной строки машинного Обучения для специалистов по анализу данных и DevOps/MLOps.

## <a name="prerequisites"></a>Технические условия

* Рабочая группа службы машинного обучения Azure. Дополнительные сведения см. в разделе [создать рабочую область](setup-create-workspace.md) статьи.
* Машинного обучения Azure SDK. Дополнительные сведения см. в разделе пакет SDK для Python [создать рабочую область](setup-create-workspace.md#sdk) статьи.
* [Интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest).
* [Расширение CLI для машинного обучения Azure](reference-azure-machine-learning-cli.md).
* [Реестр контейнеров Azure](/azure/container-registry) или другой реестр Docker, которая доступна в Интернете.
* В этом документе предполагается, что вы знакомы с созданием и использованием __вывод конфигурации__ объект как часть модели развертывания. Дополнительные сведения см. в разделе «Подготовка к развертыванию» из [способа развертывания и как](how-to-deploy-and-where.md#prepare-to-deploy).

## <a name="create-a-custom-image"></a>Создание пользовательского образа

Сведения в этом разделе предполагается, что вы используете реестр контейнеров Azure для хранения образов Docker. При планировании, для создания пользовательских образов для службы машинного обучения Azure используйте следующий контрольный список:

* Вы будете использовать реестр контейнеров Azure, созданные для рабочей области службы машинного обучения Azure, либо отдельный реестр контейнеров Azure?

    При использовании образов хранятся в __реестр контейнеров для рабочей области__, вы не обязательно должны проходить проверку подлинности в реестре. Проверка подлинности осуществляется рабочей областью.

    > [!WARNING]
    > Rzegistry контейнеров Azure для рабочей области — __создан при первом запуске обучения или развертывание модели__ использование рабочей области. Если был создан рабочую область, но не обучена или создания модели, не реестр контейнеров Azure будет существовать для рабочей области.

    Сведения о получении имени реестра контейнеров Azure для рабочей области, см. в разделе [имя реестра контейнеров Get](#getname) этой статьи.

    При использовании образов хранятся в __автономного реестра контейнеров__, вам потребуется настроить субъект-службу с по крайней мере на чтение доступа. Затем укажите идентификатор субъекта-службы (имя пользователя) и пароль для всех, кто использует образы из реестра. Исключение, если внесенные в реестр контейнеров общедоступным.

    Сведения о создании частного реестра контейнеров Azure, см. в разделе [создать частный реестр контейнеров](/azure/container-registry/container-registry-get-started-azure-cli).

    Сведения об использовании субъектов-служб с помощью реестра контейнеров Azure, см. в разделе [аутентификация в реестре контейнеров Azure с помощью субъектов](/azure/container-registry/container-registry-auth-service-principal).

* Azure сведения о реестре контейнеров и образа: Укажите имя образа для всех, кто должен использовать его. Например, образ с именем `myimage`, который хранится в реестре с именем `myregistry`, указанная как `myregistry.azurecr.io/myimage` при использовании образа для развертывания модели

* Требования к изображению: Служба машинного обучения Azure поддерживает только образы Docker, которые обеспечивают следующее программное обеспечение:

    * Ubuntu 16.04 или более поздней версии.
    * Conda 4.5. # или более поздней версии.
    * Python 3.5. # или 3.6. #.

<a id="getname"></a>

### <a name="get-container-registry-information"></a>Получение данных реестра контейнеров

В этом разделе описано Узнайте, как получить имя реестра контейнеров Azure для службы рабочей области машинного обучения Azure.

> [!WARNING]
> Реестр контейнеров Azure для рабочей области — __создан при первом запуске обучения или развертывание модели__ использование рабочей области. Если был создан рабочую область, но не обучена или создания модели, не реестр контейнеров Azure будет существовать для рабочей области.

Если вы уже обучена или развернутых моделей с помощью службы машинного обучения Azure, реестр контейнеров была создана для рабочей области. Чтобы найти имя этого контейнера в реестр, сделайте следующее:

1. Откройте новую оболочку или командной строки и используйте следующую команду для аутентификации в подписке Azure:

    ```azurecli-interactive
    az login
    ```

    Следуйте инструкциям на экране для проверки подлинности к подписке.

2. Чтобы получить список в реестр контейнеров для рабочей области, используйте следующую команду. Замените `<myworkspace>` с именем рабочей области службы машинного обучения Azure. Замените `<resourcegroup>` с группой ресурсов Azure, которая содержит рабочую область:

    ```azurecli-interactive
    az ml workspace show -w <myworkspace> -g <resourcegroup> --query containerRegistry
    ```

    Эта команда возвращает следующую информацию:

    ```text
    /subscriptions/<subscription_id>/resourceGroups/<resource_group>/providers/Microsoft.ContainerRegistry/registries/<registry_name>
    ```

    `<registry_name>` Значением является имя реестра контейнеров Azure для рабочей области.

### <a name="build-a-custom-image"></a>Создание пользовательского образа

Действия, описанные в этом пошаговом руководстве раздел создания пользовательского образа Docker в реестр контейнеров Azure.

1. Создайте новый текстовый файл с именем `Dockerfile`и используйте следующий текст в качестве содержимого:

    ```text
    FROM ubuntu:16.04

    ENV LANG=C.UTF-8 LC_ALL=C.UTF-8
    ENV PATH /opt/miniconda/bin:$PATH

    RUN apt-get update --fix-missing && \
        apt-get install -y wget bzip2 && \
        apt-get clean && \
        rm -rf /var/lib/apt/lists/*

    RUN wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-4.5.12-Linux-x86_64.sh -O ~/miniconda.sh && \
        /bin/bash ~/miniconda.sh -b -p /opt/miniconda && \
        rm ~/miniconda.sh && \
        /opt/miniconda/bin/conda clean -tipsy

    RUN conda install -y python=3.6 && \
        conda clean -aqy && \
        rm -rf /opt/miniconda/pkgs && \
        find / -type d -name __pycache__ -prune -exec rm -rf {} \;
    ```

2. Из оболочки или командной строки используйте следующее для проверки подлинности в реестр контейнеров Azure. Замените `<registry_name>` именем реестра контейнеров, которые вы хотите сохранить образ:

    ```azurecli-interactive
    az acr login --name <registry_name>
    ```

3. Чтобы отправить файл Dockerfile и постройте его, используйте следующую команду. Замените `<registry_name>` именем реестра контейнеров, которые вы хотите сохранить образ:

    ```azurecli-interactive
    az acr build --image myimage:v1 --registry <registry_name> --file Dockerfile .
    ```

    Во время сборки данные о передаются для резервного копирования в командной строке. Если построение выполнено успешно, появится сообщение, подобное приведенному ниже:

    ```text
    Run ID: cda was successful after 2m56s
    ```

Дополнительные сведения о создании образов в реестре контейнеров Azure, см. в разделе [собрать и запустить образ контейнера с помощью задачи реестра контейнеров Azure](https://docs.microsoft.com/azure/container-registry/container-registry-quickstart-task-cli)

Дополнительные сведения о загрузке существующих образов в реестр контейнеров Azure, см. в разделе [отправка первого образа в частный реестр контейнеров Docker](/azure/container-registry/container-registry-get-started-docker-cli).

## <a name="use-a-custom-image"></a>Использование пользовательского образа

Чтобы использовать пользовательский образ, вам потребуется следующее:

* __Имя образа__. Например `mcr.microsoft.com/azureml/o16n-sample-user-base/ubuntu-miniconda` — это путь в базовый образ Docker, предоставляемых корпорацией Майкрософт.
* Если изображение в __частный репозиторий__, вам потребуются следующие сведения:

    * Реестр __адрес__. Например, `myregistry.azureecr.io`.
    * Субъект-службу __username__ и __пароль__ , имеет доступ на чтение к реестру.

    Если у вас эти сведения, обратитесь к администратору для реестра контейнеров Azure, который содержит образ.

### <a name="publicly-available-images"></a>Общедоступных образов

Корпорация Майкрософт предоставляет несколько образов docker в общедоступный репозиторий, который может использоваться с действия, описанные в этом разделе:

| Image | Описание |
| ----- | ----- |
| `mcr.microsoft.com/azureml/o16n-sample-user-base/ubuntu-miniconda` | Базовый образ для службы машинного обучения Azure |
| `mcr.microsoft.com/azureml/onnxruntime:v0.4.0` | Содержит ONNX среды выполнения. |
| `mcr.microsoft.com/azureml/onnxruntime:v0.4.0-cuda10.0-cudnn7` | Содержит ONNX выполнения и CUDA компонента. |
| `mcr.microsoft.com/azureml/onnxruntime:v0.4.0-tensorrt19.03` | Содержит ONNX среду выполнения и TensorRT. |

> [!TIP]
> Так как эти образы являются общедоступными, вы не обязательно должны предоставить адрес, имя пользователя или пароль, при их использовании.

> [!IMPORTANT]
> Образы Майкрософт, которые используют CUDA или TensorRT необходимо использовать только в службах Microsoft Azure.

> [!TIP]
>__Если ваша модель обучается на вычислений машинного обучения Azure__, с использованием __версии 1.0.22 или более поздней версии__ пакета SDK для обучения машины Azure, образ создается во время обучения. Чтобы получить имя образа, используйте `run.properties["AzureML.DerivedImageName"]`. Следующий пример демонстрирует использование этого образа:
>
> ```python
> # Use an image built during training with SDK 1.0.22 or greater
> image_config.base_image = run.properties["AzureML.DerivedImageName"]
> ```

### <a name="use-an-image-with-the-azure-machine-learning-sdk"></a>Использование образа с помощью пакета SDK для Azure Machine Learning

Чтобы использовать пользовательский образ, задайте `base_image` свойство [объект конфигурации вывод](https://docs.microsoft.com/python/api/azureml-core/azureml.core.model.inferenceconfig?view=azure-ml-py) адрес образа:

```python
# use an image from a registry named 'myregistry'
inference_config.base_image = "myregistry.azurecr.io/myimage:v1"
```

Этот формат работает для обоих образов, хранящихся в реестре контейнеров Azure для вашей рабочей области и контейнер реестров, которые являются общедоступными. Например следующий код использует образ по умолчанию, предоставляемые корпорацией Майкрософт:

```python
# use an image available in public Container Registry without authentication
inference_config.base_image = "mcr.microsoft.com/azureml/o16n-sample-user-base/ubuntu-miniconda"
```

Чтобы использовать изображение из __закрытого реестра контейнеров__ , которого нет в рабочей области, необходимо указать адрес репозитория, имя пользователя и пароль:

```python
# Use an image available in a private Container Registry
inference_config.base_image = "myregistry.azurecr.io/mycustomimage:1.0"
inference_config.base_image_registry.address = "myregistry.azurecr.io"
inference_config.base_image_registry.username = "username"
inference_config.base_image_registry.password = "password"
```

### <a name="use-an-image-with-the-machine-learning-cli"></a>Используйте изображение с Machine Learning CLI

> [!IMPORTANT]
> В настоящее время Machine Learning CLI можно использовать образы из реестра контейнеров Azure для вашей рабочей области или общедоступных репозиториев. Он не может использовать образы из автономного частных реестрах.

При развертывании модели с помощью Machine Learning CLI, вы предоставить файл конфигурации вывод, который ссылается на пользовательский образ. Ниже приведен документ JSON показано, как ссылаться на образ в реестре общедоступного контейнера:

```json
{
   "entryScript": "score.py",
   "runtime": "python",
   "condaFile": "infenv.yml",
   "extraDockerfileSteps": null,
   "sourceDirectory": null,
   "enableGpu": false,
   "baseImage": "mcr.microsoft.com/azureml/o16n-sample-user-base/ubuntu-miniconda",
   "baseImageRegistry": "mcr.microsoft.com"
}
```

Этот файл используется с `az ml model deploy` команды. `--ic` Параметр используется для указания файла конфигурации вывод.

```azurecli
az ml model deploy -n myservice -m mymodel:1 --ic inferenceconfig.json --dc deploymentconfig.json --ct akscomputetarget
```

Дополнительные сведения о развертывании модели с помощью командной строки машинного Обучения см. в разделе «Регистрация модели, профилирование и развертывание» из [расширение CLI для службы машинного обучения Azure](reference-azure-machine-learning-cli.md#model-registration-profiling-deployment) статьи.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о [способа развертывания и как](how-to-deploy-and-where.md).
* Узнайте, как [Train и развертывать модели машинного обучения с помощью Azure конвейеров](/azure/devops/pipelines/targets/azure-machine-learning?view=azure-devops).
