---
title: Руководство по первой модели машинного обучения с R
titleSuffix: Azure Machine Learning
description: В рамках этого руководства вы изучите базовые конструктивные шаблоны в службе машинного обучения Azure, а также выполните обучение модели логистической регрессии, прогнозирующей вероятность летального исхода в автомобильной аварии, с использованием пакетов R azuremlsdk и caret.
services: machine-learning
ms.service: machine-learning
ms.subservice: core
ms.topic: tutorial
ms.reviewer: sgilley
author: revodavid
ms.author: davidsmi
ms.date: 11/04/2019
ms.openlocfilehash: 52dc0ff27ad2f04b9faeab24c6bdba68d9ec138e
ms.sourcegitcommit: 8a2949267c913b0e332ff8675bcdfc049029b64b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/21/2019
ms.locfileid: "74307270"
---
# <a name="tutorial-train-and-deploy-your-first-model-in-r-with-azure-machine-learning"></a>Руководство по Обучение и развертывание первой модели в R с помощью службы машинного обучения Azure
[!INCLUDE [applies-to-skus](../../../includes/aml-applies-to-basic-enterprise-sku.md)]

В рамках этого учебника вы изучите базовые конструктивные шаблоны в службе машинного обучения Azure.  Также вы выполните обучение и развертывание модели **caret**, позволяющей спрогнозировать вероятность летального исхода в автомобильной аварии. Завершив этот учебник, вы получите практические знания о пакете SDK R и сможете перейти к более сложным экспериментам и рабочим процессам.

В этом руководстве вы выполнили следующие задачи.

> [!div class="checklist"]
> * Подключение к рабочей области
> * Загрузка данных и подготовка к обучению
> * Загрузка данных в хранилище данных для их последующего использования в процессе удаленного обучения
> * Создание вычислительного ресурса
> * Обучение модели caret, прогнозирующей вероятность летального исхода
> * Развертывание конечной точки прогнозирования
> * Тестирование модели из R

Если у вас еще нет подписки Azure, создайте бесплатную учетную запись Azure, прежде чем начинать работу. Опробуйте [бесплатную или платную версию Машинного обучения Azure](https://aka.ms/AMLFree) уже сегодня.

## <a name="prerequisites"></a>Предварительные требования

1. Выполите следующие [инструкции по установке](https://azure.github.io/azureml-sdk-for-r/articles/installation.html), чтобы:
    + установить Anaconda;
    + установить `azuremlsdk`;
    + установить пакет SDK для Машинного обучения Azure для Python.

1. Скачайте три файла учебника с сайта [GitHub](https://github.com/Azure/azureml-sdk-for-r/tree/master/vignettes/train-and-deploy-with-caret).  Сохраните их в каталоге **tutorials**.

2. Создайте рабочую область службы машинного обучения Azure и выполните приведенные ниже действия, чтобы скачать ее файл конфигурации.


### <a name="create-a-workspace"></a>Создание рабочей области

Рабочая область машинного обучения Azure — это основной ресурс в облаке для экспериментов, обучения и развертывания моделей машинного обучения. Она связывает подписку и группу ресурсов Azure с легко используемым объектом в пакете SDK. Если у вас уже есть рабочая область службы машинного обучения Azure, перейдите к [следующему разделу](#config). В противном случае создайте ее прямо сейчас.

[!INCLUDE [aml-create-portal](../../../includes/aml-create-in-portal.md)]

### <a name="config"></a> Скачивание файла config.json

1. В верхней части страницы рабочей области выберите **Скачать config.json**.

    ![Скачивание файла config.json](media/tutorial-1st-r-experiment/download-config.png)  

1. Добавьте этот файл в каталог **tutorials**.

Теперь все готово к запуску этого учебника.

Для работы с этим учебником рекомендуется использовать RStudio. В RStudio выберите "Файл > Создать проект > Существующий каталог" и укажите ранее созданный каталог **tutorials**.

> [!Important]
> Оставшаяся часть этой статьи содержит те же данные, что и файл **train-and-deploy-to-aci.Rmd**.  
> Если у вас есть опыт работы с RMarkdown, вы можете использовать код из этого файла.  Также можно скопировать и вставить фрагменты кода из этого файла или из этой статьи в скрипт R или в командную строку.


## <a name="set-up-your-development-environment"></a>Настройка среды разработки
Подготовка к процедуре разработки в рамках этого учебника предусматривает следующие действия.

* Установка необходимых пакетов
* Подключение к рабочей области, что позволяет локальному компьютеру обмениваться данными с удаленными ресурсами
* Создание эксперимента, чтобы отслеживать запуски
* Создание удаленного целевого объекта вычислений для использования в обучении

### <a name="install-required-packages"></a>Установка необходимых пакетов
В рамках этого учебника предполагается, что вы уже установили пакет SDK службы машинного обучения Azure. Далее установите пакет **azuremlsdk**.

```R
library(azuremlsdk)
```

В рамках этого учебника используются данные из пакета [**DAAG**](https://cran.r-project.org/package=DAAG). Если у вас еще нет этого пакета, установите его.

```R
install.packages("DAAG")
```

Скрипты обучения и оценки (`accidents.R` и `accident_predict.R`) имеют ряд дополнительных зависимостей. Если вы планируете запускать эти скрипты локально, проверьте наличие всех необходимых пакетов.

### <a name="load-your-workspace"></a>Загрузка рабочей области
В существующей рабочей области создайте экземпляр объекта рабочей области. Следующий код загружает сведения о рабочей области из файла **config.json**. Кроме того, для получения рабочей области можно использовать [`get_workspace()`](https://azure.github.io/azureml-sdk-for-r/reference/get_workspace.html).

```R
ws <- load_workspace_from_config()
```

### <a name="create-an-experiment"></a>Создание эксперимента
Эксперимент службы машинного обучения Azure отслеживает группирование запусков (как правило, из одного скрипта обучения). Создайте эксперимент, чтобы отслеживать запуски для обучения модели caret на основе данных об автомобильных авариях.

```R
experiment_name <- "accident-logreg"
exp <- experiment(ws, experiment_name)
```

### <a name="create-a-compute-target"></a>Создание целевого объекта вычислений
Использование Вычислительной среды Машинного обучения Azure (управляемой службы AMLCompute) позволяет специалистам по анализу данных обучать модели машинного обучения в кластерах виртуальных машин Azure. Часто используются виртуальные машины с поддержкой GPU. В рамках этого учебника вы создадите кластер AmlCompute с одним узлом, который будет выступать в качестве среды обучения. Приведенный ниже код создаст вычислительный кластер, если он еще не существует в вашей рабочей области.

Если вычислительный кластер не был создан ранее, его подготовка может занять несколько минут.

```R
cluster_name <- "rcluster"
compute_target <- get_compute(ws, cluster_name = cluster_name)
if (is.null(compute_target)) {
  vm_size <- "STANDARD_D2_V2" 
  compute_target <- create_aml_compute(workspace = ws,
                                       cluster_name = cluster_name,
                                       vm_size = vm_size,
                                       max_nodes = 1)
}

wait_for_provisioning_completion(compute_target)
```

## <a name="prepare-data-for-training"></a>Подготовка данных для обучения
В рамках этого учебника используются данные из пакета **DAAG**. Этот набор данных включает данные по 25 000 автомобильных аварий, произошедших на территории США, и переменные, которые можно использовать для прогнозирования вероятности летального исхода. Сначала импортируйте данные в R и преобразуйте их в новый кадр данных `accidents` для анализа, а затем экспортируйте их в файл `Rdata`.

```R
library(DAAG)
data(nassCDS)

accidents <- na.omit(nassCDS[,c("dead","dvcat","seatbelt","frontal","sex","ageOFocc","yearVeh","airbag","occRole")])
accidents$frontal <- factor(accidents$frontal, labels=c("notfrontal","frontal"))
accidents$occRole <- factor(accidents$occRole)

saveRDS(accidents, file="accidents.Rd")
```

### <a name="upload-data-to-the-datastore"></a>Загрузка данных в хранилище данных
Загрузите данные в облако, чтобы обеспечить доступ к ним из удаленной среды обучения. В состав каждой рабочей области службы машинного обучения Azure входит хранилище данных по умолчанию, где размещаются сведения о подключении к контейнеру BLOB-объектов Azure, который подготовлен в учетной записи хранения, подключенной к рабочей области. Следующий код загружает созданные ранее данные по автомобильным авариям в это хранилище данных.

```R
ds <- get_default_datastore(ws)

target_path <- "accidentdata"
upload_files_to_datastore(ds,
                          list("./accidents.Rd"),
                          target_path = target_path,
                          overwrite = TRUE)
```


## <a name="train-a-model"></a>Обучение модели

В рамках этого учебника необходимо адаптировать модель логистической регрессии для работы с загруженными данными, используя удаленный вычислительный кластер. Чтобы отправить задание, необходимо выполнить следующие действия.

* Подготовка скрипта обучения
* Создание оценщика
* отправить задание.

### <a name="prepare-the-training-script"></a>Подготовка скрипта обучения
В каталоге, в котором располагается этот учебник, располагается подготовленный скрипт обучения `accidents.R`. Обратите внимание на следующие детали **в скрипте обучения**, которые внесены с целью использовать службу машинного обучения Azure для обучения.

* Скрипт обучения считывает аргумент `-d`, чтобы найти каталог с данными для обучения. Позднее при определении и отправке задания вы укажете хранилище данных для этого аргумента. Служба машинного обучения Azure подключит папку хранилища к удаленному кластеру для задания обучения.
* Скрипт обучения регистрирует итоговую точность в виде метрики для записи запуска в службе машинного обучения Azure с использованием `log_metric_to_run()`. В составе пакета SDK службы машинного обучения Azure предусмотрен набор API ведения журнала для регистрации различных метрик во время обучающего запуска. Эти метрики записываются и сохраняются в записи экспериментального запуска. Вы можете в любой момент получить доступ к этим метрикам или просмотреть их на странице сведений о запуске в [студии машинного обучения Azure](https://ml.azure.com). Полный набор методов ведения журнала `log_*()` см. в [справочнике](https://azure.github.io/azureml-sdk-for-r/reference/index.html#section-training-experimentation).
* Скрипт обучения сохраняет модель в каталог с именем **outputs**. Служба машинного обучения Azure работает с папкой `./outputs` особым образом. В процессе обучения файлы, записанные в папку `./outputs`, автоматически загружаются службой машинного обучения Azure в запись запуска и сохраняются в ней в качестве артефактов. Если сохранить обученную модель в папке `./outputs`, вы сможете получать доступ к файлу модели и извлекать его даже после завершения запуска при отсутствии доступа к удаленной среде обучения.

### <a name="create-an-estimator"></a>Создание оценщика

Средство оценки службы машинного обучения Azure инкапсулирует сведения о конфигурации запуска, необходимые для выполнения скрипта обучения в целевом объекте вычислений. Запуски службы машинного обучения Azure в целевом объекте вычислений осуществляются в рамках контейнерных заданий. По умолчанию образ Docker, созданный для вашего задания обучения, будет включать R, пакет SDK службы машинного обучения и набор часто используемых пакетов R. См. полный список включаемых по умолчанию пакетов.

Чтобы создать средство оценки, определите следующее.

* Каталог, который содержит скрипт для обучения (`source_directory`). Все файлы в этом каталоге передаются в узел или узлы кластера для выполнения. Этот каталог должен содержать скрипт обучения и все необходимые дополнительные скрипты.
* Скрипт обучения, который будет выполнен (`entry_script`).
* Целевой объект вычислений (`compute_target`), в данном случае ранее созданный кластер AmlCompute.
* Параметры, требуемые от скрипта обучения (`script_params`). Служба машинного обучения Azure будет выполнять ваш скрипт обучения в виде скрипта командной строки с помощью `Rscript`. В рамках этого учебника вы указываете один аргумент скрипта: точку подключения к каталогу данных для доступа посредством `ds$path(target_path)`.
* Все зависимости среды, необходимые для обучения. Образ Docker по умолчанию, создаваемый для обучения, уже содержит три необходимых для скрипта обучения пакета (`caret`, `e1071` и `optparse`).  Поэтому дополнительные сведения указывать не требуется. Если вы используете пакеты R, не включаемые по умолчанию, воспользуйтесь параметром `cran_packages` средства оценки, чтобы добавить дополнительные пакеты CRAN. См. полный набор настраиваемых параметров в справочнике по [`estimator()`](https://azure.github.io/azureml-sdk-for-r/reference/estimator.html).

```R
est <- estimator(source_directory = ".",
                 entry_script = "accidents.R",
                 script_params = list("--data_folder" = ds$path(target_path)),
                 compute_target = compute_target
                 )
```

### <a name="submit-the-job-on-the-remote-cluster"></a>Отправка задания на удаленный кластер

В заключение необходимо отправить задание для запуска в кластер. `submit_experiment()` возвращает объект Run, который используется для взаимодействия с запуском. Обычно первый запуск занимает **около 10 минут**. Но для последующих запусков используется тот же образ Docker, если зависимости скрипта не изменяются.  В этом случае образ кэшируется, в результате чего значительно сокращается время запуска контейнера.

```R
run <- submit_experiment(exp, est)
```

Со сведениями о запуске можно ознакомиться в средстве просмотра RStudio. Чтобы отслеживать состояние запуска в пользовательском интерфейсе студии машинного обучения Azure, щелкните предлагаемую ссылку "Веб-представление".

```R
view_run_details(run)
```

Обучение модели происходит в фоновом режиме. Прежде, чем выполнять другой код, дождитесь завершения обучения модели.

```R
wait_for_run_completion(run, show_output = TRUE)
```

Вы и ваши коллеги с доступом к рабочей области можете отправлять параллельно несколько экспериментов. В таком случае служба машинного обучения Azure будет автоматически планировать выполнение задач в вычислительном кластере. При необходимости вы можете настроить автоматическое масштабирование кластера на нескольких узлах и возврат к исходному размеру после того, как в очереди не останется вычислительных задач. Благодаря такой конфигурации реализуется экономичная среда для совместного использования ресурсов рабочими группами.

## <a name="retrieve-training-results"></a>Получение результатов обучения
После того как обучение модели завершено, вы можете получать доступ к артефактам задания, сохраненным в записи запуска, в том числе ко всем зарегистрированным метрикам и к готовой обученной модели.

### <a name="get-the-logged-metrics"></a>Получение зарегистрированных метрик
В скрипте обучения `accidents.R` была зарегистрирована метрика модели, описывающая точность прогнозов в обучающих данных. Вы можете просмотреть метрики в [студии](https://ml.azure.com) или извлечь их в локальный сеанс в виде списка R следующим образом.

```R
metrics <- get_run_metrics(run)
metrics
```

Если вы запускали несколько экспериментов (например, с использованием разных значений переменных, алгоритмов или гиперпараметров), вы можете сравнить метрики из каждого запуска и выбрать модель, которая будет использоваться в рабочей среде.

### <a name="get-the-trained-model"></a>Получение обученной модели
Вы можете получить обученную модель и просмотреть результаты в локальном сеансе R. Следующий код скачает содержимое каталога `./outputs`, в котором также размещается файл модели.

```R
download_files_from_run(run, prefix="outputs/")
accident_model <- readRDS("outputs/model.rds")
summary(accident_model)
```

Вы можете выделить некоторые факторы, влияющие на увеличение вероятности летального исхода.

* Более высокая скорость столкновения 
* Водитель мужского пола
* Водитель или пассажир старшей возрастной группы
* Наличие в автомобиле пассажиров

Вероятность летального исхода снижается в следующих случаях.

* Наличие подушек безопасности в автомобиле
* Использование ремней безопасности водителем и пассажирами
* Лобовое столкновение 

Год изготовления автомобиля не оказывает существенного влияния.

С помощью этой модели можно подготавливать новые прогнозы.

```R
newdata <- data.frame( # valid values shown below
 dvcat="10-24",        # "1-9km/h" "10-24"   "25-39"   "40-54"   "55+"  
 seatbelt="none",      # "none"   "belted"  
 frontal="frontal",    # "notfrontal" "frontal"
 sex="f",              # "f" "m"
 ageOFocc=16,          # age in years, 16-97
 yearVeh=2002,         # year of vehicle, 1955-2003
 airbag="none",        # "none"   "airbag"   
 occRole="pass"        # "driver" "pass"
 )

## predicted probability of death for these variables, as a percentage
as.numeric(predict(accident_model,newdata, type="response")*100)
```

## <a name="deploy-as-a-web-service"></a>Развертывание в виде веб-службы

Используя эту модель, вы можете прогнозировать вероятность летального исхода в автомобильной аварии. Служба машинного обучения Azure развернет вашу модель в качестве службы прогнозирования. В рамках этого учебника вы развернете веб-службу в [службе экземпляров контейнеров Azure](https://docs.microsoft.com/azure/container-instances/) (ACI).

### <a name="register-the-model"></a>Регистрация модели

Сначала зарегистрируйте скачанную модель в рабочей области с помощью [`register_model()`](https://azure.github.io/azureml-sdk-for-r/reference/register_model.html). Зарегистрированная модель может представлять собой любой набор файлов, однако в этом случае объекта модели R будет достаточно. Служба машинного обучения Azure будет использовать зарегистрированную модель для развертывания.

```R
model <- register_model(ws, 
                        model_path = "outputs/model.rds", 
                        model_name = "accidents_model",
                        description = "Predict probablity of auto accident")
```

### <a name="define-the-inference-dependencies"></a>Определение зависимостей вывода
Чтобы создать веб-службу для модели, сначала необходимо создать скрипт оценки (`entry_script`). Этот скрипт R будет принимать в качестве входных данных значения переменных (в формате JSON) и возвращать прогноз, полученный с использованием вашей модели. В рамках этого учебника используется готовый файл оценки `accident_predict.R`. Скрипт оценки должен содержать метод `init()`, который загружает модель и возвращает функцию, которая использует модель для получения прогноза на основании входных данных. Дополнительные сведения см. в [документации](https://azure.github.io/azureml-sdk-for-r/reference/inference_config.html#details).

Далее определите **среду** службы машинного обучения Azure для зависимостей пакета скрипта. В среде необходимо указать пакеты R (из CRAN или другого источника), которые требуются для запуска скрипта. Также вы можете указать значения переменных среды, на которые скрипт будет ссылаться для изменения поведения. По умолчанию служба машинного обучения Azure создаст тот же образ Docker по умолчанию, который использовался средством оценки для обучения. Поскольку в рамках этого учебника не предъявляются особые требования, вы можете создать среду без специальных атрибутов.

```R
r_env <- r_environment(name = "basic_env")
```

Если вы хотите использовать для развертывания собственный образ Docker, укажите параметр `custom_docker_image`. См. полный набор настраиваемых параметров для определения среды в справочнике по [`r_environment()`](https://azure.github.io/azureml-sdk-for-r/reference/r_environment.html).

Теперь вы готовы к созданию **конфигурации вывода** для инкапсуляции скрипта оценки и зависимостей среды.

```R
inference_config <- inference_config(
  entry_script = "accident_predict.R",
  environment = r_env)
```

### <a name="deploy-to-aci"></a>Развертывание в ACI
В рамках этого учебника вы выполните развертывание своей службы в ACI. Этот код подготавливает к работе один контейнер для тестирования при небольшой загрузке, который будет отвечать на входящие запросы. Дополнительные настраиваемые параметры см. в статье [`aci_webservice_deployment_config()`](https://azure.github.io/azureml-sdk-for-r/reference/aci_webservice_deployment_config.html). (Для рабочих развертываний также можно [выполнить развертывание Azure Kubernetes Service](https://azure.github.io/azureml-sdk-for-r/articles/deploy-to-aks/deploy-to-aks.html).)

``` R
aci_config <- aci_webservice_deployment_config(cpu_cores = 1, memory_gb = 0.5)
```

Далее вы развернете модель в качестве веб-службы. Развертывание **может занять несколько минут**. 

```R
aci_service <- deploy_model(ws, 
                            'accident-pred', 
                            list(model), 
                            inference_config, 
                            aci_config)

wait_for_deployment(aci_service, show_output = TRUE)
```

## <a name="test-the-deployed-service"></a>Тестирование развернутой службы

После развертывания модели в качестве службы вы можете протестировать эту службу из R с использованием [`invoke_webservice()`](https://azure.github.io/azureml-sdk-for-r/reference/invoke_webservice.html).  Предоставьте новый набор данных, на основе которых будет формироваться прогноз, преобразуйте его в формат JSON и затем передайте в эту службу.

```R
library(jsonlite)

newdata <- data.frame( # valid values shown below
 dvcat="10-24",        # "1-9km/h" "10-24"   "25-39"   "40-54"   "55+"  
 seatbelt="none",      # "none"   "belted"  
 frontal="frontal",    # "notfrontal" "frontal"
 sex="f",              # "f" "m"
 ageOFocc=22,          # age in years, 16-97
 yearVeh=2002,         # year of vehicle, 1955-2003
 airbag="none",        # "none"   "airbag"   
 occRole="pass"        # "driver" "pass"
 )

prob <- invoke_webservice(aci_service, toJSON(newdata))
prob
```

Кроме того, вы можете получить конечную точку HTTP веб-службы, которая принимает вызовы клиента REST. К этой конечной точке можно предоставить совместный доступ всем, кто хочет протестировать веб-службу или интегрировать ее в приложение.

```R
aci_service$scoring_uri
```

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите ресурсы, которые более не используются. Не удаляйте ресурсы, которые планируется использовать в дальнейшем. 

Удалите веб-службу:
```R
delete_webservice(aci_service)
```

Удалите зарегистрированную модель:
```R
delete_model(model)
```

Удалите вычислительный кластер:
```R
delete_compute(compute)
```

### <a name="delete-everything"></a>Удаление всех ресурсов

[!INCLUDE [aml-delete-resource-group](../../../includes/aml-delete-resource-group.md)]

Вы также можете сохранить группу ресурсов, но удалить одну рабочую область. Отобразите свойства рабочей области и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

После завершения первого эксперимента службы машинного обучения Azure в R вы можете подробнее ознакомиться с [пакетом SDK службы машинного обучения Azure для R](https://azure.github.io/azureml-sdk-for-r/index.html).

