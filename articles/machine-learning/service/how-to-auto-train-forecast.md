---
title: Автоматическая обучение модели прогнозирования временных рядов
titleSuffix: Azure Machine Learning
description: Узнайте, как использовать Машинное обучение Azure для обучения модели регрессии прогнозирования временных рядов с помощью автоматизированного машинного обучения.
services: machine-learning
author: trevorbye
ms.author: trbye
ms.service: machine-learning
ms.subservice: core
ms.reviewer: trbye
ms.topic: conceptual
ms.date: 06/20/2019
ms.openlocfilehash: eb13e6d279ffd8efc0cdb5ce675b77aac5be9c18
ms.sourcegitcommit: 77bfc067c8cdc856f0ee4bfde9f84437c73a6141
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2019
ms.locfileid: "72436628"
---
# <a name="auto-train-a-time-series-forecast-model"></a>Автоматическая обучение модели прогнозирования временных рядов

Из этой статьи вы узнаете, как обучить модель регрессии прогнозирования временных рядов с помощью автоматизированного машинного обучения в Машинное обучение Azure. Настройка модели прогнозирования аналогична настройке стандартной модели регрессии с помощью автоматического машинного обучения, но для работы с данными временных рядов существуют определенные параметры конфигурации и этапы предварительной обработки. В следующих примерах показано, как:

* Подготовка данных для моделирования временных рядов
* Настройка конкретных параметров временных рядов в объекте [`AutoMLConfig`](/python/api/azureml-train-automl/azureml.train.automl.automlconfig)
* Выполнение прогнозов с данными временных рядов

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2X1GW]

Вы можете использовать автоматизированное средство ML для объединения методов и подходов и получения рекомендуемого, высококачественного прогноза временных рядов. Автоматизированный эксперимент по ряду времени рассматривается как многофакторнаяная задача регрессии. Последние значения временных рядов "сведены", чтобы стать дополнительными измерениями для регрессии вместе с другими прогностические факторы.

Этот подход, в отличие от классических методов временных рядов, имеет преимущество, включающее в себя несколько контекстных переменных и их связь друг с другом во время обучения. В реальных приложениях прогнозирования на прогнозе может влиять несколько факторов. Например, при прогнозировании продаж, взаимодействии исторических тенденций, обменного курса и цены все совместно обозначают результат продаж. Еще одним преимуществом является то, что все последние нововведения в моделях регрессии немедленно применяются для прогнозирования.

Вы можете [настроить](#config) , насколько далеко в будущем должен расширяться прогноз (горизонт прогнозирования), а также как задержка и многое другое. Автоматический ML изучает одну, но часто внутреннюю модель ветвления для всех элементов в наборе данных и прогнозирующих горизонтах. Итак, доступны дополнительные данные для оценки параметров модели, и обобщение невидимых рядов становится возможным.

Функции, извлеченные из обучающих данных, играют важную роль. И автоматизированное создание машинного обучения выполняет стандартные подготовительные действия и создает дополнительные функции временных рядов для сбора сезонных эффектов и максимального уровня точности прогнозов.

## <a name="prerequisites"></a>Технические условия

* Рабочая область машинного обучения Azure. Сведения о создании рабочей области см. в статье [создание машинное обучение Azure рабочей области](how-to-manage-workspace.md).
* В этой статье предполагается, что вы можете настроить автоматический эксперимент машинного обучения. Следуйте указаниям [руководства](tutorial-auto-train-models.md) или [инструкции](how-to-configure-auto-train.md) , чтобы ознакомиться с основными шаблонами разработки экспериментов машинного обучения.

## <a name="preparing-data"></a>Подготовка данных

Самым важным различием между типом задачи регрессия прогнозирования и задачей регрессии в автоматизированном машинном обучении является включение в данные функции, представляющей допустимые временные ряды. Обычный временной ряд имеет четко определенную и постоянную частоту и имеет значение в каждой точке выборки в непрерывном промежутке времени. Рассмотрим следующий снимок файла `sample.csv`.

    day_datetime,store,sales_quantity,week_of_year
    9/3/2018,A,2000,36
    9/3/2018,B,600,36
    9/4/2018,A,2300,36
    9/4/2018,B,550,36
    9/5/2018,A,2100,36
    9/5/2018,B,650,36
    9/6/2018,A,2400,36
    9/6/2018,B,700,36
    9/7/2018,A,2450,36
    9/7/2018,B,650,36

Этот набор данных является простым примером данных по ежедневным продажам для компании с двумя разными магазинами: A и B. Кроме того, существует функция для `week_of_year`, которая позволит модели обнаруживать еженедельные сезонности. Поле `day_datetime` представляет чистый временной ряд с ежедневной частотой, а поле `sales_quantity` — целевой столбец для выполнения прогнозов. Прочтите данные в кадр данных Pandas, а затем используйте функцию `to_datetime`, чтобы убедиться, что временной ряд имеет тип `datetime`.

```python
import pandas as pd
data = pd.read_csv("sample.csv")
data["day_datetime"] = pd.to_datetime(data["day_datetime"])
```

В этом случае данные уже сортируются в возрастающем порядке по полю времени `day_datetime`. Однако при настройке эксперимента необходимо, чтобы столбец времени был отсортирован в порядке возрастания для создания допустимого временного ряда. Предположим, что данные содержат 1 000 записей, и для создания обучающих и проверочных наборов данных необходимо выполнить детерминированное разбиение данных. Укажите имя столбца меток и присвойте ему метку. В этом примере метка будет иметь значение `sales_quantity`. Затем отделите поле метки от `test_data`, чтобы сформировать набор `test_target`.

```python
train_data = data.iloc[:950]
test_data = data.iloc[-50:]

label =  "sales_quantity"
 
test_labels = test_data.pop(label).values
```

> [!NOTE]
> При обучении модели прогнозирования будущих значений убедитесь, что все функции, используемые при обучении, можно использовать при выполнении прогнозов для предполагаемого горизонта. Например, при создании прогноза спроса, включая функцию для текущей цены акций, может значительно увеличить точность обучения. Однако если вы планируете прогнозировать с долгим горизонтом, возможно, вам не удастся точно предсказать будущие значения запасов, соответствующие будущим точкам временного ряда, и точность модели может снизиться.

<a name="config"></a>
## <a name="configure-and-run-experiment"></a>Настройка и запуск эксперимента

Для задач прогнозирования автоматизированное машинное обучение использует шаги предварительной обработки и оценки, относящиеся к данным временных рядов. Будут выполнены следующие шаги предварительной обработки:

* Определите периодичность выборки временных рядов (например, ежечасно, ежедневно, еженедельно) и создайте новые записи для отсутствия временных точек, чтобы сделать серию непрерывной.
* Аппроксимация отсутствующие значения в целевом объекте (через прямую заливку) и в столбцах функций (используя медиану значений столбцов)
* Создание функций на основе детализации для включения фиксированных эффектов в разных рядах
* Создание функций на основе времени, которые помогут в освоении сезонных шаблонов
* Кодирование переменных категорий в числовые величины

Объект `AutoMLConfig` определяет параметры и данные, необходимые для автоматизированной задачи машинного обучения. Как и в случае с задачей регрессии, вы определяете стандартные параметры обучения, такие как тип задачи, число итераций, обучающие данные и число перекрестных проверок. Для задач прогнозирования необходимо задать дополнительные параметры, которые влияют на эксперимент. В следующей таблице описывается каждый параметр и его использование.

| Параметр | Описание | Обязательно для заполнения |
|-------|-------|-------|
|`time_column_name`|Используется для указания столбца DateTime во входных данных, используемых для создания временных рядов и получения его частоты.|✓|
|`grain_column_names`|Имена, определяющие отдельные группы рядов во входных данных. Если детализация не определена, предполагается, что набор данных является одним временным набором.||
|`max_horizon`|Определяет максимальный требуемый горизонт прогноза в единицах частоты временного ряда. Единицы измерения основаны на интервале времени ваших обучающих данных, например ежемесячно и еженедельно, что прогноз должен быть прогнозируемым.|✓|
|`target_lags`|Число строк для запаздывания целевых значений на основе частоты данных. Представляется в виде списка или одного целого числа. Запаздывание следует использовать, когда связь между независимыми переменными и зависящей от нее переменной не совпадает по умолчанию или не соотносится. Например, при попытке прогнозировать спрос на продукт спрос за любой месяц может зависеть от цены на продуктов 3 месяца. В этом примере может потребоваться запаздывание цели (спрос), отрицательно на 3 месяца, чтобы модель обучена по правильной связи.||
|`target_rolling_window_size`|*n* периодов, используемых для создания прогнозируемых значений, < = обучающий набор. Если не указано, *n* — это полный размер набора для обучения. Укажите этот параметр, если нужно обдумать только определенный объем журнала при обучении модели.||

Дополнительные сведения см. в [справочной документации](https://docs.microsoft.com/python/api/azureml-train-automl/azureml.train.automl.automlconfig?view=azure-ml-py) .

Создайте параметры временных рядов в качестве объекта Dictionary. Задайте `time_column_name` для поля `day_datetime` в наборе данных. Определите параметр `grain_column_names`, чтобы обеспечить создание **двух отдельных групп временных рядов** для данных. один для хранения A и б. Наконец, установите `max_horizon` в 50, чтобы прогнозировать весь набор тестов. Задайте для окна прогноза 10 периодов с `target_rolling_window_size` и укажите одну задержку для целевых значений в течение 2 периодов после параметра `target_lags`.

```python
time_series_settings = {
    "time_column_name": "day_datetime",
    "grain_column_names": ["store"],
    "max_horizon": 50,
    "target_lags": 2,
    "target_rolling_window_size": 10,
    "preprocess": True,
}
```

> [!NOTE]
> Этапы предварительной обработки автоматизированного машинного обучения (нормализация компонентов, обработка недостающих данных, преобразование текста в числовой формат и т. д.) становятся частью базовой модели. При использовании модели для прогнозирования эти этапы предварительной обработки, которые выполнялись во время обучения, автоматически выполняются для входных данных.

Определив `grain_column_names` в приведенном выше фрагменте кода, Аутомл создаст две отдельные группы временных рядов, также известные как несколько временных рядов. Если детализация не определена, Аутомл предполагает, что набор данных является единственным временным набором. Дополнительные сведения об одном ряде времени см. в [energy_demand_notebook](https://github.com/Azure/MachineLearningNotebooks/tree/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand).

Теперь создайте стандартный объект `AutoMLConfig`, указав тип задачи `forecasting`, и отправьте эксперимент. После завершения модели извлеките наиболее подходящую итерацию выполнения.

```python
from azureml.core.workspace import Workspace
from azureml.core.experiment import Experiment
from azureml.train.automl import AutoMLConfig
import logging

automl_config = AutoMLConfig(task='forecasting',
                             primary_metric='normalized_root_mean_squared_error',
                             iterations=10,
                             training_data=train_data,
                             label_column_name=label,
                             n_cross_validations=5,
                             enable_ensembling=False,
                             verbosity=logging.INFO,
                             **time_series_settings)

ws = Workspace.from_config()
experiment = Experiment(ws, "forecasting_example")
local_run = experiment.submit(automl_config, show_output=True)
best_run, fitted_model = local_run.get_output()
```

Подробные примеры кода для расширенной настройки прогнозирования см. в [записной книжке по спросу на энергию](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand/auto-ml-forecasting-energy-demand.ipynb) , в том числе:

* Обнаружение праздников и добавление признаков
* Перекрестная проверка последовательного происхождения
* Настраиваемая задержка
* Пошаговые агрегатные функции окна

### <a name="view-feature-engineering-summary"></a>Просмотреть сводные данные по проектированию функций

Для типов задач временных рядов в автоматизированном машинном обучении можно просмотреть сведения из процесса проектирования компонентов. В следующем коде показана каждая необработанная функция вместе со следующими атрибутами:

* Имя необработанного компонента
* Число сконструированных функций, сформированных за пределами этой необработанной функции
* Обнаружен тип
* Удален ли компонент
* Список преобразований компонентов для необработанных функций

```python
fitted_model.named_steps['timeseriestransformer'].get_featurization_summary()
```

## <a name="forecasting-with-best-model"></a>Прогнозирование с помощью лучшей модели

Используйте лучшую итерацию модели для прогнозирования значений для набора проверочных данных.

```python
predict_labels = fitted_model.predict(test_data)
actual_labels = test_labels.flatten()
```

Кроме того, можно использовать функцию `forecast()` вместо `predict()`, которая позволит указать, когда должны начинаться прогнозы. В следующем примере сначала замените все значения в `y_pred` на `NaN`. Источник прогноза будет находиться в конце обучающих данных в этом случае, как обычно при использовании `predict()`. Однако если заменить только вторую половину `y_pred` на `NaN`, функция будет оставлять числовые значения в первой половине неизменного, но прогнозировать значения `NaN` во второй половине. Функция возвращает прогнозируемые значения и выданные функции.

Можно также использовать параметр `forecast_destination` в функции `forecast()` для прогнозирования значений до указанной даты.

```python
label_query = test_labels.copy().astype(np.float)
label_query.fill(np.nan)
label_fcst, data_trans = fitted_pipeline.forecast(
    test_data, label_query, forecast_destination=pd.Timestamp(2019, 1, 8))
```

Вычислите корень СРЕДНЕКВАДРАТИЧНОЙ ПОГРЕШНОСТИ (среднее значение ошибки корня) между фактическими значениями `actual_labels` и прогнозируемыми значениями в `predict_labels`.

```python
from sklearn.metrics import mean_squared_error
from math import sqrt

rmse = sqrt(mean_squared_error(actual_lables, predict_labels))
rmse
```

Теперь, когда определена точность общей модели, наиболее реалистичным следующим шагом является использование модели для прогнозирования неизвестных будущих значений. Просто укажите набор данных в том же формате, что и проверочный набор `test_data`, но с будущими DateTimes, а результирующий набор прогнозов — прогнозируемые значения для каждого шага временного ряда. Предположим, что последние записи временных рядов в наборе данных были 12/31/2018. Чтобы прогнозировать спрос на следующий день (или столько периодов, сколько необходимо для прогнозирования, < = `max_horizon`), создайте одну запись временных рядов для каждого магазина 01/01/2019.

    day_datetime,store,week_of_year
    01/01/2019,A,1
    01/01/2019,A,1

Повторите необходимые шаги, чтобы загрузить эти будущие данные в кадр данных, а затем запустите `best_run.predict(test_data)` для прогнозирования будущих значений.

> [!NOTE]
> Невозможно прогнозировать значения для количества периодов больше, чем `max_horizon`. Модель должна быть повторно обучена с большим горизонтом для прогнозирования будущих значений за пределами текущего горизонта.

## <a name="next-steps"></a>Дальнейшие действия

* Следуйте указаниям [учебника](tutorial-auto-train-models.md) , чтобы научиться создавать эксперименты с помощью автоматизированного машинного обучения.
* Ознакомьтесь с справочной документацией по [пакету SDK машинное обучение Azure для Python](https://docs.microsoft.com/python/api/overview/azure/ml/intro?view=azure-ml-py) .
