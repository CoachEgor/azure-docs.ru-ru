---
title: Автоматическая обучение модели прогнозирования временных рядов
titleSuffix: Azure Machine Learning service
description: Узнайте, как использовать службу Машинное обучение Azure для обучения модели регрессии прогнозирования временных рядов с помощью автоматизированного машинного обучения.
services: machine-learning
author: trevorbye
ms.author: trbye
ms.service: machine-learning
ms.subservice: core
ms.reviewer: trbye
ms.topic: conceptual
ms.date: 06/20/2019
ms.openlocfilehash: 2a037a495a1e1ed211bd9a535891ccf75fdb140b
ms.sourcegitcommit: 32242bf7144c98a7d357712e75b1aefcf93a40cc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/04/2019
ms.locfileid: "70278180"
---
# <a name="auto-train-a-time-series-forecast-model"></a>Автоматическая обучение модели прогнозирования временных рядов

Из этой статьи вы узнаете, как обучить модель регрессии прогнозов временных рядов с помощью автоматизированного машинного обучения в службе Машинное обучение Azure Service. Настройка модели прогнозирования аналогична настройке стандартной модели регрессии с помощью автоматического машинного обучения, но для работы с данными временных рядов существуют определенные параметры конфигурации и этапы предварительной обработки. В следующих примерах показано, как:

* Подготовка данных для моделирования временных рядов
* Настройка отдельных параметров временных рядов в [`AutoMLConfig`](/python/api/azureml-train-automl/azureml.train.automl.automlconfig) объекте
* Выполнение прогнозов с данными временных рядов

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2X1GW]

Вы можете использовать автоматизированное средство ML для объединения методов и подходов и получения рекомендуемого, высококачественного прогноза временных рядов. Автоматизированный эксперимент по ряду времени рассматривается как многофакторнаяная задача регрессии. Последние значения временных рядов "сведены", чтобы стать дополнительными измерениями для регрессии вместе с другими прогностические факторы.

Этот подход, в отличие от классических методов временных рядов, имеет преимущество, включающее в себя несколько контекстных переменных и их связь друг с другом во время обучения. В реальных приложениях прогнозирования на прогнозе может влиять несколько факторов. Например, при прогнозировании продаж, взаимодействии исторических тенденций, обменного курса и цены все совместно обозначают результат продаж. Еще одним преимуществом является то, что все последние нововведения в моделях регрессии немедленно применяются для прогнозирования.

Вы можете [настроить](#config) , насколько далеко в будущем должен расширяться прогноз (горизонт прогнозирования), а также как задержка и многое другое. Автоматический ML изучает одну, но часто внутреннюю модель ветвления для всех элементов в наборе данных и прогнозирующих горизонтах. Итак, доступны дополнительные данные для оценки параметров модели, и обобщение невидимых рядов становится возможным.

Функции, извлеченные из обучающих данных, играют важную роль. И автоматизированное создание машинного обучения выполняет стандартные подготовительные действия и создает дополнительные функции временных рядов для сбора сезонных эффектов и максимального уровня точности прогнозов.

## <a name="prerequisites"></a>Предварительные требования

* Рабочая область службы машинного обучения Azure. Сведения о создании рабочей области см. в статье [Создание рабочей области службы машинное обучение Azure](how-to-manage-workspace.md).
* В этой статье предполагается, что вы можете настроить автоматический эксперимент машинного обучения. Следуйте указаниям [руководства](tutorial-auto-train-models.md) или [инструкции](how-to-configure-auto-train.md) , чтобы ознакомиться с основными шаблонами разработки экспериментов машинного обучения.

## <a name="preparing-data"></a>Подготовка данных

Самым важным различием между типом задачи регрессия прогнозирования и задачей регрессии в автоматизированном машинном обучении является включение в данные функции, представляющей допустимые временные ряды. Обычный временной ряд имеет четко определенную и постоянную частоту и имеет значение в каждой точке выборки в непрерывном промежутке времени. Рассмотрим следующий снимок файла `sample.csv`.

    day_datetime,store,sales_quantity,week_of_year
    9/3/2018,A,2000,36
    9/3/2018,B,600,36
    9/4/2018,A,2300,36
    9/4/2018,B,550,36
    9/5/2018,A,2100,36
    9/5/2018,B,650,36
    9/6/2018,A,2400,36
    9/6/2018,B,700,36
    9/7/2018,A,2450,36
    9/7/2018,B,650,36

Этот набор данных представляет собой простой пример ежедневных данных о продажах для компании с двумя разными магазинами: a и B. Кроме того, существует функция `week_of_year` , позволяющая модели обнаруживать еженедельные сезонности. Поле `day_datetime` представляет собой чистые временные ряды с ежедневной частотой, а поле `sales_quantity` — целевым столбцом для выполнения прогнозов. Прочтите данные в кадр данных Pandas, а затем используйте `to_datetime` функцию, чтобы убедиться, что временной ряд `datetime` является типом.

```python
import pandas as pd
data = pd.read_csv("sample.csv")
data["day_datetime"] = pd.to_datetime(data["day_datetime"])
```

В этом случае данные уже сортируются по полю `day_datetime`времени по возрастанию. Однако при настройке эксперимента необходимо, чтобы столбец времени был отсортирован в порядке возрастания для создания допустимого временного ряда. Предположим, что данные содержат 1 000 записей, и для создания обучающих и проверочных наборов данных необходимо выполнить детерминированное разбиение данных. Затем разделите целевое `sales_quantity` поле, чтобы создать прогнозы обучения и наборы тестов.

```python
X_train = data.iloc[:950]
X_test = data.iloc[-50:]

y_train = X_train.pop("sales_quantity").values
y_test = X_test.pop("sales_quantity").values
```

> [!NOTE]
> При обучении модели прогнозирования будущих значений убедитесь, что все функции, используемые при обучении, можно использовать при выполнении прогнозов для предполагаемого горизонта. Например, при создании прогноза спроса, включая функцию для текущей цены акций, может значительно увеличить точность обучения. Однако если вы планируете прогнозировать с долгим горизонтом, возможно, вам не удастся точно предсказать будущие значения запасов, соответствующие будущим точкам временного ряда, и точность модели может снизиться.

<a name="config"></a>
## <a name="configure-and-run-experiment"></a>Настройка и запуск эксперимента

Для задач прогнозирования автоматизированное машинное обучение использует шаги предварительной обработки и оценки, относящиеся к данным временных рядов. Будут выполнены следующие шаги предварительной обработки:

* Определите периодичность выборки временных рядов (например, ежечасно, ежедневно, еженедельно) и создайте новые записи для отсутствия временных точек, чтобы сделать серию непрерывной.
* Аппроксимация отсутствующие значения в целевом объекте (через прямую заливку) и в столбцах функций (используя медиану значений столбцов)
* Создание функций на основе детализации для включения фиксированных эффектов в разных рядах
* Создание функций на основе времени, которые помогут в освоении сезонных шаблонов
* Кодирование переменных категорий в числовые величины

`AutoMLConfig` Объект определяет параметры и данные, необходимые для автоматизированной задачи машинного обучения. Как и в случае с задачей регрессии, вы определяете стандартные параметры обучения, такие как тип задачи, число итераций, обучающие данные и число перекрестных проверок. Для задач прогнозирования необходимо задать дополнительные параметры, которые влияют на эксперимент. В следующей таблице описывается каждый параметр и его использование.

| Параметр | Описание | Обязательное значение |
|-------|-------|-------|
|`time_column_name`|Используется для указания столбца DateTime во входных данных, используемых для создания временных рядов и получения его частоты.|✓|
|`grain_column_names`|Имена, определяющие отдельные группы рядов во входных данных. Если детализация не определена, предполагается, что набор данных является одним временным набором.||
|`max_horizon`|Определяет максимальный требуемый горизонт прогноза в единицах частоты временного ряда. Единицы измерения основаны на интервале времени ваших обучающих данных, например ежемесячно и еженедельно, что прогноз должен быть прогнозируемым.|✓|
|`target_lags`|*n* периодов для наката целевых значений перед обучением модели.||
|`target_rolling_window_size`|*n* периодов, используемых для создания прогнозируемых значений, < = обучающий набор. Если не указано, *n* — это полный размер набора для обучения.||

Создайте параметры временных рядов в качестве объекта Dictionary. Присвойтесвойствузначениеполявнабореданных.`time_column_name` `day_datetime` Определите параметр, чтобы убедиться, что для данных созданы **две отдельные группы временных рядов** . одна для хранения A и B. Наконец, установите `max_horizon` значение в 50 для прогнозирования всего набора тестов. `grain_column_names` Задайте для окна прогноза 10 периодов `target_rolling_window_size`с и задерживает целевые значения на 2 периода `target_lags` с помощью параметра.

```python
time_series_settings = {
    "time_column_name": "day_datetime",
    "grain_column_names": ["store"],
    "max_horizon": 50,
    "target_lags": 2,
    "target_rolling_window_size": 10,
    "preprocess": True,
}
```

> [!NOTE]
> Этапы предварительной обработки автоматизированного машинного обучения (нормализация компонентов, обработка недостающих данных, преобразование текста в числовой формат и т. д.) становятся частью базовой модели. При использовании модели для прогнозирования эти этапы предварительной обработки, которые выполнялись во время обучения, автоматически выполняются для входных данных.

Теперь создайте Стандартный `AutoMLConfig` объект, `forecasting` указав тип задачи, и отправьте эксперимент. После завершения модели извлеките наиболее подходящую итерацию выполнения.

```python
from azureml.core.workspace import Workspace
from azureml.core.experiment import Experiment
from azureml.train.automl import AutoMLConfig
import logging

automl_config = AutoMLConfig(task='forecasting',
                             primary_metric='normalized_root_mean_squared_error',
                             iterations=10,
                             X=X_train,
                             y=y_train,
                             n_cross_validations=5,
                             enable_ensembling=False,
                             verbosity=logging.INFO,
                             **time_series_settings)

ws = Workspace.from_config()
experiment = Experiment(ws, "forecasting_example")
local_run = experiment.submit(automl_config, show_output=True)
best_run, fitted_model = local_run.get_output()
```

> [!NOTE]
> Для процедуры перекрестной проверки (ОПС) данные временных рядов могут нарушать базовые статистические предположения канонической стратегии перекрестной проверки на K, поэтому в автоматизированном машинном обучении реализуется процедура проверки отката источника для создания циклы перекрестной проверки для данных временных рядов. Чтобы использовать эту процедуру, укажите `n_cross_validations` параметр `AutoMLConfig` в объекте. Можно обходить проверку и использовать собственные наборы проверки с `X_valid` параметрами и. `y_valid`

### <a name="view-feature-engineering-summary"></a>Просмотреть сводные данные по проектированию функций

Для типов задач временных рядов в автоматизированном машинном обучении можно просмотреть сведения из процесса проектирования компонентов. В следующем коде показана каждая необработанная функция вместе со следующими атрибутами:

* Имя необработанного компонента
* Число сконструированных функций, сформированных за пределами этой необработанной функции
* Обнаружен тип
* Удален ли компонент
* Список преобразований компонентов для необработанных функций

```python
fitted_model.named_steps['timeseriestransformer'].get_featurization_summary()
```

## <a name="forecasting-with-best-model"></a>Прогнозирование с помощью лучшей модели

Используйте лучшую итерацию модели для прогнозирования значений для набора проверочных данных.

```python
y_predict = fitted_model.predict(X_test)
y_actual = y_test.flatten()
```

Кроме того, можно использовать `forecast()` функцию `predict()`, а не, которая позволит указать, когда должны начинаться прогнозы. В следующем примере сначала заменяются все значения в `y_pred` с помощью. `NaN` Источник прогноза будет находиться в конце обучающих данных в этом случае, как обычно при использовании `predict()`. Однако при замене только второй половины `y_pred` `NaN`функции функция будет оставлять числовые значения в первой половине `NaN` неизменного, но прогнозировать значения во второй половине. Функция возвращает прогнозируемые значения и выданные функции.

Можно также использовать `forecast_destination` параметр `forecast()` в функции для прогнозирования значений до указанной даты.

```python
y_query = y_test.copy().astype(np.float)
y_query.fill(np.nan)
y_fcst, X_trans = fitted_pipeline.forecast(
    X_test, y_query, forecast_destination=pd.Timestamp(2019, 1, 8))
```

Вычислить Корень среднеквадратичной погрешности (среднее значение ошибки в корне `y_test` ) между фактическими значениями и прогнозируемыми значениями `y_pred`в.

```python
from sklearn.metrics import mean_squared_error
from math import sqrt

rmse = sqrt(mean_squared_error(y_actual, y_predict))
rmse
```

Теперь, когда определена точность общей модели, наиболее реалистичным следующим шагом является использование модели для прогнозирования неизвестных будущих значений. Просто укажите набор данных в том же формате, что и тестовый `X_test` набор, но с будущими DateTimes, а результирующий набор прогнозов — прогнозируемые значения для каждого шага временного ряда. Предположим, что последние записи временных рядов в наборе данных были 12/31/2018. Чтобы прогнозировать спрос на следующий день (или столько периодов, сколько необходимо для прогнозирования, < = `max_horizon`), создайте одну запись временных рядов для каждого магазина 01/01/2019.

    day_datetime,store,week_of_year
    01/01/2019,A,1
    01/01/2019,A,1

Повторите необходимые шаги, чтобы загрузить эти будущие данные в таблицу данных, а затем выполните `best_run.predict(X_test)` для прогнозирования будущих значений.

> [!NOTE]
> Невозможно прогнозировать значения для количества периодов больше, `max_horizon`чем. Модель должна быть повторно обучена с большим горизонтом для прогнозирования будущих значений за пределами текущего горизонта.

## <a name="next-steps"></a>Следующие шаги

* Следуйте указаниям [учебника](tutorial-auto-train-models.md) , чтобы научиться создавать эксперименты с помощью автоматизированного машинного обучения.
* Ознакомьтесь с справочной документацией по [пакету SDK машинное обучение Azure для Python](https://docs.microsoft.com/python/api/overview/azure/ml/intro?view=azure-ml-py) .
