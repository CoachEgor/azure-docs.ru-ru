---
title: Автопоезд модель прогноза временных рядов
titleSuffix: Azure Machine Learning
description: Узнайте, как использовать машинное обучение Azure для обучения модели прогнозирования регрессии временных рядов с помощью автоматизированного машинного обучения.
services: machine-learning
author: trevorbye
ms.author: trbye
ms.service: machine-learning
ms.subservice: core
ms.reviewer: trbye
ms.topic: conceptual
ms.date: 03/09/2020
ms.openlocfilehash: d4e36c0d3838af85768453496a51ecd295c22b93
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79081851"
---
# <a name="auto-train-a-time-series-forecast-model"></a>Автопоезд модель прогноза временных рядов
[!INCLUDE [aml-applies-to-basic-enterprise-sku](../../includes/aml-applies-to-basic-enterprise-sku.md)]

В этой статье вы узнаете, как обучить модель регрессии временных рядов с помощью автоматизированного машинного обучения в Azure Machine Learning. Настройка модели прогнозирования аналогична настройке стандартной модели регрессии с использованием автоматизированного машинного обучения, но для работы с данными временных рядов существуют определенные параметры конфигурации и предобработка. Следующие примеры показывают, как:

* Подготовка данных для моделирования временных рядов
* Настройка определенных параметров временных рядов в объекте [`AutoMLConfig`](/python/api/azureml-train-automl-client/azureml.train.automl.automlconfig.automlconfig)
* Запуск прогнозов с данными временных рядов

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2X1GW]

Вы можете использовать автоматизированный ML для объединения методов и подходов и получения рекомендуемого, высококачественного прогноза временных рядов. Автоматизированный эксперимент временных рядов рассматривается как многовариантная проблема регрессии. Значения прошлых временных рядов «поворачиваются», чтобы стать дополнительными измерениями для регрессора вместе с другими предикторами.

Этот подход, в отличие от классических методов временных рядов, имеет преимущество естественного включения нескольких контекстуальных переменных и их отношения друг с другом во время обучения. В реальных приложениях прогнозирования несколько факторов могут влиять на прогноз. Например, при прогнозировании продаж, взаимодействия исторических тенденций, обменного курса и цены все совместно диск результат продаж. Еще одним преимуществом является то, что все последние нововведения в регрессионных моделях немедленно применяются к прогнозированию.

Можно [настроить,](#config) как далеко в будущее должен распространяться прогноз (горизонт прогноза), а также лаги и многое другое. Автоматизированная ML изучает одну, но часто внутренне разветвленную модель для всех элементов в области набора данных и горизонтов прогнозирования. Таким образом, имеются дополнительные данные для оценки параметров модели и возможного обобщения невидимых рядов.

Функции, извлеченные из обучаемых данных, играют решающую роль. Кроме того, автоматизированный ML выполняет стандартные предобработки и создает дополнительные функции временных рядов для фиксации сезонных эффектов и максимальной точности прогнозирования.

## <a name="time-series-and-deep-learning-models"></a>Тайм-ряды и модели глубокого обучения


Автоматизированный ML предоставляет пользователям как родные временные ряды, так и модели глубокого обучения в рамках системы рекомендаций. К числу учащихся относятся:
+ Пророк
+ Авто-АРИМА
+ ПрогнозTCN

Глубокое обучение мЛ позволяет прогнозировать неиварные и многовариантные данные временных рядов.

Модели глубокого обучения имеют три внутренних возможности:
1. Они могут учиться на произвольных отображениях от входных данных к выводам
1. Они поддерживают несколько входов и выходов
1. Они могут автоматически извлекать закономерности в входных данных, которые охватывают длинные последовательности

Учитывая более крупные данные, модели глубокого обучения, такие как Microsoft ForecastTCN, могут улучшить оценки полученной модели. 

Родные временные ряды учащихся также предоставляются в рамках автоматизированного ML. Пророк лучше всего работает с тайм-рядами, которые имеют сильные сезонные эффекты и несколько сезонов исторических данных. Пророк точен & быстро, надежно к выбросам, отсутствующим данным и резким изменениям в ваших временных рядах. 

AutoRegressive Integrated Moving Average (ARIMA) является популярным статистическим методом прогнозирования временных рядов. Этот метод прогнозирования обычно используется в краткосрочных сценариях прогнозирования, где данные показывают доказательства тенденций, таких как циклы, которые могут быть непредсказуемыми и трудно моделировать или прогнозировать. Auto-ARIMA преобразует ваши данные в стационарные данные, чтобы получить согласованные и надежные результаты.

## <a name="prerequisites"></a>Предварительные требования

* Рабочая область машинного обучения Azure. Для создания рабочего пространства [см.](how-to-manage-workspace.md)
* Эта статья предполагает базовое знакомство с настройкой автоматизированного эксперимента машинного обучения. Следуйте [учебнику](tutorial-auto-train-models.md) или [как](how-to-configure-auto-train.md) увидеть основные шаблоны разработки экспериментов по автоматическому компьютерному обучению.

## <a name="preparing-data"></a>Подготовка данных

Наиболее важным различием между типом задачи регрессии прогнозирования и типом задачи регрессии в автоматизированном машинном обучении является включение в данных функции, представляющей допустимые временные ряды. Регулярные временные ряды имеет четко определенную и последовательную частоту и имеет значение в каждой точке выборки в непрерывном промежутке времени. Рассмотрим следующий снимок файла `sample.csv`.

    day_datetime,store,sales_quantity,week_of_year
    9/3/2018,A,2000,36
    9/3/2018,B,600,36
    9/4/2018,A,2300,36
    9/4/2018,B,550,36
    9/5/2018,A,2100,36
    9/5/2018,B,650,36
    9/6/2018,A,2400,36
    9/6/2018,B,700,36
    9/7/2018,A,2450,36
    9/7/2018,B,650,36

Этот набор данных является простым примером ежедневных данных о продажах для компании, которая `week_of_year` имеет два разных магазина, A и B. Кроме того, есть функция, которая позволит модели обнаружить еженедельную сезонность. Поле `day_datetime` представляет собой чистую временную серию `sales_quantity` с ежедневной частотой, а поле является целевым столбцом для выполнения прогнозов. Прочитайте данные в раме данных `to_datetime` Pandas, а затем `datetime` используйте функцию, чтобы гарантировать, что временные ряды будут типами.

```python
import pandas as pd
data = pd.read_csv("sample.csv")
data["day_datetime"] = pd.to_datetime(data["day_datetime"])
```

В этом случае данные уже отсортированы, поднимаясь по временному полю. `day_datetime` Однако при настройке эксперимента убедитесь, что столбец желаемого времени сортируется в порядке возрастания, чтобы построить допустимый временной ряд. Предположим, что данные содержат 1000 записей, и сделать детерминированный раскол в данных для создания наборов обучаемых и тестовых данных. Определите имя столбца метки и установите его на этикетку. В этом примере метка будет `sales_quantity`. Затем отделите `test_data` поле метки от формы `test_target` набора.

```python
train_data = data.iloc[:950]
test_data = data.iloc[-50:]

label =  "sales_quantity"
 
test_labels = test_data.pop(label).values
```

> [!NOTE]
> При обучении модели прогнозирования будущих значений убедитесь, что все функции, используемые в обучении, могут быть использованы при запуске прогнозов для намеченного горизонта. Например, при создании прогноза спроса, включая функцию для текущей цены акций, может значительно повысить точность обучения. Однако, если вы собираетесь прогнозировать с длинным горизонтом, вы не сможете точно предсказать будущие значения запасов, соответствующие будущим точкам временных рядов, и точность модели может пострадать.

<a name="config"></a>
## <a name="configure-and-run-experiment"></a>Настройка и запуск эксперимента

Для задач прогнозирования автоматизированное машинное обучение использует шаги предварительной обработки и оценки, которые специфичны для данных временных рядов. Будут выполнены следующие этапы предварительной обработки:

* Обнаружить частоту выборок временных рядов (например, почасовую, ежедневную, еженедельную) и создать новые записи для отсутствующих временных точек, чтобы сделать серию непрерывной.
* Внушать недостающие значения в цель (через передний заливку) и столбцы функций (с использованием значений среднего столбца)
* Создание функций на основе зерна для включения фиксированных эффектов в различных сериях
* Создание функций, основанных на времени, для обучения сезонным моделям
* Кодирование категориальных переменных в числовых количествах

Объект [`AutoMLConfig`](https://docs.microsoft.com/python/api/azureml-train-automl-client/azureml.train.automl.automlconfig.automlconfig?view=azure-ml-py) определяет параметры и данные, необходимые для автоматизированной задачи машинного обучения. Подобно проблеме регрессии, вы определяете стандартные параметры обучения, такие как тип задачи, количество итераций, обучающие данные и количество перекрестных валидий. Для задач прогнозирования необходимо установить дополнительные параметры, влияющие на эксперимент. В следующей таблице объясняется каждый параметр и его использование.

| Название&nbsp;параметра | Описание | Обязательно |
|-------|-------|-------|
|`time_column_name`|Используется для определения столбца времени даты в входных данных, используемых для построения временных рядов и определения его частоты.|✓|
|`grain_column_names`|Имя (ы) определение отдельных групп рядов в входных данных. Если зерно не определено, то набор данных считается одним тайм-рядом.||
|`max_horizon`|Определяет максимальный желаемый горизонт прогноза в единицах частоты временных рядов. Единицы основаны на временном интервале ваших обучаемых данных, например, ежемесячно, еженедельно, что прогнозист должен предсказать.|✓|
|`target_lags`|Количество строк для отставания целевых значений на основе частоты данных. Отставание представлено как список или один целый ряд. Отставание следует использовать, когда связь между независимыми переменными и зависимой переменной не совпадает или коррелирует по умолчанию. Например, при попытке спрогнозировать спрос на продукт, спрос в любой месяц может зависеть от цены конкретных товаров за 3 месяца до этого. В этом примере вы можете отстать от целевого (спроса) отрицательно на 3 месяца, чтобы модель тренировалась на правильных отношениях.||
|`target_rolling_window_size`|*n* исторические периоды, которые можно использовать для генерации прогнозируемых значений, <размер набора обучения. Если опущен, *n* является полным размером набора обучения. Укажите этот параметр, если вы хотите учитывать только определенное количество истории при обучении модели.||
|`enable_dnn`|Включить прогнозирование DNNs.||

Дополнительную информацию можно узнать из [справочной документации.](/python/api/azureml-train-automl-client/azureml.train.automl.automlconfig.automlconfig)

Создайте настройки временных рядов в виде объекта словаря. Установите `time_column_name` `day_datetime` поле в наборе данных. Определить `grain_column_names` параметр для обеспечения создания **двух отдельных групп временных рядов** для данных; один для хранения A и B. `max_horizon` Наконец, установите до 50 для того, чтобы предсказать весь набор тестов. Установите окно прогноза до `target_rolling_window_size`10 периодов с и укажите одно запаздывание по целевым значениям на два периода вперед с параметром. `target_lags` Рекомендуется установить, `max_horizon` `target_rolling_window_size` и `target_lags` "авто", который будет автоматически обнаруживать эти значения для вас. В приведенном ниже примере для этих параметров использовались параметры "авто". 

```python
time_series_settings = {
    "time_column_name": "day_datetime",
    "grain_column_names": ["store"],
    "max_horizon": "auto",
    "target_lags": "auto",
    "target_rolling_window_size": "auto",
    "preprocess": True,
}
```

> [!NOTE]
> Этапы предварительной обработки автоматизированного машинного обучения (нормализация компонентов, обработка недостающих данных, преобразование текста в числовой формат и т. д.) становятся частью базовой модели. При использовании модели для прогнозирования эти этапы предварительной обработки, которые выполнялись во время обучения, автоматически выполняются для входных данных.

Определив `grain_column_names` фрагмент кода выше, AutoML создаст две отдельные группы временных рядов, также известные как несколько временных рядов. Если зерно не определено, AutoML предполагает, что набор данных представляет собой единую временную серию. Чтобы узнать больше о одиночных временных рядах, см [energy_demand_notebook.](https://github.com/Azure/MachineLearningNotebooks/tree/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand)

Теперь создайте стандартный `AutoMLConfig` `forecasting` объект, указав тип задачи, и отправьте эксперимент. После завершения модели извлеките лучшую итерацию.

```python
from azureml.core.workspace import Workspace
from azureml.core.experiment import Experiment
from azureml.train.automl import AutoMLConfig
import logging

automl_config = AutoMLConfig(task='forecasting',
                             primary_metric='normalized_root_mean_squared_error',
                             experiment_timeout_minutes=15,
                             enable_early_stopping=True,
                             training_data=train_data,
                             label_column_name=label,
                             n_cross_validations=5,
                             enable_ensembling=False,
                             verbosity=logging.INFO,
                             **time_series_settings)

ws = Workspace.from_config()
experiment = Experiment(ws, "forecasting_example")
local_run = experiment.submit(automl_config, show_output=True)
best_run, fitted_model = local_run.get_output()
```

Ознакомьтесь с [блокнотами для прогнозирования](https://github.com/Azure/MachineLearningNotebooks/tree/master/how-to-use-azureml/automated-machine-learning) для подробных примеров расширенного прогнозирования, включая:

* [обнаружение и феатуризация праздников](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-bike-share/auto-ml-forecasting-bike-share.ipynb)
* [перекрестная проверка подвижного происхождения](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand/auto-ml-forecasting-energy-demand.ipynb)
* [настраиваемые лаги](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-bike-share/auto-ml-forecasting-bike-share.ipynb)
* [функции агрегата прокатки окон](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand/auto-ml-forecasting-energy-demand.ipynb)
* [DNN](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-beer-remote/auto-ml-forecasting-beer-remote.ipynb)

### <a name="configure-a-dnn-enable-forecasting-experiment"></a>Настройка DNN позволяет прогнозировать эксперимент

> [!NOTE]
> Поддержка DNN для прогнозирования в автоматизированном машинном обучении находится в Предварительном просмотре и не поддерживается для локальных запусков.

Для того, чтобы использовать DNNs для прогнозирования, вам нужно будет установить `enable_dnn` параметр в AutoMLConfig к истине. 

Мы рекомендуем использовать кластер AML Compute с GPU SKUs и по крайней мере двумя узлами в качестве вычислительной цели. Чтобы обеспечить достаточное время для завершения обучения DNN, мы рекомендуем установить тайм-аут эксперимента как минимум на пару часов.
Для получения дополнительной информации о aML вычислений и VM размеров, которые включают GPU, см [AML Compute документации](how-to-set-up-training-targets.md#amlcompute) и [GPU оптимизированы виртуальные размеры машины документации](https://docs.microsoft.com/azure/virtual-machines/linux/sizes-gpu).

Просмотр [ноутбука по прогнозированию производства напитков](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-beer-remote/auto-ml-forecasting-beer-remote.ipynb) можно использовать для получения подробного примера кода с использованием DNNs.

### <a name="view-feature-engineering-summary"></a>Просмотр светого инженерного представления функций

Для типов задач временных рядов в автоматизированном машинном обучении можно просматривать детали процесса проектирования объектов. Следующий код показывает каждую необработанную функцию вместе со следующими атрибутами:

* Имя объекта raw
* Количество инженерных функций, сформированных из этой необработанной функции
* Обнаруженный тип
* Была ли удалена функция
* Список преобразований функций для необработанной функции

```python
fitted_model.named_steps['timeseriestransformer'].get_featurization_summary()
```

## <a name="forecasting-with-best-model"></a>Прогнозирование с лучшей моделью

Используйте лучшую итерацию модели для прогнозирования значений для набора тестовых данных.

```python
predict_labels = fitted_model.predict(test_data)
actual_labels = test_labels.flatten()
```

Кроме того, вы `forecast()` можете использовать `predict()`функцию вместо, которая позволит спецификации, когда прогнозы должны начаться. В следующем примере вы сначала замените все значения `y_pred` `NaN`на . Прогноз происхождения будет в конце обучения данных в этом случае, `predict()`как это обычно бывает при использовании . Однако, если вы заменили `y_pred` `NaN`только вторую половину с , функция оставит числовые значения `NaN` в первой половине неизменены, но прогноз значения во второй половине. Функция возвращает как прогнозируемые значения, так и выровненные объекты.

Можно также использовать `forecast_destination` параметр `forecast()` в функции для прогнозирования значений до указанной даты.

```python
label_query = test_labels.copy().astype(np.float)
label_query.fill(np.nan)
label_fcst, data_trans = fitted_pipeline.forecast(
    test_data, label_query, forecast_destination=pd.Timestamp(2019, 1, 8))
```

Рассчитайте RMSE (ошибка исходного квадрата) между `actual_labels` фактическими `predict_labels`значениями и прогнозируемыми значениями в.

```python
from sklearn.metrics import mean_squared_error
from math import sqrt

rmse = sqrt(mean_squared_error(actual_labels, predict_labels))
rmse
```

Теперь, когда была определена общая точность модели, наиболее реалистичным следующим шагом является использование модели для прогнозирования неизвестных будущих значений. Предоставь данные, установленные в `test_data` том же формате, что и тестовый набор, но с будущими датами, и полученный набор прогнозов является прогнозируемым значением для каждого шага временных рядов. Предположим, что последние рекорды временных рядов в наборе данных были за 12/31/2018. Чтобы спрогнозировать спрос на следующий день (или столько `max_horizon`периодов, сколько вам нужно прогнозировать, <) создайте единый рекорд временных рядов для каждого магазина за 01/01/2019.

    day_datetime,store,week_of_year
    01/01/2019,A,1
    01/01/2019,A,1

Повторите необходимые шаги для загрузки этих будущих данных в кадр данных, а затем запустите `best_run.predict(test_data)` для прогнозирования будущих значений.

> [!NOTE]
> Значения не могут быть предсказаны для `max_horizon`количества периодов, превышаюющих . Модель должна быть переобучана с большим горизонтом для прогнозирования будущих значений за пределами текущего горизонта.

## <a name="next-steps"></a>Дальнейшие действия

* Следуйте [учебник,](tutorial-auto-train-models.md) чтобы узнать, как создавать эксперименты с автоматизированным машинным обучением.
* Просмотр [SDK для машинного обучения Azure для](https://docs.microsoft.com/python/api/overview/azure/ml/intro?view=azure-ml-py) справочной документации Python.
