---
title: Автоматическая обучение модели прогнозирования временных рядов
titleSuffix: Azure Machine Learning
description: Узнайте, как использовать Машинное обучение Azure для обучения модели регрессии прогнозирования временных рядов с помощью автоматизированного машинного обучения.
services: machine-learning
author: trevorbye
ms.author: trbye
ms.service: machine-learning
ms.subservice: core
ms.reviewer: trbye
ms.topic: conceptual
ms.date: 03/09/2020
ms.openlocfilehash: 05d658c052c5bc12f49d957bb29ad085c269c57b
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82137380"
---
# <a name="auto-train-a-time-series-forecast-model"></a>Автоматическая обучение модели прогнозирования временных рядов
[!INCLUDE [aml-applies-to-basic-enterprise-sku](../../includes/aml-applies-to-basic-enterprise-sku.md)]

Из этой статьи вы узнаете, как настроить и обучить модель регрессии прогнозов временных рядов с помощью автоматизированного машинного обучения в Машинное обучение Azure. 

Настройка модели прогнозирования аналогична настройке стандартной модели регрессии с помощью автоматического машинного обучения, но для работы с данными временных рядов существуют определенные параметры конфигурации и этапы предварительной обработки. 

Например, можно [настроить](#config) , насколько далеко в будущем должен расширяться прогноз (горизонт прогнозирования), а также как задержка и многое другое. Автоматический ML изучает одну, но часто внутреннюю модель ветвления для всех элементов в наборе данных и прогнозирующих горизонтах. Итак, доступны дополнительные данные для оценки параметров модели, и обобщение невидимых рядов становится возможным.

В следующих примерах показано, как:

* Подготовка данных для моделирования временных рядов
* Настройка отдельных параметров временных рядов в [`AutoMLConfig`](/python/api/azureml-train-automl-client/azureml.train.automl.automlconfig.automlconfig) объекте
* Выполнение прогнозов с данными временных рядов

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2X1GW]

В отличие от классических методов временных рядов, в автоматизированном языке ML значения временных рядов "сведены", чтобы стать дополнительными измерениями для регрессии вместе с другими прогностические факторы. Этот подход включает в себя несколько контекстных переменных и их связь друг с другом во время обучения. Так как несколько факторов могут повлиять на прогноз, этот метод хорошо согласуется с реальными сценариями прогнозирования. Например, при прогнозировании продаж, взаимодействии исторических тенденций, обменного курса и цены все совместно обозначают результат продаж. 

Функции, извлеченные из обучающих данных, играют важную роль. И автоматизированное создание машинного обучения выполняет стандартные действия предварительной обработки и создает дополнительные функции временных рядов для сбора сезонных эффектов и максимального уровня точности прогнозов.

## <a name="time-series-and-deep-learning-models"></a>Модели временных рядов и моделей глубокого обучения


Автоматическое глубокое обучение в МАШИНном обучении позволяет прогнозировать данные временных рядов унивариате и многофакторная.

Модели глубокого обучения имеют три встроенных возможности:
1. Они могут узнать от произвольных сопоставлений от входных данных до выходов
1. Они поддерживают несколько входов и выходов.
1. Они могут автоматически извлекать закономерности во входных данных, охватывающие длинные последовательности.

При наличии больших данных модели глубокого обучения, такие как Форекастткн Майкрософт, могут улучшить показатели результирующей модели. Узнайте, как [настроить эксперимент для глубокого обучения](#configure-a-dnn-enable-forecasting-experiment).

Автоматический ML предоставляет пользователям собственные модели временного и глубокого обучения в рамках системы рекомендаций. 


Модели| Описание | Преимущества
----|----|---
Профет (Предварительная версия)|Профет работает наилучшим образом с временными рядами, которые обладают сильными сезонными эффектами и несколькими временами исторических данных. | Точная & высокая, надежная для выбросов, отсутствующих данных и существенных изменений в временных рядах.
Auto-ARIMA (Предварительная версия)|Интегрированное скользящее среднее с авторегрессией (ARIMA) работает лучше, когда данные замещаются в стационарном виде. Это означает, что его статистические свойства, такие как среднее и вариативность, постоянны для всего набора. Например, если Вы переворачиваете монет, то вероятность появления головок составляет 50%, независимо от того, переворачиваются ли вы сегодня, завтра или в следующий год.| Отлично подходит для серии унивариате, так как для прогнозирования будущих значений используются прошлые значения.
Форекастткн (Предварительная версия)| Форекастткн — это модель нейронной сети, предназначенная для решения самых ресурсоемких задач прогнозирования, отслеживания нелинейных локальных и глобальных тенденций в данных, а также связей между временными рядами.|Возможность использования сложных тенденций в данных и легко масштабируется до самых крупных наборов данных.

## <a name="prerequisites"></a>Предварительные условия

* Рабочая область машинного обучения Azure. Сведения о создании рабочей области см. в статье [создание машинное обучение Azure рабочей области](how-to-manage-workspace.md).
* В этой статье предполагается, что вы можете настроить автоматический эксперимент машинного обучения. Следуйте указаниям [руководства](tutorial-auto-train-models.md) или [инструкции](how-to-configure-auto-train.md) , чтобы ознакомиться с основными шаблонами разработки экспериментов машинного обучения.

## <a name="preparing-data"></a>Подготовка данных

Самым важным различием между типом задачи регрессия прогнозирования и задачей регрессии в автоматизированном машинном обучении является включение в данные функции, представляющей допустимые временные ряды. Обычный временной ряд имеет четко определенную и постоянную частоту и имеет значение в каждой точке выборки в непрерывном промежутке времени. Рассмотрим следующий снимок файла `sample.csv`.

    day_datetime,store,sales_quantity,week_of_year
    9/3/2018,A,2000,36
    9/3/2018,B,600,36
    9/4/2018,A,2300,36
    9/4/2018,B,550,36
    9/5/2018,A,2100,36
    9/5/2018,B,650,36
    9/6/2018,A,2400,36
    9/6/2018,B,700,36
    9/7/2018,A,2450,36
    9/7/2018,B,650,36

Этот набор данных представляет собой простой пример ежедневных данных о продажах для компании с двумя разными магазинами: A и B. Кроме того, существует функция `week_of_year` , позволяющая модели обнаруживать еженедельные сезонности. Поле `day_datetime` представляет собой чистые временные ряды с ежедневной частотой, а поле `sales_quantity` — целевым столбцом для выполнения прогнозов. Прочтите данные в кадр данных Pandas, а затем используйте `to_datetime` функцию, чтобы убедиться, что временной ряд является `datetime` типом.

```python
import pandas as pd
data = pd.read_csv("sample.csv")
data["day_datetime"] = pd.to_datetime(data["day_datetime"])
```

В этом случае данные уже сортируются по полю `day_datetime`времени по возрастанию. Однако при настройке эксперимента необходимо, чтобы столбец времени был отсортирован в порядке возрастания для создания допустимого временного ряда. Предположим, что данные содержат 1 000 записей, и для создания обучающих и проверочных наборов данных необходимо выполнить детерминированное разбиение данных. Укажите имя столбца меток и присвойте ему метку. В этом примере метка будет иметь `sales_quantity`значение. Затем разделите поле метки от `test_data` , чтобы сформировать `test_target` набор.

```python
train_data = data.iloc[:950]
test_data = data.iloc[-50:]

label =  "sales_quantity"
 
test_labels = test_data.pop(label).values
```

> [!NOTE]
> При обучении модели прогнозирования будущих значений убедитесь, что все функции, используемые при обучении, можно использовать при выполнении прогнозов для предполагаемого горизонта. Например, при создании прогноза спроса, включая функцию для текущей цены акций, может значительно увеличить точность обучения. Однако если вы планируете прогнозировать с долгим горизонтом, возможно, вам не удастся точно предсказать будущие значения запасов, соответствующие будущим точкам временного ряда, и точность модели может снизиться.

<a name="config"></a>

## <a name="train-and-validation-data"></a>Обучение и проверка данных
Отдельные наборы обучения и проверки можно указать непосредственно в `AutoMLConfig` конструкторе.

### <a name="rolling-origin-cross-validation"></a>Перекрестная проверка пересечения источников
Для разбиения временных рядов по временной последовательности с помощью перекрестной проверки источника временных рядов (РОКВ) используется временно согласованный временной ряд. РОКВ делит ряд на данные для обучения и проверки с помощью точки во времени происхождения. Скользящий источник во времени создает сгибы перекрестной проверки.  

![замещающий текст](./media/how-to-auto-train-forecast/ROCV.svg)

Эта стратегия сохранит целостность данных временных рядов и устранит риск утечки данных. РОКВ автоматически используется для прогнозирования задач путем передачи данных об обучении и проверке вместе и настройки числа сверток перекрестной проверки с `n_cross_validations`помощью. 

```python
automl_config = AutoMLConfig(task='forecasting',
                             n_cross_validations=3,
                             ...
                             **time_series_settings)
```
Дополнительные сведения о [аутомлконфиг](#configure-and-run-experiment).

## <a name="configure-and-run-experiment"></a>Настройка и запуск эксперимента

Для задач прогнозирования автоматизированное машинное обучение использует шаги предварительной обработки и оценки, относящиеся к данным временных рядов. Будут выполнены следующие шаги предварительной обработки:

* Определите периодичность выборки временных рядов (например, ежечасно, ежедневно, еженедельно) и создайте новые записи для отсутствия временных точек, чтобы сделать ряд непрерывным.
* Аппроксимация отсутствующие значения в целевом объекте (через прямую заливку) и в столбцах функций (используя медиану значений столбцов)
* Создание функций на основе детализации для включения фиксированных эффектов в разных рядах
* Создание функций на основе времени, которые помогут в освоении сезонных шаблонов
* Кодирование переменных категорий в числовые величины

[`AutoMLConfig`](https://docs.microsoft.com/python/api/azureml-train-automl-client/azureml.train.automl.automlconfig.automlconfig?view=azure-ml-py) Объект определяет параметры и данные, необходимые для автоматизированной задачи машинного обучения. Как и в случае с задачей регрессии, вы определяете стандартные параметры обучения, такие как тип задачи, число итераций, обучающие данные и число перекрестных проверок. Для задач прогнозирования необходимо задать дополнительные параметры, которые влияют на эксперимент. В следующей таблице описывается каждый параметр и его использование.

| Имя&nbsp;параметра | Описание | Обязательный |
|-------|-------|-------|
|`time_column_name`|Используется для указания столбца DateTime во входных данных, используемых для создания временных рядов и получения его частоты.|✓|
|`grain_column_names`|Имена, определяющие отдельные группы рядов во входных данных. Если детализация не определена, предполагается, что набор данных является одним временным набором.||
|`max_horizon`|Определяет максимальный требуемый горизонт прогноза в единицах частоты временного ряда. Единицы измерения основаны на интервале времени ваших обучающих данных, например ежемесячно, который должен прогнозироваться прогнозом.|✓|
|`target_lags`|Число строк для запаздывания целевых значений на основе частоты данных. Запаздывание представляется в виде списка или одного целого числа. Запаздывание следует использовать, когда связь между независимыми и зависимыми переменными не совпадает по умолчанию или не соотносится. Например, при попытке прогнозировать спрос на продукт спрос за любой месяц может зависеть от цены на продуктов 3 месяца. В этом примере может потребоваться запаздывание цели (спрос), отрицательно на 3 месяца, чтобы модель обучена по правильной связи.||
|`target_rolling_window_size`|*n* периодов, используемых для создания прогнозируемых значений, <= обучающий набор. Если не указано, *n* — это полный размер набора для обучения. Укажите этот параметр, если нужно обдумать только определенный объем журнала при обучении модели.||
|`enable_dnn`|Включить прогнозирование DNN.||

Дополнительные сведения см. в [справочной документации](/python/api/azureml-train-automl-client/azureml.train.automl.automlconfig.automlconfig) .

Создайте параметры временных рядов в качестве объекта Dictionary. `time_column_name` Присвойте свойству `day_datetime` значение поля в наборе данных. Определите `grain_column_names` параметр, чтобы обеспечить создание **двух отдельных групп временных рядов** для данных. для хранения A и B. Наконец, для прогнозирования всего `max_horizon` набора тестов установите значение в 50. Задайте для окна "прогноз" значение 10 `target_rolling_window_size`периодов и укажите одну задержку для целевых значений за две точки вперед с помощью `target_lags` параметра. Рекомендуется задать и `max_horizon` `target_lags` значение "Auto `target_rolling_window_size` ", которое будет автоматически определять эти значения. В приведенном ниже примере для этих параметров использовались параметры Auto. 

```python
time_series_settings = {
    "time_column_name": "day_datetime",
    "grain_column_names": ["store"],
    "max_horizon": "auto",
    "target_lags": "auto",
    "target_rolling_window_size": "auto",
    "preprocess": True,
}
```

> [!NOTE]
> Этапы предварительной обработки автоматизированного машинного обучения (нормализация компонентов, обработка недостающих данных, преобразование текста в числовой формат и т. д.) становятся частью базовой модели. При использовании модели для прогнозирования эти этапы предварительной обработки, которые выполнялись во время обучения, автоматически выполняются для входных данных.

Определив `grain_column_names` в приведенном выше фрагменте кода, аутомл создаст две отдельные группы временных рядов, также известные как несколько временных рядов. Если детализация не определена, Аутомл предполагает, что набор данных является единственным временным набором. Дополнительные сведения об отдельных временных рядах см. в [energy_demand_notebook](https://github.com/Azure/MachineLearningNotebooks/tree/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand).

Теперь создайте Стандартный `AutoMLConfig` объект, указав тип `forecasting` задачи, и отправьте эксперимент. После завершения модели извлеките наиболее подходящую итерацию выполнения.

```python
from azureml.core.workspace import Workspace
from azureml.core.experiment import Experiment
from azureml.train.automl import AutoMLConfig
import logging

automl_config = AutoMLConfig(task='forecasting',
                             primary_metric='normalized_root_mean_squared_error',
                             experiment_timeout_minutes=15,
                             enable_early_stopping=True,
                             training_data=train_data,
                             label_column_name=label,
                             n_cross_validations=5,
                             enable_ensembling=False,
                             verbosity=logging.INFO,
                             **time_series_settings)

ws = Workspace.from_config()
experiment = Experiment(ws, "forecasting_example")
local_run = experiment.submit(automl_config, show_output=True)
best_run, fitted_model = local_run.get_output()
```

Подробные примеры кода для расширенной настройки прогнозирования см. в [записных книжках примера прогнозирования](https://github.com/Azure/MachineLearningNotebooks/tree/master/how-to-use-azureml/automated-machine-learning) , включая:

* [Обнаружение праздников и добавление признаков](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-bike-share/auto-ml-forecasting-bike-share.ipynb)
* [Перекрестная проверка последовательного происхождения](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand/auto-ml-forecasting-energy-demand.ipynb)
* [Настраиваемая задержка](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-bike-share/auto-ml-forecasting-bike-share.ipynb)
* [Пошаговые агрегатные функции окна](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand/auto-ml-forecasting-energy-demand.ipynb)
* [DNN](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-beer-remote/auto-ml-forecasting-beer-remote.ipynb)

### <a name="configure-a-dnn-enable-forecasting-experiment"></a>Настройка DNN включения эксперимента по прогнозированию

> [!NOTE]
> Поддержка DNN для прогнозирования в автоматизированных Машинное обучение доступна в предварительной версии и не поддерживается для локальных запусков.

Чтобы использовать DNN для прогнозирования, необходимо присвоить `enable_dnn` параметру в аутомлконфиг значение true. 

```python
automl_config = AutoMLConfig(task='forecasting',
                             enable_dnn=True,
                             ...
                             **time_series_settings)
```
Дополнительные сведения о [аутомлконфиг](#configure-and-run-experiment).

Кроме того, можно выбрать `Enable deep learning` параметр в студии.
![замещающий текст](./media/how-to-auto-train-forecast/enable_dnn.png)

В качестве целевого объекта вычислений мы рекомендуем использовать для вычислений с графическим процессором AML и по крайней мере два узла. Чтобы обеспечить достаточное время для завершения обучения DNN, рекомендуется установить для времени ожидания эксперимента минимум несколько часов.
Дополнительные сведения о средах вычислений AML и размерах виртуальных машин, включающих GPU, см. в документации по [вычислению AML](how-to-set-up-training-targets.md#amlcompute) и [размерам виртуальных машин, оптимизированных для GPU](https://docs.microsoft.com/azure/virtual-machines/linux/sizes-gpu).

Подробный пример кода, в котором используются DNN, см. в [записной книжке «прогнозирование рабочих](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-beer-remote/auto-ml-forecasting-beer-remote.ipynb) возможностей».

### <a name="target-rolling-window-aggregation"></a>Целевая Статистическая обработка окна
Часто наилучшие сведения, которые может иметь прогноз, — это последнее значение целевого объекта. Создание совокупной статистики целевого объекта может повысить точность прогнозов. Целевые агрегаты для скользящих окон позволяют добавлять последовательное агрегирование значений данных в виде функций. Чтобы включить перестройку целевых окон `target_rolling_window_size` , задайте требуемый размер окна целого числа. 

Пример этого можно увидеть при прогнозировании спроса на энергию. Вы можете добавить функцию пошагового окна за три дня, чтобы учитывать температурные изменения в пространствах накала. В приведенном ниже примере мы создали это окно размером 3, задав `target_rolling_window_size=3` в `AutoMLConfig` конструкторе. В таблице показано проектирование признаков, возникающих при применении статистической обработки окон. Столбцы для минимума, максимума и суммы создаются в скользящем окне трех на основе заданных параметров. Каждая строка содержит новую вычисляемую функцию. в случае отметка времени 8 сентября 2017 4:8:00 максимальное, минимальное и вычисленное значения вычисляются с использованием значений спроса для 8 сентября 2017 1:8:00-3:8:00. Это окно с тремя сдвигами и заполняет данные для оставшихся строк.

![замещающий текст](./media/how-to-auto-train-forecast/target-roll.svg)

Создание и использование этих дополнительных функций в качестве дополнительных контекстных данных способствует точности модели обучения.

Просмотрите пример кода Python с использованием [статистической функции целевого последовательного окна](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand/auto-ml-forecasting-energy-demand.ipynb).

### <a name="view-feature-engineering-summary"></a>Просмотреть сводные данные по проектированию функций

Для типов задач временных рядов в автоматизированном машинном обучении можно просмотреть сведения из процесса проектирования компонентов. В следующем коде показана каждая необработанная функция вместе со следующими атрибутами:

* Имя необработанного компонента
* Число сконструированных функций, сформированных за пределами этой необработанной функции
* Обнаружен тип
* Удален ли компонент
* Список преобразований компонентов для необработанных функций

```python
fitted_model.named_steps['timeseriestransformer'].get_featurization_summary()
```

## <a name="forecasting-with-best-model"></a>Прогнозирование с помощью лучшей модели

Используйте лучшую итерацию модели для прогнозирования значений для набора проверочных данных.

Функция `forecast()` должна использоваться вместо `predict()`, в этом случае будут разрешены спецификации при запуске прогнозов. В следующем примере сначала заменяются все значения в `y_pred` с помощью `NaN`. Источник прогноза будет находиться в конце обучающих данных в этом случае, как обычно при использовании `predict()`. Однако при замене только второй половины `y_pred` `NaN`функции функция будет оставлять числовые значения в первой половине неизменного, но прогнозировать `NaN` значения во второй половине. Функция возвращает прогнозируемые значения и выданные функции.

Можно также использовать `forecast_destination` параметр в `forecast()` функции для прогнозирования значений до указанной даты.

```python
label_query = test_labels.copy().astype(np.float)
label_query.fill(np.nan)
label_fcst, data_trans = fitted_pipeline.forecast(
    test_data, label_query, forecast_destination=pd.Timestamp(2019, 1, 8))
```

Вычислить корень СРЕДНЕКВАДРАТИЧНОЙ ПОГРЕШНОСТИ (среднее значение ошибки в корне `actual_labels` ) между фактическими значениями и прогнозируемыми значениями `predict_labels`в.

```python
from sklearn.metrics import mean_squared_error
from math import sqrt

rmse = sqrt(mean_squared_error(actual_labels, predict_labels))
rmse
```

Теперь, когда определена точность общей модели, наиболее реалистичным следующим шагом является использование модели для прогнозирования неизвестных будущих значений. Укажите набор данных в том же формате, что и тестовый `test_data` набор, но с будущими значениями DateTime, а результирующий набор прогнозов — прогнозируемые значения для каждого шага временного ряда. Предположим, что последние записи временных рядов в наборе данных были 12/31/2018. Чтобы прогнозировать спрос на следующий день (или столько периодов, сколько необходимо для прогнозирования, <= `max_horizon`), создайте одну запись временных рядов для каждого магазина 01/01/2019.

    day_datetime,store,week_of_year
    01/01/2019,A,1
    01/01/2019,A,1

Повторите необходимые шаги, чтобы загрузить эти будущие данные в таблицу данных, а затем выполните `best_run.predict(test_data)` для прогнозирования будущих значений.

> [!NOTE]
> Невозможно прогнозировать значения для количества периодов больше, `max_horizon`чем. Модель должна быть повторно обучена с большим горизонтом для прогнозирования будущих значений за пределами текущего горизонта.

## <a name="next-steps"></a>Дальнейшие шаги

* Следуйте указаниям [учебника](tutorial-auto-train-models.md) , чтобы научиться создавать эксперименты с помощью автоматизированного машинного обучения.
* Ознакомьтесь с справочной документацией по [пакету SDK машинное обучение Azure для Python](https://docs.microsoft.com/python/api/overview/azure/ml/intro?view=azure-ml-py) .
