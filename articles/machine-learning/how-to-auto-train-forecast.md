---
title: Автоматическое обучение прогнозной модели временных рядов
titleSuffix: Azure Machine Learning
description: Узнайте, как использовать Машинное обучение Azure для обучения модели регрессии прогнозирования временных рядов с помощью автоматизированного машинного обучения.
services: machine-learning
author: trevorbye
ms.author: trbye
ms.service: machine-learning
ms.subservice: core
ms.reviewer: trbye
ms.topic: how-to
ms.date: 03/09/2020
ms.openlocfilehash: 72b0a3074bfdfb6b6038f6c63eb01a7b33d45ea6
ms.sourcegitcommit: 845a55e6c391c79d2c1585ac1625ea7dc953ea89
ms.contentlocale: ru-RU
ms.lasthandoff: 07/05/2020
ms.locfileid: "85959132"
---
# <a name="auto-train-a-time-series-forecast-model"></a>Автоматическое обучение прогнозной модели временных рядов
[!INCLUDE [aml-applies-to-basic-enterprise-sku](../../includes/aml-applies-to-basic-enterprise-sku.md)]

Из этой статьи вы узнаете, как настроить и обучить модель регрессии прогнозирования временных рядов с помощью автоматизированного машинного обучения в [пакете SDK Машинного обучения Azure для Python](https://docs.microsoft.com/python/api/overview/azure/ml/?view=azure-ml-py). 

Сведения о возможностях уменьшения количества необходимого кода см. в [учебнике по прогнозированию спроса с помощью автоматизированного машинного обучения](tutorial-automated-ml-forecast.md), в котором приведен пример прогнозирования временных рядов с использованием автоматизированного машинного обучения в [Студии машинного обучения Azure](https://ml.azure.com/).

Настройка модели прогнозирования аналогична настройке стандартной модели регрессии с использованием автоматизированного машинного обучения, но для работы с данными временных рядов предусмотрены определенные параметры конфигурации и этапы предварительной обработки. 

Например, можно [настроить](#config), насколько далеким будет прогноз (горизонт прогнозирования), а также его запаздывание и многое другое. Автоматизированное машинное обучение изучает одну, но зачастую разветвленную модель для всех элементов в наборе данных и горизонтах прогнозирования. Поэтому доступно больше данных для оценки параметров модели, а также становится возможным обобщение невидимых рядов.

Из приведенных ниже примеров вы узнаете, как выполнять следующие операции:

* подготовка данных для моделирования временных рядов;
* настройка отдельных параметров временных рядов в объекте [`AutoMLConfig`](/python/api/azureml-train-automl-client/azureml.train.automl.automlconfig.automlconfig);
* выполнение прогнозов с данными временных рядов.

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2X1GW]

В отличие от классических методов использования временных рядов, при автоматизированном машинном обучении прошлые значения временных рядов "сводятся" для создания дополнительных измерений для регрессоров вместе с другими прогностическими факторами. Этот подход предусматривает использование нескольких контекстных переменных и их связи друг с другом во время обучения. Так как на прогноз могут повлиять несколько факторов, этот метод хорошо согласуется с реальными сценариями прогнозирования. Например, при прогнозировании продаж их результат определяется взаимосвязью совокупности факторов: тенденций в предыдущие периоды, валютного курса и цены. 

Признаки, извлеченные из данных для обучения, играют важную роль. Кроме того, при автоматизированном машинном обучении выполняются стандартные этапы предварительной обработки и создаются дополнительные признаки временных рядов для учета сезонных эффектов и обеспечения максимального уровня точности прогнозов.

## <a name="time-series-and-deep-learning-models"></a>Модели временных рядов и глубокого обучения

Глубокое обучение при автоматизированном машинном обучении позволяет прогнозировать данные одномерных и многомерных временных рядов.

Моделям глубокого обучения присущи три характерные особенности.
1. Они могут обучаться на произвольных сопоставлениях входных данных с выходными.
1. Они поддерживают несколько входов и выходов.
1. Они могут автоматически извлекать закономерности во входных данных, проявляющиеся на длинных последовательностях.

При наличии больших объемов данных модели глубокого обучения, например ForecastTCN от Майкрософт, могут улучшить показатели результирующей модели. Узнайте, как [настроить эксперимент для глубокого обучения](#configure-a-dnn-enable-forecasting-experiment).

Автоматизированное машинное обучение предоставляет пользователям собственные модели временных рядов и глубокого обучения в рамках системы рекомендаций. 

Модели| Описание | Преимущества
----|----|---
Prophet (предварительная версия)|Модель Prophet работает наилучшим образом с временными рядами, которым присущи сильные сезонные эффекты, при наличии данных за несколько прошедших сезонов. Чтобы использовать эту модель, установите ее локально с помощью `pip install fbprophet` . | Высокая точность и скорость, надежность при наличии выбросов, отсутствующих данных и существенных изменений во временных рядах.
Auto-ARIMA (предварительная версия)|Интегрированное скользящее среднее с авторегрессией (ARIMA) прекрасно подходит для стационарных данных. Это означает, что его статистические свойства, например среднее и вариация, постоянны для всего набора. Например, если вы подбрасываете монету, вероятность выпадения орла составляет 50 %, независимо от того, когда вы ее подбрасываете: сегодня, завтра или в следующем году.| Отлично подходит для одномерных рядов, так как для прогнозирования будущих значений используются прошлые.
ForecastTCN (предварительная версия)| ForecastTCN — это модель нейронной сети, предназначенная для решения самых ресурсоемких задач прогнозирования, отслеживающая нелинейные локальные и глобальные тенденции в данных, а также связи между временными рядами.|Возможность использования сложных тенденций в данных и простота масштабирования до самых больших наборов данных.

## <a name="prerequisites"></a>Предварительные требования

* Рабочая область машинного обучения Azure. Дополнительные сведения см. в [инструкциях по созданию рабочей области Машинного обучения Azure](how-to-manage-workspace.md).
* В этой статье предполагается, что вам известны основные принципы настройки эксперимента автоматизированного машинного обучения. Следуйте инструкциям [учебника](tutorial-auto-train-models.md) или [практического руководства](how-to-configure-auto-train.md), чтобы ознакомиться с основными конструктивными шаблонами экспериментов автоматизированного машинного обучения.

## <a name="preparing-data"></a>Подготовка данных

Самое важное различие между задачами типа "регрессия прогнозирования" и "регрессия" в автоматизированном машинном обучении заключается во включении в данные признака, представляющего допустимые временные ряды. Обычный временной ряд имеет четко определенную и постоянную периодичность, а также значение в каждой точке выборки в пределах непрерывного промежутка времени. Рассмотрим следующий моментальный снимок файла `sample.csv`.

```output
day_datetime,store,sales_quantity,week_of_year
9/3/2018,A,2000,36
9/3/2018,B,600,36
9/4/2018,A,2300,36
9/4/2018,B,550,36
9/5/2018,A,2100,36
9/5/2018,B,650,36
9/6/2018,A,2400,36
9/6/2018,B,700,36
9/7/2018,A,2450,36
9/7/2018,B,650,36
```

Этот набор данных представляет собой простой пример ежедневных данных о продажах для компании с двумя разными магазинами: A и B. Кроме того, в нем присутствует признак для `week_of_year`, который позволяет модели обнаруживать еженедельные колебания. Поле `day_datetime` представляет собой чистый временной ряд с периодичностью в один день, а поле `sales_quantity` является целевым столбцом для выполнения прогнозов. Прочтите данные в объект Dataframe в Pandas, а затем используйте функцию `to_datetime`, чтобы проверить, принадлежит ли временной ряд к типу `datetime`.

```python
import pandas as pd
data = pd.read_csv("sample.csv")
data["day_datetime"] = pd.to_datetime(data["day_datetime"])
```

В этом случае данные уже отсортированы по полю времени `day_datetime`. Однако для создания допустимого временного ряда при настройке эксперимента необходимо, чтобы требуемый столбец времени был отсортирован в порядке возрастания. Предположим, что данные содержат 1000 записей и для создания наборов данных для обучения и тестирования необходимо выполнить детерминированное разбиение данных. Укажите имя столбца меток и обозначьте его метку. В этом примере меткой будет `sales_quantity`. Затем отделите поле метки от `test_data`, чтобы сформировать набор `test_target`.

```python
train_data = data.iloc[:950]
test_data = data.iloc[-50:]

label =  "sales_quantity"
 
test_labels = test_data.pop(label).values
```

> [!NOTE]
> При обучении модели для прогнозирования будущих значений убедитесь, что все признаки, используемые при обучении, можно применять при выполнении прогнозов для предполагаемого горизонта. Например, при создании прогноза спроса включение признака текущей цены акций может существенно повысить точность обучения. Однако если вы намерены выполнить прогнозирование с дальним горизонтом, возможно, вам не удастся точно предсказать будущую стоимость акций, соответствующую будущим точкам временного ряда, и точность модели может снизиться.

<a name="config"></a>

## <a name="train-and-validation-data"></a>Обучение и проверка данных
Указать наборы данных для обучения и проверки можно непосредственно в конструкторе `AutoMLConfig`.

### <a name="rolling-origin-cross-validation"></a>Перекрестная проверка источников скользящего прогноза
Для согласованного по времени разбиения временных рядов при прогнозировании используется перекрестная проверка источников скользящего прогноза (ROCV). ROCV делит ряд на данные для обучения и проверки с помощью временной точки источника. Скользящий во времени источник создает свертки перекрестной проверки.  

![замещающий текст](./media/how-to-auto-train-forecast/ROCV.svg)

Эта стратегия сохранит целостность данных временных рядов и устранит риск их утечки. ROCV применяется для задач прогнозирования автоматически благодаря одновременной передаче данных для обучения и проверки и настройке числа сверток перекрестной проверки с помощью `n_cross_validations`. Узнайте больше о том, как автоматизированное машинное обучение применяет перекрестную проверку, чтобы [предотвратить возникновение лжевзаимосвязи в моделях](concept-manage-ml-pitfalls.md#prevent-over-fitting).

```python
automl_config = AutoMLConfig(task='forecasting',
                             n_cross_validations=3,
                             ...
                             **time_series_settings)
```
Узнайте больше о [AutoMLConfig](#configure-and-run-experiment).

## <a name="configure-and-run-experiment"></a>Настройка и запуск эксперимента

Для задач прогнозирования в автоматизированном машинном обучении используются этапы предварительной обработки и оценки, характерные для данных временных рядов. Предварительная обработка состоит из следующих этапов:

* определение периодичности выборки временных рядов (например, ежечасно, ежедневно, еженедельно) и создание новых записей для отсутствующих временных точек с целью обеспечения непрерывности ряда;
* аппроксимация отсутствующих значений в столбцах целевых значений (путем прямого заполнения) и признаков (по медиане столбцов);
* создание интервальных признаков для обеспечения фиксированных эффектов в разных рядах;
* создание временных признаков, которые помогут в изучении сезонных закономерностей;
* кодирование категориальных переменных в числовые величины.

Объект [`AutoMLConfig`](https://docs.microsoft.com/python/api/azureml-train-automl-client/azureml.train.automl.automlconfig.automlconfig?view=azure-ml-py) определяет параметры и данные, необходимые для задачи автоматизированного машинного обучения. Как и в случае с задачей регрессии, вы определяете стандартные параметры обучения, например тип задачи, число итераций, данные для обучения и число перекрестных проверок. Для задач прогнозирования необходимо задать дополнительные параметры, которые влияют на эксперимент. В следующей таблице объясняется каждый параметр и его использование.

| Имя&nbsp;параметра | Описание | Обязательно |
|-------|-------|-------|
|`time_column_name`|Используется, чтобы задать столбец даты и времени во входных данных, используемых для создания временного ряда и выявления его периодичности.|✓|
|`grain_column_names`|Имена, определяющие отдельные группы рядов во входных данных. Если интервал не определен, предполагается, что набор данных является одним временным рядом.||
|`max_horizon`|Определяет максимальный требуемый горизонт прогнозирования в единицах периодичности временного ряда. Единицы измерения определяются на основе интервала времени данных для обучения, например месяц или неделя, на который следует составить прогноз.|✓|
|`target_lags`|Число строк для запаздывания целевых значений на основе периодичности данных. Запаздывание представляется в виде списка или одного целого числа. Запаздывание следует использовать, когда связь между независимыми и зависимыми переменными не согласованна или не коррелирует по умолчанию. Например, при попытке прогнозировать спрос на товар спрос за любой месяц может зависеть от цены на определенные товары тремя месяцами ранее. В этом примере может потребоваться запаздывание (отрицательное смещение) целевых значений (спроса) на три месяца, чтобы модель была обучена по правильной связи.||
|`target_rolling_window_size`|Число *n* предыдущих периодов, которые следует использовать для получения прогнозируемых значений (меньше или равно размеру набора для обучения). Если этот параметр не задан, *n* принимается равным полному размеру набора для обучения. Этот параметр следует задавать в том случае, если при обучении модели нужно учитывать только определенный объем данных за предыдущие периоды.||
|`enable_dnn`|Активирует использование глубоких нейронных сетей для прогнозирования.||

Дополнительные сведения см. в [справочной документации](/python/api/azureml-train-automl-client/azureml.train.automl.automlconfig.automlconfig).

Создайте параметры временных рядов в качестве объекта словаря. Установите в качестве значения параметра `time_column_name` поле `day_datetime`. Определите параметр `grain_column_names`, чтобы обеспечить создание **двух отдельных групп временных рядов** для данных: по одному для магазинов A и B. Наконец, задайте для `max_horizon` значение 50 для прогнозирования по всему набору для тестирования. С помощью `target_rolling_window_size` задайте окно прогнозирования в 10 периодов и укажите одну задержку для целевых значений на два периода вперед с помощью параметра `target_lags`. Для параметров `max_horizon`, `target_rolling_window_size` и `target_lags` рекомендуется задать значение "auto", чтобы они были определены автоматически. В приведенном ниже примере для этих параметров использовалось значение "auto". 

```python
time_series_settings = {
    "time_column_name": "day_datetime",
    "grain_column_names": ["store"],
    "max_horizon": "auto",
    "target_lags": "auto",
    "target_rolling_window_size": "auto",
    "preprocess": True,
}
```

> [!NOTE]
> Этапы предварительной обработки автоматизированного машинного обучения (нормализация компонентов, обработка недостающих данных, преобразование текста в числовой формат и т. д.) становятся частью базовой модели. При использовании модели для прогнозирования эти этапы предварительной обработки, которые выполнялись во время обучения, автоматически выполняются для входных данных.

Определив `grain_column_names` в приведенном выше фрагменте кода, AutoML создаст две отдельные группы временных рядов (многомерный временной ряд). Если интервал не определен, AutoML предполагает, что набор данных является одиночным временным рядом. Дополнительные сведения об одиночном временном ряде см. на странице [energy_demand_notebook](https://github.com/Azure/MachineLearningNotebooks/tree/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand).

Теперь создайте стандартный объект `AutoMLConfig`, указав тип задачи `forecasting`, и отправьте эксперимент. После завершения моделирования извлеките наиболее подходящую итерацию выполнения.

```python
from azureml.core.workspace import Workspace
from azureml.core.experiment import Experiment
from azureml.train.automl import AutoMLConfig
import logging

automl_config = AutoMLConfig(task='forecasting',
                             primary_metric='normalized_root_mean_squared_error',
                             experiment_timeout_minutes=15,
                             enable_early_stopping=True,
                             training_data=train_data,
                             label_column_name=label,
                             n_cross_validations=5,
                             enable_ensembling=False,
                             verbosity=logging.INFO,
                             **time_series_settings)

ws = Workspace.from_config()
experiment = Experiment(ws, "forecasting_example")
local_run = experiment.submit(automl_config, show_output=True)
best_run, fitted_model = local_run.get_output()
```

Подробные примеры кода для расширенной настройки прогнозирования см. в [записных книжках примеров прогнозирования](https://github.com/Azure/MachineLearningNotebooks/tree/master/how-to-use-azureml/automated-machine-learning), в том числе:

* [контроль сплошности и конструирование признаков](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-bike-share/auto-ml-forecasting-bike-share.ipynb);
* [перекрестная проверка источников скользящего прогноза](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand/auto-ml-forecasting-energy-demand.ipynb);
* [настраиваемые задержки](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-bike-share/auto-ml-forecasting-bike-share.ipynb);
* [признаки для скользящих агрегатов значений окна](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand/auto-ml-forecasting-energy-demand.ipynb);
* [глубокая нейронная сеть](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-beer-remote/auto-ml-forecasting-beer-remote.ipynb).

### <a name="configure-a-dnn-enable-forecasting-experiment"></a>Настройка эксперимента прогнозирования с поддержкой глубокой нейронной сети

> [!NOTE]
> Поддержка глубокой нейронной сети для прогнозирования в автоматизированном машинном обучении доступна в предварительной версии и не поддерживается для локальных запусков.

Чтобы использовать глубокие нейронные сети для прогнозирования, необходимо присвоить параметру `enable_dnn` в AutoMLConfig значение true. 

```python
automl_config = AutoMLConfig(task='forecasting',
                             enable_dnn=True,
                             ...
                             **time_series_settings)
```
Узнайте больше о [AutoMLConfig](#configure-and-run-experiment).

Кроме того, можно выбрать параметр `Enable deep learning` в студии.
![замещающий текст](./media/how-to-auto-train-forecast/enable_dnn.png)

В качестве целевого объекта вычислений мы рекомендуем использовать вычислительный кластер AML с номером SKU GPU и по крайней мере двумя узлами. Чтобы обеспечить достаточное время для завершения обучения глубокой нейронной сети, рекомендуется установить время ожидания эксперимента равным как минимум нескольким часам.
Дополнительные сведения о вычислительной среде AML и размерах виртуальных машин с GPU см. в [документации по вычислительной среде AML](how-to-set-up-training-targets.md#amlcompute) и статье [Размеры виртуальных машин, оптимизированных для GPU](https://docs.microsoft.com/azure/virtual-machines/linux/sizes-gpu).

Подробный пример кода, использующий глубокую нейронную сеть, см. в [записной книжке прогнозирования производства напитков](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-beer-remote/auto-ml-forecasting-beer-remote.ipynb).

### <a name="target-rolling-window-aggregation"></a>Целевой агрегат со скользящим окном
Часто наилучшей информацией для прогнозиста оказывается последнее значение целевого объекта. Создание кумулятивной статистики целевого объекта может повысить точность прогнозов. Целевой агрегат со скользящим окном позволяет добавлять скользящие агрегаты значений данных в качестве признаков. Чтобы включить скользящие окна для целевого объекта, задайте для `target_rolling_window_size` нужный размер окна (целое число). 

Пример использования такого подхода можно увидеть при прогнозировании спроса на электроэнергию. Вы можете добавить в качестве признака скользящее трехдневное окно, чтобы учитывать температурные изменения в отапливаемом помещении. В примере ниже мы создали такое окно размером 3, установив `target_rolling_window_size=3` в конструкторе `AutoMLConfig`. В таблице демонстрируется конструирование признаков, которое выполняется при применении агрегата окон. Значения в столбцах для минимума, максимума и суммы создаются по скользящему окну размером три на основе заданных параметров. Каждая строка содержит новый вычисляемый признак. В случае отметки времени 8 сентября 2017 г. 4:00 значение максимума, минимума и суммы вычисляют на основе значений спроса 8 сентября 2017 г. в период с 1:00 по 3:00. Это окно размером три смещается во времени для заполнения данными оставшихся строк.

![замещающий текст](./media/how-to-auto-train-forecast/target-roll.svg)

Создание и использование этих дополнительных признаков в качестве дополнительных контекстных данных способствует точности модели обучения.

Просмотрите пример кода Python, в котором [в качестве признака используется целевой агрегат со скользящим окном](https://github.com/Azure/MachineLearningNotebooks/blob/master/how-to-use-azureml/automated-machine-learning/forecasting-energy-demand/auto-ml-forecasting-energy-demand.ipynb).

### <a name="view-feature-engineering-summary"></a>Просмотр сводки по конструированию признаков

Для задач типа "временные ряды" в автоматизированном машинном обучении сведения можно просмотреть из процесса конструирования признаков. В следующем коде показан каждый необработанный признак вместе со следующими атрибутами:

* имя необработанного признака;
* число сконструированных признаков, сформированных из этого необработанного признака;
* обнаруженный тип;
* сведения о том, сброшен ли признак;
* список преобразований признаков для необработанного признака.

```python
fitted_model.named_steps['timeseriestransformer'].get_featurization_summary()
```

## <a name="forecasting-with-best-model"></a>Прогнозирование с использованием лучшей модели

Используйте лучшую итерацию модели для прогнозирования значений по набору данных для тестирования.

Вместо `predict()` должна использоваться функция `forecast()`. Это позволит определить, когда должны начинаться прогнозы. В следующем примере сначала все значения в `y_pred` заменяются на `NaN`. В этом случае источник прогноза будет находиться в конце данных для обучения, как обычно при использовании `predict()`. Однако если заменить только вторую половину `y_pred` на `NaN`, функция оставит числовые значения в первой половине неизменными и будет прогнозировать значения `NaN` во второй половине. Функция возвращает как прогнозируемые значения, так и выровненные признаки.

Для прогнозирования значений до указанной даты в функции `forecast()` можно также использовать параметр `forecast_destination`.

```python
label_query = test_labels.copy().astype(np.float)
label_query.fill(np.nan)
label_fcst, data_trans = fitted_pipeline.forecast(
    test_data, label_query, forecast_destination=pd.Timestamp(2019, 1, 8))
```

Вычислите среднеквадратическую погрешность между фактическими (`actual_labels`) и прогнозируемыми (`predict_labels`) значениями.

```python
from sklearn.metrics import mean_squared_error
from math import sqrt

rmse = sqrt(mean_squared_error(actual_labels, predict_labels))
rmse
```

Теперь, когда определена точность общей модели, наиболее реалистичным следующим шагом будет использование модели для прогнозирования неизвестных будущих значений. Укажите набор данных в том же формате, что и набор для тестирования `test_data`, но с будущими значениями даты и времени. Результирующим набором прогнозов будут прогнозируемые значения для каждого шага временного ряда. Предположим, что последние записи временных рядов в наборе данных датированы 31.12.2018. Чтобы спрогнозировать спрос на следующий день (или столько периодов, сколько необходимо для прогнозирования, но не более `max_horizon`), создайте одну запись одиночного временного ряда для каждого магазина на 01.01.2019.

```output
day_datetime,store,week_of_year
01/01/2019,A,1
01/01/2019,A,1
```

Повторите необходимые шаги, чтобы загрузить эти будущие данные в объект DataFrame, а затем запустите `best_run.predict(test_data)` для прогнозирования будущих значений.

> [!NOTE]
> Если количество периодов превышает `max_horizon`, спрогнозировать значения невозможно. Для прогнозирования будущих значений за пределами текущего горизонта необходимо повторно обучить модель с большим горизонтом.

## <a name="next-steps"></a>Дальнейшие действия

* Следуйте инструкциям в [учебнике](tutorial-auto-train-models.md), чтобы научиться создавать эксперименты с помощью автоматизированного машинного обучения.
* Просмотрите справочную документацию по [пакету SDK Машинного обучения Azure для Python](https://docs.microsoft.com/python/api/overview/azure/ml/intro?view=azure-ml-py).
