---
title: Защита сред обучения с помощью виртуальных сетей
titleSuffix: Azure Machine Learning
description: Используйте изолированную виртуальную сеть Azure для защиты среды обучения Машинное обучение Azure.
services: machine-learning
ms.service: machine-learning
ms.subservice: core
ms.topic: how-to
ms.reviewer: larryfr
ms.author: aashishb
author: aashishb
ms.date: 07/16/2020
ms.custom: contperfq4, tracking-python
ms.openlocfilehash: 5a71476db6f57841a0057de5b8c95f07ef5d90ad
ms.sourcegitcommit: 80b9c8ef63cc75b226db5513ad81368b8ab28a28
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2020
ms.locfileid: "90603090"
---
# <a name="secure-an-azure-machine-learning-training-environment-with-virtual-networks"></a>Защита Машинное обучение Azureной среды обучения с помощью виртуальных сетей
[!INCLUDE [applies-to-skus](../../includes/aml-applies-to-basic-enterprise-sku.md)]

Из этой статьи вы узнаете, как защитить среды обучения с помощью виртуальной сети в Машинное обучение Azure.

Эта статья является третьей частью серии из пяти частей, которая поможет вам в обеспечении безопасности Машинное обучение Azure рабочего процесса. Мы настоятельно рекомендуем прочесть первую [часть: обзор виртуальной сети](how-to-network-security-overview.md) , чтобы понять общую архитектуру. 

См. Другие статьи в этой серии:

[1. Общие сведения о виртуальной сети](how-to-network-security-overview.md)  >  [Обеспечьте безопасность рабочей области](how-to-secure-workspace-vnet.md)  >  **3. Обеспечьте безопасность среды обучения**  >  [4. Обеспечьте безопасность окружения](how-to-secure-inferencing-vnet.md)   >  [5. Включить функциональные возможности студии](how-to-enable-studio-virtual-network.md)

В этой статье вы узнаете, как защитить следующие обучающие ресурсы для обучения в виртуальной сети.
> [!div class="checklist"]
> - Вычислительный кластер Машинного обучения Azure
> - Вычислительная операция Машинного обучения Azure
> - Azure Databricks
> - Виртуальная машина
> - Кластер HDInsight

## <a name="prerequisites"></a>предварительные требования

+ Ознакомьтесь со статьей [Обзор сетевой безопасности](how-to-network-security-overview.md) , чтобы ознакомиться с общими сценариями виртуальной сети и общей архитектурой виртуальной сети.

+ Существующая виртуальная сеть и подсеть для использования с ресурсами вычислений.

+ Чтобы развернуть ресурсы в виртуальной сети или подсети, учетная запись пользователя должна иметь разрешения на доступ к следующим действиям в элементах управления доступом на основе ролей (RBAC) Azure.

    - "Microsoft. Network/virtualNetworks/соединение/действие" для ресурса виртуальной сети.
    - "Microsoft. Network/virtualNetworks/подсеть/соединение/действие" в ресурсе подсети.

    Дополнительные сведения о сетях RBAC с сетью см. в разделе [встроенные сетевые роли](/azure/role-based-access-control/built-in-roles#networking) .


## <a name="compute-clusters--instances"></a><a name="compute-instance"></a>Вычислительные кластеры и экземпляры 

Чтобы использовать [управляемый целевой объект вычислений __Машинного обучения Azure__](concept-compute-target.md#azure-machine-learning-compute-managed) или [вычислительный экземпляр  __Машинного обучения Azure__](concept-compute-instance.md) в виртуальной сети, должны выполняться следующие требования к сети.

> [!div class="checklist"]
> * Виртуальная сеть должна размещаться в той же подписке и том же регионе, что и рабочая область Машинного обучения Azure.
> * Указанная для экземпляра или кластера вычислительных ресурсов подсеть должна иметь достаточное (то есть соответствующее количеству виртуальных машин, являющихся целевыми объектами) количество неназначенных IP-адресов. Если в подсети нет достаточного количества свободных IP-адресов, вычислительный кластер будет выделен частично.
> * Проверьте, существуют ли политики безопасности или блокировки в подписке или группе ресурсов виртуальной сети, которые ограничивают права на управление виртуальной сетью. Если вы планируете защитить виртуальную сеть, применив ограничение трафика, оставьте некоторые порты открытыми для вычислительной службы. Дополнительные сведения см. в разделе [Требуемые порты](#mlcports).
> * Если вы собираетесь разместить в одной виртуальной сети несколько экземпляров или кластеров вычислительных ресурсов, может потребоваться увеличить квоту для одного или нескольких ресурсов.
> * Если учетные записи хранения Azure для рабочей области также предусмотрены в виртуальной сети, они должны находиться в той же виртуальной сети, что и экземпляр или кластер вычислительных ресурсов Машинного обучения Azure. 
> * Для работы функциональности Jupyter экземпляра вычислительных ресурсов необходимо убедиться, что связь через веб-сокет не отключена.

> [!TIP]
> Экземпляр или кластер вычислительных ресурсов машинного обучения автоматически выделяет дополнительные сетевые ресурсы __в группе ресурсов, которая содержит виртуальную сеть__. Для каждого экземпляра или кластера вычислительных ресурсов служба выделяет следующие ресурсы:
> 
> * Одна группа безопасности сети
> * Один общедоступный IP-адрес
> * Один балансировщик нагрузки
> 
> В случае с кластерами эти ресурсы удаляются (и создаются повторно) всякий раз, когда кластер масштабируется до 0 узлов. Однако в случае с экземплярами ресурсы удерживаются до тех пор, пока экземпляр не будет полностью удален (при остановке экземпляра ресурсы не удаляются). 
> Эти ресурсы ограничены [квотами ресурсов](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits) в подписке.


### <a name="required-ports"></a><a id="mlcports"></a> Требуемые порты

Если вы планируете защитить виртуальную сеть путем запрета сетевого трафика из общедоступного Интернета в Интернет, необходимо разрешить входящие подключения из пакетной службы Azure.

Пакетная служба добавляет группы безопасности сети на уровне сетевых интерфейсов, подключенных к виртуальным машинам. Эти группы безопасности сети автоматически настраивают правила для входящего и исходящего трафика, чтобы разрешить следующий трафик:

- Входящий TCP-трафик на портах 29876 и 29877 с __тега службы__ __BatchNodeManagement__.

    ![Правило входящего трафика, использующее тег службы BatchNodeManagement](./media/how-to-enable-virtual-network/batchnodemanagement-service-tag.png)

- (Необязательно.) Входящий трафик по протоколу TCP через порт 22, чтобы разрешить удаленный доступ. Используйте этот порт только в том случае, если вы хотите подключиться по протоколу SSH на общедоступном IP-адресе.

- Исходящий трафик в виртуальную сеть на любом порту.

- Исходящий трафик в Интернет на любом порту.

- Для вычислительного экземпляра входящий TCP-трафик через порт 44224 из __тега службы__ __AzureMachineLearning__.

> [!IMPORTANT]
> Соблюдайте осторожность, если вы изменяете или добавляете правила для входящего и исходящего трафика в группах безопасности сети, настроенных для пакетной службы. Если группа безопасности сети заблокирует связь с вычислительными узлами, вычислительная служба установит для этих вычислительных узлов состояние "Непригодно".
>
> Вам не нужно указывать группы безопасности сети на уровне подсети, так как пакетная служба Azure настраивает собственные группы. Однако если подсеть, содержащая Машинное обучение Azure COMPUTE, имеет связанный группы безопасности сети или брандмауэр, необходимо также разрешить указанный выше трафик.

На следующих рисунках показана настройка правила группы безопасности сети на портале Azure.

:::image type="content" source="./media/how-to-enable-virtual-network/amlcompute-virtual-network-inbound.png" alt-text="Правила NSG для входящего трафика вычислительной среды машинного обучения" border="true":::



![Правила NSG для входящего трафика для Вычислительная среда Машинного обучения](./media/how-to-enable-virtual-network/experimentation-virtual-network-outbound.png)

### <a name="limit-outbound-connectivity-from-the-virtual-network"></a><a id="limiting-outbound-from-vnet"></a> Ограничение исходящих подключений из виртуальной сети

Если вы не хотите использовать правила для исходящего трафика по умолчанию и хотите ограничить исходящий доступ в виртуальной сети, выполните следующие действия.

- Запретите исходящие интернет-подключения с помощью правил NSG.

- Ограничьте исходящий трафик для __экземпляра вычислительных ресурсов__ или __кластера вычислительных ресурсов__ следующими элементами.
   - Служба хранилища Azure, с помощью __тега службы__ __Storage.RegionName__, где `{RegionName}` — имя региона Azure.
   - Реестр контейнеров Azure, с помощью __тега службы__ __AzureContainerRegistry.RegionName__, где `{RegionName}` — имя региона Azure.
   - Машинное обучение Azure, с помощью __тега службы__ __AzureMachineLearning__
   - Azure Resource Manager, с помощью __тега службы__ __AzureResourceManager__
   - Azure Active Directory, с помощью __тега службы__ __AzureActiveDirectory__

На следующем рисунке показана настройка правила группы безопасности сети на портале Azure.

[![Правила NSG для исходящего трафика вычислительной среды машинного обучения](./media/how-to-enable-virtual-network/limited-outbound-nsg-exp.png)](./media/how-to-enable-virtual-network/limited-outbound-nsg-exp.png#lightbox)

> [!NOTE]
> Если вы планируете использовать образы DOCKER по умолчанию, предоставляемые корпорацией Майкрософт, и включите управляемые пользователем зависимости, необходимо также использовать следующие __теги служб__:
>
> * __MicrosoftContainerRegistry__
> * __AzureFrontDoor.FirstParty__
>
> Эта конфигурация необходима при наличии кода, аналогичного приведенным ниже фрагментам, в рамках сценариев обучения.
>
> __Обучение работе с RunConfig__
> ```python
> # create a new runconfig object
> run_config = RunConfiguration()
> 
> # configure Docker 
> run_config.environment.docker.enabled = True
> # For GPU, use DEFAULT_GPU_IMAGE
> run_config.environment.docker.base_image = DEFAULT_CPU_IMAGE 
> run_config.environment.python.user_managed_dependencies = True
> ```
>
> __Обучение работе с оценщиком__
> ```python
> est = Estimator(source_directory='.',
>                 script_params=script_params,
>                 compute_target='local',
>                 entry_script='dummy_train.py',
>                 user_managed=True)
> run = exp.submit(est)
> ```

### <a name="forced-tunneling"></a>Принудительное туннелирование

Если вы используете [принудительное туннелирование](/azure/vpn-gateway/vpn-gateway-forced-tunneling-rm) с машинное обучение Azureным вычислением, необходимо разрешить обмен данными с общедоступным Интернетом из подсети, содержащей ресурс вычислений. Это взаимодействие используется для планирования задач и доступа к службе хранилища Azure.

Это можно сделать двумя способами:

* Используйте [NAT виртуальной сети](../virtual-network/nat-overview.md). Шлюз NAT обеспечивает исходящее подключение к Интернету для одной или нескольких подсетей в виртуальной сети. Дополнительные сведения см. в статье [проектирование виртуальных сетей с помощью ресурсов шлюза NAT](../virtual-network/nat-gateway-resource.md).

* Добавьте [определяемые пользователем маршруты (определяемые пользователем маршруты)](https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview) в подсеть, которая содержит ресурс вычислений. Установите UDR для каждого IP-адреса, используемого пакетной службой Azure в регионе, где находятся ваши ресурсы. UDR позволяют пакетной службе взаимодействовать с вычислительными узлами с целью планирования задач. Также добавьте IP-адрес для службы Машинного обучения Azure, где существуют ресурсы, так как это необходимо для доступа к вычислительным экземплярам. Чтобы получить список IP-адресов пакетной службы и службы Машинного обучения Azure, используйте один из следующих методов.

    * Скачайте [диапазоны IP-адресов Azure и теги службы](https://www.microsoft.com/download/details.aspx?id=56519) и найдите в файле `BatchNodeManagement.<region>` и `AzureMachineLearning.<region>`, где `<region>` — ваш регион Azure.

    * Для загрузки информации используйте [интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest). В следующем примере скачиваются сведения об IP-адресе и фильтруются сведения для региона Восток США 2.

        ```azurecli-interactive
        az network list-service-tags -l "East US 2" --query "values[?starts_with(id, 'Batch')] | [?properties.region=='eastus2']"
        az network list-service-tags -l "East US 2" --query "values[?starts_with(id, 'AzureMachineLearning')] | [?properties.region=='eastus2']"
        ```

        > [!TIP]
        > Если вы используете регионы US-Виргиния, US-Китая или Китае-Восток-2, эти команды не возвращают никаких IP-адресов. Вместо этого воспользуйтесь одной из следующих ссылок, чтобы скачать список IP-адресов:
        >
        > * [Диапазоны IP-адресов и теги службы Azure для Azure для государственных организаций](https://www.microsoft.com/download/details.aspx?id=57063)
        > * [Диапазоны IP-адресов и теги службы Azure для Китая в Azure](https://www.microsoft.com//download/details.aspx?id=57062)
    
    При добавлении определяемого пользователем маршрута укажите маршрут для каждого связанного префикса IP-адреса пакетной службы, а также задайте для параметра__Тип следующего прыжка__ значение __Интернет__. На следующем изображении показан пример этого UDR на портале Azure.

    ![Пример UDR для префикса адреса](./media/how-to-enable-virtual-network/user-defined-route.png)

    > [!IMPORTANT]
    > С течением времени IP-адреса могут меняться.

    В дополнение к любым определяемые пользователем маршруты, которые вы определяете, исходящий трафик в службу хранилища Azure должен быть разрешен через Ваше локальное сетевое устройство. В частности, URL-адреса для этого трафика относятся к следующим формам: `<account>.table.core.windows.net` , `<account>.queue.core.windows.net` и `<account>.blob.core.windows.net` . 

    См. дополнительные сведения в разделе [Создание пула пакетной службы Azure в виртуальной сети](../batch/batch-virtual-network.md#user-defined-routes-for-forced-tunneling).


### <a name="create-a-compute-cluster-in-a-virtual-network"></a>Создание кластера вычислительных ресурсов в виртуальной сети

Чтобы создать кластер вычислительных ресурсов машинного обучения, выполните следующие действия.

1. Войдите в [студию Машинного обучения Azure](https://ml.azure.com/), выберите свою подписку и рабочую область.

1. Слева выберите пункт __Вычисление__.

1. Выберите __обучающие кластеры__ в центре, а затем — __+__ .

1. В диалоговом окне __Новый обучающий кластер__ разверните раздел __Дополнительные параметры__.

1. Чтобы настроить этот вычислительный ресурс для использования виртуальной сети, выполните следующие действия в разделе __Настройка виртуальной сети__.

    1. В раскрывающемся списке __Группа ресурсов__ выберите группу ресурсов, которая содержит виртуальную сеть.
    1. В раскрывающемся списке __Виртуальная сеть__выберите виртуальную сеть, которая содержит подсеть.
    1. В раскрывающемся списке __Подсеть__ выберите подсеть для использования.

   ![Параметры виртуальной сети для вычислительной среды машинного обучения](./media/how-to-enable-virtual-network/amlcompute-virtual-network-screen.png)

Вы также можете создать кластер Вычислительной среды Машинного обучения с помощью пакета SDK для Машинного обучения Azure. Следующий код создает новый кластер Вычислительной среды Машинного обучения в подсети `default`, размещенной в виртуальной сети с именем `mynetwork`:

```python
from azureml.core.compute import ComputeTarget, AmlCompute
from azureml.core.compute_target import ComputeTargetException

# The Azure virtual network name, subnet, and resource group
vnet_name = 'mynetwork'
subnet_name = 'default'
vnet_resourcegroup_name = 'mygroup'

# Choose a name for your CPU cluster
cpu_cluster_name = "cpucluster"

# Verify that cluster does not exist already
try:
    cpu_cluster = ComputeTarget(workspace=ws, name=cpu_cluster_name)
    print("Found existing cpucluster")
except ComputeTargetException:
    print("Creating new cpucluster")

    # Specify the configuration for the new cluster
    compute_config = AmlCompute.provisioning_configuration(vm_size="STANDARD_D2_V2",
                                                           min_nodes=0,
                                                           max_nodes=4,
                                                           vnet_resourcegroup_name=vnet_resourcegroup_name,
                                                           vnet_name=vnet_name,
                                                           subnet_name=subnet_name)

    # Create the cluster with the specified name and configuration
    cpu_cluster = ComputeTarget.create(ws, cpu_cluster_name, compute_config)

    # Wait for the cluster to be completed, show the output log
    cpu_cluster.wait_for_completion(show_output=True)
```

Когда завершится процесс создания, переходите в своем эксперименте к обучению модели с помощью кластера. Дополнительные сведения вы найдете в статье [Настройка целевых объектов вычислений для обучения моделей](how-to-set-up-training-targets.md).

[!INCLUDE [low-pri-note](../../includes/machine-learning-low-pri-vm.md)]

### <a name="access-data-in-a-compute-instance-notebook"></a>Доступ к данным в записной книжке экземпляра COMPUTE

Если вы используете записные книжки в экземпляре Azure COMPUTE, необходимо убедиться, что ваша Записная книжка работает на вычислительном ресурсе, который находится за той же виртуальной сетью и подсетью, что и ваши данные. 

Необходимо настроить экземпляр вычислений в той же виртуальной сети во время создания в разделе **Дополнительные параметры**  >  **Настройка виртуальной сети**. Нельзя добавить существующий вычислительный экземпляр в виртуальную сеть.

## <a name="azure-databricks"></a>Azure Databricks

Чтобы использовать Azure Databricks в виртуальной сети с рабочей областью, должны выполняться следующие требования.

> [!div class="checklist"]
> * Виртуальная сеть должна размещаться в той же подписке и том же регионе, что и рабочая область Машинного обучения Azure.
> * Если учетные записи хранения Azure для рабочей области также предусмотрены в виртуальной сети, они должны находиться в той же виртуальной сети, что и кластер Azure Databricks.
> * В дополнение к подсетям __databricks-private__ и __databricks-public__, используемым Azure Databricks, необходимо также создать подсеть __по умолчанию__ для виртуальной сети.

Конкретные сведения об использовании Azure Databricks с виртуальной сетью см. в разделе [Развертывание Azure Databricks в виртуальной сети Azure](https://docs.azuredatabricks.net/administration-guide/cloud-configurations/azure/vnet-inject.html).

<a id="vmorhdi"></a>

## <a name="virtual-machine-or-hdinsight-cluster"></a>Виртуальная машина или кластер HDInsight

> [!IMPORTANT]
> Машинное обучение Azure поддерживает только виртуальные машины под управлением Ubuntu.

В этом разделе вы узнаете, как использовать виртуальную машину или кластер Azure HDInsight в виртуальной сети с рабочей областью.

### <a name="create-the-vm-or-hdinsight-cluster"></a>Создание виртуальной машины или кластера HDInsight

Создайте виртуальную машину или кластер HDInsight с помощью портала Azure или Azure CLI, а затем поместите кластер в виртуальную сеть Azure. Дополнительные сведения см. в следующих статьях:
* [Создание и администрирование виртуальных сетей Azure для виртуальных машин Linux](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-virtual-network)

* [Расширение возможностей HDInsight с помощью виртуальной сети Azure](https://docs.microsoft.com/azure/hdinsight/hdinsight-extend-hadoop-virtual-network).

### <a name="configure-network-ports"></a>Настройка сетевых портов 

Разрешить Машинное обучение Azure взаимодействовать с портом SSH на виртуальной машине или в кластере, настроить запись источника для группы безопасности сети. Обычно для SSH используется порт 22. Чтобы разрешить трафик от этого источника, выполните следующие действия.

1. В раскрывающемся списке __Источник__ выберите значение __Тег службы__.

1. В раскрывающемся списке __Тег исходной службы__ выберите __AzureMachineLearning__.

    ![Правила для входящего трафика, настроенные для экспериментирования на виртуальной машине или в кластере HDInsight в виртуальной сети](./media/how-to-enable-virtual-network/experimentation-virtual-network-inbound.png)

1. В раскрывающемся списке __Исходный диапазон портов__ выберите __*__ .

1. В раскрывающемся списке __Назначение__ выберите __Любое__.

1. В раскрывающемся списке __Диапазоны портов назначения__ выберите __22__.

1. Для параметра __Протокол__ выберите значение __Любой__.

1. В поле __Действие__ выберите __Разрешить__.

Используйте правила входящего трафика по умолчанию для группы безопасности сети. Дополнительные сведения см. в описании стандартных правил безопасности в статье [о группах безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview#default-security-rules).

Если вы не хотите использовать правила для исходящего трафика по умолчанию и хотите ограничить исходящий доступ в виртуальной сети, следуйте инструкциям в разделе [Ограничение исходящих подключений из виртуальной сети](#limiting-outbound-from-vnet).

### <a name="attach-the-vm-or-hdinsight-cluster"></a>Подключение виртуальной машины или кластера HDInsight

Подключите виртуальную машину или кластер HDInsight к рабочей области Машинного обучения Azure. Дополнительные сведения вы найдете в статье [Настройка целевых объектов вычислений для обучения моделей](how-to-set-up-training-targets.md).

## <a name="next-steps"></a>Дальнейшие действия

Эта статья является третьей частью серии виртуальных сетей из четырех частей. Ознакомьтесь с остальными статьями, чтобы узнать, как защитить виртуальную сеть.

* [Часть 1. Обзор виртуальной сети](how-to-network-security-overview.md)
* [Часть 2. Защита ресурсов рабочей области](how-to-secure-workspace-vnet.md)
* [Часть 4. Защита окружения](how-to-secure-inferencing-vnet.md)
* [Часть 5. Включение функций Studio](how-to-enable-studio-virtual-network.md)