---
title: Миграция на основе агентов в миграции серверов Azure migrate
description: Предоставляет обзор агентской миграции VMware VM в Azure Migrate.
author: rayne-wiselman
ms.service: azure-migrate
ms.topic: conceptual
ms.date: 02/17/2020
ms.author: raynew
ms.openlocfilehash: d345d707cbf58f48466c3bd830d93250d13397c6
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77425869"
---
# <a name="agent-based-migration-architecture"></a>Архитектура миграции на основе агента

В этой статье приводится обзор архитектуры и процессов, используемых для репликации VMware на основе агентов с помощью инструмента [Azure Migrate: Server Migration.](migrate-services-overview.md#azure-migrate-server-assessment-tool)

Используя Azure Migrate: Миграция серверов, вы можете воспроизвести VMware с несколькими опциями:

- Мигрируйте вмизацию с использованием репликации на основе агента, как описано в этой статье.
- Имитируйте VM VMw с помощью репликации без агента. Это мигрирует VMs без необходимости устанавливать что-либо на них.

Подробнее о [выборе и сравнении](server-migrate-overview.md) методов миграции для VMware VMs. 


## <a name="agent-based-migration"></a>Миграция на основе агентов

Миграция на основе агента используется для переноса на специальных VM VMwи и физических серверов в Azure. Он также может использоваться для переноса других локализованных виртуализированных серверов, а также частных и общедоступных облачных виртуальных технологий, включая экземпляры AWS и GCP VMs. Миграция на основе агентов в Azure Migrate использует некоторые функции бэкэнда из службы [восстановления сайта Azure.](../site-recovery/site-recovery-overview.md)


## <a name="architectural-components"></a>Компоненты архитектуры

Диаграмма иллюстрирует компоненты, участвующие в миграции на основе агентов.

![Architecture](./media/agent-based-replication-architecture/architecture.png)

В таблице кратко излагаются компоненты, используемые для миграции на основе агента.

**Компонент** | **Подробно** | **Установки**
--- | --- | ---
**Репликационный прибор** | Прибор репликации (сервер конфигурации/процесс) — это автомат, который выступает в качестве моста между предварительной средой и миграцией серверов. Прибор обнаруживает инвентаризацию на месте машины, так что миграция сервера может организовать репликацию и миграцию. Прибор имеет два компонента:<br/><br/> **Конфигурация сервера**: Подключается к миграции сервера и репликации координат.<br/> **Процесс сервера**: Ручки репликации данных. Сервер процесса получает машинные данные, сжимает и шифрует их и отправляет в Azure. В Azure «Миграция серверов» записывает данные на управляемые диски. | По умолчанию сервер процесса устанавливается вместе с сервером конфигурации на прибор репликации.
**Мобильный сервис** | Служба мобильности — это агент, установленный на каждой машине, которую вы хотите воспроизвести и перенести. Он отправляет данные репликации с машины на сервер процесса. | Файлы установки для различных версий службы Mobility расположены на приборе репликации. Вы загружаете и устанавливаете необходимый вам агент в соответствии с операционной системой и версией машины, которую вы хотите воспроизвести.

## <a name="mobility-service-installation"></a>Установка службы Mobility Service

Вы можете запустить службу Mobility Service одним из следующих способов:

- **Нажмите установку**: Служба мобильности устанавливается сервером процесса, когда вы включите защиту для машины. 
- **Установите вручную:** Вы можете установить службу мобильности вручную на каждой машине через uI или командный запрос.

Служба мобильности общается с прибором репликации и реплицированными машинами. Если на реплицирующем приборе репликации, серверах или машинах можно исключить следующие папки:


- C:\Program Files\Microsoft Azure Recovery Services Agent
- C:\ProgramData\ASR.
- C:\ProgramData\ASRLogs.
- C:\ProgramData\ASRSetupLogs.
- C:\ProgramData\LogUploadServiceLogs.
- C:\ProgramData\Microsoft Azure Site Recovery.
- C:\Program Files (x86)\Microsoft Azure Site Recovery
- C:-ProgramData-ASR-агент (на машинах Windows с установленной службой мобильности)

## <a name="replication-process"></a>Процесс репликации

1. При включании репликации для машины начинается начальная репликация в Azure.
2. Во время первоначальной репликации служба Мобильности считывает данные с дисков машины и отправляет их на сервер процесса.
3. Эти данные используются для засеяния копии диска в подписке Azure. 
4. После завершения начальной репликации начинается репликация разностных изменений в Azure. Репликация является блок-уровне, и почти непрерывной.
4. Служба мобильности перехватывает записи на дисковую память, интегрируясь с подсистемой хранения операционной системы. Этот метод позволяет избежать операций ввоза диска на репликации машины для инкрементного репликации. 
5. Отслеживаемые изменения для машины отправляются на сервер процесса на входящий порт HTTPS 9443. Этот порт можно изменить. Сервер процесса сжимает и шифрует его и отправляет в Azure. 

## <a name="ports"></a>порты;

**Устройство** | **Подключения**
--- | --- 
**Репликационные машины** | Служба мобильности, работающая на ВМ, общается с прибором репликации на входящих в порт HTTPS 443 для управления репликацией.<br/><br/> Машины отправляют данные репликации на сервер процесса в порт httpS 9443 входящих. Этот порт можно изменить.
**Репликационный прибор** | Прибор репликации оркеструет репликацию с Azure над исходящим портом HTTPS 443.
**Сервер обработки** | Сервер обработки получает данные репликации, оптимизирует и шифрует их, а затем отправляет в службу хранилища Azure через порт 443 для исходящих подключений.


## <a name="performance-and-scaling"></a>Производительность и масштабируемость

По умолчанию развертывается один прибор репликации, который работает как на сервере конфигурации, так и на сервере процесса. Если вы копируете только несколько машин, этого развертывания достаточно. Однако, если вы реплицируете и мигрируете сотни машин, один сервер процесса может быть не в состоянии обрабатывать весь трафик репликации. В этом случае можно развернуть дополнительные, масштабированные серверы процесса.

### <a name="plan-vmware-deployment"></a>План развертывания VMware

Если вы воспроизводите VM-м объектам VMware, вы можете использовать [планировщик развертывания сайта для VMware,](../site-recovery/site-recovery-deployment-planner.md)чтобы помочь определить требования к производительности, включая ежедневную скорость изменения данных, а также необходимые серверы процессов.

### <a name="replication-appliance-capacity"></a>Емкость прибора репликации

Используйте значения в этой таблице, чтобы выяснить, нужен ли дополнительный сервер процесса в развертывании.

- Если скорость ежедневного изменения (скорость оттока) составляет более 2 ТБ, развернуть дополнительный сервер процесса.
- Если вы воспроизводите более 200 машин, разместите дополнительный прибор репликации.

**Процессора** | **Память** | **Свободное кэширование данных пространства** | **Коэффициент оттока** | **Ограничения репликации**
--- | --- | --- | --- | ---
8 виртуальных ЦП (2 сокета по 4 ядра с частотой \@ 2,5 ГГц) | 16 ГБ | 300 ГБ | 500 ГБ или менее | < 100 компьютеров 
12 виртуальных ЦП (2 сокета по 6 ядер с частотой \@ 2,5 ГГц) | 18 ГБ | 600 ГБ | От 501 ГБ до 1 ТБ | 100-150 машин.
16 виртуальных ЦП (2 сокета по 8 ядер с частотой \@ 2,5 ГГц) | 32 G1 |  1 TБ | От 1 ТБ до 2 ТБ | 151-200 машин.

### <a name="sizing-scale-out-process-servers"></a>Серверы масштабирования процесса масштабирования

Если вам нужно развернуть сервер процесса масштабирования, используйте эту таблицу, чтобы выяснить размер сервера.

**Сервер обработки** | **Свободное пространство для кэширования данных** | **Коэффициент оттока** | **Ограничения репликации**
--- | --- | --- | --- 
4 виртуальных ЦП (2 сокета * 2 ядра с частотой \@ 2,5 ГГц), 8 ГБ памяти | 300 ГБ | 250 ГБ или менее | До 85 машин 
8 виртуальных ЦП (2 сокета * 4 ядра с частотой \@ 2,5 ГГц), 12 ГБ памяти | 600 ГБ | От 251 ГБ до 1 ТБ    | 86-150 машин.
12 vCPUs (2 розетки \@ и 6 ядер 2,5 ГГц), 24-ГБ памяти | 1 TБ | 1-2 TБ | 151-225 машин.

## <a name="throttle-upload-bandwidth"></a>Throttle загрузить пропускную способность.

Трафик VMware, который реплицируется в Azure, проходит через определенный сервер обработки. Вы можете ограничить пропускную способность загрузки путем регулирования пропускной способности на машинах, которые работают в качестве серверов процессов. Вы можете влиять на пропускную способность, используя этот ключ реестра:

- Значение реестра HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication\UploadThreadsPerVM задает количество потоков, используемых для передачи данных диска (для начальной или разностной репликации данных). Если задать высокое значение, пропускная способность сети, используемая для репликации, увеличивается. Значение по умолчанию составляет четыре. Максимальное значение 32. Следите за трафиком для оптимизации значения.
- Кроме того, вы можете задушить пропускную способность на машине сервера процесса следующим образом:

    1. На машине сервера процесса откройте snap-in Azure Backup MMC. На рабочем столе или в папке C есть ярлык: «Файлы программы»-«Агент служб восстановления Azure Microsoft Azure Agent'bin. 
    2. В оснастке выберите **Change Properties** (Изменить свойства).
    3. В **throttling**, выберите **Включить интернет-пропускной способности использования регулирования для операций резервного копирования.** Задайте ограничения для рабочего и нерабочего времени. Допустимы значения в диапазоне от 512 Кбит/с до 1,023 Мбит/с.


## <a name="next-steps"></a>Дальнейшие действия

Попробуйте [миграцию на основе агента](tutorial-migrate-vmware-agent.md) для [VMware](tutorial-migrate-vmware-agent.md) или [физических серверов.](tutorial-migrate-physical-virtual-machines.md)
