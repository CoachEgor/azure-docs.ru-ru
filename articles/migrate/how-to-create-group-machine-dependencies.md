---
title: Группирование компьютеров на основе зависимостей с помощью службы "Миграция Azure" | Документация Майкрософт
description: В этой статье описывается, как создать оценку на основе зависимостей компьютера с помощью службы "Миграция Azure".
author: rayne-wiselman
ms.service: azure-migrate
ms.topic: article
ms.date: 07/17/2019
ms.author: hamusa
ms.openlocfilehash: 4130bb746a4faa4907353654d16f7c20c0cc7817
ms.sourcegitcommit: fe6b91c5f287078e4b4c7356e0fa597e78361abe
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/29/2019
ms.locfileid: "68598953"
---
# <a name="set-up-dependency-visualization-for-assessment"></a>Настройка визуализации зависимостей для оценки

В этой статье описывается, как настроить сопоставление зависимостей в службе "миграция Azure". службы "Миграция Azure".

Сопоставление зависимостей позволяет визуализировать зависимости между компьютерами, которые необходимо оценить и перенести.

- В службе "миграция Azure": Оценка сервера. вы собираетесь собирать компьютеры вместе для оценки. Обычно это компьютеры, которые требуется перенести вместе.
- Сопоставление зависимостей обычно используется, если требуется оценить группы с более высоким уровнем достоверности.
- Сопоставление зависимостей позволяет перекрестно проверить зависимости компьютеров перед выполнением оценки и миграции.
- Сопоставление и Визуализация зависимостей помогает эффективно спланировать миграцию в Azure. Это помогает убедиться, что ничего не осталось, тем самым избегая неожиданных сбоев во время миграции.
- С помощью сопоставления можно обнаружить взаимозависимые системы, которые необходимо перенести вместе. Можно также определить, обслуживает ли работающая система пользователей, или же является кандидатом на списание вместо миграции.

Дополнительные [сведения](concepts-dependency-visualization.md#how-does-it-work) о визуализации зависимостей.

## <a name="before-you-start"></a>Перед началом

- Убедитесь, что вы [создали](how-to-add-tool-first-time.md) проект "миграция Azure".
- Если вы уже создали проект, убедитесь, что вы [добавили](how-to-assess.md) службу "миграция Azure": службы "Миграция Azure".
- Убедитесь, что ваши компьютеры обнаружены в службе "миграция Azure". Это можно сделать, настроив устройство миграции Azure для [VMware](how-to-set-up-appliance-vmware.md) или [Hyper-V](how-to-set-up-appliance-hyper-v.md). Устройство обнаруживает локальные компьютеры и отправляет метаданные и данные производительности в службу "миграция Azure": службы "Миграция Azure". [Узнайте больше](migrate-appliance.md).


**Функции** | **Примечание**
--- | ---
Доступность | Визуализация зависимостей недоступна в Azure для государственных организаций.
Схема услуги | Визуализация зависимостей использует Сопоставление служб решение в журналах Azure Monitor. [Сопоставление служб](../azure-monitor/insights/service-map-configure.md) автоматически обнаруживает и отображает соединения между серверами.
Агенты | Чтобы использовать визуализацию зависимостей, установите несколько агентов на компьютерах, которые нужно сопоставлять:<br/> - Агент [log Analytics Azure](../azure-monitor/platform/log-analytics-agent.md) (ранее назывался Microsoft MONITORING Agent (MMA).<br/> -Сопоставление служб агент зависимостей.<br/><br/> Чтобы автоматизировать установку агента, можно использовать средство развертывания, такое как System Center Configuration Manager или партнерское средство, например [Intigua](https://www.intigua.com/getting-started-intigua-for-azure-migration), которое содержит решение для развертывания агентов для службы "миграция Azure".
Dependency Agent | Ознакомьтесь с поддержкой агента зависимостей для [Windows](../azure-monitor/insights/service-map-configure.md#supported-windows-operating-systems) и [Linux](../azure-monitor/insights/service-map-configure.md#supported-linux-operating-systems).<br/><br/> Дополнительные [сведения](https://docs.microsoft.com/azure/monitoring/monitoring-service-map-configure#installation-script-examples) об использовании скриптов для установки агента зависимостей.
Агент Log Analytics (MMA) | Дополнительные [сведения](../azure-monitor/platform/log-analytics-agent.md#install-and-configure-agent) о методах установки MMA.<br/><br/> Для компьютеров, отслеживаемых System Center Operations Manager 2012 R2 или более поздней версии, не нужно устанавливать агент MMA. Сопоставление служб интегрируется с Operations Manager. Вы можете включить интеграцию с помощью инструкций, которые находятся [здесь](https://docs.microsoft.com/azure/azure-monitor/insights/service-map-scom#prerequisites). Обратите внимание, однако, что агент зависимости должен быть установлен на этих компьютерах.<br/><br/> [Ознакомьтесь](../azure-monitor/platform/log-analytics-agent.md#supported-linux-operating-systems) с операционными системами Linux, поддерживаемыми агентом log Analytics.
Группы оценки | Группы, для которых необходимо визуализировать зависимости, должны содержать не более 10 компьютеров. Если у вас более 10 компьютеров, разделите их на группы меньшего размера, чтобы визуализировать зависимости.

## <a name="associate-a-log-analytics-workspace"></a>Связывание рабочей области Log Analytics

Чтобы использовать визуализацию зависимостей, необходимо связать [рабочую область log Analytics](../azure-monitor/platform/manage-access.md) с проектом службы "миграция Azure".

- Рабочую область можно подключить только в подписке на проект "миграция Azure".
- Можно присоединить существующую рабочую область или создать новую.
- Вы подключаете рабочую область при первой настройке визуализации зависимостей для компьютера.
- Вы можете подключить рабочую область только после обнаружения компьютеров в проекте службы "миграция Azure". Это можно сделать, настроив устройство миграции Azure для [VMware](how-to-set-up-appliance-vmware.md) или [Hyper-V](how-to-set-up-appliance-hyper-v.md). Устройство обнаруживает локальные компьютеры и отправляет метаданные и данные производительности в службу "миграция Azure": службы "Миграция Azure". [Узнайте больше](migrate-appliance.md).

Подключите рабочую область следующим образом:

1. В **службе "миграция Azure": Оценка**сервера щелкните **Обзор**. Если вы еще не добавили средство оценки серверов, [сделайте это первыми](how-to-assess.md).
2. В разделе **Обзор**щелкните стрелку вниз, чтобы развернуть раздел **основные компоненты**.
3. В **рабочей области OMS**щелкните **требуется настройка**.
4. В окне **Настройка рабочей области**укажите, хотите ли вы создать новую рабочую область или использовать существующую.

    ![Добавить рабочую область](./media/how-to-create-group-machine-dependencies/workspace.png)

    - После указания имени для новой рабочей области она будет создана в том же географии, что и проект службы "миграция Azure".
    - При подключении имеющейся рабочей области вы можете выбрать нужную из всех доступных рабочих областей в той же подписке, что и проект миграции.
    - Для подключения к рабочей области требуется читатель.
    - Невозможно изменить рабочую область, связанную с проектом, после его присоединения.

## <a name="download-and-install-the-vm-agents"></a>Скачивание и установка агентов виртуальной машины

Скачайте и установите агенты на каждом локальном компьютере, который необходимо визуализировать с помощью сопоставления зависимостей.

1. В **службе "миграция Azure": Оценка**сервера щелкните **обнаруженные серверы**.
2. Для каждого компьютера, для которого необходимо использовать визуализацию зависимостей, щелкните **требуется установка агента**.
3. На странице **зависимости** для виртуальной машины > **скачать и установить MMA**, скачайте соответствующий агент и установите его, как описано ниже.
4. В разделе **Загрузка и установка агента зависимостей**Скачайте соответствующий агент и установите его, как описано ниже.
5. В разделе **Настройка агента MMA**скопируйте идентификатор и ключ рабочей области. Они понадобятся при установке агента MMA.

### <a name="install-the-mma"></a>Установка MMA

#### <a name="install-the-agent-on-a-windows-machine"></a>Установка агента на компьютере Windows

Вот как можно установить агент на компьютере Windows.

1. Дважды щелкните скачанный файл агента.
2. На странице **приветствия** нажмите кнопку **Далее**. На странице **Условия лицензии** нажмите кнопку **Принимаю**, чтобы принять условия лицензии.
3. В поле **Конечная папка** оставьте или измените папку установки по умолчанию. Нажмите кнопку **Далее**.
4. В разделе **Параметры установки агента** последовательно выберите **Azure Log Analytics** > **Далее**.
5. Щелкните **Добавить**, чтобы добавить новую рабочую область Log Analytics. Вставьте идентификатор и ключ рабочей области, скопированные на портале. Нажмите кнопку **Далее**.

#### <a name="install-the-agent-on-a-linux-machine"></a>Установка агента на компьютере Linux

Вот как можно установить агент на компьютере Linux.

1. Перенесите соответствующий пакет (x86 или x64) на компьютер Linux с помощью scp или sftp.
2. Установите пакет, используя аргумент --install.

    ```sudo sh ./omsagent-<version>.universal.x64.sh --install -w <workspace id> -s <workspace key>```

### <a name="install-the-dependency-agent"></a>Установка агента зависимостей
1. Чтобы установить агент зависимостей на компьютере Windows, дважды щелкните файл установки и следуйте инструкциям мастера.
2. Чтобы установить агент зависимостей на компьютере Linux, сделайте это с правами привилегированного пользователя, используя следующую команду.

    ```sh InstallDependencyAgent-Linux64.bin```

## <a name="create-a-group-using-dependency-visualization"></a>Создание группы с помощью визуализации зависимостей

1. В **службе "миграция Azure": Оценка**сервера щелкните **обнаруженные серверы**.
2. В столбце **зависимости** щелкните **Просмотр зависимостей** для каждого компьютера, который требуется просмотреть.
3. На карте зависимостей можно увидеть следующее:
    - Входящие (клиенты) и исходящие (серверы) TCP-подключения к компьютеру и с него.
    - Зависимые компьютеры, на которых не установлены агенты зависимостей, группируются по номерам портов.
    - Зависимые компьютеры с установленными агентами зависимостей отображаются в виде отдельных рамок.
    - Процессы, выполняющиеся внутри компьютера. Разверните окно каждого компьютера, чтобы просмотреть процессы.
    - Свойства компьютера (включая полное доменное имя, операционная система, MAC-адрес). Щелкните поле каждого компьютера, чтобы просмотреть сведения.

4. Вы можете просмотреть зависимости за разные периоды. Для этого нужно щелкнуть длительность периода в метке диапазона времени. По умолчанию диапазон равен одному часу. Можно изменить диапазон времени или указать даты начала и окончания и длительность.

    > [!NOTE]
    > Диапазон времени может быть не более часа. Если требуется более длинный диапазон, используйте Azure Monitor для запроса зависимых данных в течение более длительного периода.

5. Определив зависимые компьютеры, которые нужно сгруппировать, нажмите клавиши CTRL + щелчок, чтобы выбрать несколько компьютеров на карте, и щелкните **группы компьютеров**.
6. Укажите имя группы.
7. Проверьте, нашла ли служба миграции Azure зависимые компьютеры.

    - Если зависимый компьютер не обнаружен службой "миграция Azure", выполните следующие действия. Оценка сервера не может быть добавлена в группу.
    - Чтобы добавить компьютер, запустите обнаружение еще раз и убедитесь, что компьютер обнаружен.

8. Если вы хотите создать оценку для этой группы, установите флажок.
8. Нажмите кнопку **ОК**, чтобы сохранить группу.

После создания группы рекомендуется установить агенты на всех компьютерах в группе, а затем визуализировать зависимости для всей группы.

## <a name="query-dependency-data-in-azure-monitor"></a>Запрос данных зависимостей в Azure Monitor

Вы можете запрашивать данные зависимостей, захваченные Сопоставление служб в рабочей области Log Analytics, связанной с проектом службы "миграция Azure". Log Analytics используется для записи и выполнения запросов Azure Monitor журналов.

- [Узнайте, как](../azure-monitor/insights/service-map.md#log-analytics-records) искать данные Сопоставление служб в log Analytics.
- [Общие сведения о](../azure-monitor/log-query/get-started-queries.md) написании запросов журналов в [log Analytics](../azure-monitor/log-query/get-started-portal.md).

Выполните запрос для данных зависимостей следующим образом:

1. После установки агентов перейдите на портал и выберите **Обзор**.
2. В **службе "миграция Azure": Оценка**сервера щелкните **Обзор**. Щелкните стрелку вниз, чтобы развернуть раздел **основные компоненты**.
3. В **рабочей области OMS**щелкните имя рабочей области.
3. На странице Рабочая область Log Analytics > **Общие**щелкните **журналы**.
4. Напишите запрос и нажмите кнопку **выполнить**.

### <a name="sample-queries"></a>Примеры запросов

Мы предоставляем числовые примеры запросов, которые можно использовать для извлечения данных зависимостей.

- Вы можете изменить запросы, чтобы извлечь предпочтительные точки данных.
- [Ознакомьтесь](https://docs.microsoft.com/azure/azure-monitor/insights/service-map#log-analytics-records) с полным списком записей данных о зависимостях.
- [Ознакомьтесь](https://docs.microsoft.com/azure/azure-monitor/insights/service-map#sample-log-searches) с дополнительными примерами запросов.

#### <a name="sample-review-inbound-connections"></a>Пример: Проверка входящих подключений

Проверьте входящие подключения для набора виртуальных машин.

- Записи в таблице для метрик подключения (Вмконнектион) не представляют отдельные физические сетевые подключения.
- Система группирует несколько физических сетевых подключений в логическое подключение.
- Дополнительные [сведения](https://docs.microsoft.com/azure/azure-monitor/insights/service-map#connections) о статистической обработке данных физического сетевого подключения в вмконнектион.

```
// the machines of interest
let ips=materialize(ServiceMapComputer_CL
| summarize ips=makeset(todynamic(Ipv4Addresses_s)) by MonitoredMachine=ResourceName_s
| mvexpand ips to typeof(string));
let StartDateTime = datetime(2019-03-25T00:00:00Z);
let EndDateTime = datetime(2019-03-30T01:00:00Z);
VMConnection
| where Direction == 'inbound'
| where TimeGenerated > StartDateTime and TimeGenerated  < EndDateTime
| join kind=inner (ips) on $left.DestinationIp == $right.ips
| summarize sum(LinksEstablished) by Computer, Direction, SourceIp, DestinationIp, DestinationPort
```

#### <a name="sample-summarize-sent-and-received-data"></a>Пример: Суммировать отправленные и полученные данные

В этом примере обобщены объемы данных, отправляемых и получаемых во входящих соединениях между набором компьютеров.

```
// the machines of interest
let ips=materialize(ServiceMapComputer_CL
| summarize ips=makeset(todynamic(Ipv4Addresses_s)) by MonitoredMachine=ResourceName_s
| mvexpand ips to typeof(string));
let StartDateTime = datetime(2019-03-25T00:00:00Z);
let EndDateTime = datetime(2019-03-30T01:00:00Z);
VMConnection
| where Direction == 'inbound'
| where TimeGenerated > StartDateTime and TimeGenerated  < EndDateTime
| join kind=inner (ips) on $left.DestinationIp == $right.ips
| summarize sum(BytesSent), sum(BytesReceived) by Computer, Direction, SourceIp, DestinationIp, DestinationPort
```

## <a name="next-steps"></a>Следующие шаги

[Создание оценки](how-to-create-assessment.md) для группы.
