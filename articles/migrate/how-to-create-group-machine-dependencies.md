---
title: Группирование компьютеров на основе зависимостей с помощью службы "Миграция Azure" | Документация Майкрософт
description: В этой статье описывается, как создать оценку на основе зависимостей компьютера с помощью службы "Миграция Azure".
author: rayne-wiselman
ms.service: azure-migrate
ms.topic: article
ms.date: 12/05/2018
ms.author: raynew
ms.openlocfilehash: af47678b19209936aed86c132a8a3f400c3a7e8f
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60596812"
---
# <a name="group-machines-using-machine-dependency-mapping"></a>Группирование компьютеров с помощью зависимостей

В этой статье описывается, как создать группу компьютеров для оценки с помощью службы [миграции Azure](migrate-overview.md), используя визуализацию зависимостей компьютеров. Этот метод обычно используется, если вы хотите оценить группы виртуальных машин с более высоким уровнем достоверности, выполнив перекрестную проверку зависимостей компьютеров, прежде чем выполнять оценку. Визуализация зависимостей поможет эффективно спланировать миграцию в Azure, гарантируя полный перенос без простоев. Вы сможете обнаружить все взаимозависимые системы, которые нужно переносить вместе, и определить, используют ли пользователи запущенную систему или ее уже нужно вывести из эксплуатации.

> [!NOTE]
> Функция визуализации зависимостей недоступна в Azure для государственных организаций.

## <a name="prepare-for-dependency-visualization"></a>Подготовка к визуализации зависимостей
Служба "Миграция Azure" использует решение схемы услуги в журналах Azure Monitor, чтобы включить визуализация зависимостей компьютеров.

### <a name="associate-a-log-analytics-workspace"></a>Связывание рабочей области Log Analytics
Чтобы использовать визуализацию зависимостей, необходимо связать новую или существующую рабочую область Log Analytics с проектом службы "Миграция Azure". Вы можете создать или присоединить рабочую область только в той же подписке, в которой создан проект миграции.

- Чтобы присоединить рабочую область Log Analytics к проекту, в колонке **Обзор** перейдите в раздел **Основное** проекта и щелкните **Требуется настройка**.

    ![Связывание рабочей области Log Analytics](./media/concepts-dependency-visualization/associate-workspace.png)

- Во время связывания вы можете создать рабочую область или присоединить имеющуюся.
  - Когда вы создаете рабочую область, необходимо указать ее имя. Рабочая область создается в том же [географическом регионе Azure](https://azure.microsoft.com/global-infrastructure/geographies/), что и проект миграции.
  - При подключении имеющейся рабочей области вы можете выбрать нужную из всех доступных рабочих областей в той же подписке, что и проект миграции. Обратите внимание, что в списке указаны только рабочие области, созданные в регионе, в котором [поддерживается решение "Сопоставление служб"](https://docs.microsoft.com/azure/azure-monitor/insights/service-map-configure#supported-azure-regions). Чтобы подключить рабочую область, необходим доступ к ней с ролью "Читатель".

> [!NOTE]
> Изменить рабочую область, связанную с проектом миграции, невозможно.

### <a name="download-and-install-the-vm-agents"></a>Скачивание и установка агентов виртуальной машины
Настроив рабочую область, необходимо скачать и установить агенты на каждом локальном компьютере, который нужно оценить. Кроме того, если у вас есть компьютеры без подключения к Интернету, на них необходимо скачать и установить [шлюз Log Analytics](../azure-monitor/platform/gateway.md).

1. На странице **Обзор** выберите **Управление** > **Компьютеры** и выберите необходимый компьютер.
2. В столбце **Зависимости** щелкните **Установить агенты**.
3. На странице **Зависимости** скачайте и установите Microsoft Monitoring Agent (MMA) и агент зависимостей на каждую виртуальную машину, которую нужно оценить.
4. Скопируйте идентификатор и ключ рабочей области. Они требуются для установки MMA на локальном компьютере.

> [!NOTE]
> Чтобы автоматизировать установку агентов, можно воспользоваться любым средством развертывания, например System Center Configuration Manager, или средством нашего партнера, [Intigua](https://www.intigua.com/getting-started-intigua-for-azure-migration), у которого есть решение развертывания агентов для службы "Миграция Azure".

### <a name="install-the-mma"></a>Установка MMA

#### <a name="install-the-agent-on-a-windows-machine"></a>Установка агента на компьютере Windows

Вот как можно установить агент на компьютере Windows.

1. Дважды щелкните скачанный файл агента.
2. На странице **приветствия** нажмите кнопку **Далее**. На странице **Условия лицензии** нажмите кнопку **Принимаю**, чтобы принять условия лицензии.
3. В поле **Конечная папка** оставьте или измените папку установки по умолчанию. Нажмите кнопку **Далее**.
4. В разделе **Параметры установки агента** последовательно выберите **Azure Log Analytics** > **Далее**.
5. Щелкните **Добавить**, чтобы добавить новую рабочую область Log Analytics. Вставьте идентификатор и ключ рабочей области, скопированные на портале. Нажмите кнопку **Далее**.

Агент можно установить из командной строки или с помощью автоматизированного способа например System Center Configuration Manager. Дополнительные сведения об использовании этих методов для установки агента MMA см. в разделе [Установка и настройка агента](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent#install-and-configure-agent).

#### <a name="install-the-agent-on-a-linux-machine"></a>Установка агента на компьютере Linux

Вот как можно установить агент на компьютере Linux.

1. Перенесите соответствующий пакет (x86 или x64) на компьютер Linux с помощью scp или sftp.
2. Установите пакет, используя аргумент --install.

    ```sudo sh ./omsagent-<version>.universal.x64.sh --install -w <workspace id> -s <workspace key>```

[Дополнительные сведения](https://docs.microsoft.com/azure/log-analytics/log-analytics-concept-hybrid#supported-linux-operating-systems) о списке операционных систем Linux, поддерживаемых MMA.

#### <a name="install-the-agent-on-a-machine-monitored-by-scom"></a>Установка агента на компьютере, который отслеживается с помощью SCOM

Для компьютеров, отслеживаемых System Center Operations Manager 2012 R2 или более поздней версии, нет необходимости устанавливать агент MMA. Сопоставление служб имеет интеграцию со SCOM, которая использует MOM SCOM для сбора необходимых данных о зависимостях. Вы можете включить интеграцию с помощью инструкций, которые находятся [здесь](https://docs.microsoft.com/azure/azure-monitor/insights/service-map-scom#prerequisites). Обратите внимание, однако, что агент зависимости должен быть установлен на этих компьютерах.


### <a name="install-the-dependency-agent"></a>Установка агента зависимостей
1. Чтобы установить агент зависимостей на компьютере Windows, дважды щелкните файл установки и следуйте инструкциям мастера.
2. Чтобы установить агент зависимостей на компьютере Linux, сделайте это с правами привилегированного пользователя, используя следующую команду.

    ```sh InstallDependencyAgent-Linux64.bin```

Узнайте больше о поддержке агента зависимостей для ОС [Windows](../azure-monitor/insights/service-map-configure.md#supported-windows-operating-systems) и [Linux](../azure-monitor/insights/service-map-configure.md#supported-linux-operating-systems).

[Узнайте больше](https://docs.microsoft.com/azure/monitoring/monitoring-service-map-configure#installation-script-examples) о том, как установить агент зависимостей с помощью скриптов.


## <a name="create-a-group"></a>Создание группы

1. После установки агентов перейдите на портал и выберите **Управление** > **Компьютеры**.
2. Найдите компьютер, на который вы установили агенты.
3. Столбец **зависимостей** для компьютера должен теперь отображаться как **Просмотреть зависимости**. Щелкните столбец для просмотра зависимостей компьютера.
4. На карте зависимостей компьютера появятся следующие сведения:
    - Входящие (клиенты) и исходящие (серверы) TCP-подключения к компьютеру и от него:
        - Зависимые компьютеры, на которых не установлен агент MMA и агент зависимостей, будут сгруппированы по номерам портов.
        - Зависимые компьютеры, на которых установлен агент MMA и агент зависимостей, будут отображаться в отдельных полях.
    - Чтобы просмотреть процессы, запущенные на компьютере, разверните поле каждого компьютера.
    - Чтобы просмотреть сведения о таких свойствах, как полное доменное имя (FQDN), операционная система, MAC-адрес каждого компьютера, щелкните каждое поле компьютера.

      ![Просмотр зависимостей компьютера](./media/how-to-create-group-machine-dependencies/machine-dependencies.png)

4. Вы можете просмотреть зависимости за разные периоды. Для этого нужно щелкнуть длительность периода в метке диапазона времени. По умолчанию диапазон равен одному часу. Можно изменить диапазон времени или указать даты начала и окончания и длительность.

   > [!NOTE]
   >    Сейчас пользовательский интерфейс визуализации зависимостей не поддерживает выбор диапазона времени, превышающего час. Использование Azure Monitor регистрирует [запроса данных зависимостей](https://docs.microsoft.com/azure/migrate/how-to-create-group-machine-dependencies) за более длительный срок.

5. После определения зависимых компьютеров, которые необходимо сгруппировать, выберите несколько компьютеров на карте, удерживая клавишу CTRL, а затем щелкните **Группировать компьютеры**.
6. Укажите имя группы. Проверьте, нашла ли служба миграции Azure зависимые компьютеры.

    > [!NOTE]
    > Если нет, компьютеры нельзя добавить в группу. Чтобы добавить такие компьютеры в группу, необходимо снова запустить процесс обнаружения в подходящей области в vCenter Server, и убедиться, что служба миграции Azure нашла зависимые компьютеры.  

7. Если вы хотите создать оценку для этой группы, установите флажок.
8. Нажмите кнопку **ОК**, чтобы сохранить группу.

После создания группы рекомендуется установить агенты на всех входящих в нее компьютерах и уточнить ее путем визуализации зависимости всей группы.

## <a name="query-dependency-data-from-azure-monitor-logs"></a>Данные запроса зависимостей из журналов Azure Monitor

Зависимость данных, полученных с услуги доступны для запросов в рабочей области Log Analytics, связанные с проектом "Миграция Azure". [Дополнительные сведения](https://docs.microsoft.com/azure/azure-monitor/insights/service-map#log-analytics-records) о таблицах данные схемы услуги для запроса в Azure Monitor журналы. 

Для выполнения запросов Kusto:

1. После установки агентов перейдите на портал и выберите **Обзор**.
2. В разделе **Обзор** перейдите в раздел проекта **Основное** и щелкните по имени рабочей области, указанному рядом с разделом **Рабочая область OMS**.
3. На странице "Рабочая область Log Analytics" щелкните **Общие** > **Журналы**.
4. Составьте запрос для сбора данных зависимостей с помощью журналов Azure Monitor. Найти примеры запросов в следующем разделе.
5. Выполните запрос, нажав кнопку "Запуск". 

[Дополнительные сведения](https://docs.microsoft.com/azure/azure-monitor/log-query/get-started-portal) о написании запросов Kusto. 

### <a name="sample-azure-monitor-logs-queries"></a>Пример Azure Monitor регистрирует запросы

Ниже приведены примеры запросов, которые можно использовать для извлечения данных зависимостей. Можно изменять запросы для извлечения Ваш предпочитаемый доступ к данным. Полный список полей в записи данных зависимостей доступен [здесь](https://docs.microsoft.com/azure/azure-monitor/insights/service-map#log-analytics-records). Найти дополнительные примеры запросов [здесь](https://docs.microsoft.com/azure/azure-monitor/insights/service-map#sample-log-searches).

#### <a name="summarize-inbound-connections-on-a-set-of-machines"></a>Суммировать входящие подключения через набор компьютеров

Обратите внимание на то, что записей таблицы для метрик подключения, VMConnection, не представляют отдельных физических сетевых подключений. Несколько физических сетевых подключений, группируются в логическое. [Дополнительные сведения](https://docs.microsoft.com/azure/azure-monitor/insights/service-map#connections) о физических сетевое подключение данные собираются в одной логической записи в VMConnection. 

```
// the machines of interest
let ips=materialize(ServiceMapComputer_CL
| summarize ips=makeset(todynamic(Ipv4Addresses_s)) by MonitoredMachine=ResourceName_s
| mvexpand ips to typeof(string));
let StartDateTime = datetime(2019-03-25T00:00:00Z);
let EndDateTime = datetime(2019-03-30T01:00:00Z); 
VMConnection
| where Direction == 'inbound' 
| where TimeGenerated > StartDateTime and TimeGenerated  < EndDateTime
| join kind=inner (ips) on $left.DestinationIp == $right.ips
| summarize sum(LinksEstablished) by Computer, Direction, SourceIp, DestinationIp, DestinationPort
```

#### <a name="summarize-volume-of-data-sent-and-received-on-inbound-connections-between-a-set-of-machines"></a>Суммировать объем данных, отправленных и полученных для входящих подключений между набор компьютеров

```
// the machines of interest
let ips=materialize(ServiceMapComputer_CL
| summarize ips=makeset(todynamic(Ipv4Addresses_s)) by MonitoredMachine=ResourceName_s
| mvexpand ips to typeof(string));
let StartDateTime = datetime(2019-03-25T00:00:00Z);
let EndDateTime = datetime(2019-03-30T01:00:00Z); 
VMConnection
| where Direction == 'inbound' 
| where TimeGenerated > StartDateTime and TimeGenerated  < EndDateTime
| join kind=inner (ips) on $left.DestinationIp == $right.ips
| summarize sum(BytesSent), sum(BytesReceived) by Computer, Direction, SourceIp, DestinationIp, DestinationPort
```

## <a name="next-steps"></a>Дальнейшие действия

- [Вопросы и ответы](https://docs.microsoft.com/azure/migrate/resources-faq#dependency-visualization) о визуализации зависимостей.
- [Узнайте, как](how-to-create-group-dependencies.md) уточнить группу путем визуализации ее зависимостей.
- [Узнайте больше](concepts-assessment-calculation.md) о вычислении оценок.
