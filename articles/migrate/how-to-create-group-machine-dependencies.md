---
title: Настройка анализа зависимостей на основе агентов в службе "миграция Azure" для оценки сервера
description: В этой статье описывается, как настроить анализ зависимостей на основе агента в службе "Миграция серверов Azure".
ms.topic: how-to
ms.date: 2/24/2020
ms.openlocfilehash: 47fd7e7c864e82400288bb67da952a18b648849e
ms.sourcegitcommit: 309a9d26f94ab775673fd4c9a0ffc6caa571f598
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/09/2020
ms.locfileid: "82996877"
---
# <a name="set-up-dependency-visualization"></a>Настройка визуализации зависимостей

В этой статье описывается, как настроить анализ зависимостей на основе агента в службе "миграция Azure": Оценка сервера. [Анализ зависимостей](concepts-dependency-visualization.md) помогает определить и понять зависимости между компьютерами, которые вы хотите оценить и перенести в Azure.

## <a name="before-you-start"></a>Перед началом работы

- [Сведения об](concepts-dependency-visualization.md#agent-based-analysis) анализе зависимостей на основе агентов.
- Ознакомьтесь с требованиями и требования к поддержке для настройки визуализации зависимостей на основе агентов для [виртуальных машин VMware](migrate-support-matrix-vmware.md#agent-based-dependency-analysis-requirements), [физических серверов](migrate-support-matrix-physical.md#agent-based-dependency-analysis-requirements)и [виртуальных машин Hyper-V](migrate-support-matrix-hyper-v.md#agent-based-dependency-analysis-requirements).
- Убедитесь, что вы [создали](how-to-add-tool-first-time.md) проект "миграция Azure".
- Если вы уже создали проект, убедитесь, что вы [добавили](how-to-assess.md) средство Azure Migrate: Server для оценки серверов.
- Убедитесь, что вы настроили [устройство "миграция Azure](migrate-appliance.md) " для обнаружения локальных компьютеров. Узнайте, как настроить устройство для [VMware](how-to-set-up-appliance-vmware.md), [Hyper-V](how-to-set-up-appliance-hyper-v.md)или [физических серверов](how-to-set-up-appliance-physical.md). Устройство обнаруживает локальные компьютеры и отправляет метаданные, данные о производительности в службу "миграция Azure": Оценка сервера.
- Чтобы использовать визуализацию зависимостей, вы связываете [рабочую область log Analytics](../azure-monitor/platform/manage-access.md) с проектом службы "миграция Azure":
    - Вы можете подключить рабочую область только после настройки устройства "миграция Azure" и обнаружения компьютеров в проекте "миграция Azure".
    - Убедитесь, что у вас есть рабочая область в подписке, которая содержит проект службы "миграция Azure".
    - Рабочая область должна находиться в регионах восточной части США, Юго-Восточной Азии или Западной Европы. Рабочие области в других регионах не могут быть связаны с проектом.
    - Рабочая область должна находиться в регионе, в котором [поддерживается сопоставление служб](../azure-monitor/insights/vminsights-enable-overview.md#prerequisites).
    - Вы можете связать новую или существующую рабочую область Log Analytics с проектом службы "миграция Azure".
    - Вы подключаете рабочую область при первой настройке визуализации зависимостей для компьютера. Рабочую область для проекта службы "миграция Azure" нельзя изменить после добавления.
    - В Log Analytics рабочей области, связанной с миграцией Azure, помечается ключ проекта миграции и имя проекта.

## <a name="associate-a-workspace"></a>Связывание рабочей области

1. После обнаружения компьютеров для оценки в разделе **серверы** > **Миграция Azure: Оценка сервера**щелкните **Обзор**.  
2. В **службе "миграция Azure": Оценка сервера**щелкните **Essentials**.
3. В **рабочей области OMS**щелкните **требуется настройка**.

     ![Настройка рабочей области Log Analytics](./media/how-to-create-group-machine-dependencies/oms-workspace-select.png)   

4. В окне **Настройка рабочей области OMS**укажите, следует ли создать новую рабочую область или использовать существующую.
    - Вы можете выбрать существующую рабочую область из всех рабочих областей в подписке "миграция проекта".
    - Чтобы связать его с рабочей областью, необходимо иметь доступ читателя.
5. Если вы создаете новую рабочую область, выберите ее расположение.

    ![Добавление новой рабочей области](./media/how-to-create-group-machine-dependencies/workspace.png)


## <a name="download-and-install-the-vm-agents"></a>Скачивание и установка агентов виртуальной машины

На каждом компьютере, который необходимо проанализировать, установите агенты.

> [!NOTE]
> Для компьютеров, отслеживаемых System Center Operations Manager 2012 R2 или более поздней версии, не нужно устанавливать агент MMA. Сопоставление служб интегрируется с Operations Manager. [Следуйте](https://docs.microsoft.com/azure/azure-monitor/insights/service-map-scom#prerequisites) рекомендациям по интеграции.

1. В **службе "миграция Azure": Оценка сервера**щелкните **обнаруженные серверы**.
2. Для каждого компьютера, который необходимо проанализировать с помощью визуализации зависимостей, в столбце **зависимости** щелкните **требуется установка агента**.
3. На странице **зависимости** Скачайте MMA и агент зависимостей для Windows или Linux.
4. В разделе **Настройка агента MMA**скопируйте идентификатор и ключ рабочей области. Они понадобятся при установке агента MMA.

    ![Установка агентов](./media/how-to-create-group-machine-dependencies/dependencies-install.png)


## <a name="install-the-mma"></a>Установка MMA

Установите MMA на каждом компьютере Windows или Linux, который требуется проанализировать.

### <a name="install-mma-on-a-windows-machine"></a>Установка MMA на компьютере Windows

Вот как можно установить агент на компьютере Windows.

1. Дважды щелкните скачанный файл агента.
2. На странице **приветствия** нажмите кнопку **Далее**. На странице **условия лицензии** нажмите кнопку **я принимаю** , чтобы принять условия лицензии.
3. В поле **Конечная папка** оставьте или измените папку установки по умолчанию. Нажмите кнопку **Далее**.
4. В разделе **Параметры установки агента** последовательно выберите **Azure Log Analytics** > **Далее**.
5. Щелкните **Добавить**, чтобы добавить новую рабочую область Log Analytics. Вставьте идентификатор и ключ рабочей области, скопированные на портале. Нажмите кнопку **Далее**.

Агент можно установить из командной строки или с помощью автоматизированного метода, такого как Configuration Manager или [Intigua](https://www.intigua.com/intigua-for-azure-migration).
- Дополнительные сведения об использовании этих методов для установки агента MMA см. в разделе [Установка и настройка агента](../azure-monitor/platform/log-analytics-agent.md#installation-and-configuration).
- Кроме того, агент MMA можно установить с помощью этого [скрипта](https://go.microsoft.com/fwlink/?linkid=2104394).
- Дополнительные [сведения](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent#supported-windows-operating-systems) о операционных системах Windows, поддерживаемых MMA.

### <a name="install-mma-on-a-linux-machine"></a>Установка MMA на компьютере Linux

Чтобы установить MMA на компьютере Linux, выполните следующие действия.

1. Перенесите соответствующий пакет (x86 или x64) на компьютер Linux с помощью scp или sftp.
2. Установите пакет, используя аргумент --install.

    ```sudo sh ./omsagent-<version>.universal.x64.sh --install -w <workspace id> -s <workspace key>```

[Дополнительные сведения](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent#supported-linux-operating-systems) о списке операционных систем Linux, поддерживаемых MMA. 

## <a name="install-the-dependency-agent"></a>Установка агента зависимостей

1. Чтобы установить агент зависимостей на компьютере Windows, дважды щелкните файл установки и следуйте инструкциям мастера.
2. Чтобы установить агент зависимостей на компьютере Linux, сделайте это с правами привилегированного пользователя, используя следующую команду.

    ```sh InstallDependencyAgent-Linux64.bin```

- [Узнайте больше](https://docs.microsoft.com/azure/azure-monitor/insights/vminsights-enable-hybrid-cloud#installation-script-examples) о том, как установить агент зависимостей с помощью скриптов.
- Дополнительные [сведения](https://docs.microsoft.com/azure/azure-monitor/insights/vminsights-enable-overview#supported-operating-systems) об операционных системах, поддерживаемых агентом зависимостей.


## <a name="create-a-group-using-dependency-visualization"></a>Создание группы с помощью визуализации зависимостей

Теперь создайте группу для оценки. 


> [!NOTE]
> Группы, для которых необходимо визуализировать зависимости, должны содержать не более 10 компьютеров. Если у вас более 10 компьютеров, разделите их на группы меньшего размера.

1. В **службе "миграция Azure": Оценка сервера**щелкните **обнаруженные серверы**.
2. В столбце **зависимости** щелкните **Просмотр зависимостей** для каждого компьютера, который требуется просмотреть.
3. На карте зависимостей можно увидеть следующее:
    - Входящие (клиенты) и исходящие (серверы) TCP-подключения к компьютеру и с него.
    - Зависимые компьютеры, на которых не установлены агенты зависимостей, группируются по номерам портов.
    - Зависимые компьютеры с установленными агентами зависимостей отображаются в виде отдельных рамок.
    - Процессы, выполняющиеся внутри компьютера. Разверните окно каждого компьютера, чтобы просмотреть процессы.
    - Свойства компьютера (включая полное доменное имя, операционная система, MAC-адрес). Щелкните поле каждого компьютера, чтобы просмотреть сведения.

4. Вы можете просмотреть зависимости за разные периоды. Для этого нужно щелкнуть длительность периода в метке диапазона времени.
    - По умолчанию диапазон равен одному часу. 
    - Можно изменить диапазон времени или указать даты начала и окончания и длительность.
    - Диапазон времени может быть не более часа. Если требуется более длинный диапазон, используйте Azure Monitor для запроса зависимых данных в течение более длительного периода.

5. Определив зависимые компьютеры, которые нужно сгруппировать, нажмите клавиши CTRL + щелчок, чтобы выбрать несколько компьютеров на карте, и щелкните **группы компьютеров**.
6. Укажите имя группы.
7. Проверьте, нашла ли служба миграции Azure зависимые компьютеры.

    - Если зависимый компьютер не обнаружен службой "миграция Azure": Оценка сервера, вы не сможете добавить его в группу.
    - Чтобы добавить компьютер, запустите обнаружение еще раз и убедитесь, что компьютер обнаружен.

8. Если вы хотите создать оценку для этой группы, установите флажок.
8. Нажмите кнопку **ОК**, чтобы сохранить группу.

После создания группы рекомендуется установить агенты на всех компьютерах в группе, а затем визуализировать зависимости для всей группы.

## <a name="query-dependency-data-in-azure-monitor"></a>Запрос данных зависимостей в Azure Monitor

Вы можете запрашивать данные зависимостей, захваченные Сопоставление служб в рабочей области Log Analytics, связанной с проектом службы "миграция Azure". Log Analytics используется для записи и выполнения запросов Azure Monitor журналов.

- [Узнайте, как](../azure-monitor/insights/service-map.md#log-analytics-records) искать данные Сопоставление служб в log Analytics.
- [Общие сведения о](../azure-monitor/log-query/get-started-queries.md) написании запросов журналов в [log Analytics](../azure-monitor/log-query/get-started-portal.md).

Выполните запрос для данных зависимостей следующим образом:

1. После установки агентов перейдите на портал и выберите **Обзор**.
2. В разделе " **Миграция Azure": Оценка сервера**щелкните **Обзор**. Щелкните стрелку вниз, чтобы развернуть раздел **основные компоненты**.
3. В **рабочей области OMS**щелкните имя рабочей области.
3. На странице Рабочая область Log Analytics > **Общие**щелкните **журналы**.
4. Напишите запрос и нажмите кнопку **выполнить**.

### <a name="sample-queries"></a>Примеры запросов

Ниже приведено несколько примеров запросов, которые можно использовать для извлечения данных зависимостей.

- Вы можете изменить запросы, чтобы извлечь предпочтительные точки данных.
- [Ознакомьтесь](https://docs.microsoft.com/azure/azure-monitor/insights/service-map#log-analytics-records) с полным списком записей данных о зависимостях.
- [Ознакомьтесь](https://docs.microsoft.com/azure/azure-monitor/insights/service-map#sample-log-searches) с дополнительными примерами запросов.

#### <a name="sample-review-inbound-connections"></a>Пример: проверка входящих подключений

Проверьте входящие подключения для набора виртуальных машин.

- Записи в таблице для метрик подключения (Вмконнектион) не представляют отдельные физические сетевые подключения.
- Система группирует несколько физических сетевых подключений в логическое подключение.
- Дополнительные [сведения](https://docs.microsoft.com/azure/azure-monitor/insights/service-map#connections) о статистической обработке данных физического сетевого подключения в вмконнектион.

```
// the machines of interest
let ips=materialize(ServiceMapComputer_CL
| summarize ips=makeset(todynamic(Ipv4Addresses_s)) by MonitoredMachine=ResourceName_s
| mvexpand ips to typeof(string));
let StartDateTime = datetime(2019-03-25T00:00:00Z);
let EndDateTime = datetime(2019-03-30T01:00:00Z);
VMConnection
| where Direction == 'inbound'
| where TimeGenerated > StartDateTime and TimeGenerated  < EndDateTime
| join kind=inner (ips) on $left.DestinationIp == $right.ips
| summarize sum(LinksEstablished) by Computer, Direction, SourceIp, DestinationIp, DestinationPort
```

#### <a name="sample-summarize-sent-and-received-data"></a>Пример: формирование сводки отправленных и полученных данных

В этом примере обобщены объемы данных, отправляемых и получаемых во входящих соединениях между набором компьютеров.

```
// the machines of interest
let ips=materialize(ServiceMapComputer_CL
| summarize ips=makeset(todynamic(Ipv4Addresses_s)) by MonitoredMachine=ResourceName_s
| mvexpand ips to typeof(string));
let StartDateTime = datetime(2019-03-25T00:00:00Z);
let EndDateTime = datetime(2019-03-30T01:00:00Z);
VMConnection
| where Direction == 'inbound'
| where TimeGenerated > StartDateTime and TimeGenerated  < EndDateTime
| join kind=inner (ips) on $left.DestinationIp == $right.ips
| summarize sum(BytesSent), sum(BytesReceived) by Computer, Direction, SourceIp, DestinationIp, DestinationPort
```

## <a name="next-steps"></a>Дальнейшие действия

[Создание оценки](how-to-create-assessment.md) для группы.


