---
title: Подготовка виртуальных машин Hyper-V к оценке и миграции с помощью службы "Миграция Azure"
description: Узнайте, как подготовить виртуальные машины Hyper-V к оценке и миграции с помощью службы "Миграция Azure".
ms.topic: tutorial
ms.date: 01/01/2020
ms.custom: mvc
ms.openlocfilehash: 1d327f558806e0205540c183c56b92ba31e33cb7
ms.sourcegitcommit: f0f73c51441aeb04a5c21a6e3205b7f520f8b0e1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2020
ms.locfileid: "77031226"
---
# <a name="prepare-for-assessment-and-migration-of-hyper-v-vms-to-azure"></a>Подготовка виртуальных машин Hyper-V к оценке и переносу в Azure

Из этой статьи можно узнать, как выполнить подготовку для оценки и миграции локальных виртуальных машин Hyper-V в Azure с помощью службы [Миграция Azure](migrate-services-overview.md).

Служба [Миграция Azure](migrate-overview.md) объединяет в себе инструменты, которые используются для поиска, оценки и переноса приложений, инфраструктуры и рабочих нагрузок в Microsoft Azure. Она включает в себя инструменты Миграции Azure и предложения независимых поставщиков программного обеспечения.

Это руководство является первым в серии, в которой показано, как оценивать и переносить виртуальные машины Hyper-V в Azure. В этом руководстве описано следующее:

> [!div class="checklist"]
> * Подготовьте Azure. Настройка разрешений для своей учетной записи Azure и ресурсов для работы с Миграцией Azure.
> * Подготовьте локальные хосты Hyper-V и виртуальные машины для оценки сервера. Вы можете подготовиться с помощью скрипта конфигурации или вручную.
> * Подготовка к развертыванию устройства службы "Миграция Azure". Устройство используется для обнаружения и оценки локальных виртуальных машин.
> * Подготовьте локальные хосты Hyper-V и виртуальные машины для миграции сервера.


> [!NOTE]
> В руководствах показан простейший путь развертывания сценария, использование которого позволяет быстро настроить проверку концепции. В руководствах по возможности используются параметры по умолчанию и показаны не все возможные параметры и пути. Для получения подробных инструкций ознакомьтесь со статьей о выполнении оценки и миграции Hyper-V.


Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.


## <a name="prepare-azure"></a>Подготовка Azure

### <a name="azure-permissions"></a>Разрешения Azure

Вам необходимо настроить разрешения для развертывания службы "Миграция Azure".

**Задача** | **Разрешения**
--- | ---
**Создание проекта службы "Миграция Azure"** | Учетная запись Azure должна иметь разрешения на создание проекта.
**Регистрация устройства службы "Миграция Azure"** | Служба "Миграция Azure" использует упрощенное устройство для обнаружения и оценки виртуальных машин Hyper-V с помощью средства "Миграция Azure: оценка сервера". Это устройство обнаруживает виртуальные машины и инициирует отправку метаданных и данных производительности виртуальной машины в службу "Миграция Azure".<br/><br/>Когда вы регистрируете устройство, в выбранной для устройства подписке регистрируются следующие поставщики ресурсов: Microsoft.OffAzure, Microsoft.Migrate и Microsoft.KeyVault. Регистрация поставщика ресурсов настраивает подписку для работы с поставщиком ресурсов. Для регистрации поставщиков ресурсов требуется роль участника или владельца в подписке.<br/><br/> В процессе подключения служба "Миграция Azure" создает приложение Azure Active Directory (Azure AD).<br/> Приложение Azure AD используется для обмена данными (проверка подлинности и авторизация) между агентами, работающими на устройстве, с соответствующими службами, которые выполняются в Azure. У этого приложения нет разрешений на выполнение вызовов ARM или получение доступа RBAC к любому ресурсу.



### <a name="assign-permissions-to-create-project"></a>Назначение разрешений для создания проекта

Убедитесь, что у вас есть разрешения на создание приложений проекта Миграции Azure.

1. На портале Azure откройте подписку, а затем выберите **Управление доступом (IAM)** .
2. В разделе **Проверить доступ** найдите соответствующую учетную запись и щелкните ее, чтобы просмотреть разрешения.
3. Вы должны обладать разрешениями уровня **Участник** или **Владелец**.
    - Если вы создали бесплатную учетную запись Azure, вы являетесь владельцем подписки.
    - Если вы не являетесь владельцем подписки, назначьте эту роль совместно с владельцем.


### <a name="assign-permissions-to-register-the-appliance"></a>Назначение разрешений для регистрации устройства

Во время регистрации устройства вы можете назначить службе "Миграция Azure" разрешения для создания приложений Azure AD одним из следующих способов:

- Администратор клиента и глобальный администратор могут предоставлять разрешения пользователям в клиенте для создания и регистрации приложений Azure AD.
- Администратор клиента и глобальный администратор могут назначить роль разработчика приложений (которая уже имеет нужные разрешения).

> [!NOTE]
> - У приложения нет других разрешений на доступ к подписке, помимо описанных выше.
> - Эти разрешения требуются только для регистрации нового устройства. После настройки устройства разрешения можно удалить.


#### <a name="grant-account-permissions"></a>Предоставление разрешений учетной записи

Администратор клиента и глобальный администратор могут предоставить разрешения, выполнив следующие действия:

1. В Azure AD глобальному администратору или администратору клиента нужно перейти в раздел **Azure Active Directory** > **Пользователи** > **Параметры пользователей**.
2. Затем для параметра **Регистрация приложений** нужно выбрать вариант **Да**.

    ![Разрешения Azure AD](./media/tutorial-prepare-hyper-v/aad.png)

> [!NOTE]
> Это значение по умолчанию, которое разрешает выполнять регистрацию. [Подробнее](https://docs.microsoft.com/azure/active-directory/develop/active-directory-how-applications-are-added#who-has-permission-to-add-applications-to-my-azure-ad-instance).



#### <a name="assign-application-developer-role"></a>Назначение роли разработчика приложения

Администратор клиента и глобальный администратор могут назначить учетной записи роль разработчика приложений. [Подробнее](https://docs.microsoft.com/azure/active-directory/fundamentals/active-directory-users-assign-role-azure-portal).


## <a name="prepare-hyper-v-for-assessment"></a>Подготовка Hyper-V к оценке

Вы можете подготовить Hyper-V для оценки виртуальных машин вручную или с помощью скрипта конфигурации. Здесь перечислено средства, которые необходимо подготовить с помощью скрипта или [вручную](#prepare-hyper-v-manually).

- [Проверьте](migrate-support-matrix-hyper-v.md#hyper-v-host-requirements) параметры узла Hyper-V и убедитесь, что на узлах Hyper-V открыты [необходимые порты](migrate-support-matrix-hyper-v.md#port-access).
- Настройте удаленное подключение PowerShell на каждом узле, чтобы устройство, используемое для Миграции Azure, могло выполнять команды PowerShell на узле с помощью подключения WinRM.
- Делегирование учетных данных, если диски виртуальной машины находятся на удаленных общих папках SMB.
- Настройте учетную запись, которую устройство будет использовать для обнаружения виртуальных машин на узлах Hyper-V.
- На каждой виртуальной машине, которую вы хотите обнаружить и оценить, включите Hyper-V Integration Services.



## <a name="prepare-with-a-script"></a>Подготовка с помощью сценария

Сценарий выполняет следующее:

- Проверяется, используете ли вы скрипт в поддерживаемой версии PowerShell.
- Проверяется, имеет ли пользователь, запускающий скрипт, права администратора на узле Hyper-V.
- Позволяет создать локальную учетную запись пользователя (не администратора), которая используется для взаимодействия службы "Миграция Azure" с узлом Hyper-V. Эта учетная запись пользователя добавляется в такие группы на узле:
    - пользователи удаленного управления;
    - администраторы Hyper-V;
    - пользователи системного монитора.
- Проверяется, выполняется ли на узле поддерживаемая версия и роль Hyper-V.
- На узле включается служба WinRM и открываются порты 5985 (HTTP) и 5986 (HTTPS) (требуется для сбора метаданных).
- Включается удаленное взаимодействие PowerShell на узле.
- Проверяется, включена ли служба интеграции Hyper-V на всех виртуальных машинах, управляемых узлом.
- При необходимости на узле включается CredSSP.

Выполните скрипт следующим образом:

1. Убедитесь, что на узле Hyper-V установлен PowerShell версии 4.0 или более поздней.
2. Скачайте скрипт из [Центра загрузки Майкрософт](https://aka.ms/migrate/script/hyperv). Скрипт криптографически подписывается корпорацией Майкрософт.
3. Проверьте целостность скрипта с помощью хэш-файлов MD5 или SHA256. Значения хэша указаны ниже. Выполните следующую команду, чтобы создать хэш для скрипта.
    ```
    C:\>CertUtil -HashFile <file_location> [Hashing Algorithm]
    ```
    Пример использования:
    ```
    C:\>CertUtil -HashFile C:\Users\Administrators\Desktop\ MicrosoftAzureMigrate-Hyper-V.ps1
    SHA256
    ```

4.  После проверки целостности скрипта запустите его на каждом узле Hyper-V с помощью следующей команды PowerShell:
    ```
    PS C:\Users\Administrators\Desktop> MicrosoftAzureMigrate-Hyper-V.ps1
    ```

### <a name="hashtag-values"></a>Значения хэша

Хэш-значениями являются:

| **Хэш** | **Значение** |
| --- | --- |
| **MD5** | 0ef418f31915d01f896ac42a80dc414e |
| **SHA256** | 0ad60e7299925eff4d1ae9f1c7db485dc9316ef45b0964148a3c07c80761ade2 |


## <a name="prepare-hyper-v-manually"></a>Подготовка узлов Hyper-V вручную

Выполните процедуры, описанные в этом разделе, чтобы подготовить Hyper-V вручную, без использования скрипта.

### <a name="verify-powershell-version"></a>Проверка версии PowerShell

Убедитесь, что на узле Hyper-V установлен PowerShell версии 4.0 или более поздней.



### <a name="set-up-an-account-for-vm-discovery"></a>Настройка учетной записи для обнаружения виртуальной машины

Миграции Azure необходимы разрешения для обнаружения локальных виртуальных машин.

- Настройте учетную запись домена или локального пользователя с правами администратора на узлах и в кластере Hyper-V.

    - Вам нужна единая учетная запись для всех узлов и кластеров, которые вы хотите включить в обнаружение.
    - Учетная запись может быть локальной или доменной. Мы советуем, чтобы учетной записи были назначены разрешения администратора на узлах или кластерах Hyper-V.
    - Кроме того, если вы не хотите назначать права администратора, необходимы следующие разрешения:
        - пользователи удаленного управления;
        - администраторы Hyper-V;
        - пользователи системного монитора.

### <a name="verify-hyper-v-host-settings"></a>Проверьте настройки узла Hyper-V

1. Проверьте [требования к узлу Hyper-V](migrate-support-matrix-hyper-v.md#hyper-v-host-requirements) для оценки сервера.
2. Убедитесь, что [необходимые порты](migrate-support-matrix-hyper-v.md#port-access) открыты на узлах Hyper-V.

### <a name="enable-powershell-remoting-on-hosts"></a>Включение удаленного взаимодействия PowerShell на узлах

Настройте удаленное взаимодействие PowerShell на каждом узле следующим образом:

1. На каждом узле откройте консоль PowerShell от имени администратора.
2. Выполните следующую команду:

    ```
    Enable-PSRemoting -force
    ```
### <a name="enable-integration-services-on-vms"></a>Включение Integration Services на виртуальных машинах

Integration Services должны быть включены на каждой виртуальной машине, чтобы Миграция Azure могла собирать информацию об операционной системе на виртуальной машине.

На виртуальных машинах, которые вы хотите обнаружить и оценить, включите [Hyper-V Integration Services](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-integration-services) на каждой виртуальной машине.


### <a name="enable-credssp-on-hosts"></a>Включение CredSSP на узлах

Если на узле есть виртуальные машины с дисками, расположенными на общих ресурсах SMB, выполните этот шаг на узле.

- Вы можете запустить эту команду удаленно на всех узлах Hyper-V.
- Если вы добавляете новые главные узлы в кластер, они автоматически добавляются для обнаружения, но вам необходимо вручную включить CredSSP на новых узлах, если это необходимо.

Включите шифрование, как показано ниже.

1. Определите узлы Hyper-V, на которых выполняются виртуальные машины Hyper-V с дисками на общих ресурсах SMB.
2. Выполните следующую команду на каждом указанном узле Hyper-V:

    ```
    Enable-WSManCredSSP -Role Server -Force
    ```

При настройке устройства вы закончите настройку шифрования CredSSP, [включив его на устройстве.](tutorial-assess-hyper-v.md#delegate-credentials-for-smb-vhds) Этот процесс описан в следующем учебнике этого цикла.


## <a name="prepare-for-appliance-deployment"></a>Подготовка к развертыванию устройства

Перед настройкой устройства Миграции Azure и началом оценки из следующего руководства вам следует подготовиться к развертыванию устройства.

1. [Проверьте](migrate-appliance.md#appliance---hyper-v) требования к устройству.
2. [Просмотрите](migrate-appliance.md#url-access) URL-адреса Azure, к которым устройству потребуется доступ.
3. Просмотрите данные, собранные устройством во время обнаружения и оценки.
4. [Обратите внимание](migrate-appliance.md#collected-data---hyper-v) на требования доступа к порту для устройства.


## <a name="prepare-for-hyper-v-migration"></a>Подготовка к миграции Hyper-V

1. [Проверьте](migrate-support-matrix-hyper-v-migration.md#hyper-v-hosts) требования к узлу Hyper-V для миграции и URL-адреса Azure, к которым узлам и кластерам Hyper-V необходим доступ для миграции виртуальных машин.
2. [Просмотрите требования](migrate-support-matrix-hyper-v-migration.md#hyper-v-vms) для виртуальных машин Hyper-V, которые вы хотите перенести в Azure.


## <a name="next-steps"></a>Дальнейшие действия

Изучив это руководство, вы:

> [!div class="checklist"]
> * Настроили разрешения для учетной записи Azure.
> * Подготовили виртуальные машины и узлы Hyper-V к оценке и переносу.
> * Подготовили к развертыванию устройство службы "Миграция Azure".

Перейдите к следующему руководству, чтобы создать проект службы "Миграция Azure", развернуть устройство, а также обнаружить и оценить виртуальные машины Hyper-V для миграции в Azure.

> [!div class="nextstepaction"]
> [Оценка виртуальных машин Hyper-V с помощью средства "Оценка сервера" службы "Миграция Azure"](./tutorial-assess-hyper-v.md)
