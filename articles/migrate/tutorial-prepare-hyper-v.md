---
title: Подготовка виртуальных машин Hyper-V к оценке и миграции с помощью службы "Миграция Azure"
description: Узнайте, как подготовить виртуальные машины Hyper-V к оценке и миграции с помощью службы "Миграция Azure".
ms.topic: tutorial
ms.date: 04/15/2020
ms.custom: mvc
ms.openlocfilehash: 5f669de6bd8d767ca7b947fca883187dad9fe29d
ms.sourcegitcommit: 62717591c3ab871365a783b7221851758f4ec9a4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/22/2020
ms.locfileid: "86109626"
---
# <a name="prepare-for-assessment-and-migration-of-hyper-v-vms-to-azure"></a>Подготовка виртуальных машин Hyper-V к оценке и переносу в Azure

Эта статья объясняется, как подготовиться к оценке локальных виртуальных машин Hyper-V с помощью [средства "Оценка серверов" службы "Миграция Azure"](migrate-services-overview.md#azure-migrate-server-assessment-tool) и их миграции в Azure с помощью [средства "Миграция сервера" службы "Миграция Azure"](migrate-services-overview.md#azure-migrate-server-migration-tool).


Это руководство является первым в серии, в которой показано, как оценивать и переносить виртуальные машины Hyper-V в Azure. В этом руководстве описано следующее:

> [!div class="checklist"]
> * подготовка Azure для работы со службой "Миграция Azure";
> * подготовка к оценке виртуальных машин Hyper-V;
> * подготовка к миграции виртуальных машин Hyper-V. 

> [!NOTE]
> В руководствах показан простейший путь развертывания сценария, использование которого позволяет быстро настроить проверку концепции. В руководствах по возможности используются параметры по умолчанию и показаны не все возможные параметры и пути.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.


## <a name="prepare-azure"></a>Подготовка Azure

В таблице перечислены задачи, которые необходимо выполнить в Azure. Инструкции приведены после таблицы.

**Задача** | **Сведения** | **Разрешения**
--- | --- | ---
**Создание проекта службы "Миграция Azure"** | Проект службы "Миграция Azure" обеспечивает централизованное выполнение оркестрации и администрирования процессов оценки и миграции с помощью средств Миграции Azure, других средств корпорации Майкрософт и сторонних предложений. | Учетной записи Azure требуются разрешения участника или владельца в группе ресурсов, в которой находится проект.
**Регистрация устройства** | Служба "Миграция Azure" использует упрощенное устройство для обнаружения и оценки виртуальных машин Hyper-V. [Подробнее](migrate-appliance-architecture.md#appliance-registration). | Чтобы зарегистрировать устройство, учетной записи Azure требуются разрешения участника или владельца для подписки Azure.
**Создание приложения Azure AD** | При регистрации модуля служба "Миграция Azure" создает приложение Azure Active Directory (Azure AD), которое используется для обмена данными между агентами, выполняющимися на устройстве, и службой "Миграция Azure". | Учетная запись Azure должна иметь разрешения на создание приложений Azure AD.
**Создание виртуальной машины** | Вам понадобятся разрешения на создание виртуальной машины в группе ресурсов и в виртуальной сети, а также для записи на управляемый диск Azure. | Учетной записи Azure потребуется роль участника виртуальной машины.


### <a name="assign-permissions-to-create-project"></a>Назначение разрешений для создания проекта

Убедитесь, что у вас есть разрешения на создание приложений проекта Миграции Azure.

1. На портале Azure откройте подписку, а затем выберите **Управление доступом (IAM)** .
2. В разделе **Проверить доступ** найдите соответствующую учетную запись и щелкните ее, чтобы просмотреть разрешения.
3. Вы должны обладать разрешениями уровня **Участник** или **Владелец**.
    - Если вы создали бесплатную учетную запись Azure, вы являетесь владельцем подписки.
    - Если вы не являетесь владельцем подписки, назначьте эту роль совместно с владельцем.


### <a name="assign-permissions-to-create-azure-ad-apps"></a>Присвоение разрешений для создания приложений Azure AD

Во время регистрации устройства вы можете назначить службе "Миграция Azure" разрешения для создания приложений Azure AD одним из следующих способов:

- Администратор клиента и глобальный администратор могут предоставлять разрешения пользователям в клиенте для создания и регистрации приложений Azure AD.
- Администратор клиента и глобальный администратор могут назначить роль разработчика приложений (которая уже имеет нужные разрешения).

> [!NOTE]
> - У приложения нет других разрешений на доступ к подписке, помимо описанных выше.
> - Эти разрешения требуются только для регистрации нового устройства. После настройки устройства разрешения можно удалить.


#### <a name="grant-account-permissions"></a>Предоставление разрешений учетной записи

Администратор клиента и глобальный администратор могут предоставить разрешения, выполнив следующие действия:

1. В Azure AD глобальному администратору или администратору клиента нужно перейти в раздел **Azure Active Directory** > **Пользователи** > **Параметры пользователей**.
2. Затем для параметра **Регистрация приложений** нужно выбрать вариант **Да**.

    ![Разрешения Azure AD](./media/tutorial-prepare-hyper-v/aad.png)

> [!NOTE]
> Это значение по умолчанию, которое разрешает выполнять регистрацию. [Подробнее](../active-directory/develop/active-directory-how-applications-are-added.md#who-has-permission-to-add-applications-to-my-azure-ad-instance).



#### <a name="assign-application-developer-role"></a>Назначение роли разработчика приложения

Администратор клиента и глобальный администратор могут назначить учетной записи роль разработчика приложений. [Подробнее](../active-directory/fundamentals/active-directory-users-assign-role-azure-portal.md).

### <a name="assign-azure-account-permissions"></a>Назначение разрешений учетной записи Azure

Присвойте учетной записи роль участника виртуальной машины, чтобы получить разрешения на следующие действия:

- разрешение на создание виртуальной машины в выбранной группе ресурсов;
- разрешение на создание виртуальной машины в выбранной виртуальной сети;
- разрешение на запись на управляемый диск Azure. 


### <a name="set-up-an-azure-network"></a>Настроить сеть

[Настройте сеть Azure](../virtual-network/manage-virtual-network.md#create-a-virtual-network). Локальные компьютеры реплицируются на управляемые диски Azure. При отработке отказа в Azure для миграции виртуальные машины Azure создаются на этих управляемых дисках и присоединяются к сети Azure, которую вы настроили.


## <a name="prepare-for-assessment"></a>Подготовка к оценке

Вы можете подготовить Hyper-V для оценки виртуальных машин вручную или с помощью скрипта конфигурации. Здесь описаны этапы подготовки. Если для подготовки применяется скрипт, они настраиваются автоматически.

**Step** | **Скрипт** | **Вручную**
--- | --- | ---
**Проверка требований к узлу Hyper-V** | Скрипт проверяет, есть ли на узле поддерживаемая версия и роль Hyper-V.<br/><br/> На узле включается служба WinRM и открываются порты 5985 (HTTP) и 5986 (HTTPS) (требуется для сбора метаданных). | Проверьте [требования к узлу Hyper-V](migrate-support-matrix-hyper-v.md#hyper-v-host-requirements) для оценки сервера.<br/><br/> Убедитесь, что [необходимые порты](migrate-support-matrix-hyper-v.md#port-access) открыты на узлах Hyper-V.
**Проверка версии PowerShell** | Проверяется, используете ли вы скрипт в поддерживаемой версии PowerShell. | Убедитесь, что на узле Hyper-V используется PowerShell версии 4.0 или более поздней.
**Создание учетной записи** | Проверяется, имеет ли пользователь, запускающий скрипт, права администратора на узле Hyper-V.<br/><br/>  Позволяет создать локальную учетную запись пользователя (не администратора), которая используется для взаимодействия службы "Миграция Azure" с узлом Hyper-V. Эта учетная запись пользователя добавляется в такие группы на узле:<br/><br/> – "Пользователи удаленного управления";<br/><br/> – "Администраторы Hyper-V";<br/><br/>– "Пользователи системного монитора". | Настройте учетную запись домена или локального пользователя с правами администратора на узлах и в кластере Hyper-V.<br/><br/> – Вам нужна единая учетная запись для всех узлов и кластеров, которые вы хотите включить в обнаружение.<br/><br/> – Учетная запись может быть локальной или доменной. Мы советуем, чтобы учетной записи были назначены разрешения администратора на узлах или кластерах Hyper-V.<br/><br/> Кроме того, если вы не хотите назначать права администратора, необходимы следующие разрешения: "Пользователи удаленного управления", "Администраторы Hyper-V" и "Пользователи системного монитора".
**Включение удаленного взаимодействия PowerShell** | Включает на узле удаленное взаимодействия PowerShell, чтобы устройство, используемое для службы "Миграция Azure", могло выполнять команды PowerShell на узле с помощью подключения WinRM.| Для настройки откройте на каждом узле консоль PowerShell с правами администратора и выполните следующую команду:<br/><br/>``` Enable-PSRemoting -force ```
**Настройка служб интеграции Hyper-V** | Проверяется, включены ли службы Integration Services Hyper-V на всех виртуальных машинах, управляемых узлом. |  [Включите службы интеграции Hyper-V](/windows-server/virtualization/hyper-v/manage/manage-hyper-v-integration-services) на каждой виртуальной машине.<br/><br/> Если вы используете Windows Server 2003, [выполните эти инструкции](prepare-windows-server-2003-migration.md).
**Делегирование учетных данных, если диски виртуальной машины находятся в удаленных общих папках SMB** | Скрипт делегирует учетные данные. | [Включите CredSSP](#enable-credssp-to-delegate-credentials), чтобы делегировать учетные данные.

### <a name="run-the-script"></a>Выполнение скрипта

Выполните скрипт следующим образом:

1. Убедитесь, что на узле Hyper-V установлен PowerShell версии 4.0 или более поздней.
2. Скачайте скрипт из [Центра загрузки Майкрософт](https://aka.ms/migrate/script/hyperv). Скрипт криптографически подписывается корпорацией Майкрософт.
3. Проверьте целостность скрипта с помощью хэш-файлов MD5 или SHA256. Значения хэша указаны ниже. Выполните следующую команду, чтобы создать хэш для скрипта.
    ```
    C:\>CertUtil -HashFile <file_location> [Hashing Algorithm]
    ```
    Пример использования:
    ```
    C:\>CertUtil -HashFile C:\Users\Administrators\Desktop\ MicrosoftAzureMigrate-Hyper-V.ps1 SHA256
    ```

4. После проверки целостности скрипта запустите его на каждом узле Hyper-V с помощью следующей команды PowerShell:
    ```
    PS C:\Users\Administrators\Desktop> MicrosoftAzureMigrate-Hyper-V.ps1
    ```

#### <a name="hashtag-values"></a>Значения хэша

Хэш-значениями являются:

| **Хэш** | **Значение** |
| --- | --- |
| **MD5** | 0ef418f31915d01f896ac42a80dc414e |
| **SHA256** | 0ad60e7299925eff4d1ae9f1c7db485dc9316ef45b0964148a3c07c80761ade2 |



### <a name="enable-credssp-to-delegate-credentials"></a>Включите CredSSP, чтобы делегировать учетные данные.

Если на узле есть виртуальные машины с дисками, расположенными на общих ресурсах SMB, выполните этот шаг на узле.

- Вы можете запустить эту команду удаленно на всех узлах Hyper-V.
- Если вы добавляете новые главные узлы в кластер, они автоматически добавляются для обнаружения, но вам необходимо вручную включить CredSSP на новых узлах, если это необходимо.

Включите шифрование, как показано ниже.

1. Определите узлы Hyper-V, на которых выполняются виртуальные машины Hyper-V с дисками на общих ресурсах SMB.
2. Выполните следующую команду на каждом указанном узле Hyper-V:

    ```
    Enable-WSManCredSSP -Role Server -Force
    ```

При настройке устройства вы закончите настройку шифрования CredSSP, [включив его на устройстве.](tutorial-assess-hyper-v.md#delegate-credentials-for-smb-vhds) Этот процесс описан в следующем учебнике этого цикла.


## <a name="prepare-for-appliance-deployment"></a>Подготовка к развертыванию устройства

Перед настройкой устройства Миграции Azure и началом оценки из следующего руководства вам следует подготовиться к развертыванию устройства.

1. [Проверьте](migrate-appliance.md#appliance---hyper-v) требования к устройству.
2. Проверьте URL-адреса Azure, к которым модуль будет обращаться в [общедоступных](migrate-appliance.md#public-cloud-urls) облаках и облаках для [государственных организаций](migrate-appliance.md#government-cloud-urls). Если вы используете брандмауэр или прокси-сервер на основе URL-адресов, убедитесь, что он разрешает доступ к нужным URL-адресам.
3. Просмотрите данные, собранные устройством во время обнаружения и оценки.
4. [Просмотрите](migrate-appliance.md#collected-data---hyper-v) требования доступа к порту для устройства.


## <a name="prepare-for-hyper-v-migration"></a>Подготовка к миграции Hyper-V

1. [Проверьте](migrate-support-matrix-hyper-v-migration.md#hyper-v-host-requirements) требования к узлу Hyper-V для миграции и URL-адреса Azure, к которым узлам и кластерам Hyper-V необходим доступ для миграции виртуальных машин.
2. [Просмотрите требования](migrate-support-matrix-hyper-v-migration.md#hyper-v-vms) для виртуальных машин Hyper-V, которые вы хотите перенести в Azure.
3. Прежде чем переносить виртуальные машины в Azure, необходимо внести в них некоторые изменения.
    - Важно внести эти изменения до начала миграции. Если вы перенесете виртуальную машину до внесения изменений, она может не загрузиться в Azure.
    - Просмотрите сведения об изменениях для [Windows](prepare-for-migration.md#windows-machines) и [Linux](prepare-for-migration.md#linux-machines), которые необходимо внести.



## <a name="next-steps"></a>Дальнейшие действия

Изучив это руководство, вы:

> [!div class="checklist"]
> * Настроили разрешения для учетной записи Azure.
> * Подготовили виртуальные машины и узлы Hyper-V к оценке и переносу.
> * Подготовили к развертыванию устройство службы "Миграция Azure".

Перейдите к следующему руководству, чтобы создать проект службы "Миграция Azure", развернуть устройство, а также обнаружить и оценить виртуальные машины Hyper-V для миграции в Azure.

> [!div class="nextstepaction"]
> [Оценка виртуальных машин Hyper-V с помощью средства "Оценка сервера" службы "Миграция Azure"](./tutorial-assess-hyper-v.md)
