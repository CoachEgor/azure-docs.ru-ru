---
title: Миграция виртуальных машин VMware с помощью средства "Миграция сервера" службы "Миграция Azure" без агента
description: Узнайте, как выполнить миграцию виртуальных машин VMware с помощью службы "Миграция Azure" без агента.
author: rayne-wiselman
ms.service: azure-migrate
ms.topic: tutorial
ms.date: 11/19/2019
ms.author: raynew
ms.custom: mvc
ms.openlocfilehash: 2b4aad83abc92170df5a7e7cfa7f7751b49b3424
ms.sourcegitcommit: 8e31a82c6da2ee8dafa58ea58ca4a7dd3ceb6132
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/19/2019
ms.locfileid: "74196415"
---
# <a name="migrate-vmware-vms-to-azure-agentless"></a>Миграция виртуальных машин VMware в Azure (без агента)

В этой статье показано, как перенести локальные виртуальные машины VMware в Azure с помощью средства "Миграция сервера" службы "Миграция Azure" без агента.

Служба [Миграция Azure](migrate-services-overview.md) предоставляет центральный концентратор для наблюдения за обнаружением, оценкой и миграцией локальных приложений и рабочих нагрузок, а также экземпляров виртуальных машин AWS/GCP в Azure. Эта служба предоставляет инструменты для оценки и миграции, а также предложения сторонних независимых поставщиков программного обеспечения (ISV).

Это руководство является третьим в серии, в которой показано, как оценивать и переносить VMware в Azure с помощью средств "Оценка сервера" и "Миграция сервера" службы "Миграция Azure". Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Подготовка виртуальных машин к миграции.
> * Добавление средства "Миграция сервера" службы "Миграция Azure".
> * Обнаружение виртуальных машин, которые требуется перенести.
> * Запуск репликации виртуальных машин.
> * Выполнение тестовой миграции, позволяющей убедиться в правильной работе всех компонентов.
> * Выполнение полной миграции виртуальной машины.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.

## <a name="migration-methods"></a>Способы миграции

Вы можете перенести виртуальные машины VMware в Azure с помощью средства "Миграция сервера" службы "Миграция Azure". Это средство предлагает несколько вариантов миграции виртуальных машин VMware:

- Миграция с использованием безагентной репликации. Миграция виртуальных машин без необходимости установки каких-либо компонентов.
- Миграция с агентом для репликации. Установите агент на виртуальную машины для репликации.

Чтобы решить, хотите ли вы использовать миграцию без агентов или на основе агента, просмотрите следующие статьи:

- [Узнайте](server-migrate-overview.md), как работает безагентная миграция, и [сравните методы миграции](server-migrate-overview.md#compare-migration-methods).
- [Прочтите эту статью](tutorial-migrate-vmware-agent.md), если вы хотите использовать метод на основе агента.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством вам потребуется:

1. [Завершите работу с первым руководством](tutorial-prepare-vmware.md) из этой серии, чтобы настроить Azure и VMware для миграции. Для работы с этим руководством вам потребуется следующее:
    - [Подготовка Azure](tutorial-prepare-vmware.md#prepare-azure) к миграции.
    - [Подготовка локальной среды](tutorial-prepare-vmware.md#prepare-for-agentless-vmware-migration) к миграции.
    
2. Мы советуем оценить виртуальные машины VMware с помощью средства "Миграция серверов" службы "Миграция Azure", прежде чем перенести их в Azure. Чтобы выполнить оценку, [завершите работу со вторым руководством](tutorial-assess-vmware.md) из этой серии. Если вы не хотите оценивать виртуальные машины, вы можете пропустить это руководство. Хотя мы рекомендуем опробовать оценку, не нужно выполнять ее перед миграцией виртуальных машин.



## <a name="add-the-azure-migrate-server-migration-tool"></a>Добавление средства "Миграция сервера" службы "Миграция Azure"

Если вы не следовали второму руководству для оценки виртуальных машин VMware, [следуйте этим инструкциям](how-to-add-tool-first-time.md), чтобы настроить проект службы "Миграция Azure" и выбрать средство "Миграция сервера" службы "Миграция Azure" в проект. 

Если вы следовали второму руководству и уже настроили проект службы "Миграция Azure", добавьте средство "Миграция сервера" службы "Миграция Azure" следующим образом:

1. В проекте службы "Миграция Azure" щелкните **Обзор**. 
2. В разделе **Discover, assess, and migration servers** (Обнаружение, оценка и миграция серверов) щелкните **Оценка и миграция серверов**.

     ![Оценка и перенос серверов](./media/tutorial-migrate-vmware/assess-migrate.png)

3. В области **Migration tools** (Средства миграции) выберите **Click here to add a migration tool when you are ready to migrate** (Щелкните здесь, чтобы добавить средство миграции, когда будете готовы к миграции).

    ![Выбор средства](./media/tutorial-migrate-vmware/select-migration-tool.png)

4. В списке средств выберите **Azure Migrate: Server Migration** > **Add tool** (Миграция Azure: миграция сервера > Добавить средство)

    ![Средство миграции сервера](./media/tutorial-migrate-vmware/server-migration-tool.png)

## <a name="set-up-the-azure-migrate-appliance"></a>Настройка устройства службы "Миграция Azure"

Средство "Миграция сервера" службы "Миграция Azure" запускает упрощенное устройство виртуальной машины VMware. Это устройство выполняет обнаружение виртуальных машин и инициирует отправку метаданных и данных о производительности в средство "Миграция сервера" службы "Миграция Azure". Это же устройство также используется средством оценки сервера службы "Миграция Azure".

Если вы следовали второму руководству по оценке виртуальных машин VMware, вы уже настроили устройство в ходе работы с ним. Если вы не следовали инструкциям из этого руководства, необходимо настроить устройство сейчас. Для этого необходимо сделать следующее: 

- Скачайте файл шаблона OVA и импортируйте его в vCenter Server.
- Создайте устройство и убедитесь, что оно может подключиться к средству оценки сервера в службе "Миграция Azure". 
- Настройте устройство в первый раз и зарегистрируйте его в проекте службы "Миграция Azure".

Для настройки устройства следуйте инструкциям из [этой статьи](how-to-set-up-appliance-vmware.md).


## <a name="prepare-vms-for-migration"></a>Подготовка виртуальных машин к миграции.

Для переноса виртуальных машин с помощью Миграции Azure в Azure требуются некоторые изменения.

- В некоторых операционных системах Миграция Azure вносит эти изменения автоматически. [Подробнее](migrate-support-matrix-vmware.md#agentless-migration-vmware-vm-requirements)
- Если вы выполняете миграцию виртуальной машины без одной из этих операционных систем, следуйте инструкциям для подготовки виртуальной машины.
- Важно внести эти изменения до начала миграции. Если вы перенесете виртуальную машину до внесения изменений, она может не загрузиться в Azure.
- Изменения конфигурации, которые вы вносите в локальные виртуальные машины, реплицируются в Azure после включения репликации для виртуальной машины. Чтобы обеспечить репликацию изменений, убедитесь, что точка восстановления, в которую вы выполняете перенос, имеет более позднюю дату, чем время, когда изменения конфигурации были сделаны локально.


### <a name="prepare-windows-server-vms"></a>Подготовка виртуальных машин Windows Server

**Действие** | **Дополнительные сведения** | **Указания**
--- | --- | ---
Убедитесь, что тома Windows в виртуальной машине Azure используют те же назначения букв дисков, что и на локальной виртуальной машине. | Для политики SAN выберите значение "Перевод всего в состояние «в сети»". | 1. Войдите в виртуальную машину с помощью учетной записи администратора и откройте командное окно.<br/> 2. Введите **diskpart** для запуска служебной программы Diskpart.<br/> 3. Введите **SAN POLICY=OnlineAll**<br/> 4. Введите Exit, чтобы выйти из Diskpart, и закройте командную строку.
Включение консоли последовательного доступа Azure для виртуальной машины Azure | Это помогает при устранении неполадок. Перезагружать виртуальную машину не нужно. Виртуальная машина Azure будет загружаться с использованием образа диска, что эквивалентно перезагрузке новой виртуальной машины. | Чтобы включить, следуйте [этим инструкциям](https://docs.microsoft.com/azure/virtual-machines/windows/serial-console).
Установка гостевой интеграции Hyper-V | Если вы переносите машины под управлением Windows Server 2003, установите Hyper-V Guest Integration Services в операционной системе виртуальной машины. | [Узнайте больше](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-integration-services#install-or-update-integration-services).
Удаленный рабочий стол | Включите удаленный рабочий стол на виртуальной машине и убедитесь, что брандмауэр Windows не блокирует доступ к удаленному рабочему столу ни в одном сетевом профиле. | [Узнайте больше](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/clients/remote-desktop-allow-access).

### <a name="prepare-linux-vms"></a>Создание виртуальных машин Linux

**Действие** | **Дополнительные сведения** 
--- | --- | ---
Установка Hyper-V Linux Integration Services | В большинстве новых версий дистрибутивов Linux это включено по умолчанию.
Пересоздание образа инициализации Linux, чтобы он содержал необходимые драйверы Hyper-V | Это гарантирует, что виртуальная машина будет загружаться в Azure, и требуется только в некоторых дистрибутивах.
Включение ведения журнала последовательной консоли Azure | Это помогает при устранении неполадок. Перезагружать виртуальную машину не нужно. Виртуальная машина Azure будет загружаться с использованием образа диска, что эквивалентно перезагрузке новой виртуальной машины.<br/> Чтобы включить, следуйте [этим инструкциям](https://docs.microsoft.com/azure/virtual-machines/linux/serial-console).
Обновление файла карты устройств | Обновите файл сопоставления устройств с именем устройства для сопоставлений томов, чтобы использовать постоянные идентификаторы устройств.
Обновление записи в FSTAB-файле | Обновите записи, чтобы использовать постоянные идентификаторы томов.
Удаление правила udev | Удалите все правила udev, которые резервируют имена интерфейсов на основе MAC-адресов и т. д.
Обновление сетевых интерфейсов | Обновите сетевые интерфейсы для получения IP-адреса на основе DHCP.
Включение SSH | Убедитесь, что SSH включен и служба sshd настроена на автоматический запуск при перезагрузке.<br/> Убедитесь, что входящие запросы на SSH-соединения не заблокированы брандмауэром ОС или правилами сценариев.

[Ознакомьтесь с этой статьей](https://docs.microsoft.com/azure/virtual-machines/linux/create-upload-generic), в которой обсуждаются эти шаги для запуска виртуальной машины Linux в Azure и содержатся инструкции для некоторых популярных дистрибутивов Linux.  


## <a name="replicate-vms"></a>Репликация виртуальных машин

По завершении обнаружения можно начать репликацию виртуальных машин VMware в Azure. 

> [!NOTE]
> Можно реплицировать до 10 виртуальных машин за раз. Если требуется реплицировать большее число виртуальных машин, выполните одновременную репликацию в пакетах из 10 машин. При миграции без агента можно одновременно запустить до 100 репликаций.

1. В проекте службы "Миграция Azure" щелкните **Серверы** и в разделе **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) выберите **Репликация**.

    ![Репликация виртуальных машин](./media/tutorial-migrate-vmware/select-replicate.png)

2. В разделе **Реплицировать** выберите **Параметры исходного кода** > **Ваши компьютеры виртуализированы?** и **Yes, with VMware vSphere Hypervisor** (Да, с помощью гипервизора VMware vSphere).
3. В разделе **Локальное устройство** выберите имя устройства Миграции Azure, которое вы настроили, и нажмите кнопку **ОК**. 

    ![Параметры источника](./media/tutorial-migrate-vmware/source-settings.png)

    - Этот шаг предполагает, что вы уже настроили устройство, когда завершили работу с руководством.
    - Если вы еще не настроили устройство, следуйте инструкциям в [этой статье](how-to-set-up-appliance-vmware.md).

4. В разделе **Виртуальные машины** выберите виртуальные машины, которые необходимо реплицировать.
    - Если вы выполнили оценку для виртуальных машин, вы можете применить рекомендации по выбору размера виртуальной машины и типу диска ("Премиум" или "Стандарт") из результатов оценки. Для этого в поле **Импортировать параметры миграции из средства оценки Миграции Azure?** выберите вариант **Да**.
    - Если вы не проводили оценку или не хотите использовать параметры оценки, выберите вариант **Нет**.
    - Если вы решили использовать оценку, выберите группу виртуальных машин и имя оценки.

    ![Выбор оценки](./media/tutorial-migrate-vmware/select-assessment.png)

5. В разделе **Виртуальные машины** найдите виртуальные машины и отметьте каждую виртуальную машину, которую вы хотите перенести. Выберите **Next: Целевые параметры**.

    ![Выбор виртуальных машин](./media/tutorial-migrate-vmware/select-vms.png)

6. В разделе **Целевые параметры** выберите подписку и целевой регион, в который вы хотите выполнить миграцию, а также укажите группу ресурсов, в которой будут находиться виртуальные машины Azure после миграции. В разделе **Виртуальная сеть** выберите виртуальную сеть или подсеть Azure, к которой будут подключены виртуальные машины Azure после миграции.
7. Для параметра **Преимущество гибридного использования Azure**

    - выберите вариант **Нет**, если вы не хотите применять Преимущество гибридного использования Azure. Нажмите кнопку **Далее**.
    - Выберите вариант **Да**, если у вас есть компьютеры с Windows Server, на которые распространяются активные подписки Software Assurance или Windows Server, и вы хотите применить это преимущество к компьютерам, которые вы переносите. Нажмите кнопку **Далее**.

    ![Целевые параметры](./media/tutorial-migrate-vmware/target-settings.png)

8. В разделе **Вычисления** просмотрите имя виртуальной машины, размер, тип диска ОС и группу доступности. Виртуальные машины должны соответствовать [требованиям Azure](migrate-support-matrix-vmware.md#agentless-migration-vmware-vm-requirements).

    - **Размер виртуальной машины**. Если вы используете рекомендации по оценке, раскрывающийся список размеров виртуальных машин будет содержать рекомендуемый размер. В противном случае Миграция Azure выбирает размер в зависимости от ближайшего совпадения в подписке Azure. В качестве альтернативы выберите размер вручную в разделе **Размер виртуальной машины Azure**. 
    - **Диск ОС**: Укажите загрузочный диск ОС для виртуальной машины. Диск ОС — это диск с загрузчиком операционной системы и установщиком. 
    - **Группа доступности**. Если виртуальная машина должна находиться в группе доступности Azure после миграции, укажите эту группу. Группа должна находиться в целевой группе ресурсов, которую вы указываете для миграции.

    ![Параметры вычисления виртуальной машины](./media/tutorial-migrate-vmware/compute-settings.png)

9. В разделе **Диски** укажите, следует ли реплицировать диски виртуальных машин в Azure, и выберите тип диска (SSD или HDD (цен. категория "Стандартный") или управляемые диски (цен. категория "Премиум")) в Azure. Нажмите кнопку **Далее**.
    - Диски можно исключить из репликации.
    - Если вы исключите диски, они не будут присутствовать на виртуальной машине Azure после миграции. 

    ![Диски](./media/tutorial-migrate-vmware/disks.png)

10. В разделе **Review and start replication** (Просмотр и запуск репликации) просмотрите параметры и нажмите кнопку **Реплицировать**, чтобы начать первоначальную репликацию серверов.

> [!NOTE]
> Вы можете обновить параметры репликации в любое время до начала репликации в разделе **Управление** > **Репликация компьютеров**. Настройки невозможно изменить после начала репликации.

### <a name="provisioning-for-the-first-time"></a>Подготовка выполняется впервые

Если это первая виртуальная машина, которую вы реплицируете в проекте Миграции Azure, средство "Миграция сервера" службы "Миграция Azure" автоматически выделяет эти ресурсы в той же группе ресурсов, что и проект.

- **Служебная шина** Средство "Миграция сервера" службы "Миграция Azure" использует служебную шину для отправки сообщений оркестровки репликации на устройство.
- **Учетная запись хранения шлюза**. Миграция сервера использует учетную запись шлюза для хранения информации о состоянии реплицируемых виртуальных машин.
- **Учетная запись хранения журналов**. Устройство Миграции Azure загружает журналы репликации для виртуальных машин в учетную запись хранения журналов. Миграция Azure применяет сведения о репликации к управляемым дискам реплики.
- **Хранилище ключей**. Устройство Миграции Azure использует хранилище ключей для управления строками подключения для служебной шины и ключами доступа для учетных записей хранения, используемых при репликации. Вы должны были установить разрешения, необходимые хранилищу ключей для доступа к учетной записи хранения, на этапе подготовки. [Проверьте эти разрешения](tutorial-prepare-vmware.md#assign-role-assignment-permissions).   


## <a name="track-and-monitor"></a>Отслеживание и мониторинг


- Когда вы нажимаете кнопку **Реплицировать**, выполняется задание "Запуск репликации". 
- После успешного завершения задания "Запуск репликации" компьютеры начинают первоначальную репликацию в Azure.
- Во время начальной репликации создается снимок виртуальной машины. Дисковые данные из моментального снимка реплицируются в управляемые диски реплики в Azure.
- После завершения начальной репликации начинается разностная репликация. Добавочные изменения локальных дисков периодически реплицируются на диски реплики в Azure.

Отслеживать состояние задания можно в уведомлениях портала.

Вы можете отслеживать состояние репликации, щелкнув **Репликация серверов** в разделе **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера).
![Мониторинг репликации](./media/tutorial-migrate-vmware/replicating-servers.png)




## <a name="run-a-test-migration"></a>Выполнение тестовой миграции


Когда начинается разностная репликация, вы можете запустить тестовую миграцию для виртуальных машин перед выполнением полной миграции в Azure. Мы настоятельно рекомендуем сделать это хотя бы один раз для каждой машины перед ее миграцией.

- Запуск тестовой миграции позволяет проверить, что миграция будет работать должным образом, не затрагивая локальные машины, которые остаются работоспособными и продолжают репликацию. 
- Тестовая миграция моделирует миграцию путем создания виртуальной машины Azure с использованием реплицированных данных (обычно выполняется миграция в нерабочую виртуальную сеть в вашей подписке Azure).
- Вы можете использовать реплицированную тестовую виртуальную машину Azure для проверки миграции, выполнения тестирования приложений и решения любых проблем перед полной миграцией.

Выполните тестовую миграцию следующим образом:


1. Последовательно выберите разделы **Цели миграции** > **Серверы** > **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) щелкните **Тестовая миграция серверов выполнена**.

     ![Тестовая миграция серверов](./media/tutorial-migrate-vmware/test-migrated-servers.png)

2. Щелкните правой кнопкой мыши виртуальную машину, чтобы выполнить тест, и выберите **Тестовая миграция**.

    ![Тестовая миграция](./media/tutorial-migrate-vmware/test-migrate.png)

3. В разделе **Тестовая миграция** выберите виртуальную сеть Azure, в которой будет находиться виртуальная машина Azure после миграции. Мы рекомендуем использовать нерабочую виртуальную сеть.
4. Запустится задание **Тестовая миграция**. Отслеживайте задание и уведомления на портале.
5. После завершения миграции просмотрите перенастроенную виртуальную машину Azure в разделе **Виртуальные машины** на портале Azure. Имя машины содержит суффикс **-Test**.
6. После завершения теста щелкните правой кнопкой мыши виртуальную машину Azure в разделе **Репликация компьютеров** и выберите **Очистка тестовой миграции**.

    ![Очистка миграции](./media/tutorial-migrate-vmware/clean-up.png)


## <a name="migrate-vms"></a>Перенос виртуальных машин

Убедившись, что тестовая миграция работает должным образом, вы можете выполнить миграцию локальных компьютеров.

1. В проекте "Миграция Azure" щелкните **Серверы** > **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) и выберите **Репликация серверов**.

    ![Репликация серверов](./media/tutorial-migrate-vmware/replicate-servers.png)

2. В области **Репликация компьютеров** щелкните правой кнопкой мыши виртуальную машину и выберите **Миграция**.
3. В разделе **Миграция** > **Shut down virtual machines and perform a planned migration with no data loss** (Завершить работу виртуальных машин и выполнить запланированную миграцию без потери данных?) выберите вариант **Да** > **ОК**.
    - По умолчанию Миграция Azure выключает локальную виртуальную машину и запускает репликацию по требованию для синхронизации любых изменений виртуальной машины, которые произошли с момента последней репликации. Это гарантирует отсутствие потери данных.
    - Если вы не хотите выключать виртуальную машину, выберите вариант **Нет**.
4. Запустится задание миграции виртуальной машины. Отслеживайте задание в уведомлениях Azure.
5. После завершения работы вы можете просматривать виртуальную машину и управлять ею на странице **Виртуальные машины**.

## <a name="complete-the-migration"></a>Выполнение миграции

1. После завершения миграции щелкните правой кнопкой мыши виртуальную машину и выберите **Stop migration** (Остановка миграции). Это останавливает репликацию для локального компьютера и очищает информацию о состоянии репликации виртуальной машины.
2. Установите агент виртуальной машины Azure для [Windows](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-windows) или [Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux) на перенесенных компьютерах.
3. Выполните любые действия по настройке после миграции приложения, такие как обновление строк подключения к базе данных и конфигурация веб-сервера.
4. Выполните приемочное тестирование конечного приложения и миграции на перенесенном приложении, работающем в Azure.
5. Остановите трафик для перенесенного экземпляра виртуальной машины Azure.
6. Удалите локальные виртуальные машины из списка локальных виртуальных машин.
7. Удалите локальные виртуальные машины из локальных заданий резервного копирования.
8. Обновите внутренние документы и отразите в них новое расположение и IP-адреса виртуальных машин Azure. 

## <a name="post-migration-best-practices"></a>Рекомендации, выполняемые после миграции

- Для повышения устойчивости:
    - Обеспечьте безопасность данных путем резервного копирования виртуальных машин Azure с помощью службы Azure Backup. [Узнайте больше](../backup/quick-backup-vm-portal.md).
    - Обеспечьте непрерывную работу и постоянную доступность рабочих нагрузок за счет репликации виртуальных машин Azure в дополнительный регион с помощью Site Recovery. [Узнайте больше](../site-recovery/azure-to-azure-tutorial-enable-replication.md).
- Для повышения уровня безопасности:
    - Заблокируйте и ограничьте доступ входящего трафика с помощью [JIT-администрирования](https://docs.microsoft.com/azure/security-center/security-center-just-in-time) центра безопасности Azure.
    - Ограничьте сетевой трафик конечными точками с помощью [групп безопасности сети](https://docs.microsoft.com/azure/virtual-network/security-overview).
    - Разверните [шифрование дисков Azure](https://docs.microsoft.com/azure/security/azure-security-disk-encryption-overview), чтобы обеспечить безопасность дисков и защитить данные от кражи и несанкционированного доступа.
    - Ознакомьтесь с дополнительными сведениями о [защите ресурсов IaaS](https://azure.microsoft.com/services/virtual-machines/secure-well-managed-iaas/) и посетите [центр безопасности Azure](https://azure.microsoft.com/services/security-center/).
- Для мониторинга и управления:
-  Рассмотрите возможность развертывания [службы "Управление затратами Azure"](https://docs.microsoft.com/azure/cost-management/overview) для мониторинга использования ресурсов и затрат.


## <a name="next-steps"></a>Дополнительная информация

Проанализируйте процесс [миграции в облако](https://docs.microsoft.com/azure/architecture/cloud-adoption/getting-started/migrate) в Azure Cloud Adoption Framework.
