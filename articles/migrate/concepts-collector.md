---
title: Сведения о модуле сборщика в службе "Миграция Azure" | Документация Майкрософт
description: В этой статье объясняется, как использовать модуль сборщика в службе "Миграция Azure".
author: snehaamicrosoft
ms.service: azure-migrate
ms.topic: conceptual
ms.date: 04/26/2019
ms.author: snehaa
services: azure-migrate
ms.openlocfilehash: d00899e0ca358b4e2970caa8c63c98e375ea970c
ms.sourcegitcommit: 44a85a2ed288f484cc3cdf71d9b51bc0be64cc33
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64728023"
---
# <a name="about-the-collector-appliance"></a>Сведения о модуле сборщика

 Данная статья содержит информацию о Сборщике Миграции Azure.

Сборщик Миграции Azure — это простой модуль, который можно использовать для обнаружения локального окружения vCenter для оценки с помощью службы [Миграция Azure](migrate-overview.md) перед миграцией в Azure.  

## <a name="discovery-method"></a>Метод обнаружения

Ранее существовало два метода модуля сборщика: однократное и непрерывное обнаружение. Модель однократного обнаружения теперь устарела, так как она использовала параметры статистики vCenter Server для сбора данных о производительности (для параметров статистики требовался уровень 3), а также собирала средние значения счетчиков (вместо пиковых значений), что приводило к уменьшению размера. Модель непрерывного обнаружения обеспечивает сбор подробных данных и приводит к точному определению размеров благодаря сбору пиковых значений счетчика. Ниже приведен принцип работы:

Модуль сборщика непрерывно подключен к проекту службы "Миграция Azure" и непрерывно собирает данные о производительности виртуальных машин.

- Сборщик постоянно профилирует локальную среду для сбора данных об использовании в режиме реального времени каждые 20 секунд.
- Модуль загружает 20-секундные образцы и создает одну точку данных каждые 15 минут.
- Чтобы создать точку данных, модуль выбирает пиковое значение из 20-секундных образцов и отправляет его в Azure.
- Эта модель не зависит от параметров статистики сервера vCenter Server для сбора данных о производительности.
- Вы можете остановить непрерывное профилирование в любое время в Сборщике.

**Быстрые оценки.** после завершения обнаружения (оно занимает несколько часов в зависимости от количества виртуальных машин) с помощью устройства непрерывного обнаружения можно сразу же создать оценки. Так как сбор данных производительности начинается с момента запуска обнаружения, если вам нужны быстрые оценки, следует выбрать условие определения размера в оценке как *локальное*. Для оценки на основе производительности рекомендуется после запуска обнаружения подождать по крайней мере один день, чтобы получить рекомендации по выбору надежного размера.

Модуль только непрерывно собирает данные о производительности. Он не обнаруживает изменения конфигурации в локальной среде (например, добавление, удаление виртуальной машины, добавление диска и т. д.). Если в локальной среде была изменена конфигурация и вам нужно отразить эти изменения на портале, сделайте следующее:

- Добавление элементов (виртуальных машин, дисков, ядер и т. д.). Чтобы отразить эти изменения на портале Azure, вы можете остановить обнаружение с модуля, а затем запустить его снова. Это позволит обновить изменения в проекте "Миграция Azure".

- Удаление виртуальных машин. Из-за особенностей конструкции модуля удаление виртуальных машин не отражается даже при остановке и повторном запуске обнаружения. Это связано с тем, что данные из последующих обнаружений добавляются к более старым обнаружениям, а не переопределяются. В этом случае вы можете просто игнорировать виртуальную машину на портале, удалив ее из своей группы и пересчитав оценку.

> [!NOTE]
> Устройство однократного обнаружения не рекомендуют использовать, поскольку этот метод полагался на параметры статистик vCenter Server для доступности точки данных производительности и собранных средних счетчиков производительности, которые привели к превышению размера виртуальных машин для миграции в Azure.

## <a name="deploying-the-collector"></a>Развертывание Сборщика

Модуль сборщика развертывается с использованием шаблона OVF:

- Скачайте шаблон OVF из проекта "Миграция Azure" на портале Azure. Импортируйте скачанный файл на сервер vCenter Server, чтобы настроить виртуальную машину модуля сборщика.
- Из файла OVF VMware настраивает виртуальную машину с 8 ядрами, 16 ГБ ОЗУ и 1 диском размером 80 ГБ. Используется ОС Windows Server 2016 (64-разрядная версия).
- При запуске Сборщика для проверки возможности подключения к службе "Миграция Azure" выполняется ряд предварительных проверок.

- [Дополнительные сведения](tutorial-assessment-vmware.md#create-the-collector-vm) о создании Сборщика.


## <a name="collector-prerequisites"></a>Предварительные требования для Сборщика

Сборщик должен пройти несколько проверок предварительных требований, чтобы он мог подключиться к службе "Миграция Azure" по Интернету и отправлять обнаруженные данные.

- **Проверка облака Azure.** Сборщик должен иметь сведения об облаке Azure, в которое вы планируете выполнить миграцию.
    - Выберите Azure для государственных организаций, если вы планируете перейти на использование облака Azure для государственных организаций.
    - Выберите глобальную инфраструктуру Azure, если вы планируете перейти на использование коммерческого облака Azure.
    - На основе указанного облака устройство отправит обнаруженные метаданные в соответствующие конечные точки.
- **Проверка подключения к Интернету.** Сборщик может подключиться к Интернету напрямую или через прокси-сервер.
    - Проверяется подключение к [обязательным и необязательным URL-адресам](#urls-for-connectivity).
    - Если у вас есть прямое подключение к Интернету, никаких конкретных действий не требуется — только проверка того, что Сборщик может подключиться к требуемым URL-адресам.
    - В случае подключения через прокси-сервер обратите внимание на приведенные ниже требования.
- **Проверка синхронизации времени.** Сборщик нужно синхронизировать с сервером времени в Интернете, чтобы обеспечить проверку подлинности запросов к службе.
    - Чтобы проверить время, URL-адрес portal.azure.com должен быть доступен для сборщика.
    - Если виртуальная машина не синхронизирована, измените время на виртуальной машине со Сборщиком в соответствии с текущим временем. Чтобы проверить часовой пояс, откройте командную строку с правами администратора на этой виртуальной машине и выполните команду **w32tm /tz**. Чтобы синхронизировать время, выполните команду **w32tm /resync**.
- **Проверка выполнения службы сборщика.**  Служба "Сборщик Миграции Azure" должна быть запущена на виртуальной машине Сборщика.
    - Служба запускается автоматически после загрузки виртуальной машины.
    - Если служба не запущена, запустите ее с помощью панели управления.
    - Служба сборщика отвечает за подключение к серверу vCenter Server, сбор метаданных и данных о производительности виртуальной машины и их отправку в службу "Миграция Azure".
- **Проверка установки VMware PowerCLI 6.5.** Чтобы Сборщик мог обмениваться данными с сервером vCenter Server, нужно установить модуль PowerShell VMware PowerCLI 6.5.
    - Если Сборщик может получить доступ к URL-адресам, необходимым для установки модуля, модуль устанавливается автоматически во время развертывания Сборщика.
    - В противном случае вам придется установить модуль вручную.
- **Проверка подключения к vCenter Server.** Сборщик должен быть подключен к vCenter Server c возможностью отправлять запросы к виртуальным машинам (запрашивать их метаданные и данные счетчиков производительности). [Проверьте предварительные требования](#connect-to-vcenter-server) для подключения.


### <a name="connect-to-the-internet-via-a-proxy"></a>Подключение к Интернету через прокси-сервер

- Если для прокси-сервера требуется аутентификация, можно указать имя пользователя и пароль при настройке Сборщика.
- IP адрес или полное ДОМЕННОЕ имя прокси-сервера должен быть указан как *http:\//IPaddress* или *http:\//FQDN*.
- Поддерживается только прокси-сервер HTTP. Сборщик не поддерживает прокси-серверы на основе HTTPS.
- Если прокси-сервер является перехватчиком, необходимо импортировать его сертификат на виртуальную машину со Сборщиком.
  1. В виртуальной машине со Сборщиком перейдите в меню **Пуск** > **Управление сертификатами компьютеров**.
  2. В средстве "Сертификаты" в разделе **Сертификаты — локальный компьютер** найдите **Доверенные издатели** > **Сертификаты**.

      ![Средство "Сертификаты"](./media/concepts-intercepting-proxy/certificates-tool.png)

  3. Скопируйте сертификат прокси-сервера в виртуальную машину со Сборщиком. Вам может потребоваться получить его от сетевого администратора.
  4. Дважды щелкните сертификат и нажмите кнопку **Установить сертификат**.
  5. В мастере импорта сертификатов для параметра "Расположение хранилища" выберите **Локальный компьютер**.

     ![Расположение хранилища сертификатов](./media/concepts-intercepting-proxy/certificate-store-location.png)

  6. Выберите **Поместить все сертификаты в следующее хранилище** > **Обзор** > **Доверенные издатели**. Нажмите кнопку **Готово** , чтобы импортировать сертификат.

     ![Хранилище сертификатов](./media/concepts-intercepting-proxy/certificate-store.png)

  7. Убедитесь, что сертификат импортирован, как и ожидалось, и проверьте, что предварительная проверка подключения к Интернету выполнена должным образом.


### <a name="urls-for-connectivity"></a>URL-адреса для подключения

Проверка подключения производится с помощью подключения к URL-адресам из списка.

**URL-адрес** | **Дополнительные сведения**  | **Проверка предварительных требований**
--- | --- | ---
*.portal.azure.com | Применимо к глобальной инфраструктуре Azure. Проверяется возможность подключения со службой Azure и синхронизация времени. | Проверьте доступ к нужному URL-адресу.<br/><br/> Если подключение отсутствует, проверка завершается ошибкой.
*.portal.azure.us | Применимо только к Azure для государственных организаций. Проверяется возможность подключения со службой Azure и синхронизация времени. | Проверьте доступ к нужному URL-адресу.<br/><br/> Если подключение отсутствует, проверка завершается ошибкой.
*.oneget.org:443<br/><br/> *.windows.net:443<br/><br/> *.windowsazure.com:443<br/><br/> *.powershellgallery.com:443<br/><br/> *.msecnd.net:443<br/><br/> *.visualstudio.com:443| Необходимо загрузить модуль PowerCLI vCenter на основе PowerShell. | Необходим доступ к URL-адреса.<br/><br/> Проверка предварительных требований не завершится сбоем.<br/><br/> Автоматическая установка модуля на виртуальную машину со Сборщиком завершится сбоем. Необходимо вручную установить модуль на компьютере, подключенном к Интернету, а затем скопируйте модули к устройству. [Дополнительные сведения, перейдя к шагу 4 этого руководства по устранению неполадок](https://docs.microsoft.com/azure/migrate/troubleshooting-general#error-unhandledexception-internal-error-occurred-systemiofilenotfoundexception).


### <a name="install-vmware-powercli-module-manually"></a>Установка модуля VMware PowerCLI вручную

1. Установите модуль, используя [эти шаги](https://blogs.vmware.com/PowerCLI/2017/04/powercli-install-process-powershell-gallery.html). В этих шагах описывается установка в сетевом и автономном режимах.
2. Если виртуальная машина со Сборщиком находится в автономном режиме и модуль устанавливается на другой компьютер с доступом в Интернет, необходимо скопировать файлы VMware.* с этого компьютера на виртуальную машину со Сборщиком.
3. После установки вы можете перезапустить предварительные проверки, чтобы подтвердить, что PowerCLI установлен.

### <a name="connect-to-vcenter-server"></a>Подключение к vCenter Server

Сборщик подключается к vCenter Server и запрашивает метаданные виртуальной машины и счетчики производительности. Вот что нужно для этого подключения:

- Поддерживается vCenter Server версий 5.5, 6.0, 6.5 и 6.7.
- Для обнаружения вам нужна учетная запись только для чтения с разрешениями, приведенными ниже. Для обнаружения можно получить доступ только к тем центрам обработки данных, которые доступны в рамках этой учетной записи.
- По умолчанию к vCenter Server можно подключиться с помощью полного доменного имени или IP-адреса. Если vCenter Server прослушивает другой порт, можно подключиться к нему, используя формат *IP-адрес:номер_порта* или *FQDN:номер_порта*.
- Для сборщика требуется сеть, по которой он сможет напрямую подключаться к серверу vCenter.

#### <a name="account-permissions"></a>Разрешения учетной записи

**Учетная запись.** | **Разрешения**
--- | ---
Учетная запись пользователя с правами только для чтения (минимум) | Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only   


## <a name="collector-communications"></a>Обмен данными, выполняемый Сборщиком

Сборщик обменивается данными, как показано на следующей схеме и описано в таблице.

![Схема связей сборщика](./media/tutorial-assessment-vmware/portdiagram.PNG)


**С чем взаимодействует Сборщик** | **Порт** | **Дополнительные сведения**
--- | --- | ---
со службой Миграция Azure | TCP 443 | Сборщик взаимодействует со службой "Миграция Azure" через порт 443 по протоколу SSL.
с сервером vCenter | TCP 443 | Сборщик должен иметь возможность взаимодействовать с сервером vCenter.<br/><br/> По умолчанию он подключается к vCenter через порт 443.<br/><br/> Если vCenter Server ожидает передачи данных на другом порте, на Сборщике этот порт должен быть доступен как исходящий.
RDP | TCP 3389 |

## <a name="collected-metadata"></a>Собранные метаданные

> [!NOTE]
> Метаданные, обнаруживаемые "Миграция Azure" помогут вам выбрать правильный объем приложений при их переносе в Azure, используется модуль сборщика выполнять анализ пригодности для Azure, анализ зависимостей приложения и планирование затрат. Корпорация Майкрософт использует эти данные по отношению к любому аудиту соответствия лицензии.

Модуль сборщика обнаруживает следующие метаданные конфигурации для каждой виртуальной машины. Данные конфигурации для виртуальных машин станут доступны в течение часа после запуска обнаружения.

- Отображаемое имя виртуальной машины (в vCenter Server).
- Путь инвентаризации виртуальной машины (узел или папка на сервере vCenter Server).
- IP-адрес
- MAC-адрес.
- Операционная система
- Число ядер, дисков и сетевых адаптеров.
- Объем памяти, размеры диска.
- Счетчики производительности виртуальной машины, диска и сети.

### <a name="performance-counters"></a>Счетчики производительности

 Устройство сборщика собирает следующие счетчики производительности для каждой виртуальной машины из узла ESXi с интервалом в 20 секунд. Это счетчики vCenter, и, хотя в терминологии сообщается среднее значение, 20-секундные выборки являются счетчиками в режиме реального времени. Данные о производительности виртуальных машин становятся доступны на портале через два часа после запуска обнаружения. Настоятельно советуем подождать по крайней мере один день, прежде чем создавать оценки производительности для получения точных рекомендаций по выбору правильного размера. Если требуется мгновенное вознаграждение, вы можете создать оценку с критерием определения размера *Как в локальной среде*, который не будет учитывать данные производительности для определения нужного размера.

**Счетчик** |  **Влияние на оценку**
--- | ---
cpu.usage.average | Рекомендуемый размер и стоимость виртуальной машины  
mem.usage.average | Рекомендуемый размер и стоимость виртуальной машины  
virtualDisk.read.average | Вычисляет размер диска, затраты на хранение и размер виртуальной машины
virtualDisk.write.average | Вычисляет размер диска, затраты на хранение и размер виртуальной машины
virtualDisk.numberReadAveraged.average | Вычисляет размер диска, затраты на хранение и размер виртуальной машины
virtualDisk.numberWriteAveraged.average | Вычисляет размер диска, затраты на хранение и размер виртуальной машины
net.received.average | Вычисляет размер виртуальной машины                          
net.transmitted.average | Вычисляет размер виртуальной машины     

Ниже приведен полный список счетчиков VMware, собранных службой "Миграция Azure".

**Категория** |  **Metadata** | **Точка данных vCenter**
--- | --- | ---
Сведения о компьютере | Идентификатор виртуальной машины | vm.Config.InstanceUuid
Сведения о компьютере | имя виртуальной машины; | vm.Config.Name
Сведения о компьютере | Идентификатор vCenter Server | VMwareClient.InstanceUuid
Сведения о компьютере |  Описание виртуальной машины |  vm.Summary.Config.Annotation
Сведения о компьютере | Имя продукта лицензии | vm.Client.ServiceContent.About.LicenseProductName
Сведения о компьютере | Тип операционной системы | vm.Summary.Config.GuestFullName
Сведения о компьютере | Версия операционной системы | vm.Summary.Config.GuestFullName
Сведения о компьютере | Тип загрузки | vm.Config.Firmware
Сведения о компьютере | Число ядер | vm.Config.Hardware.NumCPU
Сведения о компьютере | Объем памяти, мегабайт | vm.Config.Hardware.MemoryMB
Сведения о компьютере | Количество дисков | vm.Config.Hardware.Device.ToList().FindAll(x => x is VirtualDisk).count
Сведения о компьютере | Список размеров диска | vm.Config.Hardware.Device.ToList().FindAll(x => x is VirtualDisk)
Сведения о компьютере | Список сетевых адаптеров | vm.Config.Hardware.Device.ToList().FindAll(x => x is VirtualEthernetCard)
Сведения о компьютере | загрузка ЦП; | cpu.usage.average
Сведения о компьютере | Использование памяти | mem.usage.average
Сведения о дисках (на диск) | Значение ключа диска | disk.Key
Сведения о дисках (на диск) | Номер диска | disk.UnitNumber
Сведения о дисках (на диск) | Значение ключа контроллера диска | disk.ControllerKey.Value
Сведения о дисках (на диск) | Подготовленных гигабайт | virtualDisk.DeviceInfo.Summary
Сведения о дисках (на диск) | Имя диска | Это значение создается с использованием disk.UnitNumber, disk.Key и disk.ControllerKey.Value
Сведения о дисках (на диск) | Число операций чтения в секунду | virtualDisk.numberReadAveraged.average
Сведения о дисках (на диск) | Число операций записи в секунду | virtualDisk.numberWriteAveraged.average
Сведения о дисках (на диск) | Пропускная способность при чтении (мегабайт в секунду) | virtualDisk.read.average
Сведения о дисках (на диск) | Пропускная способность при записи (мегабайт в секунду) | virtualDisk.write.average
Сведения о сетевом адаптере (для каждого экземпляра) | Имя сетевого адаптера | nic.Key
Сведения о сетевом адаптере (для каждого экземпляра) | MAC-адрес | ((VirtualEthernetCard)nic).MacAddress
Сведения о сетевом адаптере (для каждого экземпляра) | IPv4-адреса | vm.Guest.Net
Сведения о сетевом адаптере (для каждого экземпляра) | IPv6-адреса | vm.Guest.Net
Сведения о сетевом адаптере (для каждого экземпляра) | Пропускная способность при чтении (мегабайт в секунду) | net.received.average
Сведения о сетевом адаптере (для каждого экземпляра) | Пропускная способность при записи (мегабайт в секунду) | net.transmitted.average
Подробности о пути инвентаризации | ИМЯ | container.GetType().Name
Подробности о пути инвентаризации | Тип дочернего объекта | container.ChildType
Подробности о пути инвентаризации | Справочные сведения | container.MoRef
Подробности о пути инвентаризации | Полный путь инвентаризации | container.Name с полным путем
Подробности о пути инвентаризации | Сведения о родительском объекте | Container.Parent
Подробности о пути инвентаризации | Сведения о папке для каждой виртуальной машины | ((Folder)container).ChildEntity.Type
Подробности о пути инвентаризации | Сведения о центре обработки данных для папки каждой виртуальной машины | ((Datacenter)container).VmFolder
Подробности о пути инвентаризации | Сведения о центре обработки данных для папки каждого узла | ((Datacenter)container).HostFolder
Подробности о пути инвентаризации | Сведения о кластере для каждого узла | ((ClusterComputeResource)container).Host)
Подробности о пути инвентаризации | Сведения об узле для каждой виртуальной машины | ((HostSystem)container).Vm


## <a name="securing-the-collector-appliance"></a>Обеспечение безопасности модуля сборщика

Рекомендуем выполнить описанные ниже действия для защиты модуля сборщика.

- Не предоставляйте пароли администратора неавторизованным лицам и не помещайте такие пароли в ненадлежащих расположениях.
- Завершайте работу модуля, когда он не используется.
- Подключите модуль к защищенной сети.
- По завершении миграции удалите экземпляр модуля.
- Кроме того, не забудьте также удалить резервные копии дисков (VMDK), так как на дисках могут храниться кэшированные учетные данные vCenter.

## <a name="os-license-in-the-collector-vm"></a>Лицензия ОС на виртуальной машине со Сборщиком

Сборщик данных поставляется с лицензией Windows Server 2016 evaluation, который действителен в течение 180 дней. Если срок действия ознакомительного периода для виртуальной машины со Сборщиком истекает, рекомендуется скачать новый OVA-файл и создать новый модуль.

## <a name="updating-the-os-of-the-collector-vm"></a>Обновление операционной системы на виртуальной машине со Сборщиком

Несмотря на то что модуль сборщика имеет лицензию на пробное использование в течение 180 дней, вам нужно постоянно обновлять ОС в модуле, чтобы избежать автоматического завершения его работы.

- Если Сборщик не обновляется в течение 60 дней, он запускает автоматическое завершение работы компьютера.
- Если выполняется обнаружение, компьютер не будет отключен, даже если прошло 60 дней. Когда задание обнаружения будет завершено, компьютер отключится.
- Если Сборщик используется более 60 дней, рекомендуем постоянно поддерживать компьютер в обновленном состоянии, запуская средство обновления Windows.

## <a name="upgrading-the-collector-appliance-version"></a>Обновление версии модуля сборщика

Сборщик можно обновить до последней версии, не скачивая OVA-файл повторно.

1. Скачайте [пакет обновления](concepts-collector-upgrade.md) последней версии.
2. Чтобы обеспечить защиту скачиваемых исправлений, откройте командное окно от имени администратора и выполните указанную ниже команду для создания хэша ZIP-файла. Созданный хэш должен совпадать с хэшем, предусмотренным для определенной версии:

    ```C:\>CertUtil -HashFile <file_location> [Hashing Algorithm]```

    (Пример использования: C:\>CertUtil -HashFile C:\AzureMigrate\CollectorUpdate_release_1.0.9.14.zip SHA256.)
3. Скопируйте ZIP-файл на виртуальную машину сборщика службы "Миграция Azure" (модуль сборщика).
4. Щелкните ZIP-файл правой кнопкой мыши и выберите "Извлечь все".
5. Щелкните файл Setup.ps1 правой кнопкой мыши и выберите Run with PowerShell (Запуск с помощью PowerShell), а затем следуйте инструкциям на экране, чтобы установить обновление.

## <a name="discovery-process"></a>Процесс обнаружения

После настройки модуля можно запустить обнаружение. Вот как это работает:

- Запускайте обнаружение по областям. Будут обнаружены все виртуальные машины в указанном пути инвентаризации vCenter.
    - Одновременно задавайте только одну область.
    - Область может включать в себя 1500 виртуальных машин или меньше.
    - Областью может быть центр обработки данных, папка или узел ESXi.
- После соединения с vCenter Server можно подключиться, указав проект миграции для сбора.
- Виртуальные машины обнаруживаются, а их метаданные и данные о производительности отправляются в Azure. Эти действия являются частью задания сбора.
    - Модулю сборщика предоставляется определенный идентификатор, который сохраняется для отдельной машины во всех обнаружениях.
    - Выполняемому заданию коллекции присваивается идентификатор конкретного сеанса. Идентификатор изменяется для каждого задания сбора и может использоваться для устранения неполадок.

## <a name="next-steps"></a>Дальнейшие действия

[Настройка оценки локальных виртуальных машин VMware](tutorial-assessment-vmware.md)
