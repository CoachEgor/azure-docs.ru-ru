---
title: Настройка анализа зависимостей без агента в службе "миграция Azure — Оценка сервера"
description: Настройка анализа зависимостей без агента в службе "миграция Azure" для оценки серверов.
author: rashi-ms
ms.author: rajosh
ms.manager: abhemraj
ms.topic: how-to
ms.date: 6/08/2020
ms.openlocfilehash: d84c85326c6f5d87189a2c24a3b13654f157cb05
ms.sourcegitcommit: ea551dad8d870ddcc0fee4423026f51bf4532e19
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/07/2020
ms.locfileid: "96754289"
---
# <a name="analyze-machine-dependencies-agentless"></a>Анализ зависимостей компьютера (без агентов)

В этой статье описывается, как настроить анализ зависимостей без агента в службе "миграция Azure": Оценка сервера. [Анализ зависимостей](concepts-dependency-visualization.md) помогает определить и понять зависимости между компьютерами для оценки и миграции в Azure.


> [!IMPORTANT]
> Визуализация зависимостей без агента сейчас доступна в предварительной версии для виртуальных машин VMware, обнаруженных с помощью средства "миграция Azure": Серверная оценка.
> Возможности могут быть ограничены или неполными.
> Эта предварительная версия охватывается службой поддержки клиентов и может использоваться для рабочих нагрузок.
> Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="current-limitations"></a>Текущие ограничения

- В представлении "анализ зависимостей" в настоящее время невозможно добавить или удалить сервер из группы.
- Схема зависимостей для группы серверов в настоящее время недоступна.
- В проекте службы "миграция Azure" сбор данных о зависимостях можно настроить параллельно для серверов 1000. Можно проанализировать большее количество серверов путем виртуализации в пакетах 1000.

## <a name="before-you-start"></a>Перед началом работы

- [Ознакомьтесь](migrate-support-matrix-vmware.md#dependency-analysis-requirements-agentless) с поддерживаемыми операционными системами и необходимыми разрешениями.
- Не забудьте выполнить следующие действия.
    - У вас есть проект службы "миграция Azure". Если это не так, [Создайте](./create-manage-projects.md) его сейчас.
    - Убедитесь, что в проект [добавлен](how-to-assess.md) инструмент Azure Migrate: Server для оценки.
    - Настройте [устройство миграции Azure](migrate-appliance.md) для обнаружения локальных компьютеров. [Настройте устройство](how-to-set-up-appliance-vmware.md) для виртуальных машин VMware. Устройство обнаруживает локальные компьютеры и отправляет метаданные и данные производительности в службу "миграция Azure": Оценка сервера.
- Убедитесь, что средства VMware (более поздние версии, чем 10,2) установлены на каждой виртуальной машине, которую необходимо проанализировать.


## <a name="create-a-user-account-for-discovery"></a>Создание учетной записи пользователя для обнаружения

Настройте учетную запись пользователя, чтобы оценка сервера могла получить доступ к виртуальной машине для обнаружения зависимостей. [Сведения](migrate-support-matrix-vmware.md#dependency-analysis-requirements-agentless) о требованиях к учетной записи для виртуальных машин Windows и Linux.


## <a name="add-the-user-account-to-the-appliance"></a>Добавление учетной записи пользователя в устройство

Добавьте учетную запись пользователя в устройство.

1. Откройте приложение управления устройством. 
2. Перейдите на панель **Укажите сведения о vCenter** .
3. В окне **обнаружение приложения и зависимостей на виртуальных машинах** нажмите кнопку **Добавить учетные данные** .
3. Выберите **операционную систему**, укажите понятное имя учетной записи и **User name** / **пароль** пользователя.
6. Нажмите кнопку **Сохранить**.
7. Нажмите кнопку **сохранить и начать обнаружение**.

    ![Добавление учетной записи пользователя виртуальной машины](./media/how-to-create-group-machine-dependencies-agentless/add-vm-credential.png)

## <a name="start-dependency-discovery"></a>Запустить обнаружение зависимостей

Выберите компьютеры, на которых необходимо включить обнаружение зависимостей. 

1. В **службе "миграция Azure": Оценка сервера** щелкните **обнаруженные серверы**.
2. Щелкните значок **анализ зависимостей** .
3. Нажмите кнопку **Добавить серверы**.
4. На странице **Добавление серверов** выберите устройство, которое будет обнаруживать соответствующие компьютеры.
5. В списке компьютер выберите компьютеры.
6. Нажмите кнопку **Добавить серверы**.

    ![Запустить обнаружение зависимостей](./media/how-to-create-group-machine-dependencies-agentless/start-dependency-discovery.png)

Можно визуализировать зависимости около шести часов после запуска обнаружения зависимостей. Если вы хотите включить несколько компьютеров, для этого можно использовать [PowerShell](#start-or-stop-dependency-discovery-using-powershell) .

## <a name="visualize-dependencies"></a>Визуализация зависимостей

1. В **службе "миграция Azure": Оценка сервера** щелкните **обнаруженные серверы**.
2. Найдите компьютер, который вы хотите просмотреть.
3. В столбце **зависимости** щелкните **Просмотр зависимостей** .
4. Измените период времени, для которого необходимо просмотреть карту, с помощью раскрывающегося списка **Длительность времени** .
5. Разверните группу **клиентов** , чтобы получить список компьютеров с зависимостью от выбранной машины.
6. Разверните группу **портов** , чтобы получить список компьютеров, имеющих зависимость от выбранного компьютера.
7. Чтобы перейти к представлению карт зависимых компьютеров, щелкните имя компьютера > **загрузить карту сервера** .

    ![Развертывание группы портов сервера и загрузка схемы сервера](./media/how-to-create-group-machine-dependencies-agentless/load-server-map.png)

    ![Развернуть группу клиентов ](./media/how-to-create-group-machine-dependencies-agentless/expand-client-group.png)

8. Разверните выбранный компьютер, чтобы просмотреть сведения об уровне процесса для каждой зависимости.

    ![Развертывание сервера для отображения процессов](./media/how-to-create-group-machine-dependencies-agentless/expand-server-processes.png)

> [!NOTE]
> Сведения о процессе для зависимости не всегда доступны. Если он недоступен, зависимость отображается с процессом, помеченным как "Неизвестный процесс".

## <a name="export-dependency-data"></a>Экспорт данных зависимостей

1. В **службе "миграция Azure": Оценка сервера** щелкните **обнаруженные серверы**.
2. Щелкните значок **анализ зависимостей** .
3. Нажмите кнопку **Экспорт зависимостей приложений**.
4. На странице **Экспорт зависимостей приложения** выберите устройство, которое будет обнаруживать соответствующие компьютеры.
5. Выберите время начала и время окончания. Обратите внимание, что данные можно загрузить только за последние 30 дней.
6. Щелкните **Экспорт зависимостей**.

Данные зависимостей экспортируются и загружаются в формате CSV. Скачанный файл содержит данные зависимостей на всех компьютерах, включенных для анализа зависимостей. 

![Экспорт зависимостей](./media/how-to-create-group-machine-dependencies-agentless/export.png)

### <a name="dependency-information"></a>Сведения о зависимостях

Каждая строка в экспортированном CSV-файле соответствует зависимости, наблюдаемой в заданном интервале времени. 

В следующей таблице перечислены поля в экспортированном CSV-файле. Обратите внимание, что поля имя сервера, приложение и процесс заполнены только для серверов, для которых включен анализ зависимостей без агента.

**Имя поля** | **Сведения**
--- | --- 
тимеслот | Тимеслот, в течение которого была наблюдаться зависимость. <br/> Данные зависимостей захватываются в течение 6-часового слота.
Имя исходного сервера | Имя исходного компьютера 
Исходное приложение | Имя приложения на исходном компьютере 
Процесс-источник | Имя процесса на исходном компьютере 
Имя целевого сервера | Имя конечного компьютера
Конечный IP-адрес | IP-адрес конечного компьютера
Конечное приложение | Имя приложения на целевом компьютере
Процесс назначения | Имя процесса на целевом компьютере 
Конечный порт | Номер порта на целевом компьютере


## <a name="stop-dependency-discovery"></a>Отключить обнаружение зависимостей

Выберите компьютеры, на которых требуется отключить обнаружение зависимостей. 

1. В **службе "миграция Azure": Оценка сервера** щелкните **обнаруженные серверы**.
2. Щелкните значок **анализ зависимостей** .
3. Нажмите кнопку **удалить серверы**.
3. На странице **Удаление серверов** выберите **устройство** , которое обнаруживает виртуальные машины, на которых вы хотите отключить обнаружение зависимостей.
4. В списке компьютер выберите компьютеры.
5. Нажмите кнопку **удалить серверы**.

Если вы хотите запретить зависимость на нескольких компьютерах, для этого можно использовать [PowerShell](#start-or-stop-dependency-discovery-using-powershell) .


## <a name="start-or-stop-dependency-discovery-using-powershell"></a>Запуск или завершение обнаружения зависимостей с помощью PowerShell

Скачайте модуль PowerShell из репозитория [примеров Azure PowerShell](https://github.com/Azure/azure-docs-powershell-samples/tree/master/azure-migrate/dependencies-at-scale) на сайте GitHub.


### <a name="log-in-to-azure"></a>Вход в Azure

1. Войдите в подписку Azure с помощью командлета Connect-AzAccount.

    ```PowerShell
    Connect-AzAccount
    ```
    При использовании Azure для государственных организаций используйте следующую команду.
    ```PowerShell
    Connect-AzAccount -EnvironmentName AzureUSGovernment
    ```

2. Выберите подписку, в которой был создан проект "миграция Azure" 

    ```PowerShell
    select-azsubscription -subscription "Fabrikam Demo Subscription"
    ```

3. Импорт скачанного модуля PowerShell AzMig_Dependencies

    ```PowerShell
    Import-Module .\AzMig_Dependencies.psm1
    ```

### <a name="enable-or-disable-dependency-data-collection"></a>Включение или отключение сбора данных о зависимостях

1. Получите список обнаруженных виртуальных машин VMware в проекте службы "миграция Azure" с помощью следующих команд. В приведенном ниже примере имя проекта — Фабрикамдемопрожект, а группа ресурсов, к которой он принадлежит, — Фабрикамдеморг. Список компьютеров будет сохранен в FabrikamDemo_VMs.csv

    ```PowerShell
    Get-AzMigDiscoveredVMwareVMs -ResourceGroupName "FabrikamDemoRG" -ProjectName "FabrikamDemoProject" -OutputCsvFile "FabrikamDemo_VMs.csv"
    ```

    В файле можно увидеть отображаемое имя виртуальной машины, текущее состояние коллекции зависимостей и идентификатор ARM для всех обнаруженных виртуальных машин. 

2. Чтобы включить или отключить зависимости, создайте входной CSV-файл. Файл должен иметь столбец с заголовком "ARM ID". Все дополнительные заголовки в CSV-файле будут игнорироваться. Вы можете создать CSV-файл с помощью файла, созданного на предыдущем шаге. Создайте копию файла, в котором будут храниться виртуальные машины, для которых необходимо включить или отключить зависимости. 

    В следующем примере анализ зависимостей включается в списке виртуальных машин во входном файле FabrikamDemo_VMs_Enable.csv.

    ```PowerShell
    Set-AzMigDependencyMappingAgentless -InputCsvFile .\FabrikamDemo_VMs_Enable.csv -Enable
    ```

    В следующем примере анализ зависимостей отключается в списке виртуальных машин во входном файле FabrikamDemo_VMs_Disable.csv.

    ```PowerShell
    Set-AzMigDependencyMappingAgentless -InputCsvFile .\FabrikamDemo_VMs_Disable.csv -Disable
    ```

## <a name="visualize-network-connections-in-power-bi"></a>Визуализация сетевых подключений в Power BI

Служба "миграция Azure" предлагает шаблон Power BI, который можно использовать для визуализации сетевых подключений нескольких серверов одновременно, а также для фильтрации по процессам и серверам. Чтобы визуализировать, загрузите Power BI с данными зависимостей в соответствии с приведенными ниже инструкциями.

1. Скачайте модуль PowerShell и шаблон Power BI из репозитория [примеров Azure PowerShell](https://github.com/Azure/azure-docs-powershell-samples/tree/master/azure-migrate/dependencies-at-scale) на сайте GitHub.

2. Войдите в Azure, выполнив приведенные ниже инструкции. 
- Войдите в подписку Azure с помощью командлета Connect-AzAccount.

    ```PowerShell
    Connect-AzAccount
    ```

- При использовании Azure для государственных организаций используйте следующую команду.

    ```PowerShell
    Connect-AzAccount -EnvironmentName AzureUSGovernment
    ```

- Выберите подписку, в которой был создан проект "миграция Azure" 

    ```PowerShell
    select-azsubscription -subscription "Fabrikam Demo Subscription"
    ```

3. Импорт скачанного модуля PowerShell AzMig_Dependencies

    ```PowerShell
    Import-Module .\AzMig_Dependencies.psm1
    ```

4. Выполните следующую команду. Эта команда скачивает данные зависимостей в CSV-файл и обрабатывает их для создания списка уникальных зависимостей, которые можно использовать для визуализации в Power BI. В примере ниже имя проекта — Фабрикамдемопрожект, а группа ресурсов, к которой он принадлежит, — Фабрикамдеморг. Зависимости будут скачаны для компьютеров, обнаруженных Фабрикамапплианце. Уникальные зависимости будут сохранены в FabrikamDemo_Dependencies.csv

    ```PowerShell
    Get-AzMigDependenciesAgentless -ResourceGroup FabrikamDemoRG -Appliance FabrikamAppliance -ProjectName FabrikamDemoProject -OutputCsvFile "FabrikamDemo_Dependencies.csv"
    ```

5. Открытие скачанного шаблона Power BI

6. Загрузите Скачанные данные зависимостей в Power BI.
    - Откройте шаблон в Power BI.
    - Щелкните **получить данные** на панели инструментов. 
    - Выберите **Text/CSV** из общих источников данных.
    - Выберите скачанный файл зависимостей.
    - Нажмите кнопку **Загрузить**.
    - Вы увидите таблицу, которая импортируется с именем CSV-файла. Таблицу можно увидеть на панели полей справа. Переименуйте его в AzMig_Dependencies
    - Щелкните Обновить на панели инструментов.

    Диаграмма "Сетевые подключения" и имя исходного сервера, имя целевого сервера, имя исходного процесса, срезы имени процесса назначения должны быть освещены с импортированными данными.

7. Визуализировать карту сетевых подключений по серверам и процессам. Сохраните файл.


## <a name="next-steps"></a>Следующие шаги

[Сгруппируйте компьютеры](how-to-create-a-group.md) для оценки.