---
title: Миграция виртуальных машин Hyper-V в Azure с помощью средства "Миграция сервера" в службе "Миграция Azure"
description: Сведения о миграции локальных виртуальных машин Hyper-V в Azure с помощью средства "Миграция сервера" в службе "Миграция Azure"
ms.topic: tutorial
ms.date: 11/18/2019
ms.custom: MVC
ms.openlocfilehash: e1b670db3399857278c646d3793e8ec946d385b0
ms.sourcegitcommit: 8f4d54218f9b3dccc2a701ffcacf608bbcd393a6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2020
ms.locfileid: "78943296"
---
# <a name="migrate-hyper-v-vms-to-azure"></a>Перенос виртуальных машин Hyper-V в Azure 

В этой статье показано, как перенести локальные виртуальные машины Hyper-V в Azure с помощью службы "Миграция Azure" без агента. Миграции Azure.

Служба [Миграция Azure](migrate-services-overview.md) объединяет в себе средства наблюдения за обнаружением, оценкой и миграцией локальных приложений и рабочих нагрузок, а также виртуальных машин частного или общедоступного облака в Azure. Эта служба предоставляет инструменты для оценки и миграции, а также предложения сторонних независимых поставщиков программного обеспечения (ISV).

Это руководство является третьим в серии, в которой показано, как оценивать и переносить Hyper-V в Azure с помощью средств "Оценка сервера" и "Миграция сервера" службы "Миграция Azure". В этом руководстве описано следующее:


> [!div class="checklist"]
> * Подготовка Azure и локальной среды Hyper-V.
> * Настройка исходной среды и развертывание устройства репликации.
> * Настройте целевую среду.
> * Включите репликацию.
> * Выполнение тестовой миграции, позволяющей убедиться в правильной работе всех компонентов.
> * Выполнение полной миграции в Azure.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.


## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством вам потребуется:

1. [Просмотрите](hyper-v-migration-architecture.md) архитектуру миграции Hyper-V.
2. [Ознакомьтесь с первым руководством](tutorial-prepare-hyper-v.md) из этой серии, чтобы настроить Azure и Hyper-V для миграции. Из первого руководства вы узнаете следующее.
    - [Подготовка Azure](tutorial-prepare-hyper-v.md#prepare-azure) к миграции.
    - [Подготовка локальной среды](tutorial-prepare-hyper-v.md#prepare-for-hyper-v-migration) к миграции.
3. Мы рекомендуем попытаться оценить виртуальные машины Hyper-V, используя службу "Миграция Azure": Оценка сервера перед его переносом в Azure. Для этого [ознакомьтесь со вторым руководством](tutorial-assess-hyper-v.md) из этой серии. Хотя мы рекомендуем опробовать оценку, не нужно выполнять оценку перед миграцией виртуальных машин.
4. Убедитесь, что учетной записи Azure назначена роль участника виртуальной машины, что позволит получить:

    - разрешение на создание виртуальной машины в выбранной группе ресурсов;
    - разрешение на создание виртуальной машины в выбранной виртуальной сети;
    - разрешение на запись на управляемый диск Azure.
5. [Настройте сеть Azure](../virtual-network/manage-virtual-network.md#create-a-virtual-network). В процессе миграции в Azure созданные виртуальные машины Azure присоединяются к сети Azure, указанной при настройке миграции.


## <a name="add-the-azure-migrate-server-migration-tool"></a>Добавление средства "Миграция сервера" службы "Миграция Azure"

Если вы не следовали второму руководству для оценки виртуальных машин Hyper-V, [следуйте этим инструкциям](how-to-add-tool-first-time.md), чтобы настроить проект службы "Миграция Azure" и добавить средство миграции сервера Azure в проект.

Если вы следовали второму руководству у вас уже есть проект службы "Миграция Azure", добавьте службу "Миграция Azure": средство миграции сервера следующим образом:

1. В проекте службы "Миграция Azure" щелкните **Обзор**. 
2. В разделе **Discover, assess, and migration servers** (Обнаружение, оценка и миграция серверов) щелкните **Оценка и миграция серверов**.
3. В области **Migration tools** (Средства миграции) выберите **Click here to add a migration tool when you are ready to migrate** (Щелкните здесь, чтобы добавить средство миграции, когда будете готовы к миграции).

    ![Выбор средства](./media/tutorial-migrate-hyper-v/select-migration-tool.png)

4. В списке средств выберите **Azure Migrate: Server Migration** > **Add tool** (Миграция Azure: миграция сервера > Добавить средство)

    ![Средство миграции сервера](./media/tutorial-migrate-hyper-v/server-migration-tool.png)


## <a name="set-up-the-azure-migrate-appliance"></a>Настройка устройства службы "Миграция Azure"

Средство "Миграция сервера" в службе "Миграция Azure" запускает упрощенное устройство виртуальной машины Hyper-V.

- Это устройство выполняет обнаружение виртуальных машин и инициирует отправку метаданных и данных о производительности в средство "Миграция сервера" службы "Миграция Azure".
- Устройство также используется службой "Миграция Azure": средство оценки серверов для миграции виртуальных машин Hyper-V в Azure.

Чтобы настроить устройство, сделайте следующее.
- Если вы следовали второму руководству по оценке виртуальных машин Hyper-V, вы уже настроили устройство в ходе работы с этим руководством и вам не нужно делать это повторно.
- Если вы не следовали инструкциям из этого руководства, необходимо настроить устройство сейчас. Для этого необходимо сделать следующее: 

    - Скачайте сжатый виртуальный жесткий диск Hyper-V с портала Azure.
    - Создайте устройство и убедитесь, что оно может подключиться к средству оценки сервера в службе "Миграция Azure". 
    - Настройте устройство в первый раз и зарегистрируйте его в проекте службы "Миграция Azure".

    Для настройки устройства следуйте подробным инструкциям из [этой статьи](how-to-set-up-appliance-hyper-v.md).

## <a name="prepare-hyper-v-hosts"></a>Подготовка узлов Hyper-V

1. В проекте "Миграция Azure" > **Серверы**, в разделе **Azure Migrate: Server Migration** (Миграция Azure: Миграция сервера), выберите **Обнаружить**.
2. В разделе **Обнаружение компьютеров** > **Ваши компьютеры виртуализированы?** выберите **Yes, with Hyper-V** (Да, с помощью Hyper-V).
3. В поле **Целевой регион** выберите регион Azure, в который необходимо перенести компьютеры.
6. Выберите параметр **Подтвердите, что целевым регионом для миграции является "имя-региона"** .
7. Щелкните **Создать ресурсы**. После этого в фоновом режиме создается хранилище Azure Site Recovery.
    - Если вы уже настроили миграцию с помощью миграции сервера в службе миграции Azure, этот параметр не будет отображаться, так как ресурсы были настроены ранее.
    - После нажатия этой кнопки вы не сможете изменить целевой регион для этого проекта.
    - Все последующие миграции будут выполняться в этот регион.
    
8. В разделе **Prepare Hyper-V host servers** (Подготовка серверов узла Hyper-V) скачайте поставщик репликации Hyper-V и файл ключа регистрации.
    - Ключ регистрации необходим для регистрации узла Hyper-V на сервере Миграции Azure.
    - Ключ действителен в течение пяти дней после создания.

    ![Загрузка поставщика и ключа](./media/tutorial-migrate-hyper-v/download-provider-hyper-v.png)

4. Скопируйте файл установки поставщика и файл ключа регистрации на каждый узел Hyper-V (или узел кластера), на котором запущены виртуальные машины, которые необходимо реплицировать.
5. Запустите файл установки поставщика на каждом узле, как описано ниже.
6. После установки поставщика на узлах в окне **Обнаружение компьютеров** выберите **Finalize registration** (Завершить регистрацию).

    ![Завершение регистрации](./media/tutorial-migrate-hyper-v/finalize-registration.png)

После завершения регистрации может пройти до 15 минут, пока обнаруженные виртуальные машины не отобразятся в сервере миграции Azure. При обнаружении виртуальных машин количество **обнаруженных серверов** увеличивается.

![Обнаруженные серверы](./media/tutorial-migrate-hyper-v/discovered-servers.png)

### <a name="register-hyper-v-hosts"></a>Регистрация узлов Hyper-V

Установите скачанный файл установки (AzureSiteRecoveryProvider.exe) на каждом соответствующем узле Hyper-V.

1. Запустите файл установки поставщика на всех узлах или узлах кластера.
2. В мастере установки поставщика в разделе **Центр обновления Майкрософт** выберите использовать Центр обновления Майкрософт для проверки наличия обновлений поставщика.
3. На странице **Установка** примите расположение установки по умолчанию для поставщика и агента и выберите **Установить**.
4. После установки в мастере регистрации в разделе **Параметры хранилища** выберите **Обзор**, а в поле **Файл ключа** выберите скачанный файл ключа хранилища.
5. В окне **Proxy Settings** (Параметры прокси-сервера) укажите, как поставщик, выполняемый на узле, подключается к Интернету.
    - Если устройство находится вне прокси-сервера, необходимо указать параметры прокси-сервера.
    - Укажите имя прокси-сервера как **http://ip-address** или. **http://FQDN** . Прокси-серверы HTTPS не поддерживаются.
   

6. Убедитесь, что поставщик может получить доступ к [нужным URL-адресам](migrate-support-matrix-hyper-v-migration.md#hyper-v-hosts).
7. В окне **Регистрация** после регистрации узла нажмите кнопку **Готово**.

## <a name="replicate-hyper-v-vms"></a>Репликация виртуальных машин Hyper-V

По завершении обнаружения, вы можете начать репликацию виртуальных машин в Azure.

> [!NOTE]
> Можно реплицировать до 10 виртуальных машин за раз. Если требуется реплицировать большее число виртуальных машин, выполните одновременную репликацию в пакетах из 10 машин.

1. В проекте службы "Миграция Azure" щелкните **Серверы** и в разделе **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) выберите **Репликация**.
2. В разделе **Репликация** выберите **Параметры исходного кода** > **Ваши компьютеры виртуализированы?** выберите **Да, с Hyper-V**. Выберите **Next: Виртуальные машины**.
3. В разделе **Виртуальные машины** выберите виртуальные машины, которые необходимо реплицировать.
    - Если вы выполнили оценку для виртуальных машин, вы можете применить рекомендации по выбору размера виртуальной машины и типу диска ("Премиум" или "Стандарт") из результатов оценки. Для этого в поле **Импортировать параметры миграции из средства оценки Миграции Azure?** выберите вариант **Да**.
    - Если вы не проводили оценку или не хотите использовать параметры оценки, выберите вариант **Нет**.
    - Если вы решили использовать оценку, выберите группу виртуальных машин и имя оценки.

        ![Выбор оценки](./media/tutorial-migrate-hyper-v/select-assessment.png)

4. В разделе **Виртуальные машины** найдите виртуальные машины и отметьте каждую виртуальную машину, которую вы хотите перенести. Затем нажмите **следующее: Целевые параметры**.

    ![Выбор виртуальных машин](./media/tutorial-migrate-hyper-v/select-vms.png)

5. В разделе **Целевые параметры** выберите целевой регион, в который вы хотите выполнить миграцию, подписку, а также группу ресурсов, в которой будут находиться виртуальные машины Azure после миграции.
7. В поле **Учетная запись хранения репликации** выберите учетную запись хранения Azure, в которой будут храниться реплицированные данные в Azure.
8. В разделе **Виртуальная сеть** выберите виртуальную сеть или подсеть Azure, к которой будут подключены виртуальные машины Azure после миграции.
9. Для параметра **Преимущество гибридного использования Azure**

    - выберите вариант **Нет**, если вы не хотите применять Преимущество гибридного использования Azure. Затем щелкните **Далее**.
    - Выберите вариант **Да**, если у вас есть компьютеры с Windows Server, на которые распространяются активные подписки Software Assurance или Windows Server, и вы хотите применить это преимущество к компьютерам, которые вы переносите. Затем нажмите кнопку **Далее**.

    ![Целевые параметры](./media/tutorial-migrate-hyper-v/target-settings.png)

10. В разделе **Вычисления** просмотрите имя виртуальной машины, размер, тип диска ОС и группу доступности. Виртуальные машины должны соответствовать [требованиям Azure](migrate-support-matrix-hyper-v-migration.md#azure-vm-requirements).

    - **Размер виртуальной машины**. Если вы используете рекомендации по оценке, раскрывающийся список размеров виртуальных машин будет содержать рекомендуемый размер. В противном случае Миграция Azure выбирает размер в зависимости от ближайшего совпадения в подписке Azure. В качестве альтернативы выберите размер вручную в разделе **Размер виртуальной машины Azure**. 
    - **Диск ОС**: Укажите загрузочный диск ОС для виртуальной машины. Диск ОС — это диск с загрузчиком операционной системы и установщиком. 
    - **Группа доступности**. Если виртуальная машина должна находиться в группе доступности Azure после миграции, укажите эту группу. Группа должна находиться в целевой группе ресурсов, которую вы указываете для миграции.

    ![Параметры вычисления виртуальной машины](./media/tutorial-migrate-hyper-v/compute-settings.png)

11. В разделе **Диски** укажите, следует ли реплицировать диски виртуальных машин в Azure, и выберите тип диска (SSD или HDD (цен. категория "Стандартный") или управляемые диски (цен. категория "Премиум")) в Azure. Затем нажмите кнопку **Далее**.
    - Диски можно исключить из репликации.
    - Если вы исключите диски, они не будут присутствовать на виртуальной машине Azure после миграции. 

    ![Диски](./media/tutorial-migrate-hyper-v/disks.png)

10. В разделе **Review and start replication** (Просмотр и запуск репликации) просмотрите параметры и нажмите кнопку **Реплицировать**, чтобы начать первоначальную репликацию серверов.

> [!NOTE]
> Вы можете обновить параметры репликации в любое время до начала репликации в разделе **Управление** > **Репликация компьютеров**. Настройки невозможно изменить после начала репликации.

## <a name="provisioning-for-the-first-time"></a>Подготовка выполняется впервые

Если это первая виртуальная машина, которую вы реплицируете в проекте службы "Миграция Azure", служба "Миграция Azure": миграция сервера автоматически подготавливает эти ресурсы в той же группе ресурсов, что и проект.

- **Служебная шина** Миграция Azure Средство "Миграция сервера" использует служебную шину для отправки сообщений оркестровки репликации на устройство.
- **Учетная запись хранения шлюза**. Миграция Azure Миграция сервера использует учетную запись шлюза для хранения информации о состоянии реплицируемых виртуальных машин.
- **Учетная запись хранения журналов**. Устройство Миграции Azure загружает журналы репликации для виртуальных машин в учетную запись хранения журналов. Миграция Azure применяет сведения о репликации к управляемым дискам реплики.
- **Хранилище ключей**. Устройство Миграции Azure использует хранилище ключей для управления строками подключения для служебной шины и ключами доступа для учетных записей хранения, используемых при репликации. Вы должны были установить разрешения, необходимые хранилищу ключей для доступа к учетной записи хранения, [на этапе подготовки Azure](tutorial-prepare-hyper-v.md#prepare-azure) для оценки и переноса виртуальных машин Hyper-V. 


## <a name="track-and-monitor"></a>Отслеживание и мониторинг


- Когда вы нажимаете кнопку **Реплицировать**, выполняется задание "Запуск репликации". 
- После успешного завершения задания "Запуск репликации" компьютеры начинают первоначальную репликацию в Azure.
- После завершения начальной репликации начинается разностная репликация. Добавочные изменения на локальных дисках периодически реплицируются в Azure.

Отслеживать состояние задания можно в уведомлениях портала.

Вы можете отслеживать состояние репликации, щелкнув **Репликация серверов** в разделе **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера).
![Мониторинг репликации](./media/tutorial-migrate-hyper-v/replicating-servers.png)



## <a name="run-a-test-migration"></a>Выполнение тестовой миграции


Когда начинается разностная репликация, вы можете запустить тестовую миграцию для виртуальных машин перед выполнением полной миграции в Azure. Мы настоятельно рекомендуем сделать это хотя бы один раз для каждой машины перед ее миграцией.

- Запуск тестовой миграции позволяет проверить, что миграция будет работать должным образом, не затрагивая локальные машины, которые остаются работоспособными и продолжают репликацию. 
- Тестовая миграция моделирует миграцию путем создания виртуальной машины Azure с использованием реплицированных данных (обычно выполняется миграция в нерабочую виртуальную сеть в вашей подписке Azure).
- Вы можете использовать реплицированную тестовую виртуальную машину Azure для проверки миграции, выполнения тестирования приложений и решения любых проблем перед полной миграцией.

Выполните тестовую миграцию следующим образом:


1. Последовательно выберите разделы **Цели миграции** > **Серверы** > **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) щелкните **Тестовая миграция серверов выполнена**.

     ![Тестовая миграция серверов](./media/tutorial-migrate-hyper-v/test-migrated-servers.png)

2. Щелкните правой кнопкой мыши виртуальную машину, чтобы выполнить тест, и выберите **Тестовая миграция**.

    ![Тестовая миграция](./media/tutorial-migrate-hyper-v/test-migrate.png)

3. В разделе **Тестовая миграция** выберите виртуальную сеть Azure, в которой будет находиться виртуальная машина Azure после миграции. Мы рекомендуем использовать нерабочую виртуальную сеть.
4. Запустится задание **Тестовая миграция**. Отслеживайте задание и уведомления на портале.
5. После завершения миграции просмотрите перенастроенную виртуальную машину Azure в разделе **Виртуальные машины** на портале Azure. Имя машины содержит суффикс **-Test**.
6. После завершения теста щелкните правой кнопкой мыши виртуальную машину Azure в разделе **Репликация компьютеров** и выберите **Очистка тестовой миграции**.

    ![Очистка миграции](./media/tutorial-migrate-hyper-v/clean-up.png)


## <a name="migrate-vms"></a>Перенос виртуальных машин

Убедившись, что тестовая миграция работает должным образом, вы можете выполнить миграцию локальных компьютеров.

1. В проекте "Миграция Azure" щелкните **Серверы** > **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) и выберите **Репликация серверов**.

    ![Репликация серверов](./media/tutorial-migrate-hyper-v/replicate-servers.png)

2. В области **Репликация компьютеров** щелкните правой кнопкой мыши виртуальную машину и выберите **Миграция**.
3. В разделе **Миграция** > **Shut down virtual machines and perform a planned migration with no data loss** (Завершить работу виртуальных машин и выполнить запланированную миграцию без потери данных?) выберите вариант **Да** > **ОК**.
    - По умолчанию Миграция Azure выключает локальную виртуальную машину и запускает репликацию по требованию для синхронизации любых изменений виртуальной машины, которые произошли с момента последней репликации. Это гарантирует отсутствие потери данных.
    - Если вы не хотите выключать виртуальную машину, выберите вариант **Нет**.
4. Запустится задание миграции виртуальной машины. Отслеживайте задание в уведомлениях Azure.
5. После завершения работы вы можете просматривать виртуальную машину и управлять ею на странице **Виртуальные машины**.

## <a name="complete-the-migration"></a>Выполнение миграции

1. После завершения миграции щелкните правой кнопкой мыши виртуальную машину и выберите **Stop migration** (Остановка миграции). Таким образом вы сделаете следующее:
    - Остановите репликацию для локального компьютера.
    - Удалите компьютер из числа **реплицируемых серверов** в средстве для миграции серверов Миграции Azure.
    - Очистите информацию о состоянии репликации виртуальной машины.
2. Установите агент виртуальной машины Azure для [Windows](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-windows) или [Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux) на перенесенных компьютерах.
3. Выполните любые действия по настройке после миграции приложения, такие как обновление строк подключения к базе данных и конфигурация веб-сервера.
4. Выполните приемочное тестирование конечного приложения и миграции на перенесенном приложении, работающем в Azure.
5. Остановите трафик для перенесенного экземпляра виртуальной машины Azure.
6. Удалите локальные виртуальные машины из списка локальных виртуальных машин.
7. Удалите локальные виртуальные машины из локальных заданий резервного копирования.
8. Обновите внутренние документы и отразите в них новое расположение и IP-адреса виртуальных машин Azure. 

## <a name="post-migration-best-practices"></a>Рекомендации, выполняемые после миграции

- Для повышения устойчивости:
    - Обеспечьте безопасность данных путем резервного копирования виртуальных машин Azure с помощью службы Azure Backup. [Подробнее](../backup/quick-backup-vm-portal.md).
    - Обеспечьте непрерывную работу и постоянную доступность рабочих нагрузок за счет репликации виртуальных машин Azure в дополнительный регион с помощью Site Recovery. [Подробнее](../site-recovery/azure-to-azure-tutorial-enable-replication.md).
- Для повышения уровня безопасности:
    - Заблокируйте и ограничьте доступ входящего трафика с помощью [JIT-администрирования](https://docs.microsoft.com/azure/security-center/security-center-just-in-time) центра безопасности Azure.
    - Ограничьте сетевой трафик конечными точками с помощью [групп безопасности сети](https://docs.microsoft.com/azure/virtual-network/security-overview).
    - Разверните [шифрование дисков Azure](https://docs.microsoft.com/azure/security/azure-security-disk-encryption-overview), чтобы обеспечить безопасность дисков и защитить данные от кражи и несанкционированного доступа.
    - Ознакомьтесь с дополнительными сведениями о [защите ресурсов IaaS](https://azure.microsoft.com/services/virtual-machines/secure-well-managed-iaas/) и посетите [центр безопасности Azure](https://azure.microsoft.com/services/security-center/).
- Для мониторинга и управления:
-  Рассмотрите возможность развертывания [службы "Управление затратами Azure"](https://docs.microsoft.com/azure/cost-management/overview) для мониторинга использования ресурсов и затрат.


## <a name="next-steps"></a>Дальнейшие действия

Проанализируйте процесс [миграции в облако](https://docs.microsoft.com/azure/architecture/cloud-adoption/getting-started/migrate) в Azure Cloud Adoption Framework.
