---
title: Масштабирование обнаружения и оценки с помощью службы "Миграция Azure" | Документация Майкрософт
description: В этой статье описывается, как оценить большое число локальных компьютеров с помощью службы "Миграция Azure".
author: rayne-wiselman
ms.service: azure-migrate
ms.topic: conceptual
ms.date: 04/04/2019
ms.author: raynew
ms.openlocfilehash: fe86c758dbf05f91d53cb918b7794c12ab3f39bc
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "65518757"
---
# <a name="discover-and-assess-a-large-vmware-environment"></a>Обнаружение и оценка крупной среды VMware

Служба "Миграция Azure" имеет ограничение в 1500 виртуальных машин на один проект. В этой статье описывается, как оценить большое количество локальных виртуальных машин с помощью службы [Миграция Azure](migrate-overview.md).

> [!NOTE]
> Доступна предварительная версия, которая позволяет обнаруживать до 10 000 виртуальных машин VMware в одном проекте с помощью одного устройства. Если вы хотите опробовать ее, заполните [эту форму](https://aka.ms/migratefuture).

## <a name="prerequisites"></a>Технические условия

- **VMware**. Управление виртуальными машинами, которые планируется перенести, должно осуществляться с помощью vCenter Server версии 5.5, 6.0, 6.5 или 6.7. Кроме того, для развертывания виртуальной машины сборщика необходим один узел ESXi версии 5.5 или более поздней.
- **Учетная запись vCenter**. Для доступа к серверу vCenter Server требуется учетная запись, предназначенная только для чтения. Служба "Миграция Azure" использует эту учетную запись для обнаружения локальных виртуальных машин.
- **Разрешения**. На сервере vCenter Server вам потребуются разрешения для создания виртуальной машины путем импорта OVA-файла.
- **Параметры статистики.** Этот параметр необходим только при использовании модели [однократного обнаружения](https://docs.microsoft.com/azure/migrate/concepts-collector), которая уже является нерекомендуемой. При однократном обнаружении параметры статистики для vCenter Server следует задать на уровне 3 перед началом развертывания. Следует установить уровень статистики 3 для каждого из интервалов сбора дня, недели и месяца. Если уровень ниже 3 для любого из интервалов сбора, оценка будет выполняться, но данные о производительности хранилища и сети не будут собираться. В этом случае рекомендации по размеру будут основаны на данных производительности ЦП и памяти, а также на данных конфигурации диска и сетевых адаптеров.

> [!NOTE]
> Устройство однократного обнаружения не рекомендуют использовать, поскольку этот метод полагался на параметры статистик vCenter Server для доступности точки данных производительности и собранных средних счетчиков производительности, которые привели к превышению размера виртуальных машин для миграции в Azure.

### <a name="set-up-permissions"></a>Настройка разрешений

Службе "Миграция Azure" необходим доступ к серверам VMware для автоматического обнаружения виртуальных машин для оценки. Учетной записи VMware необходимы следующие разрешения.

- Тип пользователя: Пользователь только для чтения (минимум).
- Разрешения. Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only
- Сведения. Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.
- Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль "Без доступа" с параметром "Распространить на дочерний объект".

Если при развертывании в среде с несколькими клиентами и хотите области, папки виртуальных машин для одного клиента, невозможно выбрать папку виртуальной Машины при определении коллекции в "Миграция Azure". Ниже приведены инструкции о том, как обнаружение области, папки виртуальных машин:

1. Создать пользователя с каждого клиента и назначьте разрешения только для чтения ко всем виртуальным машинам, относящихся к определенной клиенту. 
2. Предоставляют подобный доступ только для чтения пользователя к родительским объектам, где размещаются виртуальные машины. Всех родительских объектов - узел, папку узлов, кластера, папку кластеров — в иерархии до центра обработки данных должны быть включены. Необходимо распространить разрешения на все дочерние объекты.
3. Использовать учетные данные для обнаружения, выбрав центр обработки данных как *область сбора*. Настройка ролей RBAC гарантирует, что соответствующего пользователя vCenter имеет доступ к виртуальным машинам только определенного клиента.

## <a name="plan-your-migration-projects-and-discoveries"></a>Планирование проектов миграции и операций обнаружения

В зависимости от количества виртуальных машин, которые планируется обнаружить, вы можете создать несколько проектов и развернуть несколько устройств в своей среде. Устройство может быть подключено к одному серверу vCenter Server и к одному проекту (если вы не остановите обнаружение и не начнете сначала).

При однократном обнаружении (не рекомендуется сейчас) обнаружение работает по принципу "обнаружил и забыл". По окончании обнаружения можно использовать тот же сборщик для сбора данных другого vCenter Server или другого проекта миграции.

> [!NOTE]
> Устройство однократного обнаружения не рекомендуют использовать, поскольку этот метод полагался на параметры статистик vCenter Server для доступности точки данных производительности и собранных средних счетчиков производительности, которые привели к превышению размера виртуальных машин для миграции в Azure. Рекомендуется для перемещения к устройству непрерывной обнаружения.

Планируйте обнаружение и оценку с учетом следующих ограничений:

| **Сущность** | **Предельное число виртуальных машин** |
| ---------- | ----------------- |
| Project    | 1,500             |
| Обнаружение  | 1,500             |
| Оценка | 1,500             |

При планировании учитывайте следующие особенности:

- При выполнении операции обнаружения с использованием сборщика службы "Миграция Azure" можно задать для области обнаружения папку, центр данных, кластер или узел vCenter Server.
- Чтобы выполнить несколько обнаружений из одного центра vCenter Server, убедитесь, что виртуальные машины, которые нужно обнаружить, размещены в папках, центрах обработки данных, кластерах или на узлах, поддерживающих ограничение в 1500 компьютеров.
- В целях оценки рекомендуется размещать взаимозависимые компьютеры в рамках одного проекта и оценки. В vCenter Server убедитесь, что зависимые компьютеры находятся в одной папке, центре обработки данных или кластере, предназначенном для оценки.

В зависимости от сценария вы можете разделить операции обнаружения, выбрав один из описанных ниже вариантов.

### <a name="multiple-vcenter-servers-with-less-than-1500-vms"></a>Несколько серверов vCenter Server с количеством виртуальных машин до 1500
Если у вас несколько vCenter Server, а число виртуальных машин менее 1500, можно использовать следующий подход в зависимости от вашего сценария:

**Непрерывное обнаружение**. При непрерывном обнаружении сборщик задействован только в одном проекте. Поэтому необходимо развернуть сборщик для каждого vCenter Server, создать отдельный проект для каждого сборщика и выполнить обнаружение соответствующим образом.

**Однократное обнаружение (не рекомендуемое сейчас)** . Вы можете использовать один сборщик и один проект миграции для обнаружения всех виртуальных машин во всех vCenter Server. Так как при однократном обнаружении сборщик обнаруживает один vCenter Server за раз, можно последовательно использовать один и тот же сборщик во всех vCenter Server и один проект миграции. По завершении всех операций обнаружения можно создать оценку для виртуальных машин.


### <a name="multiple-vcenter-servers-with-more-than-1500-vms"></a>Несколько серверов vCenter Server с количеством виртуальных машин свыше 1500

Если используется несколько серверов vCenter Server, на каждом из которых менее 1500 виртуальных машин, но их общее количество на всех серверах превышает 1500, необходимо создать несколько проектов миграции (в одном проекте миграции может использоваться не более 1500 виртуальных машин). Этого можно достичь, создав по одному проекту миграции на каждый сервер vCenter Server и разделив операции обнаружения.

**Непрерывное обнаружение**. Необходимо создать несколько сборщиков (по одному для каждого vCenter Server), подключить каждый из них к отдельному проекту и выполнить обнаружение соответствующим образом.

**Однократное обнаружение (не рекомендуемое сейчас)** . Для обнаружения каждого сервера vCenter Server можно последовательно использовать один и тот же сборщик. Чтобы начать операции обнаружения одновременно, можете развернуть несколько устройств и запустить эти операции параллельно.

### <a name="more-than-1500-machines-in-a-single-vcenter-server"></a>Более 1500 машин на одном сервере vCenter Server

Если на одном сервере vCenter Server более 1500 виртуальных машин, разделите операции обнаружения на несколько проектов миграции. Чтобы разделить операции обнаружения, можно использовать поле «область» на устройстве и укажите узел, кластер, папка узлов, папка кластеров или центра обработки данных, которые нужно обнаружить. Например, если у вас есть две папки в vCenter Server, в одной из которых 1000 виртуальных машин (Папка 1), а в другой — 800 (Папка 2), можно разделить операции обнаружения между этими папками с помощью поля "Область".

**Непрерывное обнаружение**. В этом случае необходимо создать два сборщика и указать папку 1 как область для первого сборщика, подключив его к первому проекту миграции. Можно одновременно начать обнаружение в Папке 2 с помощью второго сборщика, подключив его ко второму проекту миграции.

**Однократное обнаружение (не рекомендуемое сейчас)** . Можно использовать один сборщик для обеих операций обнаружения. В первой операции обнаружения можно указать папку 1 как область для первого проекта миграции. Когда операция завершится, можете использовать этот же сборщик, но в поле "Область" нужно указать "Папка 2", а в сведениях о проекте — что это второй проект миграции. После этого выполните вторую операцию обнаружения.

### <a name="multi-tenant-environment"></a>Среда с несколькими клиентами

Если несколько клиентов совместно используют вашу среду и вы не хотите, чтобы обнаружение виртуальных машин для одного клиента выполнялось в подписке другого клиента, используйте поле "Область" на устройстве сборщика, чтобы обозначить область обнаружения. Если клиенты совместно используют узлы, создайте учетную запись с доступом только для чтения и только для тех виртуальных машин, которые принадлежат конкретному клиенту. Используйте эти учетные данные на устройстве сборщика, указав область в качестве узла для обнаружения.

## <a name="discover-on-premises-environment"></a>Сведения о локальной среде

Когда план будет готов, можно приступить к обнаружению локальных виртуальных машин.

### <a name="create-a-project"></a>Создание проекта

Создайте проект службы "Миграция Azure" в соответствии со своими требованиями.

1. На портале Azure выберите **Создать ресурс**.
2. Выполните поиск по фразе **Миграция Azure** и в результатах поиска выберите службу **Миграция Azure**. Щелкните **Создать**.
3. Укажите имя проекта и подписку Azure для него.
4. Создайте новую группу ресурсов.
5. Укажите расположение, в котором нужно создать проект, а затем выберите **Создать**. Обратите внимание, что виртуальные машины с другим целевым расположением по-прежнему можно оценить. Метаданные, собранные из локальных виртуальных машин, хранятся в расположении, которое задано для проекта.

### <a name="set-up-the-collector-appliance"></a>Настройка модуля сборщика

Служба "Миграция Azure" создает локальную виртуальную машину, известную как модуль сборщика. Эта виртуальная машина обнаруживает локальные виртуальные машины VMware, отправляет в службу "Миграция Azure" метаданные о них. Чтобы настроить модуль сборщика, скачайте OVA-файл и импортируйте его на локальный экземпляр vCenter Server.

#### <a name="download-the-collector-appliance"></a>Скачивание модуля сборщика

Если у вас есть несколько проектов, то модуль сборщика для vCenter Server необходимо скачать только один раз. После скачивания и установки модуля запустите его для каждого проекта, указав уникальный идентификатор и ключ проекта.

1. В проекте службы "Миграция Azure" щелкните **Начало работы** > **Обнаружение и оценка** > **Обнаружение компьютеров**.
2. В окне **Обнаружение компьютеров** щелкните **Скачать**, чтобы скачать устройство.

    Устройство для службы "Миграция Azure" взаимодействует с vCenter Server и постоянно профилирует локальную среду, чтобы собрать данные об использовании в реальном времени по каждой виртуальной машине. Оно собирает данные счетчиков пиковых значений по каждой метрике (использование ЦП, памяти и т. д.). Эта модель не зависит от параметров статистики vCenter Server для сбора данных о производительности. Функцию непрерывного профилирования можно отключить в самом модуле.

    > [!NOTE]
    > Устройство однократного обнаружения не рекомендуют использовать, поскольку этот метод полагался на параметры статистик vCenter Server для доступности точки данных производительности и собранных средних счетчиков производительности, которые привели к превышению размера виртуальных машин для миграции в Azure.

    **Мгновенное вознаграждение.** После завершения обнаружения (занимает несколько часов в зависимости от количества виртуальных машин) с помощью устройства непрерывного обнаружения можно сразу же создать оценки. Сбор данных производительности начинается с момента запуска обнаружения, если вы ищете мгновенное вознаграждение, следует выбрать условие определения размера в оценке как *локальное*. Для оценки на основе производительности рекомендуется после запуска обнаружения подождать по крайней мере один день, чтобы получить рекомендации по выбору надежного размера.

    Обратите внимание, что модуль только непрерывно собирает данные о производительности. Он не обнаруживает изменения конфигурации в локальной среде (например, добавление, удаление виртуальной машины, добавление диска и т. д.). Если в локальной среде была изменена конфигурация и вам нужно отразить эти изменения на портале, сделайте следующее:

    - Добавление элементов (виртуальных машин, дисков, ядер и т. д.). Чтобы отразить эти изменения на портале Azure, вы можете остановить обнаружение с модуля, а затем запустить его снова. Это позволит обновить изменения в проекте "Миграция Azure".

    - Удаление виртуальных машин. Из-за особенностей конструкции модуля удаление виртуальных машин не отражается даже при остановке и повторном запуске обнаружения. Это связано с тем, что данные из последующих обнаружений добавляются к более старым обнаружениям, а не переопределяются. В этом случае вы можете просто игнорировать виртуальную машину на портале, удалив ее из своей группы и пересчитав оценку.

3. В окне **Копирование учетных данных проекта** скопируйте идентификатор и ключ для проекта. Они потребуются при настройке сборщика.


#### <a name="verify-the-collector-appliance"></a>Проверка модуля сборщика

Прежде чем развертывать OVA-файл, убедитесь, что он не поврежден.

1. На компьютере, на который был скачан файл, откройте командное окно с правами администратора.

2. Выполните следующую команду, чтобы создать хэш OVA-файла.

   ```C:\>CertUtil -HashFile <file_location> [Hashing Algorithm]```

   Пример использования: ```C:\>CertUtil -HashFile C:\AzureMigrate\AzureMigrate.ova SHA256```

3. Убедитесь, что созданный хэш соответствует следующим параметрам.

#### <a name="continuous-discovery"></a>Непрерывное обнаружение

Для OVA-файла версии 1.0.10.4

**Алгоритм** | **Значение хэша**
--- | ---
MD5 | 2ca5b1b93ee0675ca794dd3fd216e13d
SHA1 | 8c46a52b18d36e91daeae62f412f5cb2a8198ee5
SHA256 | 3b3dec0f995b3dd3c6ba218d436be003a687710abab9fcd17d4bdc90a11276be

#### <a name="one-time-discovery-deprecated-now"></a>Однократное обнаружение (не рекомендуемое сейчас)

Для версии OVA 1.0.9.15 (выпущена 23.10.2018)

**Алгоритм** | **Значение хэша**
--- | ---
MD5 | e9ef16b0c837638c506b5fc0ef75ebfa
SHA1 | 37b4b1e92b3c6ac2782ff5258450df6686c89864
SHA256 | 8a86fc17f69b69968eb20a5c4c288c194cdcffb4ee6568d85ae5ba96835559ba

Для версии OVA 1.0.9.14 (выпущена 24.08.2018)

**Алгоритм** | **Значение хэша**
--- | ---
MD5 | 6d8446c0eeba3de3ecc9bc3713f9c8bd
SHA1 | e9f5bdfdd1a746c11910ed917511b5d91b9f939f
SHA256 | 7f7636d0959379502dfbda19b8e3f47f3a4744ee9453fc9ce548e6682a66f13c

Для OVA-файла версии 1.0.9.12

**Алгоритм** | **Значение хэша**
--- | ---
MD5 | d0363e5d1b377a8eb08843cf034ac28a
SHA1 | df4a0ada64bfa59c37acf521d15dcabe7f3f716b
SHA256 | f677b6c255e3d4d529315a31b5947edfe46f45e4eb4dbc8019d68d1d1b337c2e

Для OVA-файла версии 1.0.9.8

**Алгоритм** | **Значение хэша**
--- | ---
MD5 | b5d9f0caf15ca357ac0563468c2e6251
SHA1 | d6179b5bfe84e123fabd37f8a1e4930839eeb0e5
SHA256 | 09c68b168719cb93bd439ea6a5fe21a3b01beec0e15b84204857061ca5b116ff

Для OVA-файла версии 1.0.9.7

**Алгоритм** | **Значение хэша**
--- | ---
MD5 | d5b6a03701203ff556fa78694d6d7c35
SHA1 | f039feaa10dccd811c3d22d9a59fb83d0b01151e
SHA256 | e5e997c003e29036f62bf3fdce96acd4a271799211a84b34b35dfd290e9bea9c

### <a name="create-the-collector-vm"></a>Создание виртуальной машины сборщика

Импортируйте загруженный файл в vCenter Server.

1. В консоли клиента vSphere выберите **File** (Файл) > **Deploy OVF Template** (Развернуть шаблон OVF).

    ![Развертывание шаблона OVF](./media/how-to-scale-assessment/vcenter-wizard.png)

2. В мастере развертывания шаблона OVF выберите **Source** (Источник) и укажите расположение OVA-файла.
3. В полях**Name** (Имя) и **Location** (Расположение) укажите понятное имя виртуальной машины сборщика и объект инвентаризации, в котором будет размещена эта виртуальная машина.
4. В поле **Host/Cluster** (Узел или кластер) укажите узел или кластер, в котором будет выполняться виртуальная машина сборщика.
5. В поле "Storage" (Хранилище) укажите место хранения данных виртуальной машины сборщика.
6. В поле **Disk Format** (Формат диска) укажите тип и размер диска.
7. В поле **Network Mapping** (Сетевое сопоставление) укажите сеть, к которой будет подключена виртуальная машина сборщика. Этой сети требуется подключение к Интернету для отправки метаданных в Azure.
8. Проверьте и подтвердите параметры и нажмите кнопку **Finish** (Готово).

### <a name="identify-the-id-and-key-for-each-project"></a>Определение идентификатора и ключа для каждого проекта

Если у вас несколько проектов, обязательно укажите идентификатор и ключ для каждого из них. Ключ необходим при запуске сборщика для обнаружения виртуальных машин.

1. В проекте выберите **Начало работы** > **Обнаружение и оценка** > **Обнаружение компьютеров**.
2. В окне **Копирование учетных данных проекта** скопируйте идентификатор и ключ для проекта.
    ![Копирование учетных данных проекта](./media/how-to-scale-assessment/copy-project-credentials.png)

### <a name="run-the-collector-to-discover-vms"></a>Запуск сборщика для обнаружения виртуальных машин

Для каждого обнаружения, которое необходимо выполнить, следует запустить сборщик для виртуальных машин в требуемой области обнаружения. Выполняйте операции обнаружения по очереди. Параллельные операции обнаружения не поддерживаются, и у всех операций обнаружения должны быть разные области.

1.  В консоли клиента vSphere щелкните правой кнопкой мыши виртуальную машину и выберите **Open Console** (Открыть консоль).
2.  Укажите язык, часовой пояс и параметры пароля для модуля.
3.  На рабочем столе щелкните ярлык **Run collector** (Запустить сборщик).
4.  В сборщике службы "Миграция Azure" откройте раздел **Set Up Prerequisites** (Настройка предварительных требований), а затем:

    a. Примите условия лицензии и прочитайте информацию от сторонних производителей.

    Сборщик проверит наличие доступа к Интернету у виртуальной машины.

    2\. Если виртуальная машина подключена к Интернету через прокси-сервер, выберите **Proxy settings** (Параметры прокси-сервера) и укажите адрес и порт прослушивания прокси-сервера. Укажите учетные данные, если для прокси-сервера требуется аутентификация.

    Сборщик проверит, запущена ли служба сборщика. Эта служба устанавливается по умолчанию на виртуальной машине сборщика.

    c. Скачайте и установите VMware PowerCLI.

5.  В разделе **Specify vCenter Server details** (Укажите сведения о vCenter Server) выполните следующие действия:
    - Укажите полное доменное имя или IP-адрес vCenter Server.
    - Для **имени пользователя** и **пароля** укажите данные учетной записи только для чтения, которую сборщик будет использовать для обнаружения виртуальных машин в vCenter Server.
    - В поле **Select scope** (Выбор области) выберите область обнаружения виртуальных машин. Сборщик может обнаруживать только виртуальные машины в указанной области. Областью может быть определенная папка, центр обработки данных или кластер. Она не должна содержать более 1000 виртуальных машин.

6.  В поле **Specify migration project** (Выбор проекта миграции) укажите идентификатор и ключ для проекта. Если вы не скопировали их, то откройте портал Azure на виртуальной машине сборщика. На проектной странице **Обзор** выберите **Обнаружение компьютеров** и скопируйте соответствующие значения.  
7.  В окне **View collection progress** (Просмотр хода выполнения сборщика) наблюдайте за процессом обнаружения и убедитесь, что в области обнаружения собираются метаданные из виртуальных машин. Сборщик предоставляет приблизительное время завершения обнаружения.

#### <a name="verify-vms-in-the-portal"></a>Проверка виртуальных машин на портале

Сборщик будет постоянно профилировать локальную среду и отправлять данные о производительности с интервалом в один час. Сведения о виртуальных машинах будут доступны на портале через час после начала обнаружения. Настоятельно рекомендуем подождать по крайней мере один день, прежде чем создавать оценки производительности для виртуальных машин.

1. В проекте службы "Миграция Azure" последовательно выберите **Управление** > **Компьютеры**.
2. Проверьте, появились ли на портале виртуальные машины, которые нужно было обнаружить.

### <a name="data-collected-from-on-premises-environment"></a>Данные, собираемые из локальной среды

Устройство сборщика обнаруживает следующие данные конфигурации выбранных виртуальных машин.

1. Отображаемое имя виртуальной машины (на сервере vCenter).
2. Путь инвентаризации виртуальной машины (узел или папка на сервере vCenter).
3. IP-адрес
4. MAC-адрес.
5. Операционная система
5. Число ядер, дисков и сетевых адаптеров.
6. Объем памяти, размеры диска.
7. Данные счетчиков производительности виртуальных машин, диска и сети, приведенные в таблице ниже.

Устройство сборщика собирает следующие счетчики производительности для каждой виртуальной машины из узла ESXi с интервалом в 20 секунд. Это счетчики vCenter, и, хотя в терминологии сообщается среднее значение, 20-секундные выборки являются счетчиками в режиме реального времени. На основе пиковых значений 20-секундных замеров сборщик рассчитывает среднее значение для 15-минутного периода и отправляет его в Azure. Данные о производительности виртуальных машин становятся доступны на портале через два часа после запуска обнаружения. Настоятельно советуем подождать по крайней мере один день, прежде чем создавать оценки производительности для получения точных рекомендаций по выбору правильного размера. Если требуется мгновенное вознаграждение, вы можете создать оценку с критерием определения размера *Как в локальной среде*, который не будет учитывать данные производительности для определения нужного размера.

**Счетчик** |  **Влияние на оценку**
--- | ---
cpu.usage.average | Рекомендуемый размер и стоимость виртуальной машины  
mem.usage.average | Рекомендуемый размер и стоимость виртуальной машины  
virtualDisk.read.average | Вычисляет размер диска, затраты на хранение и размер виртуальной машины
virtualDisk.write.average | Вычисляет размер диска, затраты на хранение и размер виртуальной машины
virtualDisk.numberReadAveraged.average | Вычисляет размер диска, затраты на хранение и размер виртуальной машины
virtualDisk.numberWriteAveraged.average | Вычисляет размер диска, затраты на хранение и размер виртуальной машины
net.received.average | Вычисляет размер виртуальной машины                          
net.transmitted.average | Вычисляет размер виртуальной машины     

> [!WARNING]
> Однократный метод обнаружения, который полагается на параметры статистики vCenter Server для сбора данных производительности, теперь нерекомендуемый.

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте, как [создать группу](how-to-create-a-group.md) для оценки.
- [Узнайте больше](concepts-assessment-calculation.md) о вычислении оценок.
