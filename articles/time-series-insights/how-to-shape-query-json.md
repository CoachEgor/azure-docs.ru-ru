---
title: Рекомендации по формированию запросов JSON - Azure Time Series Исследования (ru) Документы Майкрософт
description: Узнайте, как улучшить эффективность запроса Azure Time Series Insights, сформируя JSON.
services: time-series-insights
author: deepakpalled
ms.author: dpalled
manager: cshankar
ms.service: time-series-insights
ms.topic: article
ms.date: 04/17/2020
ms.custom: seodec18
ms.openlocfilehash: 63a708f80ad18309269e37c354b047c304a260d3
ms.sourcegitcommit: d791f8f3261f7019220dd4c2dbd3e9b5a5f0ceaf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2020
ms.locfileid: "81641294"
---
# <a name="shape-json-to-maximize-query-performance"></a>Форма JSON для максимизации производительности запроса

В этой статье содержатся рекомендации по формированию JSON для максимизации эффективности запросов Azure Time Series Insights.

## <a name="video"></a>Видеоролик

### <a name="learn-best-practices-for-shaping-json-to-meet-your-storage-needsbr"></a>Изучите лучшие практики для формирования JSON для удовлетворения ваших потребностей в хранении.</br>

> [!VIDEO https://www.youtube.com/embed/b2BD5hwbg5I]

## <a name="best-practices"></a>Рекомендации

Подумайте о том, как вы отправляете события в Time Series Insights. А именно, вы всегда:

1. Отправлять данные по сети наиболее эффективным путем.
1. Убедитесь, что ваши данные хранятся таким образом, чтобы вы могли выполнять агрегации, подходящие для вашего сценария.
1. Убедитесь, что вы не достигнете Временные серии Исследования максимальные пределы свойств:
   - 600 свойств (столбцов) для сред S1;
   - 800 свойств (столбцов) для сред S2.

> [!TIP]
> Просмотр [ограничений и планирования](time-series-insights-update-plan.md) в Azure Time Series Insights Preview.

Следующее руководство помогает обеспечить наилучшую производительность запроса:

1. Не используйте динамические свойства, такие как идентификатор тегов, в качестве имени свойства. Это использование способствует достижению максимального предела свойств.
1. Не отправляйте необязательные свойства. Если свойство запроса не требуется, лучше не отправлять его. Таким образом, вы избегаете ограничений на хранение.
1. Используйте [справочные данные,](time-series-insights-add-reference-data-set.md) чтобы избежать отправки статических данных по сети.
1. Совместное использование свойств измерений между несколькими событиями для более эффективной передачи данных по сети.
1. Не применяйте глубокую вложенность массивов. Time Series Insights поддерживает до двух уровней вложенных массивов, содержащих объекты. Time Series Insights сглаживает массивы в сообщениях на несколько событий парами значений свойств.
1. Если для всех или большинства событий существует только несколько мер, лучше отправлять эти меры как отдельные свойства в одном и том же объекте. Отправка их отдельно сокращает количество событий и может повысить производительность запроса, поскольку требуется меньшее количество событий. При наличии нескольких мер отправка их в качестве значений в одном свойстве сводит к минимуму возможность достижения максимального предела свойства.

## <a name="example-overview"></a>Пример обзора

Следующие два примера демонстрируют, как отправлять события, чтобы подчеркнуть предыдущие рекомендации. Следуя каждому примеру, можно просмотреть, как были применены рекомендации.

Примеры основаны на сценарии, в котором несколько устройств отправляют измерения или сигналы. Измерения или сигналы могут быть Скорость потока, давление масла двигателя, температура, и влажность. В первом примере имеется несколько измерений по всем устройствам. Второй пример имеет много устройств, и каждое устройство посылает много уникальных измерений.

## <a name="scenario-one-only-a-few-measurements-exist"></a>Сценарий первый: Существует лишь несколько измерений

> [!TIP]
> Мы рекомендуем отправлять каждое измерение или сигнал в виде отдельного свойства или столбца.

В следующем примере есть одно сообщение Azure IoT Hub, где внешний массив содержит общий раздел значений общего измерения. Внешний массив использует эталонные данные для повышения эффективности сообщения. Справочные данные содержат метаданные устройства, которые не меняются с каждым событием, но они предоставляют полезные свойства для анализа данных. Пакетирование значений общего измерения и использование справочных данных экономит на байтах, отправленных по проводу, что делает сообщение более эффективным.

Рассмотрим следующую полезную нагрузку JSON, отправленную в среду Time Series Insights GA с помощью [объекта сообщения IoT Device,](https://docs.microsoft.com/dotnet/api/microsoft.azure.devices.message?view=azure-dotnet) который сериализируется в JSON при отправке в облако Azure:


```JSON
[
    {
        "deviceId": "FXXX",
        "timestamp": "2018-01-17T01:17:00Z",
        "series": [
            {
                "Flow Rate ft3/s": 1.0172575712203979,
                "Engine Oil Pressure psi ": 34.7
            },
            {
                "Flow Rate ft3/s": 2.445906400680542,
                "Engine Oil Pressure psi ": 49.2
            }
        ]
    },
    {
        "deviceId": "FYYY",
        "timestamp": "2018-01-17T01:18:00Z",
        "series": [
            {
                "Flow Rate ft3/s": 0.58015072345733643,
                "Engine Oil Pressure psi ": 22.2
            }
        ]
    }
]
```

* Таблица справочных данных с ключевым **свойством deviceId:**

   | deviceId | messageId | deviceLocation |
   | --- | --- | --- |
   | FXXX | LINE\_DATA | EU |
   | FYYY | LINE\_DATA | США |

* Таблица событий Time Series Insights после выравнивания:

   | deviceId | messageId | deviceLocation | TIMESTAMP | series.Flow Rate ft3/s | series.Engine Oil Pressure psi |
   | --- | --- | --- | --- | --- | --- |
   | FXXX | LINE\_DATA | EU | 2018-01-17T01:17:00Z | 1.0172575712203979 | 34.7 |
   | FXXX | LINE\_DATA | EU | 2018-01-17T01:17:00Z | 2.445906400680542 | 49.2 |
   | FYYY | LINE\_DATA | США | 2018-01-17T01:18:00Z | 0.58015072345733643 | 22.2 |

> [!NOTE]
> - Столбец **deviceId** служит заголовком столбца для различных устройств в парке автомобилей. Создание **значения deviceId,** которое имеет собственное значение свойства, ограничивает общее количество устройств 595 (для сред S1) или 795 (для сред S2) с другими пятью столбцов.
> - Не нужно изготывать ненужные свойства (например, информация о модели и модели). Поскольку свойства не будут запрашиваться в будущем, их устранение позволяет повысить эффективность сети и хранения данных.
> - Эталонные данные используются для сокращения количества байтов, передаваемых по сети. Два атрибута **messageId** и **deviceLocation** соединены с помощью **ключевого свойства deviceId.** Эти данные соединяются с данными телеметрии во время входа, а затем хранятся в Time Series Insights для запроса.
> - Используются два слоя гнездования, что является максимальным количеством вложений, поддерживаемым Time Series Insights. Критически важно избегать глубоко вложенных массивов.
> - Меры отправляются как отдельные свойства внутри одного объекта, поскольку существует несколько мер. Здесь **series.Flow Rate psi** и **series.Engine Oil Pressure ft3/s** — уникальные столбцы.

## <a name="scenario-two-several-measures-exist"></a>Сценарий второй: существует несколько мер

> [!TIP]
> Мы рекомендуем отправлять измерения как "тип", "единица" и "стоимость" tuples.

Пример полезных данных JSON:

```JSON
[
    {
        "deviceId": "FXXX",
        "timestamp": "2018-01-17T01:17:00Z",
        "series": [
            {
                "tagId": "pumpRate",
                "value": 1.0172575712203979
            },
            {
                "tagId": "oilPressure",
                "value": 49.2
            },
            {
                "tagId": "pumpRate",
                "value": 2.445906400680542
            },
            {
                "tagId": "oilPressure",
                "value": 34.7
            }
        ]
    },
    {
        "deviceId": "FYYY",
        "timestamp": "2018-01-17T01:18:00Z",
        "series": [
            {
                "tagId": "pumpRate",
                "value": 0.58015072345733643
            },
            {
                "tagId": "oilPressure",
                "value": 22.2
            }
        ]
    }
]
```

* Таблица справочных данных с ключевыми свойствами **deviceId** и **series.tagId**:

   | deviceId | series.tagId | messageId | deviceLocation | type | unit |
   | --- | --- | --- | --- | --- | --- |
   | FXXX | pumpRate | LINE\_DATA | EU | Скорость потока | ft3/s |
   | FXXX | oilPressure | LINE\_DATA | EU | Давление масла в двигателе | psi |
   | FYYY | pumpRate | LINE\_DATA | США | Скорость потока | ft3/s |
   | FYYY | oilPressure | LINE\_DATA | США | Давление масла в двигателе | psi |

* Таблица событий Time Series Insights после выравнивания:

   | deviceId | series.tagId | messageId | deviceLocation | type | unit | TIMESTAMP | series.value |
   | --- | --- | --- | --- | --- | --- | --- | --- |
   | FXXX | pumpRate | LINE\_DATA | EU | Скорость потока | ft3/s | 2018-01-17T01:17:00Z | 1.0172575712203979 | 
   | FXXX | oilPressure | LINE\_DATA | EU | Давление масла в двигателе | psi | 2018-01-17T01:17:00Z | 34.7 |
   | FXXX | pumpRate | LINE\_DATA | EU | Скорость потока | ft3/s | 2018-01-17T01:17:00Z | 2.445906400680542 | 
   | FXXX | oilPressure | LINE\_DATA | EU | Давление масла в двигателе | psi | 2018-01-17T01:17:00Z | 49.2 |
   | FYYY | pumpRate | LINE\_DATA | США | Скорость потока | ft3/s | 2018-01-17T01:18:00Z | 0.58015072345733643 |
   | FYYY | oilPressure | LINE\_DATA | США | Давление масла в двигателе | psi | 2018-01-17T01:18:00Z | 22.2 |

> [!NOTE]
> - Столбцы **deviceId** и **series.tagId** служат заголовками столбцов для различных устройств и тегов в автопарке. Использование каждого в качестве собственного атрибута ограничивает запрос 594 (для сред S1) или 794 (для сред S2) общими устройствами с другими шестью столбиками.
> - Ненужных свойств удалось избежать по причине, приведенной в первом примере.
> - Справочные данные используются для уменьшения количества байтов, передаваемых по сети путем введения **deviceId,** который используется для уникальной пары **messageId** и **deviceLocation.** Композитный ключ **series.tagId** используется для уникальной пары **типа** и **единицы.** Композитный ключ позволяет использовать пару **deviceId** и **series.tagId** для обозначения четырех значений: **messageId, deviceLocation, type** и **unit.** Эти данные соединяются с данными телеметрии во время входа. Затем он хранится в Time Series Insights для запроса.
> - Используются два слоя гнездования, по причине, приведенной в первом примере.

### <a name="for-both-scenarios"></a>Для обоих сценариев

Для свойства с большим количеством возможных значений лучше всего отправлять определенные значения в пределах одного столбца, а не создавать новый столбец для каждого значения. Из предыдущих двух примеров:

  - В первом примере несколько свойств имеют несколько значений, поэтому уместно сделать каждое отдельное свойство.
  - Во втором примере измерения не указаны как индивидуальные свойства. Вместо этого они являются массивом значений или мер в рамках общего свойства серии. Отправляется новый ключ **tagId,** который создает новую **колонку series.tagId** в сплющенной таблице. Новый **тип** свойств и **единица** создаются с помощью справочных данных, чтобы не достичь предела свойства.

## <a name="next-steps"></a>Дальнейшие действия

- Подробнее об [отправке сообщений устройств IoT Hub в облако.](../iot-hub/iot-hub-devguide-messages-construct.md)

- Прочитайте [синтаксис анализа серии времени Azure,](https://docs.microsoft.com/rest/api/time-series-insights/ga-query-syntax) чтобы узнать больше о синтаксисе запросов для доступа к данным TIME Series Insights REST API.

- [Узнайте, как формировать события.](./time-series-insights-send-events.md)
