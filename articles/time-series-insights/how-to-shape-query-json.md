---
title: Рекомендации по формированию JSON в запросах службы "Аналитика временных рядов Azure" | Документация Майкрософт
description: Сведения о том, как повысить эффективность запросов службы "Аналитика временных рядов Azure".
services: time-series-insights
author: ashannon7
manager: cshankar
ms.service: time-series-insights
ms.topic: article
ms.date: 05/09/2019
ms.author: anshan
ms.custom: seodec18
ms.openlocfilehash: 535fe9a7920db89e434b4cc1b66aa38bf72a7829
ms.sourcegitcommit: 36c50860e75d86f0d0e2be9e3213ffa9a06f4150
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2019
ms.locfileid: "65790066"
---
# <a name="how-to-shape-json-to-maximize-query-performance"></a>Формирование JSON для достижения максимальной производительности запросов 

Эта статья содержит рекомендации для формирования JSON, для повышения эффективности запросов Azure Time Series Insights.

## <a name="video"></a>Видео

### <a name="learn-best-practices-for-shaping-json-to-meet-your-storage-needsbr"></a>Ознакомьтесь с рекомендациями для формирования JSON, необходимое для хранения.</br>

> [!VIDEO https://www.youtube.com/embed/b2BD5hwbg5I]

## <a name="best-practices"></a>Рекомендации

Важно подумать о том, как вы отправляете события в службу аналитики временных рядов. А именно, следует всегда:

1. Отправлять данные по сети наиболее эффективным путем.
1. Убедитесь, что данные хранятся в виде, позволяет выполнять агрегирование, подходящий для вашего сценария.
1. Убедитесь, не превышал ограничений на максимальный свойство Time Series Insights:
   - 600 свойств (столбцов) для сред S1;
   - 800 свойств (столбцов) для сред S2.

Следующие рекомендации помогут обеспечить оптимальную производительность запросов.

1. Не используйте динамические свойства, например идентификатор тега в качестве имени свойства, так как это способствует достижению максимального лимита на количество свойств.
1. Не отправляйте необязательные свойства. Если свойство запроса не требуется, рекомендуется не отправлять его и не превышать ограничений хранилища.
1. Используйте [эталонные данные](time-series-insights-add-reference-data-set.md), чтобы избежать отправки статических данных по сети.
1. Используйте свойства измерений совместно в нескольких событиях, чтобы эффективнее передавать данные по сети.
1. Не применяйте глубокую вложенность массивов. Time Series Insights поддерживает до двух уровней вложенных массивов, содержащих объекты. Time Series Insights объединяет массивы в сообщениях, в нескольких событий с помощью пар "свойство-значение".
1. Если для всех или большинства событий существует только несколько мер, лучше отправлять эти меры как отдельные свойства в одном и том же объекте. Отправка их по отдельности сокращает число событий и может сделать запросы более производительными, так как требуется обрабатывать меньше событий. При наличии нескольких мер отправка их в виде значений в едином свойстве сводит к минимуму вероятность достижения ограничения на максимальное количество свойств.

## <a name="example-overview"></a>Общие сведения о примере

В следующих двух примерах демонстрируется отправка событий для иллюстрации приведенных выше рекомендаций. После каждого примера можно увидеть, как были применены рекомендации.

Примеры основаны на сценарии, в котором несколько устройств отправляют измерения или сигналы. Это могут быть такие измерения или сигналы, как скорость потока, давление масла в двигателе, температура и влажность. В первом примере имеется несколько измерений по всем устройствам. Во втором примере используется несколько устройств, каждое из которых отправляет много уникальных измерений.

## <a name="scenario-one-only-a-few-measurements-exist"></a>Сценарий 1: существует только несколько измерений

> [!TIP]
> **Рекомендация**: Отправка каждого измерения/сигнала в качестве отдельного свойства или столбца.

В следующем примере есть одно сообщение Центра Интернета вещей, в котором внешний массив содержит совместно используемый раздел значений общих измерений. Внешний массив использует эталонные данные для повышения эффективности сообщения. В эталонных данных содержатся метаданные устройств, которые не изменяются при каждом событии, но предоставляют полезные свойства для анализа данных. Как пакетная обработка значений общих измерений, так и использование эталонных данных позволяют сократить количество байтов, передаваемых по сети, что повышает эффективность сообщения.

Пример полезных данных JSON:

```json
[
    {
        "deviceId": "FXXX",
        "timestamp": "2018-01-17T01:17:00Z",
        "series": [
            {
                "Flow Rate ft3/s": 1.0172575712203979,
                "Engine Oil Pressure psi ": 34.7
            },
            {
                "Flow Rate ft3/s": 2.445906400680542,
                "Engine Oil Pressure psi ": 49.2
            }
        ]
    },
    {
        "deviceId": "FYYY",
        "timestamp": "2018-01-17T01:18:00Z",
        "series": [
            {
                "Flow Rate ft3/s": 0.58015072345733643,
                "Engine Oil Pressure psi ": 22.2
            }
        ]
    }
]
```

* Таблица эталонных данных (ключевое свойство — **deviceId**):

   | deviceId | messageId | deviceLocation |
   | --- | --- | --- |
   | FXXX | LINE\_DATA | EU |
   | FYYY | LINE\_DATA | США |

* Таблица событий Аналитики временных рядов (после преобразования в плоскую структуру):

   | deviceId | messageId | deviceLocation |  timestamp | series.Flow Rate ft3/s | series.Engine Oil Pressure psi |
   | --- | --- | --- | --- | --- | --- |
   | FXXX | LINE\_DATA | EU | 2018-01-17T01:17:00Z | 1.0172575712203979 | 34.7 |
   | FXXX | LINE\_DATA | EU | 2018-01-17T01:17:00Z | 2.445906400680542 | 49.2 |
   | FYYY | LINE\_DATA | США | 2018-01-17T01:18:00Z | 0.58015072345733643 | 22.2 |

Выше:

- Столбец **deviceId** служит заголовком столбца для различных устройств в парке автомобилей. Попытка сделать значение столбца deviceId именем его собственного свойства ограничила бы общее количество устройств до 595 (в средах S1) или 795 (в средах S2) с остальными пятью столбцами.

- Необязательные свойства пропускаются, например сведения об изготовителе, марке, модели и т. д. Так как эти свойства не будут запрашиваться в будущем, их исключение позволяет повысить эффективность сети и хранилища.

- Эталонные данные используются для сокращения количества байтов, передаваемых по сети. Два атрибута **messageId** и **deviceLocation**, соединяются с использованием свойство ключа **deviceId**. Эти данные объединена с данные телеметрии во время входа и впоследствии хранятся в Time Series Insights для выполнения запросов.

- Используются два уровня вложенности, которой является максимальным вложенности, поддерживаемых Time Series Insights. Критически важно избегать глубоко вложенных массивов.

- Меры передаются в виде отдельных свойств в одном и том же объекте, так как у нас есть несколько мер. Здесь **series.Flow Rate psi** и **series.Engine Oil Pressure ft3/s** — уникальные столбцы.

## <a name="scenario-two-several-measures-exist"></a>Сценарий 2: существует несколько мер

> [!TIP]
> **Рекомендация:** отправляйте измерения в виде кортежей type, unit и value.

Пример полезных данных JSON:

```json
[
    {
        "deviceId": "FXXX",
        "timestamp": "2018-01-17T01:17:00Z",
        "series": [
            {
                "tagId": "pumpRate",
                "value": 1.0172575712203979
            },
            {
                "tagId": "oilPressure",
                "value": 49.2
            },
            {
                "tagId": "pumpRate",
                "value": 2.445906400680542
            },
            {
                "tagId": "oilPressure",
                "value": 34.7
            }
        ]
    },
    {
        "deviceId": "FYYY",
        "timestamp": "2018-01-17T01:18:00Z",
        "series": [
            {
                "tagId": "pumpRate",
                "value": 0.58015072345733643
            },
            {
                "tagId": "oilPressure",
                "value": 22.2
            }
        ]
    }
]
```

* Эталонные данные (ключевые свойства являются **deviceId** и **series.tagId**):

   | deviceId | series.tagId | messageId | deviceLocation | тип | единица измерения |
   | --- | --- | --- | --- | --- | --- |
   | FXXX | pumpRate | LINE\_DATA | EU | Скорость потока | ft3/s |
   | FXXX | oilPressure | LINE\_DATA | EU | Давление масла в двигателе | psi |
   | FYYY | pumpRate | LINE\_DATA | США | Скорость потока | ft3/s |
   | FYYY | oilPressure | LINE\_DATA | США | Давление масла в двигателе | psi |

* Таблица событий Аналитики временных рядов (после преобразования в плоскую структуру):

   | deviceId | series.tagId | messageId | deviceLocation | тип | единица измерения |  timestamp | series.value |
   | --- | --- | --- | --- | --- | --- | --- | --- |
   | FXXX | pumpRate | LINE\_DATA | EU | Скорость потока | ft3/s | 2018-01-17T01:17:00Z | 1.0172575712203979 | 
   | FXXX | oilPressure | LINE\_DATA | EU | Давление масла в двигателе | psi | 2018-01-17T01:17:00Z | 34.7 |
   | FXXX | pumpRate | LINE\_DATA | EU | Скорость потока | ft3/s | 2018-01-17T01:17:00Z | 2.445906400680542 | 
   | FXXX | oilPressure | LINE\_DATA | EU | Давление масла в двигателе | Psi | 2018-01-17T01:17:00Z | 49.2 |
   | FYYY | pumpRate | LINE\_DATA | США | Скорость потока | ft3/s | 2018-01-17T01:18:00Z | 0.58015072345733643 |
   | FYYY | oilPressure | LINE\_DATA | США | Давление масла в двигателе | psi | 2018-01-17T01:18:00Z | 22.2 |

Выше:

- Столбцы **deviceId** и **series.tagId** служат в качестве заголовков столбцов для различных устройств и тегов в парка. Использование каждого из них в качестве собственного атрибута ограничило бы запрос общим количеством устройств 594 (в средах S1) или 794 (в средах S2) с шестью остальными столбцами.

- были избежать ненужных свойств, причина состоит в первом примере.

- ссылочные данные используется для сокращения числа байтов, передаваемых по сети путем введения **deviceId**, для уникальных пары **messageId** и **deviceLocation**. Используется составной ключ **series.tagId** для уникальной пары **type** и **unit**. Составной ключ позволяет использовать пару **deviceId** и **series.tagId** для ссылки на четыре значения: **messageId, deviceLocation, type** и **unit**. Эти данные объединена с данные телеметрии во время входа и впоследствии хранятся в Time Series Insights для выполнения запросов.

- по той причине, указанных в первом примере используются два уровня вложения.

### <a name="for-both-scenarios"></a>Для обоих сценариев

При наличии свойства с большим количеством возможных значений рекомендуется передавать уникальные значения в едином столбце, а не создавать новый столбец для каждого значения. Из предыдущих двух примеров:

  - В первом примере существует несколько свойств, которые имеют несколько значений, поэтому их оптимально реализовать в виде отдельных свойств.
  - Однако во втором примере видно, что меры указаны не в виде отдельных свойств, а в виде массива значений и мер под общим свойством series. Передается новый ключ **tagId**, который создает новый столбец **series.tagId** в таблице, преобразованной в плоскую структуру. Создаются новые свойства **type** и **unit** с использованием эталонных данных, что позволяет предотвратить достижение ограничения на число свойств.

## <a name="next-steps"></a>Дальнейшие действия

- Чтение [синтаксис запроса Azure Time Series Insights](/rest/api/time-series-insights/ga-query-syntax) Дополнительные сведения о синтаксисе запросов для доступа к данным Time Series Insights REST API.

- Узнайте, [как события фигуры](./time-series-insights-send-events.md).
