---
title: Хранилище данных и входящий трафик в Аналитике временных рядов Azure (предварительная версия) | Документация Майкрософт
description: Сведения о хранилище данных и входящем трафик в Аналитике временных рядов Azure (предварительная версия).
author: lyrana
ms.author: lyhughes
manager: cshankar
ms.workload: big-data
ms.service: time-series-insights
services: time-series-insights
ms.topic: conceptual
ms.date: 04/27/2020
ms.custom: seodec18
ms.openlocfilehash: d3bfb589ec4c152b136e8e1f432864b719c97d58
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85509325"
---
# <a name="data-storage-and-ingress-in-azure-time-series-insights-preview"></a>Хранилище данных и входящий трафик в Аналитике временных рядов Azure (предварительная версия)

В этой статье описаны обновления в хранилище данных и входящем трафике для Аналитики временных рядов Azure (предварительная версия). Здесь рассматриваются базовая структура хранилища, формат файла и свойство идентификатора временных рядов. В статье также содержатся сведения о базовом процессе приема, текущих ограничениях предварительной версии и приводятся соответствующие рекомендации.

## <a name="data-ingress"></a>Прием данных

Среда Аналитики временных рядов Azure содержит *механизм приема* для сбора, обработки и хранения данных временных рядов.

При [планировании](time-series-insights-update-plan.md) среды следует принимать во внимание некоторые соображения, чтобы обеспечить обработку всех входящих данных, принимать большие объемы трафика и сократить *задержку приема* (время, требуемое Аналитике временных рядов на считывание и обработку данных из источника событий).

Политики входящего трафика Аналитики временных рядов (предварительная версия) определяют источник данных и формат, который должны иметь данные.

### <a name="ingress-policies"></a>Политики входящего трафика

При *приеме данных* необходимо понимать способ отправки данных в среду Аналитики временных рядов (предварительная версия).

Ниже кратко рассматриваются вопросы конфигурации, форматирования, а также приводятся некоторые рекомендации.

#### <a name="event-sources"></a>Источники событий

Аналитика временных рядов Azure (предварительная версия) поддерживает следующие источники событий.

- [Центр Интернета вещей Azure](../iot-hub/about-iot-hub.md)
- [Центры событий Azure](../event-hubs/event-hubs-about.md)

Аналитика временных рядов Azure (предварительная версия) поддерживает не более двух источников событий на один экземпляр. При подключении источника событий среда TSI будет считывать все события, хранящиеся в настоящее время в Центре Интернета вещей или Центре событий, начиная с самого раннего события.

> [!IMPORTANT]
>
> * При подключении источника событий к среде предварительной версии может возникнуть высокая первоначальная задержка.
> Задержка источника событий зависит от числа событий, находящихся в данный момент в Центре Интернета вещей или Центре событий.
> * Высокая задержка сократится после первого приема данных источника событий. Если уровень задержки не снижается, отправьте запрос в службу поддержки на портале Azure.

#### <a name="supported-data-format-and-types"></a>Поддерживаемые типы и форматы данных

Аналитика временных рядов Azure поддерживает данные в формате JSON в кодировке UTF-8, отправляемые из Центра Интернета вещей Azure или Центров событий Azure. 

Ниже приведены поддерживаемые типы данных.

| Тип данных | Описание |
|---|---|
| **bool**; | Тип данных, имеющий одно из двух состояний: `true` или `false`. |
| **dateTime** | Представляет текущее время, обычно выраженное как дата и время суток. Выражено в формате [ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html). |
| **long** | 64-разрядное целое число со знаком  |
| **double** | 64-разрядное значение двойной точности с плавающей запятой (стандарт [IEEE 754](https://ieeexplore.ieee.org/document/8766229)). |
| **строка** | Текстовые значения, состоящие из символов Юникода.          |

> [!IMPORTANT]
>
> * Среда TSI является строго типизированной. Если устройства или теги отправляют как целочисленные, так и Нецелочисленные данные, значения свойств устройства будут храниться в двух разделенных столбцах типа Double и Long, а [функция объединения ()](https://docs.microsoft.com/rest/api/time-series-insights/preview#time-series-expression-and-syntax) должна использоваться при вызове API и определении выражений переменной модели временных рядов.

#### <a name="objects-and-arrays"></a>Объекты и массивы

Сложные типы, такие как объекты и массивы, можно отправлять в составе полезных данных, но при хранении к данным будет применено выравнивание (преобразование в плоскую структуру).

Советы по планированию и оптимизации с подробными сведениями о формировании событий JSON, отправке сложных типов и выравнивании вложенных объектов см. в статье об [использовании JSON для входящего трафика и запросов](./time-series-insights-update-how-to-shape-events.md).

### <a name="ingress-best-practices"></a>Рекомендации по приему данных

Рекомендуется придерживаться следующих советов.

* Настраивайте Аналитику временных рядов Azure и Центр Интернета вещей или Центр событий в одном регионе, что позволит сократить возможную задержку.

* [Планируйте потребности масштабирования](time-series-insights-update-plan.md) — рассчитайте ожидаемую скорость приема и убедитесь, что она входит в приведенный ниже диапазон значений.

* Узнайте, как оптимизировать и сформировать данные JSON, а также текущие ограничения в предварительной версии, ознакомившись со статьей об [использовании JSON для входящего трафика и запросов](./time-series-insights-update-how-to-shape-events.md).

* Используйте потоковый прием только для последних данных и данных практически в реальном времени. Потоковая передача исторических данных не поддерживается.

#### <a name="historical-data-ingestion"></a>Прием данных за прошедшие периоды

Сейчас использование конвейера потоковой передачи для импорта данных за прошедшие периоды не поддерживается в Аналитике временных рядов Azure (предварительная версия). Чтобы импортировать в среду данные за прошедшие периоды, следуйте приведенным ниже рекомендациям.

* Не выполняйте параллельную потоковую передачу динамических и исторических данных. Прием неупорядоченных данных приведет к снижению производительности запросов.
* Для достижения оптимальной производительности принимайте данные за прошлые периоды в хронологической последовательности.
* Не выходите за рамки приведенных ниже диапазонов скорости приема.
* Отключите теплое хранилище, если данные старше, чем срок хранения в теплом хранилище.

### <a name="ingress-scale-and-preview-limitations"></a>Масштабирование входящего трафика и ограничения предварительной версии

Ниже приводятся ограничения для входящего трафика Аналитики временных рядов Azure (предварительная версия).

> [!TIP]
> Полный список всех ограничений предварительной версии см. в статье о [планировании среды](https://docs.microsoft.com/azure/time-series-insights/time-series-insights-update-plan#review-preview-limits).

#### <a name="per-environment-limitations"></a>Ограничения на среду

Как правило, скорость входящего трафика рассматривается как произведение числа устройств в организации, частоты отправки событий и размера каждого события:

*  **число устройств** × **частота отправки событий** × **размер каждого события**.

По умолчанию Аналитика временных рядов (предварительная версия) может принимать входящие данные со скоростью **до 1 МБ в секунду (Мбит/с) в каждой среде Аналитики временных рядов**. Существуют дополнительные ограничения [для каждой секции центра](https://docs.microsoft.com/azure/time-series-insights/time-series-insights-update-storage-ingress#hub-partitions-and-per-partition-limits).

> [!TIP]
>
> * Поддержка скоростей приема до 16 Мбит/с предоставляется по запросу.
> * Если вам требуется более высокая пропускная способность, свяжитесь с нами, отправив запрос в службу поддержки не портале Azure.
 
* **Пример 1**.

    В Contoso Shipping имеется 100 000 устройств, которые создают событие три раза в минуту. Размер события составляет 200 байт. В качестве источника событий Аналитики временных рядов используется Центр Интернета вещей с четырьмя секциями.

    * Скорость приема для среды Аналитики временных рядов рассчитывается следующим образом: **100 000 устройств * 200 байт/событие * (3/60 событий/с) = 1 Мбит/с**.
    * Скорость приема на раздел составит 0,25 Мбит/с.
    * Скорость приема в Contoso Shipping находится в пределах ограничения предварительной версии.

* **Пример 2.**

    В Contoso Fleet Analytics имеется 60 000 устройств, каждое из которых создает событие каждую секунду. В качестве источника событий Аналитики временных рядов используется Центр событий с четырьмя секциями. Размер события составляет 200 байт.

    * Скорость приема рассчитывается следующим образом: **60 000 устройств * 200 байт/событие * (1 событие/с) = 12 Мбит/с**.
    * Скорость приема на секцию составит 3 Мбит/с.
    * Скорость приема в Contoso Fleet Analytics превышает ограничения, заданные для среды и секции. Чтобы оставаться в пределах ограничений предварительной версии, Сотрудники могут отправить запрос в службу поддержки Аналитики временных рядов на повышение скорости приема для своей среды, и создать Центр событий с дополнительными секциями.

#### <a name="hub-partitions-and-per-partition-limits"></a>Секции центра и ограничения на секцию

При планировании среды Аналитики временных рядов важно учитывать конфигурацию источников событий, которые будут подключены к Аналитике временных рядов. Для включения горизонтального масштабирования в целях обработки событий Центр Интернета вещей Azure и Центры событий используют секции. 

*Секция* — это упорядоченная последовательность событий, хранящаяся в центре. Число секций задается на этапе создания центра и не может быть изменено.

Рекомендации по секционированию Центров событий см. в разделе о [необходимом количестве секций](https://docs.microsoft.com/azure/event-hubs/event-hubs-faq#how-many-partitions-do-i-need).

> [!NOTE]
> Большинству Центров Интернета вещей, используемых в Аналитике временных рядов Azure, требуется всего четыре секции.

Независимо от того, создаете ли вы новый центр для среды Аналитики временных рядов или используете существующий, вам потребуется рассчитать скорость приема для каждой секции, чтобы определить, находится ли она в пределах ограничений предварительной версии. 

Сейчас в Аналитике временных рядов Azure (предварительная версия) установлен общий **предел для каждой секции, равный 0,5 Мбит/с**.

#### <a name="iot-hub-specific-considerations"></a>Специфика работы с Центром Интернета вещей

Создаваемому в Центре Интернета вещей устройству назначается секция на постоянной основе. В этом случае Центр Интернета вещей может гарантировать упорядочение событий (так как назначение никогда не меняется).

Фиксированное назначение секции также влияет на экземпляры Аналитики временных рядов, которые принимают данные, отправляемые из нижестоящего Центра Интернета вещей. Когда сообщения с нескольких устройств перенаправляются в центр с помощью одного идентификатора устройства шлюза, они могут поступить в одну секцию одновременно, что может привести к превышению ограничений на масштаб каждой секции.

**Влияние**.

* Если в одной секции скорость приема данных постоянно превышает ограничение предварительной версии, возможно, Аналитика временных рядов не будет синхронизировать все данные телеметрии устройств, пока не будет превышен срок хранения данных в Центре Интернета вещей. При постоянном превышении ограничений приема отправленные данные могут быть потеряны.

Чтобы избежать подобных ситуаций, рекомендуются следующие методы.

* Перед развертыванием решения рассчитайте скорость приема на секцию.
* Оптимально распределите нагрузку на устройства Центра Интернета.

> [!IMPORTANT]
> Для сред, использующих Центр Интернета вещей в качестве источника событий, рассчитайте скорость приема, принимая во внимание число используемых устройств, чтобы скорость не превышала ограничение предварительной версии, составляющее 0,5 Мбит/с на секцию.
>
> * Ограничение предварительной версии не будет превышено даже при одновременном поступлении нескольких событий.

  ![Диаграмма секций Центра Интернета вещей](media/concepts-ingress-overview/iot-hub-partiton-diagram.png)

Дополнительные сведения об оптимизации пропускной способности центра и секций см. в следующих ресурсах:

* [Масштаб центра Интернета вещей](https://docs.microsoft.com/azure/iot-hub/iot-hub-scaling)
* [Масштаб Центра событий](https://docs.microsoft.com/azure/event-hubs/event-hubs-scalability#throughput-units)
* [Секции Центра событий](https://docs.microsoft.com/azure/event-hubs/event-hubs-features#partitions)

### <a name="data-storage"></a>Хранилище данных

При создании среды SKU Аналитики временных рядов (предварительная версия) *с оплатой по мере использования* вы создаете два ресурса Azure:

* Среда Аналитики временных рядов (предварительная версия), которую можно настроить для теплого хранения данных.
* Учетная запись BLOB-объекта хранилища Azure общего назначения версии 1 для холодного хранения данных.

Данные в теплом хранилище доступны только через [запросы временных рядов](./time-series-insights-update-tsq.md) и [обозреватель Аналитики временных рядов (предварительная версия)](./time-series-insights-update-explorer.md). Последние данные будут храниться в теплом хранилище в течение [срока хранения](./time-series-insights-update-plan.md#the-preview-environment), выбранного при создании среды Аналитики временных рядов.

Аналитика временных рядов (предварительная версия) сохраняет данные холодного хранилища в хранилище BLOB-объектов Azure в [формате файлов Parquet](#parquet-file-format-and-folder-structure). Аналитика временных рядов (предварительная версия) управляет только этими данными, но они доступны для чтения в виде стандартных файлов Parquet.

> [!WARNING]
> Владелец учетной записи хранения BLOB-объектов Azure, где находятся данные холодного хранилища, имеет полный доступ ко всем данным в учетной записи. В эти права доступа входят разрешения на запись и удаление. Не изменяйте и не удаляйте данные, записываемые Аналитикой временных рядов (предварительная версия), так как это может привести к потере данных.

### <a name="data-availability"></a>Доступность данных

Аналитика временных рядов (предварительная версия) секционирует и индексирует данные для обеспечения оптимальной производительности запросов. После индексирования данные становятся доступными для запросов из горячего (если включено) и холодного хранилищ. Доступность данных зависит от объема принимаемых данных.

> [!IMPORTANT]
> При работе с предварительной версией может возникать 60-секундная задержка доступа к данным. Если уровень задержки значительно выше, отправьте запрос в службу поддержки на портале Azure.

## <a name="azure-storage"></a>Хранилище Azure

В этом разделе приводятся сведения о службе хранилища Azure, относящиеся к Аналитике временных рядов (предварительная версия).

Подробное описание хранилища BLOB-объектов Azure см. в статье [Общие сведения о хранилище BLOB-объектов Azure](../storage/blobs/storage-blobs-introduction.md).

### <a name="your-storage-account"></a>Ваша учетная запись хранения

При создании среды Аналитики временных рядов Azure (предварительная версия) с оплатой по мере использования создается учетная запись BLOB-объекта хранилища Azure общего назначения версии 1, которая будет выполнять роль долгосрочного холодного хранилища.  

В вашей учетной записи хранения Azure Аналитика временных рядов (предварительная версия) сохраняет до двух копий каждого события. Одна копия хранит события, упорядоченные по времени приема, всегда разрешая доступ к событиям в упорядоченной по времени последовательности. Со временем Аналитика временных рядов (предварительная версия) также создает повторно секционированную копию данных для оптимизации производительности запросов Аналитики временных рядов.

На этапе общедоступной предварительной версии данные хранятся неограниченное время в вашей учетной записи хранения Azure.

#### <a name="writing-and-editing-time-series-insights-blobs"></a>Записывание и изменение больших двоичных объектов Аналитики временных рядов

Чтобы обеспечить производительность и доступность данных, не изменяйте и не удаляйте BLOB-объекты, созданные с помощью Аналитики временных рядов (предварительная версия).

#### <a name="accessing-time-series-insights-preview-cold-store-data"></a>Доступ к данным в холодном хранилище Аналитики временных рядов (предварительная версия)

Помимо доступа к данным из [обозревателя Аналитики временных рядов (предварительная версия)](./time-series-insights-update-explorer.md) и [запросов временных рядов](./time-series-insights-update-tsq.md), вам также может потребоваться доступ к данным напрямую из файлов Parquet, хранящихся в холодном хранилище. Например, можно считывать, преобразовывать и очищать данные в записной книжке Jupyter, а затем использовать их для обучения модели Машинного обучения Azure в том же рабочем процессе Spark.

Для доступа к данным напрямую из учетной записи хранения Azure необходим доступ на чтение к учетной записи, используемой для хранения данных Аналитики временных рядов (предварительная версия). Затем можно считывать выбранные данные на основе времени создания файла Parquet, расположенного в папке `PT=Time`, описанной ниже в разделе [Формат файла Parquet](#parquet-file-format-and-folder-structure).  Дополнительные сведения о включении доступа на чтение для учетной записи хранения см. в статье об [управлении доступом к ресурсам учетной записи хранения](../storage/blobs/storage-manage-access-to-resources.md).

#### <a name="data-deletion"></a>Удаление данных

Не удаляйте файлы Аналитики временных рядов (предварительная версия). Управляйте связанными данными только в Аналитике временных рядов (предварительная версия).

### <a name="parquet-file-format-and-folder-structure"></a>Формат файла Parquet и структура папок

Parquet — это формат столбца с открытым исходным кодом, предназначенный для эффективного хранения и производительности. Аналитика временных рядов (предварительная версия) использует Parquet для масштабного включения производительности запросов на основе идентификатора.  

Дополнительные сведения о типе файла Parquet см. в [документации по Parquet](https://parquet.apache.org/documentation/latest/).

Аналитика временных рядов (предварительная версия) сохраняет копии данных следующим образом.

* Первая начальная копия секционируется по времени приема и сохраняет данные в примерном порядке поступления. Эти данные содержатся в папке `PT=Time`:

  `V=1/PT=Time/Y=<YYYY>/M=<MM>/<YYYYMMDDHHMMSSfff>_<TSI_INTERNAL_SUFFIX>.parquet`

* Вторая повторно секционированная копия группируется по идентификаторам временных рядов и находится в папке `PT=TsId`:

  `V=1/PT=TsId/<TSI_INTERNAL_STRUCTURE>/<TSI_INTERNAL_NAME>.parquet`

Метка времени в именах больших двоичных объектов в `PT=Time` папке соответствует времени прибытия TSI данных (а не метки времени событий).

С течением времени данные в папке `PT=TsId` будут оптимизированы для запросов и не являются статическими. Во время повторного секционирования одни и те же события могут присутствовать в нескольких больших двоичных объектах. Кроме того, имена больших двоичных объектов могут измениться в будущем.

> [!NOTE]
>
> * `<YYYY>` сопоставляется с представлением 4-значного числа года.
> * `<MM>` сопоставляется с представлением 2-значного числа месяца.
> * `<YYYYMMDDHHMMSSfff>` сопоставляется с представлением отметки времени с 4-значным числом года (`YYYY`), 2-значным числом месяца (`MM`), 2-значным числом дня (`DD`), 2-значным числом часа (`HH`), 2-значным числом минуты (`MM`), 2-значным числом секунды (`SS`) и 3-значным числом миллисекунды (`fff`).

События Аналитики временных рядов (предварительная версия) сопоставляются с содержимым файла Parquet следующим образом.

* Каждое событие сопоставляется с отдельной строкой.
* Каждая строка содержит столбец **метки времени** с меткой времени события. Свойство time-stamp никогда не имеет значение NULL. Если свойство time-stamp не указано в источнике событий, по умолчанию используется **время постановки события в очередь**. Сохраненная метка времени всегда имеет формат UTC.
* Каждая строка содержит столбцы идентификаторов временных рядов (TSID), как определено при создании среды Аналитики временных рядов. Имя свойства TSID содержит суффикс `_string`.
* Все остальные свойства, отправляемые как данные телеметрии, сопоставлены с именами столбцов, заканчивающимися на `_string` (string), `_bool` (Boolean), `_datetime` (datetime) и `_double` (double) в зависимости от типа свойства.
* Эта схема сопоставления применяется к первой версии формата файла (**V=1**) и хранится в базовой папке с тем же именем. По мере развития этой функции схема сопоставления может измениться, а номер версии — увеличиться.

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте, как [использовать JSON для входящего трафика и запросов](./time-series-insights-update-how-to-shape-events.md).

- О новой модели данных читайте [здесь](./time-series-insights-update-tsm.md).
