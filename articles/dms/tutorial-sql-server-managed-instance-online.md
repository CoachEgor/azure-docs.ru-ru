---
title: Руководство. Миграция SQL Server в оперативный режим в управляемый экземпляр SQL
titleSuffix: Azure Database Migration Service
description: Узнайте, как перенести базу данных из локального экземпляра SQL Server в управляемый экземпляр Базы данных SQL Azure по сети с помощью Azure Database Migration Service.
services: dms
author: HJToland3
ms.author: jtoland
manager: craigg
ms.reviewer: craigg
ms.service: dms
ms.workload: data-services
ms.custom: seo-lt-2019
ms.topic: article
ms.date: 01/10/2020
ms.openlocfilehash: 236c68b3c26049073d3e6e942ce2a6be8b7f4fde
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "80298908"
---
# <a name="tutorial-migrate-sql-server-to-an-azure-sql-database-managed-instance-online-using-dms"></a>Руководство. Миграция SQL Server в управляемый экземпляр базы данных SQL Azure в сети с помощью DMS

Azure Database Migration Service можно использовать для переноса баз данных из локального экземпляра SQL Server в [управляемый экземпляр Базы данных SQL Azure](../sql-database/sql-database-managed-instance.md) с минимальным временем простоя в работе приложений. Дополнительные методы, которые могут потребовать определенных действий вручную, см. в статье [SQL Server миграция экземпляра в управляемый экземпляр базы данных SQL Azure](../sql-database/sql-database-managed-instance-migrate.md).

В этом учебнике описано, как выполнять миграцию базы данных **Adventureworks2012** из локального экземпляра SQL Server в управляемый экземпляр Базы данных SQL Azure с помощью Azure Database Migration Service с минимальным временем простоя.

В этом руководстве описано следующее:
> [!div class="checklist"]
>
> * создание экземпляра Azure Database Migration Service;
> * создание проекта миграции и запуск миграции по сети с помощью Azure Database Migration Service;
> * мониторинг миграции.
> * Когда будете готовы, выполните прямую миграцию.

> [!IMPORTANT]
> Чтобы выполнить миграцию по сети из SQL Server в управляемый экземпляр Базы данных SQL Azure с помощью Azure Database Migration Service, поместите полную резервную копию и последующие резервные копии журналов в сетевую папку SMB, которые служба может использовать для миграции баз данных. Azure Database Migration Service не инициирует создание резервных копий, вместо этого он использует для миграции существующие резервные копии, которые уже могли быть созданы в рамках плана аварийного восстановления.
> Выбирайте [резервные копии, используя параметр WITH CHECKSUM](https://docs.microsoft.com/sql/relational-databases/backup-restore/enable-or-disable-backup-checksums-during-backup-or-restore-sql-server?view=sql-server-2017). Также убедитесь, что не добавили несколько резервных копий (например, полную копию и журнал транзакций) на один носитель резервных копий. Сохраняйте каждую резервную копию в отдельный файл. Наконец, чтобы снизить вероятность возникновения потенциальных проблем, связанных с миграцией больших объемов резервных копий, можно использовать сжатые резервные копии.

> [!NOTE]
> Чтобы выполнить сетевую миграцию с помощью Azure Database Migration Service, требуется создать экземпляр ценовой категории "Премиум".

> [!IMPORTANT]
> Чтобы процесс миграции был выполнен без проблем, корпорация Майкрософт рекомендует создать экземпляр Azure Database Migration Service в том же регионе Azure, в котором размещена целевая база данных. Перемещение данных между регионами и географическими областями может замедлить процесс миграции и привести к ошибкам.

> [!IMPORTANT]
> Сократите продолжительность процесса оперативной миграции настолько, насколько это возможно, чтобы свести к сведению риск перенастройки экземпляра или планового обслуживания. В случае такого события процесс миграции начнется с самого начала. В случае планового обслуживания существует льготный период в 36 часов до перезапуска процесса миграции.

[!INCLUDE [online-offline](../../includes/database-migration-service-offline-online.md)]

В этой статье описывается перенос данных из SQL Server в управляемый экземпляр Базы данных SQL Azure по сети. Сведения о переносе в автономном режиме см. в руководстве [Перенос SQL Server в Управляемый экземпляр Базы данных SQL Azure с помощью DMS в автономном режиме](tutorial-sql-server-to-managed-instance.md).

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством вам потребуется следующее:

* Создайте виртуальная сеть Microsoft Azure для Azure Database Migration Service с помощью модели развертывания Azure Resource Manager, которая обеспечивает подключение типа "сеть — сеть" к локальным исходным серверам с помощью [ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-introduction) или [VPN](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways). [Изучите сетевые топологии для переноса в управляемый экземпляр Базы данных Azure SQL с помощью Azure Database Migration Service](https://aka.ms/dmsnetworkformi). Дополнительные сведения о создании виртуальной сети см. в [документации по виртуальной сети](https://docs.microsoft.com/azure/virtual-network/), особенно в кратком руководстве, где приведены пошаговые инструкции.

    > [!NOTE]
    > При установке виртуальной сети с помощью ExpressRoute с пирингом сети в корпорацию Майкрософт добавьте следующие [конечные точки](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoints-overview) службы в подсеть, в которой будет подготовлена служба:
    >
    > * целевую конечную точку базы данных (например, конечная точка SQL, конечная точка Cosmos DB и т. д.);
    > * конечную точку службы хранилища;
    > * конечную точку служебной шины.
    >
    > Такая конфигурация вызвана тем, что у Azure Database Migration Service нет подключения к Интернету.
    >
    >Если у вас нет подключения типа "сеть — сеть" между локальной сетью и Azure, или если пропускная способность подключения "сеть — сеть" ограничена, рекомендуется использовать Azure Database Migration Service в гибридном режиме (Предварительная версия). Гибридный режим использует локальный рабочий процесс миграции вместе с экземпляром Azure Database Migration Service, который работает в облаке. Сведения о создании экземпляра Azure Database Migration Service в гибридном режиме см. в статье [Создание экземпляра Azure Database Migration Service в гибридном режиме с помощью портала Azure](https://aka.ms/dms-hybrid-create).

    > [!IMPORTANT]
    > В отношении учетной записи хранения, используемой в процессе миграции, необходимо:
    > * разрешить всем сетям доступ к учетной записи хранения;
    > * Включите [Делегирование подсети](https://docs.microsoft.com/azure/virtual-network/manage-subnet-delegation) в подсети MI и обновите правила брандмауэра для учетной записи хранения, чтобы разрешить эту подсеть.

* Убедитесь, что правила группы безопасности сети виртуальной сети не блокируют следующие порты входящих подключений для Azure Database Migration Service: 443, 53, 9354, 445, 12000. Дополнительные сведения о фильтрации трафика NSG в виртуальной сети см. в статье [Фильтрация сетевого трафика с помощью групп безопасности сети](https://docs.microsoft.com/azure/virtual-network/virtual-networks-nsg).
* Настройте [брандмауэр Windows для доступа к ядру исходной СУБД](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access).
* Откройте брандмауэр Windows, чтобы предоставить Azure Database Migration Service доступ к исходному серверу SQL Server. По умолчанию это TCP-порт 1433.
* Если вы запустили несколько именованных экземпляров SQL Server, использующих динамические порты, вы можете включить службу обозревателя SQL и разрешить доступ к UDP-порту 1434 через брандмауэры. Это позволит службе Azure Database Migration Service подключиться к именованному экземпляру на исходном сервере.
* Если перед исходными базами данных используется брандмауэр, его правила должны разрешать службе Azure Database Migration Service доступ к исходным базам данных для миграции и файлам SMB через порт 445.
* Создайте управляемый экземпляр Базы данных SQL, следуя инструкциям из статьи [Краткое руководство. Создание управляемого экземпляра Базы данных SQL Azure](https://aka.ms/sqldbmi).
* Убедитесь, что для подключения к исходному серверу SQL Server и целевому управляемому экземпляру используются имена, входящие в серверную роль sysadmin.
* Укажите сетевую папку SMB, содержащую все файлы полных резервных копий базы данных и файлы резервных копий журнала транзакций, которые могут использоваться службой Azure Database Migration Service для миграции базы данных.
* Предоставьте учетной записи службы, от имени которой выполняется исходный экземпляр SQL Server, права на запись в эту созданную сетевую папку, а учетной записи компьютера для исходного сервера — права на чтение и запись для этой папки.
* Запишите имя пользователя и пароль учетной записи Windows, которой предоставлены полные права доступа к этой сетевой папке. Azure Database Migration Service олицетворяет учетные данные пользователя, чтобы передать файлы резервных копий в контейнер службы хранилища Azure для операции восстановления.
* Создайте идентификатор приложения Azure Active Directory, создающего ключ идентификатора приложения, который может использоваться службой DMS для подключения к целевому управляемому экземпляру Базы данных SQL Azure и контейнеру службы хранилища Azure. Дополнительные сведения см. в статье [Создание приложения Azure Active Directory и субъекта-службы с доступом к ресурсам с помощью портала](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-create-service-principal-portal).

  > [!NOTE]
  > DMS необходимо разрешение участника в подписке для указанного идентификатора приложения. Кроме того, вы можете создать пользовательские роли, предоставляющие определенные разрешения, которые требует Azure Database Migration Service. Пошаговые инструкции по использованию пользовательских ролей см. в статье [Custom roles for SQL Server to SQL Database managed instance online migrations](https://docs.microsoft.com/azure/dms/resource-custom-roles-sql-db-managed-instance) (Пользовательские роли для миграций SQL Server к управляемому экземпляру базы данных SQL в сети).

* Создайте и запишите учетную запись хранения Azure с **уровнем производительности "Стандартный"**, которая позволяет службе DMS передавать файлы резервной копии базы данных и использовать их для переноса баз данных.  Убедитесь, что учетная запись хранения Azure создана в том же регионе, что и экземпляр службы DMS.

## <a name="register-the-microsoftdatamigration-resource-provider"></a>Регистрация поставщика ресурсов Microsoft.DataMigration

1. Войдите на портал Azure, щелкните **Все службы** и выберите **Подписки**.

    ![Отображение подписок на портале](media/tutorial-sql-server-to-managed-instance-online/portal-select-subscriptions.png)

2. Выберите подписку, в которой нужно создать экземпляр Azure Database Migration Service, а затем щелкните **Поставщики ресурсов**.

    ![Отображение поставщиков ресурсов](media/tutorial-sql-server-to-managed-instance-online/portal-select-resource-provider.png)

3. Найдите миграцию, а затем справа от **Microsoft. Migration**выберите **Register**.

    ![Регистрация поставщика ресурсов](media/tutorial-sql-server-to-managed-instance-online/portal-register-resource-provider.png)

## <a name="create-an-azure-database-migration-service-instance"></a>Создание экземпляра Azure Database Migration Service

1. В портал Azure выберите + **создать ресурс**, найдите **Azure Database Migration Service**, а затем выберите **Azure Database Migration Service** из раскрывающегося списка.

     ![Azure Marketplace](media/tutorial-sql-server-to-managed-instance-online/portal-marketplace.png)

2. На экране **Azure Database Migration Service** выберите **Создать**.

    ![Создание экземпляра Azure Database Migration Service](media/tutorial-sql-server-to-managed-instance-online/dms-create1.png)

3. На экране **Создание службы миграции** укажите имя службы, подписку и новую или существующую группу ресурсов.

4. Выберите расположение, в котором хотите создать экземпляр DMS.

5. Выберите существующую виртуальную сеть или создайте ее.

    Виртуальная сеть предоставляет Azure Database Migration Service с доступом к исходному SQL Server и целевому управляемому экземпляру базы данных SQL.

    Дополнительные сведения о создании виртуальной сети в портал Azure см. в статье [Создание виртуальной сети с помощью портал Azure](https://aka.ms/DMSVnet).

    Подробные сведения см. в статье [Сетевые топологии для переноса Управляемого экземпляра Базы данных Azure SQL с помощью Azure Database Migration Service](https://aka.ms/dmsnetworkformi).

6. Выберите номер SKU ценовой категории "Премиум".

    > [!NOTE]
    > Миграция по сети поддерживается, только если используется уровень "Премиум".

    Дополнительные сведения о затратах и ценовых категориях см. на [странице с ценами](https://aka.ms/dms-pricing).

    ![Создание службы DMS](media/tutorial-sql-server-to-managed-instance-online/dms-create-service3.png)

7. Выберите **Создать**, чтобы создать службу.

## <a name="create-a-migration-project"></a>Создание проекта миграции

После создания экземпляра службы найдите его на портале Azure, откройте и создайте проект миграции.

1. На портале Azure щелкните **Все службы**, выполните поиск по запросу "Azure Database Migration Service" и выберите **Azure Database Migration Services** (Службы Azure Database Migration Service).

    ![Поиск всех экземпляров Azure Database Migration Service](media/tutorial-sql-server-to-managed-instance-online/dms-search.png)

2. На экране **Azure Database Migration Service** найдите имя созданного экземпляра, а затем выберите экземпляр.

3. Выберите **+ Новый проект миграции**.

4. На экране **New migration project** (Новый проект миграции) задайте имя для проекта, в текстовом поле **Source server type** (Тип исходного сервера) выберите **SQL Server**, в текстовом поле **Target server type** (Тип целевого сервера) выберите **Управляемый экземпляр Базы данных SQL Azure**, а затем в разделе **Choose type of activity** (Выберите тип действия) выберите **Online data migration** (Миграция данных по сети).

   ![Создание проекта Azure Database Migration Service](media/tutorial-sql-server-to-managed-instance-online/dms-create-project3.png)

5. Выберите **Create and run activity** (Создать и выполнить действие), чтобы создать проект.

## <a name="specify-source-details"></a>Указание сведений об источнике

1. На экране **Migration source detail** (Сведения об источнике миграции) задайте сведения о подключении для исходного SQL Server.

2. Если на сервере не установлен доверенный сертификат, установите флажок **Доверять сертификату сервера**.

    Если доверенный сертификат не установлен, SQL Server создаст самозаверяющий сертификат при запуске экземпляра. Этот сертификат используется с целью шифрования учетных данных для клиентских подключений.

    > [!CAUTION]
    > TLS-подключения, зашифрованные с помощью самозаверяющего сертификата, не обеспечивают надежную защиту. Они уязвимы для атак "злоумышленник в середине". Не следует полагаться на TLS, используя самозаверяющие сертификаты в рабочей среде или на серверах, подключенных к Интернету.

   ![Сведения об источнике](media/tutorial-sql-server-to-managed-instance-online/dms-source-details2.png)

3. Щелкните **Сохранить**.

4. На экране **Выбор баз данных-источников** выберите базу данных **Adventureworks2012** для миграции.

   ![Выбор баз данных-источников](media/tutorial-sql-server-to-managed-instance-online/dms-source-database1.png)

    > [!IMPORTANT]
    > При использовании MSSQL Integration Services (SSIS), DMS не поддерживает перенос базы данных каталога для проектов или пакетов служб SSIS (SSISDB) из SQL Server в управляемый экземпляр Базы данных SQL Azure. Но можно подготовить SSIS в Фабрике данных Azure (ADF) и повторно развернуть проекты или пакеты служб SQL Server Integration Services в целевой базе данных SQL Server Integration Services, размещенной в управляемом экземпляре Базы данных SQL Azure. Дополнительные сведения о миграции пакетов SSIS см. в статье [Перенос пакетов SQL Server Integration Services в Azure](https://docs.microsoft.com/azure/dms/how-to-migrate-ssis-packages).

5. Щелкните **Сохранить**.

## <a name="specify-target-details"></a>Указание сведений о цели

1. На экране **Migration target details** (Сведения о целевом объекте миграции) укажите **идентификатор приложения** и **ключ**, которые будут использоваться экземпляром DMS для подключения к целевому экземпляру управляемого экземпляра Базы данных SQL Azure и учетной записи хранения Azure.

    Дополнительные сведения см. в статье [Создание приложения Azure Active Directory и субъекта-службы с доступом к ресурсам с помощью портала](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-create-service-principal-portal).

2. Выберите **подписку** , содержащую целевой экземпляр управляемого экземпляра базы данных SQL Azure, а затем выберите целевой экземпляр.

    Если вы еще не подготовили управляемый экземпляр базы данных SQL Azure, выберите [ссылку](https://aka.ms/SQLDBMI) , которая поможет подготовить экземпляр. Когда управляемый экземпляр Базы данных SQL Azure будет готов, вернитесь к этому проекту, чтобы выполнить миграцию.

3. Укажите **пользователя SQL** и **пароль**, чтобы подключиться к управляемому экземпляру Базы данных SQL Azure.

    ![Выбор цели](media/tutorial-sql-server-to-managed-instance-online/dms-target-details3.png)

4. Щелкните **Сохранить**.

## <a name="select-source-databases"></a>Выбор баз данных-источников

1. На экране **Выбор баз данных-источников** выберите базу данных-источник для миграции.

    ![Выбор баз данных-источников](media/tutorial-sql-server-to-managed-instance-online/dms-select-source-databases2.png)

2. Щелкните **Сохранить**.

## <a name="configure-migration-settings"></a>Настройка параметров миграции

1. На экране **Configure migration settings** (Настройка параметров миграции) укажите следующие сведения:

    | | |
    |--------|---------|
    |**Общая сетевая папка SMB** | Локальная сетевая папка SMB или общая папка Azure, содержащая файлы резервных копий базы данных и файлы резервных копий журнала транзакций, которые могут использоваться службой Azure Database Migration Service для миграции. Учетная запись службы, в которой выполняется исходный экземпляр SQL Server, должна иметь права записи и чтения для этой сетевой папки. Укажите полное доменное имя или IP-адрес сервера и сетевую папку, например "\\\servername.domainname.com\backupfolder" или "\\\IP address\backupfolder". Для повышения производительности рекомендуется использовать отдельную папку для каждой переносимой базы данных. Путь к общей папке на уровне базы данных можно указать с помощью параметра **Дополнительные параметры** . |
    |**User name** | Убедитесь, что пользователь Windows имеет полное право доступа к указанной ранее сетевой папке. Azure Database Migration Service выполнит олицетворение учетных данных пользователя, чтобы отправить файлы резервных копий в контейнер службы хранилища Azure для операции восстановления. При использовании файлового ресурса Azure следует использовать имя учетной записи хранения, предварительно указав в качестве имени пользователя AZURE\. |
    |**Пароль** | Пароль для пользователя Если используется общая папка Azure, в качестве пароля следует указать ключ учетной записи хранения. |
    |**Подписка учетной записи хранения Azure** | Выберите подписку, которая содержит учетную запись хранения Azure. |
    |**Учетная запись хранения Azure** | Выберите учетную запись хранения Azure, в которую служба DMS может отправлять файлы резервной копии из общей сетевой папки SMB, а также использовать эту учетную запись для миграции базы данных.  Рекомендуется выбрать учетную запись хранения в том же регионе, что и служба DMS для получения оптимальной производительности при передаче файлов. |

    ![Настройка параметров миграции](media/tutorial-sql-server-to-managed-instance-online/dms-configure-migration-settings4.png)

    > [!NOTE]
    > Если Azure Database Migration Service отображается ошибка "системная ошибка 53" или "системная ошибка 57", причина может быть вызвана невозможностью Azure Database Migration Service доступа к файловому ресурсу Azure. При возникновении таких ошибок [предоставьте доступ к хранилищу учетной записи из виртуальной сети](https://docs.microsoft.com/azure/storage/common/storage-network-security?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network).

    > [!IMPORTANT]
    > Если функция проверки замыкания на себя включена и исходная SQL Server и общая папка находятся на одном и том же компьютере, источник не сможет получить доступ к файлам, Сурса с помощью полного доменного имени. Чтобы устранить эту проблему, отключите функцию проверки замыкания на себя с помощью приведенных [здесь](https://support.microsoft.com/help/926642/error-message-when-you-try-to-access-a-server-locally-by-using-its-fqd)инструкций.

2. Щелкните **Сохранить**.

## <a name="review-the-migration-summary"></a>Просмотр сводки по миграции

1. На экране **Сводка по миграции** в текстовом поле **Имя активности** задайте имя действия миграции.

2. Проверьте и подтвердите сведения, связанные с проектом миграции.

    ![Сводка по проекту миграции](media/tutorial-sql-server-to-managed-instance-online/dms-project-summary3.png)

## <a name="run-and-monitor-the-migration"></a>Запуск и мониторинг миграции

1. Выберите **Запустить миграцию**.

2. На экране действия миграции, выберите **Обновить**, чтобы обновить отображающиеся данные.

   ![Выполняется действие миграции](media/tutorial-sql-server-to-managed-instance-online/dms-monitor-migration2.png)

    Далее можно развернуть категории баз данных и имен для входа, чтобы отслеживать состояние переноса соответствующих объектов сервера.

   ![Выполняется действие миграции](media/tutorial-sql-server-to-managed-instance-online/dms-monitor-migration-extend2.png)

## <a name="performing-migration-cutover"></a>Выполнение прямой миграции

После восстановления полной резервной копии базы данных на целевом экземпляре управляемого экземпляра Базы данных SQL Azure база данных будет доступна для выполнения прямой миграции.

1. Когда вы будете готовы выполнить миграцию базы данных по сети, щелкните **Start Cutover** (Запустить прямую миграцию).

2. Остановите весь входящий трафик для баз данных-источников.

3. Создайте [резервную копию заключительного фрагмента журнала], сделайте файл резервной копии доступным в сетевой папке SMB и подождите, пока восстановится окончательная резервная копия журнала транзакций.

    На том этапе для параметра **Ожидающие изменения** будет присвоено значение 0.

4. Щелкните **Подтвердить**, а затем — **Apply** (Применить).

    ![Подготовка к выполнению прямой миграции](media/tutorial-sql-server-to-managed-instance-online/dms-complete-cutover.png)

5. Когда состояние переноса базы данных изменится на **завершено**, Подключите свои приложения к новому целевому экземпляру управляемого экземпляра базы данных SQL Azure.

    ![Завершенная прямая миграция](media/tutorial-sql-server-to-managed-instance-online/dms-cutover-complete.png)

## <a name="next-steps"></a>Дальнейшие действия

* Руководство по переносу базы данных на управляемый экземпляр с помощью команды T-SQL RESTORE см. в разделе [Восстановление резервной копии в управляемый экземпляр с помощью команды Restore](../sql-database/sql-database-managed-instance-restore-from-backup-tutorial.md).
* Дополнительные сведения об управляемом экземпляре см. [в разделе что такое управляемый экземпляр](../sql-database/sql-database-managed-instance.md).
* Сведения о подключении приложений к управляемому экземпляру см. в разделе [Connect](../sql-database/sql-database-managed-instance-connect-app.md)Apps.
