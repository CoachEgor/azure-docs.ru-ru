---
title: Руководство. Миграция SQL Server в SQL Управляемый экземпляр
titleSuffix: Azure Database Migration Service
description: Сведения о переходе с SQL Server на Управляемый экземпляр SQL Azure с помощью Azure Database Migration Service.
services: dms
author: pochiraju
ms.author: rajpo
manager: craigg
ms.reviewer: craigg
ms.service: dms
ms.workload: data-services
ms.custom: seo-lt-2019,fasttrack-edit
ms.topic: article
ms.date: 01/08/2020
ms.openlocfilehash: 79bfb0510aba3a77b720748aaafd83e837500e87
ms.sourcegitcommit: 3d79f737ff34708b48dd2ae45100e2516af9ed78
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "87086733"
---
# <a name="tutorial-migrate-sql-server-to-an-azure-sql-managed-instance-offline-using-dms"></a>Руководство. Миграция SQL Server в Управляемый экземпляр SQL Azure в автономном режиме с помощью DMS

Azure Database Migration Service можно использовать для переноса баз данных из экземпляра SQL Server в [управляемый экземпляр Azure SQL](../azure-sql/managed-instance/sql-managed-instance-paas-overview.md). Дополнительные методы, которые могут потребовать определенных действий вручную, см. в статье [SQL Server миграция экземпляра в SQL управляемый экземпляр](../azure-sql/managed-instance/migrate-to-instance-from-sql-server.md).

В этом руководстве вы переносите базу данных **Adventureworks2012** из локального экземпляра SQL Server в управляемый экземпляр SQL с помощью Azure Database Migration Service.

В этом руководстве вы узнаете, как:
> [!div class="checklist"]
>
> - Создайте экземпляр Azure Database Migration Service.
> - создание проекта миграции с использованием Azure Database Migration Service.
> - выполнение миграции.
> - Мониторинг миграции.
> - скачивание отчета о миграции.

> [!IMPORTANT]
> Для автономных миграций с SQL Server на SQL Управляемый экземпляр Azure Database Migration Service могут создавать файлы резервных копий. Кроме того, вы можете указать последнюю полную резервную копию базы данных в сетевой общей папке SMB, которую служба будет использовать для переноса баз данных. Не добавляйте несколько резервных копий на один носитель резервных копий. Сохраняйте каждую резервную копию в отдельный файл. Обратите внимание, чтобы снизить вероятность возникновения потенциальных проблем с миграцией больших объемов резервных копий, можно также использовать сжатые резервные копии.

[!INCLUDE [online-offline](../../includes/database-migration-service-offline-online.md)]

В этой статье описывается автономная миграция с SQL Server на Управляемый экземпляр SQL. Сведения о переносе в сети см. [в статье миграция SQL Server в SQL управляемый экземпляр Online с помощью DMS](tutorial-sql-server-managed-instance-online.md).

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством вам потребуется следующее:

- Создайте виртуальная сеть Microsoft Azure для Azure Database Migration Service с помощью модели развертывания Azure Resource Manager, которая обеспечивает подключение типа "сеть — сеть" к локальным исходным серверам с помощью [ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-introduction) или [VPN](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpngateways). [Изучите сетевые топологии для миграции SQL управляемый экземпляр с помощью Azure Database Migration Service](https://aka.ms/dmsnetworkformi). Дополнительные сведения о создании виртуальной сети см. в [документации по виртуальной сети](https://docs.microsoft.com/azure/virtual-network/), особенно в кратком руководстве, где приведены пошаговые инструкции.

    > [!NOTE]
    > При установке виртуальной сети с помощью ExpressRoute с пирингом сети в корпорацию Майкрософт добавьте следующие [конечные точки](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoints-overview) службы в подсеть, в которой будет подготовлена служба:
    > - целевую конечную точку базы данных (например, конечная точка SQL, конечная точка Cosmos DB и т. д.);
    > - конечную точку службы хранилища;
    > - конечную точку служебной шины.
    >
    > Такая конфигурация вызвана тем, что у Azure Database Migration Service нет подключения к Интернету.

- Убедитесь, что правила группы безопасности сети виртуальной сети не блокируют следующие порты входящих подключений для Azure Database Migration Service: 443, 53, 9354, 445, 12000. Дополнительные сведения о фильтрации трафика NSG в виртуальной сети см. в статье [Фильтрация сетевого трафика с помощью групп безопасности сети](https://docs.microsoft.com/azure/virtual-network/virtual-networks-nsg).
- Настройте [брандмауэр Windows для доступа к ядру исходной СУБД](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access).
- Откройте брандмауэр Windows, чтобы предоставить Azure Database Migration Service доступ к исходному серверу SQL Server. По умолчанию это TCP-порт 1433.
- Если вы запустили несколько именованных экземпляров SQL Server, использующих динамические порты, вы можете включить службу обозревателя SQL и разрешить доступ к UDP-порту 1434 через брандмауэры. Это позволит службе Azure Database Migration Service подключиться к именованному экземпляру на исходном сервере.
- Если перед исходными базами данных используется брандмауэр, его правила должны разрешать службе Azure Database Migration Service доступ к исходным базам данных для миграции и файлам SMB через порт 445.
- Создайте Управляемый экземпляр SQL, следуя сведениям в статье [создание управляемый экземпляр SQL в портал Azure](https://aka.ms/sqldbmi).
- Убедитесь, что имена входа, используемые для подключения исходного SQL Server и целевого Управляемый экземпляр SQL, являются членами роли сервера sysadmin.

    >[!NOTE]
    >По умолчанию Azure Database Migration Service поддерживает только миграцию имен входа SQL. Однако можно включить возможность миграции имен входа Windows следующим образом:
    >
    >- Убедитесь, что целевой SQL-Управляемый экземпляр имеет доступ на чтение AAD, который можно настроить с помощью портал Azure пользователем с ролью " **администратор компании**" или " **глобальный администратор**".
    >- Настройка экземпляра Azure Database Migration Service для включения миграции имени входа пользователя или группы Windows, которая настраивается с помощью портал Azure, на странице Конфигурация. После включения этого параметра перезапустите службу, чтобы изменения вступили в силу.
    >
    > После перезапуска службы в списке имен входа, доступном для миграции, отобразятся имена входа пользователей Windows или группы. Для всех переносимых имен входа пользователей или групп Windows вам будет предложено указать соответствующее доменное имя. Учетные записи пользователей службы (учетная запись с правами администратора) и виртуальные учетные записи пользователей (имя учетной записи с помощью службы NT domain name) не поддерживаются.

- Создайте общую сетевую папку, которую Azure Database Migration Service сможет использовать для резервного копирования базы данных-источника.
- Предоставьте учетной записи службы, от имени которой выполняется исходный экземпляр SQL Server, права на запись в эту созданную сетевую папку, а учетной записи компьютера для исходного сервера — права на чтение и запись для этой папки.
- Запишите имя пользователя и пароль учетной записи Windows, которой предоставлены полные права доступа к этой сетевой папке. Azure Database Migration Service олицетворяет учетные данные пользователя, чтобы передать файлы резервных копий в контейнер службы хранилища Azure для операции восстановления.
- Создайте контейнер больших двоичных объектов и получите его URI SAS, следуя инструкциям, приведенным в разделе [Получение SAS для контейнера больших двоичных объектов](https://docs.microsoft.com/azure/vs-azure-tools-storage-explorer-blobs#get-the-sas-for-a-blob-container), и не забудьте установить все разрешения (чтение, запись, удаление, перечисление) в окне политик при создании URI SAS. Эти сведения предоставляют Azure Database Migration Service с доступом к контейнеру учетной записи хранения для отправки файлов резервных копий, используемых для переноса баз данных в SQL Управляемый экземпляр.

    > [!NOTE]
    > Azure Database Migration Service не поддерживает использование маркера SAS уровня учетной записи при настройке параметров учетной записи хранения на шаге [Настройка параметров миграции](https://docs.microsoft.com/azure/dms/tutorial-sql-server-to-managed-instance#configure-migration-settings) .
    
## <a name="register-the-microsoftdatamigration-resource-provider"></a>Регистрация поставщика ресурсов Microsoft.DataMigration

1. Войдите на портал Azure, щелкните **Все службы** и выберите **Подписки**.

    ![Отображение подписок на портале](media/tutorial-sql-server-to-managed-instance/portal-select-subscriptions.png)

2. Выберите подписку, в которой нужно создать экземпляр Azure Database Migration Service, а затем щелкните **Поставщики ресурсов**.

    ![Отображение поставщиков ресурсов](media/tutorial-sql-server-to-managed-instance/portal-select-resource-provider.png)

3. В поле поиска введите migration, а затем справа от **Microsoft.DataMigration** щелкните **Зарегистрировать**.

    ![Регистрация поставщика ресурсов](media/tutorial-sql-server-to-managed-instance/portal-register-resource-provider.png)

## <a name="create-an-azure-database-migration-service-instance"></a>Создание экземпляра Azure Database Migration Service

1. В портал Azure выберите + **создать ресурс**, найдите **Azure Database Migration Service**, а затем выберите **Azure Database Migration Service** из раскрывающегося списка.

    ![Azure Marketplace](media/tutorial-sql-server-to-managed-instance/portal-marketplace.png)

2. На экране **Azure Database Migration Service** выберите **Создать**.

    ![Создание экземпляра Azure Database Migration Service](media/tutorial-sql-server-to-managed-instance/dms-create1.png)

3. На экране **Создание службы миграции** укажите имя службы, подписку и новую или существующую группу ресурсов.

4. Выберите расположение, в котором хотите создать экземпляр DMS.

5. Выберите существующую виртуальную сеть или создайте ее.

    Виртуальная сеть предоставляет Azure Database Migration Service с доступом к исходному SQL Server и целевому Управляемый экземпляр SQL.

    Дополнительные сведения о создании виртуальной сети в портал Azure см. в статье [Создание виртуальной сети с помощью портал Azure](https://aka.ms/DMSVnet).

    Дополнительные сведения см. в статье [сетевые топологии для миграции управляемый экземпляр Azure SQL с помощью Azure Database Migration Service](https://aka.ms/dmsnetworkformi).

6. Выберите ценовую категорию.

    Дополнительные сведения о затратах и ценовых категориях см. на [странице с ценами](https://aka.ms/dms-pricing).

    ![Создание службы DMS](media/tutorial-sql-server-to-managed-instance/dms-create-service2.png)

7. Выберите **Создать**, чтобы создать службу.

## <a name="create-a-migration-project"></a>Создание проекта миграции

После создания экземпляра службы найдите его на портале Azure, откройте и создайте проект миграции.

1. На портале Azure щелкните **Все службы**, выполните поиск по запросу "Azure Database Migration Service" и выберите **Azure Database Migration Services** (Службы Azure Database Migration Service).

    ![Поиск всех экземпляров Azure Database Migration Service](media/tutorial-sql-server-to-managed-instance/dms-search.png)

2. На экране **Azure Database Migration Service** найдите имя созданного экземпляра, а затем выберите экземпляр.

3. Выберите **+ Новый проект миграции**.

4. На экране **Новый проект миграции** укажите имя проекта, в текстовом поле **Тип исходного сервера** выберите **SQL Server**, в текстовом поле **тип целевого сервера** выберите **управляемый экземпляр SQL Azure**, а затем в списке **выберите тип действия**выберите **Автономная миграция данных**.

   ![Создание проекта DMS](media/tutorial-sql-server-to-managed-instance/dms-create-project2.png)

5. Выберите **Создать**, чтобы создать проект.

## <a name="specify-source-details"></a>Указание сведений об источнике

1. На экране **Migration source detail** (Сведения об источнике миграции) задайте сведения о подключении для исходного SQL Server.

2. Если на сервере не установлен доверенный сертификат, установите флажок **Доверять сертификату сервера**.

    Если доверенный сертификат не установлен, SQL Server создаст самозаверяющий сертификат при запуске экземпляра. Этот сертификат используется с целью шифрования учетных данных для клиентских подключений.

    > [!CAUTION]
    > TLS-подключения, зашифрованные с помощью самозаверяющего сертификата, не обеспечивают надежную защиту. Они уязвимы для атак "злоумышленник в середине". Не следует полагаться на TLS, используя самозаверяющие сертификаты в рабочей среде или на серверах, подключенных к Интернету.

   ![Сведения об источнике](media/tutorial-sql-server-to-managed-instance/dms-source-details1.png)

3. Щелкните **Сохранить**.

4. На экране **Выбор баз данных-источников** выберите базу данных **Adventureworks2012** для миграции.

   ![Выбор баз данных-источников](media/tutorial-sql-server-to-managed-instance/dms-source-database1.png)

    > [!IMPORTANT]
    > Если используется SQL Server Integration Services (SSIS), DMS не поддерживает миграцию базы данных каталога для проектов или пакетов служб SSIS (SSISDB) с SQL Server на SQL Управляемый экземпляр. Тем не менее можно подготавливать службы SSIS в фабрике данных Azure (ADF) и повторно развертывать проекты или пакеты служб SSIS в целевой SSISDB, размещенном в SQL Управляемый экземпляр. Дополнительные сведения о миграции пакетов SSIS см. в статье [Перенос пакетов SQL Server Integration Services в Azure](https://docs.microsoft.com/azure/dms/how-to-migrate-ssis-packages).

5. Щелкните **Сохранить**.

## <a name="specify-target-details"></a>Указание сведений о цели

1. На экране **сведения о целевом объекте миграции** укажите сведения о подключении для целевого объекта, который является предварительно подготовленным управляемый экземпляр SQL, на который выполняется миграция базы данных **AdventureWorks2012** .

    Если вы еще не подготовили Управляемый экземпляр SQL, выберите [ссылку](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-get-started) , которая поможет подготовить экземпляр. Вы по-прежнему можете продолжить создание проекта, а затем, когда Управляемый экземпляр SQL готово, вернитесь к этому проекту для выполнения миграции.

    ![Выбор цели](media/tutorial-sql-server-to-managed-instance/dms-target-details2.png)

2. Щелкните **Сохранить**.

## <a name="select-source-databases"></a>Выбор баз данных-источников

1. На экране **Выбор баз данных-источников** выберите базу данных-источник для миграции.

    ![Выбор баз данных-источников](media/tutorial-sql-server-to-managed-instance/select-source-databases.png)

2. Щелкните **Сохранить**.

## <a name="select-logins"></a>Выберите имена для входа

1. Выберите имена для входа, которые хотите перенести, на экране **Select logins** (Выбор имени входа).

    >[!NOTE]
    >По умолчанию Azure Database Migration Service поддерживает только миграцию имен входа SQL. Сведения о включении поддержки миграции имен входа Windows см. в разделе " **Предварительные требования** " этого руководства.

    ![Выберите имена для входа](media/tutorial-sql-server-to-managed-instance/select-logins.png)

2. Щелкните **Сохранить**.

## <a name="configure-migration-settings"></a>Настройка параметров миграции

1. На экране **Configure migration settings** (Настройка параметров миграции) укажите следующие сведения:

    | | |
    |--------|---------|
    |**Выбор исходных резервных копий** | Выберите вариант **I will provide latest backup files** (Я предоставлю файлы последних резервных копий), если у вас есть файлы полных резервных копий, которые DMS может использовать для переноса базы данных. Выберите вариант **I will let Azure Database Migration Service create backup files** (Я разрешу Azure Database Migration Service создавать файлы резервных копий), если нужно, чтобы служба DMS сначала создала полную резервную копию базы данных-источника и использовала ее для миграции. |
    |**Локальная общая сетевая папка** | Локальная сетевая папка SMB, в которую Azure Database Migration Service может поместить резервные копии базы данных-источника. Учетная запись службы, в которой выполняется исходный экземпляр SQL Server, должна иметь права записи для этой сетевой папки. Укажите полное доменное имя или IP-адрес сервера и сетевую папку, например "\\\servername.domainname.com\backupfolder" или "\\\IP address\backupfolder".|
    |**User name** | Убедитесь, что пользователь Windows имеет полное право доступа к указанной ранее сетевой папке. Azure Database Migration Service выполнит олицетворение учетных данных пользователя, чтобы отправить файлы резервных копий в контейнер службы хранилища Azure для операции восстановления. В случае выбора для миграции баз данных с поддержкой TDE указанный ранее пользователь Windows должен иметь встроенную учетную запись администратора, а режим [Контроль учетных записей](https://docs.microsoft.com/windows/security/identity-protection/user-account-control/user-account-control-overview) должен быть отключен для Azure Database Migration Service, чтобы отправлять и удалять файлы сертификатов. |
    |**Пароль** | Пароль для пользователя |
    |**Параметры учетной записи хранения** | URI SAS, который предоставляет Azure Database Migration Service с доступом к контейнеру учетной записи хранения, в который служба загружает файлы резервных копий и используется для переноса баз данных в SQL Управляемый экземпляр. [Узнайте, как получить URI SAS для контейнера больших двоичных объектов](https://docs.microsoft.com/azure/vs-azure-tools-storage-explorer-blobs#get-the-sas-for-a-blob-container). Этот URI SAS должен быть для контейнера больших двоичных объектов, а не для учетной записи хранения.|
    |**Параметры TDE** | При переносе баз данных-источников с включенным прозрачное шифрование данных (TDE) необходимо иметь права на запись в целевом Управляемый экземпляр SQL.  Выберите подписку, в которой подготовлена Управляемый экземпляр SQL в раскрывающемся меню.  В раскрывающемся меню выберите целевой **Управляемый экземпляр Базы данных SQL Azure**. |

    ![Настройка параметров миграции](media/tutorial-sql-server-to-managed-instance/dms-configure-migration-settings3.png)

2. Щелкните **Сохранить**.

## <a name="review-the-migration-summary"></a>Просмотр сводки по миграции

1. На экране **Сводка по миграции** в текстовом поле **Имя активности** задайте имя действия миграции.

2. Разверните раздел **Вариант проверки**, чтобы открыть экран **Выбор варианта проверки**, укажите, нужно ли проверять переносимую базу данных на правильность запроса, а затем щелкните **Сохранить**.

3. Проверьте и подтвердите сведения, связанные с проектом миграции.

    ![Сводка по проекту миграции](media/tutorial-sql-server-to-managed-instance/dms-project-summary2.png)

4. Щелкните **Сохранить**.

## <a name="run-the-migration"></a>Выполнение миграции

- Выберите **Запустить миграцию**.

  Появится окно действия миграции, в котором будет указано состояние действия **Ожидание**.

## <a name="monitor-the-migration"></a>Мониторинг миграции

1. Для обновления отображающихся данных нажмите кнопку **Обновить** на экране действия миграции.

   ![Выполняется действие миграции](media/tutorial-sql-server-to-managed-instance/dms-monitor-migration1.png)

    Далее можно развернуть категории баз данных и имен для входа, чтобы отслеживать состояние переноса соответствующих объектов сервера.

   ![Выполняется действие миграции](media/tutorial-sql-server-to-managed-instance/dms-monitor-migration-extend.png)

2. После завершения миграции нажмите **Скачать отчет**, чтобы получить отчет с подробными сведениями о процессе миграции.

3. Убедитесь, что Целевая база данных в целевой среде SQL Управляемый экземпляр.

## <a name="next-steps"></a>Дальнейшие действия

- Руководство по переносу базы данных на SQL Управляемый экземпляр с помощью команды T-SQL RESTORE см. в разделе [Восстановление резервной копии в sql управляемый экземпляр с помощью команды Restore](../sql-database/sql-database-managed-instance-restore-from-backup-tutorial.md).
- Дополнительные сведения о SQL Управляемый экземпляр см. в разделе [что такое sql управляемый экземпляр](../azure-sql/managed-instance/sql-managed-instance-paas-overview.md).
- Сведения о подключении приложений к SQL Управляемый экземпляр см. в разделе [Подключение приложений](../azure-sql/managed-instance/connect-application-instance.md).
