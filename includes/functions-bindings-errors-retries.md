---
author: ggailey777
ms.service: azure-functions
ms.topic: include
ms.date: 10/01/2020
ms.author: glenga
ms.openlocfilehash: 285c3bf37e9d6de042cb028745fc8b094d34c3a1
ms.sourcegitcommit: 7863fcea618b0342b7c91ae345aa099114205b03
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/03/2020
ms.locfileid: "93284383"
---
Ошибки, возникающие в функциях Azure, могут поступать из любого из следующих источников:

- Использование встроенных [триггеров и привязок](..\articles\azure-functions\functions-triggers-bindings.md) функций Azure
- Вызовы API базовых служб Azure
- Вызовы конечных точек RESTFUL
- Вызовы клиентских библиотек, пакетов или сторонних API

Следующие рекомендации по обработке ошибок важны, чтобы избежать потери данных или пропущенных сообщений. Рекомендуемые методы обработки ошибок включают следующие действия.

- [Включить Application Insights](../articles/azure-functions/functions-monitoring.md)
- [Использование структурированной обработки ошибок](#use-structured-error-handling)
- [Проектирование для идемпотентности](../articles/azure-functions/functions-idempotent.md)
- [Реализация политик повтора](#retry-policies) (при необходимости)

### <a name="use-structured-error-handling"></a>Использование структурированной обработки ошибок

Запись и запись ошибок в журнал крайне важны для мониторинга работоспособности приложения. Самый верхний уровень кода функции должен включать блок try/catch. В блоке catch можно записывать и записывать ошибки.

## <a name="retry-policies"></a>Политики повтора

Политику повтора можно определить для любой функции любого типа триггера в приложении-функции.  Политика повтора повторно выполняет функцию до успешного выполнения или до тех пор, пока не будет выполнено максимальное число повторных попыток.  Политики повтора можно определить для всех функций в приложении или для отдельных функций.  По умолчанию приложение-функция не будет повторять сообщения (помимо [конкретных триггеров, которые имеют политику повтора в источнике триггера](#trigger-specific-retry-support)).  Политика повтора вычисляется каждый раз, когда выполнение приводит к неперехваченному исключению.  Рекомендуется перехватывать все исключения в коде и повторно создавать ошибки, которые должны привести к повторной попытке.  Концентраторы событий и контрольные точки Azure Cosmos DB не будут записаны до тех пор, пока не завершится политика повторных попыток выполнения. Это означает, что выполнение этой секции приостанавливается до завершения текущего пакета.

### <a name="retry-policy-options"></a>Параметры политики повтора

Для определения политики повтора доступны следующие параметры.

Максимальное число **повторных попыток** — это максимальное количество повторений выполнения до последующего сбоя. Значение параметра `-1` указывает на неограниченное время повтора. Текущее число повторных попыток хранится в памяти экземпляра. Возможно, произошел сбой экземпляра между повторными попытками.  При сбое экземпляра во время применения политики повтора число повторных попыток будет утеряно.  При возникновении ошибок экземпляра триггеры, такие как концентраторы событий, Azure Cosmos DB и хранилище очередей, могут возобновить обработку и повторить пакет на новом экземпляре, при этом счетчик повторных попыток сбрасывается в ноль.  Другие триггеры, такие как HTTP и Timer, не возобновляются на новом экземпляре.  Это означает, что максимальное количество повторных попыток является наилучшим вариантом, и в некоторых редких случаях выполнение может быть повторено более, чем максимальное, или для триггеров, таких как HTTP и таймер, которые будут повторяться меньше максимального значения.

**Стратегия повторных попыток** управляет поведением повторных попыток.  Ниже приведены два варианта поддержки повторных попыток.

| Параметр | Описание|
|---|---|
|**`fixedDelay`**| Указанное количество времени может пройти между повторными попытками,|
| **`exponentialBackoff`**| Первая повторная попытка ожидает минимальную задержку. При последующих повторах время добавляется экспоненциально к начальной длительности каждой попытки, пока не будет достигнута максимальная задержка.  Экспоненциальное обратное отключение добавляет некоторый небольшой случай, чтобы задерживать повторные попытки в сценариях с высокой пропускной способностью.|

#### <a name="app-level-configuration"></a>Настройка уровня приложения

Политику повтора можно определить для всех функций в приложении [, использующих `host.json` файл](../articles/azure-functions/functions-host-json.md#retry). 

#### <a name="function-level-configuration"></a>Настройка уровня функции

Политику повтора можно определить для определенной функции.  Конфигурация, зависящая от функции, имеет приоритет над конфигурацией на уровне приложения.

#### <a name="fixed-delay-retry"></a>Фиксированная задержка повтора

# <a name="c"></a>[C#](#tab/csharp)

```csharp
[FunctionName("EventHubTrigger")]
[FixedDelayRetry(5, "00:00:10")]
public static async Task Run([EventHubTrigger("myHub", Connection = "EventHubConnection")] EventData[] events, ILogger log)
{
// ...
}
```

# <a name="c-script"></a>[Скрипт C#](#tab/csharp-script)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "fixedDelay",
        "maxRetryCount": 4,
        "delayInterval": "00:00:10"
    }
}
```
# <a name="javascript"></a>[JavaScript](#tab/javascript)

Ниже приведена Политика повтора в *function.jsдля* файла:


```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "fixedDelay",
        "maxRetryCount": 4,
        "delayInterval": "00:00:10"
    }
}
```

# <a name="python"></a>[Python](#tab/python)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "fixedDelay",
        "maxRetryCount": 4,
        "delayInterval": "00:00:10"
    }
}
```

# <a name="java"></a>[Java](#tab/java)

Ниже приведена Политика повтора в *function.jsдля* файла:


```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "fixedDelay",
        "maxRetryCount": 4,
        "delayInterval": "00:00:10"
    }
}
```
---

#### <a name="exponential-backoff-retry"></a>Экспоненциальная повторная попытка

# <a name="c"></a>[C#](#tab/csharp)

```csharp
[FunctionName("EventHubTrigger")]
[ExponentialBackoffRetry(5, "00:00:04", "00:15:00")]
public static async Task Run([EventHubTrigger("myHub", Connection = "EventHubConnection")] EventData[] events, ILogger log)
{
// ...
}
```

# <a name="c-script"></a>[Скрипт C#](#tab/csharp-script)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "exponentialBackoff",
        "maxRetryCount": 5,
        "minimumInterval": "00:00:10",
        "maximumInterval": "00:15:00"
    }
}
```

# <a name="javascript"></a>[JavaScript](#tab/javascript)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "exponentialBackoff",
        "maxRetryCount": 5,
        "minimumInterval": "00:00:10",
        "maximumInterval": "00:15:00"
    }
}
```

# <a name="python"></a>[Python](#tab/python)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "exponentialBackoff",
        "maxRetryCount": 5,
        "minimumInterval": "00:00:10",
        "maximumInterval": "00:15:00"
    }
}
```

# <a name="java"></a>[Java](#tab/java)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "exponentialBackoff",
        "maxRetryCount": 5,
        "minimumInterval": "00:00:10",
        "maximumInterval": "00:15:00"
    }
}
```
---

|свойство function.json  |Свойство атрибута | Описание |
|---------|---------|---------| 
|модель|Н/Д|Обязательный элемент. Используемая стратегия повторных попыток. Допустимые значения: `fixedDelay` или `exponentialBackoff`.|
|maxRetryCount|Н/Д|Обязательный элемент. Максимальное количество попыток выполнения каждой функции. `-1` Указывает на неограниченное время повтора.|
|делайинтервал|Н/Д|Задержка, которая будет использоваться между повторными попытками при использовании `fixedDelay` стратегии.|
|minimumInterval|Н/Д|Минимальная задержка повторных попыток при использовании `exponentialBackoff` стратегии.|
|maximumInterval|Н/Д|Максимальная задержка повтора при использовании `exponentialBackoff` стратегии.| 

## <a name="trigger-specific-retry-support"></a>Поддержка повторных попыток для конкретного триггера

Некоторые триггеры обеспечивают повторные попытки в источнике триггера.  Эти повторные попытки можно использовать в дополнение к или в качестве замены для политики повтора узла приложения-функции.  Если требуется фиксированное число повторных попыток, следует использовать политику повторов, специфичную для триггеров, по универсальной политике повтора узла.  Следующие триггеры поддерживают повторные попытки в источнике триггера:

* [Хранилище BLOB-объектов Azure](../articles/azure-functions/functions-bindings-storage-blob.md)
* [хранилище очередей Azure](../articles/azure-functions/functions-bindings-storage-queue.md);
* [служебная шина Azure (очередь/тема)](../articles/azure-functions/functions-bindings-service-bus.md).

По умолчанию эти запросы повторно поступают в пять раз. После пятой повторной попытки хранилище очередей Azure и триггер служебной шины Azure записывают сообщение в [очередь подозрительных](../articles/azure-functions/functions-bindings-storage-queue-trigger.md#poison-messages)сообщений.
