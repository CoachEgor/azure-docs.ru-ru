---
title: включение файла
description: включение файла
services: batch
documentationcenter: ''
author: laurenhughes
manager: jeconnoc
editor: ''
ms.assetid: ''
ms.service: batch
ms.devlang: na
ms.topic: include
ms.tgt_pltfrm: na
ms.workload: ''
ms.date: 04/10/2019
ms.author: lahugh
ms.custom: include file
ms.openlocfilehash: 711b662c35b5f8fec96f1edee765696bc1028bf8
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60550231"
---
### <a name="general-requirements"></a>Общие требования

* Виртуальная сеть должна находиться в тех же подписке и регионе, что и учетная запись пакетной службы, которую вы используете для создания пула.

* Размер пула, использующий виртуальную сеть, не может превышать 4096 узлов.

* Указанная для пула подсеть должна иметь достаточное количество свободных IP-адресов для всех виртуальных машин, предназначенных для пула, то есть сумму свойств `targetDedicatedNodes` и `targetLowPriorityNodes` этого пула. Если в подсети недостаточно свободных IP-адресов, пакетная служба ограничивает выделение вычислительных узлов для пула и генерирует ошибку изменения размера. 

* Необходимо, чтобы конечная точка службы хранилища Azure могла быть разрешена на всех пользовательских DNS-серверах, используемых в виртуальной сети. В частности, должны разрешаться URL-адреса в формате `<account>.table.core.windows.net`, `<account>.queue.core.windows.net` и `<account>.blob.core.windows.net`. 

Дополнительные требования к виртуальной сети различаются в зависимости от того, где указан пул пакетной службы: в конфигурации виртуальной машины или конфигурации облачных служб. Для новых развертываний пула в виртуальной сети рекомендуется конфигурация виртуальной машины.

### <a name="pools-in-the-virtual-machine-configuration"></a>Пулы в конфигурации виртуальной машины

**Поддерживаемые виртуальные сети** — только виртуальные сети на основе Azure Resource Manager.

**Идентификатор подсети** — при указании подсети с помощью API пакетной службы используйте *идентификатор ресурса* подсети. Идентификатор подсети имеет вид:

  ```
  /subscriptions/{subscription}/resourceGroups/{group}/providers/Microsoft.Network/virtualNetworks/{network}/subnets/{subnet}
  ```

**Разрешения** — проверьте, ограничивают ли ваши политики безопасности или блокировки в подписке или группе ресурсов виртуальной сети разрешения пользователя на управление виртуальной сетью.

**Дополнительные сетевые ресурсы** — пакетная служба автоматически выделяет дополнительные сетевые ресурсы в группе ресурсов, содержащей виртуальную сеть. Для каждого 50 выделенных узлов (или каждого 20 узлов с низким приоритетом) выделяет пакетной службы: Подсистема балансировки нагрузки группы безопасности 1 сети (NSG), один общедоступный IP-адрес и 1. Эти ресурсы ограничены [квотами ресурсов](../articles/azure-subscription-service-limits.md) в подписке. Для больших пулов вам может потребоваться увеличить квоту на один или несколько из этих ресурсов.

#### <a name="network-security-groups"></a>Группы безопасности сети

Подсеть должна разрешать входящую связь из пакетной службы, чтобы иметь возможность планировать задачи на вычислительных узлах, и исходящую связь для связи со службой хранилища Azure или другими ресурсами. Для пулов в конфигурации виртуальной машины пакетная служба добавляет группы безопасности сети на уровне сетевых интерфейсов, подключенных к виртуальным машинам. Эти группы безопасности сети автоматически настраивают правила для входящего и исходящего трафика, чтобы разрешить следующий трафик:

* Входящий трафик TCP через порты 29876 и 29877 с IP-адресов с ролью пакетной службы. 
* Входящий трафик TCP через порт 22 (узлы Linux) или 3389 (узлы Windows), чтобы разрешить удаленный доступ. Для некоторых типов задач с несколькими экземплярами в Linux (MPI), необходимо также разрешить трафик через порт 22 для SSH для IP-адресов в подсети, содержащей вычислительные узлы пакетной службы.
* Исходящий трафик в виртуальную сеть на любом порту.
* Исходящий трафик в Интернет на любом порту.

> [!IMPORTANT]
> Соблюдайте осторожность, если вы изменяете или добавляете правила для входящего и исходящего трафика в группах безопасности сети, настроенных для пакетной службы. Если группа безопасности сети (NSG), связанная с назначенной подсетью, запрещает взаимодействие с вычислительными узлами, пакетная служба установит для вычислительных узлов состояние **Непригоден**.

Вам не нужно указывать группы безопасности сети на уровне подсети, так как пакетная служба настраивает собственные такие группы. Однако если указанной подсети уже назначены группы безопасности сети и (или) брандмауэр, настройте правила безопасности для входящего и исходящего трафика, как показано в следующих таблицах. Настройте входящий трафик через порт 3389 (Windows) или 22 (Linux), только в том случае, если необходимо разрешить удаленный доступ к виртуальным машинам пула из внешних источников. Виртуальные машины пула можно использовать и без этой настройки. Обратите внимание на то, что необходимо включить трафик подсети виртуальной сети через порт 22 для Linux, при использовании определенных видов многоэкземплярных задач, таких как MPI.

**Правила безопасности для входящего трафика**

| Исходные IP-адреса | Тег службы источника | Исходные порты | Место назначения | Конечные порты | Protocol | Действие |
| --- | --- | --- | --- | --- | --- | --- |
| Н/Д | `BatchNodeManagement` [Тег службы](../articles/virtual-network/security-overview.md#service-tags) | * | Любой | 29876–29877 | TCP | РАЗРЕШИТЬ |
| Пользователь IP-адреса источника для удаленного доступа к вычислительных узлов и (или) подсети узла вычислений для задач с несколькими экземплярами Linux, если это необходимо. | Н/Д | * | Любой | 3389 (Windows), 22 (Linux) | TCP | РАЗРЕШИТЬ |

**Правила безопасности для исходящего трафика**

| Источник | Исходные порты | Место назначения | Тег целевой службы | Protocol | Действие |
| --- | --- | --- | --- | --- | --- |
| Любой | 443 | [Тег службы](../articles/virtual-network/security-overview.md#service-tags) | `Storage` (в одном регионе с вашей учетной записи пакетной службы и виртуальной сети)  | Любой | РАЗРЕШИТЬ |

### <a name="pools-in-the-cloud-services-configuration"></a>Пулы в конфигурации облачных служб

**Поддерживаемые виртуальные сети** — только классические виртуальные сети.

**Идентификатор подсети** — при указании подсети с помощью API пакетной службы используйте *идентификатор ресурса* подсети. Идентификатор подсети имеет вид:

  ```
  /subscriptions/{subscription}/resourceGroups/{group}/providers/Microsoft.ClassicVirtualNetwork /virtualNetworks/{network}/subnets/{subnet}
  ```

**Разрешения`MicrosoftAzureBatch` — субъекту-службе**  должна быть назначена роль управления доступом на основе ролей `Classic Virtual Machine Contributor` для указанной виртуальной сети.

#### <a name="network-security-groups"></a>Группы безопасности сети

Подсеть должна разрешать входящую связь из пакетной службы, чтобы иметь возможность планировать задачи на вычислительных узлах, и исходящую связь для связи со службой хранилища Azure или другими ресурсами.

Вам не нужно указывать группу безопасности сети, так как пакетная служба настраивает входящий трафик только с IP-адресов пакетной службы на узлах пула. Если указанной подсети уже назначены группы безопасности сети и (или) брандмауэр, настройте правила безопасности для входящего и исходящего трафика, как показано в следующих таблицах. Если группа безопасности сети (NSG), связанная с назначенной подсетью, запрещает взаимодействие с вычислительными узлами, пакетная служба установит для вычислительных узлов состояние **Непригоден**.

Настройте входящий трафик через порт 3389 для Windows, если вам нужно разрешить доступ по протоколу RDP на узлах пула. Узлы пула можно использовать и без этой настройки.

**Правила безопасности для входящего трафика**

| Исходные IP-адреса | Исходные порты | Место назначения | Конечные порты | Protocol | Действие |
| --- | --- | --- | --- | --- | --- |
Любой <br /><br />Хотя фактически это разрешает доступ со всех адресов, пакетная служба применяет правило списка управления доступом на уровне каждого узла, которое отфильтровывает все IP-адреса, не относящиеся к пакетной службе. | * | Любой | 10100, 20100, 30100 | TCP | РАЗРЕШИТЬ |
| (Необязательно) чтобы предоставить доступ RDP на вычислительных узлах. | * | Любой | 3389 | TCP | РАЗРЕШИТЬ |

**Правила безопасности для исходящего трафика**

| Источник | Исходные порты | Место назначения | Конечные порты | Protocol | Действие |
| --- | --- | --- | --- | --- | --- |
| Любой | * | Любой | 443  | Любой | РАЗРЕШИТЬ |
