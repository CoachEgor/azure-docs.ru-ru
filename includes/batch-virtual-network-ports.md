---
title: включить файл
description: включить файл
services: batch
documentationcenter: ''
author: LauraBrenner
manager: evansma
editor: ''
ms.assetid: ''
ms.service: batch
ms.devlang: na
ms.topic: include
ms.tgt_pltfrm: na
ms.workload: ''
ms.date: 04/03/2020
ms.author: labrenne
ms.custom: include file
ms.openlocfilehash: dc08dcded6418208751edbffcb5d263db059ec01
ms.sourcegitcommit: 62c5557ff3b2247dafc8bb482256fef58ab41c17
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2020
ms.locfileid: "80657478"
---
### <a name="general-requirements"></a>Общие требования

* Виртуальная сеть должна находиться в тех же подписке и регионе, что и учетная запись пакетной службы, которую вы используете для создания пула.

* Размер пула, использующий виртуальную сеть, не может превышать 4096 узлов.

* Указанная для пула подсеть должна иметь достаточное количество свободных IP-адресов для всех виртуальных машин, предназначенных для пула, то есть сумму свойств `targetDedicatedNodes` и `targetLowPriorityNodes` этого пула. Если в подсети недостаточно свободных IP-адресов, пакетная служба ограничивает выделение вычислительных узлов для пула и генерирует ошибку изменения размера.

* Необходимо, чтобы конечная точка службы хранилища Azure могла быть разрешена на всех пользовательских DNS-серверах, используемых в виртуальной сети. В частности, должны разрешаться URL-адреса в формате `<account>.table.core.windows.net`, `<account>.queue.core.windows.net` и `<account>.blob.core.windows.net`.

Дополнительные требования к виртуальной сети различаются в зависимости от того, где указан пул пакетной службы: в конфигурации виртуальной машины или конфигурации облачных служб. Для новых развертываний пула в виртуальной сети рекомендуется конфигурация виртуальной машины.

### <a name="pools-in-the-virtual-machine-configuration"></a>Пулы в конфигурации виртуальной машины

**Поддерживаемые виртуальные сети** — только виртуальные сети на основе Azure Resource Manager.

**Идентификатор подсети** — при указании подсети с помощью API пакетной службы используйте *идентификатор ресурса* подсети. Идентификатор подсети имеет вид:

  ```
  /subscriptions/{subscription}/resourceGroups/{group}/providers/Microsoft.Network/virtualNetworks/{network}/subnets/{subnet}
  ```

**Разрешения** — проверьте, ограничивают ли ваши политики безопасности или блокировки в подписке или группе ресурсов виртуальной сети разрешения пользователя на управление виртуальной сетью.

**Дополнительные сетевые ресурсы** — пакетная служба автоматически выделяет дополнительные сетевые ресурсы в группе ресурсов, содержащей виртуальную сеть.

> [!IMPORTANT]
>Для каждого 50 выделенных узлов (или каждых 20 низкоприоритетных узлов) Batch выделяет: одну группу сетевой безопасности (NSG), один публичный IP-адрес и один балансера. Эти ресурсы ограничены [квотами ресурсов](../articles/azure-resource-manager/management/azure-subscription-service-limits.md) в подписке. Для больших пулов может потребоваться запросить увеличение квоты для одного или нескольких из этих ресурсов.

#### <a name="network-security-groups-batch-default"></a>Группы безопасности сети: по умолчанию пакета

Подсеть должна позволить входящим коммуникациям из службы Пакета иметь возможность планировать задачи на вычислительных узлах, а исходящих сообщений — общаться с Хранилищем Azure или другими ресурсами по мере необходимости рабочей нагрузкой. Для пулов в конфигурации Виртуальной машины Batch добавляет НСГ на уровне сетевых интерфейсов (NICs), прикрепленных к вычислительным узлам. Эти НСК настроены со следующими дополнительными правилами:

* Входящий трафик TCP на портах 29876 и 29877 `BatchNodeManagement` с IP-адресов службы пакетов, которые соответствуют тегу обслуживания.
* Входящий трафик TCP через порт 22 (узлы Linux) или 3389 (узлы Windows), чтобы разрешить удаленный доступ. Для определенных типов задач с несколькими экземплярами на Linux (например, MPI) необходимо также разрешить трафик SSH port 22 для I-pPs в подсети, содержащей вычислительные узлы Batch. Это может быть заблокировано на уровне подсети правил NSG (см. ниже).
* Исходящий трафик в виртуальную сеть на любом порту. Это может быть изменено в правилах NSG уровня подсети (см. ниже).
* Исходящий трафик в любом порту в Интернет. Это может быть изменено в правилах NSG уровня подсети (см. ниже).

> [!IMPORTANT]
> Соблюдайте осторожность, если вы изменяете или добавляете правила для входящего и исходящего трафика в группах безопасности сети, настроенных для пакетной службы. Если группа безопасности сети (NSG), связанная с назначенной подсетью, запрещает взаимодействие с вычислительными узлами, пакетная служба установит для вычислительных узлов состояние **Непригоден**. Кроме того, блокировки ресурсов не должны применяться к любому ресурсу, созданному Пакетом, в противном случае это может привести к предотвращению очистки ресурсов в результате инициированных пользователем действий, таких как устранение пула.

#### <a name="network-security-groups-specifying-subnet-level-rules"></a>Группы сетевой безопасности: определение правил уровня подсети

Не требуется указывать НСГ на уровне виртуальной сети подсети, поскольку Batch настраивает собственные НСГ (см. выше). Если у вас есть NSG, связанная с подсетью, где развернуты вычислительные узлы batch, или вы хотите применить пользовательские правила NSG для переопределения применяемых по умолчанию, необходимо настроить эту НСГ с по крайней мере входящими и исходящими правилами безопасности, как показано в следующих таблицах.

Назначьте входящий трафик в порту 3389 (Windows) или 22 (Linux) только в том случае, если вам необходимо разрешить удаленный доступ к вычислительным узлам из внешних источников. Возможно, потребуется включить правила порта 22 на Linux, если вам требуется поддержка задач с несколькими экземплярами с определенными время выполнения MPI. Разрешение трафика на этих портах строго не требуется для того, чтобы вычислительные узлы пула были пригодны для узла для узла.

**Правила безопасности для входящего трафика**

| Исходные IP-адреса | Тег службы источника | Исходные порты | Назначение | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- | --- |
| Недоступно | `BatchNodeManagement`[Тег обслуживания](../articles/virtual-network/security-overview.md#service-tags) (при использовании регионального варианта, в том же регионе, что и учетная запись пакета) | * | Любой | 29876–29877 | TCP | Allow |
| I-интерфейс ы и мпобрета пользователя для удаленного доступа к вычислительным узлам и/или вычислению подсети узлов для задач с несколькими экземплярами Linux, если это необходимо. | Недоступно | * | Любой | 3389 (Windows), 22 (Linux) | TCP | Allow |

> [!WARNING]
> IP-адреса службы пакетов могут меняться с течением времени. Поэтому настоятельно рекомендуется использовать тег `BatchNodeManagement` обслуживания (или региональный вариант) для правил NSG. Не рекомендуется заполнять правила NSG IP-адресами службы batch.

**Правила безопасности для исходящего трафика**

| Источник | Исходные порты | Назначение | Тег целевой службы | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- | --- |
| Любой | * | [Сервисный тег](../articles/virtual-network/security-overview.md#service-tags) | `Storage`(при использовании регионального варианта, в том же регионе, что и ваша учетная запись Batch) | 443 | TCP | Allow |

### <a name="pools-in-the-cloud-services-configuration"></a>Пулы в конфигурации облачных служб

**Поддерживаемые виртуальные сети** — только классические виртуальные сети.

**Идентификатор подсети** — при указании подсети с помощью API пакетной службы используйте *идентификатор ресурса* подсети. Идентификатор подсети имеет вид:

  ```
  /subscriptions/{subscription}/resourceGroups/{group}/providers/Microsoft.ClassicNetwork /virtualNetworks/{network}/subnets/{subnet}
  ```

**Разрешения`Microsoft Azure Batch` — субъекту-службе ** должна быть назначена роль управления доступом на основе ролей `Classic Virtual Machine Contributor` для указанной виртуальной сети.

#### <a name="network-security-groups"></a>Группы безопасности сети

Подсеть должна разрешать входящую связь из пакетной службы, чтобы иметь возможность планировать задачи на вычислительных узлах, и исходящую связь для связи со службой хранилища Azure или другими ресурсами.

Вам не нужно указывать группу безопасности сети, так как пакетная служба настраивает входящий трафик только с IP-адресов пакетной службы на узлах пула. Если указанной подсети уже назначены группы безопасности сети и (или) брандмауэр, настройте правила безопасности для входящего и исходящего трафика, как показано в следующих таблицах. Если группа безопасности сети (NSG), связанная с назначенной подсетью, запрещает взаимодействие с вычислительными узлами, пакетная служба установит для вычислительных узлов состояние **Непригоден**.

Навлаживайте входный трафик в порту 3389 для Windows, если вам необходимо разрешить RDP доступ к узлам пула. Узлы пула можно использовать и без этой настройки.

**Правила безопасности для входящего трафика**

| Исходные IP-адреса | Исходные порты | Назначение | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- |
Любой <br /><br />Хотя фактически это разрешает доступ со всех адресов, пакетная служба применяет правило списка управления доступом на уровне каждого узла, которое отфильтровывает все IP-адреса, не относящиеся к пакетной службе. | * | Любой | 10100, 20100, 30100 | TCP | Allow |
| Необязательно, чтобы позволить RDP доступ к вычислительным узлам. | * | Любой | 3389 | TCP | Allow |

**Правила безопасности для исходящего трафика**

| Источник | Исходные порты | Назначение | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- |
| Любой | * | Любой | 443  | Любой | Allow |
