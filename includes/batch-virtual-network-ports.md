---
title: Включить имя файла
description: включить файл
services: batch
documentationcenter: ''
author: JnHs
manager: evansma
editor: ''
ms.service: batch
ms.devlang: na
ms.topic: include
ms.tgt_pltfrm: na
ms.date: 06/16/2020
ms.author: jenhayes
ms.custom: include file
ms.openlocfilehash: 1b21141a4b3f9ae92cdcf1d5a93a457012cb136a
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85506617"
---
### <a name="general-requirements"></a>Общие требования

* Виртуальная сеть должна находиться в тех же подписке и регионе, что и учетная запись пакетной службы, которую вы используете для создания пула.

* Размер пула, использующий виртуальную сеть, не может превышать 4096 узлов.

* Указанная для пула подсеть должна иметь достаточное количество свободных IP-адресов для всех виртуальных машин, предназначенных для пула, то есть сумму свойств `targetDedicatedNodes` и `targetLowPriorityNodes` этого пула. Если в подсети недостаточно свободных IP-адресов, пакетная служба ограничивает выделение вычислительных узлов для пула и генерирует ошибку изменения размера.

* Необходимо, чтобы конечная точка службы хранилища Azure могла быть разрешена на всех пользовательских DNS-серверах, используемых в виртуальной сети. В частности, должны разрешаться URL-адреса в формате `<account>.table.core.windows.net`, `<account>.queue.core.windows.net` и `<account>.blob.core.windows.net`.

Дополнительные требования к виртуальной сети различаются в зависимости от того, где указан пул пакетной службы: в конфигурации виртуальной машины или конфигурации облачных служб. Для новых развертываний пула в виртуальной сети рекомендуется конфигурация виртуальной машины.

### <a name="pools-in-the-virtual-machine-configuration"></a>Пулы в конфигурации виртуальной машины

**Поддерживаемые виртуальные сети** — только виртуальные сети на основе Azure Resource Manager.

**Идентификатор подсети** — при указании подсети с помощью API пакетной службы используйте *идентификатор ресурса* подсети. Идентификатор подсети имеет вид:

`/subscriptions/{subscription}/resourceGroups/{group}/providers/Microsoft.Network/virtualNetworks/{network}/subnets/{subnet}`

**Разрешения** — проверьте, ограничивают ли ваши политики безопасности или блокировки в подписке или группе ресурсов виртуальной сети разрешения пользователя на управление виртуальной сетью.

**Дополнительные сетевые ресурсы** — пакетная служба автоматически выделяет дополнительные сетевые ресурсы в группе ресурсов, содержащей виртуальную сеть.

> [!IMPORTANT]
> Для каждого выделенного узла 100 или узлов с низким приоритетом выделяются пакеты: одна группа безопасности сети (NSG), один общедоступный IP-адрес и один балансировщик нагрузки. Эти ресурсы ограничены [квотами ресурсов](../articles/azure-resource-manager/management/azure-subscription-service-limits.md) в подписке. Для больших пулов может потребоваться запросить увеличение квоты для одного или нескольких из этих ресурсов.

#### <a name="network-security-groups-batch-default"></a>Группы безопасности сети: пакет по умолчанию

Подсеть должна разрешать входящий трафик из пакетной службы, чтобы иметь возможность планировать задачи на этих узлах, а также исходящий обмен данными с хранилищем Azure или другими ресурсами, необходимыми для вашей рабочей нагрузки. Для пулов в конфигурации виртуальной машины Пакетная службы добавляет группы безопасности сети на уровне сетевых интерфейсов (NIC), подключенном к вычисленным узлам. Эти группы безопасности сети настраиваются со следующими дополнительными правилами:

* Входящий TCP-трафик на портах 29876 и 29877 из пакетов служб пакетной службы, соответствующих `BatchNodeManagement` тегу службы.
* Входящий трафик TCP через порт 22 (узлы Linux) или 3389 (узлы Windows), чтобы разрешить удаленный доступ. Для некоторых типов задач с несколькими экземплярами в Linux (например, MPI) необходимо также разрешить трафик SSH через порт 22 для IP-адресов в подсети, содержащей вычислительные узлы пакетной службы. Это может быть заблокировано для каждого правила NSG на уровне подсети (см. ниже).
* Исходящий трафик в виртуальную сеть на любом порту. Это можно изменить в правилах NSG на уровне подсети (см. ниже).
* Исходящий трафик через любой порт в Интернете. Это можно изменить в правилах NSG на уровне подсети (см. ниже).

> [!IMPORTANT]
> Будьте внимательны при изменении или добавлении правил для входящих или исходящих подключений в пакетной конфигурации группы безопасности сети. Если подключение к вычисленным узлам в указанной подсети отклоняется NSG, пакетная служба установит для них состояние **непригодно для использования**. Кроме того, не следует применять блокировки ресурсов к любому ресурсу, созданному пакетной службой, так как это может препятствовать очистке ресурсов в результате действий, инициированных пользователем, таких как Удаление пула.

#### <a name="network-security-groups-specifying-subnet-level-rules"></a>Группы безопасности сети: Указание правил уровня подсети

Вам не нужно указывать группы безопасности сети на уровне подсети виртуальной сети, так как пакет настраивает собственный группы безопасности сети (см. выше). Если у вас есть NSG, связанный с подсетью, в которой развернуты составные кластерные узлы, или если вы хотите применить настраиваемые правила NSG для переопределения применяемых по умолчанию правил, необходимо настроить для этого NSG по крайней мере правила безопасности для входящего и исходящего трафика, приведенные в следующих таблицах.

Настройте входящий трафик через порт 3389 (Windows) или 22 (Linux) только в том случае, если необходимо предоставить удаленный доступ к вычисленным узлам извне источников. Если требуется поддержка многоэкземплярных задач с определенными средами MPI, может потребоваться включить правила порта 22 в Linux. Предоставление трафика через эти порты не обязательно является обязательным для использования в качестве ресурсов для вычислений.

**Правила безопасности для входящего трафика**

| Исходные IP-адреса | Тег службы источника | Исходные порты | Назначение | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- | --- |
| н/д | `BatchNodeManagement`[Тег службы](../articles/virtual-network/security-overview.md#service-tags) (если используется региональный вариант в том же регионе, что и учетная запись пакетной функции) | * | Любой | 29876–29877 | TCP | Разрешить |
| Исходные IP-адреса пользователей для удаленного доступа к вычислительным узлам и (или) подсети вычислительных узлов для задач с несколькими экземплярами Linux, если это необходимо. | н/д | * | Любой | 3389 (Windows), 22 (Linux) | TCP | Разрешить |

> [!WARNING]
> IP-адреса пакетной службы могут меняться со временем. Поэтому настоятельно рекомендуется использовать `BatchNodeManagement` тег службы (или региональный вариант) для правил NSG. Старайтесь не заполнять правила NSG с помощью конкретных IP-адресов пакетной службы.

**Правила безопасности для исходящего трафика**

| Источник | Исходные порты | Назначение | Тег целевой службы | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- | --- |
| Любой | * | [Тег службы](../articles/virtual-network/security-overview.md#service-tags) | `Storage`(если используется региональный вариант в том же регионе, что и учетная запись пакетной службы) | 443 | TCP | Разрешить |

### <a name="pools-in-the-cloud-services-configuration"></a>Пулы в конфигурации облачных служб

**Поддерживаемые виртуальные сети** — только классические виртуальные сети.

**Идентификатор подсети** — при указании подсети с помощью API пакетной службы используйте *идентификатор ресурса* подсети. Идентификатор подсети имеет вид:

`/subscriptions/{subscription}/resourceGroups/{group}/providers/Microsoft.ClassicNetwork /virtualNetworks/{network}/subnets/{subnet}`

**Разрешения`Microsoft Azure Batch` — субъекту-службе ** должна быть назначена роль управления доступом на основе ролей `Classic Virtual Machine Contributor` для указанной виртуальной сети.

#### <a name="network-security-groups"></a>группы безопасности сети;

Подсеть должна разрешать входящую связь из пакетной службы, чтобы иметь возможность планировать задачи на вычислительных узлах, и исходящую связь для связи со службой хранилища Azure или другими ресурсами.

Вам не нужно указывать группу безопасности сети, так как пакетная служба настраивает входящий трафик только с IP-адресов пакетной службы на узлах пула. Если указанной подсети уже назначены группы безопасности сети и (или) брандмауэр, настройте правила безопасности для входящего и исходящего трафика, как показано в следующих таблицах. Если подключение к вычисленным узлам в указанной подсети отклоняется NSG, пакетная служба задает для них состояние **непригодного к использованию**.

Настройте входящий трафик через порт 3389 для Windows, если требуется разрешение доступа по протоколу RDP к узлам пула. Это не требуется для использования узлов пула.

**Правила безопасности для входящего трафика**

| Исходные IP-адреса | Исходные порты | Назначение | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- |
Любой <br /><br />Хотя фактически это разрешает доступ со всех адресов, пакетная служба применяет правило списка управления доступом на уровне каждого узла, которое отфильтровывает все IP-адреса, не относящиеся к пакетной службе. | * | Любой | 10100, 20100, 30100 | TCP | Разрешить |
| Необязательно, чтобы разрешить доступ по протоколу RDP к вычисленным узлам. | * | Любой | 3389 | TCP | Разрешить |

**Правила безопасности для исходящего трафика**

| Источник | Исходные порты | Назначение | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- |
| Любой | * | Любой | 443  | Любой | Allow |
