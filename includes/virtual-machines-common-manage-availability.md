---
title: включить файл
description: включить файл
services: virtual-machines
author: cynthn
ms.service: virtual-machines
ms.topic: include
ms.date: 03/27/2018
ms.author: cynthn
ms.custom: include file
ms.openlocfilehash: 40810b9a9b295f2aa9d56caaf4b51cab7dbbe5bc
ms.sourcegitcommit: 5d6ce6dceaf883dbafeb44517ff3df5cd153f929
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2020
ms.locfileid: "76887741"
---
## <a name="understand-vm-reboots---maintenance-vs-downtime"></a>Общие сведения о перезагрузках виртуальной машины. Обслуживание и простой
Есть три сценария, которые могут повлиять на работу виртуальной машины в Azure: незапланированное техническое обслуживание, незапланированный простой и запланированное техническое обслуживание.

* **Событие незапланированного технического обслуживания** возникает, когда платформа Azure прогнозирует, что в оборудовании или в любом компоненте платформы, связанными с физическим компьютером, может произойти ошибка. При выявлении такой ошибки платформа Azure вызывает событие незапланированного технического обслуживания, чтобы уменьшить воздействие на виртуальные машины, размещенные на этом оборудовании. Azure использует технологию [Динамическая миграция](https://docs.microsoft.com/azure/virtual-machines/linux/maintenance-and-updates) для переноса виртуальных машин с неисправного оборудования на работоспособный физический компьютер. Динамическая миграция — это операция обслуживания виртуальной машины, которая всего лишь приостанавливает работу виртуальной машины на короткое время. Память, открытые файлы и сетевые подключения сохраняются, но производительность может уменьшиться до или после события. Если динамическую миграцию невозможно применить, возникает событие незапланированного простоя виртуальных машин, как описано ниже.


* **Непредвиденные простои** при неожиданных отказах оборудования или физической инфраструктуры виртуальной машины. Это могут быть сбои локальной сети или локальных жестких дисков, а также другие ошибки на уровне стойки. При выявлении таких сбоев платформа Azure автоматически переносит виртуальную машину на работоспособный физический компьютер в том же центре обработки данных. Во время восстановления работоспособности виртуальной машины возникает простой (перезагрузка), а в некоторых случаях отключается временный диск. Подключенные диски ОС и диски данных всегда сохраняются.

  Виртуальные машины могут также стать недоступными в случае сбоя или аварии, которые затрагивают весь центр обработки данных или даже весь регион, но это маловероятная ситуация. Для таких сценариев в Azure предусмотрены разные функции защиты, включая [зоны доступности](../articles/availability-zones/az-overview.md) и [пары регионов](../articles/best-practices-availability-paired-regions.md#what-are-paired-regions).

* **События запланированного обслуживания** — это периодические обновления, осуществляемые корпорацией Майкрософт на базовой платформе Azure для улучшения общей надежности, производительности и безопасности инфраструктуры платформы, на которой работают ваши виртуальные машины. Большинство таких обновлений выполняется без какого-либо воздействия на ваши виртуальные машины или облачные службы. Дополнительные сведения см. в статье [Обслуживание с сохранением виртуальной машины посредством миграции на месте](https://docs.microsoft.com/azure/virtual-machines/windows/preserving-maintenance). Хотя в большинстве случаев платформа Azure выполняет обслуживание с сохранением виртуальной машины, в некоторых случаях требуется перезагрузить виртуальную машину, чтобы применить необходимые обновления к базовой инфраструктуре. В этом случае можно выполнить плановое техническое обслуживание Azure с операцией повторного развертывания обслуживания. Для этого обслуживание виртуальных машин инициируется в подходящем временном окне. Дополнительные сведения см. в статье [Плановое обслуживание виртуальных машин Windows](https://docs.microsoft.com/azure/virtual-machines/windows/planned-maintenance/).


Чтобы уменьшить воздействие простоя из-за одного или нескольких из описанных здесь событий, мы рекомендуем вам выполнить на своих виртуальных машинах следующие действия по обеспечению высокого уровня доступности.

* [Настройка нескольких виртуальных машин в группе доступности для обеспечения избыточности]
* [Использование управляемых дисков для виртуальных машин в группе доступности]
* [Служба метаданных Azure: подслужба "Запланированные события" для виртуальных машин Windows](https://docs.microsoft.com/azure/virtual-machines/virtual-machines-scheduled-events)
* [Настройка каждого уровня приложений в отдельных группах доступности]
* [Объединение балансировщика нагрузки с группами доступности]
* [Используйте зоны доступности, чтобы обеспечить защиту от сбоев на уровне центра обработки данных]

## <a name="use-availability-zones-to-protect-from-datacenter-level-failures"></a>Используйте зоны доступности, чтобы обеспечить защиту от сбоев на уровне центра обработки данных

[Зоны доступности](../articles/availability-zones/az-overview.md) расширяют уровень контроля, который должен поддерживать доступность приложений и данных на виртуальных машинах. Зоны доступности — уникальные физические расположения в пределах одного региона Azure. Каждая зона состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия. Для обеспечения устойчивости существует как минимум три отдельные зоны во всех включенных регионах. Физическое разделение зон доступности в пределах региона защищает приложения и данные от сбоев центров обработки данных. Избыточные между зонами службы реплицируют приложения и данные в зонах доступности, чтобы обеспечить защиту от возникновения единых точек отказа.

Зона доступности в регионе Azure представляет собой сочетание **домена сбоя** и **домена обновления**. Например, если вы создаете три или боле виртуальных машин в трех зонах в регионе Azure, виртуальные машины эффективно распределяются между тремя доменами сбоя и тремя доменами обновления. Платформа Azure поддерживает такое распределение между доменами обновления, чтобы виртуальные машины в различных зонах не обновлялись одновременно.

Благодаря зонам доступности Azure предлагает наилучшее в отрасли соглашение об уровне обслуживания с гарантией времени непрерывной работы 99,99 % для виртуальных машин. Разрабатывать решения для использования реплицированных виртуальных машин в зонах, вы можете защитить приложения и данные от потери центра обработки данных. В случае неполадок с одной зоной реплицированные приложения и данные сразу же станут доступными в другой зоне.

![Зоны доступности](./media/virtual-machines-common-regions-and-availability/three-zones-per-region.png)

См. дополнительные сведения о развертывании виртуальных машин [Windows](../articles/virtual-machines/windows/create-powershell-availability-zone.md) или [Linux](../articles/virtual-machines/linux/create-cli-availability-zone.md) в зонах доступности.

## <a name="configure-multiple-virtual-machines-in-an-availability-set-for-redundancy"></a>Настройка нескольких виртуальных машин в группе доступности для обеспечения избыточности
Группы доступности — это еще одна конфигурация центра обработки данных для обеспечения избыточности и доступности виртуальных машин. Эта конфигурация в пределах центра обработки данных обеспечит доступность не менее одной виртуальной машины и достижение показателя 99,95 % уровня обслуживания Azure при событиях запланированного и незапланированного обслуживания. Дополнительные сведения см. в статье о [соглашении об уровне обслуживания для виртуальных машин](https://azure.microsoft.com/support/legal/sla/virtual-machines/).

> [!IMPORTANT]
> Не рекомендуется оставлять в группе доступности один экземпляр виртуальной машины. В такой конфигурации виртуальные машины не смогут обеспечивать уровень обслуживания, предусмотренный соглашением об уровне обслуживания, и будут простаивать во время плановых сеансов обслуживания Azure, за исключением случаев, когда отдельная виртуальная машина использует [SSD хранилища Azure класса Premium](../articles/virtual-machines/windows/disks-types.md#premium-ssd). Для отдельных виртуальных машин, использующих диски SSD класса Premium, применяется соглашение об уровне обслуживания Azure.

Платформа Azure назначает каждой виртуальной машине в группе доступности **домен обновления** и **домен сбоя**. Для заданной группы доступности по умолчанию назначается пять доменов обновления без возможности изменения пользователем (в дальнейшем службы, развернутые с помощью Resource Manager, можно будет расширить до 20 доменов обновления). Это позволяет указывать группы виртуальных машин и базовое физическое оборудование, которые можно одновременно перезагружать. Если в одной группе доступности настраивается более пяти виртуальных машин, шестая виртуальная машина помещается в тот же домен обновления, что и первая виртуальная машина, седьмая — что и вторая, и т. д. Порядок перезагрузки доменов обновления при выполнении запланированного обслуживания может не быть последовательным, но за один раз будет перезагружаться только один домен обновления. Перезагруженному домену обновления предоставляется 30 минут для восстановления, прежде чем будет инициировано обслуживание на другом домене обновления.

Домены сбоя определяют группу виртуальных машин, которые совместно используют общий источник питания и сетевой коммутатор. По умолчанию виртуальные машины, настроенные в группе доступности, разделяются на три домена сбоя для служб, развернутых с помощью Resource Manager, и на два домена сбоя для классического развертывания. Включение виртуальных машин в группу доступности не защитит ваше приложение от сбоев, связанных с операционной системой или приложениями, но минимизирует последствия сбоев физического оборудования, сети и электропитания.

<!--Image reference-->
   ![концептуальный рисунок конфигурации домена обновления и домена сбоя](./media/virtual-machines-common-manage-availability/ud-fd-configuration.png)

## <a name="use-managed-disks-for-vms-in-an-availability-set"></a>Использование управляемых дисков для виртуальных машин в группе доступности
Если сейчас вы используете виртуальные машины с неуправляемыми дисками, мы настоятельно рекомендуем [преобразовать виртуальные машины в группе доступности для использования управляемых дисков](../articles/virtual-machines/windows/convert-unmanaged-to-managed-disks.md).

Служба [Управляемые диски](../articles/virtual-machines/windows/managed-disks-overview.md) обеспечивает более высокую надежность групп доступности. При ее использовании диски разных виртуальных машин в группе доступности достаточно изолированы друг от друга, что позволяет избежать одиночных точек сбоя. Это обеспечивается за счет автоматического помещения дисков в разные домены сбоя хранилища (кластеры хранилища) и их оптимизации с доменом сбоя виртуальной машины. При неполадках домена сбоя хранилища из-за сбоя оборудования или программного обеспечения происходит сбой только того экземпляра виртуальной машины, диски которого находятся на домене сбоя хранилища.
![Домены сбоя управляемых дисков](./media/virtual-machines-common-manage-availability/md-fd-updated.png)

> [!IMPORTANT]
> Количество доменов сбоя в управляемых группах доступности зависит от региона. На каждый регион выделяется два или три домена сбоя. Чтобы увидеть домен сбоя для каждого региона, запустите следующие скрипты.

```azurepowershell-interactive
Get-AzComputeResourceSku | where{$_.ResourceType -eq 'availabilitySets' -and $_.Name -eq 'Aligned'}
```

```azurecli-interactive 
az vm list-skus --resource-type availabilitySets --query '[?name==`Aligned`].{Location:locationInfo[0].location, MaximumFaultDomainCount:capabilities[0].value}' -o Table
```

> [!NOTE]
> При определенных обстоятельствах 2 виртуальные машины в одной группе доступности могут совместно использовать одни и те же FaultDomain. Это можно подтвердить, перейдя в группу доступности и проверив столбец **домена сбоя** .
> Это может быть вызвано следующей последовательностью развертывания виртуальных машин:
> - Развертывание первой виртуальной машины
> - Прерывание и освобождение первой виртуальной машины
> - Развертывание второй виртуальной машины в этих случаях диск операционной системы второй виртуальной машины может быть создан в том же домене сбоя, что и первая виртуальная машина, поэтому вторая виртуальная машина также будет направляться на тот же FaultDomain. 
> Чтобы избежать этой проблемы, рекомендуется не прекращать и не выделять виртуальные машины между развертываниями.

Если вы планируете использовать виртуальные машины с неуправляемыми дисками, выполните указанные ниже рекомендации для учетных записей хранения, в которых хранятся виртуальные жесткие диски (VHD) виртуальных машин в виде [страничных BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/Understanding-Block-Blobs--Append-Blobs--and-Page-Blobs#about-page-blobs).

1. **Храните все диски (операционной системы и данных), связанные с одной виртуальной машиной, в одной учетной записи хранения**.
2. Перед добавлением дополнительных виртуальных жестких дисков в учетную запись хранения **Проверьте [ограничения](../articles/storage/blobs/scalability-targets-premium-page-blobs.md) на количество неуправляемых дисков в учетной записи хранения Azure** .
3. **Используйте отдельную учетную запись хранения для каждой виртуальной машины в группе доступности.** Несколько виртуальных машин в одной группе доступности не должны совместно использовать одну учетную запись хранения. Это допустимо для виртуальных машин из разных групп доступности, если соблюдаются все описанные выше рекомендации. ![Домены сбоя неуправляемых дисков](./media/virtual-machines-common-manage-availability/umd-updated.png)

## <a name="use-scheduled-events-to-proactively-respond-to-vm-impacting-events"></a>Использование запланированных событий для упреждающего ответа, влияющие на события виртуальных машин

При подписке на [запланированные события](https://docs.microsoft.com/azure/virtual-machines/virtual-machines-scheduled-events) виртуальная машина получает уведомления о предстоящих событиях обслуживания, которые могут повлиять на вашу виртуальную машину. Активация запланированных событий предоставляет виртуальной машине минимальный интервал времени перед тем, как будет выполнено обслуживание. Например, если не предпринять какое-либо действие, выполнятся обновления ОС узла, которые могут поставить в очередь виртуальную машину как события, указывающие на влияние и время обслуживания. События расписания также помещаются в очередь, когда Azure обнаруживает неизбежный сбой оборудования, который может повлиять на вашу виртуальную машину, что позволяет вам решить, когда следует выполнить восстановление. Клиенты могут использовать события для выполнения задач перед обслуживанием, например, сохранение состояния, переключение на вторичное устройство и т. д. После того как вы завершите свою логику для корректной обработки события обслуживания, вы можете утвердить ожидающее запланированное событие, чтобы позволить платформе продолжить обслуживание.

## <a name="configure-each-application-tier-into-separate-availability-zones-or-availability-sets"></a>Настройка каждого уровня приложения в отдельных зонах доступности или группах доступности
Если виртуальные машины практически идентичны и для вашего приложения используются одинаковые цели, рекомендуется настроить зону доступности или группу доступности для каждого уровня приложения.  Если поместить два разных уровня в одну и ту же зону доступности или набор, все виртуальные машины на одном уровне приложения могут быть перезагружены одновременно. Настроив по крайней мере две виртуальные машины в зоне доступности или задав для каждого уровня, вы гарантируете, что на каждом уровне будет доступна хотя бы одна виртуальная машина.

Например, можно разместить все виртуальные машины в интерфейсе приложения, где запущены службы IIS, Apache и nginx, в отдельной зоне доступности или наборе. Убедитесь, что только внешние виртуальные машины размещены в одной и той же зоне доступности или наборе. Аналогичным образом убедитесь, что только виртуальные машины уровня данных размещены в собственной зоне доступности или наборе, например на реплицированных SQL Server виртуальных машинах или на виртуальных машинах MySQL.

<!--Image reference-->
   ![уровней приложений](./media/virtual-machines-common-manage-availability/application-tiers.png)

## <a name="combine-a-load-balancer-with-availability-zones-or-sets"></a>Объединение подсистемы балансировки нагрузки с зонами или наборами доступности
Чтобы обеспечить максимальную устойчивость приложений, объедините [Azure Load Balancer](../articles/load-balancer/load-balancer-overview.md) с зоной доступности или набором. Подсистема балансировки нагрузки Azure распределяет трафик между несколькими виртуальными машинами. Наши виртуальные машины стандартного уровня включают в себя подсистему балансировки нагрузки Azure. Не все уровни виртуальных машин имеют балансировщик нагрузки Azure. Дополнительные сведения о балансировке нагрузки виртуальных машин см. в статье [Балансировка нагрузки для служб инфраструктуры Azure](../articles/virtual-machines/virtual-machines-linux-load-balance.md).

Если балансировщик нагрузки не настроен для балансировки трафика между несколькими виртуальными машинами, то любое запланированное событие обслуживания оказывает воздействие на единственную виртуальную машину, обслуживающую трафик, что приведет к сбою на уровне приложений. Если включить несколько виртуальных машин одного уровня в одну подсистему балансировки нагрузки и группу доступности, трафик непрерывно будет обслуживаться хотя бы одним экземпляром.

Руководство по балансировке нагрузки между зонами доступности см. [в разделе Балансировка нагрузки виртуальных машин во всех зонах доступности с помощью Azure CLI](../articles/load-balancer/load-balancer-standard-public-zone-redundant-cli.md).


<!-- Link references -->
[Настройка нескольких виртуальных машин в группе доступности для обеспечения избыточности]: #configure-multiple-virtual-machines-in-an-availability-set-for-redundancy
[Настройка каждого уровня приложений в отдельных группах доступности]: #configure-each-application-tier-into-separate-availability-zones-or-availability-sets
[Объединение балансировщика нагрузки с группами доступности]: #combine-a-load-balancer-with-availability-zones-or-sets
[Avoid single instance virtual machines in availability sets]: #avoid-single-instance-virtual-machines-in-availability-sets
[Использование управляемых дисков для виртуальных машин в группе доступности]: #use-managed-disks-for-vms-in-an-availability-set
[Используйте зоны доступности, чтобы обеспечить защиту от сбоев на уровне центра обработки данных]: #use-availability-zones-to-protect-from-datacenter-level-failures
