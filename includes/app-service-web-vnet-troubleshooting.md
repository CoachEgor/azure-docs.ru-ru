---
author: ccompy
ms.service: app-service-web
ms.topic: include
ms.date: 02/27/2020
ms.author: ccompy
ms.openlocfilehash: 2d2a82552a846cedfa5da3bb6ec6df8a40b67732
ms.sourcegitcommit: bc792d0525d83f00d2329bea054ac45b2495315d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78671485"
---
Простота настройки этой функции не гарантирует отсутствия проблем при ее использовании. При проблемах с доступом к нужной конечной точке можно воспользоваться некоторыми служебными программами для проверки подключения из консоли приложения. Вы можете использовать две консоли: консоль Kudu и консоль на портале Azure. Чтобы открыть консоль Kudu из приложения, выберите пункты "Сервис" -> "Kudu". Можно также обратиться к консоли Кудо по адресу [sitename]. SCM. azurewebsites. NET. После загрузки веб-сайта перейдите на вкладку консоль отладки. Чтобы открыть портал Azure размещенную консоль, в приложении перейдите в раздел Сервис-> консоль. 

#### <a name="tools"></a>Сервис
Средства **ping**, **nslookup**и **tracert** не будут работать через консоль из-за ограничений безопасности. Чтобы заполнить void, добавляются два отдельных средства. Для проверки работоспособности DNS мы добавили средство nameresolver.exe. Синтаксис:

    nameresolver.exe hostname [optional: DNS Server]

Для проверки имен узлов, которые использует ваше приложение, можно использовать команду **nameresolver**. Так вы сможете обнаружить ошибки в настройке DNS-сервера или проблемы с доступом к DNS-серверу. Вы видите DNS-сервер, который приложение будет использовать в консоли, просмотрев переменные среды WEBSITE_DNS_SERVER и WEBSITE_DNS_ALT_SERVER.

Следующее средство позволяет проверить подключение к комбинации «узел:порт» по протоколу TCP. Этот инструмент называется **tcpping.exe** и использует следующий синтаксис.

    tcpping.exe hostname [optional: port]

Служебная программа **tcpping** сообщает, возможно ли получить доступ к определенному узлу и порту. Сообщение об успешном выполнении отображается только с том случае, когда приложение ожидает передачи данных от комбинации "узел:порт", а также есть доступ по сети из приложения к указанным узлу и порту.

#### <a name="debugging-access-to-vnet-hosted-resources"></a>Доступ к ресурсам виртуальной сети для отладки
У приложения могут возникнуть проблемы с доступом к определенной комбинации «узел:порт». Это происходит по многим причинам. Вот три наиболее распространенные причины:

* **Брандмауэр блокирует доступ.** Если вы используете брандмауэр, может быть превышено время ожидания TCP. В нашем случае это 21 секунда. Проверьте подключение с помощью средства **tcpping**. Время ожидания TCP может превышаться и по многим другим причинам, но начать стоит именно с этой. 
* **Служба DNS недоступна.** Время ожидания для DNS составляет три секунды на каждый DNS-сервер. Если у вас два DNS-сервера, то время ожидания составляет 6 секунд. Используйте средство nameresolver для проверки работы DNS. Помните, что средство nslookup не подходит для проверки, так как оно игнорирует настройки DNS для виртуальной сети. Если он недоступен, возможно, брандмауэр или NSG блокирует доступ к DNS.

Если эти элементы не отвечают на ваши проблемы, сначала изучите такие вещи, как: 

**Интеграция региональной виртуальной сети**
* является ли целевой адрес, не являющийся АДРЕСНЫЕ пространства RFC1918, и у вас нет WEBSITE_VNET_ROUTE_ALL, равного 1?
* Существует ли NSG блокировка исходящего трафика из вашей подсети интеграции?
* Если переход выполняется между ExpressRoute или VPN, это локальный шлюз, настроенный для маршрутизации трафика в Azure? Если вы можете получить доступ к конечным точкам в виртуальной сети, но не в локальной среде, проверьте маршруты.
* у вас есть достаточные разрешения для настройки делегирования в подсети интеграции? Во время настройки интеграции с региональной виртуальной сетью ваша подсеть интеграции будет делегирована в Microsoft. Web. Пользовательский интерфейс интеграции виртуальной сети будет автоматически делегировать подсеть в Microsoft. Web. Если учетная запись не имеет достаточных сетевых разрешений для настройки делегирования, вам потребуется пользователь, который может задать атрибуты в подсети интеграции для делегирования подсети. Чтобы вручную делегировать подсеть интеграции, перейдите в пользовательский интерфейс подсети виртуальной сети Azure и настройте делегирование для Microsoft. Web. 

**Интеграция виртуальной сети, требуемой шлюзом**
* диапазон адресов "точка — сеть" в диапазонах RFC 1918 (10.0.0.0-10.255.255.255/172.16.0.0-172.31.255.255/192.168.0.0-192.168.255.255)?
* Отображается ли на портале шлюз в рабочем состоянии? Если шлюз не работает, восстановите его работоспособность.
* Отображаются ли сертификаты как синхронизированные или вы подозреваете, что конфигурация сети была изменена?  Если сертификаты не синхронизированы или вы подозреваете, что в конфигурацию виртуальной сети были внесены изменения, которые не были синхронизированы с планах ASP, нажмите "синхронизировать сеть".
* При переходе через VPN — локальный шлюз, настроенный для маршрутизации трафика в Azure? Если вы можете получить доступ к конечным точкам в виртуальной сети, но не в локальной среде, проверьте маршруты.
* Вы пытаетесь использовать шлюз сосуществования, поддерживающий обе точки с сайтом и ExpressRoute? Шлюзы сосуществования не поддерживаются при интеграции с виртуальной сетью.

Отладка сетевых проблем является сложной задачей, так как здесь не видно, что блокирует доступ к определенной комбинации "узел: порт". Ниже представлено несколько возможных причин этой проблемы.

* У вас есть брандмауэр на узле, который препятствует доступу к порту приложения из диапазона IP-адресов "точка — сеть". Для подключения между подсетями часто требуется разрешить общий доступ.
* Целевой узел не работает.
* Ваше приложение не работает.
* У вас неправильный IP-адрес или имя узла.
* Приложение прослушивает порт, отличный от ожидаемого. Вы можете сопоставить ИД процесса с портом прослушивания при помощи команды "netstat -aon" в узле конечной точки. 
* Группы безопасности сети настроены таким образом, чтобы предотвратить доступ к узлу приложения и порту из диапазона IP-адресов "точка — сеть".

Помните, что вы не уверены, какой адрес будет использоваться приложением. Это может быть любой адрес в подсети интеграции или диапазон адресов "точка — сеть", поэтому необходимо разрешить доступ из всего диапазона адресов. 

Можно выполнить дополнительные действия по отладке.

* Подключитесь к виртуальной машине в виртуальной сети и попытайтесь связаться с узлом ресурсов: через порт. Чтобы проверить доступ TCP, используйте команду PowerShell **test-netconnection**. Синтаксис:

      test-netconnection hostname [optional: -Port]

* Выведите приложение на виртуальной машине и протестируйте доступ к этому узлу и порту из консоли приложения с помощью **tcpping**

#### <a name="on-premises-resources"></a>Локальные ресурсы ####

Если приложение не может перейти к ресурсу локально, проверьте, можно ли перейти к ней через виртуальную сеть. Чтобы проверить доступ по протоколу TCP, используйте команду PowerShell **test-netconnection**. Если виртуальная машина не может подключиться к локальному ресурсу, возможно, подключение VPN или ExpressRoute настроено неправильно.

Если размещенная в виртуальной сети виртуальная машина может взаимодействовать с локальной системой, а приложение — нет, это может быть вызвано одной из следующих причин:

* В ваших маршрутах не настроена подсеть или указаны диапазоны адресов сайтов в локальном шлюзе.
* Группы безопасности сети блокируют доступ к диапазону IP-адресов "точка — сеть".
* Локальные брандмауэры блокируют трафик из диапазона IP-адресов "точка — сеть".
* Вы пытаетесь обратиться к адресу, отличному от RFC 1918, с помощью функции интеграции с региональной виртуальной сетью.