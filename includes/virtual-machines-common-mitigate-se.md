---
title: включить файл
description: включить файл
services: virtual-machines
author: cynthn
ms.service: virtual-machines
ms.topic: include
ms.date: 11/12/2019
ms.author: cynthn;kareni
ms.custom: include file
ms.openlocfilehash: 6668d9753d0b93ab907d37cdeff8315f488cff7a
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "73935893"
---
**Последнее обновление документа**: 12 Ноябрь 2019 10:00 AM PST.

В результате обнаружения [нового класса уязвимостей ЦП](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/ADV180002), известного как атаки спекулятивного выполнения команд с предсказанием ветвлений, у пользователей возникли вопросы, требующие разъяснения.  

Корпорация Майкрософт развернула по всем облачным службам средства устранения уязвимостей. Инфраструктура с изолированными друг от друга нагрузками, которая работает в Azure, является защищенной. Это означает, что потенциальному злоумышленнику с помощью той же инфраструктуры, используя эти уязвимости, не удастся осуществить атаку на ваше приложение.

Чтобы свести к минимуму последствия для пользователей и устранить необходимость перезагрузки, Azure всякий раз при возможности использует [обслуживание с сохранением памяти](https://docs.microsoft.com/azure/virtual-machines/windows/maintenance-and-updates#maintenance-that-doesnt-require-a-reboot). Azure продолжит использовать эти методы при выполнении системных обновлений на узле и для защиты своих клиентов.

Дополнительные сведения о том, как вопросы безопасности учитываются в каждом аспекте создания Azure, доступны на веб-сайте [Документация по системе безопасности Azure](https://docs.microsoft.com/azure/security/). 

> [!NOTE] 
> С тех пор как этот документ был впервые опубликован, было обнаружено несколько вариантов этого класса уязвимостей. Корпорация Майкрософт продолжает активно вкладывать средства в защиту своих клиентов и предоставлять поддержку. Эта страница будет обновляться по мере выпуска дальнейших исправлений. 
> 
> 12 ноября 2019 года [корпорация Intel опубликовала](https://software.intel.com/security-software-guidance/insights/deep-dive-intel-transactional-synchronization-extensions-intel-tsx-asynchronous-abort) техническую рекомендацию по уязвимости Intel® транзакционной синхронизации (Intel® TSX) По данным транзакционной ассортовой (TAA), которая назначена [CVE-2019-11135.](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-11135) Эта уязвимость затрагивает процессоры Intel® Core® и Intel® Xeon®.  Корпорация Майкрософт Azure выпустила обновления операционной системы и развертывает новый микрокод, как это стало доступно Intel, по всему нашему флоту, чтобы защитить наших клиентов от этих новых уязвимостей.   Azure тесно сотрудничает с корпорацией Intel для тестирования и проверки нового микрокода до его официального выпуска на платформе. 
>
> **Клиенты, которые работают ненадежный код в пределах их VM** необходимо принять меры для защиты от этих уязвимостей, читая ниже для дополнительного руководства по всем спекулятивным исполнения бокового канала уязвимостей (Microsoft Advisories ADV [180002](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/ADV180002), [180018](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/adv180018), и [190013](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/ADV190013)).
>
> Другие клиенты должны оценить эти уязвимости с точки зрения Defense in Depth и рассмотреть последствия выбранной ими конфигурации для безопасности и производительности.
> 



## <a name="keeping-your-operating-systems-up-to-date"></a>Поддержание актуальной работы операционных систем

Хотя обновление ОС не является обязательным требованием для изоляции приложений, запускаемых в Azure, от других клиентов Azure, настоятельно рекомендуется поддерживать актуальное состояние системы. Последние накопительные пакеты обновлений безопасности для Windows оснащены средствами устранения рисков, связанных с несколькими уязвимостями спекулятивного выполнения команд с предсказанием ветвлений. Аналогичным образом дистрибутивы Linux выпустили несколько обновлений для устранения этих уязвимостей. Вот наши рекомендуемые действия по обновлению операционной системы:

| Предложение | Рекомендуемое действие  |
|----------|---------------------|
| Oблачныe службы Azure  | Включите [автоматическое обновление](https://docs.microsoft.com/azure/cloud-services/cloud-services-how-to-configure-portal) или убедитесь, что вы работаете новейшие Гостевой ОС. |
| Виртуальные машины Linux в Azure | Устанавливайте обновления, предоставляемые поставщиками операционной системы. Дополнительные сведения см. в пункте [Linux](#linux) далее в этом документе. |
| Виртуальные машины Windows в Azure  | Установка последнего накопительного пакета обновлений безопасности.
| Прочие службы Azure PaaS | Для клиентов, использующих эти службы, дополнительные действия не требуются. Azure автоматически выполняет обновление версий операционной системы. |

## <a name="additional-guidance-if-you-are-running-untrusted-code"></a>Дополнительные рекомендации при выполнении кода без доверия 

Клиентам, позволяющим ненадежным пользователям выполнение произвольного кода, может потребоваться использование дополнительных компонентов безопасности внутри своих виртуальных машин Azure или облачных служб. Эти компоненты защищают от внутрипроцессных векторов обнаружения, описываемых несколькими уязвимостями спекулятивного выполнения команд.

Примеры сценариев, где рекомендуется использовать дополнительные компоненты безопасности.

- Вы допускаете запуск кода, которому не доверяете, на своей виртуальной машине.  
    - *Например, вы разрешаете одному из клиентов загрузить двоичный файл или сценарий, который затем будет выполнен в приложении*. 
- Вы разрешаете пользователям, которым не доверяете, входить в виртуальную машину через учетные записи с низкими разрешениями.   
    - *Например, вы разрешаете низкопривилегированному пользователю войти в одну из виртуальных машин с помощью удаленного рабочего стола или SSH*.  
- Вы разрешаете ненадежным пользователям доступ к виртуальным машинам с помощью встроенной виртуализации.  
    - *Например, вы управляете узлом Hyper-V, но выделяете виртуальные машины для ненадежных пользователей*. 

Клиентам, которые не используют сценарии с ненадежным кодом, не обязательно включать эти дополнительные компоненты безопасности. 

## <a name="enabling-additional-security"></a>Включение дополнительной защиты 

Вы можете включить дополнительные функции безопасности внутри вашего VM или Облачного сервиса, если вы работаете с ненадежным кодом. Параллельно убедитесь, что ваша операционная система обновлена для включения функций безопасности внутри вашего VM или Облачного сервиса

### <a name="windows"></a>Windows 

Чтобы включить эти дополнительные компоненты безопасности, нужно использовать последнюю версию целевой операционной системы. Несмотря на то что по умолчанию задействованы многочисленные предупреждения о спекулятивном выполнении команд с предсказанием ветвлений, дополнительные функции, описанные здесь, должны быть активированы вручную и могут отрицательно сказаться на производительности. 


**Шаг 1: Отключить гипер-поток на VM** - Клиенты, работающие ненадежный код на гипер-резьбой VM необходимо отключить гипер-поток или перейти к не-гипер-резьбой VM размер. Ссылка [на этот документ](https://docs.microsoft.com/azure/virtual-machines/windows/acu) для списка гипер-резьбовых размеров VM (где соотношение vCPU к ядру 2:1). Чтобы проверить, включен ли ваш VM гиперпоток, пожалуйста, обратитесь к приведенным ниже скрипту, используя командную строку Windows из VM.

Введите `wmic` интерактивный интерфейс. Затем введите ниже, чтобы просмотреть количество физических и логических процессоров на VM.

```console
CPU Get NumberOfCores,NumberOfLogicalProcessors /Format:List
```

Если количество логических процессоров больше, чем физические процессоры (ядра), то гипер-поток включен.  Если вы работаете с гипер-резьбой VM, пожалуйста, [свяжитесь с поддержкой Azure,](https://aka.ms/MicrocodeEnablementRequest-SupportTechnical) чтобы получить гипер-потоки отключены.  Как только гипер-поток отключен, **поддержка потребует полной перезагрузки VM.** Пожалуйста, обратитесь к [Core граф,](#core-count) чтобы понять, почему ваш VM количество ядра сократилось.


**Шаг 2**: Параллельно с шагом 1, следуйте инструкциям в [KB4072698](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution) для проверки защиты включены с помощью модуля [SpeculationControl](https://aka.ms/SpeculationControlPS) PowerShell.

> [!NOTE]
> Если этот модуль ранее уже был загружен, необходимо установить его последнюю версию.
>


Выход скрипта PowerShell должен иметь ниже значения для проверки включенных средств защиты от этих уязвимостей:

```
Windows OS support for branch target injection mitigation is enabled: True
Windows OS support for kernel VA shadow is enabled: True
Windows OS support for speculative store bypass disable is enabled system-wide: False
Windows OS support for L1 terminal fault mitigation is enabled: True
Windows OS support for MDS mitigation is enabled: True
Windows OS support for TAA mitigation is enabled: True
```

Если вывод `MDS mitigation is enabled: False`показывается, пожалуйста, [свяжитесь с службой поддержки Azure](https://aka.ms/MicrocodeEnablementRequest-SupportTechnical) для доступных вариантов смягчения.



**Шаг 3**: Для обеспечения поддержки ОС в виртуальном адресе ядра (KVAS) и поддержке Целевой ветви (BTI) следуйте инструкциям в [KB4072698,](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution) чтобы обеспечить защиту с помощью ключей `Session Manager` реестра. Потребуется перезагрузка.


**Шаг 4**: Для развертываний, использующих [вложенную виртуализацию](https://docs.microsoft.com/azure/virtual-machines/windows/nested-virtualization) (только D3 и E3): Эти инструкции применяются внутри VM, который вы используете в качестве хоста Hyper-V.

1.  Следуйте инструкциям в [KB4072698,](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution) чтобы `MinVmVersionForCpuBasedMitigations` обеспечить защиту с помощью ключей реестра.
2.  Установите тип планировщика гипервизора, `Core` следуя инструкциям [здесь.](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types)


### <a name="linux"></a>Linux

<a name="linux"></a>Для включения внутреннего набора дополнительных компонентов безопасности требуется, чтобы целевая операционная система была обновлена до последней версии. Некоторые методы устранения рисков будут включены по умолчанию. В приведенном ниже разделе описаны компоненты, которые по умолчанию отключены и/или зависят от аппаратной поддержки (микрокод). Включение этих компонентов может отрицательно сказаться на производительности. Дополнительные сведения см. в справочной документации поставщика операционной системы.


**Шаг 1: Отключить гипер-поток на VM** - Клиенты, работающие ненадежный код на гипер-резьбой VM необходимо отключить гипер-поток или перейти к не-гипер-резьбой VM.  Ссылка [на этот документ](https://docs.microsoft.com/azure/virtual-machines/linux/acu) для списка гипер-резьбовых размеров VM (где соотношение vCPU к ядру 2:1). Чтобы проверить, работаете ли вы с гипер-резьбовым VM, запустите `lscpu` команду в Linux VM. 

Если, `Thread(s) per core = 2`то гипер-поток был включен. 

Если, `Thread(s) per core = 1`то гипер-поток был отключен. 

 
Вывод образца для VM с включенным гиперпотоком: 

```console
CPU Architecture:      x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                8
On-line CPU(s) list:   0-7
Thread(s) per core:    2
Core(s) per socket:    4
Socket(s):             1
NUMA node(s):          1

```

Если вы работаете с гипер-резьбой VM, пожалуйста, [свяжитесь с поддержкой Azure,](https://aka.ms/MicrocodeEnablementRequest-SupportTechnical) чтобы получить гипер-потоки отключены.  Как только гипер-поток отключен, **поддержка потребует полной перезагрузки VM.** Пожалуйста, обратитесь к [Core граф,](#core-count) чтобы понять, почему ваш VM количество ядра сократилось.



**Шаг 2**: Чтобы смягчить против любого из ниже спекулятивных уязвимостей бокового канала выполнения, обратитесь к документации поставщика операционной системы:   
 
- [RedHat и CentOS](https://access.redhat.com/security/vulnerabilities) 
- [Suse](https://www.suse.com/support/kb/?doctype%5B%5D=DT_SUSESDB_PSDB_1_1&startIndex=1&maxIndex=0) 
- [Ubuntu](https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/) 


### <a name="core-count"></a>Количество ягов

При создании сверхпоточного VM Azure выделяет 2 потока на ядро - они называются vCPUs. При отключении гиперпотоки Azure удаляет поток и всплывает на поверхность одиночные нити (физические ядра). Соотношение VCPU к процессору 2:1, поэтому после того, как гипер-поток отключен, количество процессоров в VM, как представляется, сократилось вдважды. Например, D8_v3 VM — это сверхнитевый VM, работающий на 8 vCPUs (2 потока на ядро x 4 ядра).  При отключении гиперпотоков процессоры упадут до 4 физических ядер с 1 потоком на ядро. 

## <a name="next-steps"></a>Дальнейшие действия

Эта статья содержит руководство ниже спекулятивного исполнения бокового канала атак, которые влияют на многие современные процессоры:

[Призрак Meltdown](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/ADV180002):
- CVE-2017-5715 - Инъекция ветвей (BTI)  
- CVE-2017-5754 - Изоляция таблицы страниця ядра (KPTI)
- CVE-2018-3639 - Спекулятивный обход магазина (KPTI) 
- [CVE-2019-1125](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-1125) - Информация о ядрах Windows - вариант Spectre Variant 1
 
[Неисправность терминала L1 (L1TF)](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/ADV180018):
- CVE-2018-3615 - Расширения Intel Software Guard (Intel SGX)
- CVE-2018-3620 - Операционные системы (ОС) и режим управления системой (SMM)
- CVE-2018-3646 - удары виртуальный менеджер машины (VMM)

[Выборка микроархитектуры данных:](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/ADV190013) 
- CVE-2019-11091 - Микроархитектурная обработка данных некэшнированная память (MDSUM)
- CVE-2018-12126 - Выборка буферных данных микроархитектурного хранилища (MSBDS)
- CVE-2018-12127 - Выборка данных микроархитектуры порта (MLPDS)
- CVE-2018-12130 - Микроархитектурная выборка буферных данных (MFBDS)

Трансакционная синхронизация расширения (Intel® TSX) Транзакционный аборт:  
- [CVE-2019-11135](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-11135) - TSX транзакция Асинхронный аборт (TAA)








